<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22452:1c73b7308c85927524207fbd0015b91a0b04deb8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1c73b7308c85927524207fbd0015b91a0b04deb8" />
<meta property="og:url" content="/comm-central/rev/1c73b7308c85927524207fbd0015b91a0b04deb8" />
<meta property="og:description" content="Bug 1410672 - Fix indent for eslint. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1c73b7308c85927524207fbd0015b91a0b04deb8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1c73b7308c85927524207fbd0015b91a0b04deb8">shortlog</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1c73b7308c85927524207fbd0015b91a0b04deb8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8">files</a> |
changeset |
<a href="/comm-central/raw-rev/1c73b7308c85927524207fbd0015b91a0b04deb8">raw</a>  | <a href="/comm-central/archive/1c73b7308c85927524207fbd0015b91a0b04deb8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410672">Bug 1410672</a> - Fix indent for eslint. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#101;&#115;&#108;&#105;&#110;&#116;&#32;&#60;&#101;&#115;&#108;&#105;&#110;&#116;&#64;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#46;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 24 Oct 2017 23:17:03 +0200</td></tr>

<tr>
 <td>changeset 22452</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1c73b7308c85927524207fbd0015b91a0b04deb8">1c73b7308c85927524207fbd0015b91a0b04deb8</a></td>
</tr>



<tr>
<td>parent 22451</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7aed7ffb951f77828426b361ab36667830c0b4c6">7aed7ffb951f77828426b361ab36667830c0b4c6</a>
</td>
</tr>

<tr>
<td>child 22453</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5f5fbb45e801293526d7c6ab2158f7b7875c2828">5f5fbb45e801293526d7c6ab2158f7b7875c2828</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1c73b7308c85927524207fbd0015b91a0b04deb8">13686</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 29 Oct 2017 22:03:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1c73b7308c85 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1c73b7308c85927524207fbd0015b91a0b04deb8">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1c73b7308c85927524207fbd0015b91a0b04deb8&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1c73b7308c85927524207fbd0015b91a0b04deb8&newProject=comm-central&newRevision=1130d5a2c7009582877d46cb3f19e5cb1ed6e3ca&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1c73b7308c85927524207fbd0015b91a0b04deb8&newProject=comm-central&newRevision=1130d5a2c7009582877d46cb3f19e5cb1ed6e3ca&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1c73b7308c85927524207fbd0015b91a0b04deb8&newProject=comm-central&newRevision=1130d5a2c7009582877d46cb3f19e5cb1ed6e3ca&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410672">1410672</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1410672">Bug 1410672</a> - Fix indent for eslint. r=MakeMyDay

[skip-blame]

MozReview-Commit-ID: 2NfsSjrb7i3</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">calendar/base/content/agenda-listbox.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/agenda-listbox.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">calendar/base/content/calendar-daypicker.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-daypicker.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">calendar/base/content/calendar-item-bindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-item-bindings.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">calendar/base/content/calendar-menus.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-menus.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">calendar/base/content/dialogs/calendar-invitations-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/dialogs/calendar-invitations-list.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">calendar/base/content/widgets/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">calendar/base/content/widgets/calendar-subscriptions-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-subscriptions-list.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">calendar/base/content/widgets/calendar-widgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/calendar-widgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/1c73b7308c85927524207fbd0015b91a0b04deb8/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -9,85 +9,85 @@</span>
<a href="#l1.4"></a><span id="l1.4">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   &lt;binding id=&quot;agenda-base-richlist-item&quot;</span>
<a href="#l1.7"></a><span id="l1.7">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l1.8"></a><span id="l1.8">     &lt;implementation&gt;</span>
<a href="#l1.9"></a><span id="l1.9">       &lt;field name=&quot;mOccurrence&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l1.10"></a><span id="l1.10">       &lt;property name=&quot;occurrence&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l1.11"></a><span id="l1.11">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-          return this.mOccurrence;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+            return this.mOccurrence;</span>
<a href="#l1.14"></a><span id="l1.14">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l1.15"></a><span id="l1.15">       &lt;/property&gt;</span>
<a href="#l1.16"></a><span id="l1.16">     &lt;/implementation&gt;</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">     &lt;handlers&gt;</span>
<a href="#l1.19"></a><span id="l1.19">       &lt;handler event=&quot;click&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-        if (event.detail == 1) {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-            agendaListbox.onSelect(this);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-        } else if (event.button == 0) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-            // We only care about button 0 doubleclick events</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-            document.getElementById(&quot;agenda_edit_event_command&quot;).doCommand();</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-            event.preventDefault();</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-        }</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+          if (event.detail == 1) {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+              agendaListbox.onSelect(this);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+          } else if (event.button == 0) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+              // We only care about button 0 doubleclick events</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+              document.getElementById(&quot;agenda_edit_event_command&quot;).doCommand();</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+              event.preventDefault();</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+          }</span>
<a href="#l1.36"></a><span id="l1.36">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l1.37"></a><span id="l1.37">       &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-         event.stopPropagation();</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-         onMouseOverItem(event);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+          onMouseOverItem(event);</span>
<a href="#l1.42"></a><span id="l1.42">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l1.43"></a><span id="l1.43">     &lt;/handlers&gt;</span>
<a href="#l1.44"></a><span id="l1.44">   &lt;/binding&gt;</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46">   &lt;binding id=&quot;agenda-checkbox-richlist-item&quot;</span>
<a href="#l1.47"></a><span id="l1.47">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l1.48"></a><span id="l1.48">     &lt;content&gt;</span>
<a href="#l1.49"></a><span id="l1.49">       &lt;xul:treenode-checkbox class=&quot;agenda-checkbox&quot; anonid=&quot;agenda-checkbox-widget&quot;</span>
<a href="#l1.50"></a><span id="l1.50">                                                    flex=&quot;1&quot;</span>
<a href="#l1.51"></a><span id="l1.51">                                                    xbl:inherits=&quot;selected,label,hidden,disabled&quot;/&gt;</span>
<a href="#l1.52"></a><span id="l1.52">     &lt;/content&gt;</span>
<a href="#l1.53"></a><span id="l1.53">     &lt;implementation&gt;</span>
<a href="#l1.54"></a><span id="l1.54">       &lt;field name=&quot;kCheckbox&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l1.55"></a><span id="l1.55">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-        this.kCheckbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-checkbox-widget&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+          this.kCheckbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-checkbox-widget&quot;);</span>
<a href="#l1.60"></a><span id="l1.60">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">       &lt;method name=&quot;getItem&quot;&gt;</span>
<a href="#l1.63"></a><span id="l1.63">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-          return this.mItem;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+            return this.mItem;</span>
<a href="#l1.66"></a><span id="l1.66">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.67"></a><span id="l1.67">       &lt;/method&gt;</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">       &lt;method name=&quot;setItem&quot;&gt;</span>
<a href="#l1.70"></a><span id="l1.70">         &lt;parameter name=&quot;synthetic&quot;/&gt;</span>
<a href="#l1.71"></a><span id="l1.71">         &lt;parameter name=&quot;showsToday&quot;/&gt;</span>
<a href="#l1.72"></a><span id="l1.72">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-          this.mItem = synthetic;</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-          let duration = synthetic.duration;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-          if (showsToday) {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-              this.kCheckbox.label = this.getAttribute(&quot;title&quot;);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-              if (this.id == &quot;nextweek-header&quot;) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-                  if (duration &gt; 7) {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-                      this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration / 7, &quot;weeks&quot;) + &quot;)&quot;;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-                  } else {</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-                      this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration, &quot;days&quot;) + &quot;)&quot;;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-                  }</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-              }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-          } else if (synthetic.duration == 1) {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-              this.kCheckbox.label = cal.getDateFormatter().formatDate(synthetic.start);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-          } else {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-              this.kCheckbox.label = cal.getDateFormatter().formatInterval(synthetic.start, synthetic.end);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-          }</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+            this.mItem = synthetic;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+            let duration = synthetic.duration;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+            if (showsToday) {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+                this.kCheckbox.label = this.getAttribute(&quot;title&quot;);</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+                if (this.id == &quot;nextweek-header&quot;) {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+                    if (duration &gt; 7) {</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+                        this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration / 7, &quot;weeks&quot;) + &quot;)&quot;;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+                    } else {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+                        this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration, &quot;days&quot;) + &quot;)&quot;;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+                    }</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+                }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+            } else if (synthetic.duration == 1) {</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+                this.kCheckbox.label = cal.getDateFormatter().formatDate(synthetic.start);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+            } else {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+                this.kCheckbox.label = cal.getDateFormatter().formatInterval(synthetic.start, synthetic.end);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+            }</span>
<a href="#l1.105"></a><span id="l1.105">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.106"></a><span id="l1.106">       &lt;/method&gt;</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108">       &lt;method name=&quot;getCheckbox&quot;&gt;</span>
<a href="#l1.109"></a><span id="l1.109">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-          return this.kCheckbox;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+            return this.kCheckbox;</span>
<a href="#l1.112"></a><span id="l1.112">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.113"></a><span id="l1.113">       &lt;/method&gt;</span>
<a href="#l1.114"></a><span id="l1.114">     &lt;/implementation&gt;</span>
<a href="#l1.115"></a><span id="l1.115">   &lt;/binding&gt;</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">   &lt;binding id=&quot;agenda-allday-richlist-item&quot;</span>
<a href="#l1.118"></a><span id="l1.118">            extends=&quot;chrome://calendar/content/agenda-listbox.xml#agenda-base-richlist-item&quot;&gt;</span>
<a href="#l1.119"></a><span id="l1.119">     &lt;content tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineat">@@ -106,78 +106,78 @@</span>
<a href="#l1.121"></a><span id="l1.121">           &lt;/xul:hbox&gt;</span>
<a href="#l1.122"></a><span id="l1.122">         &lt;/xul:vbox&gt;</span>
<a href="#l1.123"></a><span id="l1.123">       &lt;/xul:hbox&gt;</span>
<a href="#l1.124"></a><span id="l1.124">     &lt;/content&gt;</span>
<a href="#l1.125"></a><span id="l1.125">     &lt;implementation&gt;</span>
<a href="#l1.126"></a><span id="l1.126">       &lt;field name=&quot;mAllDayItem&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-        this.mAllDayItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;allday-item&quot;);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+          this.mAllDayItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;allday-item&quot;);</span>
<a href="#l1.133"></a><span id="l1.133">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l1.134"></a><span id="l1.134"> </span>
<a href="#l1.135"></a><span id="l1.135">       &lt;method name=&quot;setOccurrence&quot;&gt;</span>
<a href="#l1.136"></a><span id="l1.136">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l1.137"></a><span id="l1.137">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l1.138"></a><span id="l1.138">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-          this.mOccurrence = aOccurrence;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-          this.mAllDayItem.occurrence = aOccurrence;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-          let dateFormatter = cal.getDateFormatter();</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-          let periodStartDate = aPeriod.start.clone();</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-          periodStartDate.isDate = true;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-          let periodEndDate = aPeriod.end;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-          let startDate = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+            this.mOccurrence = aOccurrence;</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+            this.mAllDayItem.occurrence = aOccurrence;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+            let dateFormatter = cal.getDateFormatter();</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+            let periodStartDate = aPeriod.start.clone();</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+            periodStartDate.isDate = true;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+            let periodEndDate = aPeriod.end;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+            let startDate = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+                                .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+            let endDate = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l1.155"></a><span id="l1.155">                               .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-          let endDate = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-                            .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-          let endPreviousDay = endDate.clone();</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-          endPreviousDay.day--;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-          // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-          // period with one day duration.</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-          let showDate = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+            let endPreviousDay = endDate.clone();</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+            endPreviousDay.day--;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+            // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+            // period with one day duration.</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+            let showDate = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-          let date = &quot;&quot;;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-          let iconType = &quot;&quot;;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-          let allDayDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-allDayEvent-date&quot;);</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-          setBooleanAttribute(allDayDateLabel, &quot;hidden&quot;, !showDate);</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-          if (startDate.compare(endPreviousDay) == 0) {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-              // All day event one day duration.</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-              date = dateFormatter.formatDate(startDate);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-          } else if (startDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-               startDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-              // All day event spanning multiple days.</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-              iconType = &quot;start&quot;;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-              date = dateFormatter.formatDate(startDate);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-          } else if (endDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-                     endDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-              iconType = &quot;end&quot;;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-              date = dateFormatter.formatDate(endPreviousDay);</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-          } else {</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-              iconType = &quot;continue&quot;;</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-              hideElement(allDayDateLabel);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-          }</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+            let date = &quot;&quot;;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+            let iconType = &quot;&quot;;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+            let allDayDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-allDayEvent-date&quot;);</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+            setBooleanAttribute(allDayDateLabel, &quot;hidden&quot;, !showDate);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+            if (startDate.compare(endPreviousDay) == 0) {</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+                // All day event one day duration.</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+                date = dateFormatter.formatDate(startDate);</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+            } else if (startDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+                 startDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+                // All day event spanning multiple days.</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+                iconType = &quot;start&quot;;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+                date = dateFormatter.formatDate(startDate);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+            } else if (endDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+                       endDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+                iconType = &quot;end&quot;;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+                date = dateFormatter.formatDate(endPreviousDay);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+            } else {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+                iconType = &quot;continue&quot;;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+                hideElement(allDayDateLabel);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+            }</span>
<a href="#l1.209"></a><span id="l1.209"> </span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-          let multiDayImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-multiDayEvent-image&quot;);</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-          multiDayImage.setAttribute(&quot;type&quot;, iconType);</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-          // class wrap causes allday items to wrap its text in today-pane</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-          let addWrap = document.getAnonymousElementByAttribute(this.mAllDayItem, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-          addWrap.classList.add(&quot;wrap&quot;);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-          addWrap = document.getAnonymousElementByAttribute(this.mAllDayItem, &quot;anonid&quot;, &quot;event-detail-box&quot;);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-          addWrap.classList.add(&quot;wrap&quot;);</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-          allDayDateLabel.value = date;</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+            let multiDayImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-multiDayEvent-image&quot;);</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+            multiDayImage.setAttribute(&quot;type&quot;, iconType);</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+            // class wrap causes allday items to wrap its text in today-pane</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+            let addWrap = document.getAnonymousElementByAttribute(this.mAllDayItem, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+            addWrap.classList.add(&quot;wrap&quot;);</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+            addWrap = document.getAnonymousElementByAttribute(this.mAllDayItem, &quot;anonid&quot;, &quot;event-detail-box&quot;);</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+            addWrap.classList.add(&quot;wrap&quot;);</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+            allDayDateLabel.value = date;</span>
<a href="#l1.226"></a><span id="l1.226">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.227"></a><span id="l1.227">       &lt;/method&gt;</span>
<a href="#l1.228"></a><span id="l1.228">     &lt;/implementation&gt;</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230">     &lt;handlers&gt;</span>
<a href="#l1.231"></a><span id="l1.231">       &lt;handler event=&quot;dragstart&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-        invokeEventDragSession(this.mAllDayItem.occurrence.clone(), this);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-        event.preventDefault();</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+          invokeEventDragSession(this.mAllDayItem.occurrence.clone(), this);</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+          event.preventDefault();</span>
<a href="#l1.238"></a><span id="l1.238">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l1.239"></a><span id="l1.239">     &lt;/handlers&gt;</span>
<a href="#l1.240"></a><span id="l1.240">   &lt;/binding&gt;</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242">   &lt;binding id=&quot;agenda-richlist-item&quot;</span>
<a href="#l1.243"></a><span id="l1.243">            extends=&quot;chrome://calendar/content/agenda-listbox.xml#agenda-base-richlist-item&quot;&gt;</span>
<a href="#l1.244"></a><span id="l1.244">     &lt;content tooltip=&quot;itemTooltip&quot;&gt;</span>
<a href="#l1.245"></a><span id="l1.245">       &lt;xul:hbox anonid=&quot;agenda-container-box&quot; class=&quot;agenda-container-box&quot; xbl:inherits=&quot;selected,disabled,current&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineat">@@ -197,95 +197,95 @@</span>
<a href="#l1.247"></a><span id="l1.247">       &lt;/xul:hbox&gt;</span>
<a href="#l1.248"></a><span id="l1.248">     &lt;/content&gt;</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">     &lt;implementation&gt;</span>
<a href="#l1.251"></a><span id="l1.251">       &lt;method name=&quot;setOccurrence&quot;&gt;</span>
<a href="#l1.252"></a><span id="l1.252">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l1.253"></a><span id="l1.253">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l1.254"></a><span id="l1.254">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-          this.mOccurrence = aItem;</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-          this.setAttribute(&quot;status&quot;, aItem.status);</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-          let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-                                        .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+            this.mOccurrence = aItem;</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+            this.setAttribute(&quot;status&quot;, aItem.status);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+            let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+                                          .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-          let periodStartDate = aPeriod.start.clone();</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-          periodStartDate.isDate = true;</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-          let periodEndDate = aPeriod.end.clone();</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-          periodEndDate.day--;</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-          let start = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+            let periodStartDate = aPeriod.start.clone();</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+            periodStartDate.isDate = true;</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+            let periodEndDate = aPeriod.end.clone();</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+            periodEndDate.day--;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+            let start = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+                            .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+            let end = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l1.276"></a><span id="l1.276">                           .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-          let end = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-                        .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-          let startDate = start.clone();</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-          startDate.isDate = true;</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-          let endDate = end.clone();</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-          endDate.isDate = true;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-          let endAtMidnight = (end.hour == 0 &amp;&amp; end.minute == 0);</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-          if (endAtMidnight) {</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-              endDate.day--;</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-          }</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-          // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-          // period with one day duration.</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-          let longFormat = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+            let startDate = start.clone();</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+            startDate.isDate = true;</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+            let endDate = end.clone();</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+            endDate.isDate = true;</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+            let endAtMidnight = (end.hour == 0 &amp;&amp; end.minute == 0);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+            if (endAtMidnight) {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+                endDate.day--;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+            }</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+            // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+            // period with one day duration.</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+            let longFormat = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l1.301"></a><span id="l1.301"> </span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-          let duration = &quot;&quot;;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-          let iconType = &quot;&quot;;</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-          if (startDate.compare(endDate) == 0) {</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-              // event that starts and ends in the same day, midnight included</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-              duration = longFormat ? dateFormatter.formatDateTime(start)</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-                                    : dateFormatter.formatTime(start);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-          } else if (startDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-                     startDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-              // event spanning multiple days, start date within period</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-              iconType = &quot;start&quot;;</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-              duration = longFormat ? dateFormatter.formatDateTime(start)</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-                                    : dateFormatter.formatTime(start);</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-          } else if (endDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-                     endDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-              // event spanning multiple days, end date within period</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-              iconType = &quot;end&quot;;</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-              if (endAtMidnight) {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-                  duration = dateFormatter.formatDate(endDate) + &quot; &quot;;</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-                  duration = longFormat ? duration + cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;)</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-                                        : cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-              } else {</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-                  duration = longFormat ? dateFormatter.formatDateTime(end)</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-                                        : dateFormatter.formatTime(end);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-              }</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-          } else {</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-              iconType = &quot;continue&quot;;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-          }</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-          let multiDayImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-multiDayEvent-image&quot;);</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-          multiDayImage.setAttribute(&quot;type&quot;, iconType);</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-          let durationbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-event-start&quot;);</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-          durationbox.textContent = duration;</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+            let duration = &quot;&quot;;</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+            let iconType = &quot;&quot;;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+            if (startDate.compare(endDate) == 0) {</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+                // event that starts and ends in the same day, midnight included</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+                duration = longFormat ? dateFormatter.formatDateTime(start)</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+                                      : dateFormatter.formatTime(start);</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+            } else if (startDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+                       startDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+                // event spanning multiple days, start date within period</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+                iconType = &quot;start&quot;;</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+                duration = longFormat ? dateFormatter.formatDateTime(start)</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+                                      : dateFormatter.formatTime(start);</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+            } else if (endDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+                       endDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+                // event spanning multiple days, end date within period</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+                iconType = &quot;end&quot;;</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+                if (endAtMidnight) {</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+                    duration = dateFormatter.formatDate(endDate) + &quot; &quot;;</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+                    duration = longFormat ? duration + cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;)</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+                                          : cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+                } else {</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+                    duration = longFormat ? dateFormatter.formatDateTime(end)</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+                                          : dateFormatter.formatTime(end);</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+                }</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+            } else {</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+                iconType = &quot;continue&quot;;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+            }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+            let multiDayImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-multiDayEvent-image&quot;);</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+            multiDayImage.setAttribute(&quot;type&quot;, iconType);</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+            let durationbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-event-start&quot;);</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+            durationbox.textContent = duration;</span>
<a href="#l1.364"></a><span id="l1.364"> </span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-          // show items with time only (today &amp; tomorrow) as one line.</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-          if (longFormat) {</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-              let titlebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-event-title&quot;);</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-              titlebox.textContent = aItem.title;</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-          } else {</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-              durationbox.textContent += &quot; &quot; + aItem.title;</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-          }</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-          this.refreshColor();</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+            // show items with time only (today &amp; tomorrow) as one line.</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+            if (longFormat) {</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineplus">+                let titlebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-event-title&quot;);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineplus">+                titlebox.textContent = aItem.title;</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+            } else {</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+                durationbox.textContent += &quot; &quot; + aItem.title;</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineplus">+            }</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+            this.refreshColor();</span>
<a href="#l1.381"></a><span id="l1.381">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.382"></a><span id="l1.382">       &lt;/method&gt;</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384">       &lt;method name=&quot;refreshColor&quot;&gt;</span>
<a href="#l1.385"></a><span id="l1.385">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-          let calcolor = (this.mOccurrence &amp;&amp;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-                           this.mOccurrence.calendar.getProperty(&quot;color&quot;)) ||</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-                          &quot;#a8c2e1&quot;;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+            let calcolor = (this.mOccurrence &amp;&amp;</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+                             this.mOccurrence.calendar.getProperty(&quot;color&quot;)) ||</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+                            &quot;#a8c2e1&quot;;</span>
<a href="#l1.392"></a><span id="l1.392"> </span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-          let imagebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-calendar-image&quot;);</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-          imagebox.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + calcolor + &quot;;&quot;);</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+            let imagebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-calendar-image&quot;);</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+            imagebox.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + calcolor + &quot;;&quot;);</span>
<a href="#l1.397"></a><span id="l1.397">         ]]&gt;&lt;/body&gt;</span>
<a href="#l1.398"></a><span id="l1.398">       &lt;/method&gt;</span>
<a href="#l1.399"></a><span id="l1.399">     &lt;/implementation&gt;</span>
<a href="#l1.400"></a><span id="l1.400"> </span>
<a href="#l1.401"></a><span id="l1.401">     &lt;handlers&gt;</span>
<a href="#l1.402"></a><span id="l1.402">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-        invokeEventDragSession(this.mOccurrence.clone(), this);</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+          invokeEventDragSession(this.mOccurrence.clone(), this);</span>
<a href="#l1.405"></a><span id="l1.405">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l1.406"></a><span id="l1.406">     &lt;/handlers&gt;</span>
<a href="#l1.407"></a><span id="l1.407">   &lt;/binding&gt;</span>
<a href="#l1.408"></a><span id="l1.408"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -37,244 +37,244 @@</span>
<a href="#l2.4"></a><span id="l2.4">       &lt;field name=&quot;mDropShadows&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.5"></a><span id="l2.5">       &lt;field name=&quot;mMagnifyAmount&quot;&gt;0&lt;/field&gt;</span>
<a href="#l2.6"></a><span id="l2.6">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l2.7"></a><span id="l2.7">       &lt;field name=&quot;mViewStart&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.8"></a><span id="l2.8">       &lt;field name=&quot;mViewEnd&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.9"></a><span id="l2.9">       &lt;field name=&quot;mToggleStatus&quot;&gt;0&lt;/field&gt;</span>
<a href="#l2.10"></a><span id="l2.10">       &lt;field name=&quot;mLog&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.11"></a><span id="l2.11">       &lt;field name=&quot;mToggleStatusFlag&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      ({</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-          WorkdaysOnly: 1,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-          TasksInView: 2,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-          ShowCompleted: 4,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      })</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+        ({</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            WorkdaysOnly: 1,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+            TasksInView: 2,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+            ShowCompleted: 4,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+        })</span>
<a href="#l2.22"></a><span id="l2.22">       ]]&gt;&lt;/field&gt;</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">       &lt;field name=&quot;mPrefObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-      ({</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-          calView: this,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-          observe: function(subj, topic, pref) {</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-              this.calView.handlePreference(subj, topic, pref);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-          }</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-      })</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      ]]&gt;&lt;/field&gt;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      &lt;field name=&quot;mObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-        // the calIObserver, calICompositeObserver, and calIAlarmServiceObserver</span>
<a href="#l2.35"></a><span id="l2.35">         ({</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-            QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                Components.interfaces.calIObserver,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                Components.interfaces.calIAlarmServiceObserver,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                Components.interfaces.calICompositeObserver</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-            ]),</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42">             calView: this,</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-            onStartBatch: function() {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-            },</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-            onEndBatch: function() {</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-            },</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-            onLoad: function() {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                this.calView.refresh();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-            },</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-            onAddItem: function(aItem) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                if (cal.isToDo(aItem)) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-                    if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-                        return;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-                    }</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-                    if (!this.calView.mTasksInView) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-                        return;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                    }</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-                    if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-                        return;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                    }</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                }</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                let occs = aItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-                                                       this.calView.queryEndDate,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-                                                       {});</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                for (let occ of occs) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                    this.calView.doAddItem(occ);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-                }</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-            },</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-            onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                if (cal.isToDo(aNewItem) &amp;&amp; cal.isToDo(aOldItem) &amp;&amp;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                    !this.calView.mTasksInView) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                    return;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                }</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                let occs;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-                if (!cal.isToDo(aOldItem) || aOldItem.entryDate || aOldItem.dueDate) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                    occs = aOldItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                                                          this.calView.queryEndDate,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-                                                          {});</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                    for (let occ of occs) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                        this.calView.doDeleteItem(occ);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                    }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-                }</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-                if (cal.isToDo(aNewItem)) {</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-                    if ((!aNewItem.entryDate &amp;&amp; !aNewItem.dueDate) || !this.calView.mTasksInView) {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-                        return;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-                    }</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-                    if (aNewItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-                        return;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-                    }</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-                }</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-                occs = aNewItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                                                      this.calView.queryEndDate,</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-                                                      {});</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-                for (let occ of occs) {</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-                    this.calView.doAddItem(occ);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-                }</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-            },</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-            onDeleteItem: function(aItem) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-                if (cal.isToDo(aItem)) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-                    if (!this.calView.mTasksInView) {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-                        return;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-                    }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-                    if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-                        return;</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-                    }</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-                    if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-                        return;</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-                    }</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                }</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-                let occs = aItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-                                                       this.calView.queryEndDate,</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-                                                       {});</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-                for (let occ of occs) {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                    this.calView.doDeleteItem(occ);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                }</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-            },</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-            onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-            onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-                switch (aName) {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                    case &quot;suppressAlarms&quot;:</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                        if (!Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true) ||</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-                            aCalendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-                            break;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-                        }</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-                        // else fall through</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-                    case &quot;readOnly&quot;:</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-                    case &quot;disabled&quot;:</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-                        // XXXvv we can be smarter about how we handle this stuff</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-                        this.calView.refresh();</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-                        break;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-                }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-            },</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-            onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-                // Values are not important here yet.</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-                this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-            },</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-            //</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-            // calIAlarmServiceObserver stuff</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-            //</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-            onAlarm: function(aAlarmItem) {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-                this.calView.flashAlarm(aAlarmItem, false);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-            },</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-            onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-                // Stop the flashing for the item.</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-                this.calView.flashAlarm(aItem, true);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-            },</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-            onRemoveAlarmsByCalendar: function(aCalendar) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-                // Stop the flashing for all items of this calendar</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-                for (let key in this.calView.mFlashingEvents) {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-                    let item = this.calView.mFlashingEvents[key];</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-                    if (item.calendar.id == aCalendar.id) {</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-                        this.calView.flashAlarm(item, true);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-                    }</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-                }</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-            },</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-            onAlarmsLoaded: function(aCalendar) {},</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-            //</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-            // calICompositeObserver stuff</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-            // XXXvv we can be smarter about how we handle this stuff</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-            //</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-            onCalendarAdded: function(aCalendar) {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-                if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-                    this.calView.addItemsFromCalendar(aCalendar);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-                }</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-            },</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-            onCalendarRemoved: function(aCalendar) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-                if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-                    this.calView.deleteItemsFromCalendar(aCalendar);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-                }</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-            },</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-            onDefaultCalendarChanged: function(aNewDefaultCalendar) {</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-                // don't care, for now</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+            observe: function(subj, topic, pref) {</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+                this.calView.handlePreference(subj, topic, pref);</span>
<a href="#l2.194"></a><span id="l2.194">             }</span>
<a href="#l2.195"></a><span id="l2.195">         })</span>
<a href="#l2.196"></a><span id="l2.196">       ]]&gt;&lt;/field&gt;</span>
<a href="#l2.197"></a><span id="l2.197"> </span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-        Components.utils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+      &lt;field name=&quot;mObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+          // the calIObserver, calICompositeObserver, and calIAlarmServiceObserver</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+          ({</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+              QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+                  Components.interfaces.calIObserver,</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+                  Components.interfaces.calIAlarmServiceObserver,</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+                  Components.interfaces.calICompositeObserver</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+              ]),</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+              calView: this,</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+              onStartBatch: function() {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+              },</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+              onEndBatch: function() {</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+              },</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+              onLoad: function() {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+                  this.calView.refresh();</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+              },</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+              onAddItem: function(aItem) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+                  if (cal.isToDo(aItem)) {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+                      if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+                          return;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+                      }</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+                      if (!this.calView.mTasksInView) {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+                          return;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+                      }</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+                      if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+                          return;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+                      }</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+                  }</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+                  let occs = aItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+                                                         this.calView.queryEndDate,</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+                                                         {});</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+                  for (let occ of occs) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+                      this.calView.doAddItem(occ);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+                  }</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+              },</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+              onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+                  if (cal.isToDo(aNewItem) &amp;&amp; cal.isToDo(aOldItem) &amp;&amp;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+                      !this.calView.mTasksInView) {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+                      return;</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+                  }</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+                  let occs;</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-        const kWorkdaysCommand = &quot;calendar_toggle_workdays_only_command&quot;;</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-        const kTasksInViewCommand = &quot;calendar_toggle_tasks_in_view_command&quot;;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        const kShowCompleted = &quot;calendar_toggle_show_completed_in_view_command&quot;;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        const kOrientation = &quot;calendar_toggle_orientation_command&quot;;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+                  if (!cal.isToDo(aOldItem) || aOldItem.entryDate || aOldItem.dueDate) {</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+                      occs = aOldItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+                                                            this.calView.queryEndDate,</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+                                                            {});</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+                      for (let occ of occs) {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+                          this.calView.doDeleteItem(occ);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+                      }</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+                  }</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+                  if (cal.isToDo(aNewItem)) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+                      if ((!aNewItem.entryDate &amp;&amp; !aNewItem.dueDate) || !this.calView.mTasksInView) {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+                          return;</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+                      }</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+                      if (aNewItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+                          return;</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+                      }</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+                  }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+                  occs = aNewItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+                                                        this.calView.queryEndDate,</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+                                                        {});</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+                  for (let occ of occs) {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+                      this.calView.doAddItem(occ);</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+                  }</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+              },</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+              onDeleteItem: function(aItem) {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+                  if (cal.isToDo(aItem)) {</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+                      if (!this.calView.mTasksInView) {</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+                          return;</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+                      }</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+                      if (!aItem.entryDate &amp;&amp; !aItem.dueDate) {</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+                          return;</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+                      }</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+                      if (aItem.isCompleted &amp;&amp; !this.calView.mShowCompleted) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+                          return;</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+                      }</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+                  }</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+                  let occs = aItem.getOccurrencesBetween(this.calView.startDate,</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+                                                         this.calView.queryEndDate,</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+                                                         {});</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+                  for (let occ of occs) {</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+                      this.calView.doDeleteItem(occ);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+                  }</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+              },</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+              onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l2.302"></a><span id="l2.302"> </span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-        this.workdaysOnly = (document.getElementById(kWorkdaysCommand)</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-                                .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-        this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-                                .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-        this.rotated = (document.getElementById(kOrientation)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-                                .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-        this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-                                .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+              onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+                  switch (aName) {</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+                      case &quot;suppressAlarms&quot;:</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+                          if (!Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true) ||</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+                              aCalendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) === false) {</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+                              break;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+                          }</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+                          // else fall through</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+                      case &quot;readOnly&quot;:</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+                      case &quot;disabled&quot;:</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+                          // XXXvv we can be smarter about how we handle this stuff</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+                          this.calView.refresh();</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+                          break;</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+                  }</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+              },</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+              onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+                  // Values are not important here yet.</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+                  this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+              },</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+              //</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+              // calIAlarmServiceObserver stuff</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+              //</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+              onAlarm: function(aAlarmItem) {</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+                  this.calView.flashAlarm(aAlarmItem, false);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+              },</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+              onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+                  // Stop the flashing for the item.</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+                  this.calView.flashAlarm(aItem, true);</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+              },</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+              onRemoveAlarmsByCalendar: function(aCalendar) {</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+                  // Stop the flashing for all items of this calendar</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+                  for (let key in this.calView.mFlashingEvents) {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+                      let item = this.calView.mFlashingEvents[key];</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+                      if (item.calendar.id == aCalendar.id) {</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+                          this.calView.flashAlarm(item, true);</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+                      }</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+                  }</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+              },</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+              onAlarmsLoaded: function(aCalendar) {},</span>
<a href="#l2.355"></a><span id="l2.355"> </span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-        this.mTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-        let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-        alarmService.addObserver(this.mObserver);</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-        this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-        this.mResizeHandler = () =&gt; {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-            this.onResize(this);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-        };</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-        this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-        // add a preference observer to monitor changes</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-        Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-        this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-        this.updateDaysOffPrefs();</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        this.mPendingRefreshJobs = new Map();</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-        this.mLog = Log4Moz.getConfiguredLogger(&quot;calBaseView&quot;);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-        this.mFlashingEvents = {};</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+              //</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+              // calICompositeObserver stuff</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+              // XXXvv we can be smarter about how we handle this stuff</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+              //</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+              onCalendarAdded: function(aCalendar) {</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+                  if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+                      this.calView.addItemsFromCalendar(aCalendar);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+                  }</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+              },</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+              onCalendarRemoved: function(aCalendar) {</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+                  if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+                      this.calView.deleteItemsFromCalendar(aCalendar);</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+                  }</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+              },</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+              onDefaultCalendarChanged: function(aNewDefaultCalendar) {</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+                  // don't care, for now</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+              }</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+          })</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+      ]]&gt;&lt;/field&gt;</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+          Components.utils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+          const kWorkdaysCommand = &quot;calendar_toggle_workdays_only_command&quot;;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+          const kTasksInViewCommand = &quot;calendar_toggle_tasks_in_view_command&quot;;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+          const kShowCompleted = &quot;calendar_toggle_show_completed_in_view_command&quot;;</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+          const kOrientation = &quot;calendar_toggle_orientation_command&quot;;</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+          this.workdaysOnly = (document.getElementById(kWorkdaysCommand)</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+                                  .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+          this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+                                  .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+          this.rotated = (document.getElementById(kOrientation)</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+                                  .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+          this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+                                  .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+          this.mTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+          let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+                                       .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+          alarmService.addObserver(this.mObserver);</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+          this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+          this.mResizeHandler = () =&gt; {</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+              this.onResize(this);</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+          };</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+          this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+          // add a preference observer to monitor changes</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+          Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+          this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+          this.updateDaysOffPrefs();</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+          this.mPendingRefreshJobs = new Map();</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+          this.mLog = Log4Moz.getConfiguredLogger(&quot;calBaseView&quot;);</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+          this.mFlashingEvents = {};</span>
<a href="#l2.430"></a><span id="l2.430">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l2.431"></a><span id="l2.431"> </span>
<a href="#l2.432"></a><span id="l2.432">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.435"></a><span id="l2.435"> </span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-        if (this.mCalendar) {</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-            this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-        }</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-        let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-        alarmService.removeObserver(this.mObserver);</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-        this.viewBroadcaster.removeEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-        Services.prefs.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+          if (this.mCalendar) {</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+              this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+          }</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+          let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+                                       .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+          alarmService.removeObserver(this.mObserver);</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+          this.viewBroadcaster.removeEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+          Services.prefs.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.452"></a><span id="l2.452">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l2.453"></a><span id="l2.453"> </span>
<a href="#l2.454"></a><span id="l2.454">       &lt;property name=&quot;type&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l2.455"></a><span id="l2.455">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.456"></a><span id="l2.456">             let typelist = this.id.split(&quot;-&quot;);</span>
<a href="#l2.457"></a><span id="l2.457">             return typelist[0];</span>
<a href="#l2.458"></a><span id="l2.458">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.459"></a><span id="l2.459">       &lt;/property&gt;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineat">@@ -331,422 +331,422 @@</span>
<a href="#l2.461"></a><span id="l2.461">       &lt;property name=&quot;rangeEndDate&quot;</span>
<a href="#l2.462"></a><span id="l2.462">                 onget=&quot;return this.mRangeEndDate;&quot;</span>
<a href="#l2.463"></a><span id="l2.463">                 onset=&quot;return (this.mRangeEndDate = val);&quot;/&gt;</span>
<a href="#l2.464"></a><span id="l2.464">       &lt;property name=&quot;observerID&quot; readonly=&quot;true&quot;</span>
<a href="#l2.465"></a><span id="l2.465">                 onget=&quot;return 'base-view-observer';&quot;/&gt;</span>
<a href="#l2.466"></a><span id="l2.466"> </span>
<a href="#l2.467"></a><span id="l2.467">       &lt;property name=&quot;weekStartOffset&quot;&gt;</span>
<a href="#l2.468"></a><span id="l2.468">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-           return this.mWeekStartOffset;</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+            return this.mWeekStartOffset;</span>
<a href="#l2.471"></a><span id="l2.471">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.472"></a><span id="l2.472">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-           this.mWeekStartOffset = val;</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-           return val;</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+            this.mWeekStartOffset = val;</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+            return val;</span>
<a href="#l2.477"></a><span id="l2.477">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.478"></a><span id="l2.478">       &lt;/property&gt;</span>
<a href="#l2.479"></a><span id="l2.479"> </span>
<a href="#l2.480"></a><span id="l2.480">       &lt;property name=&quot;displayCalendar&quot;&gt;</span>
<a href="#l2.481"></a><span id="l2.481">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-          return this.mCalendar;</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+            return this.mCalendar;</span>
<a href="#l2.484"></a><span id="l2.484">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.485"></a><span id="l2.485">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-          if (this.mCalendar) {</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-              this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-          }</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-          this.mCalendar = val;</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-          this.mCalendar.addObserver(this.mObserver);</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-          this.refresh();</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-          return val;</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+            if (this.mCalendar) {</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+                this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+            }</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+            this.mCalendar = val;</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+            this.mCalendar.addObserver(this.mObserver);</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+            this.refresh();</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+            return val;</span>
<a href="#l2.500"></a><span id="l2.500">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.501"></a><span id="l2.501">       &lt;/property&gt;</span>
<a href="#l2.502"></a><span id="l2.502"> </span>
<a href="#l2.503"></a><span id="l2.503">       &lt;property name=&quot;initialized&quot;&gt;</span>
<a href="#l2.504"></a><span id="l2.504">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-          let retval;</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+            let retval;</span>
<a href="#l2.507"></a><span id="l2.507"> </span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-          // Some views throw when accessing an uninitialized startDay</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-          try {</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-              retval = this.displayCalendar &amp;&amp; this.startDay &amp;&amp;</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-                       this.endDay;</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-          } catch (ex) {</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-              return false;</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-          }</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-          return retval;</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+            // Some views throw when accessing an uninitialized startDay</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+            try {</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+                retval = this.displayCalendar &amp;&amp; this.startDay &amp;&amp;</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+                         this.endDay;</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+            } catch (ex) {</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+                return false;</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+            }</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+            return retval;</span>
<a href="#l2.524"></a><span id="l2.524">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.525"></a><span id="l2.525">       &lt;/property&gt;</span>
<a href="#l2.526"></a><span id="l2.526"> </span>
<a href="#l2.527"></a><span id="l2.527">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l2.528"></a><span id="l2.528">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l2.529"></a><span id="l2.529">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-          this.showDate(aDate);</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineplus">+            this.showDate(aDate);</span>
<a href="#l2.532"></a><span id="l2.532">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.533"></a><span id="l2.533">       &lt;/method&gt;</span>
<a href="#l2.534"></a><span id="l2.534"> </span>
<a href="#l2.535"></a><span id="l2.535">       &lt;method name=&quot;getRangeDescription&quot;&gt;</span>
<a href="#l2.536"></a><span id="l2.536">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-          return cal.getDateFormatter().formatInterval(this.rangeStartDate, this.rangeEndDate);</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+            return cal.getDateFormatter().formatInterval(this.rangeStartDate, this.rangeEndDate);</span>
<a href="#l2.539"></a><span id="l2.539">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.540"></a><span id="l2.540">       &lt;/method&gt;</span>
<a href="#l2.541"></a><span id="l2.541"> </span>
<a href="#l2.542"></a><span id="l2.542">       &lt;!-- This function guarantees that the</span>
<a href="#l2.543"></a><span id="l2.543">        labels are clipped in the instance that the overflow occurrs,</span>
<a href="#l2.544"></a><span id="l2.544">        avoiding horizontal scrollbars from showing up for a short period. --&gt;</span>
<a href="#l2.545"></a><span id="l2.545">       &lt;method name=&quot;adjustWeekdayLength&quot;&gt;</span>
<a href="#l2.546"></a><span id="l2.546">         &lt;parameter name=&quot;forceShortName&quot;/&gt;</span>
<a href="#l2.547"></a><span id="l2.547">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-          let useShortNames = false;</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-          let labeldayboxkids = this.labeldaybox.childNodes;</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-          if (!labeldayboxkids || !labeldayboxkids[0]) {</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-              useShortNames = true;</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-          } else if (forceShortName &amp;&amp; forceShortName === true) {</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-              useShortNames = true;</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-          } else {</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-              let clientWidth = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;mainbox&quot;).clientWidth;</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-              let timespacer = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headertimespacer&quot;);</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-              if (timespacer) {</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-                  clientWidth -= timespacer.clientWidth;</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-              }</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-              if (this.getLongWeekdayTotalPixels() &gt; 0.95 * clientWidth) {</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-                  useShortNames = true;</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-              }</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-          }</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-          for (let i = 0; i &lt; labeldayboxkids.length; i++) {</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-              labeldayboxkids[i].shortWeekNames = useShortNames;</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-          }</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+            let useShortNames = false;</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+            let labeldayboxkids = this.labeldaybox.childNodes;</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+            if (!labeldayboxkids || !labeldayboxkids[0]) {</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineplus">+                useShortNames = true;</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+            } else if (forceShortName &amp;&amp; forceShortName === true) {</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+                useShortNames = true;</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+            } else {</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+                let clientWidth = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;mainbox&quot;).clientWidth;</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+                let timespacer = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headertimespacer&quot;);</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+                if (timespacer) {</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+                    clientWidth -= timespacer.clientWidth;</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+                }</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+                if (this.getLongWeekdayTotalPixels() &gt; 0.95 * clientWidth) {</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+                    useShortNames = true;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+                }</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineplus">+            }</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineplus">+            for (let i = 0; i &lt; labeldayboxkids.length; i++) {</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+                labeldayboxkids[i].shortWeekNames = useShortNames;</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineplus">+            }</span>
<a href="#l2.586"></a><span id="l2.586">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.587"></a><span id="l2.587">       &lt;/method&gt;</span>
<a href="#l2.588"></a><span id="l2.588"> </span>
<a href="#l2.589"></a><span id="l2.589">       &lt;method name=&quot;today&quot;&gt;</span>
<a href="#l2.590"></a><span id="l2.590">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-          let date = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-          date.isDate = true;</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-          return date;</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineplus">+            let date = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineplus">+            date.isDate = true;</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+            return date;</span>
<a href="#l2.597"></a><span id="l2.597">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.598"></a><span id="l2.598">       &lt;/method&gt;</span>
<a href="#l2.599"></a><span id="l2.599"> </span>
<a href="#l2.600"></a><span id="l2.600">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l2.601"></a><span id="l2.601">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.602"></a><span id="l2.602">             return (this.nodeName == currentView().nodeName);</span>
<a href="#l2.603"></a><span id="l2.603">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.604"></a><span id="l2.604">       &lt;/method&gt;</span>
<a href="#l2.605"></a><span id="l2.605"> </span>
<a href="#l2.606"></a><span id="l2.606">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l2.607"></a><span id="l2.607">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-          if (this.isVisible()) {</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-              this.addItemsFromCalendar(this.mCalendar);</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-          }</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+            if (this.isVisible()) {</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+                this.addItemsFromCalendar(this.mCalendar);</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+            }</span>
<a href="#l2.614"></a><span id="l2.614">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.615"></a><span id="l2.615">       &lt;/method&gt;</span>
<a href="#l2.616"></a><span id="l2.616"> </span>
<a href="#l2.617"></a><span id="l2.617">       &lt;!-- force refresh visible and invisible views.</span>
<a href="#l2.618"></a><span id="l2.618">            This method is added because when only a preference is toggled, the start</span>
<a href="#l2.619"></a><span id="l2.619">            and end date of views are unchanged, therefore those views behind the</span>
<a href="#l2.620"></a><span id="l2.620">            &quot;scene&quot; might stay the same upon switch to them. --&gt;</span>
<a href="#l2.621"></a><span id="l2.621">       &lt;method name=&quot;forceRefresh&quot;&gt;</span>
<a href="#l2.622"></a><span id="l2.622">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-          this.addItemsFromCalendar(this.mCalendar);</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+            this.addItemsFromCalendar(this.mCalendar);</span>
<a href="#l2.625"></a><span id="l2.625">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.626"></a><span id="l2.626">       &lt;/method&gt;</span>
<a href="#l2.627"></a><span id="l2.627"> </span>
<a href="#l2.628"></a><span id="l2.628">       &lt;method name=&quot;addItemsFromCalendar&quot;&gt;</span>
<a href="#l2.629"></a><span id="l2.629">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l2.630"></a><span id="l2.630">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-          let refreshJob = {</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-              QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-              calView: this,</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-              calendar: null,</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineminus">-              calId: null,</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineminus">-              operation: null,</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-              cancelled: false,</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+            let refreshJob = {</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+                QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+                calView: this,</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+                calendar: null,</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+                calId: null,</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+                operation: null,</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+                cancelled: false,</span>
<a href="#l2.645"></a><span id="l2.645"> </span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-              onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-                  this.calView.mLog.info(&quot;Refresh complete of calendar &quot; + this.calId);</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-                  if (this.calView.mPendingRefreshJobs.has(this.calId)) {</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-                      this.calView.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-                  }</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineplus">+                onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineplus">+                    this.calView.mLog.info(&quot;Refresh complete of calendar &quot; + this.calId);</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineplus">+                    if (this.calView.mPendingRefreshJobs.has(this.calId)) {</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+                        this.calView.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineplus">+                    }</span>
<a href="#l2.656"></a><span id="l2.656"> </span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-                  if (!this.cancelled) {</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-                      // Fire event</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-                      this.calView.fireEvent(&quot;viewloaded&quot;, aOperationType);</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-                  }</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-              },</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+                    if (!this.cancelled) {</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+                        // Fire event</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+                        this.calView.fireEvent(&quot;viewloaded&quot;, aOperationType);</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+                    }</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineplus">+                },</span>
<a href="#l2.667"></a><span id="l2.667"> </span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-              onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-                  if (this.cancelled || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-                      return;</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-                  }</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+                onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+                    if (this.cancelled || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+                        return;</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+                    }</span>
<a href="#l2.676"></a><span id="l2.676"> </span>
<a href="#l2.677"></a><span id="l2.677" class="difflineminus">-                  for (let item of aItems) {</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-                      if (!cal.isToDo(item) || item.entryDate || item.dueDate) {</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-                          this.calView.doAddItem(item);</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineminus">-                      }</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineminus">-                  }</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-              },</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineplus">+                    for (let item of aItems) {</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+                        if (!cal.isToDo(item) || item.entryDate || item.dueDate) {</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineplus">+                            this.calView.doAddItem(item);</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+                        }</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineplus">+                    }</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineplus">+                },</span>
<a href="#l2.689"></a><span id="l2.689"> </span>
<a href="#l2.690"></a><span id="l2.690" class="difflineminus">-              cancel: function() {</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-                  this.calView.mLog.info(&quot;Refresh cancelled for calendar &quot; + this.calId);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineminus">-                  this.cancelled = true;</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineminus">-                  let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineminus">-                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineminus">-                      operation.cancel();</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-                      this.operation = null;</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-                  }</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-              },</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+                cancel: function() {</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineplus">+                    this.calView.mLog.info(&quot;Refresh cancelled for calendar &quot; + this.calId);</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineplus">+                    this.cancelled = true;</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+                    let operation = cal.wrapInstance(this.operation, Components.interfaces.calIOperation);</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+                    if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+                        operation.cancel();</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+                        this.operation = null;</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+                    }</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+                },</span>
<a href="#l2.708"></a><span id="l2.708"> </span>
<a href="#l2.709"></a><span id="l2.709" class="difflineminus">-              execute: function() {</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineminus">-                  if (!this.calView.startDate || !this.calView.endDate || !aCalendar) {</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-                      return;</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-                  }</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+                execute: function() {</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+                    if (!this.calView.startDate || !this.calView.endDate || !aCalendar) {</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineplus">+                        return;</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineplus">+                    }</span>
<a href="#l2.717"></a><span id="l2.717"> </span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-                  if (aCalendar.type == &quot;composite&quot;) {</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-                      // we're refreshing from the composite calendar, so we can cancel</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-                      // all other pending refresh jobs.</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineminus">-                      this.calView.mLog.info(&quot;Refreshing composite calendar, cancelling all pending refreshes&quot;);</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineminus">-                      this.calId = &quot;composite&quot;;</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-                      for (let job of this.calView.mPendingRefreshJobs.values()) {</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-                          job.cancel();</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-                      }</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-                      this.calView.mPendingRefreshJobs.clear();</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineminus">-                      this.calView.relayout();</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-                  } else {</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-                      this.calId = aCalendar.id;</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-                      if (this.calView.mPendingRefreshJobs.has(this.calId)) {</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-                          this.calView.mPendingRefreshJobs.get(this.calId).cancel();</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-                          this.calView.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineminus">-                      }</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-                  }</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-                  this.calendar = aCalendar;</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+                    if (aCalendar.type == &quot;composite&quot;) {</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+                        // we're refreshing from the composite calendar, so we can cancel</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineplus">+                        // all other pending refresh jobs.</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+                        this.calView.mLog.info(&quot;Refreshing composite calendar, cancelling all pending refreshes&quot;);</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineplus">+                        this.calId = &quot;composite&quot;;</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+                        for (let job of this.calView.mPendingRefreshJobs.values()) {</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+                            job.cancel();</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineplus">+                        }</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineplus">+                        this.calView.mPendingRefreshJobs.clear();</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineplus">+                        this.calView.relayout();</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+                    } else {</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+                        this.calId = aCalendar.id;</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+                        if (this.calView.mPendingRefreshJobs.has(this.calId)) {</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+                            this.calView.mPendingRefreshJobs.get(this.calId).cancel();</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+                            this.calView.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+                        }</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+                    }</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+                    this.calendar = aCalendar;</span>
<a href="#l2.754"></a><span id="l2.754"> </span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-                  // start our items query; for a disjoint date range</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-                  // we get all the items, and just filter out the ones we don't</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineminus">-                  // care about in addItem</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-                  let filter = this.calendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-                  if (this.calView.mShowCompleted) {</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-                      filter |= this.calendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-                  } else {</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-                      filter |= this.calendar.ITEM_FILTER_COMPLETED_NO;</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-                  }</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+                    // start our items query; for a disjoint date range</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+                    // we get all the items, and just filter out the ones we don't</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+                    // care about in addItem</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineplus">+                    let filter = this.calendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+                    if (this.calView.mShowCompleted) {</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineplus">+                        filter |= this.calendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+                    } else {</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineplus">+                        filter |= this.calendar.ITEM_FILTER_COMPLETED_NO;</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+                    }</span>
<a href="#l2.773"></a><span id="l2.773"> </span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-                  if (this.calView.mTasksInView) {</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-                      filter |= this.calendar.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineminus">-                  } else {</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineminus">-                      filter |= this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-                  }</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+                    if (this.calView.mTasksInView) {</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineplus">+                        filter |= this.calendar.ITEM_FILTER_TYPE_ALL;</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineplus">+                    } else {</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+                        filter |= this.calendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineplus">+                    }</span>
<a href="#l2.784"></a><span id="l2.784"> </span>
<a href="#l2.785"></a><span id="l2.785" class="difflineminus">-                  let operation = this.calendar.getItems(filter,</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineminus">-                                                         0,</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineminus">-                                                         this.calView.startDate,</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineminus">-                                                         this.calView.queryEndDate,</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-                                                         this);</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-                  operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-                      this.operation = operation;</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineminus">-                      this.calView.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineminus">-                  }</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineminus">-              }</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineminus">-          };</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineplus">+                    let operation = this.calendar.getItems(filter,</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+                                                           0,</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineplus">+                                                           this.calView.startDate,</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineplus">+                                                           this.calView.queryEndDate,</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineplus">+                                                           this);</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineplus">+                    operation = cal.wrapInstance(operation, Components.interfaces.calIOperation);</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+                    if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+                        this.operation = operation;</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+                        this.calView.mPendingRefreshJobs.set(this.calId, this);</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+                    }</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineplus">+                }</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineplus">+            };</span>
<a href="#l2.809"></a><span id="l2.809"> </span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-          refreshJob.execute();</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineplus">+            refreshJob.execute();</span>
<a href="#l2.812"></a><span id="l2.812">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.813"></a><span id="l2.813">       &lt;/method&gt;</span>
<a href="#l2.814"></a><span id="l2.814"> </span>
<a href="#l2.815"></a><span id="l2.815">       &lt;method name=&quot;deleteItemsFromCalendar&quot;&gt;</span>
<a href="#l2.816"></a><span id="l2.816">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l2.817"></a><span id="l2.817">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineminus">-          /* This method must be implemented in subclasses. */</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineminus">-          throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+            /* This method must be implemented in subclasses. */</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineplus">+            throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.822"></a><span id="l2.822">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.823"></a><span id="l2.823">       &lt;/method&gt;</span>
<a href="#l2.824"></a><span id="l2.824"> </span>
<a href="#l2.825"></a><span id="l2.825">       &lt;!-- the end date that should be used for getItems and similar queries --&gt;</span>
<a href="#l2.826"></a><span id="l2.826">       &lt;property name=&quot;queryEndDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l2.827"></a><span id="l2.827">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineminus">-          let end = this.endDate;</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineminus">-          if (!end) {</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineminus">-              return null;</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-          }</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-          end = end.clone();</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineminus">-          end.day += 1;</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineminus">-          end.isDate = true;</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineminus">-          return end;</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineplus">+            let end = this.endDate;</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineplus">+            if (!end) {</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineplus">+                return null;</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineplus">+            }</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineplus">+            end = end.clone();</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineplus">+            end.day += 1;</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineplus">+            end.isDate = true;</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+            return end;</span>
<a href="#l2.844"></a><span id="l2.844">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.845"></a><span id="l2.845">       &lt;/property&gt;</span>
<a href="#l2.846"></a><span id="l2.846"> </span>
<a href="#l2.847"></a><span id="l2.847">       &lt;method name=&quot;fireEvent&quot;&gt;</span>
<a href="#l2.848"></a><span id="l2.848">         &lt;parameter name=&quot;aEventName&quot;/&gt;</span>
<a href="#l2.849"></a><span id="l2.849">         &lt;parameter name=&quot;aEventDetail&quot;/&gt;</span>
<a href="#l2.850"></a><span id="l2.850">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineminus">-          event.initEvent(aEventName, true, false);</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineminus">-          event.detail = aEventDetail;</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineplus">+            event.initEvent(aEventName, true, false);</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineplus">+            event.detail = aEventDetail;</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l2.859"></a><span id="l2.859">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.860"></a><span id="l2.860">       &lt;/method&gt;</span>
<a href="#l2.861"></a><span id="l2.861"> </span>
<a href="#l2.862"></a><span id="l2.862">       &lt;method name=&quot;removeDropShadows&quot;&gt;</span>
<a href="#l2.863"></a><span id="l2.863">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineminus">-          let dropbox = document.getAnonymousElementByAttribute(this, &quot;dropbox&quot;, &quot;true&quot;);</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineminus">-          if (dropbox &amp;&amp; dropbox !== undefined) {</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineminus">-              dropbox.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineminus">-          }</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineplus">+            let dropbox = document.getAnonymousElementByAttribute(this, &quot;dropbox&quot;, &quot;true&quot;);</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineplus">+            if (dropbox &amp;&amp; dropbox !== undefined) {</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineplus">+                dropbox.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+            }</span>
<a href="#l2.872"></a><span id="l2.872">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.873"></a><span id="l2.873">       &lt;/method&gt;</span>
<a href="#l2.874"></a><span id="l2.874"> </span>
<a href="#l2.875"></a><span id="l2.875">       &lt;method name=&quot;getLongWeekdayTotalPixels&quot;&gt;</span>
<a href="#l2.876"></a><span id="l2.876">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineminus">-          if (this.mLongWeekdayTotalPixels &lt;= 0) {</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineminus">-              let maxDayWidth = 0;</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineminus">-              for (let label of this.labeldaybox.childNodes) {</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineminus">-                  if (label.localName &amp;&amp; label.localName == &quot;calendar-day-label&quot;) {</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineminus">-                      label.shortWeekNames = false;</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineminus">-                      let curPixelLength = label.getLongWeekdayPixels();</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineminus">-                      maxDayWidth = Math.max(maxDayWidth, curPixelLength);</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineminus">-                  }</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineminus">-              }</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineminus">-              if (maxDayWidth &gt; 0) {</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-                  this.mLongWeekdayTotalPixels = (maxDayWidth * this.labeldaybox.childNodes.length) + 10;</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-              }</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineminus">-          }</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineminus">-          return this.mLongWeekdayTotalPixels;</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+            if (this.mLongWeekdayTotalPixels &lt;= 0) {</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineplus">+                let maxDayWidth = 0;</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineplus">+                for (let label of this.labeldaybox.childNodes) {</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineplus">+                    if (label.localName &amp;&amp; label.localName == &quot;calendar-day-label&quot;) {</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineplus">+                        label.shortWeekNames = false;</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineplus">+                        let curPixelLength = label.getLongWeekdayPixels();</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineplus">+                        maxDayWidth = Math.max(maxDayWidth, curPixelLength);</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineplus">+                    }</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineplus">+                }</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineplus">+                if (maxDayWidth &gt; 0) {</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+                    this.mLongWeekdayTotalPixels = (maxDayWidth * this.labeldaybox.childNodes.length) + 10;</span>
<a href="#l2.902"></a><span id="l2.902" class="difflineplus">+                }</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineplus">+            }</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineplus">+            return this.mLongWeekdayTotalPixels;</span>
<a href="#l2.905"></a><span id="l2.905">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.906"></a><span id="l2.906">       &lt;/method&gt;</span>
<a href="#l2.907"></a><span id="l2.907"> </span>
<a href="#l2.908"></a><span id="l2.908">       &lt;!-- A preference handler which is called by the preference observer.</span>
<a href="#l2.909"></a><span id="l2.909">            Can be overwritten in derived bindings. --&gt;</span>
<a href="#l2.910"></a><span id="l2.910">       &lt;method name=&quot;handleCommonPreference&quot;&gt;</span>
<a href="#l2.911"></a><span id="l2.911">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l2.912"></a><span id="l2.912">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l2.913"></a><span id="l2.913">         &lt;parameter name=&quot;aPreference&quot;/&gt;</span>
<a href="#l2.914"></a><span id="l2.914">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineminus">-          // refresh view if categories seem to have changed</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineminus">-          if (aPreference.startsWith(&quot;calendar.category.color&quot;)) {</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineminus">-              this.refreshView();</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-              return;</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineminus">-          }</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineminus">-          switch (aPreference) {</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineminus">-              case &quot;calendar.week.d0sundaysoff&quot;:</span>
<a href="#l2.922"></a><span id="l2.922" class="difflineminus">-              case &quot;calendar.week.d1mondaysoff&quot;:</span>
<a href="#l2.923"></a><span id="l2.923" class="difflineminus">-              case &quot;calendar.week.d2tuesdaysoff&quot;:</span>
<a href="#l2.924"></a><span id="l2.924" class="difflineminus">-              case &quot;calendar.week.d3wednesdaysoff&quot;:</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineminus">-              case &quot;calendar.week.d4thursdaysoff&quot;:</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineminus">-              case &quot;calendar.week.d5fridaysoff&quot;:</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineminus">-              case &quot;calendar.week.d6saturdaysoff&quot;:</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineminus">-                  this.updateDaysOffPrefs();</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineminus">-                  break;</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineminus">-              case &quot;calendar.timezone.local&quot;:</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineminus">-                  this.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineminus">-                  this.refreshView();</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineminus">-                  break;</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineminus">-              case &quot;calendar.alarms.indicator.show&quot;:</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineminus">-                  // Break here to ensure the view is refreshed</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineminus">-                  break;</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineminus">-              case &quot;calendar.week.start&quot;:</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineminus">-                  this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineminus">-                  break;</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineminus">-              case &quot;calendar.date.format&quot;:</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineminus">-                  this.refreshView();</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineminus">-                  break;</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineminus">-              default:</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineminus">-                  return;</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineminus">-          }</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineminus">-          this.refreshView();</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineplus">+            // refresh view if categories seem to have changed</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineplus">+            if (aPreference.startsWith(&quot;calendar.category.color&quot;)) {</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineplus">+                this.refreshView();</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineplus">+                return;</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineplus">+            }</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineplus">+            switch (aPreference) {</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineplus">+                case &quot;calendar.week.d0sundaysoff&quot;:</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineplus">+                case &quot;calendar.week.d1mondaysoff&quot;:</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineplus">+                case &quot;calendar.week.d2tuesdaysoff&quot;:</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineplus">+                case &quot;calendar.week.d3wednesdaysoff&quot;:</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+                case &quot;calendar.week.d4thursdaysoff&quot;:</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+                case &quot;calendar.week.d5fridaysoff&quot;:</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+                case &quot;calendar.week.d6saturdaysoff&quot;:</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineplus">+                    this.updateDaysOffPrefs();</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineplus">+                    break;</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineplus">+                case &quot;calendar.timezone.local&quot;:</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineplus">+                    this.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineplus">+                    this.refreshView();</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+                    break;</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+                case &quot;calendar.alarms.indicator.show&quot;:</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineplus">+                    // Break here to ensure the view is refreshed</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineplus">+                    break;</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineplus">+                case &quot;calendar.week.start&quot;:</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineplus">+                    this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineplus">+                    break;</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineplus">+                case &quot;calendar.date.format&quot;:</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineplus">+                    this.refreshView();</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+                    break;</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineplus">+                default:</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineplus">+                    return;</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineplus">+            }</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineplus">+            this.refreshView();</span>
<a href="#l2.979"></a><span id="l2.979">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.980"></a><span id="l2.980">       &lt;/method&gt;</span>
<a href="#l2.981"></a><span id="l2.981"> </span>
<a href="#l2.982"></a><span id="l2.982">       &lt;method name=&quot;updateDaysOffPrefs&quot;&gt;</span>
<a href="#l2.983"></a><span id="l2.983">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-          const weekPrefix = &quot;calendar.week.&quot;;</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-          const prefNames = [</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineminus">-              &quot;d0sundaysoff&quot;, &quot;d1mondaysoff&quot;, &quot;d2tuesdaysoff&quot;,</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineminus">-              &quot;d3wednesdaysoff&quot;, &quot;d4thursdaysoff&quot;, &quot;d5fridaysoff&quot;,</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineminus">-              &quot;d6saturdaysoff&quot;</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineminus">-          ];</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-          const defaults = [</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineminus">-              &quot;true&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;true&quot;</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-          ];</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-          let daysOff = [];</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineminus">-          for (let i in prefNames) {</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineminus">-              if (Preferences.get(weekPrefix + prefNames[i], defaults[i])) {</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineminus">-                  daysOff.push(Number(i));</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineminus">-              }</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineminus">-          }</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-          this.daysOffArray = daysOff;</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineplus">+            const weekPrefix = &quot;calendar.week.&quot;;</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineplus">+            const prefNames = [</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineplus">+                &quot;d0sundaysoff&quot;, &quot;d1mondaysoff&quot;, &quot;d2tuesdaysoff&quot;,</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineplus">+                &quot;d3wednesdaysoff&quot;, &quot;d4thursdaysoff&quot;, &quot;d5fridaysoff&quot;,</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+                &quot;d6saturdaysoff&quot;</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+            ];</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+            const defaults = [</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+                &quot;true&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;false&quot;, &quot;true&quot;</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+            ];</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+            let daysOff = [];</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+            for (let i in prefNames) {</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+                if (Preferences.get(weekPrefix + prefNames[i], defaults[i])) {</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineplus">+                    daysOff.push(Number(i));</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineplus">+                }</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+            }</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineplus">+            this.daysOffArray = daysOff;</span>
<a href="#l2.1016"></a><span id="l2.1016">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1017"></a><span id="l2.1017">       &lt;/method&gt;</span>
<a href="#l2.1018"></a><span id="l2.1018"> </span>
<a href="#l2.1019"></a><span id="l2.1019">       &lt;method name=&quot;refreshView&quot;&gt;</span>
<a href="#l2.1020"></a><span id="l2.1020">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineminus">-          if (!this.startDay || !this.endDay) {</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineminus">-              // don't refresh if we're not initialized</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-              return;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-          }</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-          // Just refresh, the goToDay function will notice</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineminus">-          this.goToDay(this.selectedDay);</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineminus">-          this.forceRefresh();</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+            if (!this.startDay || !this.endDay) {</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+                // don't refresh if we're not initialized</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+                return;</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineplus">+            }</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+            // Just refresh, the goToDay function will notice</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineplus">+            this.goToDay(this.selectedDay);</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineplus">+            this.forceRefresh();</span>
<a href="#l2.1035"></a><span id="l2.1035">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1036"></a><span id="l2.1036">       &lt;/method&gt;</span>
<a href="#l2.1037"></a><span id="l2.1037"> </span>
<a href="#l2.1038"></a><span id="l2.1038">       &lt;!-- Default implementations follow, these make things easier for</span>
<a href="#l2.1039"></a><span id="l2.1039">             extensions that don't need certain features. --&gt;</span>
<a href="#l2.1040"></a><span id="l2.1040">       &lt;method name=&quot;handlePreference&quot;&gt;</span>
<a href="#l2.1041"></a><span id="l2.1041">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l2.1042"></a><span id="l2.1042">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l2.1043"></a><span id="l2.1043">         &lt;parameter name=&quot;aPref&quot;/&gt;</span>
<a href="#l2.1044"></a><span id="l2.1044">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineminus">-          // Do nothing by default</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineplus">+            // Do nothing by default</span>
<a href="#l2.1047"></a><span id="l2.1047">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1048"></a><span id="l2.1048">       &lt;/method&gt;</span>
<a href="#l2.1049"></a><span id="l2.1049">       &lt;method name=&quot;setDateRange&quot;&gt;</span>
<a href="#l2.1050"></a><span id="l2.1050">         &lt;parameter name=&quot;aStartDate&quot;/&gt;</span>
<a href="#l2.1051"></a><span id="l2.1051">         &lt;parameter name=&quot;aEndDate&quot;/&gt;</span>
<a href="#l2.1052"></a><span id="l2.1052">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineminus">-          cal.navigationBar.setDateRange(aStartDate, aEndDate);</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineplus">+            cal.navigationBar.setDateRange(aStartDate, aEndDate);</span>
<a href="#l2.1055"></a><span id="l2.1055">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1056"></a><span id="l2.1056">       &lt;/method&gt;</span>
<a href="#l2.1057"></a><span id="l2.1057"> </span>
<a href="#l2.1058"></a><span id="l2.1058">       &lt;property name=&quot;selectedDay&quot;</span>
<a href="#l2.1059"></a><span id="l2.1059">                 onget=&quot;return this.startDate&quot;</span>
<a href="#l2.1060"></a><span id="l2.1060">                 onset=&quot;return this.startDate&quot;/&gt;</span>
<a href="#l2.1061"></a><span id="l2.1061"> </span>
<a href="#l2.1062"></a><span id="l2.1062">       &lt;method name=&quot;getSelectedItems&quot;&gt;</span>
<a href="#l2.1063"></a><span id="l2.1063">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l2.1064"></a><span id="l2.1064">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-          aCount.value = this.mSelectedItems.length;</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineminus">-          return this.mSelectedItems;</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineplus">+            aCount.value = this.mSelectedItems.length;</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineplus">+            return this.mSelectedItems;</span>
<a href="#l2.1069"></a><span id="l2.1069">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1070"></a><span id="l2.1070">       &lt;/method&gt;</span>
<a href="#l2.1071"></a><span id="l2.1071">       &lt;method name=&quot;setSelectedItems&quot;&gt;</span>
<a href="#l2.1072"></a><span id="l2.1072">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l2.1073"></a><span id="l2.1073">         &lt;parameter name=&quot;aItems&quot;/&gt;</span>
<a href="#l2.1074"></a><span id="l2.1074">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineminus">-          this.mSelectedItems = aItems.concat([]);</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineminus">-          return this.mSelectedItems;</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineplus">+            this.mSelectedItems = aItems.concat([]);</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineplus">+            return this.mSelectedItems;</span>
<a href="#l2.1079"></a><span id="l2.1079">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1080"></a><span id="l2.1080">       &lt;/method&gt;</span>
<a href="#l2.1081"></a><span id="l2.1081"> </span>
<a href="#l2.1082"></a><span id="l2.1082">       &lt;method name=&quot;getDateList&quot;&gt;</span>
<a href="#l2.1083"></a><span id="l2.1083">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l2.1084"></a><span id="l2.1084">         &lt;parameter name=&quot;aDates&quot;/&gt;</span>
<a href="#l2.1085"></a><span id="l2.1085">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-          let start = this.startDate.clone();</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-          while (start.compare(this.endDate) &lt;= 0) {</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-              dates.push(start);</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-              start.day++;</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineminus">-          }</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineminus">-          aCount.value = dates.length;</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineminus">-          return dates;</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineplus">+            let start = this.startDate.clone();</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineplus">+            while (start.compare(this.endDate) &lt;= 0) {</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineplus">+                dates.push(start);</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineplus">+                start.day++;</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+            }</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+            aCount.value = dates.length;</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+            return dates;</span>
<a href="#l2.1100"></a><span id="l2.1100">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1101"></a><span id="l2.1101">       &lt;/method&gt;</span>
<a href="#l2.1102"></a><span id="l2.1102"> </span>
<a href="#l2.1103"></a><span id="l2.1103">       &lt;method name=&quot;flashAlarm&quot;&gt;</span>
<a href="#l2.1104"></a><span id="l2.1104">         &lt;parameter name=&quot;aAlarmItem&quot;/&gt;</span>
<a href="#l2.1105"></a><span id="l2.1105">         &lt;parameter name=&quot;aStop&quot;/&gt;</span>
<a href="#l2.1106"></a><span id="l2.1106">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineminus">-          // Do nothing by default</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineplus">+            // Do nothing by default</span>
<a href="#l2.1109"></a><span id="l2.1109">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1110"></a><span id="l2.1110">       &lt;/method&gt;</span>
<a href="#l2.1111"></a><span id="l2.1111"> </span>
<a href="#l2.1112"></a><span id="l2.1112">       &lt;method name=&quot;zoomIn&quot;&gt;</span>
<a href="#l2.1113"></a><span id="l2.1113">         &lt;parameter name=&quot;aLevel&quot;/&gt;</span>
<a href="#l2.1114"></a><span id="l2.1114">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1115"></a><span id="l2.1115">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1116"></a><span id="l2.1116">       &lt;/method&gt;</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineat">@@ -758,98 +758,98 @@</span>
<a href="#l2.1118"></a><span id="l2.1118">       &lt;method name=&quot;zoomReset&quot;&gt;</span>
<a href="#l2.1119"></a><span id="l2.1119">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1120"></a><span id="l2.1120">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1121"></a><span id="l2.1121">       &lt;/method&gt;</span>
<a href="#l2.1122"></a><span id="l2.1122">     &lt;/implementation&gt;</span>
<a href="#l2.1123"></a><span id="l2.1123"> </span>
<a href="#l2.1124"></a><span id="l2.1124">     &lt;handlers&gt;</span>
<a href="#l2.1125"></a><span id="l2.1125">       &lt;handler event=&quot;move&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineminus">-        this.moveView(event.detail);</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+          this.moveView(event.detail);</span>
<a href="#l2.1128"></a><span id="l2.1128">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1129"></a><span id="l2.1129">       &lt;handler event=&quot;keypress&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-        const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineminus">-        switch (event.keyCode) {</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineminus">-            case kKE.DOM_VK_PAGE_UP:</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-                this.moveView(-1);</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineminus">-                break;</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineminus">-            case kKE.DOM_VK_PAGE_DOWN:</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineminus">-                this.moveView(1);</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineminus">-                break;</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineminus">-        }</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+          const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineplus">+          switch (event.keyCode) {</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineplus">+              case kKE.DOM_VK_PAGE_UP:</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineplus">+                  this.moveView(-1);</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+                  break;</span>
<a href="#l2.1144"></a><span id="l2.1144" class="difflineplus">+              case kKE.DOM_VK_PAGE_DOWN:</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineplus">+                  this.moveView(1);</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineplus">+                  break;</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineplus">+          }</span>
<a href="#l2.1148"></a><span id="l2.1148">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1149"></a><span id="l2.1149">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineminus">-        const pixelThreshold = 150;</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineminus">-        if (event.shiftKey &amp;&amp; Preferences.get(&quot;calendar.view.mousescroll&quot;, true)) {</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineminus">-            if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineminus">-                if (event.deltaY != 0) {</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineminus">-                    deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineminus">-                }</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineminus">-            } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineminus">-                this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineminus">-                if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineminus">-                    deltaView = 1;</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineminus">-                    this.mPixelScrollDelta = 0;</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-                } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineminus">-                    deltaView = -1;</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineminus">-                    this.mPixelScrollDelta = 0;</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineminus">-                }</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineminus">-            }</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+          const pixelThreshold = 150;</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+          if (event.shiftKey &amp;&amp; Preferences.get(&quot;calendar.view.mousescroll&quot;, true)) {</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineplus">+              if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+                  if (event.deltaY != 0) {</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+                      deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+                  }</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineplus">+              } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineplus">+                  this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+                  if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+                      deltaView = 1;</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineplus">+                      this.mPixelScrollDelta = 0;</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineplus">+                  } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineplus">+                      deltaView = -1;</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineplus">+                      this.mPixelScrollDelta = 0;</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineplus">+                  }</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineplus">+              }</span>
<a href="#l2.1182"></a><span id="l2.1182"> </span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineminus">-            if (deltaView != 0) {</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineminus">-                this.moveView(deltaView);</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineminus">-            }</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineminus">-        }</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineplus">+              if (deltaView != 0) {</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineplus">+                  this.moveView(deltaView);</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineplus">+              }</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineplus">+          }</span>
<a href="#l2.1191"></a><span id="l2.1191"> </span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineminus">-        // Prevent default scroll handling</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-        event.preventDefault();</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+          // Prevent default scroll handling</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineplus">+          event.preventDefault();</span>
<a href="#l2.1196"></a><span id="l2.1196">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1197"></a><span id="l2.1197">       &lt;handler event=&quot;MozRotateGesture&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineminus">-        // Threshold for the minimum and maximum angle we should accept</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineminus">-        // rotation for. 90 degrees minimum is most logical, but 45 degrees</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineminus">-        // allows you to rotate with one hand.</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineminus">-        const MIN_ROTATE_ANGLE = 45;</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineminus">-        const MAX_ROTATE_ANGLE = 180;</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineplus">+          // Threshold for the minimum and maximum angle we should accept</span>
<a href="#l2.1204"></a><span id="l2.1204" class="difflineplus">+          // rotation for. 90 degrees minimum is most logical, but 45 degrees</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineplus">+          // allows you to rotate with one hand.</span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineplus">+          const MIN_ROTATE_ANGLE = 45;</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineplus">+          const MAX_ROTATE_ANGLE = 180;</span>
<a href="#l2.1208"></a><span id="l2.1208"> </span>
<a href="#l2.1209"></a><span id="l2.1209" class="difflineminus">-        let absval = Math.abs(event.delta);</span>
<a href="#l2.1210"></a><span id="l2.1210" class="difflineminus">-        if (this.supportsRotation &amp;&amp;</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineminus">-            absval &gt;= MIN_ROTATE_ANGLE &amp;&amp;</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineminus">-            absval &lt; MAX_ROTATE_ANGLE) {</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineminus">-            toggleOrientation();</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineminus">-            event.preventDefault();</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineminus">-        }</span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineplus">+          let absval = Math.abs(event.delta);</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineplus">+          if (this.supportsRotation &amp;&amp;</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineplus">+              absval &gt;= MIN_ROTATE_ANGLE &amp;&amp;</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineplus">+              absval &lt; MAX_ROTATE_ANGLE) {</span>
<a href="#l2.1220"></a><span id="l2.1220" class="difflineplus">+              toggleOrientation();</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineplus">+              event.preventDefault();</span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineplus">+          }</span>
<a href="#l2.1223"></a><span id="l2.1223">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1224"></a><span id="l2.1224">       &lt;handler event=&quot;MozMagnifyGestureStart&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1225"></a><span id="l2.1225" class="difflineminus">-        this.mMagnifyAmount = 0;</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineplus">+          this.mMagnifyAmount = 0;</span>
<a href="#l2.1227"></a><span id="l2.1227">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1228"></a><span id="l2.1228">       &lt;handler event=&quot;MozMagnifyGestureUpdate&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineminus">-        // Threshold as to how much magnification causes the zoom to happen</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineminus">-        const THRESHOLD = 30;</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineplus">+          // Threshold as to how much magnification causes the zoom to happen</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineplus">+          const THRESHOLD = 30;</span>
<a href="#l2.1233"></a><span id="l2.1233"> </span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineminus">-        if (this.supportsZoom) {</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineminus">-            this.mMagnifyAmount += event.delta;</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineplus">+          if (this.supportsZoom) {</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineplus">+              this.mMagnifyAmount += event.delta;</span>
<a href="#l2.1238"></a><span id="l2.1238"> </span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineminus">-            if (this.mMagnifyAmount &gt; THRESHOLD) {</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineminus">-                this.zoomOut();</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineminus">-                this.mMagnifyAmount = 0;</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineminus">-            } else if (this.mMagnifyAmount &lt; -THRESHOLD) {</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineminus">-                this.zoomIn();</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineminus">-                this.mMagnifyAmount = 0;</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineminus">-            }</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineminus">-            event.preventDefault();</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineminus">-        }</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineplus">+              if (this.mMagnifyAmount &gt; THRESHOLD) {</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineplus">+                  this.zoomOut();</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineplus">+                  this.mMagnifyAmount = 0;</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineplus">+              } else if (this.mMagnifyAmount &lt; -THRESHOLD) {</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+                  this.zoomIn();</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+                  this.mMagnifyAmount = 0;</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineplus">+              }</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineplus">+              event.preventDefault();</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineplus">+          }</span>
<a href="#l2.1257"></a><span id="l2.1257">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1258"></a><span id="l2.1258">       &lt;handler event=&quot;MozSwipeGesture&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineminus">-        if ((event.direction == SimpleGestureEvent.DIRECTION_UP &amp;&amp; !this.rotated) ||</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineminus">-            (event.direction == SimpleGestureEvent.DIRECTION_LEFT &amp;&amp; this.rotated)) {</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineminus">-            this.moveView(-1);</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineminus">-        } else if ((event.direction == SimpleGestureEvent.DIRECTION_DOWN &amp;&amp; !this.rotated) ||</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineminus">-                   (event.direction == SimpleGestureEvent.DIRECTION_RIGHT &amp;&amp; this.rotated)) {</span>
<a href="#l2.1264"></a><span id="l2.1264" class="difflineminus">-            this.moveView(1);</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineminus">-        }</span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineplus">+          if ((event.direction == SimpleGestureEvent.DIRECTION_UP &amp;&amp; !this.rotated) ||</span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineplus">+              (event.direction == SimpleGestureEvent.DIRECTION_LEFT &amp;&amp; this.rotated)) {</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineplus">+              this.moveView(-1);</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineplus">+          } else if ((event.direction == SimpleGestureEvent.DIRECTION_DOWN &amp;&amp; !this.rotated) ||</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineplus">+                     (event.direction == SimpleGestureEvent.DIRECTION_RIGHT &amp;&amp; this.rotated)) {</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+              this.moveView(1);</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineplus">+          }</span>
<a href="#l2.1273"></a><span id="l2.1273">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l2.1274"></a><span id="l2.1274">     &lt;/handlers&gt;</span>
<a href="#l2.1275"></a><span id="l2.1275">   &lt;/binding&gt;</span>
<a href="#l2.1276"></a><span id="l2.1276"> </span>
<a href="#l2.1277"></a><span id="l2.1277">   &lt;binding id=&quot;calendar-day-label&quot; extends=&quot;xul:box&quot;&gt;</span>
<a href="#l2.1278"></a><span id="l2.1278">     &lt;content flex=&quot;1&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l2.1279"></a><span id="l2.1279">       &lt;xul:label anonid=&quot;longWeekdayName&quot; class=&quot;calendar-day-label-name&quot; xbl:inherits=&quot;selected,relation&quot;/&gt;</span>
<a href="#l2.1280"></a><span id="l2.1280">       &lt;xul:label anonid=&quot;shortWeekdayName&quot; class=&quot;calendar-day-label-name&quot; hidden=&quot;true&quot; xbl:inherits=&quot;selected,relation&quot;/&gt;</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineat">@@ -858,71 +858,73 @@</span>
<a href="#l2.1282"></a><span id="l2.1282">       &lt;field name=&quot;mWeekday&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l2.1283"></a><span id="l2.1283">       &lt;field name=&quot;longWeekdayPixels&quot;&gt;0&lt;/field&gt;</span>
<a href="#l2.1284"></a><span id="l2.1284">       &lt;field name=&quot;mDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l2.1285"></a><span id="l2.1285">       &lt;property name=&quot;longName&quot; readonly=&quot;true&quot;</span>
<a href="#l2.1286"></a><span id="l2.1286">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'longWeekdayName');&quot;/&gt;</span>
<a href="#l2.1287"></a><span id="l2.1287">       &lt;property name=&quot;shortName&quot; readonly=&quot;true&quot;</span>
<a href="#l2.1288"></a><span id="l2.1288">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'shortWeekdayName');&quot;/&gt;</span>
<a href="#l2.1289"></a><span id="l2.1289">       &lt;property name=&quot;weekDay&quot;&gt;</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineminus">-        &lt;getter&gt;return this.mWeekday;&lt;/getter&gt;</span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+            return this.mWeekday;</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.1294"></a><span id="l2.1294">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineminus">-          this.mWeekday = val % 7;</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineminus">-          this.longName.value = cal.getDateFormatter().dayName(val);</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineminus">-          this.shortName.value = cal.getDateFormatter().shortDayName(val);</span>
<a href="#l2.1298"></a><span id="l2.1298" class="difflineminus">-          return this.mWeekday;</span>
<a href="#l2.1299"></a><span id="l2.1299" class="difflineplus">+            this.mWeekday = val % 7;</span>
<a href="#l2.1300"></a><span id="l2.1300" class="difflineplus">+            this.longName.value = cal.getDateFormatter().dayName(val);</span>
<a href="#l2.1301"></a><span id="l2.1301" class="difflineplus">+            this.shortName.value = cal.getDateFormatter().shortDayName(val);</span>
<a href="#l2.1302"></a><span id="l2.1302" class="difflineplus">+            return this.mWeekday;</span>
<a href="#l2.1303"></a><span id="l2.1303">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.1304"></a><span id="l2.1304">       &lt;/property&gt;</span>
<a href="#l2.1305"></a><span id="l2.1305"> </span>
<a href="#l2.1306"></a><span id="l2.1306">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l2.1307"></a><span id="l2.1307">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineminus">-          return this.mDate;</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineplus">+            return this.mDate;</span>
<a href="#l2.1310"></a><span id="l2.1310">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.1311"></a><span id="l2.1311">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineminus">-          this.mDate = val;</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineminus">-          let dateFormatter = cal.getDateFormatter();</span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineminus">-          let label = cal.calGetString(&quot;calendar&quot;, &quot;dayHeaderLabel&quot;, [</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineminus">-              dateFormatter.shortDayName(val.weekday),</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineminus">-              dateFormatter.formatDateWithoutYear(val)</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineminus">-          ]);</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineminus">-          this.shortName.setAttribute(&quot;value&quot;, label);</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineminus">-          label = cal.calGetString(&quot;calendar&quot;, &quot;dayHeaderLabel&quot;, [</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineminus">-              dateFormatter.dayName(val.weekday),</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineminus">-              dateFormatter.formatDateWithoutYear(val)</span>
<a href="#l2.1322"></a><span id="l2.1322" class="difflineminus">-          ]);</span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineminus">-          this.longName.setAttribute(&quot;value&quot;, label);</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineminus">-          return val;</span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineplus">+            this.mDate = val;</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineplus">+            let dateFormatter = cal.getDateFormatter();</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineplus">+            let label = cal.calGetString(&quot;calendar&quot;, &quot;dayHeaderLabel&quot;, [</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineplus">+                dateFormatter.shortDayName(val.weekday),</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineplus">+                dateFormatter.formatDateWithoutYear(val)</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineplus">+            ]);</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineplus">+            this.shortName.setAttribute(&quot;value&quot;, label);</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+            label = cal.calGetString(&quot;calendar&quot;, &quot;dayHeaderLabel&quot;, [</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+                dateFormatter.dayName(val.weekday),</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+                dateFormatter.formatDateWithoutYear(val)</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineplus">+            ]);</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineplus">+            this.longName.setAttribute(&quot;value&quot;, label);</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineplus">+            return val;</span>
<a href="#l2.1338"></a><span id="l2.1338">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.1339"></a><span id="l2.1339">       &lt;/property&gt;</span>
<a href="#l2.1340"></a><span id="l2.1340"> </span>
<a href="#l2.1341"></a><span id="l2.1341">       &lt;property name=&quot;shortWeekNames&quot;&gt;</span>
<a href="#l2.1342"></a><span id="l2.1342">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.1343"></a><span id="l2.1343">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.1344"></a><span id="l2.1344">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineminus">-          // cache before change, in case we are switching to short</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineminus">-          this.getLongWeekdayPixels();</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineminus">-          setBooleanAttribute(this.longName, &quot;hidden&quot;, val);</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineminus">-          setBooleanAttribute(this.shortName, &quot;hidden&quot;, !val);</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineminus">-          return val;</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineplus">+            // cache before change, in case we are switching to short</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+            this.getLongWeekdayPixels();</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+            setBooleanAttribute(this.longName, &quot;hidden&quot;, val);</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+            setBooleanAttribute(this.shortName, &quot;hidden&quot;, !val);</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineplus">+            return val;</span>
<a href="#l2.1355"></a><span id="l2.1355">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l2.1356"></a><span id="l2.1356">       &lt;/property&gt;</span>
<a href="#l2.1357"></a><span id="l2.1357"> </span>
<a href="#l2.1358"></a><span id="l2.1358">       &lt;method name=&quot;getLongWeekdayPixels&quot;&gt;</span>
<a href="#l2.1359"></a><span id="l2.1359">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineminus">-          // Only do this if the long weekdays are visible and we haven't already cached.</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineminus">-          let longNameWidth = this.longName.boxObject.width;</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineminus">-          if (longNameWidth &gt; 0) {</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineminus">-              this.longWeekdayPixels = longNameWidth +</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineminus">-                                       getSummarizedStyleValues(this.longName, [&quot;margin-left&quot;, &quot;margin-right&quot;]);</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineminus">-              this.longWeekdayPixels += getSummarizedStyleValues(this, [</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineminus">-                  &quot;border-left-width&quot;, &quot;padding-left&quot;, &quot;padding-right&quot;</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineminus">-              ]);</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineminus">-              return this.longWeekdayPixels;</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineminus">-          } else {</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineminus">-              // in this case the weekdaypixels have not yet been layouted;</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-              // by definition 0 is returned</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineminus">-              return 0;</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineminus">-          }</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineplus">+            // Only do this if the long weekdays are visible and we haven't already cached.</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineplus">+            let longNameWidth = this.longName.boxObject.width;</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineplus">+            if (longNameWidth &gt; 0) {</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineplus">+                this.longWeekdayPixels = longNameWidth +</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineplus">+                                         getSummarizedStyleValues(this.longName, [&quot;margin-left&quot;, &quot;margin-right&quot;]);</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineplus">+                this.longWeekdayPixels += getSummarizedStyleValues(this, [</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+                    &quot;border-left-width&quot;, &quot;padding-left&quot;, &quot;padding-right&quot;</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineplus">+                ]);</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+                return this.longWeekdayPixels;</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+            } else {</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+                // in this case the weekdaypixels have not yet been layouted;</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+                // by definition 0 is returned</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+                return 0;</span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineplus">+            }</span>
<a href="#l2.1388"></a><span id="l2.1388">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.1389"></a><span id="l2.1389">       &lt;/method&gt;</span>
<a href="#l2.1390"></a><span id="l2.1390">     &lt;/implementation&gt;</span>
<a href="#l2.1391"></a><span id="l2.1391">   &lt;/binding&gt;</span>
<a href="#l2.1392"></a><span id="l2.1392"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,27 +25,27 @@</span>
<a href="#l3.4"></a><span id="l3.4">                    flex=&quot;1&quot;</span>
<a href="#l3.5"></a><span id="l3.5">                    xbl:inherits=&quot;value=label&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6">       &lt;/xul:hbox&gt;</span>
<a href="#l3.7"></a><span id="l3.7">     &lt;/content&gt;</span>
<a href="#l3.8"></a><span id="l3.8">     &lt;implementation&gt;</span>
<a href="#l3.9"></a><span id="l3.9">       &lt;method name=&quot;onmodified&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          if (aEvent.attrName == &quot;checked&quot;) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-              let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-              event.initEvent(&quot;select&quot;, true, true);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-              this.calendar.dispatchEvent(event);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-          }</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+            if (aEvent.attrName == &quot;checked&quot;) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+                let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                event.initEvent(&quot;select&quot;, true, true);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+                this.calendar.dispatchEvent(event);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+            }</span>
<a href="#l3.22"></a><span id="l3.22">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.23"></a><span id="l3.23">       &lt;/method&gt;</span>
<a href="#l3.24"></a><span id="l3.24">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-        this.setAttribute(&quot;autoCheck&quot;, &quot;true&quot;);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-        this.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-        this.addEventListener(&quot;DOMAttrModified&quot;, this.onmodified);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+          this.setAttribute(&quot;autoCheck&quot;, &quot;true&quot;);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+          this.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+          this.addEventListener(&quot;DOMAttrModified&quot;, this.onmodified);</span>
<a href="#l3.31"></a><span id="l3.31">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l3.32"></a><span id="l3.32">     &lt;/implementation&gt;</span>
<a href="#l3.33"></a><span id="l3.33">   &lt;/binding&gt;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   &lt;!--</span>
<a href="#l3.36"></a><span id="l3.36">   ########################################################################</span>
<a href="#l3.37"></a><span id="l3.37">   ## daypicker-weekday</span>
<a href="#l3.38"></a><span id="l3.38">   ########################################################################</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineat">@@ -72,76 +72,76 @@</span>
<a href="#l3.40"></a><span id="l3.40">       &lt;!--</span>
<a href="#l3.41"></a><span id="l3.41">       The weekday-picker manages an array of selected days of the week and</span>
<a href="#l3.42"></a><span id="l3.42">       the 'days' property is the interface to this array. the expected argument is</span>
<a href="#l3.43"></a><span id="l3.43">       an array containing integer elements, where each element represents a selected</span>
<a href="#l3.44"></a><span id="l3.44">       day of the week, starting with SUNDAY=1.</span>
<a href="#l3.45"></a><span id="l3.45">       --&gt;</span>
<a href="#l3.46"></a><span id="l3.46">       &lt;property name=&quot;days&quot;&gt;</span>
<a href="#l3.47"></a><span id="l3.47">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+            let mainbox =</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+            let numChilds = mainbox.childNodes.length;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+            for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+                let child = mainbox.childNodes[i];</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+                child.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+            }</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+            for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                let index = val[i] - 1 - this.weekStartOffset;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                if (index &lt; 0) {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+                    index += 7;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+                }</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+                mainbox.childNodes[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+            }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            return val;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+            let mainbox =</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+            let numChilds = mainbox.childNodes.length;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+            let days = [];</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+            for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+                let child = mainbox.childNodes[i];</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+                if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+                    let index = i + this.weekStartOffset;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+                    if (index &gt;= 7) {</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+                        index -= 7;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+                    }</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                    days.push(index + 1);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                }</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+            }</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+            return days;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+          this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+          let props =</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+              Services.strings.createBundle(</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+                  &quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l3.94"></a><span id="l3.94">           let mainbox =</span>
<a href="#l3.95"></a><span id="l3.95">               document.getAnonymousElementByAttribute(</span>
<a href="#l3.96"></a><span id="l3.96">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.97"></a><span id="l3.97">           let numChilds = mainbox.childNodes.length;</span>
<a href="#l3.98"></a><span id="l3.98">           for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l3.99"></a><span id="l3.99">               let child = mainbox.childNodes[i];</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-              child.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-          }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-          for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-              let index = val[i] - 1 - this.weekStartOffset;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-              if (index &lt; 0) {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-                  index += 7;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+              let dow = i + this.weekStartOffset;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+              if (dow &gt;= 7) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                  dow -= 7;</span>
<a href="#l3.109"></a><span id="l3.109">               }</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-              mainbox.childNodes[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-          }</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-          return val;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-          let mainbox =</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-          let numChilds = mainbox.childNodes.length;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-          let days = [];</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-              let child = mainbox.childNodes[i];</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-              if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-                  let index = i + this.weekStartOffset;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-                  if (index &gt;= 7) {</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-                      index -= 7;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-                  }</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-                  days.push(index + 1);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-              }</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+              let day = props.GetStringFromName(&quot;day.&quot; + (dow + 1) + &quot;.Mmm&quot;);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+              child.label = day;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+              child.calendar = this;</span>
<a href="#l3.132"></a><span id="l3.132">           }</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-          return days;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-        this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-        let props =</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-            Services.strings.createBundle(</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-                &quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-        let mainbox =</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-            document.getAnonymousElementByAttribute(</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-                this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-        let numChilds = mainbox.childNodes.length;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-        for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-            let child = mainbox.childNodes[i];</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-            let dow = i + this.weekStartOffset;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-            if (dow &gt;= 7) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-                dow -= 7;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-            }</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-            let day = props.GetStringFromName(&quot;day.&quot; + (dow + 1) + &quot;.Mmm&quot;);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-            child.label = day;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-            child.calendar = this;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-        }</span>
<a href="#l3.160"></a><span id="l3.160">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l3.161"></a><span id="l3.161">     &lt;/implementation&gt;</span>
<a href="#l3.162"></a><span id="l3.162">   &lt;/binding&gt;</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164">   &lt;!--</span>
<a href="#l3.165"></a><span id="l3.165">   ########################################################################</span>
<a href="#l3.166"></a><span id="l3.166">   ## daypicker-monthday</span>
<a href="#l3.167"></a><span id="l3.167">   ########################################################################</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineat">@@ -196,71 +196,71 @@</span>
<a href="#l3.169"></a><span id="l3.169">           &lt;daypicker bottom=&quot;true&quot; label=&quot;31&quot; xbl:inherits=&quot;disabled, mode=id&quot;/&gt;</span>
<a href="#l3.170"></a><span id="l3.170">           &lt;daypicker bottom=&quot;true&quot; right=&quot;true&quot; label=&quot;&quot; xbl:inherits=&quot;disabled, mode=id&quot;/&gt;</span>
<a href="#l3.171"></a><span id="l3.171">         &lt;/xul:hbox&gt;</span>
<a href="#l3.172"></a><span id="l3.172">       &lt;/xul:vbox&gt;</span>
<a href="#l3.173"></a><span id="l3.173">     &lt;/content&gt;</span>
<a href="#l3.174"></a><span id="l3.174">     &lt;implementation&gt;</span>
<a href="#l3.175"></a><span id="l3.175">       &lt;property name=&quot;days&quot;&gt;</span>
<a href="#l3.176"></a><span id="l3.176">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+            let mainbox =</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+            let numRows = mainbox.childNodes.length;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+            let days = [];</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+            for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+                let row = mainbox.childNodes[i];</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+                let numChilds = row.childNodes.length;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+                for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+                    let child = row.childNodes[j];</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+                    child.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+                    days.push(child);</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+                }</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+            }</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+            for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+                let lastDayOffset = val[i] == -1 ? 0 : -1;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+                let index = (val[i] &lt; 0 ? val[i] + days.length + lastDayOffset</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+                                        : val[i] - 1);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+                days[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+            }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+            return val;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+        ]]&gt;&lt;/setter&gt;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+            let mainbox =</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+            let numRows = mainbox.childNodes.length;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+            let days = [];</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+            for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+                let row = mainbox.childNodes[i];</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+                let numChilds = row.childNodes.length;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+                for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+                    let child = row.childNodes[j];</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+                    if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+                        days.push(Number(child.label) ? Number(child.label) : -1);</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+                    }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+                }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+            }</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+            return days;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.221"></a><span id="l3.221">           let mainbox =</span>
<a href="#l3.222"></a><span id="l3.222">               document.getAnonymousElementByAttribute(</span>
<a href="#l3.223"></a><span id="l3.223">                   this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.224"></a><span id="l3.224">           let numRows = mainbox.childNodes.length;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-          let days = [];</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-          for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-              let row = mainbox.childNodes[i];</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-              let numChilds = row.childNodes.length;</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-              for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-                  let child = row.childNodes[j];</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-                  child.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-                  days.push(child);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-              }</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-          }</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-          for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-              let lastDayOffset = val[i] == -1 ? 0 : -1;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-              let index = (val[i] &lt; 0 ? val[i] + days.length + lastDayOffset</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-                                      : val[i] - 1);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-              days[index].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-          }</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-          return val;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-          let mainbox =</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-          let numRows = mainbox.childNodes.length;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-          let days = [];</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+          let child = null;</span>
<a href="#l3.250"></a><span id="l3.250">           for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l3.251"></a><span id="l3.251">               let row = mainbox.childNodes[i];</span>
<a href="#l3.252"></a><span id="l3.252">               let numChilds = row.childNodes.length;</span>
<a href="#l3.253"></a><span id="l3.253">               for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-                  let child = row.childNodes[j];</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-                  if (child.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-                      days.push(Number(child.label) ? Number(child.label) : -1);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-                  }</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+                  child = row.childNodes[j];</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                  child.calendar = this;</span>
<a href="#l3.260"></a><span id="l3.260">               }</span>
<a href="#l3.261"></a><span id="l3.261">           }</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-          return days;</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-        let mainbox =</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-            document.getAnonymousElementByAttribute(</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-                this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-        let numRows = mainbox.childNodes.length;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-        let child = null;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-        for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-            let row = mainbox.childNodes[i];</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-            let numChilds = row.childNodes.length;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-            for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-                child = row.childNodes[j];</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-                child.calendar = this;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-            }</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-        }</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-        let labelLastDay = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceMonthlyLastDayLabel&quot;);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-        child.setAttribute(&quot;label&quot;, labelLastDay);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+          let labelLastDay = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceMonthlyLastDayLabel&quot;);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+          child.setAttribute(&quot;label&quot;, labelLastDay);</span>
<a href="#l3.285"></a><span id="l3.285">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l3.286"></a><span id="l3.286">     &lt;/implementation&gt;</span>
<a href="#l3.287"></a><span id="l3.287">   &lt;/binding&gt;</span>
<a href="#l3.288"></a><span id="l3.288"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -29,76 +29,76 @@</span>
<a href="#l4.4"></a><span id="l4.4">       &lt;xul:textbox readonly=&quot;true&quot;</span>
<a href="#l4.5"></a><span id="l4.5">                    class=&quot;selectable-label plain&quot;</span>
<a href="#l4.6"></a><span id="l4.6">                    anonid=&quot;item-datetime-value&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">     &lt;/content&gt;</span>
<a href="#l4.8"></a><span id="l4.8">     &lt;implementation&gt;</span>
<a href="#l4.9"></a><span id="l4.9">       &lt;field name=&quot;mItem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">       &lt;property name=&quot;mode&quot;</span>
<a href="#l4.17"></a><span id="l4.17">                 readonly=&quot;true&quot;&gt;</span>
<a href="#l4.18"></a><span id="l4.18">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-          if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-              return this.getAttribute(&quot;mode&quot;);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-          } else {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-              return &quot;start&quot;;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-          }</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+            if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+                return this.getAttribute(&quot;mode&quot;);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+            } else {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+                return &quot;start&quot;;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+            }</span>
<a href="#l4.29"></a><span id="l4.29">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l4.30"></a><span id="l4.30">       &lt;/property&gt;</span>
<a href="#l4.31"></a><span id="l4.31">       &lt;property name=&quot;Item&quot;&gt;</span>
<a href="#l4.32"></a><span id="l4.32">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-          return mItem;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+            return mItem;</span>
<a href="#l4.35"></a><span id="l4.35">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l4.36"></a><span id="l4.36">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-          this.mItem = val;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-          let headerLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-label&quot;);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-          let itemDateTimeLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-value&quot;);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-          let date;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-          if (this.mode == &quot;start&quot;) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-              date = this.mItem[cal.calGetStartDateProp(this.mItem)];</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-              if (date) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-                  let label;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-                  if (cal.isToDo(this.mItem)) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-                      label = this.getAttribute(&quot;taskStartLabel&quot;);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-                  } else {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-                      label = this.getAttribute(&quot;eventStartLabel&quot;);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-                  }</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-                  headerLabel.value = label;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-              }</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-          } else {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-              date = this.mItem[cal.calGetEndDateProp(this.mItem)];</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-              if (date) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                  let label;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-                  if (cal.isToDo(this.mItem)) {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-                      label = this.getAttribute(&quot;taskDueLabel&quot;);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-                  } else {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-                      label = this.getAttribute(&quot;eventEndLabel&quot;);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-                  }</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-                  headerLabel.value = label;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-              }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-          }</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-          let hideLabels = (date == null);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-          if (hideLabels) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-              this.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-          } else {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-              const kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-              let localTime = date.getInTimezone(kDefaultTimezone);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-              let formatter = cal.getDateFormatter();</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-              itemDateTimeLabel.value = formatter.formatDateTime(localTime);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-              if (!date.timezone.isFloating &amp;&amp; date.timezone.tzid != kDefaultTimezone.tzid) {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-                  // we additionally display the original datetime with timezone</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-                  let orgTime = cal.calGetString(&quot;calendar&quot;, &quot;datetimeWithTimezone&quot;, [</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-                      formatter.formatDateTime(date),</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-                      date.timezone.tzid</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-                  ]);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-                  itemDateTimeLabel.value += &quot; (&quot; + orgTime + &quot;)&quot;;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-              }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-              this.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-          }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+            this.mItem = val;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+            let headerLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-label&quot;);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+            let itemDateTimeLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-value&quot;);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+            let date;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+            if (this.mode == &quot;start&quot;) {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+                date = this.mItem[cal.calGetStartDateProp(this.mItem)];</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+                if (date) {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+                    let label;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+                    if (cal.isToDo(this.mItem)) {</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+                        label = this.getAttribute(&quot;taskStartLabel&quot;);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+                    } else {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+                        label = this.getAttribute(&quot;eventStartLabel&quot;);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+                    }</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+                    headerLabel.value = label;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+                }</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+            } else {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+                date = this.mItem[cal.calGetEndDateProp(this.mItem)];</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+                if (date) {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+                    let label;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+                    if (cal.isToDo(this.mItem)) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+                        label = this.getAttribute(&quot;taskDueLabel&quot;);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+                    } else {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+                        label = this.getAttribute(&quot;eventEndLabel&quot;);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+                    }</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+                    headerLabel.value = label;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+                }</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+            }</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+            let hideLabels = (date == null);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+            if (hideLabels) {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+                this.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+            } else {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+                const kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+                let localTime = date.getInTimezone(kDefaultTimezone);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+                let formatter = cal.getDateFormatter();</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                itemDateTimeLabel.value = formatter.formatDateTime(localTime);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+                if (!date.timezone.isFloating &amp;&amp; date.timezone.tzid != kDefaultTimezone.tzid) {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+                    // we additionally display the original datetime with timezone</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+                    let orgTime = cal.calGetString(&quot;calendar&quot;, &quot;datetimeWithTimezone&quot;, [</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+                        formatter.formatDateTime(date),</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+                        date.timezone.tzid</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+                    ]);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+                    itemDateTimeLabel.value += &quot; (&quot; + orgTime + &quot;)&quot;;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+                }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+                this.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+            }</span>
<a href="#l4.127"></a><span id="l4.127">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l4.128"></a><span id="l4.128">       &lt;/property&gt;</span>
<a href="#l4.129"></a><span id="l4.129">     &lt;/implementation&gt;</span>
<a href="#l4.130"></a><span id="l4.130">   &lt;/binding&gt;</span>
<a href="#l4.131"></a><span id="l4.131"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-menus.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-menus.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -12,65 +12,65 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   &lt;binding id=&quot;task-menupopup&quot; extends=&quot;xul:menupopup&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6">     &lt;implementation&gt;</span>
<a href="#l5.7"></a><span id="l5.7">       &lt;field name=&quot;mType&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l5.8"></a><span id="l5.8">       &lt;field name=&quot;mPopupHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.9"></a><span id="l5.9">       &lt;field name=&quot;mParentMenuPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-        this.mPopupHandler = () =&gt; { this.changeMenuByPropertyName(); };</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-        this.mParentMenuPopup = cal.getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-        this.mParentMenuPopup.addEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+          this.mPopupHandler = () =&gt; { this.changeMenuByPropertyName(); };</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+          this.mParentMenuPopup = cal.getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+          this.mParentMenuPopup.addEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l5.21"></a><span id="l5.21">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-        this.mParentMenuPopup.removeEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+          this.mParentMenuPopup.removeEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l5.26"></a><span id="l5.26">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">       &lt;!-- This method checks a command which naming follows</span>
<a href="#l5.29"></a><span id="l5.29">            the notation 'calendar_' +  mType + ' + '-' + propertyValue + 'command',</span>
<a href="#l5.30"></a><span id="l5.30">            when its propertyValue part matches the propertyValue of the selected tasks</span>
<a href="#l5.31"></a><span id="l5.31">            as long as the selected tasks share common propertyValues. --&gt;</span>
<a href="#l5.32"></a><span id="l5.32">       &lt;method name=&quot;changeMenuByPropertyName&quot;&gt;</span>
<a href="#l5.33"></a><span id="l5.33">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-          let liveList = document.getAnonymousNodes(this);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-          for (let item of liveList) {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-              let commandName = item.getAttribute(&quot;command&quot;);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-              let command = document.getElementById(commandName);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-              if (command) {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                  command.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-                  item.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-              }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-          }</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-          let propertyValue;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-          if (gTabmail &amp;&amp; gTabmail.currentTabInfo.mode.type == &quot;calendarTask&quot;) {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-              // We are in a task tab (editing a single task).</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-              propertyValue = gConfig[this.mType];</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-          } else {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-              // We are in the Tasks tab.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-              let tasks = getSelectedTasks();</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-              let tasksSelected = (tasks != null) &amp;&amp; (tasks.length &gt; 0);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-              if (tasksSelected) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-                  let task = tasks[0];</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-                  if (cal.isPropertyValueSame(tasks, this.mType)) {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                      propertyValue = task[this.mType];</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-                  }</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-              } else {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-                  cal.applyAttributeToMenuChildren(this, &quot;disabled&quot;, !tasksSelected);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-              }</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-          }</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-          if (propertyValue || propertyValue == 0) {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-              let command = document.getElementById(&quot;calendar_&quot; + this.mType + &quot;-&quot; + propertyValue + &quot;_command&quot;);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-              if (command) {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-                  command.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-              }</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-          }</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+            let liveList = document.getAnonymousNodes(this);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+            for (let item of liveList) {</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+                let commandName = item.getAttribute(&quot;command&quot;);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+                let command = document.getElementById(commandName);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+                if (command) {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+                    command.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                    item.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+                }</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+            }</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+            let propertyValue;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+            if (gTabmail &amp;&amp; gTabmail.currentTabInfo.mode.type == &quot;calendarTask&quot;) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+                // We are in a task tab (editing a single task).</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+                propertyValue = gConfig[this.mType];</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+            } else {</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+                // We are in the Tasks tab.</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+                let tasks = getSelectedTasks();</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+                let tasksSelected = (tasks != null) &amp;&amp; (tasks.length &gt; 0);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+                if (tasksSelected) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+                    let task = tasks[0];</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+                    if (cal.isPropertyValueSame(tasks, this.mType)) {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                        propertyValue = task[this.mType];</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+                    }</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+                } else {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+                    cal.applyAttributeToMenuChildren(this, &quot;disabled&quot;, !tasksSelected);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+                }</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+            }</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+            if (propertyValue || propertyValue == 0) {</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+                let command = document.getElementById(&quot;calendar_&quot; + this.mType + &quot;-&quot; + propertyValue + &quot;_command&quot;);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+                if (command) {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+                    command.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+                }</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+            }</span>
<a href="#l5.98"></a><span id="l5.98">         ]]&gt;&lt;/body&gt;</span>
<a href="#l5.99"></a><span id="l5.99">       &lt;/method&gt;</span>
<a href="#l5.100"></a><span id="l5.100">     &lt;/implementation&gt;</span>
<a href="#l5.101"></a><span id="l5.101">    &lt;/binding&gt;</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103">   &lt;binding id=&quot;task-progress-menupopup&quot; extends=&quot;chrome://calendar/content/calendar-menus.xml#task-menupopup&quot;&gt;</span>
<a href="#l5.104"></a><span id="l5.104">     &lt;content&gt;</span>
<a href="#l5.105"></a><span id="l5.105">       &lt;xul:menuitem anonid=&quot;percent-0-menuitem&quot;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineat">@@ -102,18 +102,18 @@</span>
<a href="#l5.107"></a><span id="l5.107">                 label=&quot;&amp;progress.level.100;&quot;</span>
<a href="#l5.108"></a><span id="l5.108">                 accesskey=&quot;&amp;progress.level.100.accesskey;&quot;</span>
<a href="#l5.109"></a><span id="l5.109">                 observes=&quot;calendar_percentComplete-100_command&quot;</span>
<a href="#l5.110"></a><span id="l5.110">                 command=&quot;calendar_percentComplete-100_command&quot;/&gt;</span>
<a href="#l5.111"></a><span id="l5.111">       &lt;children/&gt;</span>
<a href="#l5.112"></a><span id="l5.112">     &lt;/content&gt;</span>
<a href="#l5.113"></a><span id="l5.113">     &lt;implementation&gt;</span>
<a href="#l5.114"></a><span id="l5.114">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-        this.mType = &quot;percentComplete&quot;;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-        this.changeMenuByPropertyName();</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+          this.mType = &quot;percentComplete&quot;;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+          this.changeMenuByPropertyName();</span>
<a href="#l5.119"></a><span id="l5.119">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.120"></a><span id="l5.120">     &lt;/implementation&gt;</span>
<a href="#l5.121"></a><span id="l5.121">    &lt;/binding&gt;</span>
<a href="#l5.122"></a><span id="l5.122"> </span>
<a href="#l5.123"></a><span id="l5.123">   &lt;binding id=&quot;task-priority-menupopup&quot; extends=&quot;chrome://calendar/content/calendar-menus.xml#task-menupopup&quot;&gt;</span>
<a href="#l5.124"></a><span id="l5.124">     &lt;content&gt;</span>
<a href="#l5.125"></a><span id="l5.125">       &lt;xul:menuitem id=&quot;priority-0-menuitem&quot;</span>
<a href="#l5.126"></a><span id="l5.126">                     type=&quot;checkbox&quot;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineat">@@ -138,14 +138,14 @@</span>
<a href="#l5.128"></a><span id="l5.128">                 label=&quot;&amp;priority.level.high;&quot;</span>
<a href="#l5.129"></a><span id="l5.129">                 accesskey=&quot;&amp;priority.level.high.accesskey;&quot;</span>
<a href="#l5.130"></a><span id="l5.130">                 command=&quot;calendar_priority-1_command&quot;</span>
<a href="#l5.131"></a><span id="l5.131">                 observes=&quot;calendar_priority-1_command&quot;/&gt;</span>
<a href="#l5.132"></a><span id="l5.132">       &lt;children/&gt;</span>
<a href="#l5.133"></a><span id="l5.133">     &lt;/content&gt;</span>
<a href="#l5.134"></a><span id="l5.134">     &lt;implementation&gt;</span>
<a href="#l5.135"></a><span id="l5.135">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-        this.mType = &quot;priority&quot;;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-        this.changeMenuByPropertyName();</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+          this.mType = &quot;priority&quot;;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+          this.changeMenuByPropertyName();</span>
<a href="#l5.140"></a><span id="l5.140">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l5.141"></a><span id="l5.141">     &lt;/implementation&gt;</span>
<a href="#l5.142"></a><span id="l5.142">    &lt;/binding&gt;</span>
<a href="#l5.143"></a><span id="l5.143"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -65,59 +65,59 @@</span>
<a href="#l6.4"></a><span id="l6.4">               &lt;/xul:stack&gt;</span>
<a href="#l6.5"></a><span id="l6.5">             &lt;/xul:box&gt;</span>
<a href="#l6.6"></a><span id="l6.6">           &lt;/xul:box&gt;</span>
<a href="#l6.7"></a><span id="l6.7">         &lt;/xul:hbox&gt;</span>
<a href="#l6.8"></a><span id="l6.8">       &lt;/xul:vbox&gt;</span>
<a href="#l6.9"></a><span id="l6.9">     &lt;/content&gt;</span>
<a href="#l6.10"></a><span id="l6.10">     &lt;implementation&gt;</span>
<a href="#l6.11"></a><span id="l6.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">       &lt;property name=&quot;occurrence&quot;&gt;</span>
<a href="#l6.17"></a><span id="l6.17">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-          return this.mOccurrence;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+            return this.mOccurrence;</span>
<a href="#l6.20"></a><span id="l6.20">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.21"></a><span id="l6.21">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-          cal.ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-          this.mOccurrence = val;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-          if (cal.isEvent(val)) {</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-              if (!val.startDate.isDate) {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-                  let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-                  let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-                                            .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-                  let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                                                   : cal.calendarDefaultTimezone();</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                  let parentDate = cal.ensureDateTime(this.parentBox.date);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-                  let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-                  let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-                  let nextDay = parentDate.clone();</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                  nextDay.day++;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                  let comp = endTime.compare(nextDay);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-                  if (startTime.compare(parentDate) == -1) {</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-                      if (comp == 1) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-                          label.value = &quot;&quot;;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-                      } else if (comp == 0) {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-                          label.value = &quot;&quot;;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-                      } else {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-                          label.value = &quot; &quot; + formatter.formatTime(endTime);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-                      }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-                  } else if (comp == 1) {</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-                      label.value = &quot; &quot; + formatter.formatTime(startTime);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-                  } else {</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-                      label.value = formatter.formatTime(startTime);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-                  }</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-                  label.setAttribute(&quot;time&quot;, &quot;true&quot;);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-              }</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-          }</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+            cal.ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+            this.mOccurrence = val;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+            if (cal.isEvent(val)) {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+                if (!val.startDate.isDate) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+                    let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+                    let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+                                              .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+                    let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+                                                     : cal.calendarDefaultTimezone();</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                    let parentDate = cal.ensureDateTime(this.parentBox.date);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+                    let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+                    let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+                    let nextDay = parentDate.clone();</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+                    nextDay.day++;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                    let comp = endTime.compare(nextDay);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+                    if (startTime.compare(parentDate) == -1) {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+                        if (comp == 1) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+                            label.value = &quot;&quot;;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+                        } else if (comp == 0) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+                            label.value = &quot;&quot;;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+                        } else {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+                            label.value = &quot; &quot; + formatter.formatTime(endTime);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+                        }</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+                    } else if (comp == 1) {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+                        label.value = &quot; &quot; + formatter.formatTime(startTime);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+                    } else {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+                        label.value = formatter.formatTime(startTime);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+                    }</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+                    label.setAttribute(&quot;time&quot;, &quot;true&quot;);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+                }</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+            }</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-          this.setEditableLabel();</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-          this.setCSSClasses();</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-          return val;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+            this.setEditableLabel();</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+            this.setCSSClasses();</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+            return val;</span>
<a href="#l6.91"></a><span id="l6.91">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.92"></a><span id="l6.92">       &lt;/property&gt;</span>
<a href="#l6.93"></a><span id="l6.93">     &lt;/implementation&gt;</span>
<a href="#l6.94"></a><span id="l6.94">   &lt;/binding&gt;</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96">   &lt;binding id=&quot;calendar-month-day-box&quot; extends=&quot;chrome://calendar/content/widgets/calendar-widgets.xml#dragndropContainer&quot;&gt;</span>
<a href="#l6.97"></a><span id="l6.97">     &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l6.98"></a><span id="l6.98">       &lt;xul:hbox anonid=&quot;monthday-labels&quot; style=&quot;overflow: hidden;&quot;&gt;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineat">@@ -136,208 +136,210 @@</span>
<a href="#l6.100"></a><span id="l6.100">       &lt;/xul:hbox&gt;</span>
<a href="#l6.101"></a><span id="l6.101">       &lt;xul:vbox anonid=&quot;day-items&quot; class=&quot;calendar-month-day-box-items-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l6.102"></a><span id="l6.102">         &lt;children/&gt;</span>
<a href="#l6.103"></a><span id="l6.103">       &lt;/xul:vbox&gt;</span>
<a href="#l6.104"></a><span id="l6.104">     &lt;/content&gt;</span>
<a href="#l6.105"></a><span id="l6.105"> </span>
<a href="#l6.106"></a><span id="l6.106">     &lt;implementation&gt;</span>
<a href="#l6.107"></a><span id="l6.107">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.110"></a><span id="l6.110">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112">       &lt;field name=&quot;mDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l6.113"></a><span id="l6.113">       &lt;field name=&quot;mItemHash&quot;&gt;{}&lt;/field&gt;</span>
<a href="#l6.114"></a><span id="l6.114">       &lt;field name=&quot;mShowMonthLabel&quot;&gt;false&lt;/field&gt;</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">       &lt;property name=&quot;date&quot;</span>
<a href="#l6.117"></a><span id="l6.117">                 onget=&quot;return this.mDate&quot;</span>
<a href="#l6.118"></a><span id="l6.118">                 onset=&quot;this.setDate(val); return val;&quot;/&gt;</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l6.121"></a><span id="l6.121">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-          let sel = this.getAttribute(&quot;selected&quot;);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-          if (sel &amp;&amp; sel == &quot;true&quot;) {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-              return true;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-          }</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+            let sel = this.getAttribute(&quot;selected&quot;);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+            if (sel &amp;&amp; sel == &quot;true&quot;) {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+                return true;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+            }</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-          return false;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+            return false;</span>
<a href="#l6.133"></a><span id="l6.133">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.134"></a><span id="l6.134">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-          if (val) {</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-              this.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-          } else {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-              this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-          }</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-          return val;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+            if (val) {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+                this.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+            } else {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+                this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+            }</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+            return val;</span>
<a href="#l6.147"></a><span id="l6.147">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.148"></a><span id="l6.148">       &lt;/property&gt;</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150">       &lt;property name=&quot;dayitems&quot;&gt;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-        &lt;getter&gt;return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-items&quot;);&lt;/getter&gt;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-items&quot;);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.155"></a><span id="l6.155">       &lt;/property&gt;</span>
<a href="#l6.156"></a><span id="l6.156"> </span>
<a href="#l6.157"></a><span id="l6.157">       &lt;property name=&quot;showMonthLabel&quot;&gt;</span>
<a href="#l6.158"></a><span id="l6.158">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-          return this.mShowMonthLabel;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+            return this.mShowMonthLabel;</span>
<a href="#l6.161"></a><span id="l6.161">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.162"></a><span id="l6.162">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-          if (this.mShowMonthLabel == val) {</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-              return val;</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-          }</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-          this.mShowMonthLabel = val;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+            if (this.mShowMonthLabel == val) {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+                return val;</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+            }</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+            this.mShowMonthLabel = val;</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-          if (!this.mDate) {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-              return val;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-          }</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-          if (val) {</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-              this.setAttribute(&quot;value&quot;, cal.getDateFormatter().formatDateWithoutYear(this.mDate));</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-          } else {</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-              this.setAttribute(&quot;value&quot;, this.mDate.day);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-          }</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-          return val;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+            if (!this.mDate) {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+                return val;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+            }</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+            if (val) {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+                this.setAttribute(&quot;value&quot;, cal.getDateFormatter().formatDateWithoutYear(this.mDate));</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+            } else {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+                this.setAttribute(&quot;value&quot;, this.mDate.day);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+            }</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+            return val;</span>
<a href="#l6.190"></a><span id="l6.190">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.191"></a><span id="l6.191">       &lt;/property&gt;</span>
<a href="#l6.192"></a><span id="l6.192"> </span>
<a href="#l6.193"></a><span id="l6.193">       &lt;method name=&quot;setDate&quot;&gt;</span>
<a href="#l6.194"></a><span id="l6.194">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l6.195"></a><span id="l6.195">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-          if (!aDate) {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-              throw Components.results.NS_ERROR_NULL_POINTER;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-          }</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+            if (!aDate) {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+                throw Components.results.NS_ERROR_NULL_POINTER;</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+            }</span>
<a href="#l6.202"></a><span id="l6.202"> </span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-          // Remove all the old events</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-          this.mItemHash = {};</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-          removeChildren(this);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+            // Remove all the old events</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+            this.mItemHash = {};</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+            removeChildren(this);</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-          if (this.mDate &amp;&amp; this.mDate.compare(aDate) == 0) {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-              return;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-          }</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+            if (this.mDate &amp;&amp; this.mDate.compare(aDate) == 0) {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+                return;</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+            }</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-          this.mDate = aDate;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+            this.mDate = aDate;</span>
<a href="#l6.219"></a><span id="l6.219"> </span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-          // Set up DOM attributes for custom CSS coloring.</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-          let weekTitle = cal.getWeekInfoService().getWeekTitle(aDate);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-          this.setAttribute(&quot;year&quot;, aDate.year);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-          this.setAttribute(&quot;month&quot;, aDate.month + 1);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-          this.setAttribute(&quot;week&quot;, weekTitle);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-          this.setAttribute(&quot;day&quot;, aDate.day);</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+            // Set up DOM attributes for custom CSS coloring.</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+            let weekTitle = cal.getWeekInfoService().getWeekTitle(aDate);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+            this.setAttribute(&quot;year&quot;, aDate.year);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+            this.setAttribute(&quot;month&quot;, aDate.month + 1);</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+            this.setAttribute(&quot;week&quot;, weekTitle);</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+            this.setAttribute(&quot;day&quot;, aDate.day);</span>
<a href="#l6.232"></a><span id="l6.232"> </span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-          if (this.mShowMonthLabel) {</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-              let monthName = cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (aDate.month + 1) + &quot;.Mmm&quot;);</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-              this.setAttribute(&quot;value&quot;, aDate.day + &quot; &quot; + monthName);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-          } else {</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-              this.setAttribute(&quot;value&quot;, aDate.day);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-          }</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+            if (this.mShowMonthLabel) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+                let monthName = cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (aDate.month + 1) + &quot;.Mmm&quot;);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+                this.setAttribute(&quot;value&quot;, aDate.day + &quot; &quot; + monthName);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+            } else {</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+                this.setAttribute(&quot;value&quot;, aDate.day);</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+            }</span>
<a href="#l6.245"></a><span id="l6.245">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.246"></a><span id="l6.246">       &lt;/method&gt;</span>
<a href="#l6.247"></a><span id="l6.247"> </span>
<a href="#l6.248"></a><span id="l6.248">       &lt;method name=&quot;addItem&quot;&gt;</span>
<a href="#l6.249"></a><span id="l6.249">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.250"></a><span id="l6.250">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-          if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-              this.deleteItem(aItem);</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-          }</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+            if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+                this.deleteItem(aItem);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+            }</span>
<a href="#l6.257"></a><span id="l6.257"> </span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-          let box = createXULElement(&quot;calendar-month-day-box-item&quot;);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-          let context = this.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-                        this.getAttribute(&quot;context&quot;);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-          box.setAttribute(&quot;context&quot;, context);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-          box.setAttribute(&quot;calendar-uri&quot;, aItem.calendar.uri.spec);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-          box.setAttribute(&quot;calendar-id&quot;, aItem.calendar.id);</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+            let box = createXULElement(&quot;calendar-month-day-box-item&quot;);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+            let context = this.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+                          this.getAttribute(&quot;context&quot;);</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+            box.setAttribute(&quot;context&quot;, context);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+            box.setAttribute(&quot;calendar-uri&quot;, aItem.calendar.uri.spec);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+            box.setAttribute(&quot;calendar-id&quot;, aItem.calendar.id);</span>
<a href="#l6.270"></a><span id="l6.270"> </span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-          cal.binaryInsertNode(this, box, aItem, cal.view.compareItems, false);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+            cal.binaryInsertNode(this, box, aItem, cal.view.compareItems, false);</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-          box.calendarView = this.calendarView;</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-          box.item = aItem;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-          box.parentBox = this;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-          box.occurrence = aItem;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+            box.calendarView = this.calendarView;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+            box.item = aItem;</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+            box.parentBox = this;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+            box.occurrence = aItem;</span>
<a href="#l6.282"></a><span id="l6.282"> </span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-          this.mItemHash[aItem.hashId] = box;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-          return box;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+            this.mItemHash[aItem.hashId] = box;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+            return box;</span>
<a href="#l6.287"></a><span id="l6.287">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.288"></a><span id="l6.288">       &lt;/method&gt;</span>
<a href="#l6.289"></a><span id="l6.289"> </span>
<a href="#l6.290"></a><span id="l6.290">       &lt;method name=&quot;selectItem&quot;&gt;</span>
<a href="#l6.291"></a><span id="l6.291">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.292"></a><span id="l6.292">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-          if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-              this.mItemHash[aItem.hashId].selected = true;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-          }</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+            if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+                this.mItemHash[aItem.hashId].selected = true;</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+            }</span>
<a href="#l6.299"></a><span id="l6.299">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.300"></a><span id="l6.300">       &lt;/method&gt;</span>
<a href="#l6.301"></a><span id="l6.301"> </span>
<a href="#l6.302"></a><span id="l6.302">       &lt;method name=&quot;unselectItem&quot;&gt;</span>
<a href="#l6.303"></a><span id="l6.303">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.304"></a><span id="l6.304">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-          if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-              this.mItemHash[aItem.hashId].selected = false;</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-          }</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+            if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+                this.mItemHash[aItem.hashId].selected = false;</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+            }</span>
<a href="#l6.311"></a><span id="l6.311">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.312"></a><span id="l6.312">       &lt;/method&gt;</span>
<a href="#l6.313"></a><span id="l6.313"> </span>
<a href="#l6.314"></a><span id="l6.314">       &lt;method name=&quot;deleteItem&quot;&gt;</span>
<a href="#l6.315"></a><span id="l6.315">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.316"></a><span id="l6.316">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-          if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-              let node = this.mItemHash[aItem.hashId];</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-              node.remove();</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-              delete this.mItemHash[aItem.hashId];</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-          }</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+            if (aItem.hashId in this.mItemHash) {</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+                let node = this.mItemHash[aItem.hashId];</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+                node.remove();</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+                delete this.mItemHash[aItem.hashId];</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+            }</span>
<a href="#l6.327"></a><span id="l6.327">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.328"></a><span id="l6.328">       &lt;/method&gt;</span>
<a href="#l6.329"></a><span id="l6.329"> </span>
<a href="#l6.330"></a><span id="l6.330">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l6.331"></a><span id="l6.331">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.332"></a><span id="l6.332">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-          // When item's timezone is different than the default one, the</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-          // item might get moved on a day different than the drop day.</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-          // Changing the drop day allows to compensate a possible difference.</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+            // When item's timezone is different than the default one, the</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+            // item might get moved on a day different than the drop day.</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+            // Changing the drop day allows to compensate a possible difference.</span>
<a href="#l6.339"></a><span id="l6.339"> </span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-          // Figure out if the timezones cause a days difference.</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-          let start = (aItem[cal.calGetStartDateProp(aItem)] ||</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-                       aItem[cal.calGetEndDateProp(aItem)]).clone();</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-          let dayboxDate = this.mDate.clone();</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-          if (start.timezone != dayboxDate.timezone) {</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-              let startInDefaultTz = start.clone().getInTimezone(dayboxDate.timezone);</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-              start.isDate = true;</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-              startInDefaultTz.isDate = true;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-              startInDefaultTz.timezone = start.timezone;</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-              let dayDiff = start.subtractDate(startInDefaultTz);</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-              // Change the day where to drop the item.</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-              dayboxDate.addDuration(dayDiff);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-          }</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+            // Figure out if the timezones cause a days difference.</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+            let start = (aItem[cal.calGetStartDateProp(aItem)] ||</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+                         aItem[cal.calGetEndDateProp(aItem)]).clone();</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+            let dayboxDate = this.mDate.clone();</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+            if (start.timezone != dayboxDate.timezone) {</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+                let startInDefaultTz = start.clone().getInTimezone(dayboxDate.timezone);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+                start.isDate = true;</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+                startInDefaultTz.isDate = true;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+                startInDefaultTz.timezone = start.timezone;</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+                let dayDiff = start.subtractDate(startInDefaultTz);</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+                // Change the day where to drop the item.</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+                dayboxDate.addDuration(dayDiff);</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+            }</span>
<a href="#l6.366"></a><span id="l6.366"> </span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-          return cal.moveItem(aItem, dayboxDate);</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+            return cal.moveItem(aItem, dayboxDate);</span>
<a href="#l6.369"></a><span id="l6.369">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.370"></a><span id="l6.370">       &lt;/method&gt;</span>
<a href="#l6.371"></a><span id="l6.371">     &lt;/implementation&gt;</span>
<a href="#l6.372"></a><span id="l6.372"> </span>
<a href="#l6.373"></a><span id="l6.373">     &lt;handlers&gt;</span>
<a href="#l6.374"></a><span id="l6.374">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-        if (this.mDate) {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-            this.calendarView.selectedDay = this.mDate;</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-        }</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+          if (this.mDate) {</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+              this.calendarView.selectedDay = this.mDate;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+          }</span>
<a href="#l6.383"></a><span id="l6.383">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l6.384"></a><span id="l6.384">       &lt;handler event=&quot;dblclick&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-        this.calendarView.controller.createNewEvent();</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+          this.calendarView.controller.createNewEvent();</span>
<a href="#l6.389"></a><span id="l6.389">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l6.390"></a><span id="l6.390">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-        if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-            this.calendarView.setSelectedItems(0, []);</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-        }</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+          if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+              this.calendarView.setSelectedItems(0, []);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+          }</span>
<a href="#l6.397"></a><span id="l6.397">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l6.398"></a><span id="l6.398">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-        if (cal.getParentNodeOrThisByAttribute(event.originalTarget, &quot;anonid&quot;, &quot;day-label&quot;) == null) {</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-            if (this.dayitems.scrollHeight &gt; this.dayitems.clientHeight) {</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-                event.stopPropagation();</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-            }</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-        }</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+          if (cal.getParentNodeOrThisByAttribute(event.originalTarget, &quot;anonid&quot;, &quot;day-label&quot;) == null) {</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+              if (this.dayitems.scrollHeight &gt; this.dayitems.clientHeight) {</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+                  event.stopPropagation();</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+              }</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+          }</span>
<a href="#l6.409"></a><span id="l6.409">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l6.410"></a><span id="l6.410">     &lt;/handlers&gt;</span>
<a href="#l6.411"></a><span id="l6.411">   &lt;/binding&gt;</span>
<a href="#l6.412"></a><span id="l6.412"> </span>
<a href="#l6.413"></a><span id="l6.413">   &lt;binding id=&quot;calendar-month-base-view&quot; extends=&quot;chrome://calendar/content/calendar-base-view.xml#calendar-base-view&quot;&gt;</span>
<a href="#l6.414"></a><span id="l6.414">     &lt;content style=&quot;overflow: auto;&quot; flex=&quot;1&quot; xbl:inherits=&quot;context,item-context&quot;&gt;</span>
<a href="#l6.415"></a><span id="l6.415">       &lt;xul:vbox anonid=&quot;mainbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l6.416"></a><span id="l6.416">         &lt;xul:hbox class=&quot;labeldaybox-container&quot;</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineat">@@ -412,32 +414,32 @@</span>
<a href="#l6.418"></a><span id="l6.418">             &lt;/xul:row&gt;</span>
<a href="#l6.419"></a><span id="l6.419">           &lt;/xul:rows&gt;</span>
<a href="#l6.420"></a><span id="l6.420">         &lt;/xul:grid&gt;</span>
<a href="#l6.421"></a><span id="l6.421">       &lt;/xul:vbox&gt;</span>
<a href="#l6.422"></a><span id="l6.422">     &lt;/content&gt;</span>
<a href="#l6.423"></a><span id="l6.423"> </span>
<a href="#l6.424"></a><span id="l6.424">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l6.425"></a><span id="l6.425">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calViewUtils.jsm&quot;);</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calViewUtils.jsm&quot;);</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.432"></a><span id="l6.432"> </span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-        // Set the preference for the default start of the week</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-        this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+          // Set the preference for the default start of the week</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+          this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l6.437"></a><span id="l6.437"> </span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-        for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-            let hdr = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-            this.labeldaybox.appendChild(hdr);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-            hdr.weekDay = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-            hdr.shortWeekNames = false;</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-        }</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+          for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+              let hdr = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+              this.labeldaybox.appendChild(hdr);</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+              hdr.weekDay = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+              hdr.shortWeekNames = false;</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+          }</span>
<a href="#l6.450"></a><span id="l6.450"> </span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-        // Set the preference for displaying the week number</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-        this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+          // Set the preference for displaying the week number</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+          this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l6.455"></a><span id="l6.455">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l6.456"></a><span id="l6.456"> </span>
<a href="#l6.457"></a><span id="l6.457">       &lt;!-- fields --&gt;</span>
<a href="#l6.458"></a><span id="l6.458">       &lt;field name=&quot;mDateBoxes&quot;&gt;null&lt;/field&gt;</span>
<a href="#l6.459"></a><span id="l6.459">       &lt;field name=&quot;mSelectedDayBox&quot;&gt;null&lt;/field&gt;</span>
<a href="#l6.460"></a><span id="l6.460"> </span>
<a href="#l6.461"></a><span id="l6.461">       &lt;field name=&quot;mShowDaysOutsideMonth&quot;&gt;true&lt;/field&gt;</span>
<a href="#l6.462"></a><span id="l6.462">       &lt;field name=&quot;mShowFullMonth&quot;&gt;true&lt;/field&gt;</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineat">@@ -445,24 +447,24 @@</span>
<a href="#l6.464"></a><span id="l6.464"> </span>
<a href="#l6.465"></a><span id="l6.465">       &lt;field name=&quot;mClickedTime&quot;&gt;null&lt;/field&gt;</span>
<a href="#l6.466"></a><span id="l6.466"> </span>
<a href="#l6.467"></a><span id="l6.467">       &lt;!-- other methods --&gt;</span>
<a href="#l6.468"></a><span id="l6.468">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l6.469"></a><span id="l6.469">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l6.470"></a><span id="l6.470">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l6.471"></a><span id="l6.471">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-          let needsrelayout = (aAttr == &quot;context&quot; || aAttr == &quot;item-context&quot;);</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+            let needsrelayout = (aAttr == &quot;context&quot; || aAttr == &quot;item-context&quot;);</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l6.476"></a><span id="l6.476"> </span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-          if (needsrelayout) {</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-              this.relayout();</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-          }</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+            if (needsrelayout) {</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+                this.relayout();</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+            }</span>
<a href="#l6.483"></a><span id="l6.483"> </span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-          return ret;</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+            return ret;</span>
<a href="#l6.486"></a><span id="l6.486">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.487"></a><span id="l6.487">       &lt;/method&gt;</span>
<a href="#l6.488"></a><span id="l6.488"> </span>
<a href="#l6.489"></a><span id="l6.489">       &lt;!-- calICalendarView --&gt;</span>
<a href="#l6.490"></a><span id="l6.490"> </span>
<a href="#l6.491"></a><span id="l6.491">       &lt;property name=&quot;supportsDisjointDates&quot; readonly=&quot;true&quot;</span>
<a href="#l6.492"></a><span id="l6.492">                 onget=&quot;return false;&quot;/&gt;</span>
<a href="#l6.493"></a><span id="l6.493">       &lt;property name=&quot;hasDisjointDates&quot; readonly=&quot;true&quot;</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineat">@@ -471,21 +473,21 @@</span>
<a href="#l6.495"></a><span id="l6.495">       &lt;property name=&quot;startDate&quot; readonly=&quot;true&quot;</span>
<a href="#l6.496"></a><span id="l6.496">                 onget=&quot;return this.mStartDate&quot;/&gt;</span>
<a href="#l6.497"></a><span id="l6.497"> </span>
<a href="#l6.498"></a><span id="l6.498">       &lt;property name=&quot;endDate&quot; readonly=&quot;true&quot;</span>
<a href="#l6.499"></a><span id="l6.499">                 onget=&quot;return this.mEndDate&quot;/&gt;</span>
<a href="#l6.500"></a><span id="l6.500"> </span>
<a href="#l6.501"></a><span id="l6.501">       &lt;property name=&quot;showFullMonth&quot;&gt;</span>
<a href="#l6.502"></a><span id="l6.502">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-          return this.mShowFullMonth;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+            return this.mShowFullMonth;</span>
<a href="#l6.505"></a><span id="l6.505">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.506"></a><span id="l6.506">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-          this.mShowFullMonth = val;</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-          return val;</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+            this.mShowFullMonth = val;</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+            return val;</span>
<a href="#l6.511"></a><span id="l6.511">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.512"></a><span id="l6.512">       &lt;/property&gt;</span>
<a href="#l6.513"></a><span id="l6.513"> </span>
<a href="#l6.514"></a><span id="l6.514">       &lt;!-- this property may be overridden by the</span>
<a href="#l6.515"></a><span id="l6.515">           descendent classes if neeeded  --&gt;</span>
<a href="#l6.516"></a><span id="l6.516">       &lt;property name=&quot;weeksInView&quot;&gt;</span>
<a href="#l6.517"></a><span id="l6.517">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.518"></a><span id="l6.518">             return 0;</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineat">@@ -495,649 +497,649 @@</span>
<a href="#l6.520"></a><span id="l6.520">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.521"></a><span id="l6.521">       &lt;/property&gt;</span>
<a href="#l6.522"></a><span id="l6.522"> </span>
<a href="#l6.523"></a><span id="l6.523">       &lt;method name=&quot;handlePreference&quot;&gt;</span>
<a href="#l6.524"></a><span id="l6.524">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l6.525"></a><span id="l6.525">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l6.526"></a><span id="l6.526">         &lt;parameter name=&quot;aPreference&quot;/&gt;</span>
<a href="#l6.527"></a><span id="l6.527">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-          aSubject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+            aSubject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l6.530"></a><span id="l6.530"> </span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-          switch (aPreference) {</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-              case &quot;calendar.previousweeks.inview&quot;:</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-                  this.updateDaysOffPrefs();</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-                  this.refreshView();</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-                  break;</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+            switch (aPreference) {</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+                case &quot;calendar.previousweeks.inview&quot;:</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+                    this.updateDaysOffPrefs();</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+                    this.refreshView();</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+                    break;</span>
<a href="#l6.541"></a><span id="l6.541"> </span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-              case &quot;calendar.week.start&quot;:</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-                  this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-                  // Refresh the view so the settings take effect</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-                  this.refreshView();</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-                  break;</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+                case &quot;calendar.week.start&quot;:</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+                    this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+                    // Refresh the view so the settings take effect</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+                    this.refreshView();</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+                    break;</span>
<a href="#l6.552"></a><span id="l6.552"> </span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-              case &quot;calendar.weeks.inview&quot;:</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-                  this.weeksInView = aSubject.getIntPref(aPreference);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-                  break;</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+                case &quot;calendar.weeks.inview&quot;:</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+                    this.weeksInView = aSubject.getIntPref(aPreference);</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+                    break;</span>
<a href="#l6.559"></a><span id="l6.559"> </span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-              case &quot;calendar.view-minimonth.showWeekNumber&quot;:</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-                  this.mShowWeekNumber = aSubject.getBoolPref(aPreference);</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-                  if (this.mShowWeekNumber) {</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-                      this.refreshView();</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-                  } else {</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-                      this.hideWeekNumbers();</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-                  }</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-                  break;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineplus">+                case &quot;calendar.view-minimonth.showWeekNumber&quot;:</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+                    this.mShowWeekNumber = aSubject.getBoolPref(aPreference);</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+                    if (this.mShowWeekNumber) {</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineplus">+                        this.refreshView();</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+                    } else {</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineplus">+                        this.hideWeekNumbers();</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+                    }</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineplus">+                    break;</span>
<a href="#l6.576"></a><span id="l6.576"> </span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-              default:</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-                  this.handleCommonPreference(aSubject, aTopic, aPreference);</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-                  break;</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-          }</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+                default:</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineplus">+                    this.handleCommonPreference(aSubject, aTopic, aPreference);</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineplus">+                    break;</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineplus">+            }</span>
<a href="#l6.585"></a><span id="l6.585">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.586"></a><span id="l6.586">       &lt;/method&gt;</span>
<a href="#l6.587"></a><span id="l6.587"> </span>
<a href="#l6.588"></a><span id="l6.588">       &lt;method name=&quot;getSelectedItems&quot;&gt;</span>
<a href="#l6.589"></a><span id="l6.589">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l6.590"></a><span id="l6.590">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-          aCount.value = this.mSelectedItems.length;</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-          return this.mSelectedItems;</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+            aCount.value = this.mSelectedItems.length;</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+            return this.mSelectedItems;</span>
<a href="#l6.595"></a><span id="l6.595">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.596"></a><span id="l6.596">       &lt;/method&gt;</span>
<a href="#l6.597"></a><span id="l6.597"> </span>
<a href="#l6.598"></a><span id="l6.598">       &lt;method name=&quot;setSelectedItems&quot;&gt;</span>
<a href="#l6.599"></a><span id="l6.599">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l6.600"></a><span id="l6.600">         &lt;parameter name=&quot;aItems&quot;/&gt;</span>
<a href="#l6.601"></a><span id="l6.601">         &lt;parameter name=&quot;aSuppressEvent&quot;/&gt;</span>
<a href="#l6.602"></a><span id="l6.602">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-          if (this.mSelectedItems.length) {</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-              for (let item of this.mSelectedItems) {</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-                  let oldboxes = this.findDayBoxesForItem(item);</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-                  for (let oldbox of oldboxes) {</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-                      oldbox.unselectItem(item);</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-                  }</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-              }</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-          }</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+            if (this.mSelectedItems.length) {</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+                for (let item of this.mSelectedItems) {</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+                    let oldboxes = this.findDayBoxesForItem(item);</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+                    for (let oldbox of oldboxes) {</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineplus">+                        oldbox.unselectItem(item);</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+                    }</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+                }</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+            }</span>
<a href="#l6.619"></a><span id="l6.619"> </span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-          this.mSelectedItems = aItems || [];</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+            this.mSelectedItems = aItems || [];</span>
<a href="#l6.622"></a><span id="l6.622"> </span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-          if (this.mSelectedItems.length) {</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-              for (let item of this.mSelectedItems) {</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-                  let newboxes = this.findDayBoxesForItem(item);</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-                  for (let newbox of newboxes) {</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-                      newbox.selectItem(item);</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-                  }</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-              }</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-          }</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineplus">+            if (this.mSelectedItems.length) {</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineplus">+                for (let item of this.mSelectedItems) {</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineplus">+                    let newboxes = this.findDayBoxesForItem(item);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+                    for (let newbox of newboxes) {</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+                        newbox.selectItem(item);</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineplus">+                    }</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineplus">+                }</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+            }</span>
<a href="#l6.639"></a><span id="l6.639"> </span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-          if (!aSuppressEvent) {</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-              this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-          }</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+            if (!aSuppressEvent) {</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+                this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+            }</span>
<a href="#l6.646"></a><span id="l6.646">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.647"></a><span id="l6.647">       &lt;/method&gt;</span>
<a href="#l6.648"></a><span id="l6.648"> </span>
<a href="#l6.649"></a><span id="l6.649">       &lt;method name=&quot;centerSelectedItems&quot;&gt;</span>
<a href="#l6.650"></a><span id="l6.650">         &lt;body&gt;</span>
<a href="#l6.651"></a><span id="l6.651">         &lt;/body&gt;</span>
<a href="#l6.652"></a><span id="l6.652">       &lt;/method&gt;</span>
<a href="#l6.653"></a><span id="l6.653"> </span>
<a href="#l6.654"></a><span id="l6.654">       &lt;property name=&quot;selectedDay&quot;&gt;</span>
<a href="#l6.655"></a><span id="l6.655">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-          if (this.mSelectedDayBox) {</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-              return this.mSelectedDayBox.date.clone();</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-          }</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+            if (this.mSelectedDayBox) {</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+                return this.mSelectedDayBox.date.clone();</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+            }</span>
<a href="#l6.662"></a><span id="l6.662"> </span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-          return null;</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+            return null;</span>
<a href="#l6.665"></a><span id="l6.665">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.666"></a><span id="l6.666">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-          if (this.mSelectedDayBox) {</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-              this.mSelectedDayBox.selected = false;</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-          }</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+            if (this.mSelectedDayBox) {</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+                this.mSelectedDayBox.selected = false;</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+            }</span>
<a href="#l6.673"></a><span id="l6.673"> </span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-          let realVal = val;</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-          if (!realVal.isDate) {</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-              realVal = val.clone();</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-              realVal.isDate = true;</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-          }</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-          let box = this.findDayBoxForDate(realVal);</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-          if (box) {</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-              box.selected = true;</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-              this.mSelectedDayBox = box;</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-          }</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-          this.fireEvent(&quot;dayselect&quot;, realVal);</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-          return val;</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineplus">+            let realVal = val;</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+            if (!realVal.isDate) {</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+                realVal = val.clone();</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+                realVal.isDate = true;</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+            }</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+            let box = this.findDayBoxForDate(realVal);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineplus">+            if (box) {</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+                box.selected = true;</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+                this.mSelectedDayBox = box;</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+            }</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineplus">+            this.fireEvent(&quot;dayselect&quot;, realVal);</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineplus">+            return val;</span>
<a href="#l6.698"></a><span id="l6.698">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.699"></a><span id="l6.699">       &lt;/property&gt;</span>
<a href="#l6.700"></a><span id="l6.700"> </span>
<a href="#l6.701"></a><span id="l6.701">       &lt;property name=&quot;selectedDateTime&quot;&gt;</span>
<a href="#l6.702"></a><span id="l6.702">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.703"></a><span id="l6.703">             return cal.getDefaultStartDate(this.selectedDay);</span>
<a href="#l6.704"></a><span id="l6.704">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.705"></a><span id="l6.705">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.706"></a><span id="l6.706">             this.mClickedTime = val;</span>
<a href="#l6.707"></a><span id="l6.707">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.708"></a><span id="l6.708">       &lt;/property&gt;</span>
<a href="#l6.709"></a><span id="l6.709"> </span>
<a href="#l6.710"></a><span id="l6.710">       &lt;method name=&quot;showDate&quot;&gt;</span>
<a href="#l6.711"></a><span id="l6.711">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l6.712"></a><span id="l6.712">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-          // If aDate is null it means that only a refresh is needed</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-          // without changing the start and end of the view.</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-          if (aDate) {</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-              this.setDateRange(aDate.startOfMonth, aDate.endOfMonth);</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-              this.selectedDay = aDate;</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-          } else {</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-              this.refresh();</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-              // Refresh the selected day if it doesn't appear in the view.</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-              this.selectedDay = this.selectedDay;</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-          }</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineplus">+            // If aDate is null it means that only a refresh is needed</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+            // without changing the start and end of the view.</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineplus">+            if (aDate) {</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+                this.setDateRange(aDate.startOfMonth, aDate.endOfMonth);</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+                this.selectedDay = aDate;</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+            } else {</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+                this.refresh();</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+                // Refresh the selected day if it doesn't appear in the view.</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+                this.selectedDay = this.selectedDay;</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+            }</span>
<a href="#l6.733"></a><span id="l6.733">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.734"></a><span id="l6.734">       &lt;/method&gt;</span>
<a href="#l6.735"></a><span id="l6.735"> </span>
<a href="#l6.736"></a><span id="l6.736">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l6.737"></a><span id="l6.737">       &lt;parameter name=&quot;aBinding&quot;/&gt;</span>
<a href="#l6.738"></a><span id="l6.738">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-          aBinding.adjustWeekdayLength();</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-          // Delete the timer for the time indicator in day/week view.</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-          timeIndicator.cancel();</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineplus">+            aBinding.adjustWeekdayLength();</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineplus">+            // Delete the timer for the time indicator in day/week view.</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineplus">+            timeIndicator.cancel();</span>
<a href="#l6.745"></a><span id="l6.745">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.746"></a><span id="l6.746">       &lt;/method&gt;</span>
<a href="#l6.747"></a><span id="l6.747"> </span>
<a href="#l6.748"></a><span id="l6.748">       &lt;method name=&quot;setDateRange&quot;&gt;</span>
<a href="#l6.749"></a><span id="l6.749">         &lt;parameter name=&quot;aStartDate&quot;/&gt;</span>
<a href="#l6.750"></a><span id="l6.750">         &lt;parameter name=&quot;aEndDate&quot;/&gt;</span>
<a href="#l6.751"></a><span id="l6.751">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-          this.rangeStartDate = aStartDate;</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-          this.rangeEndDate = aEndDate;</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-          let viewStart = cal.getWeekInfoService().getStartOfWeek(</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-                                      aStartDate.getInTimezone(this.mTimezone));</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-          let viewEnd = cal.getWeekInfoService().getEndOfWeek(</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-                                      aEndDate.getInTimezone(this.mTimezone));</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineplus">+            this.rangeStartDate = aStartDate;</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineplus">+            this.rangeEndDate = aEndDate;</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineplus">+            let viewStart = cal.getWeekInfoService().getStartOfWeek(</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineplus">+                                        aStartDate.getInTimezone(this.mTimezone));</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineplus">+            let viewEnd = cal.getWeekInfoService().getEndOfWeek(</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineplus">+                                        aEndDate.getInTimezone(this.mTimezone));</span>
<a href="#l6.764"></a><span id="l6.764"> </span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-          viewStart.isDate = true;</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-          viewStart.makeImmutable();</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-          viewEnd.isDate = true;</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-          viewEnd.makeImmutable();</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-          this.mStartDate = viewStart;</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-          this.mEndDate = viewEnd;</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineplus">+            viewStart.isDate = true;</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineplus">+            viewStart.makeImmutable();</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineplus">+            viewEnd.isDate = true;</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineplus">+            viewEnd.makeImmutable();</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+            this.mStartDate = viewStart;</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineplus">+            this.mEndDate = viewEnd;</span>
<a href="#l6.777"></a><span id="l6.777"> </span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-          // check values of tasksInView, workdaysOnly, showCompleted</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-          // see setDateRange comment in calendar-multiday-view.xml</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-          let toggleStatus = 0;</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineplus">+            // check values of tasksInView, workdaysOnly, showCompleted</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineplus">+            // see setDateRange comment in calendar-multiday-view.xml</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineplus">+            let toggleStatus = 0;</span>
<a href="#l6.784"></a><span id="l6.784"> </span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-          if (this.mTasksInView) {</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-          }</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-          if (this.mWorkdaysOnly) {</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-          }</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-          if (this.mShowCompleted) {</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">-          }</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineplus">+            if (this.mTasksInView) {</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+            }</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+            if (this.mWorkdaysOnly) {</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+            }</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+            if (this.mShowCompleted) {</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineplus">+            }</span>
<a href="#l6.803"></a><span id="l6.803"> </span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-          // Update the navigation bar only when changes are related to the current view.</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-          if (this.isVisible()) {</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-              cal.navigationBar.setDateRange(aStartDate, aEndDate);</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-          }</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineplus">+            // Update the navigation bar only when changes are related to the current view.</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineplus">+            if (this.isVisible()) {</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineplus">+                cal.navigationBar.setDateRange(aStartDate, aEndDate);</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineplus">+            }</span>
<a href="#l6.812"></a><span id="l6.812"> </span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-          // Check whether view range has been changed since last call to</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-          // relayout()</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-          if (!this.mViewStart || !this.mViewEnd ||</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-              this.mViewEnd.compare(viewEnd) != 0 ||</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-              this.mViewStart.compare(viewStart) != 0 ||</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-              this.mToggleStatus != toggleStatus) {</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-              this.refresh();</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-          }</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+            // Check whether view range has been changed since last call to</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+            // relayout()</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+            if (!this.mViewStart || !this.mViewEnd ||</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineplus">+                this.mViewEnd.compare(viewEnd) != 0 ||</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineplus">+                this.mViewStart.compare(viewStart) != 0 ||</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineplus">+                this.mToggleStatus != toggleStatus) {</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineplus">+                this.refresh();</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineplus">+            }</span>
<a href="#l6.829"></a><span id="l6.829"> </span>
<a href="#l6.830"></a><span id="l6.830">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.831"></a><span id="l6.831">       &lt;/method&gt;</span>
<a href="#l6.832"></a><span id="l6.832"> </span>
<a href="#l6.833"></a><span id="l6.833">       &lt;method name=&quot;getDateList&quot;&gt;</span>
<a href="#l6.834"></a><span id="l6.834">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l6.835"></a><span id="l6.835">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-          if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-              aCount.value = 0;</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-              return [];</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-          }</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+            if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+                aCount.value = 0;</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineplus">+                return [];</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineplus">+            }</span>
<a href="#l6.844"></a><span id="l6.844"> </span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-          let results = [];</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-          let curDate = this.mStartDate.clone();</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-          curDate.isDate = true;</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineplus">+            let results = [];</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineplus">+            let curDate = this.mStartDate.clone();</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineplus">+            curDate.isDate = true;</span>
<a href="#l6.851"></a><span id="l6.851"> </span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-          while (curDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-              results.push(curDate.clone());</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-              curDate.day += 1;</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-          }</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-          aCount.value = results.length;</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-          return results;</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+            while (curDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+                results.push(curDate.clone());</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+                curDate.day += 1;</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+            }</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+            aCount.value = results.length;</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineplus">+            return results;</span>
<a href="#l6.864"></a><span id="l6.864">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.865"></a><span id="l6.865">       &lt;/method&gt;</span>
<a href="#l6.866"></a><span id="l6.866"> </span>
<a href="#l6.867"></a><span id="l6.867">       &lt;!-- public properties and methods --&gt;</span>
<a href="#l6.868"></a><span id="l6.868"> </span>
<a href="#l6.869"></a><span id="l6.869">       &lt;!-- whether to show days outside of the current month --&gt;</span>
<a href="#l6.870"></a><span id="l6.870">       &lt;property name=&quot;showDaysOutsideMonth&quot;&gt;</span>
<a href="#l6.871"></a><span id="l6.871">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-          return this.mShowDaysOutsideMonth;</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineplus">+            return this.mShowDaysOutsideMonth;</span>
<a href="#l6.874"></a><span id="l6.874">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.875"></a><span id="l6.875">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-          if (this.mShowDaysOutsideMonth != val) {</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-              this.mShowDaysOutsideMonth = val;</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-              this.refresh();</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-          }</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-          return val;</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineplus">+            if (this.mShowDaysOutsideMonth != val) {</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineplus">+                this.mShowDaysOutsideMonth = val;</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineplus">+                this.refresh();</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineplus">+            }</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineplus">+            return val;</span>
<a href="#l6.886"></a><span id="l6.886">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.887"></a><span id="l6.887">       &lt;/property&gt;</span>
<a href="#l6.888"></a><span id="l6.888"> </span>
<a href="#l6.889"></a><span id="l6.889">       &lt;!-- private properties and methods --&gt;</span>
<a href="#l6.890"></a><span id="l6.890"> </span>
<a href="#l6.891"></a><span id="l6.891">       &lt;property name=&quot;monthgrid&quot; readonly=&quot;true&quot;</span>
<a href="#l6.892"></a><span id="l6.892">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'monthgrid');&quot;/&gt;</span>
<a href="#l6.893"></a><span id="l6.893"> </span>
<a href="#l6.894"></a><span id="l6.894">       &lt;property name=&quot;monthgridrows&quot; readonly=&quot;true&quot;</span>
<a href="#l6.895"></a><span id="l6.895">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'monthgridrows');&quot;/&gt;</span>
<a href="#l6.896"></a><span id="l6.896"> </span>
<a href="#l6.897"></a><span id="l6.897">       &lt;method name=&quot;relayout&quot;&gt;</span>
<a href="#l6.898"></a><span id="l6.898">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-          // Adjust headers based on the starting day of the week, if necessary</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-          if (this.labeldaybox.firstChild.weekDay != this.weekStartOffset) {</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-              for (let i = 0; i &lt; this.labeldaybox.childNodes.length; i++) {</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-                  this.labeldaybox.childNodes[i].weekDay = (i + this.weekStartOffset) % 7;</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-              }</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-          }</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineplus">+            // Adjust headers based on the starting day of the week, if necessary</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineplus">+            if (this.labeldaybox.firstChild.weekDay != this.weekStartOffset) {</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineplus">+                for (let i = 0; i &lt; this.labeldaybox.childNodes.length; i++) {</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineplus">+                    this.labeldaybox.childNodes[i].weekDay = (i + this.weekStartOffset) % 7;</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineplus">+                }</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineplus">+            }</span>
<a href="#l6.911"></a><span id="l6.911"> </span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-          if (this.mSelectedItems.length) {</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-              this.mSelectedItems = [];</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-          }</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineplus">+            if (this.mSelectedItems.length) {</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineplus">+                this.mSelectedItems = [];</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineplus">+            }</span>
<a href="#l6.918"></a><span id="l6.918"> </span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-          if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-              throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-          }</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineplus">+            if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineplus">+                throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineplus">+            }</span>
<a href="#l6.925"></a><span id="l6.925"> </span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-          // Days that are not in the main month on display are displayed with</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-          // a gray background.  Unless the month actually starts on a Sunday,</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-          // this means that mStartDate.month is 1 month less than the main month</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-          let mainMonth = this.mStartDate.month;</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-          if (this.mStartDate.day != 1) {</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-              mainMonth++;</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-              mainMonth = mainMonth % 12;</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-          }</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineplus">+            // Days that are not in the main month on display are displayed with</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineplus">+            // a gray background.  Unless the month actually starts on a Sunday,</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineplus">+            // this means that mStartDate.month is 1 month less than the main month</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineplus">+            let mainMonth = this.mStartDate.month;</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineplus">+            if (this.mStartDate.day != 1) {</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineplus">+                mainMonth++;</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineplus">+                mainMonth = mainMonth % 12;</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineplus">+            }</span>
<a href="#l6.942"></a><span id="l6.942"> </span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-          let dateBoxes = [];</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-          let today = this.today();</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineplus">+            let dateBoxes = [];</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineplus">+            let today = this.today();</span>
<a href="#l6.947"></a><span id="l6.947"> </span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">-          // This gets set to true, telling us to collapse the rest of the rows</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-          let finished = false;</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-          let dateList = this.getDateList({});</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineplus">+            // This gets set to true, telling us to collapse the rest of the rows</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineplus">+            let finished = false;</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineplus">+            let dateList = this.getDateList({});</span>
<a href="#l6.954"></a><span id="l6.954"> </span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-          // This allows to find the first column of dayboxes where to set the</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-          // week labels taking into account whether days-off are displayed or not.</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-          let weekLabelColumnPos = -1;</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineplus">+            // This allows to find the first column of dayboxes where to set the</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineplus">+            // week labels taking into account whether days-off are displayed or not.</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineplus">+            let weekLabelColumnPos = -1;</span>
<a href="#l6.961"></a><span id="l6.961"> </span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-          let rows = this.monthgridrows.childNodes;</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineplus">+            let rows = this.monthgridrows.childNodes;</span>
<a href="#l6.964"></a><span id="l6.964"> </span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-          // Iterate through each monthgridrow and set up the day-boxes that</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-          // are its child nodes.  Remember, childNodes is not a normal array,</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-          // so don't use the in operator if you don't want extra properties</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-          // coming out.</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-          for (let i = 0; i &lt; rows.length; i++) {</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-              let row = rows[i];</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-              // If we've already assigned all of the day-boxes that we need, just</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-              // collapse the rest of the rows, otherwise expand them if needed.</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-              if (finished) {</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-                  row.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-                  continue;</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-              } else {</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-                  row.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-              }</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-              for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-                  let daybox = row.childNodes[j];</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-                  let date = dateList[dateBoxes.length];</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineplus">+            // Iterate through each monthgridrow and set up the day-boxes that</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineplus">+            // are its child nodes.  Remember, childNodes is not a normal array,</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineplus">+            // so don't use the in operator if you don't want extra properties</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineplus">+            // coming out.</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineplus">+            for (let i = 0; i &lt; rows.length; i++) {</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineplus">+                let row = rows[i];</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineplus">+                // If we've already assigned all of the day-boxes that we need, just</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineplus">+                // collapse the rest of the rows, otherwise expand them if needed.</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineplus">+                if (finished) {</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineplus">+                    row.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineplus">+                    continue;</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineplus">+                } else {</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineplus">+                    row.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineplus">+                }</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineplus">+                for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineplus">+                    let daybox = row.childNodes[j];</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineplus">+                    let date = dateList[dateBoxes.length];</span>
<a href="#l6.999"></a><span id="l6.999"> </span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-                  // Remove the attribute &quot;relation&quot; for all the column headers.</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-                  // Consider only the first row index otherwise it will be</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-                  // removed again afterwards the correct setting.</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-                  if (i == 0) {</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-                      this.labeldaybox.childNodes[j].removeAttribute(&quot;relation&quot;);</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-                  }</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineplus">+                    // Remove the attribute &quot;relation&quot; for all the column headers.</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineplus">+                    // Consider only the first row index otherwise it will be</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineplus">+                    // removed again afterwards the correct setting.</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineplus">+                    if (i == 0) {</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineplus">+                        this.labeldaybox.childNodes[j].removeAttribute(&quot;relation&quot;);</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineplus">+                    }</span>
<a href="#l6.1012"></a><span id="l6.1012"> </span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-                  daybox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-                  daybox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineplus">+                    daybox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineplus">+                    daybox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l6.1017"></a><span id="l6.1017"> </span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-                  // Set the box-class depending on if this box displays a day in</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-                  // the month being currently shown or not.</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-                  let boxClass;</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-                  if (this.showFullMonth) {</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-                      boxClass = &quot;calendar-month-day-box-&quot; +</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-                                 (mainMonth == date.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-                  } else {</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-                      boxClass = &quot;calendar-month-day-box-current-month&quot;;</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-                  }</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-                  if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == date.weekday)) {</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-                      boxClass = &quot;calendar-month-day-box-day-off &quot; + boxClass;</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-                  }</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+                    // Set the box-class depending on if this box displays a day in</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineplus">+                    // the month being currently shown or not.</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineplus">+                    let boxClass;</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineplus">+                    if (this.showFullMonth) {</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineplus">+                        boxClass = &quot;calendar-month-day-box-&quot; +</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineplus">+                                   (mainMonth == date.month ? &quot;current-month&quot; : &quot;other-month&quot;);</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineplus">+                    } else {</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineplus">+                        boxClass = &quot;calendar-month-day-box-current-month&quot;;</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineplus">+                    }</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineplus">+                    if (this.mDaysOffArray.some(dayOffNum =&gt; dayOffNum == date.weekday)) {</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineplus">+                        boxClass = &quot;calendar-month-day-box-day-off &quot; + boxClass;</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineplus">+                    }</span>
<a href="#l6.1042"></a><span id="l6.1042"> </span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-                  // Set up date relations</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-                  switch (date.compare(today)) {</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-                      case -1:</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-                          daybox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-                          break;</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-                      case 0:</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-                          daybox.setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-                          this.labeldaybox.childNodes[j].setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-                          break;</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-                      case 1:</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-                          daybox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-                          break;</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-                  }</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineplus">+                    // Set up date relations</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineplus">+                    switch (date.compare(today)) {</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineplus">+                        case -1:</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+                            daybox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineplus">+                            break;</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineplus">+                        case 0:</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineplus">+                            daybox.setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineplus">+                            this.labeldaybox.childNodes[j].setAttribute(&quot;relation&quot;, &quot;today&quot;);</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineplus">+                            break;</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineplus">+                        case 1:</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineplus">+                            daybox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineplus">+                            break;</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineplus">+                    }</span>
<a href="#l6.1069"></a><span id="l6.1069"> </span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-                  // Set up label with the week number in the first day of the row.</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-                  if (this.mShowWeekNumber) {</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-                      let weekLabel = document.getAnonymousElementByAttribute(daybox, &quot;anonid&quot;, &quot;week-label&quot;);</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-                      if (weekLabelColumnPos &lt; 0) {</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-                          let isDayOff = this.mDaysOffArray.includes((j + this.mWeekStartOffset) % 7);</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-                          if (this.mDisplayDaysOff || !isDayOff) {</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-                              weekLabelColumnPos = j;</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-                          }</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-                      }</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-                      // Build and set the label.</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-                      if (j == weekLabelColumnPos) {</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-                          weekLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-                          let weekNumber = cal.getWeekInfoService().getWeekTitle(date);</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-                          let weekString = cal.calGetString(&quot;calendar&quot;, &quot;abbreviationOfWeek&quot;, [weekNumber]);</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-                          weekLabel.value = weekString;</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-                      } else {</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-                          weekLabel.hidden = true;</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-                      }</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-                  }</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineplus">+                    // Set up label with the week number in the first day of the row.</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineplus">+                    if (this.mShowWeekNumber) {</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineplus">+                        let weekLabel = document.getAnonymousElementByAttribute(daybox, &quot;anonid&quot;, &quot;week-label&quot;);</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineplus">+                        if (weekLabelColumnPos &lt; 0) {</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineplus">+                            let isDayOff = this.mDaysOffArray.includes((j + this.mWeekStartOffset) % 7);</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineplus">+                            if (this.mDisplayDaysOff || !isDayOff) {</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineplus">+                                weekLabelColumnPos = j;</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineplus">+                            }</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineplus">+                        }</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineplus">+                        // Build and set the label.</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineplus">+                        if (j == weekLabelColumnPos) {</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineplus">+                            weekLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineplus">+                            let weekNumber = cal.getWeekInfoService().getWeekTitle(date);</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineplus">+                            let weekString = cal.calGetString(&quot;calendar&quot;, &quot;abbreviationOfWeek&quot;, [weekNumber]);</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineplus">+                            weekLabel.value = weekString;</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineplus">+                        } else {</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineplus">+                            weekLabel.hidden = true;</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineplus">+                        }</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineplus">+                    }</span>
<a href="#l6.1108"></a><span id="l6.1108"> </span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-                  daybox.setAttribute(&quot;class&quot;, boxClass);</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineplus">+                    daybox.setAttribute(&quot;class&quot;, boxClass);</span>
<a href="#l6.1111"></a><span id="l6.1111"> </span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-                  daybox.setDate(date);</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-                  if (date.day == 1 || date.day == date.endOfMonth.day) {</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-                      daybox.showMonthLabel = true;</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-                  } else {</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-                      daybox.showMonthLabel = false;</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-                  }</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-                  daybox.calendarView = this;</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-                  daybox.date = date;</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-                  dateBoxes.push(daybox);</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineplus">+                    daybox.setDate(date);</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineplus">+                    if (date.day == 1 || date.day == date.endOfMonth.day) {</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineplus">+                        daybox.showMonthLabel = true;</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineplus">+                    } else {</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineplus">+                        daybox.showMonthLabel = false;</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineplus">+                    }</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineplus">+                    daybox.calendarView = this;</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineplus">+                    daybox.date = date;</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineplus">+                    dateBoxes.push(daybox);</span>
<a href="#l6.1130"></a><span id="l6.1130"> </span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-                  // If we've now assigned all of our dates, set this to true so we</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-                  // know we can just collapse the rest of the rows.</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-                  if (dateBoxes.length == dateList.length) {</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-                      finished = true;</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-                  }</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-              }</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-          }</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineplus">+                    // If we've now assigned all of our dates, set this to true so we</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineplus">+                    // know we can just collapse the rest of the rows.</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineplus">+                    if (dateBoxes.length == dateList.length) {</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineplus">+                        finished = true;</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineplus">+                    }</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineplus">+                }</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineplus">+            }</span>
<a href="#l6.1145"></a><span id="l6.1145"> </span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-          // If we're not showing a full month, then add a few extra labels to</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineminus">-          // help the user orient themselves in the view.</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineminus">-          if (!this.mShowFullMonth) {</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineminus">-              dateBoxes[0].showMonthLabel = true;</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">-              dateBoxes[dateBoxes.length - 1].showMonthLabel = true;</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-          }</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineplus">+            // If we're not showing a full month, then add a few extra labels to</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineplus">+            // help the user orient themselves in the view.</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineplus">+            if (!this.mShowFullMonth) {</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineplus">+                dateBoxes[0].showMonthLabel = true;</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineplus">+                dateBoxes[dateBoxes.length - 1].showMonthLabel = true;</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineplus">+            }</span>
<a href="#l6.1158"></a><span id="l6.1158"> </span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-          // Store these, so that we can access them later</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-          this.mDateBoxes = dateBoxes;</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-          this.hideDaysOff();</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineplus">+            // Store these, so that we can access them later</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineplus">+            this.mDateBoxes = dateBoxes;</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineplus">+            this.hideDaysOff();</span>
<a href="#l6.1165"></a><span id="l6.1165"> </span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineminus">-          this.adjustWeekdayLength();</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineplus">+            this.adjustWeekdayLength();</span>
<a href="#l6.1168"></a><span id="l6.1168"> </span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineminus">-          // Store the start and end of current view. Next time when</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineminus">-          // setDateRange is called, it will use mViewStart and mViewEnd to</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineminus">-          // check if view range has been changed.</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineminus">-          this.mViewStart = this.mStartDate;</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineminus">-          this.mViewEnd = this.mEndDate;</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineplus">+            // Store the start and end of current view. Next time when</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineplus">+            // setDateRange is called, it will use mViewStart and mViewEnd to</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineplus">+            // check if view range has been changed.</span>
<a href="#l6.1177"></a><span id="l6.1177" class="difflineplus">+            this.mViewStart = this.mStartDate;</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineplus">+            this.mViewEnd = this.mEndDate;</span>
<a href="#l6.1179"></a><span id="l6.1179"> </span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-          // Store toggle status of current view</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-          let toggleStatus = 0;</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineplus">+            // Store toggle status of current view</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineplus">+            let toggleStatus = 0;</span>
<a href="#l6.1184"></a><span id="l6.1184"> </span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineminus">-          if (this.mTasksInView) {</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-          }</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-          if (this.mWorkdaysOnly) {</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineminus">-          }</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineminus">-          if (this.mShowCompleted) {</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-          }</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineplus">+            if (this.mTasksInView) {</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineplus">+            }</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineplus">+            if (this.mWorkdaysOnly) {</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineplus">+            }</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineplus">+            if (this.mShowCompleted) {</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineplus">+            }</span>
<a href="#l6.1203"></a><span id="l6.1203"> </span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-          this.mToggleStatus = toggleStatus;</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineplus">+            this.mToggleStatus = toggleStatus;</span>
<a href="#l6.1206"></a><span id="l6.1206">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1207"></a><span id="l6.1207">       &lt;/method&gt;</span>
<a href="#l6.1208"></a><span id="l6.1208"> </span>
<a href="#l6.1209"></a><span id="l6.1209">       &lt;method name=&quot;hideWeekNumbers&quot;&gt;</span>
<a href="#l6.1210"></a><span id="l6.1210">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-          let rows = this.monthgridrows.childNodes;</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineminus">-          for (let i = 0; i &lt; rows.length; i++) {</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineminus">-              let row = rows[i];</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineminus">-              for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineminus">-                  let daybox = row.childNodes[j];</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineminus">-                  let weekLabel = document.getAnonymousElementByAttribute(daybox, &quot;anonid&quot;, &quot;week-label&quot;);</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineminus">-                  weekLabel.hidden = true;</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineminus">-              }</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineminus">-          }</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineplus">+            let rows = this.monthgridrows.childNodes;</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineplus">+            for (let i = 0; i &lt; rows.length; i++) {</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineplus">+                let row = rows[i];</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineplus">+                for (let j = 0; j &lt; row.childNodes.length; j++) {</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineplus">+                    let daybox = row.childNodes[j];</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineplus">+                    let weekLabel = document.getAnonymousElementByAttribute(daybox, &quot;anonid&quot;, &quot;week-label&quot;);</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineplus">+                    weekLabel.hidden = true;</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineplus">+                }</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineplus">+            }</span>
<a href="#l6.1229"></a><span id="l6.1229">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1230"></a><span id="l6.1230">       &lt;/method&gt;</span>
<a href="#l6.1231"></a><span id="l6.1231"> </span>
<a href="#l6.1232"></a><span id="l6.1232">       &lt;method name=&quot;hideDaysOff&quot;&gt;</span>
<a href="#l6.1233"></a><span id="l6.1233">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineminus">-          let columns = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;monthgridcolumns&quot;).childNodes;</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineminus">-          let headerkids = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;labeldaybox&quot;).childNodes;</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineminus">-          for (let i = 0; i &lt; columns.length; i++) {</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineminus">-              let dayForColumn = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineminus">-              let dayOff = this.mDaysOffArray.includes(dayForColumn);</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineminus">-              columns[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineminus">-              headerkids[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineminus">-          }</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineplus">+            let columns = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;monthgridcolumns&quot;).childNodes;</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineplus">+            let headerkids = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;labeldaybox&quot;).childNodes;</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineplus">+            for (let i = 0; i &lt; columns.length; i++) {</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineplus">+                let dayForColumn = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineplus">+                let dayOff = this.mDaysOffArray.includes(dayForColumn);</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineplus">+                columns[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineplus">+                headerkids[i].collapsed = dayOff &amp;&amp; !this.mDisplayDaysOff;</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineplus">+            }</span>
<a href="#l6.1250"></a><span id="l6.1250">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1251"></a><span id="l6.1251">       &lt;/method&gt;</span>
<a href="#l6.1252"></a><span id="l6.1252"> </span>
<a href="#l6.1253"></a><span id="l6.1253">       &lt;method name=&quot;findDayBoxForDate&quot;&gt;</span>
<a href="#l6.1254"></a><span id="l6.1254">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l6.1255"></a><span id="l6.1255">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-          if (!this.mDateBoxes) {</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-              return null;</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-          }</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineminus">-          for (let box of this.mDateBoxes) {</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineminus">-              if (box.mDate.compare(aDate) == 0) {</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineminus">-                  return box;</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-              }</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-          }</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineminus">-          return null;</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineplus">+            if (!this.mDateBoxes) {</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineplus">+                return null;</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineplus">+            }</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineplus">+            for (let box of this.mDateBoxes) {</span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineplus">+                if (box.mDate.compare(aDate) == 0) {</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineplus">+                    return box;</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineplus">+                }</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineplus">+            }</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineplus">+            return null;</span>
<a href="#l6.1274"></a><span id="l6.1274">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1275"></a><span id="l6.1275">       &lt;/method&gt;</span>
<a href="#l6.1276"></a><span id="l6.1276"> </span>
<a href="#l6.1277"></a><span id="l6.1277">       &lt;method name=&quot;findDayBoxesForItem&quot;&gt;</span>
<a href="#l6.1278"></a><span id="l6.1278">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.1279"></a><span id="l6.1279">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineminus">-          let targetDate = null;</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineminus">-          let finishDate = null;</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineminus">-          let boxes = [];</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineplus">+            let targetDate = null;</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineplus">+            let finishDate = null;</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineplus">+            let boxes = [];</span>
<a href="#l6.1286"></a><span id="l6.1286"> </span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineminus">-          // All our boxes are in default tz, so we need these times in them too.</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineminus">-          if (cal.isEvent(aItem)) {</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineminus">-              targetDate = aItem.startDate.getInTimezone(this.mTimezone);</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">-              finishDate = aItem.endDate.getInTimezone(this.mTimezone);</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineminus">-          } else if (cal.isToDo(aItem)) {</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineminus">-              // Consider tasks without entry OR due date.</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineminus">-              if (aItem.entryDate || aItem.dueDate) {</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">-                  targetDate = (aItem.entryDate || aItem.dueDate).getInTimezone(this.mTimezone);</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineminus">-                  finishDate = (aItem.dueDate || aItem.entryDate).getInTimezone(this.mTimezone);</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineminus">-              }</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineminus">-          }</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineplus">+            // All our boxes are in default tz, so we need these times in them too.</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineplus">+            if (cal.isEvent(aItem)) {</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineplus">+                targetDate = aItem.startDate.getInTimezone(this.mTimezone);</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineplus">+                finishDate = aItem.endDate.getInTimezone(this.mTimezone);</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineplus">+            } else if (cal.isToDo(aItem)) {</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineplus">+                // Consider tasks without entry OR due date.</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineplus">+                if (aItem.entryDate || aItem.dueDate) {</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineplus">+                    targetDate = (aItem.entryDate || aItem.dueDate).getInTimezone(this.mTimezone);</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineplus">+                    finishDate = (aItem.dueDate || aItem.entryDate).getInTimezone(this.mTimezone);</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineplus">+                }</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineplus">+            }</span>
<a href="#l6.1309"></a><span id="l6.1309"> </span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-          if (!targetDate) {</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineminus">-              return boxes;</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineminus">-          }</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineplus">+            if (!targetDate) {</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineplus">+                return boxes;</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineplus">+            }</span>
<a href="#l6.1316"></a><span id="l6.1316"> </span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineminus">-          if (!finishDate) {</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-              let maybeBox = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-              if (maybeBox) {</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineminus">-                  boxes.push(maybeBox);</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineminus">-              }</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineminus">-              return boxes;</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineminus">-          }</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineplus">+            if (!finishDate) {</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineplus">+                let maybeBox = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineplus">+                if (maybeBox) {</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineplus">+                    boxes.push(maybeBox);</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineplus">+                }</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineplus">+                return boxes;</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineplus">+            }</span>
<a href="#l6.1331"></a><span id="l6.1331"> </span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-          if (!targetDate.isDate) {</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineminus">-              // Reset the time to 00:00, so that we really get all the boxes</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineminus">-              targetDate.hour = 0;</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineminus">-              targetDate.minute = 0;</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-              targetDate.second = 0;</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-          }</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineplus">+            if (!targetDate.isDate) {</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineplus">+                // Reset the time to 00:00, so that we really get all the boxes</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineplus">+                targetDate.hour = 0;</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineplus">+                targetDate.minute = 0;</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineplus">+                targetDate.second = 0;</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineplus">+            }</span>
<a href="#l6.1344"></a><span id="l6.1344"> </span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineminus">-          if (targetDate.compare(finishDate) == 0) {</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineminus">-              // We have also to handle zero length events in particular for</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineminus">-              // tasks without entry or due date.</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineminus">-              let box = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineminus">-              if (box) {</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineminus">-                  boxes.push(box);</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineminus">-              }</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineminus">-          }</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineplus">+            if (targetDate.compare(finishDate) == 0) {</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineplus">+                // We have also to handle zero length events in particular for</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineplus">+                // tasks without entry or due date.</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineplus">+                let box = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineplus">+                if (box) {</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineplus">+                    boxes.push(box);</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineplus">+                }</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineplus">+            }</span>
<a href="#l6.1361"></a><span id="l6.1361"> </span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">-          while (targetDate.compare(finishDate) == -1) {</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-              let box = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineplus">+            while (targetDate.compare(finishDate) == -1) {</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineplus">+                let box = this.findDayBoxForDate(targetDate);</span>
<a href="#l6.1366"></a><span id="l6.1366"> </span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineminus">-              // This might not exist, if the event spans the view start or end</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineminus">-              if (box) {</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineminus">-                  boxes.push(box);</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineminus">-              }</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineminus">-              targetDate.day += 1;</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineminus">-          }</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineplus">+                // This might not exist, if the event spans the view start or end</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineplus">+                if (box) {</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineplus">+                    boxes.push(box);</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineplus">+                }</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineplus">+                targetDate.day += 1;</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineplus">+            }</span>
<a href="#l6.1379"></a><span id="l6.1379"> </span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineminus">-          return boxes;</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-	]]&gt;&lt;/body&gt;</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineplus">+            return boxes;</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1384"></a><span id="l6.1384">       &lt;/method&gt;</span>
<a href="#l6.1385"></a><span id="l6.1385"> </span>
<a href="#l6.1386"></a><span id="l6.1386">       &lt;method name=&quot;doAddItem&quot;&gt;</span>
<a href="#l6.1387"></a><span id="l6.1387">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.1388"></a><span id="l6.1388">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineminus">-          let boxes = this.findDayBoxesForItem(aItem);</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineplus">+            let boxes = this.findDayBoxesForItem(aItem);</span>
<a href="#l6.1391"></a><span id="l6.1391"> </span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineminus">-          if (!boxes.length) {</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineminus">-              return;</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineminus">-          }</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineplus">+            if (!boxes.length) {</span>
<a href="#l6.1396"></a><span id="l6.1396" class="difflineplus">+                return;</span>
<a href="#l6.1397"></a><span id="l6.1397" class="difflineplus">+            }</span>
<a href="#l6.1398"></a><span id="l6.1398"> </span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">-          for (let box of boxes) {</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">-              box.addItem(aItem);</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineminus">-          }</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineplus">+            for (let box of boxes) {</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineplus">+                box.addItem(aItem);</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineplus">+            }</span>
<a href="#l6.1405"></a><span id="l6.1405">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1406"></a><span id="l6.1406">       &lt;/method&gt;</span>
<a href="#l6.1407"></a><span id="l6.1407"> </span>
<a href="#l6.1408"></a><span id="l6.1408">       &lt;method name=&quot;doDeleteItem&quot;&gt;</span>
<a href="#l6.1409"></a><span id="l6.1409">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l6.1410"></a><span id="l6.1410">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineminus">-          let boxes = this.findDayBoxesForItem(aItem);</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineplus">+            let boxes = this.findDayBoxesForItem(aItem);</span>
<a href="#l6.1413"></a><span id="l6.1413"> </span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineminus">-          if (!boxes.length) {</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineminus">-              return;</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineminus">-          }</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineplus">+            if (!boxes.length) {</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineplus">+                return;</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineplus">+            }</span>
<a href="#l6.1420"></a><span id="l6.1420"> </span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineminus">-          function isNotItem(a) {</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineminus">-              return (a.hashId != aItem.hashId);</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineminus">-          }</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineminus">-          let oldLength = this.mSelectedItems.length;</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineminus">-          this.mSelectedItems = this.mSelectedItems.filter(isNotItem);</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineplus">+            function isNotItem(a) {</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineplus">+                return (a.hashId != aItem.hashId);</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineplus">+            }</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineplus">+            let oldLength = this.mSelectedItems.length;</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineplus">+            this.mSelectedItems = this.mSelectedItems.filter(isNotItem);</span>
<a href="#l6.1431"></a><span id="l6.1431"> </span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineminus">-          for (let box of boxes) {</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineminus">-              box.deleteItem(aItem);</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineminus">-          }</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineplus">+            for (let box of boxes) {</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineplus">+                box.deleteItem(aItem);</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineplus">+            }</span>
<a href="#l6.1438"></a><span id="l6.1438"> </span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineminus">-          // If a deleted event was selected, we need to announce that the</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineminus">-          // selection changed.</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineminus">-          if (oldLength != this.mSelectedItems.length) {</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineminus">-              this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineminus">-          }</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineplus">+            // If a deleted event was selected, we need to announce that the</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineplus">+            // selection changed.</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineplus">+            if (oldLength != this.mSelectedItems.length) {</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineplus">+                this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineplus">+            }</span>
<a href="#l6.1449"></a><span id="l6.1449">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1450"></a><span id="l6.1450">       &lt;/method&gt;</span>
<a href="#l6.1451"></a><span id="l6.1451"> </span>
<a href="#l6.1452"></a><span id="l6.1452">       &lt;method name=&quot;deleteItemsFromCalendar&quot;&gt;</span>
<a href="#l6.1453"></a><span id="l6.1453">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l6.1454"></a><span id="l6.1454">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineminus">-          if (!this.mDateBoxes) {</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineminus">-              return;</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineminus">-          }</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-          for (let box of this.mDateBoxes) {</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-              for (let id in box.mItemHash) {</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineminus">-                  let node = box.mItemHash[id];</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineminus">-                  let item = node.item;</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-                  if (item.calendar.id == aCalendar.id) {</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineminus">-                      box.deleteItem(item);</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-                  }</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">-              }</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-          }</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineplus">+            if (!this.mDateBoxes) {</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineplus">+                return;</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineplus">+            }</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineplus">+            for (let box of this.mDateBoxes) {</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineplus">+                for (let id in box.mItemHash) {</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineplus">+                    let node = box.mItemHash[id];</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineplus">+                    let item = node.item;</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineplus">+                    if (item.calendar.id == aCalendar.id) {</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineplus">+                        box.deleteItem(item);</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineplus">+                    }</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineplus">+                }</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineplus">+            }</span>
<a href="#l6.1479"></a><span id="l6.1479">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1480"></a><span id="l6.1480">       &lt;/method&gt;</span>
<a href="#l6.1481"></a><span id="l6.1481"> </span>
<a href="#l6.1482"></a><span id="l6.1482">       &lt;method name=&quot;flashAlarm&quot;&gt;</span>
<a href="#l6.1483"></a><span id="l6.1483">         &lt;parameter name=&quot;aAlarmItem&quot;/&gt;</span>
<a href="#l6.1484"></a><span id="l6.1484">         &lt;parameter name=&quot;aStop&quot;/&gt;</span>
<a href="#l6.1485"></a><span id="l6.1485">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineminus">-          let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">-          let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineplus">+            let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineplus">+            let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l6.1490"></a><span id="l6.1490"> </span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineminus">-          if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineminus">-              // No need to animate if the indicator should not be shown.</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineminus">-              return;</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineminus">-          }</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineplus">+            if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineplus">+                // No need to animate if the indicator should not be shown.</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineplus">+                return;</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineplus">+            }</span>
<a href="#l6.1499"></a><span id="l6.1499"> </span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineminus">-          // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineminus">-          // boxes.</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineminus">-          let boxes = this.findDayBoxesForItem(aAlarmItem);</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineminus">-          for (let box of boxes) {</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineminus">-              for (let id in box.mItemHash) {</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-                  let itemData = box.mItemHash[id];</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-                  if (itemData.item.hasSameIds(aAlarmItem)) {</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineminus">-                      if (aStop) {</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-                          itemData.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-                      } else {</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-                          itemData.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-                      }</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-                  }</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-              }</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-          }</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineplus">+            // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineplus">+            // boxes.</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineplus">+            let boxes = this.findDayBoxesForItem(aAlarmItem);</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineplus">+            for (let box of boxes) {</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineplus">+                for (let id in box.mItemHash) {</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineplus">+                    let itemData = box.mItemHash[id];</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineplus">+                    if (itemData.item.hasSameIds(aAlarmItem)) {</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineplus">+                        if (aStop) {</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineplus">+                            itemData.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineplus">+                        } else {</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineplus">+                            itemData.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineplus">+                        }</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineplus">+                    }</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineplus">+                }</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineplus">+            }</span>
<a href="#l6.1530"></a><span id="l6.1530"> </span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineminus">-          if (aStop) {</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineminus">-              // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineminus">-              delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineminus">-          } else {</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineminus">-              // Set up a timer to stop the flashing after the total time.</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-              this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-              setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineminus">-          }</span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineplus">+            if (aStop) {</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineplus">+                // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineplus">+                delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineplus">+            } else {</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineplus">+                // Set up a timer to stop the flashing after the total time.</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineplus">+                this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineplus">+                setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineplus">+            }</span>
<a href="#l6.1547"></a><span id="l6.1547">         ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1548"></a><span id="l6.1548">       &lt;/method&gt;</span>
<a href="#l6.1549"></a><span id="l6.1549">     &lt;/implementation&gt;</span>
<a href="#l6.1550"></a><span id="l6.1550"> </span>
<a href="#l6.1551"></a><span id="l6.1551">     &lt;handlers&gt;</span>
<a href="#l6.1552"></a><span id="l6.1552">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l6.1553"></a><span id="l6.1553" class="difflineminus">-        const pixelThreshold = 150;</span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineminus">-        let scrollEnabled = Preferences.get(&quot;calendar.view.mousescroll&quot;, true);</span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineminus">-        if (!event.ctrlKey &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineminus">-            !event.altKey &amp;&amp; !event.metaKey &amp;&amp; scrollEnabled) {</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineminus">-            // In the month view, the only thing that can be scrolled</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineminus">-            // is the month the user is in. calendar-base-view takes care</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineminus">-            // of the shift key, so only move the view when no modifier</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineminus">-            // is pressed.</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineminus">-            let deltaView = 0;</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineminus">-            if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineminus">-                if (event.deltaY != 0) {</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineminus">-                    deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineminus">-                }</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineminus">-            } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineminus">-                this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineminus">-                if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineminus">-                    deltaView = 1;</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineminus">-                    this.mPixelScrollDelta = 0;</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineminus">-                } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineminus">-                    deltaView = -1;</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineminus">-                    this.mPixelScrollDelta = 0;</span>
<a href="#l6.1574"></a><span id="l6.1574" class="difflineminus">-                }</span>
<a href="#l6.1575"></a><span id="l6.1575" class="difflineminus">-            }</span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineplus">+          const pixelThreshold = 150;</span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineplus">+          let scrollEnabled = Preferences.get(&quot;calendar.view.mousescroll&quot;, true);</span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineplus">+          if (!event.ctrlKey &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineplus">+              !event.altKey &amp;&amp; !event.metaKey &amp;&amp; scrollEnabled) {</span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineplus">+              // In the month view, the only thing that can be scrolled</span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineplus">+              // is the month the user is in. calendar-base-view takes care</span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineplus">+              // of the shift key, so only move the view when no modifier</span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineplus">+              // is pressed.</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineplus">+              let deltaView = 0;</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineplus">+              if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineplus">+                  if (event.deltaY != 0) {</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineplus">+                      deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineplus">+                  }</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineplus">+              } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineplus">+                  this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineplus">+                  if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineplus">+                      deltaView = 1;</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineplus">+                      this.mPixelScrollDelta = 0;</span>
<a href="#l6.1594"></a><span id="l6.1594" class="difflineplus">+                  } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l6.1595"></a><span id="l6.1595" class="difflineplus">+                      deltaView = -1;</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineplus">+                      this.mPixelScrollDelta = 0;</span>
<a href="#l6.1597"></a><span id="l6.1597" class="difflineplus">+                  }</span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineplus">+              }</span>
<a href="#l6.1599"></a><span id="l6.1599"> </span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineminus">-            if (deltaView != 0) {</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineminus">-                this.moveView(deltaView);</span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineminus">-            }</span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineminus">-        }</span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineplus">+              if (deltaView != 0) {</span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineplus">+                  this.moveView(deltaView);</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineplus">+              }</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineplus">+          }</span>
<a href="#l6.1608"></a><span id="l6.1608">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l6.1609"></a><span id="l6.1609">     &lt;/handlers&gt;</span>
<a href="#l6.1610"></a><span id="l6.1610">   &lt;/binding&gt;</span>
<a href="#l6.1611"></a><span id="l6.1611"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -26,150 +26,150 @@</span>
<a href="#l7.4"></a><span id="l7.4">     &lt;implementation&gt;</span>
<a href="#l7.5"></a><span id="l7.5">       &lt;field name=&quot;mPixPerMin&quot;&gt;0.6&lt;/field&gt;</span>
<a href="#l7.6"></a><span id="l7.6">       &lt;field name=&quot;mStartMin&quot;&gt;0&lt;/field&gt;</span>
<a href="#l7.7"></a><span id="l7.7">       &lt;field name=&quot;mEndMin&quot;&gt;24 * 60&lt;/field&gt;</span>
<a href="#l7.8"></a><span id="l7.8">       &lt;field name=&quot;mDayStartHour&quot;&gt;0&lt;/field&gt;</span>
<a href="#l7.9"></a><span id="l7.9">       &lt;field name=&quot;mDayEndHour&quot;&gt;24&lt;/field&gt;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">       &lt;constructor&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        this.relayout();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+          this.relayout();</span>
<a href="#l7.14"></a><span id="l7.14">       &lt;/constructor&gt;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">       &lt;method name=&quot;setDayStartEndHours&quot;&gt;</span>
<a href="#l7.17"></a><span id="l7.17">         &lt;parameter name=&quot;aDayStartHour&quot;/&gt;</span>
<a href="#l7.18"></a><span id="l7.18">         &lt;parameter name=&quot;aDayEndHour&quot;/&gt;</span>
<a href="#l7.19"></a><span id="l7.19">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-          if (aDayStartHour * 60 &lt; this.mStartMin ||</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-              aDayStartHour &gt; aDayEndHour ||</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-              aDayEndHour * 60 &gt; this.mEndMin) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-              throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-          }</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-          if (this.mDayStartHour != aDayStartHour ||</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-              this.mDayEndHour != aDayEndHour) {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-              this.mDayEndHour = aDayEndHour;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-              this.mDayStartHour = aDayStartHour;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-              let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-              if (topbox.childNodes.length) {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                  // This only needs to be done if the initial relayout has</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                  // already happened, otherwise it will be done then.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                  for (let hour = this.mStartMin / 60; hour &lt; this.mEndMin / 60; hour++) {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-                      if (hour &lt; this.mDayStartHour || hour &gt;= this.mDayEndHour) {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-                          topbox.childNodes[hour].setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-                      } else {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-                          topbox.childNodes[hour].removeAttribute(&quot;off-time&quot;);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-                      }</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-                  }</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-              }</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-          }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+            if (aDayStartHour * 60 &lt; this.mStartMin ||</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+                aDayStartHour &gt; aDayEndHour ||</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+                aDayEndHour * 60 &gt; this.mEndMin) {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+            }</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+            if (this.mDayStartHour != aDayStartHour ||</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                this.mDayEndHour != aDayEndHour) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                this.mDayEndHour = aDayEndHour;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                this.mDayStartHour = aDayStartHour;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+                let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+                if (topbox.childNodes.length) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                    // This only needs to be done if the initial relayout has</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                    // already happened, otherwise it will be done then.</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                    for (let hour = this.mStartMin / 60; hour &lt; this.mEndMin / 60; hour++) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                        if (hour &lt; this.mDayStartHour || hour &gt;= this.mDayEndHour) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+                            topbox.childNodes[hour].setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                        } else {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                            topbox.childNodes[hour].removeAttribute(&quot;off-time&quot;);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                        }</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                    }</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                }</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+            }</span>
<a href="#l7.66"></a><span id="l7.66">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.67"></a><span id="l7.67">       &lt;/method&gt;</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l7.70"></a><span id="l7.70">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l7.71"></a><span id="l7.71">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l7.72"></a><span id="l7.72">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-          let needsrelayout = false;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-          if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-              if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-                  needsrelayout = true;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-              }</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-          }</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-          if (needsrelayout) {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-              this.relayout();</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-          }</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-          return ret;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+            let needsrelayout = false;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+            if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+                if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+                    needsrelayout = true;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+                }</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+            }</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+            if (needsrelayout) {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+                this.relayout();</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+            }</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+            return ret;</span>
<a href="#l7.103"></a><span id="l7.103">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.104"></a><span id="l7.104">       &lt;/method&gt;</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106">       &lt;property name=&quot;pixelsPerMinute&quot;</span>
<a href="#l7.107"></a><span id="l7.107">                 onget=&quot;return this.mPixPerMin&quot;</span>
<a href="#l7.108"></a><span id="l7.108">                 onset=&quot;if (this.mPixPerMin != val) { this.mPixPerMin = val; this.relayout(); } return val;&quot;/&gt;</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110">       &lt;method name=&quot;relayout&quot;&gt;</span>
<a href="#l7.111"></a><span id="l7.111">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-          let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-          let orient = topbox.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-          function makeTimeBox(timestr, size) {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-              let box = createXULElement(&quot;box&quot;);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-              box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-              if (orient == &quot;horizontal&quot;) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                  box.setAttribute(&quot;width&quot;, size);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-              } else {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                  box.setAttribute(&quot;height&quot;, size);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-              }</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-              let label = createXULElement(&quot;label&quot;);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-              label.setAttribute(&quot;class&quot;, &quot;calendar-time-bar-label&quot;);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-              label.setAttribute(&quot;value&quot;, timestr);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-              label.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-              box.appendChild(label);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-              return box;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-          }</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-          while (topbox.hasChildNodes()) {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-              topbox.lastChild.remove();</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-          }</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-          let timeFormatter = cal.getDateFormatter();</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-          let jsTime = new Date();</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-          let timeString;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-          let theMin = this.mStartMin;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-          let theHour = Math.floor(theMin / 60);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-          let durLeft = this.mEndMin - this.mStartMin;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-          while (durLeft &gt; 0) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-              let dur;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-              if (this.mEndMin - theMin &lt; 60) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-                  dur = this.mEndMin - theMin;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-              } else {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                  dur = theMin % 60;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-              }</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-              theMin += dur;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-              if (dur == 0) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-                  dur = 60;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-              }</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-              // calculate duration pixel as the difference between</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-              // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-              let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-              let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-              let durPix = endPix - startPix;</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-              let box;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-              if (dur == 60) {</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-                  jsTime.setHours(theHour, 0, 0);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-                  timeString = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-                  box = makeTimeBox(timeString, durPix);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-              } else {</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-                  box = makeTimeBox(&quot;&quot;, durPix);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-              }</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-              // Set up workweek hours</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-              if (theHour &lt; this.mDayStartHour || theHour &gt;= this.mDayEndHour) {</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-                  box.setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-              }</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-              box.setAttribute(&quot;class&quot;, &quot;calendar-time-bar-box-&quot; + (theHour % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-              topbox.appendChild(box);</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-              durLeft -= dur;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-              theMin += dur;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-              theHour++;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-          }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+            Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+            let topbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+            let orient = topbox.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+            function makeTimeBox(timestr, size) {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+                let box = createXULElement(&quot;box&quot;);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+                box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+                if (orient == &quot;horizontal&quot;) {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+                    box.setAttribute(&quot;width&quot;, size);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+                } else {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+                    box.setAttribute(&quot;height&quot;, size);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+                }</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+                let label = createXULElement(&quot;label&quot;);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+                label.setAttribute(&quot;class&quot;, &quot;calendar-time-bar-label&quot;);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+                label.setAttribute(&quot;value&quot;, timestr);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+                label.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+                box.appendChild(label);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+                return box;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+            }</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+            while (topbox.hasChildNodes()) {</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+                topbox.lastChild.remove();</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+            }</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+            let timeFormatter = cal.getDateFormatter();</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+            let jsTime = new Date();</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+            let timeString;</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+            let theMin = this.mStartMin;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+            let theHour = Math.floor(theMin / 60);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+            let durLeft = this.mEndMin - this.mStartMin;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+            while (durLeft &gt; 0) {</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+                let dur;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+                if (this.mEndMin - theMin &lt; 60) {</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+                    dur = this.mEndMin - theMin;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+                } else {</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+                    dur = theMin % 60;</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+                }</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+                theMin += dur;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+                if (dur == 0) {</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+                    dur = 60;</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+                }</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+                // calculate duration pixel as the difference between</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+                // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+                let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+                let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+                let durPix = endPix - startPix;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+                let box;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+                if (dur == 60) {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+                    jsTime.setHours(theHour, 0, 0);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+                    timeString = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+                    box = makeTimeBox(timeString, durPix);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+                } else {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+                    box = makeTimeBox(&quot;&quot;, durPix);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+                }</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+                // Set up workweek hours</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+                if (theHour &lt; this.mDayStartHour || theHour &gt;= this.mDayEndHour) {</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+                    box.setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+                }</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+                box.setAttribute(&quot;class&quot;, &quot;calendar-time-bar-box-&quot; + (theHour % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+                topbox.appendChild(box);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+                durLeft -= dur;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+                theMin += dur;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+                theHour++;</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+            }</span>
<a href="#l7.258"></a><span id="l7.258">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.259"></a><span id="l7.259">       &lt;/method&gt;</span>
<a href="#l7.260"></a><span id="l7.260">     &lt;/implementation&gt;</span>
<a href="#l7.261"></a><span id="l7.261">   &lt;/binding&gt;</span>
<a href="#l7.262"></a><span id="l7.262"> </span>
<a href="#l7.263"></a><span id="l7.263">   &lt;!--</span>
<a href="#l7.264"></a><span id="l7.264">      - A simple gripbar that is displayed at the start and end of an</span>
<a href="#l7.265"></a><span id="l7.265">      - event box.  Needs to handle being dragged and resizing the</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineat">@@ -183,43 +183,43 @@</span>
<a href="#l7.267"></a><span id="l7.267">                xbl:inherits=&quot;align=whichside&quot;&gt;</span>
<a href="#l7.268"></a><span id="l7.268">         &lt;xul:image xbl:inherits=&quot;class&quot;/&gt;</span>
<a href="#l7.269"></a><span id="l7.269">       &lt;/xul:box&gt;</span>
<a href="#l7.270"></a><span id="l7.270">     &lt;/content&gt;</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272">     &lt;implementation&gt;</span>
<a href="#l7.273"></a><span id="l7.273">       &lt;property name=&quot;parentorient&quot;&gt;</span>
<a href="#l7.274"></a><span id="l7.274">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-          return this.getAttribute(&quot;parentorient&quot;);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+            return this.getAttribute(&quot;parentorient&quot;);</span>
<a href="#l7.277"></a><span id="l7.277">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.278"></a><span id="l7.278">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-          let thebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;thebox&quot;);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-          this.setAttribute(&quot;parentorient&quot;, val);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-          thebox.setAttribute(&quot;orient&quot;, getOtherOrientation(val));</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-          return val;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+            let thebox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;thebox&quot;);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+            this.setAttribute(&quot;parentorient&quot;, val);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+            thebox.setAttribute(&quot;orient&quot;, getOtherOrientation(val));</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+            return val;</span>
<a href="#l7.287"></a><span id="l7.287">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.288"></a><span id="l7.288">       &lt;/property&gt;</span>
<a href="#l7.289"></a><span id="l7.289"> </span>
<a href="#l7.290"></a><span id="l7.290">       &lt;!-- private --&gt;</span>
<a href="#l7.291"></a><span id="l7.291">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-        this.parentorient = this.getAttribute(&quot;parentorient&quot;);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+          this.parentorient = this.getAttribute(&quot;parentorient&quot;);</span>
<a href="#l7.294"></a><span id="l7.294">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.295"></a><span id="l7.295">     &lt;/implementation&gt;</span>
<a href="#l7.296"></a><span id="l7.296"> </span>
<a href="#l7.297"></a><span id="l7.297">     &lt;handlers&gt;</span>
<a href="#l7.298"></a><span id="l7.298">       &lt;handler event=&quot;mousedown&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-        // store the attribute 'whichside' in the event object</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-        // but *don't* call stopPropagation(). as soon as the</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-        // enclosing event box will receive the event it will</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-        // make use of this information in order to invoke the</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-        // appropriate action.</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-        event.whichside = this.getAttribute(&quot;whichside&quot;);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+          // store the attribute 'whichside' in the event object</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+          // but *don't* call stopPropagation(). as soon as the</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+          // enclosing event box will receive the event it will</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+          // make use of this information in order to invoke the</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+          // appropriate action.</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+          event.whichside = this.getAttribute(&quot;whichside&quot;);</span>
<a href="#l7.311"></a><span id="l7.311">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.312"></a><span id="l7.312">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l7.315"></a><span id="l7.315">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.316"></a><span id="l7.316">     &lt;/handlers&gt;</span>
<a href="#l7.317"></a><span id="l7.317">   &lt;/binding&gt;</span>
<a href="#l7.318"></a><span id="l7.318"> </span>
<a href="#l7.319"></a><span id="l7.319">   &lt;!--</span>
<a href="#l7.320"></a><span id="l7.320">      - A column for displaying event boxes in.  One column per</span>
<a href="#l7.321"></a><span id="l7.321">      - day; it manages the layout of the events given via add/deleteEvent.</span>
<a href="#l7.322"></a><span id="l7.322">     --&gt;</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineat">@@ -239,21 +239,21 @@</span>
<a href="#l7.324"></a><span id="l7.324">           &lt;xul:label anonid=&quot;fgdragbox-endlabel&quot; class=&quot;fgdragbox-label&quot;/&gt;</span>
<a href="#l7.325"></a><span id="l7.325">         &lt;/xul:box&gt;</span>
<a href="#l7.326"></a><span id="l7.326">       &lt;/xul:stack&gt;</span>
<a href="#l7.327"></a><span id="l7.327">       &lt;xul:calendar-event-box anonid=&quot;config-box&quot; hidden=&quot;true&quot; xbl:inherits=&quot;orient&quot;/&gt;</span>
<a href="#l7.328"></a><span id="l7.328">     &lt;/content&gt;</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330">     &lt;implementation&gt;</span>
<a href="#l7.331"></a><span id="l7.331">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-        this.mEventInfos = [];</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-        this.mTimezone = cal.UTC();</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-        this.mSelectedItemIds = {};</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+          this.mEventInfos = [];</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+          this.mTimezone = cal.UTC();</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+          this.mSelectedItemIds = {};</span>
<a href="#l7.342"></a><span id="l7.342">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.343"></a><span id="l7.343"> </span>
<a href="#l7.344"></a><span id="l7.344">       &lt;!-- fields --&gt;</span>
<a href="#l7.345"></a><span id="l7.345">       &lt;field name=&quot;mPixPerMin&quot;&gt;0.6&lt;/field&gt;</span>
<a href="#l7.346"></a><span id="l7.346">       &lt;field name=&quot;mStartMin&quot;&gt;0&lt;/field&gt;</span>
<a href="#l7.347"></a><span id="l7.347">       &lt;field name=&quot;mEndMin&quot;&gt;24 * 60&lt;/field&gt;</span>
<a href="#l7.348"></a><span id="l7.348">       &lt;field name=&quot;mDayStartMin&quot;&gt;8 * 60&lt;/field&gt;</span>
<a href="#l7.349"></a><span id="l7.349">       &lt;field name=&quot;mDayEndMin&quot;&gt;17 * 60&lt;/field&gt;</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineat">@@ -285,167 +285,167 @@</span>
<a href="#l7.351"></a><span id="l7.351">         --&gt;</span>
<a href="#l7.352"></a><span id="l7.352">       &lt;field name=&quot;mCreatedNewEvent&quot;&gt;false&lt;/field&gt;</span>
<a href="#l7.353"></a><span id="l7.353">       &lt;field name=&quot;mEventToEdit&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.354"></a><span id="l7.354">       &lt;field name=&quot;mSelectedItemIds&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.355"></a><span id="l7.355"> </span>
<a href="#l7.356"></a><span id="l7.356">       &lt;!-- properties --&gt;</span>
<a href="#l7.357"></a><span id="l7.357">       &lt;property name=&quot;pixelsPerMinute&quot;&gt;</span>
<a href="#l7.358"></a><span id="l7.358">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-          return this.mPixPerMin;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+            return this.mPixPerMin;</span>
<a href="#l7.361"></a><span id="l7.361">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.362"></a><span id="l7.362">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-          if (val &lt;= 0.0) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-              val = 0.01;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-          }</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-          if (val != this.mPixPerMin) {</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-              this.mPixPerMin = val;</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-              this.relayout();</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-          }</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-          return val;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+            if (val &lt;= 0.0) {</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+                val = 0.01;</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+            }</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+            if (val != this.mPixPerMin) {</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+                this.mPixPerMin = val;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+                this.relayout();</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+            }</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+            return val;</span>
<a href="#l7.379"></a><span id="l7.379">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.380"></a><span id="l7.380">       &lt;/property&gt;</span>
<a href="#l7.381"></a><span id="l7.381"> </span>
<a href="#l7.382"></a><span id="l7.382">       &lt;field name=&quot;mSelected&quot;&gt;false&lt;/field&gt;</span>
<a href="#l7.383"></a><span id="l7.383">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l7.384"></a><span id="l7.384">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-          return this.mSelected;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+            return this.mSelected;</span>
<a href="#l7.387"></a><span id="l7.387">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.388"></a><span id="l7.388">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-          this.mSelected = val;</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-          if (this.bgbox &amp;&amp; this.bgbox.hasChildNodes()) {</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-              let child = this.bgbox.firstChild;</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-              while (child) {</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-                  if (val) {</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-                      child.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-                  } else {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-                      child.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-                  }</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-                  child = child.nextSibling;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-              }</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-          }</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-          return val;</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+            this.mSelected = val;</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+            if (this.bgbox &amp;&amp; this.bgbox.hasChildNodes()) {</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+                let child = this.bgbox.firstChild;</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+                while (child) {</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+                    if (val) {</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+                        child.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+                    } else {</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+                        child.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+                    }</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+                    child = child.nextSibling;</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+                }</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+            }</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+            return val;</span>
<a href="#l7.415"></a><span id="l7.415">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.416"></a><span id="l7.416">       &lt;/property&gt;</span>
<a href="#l7.417"></a><span id="l7.417"> </span>
<a href="#l7.418"></a><span id="l7.418">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l7.419"></a><span id="l7.419">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-          return this.mDate;</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+            return this.mDate;</span>
<a href="#l7.422"></a><span id="l7.422">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.423"></a><span id="l7.423">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-          this.mDate = val;</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-          if (!cal.compareObjects(val.timezone, this.mTimezone)) {</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-              this.mTimezone = val.timezone;</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-              if (!this.mLayoutBatchCount) {</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-                  this.recalculateStartEndMinutes();</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-              }</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-          }</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-          return val;</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+            this.mDate = val;</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+            if (!cal.compareObjects(val.timezone, this.mTimezone)) {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+                this.mTimezone = val.timezone;</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+                if (!this.mLayoutBatchCount) {</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+                    this.recalculateStartEndMinutes();</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+                }</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+            }</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+            return val;</span>
<a href="#l7.444"></a><span id="l7.444">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.445"></a><span id="l7.445">       &lt;/property&gt;</span>
<a href="#l7.446"></a><span id="l7.446"> </span>
<a href="#l7.447"></a><span id="l7.447">       &lt;property name=&quot;calendarView&quot;</span>
<a href="#l7.448"></a><span id="l7.448">                 onget=&quot;return this.mCalendarView;&quot;</span>
<a href="#l7.449"></a><span id="l7.449">                 onset=&quot;return (this.mCalendarView = val);&quot; /&gt;</span>
<a href="#l7.450"></a><span id="l7.450"> </span>
<a href="#l7.451"></a><span id="l7.451">       &lt;property name=&quot;topbox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.452"></a><span id="l7.452">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;topbox&quot;);</span>
<a href="#l7.455"></a><span id="l7.455">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.456"></a><span id="l7.456">       &lt;/property&gt;</span>
<a href="#l7.457"></a><span id="l7.457"> </span>
<a href="#l7.458"></a><span id="l7.458">       &lt;property name=&quot;bgbox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.459"></a><span id="l7.459">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;bgbox&quot;);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;bgbox&quot;);</span>
<a href="#l7.462"></a><span id="l7.462">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.463"></a><span id="l7.463">       &lt;/property&gt;</span>
<a href="#l7.464"></a><span id="l7.464"> </span>
<a href="#l7.465"></a><span id="l7.465">       &lt;field name=&quot;mFgboxes&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.466"></a><span id="l7.466">       &lt;field name=&quot;mMinDuration&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.467"></a><span id="l7.467">       &lt;property name=&quot;fgboxes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.468"></a><span id="l7.468">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-          if (this.mFgboxes == null) {</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-              this.mFgboxes = {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-                  box: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgbox&quot;),</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-                  dragbox: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox&quot;),</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-                  dragspacer: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragspacer&quot;),</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-                  startlabel: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox-startlabel&quot;),</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-                  endlabel: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox-endlabel&quot;)</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-              };</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-          }</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-          return this.mFgboxes;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+            if (this.mFgboxes == null) {</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+                this.mFgboxes = {</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+                    box: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgbox&quot;),</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+                    dragbox: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox&quot;),</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+                    dragspacer: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragspacer&quot;),</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+                    startlabel: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox-startlabel&quot;),</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+                    endlabel: document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragbox-endlabel&quot;)</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+                };</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+            }</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+            return this.mFgboxes;</span>
<a href="#l7.489"></a><span id="l7.489">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.490"></a><span id="l7.490">       &lt;/property&gt;</span>
<a href="#l7.491"></a><span id="l7.491"> </span>
<a href="#l7.492"></a><span id="l7.492">       &lt;property name=&quot;timeIndicatorBox&quot;</span>
<a href="#l7.493"></a><span id="l7.493">         readonly=&quot;true&quot;&gt;</span>
<a href="#l7.494"></a><span id="l7.494">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timeIndicatorBox&quot;);</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timeIndicatorBox&quot;);</span>
<a href="#l7.497"></a><span id="l7.497">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.498"></a><span id="l7.498">       &lt;/property&gt;</span>
<a href="#l7.499"></a><span id="l7.499"> </span>
<a href="#l7.500"></a><span id="l7.500">       &lt;property name=&quot;events&quot; readonly=&quot;true&quot; onget=&quot;return this.methods&quot;/&gt;</span>
<a href="#l7.501"></a><span id="l7.501"> </span>
<a href="#l7.502"></a><span id="l7.502">       &lt;field name=&quot;mDayOff&quot;&gt;false&lt;/field&gt;</span>
<a href="#l7.503"></a><span id="l7.503">       &lt;property name=&quot;dayOff&quot;&gt;</span>
<a href="#l7.504"></a><span id="l7.504">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-          return this.mDayOff;</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+            return this.mDayOff;</span>
<a href="#l7.507"></a><span id="l7.507">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.508"></a><span id="l7.508">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-          this.mDayOff = val;</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-          return val;</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+            this.mDayOff = val;</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+            return val;</span>
<a href="#l7.513"></a><span id="l7.513">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.514"></a><span id="l7.514">       &lt;/property&gt;</span>
<a href="#l7.515"></a><span id="l7.515"> </span>
<a href="#l7.516"></a><span id="l7.516">       &lt;!-- mEventInfos --&gt;</span>
<a href="#l7.517"></a><span id="l7.517">       &lt;field name=&quot;mSelectedChunks&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l7.518"></a><span id="l7.518"> </span>
<a href="#l7.519"></a><span id="l7.519">       &lt;method name=&quot;selectOccurrence&quot;&gt;</span>
<a href="#l7.520"></a><span id="l7.520">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.521"></a><span id="l7.521">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-          if (aOccurrence) {</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-              this.mSelectedItemIds[aOccurrence.hashId] = true;</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-              let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-              if (!chunk) {</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-                  return;</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-              }</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-              chunk.selected = true;</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-              this.mSelectedChunks.push(chunk);</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-          }</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+            if (aOccurrence) {</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+                this.mSelectedItemIds[aOccurrence.hashId] = true;</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+                let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+                if (!chunk) {</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+                    return;</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+                }</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+                chunk.selected = true;</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+                this.mSelectedChunks.push(chunk);</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+            }</span>
<a href="#l7.540"></a><span id="l7.540">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.541"></a><span id="l7.541">       &lt;/method&gt;</span>
<a href="#l7.542"></a><span id="l7.542"> </span>
<a href="#l7.543"></a><span id="l7.543">       &lt;method name=&quot;unselectOccurrence&quot;&gt;</span>
<a href="#l7.544"></a><span id="l7.544">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.545"></a><span id="l7.545">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-          if (aOccurrence) {</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-              delete this.mSelectedItemIds[aOccurrence.hashId];</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-              let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-              if (!chunk) {</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineminus">-                  return;</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-              }</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-              chunk.selected = false;</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-              let index = this.mSelectedChunks.indexOf(chunk);</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-              this.mSelectedChunks.splice(index, 1);</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-          }</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+            if (aOccurrence) {</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+                delete this.mSelectedItemIds[aOccurrence.hashId];</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+                let chunk = this.findChunkForOccurrence(aOccurrence);</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+                if (!chunk) {</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+                    return;</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+                }</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+                chunk.selected = false;</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+                let index = this.mSelectedChunks.indexOf(chunk);</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+                this.mSelectedChunks.splice(index, 1);</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+            }</span>
<a href="#l7.566"></a><span id="l7.566">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.567"></a><span id="l7.567">       &lt;/method&gt;</span>
<a href="#l7.568"></a><span id="l7.568"> </span>
<a href="#l7.569"></a><span id="l7.569">       &lt;method name=&quot;findChunkForOccurrence&quot;&gt;</span>
<a href="#l7.570"></a><span id="l7.570">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.571"></a><span id="l7.571">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-          for (let chunk of this.mEventBoxes) {</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-              if (chunk.occurrence.hashId == aOccurrence.hashId) {</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-                  return chunk;</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-              }</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-          }</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-          return null;</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+            for (let chunk of this.mEventBoxes) {</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+                if (chunk.occurrence.hashId == aOccurrence.hashId) {</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+                    return chunk;</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+                }</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+            }</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+            return null;</span>
<a href="#l7.586"></a><span id="l7.586">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.587"></a><span id="l7.587">       &lt;/method&gt;</span>
<a href="#l7.588"></a><span id="l7.588"> </span>
<a href="#l7.589"></a><span id="l7.589">       &lt;method name=&quot;startLayoutBatchChange&quot;&gt;</span>
<a href="#l7.590"></a><span id="l7.590">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.591"></a><span id="l7.591">             this.mLayoutBatchCount++;</span>
<a href="#l7.592"></a><span id="l7.592">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.593"></a><span id="l7.593">       &lt;/method&gt;</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineat">@@ -457,1333 +457,1333 @@</span>
<a href="#l7.595"></a><span id="l7.595">             }</span>
<a href="#l7.596"></a><span id="l7.596">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.597"></a><span id="l7.597">       &lt;/method&gt;</span>
<a href="#l7.598"></a><span id="l7.598"> </span>
<a href="#l7.599"></a><span id="l7.599">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l7.600"></a><span id="l7.600">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l7.601"></a><span id="l7.601">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l7.602"></a><span id="l7.602">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-          if (aAttr == &quot;orient&quot; &amp;&amp; this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-              this.relayout();</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-          }</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-          return ret;</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+            if (aAttr == &quot;orient&quot; &amp;&amp; this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+                this.relayout();</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+            }</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+            return ret;</span>
<a href="#l7.619"></a><span id="l7.619">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.620"></a><span id="l7.620">       &lt;/method&gt;</span>
<a href="#l7.621"></a><span id="l7.621"> </span>
<a href="#l7.622"></a><span id="l7.622">       &lt;method name=&quot;internalDeleteEvent&quot;&gt;</span>
<a href="#l7.623"></a><span id="l7.623">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.624"></a><span id="l7.624">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-          let itemIndex = -1;</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-          let occ;</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineminus">-          for (let i in this.mEventInfos) {</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-              occ = this.mEventInfos[i].event;</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-              if (occ.hashId == aOccurrence.hashId) {</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-                  itemIndex = i;</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-                  break;</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-              }</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">-          }</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-          if (itemIndex == -1) {</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-              return false;</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-          } else {</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-              delete this.mSelectedItemIds[occ.hashId];</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-              this.mSelectedChunks = this.mSelectedChunks.filter((item) =&gt; {</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-                  return !item.occurrence || (item.occurrence.hashId != aOccurrence.hashId);</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-              });</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-              this.mEventInfos.splice(itemIndex, 1);</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-              return true;</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-          }</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+            let itemIndex = -1;</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineplus">+            let occ;</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineplus">+            for (let i in this.mEventInfos) {</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+                occ = this.mEventInfos[i].event;</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+                if (occ.hashId == aOccurrence.hashId) {</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+                    itemIndex = i;</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+                    break;</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineplus">+                }</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+            }</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+            if (itemIndex == -1) {</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+                return false;</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+            } else {</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineplus">+                delete this.mSelectedItemIds[occ.hashId];</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineplus">+                this.mSelectedChunks = this.mSelectedChunks.filter((item) =&gt; {</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+                    return !item.occurrence || (item.occurrence.hashId != aOccurrence.hashId);</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineplus">+                });</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+                this.mEventInfos.splice(itemIndex, 1);</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+                return true;</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+            }</span>
<a href="#l7.665"></a><span id="l7.665">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.666"></a><span id="l7.666">       &lt;/method&gt;</span>
<a href="#l7.667"></a><span id="l7.667"> </span>
<a href="#l7.668"></a><span id="l7.668">       &lt;method name=&quot;recalculateStartEndMinutes&quot;&gt;</span>
<a href="#l7.669"></a><span id="l7.669">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-          for (let chunk of this.mEventInfos) {</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-              let mins = this.getStartEndMinutesForOccurrence(chunk.event);</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineminus">-              chunk.startMinute = mins.start;</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineminus">-              chunk.endMinute = mins.end;</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-          }</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineminus">-</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineminus">-          this.relayout();</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+            for (let chunk of this.mEventInfos) {</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+                let mins = this.getStartEndMinutesForOccurrence(chunk.event);</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+                chunk.startMinute = mins.start;</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+                chunk.endMinute = mins.end;</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+            }</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+            this.relayout();</span>
<a href="#l7.684"></a><span id="l7.684">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.685"></a><span id="l7.685">       &lt;/method&gt;</span>
<a href="#l7.686"></a><span id="l7.686"> </span>
<a href="#l7.687"></a><span id="l7.687">       &lt;!-- This function returns the start and end minutes of the occurrence</span>
<a href="#l7.688"></a><span id="l7.688">            part in the day of this column, moreover, the real start and end</span>
<a href="#l7.689"></a><span id="l7.689">            minutes of the whole occurrence (which could span multiple days)</span>
<a href="#l7.690"></a><span id="l7.690">            relative to the time 0:00 of the day in this column --&gt;</span>
<a href="#l7.691"></a><span id="l7.691">       &lt;method name=&quot;getStartEndMinutesForOccurrence&quot;&gt;</span>
<a href="#l7.692"></a><span id="l7.692">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.693"></a><span id="l7.693">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-          let stdate = aOccurrence.startDate || aOccurrence.entryDate || aOccurrence.dueDate;</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineminus">-          let enddate = aOccurrence.endDate || aOccurrence.dueDate || aOccurrence.entryDate;</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineminus">-</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineminus">-          if (!cal.compareObjects(stdate.timezone, this.mTimezone)) {</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineminus">-              stdate = stdate.getInTimezone(this.mTimezone);</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineminus">-          }</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineminus">-</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-          if (!cal.compareObjects(enddate.timezone, this.mTimezone)) {</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-              enddate = enddate.getInTimezone(this.mTimezone);</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineminus">-          }</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineminus">-</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineminus">-          let startHour = stdate.hour;</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-          let startMinute = stdate.minute;</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-          let endHour = enddate.hour;</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-          let endMinute = enddate.minute;</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-          // Handle cases where an event begins or ends on a day other than this</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-          if (stdate.compare(this.mDate) == -1) {</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineminus">-              startHour = 0;</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineminus">-              startMinute = 0;</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-          }</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-          if (enddate.compare(this.mDate) == 1) {</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-              endHour = 24;</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-              endMinute = 0;</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-          }</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-          // For occurrences that span multiple days, we figure out the real</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineminus">-          // occurrence start and end minutes relative to the date of this</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-          // column and time 0:00</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineminus">-          let durend = enddate.subtractDate(this.mDate);</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineminus">-          let durstart = stdate.subtractDate(this.mDate);</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineminus">-          // 'durend' is always positive, instead 'durstart' might be negative</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineminus">-          // if the event starts one or more days before the date of this column</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-          let realStart_ = (durstart.days * 24 + durstart.hours) * 60 + durstart.minutes;</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineminus">-          realStart_ = durstart.isNegative ? -1 * realStart_ : realStart_;</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineminus">-          let realEnd_ = (durend.days * 24 + durend.hours) * 60 + durend.minutes;</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineminus">-</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineminus">-          return {</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineminus">-              start: startHour * 60 + startMinute,</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-              end: endHour * 60 + endMinute,</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-              realStart: realStart_,</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-              realEnd: realEnd_</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineminus">-          };</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+            let stdate = aOccurrence.startDate || aOccurrence.entryDate || aOccurrence.dueDate;</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+            let enddate = aOccurrence.endDate || aOccurrence.dueDate || aOccurrence.entryDate;</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+            if (!cal.compareObjects(stdate.timezone, this.mTimezone)) {</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+                stdate = stdate.getInTimezone(this.mTimezone);</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+            }</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+            if (!cal.compareObjects(enddate.timezone, this.mTimezone)) {</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+                enddate = enddate.getInTimezone(this.mTimezone);</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+            }</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+            let startHour = stdate.hour;</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+            let startMinute = stdate.minute;</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+            let endHour = enddate.hour;</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+            let endMinute = enddate.minute;</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+            // Handle cases where an event begins or ends on a day other than this</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+            if (stdate.compare(this.mDate) == -1) {</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+                startHour = 0;</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+                startMinute = 0;</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+            }</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+            if (enddate.compare(this.mDate) == 1) {</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+                endHour = 24;</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+                endMinute = 0;</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+            }</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+            // For occurrences that span multiple days, we figure out the real</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+            // occurrence start and end minutes relative to the date of this</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+            // column and time 0:00</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+            let durend = enddate.subtractDate(this.mDate);</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+            let durstart = stdate.subtractDate(this.mDate);</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+            // 'durend' is always positive, instead 'durstart' might be negative</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+            // if the event starts one or more days before the date of this column</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+            let realStart_ = (durstart.days * 24 + durstart.hours) * 60 + durstart.minutes;</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+            realStart_ = durstart.isNegative ? -1 * realStart_ : realStart_;</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+            let realEnd_ = (durend.days * 24 + durend.hours) * 60 + durend.minutes;</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+            return {</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+                start: startHour * 60 + startMinute,</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+                end: endHour * 60 + endMinute,</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineplus">+                realStart: realStart_,</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+                realEnd: realEnd_</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineplus">+            };</span>
<a href="#l7.780"></a><span id="l7.780">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.781"></a><span id="l7.781">       &lt;/method&gt;</span>
<a href="#l7.782"></a><span id="l7.782"> </span>
<a href="#l7.783"></a><span id="l7.783">       &lt;method name=&quot;createChunk&quot;&gt;</span>
<a href="#l7.784"></a><span id="l7.784">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.785"></a><span id="l7.785">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineminus">-          let mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineminus">-</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineminus">-          let chunk = {</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineminus">-              startMinute: mins.start,</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineminus">-              endMinute: mins.end,</span>
<a href="#l7.791"></a><span id="l7.791" class="difflineminus">-              event: aOccurrence</span>
<a href="#l7.792"></a><span id="l7.792" class="difflineminus">-          };</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineminus">-          return chunk;</span>
<a href="#l7.794"></a><span id="l7.794" class="difflineplus">+            let mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineplus">+</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineplus">+            let chunk = {</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineplus">+                startMinute: mins.start,</span>
<a href="#l7.798"></a><span id="l7.798" class="difflineplus">+                endMinute: mins.end,</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineplus">+                event: aOccurrence</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineplus">+            };</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineplus">+            return chunk;</span>
<a href="#l7.802"></a><span id="l7.802">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.803"></a><span id="l7.803">       &lt;/method&gt;</span>
<a href="#l7.804"></a><span id="l7.804"> </span>
<a href="#l7.805"></a><span id="l7.805">       &lt;method name=&quot;addEvent&quot;&gt;</span>
<a href="#l7.806"></a><span id="l7.806">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.807"></a><span id="l7.807">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineminus">-          this.internalDeleteEvent(aOccurrence);</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineminus">-</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineminus">-          let chunk = this.createChunk(aOccurrence);</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineminus">-          this.mEventInfos.push(chunk);</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineminus">-          if (this.mEventMapTimeout) {</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineminus">-              clearTimeout(this.mEventMapTimeout);</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineminus">-          }</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineminus">-</span>
<a href="#l7.816"></a><span id="l7.816" class="difflineminus">-          if (this.mCreatedNewEvent) {</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineminus">-              this.mEventToEdit = aOccurrence;</span>
<a href="#l7.818"></a><span id="l7.818" class="difflineminus">-          }</span>
<a href="#l7.819"></a><span id="l7.819" class="difflineminus">-</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineminus">-          this.mEventMapTimeout = setTimeout(() =&gt; this.relayout(), 5);</span>
<a href="#l7.821"></a><span id="l7.821" class="difflineplus">+            this.internalDeleteEvent(aOccurrence);</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineplus">+</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineplus">+            let chunk = this.createChunk(aOccurrence);</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineplus">+            this.mEventInfos.push(chunk);</span>
<a href="#l7.825"></a><span id="l7.825" class="difflineplus">+            if (this.mEventMapTimeout) {</span>
<a href="#l7.826"></a><span id="l7.826" class="difflineplus">+                clearTimeout(this.mEventMapTimeout);</span>
<a href="#l7.827"></a><span id="l7.827" class="difflineplus">+            }</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineplus">+</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineplus">+            if (this.mCreatedNewEvent) {</span>
<a href="#l7.830"></a><span id="l7.830" class="difflineplus">+                this.mEventToEdit = aOccurrence;</span>
<a href="#l7.831"></a><span id="l7.831" class="difflineplus">+            }</span>
<a href="#l7.832"></a><span id="l7.832" class="difflineplus">+</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineplus">+            this.mEventMapTimeout = setTimeout(() =&gt; this.relayout(), 5);</span>
<a href="#l7.834"></a><span id="l7.834">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.835"></a><span id="l7.835">       &lt;/method&gt;</span>
<a href="#l7.836"></a><span id="l7.836"> </span>
<a href="#l7.837"></a><span id="l7.837">       &lt;method name=&quot;deleteEvent&quot;&gt;</span>
<a href="#l7.838"></a><span id="l7.838">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.839"></a><span id="l7.839">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.840"></a><span id="l7.840" class="difflineminus">-          if (this.internalDeleteEvent(aOccurrence)) {</span>
<a href="#l7.841"></a><span id="l7.841" class="difflineminus">-              this.relayout();</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineminus">-          }</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineplus">+            if (this.internalDeleteEvent(aOccurrence)) {</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineplus">+                this.relayout();</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineplus">+            }</span>
<a href="#l7.846"></a><span id="l7.846">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.847"></a><span id="l7.847">       &lt;/method&gt;</span>
<a href="#l7.848"></a><span id="l7.848"> </span>
<a href="#l7.849"></a><span id="l7.849">       &lt;method name=&quot;clear&quot;&gt;</span>
<a href="#l7.850"></a><span id="l7.850">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.851"></a><span id="l7.851" class="difflineminus">-          while (this.bgbox &amp;&amp; this.bgbox.hasChildNodes()) {</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-              this.bgbox.lastChild.remove();</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineminus">-          }</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineminus">-          while (this.topbox &amp;&amp; this.topbox.hasChildNodes()) {</span>
<a href="#l7.855"></a><span id="l7.855" class="difflineminus">-              this.topbox.lastChild.remove();</span>
<a href="#l7.856"></a><span id="l7.856" class="difflineminus">-          }</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineminus">-          for (let handler of this.mHandlersToRemove) {</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineminus">-              this.calendarView.viewBroadcaster.removeEventListener(this.calendarView.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, handler, true);</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineminus">-          }</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineminus">-          this.mHandlersToRemove = [];</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineminus">-          this.mSelectedChunks = [];</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineplus">+            while (this.bgbox &amp;&amp; this.bgbox.hasChildNodes()) {</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineplus">+                this.bgbox.lastChild.remove();</span>
<a href="#l7.864"></a><span id="l7.864" class="difflineplus">+            }</span>
<a href="#l7.865"></a><span id="l7.865" class="difflineplus">+            while (this.topbox &amp;&amp; this.topbox.hasChildNodes()) {</span>
<a href="#l7.866"></a><span id="l7.866" class="difflineplus">+                this.topbox.lastChild.remove();</span>
<a href="#l7.867"></a><span id="l7.867" class="difflineplus">+            }</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineplus">+            for (let handler of this.mHandlersToRemove) {</span>
<a href="#l7.869"></a><span id="l7.869" class="difflineplus">+                this.calendarView.viewBroadcaster.removeEventListener(this.calendarView.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, handler, true);</span>
<a href="#l7.870"></a><span id="l7.870" class="difflineplus">+            }</span>
<a href="#l7.871"></a><span id="l7.871" class="difflineplus">+            this.mHandlersToRemove = [];</span>
<a href="#l7.872"></a><span id="l7.872" class="difflineplus">+            this.mSelectedChunks = [];</span>
<a href="#l7.873"></a><span id="l7.873">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.874"></a><span id="l7.874">       &lt;/method&gt;</span>
<a href="#l7.875"></a><span id="l7.875"> </span>
<a href="#l7.876"></a><span id="l7.876">       &lt;method name=&quot;relayout&quot;&gt;</span>
<a href="#l7.877"></a><span id="l7.877">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineminus">-          if (this.mLayoutBatchCount &gt; 0) {</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineminus">-              return;</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineminus">-          }</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineminus">-          this.clear();</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineminus">-</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineminus">-          let orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineminus">-          this.bgbox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.885"></a><span id="l7.885" class="difflineminus">-</span>
<a href="#l7.886"></a><span id="l7.886" class="difflineminus">-          // bgbox is used mainly for drawing the grid.  at some point it may</span>
<a href="#l7.887"></a><span id="l7.887" class="difflineminus">-          // also be used for all-day events.</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineminus">-          let otherorient = getOtherOrientation(orient);</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineminus">-          let configBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;config-box&quot;);</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineminus">-          configBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineminus">-          let minSize = configBox.getOptimalMinSize();</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineminus">-          configBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.893"></a><span id="l7.893" class="difflineminus">-          this.mMinDuration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineminus">-                                            .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineminus">-          this.mMinDuration.minutes = Math.trunc(minSize / this.mPixPerMin);</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineminus">-</span>
<a href="#l7.897"></a><span id="l7.897" class="difflineminus">-          let theMin = this.mStartMin;</span>
<a href="#l7.898"></a><span id="l7.898" class="difflineminus">-          while (theMin &lt; this.mEndMin) {</span>
<a href="#l7.899"></a><span id="l7.899" class="difflineminus">-              let dur = theMin % 60;</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineminus">-              theMin += dur;</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineminus">-              if (dur == 0) {</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineminus">-                  dur = 60;</span>
<a href="#l7.903"></a><span id="l7.903" class="difflineminus">-              }</span>
<a href="#l7.904"></a><span id="l7.904" class="difflineminus">-</span>
<a href="#l7.905"></a><span id="l7.905" class="difflineminus">-              let box = createXULElement(&quot;spacer&quot;);</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineminus">-              // we key off this in a CSS selector</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineminus">-              box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineminus">-              box.setAttribute(&quot;class&quot;, &quot;calendar-event-column-linebox&quot;);</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineminus">-</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineminus">-              if (this.mSelected) {</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineminus">-                  box.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineminus">-              }</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineminus">-              if (this.mDayOff) {</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineminus">-                  box.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l7.915"></a><span id="l7.915" class="difflineminus">-              }</span>
<a href="#l7.916"></a><span id="l7.916" class="difflineminus">-              if (theMin &lt; this.mDayStartMin || theMin &gt;= this.mDayEndMin) {</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineminus">-                  box.setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineminus">-              }</span>
<a href="#l7.919"></a><span id="l7.919" class="difflineminus">-</span>
<a href="#l7.920"></a><span id="l7.920" class="difflineminus">-              // Carry forth the day relation</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineminus">-              box.setAttribute(&quot;relation&quot;, this.getAttribute(&quot;relation&quot;));</span>
<a href="#l7.922"></a><span id="l7.922" class="difflineminus">-</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineminus">-              // calculate duration pixel as the difference between</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineminus">-              // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l7.925"></a><span id="l7.925" class="difflineminus">-              let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineminus">-              let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l7.927"></a><span id="l7.927" class="difflineminus">-              let durPix = endPix - startPix;</span>
<a href="#l7.928"></a><span id="l7.928" class="difflineminus">-              if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.929"></a><span id="l7.929" class="difflineminus">-                  box.setAttribute(&quot;height&quot;, durPix);</span>
<a href="#l7.930"></a><span id="l7.930" class="difflineminus">-              } else {</span>
<a href="#l7.931"></a><span id="l7.931" class="difflineminus">-                  box.setAttribute(&quot;width&quot;, durPix);</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineminus">-              }</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineminus">-</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineminus">-              box.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineminus">-              this.bgbox.appendChild(box);</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineminus">-              theMin += 60;</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineminus">-          }</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineminus">-</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineminus">-          // fgbox is used for dragging events</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineminus">-          this.fgboxes.box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineminus">-          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragspacer&quot;).setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineminus">-</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineminus">-          // this one is set to otherorient, since it will contain</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineminus">-          // child boxes set to &quot;orient&quot; (one for each set of</span>
<a href="#l7.946"></a><span id="l7.946" class="difflineminus">-          // overlapping event areas)</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineminus">-          this.topbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineminus">-</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineminus">-          this.mEventMap = this.computeEventMap();</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineminus">-          this.mEventBoxes = [];</span>
<a href="#l7.951"></a><span id="l7.951" class="difflineminus">-</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineminus">-          if (!this.mEventMap.length) {</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineminus">-              return;</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineminus">-          }</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineminus">-</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineminus">-          // First of all we create a xul:stack which</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineminus">-          // will hold all events for this event column.</span>
<a href="#l7.958"></a><span id="l7.958" class="difflineminus">-          // The stack will be grouped below .../calendar-event-column/stack/topbox.</span>
<a href="#l7.959"></a><span id="l7.959" class="difflineminus">-          let stack = createXULElement(&quot;stack&quot;);</span>
<a href="#l7.960"></a><span id="l7.960" class="difflineminus">-          stack.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.961"></a><span id="l7.961" class="difflineminus">-          this.topbox.appendChild(stack);</span>
<a href="#l7.962"></a><span id="l7.962" class="difflineminus">-</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineminus">-          let boxToEdit;</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineminus">-          let columnCount = 1;</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineminus">-          let spanTotal = 0;</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineminus">-</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineminus">-          for (let layer of this.mEventMap) {</span>
<a href="#l7.968"></a><span id="l7.968" class="difflineminus">-              // The event-map (this.mEventMap) contains an array of layers.</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineminus">-              // For each layer we create a box below the stack just created above.</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineminus">-              // So each different layer lives in a box that's contained in the stack.</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineminus">-              let xulColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineminus">-              xulColumn.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineminus">-              xulColumn.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineminus">-              xulColumn.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineminus">-              stack.appendChild(xulColumn);</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineminus">-</span>
<a href="#l7.977"></a><span id="l7.977" class="difflineminus">-              let numBlocksInserted = 0;</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineminus">-</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineminus">-              // column count determined by layer with no special span columns</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineminus">-              if (layer.every(e =&gt; !e.specialSpan)) {</span>
<a href="#l7.981"></a><span id="l7.981" class="difflineminus">-                  columnCount = layer.length;</span>
<a href="#l7.982"></a><span id="l7.982" class="difflineminus">-              }</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineminus">-              spanTotal = 0;</span>
<a href="#l7.984"></a><span id="l7.984" class="difflineminus">-</span>
<a href="#l7.985"></a><span id="l7.985" class="difflineminus">-              // Each layer contains a list of the columns that</span>
<a href="#l7.986"></a><span id="l7.986" class="difflineminus">-              // need to be created for a span.</span>
<a href="#l7.987"></a><span id="l7.987" class="difflineminus">-              for (let column of layer) {</span>
<a href="#l7.988"></a><span id="l7.988" class="difflineminus">-                  let innerColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.989"></a><span id="l7.989" class="difflineminus">-                  innerColumn.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.990"></a><span id="l7.990" class="difflineminus">-</span>
<a href="#l7.991"></a><span id="l7.991" class="difflineminus">-                  let colFlex = column.specialSpan ? columnCount * column.specialSpan : 1;</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineminus">-                  innerColumn.setAttribute(&quot;flex&quot;, colFlex);</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineminus">-                  spanTotal += colFlex;</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineminus">-</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineminus">-                  innerColumn.style.minWidth = &quot;1px&quot;;</span>
<a href="#l7.996"></a><span id="l7.996" class="difflineminus">-                  innerColumn.style.minHeight = &quot;1px&quot;;</span>
<a href="#l7.997"></a><span id="l7.997" class="difflineminus">-                  innerColumn.style.width = colFlex + &quot;px&quot;;</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineminus">-                  innerColumn.style.height = colFlex + &quot;px&quot;;</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineminus">-</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineminus">-                  xulColumn.appendChild(innerColumn);</span>
<a href="#l7.1001"></a><span id="l7.1001" class="difflineminus">-                  let duration;</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineminus">-                  for (let chunk of column) {</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineminus">-                      duration = chunk.duration;</span>
<a href="#l7.1004"></a><span id="l7.1004" class="difflineminus">-                      if (!duration) {</span>
<a href="#l7.1005"></a><span id="l7.1005" class="difflineminus">-                          continue;</span>
<a href="#l7.1006"></a><span id="l7.1006" class="difflineminus">-                      }</span>
<a href="#l7.1007"></a><span id="l7.1007" class="difflineminus">-</span>
<a href="#l7.1008"></a><span id="l7.1008" class="difflineminus">-                      if (chunk.event) {</span>
<a href="#l7.1009"></a><span id="l7.1009" class="difflineminus">-                          let chunkBox = createXULElement(&quot;calendar-event-box&quot;);</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineminus">-                          let durMinutes = duration.inSeconds / 60;</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineminus">-                          let size = Math.max(durMinutes * this.mPixPerMin, minSize);</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineminus">-                          if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineminus">-                              chunkBox.setAttribute(&quot;height&quot;, size);</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineminus">-                          } else {</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineminus">-                              chunkBox.setAttribute(&quot;width&quot;, size);</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineminus">-                          }</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineminus">-                          chunkBox.setAttribute(&quot;context&quot;,</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineminus">-                                                this.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineminus">-                                                  this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineminus">-                          chunkBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineminus">-</span>
<a href="#l7.1022"></a><span id="l7.1022" class="difflineminus">-                          // Set the gripBars visibility in the chunk. Keep it</span>
<a href="#l7.1023"></a><span id="l7.1023" class="difflineminus">-                          // hidden for tasks with only entry date OR due date.</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineminus">-                          if ((chunk.event.entryDate || !chunk.event.dueDate) &amp;&amp;</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineminus">-                              (!chunk.event.entryDate || chunk.event.dueDate)) {</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineminus">-                              let startGripVisible = (chunk.event.startDate || chunk.event.entryDate)</span>
<a href="#l7.1027"></a><span id="l7.1027" class="difflineminus">-                                                         .compare(chunk.startDate) == 0;</span>
<a href="#l7.1028"></a><span id="l7.1028" class="difflineminus">-                              let endGripVisible = (chunk.event.endDate || chunk.event.dueDate)</span>
<a href="#l7.1029"></a><span id="l7.1029" class="difflineminus">-                                                       .compare(chunk.endDate) &lt;= 0;</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineminus">-                              if (startGripVisible &amp;&amp; endGripVisible) {</span>
<a href="#l7.1031"></a><span id="l7.1031" class="difflineminus">-                                  chunkBox.setAttribute(&quot;gripBars&quot;, &quot;both&quot;);</span>
<a href="#l7.1032"></a><span id="l7.1032" class="difflineminus">-                              } else if (endGripVisible) {</span>
<a href="#l7.1033"></a><span id="l7.1033" class="difflineminus">-                                  chunkBox.setAttribute(&quot;gripBars&quot;, &quot;end&quot;);</span>
<a href="#l7.1034"></a><span id="l7.1034" class="difflineminus">-                              } else if (startGripVisible) {</span>
<a href="#l7.1035"></a><span id="l7.1035" class="difflineminus">-                                  chunkBox.setAttribute(&quot;gripBars&quot;, &quot;start&quot;);</span>
<a href="#l7.1036"></a><span id="l7.1036" class="difflineminus">-                              }</span>
<a href="#l7.1037"></a><span id="l7.1037" class="difflineminus">-                          }</span>
<a href="#l7.1038"></a><span id="l7.1038" class="difflineminus">-</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineminus">-                          innerColumn.appendChild(chunkBox);</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineminus">-                          chunkBox.calendarView = this.calendarView;</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineminus">-                          chunkBox.occurrence = chunk.event;</span>
<a href="#l7.1042"></a><span id="l7.1042" class="difflineminus">-                          chunkBox.parentColumn = this;</span>
<a href="#l7.1043"></a><span id="l7.1043" class="difflineminus">-                          if (chunk.event.hashId in this.mSelectedItemIds) {</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineminus">-                              chunkBox.selected = true;</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineminus">-                              this.mSelectedChunks.push(chunkBox);</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineminus">-                          }</span>
<a href="#l7.1047"></a><span id="l7.1047" class="difflineminus">-</span>
<a href="#l7.1048"></a><span id="l7.1048" class="difflineminus">-                          this.mEventBoxes.push(chunkBox);</span>
<a href="#l7.1049"></a><span id="l7.1049" class="difflineminus">-</span>
<a href="#l7.1050"></a><span id="l7.1050" class="difflineminus">-                          if (this.mEventToEdit &amp;&amp;</span>
<a href="#l7.1051"></a><span id="l7.1051" class="difflineminus">-                              chunkBox.occurrence.hashId == this.mEventToEdit.hashId) {</span>
<a href="#l7.1052"></a><span id="l7.1052" class="difflineminus">-                              boxToEdit = chunkBox;</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineminus">-                          }</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineminus">-                      } else {</span>
<a href="#l7.1055"></a><span id="l7.1055" class="difflineminus">-                          let chunkBox = createXULElement(&quot;spacer&quot;);</span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineminus">-                          chunkBox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineminus">-                          chunkBox.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineminus">-                          chunkBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1059"></a><span id="l7.1059" class="difflineminus">-                          chunkBox.setAttribute(&quot;class&quot;, &quot;calendar-empty-space-box&quot;);</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineminus">-                          innerColumn.appendChild(chunkBox);</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineminus">-</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineminus">-                          let durMinutes = duration.inSeconds / 60;</span>
<a href="#l7.1063"></a><span id="l7.1063" class="difflineminus">-                          if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.1064"></a><span id="l7.1064" class="difflineminus">-                              chunkBox.setAttribute(&quot;height&quot;, durMinutes * this.mPixPerMin);</span>
<a href="#l7.1065"></a><span id="l7.1065" class="difflineminus">-                          } else {</span>
<a href="#l7.1066"></a><span id="l7.1066" class="difflineminus">-                              chunkBox.setAttribute(&quot;width&quot;, durMinutes * this.mPixPerMin);</span>
<a href="#l7.1067"></a><span id="l7.1067" class="difflineminus">-                          }</span>
<a href="#l7.1068"></a><span id="l7.1068" class="difflineminus">-                      }</span>
<a href="#l7.1069"></a><span id="l7.1069" class="difflineminus">-                  }</span>
<a href="#l7.1070"></a><span id="l7.1070" class="difflineminus">-</span>
<a href="#l7.1071"></a><span id="l7.1071" class="difflineminus">-                  numBlocksInserted++;</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineminus">-              }</span>
<a href="#l7.1073"></a><span id="l7.1073" class="difflineminus">-</span>
<a href="#l7.1074"></a><span id="l7.1074" class="difflineminus">-              // add last empty column if necessary</span>
<a href="#l7.1075"></a><span id="l7.1075" class="difflineminus">-              if (spanTotal &lt; columnCount) {</span>
<a href="#l7.1076"></a><span id="l7.1076" class="difflineminus">-                  let lastColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.1077"></a><span id="l7.1077" class="difflineminus">-                  lastColumn.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1078"></a><span id="l7.1078" class="difflineminus">-                  lastColumn.setAttribute(&quot;flex&quot;, columnCount - spanTotal);</span>
<a href="#l7.1079"></a><span id="l7.1079" class="difflineminus">-                  lastColumn.style.minWidth = &quot;1px&quot;;</span>
<a href="#l7.1080"></a><span id="l7.1080" class="difflineminus">-                  lastColumn.style.minHeight = &quot;1px&quot;;</span>
<a href="#l7.1081"></a><span id="l7.1081" class="difflineminus">-                  lastColumn.style.width = (columnCount - spanTotal) + &quot;px&quot;;</span>
<a href="#l7.1082"></a><span id="l7.1082" class="difflineminus">-                  lastColumn.style.height = (columnCount - spanTotal) + &quot;px&quot;;</span>
<a href="#l7.1083"></a><span id="l7.1083" class="difflineminus">-</span>
<a href="#l7.1084"></a><span id="l7.1084" class="difflineminus">-                  xulColumn.appendChild(lastColumn);</span>
<a href="#l7.1085"></a><span id="l7.1085" class="difflineminus">-              }</span>
<a href="#l7.1086"></a><span id="l7.1086" class="difflineminus">-</span>
<a href="#l7.1087"></a><span id="l7.1087" class="difflineminus">-              if (boxToEdit) {</span>
<a href="#l7.1088"></a><span id="l7.1088" class="difflineminus">-                  this.mCreatedNewEvent = false;</span>
<a href="#l7.1089"></a><span id="l7.1089" class="difflineminus">-                  this.mEventToEdit = null;</span>
<a href="#l7.1090"></a><span id="l7.1090" class="difflineminus">-                  boxToEdit.startEditing();</span>
<a href="#l7.1091"></a><span id="l7.1091" class="difflineminus">-              }</span>
<a href="#l7.1092"></a><span id="l7.1092" class="difflineminus">-</span>
<a href="#l7.1093"></a><span id="l7.1093" class="difflineminus">-              if (numBlocksInserted == 0) {</span>
<a href="#l7.1094"></a><span id="l7.1094" class="difflineminus">-                  // if we didn't insert any blocks, then</span>
<a href="#l7.1095"></a><span id="l7.1095" class="difflineminus">-                  // forget about this column</span>
<a href="#l7.1096"></a><span id="l7.1096" class="difflineminus">-                  xulColumn.remove();</span>
<a href="#l7.1097"></a><span id="l7.1097" class="difflineminus">-              }</span>
<a href="#l7.1098"></a><span id="l7.1098" class="difflineminus">-          }</span>
<a href="#l7.1099"></a><span id="l7.1099" class="difflineplus">+            if (this.mLayoutBatchCount &gt; 0) {</span>
<a href="#l7.1100"></a><span id="l7.1100" class="difflineplus">+                return;</span>
<a href="#l7.1101"></a><span id="l7.1101" class="difflineplus">+            }</span>
<a href="#l7.1102"></a><span id="l7.1102" class="difflineplus">+            this.clear();</span>
<a href="#l7.1103"></a><span id="l7.1103" class="difflineplus">+</span>
<a href="#l7.1104"></a><span id="l7.1104" class="difflineplus">+            let orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.1105"></a><span id="l7.1105" class="difflineplus">+            this.bgbox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1106"></a><span id="l7.1106" class="difflineplus">+</span>
<a href="#l7.1107"></a><span id="l7.1107" class="difflineplus">+            // bgbox is used mainly for drawing the grid.  at some point it may</span>
<a href="#l7.1108"></a><span id="l7.1108" class="difflineplus">+            // also be used for all-day events.</span>
<a href="#l7.1109"></a><span id="l7.1109" class="difflineplus">+            let otherorient = getOtherOrientation(orient);</span>
<a href="#l7.1110"></a><span id="l7.1110" class="difflineplus">+            let configBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;config-box&quot;);</span>
<a href="#l7.1111"></a><span id="l7.1111" class="difflineplus">+            configBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l7.1112"></a><span id="l7.1112" class="difflineplus">+            let minSize = configBox.getOptimalMinSize();</span>
<a href="#l7.1113"></a><span id="l7.1113" class="difflineplus">+            configBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.1114"></a><span id="l7.1114" class="difflineplus">+            this.mMinDuration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l7.1115"></a><span id="l7.1115" class="difflineplus">+                                              .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l7.1116"></a><span id="l7.1116" class="difflineplus">+            this.mMinDuration.minutes = Math.trunc(minSize / this.mPixPerMin);</span>
<a href="#l7.1117"></a><span id="l7.1117" class="difflineplus">+</span>
<a href="#l7.1118"></a><span id="l7.1118" class="difflineplus">+            let theMin = this.mStartMin;</span>
<a href="#l7.1119"></a><span id="l7.1119" class="difflineplus">+            while (theMin &lt; this.mEndMin) {</span>
<a href="#l7.1120"></a><span id="l7.1120" class="difflineplus">+                let dur = theMin % 60;</span>
<a href="#l7.1121"></a><span id="l7.1121" class="difflineplus">+                theMin += dur;</span>
<a href="#l7.1122"></a><span id="l7.1122" class="difflineplus">+                if (dur == 0) {</span>
<a href="#l7.1123"></a><span id="l7.1123" class="difflineplus">+                    dur = 60;</span>
<a href="#l7.1124"></a><span id="l7.1124" class="difflineplus">+                }</span>
<a href="#l7.1125"></a><span id="l7.1125" class="difflineplus">+</span>
<a href="#l7.1126"></a><span id="l7.1126" class="difflineplus">+                let box = createXULElement(&quot;spacer&quot;);</span>
<a href="#l7.1127"></a><span id="l7.1127" class="difflineplus">+                // we key off this in a CSS selector</span>
<a href="#l7.1128"></a><span id="l7.1128" class="difflineplus">+                box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1129"></a><span id="l7.1129" class="difflineplus">+                box.setAttribute(&quot;class&quot;, &quot;calendar-event-column-linebox&quot;);</span>
<a href="#l7.1130"></a><span id="l7.1130" class="difflineplus">+</span>
<a href="#l7.1131"></a><span id="l7.1131" class="difflineplus">+                if (this.mSelected) {</span>
<a href="#l7.1132"></a><span id="l7.1132" class="difflineplus">+                    box.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.1133"></a><span id="l7.1133" class="difflineplus">+                }</span>
<a href="#l7.1134"></a><span id="l7.1134" class="difflineplus">+                if (this.mDayOff) {</span>
<a href="#l7.1135"></a><span id="l7.1135" class="difflineplus">+                    box.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l7.1136"></a><span id="l7.1136" class="difflineplus">+                }</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineplus">+                if (theMin &lt; this.mDayStartMin || theMin &gt;= this.mDayEndMin) {</span>
<a href="#l7.1138"></a><span id="l7.1138" class="difflineplus">+                    box.setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l7.1139"></a><span id="l7.1139" class="difflineplus">+                }</span>
<a href="#l7.1140"></a><span id="l7.1140" class="difflineplus">+</span>
<a href="#l7.1141"></a><span id="l7.1141" class="difflineplus">+                // Carry forth the day relation</span>
<a href="#l7.1142"></a><span id="l7.1142" class="difflineplus">+                box.setAttribute(&quot;relation&quot;, this.getAttribute(&quot;relation&quot;));</span>
<a href="#l7.1143"></a><span id="l7.1143" class="difflineplus">+</span>
<a href="#l7.1144"></a><span id="l7.1144" class="difflineplus">+                // calculate duration pixel as the difference between</span>
<a href="#l7.1145"></a><span id="l7.1145" class="difflineplus">+                // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l7.1146"></a><span id="l7.1146" class="difflineplus">+                let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l7.1147"></a><span id="l7.1147" class="difflineplus">+                let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l7.1148"></a><span id="l7.1148" class="difflineplus">+                let durPix = endPix - startPix;</span>
<a href="#l7.1149"></a><span id="l7.1149" class="difflineplus">+                if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.1150"></a><span id="l7.1150" class="difflineplus">+                    box.setAttribute(&quot;height&quot;, durPix);</span>
<a href="#l7.1151"></a><span id="l7.1151" class="difflineplus">+                } else {</span>
<a href="#l7.1152"></a><span id="l7.1152" class="difflineplus">+                    box.setAttribute(&quot;width&quot;, durPix);</span>
<a href="#l7.1153"></a><span id="l7.1153" class="difflineplus">+                }</span>
<a href="#l7.1154"></a><span id="l7.1154" class="difflineplus">+</span>
<a href="#l7.1155"></a><span id="l7.1155" class="difflineplus">+                box.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.1156"></a><span id="l7.1156" class="difflineplus">+</span>
<a href="#l7.1157"></a><span id="l7.1157" class="difflineplus">+                this.bgbox.appendChild(box);</span>
<a href="#l7.1158"></a><span id="l7.1158" class="difflineplus">+                theMin += 60;</span>
<a href="#l7.1159"></a><span id="l7.1159" class="difflineplus">+            }</span>
<a href="#l7.1160"></a><span id="l7.1160" class="difflineplus">+</span>
<a href="#l7.1161"></a><span id="l7.1161" class="difflineplus">+            // fgbox is used for dragging events</span>
<a href="#l7.1162"></a><span id="l7.1162" class="difflineplus">+            this.fgboxes.box.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1163"></a><span id="l7.1163" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;fgdragspacer&quot;).setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1164"></a><span id="l7.1164" class="difflineplus">+</span>
<a href="#l7.1165"></a><span id="l7.1165" class="difflineplus">+            // this one is set to otherorient, since it will contain</span>
<a href="#l7.1166"></a><span id="l7.1166" class="difflineplus">+            // child boxes set to &quot;orient&quot; (one for each set of</span>
<a href="#l7.1167"></a><span id="l7.1167" class="difflineplus">+            // overlapping event areas)</span>
<a href="#l7.1168"></a><span id="l7.1168" class="difflineplus">+            this.topbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.1169"></a><span id="l7.1169" class="difflineplus">+</span>
<a href="#l7.1170"></a><span id="l7.1170" class="difflineplus">+            this.mEventMap = this.computeEventMap();</span>
<a href="#l7.1171"></a><span id="l7.1171" class="difflineplus">+            this.mEventBoxes = [];</span>
<a href="#l7.1172"></a><span id="l7.1172" class="difflineplus">+</span>
<a href="#l7.1173"></a><span id="l7.1173" class="difflineplus">+            if (!this.mEventMap.length) {</span>
<a href="#l7.1174"></a><span id="l7.1174" class="difflineplus">+                return;</span>
<a href="#l7.1175"></a><span id="l7.1175" class="difflineplus">+            }</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineplus">+</span>
<a href="#l7.1177"></a><span id="l7.1177" class="difflineplus">+            // First of all we create a xul:stack which</span>
<a href="#l7.1178"></a><span id="l7.1178" class="difflineplus">+            // will hold all events for this event column.</span>
<a href="#l7.1179"></a><span id="l7.1179" class="difflineplus">+            // The stack will be grouped below .../calendar-event-column/stack/topbox.</span>
<a href="#l7.1180"></a><span id="l7.1180" class="difflineplus">+            let stack = createXULElement(&quot;stack&quot;);</span>
<a href="#l7.1181"></a><span id="l7.1181" class="difflineplus">+            stack.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.1182"></a><span id="l7.1182" class="difflineplus">+            this.topbox.appendChild(stack);</span>
<a href="#l7.1183"></a><span id="l7.1183" class="difflineplus">+</span>
<a href="#l7.1184"></a><span id="l7.1184" class="difflineplus">+            let boxToEdit;</span>
<a href="#l7.1185"></a><span id="l7.1185" class="difflineplus">+            let columnCount = 1;</span>
<a href="#l7.1186"></a><span id="l7.1186" class="difflineplus">+            let spanTotal = 0;</span>
<a href="#l7.1187"></a><span id="l7.1187" class="difflineplus">+</span>
<a href="#l7.1188"></a><span id="l7.1188" class="difflineplus">+            for (let layer of this.mEventMap) {</span>
<a href="#l7.1189"></a><span id="l7.1189" class="difflineplus">+                // The event-map (this.mEventMap) contains an array of layers.</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineplus">+                // For each layer we create a box below the stack just created above.</span>
<a href="#l7.1191"></a><span id="l7.1191" class="difflineplus">+                // So each different layer lives in a box that's contained in the stack.</span>
<a href="#l7.1192"></a><span id="l7.1192" class="difflineplus">+                let xulColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.1193"></a><span id="l7.1193" class="difflineplus">+                xulColumn.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.1194"></a><span id="l7.1194" class="difflineplus">+                xulColumn.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.1195"></a><span id="l7.1195" class="difflineplus">+                xulColumn.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.1196"></a><span id="l7.1196" class="difflineplus">+                stack.appendChild(xulColumn);</span>
<a href="#l7.1197"></a><span id="l7.1197" class="difflineplus">+</span>
<a href="#l7.1198"></a><span id="l7.1198" class="difflineplus">+                let numBlocksInserted = 0;</span>
<a href="#l7.1199"></a><span id="l7.1199" class="difflineplus">+</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineplus">+                // column count determined by layer with no special span columns</span>
<a href="#l7.1201"></a><span id="l7.1201" class="difflineplus">+                if (layer.every(e =&gt; !e.specialSpan)) {</span>
<a href="#l7.1202"></a><span id="l7.1202" class="difflineplus">+                    columnCount = layer.length;</span>
<a href="#l7.1203"></a><span id="l7.1203" class="difflineplus">+                }</span>
<a href="#l7.1204"></a><span id="l7.1204" class="difflineplus">+                spanTotal = 0;</span>
<a href="#l7.1205"></a><span id="l7.1205" class="difflineplus">+</span>
<a href="#l7.1206"></a><span id="l7.1206" class="difflineplus">+                // Each layer contains a list of the columns that</span>
<a href="#l7.1207"></a><span id="l7.1207" class="difflineplus">+                // need to be created for a span.</span>
<a href="#l7.1208"></a><span id="l7.1208" class="difflineplus">+                for (let column of layer) {</span>
<a href="#l7.1209"></a><span id="l7.1209" class="difflineplus">+                    let innerColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.1210"></a><span id="l7.1210" class="difflineplus">+                    innerColumn.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1211"></a><span id="l7.1211" class="difflineplus">+</span>
<a href="#l7.1212"></a><span id="l7.1212" class="difflineplus">+                    let colFlex = column.specialSpan ? columnCount * column.specialSpan : 1;</span>
<a href="#l7.1213"></a><span id="l7.1213" class="difflineplus">+                    innerColumn.setAttribute(&quot;flex&quot;, colFlex);</span>
<a href="#l7.1214"></a><span id="l7.1214" class="difflineplus">+                    spanTotal += colFlex;</span>
<a href="#l7.1215"></a><span id="l7.1215" class="difflineplus">+</span>
<a href="#l7.1216"></a><span id="l7.1216" class="difflineplus">+                    innerColumn.style.minWidth = &quot;1px&quot;;</span>
<a href="#l7.1217"></a><span id="l7.1217" class="difflineplus">+                    innerColumn.style.minHeight = &quot;1px&quot;;</span>
<a href="#l7.1218"></a><span id="l7.1218" class="difflineplus">+                    innerColumn.style.width = colFlex + &quot;px&quot;;</span>
<a href="#l7.1219"></a><span id="l7.1219" class="difflineplus">+                    innerColumn.style.height = colFlex + &quot;px&quot;;</span>
<a href="#l7.1220"></a><span id="l7.1220" class="difflineplus">+</span>
<a href="#l7.1221"></a><span id="l7.1221" class="difflineplus">+                    xulColumn.appendChild(innerColumn);</span>
<a href="#l7.1222"></a><span id="l7.1222" class="difflineplus">+                    let duration;</span>
<a href="#l7.1223"></a><span id="l7.1223" class="difflineplus">+                    for (let chunk of column) {</span>
<a href="#l7.1224"></a><span id="l7.1224" class="difflineplus">+                        duration = chunk.duration;</span>
<a href="#l7.1225"></a><span id="l7.1225" class="difflineplus">+                        if (!duration) {</span>
<a href="#l7.1226"></a><span id="l7.1226" class="difflineplus">+                            continue;</span>
<a href="#l7.1227"></a><span id="l7.1227" class="difflineplus">+                        }</span>
<a href="#l7.1228"></a><span id="l7.1228" class="difflineplus">+</span>
<a href="#l7.1229"></a><span id="l7.1229" class="difflineplus">+                        if (chunk.event) {</span>
<a href="#l7.1230"></a><span id="l7.1230" class="difflineplus">+                            let chunkBox = createXULElement(&quot;calendar-event-box&quot;);</span>
<a href="#l7.1231"></a><span id="l7.1231" class="difflineplus">+                            let durMinutes = duration.inSeconds / 60;</span>
<a href="#l7.1232"></a><span id="l7.1232" class="difflineplus">+                            let size = Math.max(durMinutes * this.mPixPerMin, minSize);</span>
<a href="#l7.1233"></a><span id="l7.1233" class="difflineplus">+                            if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.1234"></a><span id="l7.1234" class="difflineplus">+                                chunkBox.setAttribute(&quot;height&quot;, size);</span>
<a href="#l7.1235"></a><span id="l7.1235" class="difflineplus">+                            } else {</span>
<a href="#l7.1236"></a><span id="l7.1236" class="difflineplus">+                                chunkBox.setAttribute(&quot;width&quot;, size);</span>
<a href="#l7.1237"></a><span id="l7.1237" class="difflineplus">+                            }</span>
<a href="#l7.1238"></a><span id="l7.1238" class="difflineplus">+                            chunkBox.setAttribute(&quot;context&quot;,</span>
<a href="#l7.1239"></a><span id="l7.1239" class="difflineplus">+                                                  this.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l7.1240"></a><span id="l7.1240" class="difflineplus">+                                                    this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.1241"></a><span id="l7.1241" class="difflineplus">+                            chunkBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1242"></a><span id="l7.1242" class="difflineplus">+</span>
<a href="#l7.1243"></a><span id="l7.1243" class="difflineplus">+                            // Set the gripBars visibility in the chunk. Keep it</span>
<a href="#l7.1244"></a><span id="l7.1244" class="difflineplus">+                            // hidden for tasks with only entry date OR due date.</span>
<a href="#l7.1245"></a><span id="l7.1245" class="difflineplus">+                            if ((chunk.event.entryDate || !chunk.event.dueDate) &amp;&amp;</span>
<a href="#l7.1246"></a><span id="l7.1246" class="difflineplus">+                                (!chunk.event.entryDate || chunk.event.dueDate)) {</span>
<a href="#l7.1247"></a><span id="l7.1247" class="difflineplus">+                                let startGripVisible = (chunk.event.startDate || chunk.event.entryDate)</span>
<a href="#l7.1248"></a><span id="l7.1248" class="difflineplus">+                                                           .compare(chunk.startDate) == 0;</span>
<a href="#l7.1249"></a><span id="l7.1249" class="difflineplus">+                                let endGripVisible = (chunk.event.endDate || chunk.event.dueDate)</span>
<a href="#l7.1250"></a><span id="l7.1250" class="difflineplus">+                                                         .compare(chunk.endDate) &lt;= 0;</span>
<a href="#l7.1251"></a><span id="l7.1251" class="difflineplus">+                                if (startGripVisible &amp;&amp; endGripVisible) {</span>
<a href="#l7.1252"></a><span id="l7.1252" class="difflineplus">+                                    chunkBox.setAttribute(&quot;gripBars&quot;, &quot;both&quot;);</span>
<a href="#l7.1253"></a><span id="l7.1253" class="difflineplus">+                                } else if (endGripVisible) {</span>
<a href="#l7.1254"></a><span id="l7.1254" class="difflineplus">+                                    chunkBox.setAttribute(&quot;gripBars&quot;, &quot;end&quot;);</span>
<a href="#l7.1255"></a><span id="l7.1255" class="difflineplus">+                                } else if (startGripVisible) {</span>
<a href="#l7.1256"></a><span id="l7.1256" class="difflineplus">+                                    chunkBox.setAttribute(&quot;gripBars&quot;, &quot;start&quot;);</span>
<a href="#l7.1257"></a><span id="l7.1257" class="difflineplus">+                                }</span>
<a href="#l7.1258"></a><span id="l7.1258" class="difflineplus">+                            }</span>
<a href="#l7.1259"></a><span id="l7.1259" class="difflineplus">+</span>
<a href="#l7.1260"></a><span id="l7.1260" class="difflineplus">+                            innerColumn.appendChild(chunkBox);</span>
<a href="#l7.1261"></a><span id="l7.1261" class="difflineplus">+                            chunkBox.calendarView = this.calendarView;</span>
<a href="#l7.1262"></a><span id="l7.1262" class="difflineplus">+                            chunkBox.occurrence = chunk.event;</span>
<a href="#l7.1263"></a><span id="l7.1263" class="difflineplus">+                            chunkBox.parentColumn = this;</span>
<a href="#l7.1264"></a><span id="l7.1264" class="difflineplus">+                            if (chunk.event.hashId in this.mSelectedItemIds) {</span>
<a href="#l7.1265"></a><span id="l7.1265" class="difflineplus">+                                chunkBox.selected = true;</span>
<a href="#l7.1266"></a><span id="l7.1266" class="difflineplus">+                                this.mSelectedChunks.push(chunkBox);</span>
<a href="#l7.1267"></a><span id="l7.1267" class="difflineplus">+                            }</span>
<a href="#l7.1268"></a><span id="l7.1268" class="difflineplus">+</span>
<a href="#l7.1269"></a><span id="l7.1269" class="difflineplus">+                            this.mEventBoxes.push(chunkBox);</span>
<a href="#l7.1270"></a><span id="l7.1270" class="difflineplus">+</span>
<a href="#l7.1271"></a><span id="l7.1271" class="difflineplus">+                            if (this.mEventToEdit &amp;&amp;</span>
<a href="#l7.1272"></a><span id="l7.1272" class="difflineplus">+                                chunkBox.occurrence.hashId == this.mEventToEdit.hashId) {</span>
<a href="#l7.1273"></a><span id="l7.1273" class="difflineplus">+                                boxToEdit = chunkBox;</span>
<a href="#l7.1274"></a><span id="l7.1274" class="difflineplus">+                            }</span>
<a href="#l7.1275"></a><span id="l7.1275" class="difflineplus">+                        } else {</span>
<a href="#l7.1276"></a><span id="l7.1276" class="difflineplus">+                            let chunkBox = createXULElement(&quot;spacer&quot;);</span>
<a href="#l7.1277"></a><span id="l7.1277" class="difflineplus">+                            chunkBox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.1278"></a><span id="l7.1278" class="difflineplus">+                            chunkBox.setAttribute(&quot;style&quot;, &quot;min-width: 1px; min-height: 1px;&quot;);</span>
<a href="#l7.1279"></a><span id="l7.1279" class="difflineplus">+                            chunkBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1280"></a><span id="l7.1280" class="difflineplus">+                            chunkBox.setAttribute(&quot;class&quot;, &quot;calendar-empty-space-box&quot;);</span>
<a href="#l7.1281"></a><span id="l7.1281" class="difflineplus">+                            innerColumn.appendChild(chunkBox);</span>
<a href="#l7.1282"></a><span id="l7.1282" class="difflineplus">+</span>
<a href="#l7.1283"></a><span id="l7.1283" class="difflineplus">+                            let durMinutes = duration.inSeconds / 60;</span>
<a href="#l7.1284"></a><span id="l7.1284" class="difflineplus">+                            if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.1285"></a><span id="l7.1285" class="difflineplus">+                                chunkBox.setAttribute(&quot;height&quot;, durMinutes * this.mPixPerMin);</span>
<a href="#l7.1286"></a><span id="l7.1286" class="difflineplus">+                            } else {</span>
<a href="#l7.1287"></a><span id="l7.1287" class="difflineplus">+                                chunkBox.setAttribute(&quot;width&quot;, durMinutes * this.mPixPerMin);</span>
<a href="#l7.1288"></a><span id="l7.1288" class="difflineplus">+                            }</span>
<a href="#l7.1289"></a><span id="l7.1289" class="difflineplus">+                        }</span>
<a href="#l7.1290"></a><span id="l7.1290" class="difflineplus">+                    }</span>
<a href="#l7.1291"></a><span id="l7.1291" class="difflineplus">+</span>
<a href="#l7.1292"></a><span id="l7.1292" class="difflineplus">+                    numBlocksInserted++;</span>
<a href="#l7.1293"></a><span id="l7.1293" class="difflineplus">+                }</span>
<a href="#l7.1294"></a><span id="l7.1294" class="difflineplus">+</span>
<a href="#l7.1295"></a><span id="l7.1295" class="difflineplus">+                // add last empty column if necessary</span>
<a href="#l7.1296"></a><span id="l7.1296" class="difflineplus">+                if (spanTotal &lt; columnCount) {</span>
<a href="#l7.1297"></a><span id="l7.1297" class="difflineplus">+                    let lastColumn = createXULElement(&quot;box&quot;);</span>
<a href="#l7.1298"></a><span id="l7.1298" class="difflineplus">+                    lastColumn.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.1299"></a><span id="l7.1299" class="difflineplus">+                    lastColumn.setAttribute(&quot;flex&quot;, columnCount - spanTotal);</span>
<a href="#l7.1300"></a><span id="l7.1300" class="difflineplus">+                    lastColumn.style.minWidth = &quot;1px&quot;;</span>
<a href="#l7.1301"></a><span id="l7.1301" class="difflineplus">+                    lastColumn.style.minHeight = &quot;1px&quot;;</span>
<a href="#l7.1302"></a><span id="l7.1302" class="difflineplus">+                    lastColumn.style.width = (columnCount - spanTotal) + &quot;px&quot;;</span>
<a href="#l7.1303"></a><span id="l7.1303" class="difflineplus">+                    lastColumn.style.height = (columnCount - spanTotal) + &quot;px&quot;;</span>
<a href="#l7.1304"></a><span id="l7.1304" class="difflineplus">+</span>
<a href="#l7.1305"></a><span id="l7.1305" class="difflineplus">+                    xulColumn.appendChild(lastColumn);</span>
<a href="#l7.1306"></a><span id="l7.1306" class="difflineplus">+                }</span>
<a href="#l7.1307"></a><span id="l7.1307" class="difflineplus">+</span>
<a href="#l7.1308"></a><span id="l7.1308" class="difflineplus">+                if (boxToEdit) {</span>
<a href="#l7.1309"></a><span id="l7.1309" class="difflineplus">+                    this.mCreatedNewEvent = false;</span>
<a href="#l7.1310"></a><span id="l7.1310" class="difflineplus">+                    this.mEventToEdit = null;</span>
<a href="#l7.1311"></a><span id="l7.1311" class="difflineplus">+                    boxToEdit.startEditing();</span>
<a href="#l7.1312"></a><span id="l7.1312" class="difflineplus">+                }</span>
<a href="#l7.1313"></a><span id="l7.1313" class="difflineplus">+</span>
<a href="#l7.1314"></a><span id="l7.1314" class="difflineplus">+                if (numBlocksInserted == 0) {</span>
<a href="#l7.1315"></a><span id="l7.1315" class="difflineplus">+                    // if we didn't insert any blocks, then</span>
<a href="#l7.1316"></a><span id="l7.1316" class="difflineplus">+                    // forget about this column</span>
<a href="#l7.1317"></a><span id="l7.1317" class="difflineplus">+                    xulColumn.remove();</span>
<a href="#l7.1318"></a><span id="l7.1318" class="difflineplus">+                }</span>
<a href="#l7.1319"></a><span id="l7.1319" class="difflineplus">+            }</span>
<a href="#l7.1320"></a><span id="l7.1320">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.1321"></a><span id="l7.1321">       &lt;/method&gt;</span>
<a href="#l7.1322"></a><span id="l7.1322"> </span>
<a href="#l7.1323"></a><span id="l7.1323">       &lt;method name=&quot;computeEventMap&quot;&gt;</span>
<a href="#l7.1324"></a><span id="l7.1324">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.1325"></a><span id="l7.1325" class="difflineminus">-          /* We're going to create a series of 'blobs'.  A blob is a series of</span>
<a href="#l7.1326"></a><span id="l7.1326" class="difflineminus">-           * events that create a continuous block of busy time.  In other</span>
<a href="#l7.1327"></a><span id="l7.1327" class="difflineminus">-           * words, a blob ends when there is some time such that no events</span>
<a href="#l7.1328"></a><span id="l7.1328" class="difflineminus">-           * occupy that time.</span>
<a href="#l7.1329"></a><span id="l7.1329" class="difflineminus">-           *</span>
<a href="#l7.1330"></a><span id="l7.1330" class="difflineminus">-           * Each blob will be an array of objects with the following properties:</span>
<a href="#l7.1331"></a><span id="l7.1331" class="difflineminus">-           *    item:     the event/task</span>
<a href="#l7.1332"></a><span id="l7.1332" class="difflineminus">-           *    startCol: the starting column to display the event in (0-indexed)</span>
<a href="#l7.1333"></a><span id="l7.1333" class="difflineminus">-           *    colSpan:  the number of columns the item spans</span>
<a href="#l7.1334"></a><span id="l7.1334" class="difflineminus">-           *</span>
<a href="#l7.1335"></a><span id="l7.1335" class="difflineminus">-           * An item with no conflicts will have startCol: 0 and colSpan: 1.</span>
<a href="#l7.1336"></a><span id="l7.1336" class="difflineminus">-           */</span>
<a href="#l7.1337"></a><span id="l7.1337" class="difflineminus">-          let blobs = [];</span>
<a href="#l7.1338"></a><span id="l7.1338" class="difflineminus">-          let currentBlob = [];</span>
<a href="#l7.1339"></a><span id="l7.1339" class="difflineminus">-          function sortByStart(aEventInfo, bEventInfo) {</span>
<a href="#l7.1340"></a><span id="l7.1340" class="difflineminus">-              // If you pass in tasks without both entry and due dates, I will</span>
<a href="#l7.1341"></a><span id="l7.1341" class="difflineminus">-              // kill you</span>
<a href="#l7.1342"></a><span id="l7.1342" class="difflineminus">-              let startComparison = aEventInfo.layoutStart.compare(bEventInfo.layoutStart);</span>
<a href="#l7.1343"></a><span id="l7.1343" class="difflineminus">-              if (startComparison == 0) {</span>
<a href="#l7.1344"></a><span id="l7.1344" class="difflineminus">-                  // If the items start at the same time, return the longer one</span>
<a href="#l7.1345"></a><span id="l7.1345" class="difflineminus">-                  // first</span>
<a href="#l7.1346"></a><span id="l7.1346" class="difflineminus">-                  return bEventInfo.layoutEnd.compare(aEventInfo.layoutEnd);</span>
<a href="#l7.1347"></a><span id="l7.1347" class="difflineminus">-              } else {</span>
<a href="#l7.1348"></a><span id="l7.1348" class="difflineminus">-                  return startComparison;</span>
<a href="#l7.1349"></a><span id="l7.1349" class="difflineminus">-              }</span>
<a href="#l7.1350"></a><span id="l7.1350" class="difflineminus">-          }</span>
<a href="#l7.1351"></a><span id="l7.1351" class="difflineminus">-          this.mEventInfos.forEach((aEventInfo) =&gt; {</span>
<a href="#l7.1352"></a><span id="l7.1352" class="difflineminus">-              let item = aEventInfo.event.clone();</span>
<a href="#l7.1353"></a><span id="l7.1353" class="difflineminus">-              let start = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l7.1354"></a><span id="l7.1354" class="difflineminus">-              start = start.getInTimezone(this.mTimezone);</span>
<a href="#l7.1355"></a><span id="l7.1355" class="difflineminus">-              aEventInfo.layoutStart = start;</span>
<a href="#l7.1356"></a><span id="l7.1356" class="difflineminus">-              let end = item.endDate || item.dueDate || item.entryDate;</span>
<a href="#l7.1357"></a><span id="l7.1357" class="difflineminus">-              end = end.getInTimezone(this.mTimezone);</span>
<a href="#l7.1358"></a><span id="l7.1358" class="difflineminus">-              let secEnd = start.clone();</span>
<a href="#l7.1359"></a><span id="l7.1359" class="difflineminus">-              secEnd.addDuration(this.mMinDuration);</span>
<a href="#l7.1360"></a><span id="l7.1360" class="difflineminus">-              if (secEnd.nativeTime &gt; end.nativeTime) {</span>
<a href="#l7.1361"></a><span id="l7.1361" class="difflineminus">-                  aEventInfo.layoutEnd = secEnd;</span>
<a href="#l7.1362"></a><span id="l7.1362" class="difflineminus">-              } else {</span>
<a href="#l7.1363"></a><span id="l7.1363" class="difflineminus">-                  aEventInfo.layoutEnd = end;</span>
<a href="#l7.1364"></a><span id="l7.1364" class="difflineminus">-              }</span>
<a href="#l7.1365"></a><span id="l7.1365" class="difflineminus">-              return aEventInfo;</span>
<a href="#l7.1366"></a><span id="l7.1366" class="difflineminus">-          });</span>
<a href="#l7.1367"></a><span id="l7.1367" class="difflineminus">-          this.mEventInfos.sort(sortByStart);</span>
<a href="#l7.1368"></a><span id="l7.1368" class="difflineminus">-</span>
<a href="#l7.1369"></a><span id="l7.1369" class="difflineminus">-          // The end time of the last ending event in the entire blob</span>
<a href="#l7.1370"></a><span id="l7.1370" class="difflineminus">-          let latestItemEnd;</span>
<a href="#l7.1371"></a><span id="l7.1371" class="difflineminus">-</span>
<a href="#l7.1372"></a><span id="l7.1372" class="difflineminus">-          // This array keeps track of the last (latest ending) item in each of</span>
<a href="#l7.1373"></a><span id="l7.1373" class="difflineminus">-          // the columns of the current blob. We could reconstruct this data at</span>
<a href="#l7.1374"></a><span id="l7.1374" class="difflineminus">-          // any time by looking at the items in the blob, but that would hurt</span>
<a href="#l7.1375"></a><span id="l7.1375" class="difflineminus">-          // perf.</span>
<a href="#l7.1376"></a><span id="l7.1376" class="difflineminus">-          let colEndArray = [];</span>
<a href="#l7.1377"></a><span id="l7.1377" class="difflineminus">-</span>
<a href="#l7.1378"></a><span id="l7.1378" class="difflineminus">-          /* Go through a 3 step process to try and place each item.</span>
<a href="#l7.1379"></a><span id="l7.1379" class="difflineminus">-           * Step 1: Look for an existing column with room for the item.</span>
<a href="#l7.1380"></a><span id="l7.1380" class="difflineminus">-           * Step 2: Look for a previously placed item that can be shrunk in</span>
<a href="#l7.1381"></a><span id="l7.1381" class="difflineminus">-           *         width to make room for the item.</span>
<a href="#l7.1382"></a><span id="l7.1382" class="difflineminus">-           * Step 3: Give up and create a new column for the item.</span>
<a href="#l7.1383"></a><span id="l7.1383" class="difflineminus">-           *</span>
<a href="#l7.1384"></a><span id="l7.1384" class="difflineminus">-           * (The steps are explained in more detail as we come to them)</span>
<a href="#l7.1385"></a><span id="l7.1385" class="difflineminus">-           */</span>
<a href="#l7.1386"></a><span id="l7.1386" class="difflineminus">-          for (let i in this.mEventInfos) {</span>
<a href="#l7.1387"></a><span id="l7.1387" class="difflineminus">-              let curItemInfo = {</span>
<a href="#l7.1388"></a><span id="l7.1388" class="difflineminus">-                  event: this.mEventInfos[i].event,</span>
<a href="#l7.1389"></a><span id="l7.1389" class="difflineminus">-                  layoutStart: this.mEventInfos[i].layoutStart,</span>
<a href="#l7.1390"></a><span id="l7.1390" class="difflineminus">-                  layoutEnd: this.mEventInfos[i].layoutEnd</span>
<a href="#l7.1391"></a><span id="l7.1391" class="difflineminus">-              };</span>
<a href="#l7.1392"></a><span id="l7.1392" class="difflineminus">-              if (!latestItemEnd) {</span>
<a href="#l7.1393"></a><span id="l7.1393" class="difflineminus">-                  latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1394"></a><span id="l7.1394" class="difflineminus">-              }</span>
<a href="#l7.1395"></a><span id="l7.1395" class="difflineminus">-              if (currentBlob.length &amp;&amp; latestItemEnd &amp;&amp;</span>
<a href="#l7.1396"></a><span id="l7.1396" class="difflineminus">-                  curItemInfo.layoutStart.compare(latestItemEnd) != -1) {</span>
<a href="#l7.1397"></a><span id="l7.1397" class="difflineminus">-                  // We're done with this current blob because item starts</span>
<a href="#l7.1398"></a><span id="l7.1398" class="difflineminus">-                  // after the last event in the current blob ended.</span>
<a href="#l7.1399"></a><span id="l7.1399" class="difflineminus">-                  blobs.push({ blob: currentBlob, totalCols: colEndArray.length });</span>
<a href="#l7.1400"></a><span id="l7.1400" class="difflineminus">-</span>
<a href="#l7.1401"></a><span id="l7.1401" class="difflineminus">-                  // Reset our variables</span>
<a href="#l7.1402"></a><span id="l7.1402" class="difflineminus">-                  currentBlob = [];</span>
<a href="#l7.1403"></a><span id="l7.1403" class="difflineminus">-                  colEndArray = [];</span>
<a href="#l7.1404"></a><span id="l7.1404" class="difflineminus">-              }</span>
<a href="#l7.1405"></a><span id="l7.1405" class="difflineminus">-</span>
<a href="#l7.1406"></a><span id="l7.1406" class="difflineminus">-              // Place the item in its correct place in the blob</span>
<a href="#l7.1407"></a><span id="l7.1407" class="difflineminus">-              let placedItem = false;</span>
<a href="#l7.1408"></a><span id="l7.1408" class="difflineminus">-</span>
<a href="#l7.1409"></a><span id="l7.1409" class="difflineminus">-              // Step 1</span>
<a href="#l7.1410"></a><span id="l7.1410" class="difflineminus">-              // Look for a possible column in the blob that has been left open. This</span>
<a href="#l7.1411"></a><span id="l7.1411" class="difflineminus">-              // would happen if we already have multiple columns but some of</span>
<a href="#l7.1412"></a><span id="l7.1412" class="difflineminus">-              // the cols have events before latestItemEnd.  For instance</span>
<a href="#l7.1413"></a><span id="l7.1413" class="difflineminus">-              //       |      |      |</span>
<a href="#l7.1414"></a><span id="l7.1414" class="difflineminus">-              //       |______|      |</span>
<a href="#l7.1415"></a><span id="l7.1415" class="difflineminus">-              //       |ev1   |______|</span>
<a href="#l7.1416"></a><span id="l7.1416" class="difflineminus">-              //       |      |ev2   |</span>
<a href="#l7.1417"></a><span id="l7.1417" class="difflineminus">-              //       |______|      |</span>
<a href="#l7.1418"></a><span id="l7.1418" class="difflineminus">-              //       |      |      |</span>
<a href="#l7.1419"></a><span id="l7.1419" class="difflineminus">-              //       |OPEN! |      |&lt;--Our item's start time might be here</span>
<a href="#l7.1420"></a><span id="l7.1420" class="difflineminus">-              //       |      |______|</span>
<a href="#l7.1421"></a><span id="l7.1421" class="difflineminus">-              //       |      |      |</span>
<a href="#l7.1422"></a><span id="l7.1422" class="difflineminus">-              //</span>
<a href="#l7.1423"></a><span id="l7.1423" class="difflineminus">-              // Remember that any time we're starting a new blob, colEndArray</span>
<a href="#l7.1424"></a><span id="l7.1424" class="difflineminus">-              // will be empty, but that's ok.</span>
<a href="#l7.1425"></a><span id="l7.1425" class="difflineminus">-              for (let j = 0; j &lt; colEndArray.length; ++j) {</span>
<a href="#l7.1426"></a><span id="l7.1426" class="difflineminus">-                  let colEnd = colEndArray[j].layoutEnd;</span>
<a href="#l7.1427"></a><span id="l7.1427" class="difflineminus">-                  if (colEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l7.1428"></a><span id="l7.1428" class="difflineminus">-                      // Yay, we can jump into this column</span>
<a href="#l7.1429"></a><span id="l7.1429" class="difflineminus">-                      colEndArray[j] = curItemInfo;</span>
<a href="#l7.1430"></a><span id="l7.1430" class="difflineminus">-</span>
<a href="#l7.1431"></a><span id="l7.1431" class="difflineminus">-                      // Check and see if there are any adjacent columns we can</span>
<a href="#l7.1432"></a><span id="l7.1432" class="difflineminus">-                      // jump into as well.</span>
<a href="#l7.1433"></a><span id="l7.1433" class="difflineminus">-                      let lastCol = Number(j) + 1;</span>
<a href="#l7.1434"></a><span id="l7.1434" class="difflineminus">-                      while (lastCol &lt; colEndArray.length) {</span>
<a href="#l7.1435"></a><span id="l7.1435" class="difflineminus">-                          let nextColEnd = colEndArray[lastCol].layoutEnd;</span>
<a href="#l7.1436"></a><span id="l7.1436" class="difflineminus">-                          // If the next column's item ends after we start, we</span>
<a href="#l7.1437"></a><span id="l7.1437" class="difflineminus">-                          // can't expand any further</span>
<a href="#l7.1438"></a><span id="l7.1438" class="difflineminus">-                          if (nextColEnd.compare(curItemInfo.layoutStart) == 1) {</span>
<a href="#l7.1439"></a><span id="l7.1439" class="difflineminus">-                              break;</span>
<a href="#l7.1440"></a><span id="l7.1440" class="difflineminus">-                          }</span>
<a href="#l7.1441"></a><span id="l7.1441" class="difflineminus">-                          colEndArray[lastCol] = curItemInfo;</span>
<a href="#l7.1442"></a><span id="l7.1442" class="difflineminus">-                          lastCol++;</span>
<a href="#l7.1443"></a><span id="l7.1443" class="difflineminus">-                      }</span>
<a href="#l7.1444"></a><span id="l7.1444" class="difflineminus">-                      // Now construct the info we need to push into the blob</span>
<a href="#l7.1445"></a><span id="l7.1445" class="difflineminus">-                      currentBlob.push({</span>
<a href="#l7.1446"></a><span id="l7.1446" class="difflineminus">-                          itemInfo: curItemInfo,</span>
<a href="#l7.1447"></a><span id="l7.1447" class="difflineminus">-                          startCol: j,</span>
<a href="#l7.1448"></a><span id="l7.1448" class="difflineminus">-                          colSpan: lastCol - j</span>
<a href="#l7.1449"></a><span id="l7.1449" class="difflineminus">-                      });</span>
<a href="#l7.1450"></a><span id="l7.1450" class="difflineminus">-</span>
<a href="#l7.1451"></a><span id="l7.1451" class="difflineminus">-                      // Update latestItemEnd</span>
<a href="#l7.1452"></a><span id="l7.1452" class="difflineminus">-                      if (latestItemEnd &amp;&amp;</span>
<a href="#l7.1453"></a><span id="l7.1453" class="difflineminus">-                          curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1454"></a><span id="l7.1454" class="difflineminus">-                          latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1455"></a><span id="l7.1455" class="difflineminus">-                      }</span>
<a href="#l7.1456"></a><span id="l7.1456" class="difflineminus">-                      placedItem = true;</span>
<a href="#l7.1457"></a><span id="l7.1457" class="difflineminus">-                      break; // Stop iterating through colEndArray</span>
<a href="#l7.1458"></a><span id="l7.1458" class="difflineminus">-                  }</span>
<a href="#l7.1459"></a><span id="l7.1459" class="difflineminus">-              }</span>
<a href="#l7.1460"></a><span id="l7.1460" class="difflineminus">-</span>
<a href="#l7.1461"></a><span id="l7.1461" class="difflineminus">-              if (placedItem) {</span>
<a href="#l7.1462"></a><span id="l7.1462" class="difflineminus">-                  // Go get the next item</span>
<a href="#l7.1463"></a><span id="l7.1463" class="difflineminus">-                  continue;</span>
<a href="#l7.1464"></a><span id="l7.1464" class="difflineminus">-              }</span>
<a href="#l7.1465"></a><span id="l7.1465" class="difflineminus">-</span>
<a href="#l7.1466"></a><span id="l7.1466" class="difflineminus">-              // Step 2</span>
<a href="#l7.1467"></a><span id="l7.1467" class="difflineminus">-              // OK, all columns (if there are any) overlap us.  Look if the</span>
<a href="#l7.1468"></a><span id="l7.1468" class="difflineminus">-              // last item in any of the last items in those columns is taking</span>
<a href="#l7.1469"></a><span id="l7.1469" class="difflineminus">-              // up 2 or more cols. If so, shrink it and stick the item in the</span>
<a href="#l7.1470"></a><span id="l7.1470" class="difflineminus">-              // created space. For instance</span>
<a href="#l7.1471"></a><span id="l7.1471" class="difflineminus">-              //       |______|______|______|</span>
<a href="#l7.1472"></a><span id="l7.1472" class="difflineminus">-              //       |ev1   |ev3   |ev4   |</span>
<a href="#l7.1473"></a><span id="l7.1473" class="difflineminus">-              //       |      |      |      |</span>
<a href="#l7.1474"></a><span id="l7.1474" class="difflineminus">-              //       |      |______|      |</span>
<a href="#l7.1475"></a><span id="l7.1475" class="difflineminus">-              //       |      |      |______|</span>
<a href="#l7.1476"></a><span id="l7.1476" class="difflineminus">-              //       |      |_____________|</span>
<a href="#l7.1477"></a><span id="l7.1477" class="difflineminus">-              //       |      |ev2          |</span>
<a href="#l7.1478"></a><span id="l7.1478" class="difflineminus">-              //       |______|             |&lt;--If our item's start time is</span>
<a href="#l7.1479"></a><span id="l7.1479" class="difflineminus">-              //       |      |_____________|   here, we can shrink ev2 and jump</span>
<a href="#l7.1480"></a><span id="l7.1480" class="difflineminus">-              //       |      |      |      |   in column #3</span>
<a href="#l7.1481"></a><span id="l7.1481" class="difflineminus">-              //</span>
<a href="#l7.1482"></a><span id="l7.1482" class="difflineminus">-              for (let j = 1; j &lt; colEndArray.length; ++j) {</span>
<a href="#l7.1483"></a><span id="l7.1483" class="difflineminus">-                  if (colEndArray[j].event.hashId == colEndArray[j - 1].event.hashId) {</span>
<a href="#l7.1484"></a><span id="l7.1484" class="difflineminus">-                      // Good we found a item that spanned multiple columns.</span>
<a href="#l7.1485"></a><span id="l7.1485" class="difflineminus">-                      // Find it in the blob so we can modify its properties</span>
<a href="#l7.1486"></a><span id="l7.1486" class="difflineminus">-                      for (let blobKey in currentBlob) {</span>
<a href="#l7.1487"></a><span id="l7.1487" class="difflineminus">-                          if (currentBlob[blobKey].itemInfo.event.hashId == colEndArray[j].event.hashId) {</span>
<a href="#l7.1488"></a><span id="l7.1488" class="difflineminus">-                              // Take all but the first spot that the item spanned</span>
<a href="#l7.1489"></a><span id="l7.1489" class="difflineminus">-                              let spanOfShrunkItem = currentBlob[blobKey].colSpan;</span>
<a href="#l7.1490"></a><span id="l7.1490" class="difflineminus">-                              currentBlob.push({</span>
<a href="#l7.1491"></a><span id="l7.1491" class="difflineminus">-                                  itemInfo: curItemInfo,</span>
<a href="#l7.1492"></a><span id="l7.1492" class="difflineminus">-                                  startCol: Number(currentBlob[blobKey].startCol) + 1,</span>
<a href="#l7.1493"></a><span id="l7.1493" class="difflineminus">-                                  colSpan: spanOfShrunkItem - 1</span>
<a href="#l7.1494"></a><span id="l7.1494" class="difflineminus">-                              });</span>
<a href="#l7.1495"></a><span id="l7.1495" class="difflineminus">-</span>
<a href="#l7.1496"></a><span id="l7.1496" class="difflineminus">-                              // Update colEndArray</span>
<a href="#l7.1497"></a><span id="l7.1497" class="difflineminus">-                              for (let k = j; k &lt; j + spanOfShrunkItem - 1; k++) {</span>
<a href="#l7.1498"></a><span id="l7.1498" class="difflineminus">-                                  colEndArray[k] = curItemInfo;</span>
<a href="#l7.1499"></a><span id="l7.1499" class="difflineminus">-                              }</span>
<a href="#l7.1500"></a><span id="l7.1500" class="difflineminus">-</span>
<a href="#l7.1501"></a><span id="l7.1501" class="difflineminus">-                              // Modify the data on the old item</span>
<a href="#l7.1502"></a><span id="l7.1502" class="difflineminus">-                              currentBlob[blobKey] = {</span>
<a href="#l7.1503"></a><span id="l7.1503" class="difflineminus">-                                  itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l7.1504"></a><span id="l7.1504" class="difflineminus">-                                  startCol: currentBlob[blobKey].startCol,</span>
<a href="#l7.1505"></a><span id="l7.1505" class="difflineminus">-                                  colSpan: 1</span>
<a href="#l7.1506"></a><span id="l7.1506" class="difflineminus">-                              };</span>
<a href="#l7.1507"></a><span id="l7.1507" class="difflineminus">-                              // Update latestItemEnd</span>
<a href="#l7.1508"></a><span id="l7.1508" class="difflineminus">-                              if (latestItemEnd &amp;&amp;</span>
<a href="#l7.1509"></a><span id="l7.1509" class="difflineminus">-                                  curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1510"></a><span id="l7.1510" class="difflineminus">-                                  latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1511"></a><span id="l7.1511" class="difflineminus">-                              }</span>
<a href="#l7.1512"></a><span id="l7.1512" class="difflineminus">-                              break; // Stop iterating through currentBlob</span>
<a href="#l7.1513"></a><span id="l7.1513" class="difflineminus">-                          }</span>
<a href="#l7.1514"></a><span id="l7.1514" class="difflineminus">-                      }</span>
<a href="#l7.1515"></a><span id="l7.1515" class="difflineminus">-                      placedItem = true;</span>
<a href="#l7.1516"></a><span id="l7.1516" class="difflineminus">-                      break; // Stop iterating through colEndArray</span>
<a href="#l7.1517"></a><span id="l7.1517" class="difflineminus">-                  }</span>
<a href="#l7.1518"></a><span id="l7.1518" class="difflineminus">-              }</span>
<a href="#l7.1519"></a><span id="l7.1519" class="difflineminus">-</span>
<a href="#l7.1520"></a><span id="l7.1520" class="difflineminus">-              if (placedItem) {</span>
<a href="#l7.1521"></a><span id="l7.1521" class="difflineminus">-                  // Go get the next item</span>
<a href="#l7.1522"></a><span id="l7.1522" class="difflineminus">-                  continue;</span>
<a href="#l7.1523"></a><span id="l7.1523" class="difflineminus">-              }</span>
<a href="#l7.1524"></a><span id="l7.1524" class="difflineminus">-</span>
<a href="#l7.1525"></a><span id="l7.1525" class="difflineminus">-              // Step 3</span>
<a href="#l7.1526"></a><span id="l7.1526" class="difflineminus">-              // Guess what? We still haven't placed the item.  We need to</span>
<a href="#l7.1527"></a><span id="l7.1527" class="difflineminus">-              // create a new column for it.</span>
<a href="#l7.1528"></a><span id="l7.1528" class="difflineminus">-</span>
<a href="#l7.1529"></a><span id="l7.1529" class="difflineminus">-              // All the items in the last column, except for the one* that</span>
<a href="#l7.1530"></a><span id="l7.1530" class="difflineminus">-              // conflicts with the item we're trying to place, need to have</span>
<a href="#l7.1531"></a><span id="l7.1531" class="difflineminus">-              // their span extended by 1, since we're adding the new column</span>
<a href="#l7.1532"></a><span id="l7.1532" class="difflineminus">-              //</span>
<a href="#l7.1533"></a><span id="l7.1533" class="difflineminus">-              // * Note that there can only be one, because we sorted our</span>
<a href="#l7.1534"></a><span id="l7.1534" class="difflineminus">-              //   events by start time, so this event must start later than</span>
<a href="#l7.1535"></a><span id="l7.1535" class="difflineminus">-              //   the start of any possible conflicts.</span>
<a href="#l7.1536"></a><span id="l7.1536" class="difflineminus">-              let lastColNum = colEndArray.length;</span>
<a href="#l7.1537"></a><span id="l7.1537" class="difflineminus">-              for (let blobKey in currentBlob) {</span>
<a href="#l7.1538"></a><span id="l7.1538" class="difflineminus">-                  let blobKeyEnd = currentBlob[blobKey].itemInfo.layoutEnd;</span>
<a href="#l7.1539"></a><span id="l7.1539" class="difflineminus">-                  if (currentBlob[blobKey].startCol + currentBlob[blobKey].colSpan == lastColNum &amp;&amp;</span>
<a href="#l7.1540"></a><span id="l7.1540" class="difflineminus">-                      blobKeyEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l7.1541"></a><span id="l7.1541" class="difflineminus">-                      currentBlob[blobKey] = {</span>
<a href="#l7.1542"></a><span id="l7.1542" class="difflineminus">-                          itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l7.1543"></a><span id="l7.1543" class="difflineminus">-                          startCol: currentBlob[blobKey].startCol,</span>
<a href="#l7.1544"></a><span id="l7.1544" class="difflineminus">-                          colSpan: currentBlob[blobKey].colSpan + 1</span>
<a href="#l7.1545"></a><span id="l7.1545" class="difflineminus">-                      };</span>
<a href="#l7.1546"></a><span id="l7.1546" class="difflineminus">-                  }</span>
<a href="#l7.1547"></a><span id="l7.1547" class="difflineminus">-              }</span>
<a href="#l7.1548"></a><span id="l7.1548" class="difflineminus">-              currentBlob.push({</span>
<a href="#l7.1549"></a><span id="l7.1549" class="difflineminus">-                  itemInfo: curItemInfo,</span>
<a href="#l7.1550"></a><span id="l7.1550" class="difflineminus">-                  startCol: colEndArray.length,</span>
<a href="#l7.1551"></a><span id="l7.1551" class="difflineminus">-                  colSpan: 1</span>
<a href="#l7.1552"></a><span id="l7.1552" class="difflineminus">-              });</span>
<a href="#l7.1553"></a><span id="l7.1553" class="difflineminus">-              colEndArray.push(curItemInfo);</span>
<a href="#l7.1554"></a><span id="l7.1554" class="difflineminus">-</span>
<a href="#l7.1555"></a><span id="l7.1555" class="difflineminus">-              // Update latestItemEnd</span>
<a href="#l7.1556"></a><span id="l7.1556" class="difflineminus">-              if (latestItemEnd &amp;&amp; curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1557"></a><span id="l7.1557" class="difflineminus">-                  latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1558"></a><span id="l7.1558" class="difflineminus">-              }</span>
<a href="#l7.1559"></a><span id="l7.1559" class="difflineminus">-              // Go get the next item</span>
<a href="#l7.1560"></a><span id="l7.1560" class="difflineminus">-          }</span>
<a href="#l7.1561"></a><span id="l7.1561" class="difflineminus">-          // Add the last blob</span>
<a href="#l7.1562"></a><span id="l7.1562" class="difflineminus">-          blobs.push({</span>
<a href="#l7.1563"></a><span id="l7.1563" class="difflineminus">-              blob: currentBlob,</span>
<a href="#l7.1564"></a><span id="l7.1564" class="difflineminus">-              totalCols: colEndArray.length</span>
<a href="#l7.1565"></a><span id="l7.1565" class="difflineminus">-          });</span>
<a href="#l7.1566"></a><span id="l7.1566" class="difflineminus">-          return this.setupBoxStructure(blobs);</span>
<a href="#l7.1567"></a><span id="l7.1567" class="difflineplus">+            /* We're going to create a series of 'blobs'.  A blob is a series of</span>
<a href="#l7.1568"></a><span id="l7.1568" class="difflineplus">+             * events that create a continuous block of busy time.  In other</span>
<a href="#l7.1569"></a><span id="l7.1569" class="difflineplus">+             * words, a blob ends when there is some time such that no events</span>
<a href="#l7.1570"></a><span id="l7.1570" class="difflineplus">+             * occupy that time.</span>
<a href="#l7.1571"></a><span id="l7.1571" class="difflineplus">+             *</span>
<a href="#l7.1572"></a><span id="l7.1572" class="difflineplus">+             * Each blob will be an array of objects with the following properties:</span>
<a href="#l7.1573"></a><span id="l7.1573" class="difflineplus">+             *    item:     the event/task</span>
<a href="#l7.1574"></a><span id="l7.1574" class="difflineplus">+             *    startCol: the starting column to display the event in (0-indexed)</span>
<a href="#l7.1575"></a><span id="l7.1575" class="difflineplus">+             *    colSpan:  the number of columns the item spans</span>
<a href="#l7.1576"></a><span id="l7.1576" class="difflineplus">+             *</span>
<a href="#l7.1577"></a><span id="l7.1577" class="difflineplus">+             * An item with no conflicts will have startCol: 0 and colSpan: 1.</span>
<a href="#l7.1578"></a><span id="l7.1578" class="difflineplus">+             */</span>
<a href="#l7.1579"></a><span id="l7.1579" class="difflineplus">+            let blobs = [];</span>
<a href="#l7.1580"></a><span id="l7.1580" class="difflineplus">+            let currentBlob = [];</span>
<a href="#l7.1581"></a><span id="l7.1581" class="difflineplus">+            function sortByStart(aEventInfo, bEventInfo) {</span>
<a href="#l7.1582"></a><span id="l7.1582" class="difflineplus">+                // If you pass in tasks without both entry and due dates, I will</span>
<a href="#l7.1583"></a><span id="l7.1583" class="difflineplus">+                // kill you</span>
<a href="#l7.1584"></a><span id="l7.1584" class="difflineplus">+                let startComparison = aEventInfo.layoutStart.compare(bEventInfo.layoutStart);</span>
<a href="#l7.1585"></a><span id="l7.1585" class="difflineplus">+                if (startComparison == 0) {</span>
<a href="#l7.1586"></a><span id="l7.1586" class="difflineplus">+                    // If the items start at the same time, return the longer one</span>
<a href="#l7.1587"></a><span id="l7.1587" class="difflineplus">+                    // first</span>
<a href="#l7.1588"></a><span id="l7.1588" class="difflineplus">+                    return bEventInfo.layoutEnd.compare(aEventInfo.layoutEnd);</span>
<a href="#l7.1589"></a><span id="l7.1589" class="difflineplus">+                } else {</span>
<a href="#l7.1590"></a><span id="l7.1590" class="difflineplus">+                    return startComparison;</span>
<a href="#l7.1591"></a><span id="l7.1591" class="difflineplus">+                }</span>
<a href="#l7.1592"></a><span id="l7.1592" class="difflineplus">+            }</span>
<a href="#l7.1593"></a><span id="l7.1593" class="difflineplus">+            this.mEventInfos.forEach((aEventInfo) =&gt; {</span>
<a href="#l7.1594"></a><span id="l7.1594" class="difflineplus">+                let item = aEventInfo.event.clone();</span>
<a href="#l7.1595"></a><span id="l7.1595" class="difflineplus">+                let start = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l7.1596"></a><span id="l7.1596" class="difflineplus">+                start = start.getInTimezone(this.mTimezone);</span>
<a href="#l7.1597"></a><span id="l7.1597" class="difflineplus">+                aEventInfo.layoutStart = start;</span>
<a href="#l7.1598"></a><span id="l7.1598" class="difflineplus">+                let end = item.endDate || item.dueDate || item.entryDate;</span>
<a href="#l7.1599"></a><span id="l7.1599" class="difflineplus">+                end = end.getInTimezone(this.mTimezone);</span>
<a href="#l7.1600"></a><span id="l7.1600" class="difflineplus">+                let secEnd = start.clone();</span>
<a href="#l7.1601"></a><span id="l7.1601" class="difflineplus">+                secEnd.addDuration(this.mMinDuration);</span>
<a href="#l7.1602"></a><span id="l7.1602" class="difflineplus">+                if (secEnd.nativeTime &gt; end.nativeTime) {</span>
<a href="#l7.1603"></a><span id="l7.1603" class="difflineplus">+                    aEventInfo.layoutEnd = secEnd;</span>
<a href="#l7.1604"></a><span id="l7.1604" class="difflineplus">+                } else {</span>
<a href="#l7.1605"></a><span id="l7.1605" class="difflineplus">+                    aEventInfo.layoutEnd = end;</span>
<a href="#l7.1606"></a><span id="l7.1606" class="difflineplus">+                }</span>
<a href="#l7.1607"></a><span id="l7.1607" class="difflineplus">+                return aEventInfo;</span>
<a href="#l7.1608"></a><span id="l7.1608" class="difflineplus">+            });</span>
<a href="#l7.1609"></a><span id="l7.1609" class="difflineplus">+            this.mEventInfos.sort(sortByStart);</span>
<a href="#l7.1610"></a><span id="l7.1610" class="difflineplus">+</span>
<a href="#l7.1611"></a><span id="l7.1611" class="difflineplus">+            // The end time of the last ending event in the entire blob</span>
<a href="#l7.1612"></a><span id="l7.1612" class="difflineplus">+            let latestItemEnd;</span>
<a href="#l7.1613"></a><span id="l7.1613" class="difflineplus">+</span>
<a href="#l7.1614"></a><span id="l7.1614" class="difflineplus">+            // This array keeps track of the last (latest ending) item in each of</span>
<a href="#l7.1615"></a><span id="l7.1615" class="difflineplus">+            // the columns of the current blob. We could reconstruct this data at</span>
<a href="#l7.1616"></a><span id="l7.1616" class="difflineplus">+            // any time by looking at the items in the blob, but that would hurt</span>
<a href="#l7.1617"></a><span id="l7.1617" class="difflineplus">+            // perf.</span>
<a href="#l7.1618"></a><span id="l7.1618" class="difflineplus">+            let colEndArray = [];</span>
<a href="#l7.1619"></a><span id="l7.1619" class="difflineplus">+</span>
<a href="#l7.1620"></a><span id="l7.1620" class="difflineplus">+            /* Go through a 3 step process to try and place each item.</span>
<a href="#l7.1621"></a><span id="l7.1621" class="difflineplus">+             * Step 1: Look for an existing column with room for the item.</span>
<a href="#l7.1622"></a><span id="l7.1622" class="difflineplus">+             * Step 2: Look for a previously placed item that can be shrunk in</span>
<a href="#l7.1623"></a><span id="l7.1623" class="difflineplus">+             *         width to make room for the item.</span>
<a href="#l7.1624"></a><span id="l7.1624" class="difflineplus">+             * Step 3: Give up and create a new column for the item.</span>
<a href="#l7.1625"></a><span id="l7.1625" class="difflineplus">+             *</span>
<a href="#l7.1626"></a><span id="l7.1626" class="difflineplus">+             * (The steps are explained in more detail as we come to them)</span>
<a href="#l7.1627"></a><span id="l7.1627" class="difflineplus">+             */</span>
<a href="#l7.1628"></a><span id="l7.1628" class="difflineplus">+            for (let i in this.mEventInfos) {</span>
<a href="#l7.1629"></a><span id="l7.1629" class="difflineplus">+                let curItemInfo = {</span>
<a href="#l7.1630"></a><span id="l7.1630" class="difflineplus">+                    event: this.mEventInfos[i].event,</span>
<a href="#l7.1631"></a><span id="l7.1631" class="difflineplus">+                    layoutStart: this.mEventInfos[i].layoutStart,</span>
<a href="#l7.1632"></a><span id="l7.1632" class="difflineplus">+                    layoutEnd: this.mEventInfos[i].layoutEnd</span>
<a href="#l7.1633"></a><span id="l7.1633" class="difflineplus">+                };</span>
<a href="#l7.1634"></a><span id="l7.1634" class="difflineplus">+                if (!latestItemEnd) {</span>
<a href="#l7.1635"></a><span id="l7.1635" class="difflineplus">+                    latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1636"></a><span id="l7.1636" class="difflineplus">+                }</span>
<a href="#l7.1637"></a><span id="l7.1637" class="difflineplus">+                if (currentBlob.length &amp;&amp; latestItemEnd &amp;&amp;</span>
<a href="#l7.1638"></a><span id="l7.1638" class="difflineplus">+                    curItemInfo.layoutStart.compare(latestItemEnd) != -1) {</span>
<a href="#l7.1639"></a><span id="l7.1639" class="difflineplus">+                    // We're done with this current blob because item starts</span>
<a href="#l7.1640"></a><span id="l7.1640" class="difflineplus">+                    // after the last event in the current blob ended.</span>
<a href="#l7.1641"></a><span id="l7.1641" class="difflineplus">+                    blobs.push({ blob: currentBlob, totalCols: colEndArray.length });</span>
<a href="#l7.1642"></a><span id="l7.1642" class="difflineplus">+</span>
<a href="#l7.1643"></a><span id="l7.1643" class="difflineplus">+                    // Reset our variables</span>
<a href="#l7.1644"></a><span id="l7.1644" class="difflineplus">+                    currentBlob = [];</span>
<a href="#l7.1645"></a><span id="l7.1645" class="difflineplus">+                    colEndArray = [];</span>
<a href="#l7.1646"></a><span id="l7.1646" class="difflineplus">+                }</span>
<a href="#l7.1647"></a><span id="l7.1647" class="difflineplus">+</span>
<a href="#l7.1648"></a><span id="l7.1648" class="difflineplus">+                // Place the item in its correct place in the blob</span>
<a href="#l7.1649"></a><span id="l7.1649" class="difflineplus">+                let placedItem = false;</span>
<a href="#l7.1650"></a><span id="l7.1650" class="difflineplus">+</span>
<a href="#l7.1651"></a><span id="l7.1651" class="difflineplus">+                // Step 1</span>
<a href="#l7.1652"></a><span id="l7.1652" class="difflineplus">+                // Look for a possible column in the blob that has been left open. This</span>
<a href="#l7.1653"></a><span id="l7.1653" class="difflineplus">+                // would happen if we already have multiple columns but some of</span>
<a href="#l7.1654"></a><span id="l7.1654" class="difflineplus">+                // the cols have events before latestItemEnd.  For instance</span>
<a href="#l7.1655"></a><span id="l7.1655" class="difflineplus">+                //       |      |      |</span>
<a href="#l7.1656"></a><span id="l7.1656" class="difflineplus">+                //       |______|      |</span>
<a href="#l7.1657"></a><span id="l7.1657" class="difflineplus">+                //       |ev1   |______|</span>
<a href="#l7.1658"></a><span id="l7.1658" class="difflineplus">+                //       |      |ev2   |</span>
<a href="#l7.1659"></a><span id="l7.1659" class="difflineplus">+                //       |______|      |</span>
<a href="#l7.1660"></a><span id="l7.1660" class="difflineplus">+                //       |      |      |</span>
<a href="#l7.1661"></a><span id="l7.1661" class="difflineplus">+                //       |OPEN! |      |&lt;--Our item's start time might be here</span>
<a href="#l7.1662"></a><span id="l7.1662" class="difflineplus">+                //       |      |______|</span>
<a href="#l7.1663"></a><span id="l7.1663" class="difflineplus">+                //       |      |      |</span>
<a href="#l7.1664"></a><span id="l7.1664" class="difflineplus">+                //</span>
<a href="#l7.1665"></a><span id="l7.1665" class="difflineplus">+                // Remember that any time we're starting a new blob, colEndArray</span>
<a href="#l7.1666"></a><span id="l7.1666" class="difflineplus">+                // will be empty, but that's ok.</span>
<a href="#l7.1667"></a><span id="l7.1667" class="difflineplus">+                for (let j = 0; j &lt; colEndArray.length; ++j) {</span>
<a href="#l7.1668"></a><span id="l7.1668" class="difflineplus">+                    let colEnd = colEndArray[j].layoutEnd;</span>
<a href="#l7.1669"></a><span id="l7.1669" class="difflineplus">+                    if (colEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l7.1670"></a><span id="l7.1670" class="difflineplus">+                        // Yay, we can jump into this column</span>
<a href="#l7.1671"></a><span id="l7.1671" class="difflineplus">+                        colEndArray[j] = curItemInfo;</span>
<a href="#l7.1672"></a><span id="l7.1672" class="difflineplus">+</span>
<a href="#l7.1673"></a><span id="l7.1673" class="difflineplus">+                        // Check and see if there are any adjacent columns we can</span>
<a href="#l7.1674"></a><span id="l7.1674" class="difflineplus">+                        // jump into as well.</span>
<a href="#l7.1675"></a><span id="l7.1675" class="difflineplus">+                        let lastCol = Number(j) + 1;</span>
<a href="#l7.1676"></a><span id="l7.1676" class="difflineplus">+                        while (lastCol &lt; colEndArray.length) {</span>
<a href="#l7.1677"></a><span id="l7.1677" class="difflineplus">+                            let nextColEnd = colEndArray[lastCol].layoutEnd;</span>
<a href="#l7.1678"></a><span id="l7.1678" class="difflineplus">+                            // If the next column's item ends after we start, we</span>
<a href="#l7.1679"></a><span id="l7.1679" class="difflineplus">+                            // can't expand any further</span>
<a href="#l7.1680"></a><span id="l7.1680" class="difflineplus">+                            if (nextColEnd.compare(curItemInfo.layoutStart) == 1) {</span>
<a href="#l7.1681"></a><span id="l7.1681" class="difflineplus">+                                break;</span>
<a href="#l7.1682"></a><span id="l7.1682" class="difflineplus">+                            }</span>
<a href="#l7.1683"></a><span id="l7.1683" class="difflineplus">+                            colEndArray[lastCol] = curItemInfo;</span>
<a href="#l7.1684"></a><span id="l7.1684" class="difflineplus">+                            lastCol++;</span>
<a href="#l7.1685"></a><span id="l7.1685" class="difflineplus">+                        }</span>
<a href="#l7.1686"></a><span id="l7.1686" class="difflineplus">+                        // Now construct the info we need to push into the blob</span>
<a href="#l7.1687"></a><span id="l7.1687" class="difflineplus">+                        currentBlob.push({</span>
<a href="#l7.1688"></a><span id="l7.1688" class="difflineplus">+                            itemInfo: curItemInfo,</span>
<a href="#l7.1689"></a><span id="l7.1689" class="difflineplus">+                            startCol: j,</span>
<a href="#l7.1690"></a><span id="l7.1690" class="difflineplus">+                            colSpan: lastCol - j</span>
<a href="#l7.1691"></a><span id="l7.1691" class="difflineplus">+                        });</span>
<a href="#l7.1692"></a><span id="l7.1692" class="difflineplus">+</span>
<a href="#l7.1693"></a><span id="l7.1693" class="difflineplus">+                        // Update latestItemEnd</span>
<a href="#l7.1694"></a><span id="l7.1694" class="difflineplus">+                        if (latestItemEnd &amp;&amp;</span>
<a href="#l7.1695"></a><span id="l7.1695" class="difflineplus">+                            curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1696"></a><span id="l7.1696" class="difflineplus">+                            latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1697"></a><span id="l7.1697" class="difflineplus">+                        }</span>
<a href="#l7.1698"></a><span id="l7.1698" class="difflineplus">+                        placedItem = true;</span>
<a href="#l7.1699"></a><span id="l7.1699" class="difflineplus">+                        break; // Stop iterating through colEndArray</span>
<a href="#l7.1700"></a><span id="l7.1700" class="difflineplus">+                    }</span>
<a href="#l7.1701"></a><span id="l7.1701" class="difflineplus">+                }</span>
<a href="#l7.1702"></a><span id="l7.1702" class="difflineplus">+</span>
<a href="#l7.1703"></a><span id="l7.1703" class="difflineplus">+                if (placedItem) {</span>
<a href="#l7.1704"></a><span id="l7.1704" class="difflineplus">+                    // Go get the next item</span>
<a href="#l7.1705"></a><span id="l7.1705" class="difflineplus">+                    continue;</span>
<a href="#l7.1706"></a><span id="l7.1706" class="difflineplus">+                }</span>
<a href="#l7.1707"></a><span id="l7.1707" class="difflineplus">+</span>
<a href="#l7.1708"></a><span id="l7.1708" class="difflineplus">+                // Step 2</span>
<a href="#l7.1709"></a><span id="l7.1709" class="difflineplus">+                // OK, all columns (if there are any) overlap us.  Look if the</span>
<a href="#l7.1710"></a><span id="l7.1710" class="difflineplus">+                // last item in any of the last items in those columns is taking</span>
<a href="#l7.1711"></a><span id="l7.1711" class="difflineplus">+                // up 2 or more cols. If so, shrink it and stick the item in the</span>
<a href="#l7.1712"></a><span id="l7.1712" class="difflineplus">+                // created space. For instance</span>
<a href="#l7.1713"></a><span id="l7.1713" class="difflineplus">+                //       |______|______|______|</span>
<a href="#l7.1714"></a><span id="l7.1714" class="difflineplus">+                //       |ev1   |ev3   |ev4   |</span>
<a href="#l7.1715"></a><span id="l7.1715" class="difflineplus">+                //       |      |      |      |</span>
<a href="#l7.1716"></a><span id="l7.1716" class="difflineplus">+                //       |      |______|      |</span>
<a href="#l7.1717"></a><span id="l7.1717" class="difflineplus">+                //       |      |      |______|</span>
<a href="#l7.1718"></a><span id="l7.1718" class="difflineplus">+                //       |      |_____________|</span>
<a href="#l7.1719"></a><span id="l7.1719" class="difflineplus">+                //       |      |ev2          |</span>
<a href="#l7.1720"></a><span id="l7.1720" class="difflineplus">+                //       |______|             |&lt;--If our item's start time is</span>
<a href="#l7.1721"></a><span id="l7.1721" class="difflineplus">+                //       |      |_____________|   here, we can shrink ev2 and jump</span>
<a href="#l7.1722"></a><span id="l7.1722" class="difflineplus">+                //       |      |      |      |   in column #3</span>
<a href="#l7.1723"></a><span id="l7.1723" class="difflineplus">+                //</span>
<a href="#l7.1724"></a><span id="l7.1724" class="difflineplus">+                for (let j = 1; j &lt; colEndArray.length; ++j) {</span>
<a href="#l7.1725"></a><span id="l7.1725" class="difflineplus">+                    if (colEndArray[j].event.hashId == colEndArray[j - 1].event.hashId) {</span>
<a href="#l7.1726"></a><span id="l7.1726" class="difflineplus">+                        // Good we found a item that spanned multiple columns.</span>
<a href="#l7.1727"></a><span id="l7.1727" class="difflineplus">+                        // Find it in the blob so we can modify its properties</span>
<a href="#l7.1728"></a><span id="l7.1728" class="difflineplus">+                        for (let blobKey in currentBlob) {</span>
<a href="#l7.1729"></a><span id="l7.1729" class="difflineplus">+                            if (currentBlob[blobKey].itemInfo.event.hashId == colEndArray[j].event.hashId) {</span>
<a href="#l7.1730"></a><span id="l7.1730" class="difflineplus">+                                // Take all but the first spot that the item spanned</span>
<a href="#l7.1731"></a><span id="l7.1731" class="difflineplus">+                                let spanOfShrunkItem = currentBlob[blobKey].colSpan;</span>
<a href="#l7.1732"></a><span id="l7.1732" class="difflineplus">+                                currentBlob.push({</span>
<a href="#l7.1733"></a><span id="l7.1733" class="difflineplus">+                                    itemInfo: curItemInfo,</span>
<a href="#l7.1734"></a><span id="l7.1734" class="difflineplus">+                                    startCol: Number(currentBlob[blobKey].startCol) + 1,</span>
<a href="#l7.1735"></a><span id="l7.1735" class="difflineplus">+                                    colSpan: spanOfShrunkItem - 1</span>
<a href="#l7.1736"></a><span id="l7.1736" class="difflineplus">+                                });</span>
<a href="#l7.1737"></a><span id="l7.1737" class="difflineplus">+</span>
<a href="#l7.1738"></a><span id="l7.1738" class="difflineplus">+                                // Update colEndArray</span>
<a href="#l7.1739"></a><span id="l7.1739" class="difflineplus">+                                for (let k = j; k &lt; j + spanOfShrunkItem - 1; k++) {</span>
<a href="#l7.1740"></a><span id="l7.1740" class="difflineplus">+                                    colEndArray[k] = curItemInfo;</span>
<a href="#l7.1741"></a><span id="l7.1741" class="difflineplus">+                                }</span>
<a href="#l7.1742"></a><span id="l7.1742" class="difflineplus">+</span>
<a href="#l7.1743"></a><span id="l7.1743" class="difflineplus">+                                // Modify the data on the old item</span>
<a href="#l7.1744"></a><span id="l7.1744" class="difflineplus">+                                currentBlob[blobKey] = {</span>
<a href="#l7.1745"></a><span id="l7.1745" class="difflineplus">+                                    itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l7.1746"></a><span id="l7.1746" class="difflineplus">+                                    startCol: currentBlob[blobKey].startCol,</span>
<a href="#l7.1747"></a><span id="l7.1747" class="difflineplus">+                                    colSpan: 1</span>
<a href="#l7.1748"></a><span id="l7.1748" class="difflineplus">+                                };</span>
<a href="#l7.1749"></a><span id="l7.1749" class="difflineplus">+                                // Update latestItemEnd</span>
<a href="#l7.1750"></a><span id="l7.1750" class="difflineplus">+                                if (latestItemEnd &amp;&amp;</span>
<a href="#l7.1751"></a><span id="l7.1751" class="difflineplus">+                                    curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1752"></a><span id="l7.1752" class="difflineplus">+                                    latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1753"></a><span id="l7.1753" class="difflineplus">+                                }</span>
<a href="#l7.1754"></a><span id="l7.1754" class="difflineplus">+                                break; // Stop iterating through currentBlob</span>
<a href="#l7.1755"></a><span id="l7.1755" class="difflineplus">+                            }</span>
<a href="#l7.1756"></a><span id="l7.1756" class="difflineplus">+                        }</span>
<a href="#l7.1757"></a><span id="l7.1757" class="difflineplus">+                        placedItem = true;</span>
<a href="#l7.1758"></a><span id="l7.1758" class="difflineplus">+                        break; // Stop iterating through colEndArray</span>
<a href="#l7.1759"></a><span id="l7.1759" class="difflineplus">+                    }</span>
<a href="#l7.1760"></a><span id="l7.1760" class="difflineplus">+                }</span>
<a href="#l7.1761"></a><span id="l7.1761" class="difflineplus">+</span>
<a href="#l7.1762"></a><span id="l7.1762" class="difflineplus">+                if (placedItem) {</span>
<a href="#l7.1763"></a><span id="l7.1763" class="difflineplus">+                    // Go get the next item</span>
<a href="#l7.1764"></a><span id="l7.1764" class="difflineplus">+                    continue;</span>
<a href="#l7.1765"></a><span id="l7.1765" class="difflineplus">+                }</span>
<a href="#l7.1766"></a><span id="l7.1766" class="difflineplus">+</span>
<a href="#l7.1767"></a><span id="l7.1767" class="difflineplus">+                // Step 3</span>
<a href="#l7.1768"></a><span id="l7.1768" class="difflineplus">+                // Guess what? We still haven't placed the item.  We need to</span>
<a href="#l7.1769"></a><span id="l7.1769" class="difflineplus">+                // create a new column for it.</span>
<a href="#l7.1770"></a><span id="l7.1770" class="difflineplus">+</span>
<a href="#l7.1771"></a><span id="l7.1771" class="difflineplus">+                // All the items in the last column, except for the one* that</span>
<a href="#l7.1772"></a><span id="l7.1772" class="difflineplus">+                // conflicts with the item we're trying to place, need to have</span>
<a href="#l7.1773"></a><span id="l7.1773" class="difflineplus">+                // their span extended by 1, since we're adding the new column</span>
<a href="#l7.1774"></a><span id="l7.1774" class="difflineplus">+                //</span>
<a href="#l7.1775"></a><span id="l7.1775" class="difflineplus">+                // * Note that there can only be one, because we sorted our</span>
<a href="#l7.1776"></a><span id="l7.1776" class="difflineplus">+                //   events by start time, so this event must start later than</span>
<a href="#l7.1777"></a><span id="l7.1777" class="difflineplus">+                //   the start of any possible conflicts.</span>
<a href="#l7.1778"></a><span id="l7.1778" class="difflineplus">+                let lastColNum = colEndArray.length;</span>
<a href="#l7.1779"></a><span id="l7.1779" class="difflineplus">+                for (let blobKey in currentBlob) {</span>
<a href="#l7.1780"></a><span id="l7.1780" class="difflineplus">+                    let blobKeyEnd = currentBlob[blobKey].itemInfo.layoutEnd;</span>
<a href="#l7.1781"></a><span id="l7.1781" class="difflineplus">+                    if (currentBlob[blobKey].startCol + currentBlob[blobKey].colSpan == lastColNum &amp;&amp;</span>
<a href="#l7.1782"></a><span id="l7.1782" class="difflineplus">+                        blobKeyEnd.compare(curItemInfo.layoutStart) != 1) {</span>
<a href="#l7.1783"></a><span id="l7.1783" class="difflineplus">+                        currentBlob[blobKey] = {</span>
<a href="#l7.1784"></a><span id="l7.1784" class="difflineplus">+                            itemInfo: currentBlob[blobKey].itemInfo,</span>
<a href="#l7.1785"></a><span id="l7.1785" class="difflineplus">+                            startCol: currentBlob[blobKey].startCol,</span>
<a href="#l7.1786"></a><span id="l7.1786" class="difflineplus">+                            colSpan: currentBlob[blobKey].colSpan + 1</span>
<a href="#l7.1787"></a><span id="l7.1787" class="difflineplus">+                        };</span>
<a href="#l7.1788"></a><span id="l7.1788" class="difflineplus">+                    }</span>
<a href="#l7.1789"></a><span id="l7.1789" class="difflineplus">+                }</span>
<a href="#l7.1790"></a><span id="l7.1790" class="difflineplus">+                currentBlob.push({</span>
<a href="#l7.1791"></a><span id="l7.1791" class="difflineplus">+                    itemInfo: curItemInfo,</span>
<a href="#l7.1792"></a><span id="l7.1792" class="difflineplus">+                    startCol: colEndArray.length,</span>
<a href="#l7.1793"></a><span id="l7.1793" class="difflineplus">+                    colSpan: 1</span>
<a href="#l7.1794"></a><span id="l7.1794" class="difflineplus">+                });</span>
<a href="#l7.1795"></a><span id="l7.1795" class="difflineplus">+                colEndArray.push(curItemInfo);</span>
<a href="#l7.1796"></a><span id="l7.1796" class="difflineplus">+</span>
<a href="#l7.1797"></a><span id="l7.1797" class="difflineplus">+                // Update latestItemEnd</span>
<a href="#l7.1798"></a><span id="l7.1798" class="difflineplus">+                if (latestItemEnd &amp;&amp; curItemInfo.layoutEnd.compare(latestItemEnd) == 1) {</span>
<a href="#l7.1799"></a><span id="l7.1799" class="difflineplus">+                    latestItemEnd = curItemInfo.layoutEnd;</span>
<a href="#l7.1800"></a><span id="l7.1800" class="difflineplus">+                }</span>
<a href="#l7.1801"></a><span id="l7.1801" class="difflineplus">+                // Go get the next item</span>
<a href="#l7.1802"></a><span id="l7.1802" class="difflineplus">+            }</span>
<a href="#l7.1803"></a><span id="l7.1803" class="difflineplus">+            // Add the last blob</span>
<a href="#l7.1804"></a><span id="l7.1804" class="difflineplus">+            blobs.push({</span>
<a href="#l7.1805"></a><span id="l7.1805" class="difflineplus">+                blob: currentBlob,</span>
<a href="#l7.1806"></a><span id="l7.1806" class="difflineplus">+                totalCols: colEndArray.length</span>
<a href="#l7.1807"></a><span id="l7.1807" class="difflineplus">+            });</span>
<a href="#l7.1808"></a><span id="l7.1808" class="difflineplus">+            return this.setupBoxStructure(blobs);</span>
<a href="#l7.1809"></a><span id="l7.1809">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.1810"></a><span id="l7.1810">       &lt;/method&gt;</span>
<a href="#l7.1811"></a><span id="l7.1811"> </span>
<a href="#l7.1812"></a><span id="l7.1812">       &lt;method name=&quot;setupBoxStructure&quot;&gt;</span>
<a href="#l7.1813"></a><span id="l7.1813">         &lt;parameter name=&quot;aBlobs&quot;/&gt;</span>
<a href="#l7.1814"></a><span id="l7.1814">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.1815"></a><span id="l7.1815" class="difflineminus">-          // This is actually going to end up being a 3-d array</span>
<a href="#l7.1816"></a><span id="l7.1816" class="difflineminus">-          // 1st dimension: &quot;layers&quot;, sets of columns of events that all</span>
<a href="#l7.1817"></a><span id="l7.1817" class="difflineminus">-          //                should have equal width*</span>
<a href="#l7.1818"></a><span id="l7.1818" class="difflineminus">-          // 2nd dimension: &quot;columns&quot;, individual columns of non-conflicting</span>
<a href="#l7.1819"></a><span id="l7.1819" class="difflineminus">-          //                items</span>
<a href="#l7.1820"></a><span id="l7.1820" class="difflineminus">-          // 3rd dimension: &quot;chunks&quot;, individual items or placeholders for</span>
<a href="#l7.1821"></a><span id="l7.1821" class="difflineminus">-          //                the blank time in between them</span>
<a href="#l7.1822"></a><span id="l7.1822" class="difflineminus">-          //</span>
<a href="#l7.1823"></a><span id="l7.1823" class="difflineminus">-          // * Note that 'equal width' isn't strictly correct.  If we're</span>
<a href="#l7.1824"></a><span id="l7.1824" class="difflineminus">-          //   oriented differently, it will be height (and we'll have rows</span>
<a href="#l7.1825"></a><span id="l7.1825" class="difflineminus">-          //   not columns).  What's more, in the 'specialSpan' case, the</span>
<a href="#l7.1826"></a><span id="l7.1826" class="difflineminus">-          //   columns won't actually have the same size, but will only all</span>
<a href="#l7.1827"></a><span id="l7.1827" class="difflineminus">-          //   be multiples of a common size.  See the note in the relayout</span>
<a href="#l7.1828"></a><span id="l7.1828" class="difflineminus">-          //   function for more info on this (fairly rare) case.</span>
<a href="#l7.1829"></a><span id="l7.1829" class="difflineminus">-          let layers = [];</span>
<a href="#l7.1830"></a><span id="l7.1830" class="difflineminus">-</span>
<a href="#l7.1831"></a><span id="l7.1831" class="difflineminus">-          // When we start a new blob, move to a new set of layers</span>
<a href="#l7.1832"></a><span id="l7.1832" class="difflineminus">-          let layerOffset = 0;</span>
<a href="#l7.1833"></a><span id="l7.1833" class="difflineminus">-          for (let glob of aBlobs) {</span>
<a href="#l7.1834"></a><span id="l7.1834" class="difflineminus">-              let layerArray = [];</span>
<a href="#l7.1835"></a><span id="l7.1835" class="difflineminus">-              let layerCounter = 1;</span>
<a href="#l7.1836"></a><span id="l7.1836" class="difflineminus">-</span>
<a href="#l7.1837"></a><span id="l7.1837" class="difflineminus">-              for (let data of glob.blob) {</span>
<a href="#l7.1838"></a><span id="l7.1838" class="difflineminus">-                  // from the item at hand we need to figure out on which</span>
<a href="#l7.1839"></a><span id="l7.1839" class="difflineminus">-                  // layer and on which column it should go.</span>
<a href="#l7.1840"></a><span id="l7.1840" class="difflineminus">-                  let layerIndex;</span>
<a href="#l7.1841"></a><span id="l7.1841" class="difflineminus">-                  let specialSpan = null;</span>
<a href="#l7.1842"></a><span id="l7.1842" class="difflineminus">-</span>
<a href="#l7.1843"></a><span id="l7.1843" class="difflineminus">-                  // each blob receives its own layer, that's the first part of the story. within</span>
<a href="#l7.1844"></a><span id="l7.1844" class="difflineminus">-                  // a given blob we need to distribute the items on different layers depending on</span>
<a href="#l7.1845"></a><span id="l7.1845" class="difflineminus">-                  // the number of columns each item spans. if each item just spans a single column</span>
<a href="#l7.1846"></a><span id="l7.1846" class="difflineminus">-                  // the blob will cover *one* layer. if the blob contains items that span more than</span>
<a href="#l7.1847"></a><span id="l7.1847" class="difflineminus">-                  // a single column, this blob will cover more than one layer. the algorithm places</span>
<a href="#l7.1848"></a><span id="l7.1848" class="difflineminus">-                  // the items on the first layer in the case an item covers a single column. new layers</span>
<a href="#l7.1849"></a><span id="l7.1849" class="difflineminus">-                  // are introduced based on the start column and number of spanning columns of an item.</span>
<a href="#l7.1850"></a><span id="l7.1850" class="difflineminus">-                  if (data.colSpan == 1) {</span>
<a href="#l7.1851"></a><span id="l7.1851" class="difflineminus">-                      layerIndex = 0;</span>
<a href="#l7.1852"></a><span id="l7.1852" class="difflineminus">-                  } else {</span>
<a href="#l7.1853"></a><span id="l7.1853" class="difflineminus">-                      let index = glob.totalCols * data.colSpan + data.startCol;</span>
<a href="#l7.1854"></a><span id="l7.1854" class="difflineminus">-                      layerIndex = layerArray[index];</span>
<a href="#l7.1855"></a><span id="l7.1855" class="difflineminus">-                      if (!layerIndex) {</span>
<a href="#l7.1856"></a><span id="l7.1856" class="difflineminus">-                          layerIndex = layerCounter++;</span>
<a href="#l7.1857"></a><span id="l7.1857" class="difflineminus">-                          layerArray[index] = layerIndex;</span>
<a href="#l7.1858"></a><span id="l7.1858" class="difflineminus">-                      }</span>
<a href="#l7.1859"></a><span id="l7.1859" class="difflineminus">-                      let offset = (glob.totalCols - data.colSpan) % glob.totalCols;</span>
<a href="#l7.1860"></a><span id="l7.1860" class="difflineminus">-                      if (offset != 0) {</span>
<a href="#l7.1861"></a><span id="l7.1861" class="difflineminus">-                          specialSpan = data.colSpan / glob.totalCols;</span>
<a href="#l7.1862"></a><span id="l7.1862" class="difflineminus">-                      }</span>
<a href="#l7.1863"></a><span id="l7.1863" class="difflineminus">-                  }</span>
<a href="#l7.1864"></a><span id="l7.1864" class="difflineminus">-                  layerIndex += layerOffset;</span>
<a href="#l7.1865"></a><span id="l7.1865" class="difflineminus">-</span>
<a href="#l7.1866"></a><span id="l7.1866" class="difflineminus">-                  // Make sure there's room to insert stuff</span>
<a href="#l7.1867"></a><span id="l7.1867" class="difflineminus">-                  while (layerIndex &gt;= layers.length) {</span>
<a href="#l7.1868"></a><span id="l7.1868" class="difflineminus">-                      layers.push([]);</span>
<a href="#l7.1869"></a><span id="l7.1869" class="difflineminus">-                  }</span>
<a href="#l7.1870"></a><span id="l7.1870" class="difflineminus">-</span>
<a href="#l7.1871"></a><span id="l7.1871" class="difflineminus">-                  while (data.startCol &gt;= layers[layerIndex].length) {</span>
<a href="#l7.1872"></a><span id="l7.1872" class="difflineminus">-                      layers[layerIndex].push([]);</span>
<a href="#l7.1873"></a><span id="l7.1873" class="difflineminus">-                      if (specialSpan) {</span>
<a href="#l7.1874"></a><span id="l7.1874" class="difflineminus">-                          layers[layerIndex][layers[layerIndex].length - 1].specialSpan = 1 / glob.totalCols;</span>
<a href="#l7.1875"></a><span id="l7.1875" class="difflineminus">-                      }</span>
<a href="#l7.1876"></a><span id="l7.1876" class="difflineminus">-                  }</span>
<a href="#l7.1877"></a><span id="l7.1877" class="difflineminus">-</span>
<a href="#l7.1878"></a><span id="l7.1878" class="difflineminus">-                  // we now retrieve the column from 'layerIndex' and 'startCol'.</span>
<a href="#l7.1879"></a><span id="l7.1879" class="difflineminus">-                  let col = layers[layerIndex][data.startCol];</span>
<a href="#l7.1880"></a><span id="l7.1880" class="difflineminus">-                  if (specialSpan) {</span>
<a href="#l7.1881"></a><span id="l7.1881" class="difflineminus">-                      col.specialSpan = specialSpan;</span>
<a href="#l7.1882"></a><span id="l7.1882" class="difflineminus">-                  }</span>
<a href="#l7.1883"></a><span id="l7.1883" class="difflineminus">-</span>
<a href="#l7.1884"></a><span id="l7.1884" class="difflineminus">-                  // take into account that items can span several days.</span>
<a href="#l7.1885"></a><span id="l7.1885" class="difflineminus">-                  // that's why i'm clipping the start- and end-time to the</span>
<a href="#l7.1886"></a><span id="l7.1886" class="difflineminus">-                  // timespan of this column.</span>
<a href="#l7.1887"></a><span id="l7.1887" class="difflineminus">-                  let start = data.itemInfo.layoutStart;</span>
<a href="#l7.1888"></a><span id="l7.1888" class="difflineminus">-                  let end = data.itemInfo.layoutEnd;</span>
<a href="#l7.1889"></a><span id="l7.1889" class="difflineminus">-                  if (start.year != this.date.year ||</span>
<a href="#l7.1890"></a><span id="l7.1890" class="difflineminus">-                      start.month != this.date.month ||</span>
<a href="#l7.1891"></a><span id="l7.1891" class="difflineminus">-                      start.day != this.date.day) {</span>
<a href="#l7.1892"></a><span id="l7.1892" class="difflineminus">-                      start = start.clone();</span>
<a href="#l7.1893"></a><span id="l7.1893" class="difflineminus">-                      start.resetTo(this.date.year,</span>
<a href="#l7.1894"></a><span id="l7.1894" class="difflineplus">+            // This is actually going to end up being a 3-d array</span>
<a href="#l7.1895"></a><span id="l7.1895" class="difflineplus">+            // 1st dimension: &quot;layers&quot;, sets of columns of events that all</span>
<a href="#l7.1896"></a><span id="l7.1896" class="difflineplus">+            //                should have equal width*</span>
<a href="#l7.1897"></a><span id="l7.1897" class="difflineplus">+            // 2nd dimension: &quot;columns&quot;, individual columns of non-conflicting</span>
<a href="#l7.1898"></a><span id="l7.1898" class="difflineplus">+            //                items</span>
<a href="#l7.1899"></a><span id="l7.1899" class="difflineplus">+            // 3rd dimension: &quot;chunks&quot;, individual items or placeholders for</span>
<a href="#l7.1900"></a><span id="l7.1900" class="difflineplus">+            //                the blank time in between them</span>
<a href="#l7.1901"></a><span id="l7.1901" class="difflineplus">+            //</span>
<a href="#l7.1902"></a><span id="l7.1902" class="difflineplus">+            // * Note that 'equal width' isn't strictly correct.  If we're</span>
<a href="#l7.1903"></a><span id="l7.1903" class="difflineplus">+            //   oriented differently, it will be height (and we'll have rows</span>
<a href="#l7.1904"></a><span id="l7.1904" class="difflineplus">+            //   not columns).  What's more, in the 'specialSpan' case, the</span>
<a href="#l7.1905"></a><span id="l7.1905" class="difflineplus">+            //   columns won't actually have the same size, but will only all</span>
<a href="#l7.1906"></a><span id="l7.1906" class="difflineplus">+            //   be multiples of a common size.  See the note in the relayout</span>
<a href="#l7.1907"></a><span id="l7.1907" class="difflineplus">+            //   function for more info on this (fairly rare) case.</span>
<a href="#l7.1908"></a><span id="l7.1908" class="difflineplus">+            let layers = [];</span>
<a href="#l7.1909"></a><span id="l7.1909" class="difflineplus">+</span>
<a href="#l7.1910"></a><span id="l7.1910" class="difflineplus">+            // When we start a new blob, move to a new set of layers</span>
<a href="#l7.1911"></a><span id="l7.1911" class="difflineplus">+            let layerOffset = 0;</span>
<a href="#l7.1912"></a><span id="l7.1912" class="difflineplus">+            for (let glob of aBlobs) {</span>
<a href="#l7.1913"></a><span id="l7.1913" class="difflineplus">+                let layerArray = [];</span>
<a href="#l7.1914"></a><span id="l7.1914" class="difflineplus">+                let layerCounter = 1;</span>
<a href="#l7.1915"></a><span id="l7.1915" class="difflineplus">+</span>
<a href="#l7.1916"></a><span id="l7.1916" class="difflineplus">+                for (let data of glob.blob) {</span>
<a href="#l7.1917"></a><span id="l7.1917" class="difflineplus">+                    // from the item at hand we need to figure out on which</span>
<a href="#l7.1918"></a><span id="l7.1918" class="difflineplus">+                    // layer and on which column it should go.</span>
<a href="#l7.1919"></a><span id="l7.1919" class="difflineplus">+                    let layerIndex;</span>
<a href="#l7.1920"></a><span id="l7.1920" class="difflineplus">+                    let specialSpan = null;</span>
<a href="#l7.1921"></a><span id="l7.1921" class="difflineplus">+</span>
<a href="#l7.1922"></a><span id="l7.1922" class="difflineplus">+                    // each blob receives its own layer, that's the first part of the story. within</span>
<a href="#l7.1923"></a><span id="l7.1923" class="difflineplus">+                    // a given blob we need to distribute the items on different layers depending on</span>
<a href="#l7.1924"></a><span id="l7.1924" class="difflineplus">+                    // the number of columns each item spans. if each item just spans a single column</span>
<a href="#l7.1925"></a><span id="l7.1925" class="difflineplus">+                    // the blob will cover *one* layer. if the blob contains items that span more than</span>
<a href="#l7.1926"></a><span id="l7.1926" class="difflineplus">+                    // a single column, this blob will cover more than one layer. the algorithm places</span>
<a href="#l7.1927"></a><span id="l7.1927" class="difflineplus">+                    // the items on the first layer in the case an item covers a single column. new layers</span>
<a href="#l7.1928"></a><span id="l7.1928" class="difflineplus">+                    // are introduced based on the start column and number of spanning columns of an item.</span>
<a href="#l7.1929"></a><span id="l7.1929" class="difflineplus">+                    if (data.colSpan == 1) {</span>
<a href="#l7.1930"></a><span id="l7.1930" class="difflineplus">+                        layerIndex = 0;</span>
<a href="#l7.1931"></a><span id="l7.1931" class="difflineplus">+                    } else {</span>
<a href="#l7.1932"></a><span id="l7.1932" class="difflineplus">+                        let index = glob.totalCols * data.colSpan + data.startCol;</span>
<a href="#l7.1933"></a><span id="l7.1933" class="difflineplus">+                        layerIndex = layerArray[index];</span>
<a href="#l7.1934"></a><span id="l7.1934" class="difflineplus">+                        if (!layerIndex) {</span>
<a href="#l7.1935"></a><span id="l7.1935" class="difflineplus">+                            layerIndex = layerCounter++;</span>
<a href="#l7.1936"></a><span id="l7.1936" class="difflineplus">+                            layerArray[index] = layerIndex;</span>
<a href="#l7.1937"></a><span id="l7.1937" class="difflineplus">+                        }</span>
<a href="#l7.1938"></a><span id="l7.1938" class="difflineplus">+                        let offset = (glob.totalCols - data.colSpan) % glob.totalCols;</span>
<a href="#l7.1939"></a><span id="l7.1939" class="difflineplus">+                        if (offset != 0) {</span>
<a href="#l7.1940"></a><span id="l7.1940" class="difflineplus">+                            specialSpan = data.colSpan / glob.totalCols;</span>
<a href="#l7.1941"></a><span id="l7.1941" class="difflineplus">+                        }</span>
<a href="#l7.1942"></a><span id="l7.1942" class="difflineplus">+                    }</span>
<a href="#l7.1943"></a><span id="l7.1943" class="difflineplus">+                    layerIndex += layerOffset;</span>
<a href="#l7.1944"></a><span id="l7.1944" class="difflineplus">+</span>
<a href="#l7.1945"></a><span id="l7.1945" class="difflineplus">+                    // Make sure there's room to insert stuff</span>
<a href="#l7.1946"></a><span id="l7.1946" class="difflineplus">+                    while (layerIndex &gt;= layers.length) {</span>
<a href="#l7.1947"></a><span id="l7.1947" class="difflineplus">+                        layers.push([]);</span>
<a href="#l7.1948"></a><span id="l7.1948" class="difflineplus">+                    }</span>
<a href="#l7.1949"></a><span id="l7.1949" class="difflineplus">+</span>
<a href="#l7.1950"></a><span id="l7.1950" class="difflineplus">+                    while (data.startCol &gt;= layers[layerIndex].length) {</span>
<a href="#l7.1951"></a><span id="l7.1951" class="difflineplus">+                        layers[layerIndex].push([]);</span>
<a href="#l7.1952"></a><span id="l7.1952" class="difflineplus">+                        if (specialSpan) {</span>
<a href="#l7.1953"></a><span id="l7.1953" class="difflineplus">+                            layers[layerIndex][layers[layerIndex].length - 1].specialSpan = 1 / glob.totalCols;</span>
<a href="#l7.1954"></a><span id="l7.1954" class="difflineplus">+                        }</span>
<a href="#l7.1955"></a><span id="l7.1955" class="difflineplus">+                    }</span>
<a href="#l7.1956"></a><span id="l7.1956" class="difflineplus">+</span>
<a href="#l7.1957"></a><span id="l7.1957" class="difflineplus">+                    // we now retrieve the column from 'layerIndex' and 'startCol'.</span>
<a href="#l7.1958"></a><span id="l7.1958" class="difflineplus">+                    let col = layers[layerIndex][data.startCol];</span>
<a href="#l7.1959"></a><span id="l7.1959" class="difflineplus">+                    if (specialSpan) {</span>
<a href="#l7.1960"></a><span id="l7.1960" class="difflineplus">+                        col.specialSpan = specialSpan;</span>
<a href="#l7.1961"></a><span id="l7.1961" class="difflineplus">+                    }</span>
<a href="#l7.1962"></a><span id="l7.1962" class="difflineplus">+</span>
<a href="#l7.1963"></a><span id="l7.1963" class="difflineplus">+                    // take into account that items can span several days.</span>
<a href="#l7.1964"></a><span id="l7.1964" class="difflineplus">+                    // that's why i'm clipping the start- and end-time to the</span>
<a href="#l7.1965"></a><span id="l7.1965" class="difflineplus">+                    // timespan of this column.</span>
<a href="#l7.1966"></a><span id="l7.1966" class="difflineplus">+                    let start = data.itemInfo.layoutStart;</span>
<a href="#l7.1967"></a><span id="l7.1967" class="difflineplus">+                    let end = data.itemInfo.layoutEnd;</span>
<a href="#l7.1968"></a><span id="l7.1968" class="difflineplus">+                    if (start.year != this.date.year ||</span>
<a href="#l7.1969"></a><span id="l7.1969" class="difflineplus">+                        start.month != this.date.month ||</span>
<a href="#l7.1970"></a><span id="l7.1970" class="difflineplus">+                        start.day != this.date.day) {</span>
<a href="#l7.1971"></a><span id="l7.1971" class="difflineplus">+                        start = start.clone();</span>
<a href="#l7.1972"></a><span id="l7.1972" class="difflineplus">+                        start.resetTo(this.date.year,</span>
<a href="#l7.1973"></a><span id="l7.1973" class="difflineplus">+                                      this.date.month,</span>
<a href="#l7.1974"></a><span id="l7.1974" class="difflineplus">+                                      this.date.day,</span>
<a href="#l7.1975"></a><span id="l7.1975" class="difflineplus">+                                      0, this.mStartMin, 0,</span>
<a href="#l7.1976"></a><span id="l7.1976" class="difflineplus">+                                      start.timezone);</span>
<a href="#l7.1977"></a><span id="l7.1977" class="difflineplus">+                    }</span>
<a href="#l7.1978"></a><span id="l7.1978" class="difflineplus">+                    if (end.year != this.date.year ||</span>
<a href="#l7.1979"></a><span id="l7.1979" class="difflineplus">+                        end.month != this.date.month ||</span>
<a href="#l7.1980"></a><span id="l7.1980" class="difflineplus">+                        end.day != this.date.day) {</span>
<a href="#l7.1981"></a><span id="l7.1981" class="difflineplus">+                        end = end.clone();</span>
<a href="#l7.1982"></a><span id="l7.1982" class="difflineplus">+                        end.resetTo(this.date.year,</span>
<a href="#l7.1983"></a><span id="l7.1983">                                     this.date.month,</span>
<a href="#l7.1984"></a><span id="l7.1984">                                     this.date.day,</span>
<a href="#l7.1985"></a><span id="l7.1985" class="difflineminus">-                                    0, this.mStartMin, 0,</span>
<a href="#l7.1986"></a><span id="l7.1986" class="difflineminus">-                                    start.timezone);</span>
<a href="#l7.1987"></a><span id="l7.1987" class="difflineminus">-                  }</span>
<a href="#l7.1988"></a><span id="l7.1988" class="difflineminus">-                  if (end.year != this.date.year ||</span>
<a href="#l7.1989"></a><span id="l7.1989" class="difflineminus">-                      end.month != this.date.month ||</span>
<a href="#l7.1990"></a><span id="l7.1990" class="difflineminus">-                      end.day != this.date.day) {</span>
<a href="#l7.1991"></a><span id="l7.1991" class="difflineminus">-                      end = end.clone();</span>
<a href="#l7.1992"></a><span id="l7.1992" class="difflineminus">-                      end.resetTo(this.date.year,</span>
<a href="#l7.1993"></a><span id="l7.1993" class="difflineminus">-                                  this.date.month,</span>
<a href="#l7.1994"></a><span id="l7.1994" class="difflineminus">-                                  this.date.day,</span>
<a href="#l7.1995"></a><span id="l7.1995" class="difflineminus">-                                  0, this.mEndMin, 0,</span>
<a href="#l7.1996"></a><span id="l7.1996" class="difflineminus">-                                  end.timezone);</span>
<a href="#l7.1997"></a><span id="l7.1997" class="difflineminus">-                  }</span>
<a href="#l7.1998"></a><span id="l7.1998" class="difflineminus">-                  let prevEnd;</span>
<a href="#l7.1999"></a><span id="l7.1999" class="difflineminus">-                  if (col.length &gt; 0) {</span>
<a href="#l7.2000"></a><span id="l7.2000" class="difflineminus">-                      // Fill in time gaps with a placeholder</span>
<a href="#l7.2001"></a><span id="l7.2001" class="difflineminus">-                      prevEnd = col[col.length - 1].endDate.clone();</span>
<a href="#l7.2002"></a><span id="l7.2002" class="difflineminus">-                  } else {</span>
<a href="#l7.2003"></a><span id="l7.2003" class="difflineminus">-                      // First event in the column, add a placeholder for the</span>
<a href="#l7.2004"></a><span id="l7.2004" class="difflineminus">-                      // blank time from this.mStartMin to the event's start</span>
<a href="#l7.2005"></a><span id="l7.2005" class="difflineminus">-                      prevEnd = start.clone();</span>
<a href="#l7.2006"></a><span id="l7.2006" class="difflineminus">-                      prevEnd.hour = 0;</span>
<a href="#l7.2007"></a><span id="l7.2007" class="difflineminus">-                      prevEnd.minute = this.mStartMin;</span>
<a href="#l7.2008"></a><span id="l7.2008" class="difflineminus">-                  }</span>
<a href="#l7.2009"></a><span id="l7.2009" class="difflineminus">-                  prevEnd.timezone = cal.floating();</span>
<a href="#l7.2010"></a><span id="l7.2010" class="difflineminus">-                  // the reason why we need to calculate time durations</span>
<a href="#l7.2011"></a><span id="l7.2011" class="difflineminus">-                  // based on floating timezones is that we need avoid</span>
<a href="#l7.2012"></a><span id="l7.2012" class="difflineminus">-                  // dst gaps in this case. converting the date/times to</span>
<a href="#l7.2013"></a><span id="l7.2013" class="difflineminus">-                  // floating conveys this idea in a natural way. note that</span>
<a href="#l7.2014"></a><span id="l7.2014" class="difflineminus">-                  // we explicitly don't use getInTimezone() as it would</span>
<a href="#l7.2015"></a><span id="l7.2015" class="difflineminus">-                  // be slightly more expensive in terms of performance.</span>
<a href="#l7.2016"></a><span id="l7.2016" class="difflineminus">-                  let floatstart = start.clone();</span>
<a href="#l7.2017"></a><span id="l7.2017" class="difflineminus">-                  floatstart.timezone = cal.floating();</span>
<a href="#l7.2018"></a><span id="l7.2018" class="difflineminus">-                  let dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l7.2019"></a><span id="l7.2019" class="difflineminus">-                  if (dur.inSeconds) {</span>
<a href="#l7.2020"></a><span id="l7.2020" class="difflineminus">-                      col.push({ duration: dur });</span>
<a href="#l7.2021"></a><span id="l7.2021" class="difflineminus">-                  }</span>
<a href="#l7.2022"></a><span id="l7.2022" class="difflineminus">-                  let floatend = end.clone();</span>
<a href="#l7.2023"></a><span id="l7.2023" class="difflineminus">-                  floatend.timezone = cal.floating();</span>
<a href="#l7.2024"></a><span id="l7.2024" class="difflineminus">-                  col.push({</span>
<a href="#l7.2025"></a><span id="l7.2025" class="difflineminus">-                      event: data.itemInfo.event,</span>
<a href="#l7.2026"></a><span id="l7.2026" class="difflineminus">-                      endDate: end,</span>
<a href="#l7.2027"></a><span id="l7.2027" class="difflineminus">-                      startDate: start,</span>
<a href="#l7.2028"></a><span id="l7.2028" class="difflineminus">-                      duration: floatend.subtractDate(floatstart)</span>
<a href="#l7.2029"></a><span id="l7.2029" class="difflineminus">-                  });</span>
<a href="#l7.2030"></a><span id="l7.2030" class="difflineminus">-              }</span>
<a href="#l7.2031"></a><span id="l7.2031" class="difflineminus">-              layerOffset = layers.length;</span>
<a href="#l7.2032"></a><span id="l7.2032" class="difflineminus">-          }</span>
<a href="#l7.2033"></a><span id="l7.2033" class="difflineminus">-          return layers;</span>
<a href="#l7.2034"></a><span id="l7.2034" class="difflineplus">+                                    0, this.mEndMin, 0,</span>
<a href="#l7.2035"></a><span id="l7.2035" class="difflineplus">+                                    end.timezone);</span>
<a href="#l7.2036"></a><span id="l7.2036" class="difflineplus">+                    }</span>
<a href="#l7.2037"></a><span id="l7.2037" class="difflineplus">+                    let prevEnd;</span>
<a href="#l7.2038"></a><span id="l7.2038" class="difflineplus">+                    if (col.length &gt; 0) {</span>
<a href="#l7.2039"></a><span id="l7.2039" class="difflineplus">+                        // Fill in time gaps with a placeholder</span>
<a href="#l7.2040"></a><span id="l7.2040" class="difflineplus">+                        prevEnd = col[col.length - 1].endDate.clone();</span>
<a href="#l7.2041"></a><span id="l7.2041" class="difflineplus">+                    } else {</span>
<a href="#l7.2042"></a><span id="l7.2042" class="difflineplus">+                        // First event in the column, add a placeholder for the</span>
<a href="#l7.2043"></a><span id="l7.2043" class="difflineplus">+                        // blank time from this.mStartMin to the event's start</span>
<a href="#l7.2044"></a><span id="l7.2044" class="difflineplus">+                        prevEnd = start.clone();</span>
<a href="#l7.2045"></a><span id="l7.2045" class="difflineplus">+                        prevEnd.hour = 0;</span>
<a href="#l7.2046"></a><span id="l7.2046" class="difflineplus">+                        prevEnd.minute = this.mStartMin;</span>
<a href="#l7.2047"></a><span id="l7.2047" class="difflineplus">+                    }</span>
<a href="#l7.2048"></a><span id="l7.2048" class="difflineplus">+                    prevEnd.timezone = cal.floating();</span>
<a href="#l7.2049"></a><span id="l7.2049" class="difflineplus">+                    // the reason why we need to calculate time durations</span>
<a href="#l7.2050"></a><span id="l7.2050" class="difflineplus">+                    // based on floating timezones is that we need avoid</span>
<a href="#l7.2051"></a><span id="l7.2051" class="difflineplus">+                    // dst gaps in this case. converting the date/times to</span>
<a href="#l7.2052"></a><span id="l7.2052" class="difflineplus">+                    // floating conveys this idea in a natural way. note that</span>
<a href="#l7.2053"></a><span id="l7.2053" class="difflineplus">+                    // we explicitly don't use getInTimezone() as it would</span>
<a href="#l7.2054"></a><span id="l7.2054" class="difflineplus">+                    // be slightly more expensive in terms of performance.</span>
<a href="#l7.2055"></a><span id="l7.2055" class="difflineplus">+                    let floatstart = start.clone();</span>
<a href="#l7.2056"></a><span id="l7.2056" class="difflineplus">+                    floatstart.timezone = cal.floating();</span>
<a href="#l7.2057"></a><span id="l7.2057" class="difflineplus">+                    let dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l7.2058"></a><span id="l7.2058" class="difflineplus">+                    if (dur.inSeconds) {</span>
<a href="#l7.2059"></a><span id="l7.2059" class="difflineplus">+                        col.push({ duration: dur });</span>
<a href="#l7.2060"></a><span id="l7.2060" class="difflineplus">+                    }</span>
<a href="#l7.2061"></a><span id="l7.2061" class="difflineplus">+                    let floatend = end.clone();</span>
<a href="#l7.2062"></a><span id="l7.2062" class="difflineplus">+                    floatend.timezone = cal.floating();</span>
<a href="#l7.2063"></a><span id="l7.2063" class="difflineplus">+                    col.push({</span>
<a href="#l7.2064"></a><span id="l7.2064" class="difflineplus">+                        event: data.itemInfo.event,</span>
<a href="#l7.2065"></a><span id="l7.2065" class="difflineplus">+                        endDate: end,</span>
<a href="#l7.2066"></a><span id="l7.2066" class="difflineplus">+                        startDate: start,</span>
<a href="#l7.2067"></a><span id="l7.2067" class="difflineplus">+                        duration: floatend.subtractDate(floatstart)</span>
<a href="#l7.2068"></a><span id="l7.2068" class="difflineplus">+                    });</span>
<a href="#l7.2069"></a><span id="l7.2069" class="difflineplus">+                }</span>
<a href="#l7.2070"></a><span id="l7.2070" class="difflineplus">+                layerOffset = layers.length;</span>
<a href="#l7.2071"></a><span id="l7.2071" class="difflineplus">+            }</span>
<a href="#l7.2072"></a><span id="l7.2072" class="difflineplus">+            return layers;</span>
<a href="#l7.2073"></a><span id="l7.2073">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2074"></a><span id="l7.2074">       &lt;/method&gt;</span>
<a href="#l7.2075"></a><span id="l7.2075"> </span>
<a href="#l7.2076"></a><span id="l7.2076">       &lt;method name=&quot;getShadowElements&quot;&gt;</span>
<a href="#l7.2077"></a><span id="l7.2077">         &lt;parameter name=&quot;aStart&quot;/&gt;</span>
<a href="#l7.2078"></a><span id="l7.2078">         &lt;parameter name=&quot;aEnd&quot;/&gt;</span>
<a href="#l7.2079"></a><span id="l7.2079">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2080"></a><span id="l7.2080" class="difflineminus">-          // aStart and aEnd are start and end minutes of the occurrence</span>
<a href="#l7.2081"></a><span id="l7.2081" class="difflineminus">-          // from time 0:00 of the dragging column</span>
<a href="#l7.2082"></a><span id="l7.2082" class="difflineminus">-          let shadows = 1;</span>
<a href="#l7.2083"></a><span id="l7.2083" class="difflineminus">-          let offset = 0;</span>
<a href="#l7.2084"></a><span id="l7.2084" class="difflineminus">-          let startMin;</span>
<a href="#l7.2085"></a><span id="l7.2085" class="difflineminus">-          if (aStart &lt; 0) {</span>
<a href="#l7.2086"></a><span id="l7.2086" class="difflineminus">-              shadows += Math.ceil(Math.abs(aStart) / this.mEndMin);</span>
<a href="#l7.2087"></a><span id="l7.2087" class="difflineminus">-              offset = shadows - 1;</span>
<a href="#l7.2088"></a><span id="l7.2088" class="difflineminus">-              let reminder = Math.abs(aStart) % this.mEndMin;</span>
<a href="#l7.2089"></a><span id="l7.2089" class="difflineminus">-              startMin = this.mEndMin - (reminder ? reminder : this.mEndMin);</span>
<a href="#l7.2090"></a><span id="l7.2090" class="difflineminus">-          } else {</span>
<a href="#l7.2091"></a><span id="l7.2091" class="difflineminus">-              startMin = aStart;</span>
<a href="#l7.2092"></a><span id="l7.2092" class="difflineminus">-          }</span>
<a href="#l7.2093"></a><span id="l7.2093" class="difflineminus">-          shadows += Math.floor(aEnd / this.mEndMin);</span>
<a href="#l7.2094"></a><span id="l7.2094" class="difflineminus">-</span>
<a href="#l7.2095"></a><span id="l7.2095" class="difflineminus">-          // return values needed to build the shadows while dragging</span>
<a href="#l7.2096"></a><span id="l7.2096" class="difflineminus">-          return {</span>
<a href="#l7.2097"></a><span id="l7.2097" class="difflineminus">-              shadows: shadows,             // number of shadows</span>
<a href="#l7.2098"></a><span id="l7.2098" class="difflineminus">-              offset: offset,               // Offset first&lt;-&gt;selected shadows</span>
<a href="#l7.2099"></a><span id="l7.2099" class="difflineminus">-              startMin: startMin,           // First shadow start minute</span>
<a href="#l7.2100"></a><span id="l7.2100" class="difflineminus">-              endMin: aEnd % this.mEndMin   // Last shadow end minute</span>
<a href="#l7.2101"></a><span id="l7.2101" class="difflineminus">-          };</span>
<a href="#l7.2102"></a><span id="l7.2102" class="difflineplus">+            // aStart and aEnd are start and end minutes of the occurrence</span>
<a href="#l7.2103"></a><span id="l7.2103" class="difflineplus">+            // from time 0:00 of the dragging column</span>
<a href="#l7.2104"></a><span id="l7.2104" class="difflineplus">+            let shadows = 1;</span>
<a href="#l7.2105"></a><span id="l7.2105" class="difflineplus">+            let offset = 0;</span>
<a href="#l7.2106"></a><span id="l7.2106" class="difflineplus">+            let startMin;</span>
<a href="#l7.2107"></a><span id="l7.2107" class="difflineplus">+            if (aStart &lt; 0) {</span>
<a href="#l7.2108"></a><span id="l7.2108" class="difflineplus">+                shadows += Math.ceil(Math.abs(aStart) / this.mEndMin);</span>
<a href="#l7.2109"></a><span id="l7.2109" class="difflineplus">+                offset = shadows - 1;</span>
<a href="#l7.2110"></a><span id="l7.2110" class="difflineplus">+                let reminder = Math.abs(aStart) % this.mEndMin;</span>
<a href="#l7.2111"></a><span id="l7.2111" class="difflineplus">+                startMin = this.mEndMin - (reminder ? reminder : this.mEndMin);</span>
<a href="#l7.2112"></a><span id="l7.2112" class="difflineplus">+            } else {</span>
<a href="#l7.2113"></a><span id="l7.2113" class="difflineplus">+                startMin = aStart;</span>
<a href="#l7.2114"></a><span id="l7.2114" class="difflineplus">+            }</span>
<a href="#l7.2115"></a><span id="l7.2115" class="difflineplus">+            shadows += Math.floor(aEnd / this.mEndMin);</span>
<a href="#l7.2116"></a><span id="l7.2116" class="difflineplus">+</span>
<a href="#l7.2117"></a><span id="l7.2117" class="difflineplus">+            // return values needed to build the shadows while dragging</span>
<a href="#l7.2118"></a><span id="l7.2118" class="difflineplus">+            return {</span>
<a href="#l7.2119"></a><span id="l7.2119" class="difflineplus">+                shadows: shadows,             // number of shadows</span>
<a href="#l7.2120"></a><span id="l7.2120" class="difflineplus">+                offset: offset,               // Offset first&lt;-&gt;selected shadows</span>
<a href="#l7.2121"></a><span id="l7.2121" class="difflineplus">+                startMin: startMin,           // First shadow start minute</span>
<a href="#l7.2122"></a><span id="l7.2122" class="difflineplus">+                endMin: aEnd % this.mEndMin   // Last shadow end minute</span>
<a href="#l7.2123"></a><span id="l7.2123" class="difflineplus">+            };</span>
<a href="#l7.2124"></a><span id="l7.2124">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2125"></a><span id="l7.2125">       &lt;/method&gt;</span>
<a href="#l7.2126"></a><span id="l7.2126"> </span>
<a href="#l7.2127"></a><span id="l7.2127">       &lt;method name=&quot;firstLastShadowColumns&quot;&gt;</span>
<a href="#l7.2128"></a><span id="l7.2128">         &lt;parameter name=&quot;aOffset&quot;/&gt;</span>
<a href="#l7.2129"></a><span id="l7.2129">         &lt;parameter name=&quot;aShadows&quot;/&gt;</span>
<a href="#l7.2130"></a><span id="l7.2130">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2131"></a><span id="l7.2131" class="difflineminus">-          let firstCol = this; // eslint-disable-line consistent-this</span>
<a href="#l7.2132"></a><span id="l7.2132" class="difflineminus">-          let lastCol = this; // eslint-disable-line consistent-this</span>
<a href="#l7.2133"></a><span id="l7.2133" class="difflineminus">-          let firstIndex = aOffset == null ? this.mDragState.offset : aOffset;</span>
<a href="#l7.2134"></a><span id="l7.2134" class="difflineminus">-          let lastIndex = firstIndex;</span>
<a href="#l7.2135"></a><span id="l7.2135" class="difflineminus">-          while (firstCol.previousSibling &amp;&amp; firstIndex &gt; 0) {</span>
<a href="#l7.2136"></a><span id="l7.2136" class="difflineminus">-              firstCol = firstCol.previousSibling;</span>
<a href="#l7.2137"></a><span id="l7.2137" class="difflineminus">-              firstIndex--;</span>
<a href="#l7.2138"></a><span id="l7.2138" class="difflineminus">-          }</span>
<a href="#l7.2139"></a><span id="l7.2139" class="difflineminus">-          let lastShadow = aShadows == null ? this.mDragState.shadows : aShadows;</span>
<a href="#l7.2140"></a><span id="l7.2140" class="difflineminus">-          while (lastCol.nextSibling &amp;&amp; lastIndex &lt; lastShadow - 1) {</span>
<a href="#l7.2141"></a><span id="l7.2141" class="difflineminus">-              lastCol = lastCol.nextSibling;</span>
<a href="#l7.2142"></a><span id="l7.2142" class="difflineminus">-              lastIndex++;</span>
<a href="#l7.2143"></a><span id="l7.2143" class="difflineminus">-          }</span>
<a href="#l7.2144"></a><span id="l7.2144" class="difflineminus">-</span>
<a href="#l7.2145"></a><span id="l7.2145" class="difflineminus">-          // returns first and last column with shadows that are visible in the</span>
<a href="#l7.2146"></a><span id="l7.2146" class="difflineminus">-          // week and the positions of these (visible) columns in the set of</span>
<a href="#l7.2147"></a><span id="l7.2147" class="difflineminus">-          // columns shadows of the occurrence</span>
<a href="#l7.2148"></a><span id="l7.2148" class="difflineminus">-          return {</span>
<a href="#l7.2149"></a><span id="l7.2149" class="difflineminus">-              firstCol: firstCol,</span>
<a href="#l7.2150"></a><span id="l7.2150" class="difflineminus">-              firstIndex: firstIndex,</span>
<a href="#l7.2151"></a><span id="l7.2151" class="difflineminus">-              lastCol: lastCol,</span>
<a href="#l7.2152"></a><span id="l7.2152" class="difflineminus">-              lastIndex: lastIndex</span>
<a href="#l7.2153"></a><span id="l7.2153" class="difflineminus">-          };</span>
<a href="#l7.2154"></a><span id="l7.2154" class="difflineplus">+            let firstCol = this; // eslint-disable-line consistent-this</span>
<a href="#l7.2155"></a><span id="l7.2155" class="difflineplus">+            let lastCol = this; // eslint-disable-line consistent-this</span>
<a href="#l7.2156"></a><span id="l7.2156" class="difflineplus">+            let firstIndex = aOffset == null ? this.mDragState.offset : aOffset;</span>
<a href="#l7.2157"></a><span id="l7.2157" class="difflineplus">+            let lastIndex = firstIndex;</span>
<a href="#l7.2158"></a><span id="l7.2158" class="difflineplus">+            while (firstCol.previousSibling &amp;&amp; firstIndex &gt; 0) {</span>
<a href="#l7.2159"></a><span id="l7.2159" class="difflineplus">+                firstCol = firstCol.previousSibling;</span>
<a href="#l7.2160"></a><span id="l7.2160" class="difflineplus">+                firstIndex--;</span>
<a href="#l7.2161"></a><span id="l7.2161" class="difflineplus">+            }</span>
<a href="#l7.2162"></a><span id="l7.2162" class="difflineplus">+            let lastShadow = aShadows == null ? this.mDragState.shadows : aShadows;</span>
<a href="#l7.2163"></a><span id="l7.2163" class="difflineplus">+            while (lastCol.nextSibling &amp;&amp; lastIndex &lt; lastShadow - 1) {</span>
<a href="#l7.2164"></a><span id="l7.2164" class="difflineplus">+                lastCol = lastCol.nextSibling;</span>
<a href="#l7.2165"></a><span id="l7.2165" class="difflineplus">+                lastIndex++;</span>
<a href="#l7.2166"></a><span id="l7.2166" class="difflineplus">+            }</span>
<a href="#l7.2167"></a><span id="l7.2167" class="difflineplus">+</span>
<a href="#l7.2168"></a><span id="l7.2168" class="difflineplus">+            // returns first and last column with shadows that are visible in the</span>
<a href="#l7.2169"></a><span id="l7.2169" class="difflineplus">+            // week and the positions of these (visible) columns in the set of</span>
<a href="#l7.2170"></a><span id="l7.2170" class="difflineplus">+            // columns shadows of the occurrence</span>
<a href="#l7.2171"></a><span id="l7.2171" class="difflineplus">+            return {</span>
<a href="#l7.2172"></a><span id="l7.2172" class="difflineplus">+                firstCol: firstCol,</span>
<a href="#l7.2173"></a><span id="l7.2173" class="difflineplus">+                firstIndex: firstIndex,</span>
<a href="#l7.2174"></a><span id="l7.2174" class="difflineplus">+                lastCol: lastCol,</span>
<a href="#l7.2175"></a><span id="l7.2175" class="difflineplus">+                lastIndex: lastIndex</span>
<a href="#l7.2176"></a><span id="l7.2176" class="difflineplus">+            };</span>
<a href="#l7.2177"></a><span id="l7.2177">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2178"></a><span id="l7.2178">       &lt;/method&gt;</span>
<a href="#l7.2179"></a><span id="l7.2179"> </span>
<a href="#l7.2180"></a><span id="l7.2180">       &lt;method name=&quot;updateShadowsBoxes&quot;&gt;</span>
<a href="#l7.2181"></a><span id="l7.2181">         &lt;parameter name=&quot;aStart&quot;/&gt;</span>
<a href="#l7.2182"></a><span id="l7.2182">         &lt;parameter name=&quot;aEnd&quot;/&gt;</span>
<a href="#l7.2183"></a><span id="l7.2183">         &lt;parameter name=&quot;aCurrentOffset&quot;/&gt;</span>
<a href="#l7.2184"></a><span id="l7.2184">         &lt;parameter name=&quot;aCurrentShadows&quot;/&gt;</span>
<a href="#l7.2185"></a><span id="l7.2185">         &lt;parameter name=&quot;aSizeattr&quot;/&gt;</span>
<a href="#l7.2186"></a><span id="l7.2186">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2187"></a><span id="l7.2187" class="difflineminus">-          let lateralColumns = this.firstLastShadowColumns(aCurrentOffset, aCurrentShadows);</span>
<a href="#l7.2188"></a><span id="l7.2188" class="difflineminus">-          let firstCol = lateralColumns.firstCol;</span>
<a href="#l7.2189"></a><span id="l7.2189" class="difflineminus">-          let firstIndex = lateralColumns.firstIndex;</span>
<a href="#l7.2190"></a><span id="l7.2190" class="difflineminus">-          let lastCol = lateralColumns.lastCol;</span>
<a href="#l7.2191"></a><span id="l7.2191" class="difflineminus">-          let lastIndex = lateralColumns.lastIndex;</span>
<a href="#l7.2192"></a><span id="l7.2192" class="difflineminus">-</span>
<a href="#l7.2193"></a><span id="l7.2193" class="difflineminus">-          // remove the first/last shadow when start/end time goes in the</span>
<a href="#l7.2194"></a><span id="l7.2194" class="difflineminus">-          // next/previous day. This happens when current offset is different</span>
<a href="#l7.2195"></a><span id="l7.2195" class="difflineminus">-          // from offset stored in mDragState</span>
<a href="#l7.2196"></a><span id="l7.2196" class="difflineminus">-          if (aCurrentOffset != null) {</span>
<a href="#l7.2197"></a><span id="l7.2197" class="difflineminus">-              if (this.mDragState.offset &gt; aCurrentOffset &amp;&amp; firstCol.previousSibling) {</span>
<a href="#l7.2198"></a><span id="l7.2198" class="difflineminus">-                  firstCol.previousSibling.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2199"></a><span id="l7.2199" class="difflineminus">-                  firstCol.previousSibling.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2200"></a><span id="l7.2200" class="difflineminus">-              }</span>
<a href="#l7.2201"></a><span id="l7.2201" class="difflineminus">-              let currentOffsetEndSide = aCurrentShadows - 1 - aCurrentOffset;</span>
<a href="#l7.2202"></a><span id="l7.2202" class="difflineminus">-              if ((this.mDragState.shadows - 1 - this.mDragState.offset) &gt; currentOffsetEndSide &amp;&amp;</span>
<a href="#l7.2203"></a><span id="l7.2203" class="difflineminus">-                   lastCol.nextSibling) {</span>
<a href="#l7.2204"></a><span id="l7.2204" class="difflineminus">-                  lastCol.nextSibling.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2205"></a><span id="l7.2205" class="difflineminus">-                  lastCol.nextSibling.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2206"></a><span id="l7.2206" class="difflineminus">-              }</span>
<a href="#l7.2207"></a><span id="l7.2207" class="difflineminus">-          }</span>
<a href="#l7.2208"></a><span id="l7.2208" class="difflineminus">-</span>
<a href="#l7.2209"></a><span id="l7.2209" class="difflineminus">-          // set shadow boxes size for every part of the occurrence</span>
<a href="#l7.2210"></a><span id="l7.2210" class="difflineminus">-          let firstShadowSize = (aCurrentShadows == 1 ? aEnd : this.mEndMin) - aStart;</span>
<a href="#l7.2211"></a><span id="l7.2211" class="difflineminus">-          let column = firstCol;</span>
<a href="#l7.2212"></a><span id="l7.2212" class="difflineminus">-          for (let i = firstIndex; column &amp;&amp; i &lt;= lastIndex; i++) {</span>
<a href="#l7.2213"></a><span id="l7.2213" class="difflineminus">-              column.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2214"></a><span id="l7.2214" class="difflineminus">-              column.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2215"></a><span id="l7.2215" class="difflineminus">-              if (i == 0) {</span>
<a href="#l7.2216"></a><span id="l7.2216" class="difflineminus">-                  // first shadow</span>
<a href="#l7.2217"></a><span id="l7.2217" class="difflineminus">-                  column.fgboxes.dragspacer.setAttribute(aSizeattr, aStart * column.mPixPerMin);</span>
<a href="#l7.2218"></a><span id="l7.2218" class="difflineminus">-                  column.fgboxes.dragbox.setAttribute(aSizeattr, firstShadowSize * column.mPixPerMin);</span>
<a href="#l7.2219"></a><span id="l7.2219" class="difflineminus">-              } else if (i == (aCurrentShadows - 1)) {</span>
<a href="#l7.2220"></a><span id="l7.2220" class="difflineminus">-                  // last shadow</span>
<a href="#l7.2221"></a><span id="l7.2221" class="difflineminus">-                  column.fgboxes.dragspacer.setAttribute(aSizeattr, 0);</span>
<a href="#l7.2222"></a><span id="l7.2222" class="difflineminus">-                  column.fgboxes.dragbox.setAttribute(aSizeattr, aEnd * column.mPixPerMin);</span>
<a href="#l7.2223"></a><span id="l7.2223" class="difflineminus">-              } else {</span>
<a href="#l7.2224"></a><span id="l7.2224" class="difflineminus">-                  // an intermediate shadow (full day)</span>
<a href="#l7.2225"></a><span id="l7.2225" class="difflineminus">-                  column.fgboxes.dragspacer.setAttribute(aSizeattr, 0);</span>
<a href="#l7.2226"></a><span id="l7.2226" class="difflineminus">-                  column.fgboxes.dragbox.setAttribute(aSizeattr, this.mEndMin * column.mPixPerMin);</span>
<a href="#l7.2227"></a><span id="l7.2227" class="difflineminus">-              }</span>
<a href="#l7.2228"></a><span id="l7.2228" class="difflineminus">-              column = column.nextSibling;</span>
<a href="#l7.2229"></a><span id="l7.2229" class="difflineminus">-          }</span>
<a href="#l7.2230"></a><span id="l7.2230" class="difflineplus">+            let lateralColumns = this.firstLastShadowColumns(aCurrentOffset, aCurrentShadows);</span>
<a href="#l7.2231"></a><span id="l7.2231" class="difflineplus">+            let firstCol = lateralColumns.firstCol;</span>
<a href="#l7.2232"></a><span id="l7.2232" class="difflineplus">+            let firstIndex = lateralColumns.firstIndex;</span>
<a href="#l7.2233"></a><span id="l7.2233" class="difflineplus">+            let lastCol = lateralColumns.lastCol;</span>
<a href="#l7.2234"></a><span id="l7.2234" class="difflineplus">+            let lastIndex = lateralColumns.lastIndex;</span>
<a href="#l7.2235"></a><span id="l7.2235" class="difflineplus">+</span>
<a href="#l7.2236"></a><span id="l7.2236" class="difflineplus">+            // remove the first/last shadow when start/end time goes in the</span>
<a href="#l7.2237"></a><span id="l7.2237" class="difflineplus">+            // next/previous day. This happens when current offset is different</span>
<a href="#l7.2238"></a><span id="l7.2238" class="difflineplus">+            // from offset stored in mDragState</span>
<a href="#l7.2239"></a><span id="l7.2239" class="difflineplus">+            if (aCurrentOffset != null) {</span>
<a href="#l7.2240"></a><span id="l7.2240" class="difflineplus">+                if (this.mDragState.offset &gt; aCurrentOffset &amp;&amp; firstCol.previousSibling) {</span>
<a href="#l7.2241"></a><span id="l7.2241" class="difflineplus">+                    firstCol.previousSibling.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2242"></a><span id="l7.2242" class="difflineplus">+                    firstCol.previousSibling.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2243"></a><span id="l7.2243" class="difflineplus">+                }</span>
<a href="#l7.2244"></a><span id="l7.2244" class="difflineplus">+                let currentOffsetEndSide = aCurrentShadows - 1 - aCurrentOffset;</span>
<a href="#l7.2245"></a><span id="l7.2245" class="difflineplus">+                if ((this.mDragState.shadows - 1 - this.mDragState.offset) &gt; currentOffsetEndSide &amp;&amp;</span>
<a href="#l7.2246"></a><span id="l7.2246" class="difflineplus">+                     lastCol.nextSibling) {</span>
<a href="#l7.2247"></a><span id="l7.2247" class="difflineplus">+                    lastCol.nextSibling.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2248"></a><span id="l7.2248" class="difflineplus">+                    lastCol.nextSibling.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2249"></a><span id="l7.2249" class="difflineplus">+                }</span>
<a href="#l7.2250"></a><span id="l7.2250" class="difflineplus">+            }</span>
<a href="#l7.2251"></a><span id="l7.2251" class="difflineplus">+</span>
<a href="#l7.2252"></a><span id="l7.2252" class="difflineplus">+            // set shadow boxes size for every part of the occurrence</span>
<a href="#l7.2253"></a><span id="l7.2253" class="difflineplus">+            let firstShadowSize = (aCurrentShadows == 1 ? aEnd : this.mEndMin) - aStart;</span>
<a href="#l7.2254"></a><span id="l7.2254" class="difflineplus">+            let column = firstCol;</span>
<a href="#l7.2255"></a><span id="l7.2255" class="difflineplus">+            for (let i = firstIndex; column &amp;&amp; i &lt;= lastIndex; i++) {</span>
<a href="#l7.2256"></a><span id="l7.2256" class="difflineplus">+                column.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2257"></a><span id="l7.2257" class="difflineplus">+                column.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2258"></a><span id="l7.2258" class="difflineplus">+                if (i == 0) {</span>
<a href="#l7.2259"></a><span id="l7.2259" class="difflineplus">+                    // first shadow</span>
<a href="#l7.2260"></a><span id="l7.2260" class="difflineplus">+                    column.fgboxes.dragspacer.setAttribute(aSizeattr, aStart * column.mPixPerMin);</span>
<a href="#l7.2261"></a><span id="l7.2261" class="difflineplus">+                    column.fgboxes.dragbox.setAttribute(aSizeattr, firstShadowSize * column.mPixPerMin);</span>
<a href="#l7.2262"></a><span id="l7.2262" class="difflineplus">+                } else if (i == (aCurrentShadows - 1)) {</span>
<a href="#l7.2263"></a><span id="l7.2263" class="difflineplus">+                    // last shadow</span>
<a href="#l7.2264"></a><span id="l7.2264" class="difflineplus">+                    column.fgboxes.dragspacer.setAttribute(aSizeattr, 0);</span>
<a href="#l7.2265"></a><span id="l7.2265" class="difflineplus">+                    column.fgboxes.dragbox.setAttribute(aSizeattr, aEnd * column.mPixPerMin);</span>
<a href="#l7.2266"></a><span id="l7.2266" class="difflineplus">+                } else {</span>
<a href="#l7.2267"></a><span id="l7.2267" class="difflineplus">+                    // an intermediate shadow (full day)</span>
<a href="#l7.2268"></a><span id="l7.2268" class="difflineplus">+                    column.fgboxes.dragspacer.setAttribute(aSizeattr, 0);</span>
<a href="#l7.2269"></a><span id="l7.2269" class="difflineplus">+                    column.fgboxes.dragbox.setAttribute(aSizeattr, this.mEndMin * column.mPixPerMin);</span>
<a href="#l7.2270"></a><span id="l7.2270" class="difflineplus">+                }</span>
<a href="#l7.2271"></a><span id="l7.2271" class="difflineplus">+                column = column.nextSibling;</span>
<a href="#l7.2272"></a><span id="l7.2272" class="difflineplus">+            }</span>
<a href="#l7.2273"></a><span id="l7.2273">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2274"></a><span id="l7.2274">       &lt;/method&gt;</span>
<a href="#l7.2275"></a><span id="l7.2275"> </span>
<a href="#l7.2276"></a><span id="l7.2276">       &lt;method name=&quot;onEventSweepKeypress&quot;&gt;</span>
<a href="#l7.2277"></a><span id="l7.2277">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l7.2278"></a><span id="l7.2278">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2279"></a><span id="l7.2279" class="difflineminus">-          let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2280"></a><span id="l7.2280" class="difflineminus">-          if (col &amp;&amp; event.keyCode == event.DOM_VK_ESCAPE) {</span>
<a href="#l7.2281"></a><span id="l7.2281" class="difflineminus">-              window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2282"></a><span id="l7.2282" class="difflineminus">-              window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2283"></a><span id="l7.2283" class="difflineminus">-              window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2284"></a><span id="l7.2284" class="difflineminus">-</span>
<a href="#l7.2285"></a><span id="l7.2285" class="difflineminus">-              let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2286"></a><span id="l7.2286" class="difflineminus">-              let column = lateralColumns.firstCol;</span>
<a href="#l7.2287"></a><span id="l7.2287" class="difflineminus">-              let index = lateralColumns.firstIndex;</span>
<a href="#l7.2288"></a><span id="l7.2288" class="difflineminus">-              while (column &amp;&amp; index &lt; col.mDragState.shadows) {</span>
<a href="#l7.2289"></a><span id="l7.2289" class="difflineminus">-                  column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2290"></a><span id="l7.2290" class="difflineminus">-                  column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2291"></a><span id="l7.2291" class="difflineminus">-                  column = column.nextSibling;</span>
<a href="#l7.2292"></a><span id="l7.2292" class="difflineminus">-                  index++;</span>
<a href="#l7.2293"></a><span id="l7.2293" class="difflineminus">-              }</span>
<a href="#l7.2294"></a><span id="l7.2294" class="difflineminus">-</span>
<a href="#l7.2295"></a><span id="l7.2295" class="difflineminus">-              col.mDragState = null;</span>
<a href="#l7.2296"></a><span id="l7.2296" class="difflineminus">-              document.calendarEventColumnDragging = null;</span>
<a href="#l7.2297"></a><span id="l7.2297" class="difflineminus">-          }</span>
<a href="#l7.2298"></a><span id="l7.2298" class="difflineplus">+            let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2299"></a><span id="l7.2299" class="difflineplus">+            if (col &amp;&amp; event.keyCode == event.DOM_VK_ESCAPE) {</span>
<a href="#l7.2300"></a><span id="l7.2300" class="difflineplus">+                window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2301"></a><span id="l7.2301" class="difflineplus">+                window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2302"></a><span id="l7.2302" class="difflineplus">+                window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2303"></a><span id="l7.2303" class="difflineplus">+</span>
<a href="#l7.2304"></a><span id="l7.2304" class="difflineplus">+                let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2305"></a><span id="l7.2305" class="difflineplus">+                let column = lateralColumns.firstCol;</span>
<a href="#l7.2306"></a><span id="l7.2306" class="difflineplus">+                let index = lateralColumns.firstIndex;</span>
<a href="#l7.2307"></a><span id="l7.2307" class="difflineplus">+                while (column &amp;&amp; index &lt; col.mDragState.shadows) {</span>
<a href="#l7.2308"></a><span id="l7.2308" class="difflineplus">+                    column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2309"></a><span id="l7.2309" class="difflineplus">+                    column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2310"></a><span id="l7.2310" class="difflineplus">+                    column = column.nextSibling;</span>
<a href="#l7.2311"></a><span id="l7.2311" class="difflineplus">+                    index++;</span>
<a href="#l7.2312"></a><span id="l7.2312" class="difflineplus">+                }</span>
<a href="#l7.2313"></a><span id="l7.2313" class="difflineplus">+</span>
<a href="#l7.2314"></a><span id="l7.2314" class="difflineplus">+                col.mDragState = null;</span>
<a href="#l7.2315"></a><span id="l7.2315" class="difflineplus">+                document.calendarEventColumnDragging = null;</span>
<a href="#l7.2316"></a><span id="l7.2316" class="difflineplus">+            }</span>
<a href="#l7.2317"></a><span id="l7.2317">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2318"></a><span id="l7.2318">       &lt;/method&gt;</span>
<a href="#l7.2319"></a><span id="l7.2319"> </span>
<a href="#l7.2320"></a><span id="l7.2320">       &lt;method name=&quot;clearMagicScroll&quot;&gt;</span>
<a href="#l7.2321"></a><span id="l7.2321">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2322"></a><span id="l7.2322" class="difflineminus">-          if (this.mMagicScrollTimer) {</span>
<a href="#l7.2323"></a><span id="l7.2323" class="difflineminus">-              clearTimeout(this.mMagicScrollTimer);</span>
<a href="#l7.2324"></a><span id="l7.2324" class="difflineminus">-              this.mMagicScrollTimer = null;</span>
<a href="#l7.2325"></a><span id="l7.2325" class="difflineminus">-          }</span>
<a href="#l7.2326"></a><span id="l7.2326" class="difflineplus">+            if (this.mMagicScrollTimer) {</span>
<a href="#l7.2327"></a><span id="l7.2327" class="difflineplus">+                clearTimeout(this.mMagicScrollTimer);</span>
<a href="#l7.2328"></a><span id="l7.2328" class="difflineplus">+                this.mMagicScrollTimer = null;</span>
<a href="#l7.2329"></a><span id="l7.2329" class="difflineplus">+            }</span>
<a href="#l7.2330"></a><span id="l7.2330">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2331"></a><span id="l7.2331">       &lt;/method&gt;</span>
<a href="#l7.2332"></a><span id="l7.2332"> </span>
<a href="#l7.2333"></a><span id="l7.2333">       &lt;method name=&quot;setupMagicScroll&quot;&gt;</span>
<a href="#l7.2334"></a><span id="l7.2334">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l7.2335"></a><span id="l7.2335">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2336"></a><span id="l7.2336" class="difflineminus">-          this.clearMagicScroll();</span>
<a href="#l7.2337"></a><span id="l7.2337" class="difflineminus">-</span>
<a href="#l7.2338"></a><span id="l7.2338" class="difflineminus">-          // If we are at the bottom or top of the view (or left/right when</span>
<a href="#l7.2339"></a><span id="l7.2339" class="difflineminus">-          // rotated), calculate the difference and start accelerating the</span>
<a href="#l7.2340"></a><span id="l7.2340" class="difflineminus">-          // scrollbar.</span>
<a href="#l7.2341"></a><span id="l7.2341" class="difflineminus">-          let diffStart, diffEnd;</span>
<a href="#l7.2342"></a><span id="l7.2342" class="difflineminus">-          let orient = event.target.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.2343"></a><span id="l7.2343" class="difflineminus">-          let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.2344"></a><span id="l7.2344" class="difflineminus">-                         event.target, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.2345"></a><span id="l7.2345" class="difflineminus">-          if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.2346"></a><span id="l7.2346" class="difflineminus">-              diffStart = event.clientY - scrollbox.boxObject.y;</span>
<a href="#l7.2347"></a><span id="l7.2347" class="difflineminus">-              diffEnd = scrollbox.boxObject.y + scrollbox.boxObject.height - event.clientY;</span>
<a href="#l7.2348"></a><span id="l7.2348" class="difflineminus">-          } else {</span>
<a href="#l7.2349"></a><span id="l7.2349" class="difflineminus">-              diffStart = event.clientX - scrollbox.boxObject.x;</span>
<a href="#l7.2350"></a><span id="l7.2350" class="difflineminus">-              diffEnd = scrollbox.boxObject.x + scrollbox.boxObject.width - event.clientX;</span>
<a href="#l7.2351"></a><span id="l7.2351" class="difflineminus">-          }</span>
<a href="#l7.2352"></a><span id="l7.2352" class="difflineminus">-</span>
<a href="#l7.2353"></a><span id="l7.2353" class="difflineminus">-          const SCROLLZONE = 55;     // Size (pixels) of the top/bottom view where the scroll starts.</span>
<a href="#l7.2354"></a><span id="l7.2354" class="difflineminus">-          const MAXTIMEOUT = 250;    // Max and min time interval (ms) between</span>
<a href="#l7.2355"></a><span id="l7.2355" class="difflineminus">-          const MINTIMEOUT = 30;     // two consecutive scrolls.</span>
<a href="#l7.2356"></a><span id="l7.2356" class="difflineminus">-          const SCROLLBYHOUR = 0.33; // Part of hour to move for each scroll.</span>
<a href="#l7.2357"></a><span id="l7.2357" class="difflineminus">-          let insideScrollZone = 0;</span>
<a href="#l7.2358"></a><span id="l7.2358" class="difflineminus">-          let pxPerHr = event.target.mPixPerMin * 60;</span>
<a href="#l7.2359"></a><span id="l7.2359" class="difflineminus">-          let scrollBy = Math.floor(pxPerHr * SCROLLBYHOUR);</span>
<a href="#l7.2360"></a><span id="l7.2360" class="difflineminus">-          if (diffStart &lt; SCROLLZONE) {</span>
<a href="#l7.2361"></a><span id="l7.2361" class="difflineminus">-              insideScrollZone = SCROLLZONE - diffStart;</span>
<a href="#l7.2362"></a><span id="l7.2362" class="difflineminus">-              scrollBy *= -1;</span>
<a href="#l7.2363"></a><span id="l7.2363" class="difflineminus">-          } else if (diffEnd &lt; SCROLLZONE) {</span>
<a href="#l7.2364"></a><span id="l7.2364" class="difflineminus">-              insideScrollZone = SCROLLZONE - diffEnd;</span>
<a href="#l7.2365"></a><span id="l7.2365" class="difflineminus">-          }</span>
<a href="#l7.2366"></a><span id="l7.2366" class="difflineminus">-</span>
<a href="#l7.2367"></a><span id="l7.2367" class="difflineminus">-          if (insideScrollZone) {</span>
<a href="#l7.2368"></a><span id="l7.2368" class="difflineminus">-              let sbo = scrollbox.boxObject;</span>
<a href="#l7.2369"></a><span id="l7.2369" class="difflineminus">-              let timeout = MAXTIMEOUT - insideScrollZone * (MAXTIMEOUT - MINTIMEOUT) / SCROLLZONE;</span>
<a href="#l7.2370"></a><span id="l7.2370" class="difflineminus">-              this.mMagicScrollTimer = setTimeout(() =&gt; {</span>
<a href="#l7.2371"></a><span id="l7.2371" class="difflineminus">-                  sbo.scrollBy(orient == &quot;horizontal&quot; &amp;&amp; scrollBy,</span>
<a href="#l7.2372"></a><span id="l7.2372" class="difflineminus">-                               orient == &quot;vertical&quot; &amp;&amp; scrollBy);</span>
<a href="#l7.2373"></a><span id="l7.2373" class="difflineminus">-                  this.onEventSweepMouseMove(event);</span>
<a href="#l7.2374"></a><span id="l7.2374" class="difflineminus">-              }, timeout);</span>
<a href="#l7.2375"></a><span id="l7.2375" class="difflineminus">-          }</span>
<a href="#l7.2376"></a><span id="l7.2376" class="difflineplus">+            this.clearMagicScroll();</span>
<a href="#l7.2377"></a><span id="l7.2377" class="difflineplus">+</span>
<a href="#l7.2378"></a><span id="l7.2378" class="difflineplus">+            // If we are at the bottom or top of the view (or left/right when</span>
<a href="#l7.2379"></a><span id="l7.2379" class="difflineplus">+            // rotated), calculate the difference and start accelerating the</span>
<a href="#l7.2380"></a><span id="l7.2380" class="difflineplus">+            // scrollbar.</span>
<a href="#l7.2381"></a><span id="l7.2381" class="difflineplus">+            let diffStart, diffEnd;</span>
<a href="#l7.2382"></a><span id="l7.2382" class="difflineplus">+            let orient = event.target.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.2383"></a><span id="l7.2383" class="difflineplus">+            let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.2384"></a><span id="l7.2384" class="difflineplus">+                           event.target, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.2385"></a><span id="l7.2385" class="difflineplus">+            if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.2386"></a><span id="l7.2386" class="difflineplus">+                diffStart = event.clientY - scrollbox.boxObject.y;</span>
<a href="#l7.2387"></a><span id="l7.2387" class="difflineplus">+                diffEnd = scrollbox.boxObject.y + scrollbox.boxObject.height - event.clientY;</span>
<a href="#l7.2388"></a><span id="l7.2388" class="difflineplus">+            } else {</span>
<a href="#l7.2389"></a><span id="l7.2389" class="difflineplus">+                diffStart = event.clientX - scrollbox.boxObject.x;</span>
<a href="#l7.2390"></a><span id="l7.2390" class="difflineplus">+                diffEnd = scrollbox.boxObject.x + scrollbox.boxObject.width - event.clientX;</span>
<a href="#l7.2391"></a><span id="l7.2391" class="difflineplus">+            }</span>
<a href="#l7.2392"></a><span id="l7.2392" class="difflineplus">+</span>
<a href="#l7.2393"></a><span id="l7.2393" class="difflineplus">+            const SCROLLZONE = 55;     // Size (pixels) of the top/bottom view where the scroll starts.</span>
<a href="#l7.2394"></a><span id="l7.2394" class="difflineplus">+            const MAXTIMEOUT = 250;    // Max and min time interval (ms) between</span>
<a href="#l7.2395"></a><span id="l7.2395" class="difflineplus">+            const MINTIMEOUT = 30;     // two consecutive scrolls.</span>
<a href="#l7.2396"></a><span id="l7.2396" class="difflineplus">+            const SCROLLBYHOUR = 0.33; // Part of hour to move for each scroll.</span>
<a href="#l7.2397"></a><span id="l7.2397" class="difflineplus">+            let insideScrollZone = 0;</span>
<a href="#l7.2398"></a><span id="l7.2398" class="difflineplus">+            let pxPerHr = event.target.mPixPerMin * 60;</span>
<a href="#l7.2399"></a><span id="l7.2399" class="difflineplus">+            let scrollBy = Math.floor(pxPerHr * SCROLLBYHOUR);</span>
<a href="#l7.2400"></a><span id="l7.2400" class="difflineplus">+            if (diffStart &lt; SCROLLZONE) {</span>
<a href="#l7.2401"></a><span id="l7.2401" class="difflineplus">+                insideScrollZone = SCROLLZONE - diffStart;</span>
<a href="#l7.2402"></a><span id="l7.2402" class="difflineplus">+                scrollBy *= -1;</span>
<a href="#l7.2403"></a><span id="l7.2403" class="difflineplus">+            } else if (diffEnd &lt; SCROLLZONE) {</span>
<a href="#l7.2404"></a><span id="l7.2404" class="difflineplus">+                insideScrollZone = SCROLLZONE - diffEnd;</span>
<a href="#l7.2405"></a><span id="l7.2405" class="difflineplus">+            }</span>
<a href="#l7.2406"></a><span id="l7.2406" class="difflineplus">+</span>
<a href="#l7.2407"></a><span id="l7.2407" class="difflineplus">+            if (insideScrollZone) {</span>
<a href="#l7.2408"></a><span id="l7.2408" class="difflineplus">+                let sbo = scrollbox.boxObject;</span>
<a href="#l7.2409"></a><span id="l7.2409" class="difflineplus">+                let timeout = MAXTIMEOUT - insideScrollZone * (MAXTIMEOUT - MINTIMEOUT) / SCROLLZONE;</span>
<a href="#l7.2410"></a><span id="l7.2410" class="difflineplus">+                this.mMagicScrollTimer = setTimeout(() =&gt; {</span>
<a href="#l7.2411"></a><span id="l7.2411" class="difflineplus">+                    sbo.scrollBy(orient == &quot;horizontal&quot; &amp;&amp; scrollBy,</span>
<a href="#l7.2412"></a><span id="l7.2412" class="difflineplus">+                                 orient == &quot;vertical&quot; &amp;&amp; scrollBy);</span>
<a href="#l7.2413"></a><span id="l7.2413" class="difflineplus">+                    this.onEventSweepMouseMove(event);</span>
<a href="#l7.2414"></a><span id="l7.2414" class="difflineplus">+                }, timeout);</span>
<a href="#l7.2415"></a><span id="l7.2415" class="difflineplus">+            }</span>
<a href="#l7.2416"></a><span id="l7.2416">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2417"></a><span id="l7.2417">       &lt;/method&gt;</span>
<a href="#l7.2418"></a><span id="l7.2418"> </span>
<a href="#l7.2419"></a><span id="l7.2419">       &lt;!--</span>
<a href="#l7.2420"></a><span id="l7.2420">          - Event sweep handlers</span>
<a href="#l7.2421"></a><span id="l7.2421">         --&gt;</span>
<a href="#l7.2422"></a><span id="l7.2422">       &lt;method name=&quot;onEventSweepMouseMove&quot;&gt;</span>
<a href="#l7.2423"></a><span id="l7.2423">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l7.2424"></a><span id="l7.2424">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2425"></a><span id="l7.2425" class="difflineminus">-          let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2426"></a><span id="l7.2426" class="difflineminus">-          if (!col) {</span>
<a href="#l7.2427"></a><span id="l7.2427" class="difflineminus">-              return;</span>
<a href="#l7.2428"></a><span id="l7.2428" class="difflineminus">-          }</span>
<a href="#l7.2429"></a><span id="l7.2429" class="difflineminus">-</span>
<a href="#l7.2430"></a><span id="l7.2430" class="difflineminus">-          col.setupMagicScroll(event);</span>
<a href="#l7.2431"></a><span id="l7.2431" class="difflineminus">-</span>
<a href="#l7.2432"></a><span id="l7.2432" class="difflineminus">-          let dragState = col.mDragState;</span>
<a href="#l7.2433"></a><span id="l7.2433" class="difflineminus">-</span>
<a href="#l7.2434"></a><span id="l7.2434" class="difflineminus">-          let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2435"></a><span id="l7.2435" class="difflineminus">-          let firstCol = lateralColumns.firstCol;</span>
<a href="#l7.2436"></a><span id="l7.2436" class="difflineminus">-          let firstIndex = lateralColumns.firstIndex;</span>
<a href="#l7.2437"></a><span id="l7.2437" class="difflineminus">-</span>
<a href="#l7.2438"></a><span id="l7.2438" class="difflineminus">-          // If we leave the view, then stop our internal sweeping and start a</span>
<a href="#l7.2439"></a><span id="l7.2439" class="difflineminus">-          // real drag session. Someday we need to fix the sweep to soely be a</span>
<a href="#l7.2440"></a><span id="l7.2440" class="difflineminus">-          // drag session, no sweeping.</span>
<a href="#l7.2441"></a><span id="l7.2441" class="difflineminus">-          if (event.clientX &lt; (event.target.boxObject.x) ||</span>
<a href="#l7.2442"></a><span id="l7.2442" class="difflineminus">-              event.clientX &gt; (event.target.boxObject.x + event.target.boxObject.width) ||</span>
<a href="#l7.2443"></a><span id="l7.2443" class="difflineminus">-              event.clientY &lt; (event.target.boxObject.y) ||</span>
<a href="#l7.2444"></a><span id="l7.2444" class="difflineminus">-              event.clientY &gt; (event.target.boxObject.y + event.target.boxObject.height)) {</span>
<a href="#l7.2445"></a><span id="l7.2445" class="difflineminus">-              // Remove the drag state</span>
<a href="#l7.2446"></a><span id="l7.2446" class="difflineminus">-              for (let column = firstCol, i = firstIndex;</span>
<a href="#l7.2447"></a><span id="l7.2447" class="difflineminus">-                   column &amp;&amp; i &lt; col.mDragState.shadows;</span>
<a href="#l7.2448"></a><span id="l7.2448" class="difflineminus">-                   column = column.nextSibling, i++) {</span>
<a href="#l7.2449"></a><span id="l7.2449" class="difflineminus">-                  column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2450"></a><span id="l7.2450" class="difflineminus">-                  column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2451"></a><span id="l7.2451" class="difflineminus">-              }</span>
<a href="#l7.2452"></a><span id="l7.2452" class="difflineminus">-</span>
<a href="#l7.2453"></a><span id="l7.2453" class="difflineminus">-              window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2454"></a><span id="l7.2454" class="difflineminus">-              window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2455"></a><span id="l7.2455" class="difflineminus">-              window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2456"></a><span id="l7.2456" class="difflineminus">-              document.calendarEventColumnDragging = null;</span>
<a href="#l7.2457"></a><span id="l7.2457" class="difflineminus">-              col.mDragState = null;</span>
<a href="#l7.2458"></a><span id="l7.2458" class="difflineminus">-</span>
<a href="#l7.2459"></a><span id="l7.2459" class="difflineminus">-              // the multiday view currently exhibits a less than optimal strategy</span>
<a href="#l7.2460"></a><span id="l7.2460" class="difflineminus">-              // in terms of item selection. items don't get automatically selected</span>
<a href="#l7.2461"></a><span id="l7.2461" class="difflineminus">-              // when clicked and dragged, as to differentiate inline editing from</span>
<a href="#l7.2462"></a><span id="l7.2462" class="difflineminus">-              // the act of selecting an event. but the application internal drop</span>
<a href="#l7.2463"></a><span id="l7.2463" class="difflineminus">-              // targets will ask for selected items in order to pull the data from</span>
<a href="#l7.2464"></a><span id="l7.2464" class="difflineminus">-              // the packets. that's why we need to make sure at least the currently</span>
<a href="#l7.2465"></a><span id="l7.2465" class="difflineminus">-              // dragged event is contained in the set of selected items.</span>
<a href="#l7.2466"></a><span id="l7.2466" class="difflineminus">-              let selectedItems = this.getSelectedItems({});</span>
<a href="#l7.2467"></a><span id="l7.2467" class="difflineminus">-              if (!selectedItems.some(aItem =&gt; aItem.hashId == item.hashId)) {</span>
<a href="#l7.2468"></a><span id="l7.2468" class="difflineminus">-                  col.calendarView.setSelectedItems(1,</span>
<a href="#l7.2469"></a><span id="l7.2469" class="difflineminus">-                      [event.ctrlKey ? item.parentItem : item]);</span>
<a href="#l7.2470"></a><span id="l7.2470" class="difflineminus">-              }</span>
<a href="#l7.2471"></a><span id="l7.2471" class="difflineminus">-              invokeEventDragSession(dragState.dragOccurrence, col);</span>
<a href="#l7.2472"></a><span id="l7.2472" class="difflineminus">-              return;</span>
<a href="#l7.2473"></a><span id="l7.2473" class="difflineminus">-          }</span>
<a href="#l7.2474"></a><span id="l7.2474" class="difflineminus">-</span>
<a href="#l7.2475"></a><span id="l7.2475" class="difflineminus">-          col.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2476"></a><span id="l7.2476" class="difflineminus">-          col.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2477"></a><span id="l7.2477" class="difflineminus">-          let minutesInDay = col.mEndMin - col.mStartMin;</span>
<a href="#l7.2478"></a><span id="l7.2478" class="difflineminus">-</span>
<a href="#l7.2479"></a><span id="l7.2479" class="difflineminus">-          // check if we need to jump a column</span>
<a href="#l7.2480"></a><span id="l7.2480" class="difflineminus">-          let jumpedColumns;</span>
<a href="#l7.2481"></a><span id="l7.2481" class="difflineminus">-          let newcol = col.calendarView.findColumnForClientPoint(event.screenX, event.screenY);</span>
<a href="#l7.2482"></a><span id="l7.2482" class="difflineminus">-          if (newcol &amp;&amp; newcol != col) {</span>
<a href="#l7.2483"></a><span id="l7.2483" class="difflineminus">-              // Find how many columns we are jumping by subtracting the dates.</span>
<a href="#l7.2484"></a><span id="l7.2484" class="difflineminus">-              let dur = newcol.mDate.subtractDate(col.mDate);</span>
<a href="#l7.2485"></a><span id="l7.2485" class="difflineminus">-              jumpedColumns = dur.days;</span>
<a href="#l7.2486"></a><span id="l7.2486" class="difflineminus">-              jumpedColumns *= dur.isNegative ? -1 : 1;</span>
<a href="#l7.2487"></a><span id="l7.2487" class="difflineminus">-              if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.2488"></a><span id="l7.2488" class="difflineminus">-                  // prevent dragging the start date after the end date in a new column</span>
<a href="#l7.2489"></a><span id="l7.2489" class="difflineminus">-                  if ((dragState.limitEndMin - minutesInDay * jumpedColumns) &lt; 0) {</span>
<a href="#l7.2490"></a><span id="l7.2490" class="difflineminus">-                      return;</span>
<a href="#l7.2491"></a><span id="l7.2491" class="difflineminus">-                  }</span>
<a href="#l7.2492"></a><span id="l7.2492" class="difflineminus">-                  dragState.limitEndMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2493"></a><span id="l7.2493" class="difflineminus">-              } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2494"></a><span id="l7.2494" class="difflineminus">-                  // prevent dragging the end date before the start date in a new column</span>
<a href="#l7.2495"></a><span id="l7.2495" class="difflineminus">-                  if ((dragState.limitStartMin - minutesInDay * jumpedColumns) &gt; minutesInDay) {</span>
<a href="#l7.2496"></a><span id="l7.2496" class="difflineminus">-                      return;</span>
<a href="#l7.2497"></a><span id="l7.2497" class="difflineminus">-                  }</span>
<a href="#l7.2498"></a><span id="l7.2498" class="difflineminus">-                  dragState.limitStartMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2499"></a><span id="l7.2499" class="difflineminus">-              } else if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2500"></a><span id="l7.2500" class="difflineminus">-                  dragState.limitEndMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2501"></a><span id="l7.2501" class="difflineminus">-                  dragState.limitStartMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2502"></a><span id="l7.2502" class="difflineminus">-                  dragState.jumpedColumns += jumpedColumns;</span>
<a href="#l7.2503"></a><span id="l7.2503" class="difflineminus">-              }</span>
<a href="#l7.2504"></a><span id="l7.2504" class="difflineminus">-              // kill our drag state</span>
<a href="#l7.2505"></a><span id="l7.2505" class="difflineminus">-              for (let column = firstCol, i = firstIndex;</span>
<a href="#l7.2506"></a><span id="l7.2506" class="difflineminus">-                   column &amp;&amp; i &lt; col.mDragState.shadows;</span>
<a href="#l7.2507"></a><span id="l7.2507" class="difflineminus">-                   column = column.nextSibling, i++) {</span>
<a href="#l7.2508"></a><span id="l7.2508" class="difflineminus">-                  column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2509"></a><span id="l7.2509" class="difflineminus">-                  column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2510"></a><span id="l7.2510" class="difflineminus">-              }</span>
<a href="#l7.2511"></a><span id="l7.2511" class="difflineminus">-</span>
<a href="#l7.2512"></a><span id="l7.2512" class="difflineminus">-              // jump ship</span>
<a href="#l7.2513"></a><span id="l7.2513" class="difflineminus">-              newcol.acceptInProgressSweep(dragState);</span>
<a href="#l7.2514"></a><span id="l7.2514" class="difflineminus">-</span>
<a href="#l7.2515"></a><span id="l7.2515" class="difflineminus">-              // restart event handling</span>
<a href="#l7.2516"></a><span id="l7.2516" class="difflineminus">-              col.onEventSweepMouseMove(event);</span>
<a href="#l7.2517"></a><span id="l7.2517" class="difflineminus">-</span>
<a href="#l7.2518"></a><span id="l7.2518" class="difflineminus">-              return;</span>
<a href="#l7.2519"></a><span id="l7.2519" class="difflineminus">-          }</span>
<a href="#l7.2520"></a><span id="l7.2520" class="difflineminus">-</span>
<a href="#l7.2521"></a><span id="l7.2521" class="difflineminus">-          let mousePos;</span>
<a href="#l7.2522"></a><span id="l7.2522" class="difflineminus">-          let sizeattr;</span>
<a href="#l7.2523"></a><span id="l7.2523" class="difflineminus">-          if (col.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.2524"></a><span id="l7.2524" class="difflineminus">-              mousePos = event.screenY - col.parentNode.boxObject.screenY;</span>
<a href="#l7.2525"></a><span id="l7.2525" class="difflineminus">-              sizeattr = &quot;height&quot;;</span>
<a href="#l7.2526"></a><span id="l7.2526" class="difflineminus">-          } else {</span>
<a href="#l7.2527"></a><span id="l7.2527" class="difflineminus">-              mousePos = event.screenX - col.parentNode.boxObject.screenX;</span>
<a href="#l7.2528"></a><span id="l7.2528" class="difflineminus">-              sizeattr = &quot;width&quot;;</span>
<a href="#l7.2529"></a><span id="l7.2529" class="difflineminus">-          }</span>
<a href="#l7.2530"></a><span id="l7.2530" class="difflineminus">-          // don't let mouse position go outside the window edges</span>
<a href="#l7.2531"></a><span id="l7.2531" class="difflineminus">-          let pos = Math.max(0, mousePos) - dragState.mouseOffset;</span>
<a href="#l7.2532"></a><span id="l7.2532" class="difflineminus">-</span>
<a href="#l7.2533"></a><span id="l7.2533" class="difflineminus">-          // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.2534"></a><span id="l7.2534" class="difflineminus">-          let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.2535"></a><span id="l7.2535" class="difflineminus">-                            !event.ctrlKey &amp;&amp;</span>
<a href="#l7.2536"></a><span id="l7.2536" class="difflineminus">-                            !event.altKey &amp;&amp;</span>
<a href="#l7.2537"></a><span id="l7.2537" class="difflineminus">-                            !event.metaKey) ? 1 : 15;</span>
<a href="#l7.2538"></a><span id="l7.2538" class="difflineminus">-          let interval = col.mPixPerMin * snapIntMin;</span>
<a href="#l7.2539"></a><span id="l7.2539" class="difflineminus">-          let curmin = Math.floor(pos / interval) * snapIntMin;</span>
<a href="#l7.2540"></a><span id="l7.2540" class="difflineminus">-          let deltamin = curmin - dragState.origMin;</span>
<a href="#l7.2541"></a><span id="l7.2541" class="difflineminus">-</span>
<a href="#l7.2542"></a><span id="l7.2542" class="difflineminus">-          let shadowElements;</span>
<a href="#l7.2543"></a><span id="l7.2543" class="difflineminus">-          if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2544"></a><span id="l7.2544" class="difflineminus">-              // Extend deltamin in a linear way over the columns</span>
<a href="#l7.2545"></a><span id="l7.2545" class="difflineminus">-              deltamin += minutesInDay * dragState.jumpedColumns;</span>
<a href="#l7.2546"></a><span id="l7.2546" class="difflineminus">-              if (deltamin &lt; 0) {</span>
<a href="#l7.2547"></a><span id="l7.2547" class="difflineminus">-                  // create a new event modifying the start. End time is fixed</span>
<a href="#l7.2548"></a><span id="l7.2548" class="difflineminus">-                  shadowElements = {</span>
<a href="#l7.2549"></a><span id="l7.2549" class="difflineminus">-                      shadows: 1 - dragState.jumpedColumns,</span>
<a href="#l7.2550"></a><span id="l7.2550" class="difflineminus">-                      offset: 0,</span>
<a href="#l7.2551"></a><span id="l7.2551" class="difflineminus">-                      startMin: curmin,</span>
<a href="#l7.2552"></a><span id="l7.2552" class="difflineminus">-                      endMin: dragState.origMin</span>
<a href="#l7.2553"></a><span id="l7.2553" class="difflineminus">-                  };</span>
<a href="#l7.2554"></a><span id="l7.2554" class="difflineminus">-              } else {</span>
<a href="#l7.2555"></a><span id="l7.2555" class="difflineminus">-                  // create a new event modifying the end. Start time is fixed</span>
<a href="#l7.2556"></a><span id="l7.2556" class="difflineminus">-                  shadowElements = {</span>
<a href="#l7.2557"></a><span id="l7.2557" class="difflineminus">-                      shadows: dragState.jumpedColumns + 1,</span>
<a href="#l7.2558"></a><span id="l7.2558" class="difflineminus">-                      offset: dragState.jumpedColumns,</span>
<a href="#l7.2559"></a><span id="l7.2559" class="difflineminus">-                      startMin: dragState.origMin,</span>
<a href="#l7.2560"></a><span id="l7.2560" class="difflineminus">-                      endMin: curmin</span>
<a href="#l7.2561"></a><span id="l7.2561" class="difflineminus">-                  };</span>
<a href="#l7.2562"></a><span id="l7.2562" class="difflineminus">-              }</span>
<a href="#l7.2563"></a><span id="l7.2563" class="difflineminus">-              dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2564"></a><span id="l7.2564" class="difflineminus">-              dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2565"></a><span id="l7.2565" class="difflineminus">-          } else if (dragState.dragType == &quot;move&quot;) {</span>
<a href="#l7.2566"></a><span id="l7.2566" class="difflineminus">-              // if we're moving, we modify startMin and endMin of the shadow.</span>
<a href="#l7.2567"></a><span id="l7.2567" class="difflineminus">-              shadowElements = col.getShadowElements(dragState.origMinStart + deltamin,</span>
<a href="#l7.2568"></a><span id="l7.2568" class="difflineminus">-                                                     dragState.origMinEnd + deltamin);</span>
<a href="#l7.2569"></a><span id="l7.2569" class="difflineminus">-              dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2570"></a><span id="l7.2570" class="difflineminus">-              dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2571"></a><span id="l7.2571" class="difflineminus">-              // Keep track of the last start position because it will help to</span>
<a href="#l7.2572"></a><span id="l7.2572" class="difflineminus">-              // build the event at the end of the drag session.</span>
<a href="#l7.2573"></a><span id="l7.2573" class="difflineminus">-              dragState.lastStart = dragState.origMinStart + deltamin;</span>
<a href="#l7.2574"></a><span id="l7.2574" class="difflineminus">-          } else if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.2575"></a><span id="l7.2575" class="difflineminus">-              // if we're modifying the start, the end time is fixed.</span>
<a href="#l7.2576"></a><span id="l7.2576" class="difflineminus">-              shadowElements = col.getShadowElements(dragState.origMin + deltamin, dragState.limitEndMin);</span>
<a href="#l7.2577"></a><span id="l7.2577" class="difflineminus">-              dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2578"></a><span id="l7.2578" class="difflineminus">-              dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2579"></a><span id="l7.2579" class="difflineminus">-</span>
<a href="#l7.2580"></a><span id="l7.2580" class="difflineminus">-              // but we need to not go past the end; if we hit</span>
<a href="#l7.2581"></a><span id="l7.2581" class="difflineminus">-              // the end, then we'll clamp to the previous snap interval minute</span>
<a href="#l7.2582"></a><span id="l7.2582" class="difflineminus">-              if (dragState.startMin &gt;= dragState.limitEndMin) {</span>
<a href="#l7.2583"></a><span id="l7.2583" class="difflineminus">-                  dragState.startMin = Math.ceil((dragState.limitEndMin - snapIntMin) / snapIntMin) * snapIntMin;</span>
<a href="#l7.2584"></a><span id="l7.2584" class="difflineminus">-              }</span>
<a href="#l7.2585"></a><span id="l7.2585" class="difflineminus">-          } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2586"></a><span id="l7.2586" class="difflineminus">-              // if we're modifying the end, the start time is fixed.</span>
<a href="#l7.2587"></a><span id="l7.2587" class="difflineminus">-              shadowElements = col.getShadowElements(dragState.limitStartMin, dragState.origMin + deltamin);</span>
<a href="#l7.2588"></a><span id="l7.2588" class="difflineminus">-              dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2589"></a><span id="l7.2589" class="difflineminus">-              dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2590"></a><span id="l7.2590" class="difflineminus">-</span>
<a href="#l7.2591"></a><span id="l7.2591" class="difflineminus">-              // but we need to not go past the start; if we hit</span>
<a href="#l7.2592"></a><span id="l7.2592" class="difflineminus">-              // the start, then we'll clamp to the next snap interval minute</span>
<a href="#l7.2593"></a><span id="l7.2593" class="difflineminus">-              if (dragState.endMin &lt;= dragState.limitStartMin) {</span>
<a href="#l7.2594"></a><span id="l7.2594" class="difflineminus">-                  dragState.endMin = Math.floor((dragState.limitStartMin + snapIntMin) / snapIntMin) * snapIntMin;</span>
<a href="#l7.2595"></a><span id="l7.2595" class="difflineminus">-              }</span>
<a href="#l7.2596"></a><span id="l7.2596" class="difflineminus">-          }</span>
<a href="#l7.2597"></a><span id="l7.2597" class="difflineminus">-          let currentOffset = shadowElements.offset;</span>
<a href="#l7.2598"></a><span id="l7.2598" class="difflineminus">-          let currentShadows = shadowElements.shadows;</span>
<a href="#l7.2599"></a><span id="l7.2599" class="difflineminus">-</span>
<a href="#l7.2600"></a><span id="l7.2600" class="difflineminus">-          // now we can update the shadow boxes position and size</span>
<a href="#l7.2601"></a><span id="l7.2601" class="difflineminus">-          col.updateShadowsBoxes(dragState.startMin, dragState.endMin,</span>
<a href="#l7.2602"></a><span id="l7.2602" class="difflineminus">-                                 currentOffset, currentShadows,</span>
<a href="#l7.2603"></a><span id="l7.2603" class="difflineminus">-                                 sizeattr);</span>
<a href="#l7.2604"></a><span id="l7.2604" class="difflineminus">-</span>
<a href="#l7.2605"></a><span id="l7.2605" class="difflineminus">-          // update the labels</span>
<a href="#l7.2606"></a><span id="l7.2606" class="difflineminus">-          lateralColumns = col.firstLastShadowColumns(currentOffset, currentShadows);</span>
<a href="#l7.2607"></a><span id="l7.2607" class="difflineminus">-          col.updateDragLabels(lateralColumns.firstCol, lateralColumns.lastCol);</span>
<a href="#l7.2608"></a><span id="l7.2608" class="difflineminus">-</span>
<a href="#l7.2609"></a><span id="l7.2609" class="difflineminus">-          col.mDragState.offset = currentOffset;</span>
<a href="#l7.2610"></a><span id="l7.2610" class="difflineminus">-          col.mDragState.shadows = currentShadows;</span>
<a href="#l7.2611"></a><span id="l7.2611" class="difflineplus">+            let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2612"></a><span id="l7.2612" class="difflineplus">+            if (!col) {</span>
<a href="#l7.2613"></a><span id="l7.2613" class="difflineplus">+                return;</span>
<a href="#l7.2614"></a><span id="l7.2614" class="difflineplus">+            }</span>
<a href="#l7.2615"></a><span id="l7.2615" class="difflineplus">+</span>
<a href="#l7.2616"></a><span id="l7.2616" class="difflineplus">+            col.setupMagicScroll(event);</span>
<a href="#l7.2617"></a><span id="l7.2617" class="difflineplus">+</span>
<a href="#l7.2618"></a><span id="l7.2618" class="difflineplus">+            let dragState = col.mDragState;</span>
<a href="#l7.2619"></a><span id="l7.2619" class="difflineplus">+</span>
<a href="#l7.2620"></a><span id="l7.2620" class="difflineplus">+            let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2621"></a><span id="l7.2621" class="difflineplus">+            let firstCol = lateralColumns.firstCol;</span>
<a href="#l7.2622"></a><span id="l7.2622" class="difflineplus">+            let firstIndex = lateralColumns.firstIndex;</span>
<a href="#l7.2623"></a><span id="l7.2623" class="difflineplus">+</span>
<a href="#l7.2624"></a><span id="l7.2624" class="difflineplus">+            // If we leave the view, then stop our internal sweeping and start a</span>
<a href="#l7.2625"></a><span id="l7.2625" class="difflineplus">+            // real drag session. Someday we need to fix the sweep to soely be a</span>
<a href="#l7.2626"></a><span id="l7.2626" class="difflineplus">+            // drag session, no sweeping.</span>
<a href="#l7.2627"></a><span id="l7.2627" class="difflineplus">+            if (event.clientX &lt; (event.target.boxObject.x) ||</span>
<a href="#l7.2628"></a><span id="l7.2628" class="difflineplus">+                event.clientX &gt; (event.target.boxObject.x + event.target.boxObject.width) ||</span>
<a href="#l7.2629"></a><span id="l7.2629" class="difflineplus">+                event.clientY &lt; (event.target.boxObject.y) ||</span>
<a href="#l7.2630"></a><span id="l7.2630" class="difflineplus">+                event.clientY &gt; (event.target.boxObject.y + event.target.boxObject.height)) {</span>
<a href="#l7.2631"></a><span id="l7.2631" class="difflineplus">+                // Remove the drag state</span>
<a href="#l7.2632"></a><span id="l7.2632" class="difflineplus">+                for (let column = firstCol, i = firstIndex;</span>
<a href="#l7.2633"></a><span id="l7.2633" class="difflineplus">+                     column &amp;&amp; i &lt; col.mDragState.shadows;</span>
<a href="#l7.2634"></a><span id="l7.2634" class="difflineplus">+                     column = column.nextSibling, i++) {</span>
<a href="#l7.2635"></a><span id="l7.2635" class="difflineplus">+                    column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2636"></a><span id="l7.2636" class="difflineplus">+                    column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2637"></a><span id="l7.2637" class="difflineplus">+                }</span>
<a href="#l7.2638"></a><span id="l7.2638" class="difflineplus">+</span>
<a href="#l7.2639"></a><span id="l7.2639" class="difflineplus">+                window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2640"></a><span id="l7.2640" class="difflineplus">+                window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2641"></a><span id="l7.2641" class="difflineplus">+                window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2642"></a><span id="l7.2642" class="difflineplus">+                document.calendarEventColumnDragging = null;</span>
<a href="#l7.2643"></a><span id="l7.2643" class="difflineplus">+                col.mDragState = null;</span>
<a href="#l7.2644"></a><span id="l7.2644" class="difflineplus">+</span>
<a href="#l7.2645"></a><span id="l7.2645" class="difflineplus">+                // the multiday view currently exhibits a less than optimal strategy</span>
<a href="#l7.2646"></a><span id="l7.2646" class="difflineplus">+                // in terms of item selection. items don't get automatically selected</span>
<a href="#l7.2647"></a><span id="l7.2647" class="difflineplus">+                // when clicked and dragged, as to differentiate inline editing from</span>
<a href="#l7.2648"></a><span id="l7.2648" class="difflineplus">+                // the act of selecting an event. but the application internal drop</span>
<a href="#l7.2649"></a><span id="l7.2649" class="difflineplus">+                // targets will ask for selected items in order to pull the data from</span>
<a href="#l7.2650"></a><span id="l7.2650" class="difflineplus">+                // the packets. that's why we need to make sure at least the currently</span>
<a href="#l7.2651"></a><span id="l7.2651" class="difflineplus">+                // dragged event is contained in the set of selected items.</span>
<a href="#l7.2652"></a><span id="l7.2652" class="difflineplus">+                let selectedItems = this.getSelectedItems({});</span>
<a href="#l7.2653"></a><span id="l7.2653" class="difflineplus">+                if (!selectedItems.some(aItem =&gt; aItem.hashId == item.hashId)) {</span>
<a href="#l7.2654"></a><span id="l7.2654" class="difflineplus">+                    col.calendarView.setSelectedItems(1,</span>
<a href="#l7.2655"></a><span id="l7.2655" class="difflineplus">+                        [event.ctrlKey ? item.parentItem : item]);</span>
<a href="#l7.2656"></a><span id="l7.2656" class="difflineplus">+                }</span>
<a href="#l7.2657"></a><span id="l7.2657" class="difflineplus">+                invokeEventDragSession(dragState.dragOccurrence, col);</span>
<a href="#l7.2658"></a><span id="l7.2658" class="difflineplus">+                return;</span>
<a href="#l7.2659"></a><span id="l7.2659" class="difflineplus">+            }</span>
<a href="#l7.2660"></a><span id="l7.2660" class="difflineplus">+</span>
<a href="#l7.2661"></a><span id="l7.2661" class="difflineplus">+            col.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2662"></a><span id="l7.2662" class="difflineplus">+            col.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.2663"></a><span id="l7.2663" class="difflineplus">+            let minutesInDay = col.mEndMin - col.mStartMin;</span>
<a href="#l7.2664"></a><span id="l7.2664" class="difflineplus">+</span>
<a href="#l7.2665"></a><span id="l7.2665" class="difflineplus">+            // check if we need to jump a column</span>
<a href="#l7.2666"></a><span id="l7.2666" class="difflineplus">+            let jumpedColumns;</span>
<a href="#l7.2667"></a><span id="l7.2667" class="difflineplus">+            let newcol = col.calendarView.findColumnForClientPoint(event.screenX, event.screenY);</span>
<a href="#l7.2668"></a><span id="l7.2668" class="difflineplus">+            if (newcol &amp;&amp; newcol != col) {</span>
<a href="#l7.2669"></a><span id="l7.2669" class="difflineplus">+                // Find how many columns we are jumping by subtracting the dates.</span>
<a href="#l7.2670"></a><span id="l7.2670" class="difflineplus">+                let dur = newcol.mDate.subtractDate(col.mDate);</span>
<a href="#l7.2671"></a><span id="l7.2671" class="difflineplus">+                jumpedColumns = dur.days;</span>
<a href="#l7.2672"></a><span id="l7.2672" class="difflineplus">+                jumpedColumns *= dur.isNegative ? -1 : 1;</span>
<a href="#l7.2673"></a><span id="l7.2673" class="difflineplus">+                if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.2674"></a><span id="l7.2674" class="difflineplus">+                    // prevent dragging the start date after the end date in a new column</span>
<a href="#l7.2675"></a><span id="l7.2675" class="difflineplus">+                    if ((dragState.limitEndMin - minutesInDay * jumpedColumns) &lt; 0) {</span>
<a href="#l7.2676"></a><span id="l7.2676" class="difflineplus">+                        return;</span>
<a href="#l7.2677"></a><span id="l7.2677" class="difflineplus">+                    }</span>
<a href="#l7.2678"></a><span id="l7.2678" class="difflineplus">+                    dragState.limitEndMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2679"></a><span id="l7.2679" class="difflineplus">+                } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2680"></a><span id="l7.2680" class="difflineplus">+                    // prevent dragging the end date before the start date in a new column</span>
<a href="#l7.2681"></a><span id="l7.2681" class="difflineplus">+                    if ((dragState.limitStartMin - minutesInDay * jumpedColumns) &gt; minutesInDay) {</span>
<a href="#l7.2682"></a><span id="l7.2682" class="difflineplus">+                        return;</span>
<a href="#l7.2683"></a><span id="l7.2683" class="difflineplus">+                    }</span>
<a href="#l7.2684"></a><span id="l7.2684" class="difflineplus">+                    dragState.limitStartMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2685"></a><span id="l7.2685" class="difflineplus">+                } else if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2686"></a><span id="l7.2686" class="difflineplus">+                    dragState.limitEndMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2687"></a><span id="l7.2687" class="difflineplus">+                    dragState.limitStartMin -= minutesInDay * jumpedColumns;</span>
<a href="#l7.2688"></a><span id="l7.2688" class="difflineplus">+                    dragState.jumpedColumns += jumpedColumns;</span>
<a href="#l7.2689"></a><span id="l7.2689" class="difflineplus">+                }</span>
<a href="#l7.2690"></a><span id="l7.2690" class="difflineplus">+                // kill our drag state</span>
<a href="#l7.2691"></a><span id="l7.2691" class="difflineplus">+                for (let column = firstCol, i = firstIndex;</span>
<a href="#l7.2692"></a><span id="l7.2692" class="difflineplus">+                     column &amp;&amp; i &lt; col.mDragState.shadows;</span>
<a href="#l7.2693"></a><span id="l7.2693" class="difflineplus">+                     column = column.nextSibling, i++) {</span>
<a href="#l7.2694"></a><span id="l7.2694" class="difflineplus">+                    column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2695"></a><span id="l7.2695" class="difflineplus">+                    column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2696"></a><span id="l7.2696" class="difflineplus">+                }</span>
<a href="#l7.2697"></a><span id="l7.2697" class="difflineplus">+</span>
<a href="#l7.2698"></a><span id="l7.2698" class="difflineplus">+                // jump ship</span>
<a href="#l7.2699"></a><span id="l7.2699" class="difflineplus">+                newcol.acceptInProgressSweep(dragState);</span>
<a href="#l7.2700"></a><span id="l7.2700" class="difflineplus">+</span>
<a href="#l7.2701"></a><span id="l7.2701" class="difflineplus">+                // restart event handling</span>
<a href="#l7.2702"></a><span id="l7.2702" class="difflineplus">+                col.onEventSweepMouseMove(event);</span>
<a href="#l7.2703"></a><span id="l7.2703" class="difflineplus">+</span>
<a href="#l7.2704"></a><span id="l7.2704" class="difflineplus">+                return;</span>
<a href="#l7.2705"></a><span id="l7.2705" class="difflineplus">+            }</span>
<a href="#l7.2706"></a><span id="l7.2706" class="difflineplus">+</span>
<a href="#l7.2707"></a><span id="l7.2707" class="difflineplus">+            let mousePos;</span>
<a href="#l7.2708"></a><span id="l7.2708" class="difflineplus">+            let sizeattr;</span>
<a href="#l7.2709"></a><span id="l7.2709" class="difflineplus">+            if (col.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.2710"></a><span id="l7.2710" class="difflineplus">+                mousePos = event.screenY - col.parentNode.boxObject.screenY;</span>
<a href="#l7.2711"></a><span id="l7.2711" class="difflineplus">+                sizeattr = &quot;height&quot;;</span>
<a href="#l7.2712"></a><span id="l7.2712" class="difflineplus">+            } else {</span>
<a href="#l7.2713"></a><span id="l7.2713" class="difflineplus">+                mousePos = event.screenX - col.parentNode.boxObject.screenX;</span>
<a href="#l7.2714"></a><span id="l7.2714" class="difflineplus">+                sizeattr = &quot;width&quot;;</span>
<a href="#l7.2715"></a><span id="l7.2715" class="difflineplus">+            }</span>
<a href="#l7.2716"></a><span id="l7.2716" class="difflineplus">+            // don't let mouse position go outside the window edges</span>
<a href="#l7.2717"></a><span id="l7.2717" class="difflineplus">+            let pos = Math.max(0, mousePos) - dragState.mouseOffset;</span>
<a href="#l7.2718"></a><span id="l7.2718" class="difflineplus">+</span>
<a href="#l7.2719"></a><span id="l7.2719" class="difflineplus">+            // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.2720"></a><span id="l7.2720" class="difflineplus">+            let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.2721"></a><span id="l7.2721" class="difflineplus">+                              !event.ctrlKey &amp;&amp;</span>
<a href="#l7.2722"></a><span id="l7.2722" class="difflineplus">+                              !event.altKey &amp;&amp;</span>
<a href="#l7.2723"></a><span id="l7.2723" class="difflineplus">+                              !event.metaKey) ? 1 : 15;</span>
<a href="#l7.2724"></a><span id="l7.2724" class="difflineplus">+            let interval = col.mPixPerMin * snapIntMin;</span>
<a href="#l7.2725"></a><span id="l7.2725" class="difflineplus">+            let curmin = Math.floor(pos / interval) * snapIntMin;</span>
<a href="#l7.2726"></a><span id="l7.2726" class="difflineplus">+            let deltamin = curmin - dragState.origMin;</span>
<a href="#l7.2727"></a><span id="l7.2727" class="difflineplus">+</span>
<a href="#l7.2728"></a><span id="l7.2728" class="difflineplus">+            let shadowElements;</span>
<a href="#l7.2729"></a><span id="l7.2729" class="difflineplus">+            if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2730"></a><span id="l7.2730" class="difflineplus">+                // Extend deltamin in a linear way over the columns</span>
<a href="#l7.2731"></a><span id="l7.2731" class="difflineplus">+                deltamin += minutesInDay * dragState.jumpedColumns;</span>
<a href="#l7.2732"></a><span id="l7.2732" class="difflineplus">+                if (deltamin &lt; 0) {</span>
<a href="#l7.2733"></a><span id="l7.2733" class="difflineplus">+                    // create a new event modifying the start. End time is fixed</span>
<a href="#l7.2734"></a><span id="l7.2734" class="difflineplus">+                    shadowElements = {</span>
<a href="#l7.2735"></a><span id="l7.2735" class="difflineplus">+                        shadows: 1 - dragState.jumpedColumns,</span>
<a href="#l7.2736"></a><span id="l7.2736" class="difflineplus">+                        offset: 0,</span>
<a href="#l7.2737"></a><span id="l7.2737" class="difflineplus">+                        startMin: curmin,</span>
<a href="#l7.2738"></a><span id="l7.2738" class="difflineplus">+                        endMin: dragState.origMin</span>
<a href="#l7.2739"></a><span id="l7.2739" class="difflineplus">+                    };</span>
<a href="#l7.2740"></a><span id="l7.2740" class="difflineplus">+                } else {</span>
<a href="#l7.2741"></a><span id="l7.2741" class="difflineplus">+                    // create a new event modifying the end. Start time is fixed</span>
<a href="#l7.2742"></a><span id="l7.2742" class="difflineplus">+                    shadowElements = {</span>
<a href="#l7.2743"></a><span id="l7.2743" class="difflineplus">+                        shadows: dragState.jumpedColumns + 1,</span>
<a href="#l7.2744"></a><span id="l7.2744" class="difflineplus">+                        offset: dragState.jumpedColumns,</span>
<a href="#l7.2745"></a><span id="l7.2745" class="difflineplus">+                        startMin: dragState.origMin,</span>
<a href="#l7.2746"></a><span id="l7.2746" class="difflineplus">+                        endMin: curmin</span>
<a href="#l7.2747"></a><span id="l7.2747" class="difflineplus">+                    };</span>
<a href="#l7.2748"></a><span id="l7.2748" class="difflineplus">+                }</span>
<a href="#l7.2749"></a><span id="l7.2749" class="difflineplus">+                dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2750"></a><span id="l7.2750" class="difflineplus">+                dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2751"></a><span id="l7.2751" class="difflineplus">+            } else if (dragState.dragType == &quot;move&quot;) {</span>
<a href="#l7.2752"></a><span id="l7.2752" class="difflineplus">+                // if we're moving, we modify startMin and endMin of the shadow.</span>
<a href="#l7.2753"></a><span id="l7.2753" class="difflineplus">+                shadowElements = col.getShadowElements(dragState.origMinStart + deltamin,</span>
<a href="#l7.2754"></a><span id="l7.2754" class="difflineplus">+                                                       dragState.origMinEnd + deltamin);</span>
<a href="#l7.2755"></a><span id="l7.2755" class="difflineplus">+                dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2756"></a><span id="l7.2756" class="difflineplus">+                dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2757"></a><span id="l7.2757" class="difflineplus">+                // Keep track of the last start position because it will help to</span>
<a href="#l7.2758"></a><span id="l7.2758" class="difflineplus">+                // build the event at the end of the drag session.</span>
<a href="#l7.2759"></a><span id="l7.2759" class="difflineplus">+                dragState.lastStart = dragState.origMinStart + deltamin;</span>
<a href="#l7.2760"></a><span id="l7.2760" class="difflineplus">+            } else if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.2761"></a><span id="l7.2761" class="difflineplus">+                // if we're modifying the start, the end time is fixed.</span>
<a href="#l7.2762"></a><span id="l7.2762" class="difflineplus">+                shadowElements = col.getShadowElements(dragState.origMin + deltamin, dragState.limitEndMin);</span>
<a href="#l7.2763"></a><span id="l7.2763" class="difflineplus">+                dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2764"></a><span id="l7.2764" class="difflineplus">+                dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2765"></a><span id="l7.2765" class="difflineplus">+</span>
<a href="#l7.2766"></a><span id="l7.2766" class="difflineplus">+                // but we need to not go past the end; if we hit</span>
<a href="#l7.2767"></a><span id="l7.2767" class="difflineplus">+                // the end, then we'll clamp to the previous snap interval minute</span>
<a href="#l7.2768"></a><span id="l7.2768" class="difflineplus">+                if (dragState.startMin &gt;= dragState.limitEndMin) {</span>
<a href="#l7.2769"></a><span id="l7.2769" class="difflineplus">+                    dragState.startMin = Math.ceil((dragState.limitEndMin - snapIntMin) / snapIntMin) * snapIntMin;</span>
<a href="#l7.2770"></a><span id="l7.2770" class="difflineplus">+                }</span>
<a href="#l7.2771"></a><span id="l7.2771" class="difflineplus">+            } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2772"></a><span id="l7.2772" class="difflineplus">+                // if we're modifying the end, the start time is fixed.</span>
<a href="#l7.2773"></a><span id="l7.2773" class="difflineplus">+                shadowElements = col.getShadowElements(dragState.limitStartMin, dragState.origMin + deltamin);</span>
<a href="#l7.2774"></a><span id="l7.2774" class="difflineplus">+                dragState.startMin = shadowElements.startMin;</span>
<a href="#l7.2775"></a><span id="l7.2775" class="difflineplus">+                dragState.endMin = shadowElements.endMin;</span>
<a href="#l7.2776"></a><span id="l7.2776" class="difflineplus">+</span>
<a href="#l7.2777"></a><span id="l7.2777" class="difflineplus">+                // but we need to not go past the start; if we hit</span>
<a href="#l7.2778"></a><span id="l7.2778" class="difflineplus">+                // the start, then we'll clamp to the next snap interval minute</span>
<a href="#l7.2779"></a><span id="l7.2779" class="difflineplus">+                if (dragState.endMin &lt;= dragState.limitStartMin) {</span>
<a href="#l7.2780"></a><span id="l7.2780" class="difflineplus">+                    dragState.endMin = Math.floor((dragState.limitStartMin + snapIntMin) / snapIntMin) * snapIntMin;</span>
<a href="#l7.2781"></a><span id="l7.2781" class="difflineplus">+                }</span>
<a href="#l7.2782"></a><span id="l7.2782" class="difflineplus">+            }</span>
<a href="#l7.2783"></a><span id="l7.2783" class="difflineplus">+            let currentOffset = shadowElements.offset;</span>
<a href="#l7.2784"></a><span id="l7.2784" class="difflineplus">+            let currentShadows = shadowElements.shadows;</span>
<a href="#l7.2785"></a><span id="l7.2785" class="difflineplus">+</span>
<a href="#l7.2786"></a><span id="l7.2786" class="difflineplus">+            // now we can update the shadow boxes position and size</span>
<a href="#l7.2787"></a><span id="l7.2787" class="difflineplus">+            col.updateShadowsBoxes(dragState.startMin, dragState.endMin,</span>
<a href="#l7.2788"></a><span id="l7.2788" class="difflineplus">+                                   currentOffset, currentShadows,</span>
<a href="#l7.2789"></a><span id="l7.2789" class="difflineplus">+                                   sizeattr);</span>
<a href="#l7.2790"></a><span id="l7.2790" class="difflineplus">+</span>
<a href="#l7.2791"></a><span id="l7.2791" class="difflineplus">+            // update the labels</span>
<a href="#l7.2792"></a><span id="l7.2792" class="difflineplus">+            lateralColumns = col.firstLastShadowColumns(currentOffset, currentShadows);</span>
<a href="#l7.2793"></a><span id="l7.2793" class="difflineplus">+            col.updateDragLabels(lateralColumns.firstCol, lateralColumns.lastCol);</span>
<a href="#l7.2794"></a><span id="l7.2794" class="difflineplus">+</span>
<a href="#l7.2795"></a><span id="l7.2795" class="difflineplus">+            col.mDragState.offset = currentOffset;</span>
<a href="#l7.2796"></a><span id="l7.2796" class="difflineplus">+            col.mDragState.shadows = currentShadows;</span>
<a href="#l7.2797"></a><span id="l7.2797">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.2798"></a><span id="l7.2798">       &lt;/method&gt;</span>
<a href="#l7.2799"></a><span id="l7.2799"> </span>
<a href="#l7.2800"></a><span id="l7.2800">       &lt;method name=&quot;onEventSweepMouseUp&quot;&gt;</span>
<a href="#l7.2801"></a><span id="l7.2801">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l7.2802"></a><span id="l7.2802">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.2803"></a><span id="l7.2803" class="difflineminus">-          let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2804"></a><span id="l7.2804" class="difflineminus">-          if (!col) {</span>
<a href="#l7.2805"></a><span id="l7.2805" class="difflineminus">-              return;</span>
<a href="#l7.2806"></a><span id="l7.2806" class="difflineminus">-          }</span>
<a href="#l7.2807"></a><span id="l7.2807" class="difflineminus">-</span>
<a href="#l7.2808"></a><span id="l7.2808" class="difflineminus">-          let dragState = col.mDragState;</span>
<a href="#l7.2809"></a><span id="l7.2809" class="difflineminus">-</span>
<a href="#l7.2810"></a><span id="l7.2810" class="difflineminus">-          let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2811"></a><span id="l7.2811" class="difflineminus">-          let column = lateralColumns.firstCol;</span>
<a href="#l7.2812"></a><span id="l7.2812" class="difflineminus">-          let index = lateralColumns.firstIndex;</span>
<a href="#l7.2813"></a><span id="l7.2813" class="difflineminus">-          while (column &amp;&amp; index &lt; dragState.shadows) {</span>
<a href="#l7.2814"></a><span id="l7.2814" class="difflineminus">-              column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2815"></a><span id="l7.2815" class="difflineminus">-              column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2816"></a><span id="l7.2816" class="difflineminus">-              column = column.nextSibling;</span>
<a href="#l7.2817"></a><span id="l7.2817" class="difflineminus">-              index++;</span>
<a href="#l7.2818"></a><span id="l7.2818" class="difflineminus">-          }</span>
<a href="#l7.2819"></a><span id="l7.2819" class="difflineminus">-</span>
<a href="#l7.2820"></a><span id="l7.2820" class="difflineminus">-          col.clearMagicScroll();</span>
<a href="#l7.2821"></a><span id="l7.2821" class="difflineminus">-</span>
<a href="#l7.2822"></a><span id="l7.2822" class="difflineminus">-          window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2823"></a><span id="l7.2823" class="difflineminus">-          window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2824"></a><span id="l7.2824" class="difflineminus">-          window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2825"></a><span id="l7.2825" class="difflineminus">-</span>
<a href="#l7.2826"></a><span id="l7.2826" class="difflineminus">-          document.calendarEventColumnDragging = null;</span>
<a href="#l7.2827"></a><span id="l7.2827" class="difflineminus">-</span>
<a href="#l7.2828"></a><span id="l7.2828" class="difflineminus">-          // if the user didn't sweep out at least a few pixels, ignore</span>
<a href="#l7.2829"></a><span id="l7.2829" class="difflineminus">-          // unless we're in a different column</span>
<a href="#l7.2830"></a><span id="l7.2830" class="difflineminus">-          if (dragState.origColumn == col) {</span>
<a href="#l7.2831"></a><span id="l7.2831" class="difflineminus">-              let ignore = false;</span>
<a href="#l7.2832"></a><span id="l7.2832" class="difflineminus">-              let orient = col.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.2833"></a><span id="l7.2833" class="difflineminus">-              let position = orient == &quot;vertical&quot; ? event.screenY : event.screenX;</span>
<a href="#l7.2834"></a><span id="l7.2834" class="difflineminus">-              if (Math.abs(position - dragState.origLoc) &lt; 3) {</span>
<a href="#l7.2835"></a><span id="l7.2835" class="difflineminus">-                  ignore = true;</span>
<a href="#l7.2836"></a><span id="l7.2836" class="difflineminus">-              }</span>
<a href="#l7.2837"></a><span id="l7.2837" class="difflineminus">-</span>
<a href="#l7.2838"></a><span id="l7.2838" class="difflineminus">-              if (ignore) {</span>
<a href="#l7.2839"></a><span id="l7.2839" class="difflineminus">-                  col.mDragState = null;</span>
<a href="#l7.2840"></a><span id="l7.2840" class="difflineminus">-                  return;</span>
<a href="#l7.2841"></a><span id="l7.2841" class="difflineminus">-              }</span>
<a href="#l7.2842"></a><span id="l7.2842" class="difflineminus">-          }</span>
<a href="#l7.2843"></a><span id="l7.2843" class="difflineminus">-</span>
<a href="#l7.2844"></a><span id="l7.2844" class="difflineminus">-          let newStart;</span>
<a href="#l7.2845"></a><span id="l7.2845" class="difflineminus">-          let newEnd;</span>
<a href="#l7.2846"></a><span id="l7.2846" class="difflineminus">-          let startTZ;</span>
<a href="#l7.2847"></a><span id="l7.2847" class="difflineminus">-          let endTZ;</span>
<a href="#l7.2848"></a><span id="l7.2848" class="difflineminus">-          let dragDay = col.mDate;</span>
<a href="#l7.2849"></a><span id="l7.2849" class="difflineminus">-          if (dragState.dragType != &quot;new&quot;) {</span>
<a href="#l7.2850"></a><span id="l7.2850" class="difflineminus">-              let oldStart = dragState.dragOccurrence.startDate ||</span>
<a href="#l7.2851"></a><span id="l7.2851" class="difflineminus">-                             dragState.dragOccurrence.entryDate ||</span>
<a href="#l7.2852"></a><span id="l7.2852" class="difflineminus">-                             dragState.dragOccurrence.dueDate;</span>
<a href="#l7.2853"></a><span id="l7.2853" class="difflineminus">-              let oldEnd = dragState.dragOccurrence.endDate ||</span>
<a href="#l7.2854"></a><span id="l7.2854" class="difflineminus">-                           dragState.dragOccurrence.dueDate ||</span>
<a href="#l7.2855"></a><span id="l7.2855" class="difflineminus">-                           dragState.dragOccurrence.entryDate;</span>
<a href="#l7.2856"></a><span id="l7.2856" class="difflineminus">-              newStart = oldStart.clone();</span>
<a href="#l7.2857"></a><span id="l7.2857" class="difflineminus">-              newEnd = oldEnd.clone();</span>
<a href="#l7.2858"></a><span id="l7.2858" class="difflineminus">-</span>
<a href="#l7.2859"></a><span id="l7.2859" class="difflineminus">-              // Our views are pegged to the default timezone.  If the event</span>
<a href="#l7.2860"></a><span id="l7.2860" class="difflineminus">-              // isn't also in the timezone, we're going to need to do some</span>
<a href="#l7.2861"></a><span id="l7.2861" class="difflineminus">-              // tweaking. We could just do this for every event but</span>
<a href="#l7.2862"></a><span id="l7.2862" class="difflineminus">-              // getInTimezone is slow, so it's much better to only do this</span>
<a href="#l7.2863"></a><span id="l7.2863" class="difflineminus">-              // when the timezones actually differ from the view's.</span>
<a href="#l7.2864"></a><span id="l7.2864" class="difflineminus">-              if (col.mTimezone != newStart.timezone ||</span>
<a href="#l7.2865"></a><span id="l7.2865" class="difflineminus">-                  col.mTimezone != newEnd.timezone) {</span>
<a href="#l7.2866"></a><span id="l7.2866" class="difflineminus">-                  startTZ = newStart.timezone;</span>
<a href="#l7.2867"></a><span id="l7.2867" class="difflineminus">-                  endTZ = newEnd.timezone;</span>
<a href="#l7.2868"></a><span id="l7.2868" class="difflineminus">-                  newStart = newStart.getInTimezone(col.calendarView.mTimezone);</span>
<a href="#l7.2869"></a><span id="l7.2869" class="difflineminus">-                  newEnd = newEnd.getInTimezone(col.calendarView.mTimezone);</span>
<a href="#l7.2870"></a><span id="l7.2870" class="difflineminus">-              }</span>
<a href="#l7.2871"></a><span id="l7.2871" class="difflineminus">-          }</span>
<a href="#l7.2872"></a><span id="l7.2872" class="difflineminus">-</span>
<a href="#l7.2873"></a><span id="l7.2873" class="difflineminus">-          if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.2874"></a><span id="l7.2874" class="difflineminus">-              newStart.resetTo(dragDay.year, dragDay.month, dragDay.day,</span>
<a href="#l7.2875"></a><span id="l7.2875" class="difflineminus">-                               0, dragState.startMin + col.mStartMin, 0,</span>
<a href="#l7.2876"></a><span id="l7.2876" class="difflineminus">-                               newStart.timezone);</span>
<a href="#l7.2877"></a><span id="l7.2877" class="difflineminus">-          } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2878"></a><span id="l7.2878" class="difflineminus">-              newEnd.resetTo(dragDay.year, dragDay.month, dragDay.day,</span>
<a href="#l7.2879"></a><span id="l7.2879" class="difflineminus">-                             0, dragState.endMin + col.mStartMin, 0,</span>
<a href="#l7.2880"></a><span id="l7.2880" class="difflineminus">-                             newEnd.timezone);</span>
<a href="#l7.2881"></a><span id="l7.2881" class="difflineminus">-          } else if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2882"></a><span id="l7.2882" class="difflineminus">-              let startDay = dragState.origColumn.mDate;</span>
<a href="#l7.2883"></a><span id="l7.2883" class="difflineminus">-              let draggedForward = (dragDay.compare(startDay) &gt; 0);</span>
<a href="#l7.2884"></a><span id="l7.2884" class="difflineminus">-              newStart = draggedForward ? startDay.clone() : dragDay.clone();</span>
<a href="#l7.2885"></a><span id="l7.2885" class="difflineminus">-              newEnd = draggedForward ? dragDay.clone() : startDay.clone();</span>
<a href="#l7.2886"></a><span id="l7.2886" class="difflineminus">-              newStart.isDate = false;</span>
<a href="#l7.2887"></a><span id="l7.2887" class="difflineminus">-              newEnd.isDate = false;</span>
<a href="#l7.2888"></a><span id="l7.2888" class="difflineminus">-              newStart.resetTo(newStart.year, newStart.month, newStart.day,</span>
<a href="#l7.2889"></a><span id="l7.2889" class="difflineminus">-                               0, dragState.startMin + col.mStartMin, 0,</span>
<a href="#l7.2890"></a><span id="l7.2890" class="difflineminus">-                               newStart.timezone);</span>
<a href="#l7.2891"></a><span id="l7.2891" class="difflineminus">-              newEnd.resetTo(newEnd.year, newEnd.month, newEnd.day,</span>
<a href="#l7.2892"></a><span id="l7.2892" class="difflineminus">-                             0, dragState.endMin + col.mStartMin, 0,</span>
<a href="#l7.2893"></a><span id="l7.2893" class="difflineminus">-                             newEnd.timezone);</span>
<a href="#l7.2894"></a><span id="l7.2894" class="difflineminus">-</span>
<a href="#l7.2895"></a><span id="l7.2895" class="difflineminus">-              // Edit the event title on the first of the new event's occurrences</span>
<a href="#l7.2896"></a><span id="l7.2896" class="difflineminus">-              if (draggedForward) {</span>
<a href="#l7.2897"></a><span id="l7.2897" class="difflineminus">-                  dragState.origColumn.mCreatedNewEvent = true;</span>
<a href="#l7.2898"></a><span id="l7.2898" class="difflineminus">-              } else {</span>
<a href="#l7.2899"></a><span id="l7.2899" class="difflineminus">-                  col.mCreatedNewEvent = true;</span>
<a href="#l7.2900"></a><span id="l7.2900" class="difflineminus">-              }</span>
<a href="#l7.2901"></a><span id="l7.2901" class="difflineminus">-          } else if (dragState.dragType == &quot;move&quot;) {</span>
<a href="#l7.2902"></a><span id="l7.2902" class="difflineminus">-              // Figure out the new date-times of the event by adding the duration</span>
<a href="#l7.2903"></a><span id="l7.2903" class="difflineminus">-              // of the total movement (days and minutes) to the old dates.</span>
<a href="#l7.2904"></a><span id="l7.2904" class="difflineminus">-              let duration = dragDay.subtractDate(dragState.origColumn.mDate);</span>
<a href="#l7.2905"></a><span id="l7.2905" class="difflineminus">-              let minutes = dragState.lastStart - dragState.realStart;</span>
<a href="#l7.2906"></a><span id="l7.2906" class="difflineminus">-</span>
<a href="#l7.2907"></a><span id="l7.2907" class="difflineminus">-              // Since both boxDate and beginMove are dates (note datetimes),</span>
<a href="#l7.2908"></a><span id="l7.2908" class="difflineminus">-              // subtractDate will only give us a non-zero number of hours on</span>
<a href="#l7.2909"></a><span id="l7.2909" class="difflineminus">-              // DST changes. While strictly speaking, subtractDate's behavior</span>
<a href="#l7.2910"></a><span id="l7.2910" class="difflineminus">-              // is correct, we need to move the event a discrete number of</span>
<a href="#l7.2911"></a><span id="l7.2911" class="difflineminus">-              // days here. There is no need for normalization here, since</span>
<a href="#l7.2912"></a><span id="l7.2912" class="difflineminus">-              // addDuration does the job for us. Also note, the duration used</span>
<a href="#l7.2913"></a><span id="l7.2913" class="difflineminus">-              // here is only used to move over multiple days. Moving on the</span>
<a href="#l7.2914"></a><span id="l7.2914" class="difflineminus">-              // same day uses the minutes from the dragState.</span>
<a href="#l7.2915"></a><span id="l7.2915" class="difflineminus">-              if (duration.hours == 23) {</span>
<a href="#l7.2916"></a><span id="l7.2916" class="difflineminus">-                  // entering DST</span>
<a href="#l7.2917"></a><span id="l7.2917" class="difflineminus">-                  duration.hours++;</span>
<a href="#l7.2918"></a><span id="l7.2918" class="difflineminus">-              } else if (duration.hours == 1) {</span>
<a href="#l7.2919"></a><span id="l7.2919" class="difflineminus">-                  // leaving DST</span>
<a href="#l7.2920"></a><span id="l7.2920" class="difflineminus">-                  duration.hours--;</span>
<a href="#l7.2921"></a><span id="l7.2921" class="difflineminus">-              }</span>
<a href="#l7.2922"></a><span id="l7.2922" class="difflineminus">-</span>
<a href="#l7.2923"></a><span id="l7.2923" class="difflineminus">-              if (duration.isNegative) {</span>
<a href="#l7.2924"></a><span id="l7.2924" class="difflineminus">-                  // Adding negative minutes to a negative duration makes the</span>
<a href="#l7.2925"></a><span id="l7.2925" class="difflineminus">-                  // duration more positive, but we want more negative, and</span>
<a href="#l7.2926"></a><span id="l7.2926" class="difflineminus">-                  // vice versa.</span>
<a href="#l7.2927"></a><span id="l7.2927" class="difflineminus">-                  minutes *= -1;</span>
<a href="#l7.2928"></a><span id="l7.2928" class="difflineminus">-              }</span>
<a href="#l7.2929"></a><span id="l7.2929" class="difflineminus">-              duration.minutes = minutes;</span>
<a href="#l7.2930"></a><span id="l7.2930" class="difflineminus">-              duration.normalize();</span>
<a href="#l7.2931"></a><span id="l7.2931" class="difflineminus">-</span>
<a href="#l7.2932"></a><span id="l7.2932" class="difflineminus">-              newStart.addDuration(duration);</span>
<a href="#l7.2933"></a><span id="l7.2933" class="difflineminus">-              newEnd.addDuration(duration);</span>
<a href="#l7.2934"></a><span id="l7.2934" class="difflineminus">-          }</span>
<a href="#l7.2935"></a><span id="l7.2935" class="difflineminus">-</span>
<a href="#l7.2936"></a><span id="l7.2936" class="difflineminus">-          // If we tweaked tzs, put times back in their original ones</span>
<a href="#l7.2937"></a><span id="l7.2937" class="difflineminus">-          if (startTZ) {</span>
<a href="#l7.2938"></a><span id="l7.2938" class="difflineminus">-              newStart = newStart.getInTimezone(startTZ);</span>
<a href="#l7.2939"></a><span id="l7.2939" class="difflineminus">-          }</span>
<a href="#l7.2940"></a><span id="l7.2940" class="difflineminus">-          if (endTZ) {</span>
<a href="#l7.2941"></a><span id="l7.2941" class="difflineminus">-              newEnd = newEnd.getInTimezone(endTZ);</span>
<a href="#l7.2942"></a><span id="l7.2942" class="difflineminus">-          }</span>
<a href="#l7.2943"></a><span id="l7.2943" class="difflineminus">-</span>
<a href="#l7.2944"></a><span id="l7.2944" class="difflineminus">-          if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.2945"></a><span id="l7.2945" class="difflineminus">-              // We won't pass a calendar, since the display calendar is the</span>
<a href="#l7.2946"></a><span id="l7.2946" class="difflineminus">-              // composite anyway. createNewEvent() will use the selected</span>
<a href="#l7.2947"></a><span id="l7.2947" class="difflineminus">-              // calendar.</span>
<a href="#l7.2948"></a><span id="l7.2948" class="difflineminus">-              // TODO We might want to get rid of the extra displayCalendar</span>
<a href="#l7.2949"></a><span id="l7.2949" class="difflineminus">-              // member.</span>
<a href="#l7.2950"></a><span id="l7.2950" class="difflineminus">-              col.calendarView.controller.createNewEvent(null,</span>
<a href="#l7.2951"></a><span id="l7.2951" class="difflineminus">-                                                         newStart,</span>
<a href="#l7.2952"></a><span id="l7.2952" class="difflineminus">-                                                         newEnd);</span>
<a href="#l7.2953"></a><span id="l7.2953" class="difflineminus">-          } else if (dragState.dragType == &quot;move&quot; ||</span>
<a href="#l7.2954"></a><span id="l7.2954" class="difflineminus">-                     dragState.dragType == &quot;modify-start&quot; ||</span>
<a href="#l7.2955"></a><span id="l7.2955" class="difflineminus">-                     dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.2956"></a><span id="l7.2956" class="difflineminus">-              col.calendarView.controller.modifyOccurrence(dragState.dragOccurrence,</span>
<a href="#l7.2957"></a><span id="l7.2957" class="difflineminus">-                                                           newStart, newEnd);</span>
<a href="#l7.2958"></a><span id="l7.2958" class="difflineminus">-          }</span>
<a href="#l7.2959"></a><span id="l7.2959" class="difflineminus">-          document.calendarEventColumnDragging = null;</span>
<a href="#l7.2960"></a><span id="l7.2960" class="difflineminus">-          col.mDragState = null;</span>
<a href="#l7.2961"></a><span id="l7.2961" class="difflineplus">+            let col = document.calendarEventColumnDragging;</span>
<a href="#l7.2962"></a><span id="l7.2962" class="difflineplus">+            if (!col) {</span>
<a href="#l7.2963"></a><span id="l7.2963" class="difflineplus">+                return;</span>
<a href="#l7.2964"></a><span id="l7.2964" class="difflineplus">+            }</span>
<a href="#l7.2965"></a><span id="l7.2965" class="difflineplus">+</span>
<a href="#l7.2966"></a><span id="l7.2966" class="difflineplus">+            let dragState = col.mDragState;</span>
<a href="#l7.2967"></a><span id="l7.2967" class="difflineplus">+</span>
<a href="#l7.2968"></a><span id="l7.2968" class="difflineplus">+            let lateralColumns = col.firstLastShadowColumns();</span>
<a href="#l7.2969"></a><span id="l7.2969" class="difflineplus">+            let column = lateralColumns.firstCol;</span>
<a href="#l7.2970"></a><span id="l7.2970" class="difflineplus">+            let index = lateralColumns.firstIndex;</span>
<a href="#l7.2971"></a><span id="l7.2971" class="difflineplus">+            while (column &amp;&amp; index &lt; dragState.shadows) {</span>
<a href="#l7.2972"></a><span id="l7.2972" class="difflineplus">+                column.fgboxes.dragbox.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2973"></a><span id="l7.2973" class="difflineplus">+                column.fgboxes.box.removeAttribute(&quot;dragging&quot;);</span>
<a href="#l7.2974"></a><span id="l7.2974" class="difflineplus">+                column = column.nextSibling;</span>
<a href="#l7.2975"></a><span id="l7.2975" class="difflineplus">+                index++;</span>
<a href="#l7.2976"></a><span id="l7.2976" class="difflineplus">+            }</span>
<a href="#l7.2977"></a><span id="l7.2977" class="difflineplus">+</span>
<a href="#l7.2978"></a><span id="l7.2978" class="difflineplus">+            col.clearMagicScroll();</span>
<a href="#l7.2979"></a><span id="l7.2979" class="difflineplus">+</span>
<a href="#l7.2980"></a><span id="l7.2980" class="difflineplus">+            window.removeEventListener(&quot;mousemove&quot;, col.onEventSweepMouseMove);</span>
<a href="#l7.2981"></a><span id="l7.2981" class="difflineplus">+            window.removeEventListener(&quot;mouseup&quot;, col.onEventSweepMouseUp);</span>
<a href="#l7.2982"></a><span id="l7.2982" class="difflineplus">+            window.removeEventListener(&quot;keypress&quot;, col.onEventSweepKeypress);</span>
<a href="#l7.2983"></a><span id="l7.2983" class="difflineplus">+</span>
<a href="#l7.2984"></a><span id="l7.2984" class="difflineplus">+            document.calendarEventColumnDragging = null;</span>
<a href="#l7.2985"></a><span id="l7.2985" class="difflineplus">+</span>
<a href="#l7.2986"></a><span id="l7.2986" class="difflineplus">+            // if the user didn't sweep out at least a few pixels, ignore</span>
<a href="#l7.2987"></a><span id="l7.2987" class="difflineplus">+            // unless we're in a different column</span>
<a href="#l7.2988"></a><span id="l7.2988" class="difflineplus">+            if (dragState.origColumn == col) {</span>
<a href="#l7.2989"></a><span id="l7.2989" class="difflineplus">+                let ignore = false;</span>
<a href="#l7.2990"></a><span id="l7.2990" class="difflineplus">+                let orient = col.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.2991"></a><span id="l7.2991" class="difflineplus">+                let position = orient == &quot;vertical&quot; ? event.screenY : event.screenX;</span>
<a href="#l7.2992"></a><span id="l7.2992" class="difflineplus">+                if (Math.abs(position - dragState.origLoc) &lt; 3) {</span>
<a href="#l7.2993"></a><span id="l7.2993" class="difflineplus">+                    ignore = true;</span>
<a href="#l7.2994"></a><span id="l7.2994" class="difflineplus">+                }</span>
<a href="#l7.2995"></a><span id="l7.2995" class="difflineplus">+</span>
<a href="#l7.2996"></a><span id="l7.2996" class="difflineplus">+                if (ignore) {</span>
<a href="#l7.2997"></a><span id="l7.2997" class="difflineplus">+                    col.mDragState = null;</span>
<a href="#l7.2998"></a><span id="l7.2998" class="difflineplus">+                    return;</span>
<a href="#l7.2999"></a><span id="l7.2999" class="difflineplus">+                }</span>
<a href="#l7.3000"></a><span id="l7.3000" class="difflineplus">+            }</span>
<a href="#l7.3001"></a><span id="l7.3001" class="difflineplus">+</span>
<a href="#l7.3002"></a><span id="l7.3002" class="difflineplus">+            let newStart;</span>
<a href="#l7.3003"></a><span id="l7.3003" class="difflineplus">+            let newEnd;</span>
<a href="#l7.3004"></a><span id="l7.3004" class="difflineplus">+            let startTZ;</span>
<a href="#l7.3005"></a><span id="l7.3005" class="difflineplus">+            let endTZ;</span>
<a href="#l7.3006"></a><span id="l7.3006" class="difflineplus">+            let dragDay = col.mDate;</span>
<a href="#l7.3007"></a><span id="l7.3007" class="difflineplus">+            if (dragState.dragType != &quot;new&quot;) {</span>
<a href="#l7.3008"></a><span id="l7.3008" class="difflineplus">+                let oldStart = dragState.dragOccurrence.startDate ||</span>
<a href="#l7.3009"></a><span id="l7.3009" class="difflineplus">+                               dragState.dragOccurrence.entryDate ||</span>
<a href="#l7.3010"></a><span id="l7.3010" class="difflineplus">+                               dragState.dragOccurrence.dueDate;</span>
<a href="#l7.3011"></a><span id="l7.3011" class="difflineplus">+                let oldEnd = dragState.dragOccurrence.endDate ||</span>
<a href="#l7.3012"></a><span id="l7.3012" class="difflineplus">+                             dragState.dragOccurrence.dueDate ||</span>
<a href="#l7.3013"></a><span id="l7.3013" class="difflineplus">+                             dragState.dragOccurrence.entryDate;</span>
<a href="#l7.3014"></a><span id="l7.3014" class="difflineplus">+                newStart = oldStart.clone();</span>
<a href="#l7.3015"></a><span id="l7.3015" class="difflineplus">+                newEnd = oldEnd.clone();</span>
<a href="#l7.3016"></a><span id="l7.3016" class="difflineplus">+</span>
<a href="#l7.3017"></a><span id="l7.3017" class="difflineplus">+                // Our views are pegged to the default timezone.  If the event</span>
<a href="#l7.3018"></a><span id="l7.3018" class="difflineplus">+                // isn't also in the timezone, we're going to need to do some</span>
<a href="#l7.3019"></a><span id="l7.3019" class="difflineplus">+                // tweaking. We could just do this for every event but</span>
<a href="#l7.3020"></a><span id="l7.3020" class="difflineplus">+                // getInTimezone is slow, so it's much better to only do this</span>
<a href="#l7.3021"></a><span id="l7.3021" class="difflineplus">+                // when the timezones actually differ from the view's.</span>
<a href="#l7.3022"></a><span id="l7.3022" class="difflineplus">+                if (col.mTimezone != newStart.timezone ||</span>
<a href="#l7.3023"></a><span id="l7.3023" class="difflineplus">+                    col.mTimezone != newEnd.timezone) {</span>
<a href="#l7.3024"></a><span id="l7.3024" class="difflineplus">+                    startTZ = newStart.timezone;</span>
<a href="#l7.3025"></a><span id="l7.3025" class="difflineplus">+                    endTZ = newEnd.timezone;</span>
<a href="#l7.3026"></a><span id="l7.3026" class="difflineplus">+                    newStart = newStart.getInTimezone(col.calendarView.mTimezone);</span>
<a href="#l7.3027"></a><span id="l7.3027" class="difflineplus">+                    newEnd = newEnd.getInTimezone(col.calendarView.mTimezone);</span>
<a href="#l7.3028"></a><span id="l7.3028" class="difflineplus">+                }</span>
<a href="#l7.3029"></a><span id="l7.3029" class="difflineplus">+            }</span>
<a href="#l7.3030"></a><span id="l7.3030" class="difflineplus">+</span>
<a href="#l7.3031"></a><span id="l7.3031" class="difflineplus">+            if (dragState.dragType == &quot;modify-start&quot;) {</span>
<a href="#l7.3032"></a><span id="l7.3032" class="difflineplus">+                newStart.resetTo(dragDay.year, dragDay.month, dragDay.day,</span>
<a href="#l7.3033"></a><span id="l7.3033" class="difflineplus">+                                 0, dragState.startMin + col.mStartMin, 0,</span>
<a href="#l7.3034"></a><span id="l7.3034" class="difflineplus">+                                 newStart.timezone);</span>
<a href="#l7.3035"></a><span id="l7.3035" class="difflineplus">+            } else if (dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.3036"></a><span id="l7.3036" class="difflineplus">+                newEnd.resetTo(dragDay.year, dragDay.month, dragDay.day,</span>
<a href="#l7.3037"></a><span id="l7.3037" class="difflineplus">+                               0, dragState.endMin + col.mStartMin, 0,</span>
<a href="#l7.3038"></a><span id="l7.3038" class="difflineplus">+                               newEnd.timezone);</span>
<a href="#l7.3039"></a><span id="l7.3039" class="difflineplus">+            } else if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.3040"></a><span id="l7.3040" class="difflineplus">+                let startDay = dragState.origColumn.mDate;</span>
<a href="#l7.3041"></a><span id="l7.3041" class="difflineplus">+                let draggedForward = (dragDay.compare(startDay) &gt; 0);</span>
<a href="#l7.3042"></a><span id="l7.3042" class="difflineplus">+                newStart = draggedForward ? startDay.clone() : dragDay.clone();</span>
<a href="#l7.3043"></a><span id="l7.3043" class="difflineplus">+                newEnd = draggedForward ? dragDay.clone() : startDay.clone();</span>
<a href="#l7.3044"></a><span id="l7.3044" class="difflineplus">+                newStart.isDate = false;</span>
<a href="#l7.3045"></a><span id="l7.3045" class="difflineplus">+                newEnd.isDate = false;</span>
<a href="#l7.3046"></a><span id="l7.3046" class="difflineplus">+                newStart.resetTo(newStart.year, newStart.month, newStart.day,</span>
<a href="#l7.3047"></a><span id="l7.3047" class="difflineplus">+                                 0, dragState.startMin + col.mStartMin, 0,</span>
<a href="#l7.3048"></a><span id="l7.3048" class="difflineplus">+                                 newStart.timezone);</span>
<a href="#l7.3049"></a><span id="l7.3049" class="difflineplus">+                newEnd.resetTo(newEnd.year, newEnd.month, newEnd.day,</span>
<a href="#l7.3050"></a><span id="l7.3050" class="difflineplus">+                               0, dragState.endMin + col.mStartMin, 0,</span>
<a href="#l7.3051"></a><span id="l7.3051" class="difflineplus">+                               newEnd.timezone);</span>
<a href="#l7.3052"></a><span id="l7.3052" class="difflineplus">+</span>
<a href="#l7.3053"></a><span id="l7.3053" class="difflineplus">+                // Edit the event title on the first of the new event's occurrences</span>
<a href="#l7.3054"></a><span id="l7.3054" class="difflineplus">+                if (draggedForward) {</span>
<a href="#l7.3055"></a><span id="l7.3055" class="difflineplus">+                    dragState.origColumn.mCreatedNewEvent = true;</span>
<a href="#l7.3056"></a><span id="l7.3056" class="difflineplus">+                } else {</span>
<a href="#l7.3057"></a><span id="l7.3057" class="difflineplus">+                    col.mCreatedNewEvent = true;</span>
<a href="#l7.3058"></a><span id="l7.3058" class="difflineplus">+                }</span>
<a href="#l7.3059"></a><span id="l7.3059" class="difflineplus">+            } else if (dragState.dragType == &quot;move&quot;) {</span>
<a href="#l7.3060"></a><span id="l7.3060" class="difflineplus">+                // Figure out the new date-times of the event by adding the duration</span>
<a href="#l7.3061"></a><span id="l7.3061" class="difflineplus">+                // of the total movement (days and minutes) to the old dates.</span>
<a href="#l7.3062"></a><span id="l7.3062" class="difflineplus">+                let duration = dragDay.subtractDate(dragState.origColumn.mDate);</span>
<a href="#l7.3063"></a><span id="l7.3063" class="difflineplus">+                let minutes = dragState.lastStart - dragState.realStart;</span>
<a href="#l7.3064"></a><span id="l7.3064" class="difflineplus">+</span>
<a href="#l7.3065"></a><span id="l7.3065" class="difflineplus">+                // Since both boxDate and beginMove are dates (note datetimes),</span>
<a href="#l7.3066"></a><span id="l7.3066" class="difflineplus">+                // subtractDate will only give us a non-zero number of hours on</span>
<a href="#l7.3067"></a><span id="l7.3067" class="difflineplus">+                // DST changes. While strictly speaking, subtractDate's behavior</span>
<a href="#l7.3068"></a><span id="l7.3068" class="difflineplus">+                // is correct, we need to move the event a discrete number of</span>
<a href="#l7.3069"></a><span id="l7.3069" class="difflineplus">+                // days here. There is no need for normalization here, since</span>
<a href="#l7.3070"></a><span id="l7.3070" class="difflineplus">+                // addDuration does the job for us. Also note, the duration used</span>
<a href="#l7.3071"></a><span id="l7.3071" class="difflineplus">+                // here is only used to move over multiple days. Moving on the</span>
<a href="#l7.3072"></a><span id="l7.3072" class="difflineplus">+                // same day uses the minutes from the dragState.</span>
<a href="#l7.3073"></a><span id="l7.3073" class="difflineplus">+                if (duration.hours == 23) {</span>
<a href="#l7.3074"></a><span id="l7.3074" class="difflineplus">+                    // entering DST</span>
<a href="#l7.3075"></a><span id="l7.3075" class="difflineplus">+                    duration.hours++;</span>
<a href="#l7.3076"></a><span id="l7.3076" class="difflineplus">+                } else if (duration.hours == 1) {</span>
<a href="#l7.3077"></a><span id="l7.3077" class="difflineplus">+                    // leaving DST</span>
<a href="#l7.3078"></a><span id="l7.3078" class="difflineplus">+                    duration.hours--;</span>
<a href="#l7.3079"></a><span id="l7.3079" class="difflineplus">+                }</span>
<a href="#l7.3080"></a><span id="l7.3080" class="difflineplus">+</span>
<a href="#l7.3081"></a><span id="l7.3081" class="difflineplus">+                if (duration.isNegative) {</span>
<a href="#l7.3082"></a><span id="l7.3082" class="difflineplus">+                    // Adding negative minutes to a negative duration makes the</span>
<a href="#l7.3083"></a><span id="l7.3083" class="difflineplus">+                    // duration more positive, but we want more negative, and</span>
<a href="#l7.3084"></a><span id="l7.3084" class="difflineplus">+                    // vice versa.</span>
<a href="#l7.3085"></a><span id="l7.3085" class="difflineplus">+                    minutes *= -1;</span>
<a href="#l7.3086"></a><span id="l7.3086" class="difflineplus">+                }</span>
<a href="#l7.3087"></a><span id="l7.3087" class="difflineplus">+                duration.minutes = minutes;</span>
<a href="#l7.3088"></a><span id="l7.3088" class="difflineplus">+                duration.normalize();</span>
<a href="#l7.3089"></a><span id="l7.3089" class="difflineplus">+</span>
<a href="#l7.3090"></a><span id="l7.3090" class="difflineplus">+                newStart.addDuration(duration);</span>
<a href="#l7.3091"></a><span id="l7.3091" class="difflineplus">+                newEnd.addDuration(duration);</span>
<a href="#l7.3092"></a><span id="l7.3092" class="difflineplus">+            }</span>
<a href="#l7.3093"></a><span id="l7.3093" class="difflineplus">+</span>
<a href="#l7.3094"></a><span id="l7.3094" class="difflineplus">+            // If we tweaked tzs, put times back in their original ones</span>
<a href="#l7.3095"></a><span id="l7.3095" class="difflineplus">+            if (startTZ) {</span>
<a href="#l7.3096"></a><span id="l7.3096" class="difflineplus">+                newStart = newStart.getInTimezone(startTZ);</span>
<a href="#l7.3097"></a><span id="l7.3097" class="difflineplus">+            }</span>
<a href="#l7.3098"></a><span id="l7.3098" class="difflineplus">+            if (endTZ) {</span>
<a href="#l7.3099"></a><span id="l7.3099" class="difflineplus">+                newEnd = newEnd.getInTimezone(endTZ);</span>
<a href="#l7.3100"></a><span id="l7.3100" class="difflineplus">+            }</span>
<a href="#l7.3101"></a><span id="l7.3101" class="difflineplus">+</span>
<a href="#l7.3102"></a><span id="l7.3102" class="difflineplus">+            if (dragState.dragType == &quot;new&quot;) {</span>
<a href="#l7.3103"></a><span id="l7.3103" class="difflineplus">+                // We won't pass a calendar, since the display calendar is the</span>
<a href="#l7.3104"></a><span id="l7.3104" class="difflineplus">+                // composite anyway. createNewEvent() will use the selected</span>
<a href="#l7.3105"></a><span id="l7.3105" class="difflineplus">+                // calendar.</span>
<a href="#l7.3106"></a><span id="l7.3106" class="difflineplus">+                // TODO We might want to get rid of the extra displayCalendar</span>
<a href="#l7.3107"></a><span id="l7.3107" class="difflineplus">+                // member.</span>
<a href="#l7.3108"></a><span id="l7.3108" class="difflineplus">+                col.calendarView.controller.createNewEvent(null,</span>
<a href="#l7.3109"></a><span id="l7.3109" class="difflineplus">+                                                           newStart,</span>
<a href="#l7.3110"></a><span id="l7.3110" class="difflineplus">+                                                           newEnd);</span>
<a href="#l7.3111"></a><span id="l7.3111" class="difflineplus">+            } else if (dragState.dragType == &quot;move&quot; ||</span>
<a href="#l7.3112"></a><span id="l7.3112" class="difflineplus">+                       dragState.dragType == &quot;modify-start&quot; ||</span>
<a href="#l7.3113"></a><span id="l7.3113" class="difflineplus">+                       dragState.dragType == &quot;modify-end&quot;) {</span>
<a href="#l7.3114"></a><span id="l7.3114" class="difflineplus">+                col.calendarView.controller.modifyOccurrence(dragState.dragOccurrence,</span>
<a href="#l7.3115"></a><span id="l7.3115" class="difflineplus">+                                                             newStart, newEnd);</span>
<a href="#l7.3116"></a><span id="l7.3116" class="difflineplus">+            }</span>
<a href="#l7.3117"></a><span id="l7.3117" class="difflineplus">+            document.calendarEventColumnDragging = null;</span>
<a href="#l7.3118"></a><span id="l7.3118" class="difflineplus">+            col.mDragState = null;</span>
<a href="#l7.3119"></a><span id="l7.3119">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3120"></a><span id="l7.3120">       &lt;/method&gt;</span>
<a href="#l7.3121"></a><span id="l7.3121"> </span>
<a href="#l7.3122"></a><span id="l7.3122">       &lt;!-- This is called by an event box when a grippy on either side is dragged,</span>
<a href="#l7.3123"></a><span id="l7.3123">          - or when the middle is pressed to drag the event to move it.  We create</span>
<a href="#l7.3124"></a><span id="l7.3124">          - the same type of view that we use to sweep out a new event, but we</span>
<a href="#l7.3125"></a><span id="l7.3125">          - initialize it based on the event's values and what type of dragging</span>
<a href="#l7.3126"></a><span id="l7.3126">          - we're doing.  In addition, we constrain things like not being able to</span>
<a href="#l7.3127"></a><span id="l7.3127" class="difflineat">@@ -1794,451 +1794,451 @@</span>
<a href="#l7.3128"></a><span id="l7.3128">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l7.3129"></a><span id="l7.3129">         &lt;!-- &quot;start&quot;, &quot;end&quot;, &quot;middle&quot; --&gt;</span>
<a href="#l7.3130"></a><span id="l7.3130">         &lt;parameter name=&quot;aGrabbedElement&quot;/&gt;</span>
<a href="#l7.3131"></a><span id="l7.3131">         &lt;!-- mouse screenX/screenY from the event --&gt;</span>
<a href="#l7.3132"></a><span id="l7.3132">         &lt;parameter name=&quot;aMouseX&quot;/&gt;</span>
<a href="#l7.3133"></a><span id="l7.3133">         &lt;parameter name=&quot;aMouseY&quot;/&gt;</span>
<a href="#l7.3134"></a><span id="l7.3134">         &lt;parameter name=&quot;aSnapInt&quot;/&gt;</span>
<a href="#l7.3135"></a><span id="l7.3135">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3136"></a><span id="l7.3136" class="difflineminus">-          if (!cal.isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l7.3137"></a><span id="l7.3137" class="difflineminus">-              !cal.userCanModifyItem(aOccurrence) ||</span>
<a href="#l7.3138"></a><span id="l7.3138" class="difflineminus">-              (aOccurrence.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence)) ||</span>
<a href="#l7.3139"></a><span id="l7.3139" class="difflineminus">-              aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l7.3140"></a><span id="l7.3140" class="difflineminus">-              return;</span>
<a href="#l7.3141"></a><span id="l7.3141" class="difflineminus">-          }</span>
<a href="#l7.3142"></a><span id="l7.3142" class="difflineminus">-</span>
<a href="#l7.3143"></a><span id="l7.3143" class="difflineminus">-          this.mDragState = {</span>
<a href="#l7.3144"></a><span id="l7.3144" class="difflineminus">-              origColumn: this,</span>
<a href="#l7.3145"></a><span id="l7.3145" class="difflineminus">-              dragOccurrence: aOccurrence,</span>
<a href="#l7.3146"></a><span id="l7.3146" class="difflineminus">-              mouseOffset: 0,</span>
<a href="#l7.3147"></a><span id="l7.3147" class="difflineminus">-              offset: null,</span>
<a href="#l7.3148"></a><span id="l7.3148" class="difflineminus">-              shadows: null,</span>
<a href="#l7.3149"></a><span id="l7.3149" class="difflineminus">-              limitStartMin: null,</span>
<a href="#l7.3150"></a><span id="l7.3150" class="difflineminus">-              lastStart: 0,</span>
<a href="#l7.3151"></a><span id="l7.3151" class="difflineminus">-              jumpedColumns: 0</span>
<a href="#l7.3152"></a><span id="l7.3152" class="difflineminus">-          };</span>
<a href="#l7.3153"></a><span id="l7.3153" class="difflineminus">-</span>
<a href="#l7.3154"></a><span id="l7.3154" class="difflineminus">-          // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.3155"></a><span id="l7.3155" class="difflineminus">-          let snapIntMin = aSnapInt || 15;</span>
<a href="#l7.3156"></a><span id="l7.3156" class="difflineminus">-          let sizeattr;</span>
<a href="#l7.3157"></a><span id="l7.3157" class="difflineminus">-          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3158"></a><span id="l7.3158" class="difflineminus">-              this.mDragState.origLoc = aMouseY;</span>
<a href="#l7.3159"></a><span id="l7.3159" class="difflineminus">-              sizeattr = &quot;height&quot;;</span>
<a href="#l7.3160"></a><span id="l7.3160" class="difflineminus">-          } else {</span>
<a href="#l7.3161"></a><span id="l7.3161" class="difflineminus">-              this.mDragState.origLoc = aMouseX;</span>
<a href="#l7.3162"></a><span id="l7.3162" class="difflineminus">-              sizeattr = &quot;width&quot;;</span>
<a href="#l7.3163"></a><span id="l7.3163" class="difflineminus">-          }</span>
<a href="#l7.3164"></a><span id="l7.3164" class="difflineminus">-</span>
<a href="#l7.3165"></a><span id="l7.3165" class="difflineminus">-          let mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l7.3166"></a><span id="l7.3166" class="difflineminus">-</span>
<a href="#l7.3167"></a><span id="l7.3167" class="difflineminus">-          // these are only used to compute durations or to compute UI</span>
<a href="#l7.3168"></a><span id="l7.3168" class="difflineminus">-          // sizes, so offset by this.mStartMin for sanity here (at the</span>
<a href="#l7.3169"></a><span id="l7.3169" class="difflineminus">-          // expense of possible insanity later)</span>
<a href="#l7.3170"></a><span id="l7.3170" class="difflineminus">-          mins.start -= this.mStartMin;</span>
<a href="#l7.3171"></a><span id="l7.3171" class="difflineminus">-          mins.end -= this.mStartMin;</span>
<a href="#l7.3172"></a><span id="l7.3172" class="difflineminus">-</span>
<a href="#l7.3173"></a><span id="l7.3173" class="difflineminus">-          if (aGrabbedElement == &quot;start&quot;) {</span>
<a href="#l7.3174"></a><span id="l7.3174" class="difflineminus">-              this.mDragState.dragType = &quot;modify-start&quot;;</span>
<a href="#l7.3175"></a><span id="l7.3175" class="difflineminus">-              // we have to use &quot;realEnd&quot; as fixed end value</span>
<a href="#l7.3176"></a><span id="l7.3176" class="difflineminus">-              this.mDragState.limitEndMin = mins.realEnd;</span>
<a href="#l7.3177"></a><span id="l7.3177" class="difflineminus">-</span>
<a href="#l7.3178"></a><span id="l7.3178" class="difflineminus">-              // snap start</span>
<a href="#l7.3179"></a><span id="l7.3179" class="difflineminus">-              this.mDragState.origMin = Math.floor(mins.start / snapIntMin) * snapIntMin;</span>
<a href="#l7.3180"></a><span id="l7.3180" class="difflineminus">-</span>
<a href="#l7.3181"></a><span id="l7.3181" class="difflineminus">-              // show the shadows and drag labels when clicking on gripbars</span>
<a href="#l7.3182"></a><span id="l7.3182" class="difflineminus">-              let shadowElements = this.getShadowElements(this.mDragState.origMin,</span>
<a href="#l7.3183"></a><span id="l7.3183" class="difflineminus">-                                                          this.mDragState.limitEndMin);</span>
<a href="#l7.3184"></a><span id="l7.3184" class="difflineminus">-              this.mDragState.startMin = shadowElements.startMin;</span>
<a href="#l7.3185"></a><span id="l7.3185" class="difflineminus">-              this.mDragState.endMin = shadowElements.endMin;</span>
<a href="#l7.3186"></a><span id="l7.3186" class="difflineminus">-              this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3187"></a><span id="l7.3187" class="difflineminus">-              this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3188"></a><span id="l7.3188" class="difflineminus">-              this.updateShadowsBoxes(this.mDragState.origMin, this.mDragState.endMin,</span>
<a href="#l7.3189"></a><span id="l7.3189" class="difflineminus">-                                      0, this.mDragState.shadows,</span>
<a href="#l7.3190"></a><span id="l7.3190" class="difflineminus">-                                      sizeattr);</span>
<a href="#l7.3191"></a><span id="l7.3191" class="difflineminus">-</span>
<a href="#l7.3192"></a><span id="l7.3192" class="difflineminus">-              // update drag labels</span>
<a href="#l7.3193"></a><span id="l7.3193" class="difflineminus">-              let lastCol = this.firstLastShadowColumns().lastCol;</span>
<a href="#l7.3194"></a><span id="l7.3194" class="difflineminus">-              this.updateDragLabels(this, lastCol);</span>
<a href="#l7.3195"></a><span id="l7.3195" class="difflineminus">-          } else if (aGrabbedElement == &quot;end&quot;) {</span>
<a href="#l7.3196"></a><span id="l7.3196" class="difflineminus">-              this.mDragState.dragType = &quot;modify-end&quot;;</span>
<a href="#l7.3197"></a><span id="l7.3197" class="difflineminus">-              // we have to use &quot;realStart&quot; as fixed end value</span>
<a href="#l7.3198"></a><span id="l7.3198" class="difflineminus">-              this.mDragState.limitStartMin = mins.realStart;</span>
<a href="#l7.3199"></a><span id="l7.3199" class="difflineminus">-</span>
<a href="#l7.3200"></a><span id="l7.3200" class="difflineminus">-              // snap end</span>
<a href="#l7.3201"></a><span id="l7.3201" class="difflineminus">-              this.mDragState.origMin = Math.floor(mins.end / snapIntMin) * snapIntMin;</span>
<a href="#l7.3202"></a><span id="l7.3202" class="difflineminus">-</span>
<a href="#l7.3203"></a><span id="l7.3203" class="difflineminus">-              // show the shadows and drag labels when clicking on gripbars</span>
<a href="#l7.3204"></a><span id="l7.3204" class="difflineminus">-              let shadowElements = this.getShadowElements(this.mDragState.limitStartMin,</span>
<a href="#l7.3205"></a><span id="l7.3205" class="difflineminus">-                                                          this.mDragState.origMin);</span>
<a href="#l7.3206"></a><span id="l7.3206" class="difflineminus">-              this.mDragState.startMin = shadowElements.startMin;</span>
<a href="#l7.3207"></a><span id="l7.3207" class="difflineminus">-              this.mDragState.endMin = shadowElements.endMin;</span>
<a href="#l7.3208"></a><span id="l7.3208" class="difflineminus">-              this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3209"></a><span id="l7.3209" class="difflineminus">-              this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3210"></a><span id="l7.3210" class="difflineminus">-              this.updateShadowsBoxes(this.mDragState.startMin, this.mDragState.endMin,</span>
<a href="#l7.3211"></a><span id="l7.3211" class="difflineminus">-                                      shadowElements.offset, this.mDragState.shadows,</span>
<a href="#l7.3212"></a><span id="l7.3212" class="difflineminus">-                                      sizeattr);</span>
<a href="#l7.3213"></a><span id="l7.3213" class="difflineminus">-</span>
<a href="#l7.3214"></a><span id="l7.3214" class="difflineminus">-              // update drag labels</span>
<a href="#l7.3215"></a><span id="l7.3215" class="difflineminus">-              let firstCol = this.firstLastShadowColumns().firstCol;</span>
<a href="#l7.3216"></a><span id="l7.3216" class="difflineminus">-              this.updateDragLabels(firstCol, this);</span>
<a href="#l7.3217"></a><span id="l7.3217" class="difflineminus">-          } else if (aGrabbedElement == &quot;middle&quot;) {</span>
<a href="#l7.3218"></a><span id="l7.3218" class="difflineminus">-              this.mDragState.dragType = &quot;move&quot;;</span>
<a href="#l7.3219"></a><span id="l7.3219" class="difflineminus">-              // in a move, origMin will be the start minute of the element where</span>
<a href="#l7.3220"></a><span id="l7.3220" class="difflineminus">-              // the drag occurs. Along with mouseOffset, it allows to track the</span>
<a href="#l7.3221"></a><span id="l7.3221" class="difflineminus">-              // shadow position. origMinStart and origMinEnd allow to figure out</span>
<a href="#l7.3222"></a><span id="l7.3222" class="difflineminus">-              // the real shadow size.</span>
<a href="#l7.3223"></a><span id="l7.3223" class="difflineminus">-              // We snap to the start and add the real duration to find the end</span>
<a href="#l7.3224"></a><span id="l7.3224" class="difflineminus">-              let limitDurationMin = mins.realEnd - mins.realStart;</span>
<a href="#l7.3225"></a><span id="l7.3225" class="difflineminus">-              this.mDragState.origMin = Math.floor(mins.start / snapIntMin) * snapIntMin;</span>
<a href="#l7.3226"></a><span id="l7.3226" class="difflineminus">-              this.mDragState.origMinStart = Math.floor(mins.realStart / snapIntMin) * snapIntMin;</span>
<a href="#l7.3227"></a><span id="l7.3227" class="difflineminus">-              this.mDragState.origMinEnd = this.mDragState.origMinStart + limitDurationMin;</span>
<a href="#l7.3228"></a><span id="l7.3228" class="difflineminus">-              // Keep also track of the real Start, it will be used at the end</span>
<a href="#l7.3229"></a><span id="l7.3229" class="difflineminus">-              // of the drag session to calculate the new start and end datetimes.</span>
<a href="#l7.3230"></a><span id="l7.3230" class="difflineminus">-              this.mDragState.realStart = mins.realStart;</span>
<a href="#l7.3231"></a><span id="l7.3231" class="difflineminus">-</span>
<a href="#l7.3232"></a><span id="l7.3232" class="difflineminus">-              let shadowElements = this.getShadowElements(this.mDragState.origMinStart,</span>
<a href="#l7.3233"></a><span id="l7.3233" class="difflineminus">-                                                          this.mDragState.origMinEnd);</span>
<a href="#l7.3234"></a><span id="l7.3234" class="difflineminus">-              this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3235"></a><span id="l7.3235" class="difflineminus">-              this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3236"></a><span id="l7.3236" class="difflineminus">-              // we need to set a mouse offset, since we're not dragging from</span>
<a href="#l7.3237"></a><span id="l7.3237" class="difflineminus">-              // one end of the element</span>
<a href="#l7.3238"></a><span id="l7.3238" class="difflineminus">-              if (aEventBox) {</span>
<a href="#l7.3239"></a><span id="l7.3239" class="difflineminus">-                  if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3240"></a><span id="l7.3240" class="difflineminus">-                      this.mDragState.mouseOffset = aMouseY - aEventBox.boxObject.screenY;</span>
<a href="#l7.3241"></a><span id="l7.3241" class="difflineminus">-                  } else {</span>
<a href="#l7.3242"></a><span id="l7.3242" class="difflineminus">-                      this.mDragState.mouseOffset = aMouseX - aEventBox.boxObject.screenX;</span>
<a href="#l7.3243"></a><span id="l7.3243" class="difflineminus">-                  }</span>
<a href="#l7.3244"></a><span id="l7.3244" class="difflineminus">-              }</span>
<a href="#l7.3245"></a><span id="l7.3245" class="difflineminus">-          } else {</span>
<a href="#l7.3246"></a><span id="l7.3246" class="difflineminus">-              // Invalid grabbed element.</span>
<a href="#l7.3247"></a><span id="l7.3247" class="difflineminus">-          }</span>
<a href="#l7.3248"></a><span id="l7.3248" class="difflineminus">-</span>
<a href="#l7.3249"></a><span id="l7.3249" class="difflineminus">-          document.calendarEventColumnDragging = this;</span>
<a href="#l7.3250"></a><span id="l7.3250" class="difflineminus">-</span>
<a href="#l7.3251"></a><span id="l7.3251" class="difflineminus">-          window.addEventListener(&quot;mousemove&quot;, this.onEventSweepMouseMove);</span>
<a href="#l7.3252"></a><span id="l7.3252" class="difflineminus">-          window.addEventListener(&quot;mouseup&quot;, this.onEventSweepMouseUp);</span>
<a href="#l7.3253"></a><span id="l7.3253" class="difflineminus">-          window.addEventListener(&quot;keypress&quot;, this.onEventSweepKeypress);</span>
<a href="#l7.3254"></a><span id="l7.3254" class="difflineplus">+            if (!cal.isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l7.3255"></a><span id="l7.3255" class="difflineplus">+                !cal.userCanModifyItem(aOccurrence) ||</span>
<a href="#l7.3256"></a><span id="l7.3256" class="difflineplus">+                (aOccurrence.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence)) ||</span>
<a href="#l7.3257"></a><span id="l7.3257" class="difflineplus">+                aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l7.3258"></a><span id="l7.3258" class="difflineplus">+                return;</span>
<a href="#l7.3259"></a><span id="l7.3259" class="difflineplus">+            }</span>
<a href="#l7.3260"></a><span id="l7.3260" class="difflineplus">+</span>
<a href="#l7.3261"></a><span id="l7.3261" class="difflineplus">+            this.mDragState = {</span>
<a href="#l7.3262"></a><span id="l7.3262" class="difflineplus">+                origColumn: this,</span>
<a href="#l7.3263"></a><span id="l7.3263" class="difflineplus">+                dragOccurrence: aOccurrence,</span>
<a href="#l7.3264"></a><span id="l7.3264" class="difflineplus">+                mouseOffset: 0,</span>
<a href="#l7.3265"></a><span id="l7.3265" class="difflineplus">+                offset: null,</span>
<a href="#l7.3266"></a><span id="l7.3266" class="difflineplus">+                shadows: null,</span>
<a href="#l7.3267"></a><span id="l7.3267" class="difflineplus">+                limitStartMin: null,</span>
<a href="#l7.3268"></a><span id="l7.3268" class="difflineplus">+                lastStart: 0,</span>
<a href="#l7.3269"></a><span id="l7.3269" class="difflineplus">+                jumpedColumns: 0</span>
<a href="#l7.3270"></a><span id="l7.3270" class="difflineplus">+            };</span>
<a href="#l7.3271"></a><span id="l7.3271" class="difflineplus">+</span>
<a href="#l7.3272"></a><span id="l7.3272" class="difflineplus">+            // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.3273"></a><span id="l7.3273" class="difflineplus">+            let snapIntMin = aSnapInt || 15;</span>
<a href="#l7.3274"></a><span id="l7.3274" class="difflineplus">+            let sizeattr;</span>
<a href="#l7.3275"></a><span id="l7.3275" class="difflineplus">+            if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3276"></a><span id="l7.3276" class="difflineplus">+                this.mDragState.origLoc = aMouseY;</span>
<a href="#l7.3277"></a><span id="l7.3277" class="difflineplus">+                sizeattr = &quot;height&quot;;</span>
<a href="#l7.3278"></a><span id="l7.3278" class="difflineplus">+            } else {</span>
<a href="#l7.3279"></a><span id="l7.3279" class="difflineplus">+                this.mDragState.origLoc = aMouseX;</span>
<a href="#l7.3280"></a><span id="l7.3280" class="difflineplus">+                sizeattr = &quot;width&quot;;</span>
<a href="#l7.3281"></a><span id="l7.3281" class="difflineplus">+            }</span>
<a href="#l7.3282"></a><span id="l7.3282" class="difflineplus">+</span>
<a href="#l7.3283"></a><span id="l7.3283" class="difflineplus">+            let mins = this.getStartEndMinutesForOccurrence(aOccurrence);</span>
<a href="#l7.3284"></a><span id="l7.3284" class="difflineplus">+</span>
<a href="#l7.3285"></a><span id="l7.3285" class="difflineplus">+            // these are only used to compute durations or to compute UI</span>
<a href="#l7.3286"></a><span id="l7.3286" class="difflineplus">+            // sizes, so offset by this.mStartMin for sanity here (at the</span>
<a href="#l7.3287"></a><span id="l7.3287" class="difflineplus">+            // expense of possible insanity later)</span>
<a href="#l7.3288"></a><span id="l7.3288" class="difflineplus">+            mins.start -= this.mStartMin;</span>
<a href="#l7.3289"></a><span id="l7.3289" class="difflineplus">+            mins.end -= this.mStartMin;</span>
<a href="#l7.3290"></a><span id="l7.3290" class="difflineplus">+</span>
<a href="#l7.3291"></a><span id="l7.3291" class="difflineplus">+            if (aGrabbedElement == &quot;start&quot;) {</span>
<a href="#l7.3292"></a><span id="l7.3292" class="difflineplus">+                this.mDragState.dragType = &quot;modify-start&quot;;</span>
<a href="#l7.3293"></a><span id="l7.3293" class="difflineplus">+                // we have to use &quot;realEnd&quot; as fixed end value</span>
<a href="#l7.3294"></a><span id="l7.3294" class="difflineplus">+                this.mDragState.limitEndMin = mins.realEnd;</span>
<a href="#l7.3295"></a><span id="l7.3295" class="difflineplus">+</span>
<a href="#l7.3296"></a><span id="l7.3296" class="difflineplus">+                // snap start</span>
<a href="#l7.3297"></a><span id="l7.3297" class="difflineplus">+                this.mDragState.origMin = Math.floor(mins.start / snapIntMin) * snapIntMin;</span>
<a href="#l7.3298"></a><span id="l7.3298" class="difflineplus">+</span>
<a href="#l7.3299"></a><span id="l7.3299" class="difflineplus">+                // show the shadows and drag labels when clicking on gripbars</span>
<a href="#l7.3300"></a><span id="l7.3300" class="difflineplus">+                let shadowElements = this.getShadowElements(this.mDragState.origMin,</span>
<a href="#l7.3301"></a><span id="l7.3301" class="difflineplus">+                                                            this.mDragState.limitEndMin);</span>
<a href="#l7.3302"></a><span id="l7.3302" class="difflineplus">+                this.mDragState.startMin = shadowElements.startMin;</span>
<a href="#l7.3303"></a><span id="l7.3303" class="difflineplus">+                this.mDragState.endMin = shadowElements.endMin;</span>
<a href="#l7.3304"></a><span id="l7.3304" class="difflineplus">+                this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3305"></a><span id="l7.3305" class="difflineplus">+                this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3306"></a><span id="l7.3306" class="difflineplus">+                this.updateShadowsBoxes(this.mDragState.origMin, this.mDragState.endMin,</span>
<a href="#l7.3307"></a><span id="l7.3307" class="difflineplus">+                                        0, this.mDragState.shadows,</span>
<a href="#l7.3308"></a><span id="l7.3308" class="difflineplus">+                                        sizeattr);</span>
<a href="#l7.3309"></a><span id="l7.3309" class="difflineplus">+</span>
<a href="#l7.3310"></a><span id="l7.3310" class="difflineplus">+                // update drag labels</span>
<a href="#l7.3311"></a><span id="l7.3311" class="difflineplus">+                let lastCol = this.firstLastShadowColumns().lastCol;</span>
<a href="#l7.3312"></a><span id="l7.3312" class="difflineplus">+                this.updateDragLabels(this, lastCol);</span>
<a href="#l7.3313"></a><span id="l7.3313" class="difflineplus">+            } else if (aGrabbedElement == &quot;end&quot;) {</span>
<a href="#l7.3314"></a><span id="l7.3314" class="difflineplus">+                this.mDragState.dragType = &quot;modify-end&quot;;</span>
<a href="#l7.3315"></a><span id="l7.3315" class="difflineplus">+                // we have to use &quot;realStart&quot; as fixed end value</span>
<a href="#l7.3316"></a><span id="l7.3316" class="difflineplus">+                this.mDragState.limitStartMin = mins.realStart;</span>
<a href="#l7.3317"></a><span id="l7.3317" class="difflineplus">+</span>
<a href="#l7.3318"></a><span id="l7.3318" class="difflineplus">+                // snap end</span>
<a href="#l7.3319"></a><span id="l7.3319" class="difflineplus">+                this.mDragState.origMin = Math.floor(mins.end / snapIntMin) * snapIntMin;</span>
<a href="#l7.3320"></a><span id="l7.3320" class="difflineplus">+</span>
<a href="#l7.3321"></a><span id="l7.3321" class="difflineplus">+                // show the shadows and drag labels when clicking on gripbars</span>
<a href="#l7.3322"></a><span id="l7.3322" class="difflineplus">+                let shadowElements = this.getShadowElements(this.mDragState.limitStartMin,</span>
<a href="#l7.3323"></a><span id="l7.3323" class="difflineplus">+                                                            this.mDragState.origMin);</span>
<a href="#l7.3324"></a><span id="l7.3324" class="difflineplus">+                this.mDragState.startMin = shadowElements.startMin;</span>
<a href="#l7.3325"></a><span id="l7.3325" class="difflineplus">+                this.mDragState.endMin = shadowElements.endMin;</span>
<a href="#l7.3326"></a><span id="l7.3326" class="difflineplus">+                this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3327"></a><span id="l7.3327" class="difflineplus">+                this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3328"></a><span id="l7.3328" class="difflineplus">+                this.updateShadowsBoxes(this.mDragState.startMin, this.mDragState.endMin,</span>
<a href="#l7.3329"></a><span id="l7.3329" class="difflineplus">+                                        shadowElements.offset, this.mDragState.shadows,</span>
<a href="#l7.3330"></a><span id="l7.3330" class="difflineplus">+                                        sizeattr);</span>
<a href="#l7.3331"></a><span id="l7.3331" class="difflineplus">+</span>
<a href="#l7.3332"></a><span id="l7.3332" class="difflineplus">+                // update drag labels</span>
<a href="#l7.3333"></a><span id="l7.3333" class="difflineplus">+                let firstCol = this.firstLastShadowColumns().firstCol;</span>
<a href="#l7.3334"></a><span id="l7.3334" class="difflineplus">+                this.updateDragLabels(firstCol, this);</span>
<a href="#l7.3335"></a><span id="l7.3335" class="difflineplus">+            } else if (aGrabbedElement == &quot;middle&quot;) {</span>
<a href="#l7.3336"></a><span id="l7.3336" class="difflineplus">+                this.mDragState.dragType = &quot;move&quot;;</span>
<a href="#l7.3337"></a><span id="l7.3337" class="difflineplus">+                // in a move, origMin will be the start minute of the element where</span>
<a href="#l7.3338"></a><span id="l7.3338" class="difflineplus">+                // the drag occurs. Along with mouseOffset, it allows to track the</span>
<a href="#l7.3339"></a><span id="l7.3339" class="difflineplus">+                // shadow position. origMinStart and origMinEnd allow to figure out</span>
<a href="#l7.3340"></a><span id="l7.3340" class="difflineplus">+                // the real shadow size.</span>
<a href="#l7.3341"></a><span id="l7.3341" class="difflineplus">+                // We snap to the start and add the real duration to find the end</span>
<a href="#l7.3342"></a><span id="l7.3342" class="difflineplus">+                let limitDurationMin = mins.realEnd - mins.realStart;</span>
<a href="#l7.3343"></a><span id="l7.3343" class="difflineplus">+                this.mDragState.origMin = Math.floor(mins.start / snapIntMin) * snapIntMin;</span>
<a href="#l7.3344"></a><span id="l7.3344" class="difflineplus">+                this.mDragState.origMinStart = Math.floor(mins.realStart / snapIntMin) * snapIntMin;</span>
<a href="#l7.3345"></a><span id="l7.3345" class="difflineplus">+                this.mDragState.origMinEnd = this.mDragState.origMinStart + limitDurationMin;</span>
<a href="#l7.3346"></a><span id="l7.3346" class="difflineplus">+                // Keep also track of the real Start, it will be used at the end</span>
<a href="#l7.3347"></a><span id="l7.3347" class="difflineplus">+                // of the drag session to calculate the new start and end datetimes.</span>
<a href="#l7.3348"></a><span id="l7.3348" class="difflineplus">+                this.mDragState.realStart = mins.realStart;</span>
<a href="#l7.3349"></a><span id="l7.3349" class="difflineplus">+</span>
<a href="#l7.3350"></a><span id="l7.3350" class="difflineplus">+                let shadowElements = this.getShadowElements(this.mDragState.origMinStart,</span>
<a href="#l7.3351"></a><span id="l7.3351" class="difflineplus">+                                                            this.mDragState.origMinEnd);</span>
<a href="#l7.3352"></a><span id="l7.3352" class="difflineplus">+                this.mDragState.shadows = shadowElements.shadows;</span>
<a href="#l7.3353"></a><span id="l7.3353" class="difflineplus">+                this.mDragState.offset = shadowElements.offset;</span>
<a href="#l7.3354"></a><span id="l7.3354" class="difflineplus">+                // we need to set a mouse offset, since we're not dragging from</span>
<a href="#l7.3355"></a><span id="l7.3355" class="difflineplus">+                // one end of the element</span>
<a href="#l7.3356"></a><span id="l7.3356" class="difflineplus">+                if (aEventBox) {</span>
<a href="#l7.3357"></a><span id="l7.3357" class="difflineplus">+                    if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3358"></a><span id="l7.3358" class="difflineplus">+                        this.mDragState.mouseOffset = aMouseY - aEventBox.boxObject.screenY;</span>
<a href="#l7.3359"></a><span id="l7.3359" class="difflineplus">+                    } else {</span>
<a href="#l7.3360"></a><span id="l7.3360" class="difflineplus">+                        this.mDragState.mouseOffset = aMouseX - aEventBox.boxObject.screenX;</span>
<a href="#l7.3361"></a><span id="l7.3361" class="difflineplus">+                    }</span>
<a href="#l7.3362"></a><span id="l7.3362" class="difflineplus">+                }</span>
<a href="#l7.3363"></a><span id="l7.3363" class="difflineplus">+            } else {</span>
<a href="#l7.3364"></a><span id="l7.3364" class="difflineplus">+                // Invalid grabbed element.</span>
<a href="#l7.3365"></a><span id="l7.3365" class="difflineplus">+            }</span>
<a href="#l7.3366"></a><span id="l7.3366" class="difflineplus">+</span>
<a href="#l7.3367"></a><span id="l7.3367" class="difflineplus">+            document.calendarEventColumnDragging = this;</span>
<a href="#l7.3368"></a><span id="l7.3368" class="difflineplus">+</span>
<a href="#l7.3369"></a><span id="l7.3369" class="difflineplus">+            window.addEventListener(&quot;mousemove&quot;, this.onEventSweepMouseMove);</span>
<a href="#l7.3370"></a><span id="l7.3370" class="difflineplus">+            window.addEventListener(&quot;mouseup&quot;, this.onEventSweepMouseUp);</span>
<a href="#l7.3371"></a><span id="l7.3371" class="difflineplus">+            window.addEventListener(&quot;keypress&quot;, this.onEventSweepKeypress);</span>
<a href="#l7.3372"></a><span id="l7.3372">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3373"></a><span id="l7.3373">       &lt;/method&gt;</span>
<a href="#l7.3374"></a><span id="l7.3374"> </span>
<a href="#l7.3375"></a><span id="l7.3375">       &lt;!-- called by sibling columns to tell us to take over the sweeping</span>
<a href="#l7.3376"></a><span id="l7.3376">          - of an event.</span>
<a href="#l7.3377"></a><span id="l7.3377">         --&gt;</span>
<a href="#l7.3378"></a><span id="l7.3378">       &lt;method name=&quot;acceptInProgressSweep&quot;&gt;</span>
<a href="#l7.3379"></a><span id="l7.3379">         &lt;parameter name=&quot;aDragState&quot;/&gt;</span>
<a href="#l7.3380"></a><span id="l7.3380">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3381"></a><span id="l7.3381" class="difflineminus">-          this.mDragState = aDragState;</span>
<a href="#l7.3382"></a><span id="l7.3382" class="difflineminus">-          document.calendarEventColumnDragging = this;</span>
<a href="#l7.3383"></a><span id="l7.3383" class="difflineminus">-</span>
<a href="#l7.3384"></a><span id="l7.3384" class="difflineminus">-          this.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.3385"></a><span id="l7.3385" class="difflineminus">-          this.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.3386"></a><span id="l7.3386" class="difflineminus">-</span>
<a href="#l7.3387"></a><span id="l7.3387" class="difflineminus">-          // the same event handlers are still valid,</span>
<a href="#l7.3388"></a><span id="l7.3388" class="difflineminus">-          // because they use document.calendarEventColumnDragging.</span>
<a href="#l7.3389"></a><span id="l7.3389" class="difflineminus">-          // So we really don't have anything to do here.</span>
<a href="#l7.3390"></a><span id="l7.3390" class="difflineplus">+            this.mDragState = aDragState;</span>
<a href="#l7.3391"></a><span id="l7.3391" class="difflineplus">+            document.calendarEventColumnDragging = this;</span>
<a href="#l7.3392"></a><span id="l7.3392" class="difflineplus">+</span>
<a href="#l7.3393"></a><span id="l7.3393" class="difflineplus">+            this.fgboxes.box.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.3394"></a><span id="l7.3394" class="difflineplus">+            this.fgboxes.dragbox.setAttribute(&quot;dragging&quot;, &quot;true&quot;);</span>
<a href="#l7.3395"></a><span id="l7.3395" class="difflineplus">+</span>
<a href="#l7.3396"></a><span id="l7.3396" class="difflineplus">+            // the same event handlers are still valid,</span>
<a href="#l7.3397"></a><span id="l7.3397" class="difflineplus">+            // because they use document.calendarEventColumnDragging.</span>
<a href="#l7.3398"></a><span id="l7.3398" class="difflineplus">+            // So we really don't have anything to do here.</span>
<a href="#l7.3399"></a><span id="l7.3399">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3400"></a><span id="l7.3400">       &lt;/method&gt;</span>
<a href="#l7.3401"></a><span id="l7.3401"> </span>
<a href="#l7.3402"></a><span id="l7.3402">       &lt;method name=&quot;updateDragLabels&quot;&gt;</span>
<a href="#l7.3403"></a><span id="l7.3403">         &lt;parameter name=&quot;aFirstColumn&quot;/&gt;</span>
<a href="#l7.3404"></a><span id="l7.3404">         &lt;parameter name=&quot;aLastColumn&quot;/&gt;</span>
<a href="#l7.3405"></a><span id="l7.3405">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3406"></a><span id="l7.3406" class="difflineminus">-          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3407"></a><span id="l7.3407" class="difflineminus">-          if (!this.mDragState) {</span>
<a href="#l7.3408"></a><span id="l7.3408" class="difflineminus">-              return;</span>
<a href="#l7.3409"></a><span id="l7.3409" class="difflineminus">-          }</span>
<a href="#l7.3410"></a><span id="l7.3410" class="difflineminus">-</span>
<a href="#l7.3411"></a><span id="l7.3411" class="difflineminus">-          let firstColumn = aFirstColumn || this;</span>
<a href="#l7.3412"></a><span id="l7.3412" class="difflineminus">-          let lastColumn = aLastColumn || this;</span>
<a href="#l7.3413"></a><span id="l7.3413" class="difflineminus">-          let realstartmin = this.mDragState.startMin + this.mStartMin;</span>
<a href="#l7.3414"></a><span id="l7.3414" class="difflineminus">-          let realendmin = this.mDragState.endMin + this.mStartMin;</span>
<a href="#l7.3415"></a><span id="l7.3415" class="difflineminus">-          let starthr = Math.floor(realstartmin / 60);</span>
<a href="#l7.3416"></a><span id="l7.3416" class="difflineminus">-          let startmin = realstartmin % 60;</span>
<a href="#l7.3417"></a><span id="l7.3417" class="difflineminus">-</span>
<a href="#l7.3418"></a><span id="l7.3418" class="difflineminus">-          let endhr = Math.floor(realendmin / 60);</span>
<a href="#l7.3419"></a><span id="l7.3419" class="difflineminus">-          let endmin = realendmin % 60;</span>
<a href="#l7.3420"></a><span id="l7.3420" class="difflineminus">-</span>
<a href="#l7.3421"></a><span id="l7.3421" class="difflineminus">-          let timeFormatter = cal.getDateFormatter();</span>
<a href="#l7.3422"></a><span id="l7.3422" class="difflineminus">-</span>
<a href="#l7.3423"></a><span id="l7.3423" class="difflineminus">-          let jsTime = new Date();</span>
<a href="#l7.3424"></a><span id="l7.3424" class="difflineminus">-          jsTime.setHours(starthr, startmin);</span>
<a href="#l7.3425"></a><span id="l7.3425" class="difflineminus">-          let startstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.3426"></a><span id="l7.3426" class="difflineminus">-          jsTime.setHours(endhr, endmin);</span>
<a href="#l7.3427"></a><span id="l7.3427" class="difflineminus">-          let endstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.3428"></a><span id="l7.3428" class="difflineminus">-</span>
<a href="#l7.3429"></a><span id="l7.3429" class="difflineminus">-          // Tasks without Entry or Due date have a string as first label</span>
<a href="#l7.3430"></a><span id="l7.3430" class="difflineminus">-          // instead of the time.</span>
<a href="#l7.3431"></a><span id="l7.3431" class="difflineminus">-          if (cal.isToDo(this.mDragState.dragOccurrence)) {</span>
<a href="#l7.3432"></a><span id="l7.3432" class="difflineminus">-              if (!this.mDragState.dragOccurrence.dueDate) {</span>
<a href="#l7.3433"></a><span id="l7.3433" class="difflineminus">-                  startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l7.3434"></a><span id="l7.3434" class="difflineminus">-              } else if (!this.mDragState.dragOccurrence.entryDate) {</span>
<a href="#l7.3435"></a><span id="l7.3435" class="difflineminus">-                  startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyDueDate&quot;);</span>
<a href="#l7.3436"></a><span id="l7.3436" class="difflineminus">-              }</span>
<a href="#l7.3437"></a><span id="l7.3437" class="difflineminus">-          }</span>
<a href="#l7.3438"></a><span id="l7.3438" class="difflineminus">-          firstColumn.fgboxes.startlabel.setAttribute(&quot;value&quot;, startstr);</span>
<a href="#l7.3439"></a><span id="l7.3439" class="difflineminus">-          lastColumn.fgboxes.endlabel.setAttribute(&quot;value&quot;, endstr);</span>
<a href="#l7.3440"></a><span id="l7.3440" class="difflineplus">+            Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3441"></a><span id="l7.3441" class="difflineplus">+            if (!this.mDragState) {</span>
<a href="#l7.3442"></a><span id="l7.3442" class="difflineplus">+                return;</span>
<a href="#l7.3443"></a><span id="l7.3443" class="difflineplus">+            }</span>
<a href="#l7.3444"></a><span id="l7.3444" class="difflineplus">+</span>
<a href="#l7.3445"></a><span id="l7.3445" class="difflineplus">+            let firstColumn = aFirstColumn || this;</span>
<a href="#l7.3446"></a><span id="l7.3446" class="difflineplus">+            let lastColumn = aLastColumn || this;</span>
<a href="#l7.3447"></a><span id="l7.3447" class="difflineplus">+            let realstartmin = this.mDragState.startMin + this.mStartMin;</span>
<a href="#l7.3448"></a><span id="l7.3448" class="difflineplus">+            let realendmin = this.mDragState.endMin + this.mStartMin;</span>
<a href="#l7.3449"></a><span id="l7.3449" class="difflineplus">+            let starthr = Math.floor(realstartmin / 60);</span>
<a href="#l7.3450"></a><span id="l7.3450" class="difflineplus">+            let startmin = realstartmin % 60;</span>
<a href="#l7.3451"></a><span id="l7.3451" class="difflineplus">+</span>
<a href="#l7.3452"></a><span id="l7.3452" class="difflineplus">+            let endhr = Math.floor(realendmin / 60);</span>
<a href="#l7.3453"></a><span id="l7.3453" class="difflineplus">+            let endmin = realendmin % 60;</span>
<a href="#l7.3454"></a><span id="l7.3454" class="difflineplus">+</span>
<a href="#l7.3455"></a><span id="l7.3455" class="difflineplus">+            let timeFormatter = cal.getDateFormatter();</span>
<a href="#l7.3456"></a><span id="l7.3456" class="difflineplus">+</span>
<a href="#l7.3457"></a><span id="l7.3457" class="difflineplus">+            let jsTime = new Date();</span>
<a href="#l7.3458"></a><span id="l7.3458" class="difflineplus">+            jsTime.setHours(starthr, startmin);</span>
<a href="#l7.3459"></a><span id="l7.3459" class="difflineplus">+            let startstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.3460"></a><span id="l7.3460" class="difflineplus">+            jsTime.setHours(endhr, endmin);</span>
<a href="#l7.3461"></a><span id="l7.3461" class="difflineplus">+            let endstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l7.3462"></a><span id="l7.3462" class="difflineplus">+</span>
<a href="#l7.3463"></a><span id="l7.3463" class="difflineplus">+            // Tasks without Entry or Due date have a string as first label</span>
<a href="#l7.3464"></a><span id="l7.3464" class="difflineplus">+            // instead of the time.</span>
<a href="#l7.3465"></a><span id="l7.3465" class="difflineplus">+            if (cal.isToDo(this.mDragState.dragOccurrence)) {</span>
<a href="#l7.3466"></a><span id="l7.3466" class="difflineplus">+                if (!this.mDragState.dragOccurrence.dueDate) {</span>
<a href="#l7.3467"></a><span id="l7.3467" class="difflineplus">+                    startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l7.3468"></a><span id="l7.3468" class="difflineplus">+                } else if (!this.mDragState.dragOccurrence.entryDate) {</span>
<a href="#l7.3469"></a><span id="l7.3469" class="difflineplus">+                    startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyDueDate&quot;);</span>
<a href="#l7.3470"></a><span id="l7.3470" class="difflineplus">+                }</span>
<a href="#l7.3471"></a><span id="l7.3471" class="difflineplus">+            }</span>
<a href="#l7.3472"></a><span id="l7.3472" class="difflineplus">+            firstColumn.fgboxes.startlabel.setAttribute(&quot;value&quot;, startstr);</span>
<a href="#l7.3473"></a><span id="l7.3473" class="difflineplus">+            lastColumn.fgboxes.endlabel.setAttribute(&quot;value&quot;, endstr);</span>
<a href="#l7.3474"></a><span id="l7.3474"> </span>
<a href="#l7.3475"></a><span id="l7.3475">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3476"></a><span id="l7.3476">       &lt;/method&gt;</span>
<a href="#l7.3477"></a><span id="l7.3477"> </span>
<a href="#l7.3478"></a><span id="l7.3478">       &lt;method name=&quot;setDayStartEndMinutes&quot;&gt;</span>
<a href="#l7.3479"></a><span id="l7.3479">         &lt;parameter name=&quot;aDayStartMin&quot;/&gt;</span>
<a href="#l7.3480"></a><span id="l7.3480">         &lt;parameter name=&quot;aDayEndMin&quot;/&gt;</span>
<a href="#l7.3481"></a><span id="l7.3481">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3482"></a><span id="l7.3482" class="difflineminus">-          if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l7.3483"></a><span id="l7.3483" class="difflineminus">-              aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l7.3484"></a><span id="l7.3484" class="difflineminus">-              throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.3485"></a><span id="l7.3485" class="difflineminus">-          }</span>
<a href="#l7.3486"></a><span id="l7.3486" class="difflineminus">-          if (this.mDayStartMin != aDayStartMin || this.mDayEndMin != aDayEndMin) {</span>
<a href="#l7.3487"></a><span id="l7.3487" class="difflineminus">-              this.mDayStartMin = aDayStartMin;</span>
<a href="#l7.3488"></a><span id="l7.3488" class="difflineminus">-              this.mDayEndMin = aDayEndMin;</span>
<a href="#l7.3489"></a><span id="l7.3489" class="difflineminus">-          }</span>
<a href="#l7.3490"></a><span id="l7.3490" class="difflineplus">+            if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l7.3491"></a><span id="l7.3491" class="difflineplus">+                aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l7.3492"></a><span id="l7.3492" class="difflineplus">+                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.3493"></a><span id="l7.3493" class="difflineplus">+            }</span>
<a href="#l7.3494"></a><span id="l7.3494" class="difflineplus">+            if (this.mDayStartMin != aDayStartMin || this.mDayEndMin != aDayEndMin) {</span>
<a href="#l7.3495"></a><span id="l7.3495" class="difflineplus">+                this.mDayStartMin = aDayStartMin;</span>
<a href="#l7.3496"></a><span id="l7.3496" class="difflineplus">+                this.mDayEndMin = aDayEndMin;</span>
<a href="#l7.3497"></a><span id="l7.3497" class="difflineplus">+            }</span>
<a href="#l7.3498"></a><span id="l7.3498">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3499"></a><span id="l7.3499">       &lt;/method&gt;</span>
<a href="#l7.3500"></a><span id="l7.3500"> </span>
<a href="#l7.3501"></a><span id="l7.3501">       &lt;method name=&quot;getClickedDateTime&quot;&gt;</span>
<a href="#l7.3502"></a><span id="l7.3502">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l7.3503"></a><span id="l7.3503">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3504"></a><span id="l7.3504" class="difflineminus">-          let newStart = this.date.clone();</span>
<a href="#l7.3505"></a><span id="l7.3505" class="difflineminus">-          newStart.isDate = false;</span>
<a href="#l7.3506"></a><span id="l7.3506" class="difflineminus">-          newStart.hour = 0;</span>
<a href="#l7.3507"></a><span id="l7.3507" class="difflineminus">-</span>
<a href="#l7.3508"></a><span id="l7.3508" class="difflineminus">-          const ROUND_INTERVAL = 15;</span>
<a href="#l7.3509"></a><span id="l7.3509" class="difflineminus">-</span>
<a href="#l7.3510"></a><span id="l7.3510" class="difflineminus">-          let interval = this.mPixPerMin * ROUND_INTERVAL;</span>
<a href="#l7.3511"></a><span id="l7.3511" class="difflineminus">-          let pos;</span>
<a href="#l7.3512"></a><span id="l7.3512" class="difflineminus">-          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3513"></a><span id="l7.3513" class="difflineminus">-              pos = event.screenY - this.parentNode.boxObject.screenY;</span>
<a href="#l7.3514"></a><span id="l7.3514" class="difflineminus">-          } else {</span>
<a href="#l7.3515"></a><span id="l7.3515" class="difflineminus">-              pos = event.screenX - this.parentNode.boxObject.screenX;</span>
<a href="#l7.3516"></a><span id="l7.3516" class="difflineminus">-          }</span>
<a href="#l7.3517"></a><span id="l7.3517" class="difflineminus">-          newStart.minute = (Math.round(pos / interval) * ROUND_INTERVAL) + this.mStartMin;</span>
<a href="#l7.3518"></a><span id="l7.3518" class="difflineminus">-          event.stopPropagation();</span>
<a href="#l7.3519"></a><span id="l7.3519" class="difflineminus">-          return newStart;</span>
<a href="#l7.3520"></a><span id="l7.3520" class="difflineplus">+            let newStart = this.date.clone();</span>
<a href="#l7.3521"></a><span id="l7.3521" class="difflineplus">+            newStart.isDate = false;</span>
<a href="#l7.3522"></a><span id="l7.3522" class="difflineplus">+            newStart.hour = 0;</span>
<a href="#l7.3523"></a><span id="l7.3523" class="difflineplus">+</span>
<a href="#l7.3524"></a><span id="l7.3524" class="difflineplus">+            const ROUND_INTERVAL = 15;</span>
<a href="#l7.3525"></a><span id="l7.3525" class="difflineplus">+</span>
<a href="#l7.3526"></a><span id="l7.3526" class="difflineplus">+            let interval = this.mPixPerMin * ROUND_INTERVAL;</span>
<a href="#l7.3527"></a><span id="l7.3527" class="difflineplus">+            let pos;</span>
<a href="#l7.3528"></a><span id="l7.3528" class="difflineplus">+            if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3529"></a><span id="l7.3529" class="difflineplus">+                pos = event.screenY - this.parentNode.boxObject.screenY;</span>
<a href="#l7.3530"></a><span id="l7.3530" class="difflineplus">+            } else {</span>
<a href="#l7.3531"></a><span id="l7.3531" class="difflineplus">+                pos = event.screenX - this.parentNode.boxObject.screenX;</span>
<a href="#l7.3532"></a><span id="l7.3532" class="difflineplus">+            }</span>
<a href="#l7.3533"></a><span id="l7.3533" class="difflineplus">+            newStart.minute = (Math.round(pos / interval) * ROUND_INTERVAL) + this.mStartMin;</span>
<a href="#l7.3534"></a><span id="l7.3534" class="difflineplus">+            event.stopPropagation();</span>
<a href="#l7.3535"></a><span id="l7.3535" class="difflineplus">+            return newStart;</span>
<a href="#l7.3536"></a><span id="l7.3536">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3537"></a><span id="l7.3537">       &lt;/method&gt;</span>
<a href="#l7.3538"></a><span id="l7.3538">     &lt;/implementation&gt;</span>
<a href="#l7.3539"></a><span id="l7.3539"> </span>
<a href="#l7.3540"></a><span id="l7.3540">     &lt;handlers&gt;</span>
<a href="#l7.3541"></a><span id="l7.3541">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3542"></a><span id="l7.3542" class="difflineminus">-        if (this.calendarView.controller) {</span>
<a href="#l7.3543"></a><span id="l7.3543" class="difflineminus">-            let newStart = getClickedDateTime(event);</span>
<a href="#l7.3544"></a><span id="l7.3544" class="difflineminus">-            this.calendarView.controller.createNewEvent(null, newStart, null);</span>
<a href="#l7.3545"></a><span id="l7.3545" class="difflineminus">-        }</span>
<a href="#l7.3546"></a><span id="l7.3546" class="difflineplus">+          if (this.calendarView.controller) {</span>
<a href="#l7.3547"></a><span id="l7.3547" class="difflineplus">+              let newStart = getClickedDateTime(event);</span>
<a href="#l7.3548"></a><span id="l7.3548" class="difflineplus">+              this.calendarView.controller.createNewEvent(null, newStart, null);</span>
<a href="#l7.3549"></a><span id="l7.3549" class="difflineplus">+          }</span>
<a href="#l7.3550"></a><span id="l7.3550">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3551"></a><span id="l7.3551"> </span>
<a href="#l7.3552"></a><span id="l7.3552">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3553"></a><span id="l7.3553" class="difflineminus">-        if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l7.3554"></a><span id="l7.3554" class="difflineminus">-            this.calendarView.setSelectedItems(0, []);</span>
<a href="#l7.3555"></a><span id="l7.3555" class="difflineminus">-            this.focus();</span>
<a href="#l7.3556"></a><span id="l7.3556" class="difflineminus">-        }</span>
<a href="#l7.3557"></a><span id="l7.3557" class="difflineplus">+          if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l7.3558"></a><span id="l7.3558" class="difflineplus">+              this.calendarView.setSelectedItems(0, []);</span>
<a href="#l7.3559"></a><span id="l7.3559" class="difflineplus">+              this.focus();</span>
<a href="#l7.3560"></a><span id="l7.3560" class="difflineplus">+          }</span>
<a href="#l7.3561"></a><span id="l7.3561">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3562"></a><span id="l7.3562"> </span>
<a href="#l7.3563"></a><span id="l7.3563">       &lt;handler event=&quot;click&quot; button=&quot;2&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3564"></a><span id="l7.3564" class="difflineminus">-        let newStart = getClickedDateTime(event);</span>
<a href="#l7.3565"></a><span id="l7.3565" class="difflineminus">-        this.calendarView.selectedDateTime = newStart;</span>
<a href="#l7.3566"></a><span id="l7.3566" class="difflineplus">+          let newStart = getClickedDateTime(event);</span>
<a href="#l7.3567"></a><span id="l7.3567" class="difflineplus">+          this.calendarView.selectedDateTime = newStart;</span>
<a href="#l7.3568"></a><span id="l7.3568">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3569"></a><span id="l7.3569"> </span>
<a href="#l7.3570"></a><span id="l7.3570">       &lt;!-- mouse down handler, in empty event column regions.  Starts sweeping out a new</span>
<a href="#l7.3571"></a><span id="l7.3571">          - event.</span>
<a href="#l7.3572"></a><span id="l7.3572">         --&gt;</span>
<a href="#l7.3573"></a><span id="l7.3573">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3574"></a><span id="l7.3574" class="difflineminus">-        // select this column</span>
<a href="#l7.3575"></a><span id="l7.3575" class="difflineminus">-        this.calendarView.selectedDay = this.mDate;</span>
<a href="#l7.3576"></a><span id="l7.3576" class="difflineminus">-</span>
<a href="#l7.3577"></a><span id="l7.3577" class="difflineminus">-        // If the selected calendar is readOnly, we don't want any sweeping.</span>
<a href="#l7.3578"></a><span id="l7.3578" class="difflineminus">-        let calendar = getSelectedCalendar();</span>
<a href="#l7.3579"></a><span id="l7.3579" class="difflineminus">-        if (!cal.isCalendarWritable(calendar) ||</span>
<a href="#l7.3580"></a><span id="l7.3580" class="difflineminus">-            calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l7.3581"></a><span id="l7.3581" class="difflineminus">-            return;</span>
<a href="#l7.3582"></a><span id="l7.3582" class="difflineminus">-        }</span>
<a href="#l7.3583"></a><span id="l7.3583" class="difflineminus">-</span>
<a href="#l7.3584"></a><span id="l7.3584" class="difflineminus">-        // Only start sweeping out an event if the left button was clicked</span>
<a href="#l7.3585"></a><span id="l7.3585" class="difflineminus">-        if (event.button != 0) {</span>
<a href="#l7.3586"></a><span id="l7.3586" class="difflineminus">-            return;</span>
<a href="#l7.3587"></a><span id="l7.3587" class="difflineminus">-        }</span>
<a href="#l7.3588"></a><span id="l7.3588" class="difflineminus">-</span>
<a href="#l7.3589"></a><span id="l7.3589" class="difflineminus">-        this.mDragState = {</span>
<a href="#l7.3590"></a><span id="l7.3590" class="difflineminus">-            origColumn: this,</span>
<a href="#l7.3591"></a><span id="l7.3591" class="difflineminus">-            dragType: &quot;new&quot;,</span>
<a href="#l7.3592"></a><span id="l7.3592" class="difflineminus">-            mouseOffset: 0,</span>
<a href="#l7.3593"></a><span id="l7.3593" class="difflineminus">-            offset: null,</span>
<a href="#l7.3594"></a><span id="l7.3594" class="difflineminus">-            shadows: null,</span>
<a href="#l7.3595"></a><span id="l7.3595" class="difflineminus">-            limitStartMin: null,</span>
<a href="#l7.3596"></a><span id="l7.3596" class="difflineminus">-            limitEndMin: null,</span>
<a href="#l7.3597"></a><span id="l7.3597" class="difflineminus">-            jumpedColumns: 0</span>
<a href="#l7.3598"></a><span id="l7.3598" class="difflineminus">-        };</span>
<a href="#l7.3599"></a><span id="l7.3599" class="difflineminus">-</span>
<a href="#l7.3600"></a><span id="l7.3600" class="difflineminus">-        // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.3601"></a><span id="l7.3601" class="difflineminus">-        let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.3602"></a><span id="l7.3602" class="difflineminus">-                          !event.ctrlKey &amp;&amp;</span>
<a href="#l7.3603"></a><span id="l7.3603" class="difflineminus">-                          !event.altKey &amp;&amp;</span>
<a href="#l7.3604"></a><span id="l7.3604" class="difflineminus">-                          !event.metaKey) ? 1 : 15;</span>
<a href="#l7.3605"></a><span id="l7.3605" class="difflineminus">-        let interval = this.mPixPerMin * snapIntMin;</span>
<a href="#l7.3606"></a><span id="l7.3606" class="difflineminus">-</span>
<a href="#l7.3607"></a><span id="l7.3607" class="difflineminus">-        if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3608"></a><span id="l7.3608" class="difflineminus">-            this.mDragState.origLoc = event.screenY;</span>
<a href="#l7.3609"></a><span id="l7.3609" class="difflineminus">-            this.mDragState.origMin = Math.floor((event.screenY - this.parentNode.boxObject.screenY) / interval) * snapIntMin;</span>
<a href="#l7.3610"></a><span id="l7.3610" class="difflineminus">-            this.mDragState.limitEndMin = this.mDragState.origMin;</span>
<a href="#l7.3611"></a><span id="l7.3611" class="difflineminus">-            this.mDragState.limitStartMin = this.mDragState.origMin;</span>
<a href="#l7.3612"></a><span id="l7.3612" class="difflineminus">-            this.fgboxes.dragspacer.setAttribute(&quot;height&quot;, this.mDragState.origMin * this.mPixPerMin);</span>
<a href="#l7.3613"></a><span id="l7.3613" class="difflineminus">-        } else {</span>
<a href="#l7.3614"></a><span id="l7.3614" class="difflineminus">-            this.mDragState.origLoc = event.screenX;</span>
<a href="#l7.3615"></a><span id="l7.3615" class="difflineminus">-            this.mDragState.origMin = Math.floor((event.screenX - this.parentNode.boxObject.screenX) / interval) * snapIntMin;</span>
<a href="#l7.3616"></a><span id="l7.3616" class="difflineminus">-            this.fgboxes.dragspacer.setAttribute(&quot;width&quot;, this.mDragState.origMin * this.mPixPerMin);</span>
<a href="#l7.3617"></a><span id="l7.3617" class="difflineminus">-        }</span>
<a href="#l7.3618"></a><span id="l7.3618" class="difflineminus">-</span>
<a href="#l7.3619"></a><span id="l7.3619" class="difflineminus">-        document.calendarEventColumnDragging = this;</span>
<a href="#l7.3620"></a><span id="l7.3620" class="difflineminus">-</span>
<a href="#l7.3621"></a><span id="l7.3621" class="difflineminus">-        window.addEventListener(&quot;mousemove&quot;, this.onEventSweepMouseMove);</span>
<a href="#l7.3622"></a><span id="l7.3622" class="difflineminus">-        window.addEventListener(&quot;mouseup&quot;, this.onEventSweepMouseUp);</span>
<a href="#l7.3623"></a><span id="l7.3623" class="difflineminus">-        window.addEventListener(&quot;keypress&quot;, this.onEventSweepKeypress);</span>
<a href="#l7.3624"></a><span id="l7.3624" class="difflineplus">+          // select this column</span>
<a href="#l7.3625"></a><span id="l7.3625" class="difflineplus">+          this.calendarView.selectedDay = this.mDate;</span>
<a href="#l7.3626"></a><span id="l7.3626" class="difflineplus">+</span>
<a href="#l7.3627"></a><span id="l7.3627" class="difflineplus">+          // If the selected calendar is readOnly, we don't want any sweeping.</span>
<a href="#l7.3628"></a><span id="l7.3628" class="difflineplus">+          let calendar = getSelectedCalendar();</span>
<a href="#l7.3629"></a><span id="l7.3629" class="difflineplus">+          if (!cal.isCalendarWritable(calendar) ||</span>
<a href="#l7.3630"></a><span id="l7.3630" class="difflineplus">+              calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l7.3631"></a><span id="l7.3631" class="difflineplus">+              return;</span>
<a href="#l7.3632"></a><span id="l7.3632" class="difflineplus">+          }</span>
<a href="#l7.3633"></a><span id="l7.3633" class="difflineplus">+</span>
<a href="#l7.3634"></a><span id="l7.3634" class="difflineplus">+          // Only start sweeping out an event if the left button was clicked</span>
<a href="#l7.3635"></a><span id="l7.3635" class="difflineplus">+          if (event.button != 0) {</span>
<a href="#l7.3636"></a><span id="l7.3636" class="difflineplus">+              return;</span>
<a href="#l7.3637"></a><span id="l7.3637" class="difflineplus">+          }</span>
<a href="#l7.3638"></a><span id="l7.3638" class="difflineplus">+</span>
<a href="#l7.3639"></a><span id="l7.3639" class="difflineplus">+          this.mDragState = {</span>
<a href="#l7.3640"></a><span id="l7.3640" class="difflineplus">+              origColumn: this,</span>
<a href="#l7.3641"></a><span id="l7.3641" class="difflineplus">+              dragType: &quot;new&quot;,</span>
<a href="#l7.3642"></a><span id="l7.3642" class="difflineplus">+              mouseOffset: 0,</span>
<a href="#l7.3643"></a><span id="l7.3643" class="difflineplus">+              offset: null,</span>
<a href="#l7.3644"></a><span id="l7.3644" class="difflineplus">+              shadows: null,</span>
<a href="#l7.3645"></a><span id="l7.3645" class="difflineplus">+              limitStartMin: null,</span>
<a href="#l7.3646"></a><span id="l7.3646" class="difflineplus">+              limitEndMin: null,</span>
<a href="#l7.3647"></a><span id="l7.3647" class="difflineplus">+              jumpedColumns: 0</span>
<a href="#l7.3648"></a><span id="l7.3648" class="difflineplus">+          };</span>
<a href="#l7.3649"></a><span id="l7.3649" class="difflineplus">+</span>
<a href="#l7.3650"></a><span id="l7.3650" class="difflineplus">+          // snap interval: 15 minutes or 1 minute if modifier key is pressed</span>
<a href="#l7.3651"></a><span id="l7.3651" class="difflineplus">+          let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.3652"></a><span id="l7.3652" class="difflineplus">+                            !event.ctrlKey &amp;&amp;</span>
<a href="#l7.3653"></a><span id="l7.3653" class="difflineplus">+                            !event.altKey &amp;&amp;</span>
<a href="#l7.3654"></a><span id="l7.3654" class="difflineplus">+                            !event.metaKey) ? 1 : 15;</span>
<a href="#l7.3655"></a><span id="l7.3655" class="difflineplus">+          let interval = this.mPixPerMin * snapIntMin;</span>
<a href="#l7.3656"></a><span id="l7.3656" class="difflineplus">+</span>
<a href="#l7.3657"></a><span id="l7.3657" class="difflineplus">+          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3658"></a><span id="l7.3658" class="difflineplus">+              this.mDragState.origLoc = event.screenY;</span>
<a href="#l7.3659"></a><span id="l7.3659" class="difflineplus">+              this.mDragState.origMin = Math.floor((event.screenY - this.parentNode.boxObject.screenY) / interval) * snapIntMin;</span>
<a href="#l7.3660"></a><span id="l7.3660" class="difflineplus">+              this.mDragState.limitEndMin = this.mDragState.origMin;</span>
<a href="#l7.3661"></a><span id="l7.3661" class="difflineplus">+              this.mDragState.limitStartMin = this.mDragState.origMin;</span>
<a href="#l7.3662"></a><span id="l7.3662" class="difflineplus">+              this.fgboxes.dragspacer.setAttribute(&quot;height&quot;, this.mDragState.origMin * this.mPixPerMin);</span>
<a href="#l7.3663"></a><span id="l7.3663" class="difflineplus">+          } else {</span>
<a href="#l7.3664"></a><span id="l7.3664" class="difflineplus">+              this.mDragState.origLoc = event.screenX;</span>
<a href="#l7.3665"></a><span id="l7.3665" class="difflineplus">+              this.mDragState.origMin = Math.floor((event.screenX - this.parentNode.boxObject.screenX) / interval) * snapIntMin;</span>
<a href="#l7.3666"></a><span id="l7.3666" class="difflineplus">+              this.fgboxes.dragspacer.setAttribute(&quot;width&quot;, this.mDragState.origMin * this.mPixPerMin);</span>
<a href="#l7.3667"></a><span id="l7.3667" class="difflineplus">+          }</span>
<a href="#l7.3668"></a><span id="l7.3668" class="difflineplus">+</span>
<a href="#l7.3669"></a><span id="l7.3669" class="difflineplus">+          document.calendarEventColumnDragging = this;</span>
<a href="#l7.3670"></a><span id="l7.3670" class="difflineplus">+</span>
<a href="#l7.3671"></a><span id="l7.3671" class="difflineplus">+          window.addEventListener(&quot;mousemove&quot;, this.onEventSweepMouseMove);</span>
<a href="#l7.3672"></a><span id="l7.3672" class="difflineplus">+          window.addEventListener(&quot;mouseup&quot;, this.onEventSweepMouseUp);</span>
<a href="#l7.3673"></a><span id="l7.3673" class="difflineplus">+          window.addEventListener(&quot;keypress&quot;, this.onEventSweepKeypress);</span>
<a href="#l7.3674"></a><span id="l7.3674">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3675"></a><span id="l7.3675">     &lt;/handlers&gt;</span>
<a href="#l7.3676"></a><span id="l7.3676">   &lt;/binding&gt;</span>
<a href="#l7.3677"></a><span id="l7.3677"> </span>
<a href="#l7.3678"></a><span id="l7.3678">   &lt;binding id=&quot;calendar-header-container&quot; extends=&quot;chrome://calendar/content/widgets/calendar-widgets.xml#dragndropContainer&quot;&gt;</span>
<a href="#l7.3679"></a><span id="l7.3679">     &lt;content xbl:inherits=&quot;selected&quot; flex=&quot;1&quot; class=&quot;calendar-event-column-header&quot;&gt;</span>
<a href="#l7.3680"></a><span id="l7.3680">       &lt;children/&gt;</span>
<a href="#l7.3681"></a><span id="l7.3681">     &lt;/content&gt;</span>
<a href="#l7.3682"></a><span id="l7.3682"> </span>
<a href="#l7.3683"></a><span id="l7.3683">     &lt;implementation&gt;</span>
<a href="#l7.3684"></a><span id="l7.3684">       &lt;field name=&quot;mItemBoxes&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.3685"></a><span id="l7.3685">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.3686"></a><span id="l7.3686" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3687"></a><span id="l7.3687" class="difflineminus">-</span>
<a href="#l7.3688"></a><span id="l7.3688" class="difflineminus">-        this.mItemBoxes = [];</span>
<a href="#l7.3689"></a><span id="l7.3689" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3690"></a><span id="l7.3690" class="difflineplus">+</span>
<a href="#l7.3691"></a><span id="l7.3691" class="difflineplus">+          this.mItemBoxes = [];</span>
<a href="#l7.3692"></a><span id="l7.3692">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.3693"></a><span id="l7.3693"> </span>
<a href="#l7.3694"></a><span id="l7.3694">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l7.3695"></a><span id="l7.3695">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.3696"></a><span id="l7.3696" class="difflineminus">-          return this.mDate;</span>
<a href="#l7.3697"></a><span id="l7.3697" class="difflineplus">+            return this.mDate;</span>
<a href="#l7.3698"></a><span id="l7.3698">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.3699"></a><span id="l7.3699">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.3700"></a><span id="l7.3700" class="difflineminus">-          this.mDate = val;</span>
<a href="#l7.3701"></a><span id="l7.3701" class="difflineminus">-          return val;</span>
<a href="#l7.3702"></a><span id="l7.3702" class="difflineplus">+            this.mDate = val;</span>
<a href="#l7.3703"></a><span id="l7.3703" class="difflineplus">+            return val;</span>
<a href="#l7.3704"></a><span id="l7.3704">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.3705"></a><span id="l7.3705">       &lt;/property&gt;</span>
<a href="#l7.3706"></a><span id="l7.3706">       &lt;method name=&quot;findBoxForItem&quot;&gt;</span>
<a href="#l7.3707"></a><span id="l7.3707">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3708"></a><span id="l7.3708">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3709"></a><span id="l7.3709" class="difflineminus">-          for (let item of this.mItemBoxes) {</span>
<a href="#l7.3710"></a><span id="l7.3710" class="difflineminus">-              if (aItem &amp;&amp; item.occurrence.hasSameIds(aItem)) {</span>
<a href="#l7.3711"></a><span id="l7.3711" class="difflineminus">-                  // We can return directly, since there will only be one box per</span>
<a href="#l7.3712"></a><span id="l7.3712" class="difflineminus">-                  // item in the header.</span>
<a href="#l7.3713"></a><span id="l7.3713" class="difflineminus">-                  return item;</span>
<a href="#l7.3714"></a><span id="l7.3714" class="difflineminus">-              }</span>
<a href="#l7.3715"></a><span id="l7.3715" class="difflineminus">-          }</span>
<a href="#l7.3716"></a><span id="l7.3716" class="difflineminus">-          return null;</span>
<a href="#l7.3717"></a><span id="l7.3717" class="difflineplus">+            for (let item of this.mItemBoxes) {</span>
<a href="#l7.3718"></a><span id="l7.3718" class="difflineplus">+                if (aItem &amp;&amp; item.occurrence.hasSameIds(aItem)) {</span>
<a href="#l7.3719"></a><span id="l7.3719" class="difflineplus">+                    // We can return directly, since there will only be one box per</span>
<a href="#l7.3720"></a><span id="l7.3720" class="difflineplus">+                    // item in the header.</span>
<a href="#l7.3721"></a><span id="l7.3721" class="difflineplus">+                    return item;</span>
<a href="#l7.3722"></a><span id="l7.3722" class="difflineplus">+                }</span>
<a href="#l7.3723"></a><span id="l7.3723" class="difflineplus">+            }</span>
<a href="#l7.3724"></a><span id="l7.3724" class="difflineplus">+            return null;</span>
<a href="#l7.3725"></a><span id="l7.3725">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3726"></a><span id="l7.3726">       &lt;/method&gt;</span>
<a href="#l7.3727"></a><span id="l7.3727"> </span>
<a href="#l7.3728"></a><span id="l7.3728">       &lt;method name=&quot;addEvent&quot;&gt;</span>
<a href="#l7.3729"></a><span id="l7.3729">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3730"></a><span id="l7.3730">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3731"></a><span id="l7.3731" class="difflineminus">-          // prevent same items being added</span>
<a href="#l7.3732"></a><span id="l7.3732" class="difflineminus">-          if (this.mItemBoxes.some(itemBox =&gt; itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3733"></a><span id="l7.3733" class="difflineminus">-              return;</span>
<a href="#l7.3734"></a><span id="l7.3734" class="difflineminus">-          }</span>
<a href="#l7.3735"></a><span id="l7.3735" class="difflineminus">-</span>
<a href="#l7.3736"></a><span id="l7.3736" class="difflineminus">-          let itemBox = createXULElement(&quot;calendar-editable-item&quot;);</span>
<a href="#l7.3737"></a><span id="l7.3737" class="difflineminus">-          this.appendChild(itemBox);</span>
<a href="#l7.3738"></a><span id="l7.3738" class="difflineminus">-          itemBox.calendarView = this.calendarView;</span>
<a href="#l7.3739"></a><span id="l7.3739" class="difflineminus">-          itemBox.occurrence = aItem;</span>
<a href="#l7.3740"></a><span id="l7.3740" class="difflineminus">-          let ctxt = this.calendarView.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l7.3741"></a><span id="l7.3741" class="difflineminus">-                     this.calendarView.getAttribute(&quot;context&quot;);</span>
<a href="#l7.3742"></a><span id="l7.3742" class="difflineminus">-          itemBox.setAttribute(&quot;context&quot;, ctxt);</span>
<a href="#l7.3743"></a><span id="l7.3743" class="difflineminus">-</span>
<a href="#l7.3744"></a><span id="l7.3744" class="difflineminus">-          if (aItem.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l7.3745"></a><span id="l7.3745" class="difflineminus">-              itemBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l7.3746"></a><span id="l7.3746" class="difflineminus">-          }</span>
<a href="#l7.3747"></a><span id="l7.3747" class="difflineminus">-</span>
<a href="#l7.3748"></a><span id="l7.3748" class="difflineminus">-          this.mItemBoxes.push(itemBox);</span>
<a href="#l7.3749"></a><span id="l7.3749" class="difflineminus">-          itemBox.parentBox = this;</span>
<a href="#l7.3750"></a><span id="l7.3750" class="difflineplus">+            // prevent same items being added</span>
<a href="#l7.3751"></a><span id="l7.3751" class="difflineplus">+            if (this.mItemBoxes.some(itemBox =&gt; itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3752"></a><span id="l7.3752" class="difflineplus">+                return;</span>
<a href="#l7.3753"></a><span id="l7.3753" class="difflineplus">+            }</span>
<a href="#l7.3754"></a><span id="l7.3754" class="difflineplus">+</span>
<a href="#l7.3755"></a><span id="l7.3755" class="difflineplus">+            let itemBox = createXULElement(&quot;calendar-editable-item&quot;);</span>
<a href="#l7.3756"></a><span id="l7.3756" class="difflineplus">+            this.appendChild(itemBox);</span>
<a href="#l7.3757"></a><span id="l7.3757" class="difflineplus">+            itemBox.calendarView = this.calendarView;</span>
<a href="#l7.3758"></a><span id="l7.3758" class="difflineplus">+            itemBox.occurrence = aItem;</span>
<a href="#l7.3759"></a><span id="l7.3759" class="difflineplus">+            let ctxt = this.calendarView.getAttribute(&quot;item-context&quot;) ||</span>
<a href="#l7.3760"></a><span id="l7.3760" class="difflineplus">+                       this.calendarView.getAttribute(&quot;context&quot;);</span>
<a href="#l7.3761"></a><span id="l7.3761" class="difflineplus">+            itemBox.setAttribute(&quot;context&quot;, ctxt);</span>
<a href="#l7.3762"></a><span id="l7.3762" class="difflineplus">+</span>
<a href="#l7.3763"></a><span id="l7.3763" class="difflineplus">+            if (aItem.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l7.3764"></a><span id="l7.3764" class="difflineplus">+                itemBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l7.3765"></a><span id="l7.3765" class="difflineplus">+            }</span>
<a href="#l7.3766"></a><span id="l7.3766" class="difflineplus">+</span>
<a href="#l7.3767"></a><span id="l7.3767" class="difflineplus">+            this.mItemBoxes.push(itemBox);</span>
<a href="#l7.3768"></a><span id="l7.3768" class="difflineplus">+            itemBox.parentBox = this;</span>
<a href="#l7.3769"></a><span id="l7.3769">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3770"></a><span id="l7.3770">       &lt;/method&gt;</span>
<a href="#l7.3771"></a><span id="l7.3771"> </span>
<a href="#l7.3772"></a><span id="l7.3772">       &lt;method name=&quot;deleteEvent&quot;&gt;</span>
<a href="#l7.3773"></a><span id="l7.3773">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3774"></a><span id="l7.3774">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3775"></a><span id="l7.3775" class="difflineminus">-          for (let i in this.mItemBoxes) {</span>
<a href="#l7.3776"></a><span id="l7.3776" class="difflineminus">-              if (this.mItemBoxes[i].occurrence.hashId == aItem.hashId) {</span>
<a href="#l7.3777"></a><span id="l7.3777" class="difflineminus">-                  this.mItemBoxes[i].remove();</span>
<a href="#l7.3778"></a><span id="l7.3778" class="difflineminus">-                  this.mItemBoxes.splice(i, 1);</span>
<a href="#l7.3779"></a><span id="l7.3779" class="difflineminus">-                  break;</span>
<a href="#l7.3780"></a><span id="l7.3780" class="difflineminus">-              }</span>
<a href="#l7.3781"></a><span id="l7.3781" class="difflineminus">-          }</span>
<a href="#l7.3782"></a><span id="l7.3782" class="difflineplus">+            for (let i in this.mItemBoxes) {</span>
<a href="#l7.3783"></a><span id="l7.3783" class="difflineplus">+                if (this.mItemBoxes[i].occurrence.hashId == aItem.hashId) {</span>
<a href="#l7.3784"></a><span id="l7.3784" class="difflineplus">+                    this.mItemBoxes[i].remove();</span>
<a href="#l7.3785"></a><span id="l7.3785" class="difflineplus">+                    this.mItemBoxes.splice(i, 1);</span>
<a href="#l7.3786"></a><span id="l7.3786" class="difflineplus">+                    break;</span>
<a href="#l7.3787"></a><span id="l7.3787" class="difflineplus">+                }</span>
<a href="#l7.3788"></a><span id="l7.3788" class="difflineplus">+            }</span>
<a href="#l7.3789"></a><span id="l7.3789">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3790"></a><span id="l7.3790">       &lt;/method&gt;</span>
<a href="#l7.3791"></a><span id="l7.3791"> </span>
<a href="#l7.3792"></a><span id="l7.3792">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l7.3793"></a><span id="l7.3793">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3794"></a><span id="l7.3794">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3795"></a><span id="l7.3795" class="difflineminus">-         let newItem = cal.moveItem(aItem, this.mDate);</span>
<a href="#l7.3796"></a><span id="l7.3796" class="difflineminus">-         newItem = cal.setItemToAllDay(newItem, true);</span>
<a href="#l7.3797"></a><span id="l7.3797" class="difflineminus">-         return newItem;</span>
<a href="#l7.3798"></a><span id="l7.3798" class="difflineplus">+            let newItem = cal.moveItem(aItem, this.mDate);</span>
<a href="#l7.3799"></a><span id="l7.3799" class="difflineplus">+            newItem = cal.setItemToAllDay(newItem, true);</span>
<a href="#l7.3800"></a><span id="l7.3800" class="difflineplus">+            return newItem;</span>
<a href="#l7.3801"></a><span id="l7.3801">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3802"></a><span id="l7.3802">       &lt;/method&gt;</span>
<a href="#l7.3803"></a><span id="l7.3803"> </span>
<a href="#l7.3804"></a><span id="l7.3804">       &lt;method name=&quot;selectOccurrence&quot;&gt;</span>
<a href="#l7.3805"></a><span id="l7.3805">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3806"></a><span id="l7.3806">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3807"></a><span id="l7.3807" class="difflineminus">-          for (let itemBox of this.mItemBoxes) {</span>
<a href="#l7.3808"></a><span id="l7.3808" class="difflineminus">-              if (aItem &amp;&amp; (itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3809"></a><span id="l7.3809" class="difflineminus">-                  itemBox.selected = true;</span>
<a href="#l7.3810"></a><span id="l7.3810" class="difflineminus">-              }</span>
<a href="#l7.3811"></a><span id="l7.3811" class="difflineminus">-          }</span>
<a href="#l7.3812"></a><span id="l7.3812" class="difflineplus">+            for (let itemBox of this.mItemBoxes) {</span>
<a href="#l7.3813"></a><span id="l7.3813" class="difflineplus">+                if (aItem &amp;&amp; (itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3814"></a><span id="l7.3814" class="difflineplus">+                    itemBox.selected = true;</span>
<a href="#l7.3815"></a><span id="l7.3815" class="difflineplus">+                }</span>
<a href="#l7.3816"></a><span id="l7.3816" class="difflineplus">+            }</span>
<a href="#l7.3817"></a><span id="l7.3817">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3818"></a><span id="l7.3818">       &lt;/method&gt;</span>
<a href="#l7.3819"></a><span id="l7.3819">       &lt;method name=&quot;unselectOccurrence&quot;&gt;</span>
<a href="#l7.3820"></a><span id="l7.3820">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.3821"></a><span id="l7.3821">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3822"></a><span id="l7.3822" class="difflineminus">-          for (let itemBox of this.mItemBoxes) {</span>
<a href="#l7.3823"></a><span id="l7.3823" class="difflineminus">-              if (aItem &amp;&amp; (itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3824"></a><span id="l7.3824" class="difflineminus">-                  itemBox.selected = false;</span>
<a href="#l7.3825"></a><span id="l7.3825" class="difflineminus">-              }</span>
<a href="#l7.3826"></a><span id="l7.3826" class="difflineminus">-          }</span>
<a href="#l7.3827"></a><span id="l7.3827" class="difflineplus">+            for (let itemBox of this.mItemBoxes) {</span>
<a href="#l7.3828"></a><span id="l7.3828" class="difflineplus">+                if (aItem &amp;&amp; (itemBox.occurrence.hashId == aItem.hashId)) {</span>
<a href="#l7.3829"></a><span id="l7.3829" class="difflineplus">+                    itemBox.selected = false;</span>
<a href="#l7.3830"></a><span id="l7.3830" class="difflineplus">+                }</span>
<a href="#l7.3831"></a><span id="l7.3831" class="difflineplus">+            }</span>
<a href="#l7.3832"></a><span id="l7.3832">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3833"></a><span id="l7.3833">       &lt;/method&gt;</span>
<a href="#l7.3834"></a><span id="l7.3834"> </span>
<a href="#l7.3835"></a><span id="l7.3835">     &lt;/implementation&gt;</span>
<a href="#l7.3836"></a><span id="l7.3836"> </span>
<a href="#l7.3837"></a><span id="l7.3837">     &lt;handlers&gt;</span>
<a href="#l7.3838"></a><span id="l7.3838">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3839"></a><span id="l7.3839" class="difflineminus">-        this.calendarView.controller.createNewEvent(null, this.mDate, null, true);</span>
<a href="#l7.3840"></a><span id="l7.3840" class="difflineplus">+          this.calendarView.controller.createNewEvent(null, this.mDate, null, true);</span>
<a href="#l7.3841"></a><span id="l7.3841">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3842"></a><span id="l7.3842">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3843"></a><span id="l7.3843" class="difflineminus">-        this.calendarView.selectedDay = this.mDate;</span>
<a href="#l7.3844"></a><span id="l7.3844" class="difflineplus">+          this.calendarView.selectedDay = this.mDate;</span>
<a href="#l7.3845"></a><span id="l7.3845">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3846"></a><span id="l7.3846">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3847"></a><span id="l7.3847" class="difflineminus">-        if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l7.3848"></a><span id="l7.3848" class="difflineminus">-            this.calendarView.setSelectedItems(0, []);</span>
<a href="#l7.3849"></a><span id="l7.3849" class="difflineminus">-        }</span>
<a href="#l7.3850"></a><span id="l7.3850" class="difflineplus">+          if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l7.3851"></a><span id="l7.3851" class="difflineplus">+              this.calendarView.setSelectedItems(0, []);</span>
<a href="#l7.3852"></a><span id="l7.3852" class="difflineplus">+          }</span>
<a href="#l7.3853"></a><span id="l7.3853">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3854"></a><span id="l7.3854">       &lt;handler event=&quot;click&quot; button=&quot;2&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3855"></a><span id="l7.3855" class="difflineminus">-        let newStart = this.calendarView.selectedDay.clone();</span>
<a href="#l7.3856"></a><span id="l7.3856" class="difflineminus">-        newStart.isDate = true;</span>
<a href="#l7.3857"></a><span id="l7.3857" class="difflineminus">-        this.calendarView.selectedDateTime = newStart;</span>
<a href="#l7.3858"></a><span id="l7.3858" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l7.3859"></a><span id="l7.3859" class="difflineplus">+          let newStart = this.calendarView.selectedDay.clone();</span>
<a href="#l7.3860"></a><span id="l7.3860" class="difflineplus">+          newStart.isDate = true;</span>
<a href="#l7.3861"></a><span id="l7.3861" class="difflineplus">+          this.calendarView.selectedDateTime = newStart;</span>
<a href="#l7.3862"></a><span id="l7.3862" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l7.3863"></a><span id="l7.3863">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3864"></a><span id="l7.3864">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.3865"></a><span id="l7.3865" class="difflineminus">-        if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3866"></a><span id="l7.3866" class="difflineminus">-            // In vertical view (normal), don't let the parent multiday view</span>
<a href="#l7.3867"></a><span id="l7.3867" class="difflineminus">-            // handle the scrolling in its bubbling phase. The default action</span>
<a href="#l7.3868"></a><span id="l7.3868" class="difflineminus">-            // will make the box scroll here.</span>
<a href="#l7.3869"></a><span id="l7.3869" class="difflineminus">-</span>
<a href="#l7.3870"></a><span id="l7.3870" class="difflineminus">-            // TODO We could scroll by the height of exactly one event box, but</span>
<a href="#l7.3871"></a><span id="l7.3871" class="difflineminus">-            // since a normal box's boxObject doesn't implement nsIScrollBoxObject,</span>
<a href="#l7.3872"></a><span id="l7.3872" class="difflineminus">-            // there is no way to scroll by pixels. Using a xul:scrollbox has</span>
<a href="#l7.3873"></a><span id="l7.3873" class="difflineminus">-            // problems since the equalsize attribute isn't inherited by the</span>
<a href="#l7.3874"></a><span id="l7.3874" class="difflineminus">-            // inner box, and even if that is worked around, something makes the</span>
<a href="#l7.3875"></a><span id="l7.3875" class="difflineminus">-            // rotated view look bad in that case.</span>
<a href="#l7.3876"></a><span id="l7.3876" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l7.3877"></a><span id="l7.3877" class="difflineminus">-        }</span>
<a href="#l7.3878"></a><span id="l7.3878" class="difflineplus">+          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3879"></a><span id="l7.3879" class="difflineplus">+              // In vertical view (normal), don't let the parent multiday view</span>
<a href="#l7.3880"></a><span id="l7.3880" class="difflineplus">+              // handle the scrolling in its bubbling phase. The default action</span>
<a href="#l7.3881"></a><span id="l7.3881" class="difflineplus">+              // will make the box scroll here.</span>
<a href="#l7.3882"></a><span id="l7.3882" class="difflineplus">+</span>
<a href="#l7.3883"></a><span id="l7.3883" class="difflineplus">+              // TODO We could scroll by the height of exactly one event box, but</span>
<a href="#l7.3884"></a><span id="l7.3884" class="difflineplus">+              // since a normal box's boxObject doesn't implement nsIScrollBoxObject,</span>
<a href="#l7.3885"></a><span id="l7.3885" class="difflineplus">+              // there is no way to scroll by pixels. Using a xul:scrollbox has</span>
<a href="#l7.3886"></a><span id="l7.3886" class="difflineplus">+              // problems since the equalsize attribute isn't inherited by the</span>
<a href="#l7.3887"></a><span id="l7.3887" class="difflineplus">+              // inner box, and even if that is worked around, something makes the</span>
<a href="#l7.3888"></a><span id="l7.3888" class="difflineplus">+              // rotated view look bad in that case.</span>
<a href="#l7.3889"></a><span id="l7.3889" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l7.3890"></a><span id="l7.3890" class="difflineplus">+          }</span>
<a href="#l7.3891"></a><span id="l7.3891">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.3892"></a><span id="l7.3892">     &lt;/handlers&gt;</span>
<a href="#l7.3893"></a><span id="l7.3893">   &lt;/binding&gt;</span>
<a href="#l7.3894"></a><span id="l7.3894"> </span>
<a href="#l7.3895"></a><span id="l7.3895">   &lt;!--</span>
<a href="#l7.3896"></a><span id="l7.3896">      -  An individual event box, to be inserted into a column.</span>
<a href="#l7.3897"></a><span id="l7.3897">     --&gt;</span>
<a href="#l7.3898"></a><span id="l7.3898">   &lt;binding id=&quot;calendar-event-box&quot; extends=&quot;chrome://calendar/content/calendar-view-core.xml#calendar-editable-item&quot;&gt;</span>
<a href="#l7.3899"></a><span id="l7.3899" class="difflineat">@@ -2300,200 +2300,200 @@</span>
<a href="#l7.3900"></a><span id="l7.3900">             &lt;/xul:stack&gt;</span>
<a href="#l7.3901"></a><span id="l7.3901">           &lt;/xul:box&gt;</span>
<a href="#l7.3902"></a><span id="l7.3902">         &lt;/xul:box&gt;</span>
<a href="#l7.3903"></a><span id="l7.3903">       &lt;/xul:box&gt;</span>
<a href="#l7.3904"></a><span id="l7.3904">     &lt;/content&gt;</span>
<a href="#l7.3905"></a><span id="l7.3905"> </span>
<a href="#l7.3906"></a><span id="l7.3906">     &lt;implementation&gt;</span>
<a href="#l7.3907"></a><span id="l7.3907">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.3908"></a><span id="l7.3908" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3909"></a><span id="l7.3909" class="difflineminus">-</span>
<a href="#l7.3910"></a><span id="l7.3910" class="difflineminus">-        this.orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.3911"></a><span id="l7.3911" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.3912"></a><span id="l7.3912" class="difflineplus">+</span>
<a href="#l7.3913"></a><span id="l7.3913" class="difflineplus">+          this.orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l7.3914"></a><span id="l7.3914">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.3915"></a><span id="l7.3915"> </span>
<a href="#l7.3916"></a><span id="l7.3916">       &lt;!-- fields --&gt;</span>
<a href="#l7.3917"></a><span id="l7.3917">       &lt;field name=&quot;mParentColumn&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.3918"></a><span id="l7.3918"> </span>
<a href="#l7.3919"></a><span id="l7.3919">       &lt;!-- methods/properties --&gt;</span>
<a href="#l7.3920"></a><span id="l7.3920">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l7.3921"></a><span id="l7.3921">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l7.3922"></a><span id="l7.3922">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l7.3923"></a><span id="l7.3923">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3924"></a><span id="l7.3924" class="difflineminus">-          let needsrelayout = false;</span>
<a href="#l7.3925"></a><span id="l7.3925" class="difflineminus">-          if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.3926"></a><span id="l7.3926" class="difflineminus">-              if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.3927"></a><span id="l7.3927" class="difflineminus">-                  needsrelayout = true;</span>
<a href="#l7.3928"></a><span id="l7.3928" class="difflineminus">-              }</span>
<a href="#l7.3929"></a><span id="l7.3929" class="difflineminus">-          }</span>
<a href="#l7.3930"></a><span id="l7.3930" class="difflineminus">-</span>
<a href="#l7.3931"></a><span id="l7.3931" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.3932"></a><span id="l7.3932" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.3933"></a><span id="l7.3933" class="difflineminus">-</span>
<a href="#l7.3934"></a><span id="l7.3934" class="difflineminus">-          if (needsrelayout) {</span>
<a href="#l7.3935"></a><span id="l7.3935" class="difflineminus">-              let eventbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l7.3936"></a><span id="l7.3936" class="difflineminus">-              eventbox.setAttribute(&quot;orient&quot;, val);</span>
<a href="#l7.3937"></a><span id="l7.3937" class="difflineminus">-              let gb1 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;);</span>
<a href="#l7.3938"></a><span id="l7.3938" class="difflineminus">-              gb1.parentorient = val;</span>
<a href="#l7.3939"></a><span id="l7.3939" class="difflineminus">-              let gb2 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar2&quot;);</span>
<a href="#l7.3940"></a><span id="l7.3940" class="difflineminus">-              gb2.parentorient = val;</span>
<a href="#l7.3941"></a><span id="l7.3941" class="difflineminus">-          }</span>
<a href="#l7.3942"></a><span id="l7.3942" class="difflineminus">-</span>
<a href="#l7.3943"></a><span id="l7.3943" class="difflineminus">-          return ret;</span>
<a href="#l7.3944"></a><span id="l7.3944" class="difflineplus">+            let needsrelayout = false;</span>
<a href="#l7.3945"></a><span id="l7.3945" class="difflineplus">+            if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.3946"></a><span id="l7.3946" class="difflineplus">+                if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.3947"></a><span id="l7.3947" class="difflineplus">+                    needsrelayout = true;</span>
<a href="#l7.3948"></a><span id="l7.3948" class="difflineplus">+                }</span>
<a href="#l7.3949"></a><span id="l7.3949" class="difflineplus">+            }</span>
<a href="#l7.3950"></a><span id="l7.3950" class="difflineplus">+</span>
<a href="#l7.3951"></a><span id="l7.3951" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.3952"></a><span id="l7.3952" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.3953"></a><span id="l7.3953" class="difflineplus">+</span>
<a href="#l7.3954"></a><span id="l7.3954" class="difflineplus">+            if (needsrelayout) {</span>
<a href="#l7.3955"></a><span id="l7.3955" class="difflineplus">+                let eventbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;);</span>
<a href="#l7.3956"></a><span id="l7.3956" class="difflineplus">+                eventbox.setAttribute(&quot;orient&quot;, val);</span>
<a href="#l7.3957"></a><span id="l7.3957" class="difflineplus">+                let gb1 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;);</span>
<a href="#l7.3958"></a><span id="l7.3958" class="difflineplus">+                gb1.parentorient = val;</span>
<a href="#l7.3959"></a><span id="l7.3959" class="difflineplus">+                let gb2 = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar2&quot;);</span>
<a href="#l7.3960"></a><span id="l7.3960" class="difflineplus">+                gb2.parentorient = val;</span>
<a href="#l7.3961"></a><span id="l7.3961" class="difflineplus">+            }</span>
<a href="#l7.3962"></a><span id="l7.3962" class="difflineplus">+</span>
<a href="#l7.3963"></a><span id="l7.3963" class="difflineplus">+            return ret;</span>
<a href="#l7.3964"></a><span id="l7.3964">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3965"></a><span id="l7.3965">       &lt;/method&gt;</span>
<a href="#l7.3966"></a><span id="l7.3966"> </span>
<a href="#l7.3967"></a><span id="l7.3967">       &lt;method name=&quot;getOptimalMinSize&quot;&gt;</span>
<a href="#l7.3968"></a><span id="l7.3968">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.3969"></a><span id="l7.3969" class="difflineminus">-          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3970"></a><span id="l7.3970" class="difflineminus">-              let minHeight = getOptimalMinimumHeight(this.eventNameLabel) +</span>
<a href="#l7.3971"></a><span id="l7.3971" class="difflineminus">-                              getSummarizedStyleValues(document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;), [&quot;margin-bottom&quot;, &quot;margin-top&quot;]) +</span>
<a href="#l7.3972"></a><span id="l7.3972" class="difflineminus">-                              getSummarizedStyleValues(this, [&quot;border-bottom-width&quot;, &quot;border-top-width&quot;]);</span>
<a href="#l7.3973"></a><span id="l7.3973" class="difflineminus">-              this.setAttribute(&quot;minheight&quot;, minHeight);</span>
<a href="#l7.3974"></a><span id="l7.3974" class="difflineminus">-              this.setAttribute(&quot;minwidth&quot;, &quot;1&quot;);</span>
<a href="#l7.3975"></a><span id="l7.3975" class="difflineminus">-              return minHeight;</span>
<a href="#l7.3976"></a><span id="l7.3976" class="difflineminus">-          } else {</span>
<a href="#l7.3977"></a><span id="l7.3977" class="difflineminus">-              this.eventNameLabel.setAttribute(&quot;style&quot;, &quot;min-width: 2em&quot;);</span>
<a href="#l7.3978"></a><span id="l7.3978" class="difflineminus">-              let minWidth = getOptimalMinimumWidth(this.eventNameLabel);</span>
<a href="#l7.3979"></a><span id="l7.3979" class="difflineminus">-              this.setAttribute(&quot;minwidth&quot;, minWidth);</span>
<a href="#l7.3980"></a><span id="l7.3980" class="difflineminus">-              this.setAttribute(&quot;minheight&quot;, &quot;1&quot;);</span>
<a href="#l7.3981"></a><span id="l7.3981" class="difflineminus">-              return minWidth;</span>
<a href="#l7.3982"></a><span id="l7.3982" class="difflineminus">-          }</span>
<a href="#l7.3983"></a><span id="l7.3983" class="difflineplus">+            if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.3984"></a><span id="l7.3984" class="difflineplus">+                let minHeight = getOptimalMinimumHeight(this.eventNameLabel) +</span>
<a href="#l7.3985"></a><span id="l7.3985" class="difflineplus">+                                getSummarizedStyleValues(document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;), [&quot;margin-bottom&quot;, &quot;margin-top&quot;]) +</span>
<a href="#l7.3986"></a><span id="l7.3986" class="difflineplus">+                                getSummarizedStyleValues(this, [&quot;border-bottom-width&quot;, &quot;border-top-width&quot;]);</span>
<a href="#l7.3987"></a><span id="l7.3987" class="difflineplus">+                this.setAttribute(&quot;minheight&quot;, minHeight);</span>
<a href="#l7.3988"></a><span id="l7.3988" class="difflineplus">+                this.setAttribute(&quot;minwidth&quot;, &quot;1&quot;);</span>
<a href="#l7.3989"></a><span id="l7.3989" class="difflineplus">+                return minHeight;</span>
<a href="#l7.3990"></a><span id="l7.3990" class="difflineplus">+            } else {</span>
<a href="#l7.3991"></a><span id="l7.3991" class="difflineplus">+                this.eventNameLabel.setAttribute(&quot;style&quot;, &quot;min-width: 2em&quot;);</span>
<a href="#l7.3992"></a><span id="l7.3992" class="difflineplus">+                let minWidth = getOptimalMinimumWidth(this.eventNameLabel);</span>
<a href="#l7.3993"></a><span id="l7.3993" class="difflineplus">+                this.setAttribute(&quot;minwidth&quot;, minWidth);</span>
<a href="#l7.3994"></a><span id="l7.3994" class="difflineplus">+                this.setAttribute(&quot;minheight&quot;, &quot;1&quot;);</span>
<a href="#l7.3995"></a><span id="l7.3995" class="difflineplus">+                return minWidth;</span>
<a href="#l7.3996"></a><span id="l7.3996" class="difflineplus">+            }</span>
<a href="#l7.3997"></a><span id="l7.3997">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.3998"></a><span id="l7.3998">       &lt;/method&gt;</span>
<a href="#l7.3999"></a><span id="l7.3999"> </span>
<a href="#l7.4000"></a><span id="l7.4000">       &lt;property name=&quot;parentColumn&quot;</span>
<a href="#l7.4001"></a><span id="l7.4001">         onget=&quot;return this.mParentColumn;&quot;</span>
<a href="#l7.4002"></a><span id="l7.4002">         onset=&quot;return (this.mParentColumn = val);&quot;/&gt;</span>
<a href="#l7.4003"></a><span id="l7.4003"> </span>
<a href="#l7.4004"></a><span id="l7.4004">       &lt;property name=&quot;startMinute&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.4005"></a><span id="l7.4005">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4006"></a><span id="l7.4006" class="difflineminus">-          if (!this.mOccurrence) {</span>
<a href="#l7.4007"></a><span id="l7.4007" class="difflineminus">-              return 0;</span>
<a href="#l7.4008"></a><span id="l7.4008" class="difflineminus">-          }</span>
<a href="#l7.4009"></a><span id="l7.4009" class="difflineminus">-          let startDate = this.mOccurrence.startDate || this.mOccurrence.entryDate;</span>
<a href="#l7.4010"></a><span id="l7.4010" class="difflineminus">-          return startDate.hour * 60 + startDate.minute;</span>
<a href="#l7.4011"></a><span id="l7.4011" class="difflineplus">+            if (!this.mOccurrence) {</span>
<a href="#l7.4012"></a><span id="l7.4012" class="difflineplus">+                return 0;</span>
<a href="#l7.4013"></a><span id="l7.4013" class="difflineplus">+            }</span>
<a href="#l7.4014"></a><span id="l7.4014" class="difflineplus">+            let startDate = this.mOccurrence.startDate || this.mOccurrence.entryDate;</span>
<a href="#l7.4015"></a><span id="l7.4015" class="difflineplus">+            return startDate.hour * 60 + startDate.minute;</span>
<a href="#l7.4016"></a><span id="l7.4016">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4017"></a><span id="l7.4017">       &lt;/property&gt;</span>
<a href="#l7.4018"></a><span id="l7.4018"> </span>
<a href="#l7.4019"></a><span id="l7.4019">       &lt;property name=&quot;endMinute&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.4020"></a><span id="l7.4020">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4021"></a><span id="l7.4021" class="difflineminus">-          if (!this.mOccurrence) {</span>
<a href="#l7.4022"></a><span id="l7.4022" class="difflineminus">-              return 0;</span>
<a href="#l7.4023"></a><span id="l7.4023" class="difflineminus">-          }</span>
<a href="#l7.4024"></a><span id="l7.4024" class="difflineminus">-          let endDate = this.mOccurrence.endDate || this.mOccurrence.dueDate;</span>
<a href="#l7.4025"></a><span id="l7.4025" class="difflineminus">-          return endDate.hour * 60 + endDate.minute;</span>
<a href="#l7.4026"></a><span id="l7.4026" class="difflineplus">+            if (!this.mOccurrence) {</span>
<a href="#l7.4027"></a><span id="l7.4027" class="difflineplus">+                return 0;</span>
<a href="#l7.4028"></a><span id="l7.4028" class="difflineplus">+            }</span>
<a href="#l7.4029"></a><span id="l7.4029" class="difflineplus">+            let endDate = this.mOccurrence.endDate || this.mOccurrence.dueDate;</span>
<a href="#l7.4030"></a><span id="l7.4030" class="difflineplus">+            return endDate.hour * 60 + endDate.minute;</span>
<a href="#l7.4031"></a><span id="l7.4031">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4032"></a><span id="l7.4032">       &lt;/property&gt;</span>
<a href="#l7.4033"></a><span id="l7.4033"> </span>
<a href="#l7.4034"></a><span id="l7.4034">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l7.4035"></a><span id="l7.4035">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4036"></a><span id="l7.4036" class="difflineminus">-          let evl = this.eventNameLabel;</span>
<a href="#l7.4037"></a><span id="l7.4037" class="difflineminus">-          let item = this.mOccurrence;</span>
<a href="#l7.4038"></a><span id="l7.4038" class="difflineminus">-</span>
<a href="#l7.4039"></a><span id="l7.4039" class="difflineminus">-          if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l7.4040"></a><span id="l7.4040" class="difflineminus">-              // Use &lt;description&gt; textContent so it can wrap.</span>
<a href="#l7.4041"></a><span id="l7.4041" class="difflineminus">-              evl.textContent = item.title;</span>
<a href="#l7.4042"></a><span id="l7.4042" class="difflineminus">-          } else {</span>
<a href="#l7.4043"></a><span id="l7.4043" class="difflineminus">-              evl.textContent = cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l7.4044"></a><span id="l7.4044" class="difflineminus">-          }</span>
<a href="#l7.4045"></a><span id="l7.4045" class="difflineminus">-</span>
<a href="#l7.4046"></a><span id="l7.4046" class="difflineminus">-          let gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l7.4047"></a><span id="l7.4047" class="difflineminus">-          let height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l7.4048"></a><span id="l7.4048" class="difflineminus">-          evl.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar * 2) + &quot;px&quot;);</span>
<a href="#l7.4049"></a><span id="l7.4049" class="difflineplus">+            let evl = this.eventNameLabel;</span>
<a href="#l7.4050"></a><span id="l7.4050" class="difflineplus">+            let item = this.mOccurrence;</span>
<a href="#l7.4051"></a><span id="l7.4051" class="difflineplus">+</span>
<a href="#l7.4052"></a><span id="l7.4052" class="difflineplus">+            if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l7.4053"></a><span id="l7.4053" class="difflineplus">+                // Use &lt;description&gt; textContent so it can wrap.</span>
<a href="#l7.4054"></a><span id="l7.4054" class="difflineplus">+                evl.textContent = item.title;</span>
<a href="#l7.4055"></a><span id="l7.4055" class="difflineplus">+            } else {</span>
<a href="#l7.4056"></a><span id="l7.4056" class="difflineplus">+                evl.textContent = cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l7.4057"></a><span id="l7.4057" class="difflineplus">+            }</span>
<a href="#l7.4058"></a><span id="l7.4058" class="difflineplus">+</span>
<a href="#l7.4059"></a><span id="l7.4059" class="difflineplus">+            let gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l7.4060"></a><span id="l7.4060" class="difflineplus">+            let height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l7.4061"></a><span id="l7.4061" class="difflineplus">+            evl.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar * 2) + &quot;px&quot;);</span>
<a href="#l7.4062"></a><span id="l7.4062">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4063"></a><span id="l7.4063">       &lt;/method&gt;</span>
<a href="#l7.4064"></a><span id="l7.4064">     &lt;/implementation&gt;</span>
<a href="#l7.4065"></a><span id="l7.4065"> </span>
<a href="#l7.4066"></a><span id="l7.4066">     &lt;handlers&gt;</span>
<a href="#l7.4067"></a><span id="l7.4067">       &lt;handler event=&quot;mousedown&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.4068"></a><span id="l7.4068" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l7.4069"></a><span id="l7.4069" class="difflineminus">-</span>
<a href="#l7.4070"></a><span id="l7.4070" class="difflineminus">-        if (this.mEditing) {</span>
<a href="#l7.4071"></a><span id="l7.4071" class="difflineminus">-            return;</span>
<a href="#l7.4072"></a><span id="l7.4072" class="difflineminus">-        }</span>
<a href="#l7.4073"></a><span id="l7.4073" class="difflineminus">-</span>
<a href="#l7.4074"></a><span id="l7.4074" class="difflineminus">-        this.parentColumn.calendarView.selectedDay = this.parentColumn.mDate;</span>
<a href="#l7.4075"></a><span id="l7.4075" class="difflineminus">-        this.mMouseX = event.screenX;</span>
<a href="#l7.4076"></a><span id="l7.4076" class="difflineminus">-        this.mMouseY = event.screenY;</span>
<a href="#l7.4077"></a><span id="l7.4077" class="difflineminus">-</span>
<a href="#l7.4078"></a><span id="l7.4078" class="difflineminus">-        let whichside = event.whichside;</span>
<a href="#l7.4079"></a><span id="l7.4079" class="difflineminus">-        if (whichside) {</span>
<a href="#l7.4080"></a><span id="l7.4080" class="difflineminus">-            this.calendarView.setSelectedItems(1,</span>
<a href="#l7.4081"></a><span id="l7.4081" class="difflineminus">-                [event.ctrlKey ? this.mOccurrence.parentItem : this.mOccurrence]);</span>
<a href="#l7.4082"></a><span id="l7.4082" class="difflineminus">-</span>
<a href="#l7.4083"></a><span id="l7.4083" class="difflineminus">-            let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.4084"></a><span id="l7.4084" class="difflineminus">-                              !event.ctrlKey &amp;&amp;</span>
<a href="#l7.4085"></a><span id="l7.4085" class="difflineminus">-                              !event.altKey &amp;&amp;</span>
<a href="#l7.4086"></a><span id="l7.4086" class="difflineminus">-                              !event.metaKey) ? 1 : 15;</span>
<a href="#l7.4087"></a><span id="l7.4087" class="difflineminus">-            // start edge resize drag</span>
<a href="#l7.4088"></a><span id="l7.4088" class="difflineminus">-            this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, whichside,</span>
<a href="#l7.4089"></a><span id="l7.4089" class="difflineminus">-                                                         event.screenX, event.screenY,</span>
<a href="#l7.4090"></a><span id="l7.4090" class="difflineminus">-                                                         snapIntMin);</span>
<a href="#l7.4091"></a><span id="l7.4091" class="difflineminus">-        } else {</span>
<a href="#l7.4092"></a><span id="l7.4092" class="difflineminus">-            // may be click or drag,</span>
<a href="#l7.4093"></a><span id="l7.4093" class="difflineminus">-            // so wait for mousemove (or mouseout if fast) to start item move drag</span>
<a href="#l7.4094"></a><span id="l7.4094" class="difflineminus">-            this.mInMouseDown = true;</span>
<a href="#l7.4095"></a><span id="l7.4095" class="difflineminus">-        }</span>
<a href="#l7.4096"></a><span id="l7.4096" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l7.4097"></a><span id="l7.4097" class="difflineplus">+</span>
<a href="#l7.4098"></a><span id="l7.4098" class="difflineplus">+          if (this.mEditing) {</span>
<a href="#l7.4099"></a><span id="l7.4099" class="difflineplus">+              return;</span>
<a href="#l7.4100"></a><span id="l7.4100" class="difflineplus">+          }</span>
<a href="#l7.4101"></a><span id="l7.4101" class="difflineplus">+</span>
<a href="#l7.4102"></a><span id="l7.4102" class="difflineplus">+          this.parentColumn.calendarView.selectedDay = this.parentColumn.mDate;</span>
<a href="#l7.4103"></a><span id="l7.4103" class="difflineplus">+          this.mMouseX = event.screenX;</span>
<a href="#l7.4104"></a><span id="l7.4104" class="difflineplus">+          this.mMouseY = event.screenY;</span>
<a href="#l7.4105"></a><span id="l7.4105" class="difflineplus">+</span>
<a href="#l7.4106"></a><span id="l7.4106" class="difflineplus">+          let whichside = event.whichside;</span>
<a href="#l7.4107"></a><span id="l7.4107" class="difflineplus">+          if (whichside) {</span>
<a href="#l7.4108"></a><span id="l7.4108" class="difflineplus">+              this.calendarView.setSelectedItems(1,</span>
<a href="#l7.4109"></a><span id="l7.4109" class="difflineplus">+                  [event.ctrlKey ? this.mOccurrence.parentItem : this.mOccurrence]);</span>
<a href="#l7.4110"></a><span id="l7.4110" class="difflineplus">+</span>
<a href="#l7.4111"></a><span id="l7.4111" class="difflineplus">+              let snapIntMin = (event.shiftKey &amp;&amp;</span>
<a href="#l7.4112"></a><span id="l7.4112" class="difflineplus">+                                !event.ctrlKey &amp;&amp;</span>
<a href="#l7.4113"></a><span id="l7.4113" class="difflineplus">+                                !event.altKey &amp;&amp;</span>
<a href="#l7.4114"></a><span id="l7.4114" class="difflineplus">+                                !event.metaKey) ? 1 : 15;</span>
<a href="#l7.4115"></a><span id="l7.4115" class="difflineplus">+              // start edge resize drag</span>
<a href="#l7.4116"></a><span id="l7.4116" class="difflineplus">+              this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, whichside,</span>
<a href="#l7.4117"></a><span id="l7.4117" class="difflineplus">+                                                           event.screenX, event.screenY,</span>
<a href="#l7.4118"></a><span id="l7.4118" class="difflineplus">+                                                           snapIntMin);</span>
<a href="#l7.4119"></a><span id="l7.4119" class="difflineplus">+          } else {</span>
<a href="#l7.4120"></a><span id="l7.4120" class="difflineplus">+              // may be click or drag,</span>
<a href="#l7.4121"></a><span id="l7.4121" class="difflineplus">+              // so wait for mousemove (or mouseout if fast) to start item move drag</span>
<a href="#l7.4122"></a><span id="l7.4122" class="difflineplus">+              this.mInMouseDown = true;</span>
<a href="#l7.4123"></a><span id="l7.4123" class="difflineplus">+          }</span>
<a href="#l7.4124"></a><span id="l7.4124">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.4125"></a><span id="l7.4125"> </span>
<a href="#l7.4126"></a><span id="l7.4126">       &lt;handler event=&quot;mousemove&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.4127"></a><span id="l7.4127" class="difflineminus">-        if (!this.mInMouseDown) {</span>
<a href="#l7.4128"></a><span id="l7.4128" class="difflineminus">-            return;</span>
<a href="#l7.4129"></a><span id="l7.4129" class="difflineminus">-        }</span>
<a href="#l7.4130"></a><span id="l7.4130" class="difflineminus">-</span>
<a href="#l7.4131"></a><span id="l7.4131" class="difflineminus">-        let deltaX = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l7.4132"></a><span id="l7.4132" class="difflineminus">-        let deltaY = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l7.4133"></a><span id="l7.4133" class="difflineminus">-        // more than a 3 pixel move?</span>
<a href="#l7.4134"></a><span id="l7.4134" class="difflineminus">-        if ((deltaX * deltaX + deltaY * deltaY) &gt; 9) {</span>
<a href="#l7.4135"></a><span id="l7.4135" class="difflineminus">-            if (this.parentColumn) {</span>
<a href="#l7.4136"></a><span id="l7.4136" class="difflineminus">-                if (this.editingTimer) {</span>
<a href="#l7.4137"></a><span id="l7.4137" class="difflineminus">-                    clearTimeout(this.editingTimer);</span>
<a href="#l7.4138"></a><span id="l7.4138" class="difflineminus">-                    this.editingTimer = null;</span>
<a href="#l7.4139"></a><span id="l7.4139" class="difflineminus">-                }</span>
<a href="#l7.4140"></a><span id="l7.4140" class="difflineminus">-</span>
<a href="#l7.4141"></a><span id="l7.4141" class="difflineminus">-                this.calendarView.setSelectedItems(1, [this.mOccurrence]);</span>
<a href="#l7.4142"></a><span id="l7.4142" class="difflineminus">-</span>
<a href="#l7.4143"></a><span id="l7.4143" class="difflineminus">-                this.mEditing = false;</span>
<a href="#l7.4144"></a><span id="l7.4144" class="difflineminus">-</span>
<a href="#l7.4145"></a><span id="l7.4145" class="difflineminus">-                this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, &quot;middle&quot;, this.mMouseX, this.mMouseY);</span>
<a href="#l7.4146"></a><span id="l7.4146" class="difflineminus">-                this.mInMouseDown = false;</span>
<a href="#l7.4147"></a><span id="l7.4147" class="difflineminus">-            }</span>
<a href="#l7.4148"></a><span id="l7.4148" class="difflineminus">-        }</span>
<a href="#l7.4149"></a><span id="l7.4149" class="difflineplus">+          if (!this.mInMouseDown) {</span>
<a href="#l7.4150"></a><span id="l7.4150" class="difflineplus">+              return;</span>
<a href="#l7.4151"></a><span id="l7.4151" class="difflineplus">+          }</span>
<a href="#l7.4152"></a><span id="l7.4152" class="difflineplus">+</span>
<a href="#l7.4153"></a><span id="l7.4153" class="difflineplus">+          let deltaX = Math.abs(event.screenX - this.mMouseX);</span>
<a href="#l7.4154"></a><span id="l7.4154" class="difflineplus">+          let deltaY = Math.abs(event.screenY - this.mMouseY);</span>
<a href="#l7.4155"></a><span id="l7.4155" class="difflineplus">+          // more than a 3 pixel move?</span>
<a href="#l7.4156"></a><span id="l7.4156" class="difflineplus">+          if ((deltaX * deltaX + deltaY * deltaY) &gt; 9) {</span>
<a href="#l7.4157"></a><span id="l7.4157" class="difflineplus">+              if (this.parentColumn) {</span>
<a href="#l7.4158"></a><span id="l7.4158" class="difflineplus">+                  if (this.editingTimer) {</span>
<a href="#l7.4159"></a><span id="l7.4159" class="difflineplus">+                      clearTimeout(this.editingTimer);</span>
<a href="#l7.4160"></a><span id="l7.4160" class="difflineplus">+                      this.editingTimer = null;</span>
<a href="#l7.4161"></a><span id="l7.4161" class="difflineplus">+                  }</span>
<a href="#l7.4162"></a><span id="l7.4162" class="difflineplus">+</span>
<a href="#l7.4163"></a><span id="l7.4163" class="difflineplus">+                  this.calendarView.setSelectedItems(1, [this.mOccurrence]);</span>
<a href="#l7.4164"></a><span id="l7.4164" class="difflineplus">+</span>
<a href="#l7.4165"></a><span id="l7.4165" class="difflineplus">+                  this.mEditing = false;</span>
<a href="#l7.4166"></a><span id="l7.4166" class="difflineplus">+</span>
<a href="#l7.4167"></a><span id="l7.4167" class="difflineplus">+                  this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, &quot;middle&quot;, this.mMouseX, this.mMouseY);</span>
<a href="#l7.4168"></a><span id="l7.4168" class="difflineplus">+                  this.mInMouseDown = false;</span>
<a href="#l7.4169"></a><span id="l7.4169" class="difflineplus">+              }</span>
<a href="#l7.4170"></a><span id="l7.4170" class="difflineplus">+          }</span>
<a href="#l7.4171"></a><span id="l7.4171">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.4172"></a><span id="l7.4172"> </span>
<a href="#l7.4173"></a><span id="l7.4173">       &lt;handler event=&quot;mouseout&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.4174"></a><span id="l7.4174" class="difflineminus">-        if (!this.mEditing &amp;&amp; this.mInMouseDown &amp;&amp; this.parentColumn) {</span>
<a href="#l7.4175"></a><span id="l7.4175" class="difflineminus">-            if (this.editingTimer) {</span>
<a href="#l7.4176"></a><span id="l7.4176" class="difflineminus">-                clearTimeout(this.editingTimer);</span>
<a href="#l7.4177"></a><span id="l7.4177" class="difflineminus">-                this.editingTimer = null;</span>
<a href="#l7.4178"></a><span id="l7.4178" class="difflineminus">-            }</span>
<a href="#l7.4179"></a><span id="l7.4179" class="difflineminus">-</span>
<a href="#l7.4180"></a><span id="l7.4180" class="difflineminus">-            this.calendarView.setSelectedItems(1, [this.mOccurrence]);</span>
<a href="#l7.4181"></a><span id="l7.4181" class="difflineminus">-</span>
<a href="#l7.4182"></a><span id="l7.4182" class="difflineminus">-            this.mEditing = false;</span>
<a href="#l7.4183"></a><span id="l7.4183" class="difflineminus">-</span>
<a href="#l7.4184"></a><span id="l7.4184" class="difflineminus">-            this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, &quot;middle&quot;, this.mMouseX, this.mMouseY);</span>
<a href="#l7.4185"></a><span id="l7.4185" class="difflineminus">-            this.mInMouseDown = false;</span>
<a href="#l7.4186"></a><span id="l7.4186" class="difflineminus">-        }</span>
<a href="#l7.4187"></a><span id="l7.4187" class="difflineplus">+          if (!this.mEditing &amp;&amp; this.mInMouseDown &amp;&amp; this.parentColumn) {</span>
<a href="#l7.4188"></a><span id="l7.4188" class="difflineplus">+              if (this.editingTimer) {</span>
<a href="#l7.4189"></a><span id="l7.4189" class="difflineplus">+                  clearTimeout(this.editingTimer);</span>
<a href="#l7.4190"></a><span id="l7.4190" class="difflineplus">+                  this.editingTimer = null;</span>
<a href="#l7.4191"></a><span id="l7.4191" class="difflineplus">+              }</span>
<a href="#l7.4192"></a><span id="l7.4192" class="difflineplus">+</span>
<a href="#l7.4193"></a><span id="l7.4193" class="difflineplus">+              this.calendarView.setSelectedItems(1, [this.mOccurrence]);</span>
<a href="#l7.4194"></a><span id="l7.4194" class="difflineplus">+</span>
<a href="#l7.4195"></a><span id="l7.4195" class="difflineplus">+              this.mEditing = false;</span>
<a href="#l7.4196"></a><span id="l7.4196" class="difflineplus">+</span>
<a href="#l7.4197"></a><span id="l7.4197" class="difflineplus">+              this.parentColumn.startSweepingToModifyEvent(this, this.mOccurrence, &quot;middle&quot;, this.mMouseX, this.mMouseY);</span>
<a href="#l7.4198"></a><span id="l7.4198" class="difflineplus">+              this.mInMouseDown = false;</span>
<a href="#l7.4199"></a><span id="l7.4199" class="difflineplus">+          }</span>
<a href="#l7.4200"></a><span id="l7.4200">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.4201"></a><span id="l7.4201"> </span>
<a href="#l7.4202"></a><span id="l7.4202">       &lt;handler event=&quot;mouseup&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.4203"></a><span id="l7.4203" class="difflineminus">-        if (this.mEditing) {</span>
<a href="#l7.4204"></a><span id="l7.4204" class="difflineminus">-            return;</span>
<a href="#l7.4205"></a><span id="l7.4205" class="difflineminus">-        }</span>
<a href="#l7.4206"></a><span id="l7.4206" class="difflineminus">-</span>
<a href="#l7.4207"></a><span id="l7.4207" class="difflineminus">-        this.mInMouseDown = false;</span>
<a href="#l7.4208"></a><span id="l7.4208" class="difflineplus">+          if (this.mEditing) {</span>
<a href="#l7.4209"></a><span id="l7.4209" class="difflineplus">+              return;</span>
<a href="#l7.4210"></a><span id="l7.4210" class="difflineplus">+          }</span>
<a href="#l7.4211"></a><span id="l7.4211" class="difflineplus">+</span>
<a href="#l7.4212"></a><span id="l7.4212" class="difflineplus">+          this.mInMouseDown = false;</span>
<a href="#l7.4213"></a><span id="l7.4213">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.4214"></a><span id="l7.4214"> </span>
<a href="#l7.4215"></a><span id="l7.4215">       &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.4216"></a><span id="l7.4216" class="difflineminus">-        if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l7.4217"></a><span id="l7.4217" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l7.4218"></a><span id="l7.4218" class="difflineminus">-            onMouseOverItem(event);</span>
<a href="#l7.4219"></a><span id="l7.4219" class="difflineminus">-        }</span>
<a href="#l7.4220"></a><span id="l7.4220" class="difflineplus">+          if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l7.4221"></a><span id="l7.4221" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l7.4222"></a><span id="l7.4222" class="difflineplus">+              onMouseOverItem(event);</span>
<a href="#l7.4223"></a><span id="l7.4223" class="difflineplus">+          }</span>
<a href="#l7.4224"></a><span id="l7.4224">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.4225"></a><span id="l7.4225">     &lt;/handlers&gt;</span>
<a href="#l7.4226"></a><span id="l7.4226">   &lt;/binding&gt;</span>
<a href="#l7.4227"></a><span id="l7.4227"> </span>
<a href="#l7.4228"></a><span id="l7.4228">   &lt;binding id=&quot;calendar-multiday-view&quot; extends=&quot;chrome://calendar/content/calendar-base-view.xml#calendar-base-view&quot;&gt;</span>
<a href="#l7.4229"></a><span id="l7.4229">     &lt;content flex=&quot;1&quot; orient=&quot;vertical&quot; xbl:inherits=&quot;context,item-context&quot;&gt;</span>
<a href="#l7.4230"></a><span id="l7.4230">       &lt;xul:box anonid=&quot;mainbox&quot; class=&quot;multiday-view-main-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l7.4231"></a><span id="l7.4231">         &lt;!-- these boxes are tricky: width or height in CSS depend on orient --&gt;</span>
<a href="#l7.4232"></a><span id="l7.4232" class="difflineat">@@ -2517,143 +2517,143 @@</span>
<a href="#l7.4233"></a><span id="l7.4233">           &lt;xul:box anonid=&quot;daybox&quot; class=&quot;multiday-view-day-box&quot; flex=&quot;1&quot;</span>
<a href="#l7.4234"></a><span id="l7.4234">                    equalsize=&quot;always&quot;/&gt;</span>
<a href="#l7.4235"></a><span id="l7.4235">         &lt;/xul:scrollbox&gt;</span>
<a href="#l7.4236"></a><span id="l7.4236">       &lt;/xul:box&gt;</span>
<a href="#l7.4237"></a><span id="l7.4237">     &lt;/content&gt;</span>
<a href="#l7.4238"></a><span id="l7.4238"> </span>
<a href="#l7.4239"></a><span id="l7.4239">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l7.4240"></a><span id="l7.4240">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l7.4241"></a><span id="l7.4241" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l7.4242"></a><span id="l7.4242" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.4243"></a><span id="l7.4243" class="difflineminus">-</span>
<a href="#l7.4244"></a><span id="l7.4244" class="difflineminus">-        // get day start/end hour from prefs and set on the view</span>
<a href="#l7.4245"></a><span id="l7.4245" class="difflineminus">-        this.setDayStartEndMinutes(Preferences.get(&quot;calendar.view.daystarthour&quot;, 8) * 60,</span>
<a href="#l7.4246"></a><span id="l7.4246" class="difflineminus">-                                   Preferences.get(&quot;calendar.view.dayendhour&quot;, 17) * 60);</span>
<a href="#l7.4247"></a><span id="l7.4247" class="difflineminus">-</span>
<a href="#l7.4248"></a><span id="l7.4248" class="difflineminus">-        // initially scroll to the day start hour in the view</span>
<a href="#l7.4249"></a><span id="l7.4249" class="difflineminus">-        this.scrollToMinute(this.mDayStartMin);</span>
<a href="#l7.4250"></a><span id="l7.4250" class="difflineminus">-</span>
<a href="#l7.4251"></a><span id="l7.4251" class="difflineminus">-        // get visible hours from prefs and set on the view</span>
<a href="#l7.4252"></a><span id="l7.4252" class="difflineminus">-        let visibleMinutes = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9) * 60;</span>
<a href="#l7.4253"></a><span id="l7.4253" class="difflineminus">-        this.setVisibleMinutes(visibleMinutes);</span>
<a href="#l7.4254"></a><span id="l7.4254" class="difflineminus">-</span>
<a href="#l7.4255"></a><span id="l7.4255" class="difflineminus">-        // set the flex attribute at the scrollbox-innerbox</span>
<a href="#l7.4256"></a><span id="l7.4256" class="difflineminus">-        // (this can be removed, after Bug 343555 is fixed)</span>
<a href="#l7.4257"></a><span id="l7.4257" class="difflineminus">-        let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.4258"></a><span id="l7.4258" class="difflineminus">-                       this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.4259"></a><span id="l7.4259" class="difflineminus">-        document.getAnonymousElementByAttribute(</span>
<a href="#l7.4260"></a><span id="l7.4260" class="difflineminus">-            scrollbox, &quot;class&quot;, &quot;box-inherit scrollbox-innerbox&quot;).flex = &quot;1&quot;;</span>
<a href="#l7.4261"></a><span id="l7.4261" class="difflineminus">-</span>
<a href="#l7.4262"></a><span id="l7.4262" class="difflineminus">-        // set the time interval for the time indicator timer</span>
<a href="#l7.4263"></a><span id="l7.4263" class="difflineminus">-        this.setTimeIndicatorInterval(Preferences.get(&quot;calendar.view.timeIndicatorInterval&quot;, 15));</span>
<a href="#l7.4264"></a><span id="l7.4264" class="difflineminus">-        this.enableTimeIndicator();</span>
<a href="#l7.4265"></a><span id="l7.4265" class="difflineminus">-</span>
<a href="#l7.4266"></a><span id="l7.4266" class="difflineminus">-        this.reorient();</span>
<a href="#l7.4267"></a><span id="l7.4267" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l7.4268"></a><span id="l7.4268" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.4269"></a><span id="l7.4269" class="difflineplus">+</span>
<a href="#l7.4270"></a><span id="l7.4270" class="difflineplus">+          // get day start/end hour from prefs and set on the view</span>
<a href="#l7.4271"></a><span id="l7.4271" class="difflineplus">+          this.setDayStartEndMinutes(Preferences.get(&quot;calendar.view.daystarthour&quot;, 8) * 60,</span>
<a href="#l7.4272"></a><span id="l7.4272" class="difflineplus">+                                     Preferences.get(&quot;calendar.view.dayendhour&quot;, 17) * 60);</span>
<a href="#l7.4273"></a><span id="l7.4273" class="difflineplus">+</span>
<a href="#l7.4274"></a><span id="l7.4274" class="difflineplus">+          // initially scroll to the day start hour in the view</span>
<a href="#l7.4275"></a><span id="l7.4275" class="difflineplus">+          this.scrollToMinute(this.mDayStartMin);</span>
<a href="#l7.4276"></a><span id="l7.4276" class="difflineplus">+</span>
<a href="#l7.4277"></a><span id="l7.4277" class="difflineplus">+          // get visible hours from prefs and set on the view</span>
<a href="#l7.4278"></a><span id="l7.4278" class="difflineplus">+          let visibleMinutes = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9) * 60;</span>
<a href="#l7.4279"></a><span id="l7.4279" class="difflineplus">+          this.setVisibleMinutes(visibleMinutes);</span>
<a href="#l7.4280"></a><span id="l7.4280" class="difflineplus">+</span>
<a href="#l7.4281"></a><span id="l7.4281" class="difflineplus">+          // set the flex attribute at the scrollbox-innerbox</span>
<a href="#l7.4282"></a><span id="l7.4282" class="difflineplus">+          // (this can be removed, after Bug 343555 is fixed)</span>
<a href="#l7.4283"></a><span id="l7.4283" class="difflineplus">+          let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.4284"></a><span id="l7.4284" class="difflineplus">+                         this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.4285"></a><span id="l7.4285" class="difflineplus">+          document.getAnonymousElementByAttribute(</span>
<a href="#l7.4286"></a><span id="l7.4286" class="difflineplus">+              scrollbox, &quot;class&quot;, &quot;box-inherit scrollbox-innerbox&quot;).flex = &quot;1&quot;;</span>
<a href="#l7.4287"></a><span id="l7.4287" class="difflineplus">+</span>
<a href="#l7.4288"></a><span id="l7.4288" class="difflineplus">+          // set the time interval for the time indicator timer</span>
<a href="#l7.4289"></a><span id="l7.4289" class="difflineplus">+          this.setTimeIndicatorInterval(Preferences.get(&quot;calendar.view.timeIndicatorInterval&quot;, 15));</span>
<a href="#l7.4290"></a><span id="l7.4290" class="difflineplus">+          this.enableTimeIndicator();</span>
<a href="#l7.4291"></a><span id="l7.4291" class="difflineplus">+</span>
<a href="#l7.4292"></a><span id="l7.4292" class="difflineplus">+          this.reorient();</span>
<a href="#l7.4293"></a><span id="l7.4293">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l7.4294"></a><span id="l7.4294"> </span>
<a href="#l7.4295"></a><span id="l7.4295">       &lt;property name=&quot;daysInView&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.4296"></a><span id="l7.4296">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4297"></a><span id="l7.4297" class="difflineminus">-          return this.labeldaybox.childNodes &amp;&amp; this.labeldaybox.childNodes.length;</span>
<a href="#l7.4298"></a><span id="l7.4298" class="difflineplus">+            return this.labeldaybox.childNodes &amp;&amp; this.labeldaybox.childNodes.length;</span>
<a href="#l7.4299"></a><span id="l7.4299">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4300"></a><span id="l7.4300">       &lt;/property&gt;</span>
<a href="#l7.4301"></a><span id="l7.4301"> </span>
<a href="#l7.4302"></a><span id="l7.4302">       &lt;property name=&quot;supportsZoom&quot; readonly=&quot;true&quot;</span>
<a href="#l7.4303"></a><span id="l7.4303">                 onget=&quot;return true;&quot;/&gt;</span>
<a href="#l7.4304"></a><span id="l7.4304">       &lt;property name=&quot;supportsRotation&quot; readonly=&quot;true&quot;</span>
<a href="#l7.4305"></a><span id="l7.4305">                 onget=&quot;return true&quot;/&gt;</span>
<a href="#l7.4306"></a><span id="l7.4306"> </span>
<a href="#l7.4307"></a><span id="l7.4307">       &lt;method name=&quot;setTimeIndicatorInterval&quot;&gt;</span>
<a href="#l7.4308"></a><span id="l7.4308">         &lt;parameter name=&quot;aPrefInterval&quot;/&gt;</span>
<a href="#l7.4309"></a><span id="l7.4309">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4310"></a><span id="l7.4310" class="difflineminus">-          // If the preference just edited by the user is outside the valid</span>
<a href="#l7.4311"></a><span id="l7.4311" class="difflineminus">-          // range [0, 1440], we change it into the nearest limit (0 or 1440).</span>
<a href="#l7.4312"></a><span id="l7.4312" class="difflineminus">-          let newTimeInterval = Math.max(0, Math.min(1440, aPrefInterval));</span>
<a href="#l7.4313"></a><span id="l7.4313" class="difflineminus">-          if (newTimeInterval != aPrefInterval) {</span>
<a href="#l7.4314"></a><span id="l7.4314" class="difflineminus">-              Preferences.set(&quot;calendar.view.timeIndicatorInterval&quot;, newTimeInterval);</span>
<a href="#l7.4315"></a><span id="l7.4315" class="difflineminus">-          }</span>
<a href="#l7.4316"></a><span id="l7.4316" class="difflineminus">-</span>
<a href="#l7.4317"></a><span id="l7.4317" class="difflineminus">-          if (newTimeInterval != this.mTimeIndicatorInterval) {</span>
<a href="#l7.4318"></a><span id="l7.4318" class="difflineminus">-              this.mTimeIndicatorInterval = newTimeInterval;</span>
<a href="#l7.4319"></a><span id="l7.4319" class="difflineminus">-          }</span>
<a href="#l7.4320"></a><span id="l7.4320" class="difflineminus">-          if (this.mTimeIndicatorInterval == 0) {</span>
<a href="#l7.4321"></a><span id="l7.4321" class="difflineminus">-              timeIndicator.cancel();</span>
<a href="#l7.4322"></a><span id="l7.4322" class="difflineminus">-          }</span>
<a href="#l7.4323"></a><span id="l7.4323" class="difflineplus">+            // If the preference just edited by the user is outside the valid</span>
<a href="#l7.4324"></a><span id="l7.4324" class="difflineplus">+            // range [0, 1440], we change it into the nearest limit (0 or 1440).</span>
<a href="#l7.4325"></a><span id="l7.4325" class="difflineplus">+            let newTimeInterval = Math.max(0, Math.min(1440, aPrefInterval));</span>
<a href="#l7.4326"></a><span id="l7.4326" class="difflineplus">+            if (newTimeInterval != aPrefInterval) {</span>
<a href="#l7.4327"></a><span id="l7.4327" class="difflineplus">+                Preferences.set(&quot;calendar.view.timeIndicatorInterval&quot;, newTimeInterval);</span>
<a href="#l7.4328"></a><span id="l7.4328" class="difflineplus">+            }</span>
<a href="#l7.4329"></a><span id="l7.4329" class="difflineplus">+</span>
<a href="#l7.4330"></a><span id="l7.4330" class="difflineplus">+            if (newTimeInterval != this.mTimeIndicatorInterval) {</span>
<a href="#l7.4331"></a><span id="l7.4331" class="difflineplus">+                this.mTimeIndicatorInterval = newTimeInterval;</span>
<a href="#l7.4332"></a><span id="l7.4332" class="difflineplus">+            }</span>
<a href="#l7.4333"></a><span id="l7.4333" class="difflineplus">+            if (this.mTimeIndicatorInterval == 0) {</span>
<a href="#l7.4334"></a><span id="l7.4334" class="difflineplus">+                timeIndicator.cancel();</span>
<a href="#l7.4335"></a><span id="l7.4335" class="difflineplus">+            }</span>
<a href="#l7.4336"></a><span id="l7.4336">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4337"></a><span id="l7.4337">       &lt;/method&gt;</span>
<a href="#l7.4338"></a><span id="l7.4338"> </span>
<a href="#l7.4339"></a><span id="l7.4339">       &lt;method name=&quot;enableTimeIndicator&quot;&gt;</span>
<a href="#l7.4340"></a><span id="l7.4340">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4341"></a><span id="l7.4341" class="difflineminus">-          // Hide or show the time indicator if the preference becomes 0 or greater than 0.</span>
<a href="#l7.4342"></a><span id="l7.4342" class="difflineminus">-          let hideIndicator = this.mTimeIndicatorInterval == 0;</span>
<a href="#l7.4343"></a><span id="l7.4343" class="difflineminus">-          setBooleanAttribute(this.timeBarTimeIndicator, &quot;hidden&quot;, hideIndicator);</span>
<a href="#l7.4344"></a><span id="l7.4344" class="difflineminus">-          let todayColumn = this.findColumnForDate(this.today());</span>
<a href="#l7.4345"></a><span id="l7.4345" class="difflineminus">-          if (todayColumn) {</span>
<a href="#l7.4346"></a><span id="l7.4346" class="difflineminus">-              setBooleanAttribute(todayColumn.column.timeIndicatorBox, &quot;hidden&quot;, hideIndicator);</span>
<a href="#l7.4347"></a><span id="l7.4347" class="difflineminus">-          }</span>
<a href="#l7.4348"></a><span id="l7.4348" class="difflineminus">-          // Update the timer but only under some circumstances, otherwise</span>
<a href="#l7.4349"></a><span id="l7.4349" class="difflineminus">-          // it will update the wrong view or it will start without need.</span>
<a href="#l7.4350"></a><span id="l7.4350" class="difflineminus">-          let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l7.4351"></a><span id="l7.4351" class="difflineminus">-          let currView = currentView().type;</span>
<a href="#l7.4352"></a><span id="l7.4352" class="difflineminus">-          if (currentMode == &quot;calendar&quot; &amp;&amp; currView == this.type &amp;&amp; !hideIndicator &amp;&amp;</span>
<a href="#l7.4353"></a><span id="l7.4353" class="difflineminus">-              (currView == &quot;day&quot; || currView == &quot;week&quot;)) {</span>
<a href="#l7.4354"></a><span id="l7.4354" class="difflineminus">-              this.updateTimeIndicatorPosition(true);</span>
<a href="#l7.4355"></a><span id="l7.4355" class="difflineminus">-          }</span>
<a href="#l7.4356"></a><span id="l7.4356" class="difflineplus">+            // Hide or show the time indicator if the preference becomes 0 or greater than 0.</span>
<a href="#l7.4357"></a><span id="l7.4357" class="difflineplus">+            let hideIndicator = this.mTimeIndicatorInterval == 0;</span>
<a href="#l7.4358"></a><span id="l7.4358" class="difflineplus">+            setBooleanAttribute(this.timeBarTimeIndicator, &quot;hidden&quot;, hideIndicator);</span>
<a href="#l7.4359"></a><span id="l7.4359" class="difflineplus">+            let todayColumn = this.findColumnForDate(this.today());</span>
<a href="#l7.4360"></a><span id="l7.4360" class="difflineplus">+            if (todayColumn) {</span>
<a href="#l7.4361"></a><span id="l7.4361" class="difflineplus">+                setBooleanAttribute(todayColumn.column.timeIndicatorBox, &quot;hidden&quot;, hideIndicator);</span>
<a href="#l7.4362"></a><span id="l7.4362" class="difflineplus">+            }</span>
<a href="#l7.4363"></a><span id="l7.4363" class="difflineplus">+            // Update the timer but only under some circumstances, otherwise</span>
<a href="#l7.4364"></a><span id="l7.4364" class="difflineplus">+            // it will update the wrong view or it will start without need.</span>
<a href="#l7.4365"></a><span id="l7.4365" class="difflineplus">+            let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l7.4366"></a><span id="l7.4366" class="difflineplus">+            let currView = currentView().type;</span>
<a href="#l7.4367"></a><span id="l7.4367" class="difflineplus">+            if (currentMode == &quot;calendar&quot; &amp;&amp; currView == this.type &amp;&amp; !hideIndicator &amp;&amp;</span>
<a href="#l7.4368"></a><span id="l7.4368" class="difflineplus">+                (currView == &quot;day&quot; || currView == &quot;week&quot;)) {</span>
<a href="#l7.4369"></a><span id="l7.4369" class="difflineplus">+                this.updateTimeIndicatorPosition(true);</span>
<a href="#l7.4370"></a><span id="l7.4370" class="difflineplus">+            }</span>
<a href="#l7.4371"></a><span id="l7.4371">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4372"></a><span id="l7.4372">       &lt;/method&gt;</span>
<a href="#l7.4373"></a><span id="l7.4373"> </span>
<a href="#l7.4374"></a><span id="l7.4374">       &lt;method name=&quot;updateTimeIndicatorPosition&quot;&gt;</span>
<a href="#l7.4375"></a><span id="l7.4375">         &lt;parameter name=&quot;aUpdateTheTimer&quot;/&gt;</span>
<a href="#l7.4376"></a><span id="l7.4376">         &lt;parameter name=&quot;aPpmChanged&quot;/&gt;</span>
<a href="#l7.4377"></a><span id="l7.4377">         &lt;parameter name=&quot;aViewChanged&quot;/&gt;</span>
<a href="#l7.4378"></a><span id="l7.4378">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4379"></a><span id="l7.4379" class="difflineminus">-          let now = cal.now();</span>
<a href="#l7.4380"></a><span id="l7.4380" class="difflineminus">-          let nowMinutes = now.hour * 60 + now.minute;</span>
<a href="#l7.4381"></a><span id="l7.4381" class="difflineminus">-          if (aUpdateTheTimer) {</span>
<a href="#l7.4382"></a><span id="l7.4382" class="difflineminus">-              let prefInt = this.mTimeIndicatorInterval;</span>
<a href="#l7.4383"></a><span id="l7.4383" class="difflineminus">-              if (prefInt == 0) {</span>
<a href="#l7.4384"></a><span id="l7.4384" class="difflineminus">-                  timeIndicator.cancel();</span>
<a href="#l7.4385"></a><span id="l7.4385" class="difflineminus">-                  return;</span>
<a href="#l7.4386"></a><span id="l7.4386" class="difflineminus">-              }</span>
<a href="#l7.4387"></a><span id="l7.4387" class="difflineminus">-</span>
<a href="#l7.4388"></a><span id="l7.4388" class="difflineminus">-              // Increase the update interval if pixels per minute is small.</span>
<a href="#l7.4389"></a><span id="l7.4389" class="difflineminus">-              let oldPrefInt = prefInt;</span>
<a href="#l7.4390"></a><span id="l7.4390" class="difflineminus">-              if (aPpmChanged &amp;&amp; this.mPixPerMin &lt; 0.6) {</span>
<a href="#l7.4391"></a><span id="l7.4391" class="difflineminus">-                  prefInt = Math.round(prefInt / this.mPixPerMin);</span>
<a href="#l7.4392"></a><span id="l7.4392" class="difflineminus">-              }</span>
<a href="#l7.4393"></a><span id="l7.4393" class="difflineminus">-              if (!aPpmChanged || aViewChanged || oldPrefInt != prefInt) {</span>
<a href="#l7.4394"></a><span id="l7.4394" class="difflineminus">-                  // Synchronize the timer with a multiple of the interval.</span>
<a href="#l7.4395"></a><span id="l7.4395" class="difflineminus">-                  let firstInterval = (prefInt - nowMinutes % prefInt) * 60 - now.second;</span>
<a href="#l7.4396"></a><span id="l7.4396" class="difflineminus">-                  if (timeIndicator.timer) {</span>
<a href="#l7.4397"></a><span id="l7.4397" class="difflineminus">-                      timeIndicator.cancel();</span>
<a href="#l7.4398"></a><span id="l7.4398" class="difflineminus">-                  }</span>
<a href="#l7.4399"></a><span id="l7.4399" class="difflineminus">-                  timeIndicator.lastView = this.id;</span>
<a href="#l7.4400"></a><span id="l7.4400" class="difflineminus">-                  timeIndicator.timer = setTimeout(() =&gt; {</span>
<a href="#l7.4401"></a><span id="l7.4401" class="difflineminus">-                      this.updateTimeIndicatorPosition(false);</span>
<a href="#l7.4402"></a><span id="l7.4402" class="difflineminus">-                      timeIndicator.start(prefInt * 60, this);</span>
<a href="#l7.4403"></a><span id="l7.4403" class="difflineminus">-                  }, firstInterval * 1000);</span>
<a href="#l7.4404"></a><span id="l7.4404" class="difflineminus">-</span>
<a href="#l7.4405"></a><span id="l7.4405" class="difflineminus">-                  // Set the time for the first positioning of the indicator.</span>
<a href="#l7.4406"></a><span id="l7.4406" class="difflineminus">-                  let time = Math.floor(nowMinutes / prefInt) * prefInt;</span>
<a href="#l7.4407"></a><span id="l7.4407" class="difflineminus">-                  document.getElementById(&quot;day-view&quot;).mTimeIndicatorMinutes = time;</span>
<a href="#l7.4408"></a><span id="l7.4408" class="difflineminus">-                  document.getElementById(&quot;week-view&quot;).mTimeIndicatorMinutes = time;</span>
<a href="#l7.4409"></a><span id="l7.4409" class="difflineminus">-              }</span>
<a href="#l7.4410"></a><span id="l7.4410" class="difflineminus">-          } else if (aUpdateTheTimer === false) {</span>
<a href="#l7.4411"></a><span id="l7.4411" class="difflineminus">-              // Set the time for every positioning after the first</span>
<a href="#l7.4412"></a><span id="l7.4412" class="difflineminus">-              document.getElementById(&quot;day-view&quot;).mTimeIndicatorMinutes = nowMinutes;</span>
<a href="#l7.4413"></a><span id="l7.4413" class="difflineminus">-              document.getElementById(&quot;week-view&quot;).mTimeIndicatorMinutes = nowMinutes;</span>
<a href="#l7.4414"></a><span id="l7.4414" class="difflineminus">-          }</span>
<a href="#l7.4415"></a><span id="l7.4415" class="difflineminus">-          // Update the position of the indicator.</span>
<a href="#l7.4416"></a><span id="l7.4416" class="difflineminus">-          let position = Math.round(this.mPixPerMin * this.mTimeIndicatorMinutes) - 1;</span>
<a href="#l7.4417"></a><span id="l7.4417" class="difflineminus">-          let posAttr = (this.orient == &quot;vertical&quot; ? &quot;top: &quot; : &quot;left: &quot;);</span>
<a href="#l7.4418"></a><span id="l7.4418" class="difflineminus">-          this.timeBarTimeIndicator.setAttribute(&quot;style&quot;, posAttr + position + &quot;px;&quot;);</span>
<a href="#l7.4419"></a><span id="l7.4419" class="difflineminus">-          let todayColumn = this.findColumnForDate(this.today());</span>
<a href="#l7.4420"></a><span id="l7.4420" class="difflineminus">-          if (todayColumn) {</span>
<a href="#l7.4421"></a><span id="l7.4421" class="difflineminus">-              todayColumn.column.timeIndicatorBox.setAttribute(&quot;style&quot;, &quot;margin-&quot; + posAttr + position + &quot;px;&quot;);</span>
<a href="#l7.4422"></a><span id="l7.4422" class="difflineminus">-          }</span>
<a href="#l7.4423"></a><span id="l7.4423" class="difflineplus">+            let now = cal.now();</span>
<a href="#l7.4424"></a><span id="l7.4424" class="difflineplus">+            let nowMinutes = now.hour * 60 + now.minute;</span>
<a href="#l7.4425"></a><span id="l7.4425" class="difflineplus">+            if (aUpdateTheTimer) {</span>
<a href="#l7.4426"></a><span id="l7.4426" class="difflineplus">+                let prefInt = this.mTimeIndicatorInterval;</span>
<a href="#l7.4427"></a><span id="l7.4427" class="difflineplus">+                if (prefInt == 0) {</span>
<a href="#l7.4428"></a><span id="l7.4428" class="difflineplus">+                    timeIndicator.cancel();</span>
<a href="#l7.4429"></a><span id="l7.4429" class="difflineplus">+                    return;</span>
<a href="#l7.4430"></a><span id="l7.4430" class="difflineplus">+                }</span>
<a href="#l7.4431"></a><span id="l7.4431" class="difflineplus">+</span>
<a href="#l7.4432"></a><span id="l7.4432" class="difflineplus">+                // Increase the update interval if pixels per minute is small.</span>
<a href="#l7.4433"></a><span id="l7.4433" class="difflineplus">+                let oldPrefInt = prefInt;</span>
<a href="#l7.4434"></a><span id="l7.4434" class="difflineplus">+                if (aPpmChanged &amp;&amp; this.mPixPerMin &lt; 0.6) {</span>
<a href="#l7.4435"></a><span id="l7.4435" class="difflineplus">+                    prefInt = Math.round(prefInt / this.mPixPerMin);</span>
<a href="#l7.4436"></a><span id="l7.4436" class="difflineplus">+                }</span>
<a href="#l7.4437"></a><span id="l7.4437" class="difflineplus">+                if (!aPpmChanged || aViewChanged || oldPrefInt != prefInt) {</span>
<a href="#l7.4438"></a><span id="l7.4438" class="difflineplus">+                    // Synchronize the timer with a multiple of the interval.</span>
<a href="#l7.4439"></a><span id="l7.4439" class="difflineplus">+                    let firstInterval = (prefInt - nowMinutes % prefInt) * 60 - now.second;</span>
<a href="#l7.4440"></a><span id="l7.4440" class="difflineplus">+                    if (timeIndicator.timer) {</span>
<a href="#l7.4441"></a><span id="l7.4441" class="difflineplus">+                        timeIndicator.cancel();</span>
<a href="#l7.4442"></a><span id="l7.4442" class="difflineplus">+                    }</span>
<a href="#l7.4443"></a><span id="l7.4443" class="difflineplus">+                    timeIndicator.lastView = this.id;</span>
<a href="#l7.4444"></a><span id="l7.4444" class="difflineplus">+                    timeIndicator.timer = setTimeout(() =&gt; {</span>
<a href="#l7.4445"></a><span id="l7.4445" class="difflineplus">+                        this.updateTimeIndicatorPosition(false);</span>
<a href="#l7.4446"></a><span id="l7.4446" class="difflineplus">+                        timeIndicator.start(prefInt * 60, this);</span>
<a href="#l7.4447"></a><span id="l7.4447" class="difflineplus">+                    }, firstInterval * 1000);</span>
<a href="#l7.4448"></a><span id="l7.4448" class="difflineplus">+</span>
<a href="#l7.4449"></a><span id="l7.4449" class="difflineplus">+                    // Set the time for the first positioning of the indicator.</span>
<a href="#l7.4450"></a><span id="l7.4450" class="difflineplus">+                    let time = Math.floor(nowMinutes / prefInt) * prefInt;</span>
<a href="#l7.4451"></a><span id="l7.4451" class="difflineplus">+                    document.getElementById(&quot;day-view&quot;).mTimeIndicatorMinutes = time;</span>
<a href="#l7.4452"></a><span id="l7.4452" class="difflineplus">+                    document.getElementById(&quot;week-view&quot;).mTimeIndicatorMinutes = time;</span>
<a href="#l7.4453"></a><span id="l7.4453" class="difflineplus">+                }</span>
<a href="#l7.4454"></a><span id="l7.4454" class="difflineplus">+            } else if (aUpdateTheTimer === false) {</span>
<a href="#l7.4455"></a><span id="l7.4455" class="difflineplus">+                // Set the time for every positioning after the first</span>
<a href="#l7.4456"></a><span id="l7.4456" class="difflineplus">+                document.getElementById(&quot;day-view&quot;).mTimeIndicatorMinutes = nowMinutes;</span>
<a href="#l7.4457"></a><span id="l7.4457" class="difflineplus">+                document.getElementById(&quot;week-view&quot;).mTimeIndicatorMinutes = nowMinutes;</span>
<a href="#l7.4458"></a><span id="l7.4458" class="difflineplus">+            }</span>
<a href="#l7.4459"></a><span id="l7.4459" class="difflineplus">+            // Update the position of the indicator.</span>
<a href="#l7.4460"></a><span id="l7.4460" class="difflineplus">+            let position = Math.round(this.mPixPerMin * this.mTimeIndicatorMinutes) - 1;</span>
<a href="#l7.4461"></a><span id="l7.4461" class="difflineplus">+            let posAttr = (this.orient == &quot;vertical&quot; ? &quot;top: &quot; : &quot;left: &quot;);</span>
<a href="#l7.4462"></a><span id="l7.4462" class="difflineplus">+            this.timeBarTimeIndicator.setAttribute(&quot;style&quot;, posAttr + position + &quot;px;&quot;);</span>
<a href="#l7.4463"></a><span id="l7.4463" class="difflineplus">+            let todayColumn = this.findColumnForDate(this.today());</span>
<a href="#l7.4464"></a><span id="l7.4464" class="difflineplus">+            if (todayColumn) {</span>
<a href="#l7.4465"></a><span id="l7.4465" class="difflineplus">+                todayColumn.column.timeIndicatorBox.setAttribute(&quot;style&quot;, &quot;margin-&quot; + posAttr + position + &quot;px;&quot;);</span>
<a href="#l7.4466"></a><span id="l7.4466" class="difflineplus">+            }</span>
<a href="#l7.4467"></a><span id="l7.4467">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4468"></a><span id="l7.4468">       &lt;/method&gt;</span>
<a href="#l7.4469"></a><span id="l7.4469"> </span>
<a href="#l7.4470"></a><span id="l7.4470">       &lt;method name=&quot;handlePreference&quot;&gt;</span>
<a href="#l7.4471"></a><span id="l7.4471">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l7.4472"></a><span id="l7.4472">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l7.4473"></a><span id="l7.4473">         &lt;parameter name=&quot;aPreference&quot;/&gt;</span>
<a href="#l7.4474"></a><span id="l7.4474">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4475"></a><span id="l7.4475" class="difflineat">@@ -2687,45 +2687,45 @@</span>
<a href="#l7.4476"></a><span id="l7.4476">                     break;</span>
<a href="#l7.4477"></a><span id="l7.4477">             }</span>
<a href="#l7.4478"></a><span id="l7.4478">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4479"></a><span id="l7.4479">       &lt;/method&gt;</span>
<a href="#l7.4480"></a><span id="l7.4480"> </span>
<a href="#l7.4481"></a><span id="l7.4481">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l7.4482"></a><span id="l7.4482">         &lt;parameter name=&quot;aRealSelf&quot;/&gt;</span>
<a href="#l7.4483"></a><span id="l7.4483">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4484"></a><span id="l7.4484" class="difflineminus">-          let self = aRealSelf || this; // eslint-disable-line consistent-this</span>
<a href="#l7.4485"></a><span id="l7.4485" class="difflineminus">-          let isARelayout = !aRealSelf;</span>
<a href="#l7.4486"></a><span id="l7.4486" class="difflineminus">-          let scrollbox = document.getAnonymousElementByAttribute(self, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.4487"></a><span id="l7.4487" class="difflineminus">-          let size;</span>
<a href="#l7.4488"></a><span id="l7.4488" class="difflineminus">-          if (self.orient == &quot;horizontal&quot;) {</span>
<a href="#l7.4489"></a><span id="l7.4489" class="difflineminus">-              size = scrollbox.boxObject.width;</span>
<a href="#l7.4490"></a><span id="l7.4490" class="difflineminus">-          } else {</span>
<a href="#l7.4491"></a><span id="l7.4491" class="difflineminus">-              size = scrollbox.boxObject.height;</span>
<a href="#l7.4492"></a><span id="l7.4492" class="difflineminus">-          }</span>
<a href="#l7.4493"></a><span id="l7.4493" class="difflineminus">-          let ppm = size / self.mVisibleMinutes;</span>
<a href="#l7.4494"></a><span id="l7.4494" class="difflineminus">-          ppm = Math.floor(ppm * 1000) / 1000;</span>
<a href="#l7.4495"></a><span id="l7.4495" class="difflineminus">-          if (ppm &lt; self.mMinPixelsPerMinute) {</span>
<a href="#l7.4496"></a><span id="l7.4496" class="difflineminus">-              ppm = self.mMinPixelsPerMinute;</span>
<a href="#l7.4497"></a><span id="l7.4497" class="difflineminus">-          }</span>
<a href="#l7.4498"></a><span id="l7.4498" class="difflineminus">-          let ppmChanged = (self.pixelsPerMinute != ppm);</span>
<a href="#l7.4499"></a><span id="l7.4499" class="difflineminus">-          self.pixelsPerMinute = ppm;</span>
<a href="#l7.4500"></a><span id="l7.4500" class="difflineminus">-          setTimeout(() =&gt; self.scrollToMinute(self.mFirstVisibleMinute), 0);</span>
<a href="#l7.4501"></a><span id="l7.4501" class="difflineminus">-</span>
<a href="#l7.4502"></a><span id="l7.4502" class="difflineminus">-          // Fit the weekday labels while scrolling.</span>
<a href="#l7.4503"></a><span id="l7.4503" class="difflineminus">-          self.adjustWeekdayLength(self.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;);</span>
<a href="#l7.4504"></a><span id="l7.4504" class="difflineminus">-</span>
<a href="#l7.4505"></a><span id="l7.4505" class="difflineminus">-          // Adjust the time indicator position and the related timer.</span>
<a href="#l7.4506"></a><span id="l7.4506" class="difflineminus">-          if (this.mTimeIndicatorInterval != 0) {</span>
<a href="#l7.4507"></a><span id="l7.4507" class="difflineminus">-              let viewChanged = isARelayout &amp;&amp; (timeIndicator.lastView != this.id);</span>
<a href="#l7.4508"></a><span id="l7.4508" class="difflineminus">-              let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l7.4509"></a><span id="l7.4509" class="difflineminus">-              if (currentMode == &quot;calendar&quot; &amp;&amp; (!timeIndicator.timer || ppmChanged || viewChanged)) {</span>
<a href="#l7.4510"></a><span id="l7.4510" class="difflineminus">-                  self.updateTimeIndicatorPosition(true, ppmChanged, viewChanged);</span>
<a href="#l7.4511"></a><span id="l7.4511" class="difflineminus">-              }</span>
<a href="#l7.4512"></a><span id="l7.4512" class="difflineminus">-          }</span>
<a href="#l7.4513"></a><span id="l7.4513" class="difflineplus">+            let self = aRealSelf || this; // eslint-disable-line consistent-this</span>
<a href="#l7.4514"></a><span id="l7.4514" class="difflineplus">+            let isARelayout = !aRealSelf;</span>
<a href="#l7.4515"></a><span id="l7.4515" class="difflineplus">+            let scrollbox = document.getAnonymousElementByAttribute(self, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.4516"></a><span id="l7.4516" class="difflineplus">+            let size;</span>
<a href="#l7.4517"></a><span id="l7.4517" class="difflineplus">+            if (self.orient == &quot;horizontal&quot;) {</span>
<a href="#l7.4518"></a><span id="l7.4518" class="difflineplus">+                size = scrollbox.boxObject.width;</span>
<a href="#l7.4519"></a><span id="l7.4519" class="difflineplus">+            } else {</span>
<a href="#l7.4520"></a><span id="l7.4520" class="difflineplus">+                size = scrollbox.boxObject.height;</span>
<a href="#l7.4521"></a><span id="l7.4521" class="difflineplus">+            }</span>
<a href="#l7.4522"></a><span id="l7.4522" class="difflineplus">+            let ppm = size / self.mVisibleMinutes;</span>
<a href="#l7.4523"></a><span id="l7.4523" class="difflineplus">+            ppm = Math.floor(ppm * 1000) / 1000;</span>
<a href="#l7.4524"></a><span id="l7.4524" class="difflineplus">+            if (ppm &lt; self.mMinPixelsPerMinute) {</span>
<a href="#l7.4525"></a><span id="l7.4525" class="difflineplus">+                ppm = self.mMinPixelsPerMinute;</span>
<a href="#l7.4526"></a><span id="l7.4526" class="difflineplus">+            }</span>
<a href="#l7.4527"></a><span id="l7.4527" class="difflineplus">+            let ppmChanged = (self.pixelsPerMinute != ppm);</span>
<a href="#l7.4528"></a><span id="l7.4528" class="difflineplus">+            self.pixelsPerMinute = ppm;</span>
<a href="#l7.4529"></a><span id="l7.4529" class="difflineplus">+            setTimeout(() =&gt; self.scrollToMinute(self.mFirstVisibleMinute), 0);</span>
<a href="#l7.4530"></a><span id="l7.4530" class="difflineplus">+</span>
<a href="#l7.4531"></a><span id="l7.4531" class="difflineplus">+            // Fit the weekday labels while scrolling.</span>
<a href="#l7.4532"></a><span id="l7.4532" class="difflineplus">+            self.adjustWeekdayLength(self.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;);</span>
<a href="#l7.4533"></a><span id="l7.4533" class="difflineplus">+</span>
<a href="#l7.4534"></a><span id="l7.4534" class="difflineplus">+            // Adjust the time indicator position and the related timer.</span>
<a href="#l7.4535"></a><span id="l7.4535" class="difflineplus">+            if (this.mTimeIndicatorInterval != 0) {</span>
<a href="#l7.4536"></a><span id="l7.4536" class="difflineplus">+                let viewChanged = isARelayout &amp;&amp; (timeIndicator.lastView != this.id);</span>
<a href="#l7.4537"></a><span id="l7.4537" class="difflineplus">+                let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l7.4538"></a><span id="l7.4538" class="difflineplus">+                if (currentMode == &quot;calendar&quot; &amp;&amp; (!timeIndicator.timer || ppmChanged || viewChanged)) {</span>
<a href="#l7.4539"></a><span id="l7.4539" class="difflineplus">+                    self.updateTimeIndicatorPosition(true, ppmChanged, viewChanged);</span>
<a href="#l7.4540"></a><span id="l7.4540" class="difflineplus">+                }</span>
<a href="#l7.4541"></a><span id="l7.4541" class="difflineplus">+            }</span>
<a href="#l7.4542"></a><span id="l7.4542">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4543"></a><span id="l7.4543">       &lt;/method&gt;</span>
<a href="#l7.4544"></a><span id="l7.4544"> </span>
<a href="#l7.4545"></a><span id="l7.4545">       &lt;!-- mDateList will always be sorted before being set --&gt;</span>
<a href="#l7.4546"></a><span id="l7.4546">       &lt;field name=&quot;mDateList&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.4547"></a><span id="l7.4547">       &lt;!-- array of { date: calIDatetime, column: colbox, header: hdrbox }  --&gt;</span>
<a href="#l7.4548"></a><span id="l7.4548">       &lt;field name=&quot;mDateColumns&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.4549"></a><span id="l7.4549">       &lt;field name=&quot;mPixPerMin&quot;&gt;0.6&lt;/field&gt;</span>
<a href="#l7.4550"></a><span id="l7.4550" class="difflineat">@@ -2741,1151 +2741,1151 @@</span>
<a href="#l7.4551"></a><span id="l7.4551">       &lt;field name=&quot;mTimeIndicatorInterval&quot;&gt;15&lt;/field&gt;</span>
<a href="#l7.4552"></a><span id="l7.4552">       &lt;field name=&quot;mModeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l7.4553"></a><span id="l7.4553">       &lt;field name=&quot;mTimeIndicatorMinutes&quot;&gt;0&lt;/field&gt;</span>
<a href="#l7.4554"></a><span id="l7.4554"> </span>
<a href="#l7.4555"></a><span id="l7.4555">       &lt;method name=&quot;flashAlarm&quot;&gt;</span>
<a href="#l7.4556"></a><span id="l7.4556">         &lt;parameter name=&quot;aAlarmItem&quot;/&gt;</span>
<a href="#l7.4557"></a><span id="l7.4557">         &lt;parameter name=&quot;aStop&quot;/&gt;</span>
<a href="#l7.4558"></a><span id="l7.4558">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4559"></a><span id="l7.4559" class="difflineminus">-          // Helper function to save some duplicate code</span>
<a href="#l7.4560"></a><span id="l7.4560" class="difflineminus">-          function setFlashingAttribute(aBox) {</span>
<a href="#l7.4561"></a><span id="l7.4561" class="difflineminus">-              if (aStop) {</span>
<a href="#l7.4562"></a><span id="l7.4562" class="difflineminus">-                  aBox.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l7.4563"></a><span id="l7.4563" class="difflineminus">-              } else {</span>
<a href="#l7.4564"></a><span id="l7.4564" class="difflineminus">-                  aBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l7.4565"></a><span id="l7.4565" class="difflineminus">-              }</span>
<a href="#l7.4566"></a><span id="l7.4566" class="difflineminus">-          }</span>
<a href="#l7.4567"></a><span id="l7.4567" class="difflineminus">-</span>
<a href="#l7.4568"></a><span id="l7.4568" class="difflineminus">-          let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l7.4569"></a><span id="l7.4569" class="difflineminus">-          let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l7.4570"></a><span id="l7.4570" class="difflineminus">-</span>
<a href="#l7.4571"></a><span id="l7.4571" class="difflineminus">-          if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l7.4572"></a><span id="l7.4572" class="difflineminus">-              // No need to animate if the indicator should not be shown.</span>
<a href="#l7.4573"></a><span id="l7.4573" class="difflineminus">-              return;</span>
<a href="#l7.4574"></a><span id="l7.4574" class="difflineminus">-          }</span>
<a href="#l7.4575"></a><span id="l7.4575" class="difflineminus">-</span>
<a href="#l7.4576"></a><span id="l7.4576" class="difflineminus">-</span>
<a href="#l7.4577"></a><span id="l7.4577" class="difflineminus">-          // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l7.4578"></a><span id="l7.4578" class="difflineminus">-          // boxes.</span>
<a href="#l7.4579"></a><span id="l7.4579" class="difflineminus">-          let columns = this.findColumnsForItem(aAlarmItem);</span>
<a href="#l7.4580"></a><span id="l7.4580" class="difflineminus">-          for (let col of columns) {</span>
<a href="#l7.4581"></a><span id="l7.4581" class="difflineminus">-              let box = col.column.findChunkForOccurrence(aAlarmItem);</span>
<a href="#l7.4582"></a><span id="l7.4582" class="difflineminus">-              if (box &amp;&amp; box.eventbox) {</span>
<a href="#l7.4583"></a><span id="l7.4583" class="difflineminus">-                  setFlashingAttribute(box.eventbox);</span>
<a href="#l7.4584"></a><span id="l7.4584" class="difflineminus">-              }</span>
<a href="#l7.4585"></a><span id="l7.4585" class="difflineminus">-              box = col.header.findBoxForItem(aAlarmItem);</span>
<a href="#l7.4586"></a><span id="l7.4586" class="difflineminus">-              if (box) {</span>
<a href="#l7.4587"></a><span id="l7.4587" class="difflineminus">-                  setFlashingAttribute(box);</span>
<a href="#l7.4588"></a><span id="l7.4588" class="difflineminus">-              }</span>
<a href="#l7.4589"></a><span id="l7.4589" class="difflineminus">-          }</span>
<a href="#l7.4590"></a><span id="l7.4590" class="difflineminus">-</span>
<a href="#l7.4591"></a><span id="l7.4591" class="difflineminus">-          if (aStop) {</span>
<a href="#l7.4592"></a><span id="l7.4592" class="difflineminus">-              // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l7.4593"></a><span id="l7.4593" class="difflineminus">-              delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l7.4594"></a><span id="l7.4594" class="difflineminus">-          } else {</span>
<a href="#l7.4595"></a><span id="l7.4595" class="difflineminus">-              // Set up a timer to stop the flashing after the total time.</span>
<a href="#l7.4596"></a><span id="l7.4596" class="difflineminus">-              this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l7.4597"></a><span id="l7.4597" class="difflineminus">-              setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l7.4598"></a><span id="l7.4598" class="difflineminus">-          }</span>
<a href="#l7.4599"></a><span id="l7.4599" class="difflineplus">+            // Helper function to save some duplicate code</span>
<a href="#l7.4600"></a><span id="l7.4600" class="difflineplus">+            function setFlashingAttribute(aBox) {</span>
<a href="#l7.4601"></a><span id="l7.4601" class="difflineplus">+                if (aStop) {</span>
<a href="#l7.4602"></a><span id="l7.4602" class="difflineplus">+                    aBox.removeAttribute(&quot;flashing&quot;);</span>
<a href="#l7.4603"></a><span id="l7.4603" class="difflineplus">+                } else {</span>
<a href="#l7.4604"></a><span id="l7.4604" class="difflineplus">+                    aBox.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l7.4605"></a><span id="l7.4605" class="difflineplus">+                }</span>
<a href="#l7.4606"></a><span id="l7.4606" class="difflineplus">+            }</span>
<a href="#l7.4607"></a><span id="l7.4607" class="difflineplus">+</span>
<a href="#l7.4608"></a><span id="l7.4608" class="difflineplus">+            let showIndicator = Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true);</span>
<a href="#l7.4609"></a><span id="l7.4609" class="difflineplus">+            let totaltime = Preferences.get(&quot;calendar.alarms.indicator.totaltime&quot;, 3600);</span>
<a href="#l7.4610"></a><span id="l7.4610" class="difflineplus">+</span>
<a href="#l7.4611"></a><span id="l7.4611" class="difflineplus">+            if (!aStop &amp;&amp; (!showIndicator || totaltime &lt; 1)) {</span>
<a href="#l7.4612"></a><span id="l7.4612" class="difflineplus">+                // No need to animate if the indicator should not be shown.</span>
<a href="#l7.4613"></a><span id="l7.4613" class="difflineplus">+                return;</span>
<a href="#l7.4614"></a><span id="l7.4614" class="difflineplus">+            }</span>
<a href="#l7.4615"></a><span id="l7.4615" class="difflineplus">+</span>
<a href="#l7.4616"></a><span id="l7.4616" class="difflineplus">+</span>
<a href="#l7.4617"></a><span id="l7.4617" class="difflineplus">+            // Make sure the flashing attribute is set or reset on all visible</span>
<a href="#l7.4618"></a><span id="l7.4618" class="difflineplus">+            // boxes.</span>
<a href="#l7.4619"></a><span id="l7.4619" class="difflineplus">+            let columns = this.findColumnsForItem(aAlarmItem);</span>
<a href="#l7.4620"></a><span id="l7.4620" class="difflineplus">+            for (let col of columns) {</span>
<a href="#l7.4621"></a><span id="l7.4621" class="difflineplus">+                let box = col.column.findChunkForOccurrence(aAlarmItem);</span>
<a href="#l7.4622"></a><span id="l7.4622" class="difflineplus">+                if (box &amp;&amp; box.eventbox) {</span>
<a href="#l7.4623"></a><span id="l7.4623" class="difflineplus">+                    setFlashingAttribute(box.eventbox);</span>
<a href="#l7.4624"></a><span id="l7.4624" class="difflineplus">+                }</span>
<a href="#l7.4625"></a><span id="l7.4625" class="difflineplus">+                box = col.header.findBoxForItem(aAlarmItem);</span>
<a href="#l7.4626"></a><span id="l7.4626" class="difflineplus">+                if (box) {</span>
<a href="#l7.4627"></a><span id="l7.4627" class="difflineplus">+                    setFlashingAttribute(box);</span>
<a href="#l7.4628"></a><span id="l7.4628" class="difflineplus">+                }</span>
<a href="#l7.4629"></a><span id="l7.4629" class="difflineplus">+            }</span>
<a href="#l7.4630"></a><span id="l7.4630" class="difflineplus">+</span>
<a href="#l7.4631"></a><span id="l7.4631" class="difflineplus">+            if (aStop) {</span>
<a href="#l7.4632"></a><span id="l7.4632" class="difflineplus">+                // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l7.4633"></a><span id="l7.4633" class="difflineplus">+                delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l7.4634"></a><span id="l7.4634" class="difflineplus">+            } else {</span>
<a href="#l7.4635"></a><span id="l7.4635" class="difflineplus">+                // Set up a timer to stop the flashing after the total time.</span>
<a href="#l7.4636"></a><span id="l7.4636" class="difflineplus">+                this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l7.4637"></a><span id="l7.4637" class="difflineplus">+                setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l7.4638"></a><span id="l7.4638" class="difflineplus">+            }</span>
<a href="#l7.4639"></a><span id="l7.4639">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4640"></a><span id="l7.4640">       &lt;/method&gt;</span>
<a href="#l7.4641"></a><span id="l7.4641"> </span>
<a href="#l7.4642"></a><span id="l7.4642">       &lt;!-- calICalendarView --&gt;</span>
<a href="#l7.4643"></a><span id="l7.4643">       &lt;property name=&quot;supportsDisjointDates&quot;</span>
<a href="#l7.4644"></a><span id="l7.4644">         onget=&quot;return true&quot;/&gt;</span>
<a href="#l7.4645"></a><span id="l7.4645">       &lt;property name=&quot;hasDisjointDates&quot;</span>
<a href="#l7.4646"></a><span id="l7.4646">         onget=&quot;return (this.mDateList != null);&quot;/&gt;</span>
<a href="#l7.4647"></a><span id="l7.4647"> </span>
<a href="#l7.4648"></a><span id="l7.4648">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l7.4649"></a><span id="l7.4649">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4650"></a><span id="l7.4650" class="difflineminus">-          if (this.mStartDate) {</span>
<a href="#l7.4651"></a><span id="l7.4651" class="difflineminus">-              return this.mStartDate;</span>
<a href="#l7.4652"></a><span id="l7.4652" class="difflineminus">-          } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l7.4653"></a><span id="l7.4653" class="difflineminus">-              return this.mDateList[0];</span>
<a href="#l7.4654"></a><span id="l7.4654" class="difflineminus">-          } else {</span>
<a href="#l7.4655"></a><span id="l7.4655" class="difflineminus">-              return null;</span>
<a href="#l7.4656"></a><span id="l7.4656" class="difflineminus">-          }</span>
<a href="#l7.4657"></a><span id="l7.4657" class="difflineplus">+            if (this.mStartDate) {</span>
<a href="#l7.4658"></a><span id="l7.4658" class="difflineplus">+                return this.mStartDate;</span>
<a href="#l7.4659"></a><span id="l7.4659" class="difflineplus">+            } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l7.4660"></a><span id="l7.4660" class="difflineplus">+                return this.mDateList[0];</span>
<a href="#l7.4661"></a><span id="l7.4661" class="difflineplus">+            } else {</span>
<a href="#l7.4662"></a><span id="l7.4662" class="difflineplus">+                return null;</span>
<a href="#l7.4663"></a><span id="l7.4663" class="difflineplus">+            }</span>
<a href="#l7.4664"></a><span id="l7.4664">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4665"></a><span id="l7.4665">       &lt;/property&gt;</span>
<a href="#l7.4666"></a><span id="l7.4666"> </span>
<a href="#l7.4667"></a><span id="l7.4667">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l7.4668"></a><span id="l7.4668">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4669"></a><span id="l7.4669" class="difflineminus">-          if (this.mEndDate) {</span>
<a href="#l7.4670"></a><span id="l7.4670" class="difflineminus">-              return this.mEndDate;</span>
<a href="#l7.4671"></a><span id="l7.4671" class="difflineminus">-          } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l7.4672"></a><span id="l7.4672" class="difflineminus">-              return this.mDateList[this.mDateList.length - 1];</span>
<a href="#l7.4673"></a><span id="l7.4673" class="difflineminus">-          } else {</span>
<a href="#l7.4674"></a><span id="l7.4674" class="difflineminus">-              return null;</span>
<a href="#l7.4675"></a><span id="l7.4675" class="difflineminus">-          }</span>
<a href="#l7.4676"></a><span id="l7.4676" class="difflineplus">+            if (this.mEndDate) {</span>
<a href="#l7.4677"></a><span id="l7.4677" class="difflineplus">+                return this.mEndDate;</span>
<a href="#l7.4678"></a><span id="l7.4678" class="difflineplus">+            } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l7.4679"></a><span id="l7.4679" class="difflineplus">+                return this.mDateList[this.mDateList.length - 1];</span>
<a href="#l7.4680"></a><span id="l7.4680" class="difflineplus">+            } else {</span>
<a href="#l7.4681"></a><span id="l7.4681" class="difflineplus">+                return null;</span>
<a href="#l7.4682"></a><span id="l7.4682" class="difflineplus">+            }</span>
<a href="#l7.4683"></a><span id="l7.4683">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4684"></a><span id="l7.4684">       &lt;/property&gt;</span>
<a href="#l7.4685"></a><span id="l7.4685"> </span>
<a href="#l7.4686"></a><span id="l7.4686">       &lt;method name=&quot;showDate&quot;&gt;</span>
<a href="#l7.4687"></a><span id="l7.4687">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l7.4688"></a><span id="l7.4688">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4689"></a><span id="l7.4689" class="difflineminus">-          let targetDate = aDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4690"></a><span id="l7.4690" class="difflineminus">-          targetDate.isDate = true;</span>
<a href="#l7.4691"></a><span id="l7.4691" class="difflineminus">-</span>
<a href="#l7.4692"></a><span id="l7.4692" class="difflineminus">-          if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l7.4693"></a><span id="l7.4693" class="difflineminus">-              if (this.mStartDate.compare(targetDate) &lt;= 0 &amp;&amp;</span>
<a href="#l7.4694"></a><span id="l7.4694" class="difflineminus">-                  this.mEndDate.compare(targetDate) &gt;= 0) {</span>
<a href="#l7.4695"></a><span id="l7.4695" class="difflineminus">-                  return;</span>
<a href="#l7.4696"></a><span id="l7.4696" class="difflineminus">-              }</span>
<a href="#l7.4697"></a><span id="l7.4697" class="difflineminus">-          } else if (this.mDateList) {</span>
<a href="#l7.4698"></a><span id="l7.4698" class="difflineminus">-              for (let date of this.mDateList) {</span>
<a href="#l7.4699"></a><span id="l7.4699" class="difflineminus">-                  // if date is already visible, nothing to do</span>
<a href="#l7.4700"></a><span id="l7.4700" class="difflineminus">-                  if (date.compare(targetDate) == 0) {</span>
<a href="#l7.4701"></a><span id="l7.4701" class="difflineminus">-                      return;</span>
<a href="#l7.4702"></a><span id="l7.4702" class="difflineminus">-                  }</span>
<a href="#l7.4703"></a><span id="l7.4703" class="difflineminus">-              }</span>
<a href="#l7.4704"></a><span id="l7.4704" class="difflineminus">-          }</span>
<a href="#l7.4705"></a><span id="l7.4705" class="difflineminus">-</span>
<a href="#l7.4706"></a><span id="l7.4706" class="difflineminus">-          // if we're only showing one date, then continue</span>
<a href="#l7.4707"></a><span id="l7.4707" class="difflineminus">-          // to only show one date; otherwise, show the week.</span>
<a href="#l7.4708"></a><span id="l7.4708" class="difflineminus">-          if (this.numVisibleDates == 1) {</span>
<a href="#l7.4709"></a><span id="l7.4709" class="difflineminus">-              this.setDateRange(aDate, aDate);</span>
<a href="#l7.4710"></a><span id="l7.4710" class="difflineminus">-          } else {</span>
<a href="#l7.4711"></a><span id="l7.4711" class="difflineminus">-              this.setDateRange(aDate.startOfWeek, aDate.endOfWeek);</span>
<a href="#l7.4712"></a><span id="l7.4712" class="difflineminus">-          }</span>
<a href="#l7.4713"></a><span id="l7.4713" class="difflineminus">-</span>
<a href="#l7.4714"></a><span id="l7.4714" class="difflineminus">-          this.selectedDay = targetDate;</span>
<a href="#l7.4715"></a><span id="l7.4715" class="difflineplus">+            let targetDate = aDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4716"></a><span id="l7.4716" class="difflineplus">+            targetDate.isDate = true;</span>
<a href="#l7.4717"></a><span id="l7.4717" class="difflineplus">+</span>
<a href="#l7.4718"></a><span id="l7.4718" class="difflineplus">+            if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l7.4719"></a><span id="l7.4719" class="difflineplus">+                if (this.mStartDate.compare(targetDate) &lt;= 0 &amp;&amp;</span>
<a href="#l7.4720"></a><span id="l7.4720" class="difflineplus">+                    this.mEndDate.compare(targetDate) &gt;= 0) {</span>
<a href="#l7.4721"></a><span id="l7.4721" class="difflineplus">+                    return;</span>
<a href="#l7.4722"></a><span id="l7.4722" class="difflineplus">+                }</span>
<a href="#l7.4723"></a><span id="l7.4723" class="difflineplus">+            } else if (this.mDateList) {</span>
<a href="#l7.4724"></a><span id="l7.4724" class="difflineplus">+                for (let date of this.mDateList) {</span>
<a href="#l7.4725"></a><span id="l7.4725" class="difflineplus">+                    // if date is already visible, nothing to do</span>
<a href="#l7.4726"></a><span id="l7.4726" class="difflineplus">+                    if (date.compare(targetDate) == 0) {</span>
<a href="#l7.4727"></a><span id="l7.4727" class="difflineplus">+                        return;</span>
<a href="#l7.4728"></a><span id="l7.4728" class="difflineplus">+                    }</span>
<a href="#l7.4729"></a><span id="l7.4729" class="difflineplus">+                }</span>
<a href="#l7.4730"></a><span id="l7.4730" class="difflineplus">+            }</span>
<a href="#l7.4731"></a><span id="l7.4731" class="difflineplus">+</span>
<a href="#l7.4732"></a><span id="l7.4732" class="difflineplus">+            // if we're only showing one date, then continue</span>
<a href="#l7.4733"></a><span id="l7.4733" class="difflineplus">+            // to only show one date; otherwise, show the week.</span>
<a href="#l7.4734"></a><span id="l7.4734" class="difflineplus">+            if (this.numVisibleDates == 1) {</span>
<a href="#l7.4735"></a><span id="l7.4735" class="difflineplus">+                this.setDateRange(aDate, aDate);</span>
<a href="#l7.4736"></a><span id="l7.4736" class="difflineplus">+            } else {</span>
<a href="#l7.4737"></a><span id="l7.4737" class="difflineplus">+                this.setDateRange(aDate.startOfWeek, aDate.endOfWeek);</span>
<a href="#l7.4738"></a><span id="l7.4738" class="difflineplus">+            }</span>
<a href="#l7.4739"></a><span id="l7.4739" class="difflineplus">+</span>
<a href="#l7.4740"></a><span id="l7.4740" class="difflineplus">+            this.selectedDay = targetDate;</span>
<a href="#l7.4741"></a><span id="l7.4741">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4742"></a><span id="l7.4742">       &lt;/method&gt;</span>
<a href="#l7.4743"></a><span id="l7.4743"> </span>
<a href="#l7.4744"></a><span id="l7.4744">       &lt;method name=&quot;setDateRange&quot;&gt;</span>
<a href="#l7.4745"></a><span id="l7.4745">         &lt;parameter name=&quot;aStartDate&quot;/&gt;</span>
<a href="#l7.4746"></a><span id="l7.4746">         &lt;parameter name=&quot;aEndDate&quot;/&gt;</span>
<a href="#l7.4747"></a><span id="l7.4747">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4748"></a><span id="l7.4748" class="difflineminus">-          this.rangeStartDate = aStartDate;</span>
<a href="#l7.4749"></a><span id="l7.4749" class="difflineminus">-          this.rangeEndDate = aEndDate;</span>
<a href="#l7.4750"></a><span id="l7.4750" class="difflineminus">-</span>
<a href="#l7.4751"></a><span id="l7.4751" class="difflineminus">-          let viewStart = aStartDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4752"></a><span id="l7.4752" class="difflineminus">-          let viewEnd = aEndDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4753"></a><span id="l7.4753" class="difflineminus">-</span>
<a href="#l7.4754"></a><span id="l7.4754" class="difflineminus">-          viewStart.isDate = true;</span>
<a href="#l7.4755"></a><span id="l7.4755" class="difflineminus">-          viewStart.makeImmutable();</span>
<a href="#l7.4756"></a><span id="l7.4756" class="difflineminus">-          viewEnd.isDate = true;</span>
<a href="#l7.4757"></a><span id="l7.4757" class="difflineminus">-          viewEnd.makeImmutable();</span>
<a href="#l7.4758"></a><span id="l7.4758" class="difflineminus">-          this.mStartDate = viewStart;</span>
<a href="#l7.4759"></a><span id="l7.4759" class="difflineminus">-          this.mEndDate = viewEnd;</span>
<a href="#l7.4760"></a><span id="l7.4760" class="difflineminus">-</span>
<a href="#l7.4761"></a><span id="l7.4761" class="difflineminus">-          // goToDay are called when toggle the values below. The attempt to fix</span>
<a href="#l7.4762"></a><span id="l7.4762" class="difflineminus">-          // Bug 872063 has modified the behavior of setDateRange, which doesn't</span>
<a href="#l7.4763"></a><span id="l7.4763" class="difflineminus">-          // always refresh the view anymore. That is not the expected behavior</span>
<a href="#l7.4764"></a><span id="l7.4764" class="difflineminus">-          // by goToDay. Add checks here to determine if the view need to be</span>
<a href="#l7.4765"></a><span id="l7.4765" class="difflineminus">-          // refreshed.</span>
<a href="#l7.4766"></a><span id="l7.4766" class="difflineminus">-</span>
<a href="#l7.4767"></a><span id="l7.4767" class="difflineminus">-          // First, check values of tasksInView, workdaysOnly, showCompleted.</span>
<a href="#l7.4768"></a><span id="l7.4768" class="difflineminus">-          // Their status will determine the value of toggleStatus, which is</span>
<a href="#l7.4769"></a><span id="l7.4769" class="difflineminus">-          // saved to this.mToggleStatus during last call to relayout()</span>
<a href="#l7.4770"></a><span id="l7.4770" class="difflineminus">-          let toggleStatus = 0;</span>
<a href="#l7.4771"></a><span id="l7.4771" class="difflineminus">-</span>
<a href="#l7.4772"></a><span id="l7.4772" class="difflineminus">-          if (this.mTasksInView) {</span>
<a href="#l7.4773"></a><span id="l7.4773" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l7.4774"></a><span id="l7.4774" class="difflineminus">-          }</span>
<a href="#l7.4775"></a><span id="l7.4775" class="difflineminus">-          if (this.mWorkdaysOnly) {</span>
<a href="#l7.4776"></a><span id="l7.4776" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l7.4777"></a><span id="l7.4777" class="difflineminus">-          }</span>
<a href="#l7.4778"></a><span id="l7.4778" class="difflineminus">-          if (this.mShowCompleted) {</span>
<a href="#l7.4779"></a><span id="l7.4779" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l7.4780"></a><span id="l7.4780" class="difflineminus">-          }</span>
<a href="#l7.4781"></a><span id="l7.4781" class="difflineminus">-</span>
<a href="#l7.4782"></a><span id="l7.4782" class="difflineminus">-          // Update the navigation bar only when changes are related to the current view.</span>
<a href="#l7.4783"></a><span id="l7.4783" class="difflineminus">-          if (this.isVisible()) {</span>
<a href="#l7.4784"></a><span id="l7.4784" class="difflineminus">-              cal.navigationBar.setDateRange(viewStart, viewEnd);</span>
<a href="#l7.4785"></a><span id="l7.4785" class="difflineminus">-          }</span>
<a href="#l7.4786"></a><span id="l7.4786" class="difflineminus">-</span>
<a href="#l7.4787"></a><span id="l7.4787" class="difflineminus">-          // Check whether view range has been changed since last call to</span>
<a href="#l7.4788"></a><span id="l7.4788" class="difflineminus">-          // relayout()</span>
<a href="#l7.4789"></a><span id="l7.4789" class="difflineminus">-          if (!this.mViewStart || !this.mViewEnd ||</span>
<a href="#l7.4790"></a><span id="l7.4790" class="difflineminus">-              this.mViewEnd.compare(viewEnd) != 0 ||</span>
<a href="#l7.4791"></a><span id="l7.4791" class="difflineminus">-              this.mViewStart.compare(viewStart) != 0 ||</span>
<a href="#l7.4792"></a><span id="l7.4792" class="difflineminus">-              this.mToggleStatus != toggleStatus) {</span>
<a href="#l7.4793"></a><span id="l7.4793" class="difflineminus">-              this.refresh();</span>
<a href="#l7.4794"></a><span id="l7.4794" class="difflineminus">-          }</span>
<a href="#l7.4795"></a><span id="l7.4795" class="difflineplus">+            this.rangeStartDate = aStartDate;</span>
<a href="#l7.4796"></a><span id="l7.4796" class="difflineplus">+            this.rangeEndDate = aEndDate;</span>
<a href="#l7.4797"></a><span id="l7.4797" class="difflineplus">+</span>
<a href="#l7.4798"></a><span id="l7.4798" class="difflineplus">+            let viewStart = aStartDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4799"></a><span id="l7.4799" class="difflineplus">+            let viewEnd = aEndDate.getInTimezone(this.mTimezone);</span>
<a href="#l7.4800"></a><span id="l7.4800" class="difflineplus">+</span>
<a href="#l7.4801"></a><span id="l7.4801" class="difflineplus">+            viewStart.isDate = true;</span>
<a href="#l7.4802"></a><span id="l7.4802" class="difflineplus">+            viewStart.makeImmutable();</span>
<a href="#l7.4803"></a><span id="l7.4803" class="difflineplus">+            viewEnd.isDate = true;</span>
<a href="#l7.4804"></a><span id="l7.4804" class="difflineplus">+            viewEnd.makeImmutable();</span>
<a href="#l7.4805"></a><span id="l7.4805" class="difflineplus">+            this.mStartDate = viewStart;</span>
<a href="#l7.4806"></a><span id="l7.4806" class="difflineplus">+            this.mEndDate = viewEnd;</span>
<a href="#l7.4807"></a><span id="l7.4807" class="difflineplus">+</span>
<a href="#l7.4808"></a><span id="l7.4808" class="difflineplus">+            // goToDay are called when toggle the values below. The attempt to fix</span>
<a href="#l7.4809"></a><span id="l7.4809" class="difflineplus">+            // Bug 872063 has modified the behavior of setDateRange, which doesn't</span>
<a href="#l7.4810"></a><span id="l7.4810" class="difflineplus">+            // always refresh the view anymore. That is not the expected behavior</span>
<a href="#l7.4811"></a><span id="l7.4811" class="difflineplus">+            // by goToDay. Add checks here to determine if the view need to be</span>
<a href="#l7.4812"></a><span id="l7.4812" class="difflineplus">+            // refreshed.</span>
<a href="#l7.4813"></a><span id="l7.4813" class="difflineplus">+</span>
<a href="#l7.4814"></a><span id="l7.4814" class="difflineplus">+            // First, check values of tasksInView, workdaysOnly, showCompleted.</span>
<a href="#l7.4815"></a><span id="l7.4815" class="difflineplus">+            // Their status will determine the value of toggleStatus, which is</span>
<a href="#l7.4816"></a><span id="l7.4816" class="difflineplus">+            // saved to this.mToggleStatus during last call to relayout()</span>
<a href="#l7.4817"></a><span id="l7.4817" class="difflineplus">+            let toggleStatus = 0;</span>
<a href="#l7.4818"></a><span id="l7.4818" class="difflineplus">+</span>
<a href="#l7.4819"></a><span id="l7.4819" class="difflineplus">+            if (this.mTasksInView) {</span>
<a href="#l7.4820"></a><span id="l7.4820" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l7.4821"></a><span id="l7.4821" class="difflineplus">+            }</span>
<a href="#l7.4822"></a><span id="l7.4822" class="difflineplus">+            if (this.mWorkdaysOnly) {</span>
<a href="#l7.4823"></a><span id="l7.4823" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l7.4824"></a><span id="l7.4824" class="difflineplus">+            }</span>
<a href="#l7.4825"></a><span id="l7.4825" class="difflineplus">+            if (this.mShowCompleted) {</span>
<a href="#l7.4826"></a><span id="l7.4826" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l7.4827"></a><span id="l7.4827" class="difflineplus">+            }</span>
<a href="#l7.4828"></a><span id="l7.4828" class="difflineplus">+</span>
<a href="#l7.4829"></a><span id="l7.4829" class="difflineplus">+            // Update the navigation bar only when changes are related to the current view.</span>
<a href="#l7.4830"></a><span id="l7.4830" class="difflineplus">+            if (this.isVisible()) {</span>
<a href="#l7.4831"></a><span id="l7.4831" class="difflineplus">+                cal.navigationBar.setDateRange(viewStart, viewEnd);</span>
<a href="#l7.4832"></a><span id="l7.4832" class="difflineplus">+            }</span>
<a href="#l7.4833"></a><span id="l7.4833" class="difflineplus">+</span>
<a href="#l7.4834"></a><span id="l7.4834" class="difflineplus">+            // Check whether view range has been changed since last call to</span>
<a href="#l7.4835"></a><span id="l7.4835" class="difflineplus">+            // relayout()</span>
<a href="#l7.4836"></a><span id="l7.4836" class="difflineplus">+            if (!this.mViewStart || !this.mViewEnd ||</span>
<a href="#l7.4837"></a><span id="l7.4837" class="difflineplus">+                this.mViewEnd.compare(viewEnd) != 0 ||</span>
<a href="#l7.4838"></a><span id="l7.4838" class="difflineplus">+                this.mViewStart.compare(viewStart) != 0 ||</span>
<a href="#l7.4839"></a><span id="l7.4839" class="difflineplus">+                this.mToggleStatus != toggleStatus) {</span>
<a href="#l7.4840"></a><span id="l7.4840" class="difflineplus">+                this.refresh();</span>
<a href="#l7.4841"></a><span id="l7.4841" class="difflineplus">+            }</span>
<a href="#l7.4842"></a><span id="l7.4842">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4843"></a><span id="l7.4843">       &lt;/method&gt;</span>
<a href="#l7.4844"></a><span id="l7.4844"> </span>
<a href="#l7.4845"></a><span id="l7.4845">       &lt;method name=&quot;getDateList&quot;&gt;</span>
<a href="#l7.4846"></a><span id="l7.4846">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l7.4847"></a><span id="l7.4847">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4848"></a><span id="l7.4848" class="difflineminus">-          let dates = [];</span>
<a href="#l7.4849"></a><span id="l7.4849" class="difflineminus">-          if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l7.4850"></a><span id="l7.4850" class="difflineminus">-              let date = this.mStartDate.clone();</span>
<a href="#l7.4851"></a><span id="l7.4851" class="difflineminus">-              while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.4852"></a><span id="l7.4852" class="difflineminus">-                  dates.push(d.clone());</span>
<a href="#l7.4853"></a><span id="l7.4853" class="difflineminus">-                  date.day += 1;</span>
<a href="#l7.4854"></a><span id="l7.4854" class="difflineminus">-              }</span>
<a href="#l7.4855"></a><span id="l7.4855" class="difflineminus">-          } else if (this.mDateList) {</span>
<a href="#l7.4856"></a><span id="l7.4856" class="difflineminus">-              for (let date of this.mDateList) {</span>
<a href="#l7.4857"></a><span id="l7.4857" class="difflineminus">-                  dates.push(date.clone());</span>
<a href="#l7.4858"></a><span id="l7.4858" class="difflineminus">-              }</span>
<a href="#l7.4859"></a><span id="l7.4859" class="difflineminus">-          }</span>
<a href="#l7.4860"></a><span id="l7.4860" class="difflineminus">-</span>
<a href="#l7.4861"></a><span id="l7.4861" class="difflineminus">-          aCount.value = dates.length;</span>
<a href="#l7.4862"></a><span id="l7.4862" class="difflineminus">-          return dates;</span>
<a href="#l7.4863"></a><span id="l7.4863" class="difflineplus">+            let dates = [];</span>
<a href="#l7.4864"></a><span id="l7.4864" class="difflineplus">+            if (this.mStartDate &amp;&amp; this.mEndDate) {</span>
<a href="#l7.4865"></a><span id="l7.4865" class="difflineplus">+                let date = this.mStartDate.clone();</span>
<a href="#l7.4866"></a><span id="l7.4866" class="difflineplus">+                while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.4867"></a><span id="l7.4867" class="difflineplus">+                    dates.push(d.clone());</span>
<a href="#l7.4868"></a><span id="l7.4868" class="difflineplus">+                    date.day += 1;</span>
<a href="#l7.4869"></a><span id="l7.4869" class="difflineplus">+                }</span>
<a href="#l7.4870"></a><span id="l7.4870" class="difflineplus">+            } else if (this.mDateList) {</span>
<a href="#l7.4871"></a><span id="l7.4871" class="difflineplus">+                for (let date of this.mDateList) {</span>
<a href="#l7.4872"></a><span id="l7.4872" class="difflineplus">+                    dates.push(date.clone());</span>
<a href="#l7.4873"></a><span id="l7.4873" class="difflineplus">+                }</span>
<a href="#l7.4874"></a><span id="l7.4874" class="difflineplus">+            }</span>
<a href="#l7.4875"></a><span id="l7.4875" class="difflineplus">+</span>
<a href="#l7.4876"></a><span id="l7.4876" class="difflineplus">+            aCount.value = dates.length;</span>
<a href="#l7.4877"></a><span id="l7.4877" class="difflineplus">+            return dates;</span>
<a href="#l7.4878"></a><span id="l7.4878">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4879"></a><span id="l7.4879">       &lt;/method&gt;</span>
<a href="#l7.4880"></a><span id="l7.4880"> </span>
<a href="#l7.4881"></a><span id="l7.4881">       &lt;property name=&quot;selectedDateTime&quot;&gt;</span>
<a href="#l7.4882"></a><span id="l7.4882">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4883"></a><span id="l7.4883" class="difflineminus">-          return this.mClickedTime;</span>
<a href="#l7.4884"></a><span id="l7.4884" class="difflineplus">+            return this.mClickedTime;</span>
<a href="#l7.4885"></a><span id="l7.4885">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4886"></a><span id="l7.4886">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.4887"></a><span id="l7.4887" class="difflineminus">-          this.mClickedTime = val;</span>
<a href="#l7.4888"></a><span id="l7.4888" class="difflineplus">+            this.mClickedTime = val;</span>
<a href="#l7.4889"></a><span id="l7.4889">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.4890"></a><span id="l7.4890">       &lt;/property&gt;</span>
<a href="#l7.4891"></a><span id="l7.4891"> </span>
<a href="#l7.4892"></a><span id="l7.4892">       &lt;property name=&quot;selectedDay&quot;&gt;</span>
<a href="#l7.4893"></a><span id="l7.4893">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.4894"></a><span id="l7.4894" class="difflineminus">-          let selected;</span>
<a href="#l7.4895"></a><span id="l7.4895" class="difflineminus">-          if (this.numVisibleDates == 1) {</span>
<a href="#l7.4896"></a><span id="l7.4896" class="difflineminus">-              selected = this.mDateColumns[0].date;</span>
<a href="#l7.4897"></a><span id="l7.4897" class="difflineminus">-          } else if (this.mSelectedDay) {</span>
<a href="#l7.4898"></a><span id="l7.4898" class="difflineminus">-              selected = this.mSelectedDay;</span>
<a href="#l7.4899"></a><span id="l7.4899" class="difflineminus">-          } else if (this.mSelectedDayCol) {</span>
<a href="#l7.4900"></a><span id="l7.4900" class="difflineminus">-              selected = this.mSelectedDayCol.date;</span>
<a href="#l7.4901"></a><span id="l7.4901" class="difflineminus">-          }</span>
<a href="#l7.4902"></a><span id="l7.4902" class="difflineminus">-</span>
<a href="#l7.4903"></a><span id="l7.4903" class="difflineminus">-          // TODO Make sure the selected day is valid</span>
<a href="#l7.4904"></a><span id="l7.4904" class="difflineminus">-          // TODO select now if it is in the range?</span>
<a href="#l7.4905"></a><span id="l7.4905" class="difflineminus">-          return selected;</span>
<a href="#l7.4906"></a><span id="l7.4906" class="difflineplus">+            let selected;</span>
<a href="#l7.4907"></a><span id="l7.4907" class="difflineplus">+            if (this.numVisibleDates == 1) {</span>
<a href="#l7.4908"></a><span id="l7.4908" class="difflineplus">+                selected = this.mDateColumns[0].date;</span>
<a href="#l7.4909"></a><span id="l7.4909" class="difflineplus">+            } else if (this.mSelectedDay) {</span>
<a href="#l7.4910"></a><span id="l7.4910" class="difflineplus">+                selected = this.mSelectedDay;</span>
<a href="#l7.4911"></a><span id="l7.4911" class="difflineplus">+            } else if (this.mSelectedDayCol) {</span>
<a href="#l7.4912"></a><span id="l7.4912" class="difflineplus">+                selected = this.mSelectedDayCol.date;</span>
<a href="#l7.4913"></a><span id="l7.4913" class="difflineplus">+            }</span>
<a href="#l7.4914"></a><span id="l7.4914" class="difflineplus">+</span>
<a href="#l7.4915"></a><span id="l7.4915" class="difflineplus">+            // TODO Make sure the selected day is valid</span>
<a href="#l7.4916"></a><span id="l7.4916" class="difflineplus">+            // TODO select now if it is in the range?</span>
<a href="#l7.4917"></a><span id="l7.4917" class="difflineplus">+            return selected;</span>
<a href="#l7.4918"></a><span id="l7.4918">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.4919"></a><span id="l7.4919">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.4920"></a><span id="l7.4920" class="difflineminus">-          // ignore if just 1 visible, it's always selected,</span>
<a href="#l7.4921"></a><span id="l7.4921" class="difflineminus">-          // but we don't indicate it</span>
<a href="#l7.4922"></a><span id="l7.4922" class="difflineminus">-          if (this.numVisibleDates == 1) {</span>
<a href="#l7.4923"></a><span id="l7.4923" class="difflineminus">-              this.fireEvent(&quot;dayselect&quot;, val);</span>
<a href="#l7.4924"></a><span id="l7.4924" class="difflineminus">-              return val;</span>
<a href="#l7.4925"></a><span id="l7.4925" class="difflineminus">-          }</span>
<a href="#l7.4926"></a><span id="l7.4926" class="difflineminus">-</span>
<a href="#l7.4927"></a><span id="l7.4927" class="difflineminus">-          if (this.mSelectedDayCol) {</span>
<a href="#l7.4928"></a><span id="l7.4928" class="difflineminus">-              this.mSelectedDayCol.column.selected = false;</span>
<a href="#l7.4929"></a><span id="l7.4929" class="difflineminus">-              this.mSelectedDayCol.header.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.4930"></a><span id="l7.4930" class="difflineminus">-          }</span>
<a href="#l7.4931"></a><span id="l7.4931" class="difflineminus">-</span>
<a href="#l7.4932"></a><span id="l7.4932" class="difflineminus">-          if (val) {</span>
<a href="#l7.4933"></a><span id="l7.4933" class="difflineminus">-              this.mSelectedDayCol = this.findColumnForDate(val);</span>
<a href="#l7.4934"></a><span id="l7.4934" class="difflineminus">-              if (this.mSelectedDayCol) {</span>
<a href="#l7.4935"></a><span id="l7.4935" class="difflineminus">-                  this.mSelectedDay = this.mSelectedDayCol.date;</span>
<a href="#l7.4936"></a><span id="l7.4936" class="difflineminus">-                  this.mSelectedDayCol.column.selected = true;</span>
<a href="#l7.4937"></a><span id="l7.4937" class="difflineminus">-                  this.mSelectedDayCol.header.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.4938"></a><span id="l7.4938" class="difflineminus">-              } else {</span>
<a href="#l7.4939"></a><span id="l7.4939" class="difflineminus">-                  this.mSelectedDay = val;</span>
<a href="#l7.4940"></a><span id="l7.4940" class="difflineminus">-              }</span>
<a href="#l7.4941"></a><span id="l7.4941" class="difflineminus">-          }</span>
<a href="#l7.4942"></a><span id="l7.4942" class="difflineminus">-          this.fireEvent(&quot;dayselect&quot;, val);</span>
<a href="#l7.4943"></a><span id="l7.4943" class="difflineminus">-          return val;</span>
<a href="#l7.4944"></a><span id="l7.4944" class="difflineplus">+            // ignore if just 1 visible, it's always selected,</span>
<a href="#l7.4945"></a><span id="l7.4945" class="difflineplus">+            // but we don't indicate it</span>
<a href="#l7.4946"></a><span id="l7.4946" class="difflineplus">+            if (this.numVisibleDates == 1) {</span>
<a href="#l7.4947"></a><span id="l7.4947" class="difflineplus">+                this.fireEvent(&quot;dayselect&quot;, val);</span>
<a href="#l7.4948"></a><span id="l7.4948" class="difflineplus">+                return val;</span>
<a href="#l7.4949"></a><span id="l7.4949" class="difflineplus">+            }</span>
<a href="#l7.4950"></a><span id="l7.4950" class="difflineplus">+</span>
<a href="#l7.4951"></a><span id="l7.4951" class="difflineplus">+            if (this.mSelectedDayCol) {</span>
<a href="#l7.4952"></a><span id="l7.4952" class="difflineplus">+                this.mSelectedDayCol.column.selected = false;</span>
<a href="#l7.4953"></a><span id="l7.4953" class="difflineplus">+                this.mSelectedDayCol.header.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.4954"></a><span id="l7.4954" class="difflineplus">+            }</span>
<a href="#l7.4955"></a><span id="l7.4955" class="difflineplus">+</span>
<a href="#l7.4956"></a><span id="l7.4956" class="difflineplus">+            if (val) {</span>
<a href="#l7.4957"></a><span id="l7.4957" class="difflineplus">+                this.mSelectedDayCol = this.findColumnForDate(val);</span>
<a href="#l7.4958"></a><span id="l7.4958" class="difflineplus">+                if (this.mSelectedDayCol) {</span>
<a href="#l7.4959"></a><span id="l7.4959" class="difflineplus">+                    this.mSelectedDay = this.mSelectedDayCol.date;</span>
<a href="#l7.4960"></a><span id="l7.4960" class="difflineplus">+                    this.mSelectedDayCol.column.selected = true;</span>
<a href="#l7.4961"></a><span id="l7.4961" class="difflineplus">+                    this.mSelectedDayCol.header.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.4962"></a><span id="l7.4962" class="difflineplus">+                } else {</span>
<a href="#l7.4963"></a><span id="l7.4963" class="difflineplus">+                    this.mSelectedDay = val;</span>
<a href="#l7.4964"></a><span id="l7.4964" class="difflineplus">+                }</span>
<a href="#l7.4965"></a><span id="l7.4965" class="difflineplus">+            }</span>
<a href="#l7.4966"></a><span id="l7.4966" class="difflineplus">+            this.fireEvent(&quot;dayselect&quot;, val);</span>
<a href="#l7.4967"></a><span id="l7.4967" class="difflineplus">+            return val;</span>
<a href="#l7.4968"></a><span id="l7.4968">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.4969"></a><span id="l7.4969">       &lt;/property&gt;</span>
<a href="#l7.4970"></a><span id="l7.4970"> </span>
<a href="#l7.4971"></a><span id="l7.4971">       &lt;method name=&quot;getSelectedItems&quot;&gt;</span>
<a href="#l7.4972"></a><span id="l7.4972">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l7.4973"></a><span id="l7.4973">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4974"></a><span id="l7.4974" class="difflineminus">-          aCount.value = this.mSelectedItems.length;</span>
<a href="#l7.4975"></a><span id="l7.4975" class="difflineminus">-          return this.mSelectedItems;</span>
<a href="#l7.4976"></a><span id="l7.4976" class="difflineplus">+            aCount.value = this.mSelectedItems.length;</span>
<a href="#l7.4977"></a><span id="l7.4977" class="difflineplus">+            return this.mSelectedItems;</span>
<a href="#l7.4978"></a><span id="l7.4978">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.4979"></a><span id="l7.4979">       &lt;/method&gt;</span>
<a href="#l7.4980"></a><span id="l7.4980">       &lt;method name=&quot;setSelectedItems&quot;&gt;</span>
<a href="#l7.4981"></a><span id="l7.4981">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l7.4982"></a><span id="l7.4982">         &lt;parameter name=&quot;aItems&quot;/&gt;</span>
<a href="#l7.4983"></a><span id="l7.4983">         &lt;parameter name=&quot;aSuppressEvent&quot;/&gt;</span>
<a href="#l7.4984"></a><span id="l7.4984">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.4985"></a><span id="l7.4985" class="difflineminus">-          if (this.mSelectedItems) {</span>
<a href="#l7.4986"></a><span id="l7.4986" class="difflineminus">-              for (let item of this.mSelectedItems) {</span>
<a href="#l7.4987"></a><span id="l7.4987" class="difflineminus">-                  for (let occ of this.getItemOccurrencesInView(item)) {</span>
<a href="#l7.4988"></a><span id="l7.4988" class="difflineminus">-                      let cols = this.findColumnsForItem(occ);</span>
<a href="#l7.4989"></a><span id="l7.4989" class="difflineminus">-                      for (let col of cols) {</span>
<a href="#l7.4990"></a><span id="l7.4990" class="difflineminus">-                          col.header.unselectOccurrence(occ);</span>
<a href="#l7.4991"></a><span id="l7.4991" class="difflineminus">-                          col.column.unselectOccurrence(occ);</span>
<a href="#l7.4992"></a><span id="l7.4992" class="difflineminus">-                      }</span>
<a href="#l7.4993"></a><span id="l7.4993" class="difflineminus">-                  }</span>
<a href="#l7.4994"></a><span id="l7.4994" class="difflineminus">-              }</span>
<a href="#l7.4995"></a><span id="l7.4995" class="difflineminus">-          }</span>
<a href="#l7.4996"></a><span id="l7.4996" class="difflineminus">-          this.mSelectedItems = aItems || [];</span>
<a href="#l7.4997"></a><span id="l7.4997" class="difflineminus">-</span>
<a href="#l7.4998"></a><span id="l7.4998" class="difflineminus">-          for (let item of this.mSelectedItems) {</span>
<a href="#l7.4999"></a><span id="l7.4999" class="difflineminus">-              for (let occ of this.getItemOccurrencesInView(item)) {</span>
<a href="#l7.5000"></a><span id="l7.5000" class="difflineminus">-                  let cols = this.findColumnsForItem(occ);</span>
<a href="#l7.5001"></a><span id="l7.5001" class="difflineminus">-                  if (cols.length &gt; 0) {</span>
<a href="#l7.5002"></a><span id="l7.5002" class="difflineminus">-                      let start = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l7.5003"></a><span id="l7.5003" class="difflineminus">-                      for (let col of cols) {</span>
<a href="#l7.5004"></a><span id="l7.5004" class="difflineminus">-                          if (start.isDate) {</span>
<a href="#l7.5005"></a><span id="l7.5005" class="difflineminus">-                              col.header.selectOccurrence(occ);</span>
<a href="#l7.5006"></a><span id="l7.5006" class="difflineminus">-                          } else {</span>
<a href="#l7.5007"></a><span id="l7.5007" class="difflineminus">-                              col.column.selectOccurrence(occ);</span>
<a href="#l7.5008"></a><span id="l7.5008" class="difflineminus">-                          }</span>
<a href="#l7.5009"></a><span id="l7.5009" class="difflineminus">-                      }</span>
<a href="#l7.5010"></a><span id="l7.5010" class="difflineminus">-                  }</span>
<a href="#l7.5011"></a><span id="l7.5011" class="difflineminus">-              }</span>
<a href="#l7.5012"></a><span id="l7.5012" class="difflineminus">-          }</span>
<a href="#l7.5013"></a><span id="l7.5013" class="difflineminus">-</span>
<a href="#l7.5014"></a><span id="l7.5014" class="difflineminus">-          if (!aSuppressEvent) {</span>
<a href="#l7.5015"></a><span id="l7.5015" class="difflineminus">-              this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l7.5016"></a><span id="l7.5016" class="difflineminus">-          }</span>
<a href="#l7.5017"></a><span id="l7.5017" class="difflineplus">+            if (this.mSelectedItems) {</span>
<a href="#l7.5018"></a><span id="l7.5018" class="difflineplus">+                for (let item of this.mSelectedItems) {</span>
<a href="#l7.5019"></a><span id="l7.5019" class="difflineplus">+                    for (let occ of this.getItemOccurrencesInView(item)) {</span>
<a href="#l7.5020"></a><span id="l7.5020" class="difflineplus">+                        let cols = this.findColumnsForItem(occ);</span>
<a href="#l7.5021"></a><span id="l7.5021" class="difflineplus">+                        for (let col of cols) {</span>
<a href="#l7.5022"></a><span id="l7.5022" class="difflineplus">+                            col.header.unselectOccurrence(occ);</span>
<a href="#l7.5023"></a><span id="l7.5023" class="difflineplus">+                            col.column.unselectOccurrence(occ);</span>
<a href="#l7.5024"></a><span id="l7.5024" class="difflineplus">+                        }</span>
<a href="#l7.5025"></a><span id="l7.5025" class="difflineplus">+                    }</span>
<a href="#l7.5026"></a><span id="l7.5026" class="difflineplus">+                }</span>
<a href="#l7.5027"></a><span id="l7.5027" class="difflineplus">+            }</span>
<a href="#l7.5028"></a><span id="l7.5028" class="difflineplus">+            this.mSelectedItems = aItems || [];</span>
<a href="#l7.5029"></a><span id="l7.5029" class="difflineplus">+</span>
<a href="#l7.5030"></a><span id="l7.5030" class="difflineplus">+            for (let item of this.mSelectedItems) {</span>
<a href="#l7.5031"></a><span id="l7.5031" class="difflineplus">+                for (let occ of this.getItemOccurrencesInView(item)) {</span>
<a href="#l7.5032"></a><span id="l7.5032" class="difflineplus">+                    let cols = this.findColumnsForItem(occ);</span>
<a href="#l7.5033"></a><span id="l7.5033" class="difflineplus">+                    if (cols.length &gt; 0) {</span>
<a href="#l7.5034"></a><span id="l7.5034" class="difflineplus">+                        let start = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l7.5035"></a><span id="l7.5035" class="difflineplus">+                        for (let col of cols) {</span>
<a href="#l7.5036"></a><span id="l7.5036" class="difflineplus">+                            if (start.isDate) {</span>
<a href="#l7.5037"></a><span id="l7.5037" class="difflineplus">+                                col.header.selectOccurrence(occ);</span>
<a href="#l7.5038"></a><span id="l7.5038" class="difflineplus">+                            } else {</span>
<a href="#l7.5039"></a><span id="l7.5039" class="difflineplus">+                                col.column.selectOccurrence(occ);</span>
<a href="#l7.5040"></a><span id="l7.5040" class="difflineplus">+                            }</span>
<a href="#l7.5041"></a><span id="l7.5041" class="difflineplus">+                        }</span>
<a href="#l7.5042"></a><span id="l7.5042" class="difflineplus">+                    }</span>
<a href="#l7.5043"></a><span id="l7.5043" class="difflineplus">+                }</span>
<a href="#l7.5044"></a><span id="l7.5044" class="difflineplus">+            }</span>
<a href="#l7.5045"></a><span id="l7.5045" class="difflineplus">+</span>
<a href="#l7.5046"></a><span id="l7.5046" class="difflineplus">+            if (!aSuppressEvent) {</span>
<a href="#l7.5047"></a><span id="l7.5047" class="difflineplus">+                this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l7.5048"></a><span id="l7.5048" class="difflineplus">+            }</span>
<a href="#l7.5049"></a><span id="l7.5049">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5050"></a><span id="l7.5050">       &lt;/method&gt;</span>
<a href="#l7.5051"></a><span id="l7.5051"> </span>
<a href="#l7.5052"></a><span id="l7.5052">       &lt;method name=&quot;getItemOccurrencesInView&quot;&gt;</span>
<a href="#l7.5053"></a><span id="l7.5053">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.5054"></a><span id="l7.5054">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5055"></a><span id="l7.5055" class="difflineminus">-          if (aItem.recurrenceInfo &amp;&amp; aItem.recurrenceStartDate) {</span>
<a href="#l7.5056"></a><span id="l7.5056" class="difflineminus">-              // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l7.5057"></a><span id="l7.5057" class="difflineminus">-              return aItem.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l7.5058"></a><span id="l7.5058" class="difflineminus">-          } else if (aItem.recurrenceStartDate) {</span>
<a href="#l7.5059"></a><span id="l7.5059" class="difflineminus">-              return [aItem];</span>
<a href="#l7.5060"></a><span id="l7.5060" class="difflineminus">-          } else { // undated todo</span>
<a href="#l7.5061"></a><span id="l7.5061" class="difflineminus">-              return [];</span>
<a href="#l7.5062"></a><span id="l7.5062" class="difflineminus">-          }</span>
<a href="#l7.5063"></a><span id="l7.5063" class="difflineplus">+            if (aItem.recurrenceInfo &amp;&amp; aItem.recurrenceStartDate) {</span>
<a href="#l7.5064"></a><span id="l7.5064" class="difflineplus">+                // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l7.5065"></a><span id="l7.5065" class="difflineplus">+                return aItem.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l7.5066"></a><span id="l7.5066" class="difflineplus">+            } else if (aItem.recurrenceStartDate) {</span>
<a href="#l7.5067"></a><span id="l7.5067" class="difflineplus">+                return [aItem];</span>
<a href="#l7.5068"></a><span id="l7.5068" class="difflineplus">+            } else { // undated todo</span>
<a href="#l7.5069"></a><span id="l7.5069" class="difflineplus">+                return [];</span>
<a href="#l7.5070"></a><span id="l7.5070" class="difflineplus">+            }</span>
<a href="#l7.5071"></a><span id="l7.5071">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5072"></a><span id="l7.5072">       &lt;/method&gt;</span>
<a href="#l7.5073"></a><span id="l7.5073"> </span>
<a href="#l7.5074"></a><span id="l7.5074">       &lt;method name=&quot;centerSelectedItems&quot;&gt;</span>
<a href="#l7.5075"></a><span id="l7.5075">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5076"></a><span id="l7.5076" class="difflineminus">-          let displayTZ = cal.calendarDefaultTimezone();</span>
<a href="#l7.5077"></a><span id="l7.5077" class="difflineminus">-          let lowMinute = 24 * 60;</span>
<a href="#l7.5078"></a><span id="l7.5078" class="difflineminus">-          let highMinute = 0;</span>
<a href="#l7.5079"></a><span id="l7.5079" class="difflineminus">-</span>
<a href="#l7.5080"></a><span id="l7.5080" class="difflineminus">-          for (let item of this.mSelectedItems) {</span>
<a href="#l7.5081"></a><span id="l7.5081" class="difflineminus">-              let startDateProperty = cal.calGetStartDateProp(item);</span>
<a href="#l7.5082"></a><span id="l7.5082" class="difflineminus">-              let endDateProperty = cal.calGetEndDateProp(item);</span>
<a href="#l7.5083"></a><span id="l7.5083" class="difflineminus">-</span>
<a href="#l7.5084"></a><span id="l7.5084" class="difflineminus">-              let occs = [];</span>
<a href="#l7.5085"></a><span id="l7.5085" class="difflineminus">-              if (item.recurrenceInfo) {</span>
<a href="#l7.5086"></a><span id="l7.5086" class="difflineminus">-                  // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l7.5087"></a><span id="l7.5087" class="difflineminus">-                  occs = item.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l7.5088"></a><span id="l7.5088" class="difflineminus">-              } else {</span>
<a href="#l7.5089"></a><span id="l7.5089" class="difflineminus">-                  occs = [item];</span>
<a href="#l7.5090"></a><span id="l7.5090" class="difflineminus">-              }</span>
<a href="#l7.5091"></a><span id="l7.5091" class="difflineminus">-</span>
<a href="#l7.5092"></a><span id="l7.5092" class="difflineminus">-              for (let occ of occs) {</span>
<a href="#l7.5093"></a><span id="l7.5093" class="difflineminus">-                  let occStart = occ[startDateProperty];</span>
<a href="#l7.5094"></a><span id="l7.5094" class="difflineminus">-                  let occEnd = occ[endDateProperty];</span>
<a href="#l7.5095"></a><span id="l7.5095" class="difflineminus">-                  // must have at least one of start or end</span>
<a href="#l7.5096"></a><span id="l7.5096" class="difflineminus">-                  if (!occStart &amp;&amp; !occEnd) {</span>
<a href="#l7.5097"></a><span id="l7.5097" class="difflineminus">-                      continue; // task with no dates</span>
<a href="#l7.5098"></a><span id="l7.5098" class="difflineminus">-                  }</span>
<a href="#l7.5099"></a><span id="l7.5099" class="difflineminus">-</span>
<a href="#l7.5100"></a><span id="l7.5100" class="difflineminus">-                  // if just has single datetime, treat as zero duration item</span>
<a href="#l7.5101"></a><span id="l7.5101" class="difflineminus">-                  // (such as task with due datetime or start datetime only)</span>
<a href="#l7.5102"></a><span id="l7.5102" class="difflineminus">-                  occStart = occStart || occEnd;</span>
<a href="#l7.5103"></a><span id="l7.5103" class="difflineminus">-                  occEnd = occEnd || occStart;</span>
<a href="#l7.5104"></a><span id="l7.5104" class="difflineminus">-                  // Now both occStart and occEnd are datetimes.</span>
<a href="#l7.5105"></a><span id="l7.5105" class="difflineminus">-</span>
<a href="#l7.5106"></a><span id="l7.5106" class="difflineminus">-                  // skip occurrence if all-day: it won't show in time view.</span>
<a href="#l7.5107"></a><span id="l7.5107" class="difflineminus">-                  if (occStart.isDate || occEnd.isDate) {</span>
<a href="#l7.5108"></a><span id="l7.5108" class="difflineminus">-                      continue;</span>
<a href="#l7.5109"></a><span id="l7.5109" class="difflineminus">-                  }</span>
<a href="#l7.5110"></a><span id="l7.5110" class="difflineminus">-</span>
<a href="#l7.5111"></a><span id="l7.5111" class="difflineminus">-                  // Trim dates to view.  (Not mutated so just reuse view dates)</span>
<a href="#l7.5112"></a><span id="l7.5112" class="difflineminus">-                  if (this.startDate.compare(occStart) &gt; 0) {</span>
<a href="#l7.5113"></a><span id="l7.5113" class="difflineminus">-                      occStart = this.startDate;</span>
<a href="#l7.5114"></a><span id="l7.5114" class="difflineminus">-                  }</span>
<a href="#l7.5115"></a><span id="l7.5115" class="difflineminus">-                  if (this.queryEndDate.compare(occEnd) &lt; 0) {</span>
<a href="#l7.5116"></a><span id="l7.5116" class="difflineminus">-                      occEnd = this.queryEndDate;</span>
<a href="#l7.5117"></a><span id="l7.5117" class="difflineminus">-                  }</span>
<a href="#l7.5118"></a><span id="l7.5118" class="difflineminus">-</span>
<a href="#l7.5119"></a><span id="l7.5119" class="difflineminus">-                  // Convert to display timezone if different</span>
<a href="#l7.5120"></a><span id="l7.5120" class="difflineminus">-                  if (occStart.timezone != displayTZ) {</span>
<a href="#l7.5121"></a><span id="l7.5121" class="difflineminus">-                      occStart = occStart.getInTimezone(displayTZ);</span>
<a href="#l7.5122"></a><span id="l7.5122" class="difflineminus">-                  }</span>
<a href="#l7.5123"></a><span id="l7.5123" class="difflineminus">-                  if (occEnd.timezone != displayTZ) {</span>
<a href="#l7.5124"></a><span id="l7.5124" class="difflineminus">-                      occEnd = occEnd.getInTimezone(displayTZ);</span>
<a href="#l7.5125"></a><span id="l7.5125" class="difflineminus">-                  }</span>
<a href="#l7.5126"></a><span id="l7.5126" class="difflineminus">-                  // If crosses midnite in current TZ, set end just</span>
<a href="#l7.5127"></a><span id="l7.5127" class="difflineminus">-                  // before midnite after start so start/title usually visible.</span>
<a href="#l7.5128"></a><span id="l7.5128" class="difflineminus">-                  if (!cal.sameDay(occStart, occEnd)) {</span>
<a href="#l7.5129"></a><span id="l7.5129" class="difflineminus">-                      occEnd = occStart.clone();</span>
<a href="#l7.5130"></a><span id="l7.5130" class="difflineminus">-                      occEnd.day = occStart.day;</span>
<a href="#l7.5131"></a><span id="l7.5131" class="difflineminus">-                      occEnd.hour = 23;</span>
<a href="#l7.5132"></a><span id="l7.5132" class="difflineminus">-                      occEnd.minute = 59;</span>
<a href="#l7.5133"></a><span id="l7.5133" class="difflineminus">-                  }</span>
<a href="#l7.5134"></a><span id="l7.5134" class="difflineminus">-</span>
<a href="#l7.5135"></a><span id="l7.5135" class="difflineminus">-                  // Ensure range shows occ</span>
<a href="#l7.5136"></a><span id="l7.5136" class="difflineminus">-                  lowMinute = Math.min(occStart.hour * 60 + occStart.minute,</span>
<a href="#l7.5137"></a><span id="l7.5137" class="difflineminus">-                                       lowMinute);</span>
<a href="#l7.5138"></a><span id="l7.5138" class="difflineminus">-                  highMinute = Math.max(occEnd.hour * 60 + occEnd.minute,</span>
<a href="#l7.5139"></a><span id="l7.5139" class="difflineminus">-                                        highMinute);</span>
<a href="#l7.5140"></a><span id="l7.5140" class="difflineminus">-              }</span>
<a href="#l7.5141"></a><span id="l7.5141" class="difflineminus">-          }</span>
<a href="#l7.5142"></a><span id="l7.5142" class="difflineminus">-</span>
<a href="#l7.5143"></a><span id="l7.5143" class="difflineminus">-          let displayDuration = highMinute - lowMinute;</span>
<a href="#l7.5144"></a><span id="l7.5144" class="difflineminus">-          if (this.mSelectedItems.length &amp;&amp;</span>
<a href="#l7.5145"></a><span id="l7.5145" class="difflineminus">-              displayDuration &gt;= 0) {</span>
<a href="#l7.5146"></a><span id="l7.5146" class="difflineminus">-              let minute;</span>
<a href="#l7.5147"></a><span id="l7.5147" class="difflineminus">-              if (displayDuration &lt;= this.mVisibleMinutes) {</span>
<a href="#l7.5148"></a><span id="l7.5148" class="difflineminus">-                  minute = lowMinute + (displayDuration - this.mVisibleMinutes) / 2;</span>
<a href="#l7.5149"></a><span id="l7.5149" class="difflineminus">-              } else if (this.mSelectedItems.length == 1) {</span>
<a href="#l7.5150"></a><span id="l7.5150" class="difflineminus">-                  // If the displayDuration doesn't fit into the visible</span>
<a href="#l7.5151"></a><span id="l7.5151" class="difflineminus">-                  // minutes, but only one event is selected, then go ahead and</span>
<a href="#l7.5152"></a><span id="l7.5152" class="difflineminus">-                  // center the event start.</span>
<a href="#l7.5153"></a><span id="l7.5153" class="difflineminus">-</span>
<a href="#l7.5154"></a><span id="l7.5154" class="difflineminus">-                  minute = Math.max(0, lowMinute - (this.mVisibleMinutes / 2));</span>
<a href="#l7.5155"></a><span id="l7.5155" class="difflineminus">-              }</span>
<a href="#l7.5156"></a><span id="l7.5156" class="difflineminus">-              this.scrollToMinute(minute);</span>
<a href="#l7.5157"></a><span id="l7.5157" class="difflineminus">-          }</span>
<a href="#l7.5158"></a><span id="l7.5158" class="difflineplus">+            let displayTZ = cal.calendarDefaultTimezone();</span>
<a href="#l7.5159"></a><span id="l7.5159" class="difflineplus">+            let lowMinute = 24 * 60;</span>
<a href="#l7.5160"></a><span id="l7.5160" class="difflineplus">+            let highMinute = 0;</span>
<a href="#l7.5161"></a><span id="l7.5161" class="difflineplus">+</span>
<a href="#l7.5162"></a><span id="l7.5162" class="difflineplus">+            for (let item of this.mSelectedItems) {</span>
<a href="#l7.5163"></a><span id="l7.5163" class="difflineplus">+                let startDateProperty = cal.calGetStartDateProp(item);</span>
<a href="#l7.5164"></a><span id="l7.5164" class="difflineplus">+                let endDateProperty = cal.calGetEndDateProp(item);</span>
<a href="#l7.5165"></a><span id="l7.5165" class="difflineplus">+</span>
<a href="#l7.5166"></a><span id="l7.5166" class="difflineplus">+                let occs = [];</span>
<a href="#l7.5167"></a><span id="l7.5167" class="difflineplus">+                if (item.recurrenceInfo) {</span>
<a href="#l7.5168"></a><span id="l7.5168" class="difflineplus">+                    // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l7.5169"></a><span id="l7.5169" class="difflineplus">+                    occs = item.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l7.5170"></a><span id="l7.5170" class="difflineplus">+                } else {</span>
<a href="#l7.5171"></a><span id="l7.5171" class="difflineplus">+                    occs = [item];</span>
<a href="#l7.5172"></a><span id="l7.5172" class="difflineplus">+                }</span>
<a href="#l7.5173"></a><span id="l7.5173" class="difflineplus">+</span>
<a href="#l7.5174"></a><span id="l7.5174" class="difflineplus">+                for (let occ of occs) {</span>
<a href="#l7.5175"></a><span id="l7.5175" class="difflineplus">+                    let occStart = occ[startDateProperty];</span>
<a href="#l7.5176"></a><span id="l7.5176" class="difflineplus">+                    let occEnd = occ[endDateProperty];</span>
<a href="#l7.5177"></a><span id="l7.5177" class="difflineplus">+                    // must have at least one of start or end</span>
<a href="#l7.5178"></a><span id="l7.5178" class="difflineplus">+                    if (!occStart &amp;&amp; !occEnd) {</span>
<a href="#l7.5179"></a><span id="l7.5179" class="difflineplus">+                        continue; // task with no dates</span>
<a href="#l7.5180"></a><span id="l7.5180" class="difflineplus">+                    }</span>
<a href="#l7.5181"></a><span id="l7.5181" class="difflineplus">+</span>
<a href="#l7.5182"></a><span id="l7.5182" class="difflineplus">+                    // if just has single datetime, treat as zero duration item</span>
<a href="#l7.5183"></a><span id="l7.5183" class="difflineplus">+                    // (such as task with due datetime or start datetime only)</span>
<a href="#l7.5184"></a><span id="l7.5184" class="difflineplus">+                    occStart = occStart || occEnd;</span>
<a href="#l7.5185"></a><span id="l7.5185" class="difflineplus">+                    occEnd = occEnd || occStart;</span>
<a href="#l7.5186"></a><span id="l7.5186" class="difflineplus">+                    // Now both occStart and occEnd are datetimes.</span>
<a href="#l7.5187"></a><span id="l7.5187" class="difflineplus">+</span>
<a href="#l7.5188"></a><span id="l7.5188" class="difflineplus">+                    // skip occurrence if all-day: it won't show in time view.</span>
<a href="#l7.5189"></a><span id="l7.5189" class="difflineplus">+                    if (occStart.isDate || occEnd.isDate) {</span>
<a href="#l7.5190"></a><span id="l7.5190" class="difflineplus">+                        continue;</span>
<a href="#l7.5191"></a><span id="l7.5191" class="difflineplus">+                    }</span>
<a href="#l7.5192"></a><span id="l7.5192" class="difflineplus">+</span>
<a href="#l7.5193"></a><span id="l7.5193" class="difflineplus">+                    // Trim dates to view.  (Not mutated so just reuse view dates)</span>
<a href="#l7.5194"></a><span id="l7.5194" class="difflineplus">+                    if (this.startDate.compare(occStart) &gt; 0) {</span>
<a href="#l7.5195"></a><span id="l7.5195" class="difflineplus">+                        occStart = this.startDate;</span>
<a href="#l7.5196"></a><span id="l7.5196" class="difflineplus">+                    }</span>
<a href="#l7.5197"></a><span id="l7.5197" class="difflineplus">+                    if (this.queryEndDate.compare(occEnd) &lt; 0) {</span>
<a href="#l7.5198"></a><span id="l7.5198" class="difflineplus">+                        occEnd = this.queryEndDate;</span>
<a href="#l7.5199"></a><span id="l7.5199" class="difflineplus">+                    }</span>
<a href="#l7.5200"></a><span id="l7.5200" class="difflineplus">+</span>
<a href="#l7.5201"></a><span id="l7.5201" class="difflineplus">+                    // Convert to display timezone if different</span>
<a href="#l7.5202"></a><span id="l7.5202" class="difflineplus">+                    if (occStart.timezone != displayTZ) {</span>
<a href="#l7.5203"></a><span id="l7.5203" class="difflineplus">+                        occStart = occStart.getInTimezone(displayTZ);</span>
<a href="#l7.5204"></a><span id="l7.5204" class="difflineplus">+                    }</span>
<a href="#l7.5205"></a><span id="l7.5205" class="difflineplus">+                    if (occEnd.timezone != displayTZ) {</span>
<a href="#l7.5206"></a><span id="l7.5206" class="difflineplus">+                        occEnd = occEnd.getInTimezone(displayTZ);</span>
<a href="#l7.5207"></a><span id="l7.5207" class="difflineplus">+                    }</span>
<a href="#l7.5208"></a><span id="l7.5208" class="difflineplus">+                    // If crosses midnite in current TZ, set end just</span>
<a href="#l7.5209"></a><span id="l7.5209" class="difflineplus">+                    // before midnite after start so start/title usually visible.</span>
<a href="#l7.5210"></a><span id="l7.5210" class="difflineplus">+                    if (!cal.sameDay(occStart, occEnd)) {</span>
<a href="#l7.5211"></a><span id="l7.5211" class="difflineplus">+                        occEnd = occStart.clone();</span>
<a href="#l7.5212"></a><span id="l7.5212" class="difflineplus">+                        occEnd.day = occStart.day;</span>
<a href="#l7.5213"></a><span id="l7.5213" class="difflineplus">+                        occEnd.hour = 23;</span>
<a href="#l7.5214"></a><span id="l7.5214" class="difflineplus">+                        occEnd.minute = 59;</span>
<a href="#l7.5215"></a><span id="l7.5215" class="difflineplus">+                    }</span>
<a href="#l7.5216"></a><span id="l7.5216" class="difflineplus">+</span>
<a href="#l7.5217"></a><span id="l7.5217" class="difflineplus">+                    // Ensure range shows occ</span>
<a href="#l7.5218"></a><span id="l7.5218" class="difflineplus">+                    lowMinute = Math.min(occStart.hour * 60 + occStart.minute,</span>
<a href="#l7.5219"></a><span id="l7.5219" class="difflineplus">+                                         lowMinute);</span>
<a href="#l7.5220"></a><span id="l7.5220" class="difflineplus">+                    highMinute = Math.max(occEnd.hour * 60 + occEnd.minute,</span>
<a href="#l7.5221"></a><span id="l7.5221" class="difflineplus">+                                          highMinute);</span>
<a href="#l7.5222"></a><span id="l7.5222" class="difflineplus">+                }</span>
<a href="#l7.5223"></a><span id="l7.5223" class="difflineplus">+            }</span>
<a href="#l7.5224"></a><span id="l7.5224" class="difflineplus">+</span>
<a href="#l7.5225"></a><span id="l7.5225" class="difflineplus">+            let displayDuration = highMinute - lowMinute;</span>
<a href="#l7.5226"></a><span id="l7.5226" class="difflineplus">+            if (this.mSelectedItems.length &amp;&amp;</span>
<a href="#l7.5227"></a><span id="l7.5227" class="difflineplus">+                displayDuration &gt;= 0) {</span>
<a href="#l7.5228"></a><span id="l7.5228" class="difflineplus">+                let minute;</span>
<a href="#l7.5229"></a><span id="l7.5229" class="difflineplus">+                if (displayDuration &lt;= this.mVisibleMinutes) {</span>
<a href="#l7.5230"></a><span id="l7.5230" class="difflineplus">+                    minute = lowMinute + (displayDuration - this.mVisibleMinutes) / 2;</span>
<a href="#l7.5231"></a><span id="l7.5231" class="difflineplus">+                } else if (this.mSelectedItems.length == 1) {</span>
<a href="#l7.5232"></a><span id="l7.5232" class="difflineplus">+                    // If the displayDuration doesn't fit into the visible</span>
<a href="#l7.5233"></a><span id="l7.5233" class="difflineplus">+                    // minutes, but only one event is selected, then go ahead and</span>
<a href="#l7.5234"></a><span id="l7.5234" class="difflineplus">+                    // center the event start.</span>
<a href="#l7.5235"></a><span id="l7.5235" class="difflineplus">+</span>
<a href="#l7.5236"></a><span id="l7.5236" class="difflineplus">+                    minute = Math.max(0, lowMinute - (this.mVisibleMinutes / 2));</span>
<a href="#l7.5237"></a><span id="l7.5237" class="difflineplus">+                }</span>
<a href="#l7.5238"></a><span id="l7.5238" class="difflineplus">+                this.scrollToMinute(minute);</span>
<a href="#l7.5239"></a><span id="l7.5239" class="difflineplus">+            }</span>
<a href="#l7.5240"></a><span id="l7.5240">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5241"></a><span id="l7.5241">       &lt;/method&gt;</span>
<a href="#l7.5242"></a><span id="l7.5242"> </span>
<a href="#l7.5243"></a><span id="l7.5243">       &lt;property name=&quot;pixelsPerMinute&quot;&gt;</span>
<a href="#l7.5244"></a><span id="l7.5244">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.5245"></a><span id="l7.5245" class="difflineminus">-          return this.mPixPerMin;</span>
<a href="#l7.5246"></a><span id="l7.5246" class="difflineplus">+            return this.mPixPerMin;</span>
<a href="#l7.5247"></a><span id="l7.5247">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.5248"></a><span id="l7.5248">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.5249"></a><span id="l7.5249" class="difflineminus">-          this.mPixPerMin = val;</span>
<a href="#l7.5250"></a><span id="l7.5250" class="difflineminus">-</span>
<a href="#l7.5251"></a><span id="l7.5251" class="difflineminus">-          let timebar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;);</span>
<a href="#l7.5252"></a><span id="l7.5252" class="difflineminus">-          timebar.pixelsPerMinute = val;</span>
<a href="#l7.5253"></a><span id="l7.5253" class="difflineminus">-</span>
<a href="#l7.5254"></a><span id="l7.5254" class="difflineminus">-          if (!this.mDateColumns) {</span>
<a href="#l7.5255"></a><span id="l7.5255" class="difflineminus">-              return val;</span>
<a href="#l7.5256"></a><span id="l7.5256" class="difflineminus">-          }</span>
<a href="#l7.5257"></a><span id="l7.5257" class="difflineminus">-          for (let col of this.mDateColumns) {</span>
<a href="#l7.5258"></a><span id="l7.5258" class="difflineminus">-              col.column.pixelsPerMinute = val;</span>
<a href="#l7.5259"></a><span id="l7.5259" class="difflineminus">-          }</span>
<a href="#l7.5260"></a><span id="l7.5260" class="difflineminus">-          return val;</span>
<a href="#l7.5261"></a><span id="l7.5261" class="difflineplus">+            this.mPixPerMin = val;</span>
<a href="#l7.5262"></a><span id="l7.5262" class="difflineplus">+</span>
<a href="#l7.5263"></a><span id="l7.5263" class="difflineplus">+            let timebar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;);</span>
<a href="#l7.5264"></a><span id="l7.5264" class="difflineplus">+            timebar.pixelsPerMinute = val;</span>
<a href="#l7.5265"></a><span id="l7.5265" class="difflineplus">+</span>
<a href="#l7.5266"></a><span id="l7.5266" class="difflineplus">+            if (!this.mDateColumns) {</span>
<a href="#l7.5267"></a><span id="l7.5267" class="difflineplus">+                return val;</span>
<a href="#l7.5268"></a><span id="l7.5268" class="difflineplus">+            }</span>
<a href="#l7.5269"></a><span id="l7.5269" class="difflineplus">+            for (let col of this.mDateColumns) {</span>
<a href="#l7.5270"></a><span id="l7.5270" class="difflineplus">+                col.column.pixelsPerMinute = val;</span>
<a href="#l7.5271"></a><span id="l7.5271" class="difflineplus">+            }</span>
<a href="#l7.5272"></a><span id="l7.5272" class="difflineplus">+            return val;</span>
<a href="#l7.5273"></a><span id="l7.5273">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.5274"></a><span id="l7.5274">       &lt;/property&gt;</span>
<a href="#l7.5275"></a><span id="l7.5275"> </span>
<a href="#l7.5276"></a><span id="l7.5276">       &lt;!-- private --&gt;</span>
<a href="#l7.5277"></a><span id="l7.5277"> </span>
<a href="#l7.5278"></a><span id="l7.5278">       &lt;property name=&quot;numVisibleDates&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.5279"></a><span id="l7.5279">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.5280"></a><span id="l7.5280" class="difflineminus">-          if (this.mDateList) {</span>
<a href="#l7.5281"></a><span id="l7.5281" class="difflineminus">-              return this.mDateList.length;</span>
<a href="#l7.5282"></a><span id="l7.5282" class="difflineminus">-          }</span>
<a href="#l7.5283"></a><span id="l7.5283" class="difflineminus">-</span>
<a href="#l7.5284"></a><span id="l7.5284" class="difflineminus">-          let count = 0;</span>
<a href="#l7.5285"></a><span id="l7.5285" class="difflineminus">-</span>
<a href="#l7.5286"></a><span id="l7.5286" class="difflineminus">-          if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l7.5287"></a><span id="l7.5287" class="difflineminus">-              // The view has not been initialized, so there are 0 visible dates.</span>
<a href="#l7.5288"></a><span id="l7.5288" class="difflineminus">-              return count;</span>
<a href="#l7.5289"></a><span id="l7.5289" class="difflineminus">-          }</span>
<a href="#l7.5290"></a><span id="l7.5290" class="difflineminus">-</span>
<a href="#l7.5291"></a><span id="l7.5291" class="difflineminus">-          let date = this.mStartDate.clone();</span>
<a href="#l7.5292"></a><span id="l7.5292" class="difflineminus">-          while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5293"></a><span id="l7.5293" class="difflineminus">-              count++;</span>
<a href="#l7.5294"></a><span id="l7.5294" class="difflineminus">-              date.day += 1;</span>
<a href="#l7.5295"></a><span id="l7.5295" class="difflineminus">-          }</span>
<a href="#l7.5296"></a><span id="l7.5296" class="difflineminus">-</span>
<a href="#l7.5297"></a><span id="l7.5297" class="difflineminus">-          return count;</span>
<a href="#l7.5298"></a><span id="l7.5298" class="difflineplus">+            if (this.mDateList) {</span>
<a href="#l7.5299"></a><span id="l7.5299" class="difflineplus">+                return this.mDateList.length;</span>
<a href="#l7.5300"></a><span id="l7.5300" class="difflineplus">+            }</span>
<a href="#l7.5301"></a><span id="l7.5301" class="difflineplus">+</span>
<a href="#l7.5302"></a><span id="l7.5302" class="difflineplus">+            let count = 0;</span>
<a href="#l7.5303"></a><span id="l7.5303" class="difflineplus">+</span>
<a href="#l7.5304"></a><span id="l7.5304" class="difflineplus">+            if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l7.5305"></a><span id="l7.5305" class="difflineplus">+                // The view has not been initialized, so there are 0 visible dates.</span>
<a href="#l7.5306"></a><span id="l7.5306" class="difflineplus">+                return count;</span>
<a href="#l7.5307"></a><span id="l7.5307" class="difflineplus">+            }</span>
<a href="#l7.5308"></a><span id="l7.5308" class="difflineplus">+</span>
<a href="#l7.5309"></a><span id="l7.5309" class="difflineplus">+            let date = this.mStartDate.clone();</span>
<a href="#l7.5310"></a><span id="l7.5310" class="difflineplus">+            while (date.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5311"></a><span id="l7.5311" class="difflineplus">+                count++;</span>
<a href="#l7.5312"></a><span id="l7.5312" class="difflineplus">+                date.day += 1;</span>
<a href="#l7.5313"></a><span id="l7.5313" class="difflineplus">+            }</span>
<a href="#l7.5314"></a><span id="l7.5314" class="difflineplus">+</span>
<a href="#l7.5315"></a><span id="l7.5315" class="difflineplus">+            return count;</span>
<a href="#l7.5316"></a><span id="l7.5316">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.5317"></a><span id="l7.5317">       &lt;/property&gt;</span>
<a href="#l7.5318"></a><span id="l7.5318"> </span>
<a href="#l7.5319"></a><span id="l7.5319">       &lt;property name=&quot;orient&quot;&gt;</span>
<a href="#l7.5320"></a><span id="l7.5320">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.5321"></a><span id="l7.5321" class="difflineminus">-          return this.getAttribute(&quot;orient&quot;) || &quot;vertical&quot;;</span>
<a href="#l7.5322"></a><span id="l7.5322" class="difflineplus">+            return this.getAttribute(&quot;orient&quot;) || &quot;vertical&quot;;</span>
<a href="#l7.5323"></a><span id="l7.5323">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.5324"></a><span id="l7.5324">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l7.5325"></a><span id="l7.5325" class="difflineminus">-          this.setAttribute(&quot;orient&quot;, val);</span>
<a href="#l7.5326"></a><span id="l7.5326" class="difflineminus">-          return val;</span>
<a href="#l7.5327"></a><span id="l7.5327" class="difflineplus">+            this.setAttribute(&quot;orient&quot;, val);</span>
<a href="#l7.5328"></a><span id="l7.5328" class="difflineplus">+            return val;</span>
<a href="#l7.5329"></a><span id="l7.5329">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l7.5330"></a><span id="l7.5330">       &lt;/property&gt;</span>
<a href="#l7.5331"></a><span id="l7.5331"> </span>
<a href="#l7.5332"></a><span id="l7.5332">       &lt;property name=&quot;timeBarTimeIndicator&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l7.5333"></a><span id="l7.5333">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l7.5334"></a><span id="l7.5334" class="difflineminus">-          let timebar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;);</span>
<a href="#l7.5335"></a><span id="l7.5335" class="difflineminus">-          return document.getAnonymousElementByAttribute(timebar, &quot;anonid&quot;, &quot;timeIndicatorBoxTimeBar&quot;);</span>
<a href="#l7.5336"></a><span id="l7.5336" class="difflineplus">+            let timebar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;);</span>
<a href="#l7.5337"></a><span id="l7.5337" class="difflineplus">+            return document.getAnonymousElementByAttribute(timebar, &quot;anonid&quot;, &quot;timeIndicatorBoxTimeBar&quot;);</span>
<a href="#l7.5338"></a><span id="l7.5338">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l7.5339"></a><span id="l7.5339">       &lt;/property&gt;</span>
<a href="#l7.5340"></a><span id="l7.5340"> </span>
<a href="#l7.5341"></a><span id="l7.5341">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l7.5342"></a><span id="l7.5342">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l7.5343"></a><span id="l7.5343">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l7.5344"></a><span id="l7.5344">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5345"></a><span id="l7.5345" class="difflineminus">-          let needsreorient = false;</span>
<a href="#l7.5346"></a><span id="l7.5346" class="difflineminus">-          let needsrelayout = false;</span>
<a href="#l7.5347"></a><span id="l7.5347" class="difflineminus">-          if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.5348"></a><span id="l7.5348" class="difflineminus">-              if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.5349"></a><span id="l7.5349" class="difflineminus">-                  needsreorient = true;</span>
<a href="#l7.5350"></a><span id="l7.5350" class="difflineminus">-              }</span>
<a href="#l7.5351"></a><span id="l7.5351" class="difflineminus">-          }</span>
<a href="#l7.5352"></a><span id="l7.5352" class="difflineminus">-</span>
<a href="#l7.5353"></a><span id="l7.5353" class="difflineminus">-          if (aAttr == &quot;context&quot; || aAttr == &quot;item-context&quot;) {</span>
<a href="#l7.5354"></a><span id="l7.5354" class="difflineminus">-              needsrelayout = true;</span>
<a href="#l7.5355"></a><span id="l7.5355" class="difflineminus">-          }</span>
<a href="#l7.5356"></a><span id="l7.5356" class="difflineminus">-</span>
<a href="#l7.5357"></a><span id="l7.5357" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.5358"></a><span id="l7.5358" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.5359"></a><span id="l7.5359" class="difflineminus">-</span>
<a href="#l7.5360"></a><span id="l7.5360" class="difflineminus">-          if (needsrelayout &amp;&amp; !needsreorient) {</span>
<a href="#l7.5361"></a><span id="l7.5361" class="difflineminus">-              this.relayout();</span>
<a href="#l7.5362"></a><span id="l7.5362" class="difflineminus">-          }</span>
<a href="#l7.5363"></a><span id="l7.5363" class="difflineminus">-</span>
<a href="#l7.5364"></a><span id="l7.5364" class="difflineminus">-          if (needsreorient) {</span>
<a href="#l7.5365"></a><span id="l7.5365" class="difflineminus">-              this.reorient();</span>
<a href="#l7.5366"></a><span id="l7.5366" class="difflineminus">-          }</span>
<a href="#l7.5367"></a><span id="l7.5367" class="difflineminus">-</span>
<a href="#l7.5368"></a><span id="l7.5368" class="difflineminus">-          return ret;</span>
<a href="#l7.5369"></a><span id="l7.5369" class="difflineplus">+            let needsreorient = false;</span>
<a href="#l7.5370"></a><span id="l7.5370" class="difflineplus">+            let needsrelayout = false;</span>
<a href="#l7.5371"></a><span id="l7.5371" class="difflineplus">+            if (aAttr == &quot;orient&quot;) {</span>
<a href="#l7.5372"></a><span id="l7.5372" class="difflineplus">+                if (this.getAttribute(&quot;orient&quot;) != aVal) {</span>
<a href="#l7.5373"></a><span id="l7.5373" class="difflineplus">+                    needsreorient = true;</span>
<a href="#l7.5374"></a><span id="l7.5374" class="difflineplus">+                }</span>
<a href="#l7.5375"></a><span id="l7.5375" class="difflineplus">+            }</span>
<a href="#l7.5376"></a><span id="l7.5376" class="difflineplus">+</span>
<a href="#l7.5377"></a><span id="l7.5377" class="difflineplus">+            if (aAttr == &quot;context&quot; || aAttr == &quot;item-context&quot;) {</span>
<a href="#l7.5378"></a><span id="l7.5378" class="difflineplus">+                needsrelayout = true;</span>
<a href="#l7.5379"></a><span id="l7.5379" class="difflineplus">+            }</span>
<a href="#l7.5380"></a><span id="l7.5380" class="difflineplus">+</span>
<a href="#l7.5381"></a><span id="l7.5381" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l7.5382"></a><span id="l7.5382" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l7.5383"></a><span id="l7.5383" class="difflineplus">+</span>
<a href="#l7.5384"></a><span id="l7.5384" class="difflineplus">+            if (needsrelayout &amp;&amp; !needsreorient) {</span>
<a href="#l7.5385"></a><span id="l7.5385" class="difflineplus">+                this.relayout();</span>
<a href="#l7.5386"></a><span id="l7.5386" class="difflineplus">+            }</span>
<a href="#l7.5387"></a><span id="l7.5387" class="difflineplus">+</span>
<a href="#l7.5388"></a><span id="l7.5388" class="difflineplus">+            if (needsreorient) {</span>
<a href="#l7.5389"></a><span id="l7.5389" class="difflineplus">+                this.reorient();</span>
<a href="#l7.5390"></a><span id="l7.5390" class="difflineplus">+            }</span>
<a href="#l7.5391"></a><span id="l7.5391" class="difflineplus">+</span>
<a href="#l7.5392"></a><span id="l7.5392" class="difflineplus">+            return ret;</span>
<a href="#l7.5393"></a><span id="l7.5393">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5394"></a><span id="l7.5394">       &lt;/method&gt;</span>
<a href="#l7.5395"></a><span id="l7.5395"> </span>
<a href="#l7.5396"></a><span id="l7.5396">       &lt;method name=&quot;reorient&quot;&gt;</span>
<a href="#l7.5397"></a><span id="l7.5397">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5398"></a><span id="l7.5398" class="difflineminus">-          let orient = this.getAttribute(&quot;orient&quot;) || &quot;horizontal&quot;;</span>
<a href="#l7.5399"></a><span id="l7.5399" class="difflineminus">-          let otherorient = (orient == &quot;vertical&quot; ? &quot;horizontal&quot; : &quot;vertical&quot;);</span>
<a href="#l7.5400"></a><span id="l7.5400" class="difflineminus">-</span>
<a href="#l7.5401"></a><span id="l7.5401" class="difflineminus">-          if (orient == &quot;horizontal&quot;) {</span>
<a href="#l7.5402"></a><span id="l7.5402" class="difflineminus">-              this.pixelsPerMinute = 1.5;</span>
<a href="#l7.5403"></a><span id="l7.5403" class="difflineminus">-          } else {</span>
<a href="#l7.5404"></a><span id="l7.5404" class="difflineminus">-              this.pixelsPerMinute = 0.6;</span>
<a href="#l7.5405"></a><span id="l7.5405" class="difflineminus">-          }</span>
<a href="#l7.5406"></a><span id="l7.5406" class="difflineminus">-</span>
<a href="#l7.5407"></a><span id="l7.5407" class="difflineminus">-          let normalelems = [&quot;mainbox&quot;, &quot;timebar&quot;];</span>
<a href="#l7.5408"></a><span id="l7.5408" class="difflineminus">-          let otherelems = [</span>
<a href="#l7.5409"></a><span id="l7.5409" class="difflineminus">-              &quot;labelbox&quot;, &quot;labeldaybox&quot;, &quot;headertimespacer&quot;, &quot;headerbox&quot;,</span>
<a href="#l7.5410"></a><span id="l7.5410" class="difflineminus">-              &quot;headerdaybox&quot;, &quot;scrollbox&quot;, &quot;daybox&quot;</span>
<a href="#l7.5411"></a><span id="l7.5411" class="difflineminus">-          ];</span>
<a href="#l7.5412"></a><span id="l7.5412" class="difflineminus">-</span>
<a href="#l7.5413"></a><span id="l7.5413" class="difflineminus">-          for (let id of normalelems) {</span>
<a href="#l7.5414"></a><span id="l7.5414" class="difflineminus">-              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, id).setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.5415"></a><span id="l7.5415" class="difflineminus">-          }</span>
<a href="#l7.5416"></a><span id="l7.5416" class="difflineminus">-          for (let id of otherelems) {</span>
<a href="#l7.5417"></a><span id="l7.5417" class="difflineminus">-              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, id).setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.5418"></a><span id="l7.5418" class="difflineminus">-          }</span>
<a href="#l7.5419"></a><span id="l7.5419" class="difflineminus">-</span>
<a href="#l7.5420"></a><span id="l7.5420" class="difflineminus">-          let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5421"></a><span id="l7.5421" class="difflineminus">-                         this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.5422"></a><span id="l7.5422" class="difflineminus">-          let mainbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5423"></a><span id="l7.5423" class="difflineminus">-                        this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.5424"></a><span id="l7.5424" class="difflineminus">-</span>
<a href="#l7.5425"></a><span id="l7.5425" class="difflineminus">-          if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.5426"></a><span id="l7.5426" class="difflineminus">-              scrollbox.setAttribute(</span>
<a href="#l7.5427"></a><span id="l7.5427" class="difflineminus">-                  &quot;style&quot;, &quot;overflow-x: hidden; overflow-y: auto;&quot;);</span>
<a href="#l7.5428"></a><span id="l7.5428" class="difflineminus">-              mainbox.setAttribute(</span>
<a href="#l7.5429"></a><span id="l7.5429" class="difflineminus">-                  &quot;style&quot;, &quot;overflow-x: auto; overflow-y: hidden;&quot;);</span>
<a href="#l7.5430"></a><span id="l7.5430" class="difflineminus">-          } else {</span>
<a href="#l7.5431"></a><span id="l7.5431" class="difflineminus">-              scrollbox.setAttribute(</span>
<a href="#l7.5432"></a><span id="l7.5432" class="difflineminus">-                  &quot;style&quot;, &quot;overflow-x: auto; overflow-y: hidden;&quot;);</span>
<a href="#l7.5433"></a><span id="l7.5433" class="difflineminus">-              mainbox.setAttribute(</span>
<a href="#l7.5434"></a><span id="l7.5434" class="difflineminus">-                  &quot;style&quot;, &quot;overflow-x: hidden; overflow-y: auto;&quot;);</span>
<a href="#l7.5435"></a><span id="l7.5435" class="difflineminus">-          }</span>
<a href="#l7.5436"></a><span id="l7.5436" class="difflineminus">-</span>
<a href="#l7.5437"></a><span id="l7.5437" class="difflineminus">-          let boxes = [&quot;daybox&quot;, &quot;headerdaybox&quot;];</span>
<a href="#l7.5438"></a><span id="l7.5438" class="difflineminus">-          for (let boxname of boxes) {</span>
<a href="#l7.5439"></a><span id="l7.5439" class="difflineminus">-              let box = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, boxname);</span>
<a href="#l7.5440"></a><span id="l7.5440" class="difflineminus">-              setAttributeToChildren(box, &quot;orient&quot;, orient);</span>
<a href="#l7.5441"></a><span id="l7.5441" class="difflineminus">-          }</span>
<a href="#l7.5442"></a><span id="l7.5442" class="difflineminus">-</span>
<a href="#l7.5443"></a><span id="l7.5443" class="difflineminus">-          setAttributeToChildren(this.labeldaybox, &quot;orient&quot;, otherorient);</span>
<a href="#l7.5444"></a><span id="l7.5444" class="difflineminus">-</span>
<a href="#l7.5445"></a><span id="l7.5445" class="difflineminus">-          // Refresh</span>
<a href="#l7.5446"></a><span id="l7.5446" class="difflineminus">-          this.refresh();</span>
<a href="#l7.5447"></a><span id="l7.5447" class="difflineplus">+            let orient = this.getAttribute(&quot;orient&quot;) || &quot;horizontal&quot;;</span>
<a href="#l7.5448"></a><span id="l7.5448" class="difflineplus">+            let otherorient = (orient == &quot;vertical&quot; ? &quot;horizontal&quot; : &quot;vertical&quot;);</span>
<a href="#l7.5449"></a><span id="l7.5449" class="difflineplus">+</span>
<a href="#l7.5450"></a><span id="l7.5450" class="difflineplus">+            if (orient == &quot;horizontal&quot;) {</span>
<a href="#l7.5451"></a><span id="l7.5451" class="difflineplus">+                this.pixelsPerMinute = 1.5;</span>
<a href="#l7.5452"></a><span id="l7.5452" class="difflineplus">+            } else {</span>
<a href="#l7.5453"></a><span id="l7.5453" class="difflineplus">+                this.pixelsPerMinute = 0.6;</span>
<a href="#l7.5454"></a><span id="l7.5454" class="difflineplus">+            }</span>
<a href="#l7.5455"></a><span id="l7.5455" class="difflineplus">+</span>
<a href="#l7.5456"></a><span id="l7.5456" class="difflineplus">+            let normalelems = [&quot;mainbox&quot;, &quot;timebar&quot;];</span>
<a href="#l7.5457"></a><span id="l7.5457" class="difflineplus">+            let otherelems = [</span>
<a href="#l7.5458"></a><span id="l7.5458" class="difflineplus">+                &quot;labelbox&quot;, &quot;labeldaybox&quot;, &quot;headertimespacer&quot;, &quot;headerbox&quot;,</span>
<a href="#l7.5459"></a><span id="l7.5459" class="difflineplus">+                &quot;headerdaybox&quot;, &quot;scrollbox&quot;, &quot;daybox&quot;</span>
<a href="#l7.5460"></a><span id="l7.5460" class="difflineplus">+            ];</span>
<a href="#l7.5461"></a><span id="l7.5461" class="difflineplus">+</span>
<a href="#l7.5462"></a><span id="l7.5462" class="difflineplus">+            for (let id of normalelems) {</span>
<a href="#l7.5463"></a><span id="l7.5463" class="difflineplus">+                document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, id).setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.5464"></a><span id="l7.5464" class="difflineplus">+            }</span>
<a href="#l7.5465"></a><span id="l7.5465" class="difflineplus">+            for (let id of otherelems) {</span>
<a href="#l7.5466"></a><span id="l7.5466" class="difflineplus">+                document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, id).setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.5467"></a><span id="l7.5467" class="difflineplus">+            }</span>
<a href="#l7.5468"></a><span id="l7.5468" class="difflineplus">+</span>
<a href="#l7.5469"></a><span id="l7.5469" class="difflineplus">+            let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5470"></a><span id="l7.5470" class="difflineplus">+                           this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.5471"></a><span id="l7.5471" class="difflineplus">+            let mainbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5472"></a><span id="l7.5472" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l7.5473"></a><span id="l7.5473" class="difflineplus">+</span>
<a href="#l7.5474"></a><span id="l7.5474" class="difflineplus">+            if (orient == &quot;vertical&quot;) {</span>
<a href="#l7.5475"></a><span id="l7.5475" class="difflineplus">+                scrollbox.setAttribute(</span>
<a href="#l7.5476"></a><span id="l7.5476" class="difflineplus">+                    &quot;style&quot;, &quot;overflow-x: hidden; overflow-y: auto;&quot;);</span>
<a href="#l7.5477"></a><span id="l7.5477" class="difflineplus">+                mainbox.setAttribute(</span>
<a href="#l7.5478"></a><span id="l7.5478" class="difflineplus">+                    &quot;style&quot;, &quot;overflow-x: auto; overflow-y: hidden;&quot;);</span>
<a href="#l7.5479"></a><span id="l7.5479" class="difflineplus">+            } else {</span>
<a href="#l7.5480"></a><span id="l7.5480" class="difflineplus">+                scrollbox.setAttribute(</span>
<a href="#l7.5481"></a><span id="l7.5481" class="difflineplus">+                    &quot;style&quot;, &quot;overflow-x: auto; overflow-y: hidden;&quot;);</span>
<a href="#l7.5482"></a><span id="l7.5482" class="difflineplus">+                mainbox.setAttribute(</span>
<a href="#l7.5483"></a><span id="l7.5483" class="difflineplus">+                    &quot;style&quot;, &quot;overflow-x: hidden; overflow-y: auto;&quot;);</span>
<a href="#l7.5484"></a><span id="l7.5484" class="difflineplus">+            }</span>
<a href="#l7.5485"></a><span id="l7.5485" class="difflineplus">+</span>
<a href="#l7.5486"></a><span id="l7.5486" class="difflineplus">+            let boxes = [&quot;daybox&quot;, &quot;headerdaybox&quot;];</span>
<a href="#l7.5487"></a><span id="l7.5487" class="difflineplus">+            for (let boxname of boxes) {</span>
<a href="#l7.5488"></a><span id="l7.5488" class="difflineplus">+                let box = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, boxname);</span>
<a href="#l7.5489"></a><span id="l7.5489" class="difflineplus">+                setAttributeToChildren(box, &quot;orient&quot;, orient);</span>
<a href="#l7.5490"></a><span id="l7.5490" class="difflineplus">+            }</span>
<a href="#l7.5491"></a><span id="l7.5491" class="difflineplus">+</span>
<a href="#l7.5492"></a><span id="l7.5492" class="difflineplus">+            setAttributeToChildren(this.labeldaybox, &quot;orient&quot;, otherorient);</span>
<a href="#l7.5493"></a><span id="l7.5493" class="difflineplus">+</span>
<a href="#l7.5494"></a><span id="l7.5494" class="difflineplus">+            // Refresh</span>
<a href="#l7.5495"></a><span id="l7.5495" class="difflineplus">+            this.refresh();</span>
<a href="#l7.5496"></a><span id="l7.5496">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5497"></a><span id="l7.5497">       &lt;/method&gt;</span>
<a href="#l7.5498"></a><span id="l7.5498"> </span>
<a href="#l7.5499"></a><span id="l7.5499">       &lt;method name=&quot;relayout&quot;&gt;</span>
<a href="#l7.5500"></a><span id="l7.5500">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5501"></a><span id="l7.5501" class="difflineminus">-          if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l7.5502"></a><span id="l7.5502" class="difflineminus">-              return;</span>
<a href="#l7.5503"></a><span id="l7.5503" class="difflineminus">-          }</span>
<a href="#l7.5504"></a><span id="l7.5504" class="difflineminus">-</span>
<a href="#l7.5505"></a><span id="l7.5505" class="difflineminus">-          let orient = this.getAttribute(&quot;orient&quot;) || &quot;horizontal&quot;;</span>
<a href="#l7.5506"></a><span id="l7.5506" class="difflineminus">-          let otherorient = getOtherOrientation(orient);</span>
<a href="#l7.5507"></a><span id="l7.5507" class="difflineminus">-</span>
<a href="#l7.5508"></a><span id="l7.5508" class="difflineminus">-          let computedDateList = [];</span>
<a href="#l7.5509"></a><span id="l7.5509" class="difflineminus">-          let startDate = this.mStartDate.clone();</span>
<a href="#l7.5510"></a><span id="l7.5510" class="difflineminus">-          while (startDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5511"></a><span id="l7.5511" class="difflineminus">-              let workday = startDate.clone();</span>
<a href="#l7.5512"></a><span id="l7.5512" class="difflineminus">-              workday.makeImmutable();</span>
<a href="#l7.5513"></a><span id="l7.5513" class="difflineminus">-              if (this.mDisplayDaysOff) {</span>
<a href="#l7.5514"></a><span id="l7.5514" class="difflineminus">-                  computedDateList.push(workday);</span>
<a href="#l7.5515"></a><span id="l7.5515" class="difflineminus">-              } else if (!this.mDaysOffArray.includes(startDate.weekday)) {</span>
<a href="#l7.5516"></a><span id="l7.5516" class="difflineminus">-                  computedDateList.push(workday);</span>
<a href="#l7.5517"></a><span id="l7.5517" class="difflineminus">-              }</span>
<a href="#l7.5518"></a><span id="l7.5518" class="difflineminus">-              startDate.day += 1;</span>
<a href="#l7.5519"></a><span id="l7.5519" class="difflineminus">-          }</span>
<a href="#l7.5520"></a><span id="l7.5520" class="difflineminus">-          this.mDateList = computedDateList;</span>
<a href="#l7.5521"></a><span id="l7.5521" class="difflineminus">-</span>
<a href="#l7.5522"></a><span id="l7.5522" class="difflineminus">-          // unselect previous selected event upon switch views, otherwise those</span>
<a href="#l7.5523"></a><span id="l7.5523" class="difflineminus">-          // events will stay selected forever, if select other events after</span>
<a href="#l7.5524"></a><span id="l7.5524" class="difflineminus">-          // change week view.</span>
<a href="#l7.5525"></a><span id="l7.5525" class="difflineminus">-          this.setSelectedItems(0, [], true);</span>
<a href="#l7.5526"></a><span id="l7.5526" class="difflineminus">-</span>
<a href="#l7.5527"></a><span id="l7.5527" class="difflineminus">-          let daybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;daybox&quot;);</span>
<a href="#l7.5528"></a><span id="l7.5528" class="difflineminus">-          let headerdaybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.5529"></a><span id="l7.5529" class="difflineminus">-</span>
<a href="#l7.5530"></a><span id="l7.5530" class="difflineminus">-          let dayStartMin = this.mDayStartMin;</span>
<a href="#l7.5531"></a><span id="l7.5531" class="difflineminus">-          let dayEndMin = this.mDayEndMin;</span>
<a href="#l7.5532"></a><span id="l7.5532" class="difflineminus">-          let setUpDayEventsBox = (aDayBox, date) =&gt; {</span>
<a href="#l7.5533"></a><span id="l7.5533" class="difflineminus">-              aDayBox.setAttribute(&quot;class&quot;, &quot;calendar-event-column-&quot; + (counter % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l7.5534"></a><span id="l7.5534" class="difflineminus">-              aDayBox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.5535"></a><span id="l7.5535" class="difflineminus">-              aDayBox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.5536"></a><span id="l7.5536" class="difflineminus">-              aDayBox.startLayoutBatchChange();</span>
<a href="#l7.5537"></a><span id="l7.5537" class="difflineminus">-              aDayBox.date = date;</span>
<a href="#l7.5538"></a><span id="l7.5538" class="difflineminus">-              aDayBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.5539"></a><span id="l7.5539" class="difflineminus">-              aDayBox.calendarView = this;</span>
<a href="#l7.5540"></a><span id="l7.5540" class="difflineminus">-              aDayBox.setDayStartEndMinutes(dayStartMin, dayEndMin);</span>
<a href="#l7.5541"></a><span id="l7.5541" class="difflineminus">-          };</span>
<a href="#l7.5542"></a><span id="l7.5542" class="difflineminus">-</span>
<a href="#l7.5543"></a><span id="l7.5543" class="difflineminus">-          let setUpDayHeaderBox = (aDayBox, date) =&gt; {</span>
<a href="#l7.5544"></a><span id="l7.5544" class="difflineminus">-              aDayBox.date = date;</span>
<a href="#l7.5545"></a><span id="l7.5545" class="difflineminus">-              aDayBox.calendarView = this;</span>
<a href="#l7.5546"></a><span id="l7.5546" class="difflineminus">-              aDayBox.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l7.5547"></a><span id="l7.5547" class="difflineminus">-              // Since the calendar-header-container boxes have the same vertical</span>
<a href="#l7.5548"></a><span id="l7.5548" class="difflineminus">-              // orientation for normal and rotated views, it needs an attribute</span>
<a href="#l7.5549"></a><span id="l7.5549" class="difflineminus">-              // &quot;rotated&quot; in order to have different css rules.</span>
<a href="#l7.5550"></a><span id="l7.5550" class="difflineminus">-              setBooleanAttribute(aDayBox, &quot;rotated&quot;, orient == &quot;horizontal&quot;);</span>
<a href="#l7.5551"></a><span id="l7.5551" class="difflineminus">-          };</span>
<a href="#l7.5552"></a><span id="l7.5552" class="difflineminus">-</span>
<a href="#l7.5553"></a><span id="l7.5553" class="difflineminus">-          this.mDateColumns = [];</span>
<a href="#l7.5554"></a><span id="l7.5554" class="difflineminus">-</span>
<a href="#l7.5555"></a><span id="l7.5555" class="difflineminus">-</span>
<a href="#l7.5556"></a><span id="l7.5556" class="difflineminus">-          // get today's date</span>
<a href="#l7.5557"></a><span id="l7.5557" class="difflineminus">-          let today = this.today();</span>
<a href="#l7.5558"></a><span id="l7.5558" class="difflineminus">-          let counter = 0;</span>
<a href="#l7.5559"></a><span id="l7.5559" class="difflineminus">-          let dayboxkids = daybox.childNodes;</span>
<a href="#l7.5560"></a><span id="l7.5560" class="difflineminus">-          let headerboxkids = headerdaybox.childNodes;</span>
<a href="#l7.5561"></a><span id="l7.5561" class="difflineminus">-          let labelboxkids = this.labeldaybox.childNodes;</span>
<a href="#l7.5562"></a><span id="l7.5562" class="difflineminus">-          let updateTimeIndicator = false;</span>
<a href="#l7.5563"></a><span id="l7.5563" class="difflineminus">-</span>
<a href="#l7.5564"></a><span id="l7.5564" class="difflineminus">-          for (let date of computedDateList) {</span>
<a href="#l7.5565"></a><span id="l7.5565" class="difflineminus">-              let dayEventsBox;</span>
<a href="#l7.5566"></a><span id="l7.5566" class="difflineminus">-              if (counter &lt; dayboxkids.length) {</span>
<a href="#l7.5567"></a><span id="l7.5567" class="difflineminus">-                  dayEventsBox = dayboxkids[counter];</span>
<a href="#l7.5568"></a><span id="l7.5568" class="difflineminus">-                  dayEventsBox.removeAttribute(&quot;relation&quot;);</span>
<a href="#l7.5569"></a><span id="l7.5569" class="difflineminus">-                  dayEventsBox.mEventInfos = [];</span>
<a href="#l7.5570"></a><span id="l7.5570" class="difflineminus">-              } else {</span>
<a href="#l7.5571"></a><span id="l7.5571" class="difflineminus">-                  dayEventsBox = createXULElement(&quot;calendar-event-column&quot;);</span>
<a href="#l7.5572"></a><span id="l7.5572" class="difflineminus">-                  dayEventsBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.5573"></a><span id="l7.5573" class="difflineminus">-                  daybox.appendChild(dayEventsBox);</span>
<a href="#l7.5574"></a><span id="l7.5574" class="difflineminus">-              }</span>
<a href="#l7.5575"></a><span id="l7.5575" class="difflineminus">-              setUpDayEventsBox(dayEventsBox, date);</span>
<a href="#l7.5576"></a><span id="l7.5576" class="difflineminus">-</span>
<a href="#l7.5577"></a><span id="l7.5577" class="difflineminus">-              let dayHeaderBox;</span>
<a href="#l7.5578"></a><span id="l7.5578" class="difflineminus">-              if (counter &lt; headerboxkids.length) {</span>
<a href="#l7.5579"></a><span id="l7.5579" class="difflineminus">-                  dayHeaderBox = headerboxkids[counter];</span>
<a href="#l7.5580"></a><span id="l7.5580" class="difflineminus">-                  // Delete backwards to make sure we get them all</span>
<a href="#l7.5581"></a><span id="l7.5581" class="difflineminus">-                  // and delete until no more elements are left.</span>
<a href="#l7.5582"></a><span id="l7.5582" class="difflineminus">-                  while (dayHeaderBox.mItemBoxes.length != 0) {</span>
<a href="#l7.5583"></a><span id="l7.5583" class="difflineminus">-                      let num = dayHeaderBox.mItemBoxes.length;</span>
<a href="#l7.5584"></a><span id="l7.5584" class="difflineminus">-                      dayHeaderBox.deleteEvent(dayHeaderBox.mItemBoxes[num-1].occurrence);</span>
<a href="#l7.5585"></a><span id="l7.5585" class="difflineminus">-                  }</span>
<a href="#l7.5586"></a><span id="l7.5586" class="difflineminus">-              } else {</span>
<a href="#l7.5587"></a><span id="l7.5587" class="difflineminus">-                  dayHeaderBox = createXULElement(&quot;calendar-header-container&quot;);</span>
<a href="#l7.5588"></a><span id="l7.5588" class="difflineminus">-                  dayHeaderBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.5589"></a><span id="l7.5589" class="difflineminus">-                  headerdaybox.appendChild(dayHeaderBox);</span>
<a href="#l7.5590"></a><span id="l7.5590" class="difflineminus">-              }</span>
<a href="#l7.5591"></a><span id="l7.5591" class="difflineminus">-              setUpDayHeaderBox(dayHeaderBox, date);</span>
<a href="#l7.5592"></a><span id="l7.5592" class="difflineminus">-</span>
<a href="#l7.5593"></a><span id="l7.5593" class="difflineminus">-              if (this.mDaysOffArray.indexOf(date.weekday) &gt;= 0) {</span>
<a href="#l7.5594"></a><span id="l7.5594" class="difflineminus">-                  dayEventsBox.dayOff = true;</span>
<a href="#l7.5595"></a><span id="l7.5595" class="difflineminus">-                  dayHeaderBox.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l7.5596"></a><span id="l7.5596" class="difflineminus">-              } else {</span>
<a href="#l7.5597"></a><span id="l7.5597" class="difflineminus">-                  dayEventsBox.dayOff = false;</span>
<a href="#l7.5598"></a><span id="l7.5598" class="difflineminus">-                  dayHeaderBox.removeAttribute(&quot;weekend&quot;);</span>
<a href="#l7.5599"></a><span id="l7.5599" class="difflineminus">-              }</span>
<a href="#l7.5600"></a><span id="l7.5600" class="difflineminus">-              let labelbox;</span>
<a href="#l7.5601"></a><span id="l7.5601" class="difflineminus">-              if (counter &lt; labelboxkids.length) {</span>
<a href="#l7.5602"></a><span id="l7.5602" class="difflineminus">-                  labelbox = labelboxkids[counter];</span>
<a href="#l7.5603"></a><span id="l7.5603" class="difflineminus">-                  labelbox.date = date;</span>
<a href="#l7.5604"></a><span id="l7.5604" class="difflineminus">-              } else {</span>
<a href="#l7.5605"></a><span id="l7.5605" class="difflineminus">-                  labelbox = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l7.5606"></a><span id="l7.5606" class="difflineminus">-                  labelbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.5607"></a><span id="l7.5607" class="difflineminus">-                  this.labeldaybox.appendChild(labelbox);</span>
<a href="#l7.5608"></a><span id="l7.5608" class="difflineminus">-                  labelbox.date = date;</span>
<a href="#l7.5609"></a><span id="l7.5609" class="difflineminus">-              }</span>
<a href="#l7.5610"></a><span id="l7.5610" class="difflineminus">-              // Set attributes for date relations and for the time indicator.</span>
<a href="#l7.5611"></a><span id="l7.5611" class="difflineminus">-              let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5612"></a><span id="l7.5612" class="difflineminus">-                                     this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.5613"></a><span id="l7.5613" class="difflineminus">-              headerDayBox.removeAttribute(&quot;todaylastinview&quot;);</span>
<a href="#l7.5614"></a><span id="l7.5614" class="difflineminus">-              dayEventsBox.timeIndicatorBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.5615"></a><span id="l7.5615" class="difflineminus">-              switch (date.compare(today)) {</span>
<a href="#l7.5616"></a><span id="l7.5616" class="difflineminus">-                  case -1: {</span>
<a href="#l7.5617"></a><span id="l7.5617" class="difflineminus">-                      dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5618"></a><span id="l7.5618" class="difflineminus">-                      dayEventsBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5619"></a><span id="l7.5619" class="difflineminus">-                      labelbox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5620"></a><span id="l7.5620" class="difflineminus">-                      break;</span>
<a href="#l7.5621"></a><span id="l7.5621" class="difflineminus">-                  }</span>
<a href="#l7.5622"></a><span id="l7.5622" class="difflineminus">-                  case 0: {</span>
<a href="#l7.5623"></a><span id="l7.5623" class="difflineminus">-                      let relation_ = this.numVisibleDates == 1 ? &quot;today1day&quot; : &quot;today&quot;;</span>
<a href="#l7.5624"></a><span id="l7.5624" class="difflineminus">-                      dayHeaderBox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5625"></a><span id="l7.5625" class="difflineminus">-                      dayEventsBox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5626"></a><span id="l7.5626" class="difflineminus">-                      labelbox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5627"></a><span id="l7.5627" class="difflineminus">-                      setBooleanAttribute(dayEventsBox.timeIndicatorBox, &quot;hidden&quot;, this.mTimeIndicatorInterval == 0);</span>
<a href="#l7.5628"></a><span id="l7.5628" class="difflineminus">-                      updateTimeIndicator = true;</span>
<a href="#l7.5629"></a><span id="l7.5629" class="difflineminus">-</span>
<a href="#l7.5630"></a><span id="l7.5630" class="difflineminus">-                      // Due to equalsize=always being set on the dayboxes</span>
<a href="#l7.5631"></a><span id="l7.5631" class="difflineminus">-                      // parent, there are a few issues showing the border of</span>
<a href="#l7.5632"></a><span id="l7.5632" class="difflineminus">-                      // the last daybox correctly. To work around this, we're</span>
<a href="#l7.5633"></a><span id="l7.5633" class="difflineminus">-                      // setting an attribute we can use in CSS. For more</span>
<a href="#l7.5634"></a><span id="l7.5634" class="difflineminus">-                      // information about this hack, see bug 455045</span>
<a href="#l7.5635"></a><span id="l7.5635" class="difflineminus">-                      if (dayHeaderBox == headerdaybox.childNodes[headerdaybox.childNodes.length - 1] &amp;&amp;</span>
<a href="#l7.5636"></a><span id="l7.5636" class="difflineminus">-                          this.numVisibleDates &gt; 1) {</span>
<a href="#l7.5637"></a><span id="l7.5637" class="difflineminus">-                          headerDayBox.setAttribute(&quot;todaylastinview&quot;, &quot;true&quot;);</span>
<a href="#l7.5638"></a><span id="l7.5638" class="difflineminus">-                      }</span>
<a href="#l7.5639"></a><span id="l7.5639" class="difflineminus">-                      break;</span>
<a href="#l7.5640"></a><span id="l7.5640" class="difflineminus">-                  }</span>
<a href="#l7.5641"></a><span id="l7.5641" class="difflineminus">-                  case 1: {</span>
<a href="#l7.5642"></a><span id="l7.5642" class="difflineminus">-                      dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5643"></a><span id="l7.5643" class="difflineminus">-                      dayEventsBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5644"></a><span id="l7.5644" class="difflineminus">-                      labelbox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5645"></a><span id="l7.5645" class="difflineminus">-                      break;</span>
<a href="#l7.5646"></a><span id="l7.5646" class="difflineminus">-                  }</span>
<a href="#l7.5647"></a><span id="l7.5647" class="difflineminus">-              }</span>
<a href="#l7.5648"></a><span id="l7.5648" class="difflineminus">-              // We don't want to actually mess with our original dates, plus</span>
<a href="#l7.5649"></a><span id="l7.5649" class="difflineminus">-              // they're likely to be immutable.</span>
<a href="#l7.5650"></a><span id="l7.5650" class="difflineminus">-              let date2 = date.clone();</span>
<a href="#l7.5651"></a><span id="l7.5651" class="difflineminus">-              date2.isDate = true;</span>
<a href="#l7.5652"></a><span id="l7.5652" class="difflineminus">-              date2.makeImmutable();</span>
<a href="#l7.5653"></a><span id="l7.5653" class="difflineminus">-              this.mDateColumns.push({ date: date2, column: dayEventsBox, header: dayHeaderBox });</span>
<a href="#l7.5654"></a><span id="l7.5654" class="difflineminus">-              counter++;</span>
<a href="#l7.5655"></a><span id="l7.5655" class="difflineminus">-          }</span>
<a href="#l7.5656"></a><span id="l7.5656" class="difflineminus">-</span>
<a href="#l7.5657"></a><span id="l7.5657" class="difflineminus">-          // Remove any extra columns that may have been hanging around</span>
<a href="#l7.5658"></a><span id="l7.5658" class="difflineminus">-          function removeExtraKids(elem) {</span>
<a href="#l7.5659"></a><span id="l7.5659" class="difflineminus">-              while (counter &lt; elem.childNodes.length) {</span>
<a href="#l7.5660"></a><span id="l7.5660" class="difflineminus">-                  elem.childNodes[counter].remove();</span>
<a href="#l7.5661"></a><span id="l7.5661" class="difflineminus">-              }</span>
<a href="#l7.5662"></a><span id="l7.5662" class="difflineminus">-          }</span>
<a href="#l7.5663"></a><span id="l7.5663" class="difflineminus">-          removeExtraKids(daybox);</span>
<a href="#l7.5664"></a><span id="l7.5664" class="difflineminus">-          removeExtraKids(headerdaybox);</span>
<a href="#l7.5665"></a><span id="l7.5665" class="difflineminus">-          removeExtraKids(this.labeldaybox);</span>
<a href="#l7.5666"></a><span id="l7.5666" class="difflineminus">-</span>
<a href="#l7.5667"></a><span id="l7.5667" class="difflineminus">-          if (updateTimeIndicator) {</span>
<a href="#l7.5668"></a><span id="l7.5668" class="difflineminus">-              this.updateTimeIndicatorPosition();</span>
<a href="#l7.5669"></a><span id="l7.5669" class="difflineminus">-          }</span>
<a href="#l7.5670"></a><span id="l7.5670" class="difflineminus">-</span>
<a href="#l7.5671"></a><span id="l7.5671" class="difflineminus">-          // fix pixels-per-minute</span>
<a href="#l7.5672"></a><span id="l7.5672" class="difflineminus">-          this.onResize();</span>
<a href="#l7.5673"></a><span id="l7.5673" class="difflineminus">-          if (this.mDateColumns) {</span>
<a href="#l7.5674"></a><span id="l7.5674" class="difflineminus">-              for (let col of this.mDateColumns) {</span>
<a href="#l7.5675"></a><span id="l7.5675" class="difflineminus">-                  col.column.endLayoutBatchChange();</span>
<a href="#l7.5676"></a><span id="l7.5676" class="difflineminus">-              }</span>
<a href="#l7.5677"></a><span id="l7.5677" class="difflineminus">-          }</span>
<a href="#l7.5678"></a><span id="l7.5678" class="difflineminus">-</span>
<a href="#l7.5679"></a><span id="l7.5679" class="difflineminus">-          // Adjust scrollbar spacers</span>
<a href="#l7.5680"></a><span id="l7.5680" class="difflineminus">-          this.adjustScrollBarSpacers();</span>
<a href="#l7.5681"></a><span id="l7.5681" class="difflineminus">-</span>
<a href="#l7.5682"></a><span id="l7.5682" class="difflineminus">-          // Store the start and end of current view. Next time when</span>
<a href="#l7.5683"></a><span id="l7.5683" class="difflineminus">-          // setDateRange is called, it will use mViewStart and mViewEnd to</span>
<a href="#l7.5684"></a><span id="l7.5684" class="difflineminus">-          // check if view range has been changed.</span>
<a href="#l7.5685"></a><span id="l7.5685" class="difflineminus">-          this.mViewStart = this.mStartDate;</span>
<a href="#l7.5686"></a><span id="l7.5686" class="difflineminus">-          this.mViewEnd = this.mEndDate;</span>
<a href="#l7.5687"></a><span id="l7.5687" class="difflineminus">-</span>
<a href="#l7.5688"></a><span id="l7.5688" class="difflineminus">-          let toggleStatus = 0;</span>
<a href="#l7.5689"></a><span id="l7.5689" class="difflineminus">-</span>
<a href="#l7.5690"></a><span id="l7.5690" class="difflineminus">-          if (this.mTasksInView) {</span>
<a href="#l7.5691"></a><span id="l7.5691" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l7.5692"></a><span id="l7.5692" class="difflineminus">-          }</span>
<a href="#l7.5693"></a><span id="l7.5693" class="difflineminus">-          if (this.mWorkdaysOnly) {</span>
<a href="#l7.5694"></a><span id="l7.5694" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l7.5695"></a><span id="l7.5695" class="difflineminus">-          }</span>
<a href="#l7.5696"></a><span id="l7.5696" class="difflineminus">-          if (this.mShowCompleted) {</span>
<a href="#l7.5697"></a><span id="l7.5697" class="difflineminus">-              toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l7.5698"></a><span id="l7.5698" class="difflineminus">-          }</span>
<a href="#l7.5699"></a><span id="l7.5699" class="difflineminus">-</span>
<a href="#l7.5700"></a><span id="l7.5700" class="difflineminus">-          this.mToggleStatus = toggleStatus;</span>
<a href="#l7.5701"></a><span id="l7.5701" class="difflineplus">+            if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l7.5702"></a><span id="l7.5702" class="difflineplus">+                return;</span>
<a href="#l7.5703"></a><span id="l7.5703" class="difflineplus">+            }</span>
<a href="#l7.5704"></a><span id="l7.5704" class="difflineplus">+</span>
<a href="#l7.5705"></a><span id="l7.5705" class="difflineplus">+            let orient = this.getAttribute(&quot;orient&quot;) || &quot;horizontal&quot;;</span>
<a href="#l7.5706"></a><span id="l7.5706" class="difflineplus">+            let otherorient = getOtherOrientation(orient);</span>
<a href="#l7.5707"></a><span id="l7.5707" class="difflineplus">+</span>
<a href="#l7.5708"></a><span id="l7.5708" class="difflineplus">+            let computedDateList = [];</span>
<a href="#l7.5709"></a><span id="l7.5709" class="difflineplus">+            let startDate = this.mStartDate.clone();</span>
<a href="#l7.5710"></a><span id="l7.5710" class="difflineplus">+            while (startDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5711"></a><span id="l7.5711" class="difflineplus">+                let workday = startDate.clone();</span>
<a href="#l7.5712"></a><span id="l7.5712" class="difflineplus">+                workday.makeImmutable();</span>
<a href="#l7.5713"></a><span id="l7.5713" class="difflineplus">+                if (this.mDisplayDaysOff) {</span>
<a href="#l7.5714"></a><span id="l7.5714" class="difflineplus">+                    computedDateList.push(workday);</span>
<a href="#l7.5715"></a><span id="l7.5715" class="difflineplus">+                } else if (!this.mDaysOffArray.includes(startDate.weekday)) {</span>
<a href="#l7.5716"></a><span id="l7.5716" class="difflineplus">+                    computedDateList.push(workday);</span>
<a href="#l7.5717"></a><span id="l7.5717" class="difflineplus">+                }</span>
<a href="#l7.5718"></a><span id="l7.5718" class="difflineplus">+                startDate.day += 1;</span>
<a href="#l7.5719"></a><span id="l7.5719" class="difflineplus">+            }</span>
<a href="#l7.5720"></a><span id="l7.5720" class="difflineplus">+            this.mDateList = computedDateList;</span>
<a href="#l7.5721"></a><span id="l7.5721" class="difflineplus">+</span>
<a href="#l7.5722"></a><span id="l7.5722" class="difflineplus">+            // unselect previous selected event upon switch views, otherwise those</span>
<a href="#l7.5723"></a><span id="l7.5723" class="difflineplus">+            // events will stay selected forever, if select other events after</span>
<a href="#l7.5724"></a><span id="l7.5724" class="difflineplus">+            // change week view.</span>
<a href="#l7.5725"></a><span id="l7.5725" class="difflineplus">+            this.setSelectedItems(0, [], true);</span>
<a href="#l7.5726"></a><span id="l7.5726" class="difflineplus">+</span>
<a href="#l7.5727"></a><span id="l7.5727" class="difflineplus">+            let daybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;daybox&quot;);</span>
<a href="#l7.5728"></a><span id="l7.5728" class="difflineplus">+            let headerdaybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.5729"></a><span id="l7.5729" class="difflineplus">+</span>
<a href="#l7.5730"></a><span id="l7.5730" class="difflineplus">+            let dayStartMin = this.mDayStartMin;</span>
<a href="#l7.5731"></a><span id="l7.5731" class="difflineplus">+            let dayEndMin = this.mDayEndMin;</span>
<a href="#l7.5732"></a><span id="l7.5732" class="difflineplus">+            let setUpDayEventsBox = (aDayBox, date) =&gt; {</span>
<a href="#l7.5733"></a><span id="l7.5733" class="difflineplus">+                aDayBox.setAttribute(&quot;class&quot;, &quot;calendar-event-column-&quot; + (counter % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l7.5734"></a><span id="l7.5734" class="difflineplus">+                aDayBox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.5735"></a><span id="l7.5735" class="difflineplus">+                aDayBox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l7.5736"></a><span id="l7.5736" class="difflineplus">+                aDayBox.startLayoutBatchChange();</span>
<a href="#l7.5737"></a><span id="l7.5737" class="difflineplus">+                aDayBox.date = date;</span>
<a href="#l7.5738"></a><span id="l7.5738" class="difflineplus">+                aDayBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l7.5739"></a><span id="l7.5739" class="difflineplus">+                aDayBox.calendarView = this;</span>
<a href="#l7.5740"></a><span id="l7.5740" class="difflineplus">+                aDayBox.setDayStartEndMinutes(dayStartMin, dayEndMin);</span>
<a href="#l7.5741"></a><span id="l7.5741" class="difflineplus">+            };</span>
<a href="#l7.5742"></a><span id="l7.5742" class="difflineplus">+</span>
<a href="#l7.5743"></a><span id="l7.5743" class="difflineplus">+            let setUpDayHeaderBox = (aDayBox, date) =&gt; {</span>
<a href="#l7.5744"></a><span id="l7.5744" class="difflineplus">+                aDayBox.date = date;</span>
<a href="#l7.5745"></a><span id="l7.5745" class="difflineplus">+                aDayBox.calendarView = this;</span>
<a href="#l7.5746"></a><span id="l7.5746" class="difflineplus">+                aDayBox.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l7.5747"></a><span id="l7.5747" class="difflineplus">+                // Since the calendar-header-container boxes have the same vertical</span>
<a href="#l7.5748"></a><span id="l7.5748" class="difflineplus">+                // orientation for normal and rotated views, it needs an attribute</span>
<a href="#l7.5749"></a><span id="l7.5749" class="difflineplus">+                // &quot;rotated&quot; in order to have different css rules.</span>
<a href="#l7.5750"></a><span id="l7.5750" class="difflineplus">+                setBooleanAttribute(aDayBox, &quot;rotated&quot;, orient == &quot;horizontal&quot;);</span>
<a href="#l7.5751"></a><span id="l7.5751" class="difflineplus">+            };</span>
<a href="#l7.5752"></a><span id="l7.5752" class="difflineplus">+</span>
<a href="#l7.5753"></a><span id="l7.5753" class="difflineplus">+            this.mDateColumns = [];</span>
<a href="#l7.5754"></a><span id="l7.5754" class="difflineplus">+</span>
<a href="#l7.5755"></a><span id="l7.5755" class="difflineplus">+</span>
<a href="#l7.5756"></a><span id="l7.5756" class="difflineplus">+            // get today's date</span>
<a href="#l7.5757"></a><span id="l7.5757" class="difflineplus">+            let today = this.today();</span>
<a href="#l7.5758"></a><span id="l7.5758" class="difflineplus">+            let counter = 0;</span>
<a href="#l7.5759"></a><span id="l7.5759" class="difflineplus">+            let dayboxkids = daybox.childNodes;</span>
<a href="#l7.5760"></a><span id="l7.5760" class="difflineplus">+            let headerboxkids = headerdaybox.childNodes;</span>
<a href="#l7.5761"></a><span id="l7.5761" class="difflineplus">+            let labelboxkids = this.labeldaybox.childNodes;</span>
<a href="#l7.5762"></a><span id="l7.5762" class="difflineplus">+            let updateTimeIndicator = false;</span>
<a href="#l7.5763"></a><span id="l7.5763" class="difflineplus">+</span>
<a href="#l7.5764"></a><span id="l7.5764" class="difflineplus">+            for (let date of computedDateList) {</span>
<a href="#l7.5765"></a><span id="l7.5765" class="difflineplus">+                let dayEventsBox;</span>
<a href="#l7.5766"></a><span id="l7.5766" class="difflineplus">+                if (counter &lt; dayboxkids.length) {</span>
<a href="#l7.5767"></a><span id="l7.5767" class="difflineplus">+                    dayEventsBox = dayboxkids[counter];</span>
<a href="#l7.5768"></a><span id="l7.5768" class="difflineplus">+                    dayEventsBox.removeAttribute(&quot;relation&quot;);</span>
<a href="#l7.5769"></a><span id="l7.5769" class="difflineplus">+                    dayEventsBox.mEventInfos = [];</span>
<a href="#l7.5770"></a><span id="l7.5770" class="difflineplus">+                } else {</span>
<a href="#l7.5771"></a><span id="l7.5771" class="difflineplus">+                    dayEventsBox = createXULElement(&quot;calendar-event-column&quot;);</span>
<a href="#l7.5772"></a><span id="l7.5772" class="difflineplus">+                    dayEventsBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.5773"></a><span id="l7.5773" class="difflineplus">+                    daybox.appendChild(dayEventsBox);</span>
<a href="#l7.5774"></a><span id="l7.5774" class="difflineplus">+                }</span>
<a href="#l7.5775"></a><span id="l7.5775" class="difflineplus">+                setUpDayEventsBox(dayEventsBox, date);</span>
<a href="#l7.5776"></a><span id="l7.5776" class="difflineplus">+</span>
<a href="#l7.5777"></a><span id="l7.5777" class="difflineplus">+                let dayHeaderBox;</span>
<a href="#l7.5778"></a><span id="l7.5778" class="difflineplus">+                if (counter &lt; headerboxkids.length) {</span>
<a href="#l7.5779"></a><span id="l7.5779" class="difflineplus">+                    dayHeaderBox = headerboxkids[counter];</span>
<a href="#l7.5780"></a><span id="l7.5780" class="difflineplus">+                    // Delete backwards to make sure we get them all</span>
<a href="#l7.5781"></a><span id="l7.5781" class="difflineplus">+                    // and delete until no more elements are left.</span>
<a href="#l7.5782"></a><span id="l7.5782" class="difflineplus">+                    while (dayHeaderBox.mItemBoxes.length != 0) {</span>
<a href="#l7.5783"></a><span id="l7.5783" class="difflineplus">+                        let num = dayHeaderBox.mItemBoxes.length;</span>
<a href="#l7.5784"></a><span id="l7.5784" class="difflineplus">+                        dayHeaderBox.deleteEvent(dayHeaderBox.mItemBoxes[num-1].occurrence);</span>
<a href="#l7.5785"></a><span id="l7.5785" class="difflineplus">+                    }</span>
<a href="#l7.5786"></a><span id="l7.5786" class="difflineplus">+                } else {</span>
<a href="#l7.5787"></a><span id="l7.5787" class="difflineplus">+                    dayHeaderBox = createXULElement(&quot;calendar-header-container&quot;);</span>
<a href="#l7.5788"></a><span id="l7.5788" class="difflineplus">+                    dayHeaderBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.5789"></a><span id="l7.5789" class="difflineplus">+                    headerdaybox.appendChild(dayHeaderBox);</span>
<a href="#l7.5790"></a><span id="l7.5790" class="difflineplus">+                }</span>
<a href="#l7.5791"></a><span id="l7.5791" class="difflineplus">+                setUpDayHeaderBox(dayHeaderBox, date);</span>
<a href="#l7.5792"></a><span id="l7.5792" class="difflineplus">+</span>
<a href="#l7.5793"></a><span id="l7.5793" class="difflineplus">+                if (this.mDaysOffArray.indexOf(date.weekday) &gt;= 0) {</span>
<a href="#l7.5794"></a><span id="l7.5794" class="difflineplus">+                    dayEventsBox.dayOff = true;</span>
<a href="#l7.5795"></a><span id="l7.5795" class="difflineplus">+                    dayHeaderBox.setAttribute(&quot;weekend&quot;, &quot;true&quot;);</span>
<a href="#l7.5796"></a><span id="l7.5796" class="difflineplus">+                } else {</span>
<a href="#l7.5797"></a><span id="l7.5797" class="difflineplus">+                    dayEventsBox.dayOff = false;</span>
<a href="#l7.5798"></a><span id="l7.5798" class="difflineplus">+                    dayHeaderBox.removeAttribute(&quot;weekend&quot;);</span>
<a href="#l7.5799"></a><span id="l7.5799" class="difflineplus">+                }</span>
<a href="#l7.5800"></a><span id="l7.5800" class="difflineplus">+                let labelbox;</span>
<a href="#l7.5801"></a><span id="l7.5801" class="difflineplus">+                if (counter &lt; labelboxkids.length) {</span>
<a href="#l7.5802"></a><span id="l7.5802" class="difflineplus">+                    labelbox = labelboxkids[counter];</span>
<a href="#l7.5803"></a><span id="l7.5803" class="difflineplus">+                    labelbox.date = date;</span>
<a href="#l7.5804"></a><span id="l7.5804" class="difflineplus">+                } else {</span>
<a href="#l7.5805"></a><span id="l7.5805" class="difflineplus">+                    labelbox = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l7.5806"></a><span id="l7.5806" class="difflineplus">+                    labelbox.setAttribute(&quot;orient&quot;, otherorient);</span>
<a href="#l7.5807"></a><span id="l7.5807" class="difflineplus">+                    this.labeldaybox.appendChild(labelbox);</span>
<a href="#l7.5808"></a><span id="l7.5808" class="difflineplus">+                    labelbox.date = date;</span>
<a href="#l7.5809"></a><span id="l7.5809" class="difflineplus">+                }</span>
<a href="#l7.5810"></a><span id="l7.5810" class="difflineplus">+                // Set attributes for date relations and for the time indicator.</span>
<a href="#l7.5811"></a><span id="l7.5811" class="difflineplus">+                let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.5812"></a><span id="l7.5812" class="difflineplus">+                                       this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.5813"></a><span id="l7.5813" class="difflineplus">+                headerDayBox.removeAttribute(&quot;todaylastinview&quot;);</span>
<a href="#l7.5814"></a><span id="l7.5814" class="difflineplus">+                dayEventsBox.timeIndicatorBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.5815"></a><span id="l7.5815" class="difflineplus">+                switch (date.compare(today)) {</span>
<a href="#l7.5816"></a><span id="l7.5816" class="difflineplus">+                    case -1: {</span>
<a href="#l7.5817"></a><span id="l7.5817" class="difflineplus">+                        dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5818"></a><span id="l7.5818" class="difflineplus">+                        dayEventsBox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5819"></a><span id="l7.5819" class="difflineplus">+                        labelbox.setAttribute(&quot;relation&quot;, &quot;past&quot;);</span>
<a href="#l7.5820"></a><span id="l7.5820" class="difflineplus">+                        break;</span>
<a href="#l7.5821"></a><span id="l7.5821" class="difflineplus">+                    }</span>
<a href="#l7.5822"></a><span id="l7.5822" class="difflineplus">+                    case 0: {</span>
<a href="#l7.5823"></a><span id="l7.5823" class="difflineplus">+                        let relation_ = this.numVisibleDates == 1 ? &quot;today1day&quot; : &quot;today&quot;;</span>
<a href="#l7.5824"></a><span id="l7.5824" class="difflineplus">+                        dayHeaderBox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5825"></a><span id="l7.5825" class="difflineplus">+                        dayEventsBox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5826"></a><span id="l7.5826" class="difflineplus">+                        labelbox.setAttribute(&quot;relation&quot;, relation_);</span>
<a href="#l7.5827"></a><span id="l7.5827" class="difflineplus">+                        setBooleanAttribute(dayEventsBox.timeIndicatorBox, &quot;hidden&quot;, this.mTimeIndicatorInterval == 0);</span>
<a href="#l7.5828"></a><span id="l7.5828" class="difflineplus">+                        updateTimeIndicator = true;</span>
<a href="#l7.5829"></a><span id="l7.5829" class="difflineplus">+</span>
<a href="#l7.5830"></a><span id="l7.5830" class="difflineplus">+                        // Due to equalsize=always being set on the dayboxes</span>
<a href="#l7.5831"></a><span id="l7.5831" class="difflineplus">+                        // parent, there are a few issues showing the border of</span>
<a href="#l7.5832"></a><span id="l7.5832" class="difflineplus">+                        // the last daybox correctly. To work around this, we're</span>
<a href="#l7.5833"></a><span id="l7.5833" class="difflineplus">+                        // setting an attribute we can use in CSS. For more</span>
<a href="#l7.5834"></a><span id="l7.5834" class="difflineplus">+                        // information about this hack, see bug 455045</span>
<a href="#l7.5835"></a><span id="l7.5835" class="difflineplus">+                        if (dayHeaderBox == headerdaybox.childNodes[headerdaybox.childNodes.length - 1] &amp;&amp;</span>
<a href="#l7.5836"></a><span id="l7.5836" class="difflineplus">+                            this.numVisibleDates &gt; 1) {</span>
<a href="#l7.5837"></a><span id="l7.5837" class="difflineplus">+                            headerDayBox.setAttribute(&quot;todaylastinview&quot;, &quot;true&quot;);</span>
<a href="#l7.5838"></a><span id="l7.5838" class="difflineplus">+                        }</span>
<a href="#l7.5839"></a><span id="l7.5839" class="difflineplus">+                        break;</span>
<a href="#l7.5840"></a><span id="l7.5840" class="difflineplus">+                    }</span>
<a href="#l7.5841"></a><span id="l7.5841" class="difflineplus">+                    case 1: {</span>
<a href="#l7.5842"></a><span id="l7.5842" class="difflineplus">+                        dayHeaderBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5843"></a><span id="l7.5843" class="difflineplus">+                        dayEventsBox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5844"></a><span id="l7.5844" class="difflineplus">+                        labelbox.setAttribute(&quot;relation&quot;, &quot;future&quot;);</span>
<a href="#l7.5845"></a><span id="l7.5845" class="difflineplus">+                        break;</span>
<a href="#l7.5846"></a><span id="l7.5846" class="difflineplus">+                    }</span>
<a href="#l7.5847"></a><span id="l7.5847" class="difflineplus">+                }</span>
<a href="#l7.5848"></a><span id="l7.5848" class="difflineplus">+                // We don't want to actually mess with our original dates, plus</span>
<a href="#l7.5849"></a><span id="l7.5849" class="difflineplus">+                // they're likely to be immutable.</span>
<a href="#l7.5850"></a><span id="l7.5850" class="difflineplus">+                let date2 = date.clone();</span>
<a href="#l7.5851"></a><span id="l7.5851" class="difflineplus">+                date2.isDate = true;</span>
<a href="#l7.5852"></a><span id="l7.5852" class="difflineplus">+                date2.makeImmutable();</span>
<a href="#l7.5853"></a><span id="l7.5853" class="difflineplus">+                this.mDateColumns.push({ date: date2, column: dayEventsBox, header: dayHeaderBox });</span>
<a href="#l7.5854"></a><span id="l7.5854" class="difflineplus">+                counter++;</span>
<a href="#l7.5855"></a><span id="l7.5855" class="difflineplus">+            }</span>
<a href="#l7.5856"></a><span id="l7.5856" class="difflineplus">+</span>
<a href="#l7.5857"></a><span id="l7.5857" class="difflineplus">+            // Remove any extra columns that may have been hanging around</span>
<a href="#l7.5858"></a><span id="l7.5858" class="difflineplus">+            function removeExtraKids(elem) {</span>
<a href="#l7.5859"></a><span id="l7.5859" class="difflineplus">+                while (counter &lt; elem.childNodes.length) {</span>
<a href="#l7.5860"></a><span id="l7.5860" class="difflineplus">+                    elem.childNodes[counter].remove();</span>
<a href="#l7.5861"></a><span id="l7.5861" class="difflineplus">+                }</span>
<a href="#l7.5862"></a><span id="l7.5862" class="difflineplus">+            }</span>
<a href="#l7.5863"></a><span id="l7.5863" class="difflineplus">+            removeExtraKids(daybox);</span>
<a href="#l7.5864"></a><span id="l7.5864" class="difflineplus">+            removeExtraKids(headerdaybox);</span>
<a href="#l7.5865"></a><span id="l7.5865" class="difflineplus">+            removeExtraKids(this.labeldaybox);</span>
<a href="#l7.5866"></a><span id="l7.5866" class="difflineplus">+</span>
<a href="#l7.5867"></a><span id="l7.5867" class="difflineplus">+            if (updateTimeIndicator) {</span>
<a href="#l7.5868"></a><span id="l7.5868" class="difflineplus">+                this.updateTimeIndicatorPosition();</span>
<a href="#l7.5869"></a><span id="l7.5869" class="difflineplus">+            }</span>
<a href="#l7.5870"></a><span id="l7.5870" class="difflineplus">+</span>
<a href="#l7.5871"></a><span id="l7.5871" class="difflineplus">+            // fix pixels-per-minute</span>
<a href="#l7.5872"></a><span id="l7.5872" class="difflineplus">+            this.onResize();</span>
<a href="#l7.5873"></a><span id="l7.5873" class="difflineplus">+            if (this.mDateColumns) {</span>
<a href="#l7.5874"></a><span id="l7.5874" class="difflineplus">+                for (let col of this.mDateColumns) {</span>
<a href="#l7.5875"></a><span id="l7.5875" class="difflineplus">+                    col.column.endLayoutBatchChange();</span>
<a href="#l7.5876"></a><span id="l7.5876" class="difflineplus">+                }</span>
<a href="#l7.5877"></a><span id="l7.5877" class="difflineplus">+            }</span>
<a href="#l7.5878"></a><span id="l7.5878" class="difflineplus">+</span>
<a href="#l7.5879"></a><span id="l7.5879" class="difflineplus">+            // Adjust scrollbar spacers</span>
<a href="#l7.5880"></a><span id="l7.5880" class="difflineplus">+            this.adjustScrollBarSpacers();</span>
<a href="#l7.5881"></a><span id="l7.5881" class="difflineplus">+</span>
<a href="#l7.5882"></a><span id="l7.5882" class="difflineplus">+            // Store the start and end of current view. Next time when</span>
<a href="#l7.5883"></a><span id="l7.5883" class="difflineplus">+            // setDateRange is called, it will use mViewStart and mViewEnd to</span>
<a href="#l7.5884"></a><span id="l7.5884" class="difflineplus">+            // check if view range has been changed.</span>
<a href="#l7.5885"></a><span id="l7.5885" class="difflineplus">+            this.mViewStart = this.mStartDate;</span>
<a href="#l7.5886"></a><span id="l7.5886" class="difflineplus">+            this.mViewEnd = this.mEndDate;</span>
<a href="#l7.5887"></a><span id="l7.5887" class="difflineplus">+</span>
<a href="#l7.5888"></a><span id="l7.5888" class="difflineplus">+            let toggleStatus = 0;</span>
<a href="#l7.5889"></a><span id="l7.5889" class="difflineplus">+</span>
<a href="#l7.5890"></a><span id="l7.5890" class="difflineplus">+            if (this.mTasksInView) {</span>
<a href="#l7.5891"></a><span id="l7.5891" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.TasksInView;</span>
<a href="#l7.5892"></a><span id="l7.5892" class="difflineplus">+            }</span>
<a href="#l7.5893"></a><span id="l7.5893" class="difflineplus">+            if (this.mWorkdaysOnly) {</span>
<a href="#l7.5894"></a><span id="l7.5894" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.WorkdaysOnly;</span>
<a href="#l7.5895"></a><span id="l7.5895" class="difflineplus">+            }</span>
<a href="#l7.5896"></a><span id="l7.5896" class="difflineplus">+            if (this.mShowCompleted) {</span>
<a href="#l7.5897"></a><span id="l7.5897" class="difflineplus">+                toggleStatus |= this.mToggleStatusFlag.ShowCompleted;</span>
<a href="#l7.5898"></a><span id="l7.5898" class="difflineplus">+            }</span>
<a href="#l7.5899"></a><span id="l7.5899" class="difflineplus">+</span>
<a href="#l7.5900"></a><span id="l7.5900" class="difflineplus">+            this.mToggleStatus = toggleStatus;</span>
<a href="#l7.5901"></a><span id="l7.5901">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5902"></a><span id="l7.5902">       &lt;/method&gt;</span>
<a href="#l7.5903"></a><span id="l7.5903"> </span>
<a href="#l7.5904"></a><span id="l7.5904">       &lt;method name=&quot;findColumnForDate&quot;&gt;</span>
<a href="#l7.5905"></a><span id="l7.5905">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l7.5906"></a><span id="l7.5906">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5907"></a><span id="l7.5907" class="difflineminus">-          if (!this.mDateColumns) {</span>
<a href="#l7.5908"></a><span id="l7.5908" class="difflineminus">-              return null;</span>
<a href="#l7.5909"></a><span id="l7.5909" class="difflineminus">-          }</span>
<a href="#l7.5910"></a><span id="l7.5910" class="difflineminus">-          for (let col of this.mDateColumns) {</span>
<a href="#l7.5911"></a><span id="l7.5911" class="difflineminus">-              if (col.date.compare(aDate) == 0) {</span>
<a href="#l7.5912"></a><span id="l7.5912" class="difflineminus">-                  return col;</span>
<a href="#l7.5913"></a><span id="l7.5913" class="difflineminus">-              }</span>
<a href="#l7.5914"></a><span id="l7.5914" class="difflineminus">-          }</span>
<a href="#l7.5915"></a><span id="l7.5915" class="difflineminus">-          return null;</span>
<a href="#l7.5916"></a><span id="l7.5916" class="difflineplus">+            if (!this.mDateColumns) {</span>
<a href="#l7.5917"></a><span id="l7.5917" class="difflineplus">+                return null;</span>
<a href="#l7.5918"></a><span id="l7.5918" class="difflineplus">+            }</span>
<a href="#l7.5919"></a><span id="l7.5919" class="difflineplus">+            for (let col of this.mDateColumns) {</span>
<a href="#l7.5920"></a><span id="l7.5920" class="difflineplus">+                if (col.date.compare(aDate) == 0) {</span>
<a href="#l7.5921"></a><span id="l7.5921" class="difflineplus">+                    return col;</span>
<a href="#l7.5922"></a><span id="l7.5922" class="difflineplus">+                }</span>
<a href="#l7.5923"></a><span id="l7.5923" class="difflineplus">+            }</span>
<a href="#l7.5924"></a><span id="l7.5924" class="difflineplus">+            return null;</span>
<a href="#l7.5925"></a><span id="l7.5925">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5926"></a><span id="l7.5926">       &lt;/method&gt;</span>
<a href="#l7.5927"></a><span id="l7.5927"> </span>
<a href="#l7.5928"></a><span id="l7.5928">       &lt;method name=&quot;findDayBoxForDate&quot;&gt;</span>
<a href="#l7.5929"></a><span id="l7.5929">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l7.5930"></a><span id="l7.5930">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5931"></a><span id="l7.5931" class="difflineminus">-          let col = this.findColumnForDate(aDate);</span>
<a href="#l7.5932"></a><span id="l7.5932" class="difflineminus">-          return (col &amp;&amp; col.header);</span>
<a href="#l7.5933"></a><span id="l7.5933" class="difflineplus">+            let col = this.findColumnForDate(aDate);</span>
<a href="#l7.5934"></a><span id="l7.5934" class="difflineplus">+            return (col &amp;&amp; col.header);</span>
<a href="#l7.5935"></a><span id="l7.5935">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5936"></a><span id="l7.5936">       &lt;/method&gt;</span>
<a href="#l7.5937"></a><span id="l7.5937"> </span>
<a href="#l7.5938"></a><span id="l7.5938">       &lt;method name=&quot;selectColumnHeader&quot;&gt;</span>
<a href="#l7.5939"></a><span id="l7.5939">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l7.5940"></a><span id="l7.5940">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5941"></a><span id="l7.5941" class="difflineminus">-          let child = this.labeldaybox.firstChild;</span>
<a href="#l7.5942"></a><span id="l7.5942" class="difflineminus">-          while (child) {</span>
<a href="#l7.5943"></a><span id="l7.5943" class="difflineminus">-              if (child.date.compare(aDate) == 0) {</span>
<a href="#l7.5944"></a><span id="l7.5944" class="difflineminus">-                  child.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.5945"></a><span id="l7.5945" class="difflineminus">-              } else {</span>
<a href="#l7.5946"></a><span id="l7.5946" class="difflineminus">-                  child.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.5947"></a><span id="l7.5947" class="difflineminus">-              }</span>
<a href="#l7.5948"></a><span id="l7.5948" class="difflineminus">-              child = child.nextSibling;</span>
<a href="#l7.5949"></a><span id="l7.5949" class="difflineminus">-          }</span>
<a href="#l7.5950"></a><span id="l7.5950" class="difflineplus">+            let child = this.labeldaybox.firstChild;</span>
<a href="#l7.5951"></a><span id="l7.5951" class="difflineplus">+            while (child) {</span>
<a href="#l7.5952"></a><span id="l7.5952" class="difflineplus">+                if (child.date.compare(aDate) == 0) {</span>
<a href="#l7.5953"></a><span id="l7.5953" class="difflineplus">+                    child.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l7.5954"></a><span id="l7.5954" class="difflineplus">+                } else {</span>
<a href="#l7.5955"></a><span id="l7.5955" class="difflineplus">+                    child.removeAttribute(&quot;selected&quot;);</span>
<a href="#l7.5956"></a><span id="l7.5956" class="difflineplus">+                }</span>
<a href="#l7.5957"></a><span id="l7.5957" class="difflineplus">+                child = child.nextSibling;</span>
<a href="#l7.5958"></a><span id="l7.5958" class="difflineplus">+            }</span>
<a href="#l7.5959"></a><span id="l7.5959">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.5960"></a><span id="l7.5960">       &lt;/method&gt;</span>
<a href="#l7.5961"></a><span id="l7.5961"> </span>
<a href="#l7.5962"></a><span id="l7.5962">       &lt;method name=&quot;findColumnsForOccurrences&quot;&gt;</span>
<a href="#l7.5963"></a><span id="l7.5963">         &lt;parameter name=&quot;aOccurrences&quot;/&gt;</span>
<a href="#l7.5964"></a><span id="l7.5964">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.5965"></a><span id="l7.5965" class="difflineminus">-          if (!this.mDateColumns || !this.mDateColumns.length) {</span>
<a href="#l7.5966"></a><span id="l7.5966" class="difflineminus">-              return [];</span>
<a href="#l7.5967"></a><span id="l7.5967" class="difflineminus">-          }</span>
<a href="#l7.5968"></a><span id="l7.5968" class="difflineminus">-</span>
<a href="#l7.5969"></a><span id="l7.5969" class="difflineminus">-          let occMap = {};</span>
<a href="#l7.5970"></a><span id="l7.5970" class="difflineminus">-          for (let occ of aOccurrences) {</span>
<a href="#l7.5971"></a><span id="l7.5971" class="difflineminus">-              let startDate = occ[cal.calGetStartDateProp(occ)]</span>
<a href="#l7.5972"></a><span id="l7.5972" class="difflineminus">-                              .getInTimezone(this.mStartDate.timezone);</span>
<a href="#l7.5973"></a><span id="l7.5973" class="difflineminus">-              let endDate = occ[cal.calGetEndDateProp(occ)]</span>
<a href="#l7.5974"></a><span id="l7.5974" class="difflineminus">-                              .getInTimezone(this.mEndDate.timezone) || startDate;</span>
<a href="#l7.5975"></a><span id="l7.5975" class="difflineminus">-              if (startDate.compare(this.mStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l7.5976"></a><span id="l7.5976" class="difflineminus">-                  endDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5977"></a><span id="l7.5977" class="difflineminus">-                  for (let i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l7.5978"></a><span id="l7.5978" class="difflineminus">-                      occMap[i] = true;</span>
<a href="#l7.5979"></a><span id="l7.5979" class="difflineminus">-                  }</span>
<a href="#l7.5980"></a><span id="l7.5980" class="difflineminus">-              }</span>
<a href="#l7.5981"></a><span id="l7.5981" class="difflineminus">-          }</span>
<a href="#l7.5982"></a><span id="l7.5982" class="difflineminus">-</span>
<a href="#l7.5983"></a><span id="l7.5983" class="difflineminus">-          return this.mDateColumns.filter(col =&gt; col.date.day in occMap);</span>
<a href="#l7.5984"></a><span id="l7.5984" class="difflineplus">+            if (!this.mDateColumns || !this.mDateColumns.length) {</span>
<a href="#l7.5985"></a><span id="l7.5985" class="difflineplus">+                return [];</span>
<a href="#l7.5986"></a><span id="l7.5986" class="difflineplus">+            }</span>
<a href="#l7.5987"></a><span id="l7.5987" class="difflineplus">+</span>
<a href="#l7.5988"></a><span id="l7.5988" class="difflineplus">+            let occMap = {};</span>
<a href="#l7.5989"></a><span id="l7.5989" class="difflineplus">+            for (let occ of aOccurrences) {</span>
<a href="#l7.5990"></a><span id="l7.5990" class="difflineplus">+                let startDate = occ[cal.calGetStartDateProp(occ)]</span>
<a href="#l7.5991"></a><span id="l7.5991" class="difflineplus">+                                .getInTimezone(this.mStartDate.timezone);</span>
<a href="#l7.5992"></a><span id="l7.5992" class="difflineplus">+                let endDate = occ[cal.calGetEndDateProp(occ)]</span>
<a href="#l7.5993"></a><span id="l7.5993" class="difflineplus">+                                .getInTimezone(this.mEndDate.timezone) || startDate;</span>
<a href="#l7.5994"></a><span id="l7.5994" class="difflineplus">+                if (startDate.compare(this.mStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l7.5995"></a><span id="l7.5995" class="difflineplus">+                    endDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l7.5996"></a><span id="l7.5996" class="difflineplus">+                    for (let i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l7.5997"></a><span id="l7.5997" class="difflineplus">+                        occMap[i] = true;</span>
<a href="#l7.5998"></a><span id="l7.5998" class="difflineplus">+                    }</span>
<a href="#l7.5999"></a><span id="l7.5999" class="difflineplus">+                }</span>
<a href="#l7.6000"></a><span id="l7.6000" class="difflineplus">+            }</span>
<a href="#l7.6001"></a><span id="l7.6001" class="difflineplus">+</span>
<a href="#l7.6002"></a><span id="l7.6002" class="difflineplus">+            return this.mDateColumns.filter(col =&gt; col.date.day in occMap);</span>
<a href="#l7.6003"></a><span id="l7.6003">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6004"></a><span id="l7.6004">       &lt;/method&gt;</span>
<a href="#l7.6005"></a><span id="l7.6005"> </span>
<a href="#l7.6006"></a><span id="l7.6006">       &lt;method name=&quot;findColumnsForItem&quot;&gt;</span>
<a href="#l7.6007"></a><span id="l7.6007">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l7.6008"></a><span id="l7.6008">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6009"></a><span id="l7.6009" class="difflineminus">-          let columns = [];</span>
<a href="#l7.6010"></a><span id="l7.6010" class="difflineminus">-</span>
<a href="#l7.6011"></a><span id="l7.6011" class="difflineminus">-          if (!this.mDateColumns) {</span>
<a href="#l7.6012"></a><span id="l7.6012" class="difflineminus">-              return columns;</span>
<a href="#l7.6013"></a><span id="l7.6013" class="difflineminus">-          }</span>
<a href="#l7.6014"></a><span id="l7.6014" class="difflineminus">-</span>
<a href="#l7.6015"></a><span id="l7.6015" class="difflineminus">-          // Note that these may be dates or datetimes</span>
<a href="#l7.6016"></a><span id="l7.6016" class="difflineminus">-          let startDate = aItem.startDate || aItem.entryDate || aItem.dueDate;</span>
<a href="#l7.6017"></a><span id="l7.6017" class="difflineminus">-          if (!startDate) {</span>
<a href="#l7.6018"></a><span id="l7.6018" class="difflineminus">-              return columns;</span>
<a href="#l7.6019"></a><span id="l7.6019" class="difflineminus">-          }</span>
<a href="#l7.6020"></a><span id="l7.6020" class="difflineminus">-          let timezone = this.mDateColumns[0].date.timezone;</span>
<a href="#l7.6021"></a><span id="l7.6021" class="difflineminus">-          let targetDate = startDate.getInTimezone(timezone);</span>
<a href="#l7.6022"></a><span id="l7.6022" class="difflineminus">-          let finishDate = (aItem.endDate || aItem.dueDate || aItem.entryDate || startDate)</span>
<a href="#l7.6023"></a><span id="l7.6023" class="difflineminus">-                               .getInTimezone(timezone);</span>
<a href="#l7.6024"></a><span id="l7.6024" class="difflineminus">-</span>
<a href="#l7.6025"></a><span id="l7.6025" class="difflineminus">-          if (!targetDate.isDate) {</span>
<a href="#l7.6026"></a><span id="l7.6026" class="difflineminus">-              // Set the time to 00:00 so that we get all the boxes</span>
<a href="#l7.6027"></a><span id="l7.6027" class="difflineminus">-              targetDate.hour = 0;</span>
<a href="#l7.6028"></a><span id="l7.6028" class="difflineminus">-              targetDate.minute = 0;</span>
<a href="#l7.6029"></a><span id="l7.6029" class="difflineminus">-              targetDate.second = 0;</span>
<a href="#l7.6030"></a><span id="l7.6030" class="difflineminus">-          }</span>
<a href="#l7.6031"></a><span id="l7.6031" class="difflineminus">-</span>
<a href="#l7.6032"></a><span id="l7.6032" class="difflineminus">-          if (targetDate.compare(finishDate) == 0) {</span>
<a href="#l7.6033"></a><span id="l7.6033" class="difflineminus">-              // We have also to handle zero length events in particular for</span>
<a href="#l7.6034"></a><span id="l7.6034" class="difflineminus">-              // tasks without entry or due date.</span>
<a href="#l7.6035"></a><span id="l7.6035" class="difflineminus">-              let col = this.findColumnForDate(targetDate);</span>
<a href="#l7.6036"></a><span id="l7.6036" class="difflineminus">-              if (col) {</span>
<a href="#l7.6037"></a><span id="l7.6037" class="difflineminus">-                  columns.push(col);</span>
<a href="#l7.6038"></a><span id="l7.6038" class="difflineminus">-              }</span>
<a href="#l7.6039"></a><span id="l7.6039" class="difflineminus">-          }</span>
<a href="#l7.6040"></a><span id="l7.6040" class="difflineminus">-</span>
<a href="#l7.6041"></a><span id="l7.6041" class="difflineminus">-          while (targetDate.compare(finishDate) == -1) {</span>
<a href="#l7.6042"></a><span id="l7.6042" class="difflineminus">-              let col = this.findColumnForDate(targetDate);</span>
<a href="#l7.6043"></a><span id="l7.6043" class="difflineminus">-</span>
<a href="#l7.6044"></a><span id="l7.6044" class="difflineminus">-              // This might not exist if the event spans the view start or end</span>
<a href="#l7.6045"></a><span id="l7.6045" class="difflineminus">-              if (col) {</span>
<a href="#l7.6046"></a><span id="l7.6046" class="difflineminus">-                  columns.push(col);</span>
<a href="#l7.6047"></a><span id="l7.6047" class="difflineminus">-              }</span>
<a href="#l7.6048"></a><span id="l7.6048" class="difflineminus">-              targetDate.day += 1;</span>
<a href="#l7.6049"></a><span id="l7.6049" class="difflineminus">-          }</span>
<a href="#l7.6050"></a><span id="l7.6050" class="difflineminus">-</span>
<a href="#l7.6051"></a><span id="l7.6051" class="difflineminus">-          return columns;</span>
<a href="#l7.6052"></a><span id="l7.6052" class="difflineplus">+            let columns = [];</span>
<a href="#l7.6053"></a><span id="l7.6053" class="difflineplus">+</span>
<a href="#l7.6054"></a><span id="l7.6054" class="difflineplus">+            if (!this.mDateColumns) {</span>
<a href="#l7.6055"></a><span id="l7.6055" class="difflineplus">+                return columns;</span>
<a href="#l7.6056"></a><span id="l7.6056" class="difflineplus">+            }</span>
<a href="#l7.6057"></a><span id="l7.6057" class="difflineplus">+</span>
<a href="#l7.6058"></a><span id="l7.6058" class="difflineplus">+            // Note that these may be dates or datetimes</span>
<a href="#l7.6059"></a><span id="l7.6059" class="difflineplus">+            let startDate = aItem.startDate || aItem.entryDate || aItem.dueDate;</span>
<a href="#l7.6060"></a><span id="l7.6060" class="difflineplus">+            if (!startDate) {</span>
<a href="#l7.6061"></a><span id="l7.6061" class="difflineplus">+                return columns;</span>
<a href="#l7.6062"></a><span id="l7.6062" class="difflineplus">+            }</span>
<a href="#l7.6063"></a><span id="l7.6063" class="difflineplus">+            let timezone = this.mDateColumns[0].date.timezone;</span>
<a href="#l7.6064"></a><span id="l7.6064" class="difflineplus">+            let targetDate = startDate.getInTimezone(timezone);</span>
<a href="#l7.6065"></a><span id="l7.6065" class="difflineplus">+            let finishDate = (aItem.endDate || aItem.dueDate || aItem.entryDate || startDate)</span>
<a href="#l7.6066"></a><span id="l7.6066" class="difflineplus">+                                 .getInTimezone(timezone);</span>
<a href="#l7.6067"></a><span id="l7.6067" class="difflineplus">+</span>
<a href="#l7.6068"></a><span id="l7.6068" class="difflineplus">+            if (!targetDate.isDate) {</span>
<a href="#l7.6069"></a><span id="l7.6069" class="difflineplus">+                // Set the time to 00:00 so that we get all the boxes</span>
<a href="#l7.6070"></a><span id="l7.6070" class="difflineplus">+                targetDate.hour = 0;</span>
<a href="#l7.6071"></a><span id="l7.6071" class="difflineplus">+                targetDate.minute = 0;</span>
<a href="#l7.6072"></a><span id="l7.6072" class="difflineplus">+                targetDate.second = 0;</span>
<a href="#l7.6073"></a><span id="l7.6073" class="difflineplus">+            }</span>
<a href="#l7.6074"></a><span id="l7.6074" class="difflineplus">+</span>
<a href="#l7.6075"></a><span id="l7.6075" class="difflineplus">+            if (targetDate.compare(finishDate) == 0) {</span>
<a href="#l7.6076"></a><span id="l7.6076" class="difflineplus">+                // We have also to handle zero length events in particular for</span>
<a href="#l7.6077"></a><span id="l7.6077" class="difflineplus">+                // tasks without entry or due date.</span>
<a href="#l7.6078"></a><span id="l7.6078" class="difflineplus">+                let col = this.findColumnForDate(targetDate);</span>
<a href="#l7.6079"></a><span id="l7.6079" class="difflineplus">+                if (col) {</span>
<a href="#l7.6080"></a><span id="l7.6080" class="difflineplus">+                    columns.push(col);</span>
<a href="#l7.6081"></a><span id="l7.6081" class="difflineplus">+                }</span>
<a href="#l7.6082"></a><span id="l7.6082" class="difflineplus">+            }</span>
<a href="#l7.6083"></a><span id="l7.6083" class="difflineplus">+</span>
<a href="#l7.6084"></a><span id="l7.6084" class="difflineplus">+            while (targetDate.compare(finishDate) == -1) {</span>
<a href="#l7.6085"></a><span id="l7.6085" class="difflineplus">+                let col = this.findColumnForDate(targetDate);</span>
<a href="#l7.6086"></a><span id="l7.6086" class="difflineplus">+</span>
<a href="#l7.6087"></a><span id="l7.6087" class="difflineplus">+                // This might not exist if the event spans the view start or end</span>
<a href="#l7.6088"></a><span id="l7.6088" class="difflineplus">+                if (col) {</span>
<a href="#l7.6089"></a><span id="l7.6089" class="difflineplus">+                    columns.push(col);</span>
<a href="#l7.6090"></a><span id="l7.6090" class="difflineplus">+                }</span>
<a href="#l7.6091"></a><span id="l7.6091" class="difflineplus">+                targetDate.day += 1;</span>
<a href="#l7.6092"></a><span id="l7.6092" class="difflineplus">+            }</span>
<a href="#l7.6093"></a><span id="l7.6093" class="difflineplus">+</span>
<a href="#l7.6094"></a><span id="l7.6094" class="difflineplus">+            return columns;</span>
<a href="#l7.6095"></a><span id="l7.6095">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6096"></a><span id="l7.6096">       &lt;/method&gt;</span>
<a href="#l7.6097"></a><span id="l7.6097"> </span>
<a href="#l7.6098"></a><span id="l7.6098">       &lt;!-- for the given client-coord-system point, return</span>
<a href="#l7.6099"></a><span id="l7.6099">          - the calendar-event-column that contains it.  If</span>
<a href="#l7.6100"></a><span id="l7.6100">          - no column contains it, return null.</span>
<a href="#l7.6101"></a><span id="l7.6101">         --&gt;</span>
<a href="#l7.6102"></a><span id="l7.6102">       &lt;method name=&quot;findColumnForClientPoint&quot;&gt;</span>
<a href="#l7.6103"></a><span id="l7.6103">         &lt;parameter name=&quot;aClientX&quot;/&gt;</span>
<a href="#l7.6104"></a><span id="l7.6104">         &lt;parameter name=&quot;aClientY&quot;/&gt;</span>
<a href="#l7.6105"></a><span id="l7.6105">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6106"></a><span id="l7.6106" class="difflineminus">-          if (!this.mDateColumns) {</span>
<a href="#l7.6107"></a><span id="l7.6107" class="difflineminus">-              return null;</span>
<a href="#l7.6108"></a><span id="l7.6108" class="difflineminus">-          }</span>
<a href="#l7.6109"></a><span id="l7.6109" class="difflineminus">-          for (let col of this.mDateColumns) {</span>
<a href="#l7.6110"></a><span id="l7.6110" class="difflineminus">-              let boxObject = document.getAnonymousElementByAttribute(col.column, &quot;anonid&quot;, &quot;boxstack&quot;).boxObject;</span>
<a href="#l7.6111"></a><span id="l7.6111" class="difflineminus">-              if (aClientX &gt;= boxObject.screenX &amp;&amp;</span>
<a href="#l7.6112"></a><span id="l7.6112" class="difflineminus">-                  aClientX &lt;= (boxObject.screenX + boxObject.width) &amp;&amp;</span>
<a href="#l7.6113"></a><span id="l7.6113" class="difflineminus">-                  aClientY &gt;= boxObject.screenY &amp;&amp;</span>
<a href="#l7.6114"></a><span id="l7.6114" class="difflineminus">-                  aClientY &lt;= (boxObject.screenY + boxObject.height)) {</span>
<a href="#l7.6115"></a><span id="l7.6115" class="difflineminus">-                  return col.column;</span>
<a href="#l7.6116"></a><span id="l7.6116" class="difflineminus">-              }</span>
<a href="#l7.6117"></a><span id="l7.6117" class="difflineminus">-          }</span>
<a href="#l7.6118"></a><span id="l7.6118" class="difflineminus">-          return null;</span>
<a href="#l7.6119"></a><span id="l7.6119" class="difflineplus">+            if (!this.mDateColumns) {</span>
<a href="#l7.6120"></a><span id="l7.6120" class="difflineplus">+                return null;</span>
<a href="#l7.6121"></a><span id="l7.6121" class="difflineplus">+            }</span>
<a href="#l7.6122"></a><span id="l7.6122" class="difflineplus">+            for (let col of this.mDateColumns) {</span>
<a href="#l7.6123"></a><span id="l7.6123" class="difflineplus">+                let boxObject = document.getAnonymousElementByAttribute(col.column, &quot;anonid&quot;, &quot;boxstack&quot;).boxObject;</span>
<a href="#l7.6124"></a><span id="l7.6124" class="difflineplus">+                if (aClientX &gt;= boxObject.screenX &amp;&amp;</span>
<a href="#l7.6125"></a><span id="l7.6125" class="difflineplus">+                    aClientX &lt;= (boxObject.screenX + boxObject.width) &amp;&amp;</span>
<a href="#l7.6126"></a><span id="l7.6126" class="difflineplus">+                    aClientY &gt;= boxObject.screenY &amp;&amp;</span>
<a href="#l7.6127"></a><span id="l7.6127" class="difflineplus">+                    aClientY &lt;= (boxObject.screenY + boxObject.height)) {</span>
<a href="#l7.6128"></a><span id="l7.6128" class="difflineplus">+                    return col.column;</span>
<a href="#l7.6129"></a><span id="l7.6129" class="difflineplus">+                }</span>
<a href="#l7.6130"></a><span id="l7.6130" class="difflineplus">+            }</span>
<a href="#l7.6131"></a><span id="l7.6131" class="difflineplus">+            return null;</span>
<a href="#l7.6132"></a><span id="l7.6132">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6133"></a><span id="l7.6133">       &lt;/method&gt;</span>
<a href="#l7.6134"></a><span id="l7.6134"> </span>
<a href="#l7.6135"></a><span id="l7.6135">       &lt;method name=&quot;adjustScrollbarSpacersForAlldayEvents&quot;&gt;</span>
<a href="#l7.6136"></a><span id="l7.6136">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l7.6137"></a><span id="l7.6137">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6138"></a><span id="l7.6138" class="difflineminus">-          let startDate = aEvent[cal.calGetStartDateProp(aEvent)];</span>
<a href="#l7.6139"></a><span id="l7.6139" class="difflineminus">-          let endDate = aEvent[cal.calGetEndDateProp(aEvent)];</span>
<a href="#l7.6140"></a><span id="l7.6140" class="difflineminus">-          if ((startDate &amp;&amp; startDate.isDate) ||</span>
<a href="#l7.6141"></a><span id="l7.6141" class="difflineminus">-              (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l7.6142"></a><span id="l7.6142" class="difflineminus">-              // If this is an all day event, then the header with allday</span>
<a href="#l7.6143"></a><span id="l7.6143" class="difflineminus">-              // events could possibly get a scrollbar. Readjust them.</span>
<a href="#l7.6144"></a><span id="l7.6144" class="difflineminus">-              this.adjustScrollBarSpacers();</span>
<a href="#l7.6145"></a><span id="l7.6145" class="difflineminus">-          }</span>
<a href="#l7.6146"></a><span id="l7.6146" class="difflineplus">+            let startDate = aEvent[cal.calGetStartDateProp(aEvent)];</span>
<a href="#l7.6147"></a><span id="l7.6147" class="difflineplus">+            let endDate = aEvent[cal.calGetEndDateProp(aEvent)];</span>
<a href="#l7.6148"></a><span id="l7.6148" class="difflineplus">+            if ((startDate &amp;&amp; startDate.isDate) ||</span>
<a href="#l7.6149"></a><span id="l7.6149" class="difflineplus">+                (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l7.6150"></a><span id="l7.6150" class="difflineplus">+                // If this is an all day event, then the header with allday</span>
<a href="#l7.6151"></a><span id="l7.6151" class="difflineplus">+                // events could possibly get a scrollbar. Readjust them.</span>
<a href="#l7.6152"></a><span id="l7.6152" class="difflineplus">+                this.adjustScrollBarSpacers();</span>
<a href="#l7.6153"></a><span id="l7.6153" class="difflineplus">+            }</span>
<a href="#l7.6154"></a><span id="l7.6154">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6155"></a><span id="l7.6155">       &lt;/method&gt;</span>
<a href="#l7.6156"></a><span id="l7.6156"> </span>
<a href="#l7.6157"></a><span id="l7.6157">       &lt;method name=&quot;doAddItem&quot;&gt;</span>
<a href="#l7.6158"></a><span id="l7.6158">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l7.6159"></a><span id="l7.6159">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6160"></a><span id="l7.6160" class="difflineminus">-          let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l7.6161"></a><span id="l7.6161" class="difflineminus">-          if (!cols.length) {</span>
<a href="#l7.6162"></a><span id="l7.6162" class="difflineminus">-              return;</span>
<a href="#l7.6163"></a><span id="l7.6163" class="difflineminus">-          }</span>
<a href="#l7.6164"></a><span id="l7.6164" class="difflineminus">-</span>
<a href="#l7.6165"></a><span id="l7.6165" class="difflineminus">-          for (let col of cols) {</span>
<a href="#l7.6166"></a><span id="l7.6166" class="difflineminus">-              let column = col.column;</span>
<a href="#l7.6167"></a><span id="l7.6167" class="difflineminus">-              let header = col.header;</span>
<a href="#l7.6168"></a><span id="l7.6168" class="difflineminus">-</span>
<a href="#l7.6169"></a><span id="l7.6169" class="difflineminus">-              let estart = aEvent.startDate || aEvent.entryDate || aEvent.dueDate;</span>
<a href="#l7.6170"></a><span id="l7.6170" class="difflineminus">-              if (estart.isDate) {</span>
<a href="#l7.6171"></a><span id="l7.6171" class="difflineminus">-                  header.addEvent(aEvent);</span>
<a href="#l7.6172"></a><span id="l7.6172" class="difflineminus">-              } else {</span>
<a href="#l7.6173"></a><span id="l7.6173" class="difflineminus">-                  column.addEvent(aEvent);</span>
<a href="#l7.6174"></a><span id="l7.6174" class="difflineminus">-              }</span>
<a href="#l7.6175"></a><span id="l7.6175" class="difflineminus">-          }</span>
<a href="#l7.6176"></a><span id="l7.6176" class="difflineminus">-</span>
<a href="#l7.6177"></a><span id="l7.6177" class="difflineminus">-          this.adjustScrollbarSpacersForAlldayEvents(aEvent);</span>
<a href="#l7.6178"></a><span id="l7.6178" class="difflineplus">+            let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l7.6179"></a><span id="l7.6179" class="difflineplus">+            if (!cols.length) {</span>
<a href="#l7.6180"></a><span id="l7.6180" class="difflineplus">+                return;</span>
<a href="#l7.6181"></a><span id="l7.6181" class="difflineplus">+            }</span>
<a href="#l7.6182"></a><span id="l7.6182" class="difflineplus">+</span>
<a href="#l7.6183"></a><span id="l7.6183" class="difflineplus">+            for (let col of cols) {</span>
<a href="#l7.6184"></a><span id="l7.6184" class="difflineplus">+                let column = col.column;</span>
<a href="#l7.6185"></a><span id="l7.6185" class="difflineplus">+                let header = col.header;</span>
<a href="#l7.6186"></a><span id="l7.6186" class="difflineplus">+</span>
<a href="#l7.6187"></a><span id="l7.6187" class="difflineplus">+                let estart = aEvent.startDate || aEvent.entryDate || aEvent.dueDate;</span>
<a href="#l7.6188"></a><span id="l7.6188" class="difflineplus">+                if (estart.isDate) {</span>
<a href="#l7.6189"></a><span id="l7.6189" class="difflineplus">+                    header.addEvent(aEvent);</span>
<a href="#l7.6190"></a><span id="l7.6190" class="difflineplus">+                } else {</span>
<a href="#l7.6191"></a><span id="l7.6191" class="difflineplus">+                    column.addEvent(aEvent);</span>
<a href="#l7.6192"></a><span id="l7.6192" class="difflineplus">+                }</span>
<a href="#l7.6193"></a><span id="l7.6193" class="difflineplus">+            }</span>
<a href="#l7.6194"></a><span id="l7.6194" class="difflineplus">+</span>
<a href="#l7.6195"></a><span id="l7.6195" class="difflineplus">+            this.adjustScrollbarSpacersForAlldayEvents(aEvent);</span>
<a href="#l7.6196"></a><span id="l7.6196">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6197"></a><span id="l7.6197">       &lt;/method&gt;</span>
<a href="#l7.6198"></a><span id="l7.6198"> </span>
<a href="#l7.6199"></a><span id="l7.6199">       &lt;method name=&quot;doDeleteItem&quot;&gt;</span>
<a href="#l7.6200"></a><span id="l7.6200">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l7.6201"></a><span id="l7.6201">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6202"></a><span id="l7.6202" class="difflineminus">-          let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l7.6203"></a><span id="l7.6203" class="difflineminus">-          if (!cols.length) {</span>
<a href="#l7.6204"></a><span id="l7.6204" class="difflineminus">-              return;</span>
<a href="#l7.6205"></a><span id="l7.6205" class="difflineminus">-          }</span>
<a href="#l7.6206"></a><span id="l7.6206" class="difflineminus">-</span>
<a href="#l7.6207"></a><span id="l7.6207" class="difflineminus">-          let oldLength = this.mSelectedItems.length;</span>
<a href="#l7.6208"></a><span id="l7.6208" class="difflineminus">-          this.mSelectedItems = this.mSelectedItems.filter((item) =&gt; {</span>
<a href="#l7.6209"></a><span id="l7.6209" class="difflineminus">-              return item.hashId != aEvent.hashId;</span>
<a href="#l7.6210"></a><span id="l7.6210" class="difflineminus">-          });</span>
<a href="#l7.6211"></a><span id="l7.6211" class="difflineminus">-</span>
<a href="#l7.6212"></a><span id="l7.6212" class="difflineminus">-          for (let col of cols) {</span>
<a href="#l7.6213"></a><span id="l7.6213" class="difflineminus">-              let column = col.column;</span>
<a href="#l7.6214"></a><span id="l7.6214" class="difflineminus">-              let header = col.header;</span>
<a href="#l7.6215"></a><span id="l7.6215" class="difflineminus">-</span>
<a href="#l7.6216"></a><span id="l7.6216" class="difflineminus">-              let estart = aEvent.startDate || aEvent.entryDate || aEvent.dueDate;</span>
<a href="#l7.6217"></a><span id="l7.6217" class="difflineminus">-              if (estart.isDate) {</span>
<a href="#l7.6218"></a><span id="l7.6218" class="difflineminus">-                  header.deleteEvent(aEvent);</span>
<a href="#l7.6219"></a><span id="l7.6219" class="difflineminus">-              } else {</span>
<a href="#l7.6220"></a><span id="l7.6220" class="difflineminus">-                  column.deleteEvent(aEvent);</span>
<a href="#l7.6221"></a><span id="l7.6221" class="difflineminus">-              }</span>
<a href="#l7.6222"></a><span id="l7.6222" class="difflineminus">-          }</span>
<a href="#l7.6223"></a><span id="l7.6223" class="difflineminus">-</span>
<a href="#l7.6224"></a><span id="l7.6224" class="difflineminus">-          // If a deleted event was selected, we need to announce that the</span>
<a href="#l7.6225"></a><span id="l7.6225" class="difflineminus">-          // selection changed.</span>
<a href="#l7.6226"></a><span id="l7.6226" class="difflineminus">-          if (oldLength != this.mSelectedItems.length) {</span>
<a href="#l7.6227"></a><span id="l7.6227" class="difflineminus">-              this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l7.6228"></a><span id="l7.6228" class="difflineminus">-          }</span>
<a href="#l7.6229"></a><span id="l7.6229" class="difflineminus">-</span>
<a href="#l7.6230"></a><span id="l7.6230" class="difflineminus">-          this.adjustScrollbarSpacersForAlldayEvents(aEvent);</span>
<a href="#l7.6231"></a><span id="l7.6231" class="difflineplus">+            let cols = this.findColumnsForItem(aEvent);</span>
<a href="#l7.6232"></a><span id="l7.6232" class="difflineplus">+            if (!cols.length) {</span>
<a href="#l7.6233"></a><span id="l7.6233" class="difflineplus">+                return;</span>
<a href="#l7.6234"></a><span id="l7.6234" class="difflineplus">+            }</span>
<a href="#l7.6235"></a><span id="l7.6235" class="difflineplus">+</span>
<a href="#l7.6236"></a><span id="l7.6236" class="difflineplus">+            let oldLength = this.mSelectedItems.length;</span>
<a href="#l7.6237"></a><span id="l7.6237" class="difflineplus">+            this.mSelectedItems = this.mSelectedItems.filter((item) =&gt; {</span>
<a href="#l7.6238"></a><span id="l7.6238" class="difflineplus">+                return item.hashId != aEvent.hashId;</span>
<a href="#l7.6239"></a><span id="l7.6239" class="difflineplus">+            });</span>
<a href="#l7.6240"></a><span id="l7.6240" class="difflineplus">+</span>
<a href="#l7.6241"></a><span id="l7.6241" class="difflineplus">+            for (let col of cols) {</span>
<a href="#l7.6242"></a><span id="l7.6242" class="difflineplus">+                let column = col.column;</span>
<a href="#l7.6243"></a><span id="l7.6243" class="difflineplus">+                let header = col.header;</span>
<a href="#l7.6244"></a><span id="l7.6244" class="difflineplus">+</span>
<a href="#l7.6245"></a><span id="l7.6245" class="difflineplus">+                let estart = aEvent.startDate || aEvent.entryDate || aEvent.dueDate;</span>
<a href="#l7.6246"></a><span id="l7.6246" class="difflineplus">+                if (estart.isDate) {</span>
<a href="#l7.6247"></a><span id="l7.6247" class="difflineplus">+                    header.deleteEvent(aEvent);</span>
<a href="#l7.6248"></a><span id="l7.6248" class="difflineplus">+                } else {</span>
<a href="#l7.6249"></a><span id="l7.6249" class="difflineplus">+                    column.deleteEvent(aEvent);</span>
<a href="#l7.6250"></a><span id="l7.6250" class="difflineplus">+                }</span>
<a href="#l7.6251"></a><span id="l7.6251" class="difflineplus">+            }</span>
<a href="#l7.6252"></a><span id="l7.6252" class="difflineplus">+</span>
<a href="#l7.6253"></a><span id="l7.6253" class="difflineplus">+            // If a deleted event was selected, we need to announce that the</span>
<a href="#l7.6254"></a><span id="l7.6254" class="difflineplus">+            // selection changed.</span>
<a href="#l7.6255"></a><span id="l7.6255" class="difflineplus">+            if (oldLength != this.mSelectedItems.length) {</span>
<a href="#l7.6256"></a><span id="l7.6256" class="difflineplus">+                this.fireEvent(&quot;itemselect&quot;, this.mSelectedItems);</span>
<a href="#l7.6257"></a><span id="l7.6257" class="difflineplus">+            }</span>
<a href="#l7.6258"></a><span id="l7.6258" class="difflineplus">+</span>
<a href="#l7.6259"></a><span id="l7.6259" class="difflineplus">+            this.adjustScrollbarSpacersForAlldayEvents(aEvent);</span>
<a href="#l7.6260"></a><span id="l7.6260">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6261"></a><span id="l7.6261">       &lt;/method&gt;</span>
<a href="#l7.6262"></a><span id="l7.6262"> </span>
<a href="#l7.6263"></a><span id="l7.6263">       &lt;method name=&quot;deleteItemsFromCalendar&quot;&gt;</span>
<a href="#l7.6264"></a><span id="l7.6264">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l7.6265"></a><span id="l7.6265">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6266"></a><span id="l7.6266" class="difflineminus">-          if (!this.mDateColumns) {</span>
<a href="#l7.6267"></a><span id="l7.6267" class="difflineminus">-              return;</span>
<a href="#l7.6268"></a><span id="l7.6268" class="difflineminus">-          }</span>
<a href="#l7.6269"></a><span id="l7.6269" class="difflineminus">-          for (let col of this.mDateColumns) {</span>
<a href="#l7.6270"></a><span id="l7.6270" class="difflineminus">-              // get all-day events in column header and events within the column</span>
<a href="#l7.6271"></a><span id="l7.6271" class="difflineminus">-              let colEvents = col.header.mItemBoxes.map(box =&gt; box.occurrence)</span>
<a href="#l7.6272"></a><span id="l7.6272" class="difflineminus">-                .concat(col.column.mEventInfos.map(info =&gt; info.event));</span>
<a href="#l7.6273"></a><span id="l7.6273" class="difflineminus">-</span>
<a href="#l7.6274"></a><span id="l7.6274" class="difflineminus">-              for (let event of colEvents) {</span>
<a href="#l7.6275"></a><span id="l7.6275" class="difflineminus">-                  if (event.calendar.id == aCalendar.id) {</span>
<a href="#l7.6276"></a><span id="l7.6276" class="difflineminus">-                      this.doDeleteItem(event);</span>
<a href="#l7.6277"></a><span id="l7.6277" class="difflineminus">-                  }</span>
<a href="#l7.6278"></a><span id="l7.6278" class="difflineminus">-              }</span>
<a href="#l7.6279"></a><span id="l7.6279" class="difflineminus">-          }</span>
<a href="#l7.6280"></a><span id="l7.6280" class="difflineplus">+            if (!this.mDateColumns) {</span>
<a href="#l7.6281"></a><span id="l7.6281" class="difflineplus">+                return;</span>
<a href="#l7.6282"></a><span id="l7.6282" class="difflineplus">+            }</span>
<a href="#l7.6283"></a><span id="l7.6283" class="difflineplus">+            for (let col of this.mDateColumns) {</span>
<a href="#l7.6284"></a><span id="l7.6284" class="difflineplus">+                // get all-day events in column header and events within the column</span>
<a href="#l7.6285"></a><span id="l7.6285" class="difflineplus">+                let colEvents = col.header.mItemBoxes.map(box =&gt; box.occurrence)</span>
<a href="#l7.6286"></a><span id="l7.6286" class="difflineplus">+                  .concat(col.column.mEventInfos.map(info =&gt; info.event));</span>
<a href="#l7.6287"></a><span id="l7.6287" class="difflineplus">+</span>
<a href="#l7.6288"></a><span id="l7.6288" class="difflineplus">+                for (let event of colEvents) {</span>
<a href="#l7.6289"></a><span id="l7.6289" class="difflineplus">+                    if (event.calendar.id == aCalendar.id) {</span>
<a href="#l7.6290"></a><span id="l7.6290" class="difflineplus">+                        this.doDeleteItem(event);</span>
<a href="#l7.6291"></a><span id="l7.6291" class="difflineplus">+                    }</span>
<a href="#l7.6292"></a><span id="l7.6292" class="difflineplus">+                }</span>
<a href="#l7.6293"></a><span id="l7.6293" class="difflineplus">+            }</span>
<a href="#l7.6294"></a><span id="l7.6294">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6295"></a><span id="l7.6295">       &lt;/method&gt;</span>
<a href="#l7.6296"></a><span id="l7.6296"> </span>
<a href="#l7.6297"></a><span id="l7.6297">       &lt;method name=&quot;adjustScrollBarSpacers&quot;&gt;</span>
<a href="#l7.6298"></a><span id="l7.6298">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6299"></a><span id="l7.6299" class="difflineminus">-          // get the view's orientation</span>
<a href="#l7.6300"></a><span id="l7.6300" class="difflineminus">-          let propertyName;</span>
<a href="#l7.6301"></a><span id="l7.6301" class="difflineminus">-          if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.6302"></a><span id="l7.6302" class="difflineminus">-              propertyName = &quot;width&quot;;</span>
<a href="#l7.6303"></a><span id="l7.6303" class="difflineminus">-          } else {</span>
<a href="#l7.6304"></a><span id="l7.6304" class="difflineminus">-              propertyName = &quot;height&quot;;</span>
<a href="#l7.6305"></a><span id="l7.6305" class="difflineminus">-          }</span>
<a href="#l7.6306"></a><span id="l7.6306" class="difflineminus">-</span>
<a href="#l7.6307"></a><span id="l7.6307" class="difflineminus">-          // get the width/height of the scrollbox scrollbar</span>
<a href="#l7.6308"></a><span id="l7.6308" class="difflineminus">-          let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6309"></a><span id="l7.6309" class="difflineminus">-                         this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6310"></a><span id="l7.6310" class="difflineminus">-          let propertyValue = scrollbox.boxObject.firstChild.boxObject[propertyName];</span>
<a href="#l7.6311"></a><span id="l7.6311" class="difflineminus">-          // Check if we need to show the headerScrollbarSpacer at all</span>
<a href="#l7.6312"></a><span id="l7.6312" class="difflineminus">-          let headerPropertyValue = propertyValue;</span>
<a href="#l7.6313"></a><span id="l7.6313" class="difflineminus">-          let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6314"></a><span id="l7.6314" class="difflineminus">-                             this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.6315"></a><span id="l7.6315" class="difflineminus">-          if (headerDayBox) {</span>
<a href="#l7.6316"></a><span id="l7.6316" class="difflineminus">-              // Only do this when there are multiple days</span>
<a href="#l7.6317"></a><span id="l7.6317" class="difflineminus">-              let headerDayBoxMaxHeight = parseInt(document.defaultView.getComputedStyle(headerDayBox)</span>
<a href="#l7.6318"></a><span id="l7.6318" class="difflineminus">-                                                           .getPropertyValue(&quot;max-height&quot;), 10);</span>
<a href="#l7.6319"></a><span id="l7.6319" class="difflineminus">-              if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot; &amp;&amp;</span>
<a href="#l7.6320"></a><span id="l7.6320" class="difflineminus">-                  headerDayBox.boxObject.height &gt;= headerDayBoxMaxHeight) {</span>
<a href="#l7.6321"></a><span id="l7.6321" class="difflineminus">-                  // If the headerDayBox is just as high as the max-height, then</span>
<a href="#l7.6322"></a><span id="l7.6322" class="difflineminus">-                  // there is already a scrollbar and we don't need to show the</span>
<a href="#l7.6323"></a><span id="l7.6323" class="difflineminus">-                  // headerScrollbarSpacer. This is only valid for the non-rotated</span>
<a href="#l7.6324"></a><span id="l7.6324" class="difflineminus">-                  // view.</span>
<a href="#l7.6325"></a><span id="l7.6325" class="difflineminus">-                  headerPropertyValue = 0;</span>
<a href="#l7.6326"></a><span id="l7.6326" class="difflineminus">-              }</span>
<a href="#l7.6327"></a><span id="l7.6327" class="difflineminus">-          }</span>
<a href="#l7.6328"></a><span id="l7.6328" class="difflineminus">-</span>
<a href="#l7.6329"></a><span id="l7.6329" class="difflineminus">-          // set the same width/height for the label and header box spacers</span>
<a href="#l7.6330"></a><span id="l7.6330" class="difflineminus">-          let headerScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6331"></a><span id="l7.6331" class="difflineminus">-                                      this, &quot;anonid&quot;, &quot;headerscrollbarspacer&quot;);</span>
<a href="#l7.6332"></a><span id="l7.6332" class="difflineminus">-          headerScrollBarSpacer.setAttribute(propertyName, headerPropertyValue);</span>
<a href="#l7.6333"></a><span id="l7.6333" class="difflineminus">-          let labelScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6334"></a><span id="l7.6334" class="difflineminus">-                                     this, &quot;anonid&quot;, &quot;labelscrollbarspacer&quot;);</span>
<a href="#l7.6335"></a><span id="l7.6335" class="difflineminus">-          labelScrollBarSpacer.setAttribute(propertyName, propertyValue);</span>
<a href="#l7.6336"></a><span id="l7.6336" class="difflineplus">+            // get the view's orientation</span>
<a href="#l7.6337"></a><span id="l7.6337" class="difflineplus">+            let propertyName;</span>
<a href="#l7.6338"></a><span id="l7.6338" class="difflineplus">+            if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot;) {</span>
<a href="#l7.6339"></a><span id="l7.6339" class="difflineplus">+                propertyName = &quot;width&quot;;</span>
<a href="#l7.6340"></a><span id="l7.6340" class="difflineplus">+            } else {</span>
<a href="#l7.6341"></a><span id="l7.6341" class="difflineplus">+                propertyName = &quot;height&quot;;</span>
<a href="#l7.6342"></a><span id="l7.6342" class="difflineplus">+            }</span>
<a href="#l7.6343"></a><span id="l7.6343" class="difflineplus">+</span>
<a href="#l7.6344"></a><span id="l7.6344" class="difflineplus">+            // get the width/height of the scrollbox scrollbar</span>
<a href="#l7.6345"></a><span id="l7.6345" class="difflineplus">+            let scrollbox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6346"></a><span id="l7.6346" class="difflineplus">+                           this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6347"></a><span id="l7.6347" class="difflineplus">+            let propertyValue = scrollbox.boxObject.firstChild.boxObject[propertyName];</span>
<a href="#l7.6348"></a><span id="l7.6348" class="difflineplus">+            // Check if we need to show the headerScrollbarSpacer at all</span>
<a href="#l7.6349"></a><span id="l7.6349" class="difflineplus">+            let headerPropertyValue = propertyValue;</span>
<a href="#l7.6350"></a><span id="l7.6350" class="difflineplus">+            let headerDayBox = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6351"></a><span id="l7.6351" class="difflineplus">+                               this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l7.6352"></a><span id="l7.6352" class="difflineplus">+            if (headerDayBox) {</span>
<a href="#l7.6353"></a><span id="l7.6353" class="difflineplus">+                // Only do this when there are multiple days</span>
<a href="#l7.6354"></a><span id="l7.6354" class="difflineplus">+                let headerDayBoxMaxHeight = parseInt(document.defaultView.getComputedStyle(headerDayBox)</span>
<a href="#l7.6355"></a><span id="l7.6355" class="difflineplus">+                                                             .getPropertyValue(&quot;max-height&quot;), 10);</span>
<a href="#l7.6356"></a><span id="l7.6356" class="difflineplus">+                if (this.getAttribute(&quot;orient&quot;) == &quot;vertical&quot; &amp;&amp;</span>
<a href="#l7.6357"></a><span id="l7.6357" class="difflineplus">+                    headerDayBox.boxObject.height &gt;= headerDayBoxMaxHeight) {</span>
<a href="#l7.6358"></a><span id="l7.6358" class="difflineplus">+                    // If the headerDayBox is just as high as the max-height, then</span>
<a href="#l7.6359"></a><span id="l7.6359" class="difflineplus">+                    // there is already a scrollbar and we don't need to show the</span>
<a href="#l7.6360"></a><span id="l7.6360" class="difflineplus">+                    // headerScrollbarSpacer. This is only valid for the non-rotated</span>
<a href="#l7.6361"></a><span id="l7.6361" class="difflineplus">+                    // view.</span>
<a href="#l7.6362"></a><span id="l7.6362" class="difflineplus">+                    headerPropertyValue = 0;</span>
<a href="#l7.6363"></a><span id="l7.6363" class="difflineplus">+                }</span>
<a href="#l7.6364"></a><span id="l7.6364" class="difflineplus">+            }</span>
<a href="#l7.6365"></a><span id="l7.6365" class="difflineplus">+</span>
<a href="#l7.6366"></a><span id="l7.6366" class="difflineplus">+            // set the same width/height for the label and header box spacers</span>
<a href="#l7.6367"></a><span id="l7.6367" class="difflineplus">+            let headerScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6368"></a><span id="l7.6368" class="difflineplus">+                                        this, &quot;anonid&quot;, &quot;headerscrollbarspacer&quot;);</span>
<a href="#l7.6369"></a><span id="l7.6369" class="difflineplus">+            headerScrollBarSpacer.setAttribute(propertyName, headerPropertyValue);</span>
<a href="#l7.6370"></a><span id="l7.6370" class="difflineplus">+            let labelScrollBarSpacer = document.getAnonymousElementByAttribute(</span>
<a href="#l7.6371"></a><span id="l7.6371" class="difflineplus">+                                       this, &quot;anonid&quot;, &quot;labelscrollbarspacer&quot;);</span>
<a href="#l7.6372"></a><span id="l7.6372" class="difflineplus">+            labelScrollBarSpacer.setAttribute(propertyName, propertyValue);</span>
<a href="#l7.6373"></a><span id="l7.6373">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6374"></a><span id="l7.6374">       &lt;/method&gt;</span>
<a href="#l7.6375"></a><span id="l7.6375"> </span>
<a href="#l7.6376"></a><span id="l7.6376">       &lt;field name=&quot;mFirstVisibleMinute&quot;&gt;0&lt;/field&gt;</span>
<a href="#l7.6377"></a><span id="l7.6377">       &lt;method name=&quot;scrollToMinute&quot;&gt;</span>
<a href="#l7.6378"></a><span id="l7.6378">         &lt;parameter name=&quot;aMinute&quot;/&gt;</span>
<a href="#l7.6379"></a><span id="l7.6379">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6380"></a><span id="l7.6380" class="difflineminus">-          let scrollbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6381"></a><span id="l7.6381" class="difflineminus">-          let scrollBoxObject = scrollbox.boxObject;</span>
<a href="#l7.6382"></a><span id="l7.6382" class="difflineminus">-          // 'aMinute' will be the first minute showed in the view, so it must</span>
<a href="#l7.6383"></a><span id="l7.6383" class="difflineminus">-          // belong to the range 0 &lt;-&gt; (24*60 - minutes_showed_in_the_view) but</span>
<a href="#l7.6384"></a><span id="l7.6384" class="difflineminus">-          // we consider 25 hours instead of 24 to let the view scroll until</span>
<a href="#l7.6385"></a><span id="l7.6385" class="difflineminus">-          // showing events that start just before 0.00</span>
<a href="#l7.6386"></a><span id="l7.6386" class="difflineminus">-          let maxFirstMin = 25 * 60 - Math.round(scrollBoxObject.height / this.mPixPerMin);</span>
<a href="#l7.6387"></a><span id="l7.6387" class="difflineminus">-          aMinute = Math.min(maxFirstMin, Math.max(0, aMinute));</span>
<a href="#l7.6388"></a><span id="l7.6388" class="difflineminus">-</span>
<a href="#l7.6389"></a><span id="l7.6389" class="difflineminus">-          if (scrollBoxObject &amp;&amp; scrollbox.scrollHeight &gt; 0) {</span>
<a href="#l7.6390"></a><span id="l7.6390" class="difflineminus">-              let x = {}, y = {};</span>
<a href="#l7.6391"></a><span id="l7.6391" class="difflineminus">-              scrollBoxObject.getPosition(x, y);</span>
<a href="#l7.6392"></a><span id="l7.6392" class="difflineminus">-              let pos = Math.round(aMinute * this.mPixPerMin);</span>
<a href="#l7.6393"></a><span id="l7.6393" class="difflineminus">-              if (scrollbox.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;) {</span>
<a href="#l7.6394"></a><span id="l7.6394" class="difflineminus">-                  scrollBoxObject.scrollTo(x.value, pos);</span>
<a href="#l7.6395"></a><span id="l7.6395" class="difflineminus">-              } else {</span>
<a href="#l7.6396"></a><span id="l7.6396" class="difflineminus">-                  scrollBoxObject.scrollTo(pos, y.value);</span>
<a href="#l7.6397"></a><span id="l7.6397" class="difflineminus">-              }</span>
<a href="#l7.6398"></a><span id="l7.6398" class="difflineminus">-          }</span>
<a href="#l7.6399"></a><span id="l7.6399" class="difflineminus">-</span>
<a href="#l7.6400"></a><span id="l7.6400" class="difflineminus">-          // Set the first visible minute in any case, we want to move to the</span>
<a href="#l7.6401"></a><span id="l7.6401" class="difflineminus">-          // right minute as soon as possible if we couldn't do so above.</span>
<a href="#l7.6402"></a><span id="l7.6402" class="difflineminus">-          this.mFirstVisibleMinute = aMinute;</span>
<a href="#l7.6403"></a><span id="l7.6403" class="difflineplus">+            let scrollbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6404"></a><span id="l7.6404" class="difflineplus">+            let scrollBoxObject = scrollbox.boxObject;</span>
<a href="#l7.6405"></a><span id="l7.6405" class="difflineplus">+            // 'aMinute' will be the first minute showed in the view, so it must</span>
<a href="#l7.6406"></a><span id="l7.6406" class="difflineplus">+            // belong to the range 0 &lt;-&gt; (24*60 - minutes_showed_in_the_view) but</span>
<a href="#l7.6407"></a><span id="l7.6407" class="difflineplus">+            // we consider 25 hours instead of 24 to let the view scroll until</span>
<a href="#l7.6408"></a><span id="l7.6408" class="difflineplus">+            // showing events that start just before 0.00</span>
<a href="#l7.6409"></a><span id="l7.6409" class="difflineplus">+            let maxFirstMin = 25 * 60 - Math.round(scrollBoxObject.height / this.mPixPerMin);</span>
<a href="#l7.6410"></a><span id="l7.6410" class="difflineplus">+            aMinute = Math.min(maxFirstMin, Math.max(0, aMinute));</span>
<a href="#l7.6411"></a><span id="l7.6411" class="difflineplus">+</span>
<a href="#l7.6412"></a><span id="l7.6412" class="difflineplus">+            if (scrollBoxObject &amp;&amp; scrollbox.scrollHeight &gt; 0) {</span>
<a href="#l7.6413"></a><span id="l7.6413" class="difflineplus">+                let x = {}, y = {};</span>
<a href="#l7.6414"></a><span id="l7.6414" class="difflineplus">+                scrollBoxObject.getPosition(x, y);</span>
<a href="#l7.6415"></a><span id="l7.6415" class="difflineplus">+                let pos = Math.round(aMinute * this.mPixPerMin);</span>
<a href="#l7.6416"></a><span id="l7.6416" class="difflineplus">+                if (scrollbox.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;) {</span>
<a href="#l7.6417"></a><span id="l7.6417" class="difflineplus">+                    scrollBoxObject.scrollTo(x.value, pos);</span>
<a href="#l7.6418"></a><span id="l7.6418" class="difflineplus">+                } else {</span>
<a href="#l7.6419"></a><span id="l7.6419" class="difflineplus">+                    scrollBoxObject.scrollTo(pos, y.value);</span>
<a href="#l7.6420"></a><span id="l7.6420" class="difflineplus">+                }</span>
<a href="#l7.6421"></a><span id="l7.6421" class="difflineplus">+            }</span>
<a href="#l7.6422"></a><span id="l7.6422" class="difflineplus">+</span>
<a href="#l7.6423"></a><span id="l7.6423" class="difflineplus">+            // Set the first visible minute in any case, we want to move to the</span>
<a href="#l7.6424"></a><span id="l7.6424" class="difflineplus">+            // right minute as soon as possible if we couldn't do so above.</span>
<a href="#l7.6425"></a><span id="l7.6425" class="difflineplus">+            this.mFirstVisibleMinute = aMinute;</span>
<a href="#l7.6426"></a><span id="l7.6426">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6427"></a><span id="l7.6427">       &lt;/method&gt;</span>
<a href="#l7.6428"></a><span id="l7.6428"> </span>
<a href="#l7.6429"></a><span id="l7.6429">       &lt;method name=&quot;setDayStartEndMinutes&quot;&gt;</span>
<a href="#l7.6430"></a><span id="l7.6430">         &lt;parameter name=&quot;aDayStartMin&quot;/&gt;</span>
<a href="#l7.6431"></a><span id="l7.6431">         &lt;parameter name=&quot;aDayEndMin&quot;/&gt;</span>
<a href="#l7.6432"></a><span id="l7.6432">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6433"></a><span id="l7.6433" class="difflineminus">-          if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l7.6434"></a><span id="l7.6434" class="difflineminus">-              aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l7.6435"></a><span id="l7.6435" class="difflineminus">-              throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.6436"></a><span id="l7.6436" class="difflineminus">-          }</span>
<a href="#l7.6437"></a><span id="l7.6437" class="difflineminus">-          if (this.mDayStartMin != aDayStartMin ||</span>
<a href="#l7.6438"></a><span id="l7.6438" class="difflineminus">-              this.mDayEndMin != aDayEndMin) {</span>
<a href="#l7.6439"></a><span id="l7.6439" class="difflineminus">-              this.mDayStartMin = aDayStartMin;</span>
<a href="#l7.6440"></a><span id="l7.6440" class="difflineminus">-              this.mDayEndMin = aDayEndMin;</span>
<a href="#l7.6441"></a><span id="l7.6441" class="difflineminus">-</span>
<a href="#l7.6442"></a><span id="l7.6442" class="difflineminus">-              // Also update on the time-bar</span>
<a href="#l7.6443"></a><span id="l7.6443" class="difflineminus">-              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;)</span>
<a href="#l7.6444"></a><span id="l7.6444" class="difflineminus">-                      .setDayStartEndHours(this.mDayStartMin / 60,</span>
<a href="#l7.6445"></a><span id="l7.6445" class="difflineminus">-                                           this.mDayEndMin / 60);</span>
<a href="#l7.6446"></a><span id="l7.6446" class="difflineminus">-          }</span>
<a href="#l7.6447"></a><span id="l7.6447" class="difflineplus">+            if (aDayStartMin &lt; this.mStartMin || aDayStartMin &gt; aDayEndMin ||</span>
<a href="#l7.6448"></a><span id="l7.6448" class="difflineplus">+                aDayEndMin &gt; this.mEndMin) {</span>
<a href="#l7.6449"></a><span id="l7.6449" class="difflineplus">+                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.6450"></a><span id="l7.6450" class="difflineplus">+            }</span>
<a href="#l7.6451"></a><span id="l7.6451" class="difflineplus">+            if (this.mDayStartMin != aDayStartMin ||</span>
<a href="#l7.6452"></a><span id="l7.6452" class="difflineplus">+                this.mDayEndMin != aDayEndMin) {</span>
<a href="#l7.6453"></a><span id="l7.6453" class="difflineplus">+                this.mDayStartMin = aDayStartMin;</span>
<a href="#l7.6454"></a><span id="l7.6454" class="difflineplus">+                this.mDayEndMin = aDayEndMin;</span>
<a href="#l7.6455"></a><span id="l7.6455" class="difflineplus">+</span>
<a href="#l7.6456"></a><span id="l7.6456" class="difflineplus">+                // Also update on the time-bar</span>
<a href="#l7.6457"></a><span id="l7.6457" class="difflineplus">+                document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timebar&quot;)</span>
<a href="#l7.6458"></a><span id="l7.6458" class="difflineplus">+                        .setDayStartEndHours(this.mDayStartMin / 60,</span>
<a href="#l7.6459"></a><span id="l7.6459" class="difflineplus">+                                             this.mDayEndMin / 60);</span>
<a href="#l7.6460"></a><span id="l7.6460" class="difflineplus">+            }</span>
<a href="#l7.6461"></a><span id="l7.6461"> </span>
<a href="#l7.6462"></a><span id="l7.6462">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6463"></a><span id="l7.6463">       &lt;/method&gt;</span>
<a href="#l7.6464"></a><span id="l7.6464"> </span>
<a href="#l7.6465"></a><span id="l7.6465">       &lt;method name=&quot;setVisibleMinutes&quot;&gt;</span>
<a href="#l7.6466"></a><span id="l7.6466">         &lt;parameter name=&quot;aVisibleMinutes&quot;/&gt;</span>
<a href="#l7.6467"></a><span id="l7.6467">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6468"></a><span id="l7.6468" class="difflineminus">-          if (aVisibleMinutes &lt;= 0 ||</span>
<a href="#l7.6469"></a><span id="l7.6469" class="difflineminus">-              aVisibleMinutes &gt; (this.mEndMin - this.mStartMin)) {</span>
<a href="#l7.6470"></a><span id="l7.6470" class="difflineminus">-              throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.6471"></a><span id="l7.6471" class="difflineminus">-          }</span>
<a href="#l7.6472"></a><span id="l7.6472" class="difflineminus">-          if (this.mVisibleMinutes != aVisibleMinutes) {</span>
<a href="#l7.6473"></a><span id="l7.6473" class="difflineminus">-              this.mVisibleMinutes = aVisibleMinutes;</span>
<a href="#l7.6474"></a><span id="l7.6474" class="difflineminus">-          }</span>
<a href="#l7.6475"></a><span id="l7.6475" class="difflineminus">-          return this.mVisibleMinutes;</span>
<a href="#l7.6476"></a><span id="l7.6476" class="difflineplus">+            if (aVisibleMinutes &lt;= 0 ||</span>
<a href="#l7.6477"></a><span id="l7.6477" class="difflineplus">+                aVisibleMinutes &gt; (this.mEndMin - this.mStartMin)) {</span>
<a href="#l7.6478"></a><span id="l7.6478" class="difflineplus">+                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l7.6479"></a><span id="l7.6479" class="difflineplus">+            }</span>
<a href="#l7.6480"></a><span id="l7.6480" class="difflineplus">+            if (this.mVisibleMinutes != aVisibleMinutes) {</span>
<a href="#l7.6481"></a><span id="l7.6481" class="difflineplus">+                this.mVisibleMinutes = aVisibleMinutes;</span>
<a href="#l7.6482"></a><span id="l7.6482" class="difflineplus">+            }</span>
<a href="#l7.6483"></a><span id="l7.6483" class="difflineplus">+            return this.mVisibleMinutes;</span>
<a href="#l7.6484"></a><span id="l7.6484">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6485"></a><span id="l7.6485">       &lt;/method&gt;</span>
<a href="#l7.6486"></a><span id="l7.6486"> </span>
<a href="#l7.6487"></a><span id="l7.6487">       &lt;method name=&quot;zoomIn&quot;&gt;</span>
<a href="#l7.6488"></a><span id="l7.6488">         &lt;parameter name=&quot;aLevel&quot;/&gt;</span>
<a href="#l7.6489"></a><span id="l7.6489">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6490"></a><span id="l7.6490" class="difflineminus">-          let visibleHours = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6491"></a><span id="l7.6491" class="difflineminus">-          visibleHours += (aLevel || 1);</span>
<a href="#l7.6492"></a><span id="l7.6492" class="difflineminus">-</span>
<a href="#l7.6493"></a><span id="l7.6493" class="difflineminus">-          Preferences.set(&quot;calendar.view.visiblehours&quot;, Math.min(visibleHours, 24));</span>
<a href="#l7.6494"></a><span id="l7.6494" class="difflineplus">+            let visibleHours = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6495"></a><span id="l7.6495" class="difflineplus">+            visibleHours += (aLevel || 1);</span>
<a href="#l7.6496"></a><span id="l7.6496" class="difflineplus">+</span>
<a href="#l7.6497"></a><span id="l7.6497" class="difflineplus">+            Preferences.set(&quot;calendar.view.visiblehours&quot;, Math.min(visibleHours, 24));</span>
<a href="#l7.6498"></a><span id="l7.6498">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6499"></a><span id="l7.6499">       &lt;/method&gt;</span>
<a href="#l7.6500"></a><span id="l7.6500">       &lt;method name=&quot;zoomOut&quot;&gt;</span>
<a href="#l7.6501"></a><span id="l7.6501">         &lt;parameter name=&quot;aLevel&quot;/&gt;</span>
<a href="#l7.6502"></a><span id="l7.6502">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6503"></a><span id="l7.6503" class="difflineminus">-          let visibleHours = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6504"></a><span id="l7.6504" class="difflineminus">-          visibleHours -= (aLevel || 1);</span>
<a href="#l7.6505"></a><span id="l7.6505" class="difflineminus">-</span>
<a href="#l7.6506"></a><span id="l7.6506" class="difflineminus">-          Preferences.set(&quot;calendar.view.visiblehours&quot;, Math.max(1, visibleHours));</span>
<a href="#l7.6507"></a><span id="l7.6507" class="difflineplus">+            let visibleHours = Preferences.get(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6508"></a><span id="l7.6508" class="difflineplus">+            visibleHours -= (aLevel || 1);</span>
<a href="#l7.6509"></a><span id="l7.6509" class="difflineplus">+</span>
<a href="#l7.6510"></a><span id="l7.6510" class="difflineplus">+            Preferences.set(&quot;calendar.view.visiblehours&quot;, Math.max(1, visibleHours));</span>
<a href="#l7.6511"></a><span id="l7.6511">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6512"></a><span id="l7.6512">       &lt;/method&gt;</span>
<a href="#l7.6513"></a><span id="l7.6513">       &lt;method name=&quot;zoomReset&quot;&gt;</span>
<a href="#l7.6514"></a><span id="l7.6514">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l7.6515"></a><span id="l7.6515" class="difflineminus">-          Preferences.set(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6516"></a><span id="l7.6516" class="difflineplus">+            Preferences.set(&quot;calendar.view.visiblehours&quot;, 9);</span>
<a href="#l7.6517"></a><span id="l7.6517">         ]]&gt;&lt;/body&gt;</span>
<a href="#l7.6518"></a><span id="l7.6518">       &lt;/method&gt;</span>
<a href="#l7.6519"></a><span id="l7.6519">     &lt;/implementation&gt;</span>
<a href="#l7.6520"></a><span id="l7.6520"> </span>
<a href="#l7.6521"></a><span id="l7.6521">     &lt;handlers&gt;</span>
<a href="#l7.6522"></a><span id="l7.6522">       &lt;handler event=&quot;click&quot; button=&quot;2&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.6523"></a><span id="l7.6523" class="difflineminus">-        this.selectedDateTime = null;</span>
<a href="#l7.6524"></a><span id="l7.6524" class="difflineplus">+          this.selectedDateTime = null;</span>
<a href="#l7.6525"></a><span id="l7.6525">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.6526"></a><span id="l7.6526">       &lt;handler event=&quot;wheel&quot; phase=&quot;bubbling&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.6527"></a><span id="l7.6527" class="difflineminus">-        if (!event.ctrlKey &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l7.6528"></a><span id="l7.6528" class="difflineminus">-            !event.altKey &amp;&amp; !event.metaKey) {</span>
<a href="#l7.6529"></a><span id="l7.6529" class="difflineminus">-            // Only shift hours if no modifier is pressed.</span>
<a href="#l7.6530"></a><span id="l7.6530" class="difflineminus">-</span>
<a href="#l7.6531"></a><span id="l7.6531" class="difflineminus">-            let minute = this.mFirstVisibleMinute;</span>
<a href="#l7.6532"></a><span id="l7.6532" class="difflineminus">-            if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l7.6533"></a><span id="l7.6533" class="difflineminus">-                if (this.rotated &amp;&amp; event.deltaX != 0) {</span>
<a href="#l7.6534"></a><span id="l7.6534" class="difflineminus">-                    minute += event.deltaX &lt; 0 ? -60 : 60;</span>
<a href="#l7.6535"></a><span id="l7.6535" class="difflineminus">-                } else if (!this.rotated &amp;&amp; event.deltaY != 0) {</span>
<a href="#l7.6536"></a><span id="l7.6536" class="difflineminus">-                    minute += event.deltaY &lt; 0 ? -60 : 60;</span>
<a href="#l7.6537"></a><span id="l7.6537" class="difflineminus">-                }</span>
<a href="#l7.6538"></a><span id="l7.6538" class="difflineminus">-            } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l7.6539"></a><span id="l7.6539" class="difflineminus">-                if (this.rotated &amp;&amp; event.deltaX != 0) {</span>
<a href="#l7.6540"></a><span id="l7.6540" class="difflineminus">-                    minute += Math.ceil(event.deltaX / this.mPixPerMin);</span>
<a href="#l7.6541"></a><span id="l7.6541" class="difflineminus">-                } else if (!this.rotated &amp;&amp; event.deltaY != 0) {</span>
<a href="#l7.6542"></a><span id="l7.6542" class="difflineminus">-                    minute += Math.ceil(event.deltaY / this.mPixPerMin);</span>
<a href="#l7.6543"></a><span id="l7.6543" class="difflineminus">-                }</span>
<a href="#l7.6544"></a><span id="l7.6544" class="difflineminus">-            }</span>
<a href="#l7.6545"></a><span id="l7.6545" class="difflineminus">-            this.scrollToMinute(minute);</span>
<a href="#l7.6546"></a><span id="l7.6546" class="difflineminus">-        }</span>
<a href="#l7.6547"></a><span id="l7.6547" class="difflineminus">-</span>
<a href="#l7.6548"></a><span id="l7.6548" class="difflineminus">-        // We are taking care of scrolling, so prevent the default</span>
<a href="#l7.6549"></a><span id="l7.6549" class="difflineminus">-        // action in any case.</span>
<a href="#l7.6550"></a><span id="l7.6550" class="difflineminus">-        event.preventDefault();</span>
<a href="#l7.6551"></a><span id="l7.6551" class="difflineplus">+          if (!event.ctrlKey &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l7.6552"></a><span id="l7.6552" class="difflineplus">+              !event.altKey &amp;&amp; !event.metaKey) {</span>
<a href="#l7.6553"></a><span id="l7.6553" class="difflineplus">+              // Only shift hours if no modifier is pressed.</span>
<a href="#l7.6554"></a><span id="l7.6554" class="difflineplus">+</span>
<a href="#l7.6555"></a><span id="l7.6555" class="difflineplus">+              let minute = this.mFirstVisibleMinute;</span>
<a href="#l7.6556"></a><span id="l7.6556" class="difflineplus">+              if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l7.6557"></a><span id="l7.6557" class="difflineplus">+                  if (this.rotated &amp;&amp; event.deltaX != 0) {</span>
<a href="#l7.6558"></a><span id="l7.6558" class="difflineplus">+                      minute += event.deltaX &lt; 0 ? -60 : 60;</span>
<a href="#l7.6559"></a><span id="l7.6559" class="difflineplus">+                  } else if (!this.rotated &amp;&amp; event.deltaY != 0) {</span>
<a href="#l7.6560"></a><span id="l7.6560" class="difflineplus">+                      minute += event.deltaY &lt; 0 ? -60 : 60;</span>
<a href="#l7.6561"></a><span id="l7.6561" class="difflineplus">+                  }</span>
<a href="#l7.6562"></a><span id="l7.6562" class="difflineplus">+              } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l7.6563"></a><span id="l7.6563" class="difflineplus">+                  if (this.rotated &amp;&amp; event.deltaX != 0) {</span>
<a href="#l7.6564"></a><span id="l7.6564" class="difflineplus">+                      minute += Math.ceil(event.deltaX / this.mPixPerMin);</span>
<a href="#l7.6565"></a><span id="l7.6565" class="difflineplus">+                  } else if (!this.rotated &amp;&amp; event.deltaY != 0) {</span>
<a href="#l7.6566"></a><span id="l7.6566" class="difflineplus">+                      minute += Math.ceil(event.deltaY / this.mPixPerMin);</span>
<a href="#l7.6567"></a><span id="l7.6567" class="difflineplus">+                  }</span>
<a href="#l7.6568"></a><span id="l7.6568" class="difflineplus">+              }</span>
<a href="#l7.6569"></a><span id="l7.6569" class="difflineplus">+              this.scrollToMinute(minute);</span>
<a href="#l7.6570"></a><span id="l7.6570" class="difflineplus">+          }</span>
<a href="#l7.6571"></a><span id="l7.6571" class="difflineplus">+</span>
<a href="#l7.6572"></a><span id="l7.6572" class="difflineplus">+          // We are taking care of scrolling, so prevent the default</span>
<a href="#l7.6573"></a><span id="l7.6573" class="difflineplus">+          // action in any case.</span>
<a href="#l7.6574"></a><span id="l7.6574" class="difflineplus">+          event.preventDefault();</span>
<a href="#l7.6575"></a><span id="l7.6575">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.6576"></a><span id="l7.6576"> </span>
<a href="#l7.6577"></a><span id="l7.6577">       &lt;handler event=&quot;scroll&quot; phase=&quot;bubbling&quot;&gt;&lt;![CDATA[</span>
<a href="#l7.6578"></a><span id="l7.6578" class="difflineminus">-        let scrollbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6579"></a><span id="l7.6579" class="difflineminus">-        let scrollBoxObject = scrollbox.boxObject;</span>
<a href="#l7.6580"></a><span id="l7.6580" class="difflineminus">-        if (scrollBoxObject &amp;&amp; scrollbox.scrollHeight &gt; 0) {</span>
<a href="#l7.6581"></a><span id="l7.6581" class="difflineminus">-            // We need to update the first visible minute, but only if the</span>
<a href="#l7.6582"></a><span id="l7.6582" class="difflineminus">-            // scrollbox has been sized.</span>
<a href="#l7.6583"></a><span id="l7.6583" class="difflineminus">-            let x = {}, y = {};</span>
<a href="#l7.6584"></a><span id="l7.6584" class="difflineminus">-            scrollBoxObject.getPosition(x, y);</span>
<a href="#l7.6585"></a><span id="l7.6585" class="difflineminus">-            if (scrollbox.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;) {</span>
<a href="#l7.6586"></a><span id="l7.6586" class="difflineminus">-                this.mFirstVisibleMinute = Math.round(y.value / this.mPixPerMin);</span>
<a href="#l7.6587"></a><span id="l7.6587" class="difflineminus">-            } else {</span>
<a href="#l7.6588"></a><span id="l7.6588" class="difflineminus">-                this.mFirstVisibleMinute = Math.round(x.value / this.mPixPerMin);</span>
<a href="#l7.6589"></a><span id="l7.6589" class="difflineminus">-            }</span>
<a href="#l7.6590"></a><span id="l7.6590" class="difflineminus">-        }</span>
<a href="#l7.6591"></a><span id="l7.6591" class="difflineplus">+          let scrollbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l7.6592"></a><span id="l7.6592" class="difflineplus">+          let scrollBoxObject = scrollbox.boxObject;</span>
<a href="#l7.6593"></a><span id="l7.6593" class="difflineplus">+          if (scrollBoxObject &amp;&amp; scrollbox.scrollHeight &gt; 0) {</span>
<a href="#l7.6594"></a><span id="l7.6594" class="difflineplus">+              // We need to update the first visible minute, but only if the</span>
<a href="#l7.6595"></a><span id="l7.6595" class="difflineplus">+              // scrollbox has been sized.</span>
<a href="#l7.6596"></a><span id="l7.6596" class="difflineplus">+              let x = {}, y = {};</span>
<a href="#l7.6597"></a><span id="l7.6597" class="difflineplus">+              scrollBoxObject.getPosition(x, y);</span>
<a href="#l7.6598"></a><span id="l7.6598" class="difflineplus">+              if (scrollbox.getAttribute(&quot;orient&quot;) == &quot;horizontal&quot;) {</span>
<a href="#l7.6599"></a><span id="l7.6599" class="difflineplus">+                  this.mFirstVisibleMinute = Math.round(y.value / this.mPixPerMin);</span>
<a href="#l7.6600"></a><span id="l7.6600" class="difflineplus">+              } else {</span>
<a href="#l7.6601"></a><span id="l7.6601" class="difflineplus">+                  this.mFirstVisibleMinute = Math.round(x.value / this.mPixPerMin);</span>
<a href="#l7.6602"></a><span id="l7.6602" class="difflineplus">+              }</span>
<a href="#l7.6603"></a><span id="l7.6603" class="difflineplus">+          }</span>
<a href="#l7.6604"></a><span id="l7.6604">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l7.6605"></a><span id="l7.6605">     &lt;/handlers&gt;</span>
<a href="#l7.6606"></a><span id="l7.6606">   &lt;/binding&gt;</span>
<a href="#l7.6607"></a><span id="l7.6607"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -109,1096 +109,1096 @@</span>
<a href="#l8.4"></a><span id="l8.4">                        tooltiptext=&quot;&amp;calendar.unifinder.tree.calendarname.tooltip2;&quot;/&gt;</span>
<a href="#l8.5"></a><span id="l8.5">         &lt;/xul:treecols&gt;</span>
<a href="#l8.6"></a><span id="l8.6">         &lt;xul:treechildren tooltip=&quot;taskTreeTooltip&quot; ondblclick=&quot;mTreeView.onDoubleClick(event)&quot;/&gt;</span>
<a href="#l8.7"></a><span id="l8.7">       &lt;/xul:tree&gt;</span>
<a href="#l8.8"></a><span id="l8.8">     &lt;/content&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">     &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l8.11"></a><span id="l8.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calItemUtils.jsm&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calItemUtils.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-        // set up the tree filter</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-        this.mFilter = new calFilter();</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+          // set up the tree filter</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+          this.mFilter = new calFilter();</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-        // set up the custom tree view</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-        let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-        this.mTreeView.tree = tree;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-        tree.view = this.mTreeView;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+          // set up the custom tree view</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+          let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+          this.mTreeView.tree = tree;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+          tree.view = this.mTreeView;</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-        // set up our calendar event observer</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-        let composite = cal.getCompositeCalendar(window);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-        composite.addObserver(this.mTaskTreeObserver);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+          // set up our calendar event observer</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+          let composite = cal.getCompositeCalendar(window);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+          composite.addObserver(this.mTaskTreeObserver);</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-        // set up the preference observer</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-        let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        branch.addObserver(&quot;calendar.&quot;, this);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+          // set up the preference observer</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+          branch.addObserver(&quot;calendar.&quot;, this);</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-        // we want to make several attributes on the column</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-        // elements persistent, but unfortunately there's no</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-        // relyable way with the 'persist' feature.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-        // that's why we need to store the necessary bits and</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-        // pieces at the element this binding is attached to.</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-        let names = this.getAttribute(&quot;visible-columns&quot;).split(&quot; &quot;);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-        let ordinals = this.getAttribute(&quot;ordinals&quot;).split(&quot; &quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-        let widths = this.getAttribute(&quot;widths&quot;).split(&quot; &quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-        let sorted = this.getAttribute(&quot;sort-active&quot;);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-        let sortDirection = this.getAttribute(&quot;sort-direction&quot;) || &quot;ascending&quot;;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-        tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-        let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-        for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-            let content = treecols[i].getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-            if (names.some(element =&gt; element == content)) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-                treecols[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-            } else {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-                treecols[i].setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-            }</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-            if (ordinals &amp;&amp; ordinals.length &gt; 0) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-                treecols[i].ordinal = Number(ordinals.shift());</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-            }</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-            if (widths &amp;&amp; widths.length &gt; 0) {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-                treecols[i].width = Number(widths.shift());</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-            }</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-            if (sorted &amp;&amp; sorted.length &gt; 0) {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-                if (sorted == content) {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-                    this.mTreeView.sortDirection = sortDirection;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-                    this.mTreeView.selectedColumn = treecols[i];</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-                }</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-            }</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-        }</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+          // we want to make several attributes on the column</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+          // elements persistent, but unfortunately there's no</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+          // relyable way with the 'persist' feature.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+          // that's why we need to store the necessary bits and</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+          // pieces at the element this binding is attached to.</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+          let names = this.getAttribute(&quot;visible-columns&quot;).split(&quot; &quot;);</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+          let ordinals = this.getAttribute(&quot;ordinals&quot;).split(&quot; &quot;);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+          let widths = this.getAttribute(&quot;widths&quot;).split(&quot; &quot;);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+          let sorted = this.getAttribute(&quot;sort-active&quot;);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+          let sortDirection = this.getAttribute(&quot;sort-direction&quot;) || &quot;ascending&quot;;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+          tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+          let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+          for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+              let content = treecols[i].getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+              if (names.some(element =&gt; element == content)) {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+                  treecols[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+              } else {</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+                  treecols[i].setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+              }</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+              if (ordinals &amp;&amp; ordinals.length &gt; 0) {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+                  treecols[i].ordinal = Number(ordinals.shift());</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+              }</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+              if (widths &amp;&amp; widths.length &gt; 0) {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+                  treecols[i].width = Number(widths.shift());</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+              }</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+              if (sorted &amp;&amp; sorted.length &gt; 0) {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+                  if (sorted == content) {</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+                      this.mTreeView.sortDirection = sortDirection;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+                      this.mTreeView.selectedColumn = treecols[i];</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+                  }</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+              }</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+          }</span>
<a href="#l8.116"></a><span id="l8.116">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l8.117"></a><span id="l8.117">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-        // remove composite calendar observer</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-        let composite = cal.getCompositeCalendar(window);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-        composite.removeObserver(this.mTaskTreeObserver);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+          // remove composite calendar observer</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+          let composite = cal.getCompositeCalendar(window);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+          composite.removeObserver(this.mTaskTreeObserver);</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-        // remove the preference observer</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-        let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-        branch.removeObserver(&quot;calendar.&quot;, this);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+          // remove the preference observer</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+          branch.removeObserver(&quot;calendar.&quot;, this);</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-        let widths = &quot;&quot;;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-        let ordinals = &quot;&quot;;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-        let visible = &quot;&quot;;</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-        let sorted = this.mTreeView.selectedColumn;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-        let tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-        let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-        for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-            if (treecols[i].getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-                let content = treecols[i].getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-                visible += visible.length &gt; 0 ? &quot; &quot; + content : content;</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-            }</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-            if (ordinals.length &gt; 0) {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-                ordinals += &quot; &quot;;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-            }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-            ordinals += treecols[i].ordinal;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-            if (widths.length &gt; 0) {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-                widths += &quot; &quot;;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-            }</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-            widths += treecols[i].width || 0;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-        }</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-        this.setAttribute(&quot;visible-columns&quot;, visible);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-        this.setAttribute(&quot;ordinals&quot;, ordinals);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-        this.setAttribute(&quot;widths&quot;, widths);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-        if (sorted) {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-            this.setAttribute(&quot;sort-active&quot;, sorted.getAttribute(&quot;itemproperty&quot;));</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-            this.setAttribute(&quot;sort-direction&quot;, this.mTreeView.sortDirection);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        } else {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-            this.removeAttribute(&quot;sort-active&quot;);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-            this.removeAttribute(&quot;sort-direction&quot;);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-        }</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+          let widths = &quot;&quot;;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+          let ordinals = &quot;&quot;;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+          let visible = &quot;&quot;;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+          let sorted = this.mTreeView.selectedColumn;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+          let tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+          let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+          for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+              if (treecols[i].getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+                  let content = treecols[i].getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+                  visible += visible.length &gt; 0 ? &quot; &quot; + content : content;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+              }</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+              if (ordinals.length &gt; 0) {</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+                  ordinals += &quot; &quot;;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+              }</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+              ordinals += treecols[i].ordinal;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+              if (widths.length &gt; 0) {</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+                  widths += &quot; &quot;;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+              }</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+              widths += treecols[i].width || 0;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+          }</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+          this.setAttribute(&quot;visible-columns&quot;, visible);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+          this.setAttribute(&quot;ordinals&quot;, ordinals);</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+          this.setAttribute(&quot;widths&quot;, widths);</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+          if (sorted) {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+              this.setAttribute(&quot;sort-active&quot;, sorted.getAttribute(&quot;itemproperty&quot;));</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+              this.setAttribute(&quot;sort-direction&quot;, this.mTreeView.sortDirection);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+          } else {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+              this.removeAttribute(&quot;sort-active&quot;);</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+              this.removeAttribute(&quot;sort-direction&quot;);</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+          }</span>
<a href="#l8.195"></a><span id="l8.195">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l8.196"></a><span id="l8.196"> </span>
<a href="#l8.197"></a><span id="l8.197">       &lt;field name=&quot;mTaskArray&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l8.198"></a><span id="l8.198">       &lt;field name=&quot;mHash2Index&quot;&gt;&lt;![CDATA[({})]]&gt;&lt;/field&gt;</span>
<a href="#l8.199"></a><span id="l8.199">       &lt;field name=&quot;mPendingRefreshJobs&quot;&gt;&lt;![CDATA[({})]]&gt;&lt;/field&gt;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-      &lt;field name=&quot;mShowCompletedTasks&quot;&gt;true&lt;/field&gt;</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-      &lt;field name=&quot;mFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-      &lt;field name=&quot;mStartDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-      &lt;field name=&quot;mEndDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-      &lt;field name=&quot;mDateRangeFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-      &lt;field name=&quot;mTextFilterField&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+        &lt;field name=&quot;mShowCompletedTasks&quot;&gt;true&lt;/field&gt;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+        &lt;field name=&quot;mFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+        &lt;field name=&quot;mStartDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+        &lt;field name=&quot;mEndDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+        &lt;field name=&quot;mDateRangeFilter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+        &lt;field name=&quot;mTextFilterField&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.212"></a><span id="l8.212"> </span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-      &lt;property name=&quot;currentIndex&quot;&gt;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-          let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-              this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-          return tree.currentIndex;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+        &lt;property name=&quot;currentIndex&quot;&gt;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+          &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+            let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+                this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+            return tree.currentIndex;</span>
<a href="#l8.223"></a><span id="l8.223">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.224"></a><span id="l8.224">       &lt;/property&gt;</span>
<a href="#l8.225"></a><span id="l8.225"> </span>
<a href="#l8.226"></a><span id="l8.226">       &lt;property name=&quot;currentTask&quot;&gt;</span>
<a href="#l8.227"></a><span id="l8.227">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-          let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-              this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-          let index = tree.currentIndex;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-          if (tree.view &amp;&amp; tree.view.selection) {</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-              // If the current index is not selected, then ignore</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-              index = (tree.view.selection.isSelected(index) ? index : -1);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-          }</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-          return index &lt; 0 ? null : this.mTaskArray[index];</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+            let tree = document.getAnonymousElementByAttribute(</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+                this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+            let index = tree.currentIndex;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+            if (tree.view &amp;&amp; tree.view.selection) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+                // If the current index is not selected, then ignore</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+                index = (tree.view.selection.isSelected(index) ? index : -1);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+            }</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+            return index &lt; 0 ? null : this.mTaskArray[index];</span>
<a href="#l8.244"></a><span id="l8.244">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.245"></a><span id="l8.245">       &lt;/property&gt;</span>
<a href="#l8.246"></a><span id="l8.246"> </span>
<a href="#l8.247"></a><span id="l8.247">       &lt;property name=&quot;selectedTasks&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.248"></a><span id="l8.248">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-          let tasks = [];</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-          let start = {};</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-          let end = {};</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-          if (!this.mTreeView.selection) {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-              return tasks;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-          }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+            let tasks = [];</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+            let start = {};</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+            let end = {};</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+            if (!this.mTreeView.selection) {</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+                return tasks;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+            }</span>
<a href="#l8.261"></a><span id="l8.261"> </span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-          let rangeCount = this.mTreeView.selection.getRangeCount();</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-          for (let range = 0; range &lt; rangeCount; range++) {</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-              this.mTreeView.selection.getRangeAt(range, start, end);</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-              for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-                  let task = this.getTaskAtRow(i);</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-                  if (task) {</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-                      tasks.push(this.getTaskAtRow(i));</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-                  }</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-              }</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-          }</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-          return tasks;</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+            let rangeCount = this.mTreeView.selection.getRangeCount();</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+            for (let range = 0; range &lt; rangeCount; range++) {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+                this.mTreeView.selection.getRangeAt(range, start, end);</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+                for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+                    let task = this.getTaskAtRow(i);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+                    if (task) {</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+                        tasks.push(this.getTaskAtRow(i));</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+                    }</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+                }</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+            }</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+            return tasks;</span>
<a href="#l8.284"></a><span id="l8.284">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.285"></a><span id="l8.285">       &lt;/property&gt;</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287">       &lt;property name=&quot;showCompleted&quot;&gt;</span>
<a href="#l8.288"></a><span id="l8.288">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-          return this.mShowCompletedTasks;</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+            return this.mShowCompletedTasks;</span>
<a href="#l8.291"></a><span id="l8.291">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.292"></a><span id="l8.292">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-          this.mShowCompletedTasks = val;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-          return val;</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+            this.mShowCompletedTasks = val;</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+            return val;</span>
<a href="#l8.297"></a><span id="l8.297">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l8.298"></a><span id="l8.298">       &lt;/property&gt;</span>
<a href="#l8.299"></a><span id="l8.299"> </span>
<a href="#l8.300"></a><span id="l8.300">       &lt;property name=&quot;textFilterField&quot;&gt;</span>
<a href="#l8.301"></a><span id="l8.301">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-          return this.mTextFilterField;</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+            return this.mTextFilterField;</span>
<a href="#l8.304"></a><span id="l8.304">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.305"></a><span id="l8.305">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-          this.mTextFilterField = val;</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-          return val;</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+            this.mTextFilterField = val;</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+            return val;</span>
<a href="#l8.310"></a><span id="l8.310">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l8.311"></a><span id="l8.311">       &lt;/property&gt;</span>
<a href="#l8.312"></a><span id="l8.312"> </span>
<a href="#l8.313"></a><span id="l8.313">       &lt;method name=&quot;duration&quot;&gt;</span>
<a href="#l8.314"></a><span id="l8.314">         &lt;parameter name=&quot;aTask&quot;/&gt;</span>
<a href="#l8.315"></a><span id="l8.315">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-          if (aTask &amp;&amp; aTask.dueDate &amp;&amp; aTask.dueDate.isValid) {</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-              let dur = aTask.dueDate.subtractDate(cal.now());</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-              if (!dur.isNegative) {</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-                  let minutes = Math.ceil(dur.inSeconds / 60);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-                  if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-                      let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-                      return dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-                  } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-                      let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-                      return dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-                  } else {</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-                      // Less than one hour</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-                      return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-                  }</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-              } else if (!aTask.completedDate || !aTask.completedDate.isValid) {</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-                  // Overdue task</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-                  let minutes = Math.ceil(-dur.inSeconds / 60);</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-                  if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-                      let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-                      return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-                  } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-                      let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-                      return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-                  } else {</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-                      // Less than one hour</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-                      return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-                  }</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-              }</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-          }</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-          // No due date specified</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-          return null;</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+            if (aTask &amp;&amp; aTask.dueDate &amp;&amp; aTask.dueDate.isValid) {</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+                let dur = aTask.dueDate.subtractDate(cal.now());</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+                if (!dur.isNegative) {</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+                    let minutes = Math.ceil(dur.inSeconds / 60);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+                    if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+                        let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+                        return dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+                    } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+                        let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+                        return dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+                    } else {</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+                        // Less than one hour</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+                        return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+                    }</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+                } else if (!aTask.completedDate || !aTask.completedDate.isValid) {</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+                    // Overdue task</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+                    let minutes = Math.ceil(-dur.inSeconds / 60);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+                    if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+                        let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+                        return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+                    } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+                        let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+                        return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+                    } else {</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+                        // Less than one hour</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+                        return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+                    }</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+                }</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+            }</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+            // No due date specified</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+            return null;</span>
<a href="#l8.378"></a><span id="l8.378">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.379"></a><span id="l8.379">       &lt;/method&gt;</span>
<a href="#l8.380"></a><span id="l8.380">       &lt;method name=&quot;getTaskAtRow&quot;&gt;</span>
<a href="#l8.381"></a><span id="l8.381">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.382"></a><span id="l8.382">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-          return (aRow &gt; -1 ? this.mTaskArray[aRow] : null);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+            return (aRow &gt; -1 ? this.mTaskArray[aRow] : null);</span>
<a href="#l8.385"></a><span id="l8.385">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.386"></a><span id="l8.386">       &lt;/method&gt;</span>
<a href="#l8.387"></a><span id="l8.387"> </span>
<a href="#l8.388"></a><span id="l8.388">       &lt;method name=&quot;getTaskFromEvent&quot;&gt;</span>
<a href="#l8.389"></a><span id="l8.389">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.390"></a><span id="l8.390">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineminus">-          return this.mTreeView._getItemFromEvent(aEvent);</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+            return this.mTreeView._getItemFromEvent(aEvent);</span>
<a href="#l8.393"></a><span id="l8.393">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.394"></a><span id="l8.394">       &lt;/method&gt;</span>
<a href="#l8.395"></a><span id="l8.395"> </span>
<a href="#l8.396"></a><span id="l8.396">       &lt;field name=&quot;mTreeView&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-      ({</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsITreeView]),</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+        ({</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsITreeView]),</span>
<a href="#l8.401"></a><span id="l8.401"> </span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-          /**</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-           * Attributes</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineminus">-           */</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+            /**</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+             * Attributes</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+             */</span>
<a href="#l8.408"></a><span id="l8.408"> </span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-          // back reference to the binding</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-          binding: this,</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-          tree: null,</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-          treebox: null,</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-          mSelectedColumn: null,</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineminus">-          sortDirection: null,</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+            // back reference to the binding</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+            binding: this,</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+            tree: null,</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+            treebox: null,</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+            mSelectedColumn: null,</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+            sortDirection: null,</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-          get selectedColumn() {</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-              return this.mSelectedColumn;</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-          },</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+            get selectedColumn() {</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+                return this.mSelectedColumn;</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+            },</span>
<a href="#l8.428"></a><span id="l8.428"> </span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-          set selectedColumn(aCol) {</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-              let tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-              let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-              for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-                  let col = treecols[i];</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-                  if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-                      col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineminus">-                      col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-                  }</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-                  if (aCol.getAttribute(&quot;itemproperty&quot;) == col.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-                      col.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-                      col.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-                  }</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-              }</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-              return (this.mSelectedColumn = aCol);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-          },</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+            set selectedColumn(aCol) {</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+                let tree = document.getAnonymousNodes(this.binding)[0];</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+                let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+                for (let i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+                    let col = treecols[i];</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+                    if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+                        col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+                        col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+                    }</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+                    if (aCol.getAttribute(&quot;itemproperty&quot;) == col.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+                        col.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+                        col.setAttribute(&quot;sortDirection&quot;, this.sortDirection);</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+                    }</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+                }</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+                return (this.mSelectedColumn = aCol);</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+            },</span>
<a href="#l8.461"></a><span id="l8.461"> </span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-          /**</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-           * High-level task tree manipulation</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-           */</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+            /**</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+             * High-level task tree manipulation</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+             */</span>
<a href="#l8.468"></a><span id="l8.468"> </span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-          // Adds an array of items to the list if they match the currently applied filter.</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-          addItems: function(aItems, aDontSort) {</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-              this.modifyItems(aItems, [], aDontSort, true);</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-          },</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+            // Adds an array of items to the list if they match the currently applied filter.</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+            addItems: function(aItems, aDontSort) {</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+                this.modifyItems(aItems, [], aDontSort, true);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+            },</span>
<a href="#l8.477"></a><span id="l8.477"> </span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-          // Removes an array of items from the list.</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-          removeItems: function(aItems) {</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-              this.modifyItems([], aItems, true, false);</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-          },</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+            // Removes an array of items from the list.</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+            removeItems: function(aItems) {</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+                this.modifyItems([], aItems, true, false);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+            },</span>
<a href="#l8.486"></a><span id="l8.486"> </span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-          // Removes an array of old items from the list, and adds an array of new items if</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-          // they match the currently applied filter.</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-          modifyItems: function(aNewItems, aOldItems, aDontSort, aSelectNew) {</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-              let selItem = this.binding.currentTask;</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-              let selIndex = this.tree.currentIndex;</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-              let firstHash = null;</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-              let remIndexes = [];</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-              aNewItems = aNewItems || [];</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-              aOldItems = aOldItems || [];</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+            // Removes an array of old items from the list, and adds an array of new items if</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+            // they match the currently applied filter.</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+            modifyItems: function(aNewItems, aOldItems, aDontSort, aSelectNew) {</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+                let selItem = this.binding.currentTask;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+                let selIndex = this.tree.currentIndex;</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+                let firstHash = null;</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+                let remIndexes = [];</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+                aNewItems = aNewItems || [];</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+                aOldItems = aOldItems || [];</span>
<a href="#l8.505"></a><span id="l8.505"> </span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-              this.treebox.beginUpdateBatch();</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+                this.treebox.beginUpdateBatch();</span>
<a href="#l8.508"></a><span id="l8.508"> </span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-              let idiff = new itemDiff();</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-              idiff.load(aOldItems);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-              idiff.difference(aNewItems);</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-              idiff.complete();</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-              let delItems = idiff.deletedItems;</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-              let addItems = idiff.addedItems;</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-              let modItems = idiff.modifiedItems;</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+                let idiff = new itemDiff();</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+                idiff.load(aOldItems);</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+                idiff.difference(aNewItems);</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+                idiff.complete();</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+                let delItems = idiff.deletedItems;</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+                let addItems = idiff.addedItems;</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+                let modItems = idiff.modifiedItems;</span>
<a href="#l8.523"></a><span id="l8.523"> </span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-              // find the indexes of the old items that need to be removed</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-              for (let item of delItems.mArray) {</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-                  if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-                      // the old item needs to be removed</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-                      remIndexes.push(this.binding.mHash2Index[item.hashId]);</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-                      delete this.binding.mHash2Index[item.hashId];</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-                  }</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-              }</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+                // find the indexes of the old items that need to be removed</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+                for (let item of delItems.mArray) {</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+                    if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+                        // the old item needs to be removed</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+                        remIndexes.push(this.binding.mHash2Index[item.hashId]);</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+                        delete this.binding.mHash2Index[item.hashId];</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+                    }</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+                }</span>
<a href="#l8.540"></a><span id="l8.540"> </span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-              // modified items need to be updated</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-              for (let item of modItems.mArray) {</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-                  if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-                      // make sure we're using the new version of a modified item</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-                      this.binding.mTaskArray[this.binding.mHash2Index[item.hashId]] = item;</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-                  }</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-              }</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+                // modified items need to be updated</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+                for (let item of modItems.mArray) {</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+                    if (item.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+                        // make sure we're using the new version of a modified item</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+                        this.binding.mTaskArray[this.binding.mHash2Index[item.hashId]] = item;</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+                    }</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+                }</span>
<a href="#l8.555"></a><span id="l8.555"> </span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-              // remove the old items working backward from the end so the indexes stay valid</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-              remIndexes.sort((a, b) =&gt; b - a).forEach((index) =&gt; {</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-                  this.binding.mTaskArray.splice(index, 1);</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-                  this.treebox.rowCountChanged(index, -1);</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-              });</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+                // remove the old items working backward from the end so the indexes stay valid</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+                remIndexes.sort((a, b) =&gt; b - a).forEach((index) =&gt; {</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+                    this.binding.mTaskArray.splice(index, 1);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+                    this.treebox.rowCountChanged(index, -1);</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+                });</span>
<a href="#l8.566"></a><span id="l8.566"> </span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-              // add the new items</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-              for (let item of addItems.mArray) {</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineminus">-                  if (!(item.hashId in this.binding.mHash2Index)) {</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-                      let index = this.binding.mTaskArray.length;</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-                      this.binding.mTaskArray.push(item);</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-                      this.binding.mHash2Index[item.hashId] = index;</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-                      this.treebox.rowCountChanged(index, 1);</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-                      firstHash = firstHash || item.hashId;</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-                  }</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-              }</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+                // add the new items</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+                for (let item of addItems.mArray) {</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+                    if (!(item.hashId in this.binding.mHash2Index)) {</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+                        let index = this.binding.mTaskArray.length;</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+                        this.binding.mTaskArray.push(item);</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+                        this.binding.mHash2Index[item.hashId] = index;</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+                        this.treebox.rowCountChanged(index, 1);</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+                        firstHash = firstHash || item.hashId;</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+                    }</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+                }</span>
<a href="#l8.587"></a><span id="l8.587"> </span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-              if (aDontSort) {</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-                  this.binding.recreateHashTable();</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-              } else {</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-                  this.binding.sortItems();</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-              }</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+                if (aDontSort) {</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+                    this.binding.recreateHashTable();</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+                } else {</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+                    this.binding.sortItems();</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+                }</span>
<a href="#l8.598"></a><span id="l8.598"> </span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-              if (aSelectNew &amp;&amp; firstHash &amp;&amp; firstHash in this.binding.mHash2Index) {</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-                  // select the first item added into the list</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-                  selIndex = this.binding.mHash2Index[firstHash];</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-              } else if (selItem &amp;&amp; selItem.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-                  // select the previously selected item</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-                  selIndex = this.binding.mHash2Index[selItem.hashId];</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-              } else if (selIndex &gt;= this.binding.mTaskArray.length) {</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-                  // make sure the previously selected index is valid</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-                  selIndex = this.binding.mTaskArray.length - 1;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-              }</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+                if (aSelectNew &amp;&amp; firstHash &amp;&amp; firstHash in this.binding.mHash2Index) {</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+                    // select the first item added into the list</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+                    selIndex = this.binding.mHash2Index[firstHash];</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+                } else if (selItem &amp;&amp; selItem.hashId in this.binding.mHash2Index) {</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+                    // select the previously selected item</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+                    selIndex = this.binding.mHash2Index[selItem.hashId];</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+                } else if (selIndex &gt;= this.binding.mTaskArray.length) {</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+                    // make sure the previously selected index is valid</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+                    selIndex = this.binding.mTaskArray.length - 1;</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+                }</span>
<a href="#l8.619"></a><span id="l8.619"> </span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-              if (selIndex &gt; -1) {</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-                  this.tree.view.selection.select(selIndex);</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-                  this.treebox.ensureRowIsVisible(selIndex);</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-              }</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+                if (selIndex &gt; -1) {</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+                    this.tree.view.selection.select(selIndex);</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+                    this.treebox.ensureRowIsVisible(selIndex);</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+                }</span>
<a href="#l8.628"></a><span id="l8.628"> </span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-              this.treebox.endUpdateBatch();</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-          },</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+                this.treebox.endUpdateBatch();</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+            },</span>
<a href="#l8.633"></a><span id="l8.633"> </span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-          clear: function() {</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-              let count = this.binding.mTaskArray.length;</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-              if (count &gt; 0) {</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-                  this.binding.mTaskArray = [];</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-                  this.binding.mHash2Index = {};</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-                  this.treebox.rowCountChanged(0, -count);</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-                  this.tree.view.selection.clearSelection();</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-              }</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-          },</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+            clear: function() {</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+                let count = this.binding.mTaskArray.length;</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+                if (count &gt; 0) {</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+                    this.binding.mTaskArray = [];</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+                    this.binding.mHash2Index = {};</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+                    this.treebox.rowCountChanged(0, -count);</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+                    this.tree.view.selection.clearSelection();</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+                }</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+            },</span>
<a href="#l8.652"></a><span id="l8.652"> </span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-          updateItem: function(aItem) {</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-              let index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-              if (index) {</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-                  this.treebox.invalidateRow(index);</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-              }</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-          },</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+            updateItem: function(aItem) {</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+                let index = this.binding.mHash2Index[aItem.hashId];</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+                if (index) {</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+                    this.treebox.invalidateRow(index);</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+                }</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+            },</span>
<a href="#l8.665"></a><span id="l8.665"> </span>
<a href="#l8.666"></a><span id="l8.666" class="difflineminus">-          /**</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-           * nsITreeView methods and properties</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-           */</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+            /**</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+             * nsITreeView methods and properties</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+             */</span>
<a href="#l8.672"></a><span id="l8.672"> </span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-          get rowCount() {</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-              return this.binding.mTaskArray.length;</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-          },</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+            get rowCount() {</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+                return this.binding.mTaskArray.length;</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+            },</span>
<a href="#l8.679"></a><span id="l8.679"> </span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-          // TODO this code is currently identical to the unifinder. We should</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-          // create an itemTreeView that these tree views can inherit, that</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-          // contains this code, and possibly other code related to sorting and</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-          // storing items. See bug 432582 for more details.</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-          getCellProperties: function(aRow, aCol) {</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineminus">-              let rowProps = this.getRowProperties(aRow);</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineminus">-              let colProps = this.getColumnProperties(aCol);</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineminus">-              return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineminus">-          },</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+            // TODO this code is currently identical to the unifinder. We should</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+            // create an itemTreeView that these tree views can inherit, that</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+            // contains this code, and possibly other code related to sorting and</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+            // storing items. See bug 432582 for more details.</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+            getCellProperties: function(aRow, aCol) {</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+                let rowProps = this.getRowProperties(aRow);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+                let colProps = this.getColumnProperties(aCol);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+                return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+            },</span>
<a href="#l8.698"></a><span id="l8.698"> </span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-          // Called to get properties to paint a column background.</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-          // For shading the sort column, etc.</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-          getColumnProperties: function(aCol) {</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-              return aCol.element.getAttribute(&quot;anonid&quot;) || &quot;&quot;;</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-          },</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+            // Called to get properties to paint a column background.</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+            // For shading the sort column, etc.</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+            getColumnProperties: function(aCol) {</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+                return aCol.element.getAttribute(&quot;anonid&quot;) || &quot;&quot;;</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+            },</span>
<a href="#l8.709"></a><span id="l8.709"> </span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-          getRowProperties: function(aRow) {</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-              let properties = [];</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-              let item = this.binding.mTaskArray[aRow];</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-              if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-                  properties.push(&quot;highpriority&quot;);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-              } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-                  properties.push(&quot;lowpriority&quot;);</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-              }</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-              properties.push(cal.getProgressAtom(item));</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+            getRowProperties: function(aRow) {</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+                let properties = [];</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+                let item = this.binding.mTaskArray[aRow];</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+                if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+                    properties.push(&quot;highpriority&quot;);</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+                } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+                    properties.push(&quot;lowpriority&quot;);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+                }</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+                properties.push(cal.getProgressAtom(item));</span>
<a href="#l8.728"></a><span id="l8.728"> </span>
<a href="#l8.729"></a><span id="l8.729" class="difflineminus">-              // Add calendar name and id atom</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-              properties.push(&quot;calendar-&quot; + cal.formatStringForCSSRule(item.calendar.name));</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineminus">-              properties.push(&quot;calendarid-&quot; + cal.formatStringForCSSRule(item.calendar.id));</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+                // Add calendar name and id atom</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+                properties.push(&quot;calendar-&quot; + cal.formatStringForCSSRule(item.calendar.name));</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+                properties.push(&quot;calendarid-&quot; + cal.formatStringForCSSRule(item.calendar.id));</span>
<a href="#l8.735"></a><span id="l8.735"> </span>
<a href="#l8.736"></a><span id="l8.736" class="difflineminus">-              // Add item status atom</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-              if (item.status) {</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-                  properties.push(&quot;status-&quot; + item.status.toLowerCase());</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-              }</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+                // Add item status atom</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+                if (item.status) {</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+                    properties.push(&quot;status-&quot; + item.status.toLowerCase());</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+                }</span>
<a href="#l8.744"></a><span id="l8.744"> </span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-              // Alarm status atom</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-              if (item.getAlarms({}).length) {</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineminus">-                  properties.push(&quot;alarm&quot;);</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-              }</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+                // Alarm status atom</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+                if (item.getAlarms({}).length) {</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+                    properties.push(&quot;alarm&quot;);</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+                }</span>
<a href="#l8.753"></a><span id="l8.753"> </span>
<a href="#l8.754"></a><span id="l8.754" class="difflineminus">-              // Task categories</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-              properties = properties.concat(item.getCategories({})</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-                                                 .map(cal.formatStringForCSSRule));</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+                // Task categories</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+                properties = properties.concat(item.getCategories({})</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+                                                   .map(cal.formatStringForCSSRule));</span>
<a href="#l8.760"></a><span id="l8.760"> </span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-              return properties.join(&quot; &quot;);</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-          },</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+                return properties.join(&quot; &quot;);</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+            },</span>
<a href="#l8.765"></a><span id="l8.765"> </span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-          // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-          // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-          cycleCell: function(aRow, aCol) {</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+            // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+            // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+            cycleCell: function(aRow, aCol) {</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+                let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.774"></a><span id="l8.774"> </span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-              // prevent toggling completed status for parent items of</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-              // repeating tasks or when the calendar is read-only.</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-              if (!task || task.recurrenceInfo || task.calendar.readOnly) {</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-                  return;</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-              }</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-              if (aCol != null) {</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-                  let content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-                  if (content == &quot;completed&quot;) {</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-                      let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-                      newTask.isCompleted = !task.completedDate;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-                      doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-                  }</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-              }</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-          },</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+                // prevent toggling completed status for parent items of</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+                // repeating tasks or when the calendar is read-only.</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+                if (!task || task.recurrenceInfo || task.calendar.readOnly) {</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+                    return;</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+                }</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+                if (aCol != null) {</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+                    let content = aCol.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+                    if (content == &quot;completed&quot;) {</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+                        let newTask = task.clone().QueryInterface(Components.interfaces.calITodo);</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+                        newTask.isCompleted = !task.completedDate;</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+                        doTransaction(&quot;modify&quot;, newTask, newTask.calendar, task, null);</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+                    }</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+                }</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+            },</span>
<a href="#l8.803"></a><span id="l8.803"> </span>
<a href="#l8.804"></a><span id="l8.804" class="difflineminus">-          // Called on the view when a header is clicked.</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-          cycleHeader: function(aCol) {</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-              if (!this.selectedColumn) {</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-                  this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-              } else if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-                  this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-              } else {</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-                  this.sortDirection = &quot;descending&quot;;</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-              }</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-              this.selectedColumn = aCol.element;</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-              let selectedItems = this.binding.selectedTasks;</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-              this.binding.sortItems();</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-              if (selectedItems != undefined) {</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-                  this.tree.view.selection.clearSelection();</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-                  for (let item of selectedItems) {</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-                      let index = this.binding.mHash2Index[item.hashId];</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-                      this.tree.view.selection.toggleSelect(index);</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-                  }</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-              }</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-          },</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+            // Called on the view when a header is clicked.</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+            cycleHeader: function(aCol) {</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+                if (!this.selectedColumn) {</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+                    this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+                } else if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+                    this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+                } else {</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineplus">+                    this.sortDirection = &quot;descending&quot;;</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+                }</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+                this.selectedColumn = aCol.element;</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineplus">+                let selectedItems = this.binding.selectedTasks;</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+                this.binding.sortItems();</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+                if (selectedItems != undefined) {</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineplus">+                    this.tree.view.selection.clearSelection();</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineplus">+                    for (let item of selectedItems) {</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+                        let index = this.binding.mHash2Index[item.hashId];</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+                        this.tree.view.selection.toggleSelect(index);</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineplus">+                    }</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+                }</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+            },</span>
<a href="#l8.844"></a><span id="l8.844"> </span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-          // The text for a given cell. If a column consists only of an</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-          // image, then the empty string is returned.</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-          getCellText: function(aRow, aCol) {</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-              if (!task) {</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-                  return false;</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineminus">-              }</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+            // The text for a given cell. If a column consists only of an</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+            // image, then the empty string is returned.</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+            getCellText: function(aRow, aCol) {</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+                let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+                if (!task) {</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+                    return false;</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+                }</span>
<a href="#l8.859"></a><span id="l8.859"> </span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-              switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-                  case &quot;title&quot;:</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-                      // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-                      return (task.title ? task.title.replace(/\n/g, &quot; &quot;) : cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-                  case &quot;entryDate&quot;:</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.entryDate);</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-                  case &quot;dueDate&quot;:</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.dueDate);</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-                  case &quot;completedDate&quot;:</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.completedDate);</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-                  case &quot;percentComplete&quot;:</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-                      return (task.percentComplete &gt; 0 ? task.percentComplete + &quot;%&quot; : &quot;&quot;);</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-                  case &quot;categories&quot;:</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-                      return task.getCategories({}).join(&quot;, &quot;); // TODO l10n-unfriendly</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-                  case &quot;location&quot;:</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-                      return task.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineminus">-                  case &quot;status&quot;:</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineminus">-                      return getToDoStatusString(task);</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineminus">-                  case &quot;calendar&quot;:</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-                      return task.calendar.name;</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-                  case &quot;duration&quot;:</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-                      return this.binding.duration(task);</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-                  case &quot;completed&quot;:</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineminus">-                  case &quot;priority&quot;:</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineminus">-                  default:</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-                      return &quot;&quot;;</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-              }</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-          },</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineplus">+                switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+                    case &quot;title&quot;:</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+                        // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+                        return (task.title ? task.title.replace(/\n/g, &quot; &quot;) : cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineplus">+                    case &quot;entryDate&quot;:</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineplus">+                        return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.entryDate);</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+                    case &quot;dueDate&quot;:</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineplus">+                        return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.dueDate);</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+                    case &quot;completedDate&quot;:</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+                        return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.completedDate);</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineplus">+                    case &quot;percentComplete&quot;:</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+                        return (task.percentComplete &gt; 0 ? task.percentComplete + &quot;%&quot; : &quot;&quot;);</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineplus">+                    case &quot;categories&quot;:</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineplus">+                        return task.getCategories({}).join(&quot;, &quot;); // TODO l10n-unfriendly</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineplus">+                    case &quot;location&quot;:</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineplus">+                        return task.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+                    case &quot;status&quot;:</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineplus">+                        return getToDoStatusString(task);</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineplus">+                    case &quot;calendar&quot;:</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+                        return task.calendar.name;</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineplus">+                    case &quot;duration&quot;:</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineplus">+                        return this.binding.duration(task);</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineplus">+                    case &quot;completed&quot;:</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineplus">+                    case &quot;priority&quot;:</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+                    default:</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineplus">+                        return &quot;&quot;;</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineplus">+                }</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineplus">+            },</span>
<a href="#l8.916"></a><span id="l8.916"> </span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-          // This method is only called for columns of type other than text.</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-          getCellValue: function(aRow, aCol) {</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-              let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-              if (!task) {</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-                  return null;</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-              }</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-              switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-                  case &quot;percentComplete&quot;:</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-                      return task.percentComplete;</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-              }</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-              return null;</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-          },</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineplus">+            // This method is only called for columns of type other than text.</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+            getCellValue: function(aRow, aCol) {</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+                let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+                if (!task) {</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+                    return null;</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+                }</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+                switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+                    case &quot;percentComplete&quot;:</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+                        return task.percentComplete;</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+                }</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+                return null;</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+            },</span>
<a href="#l8.941"></a><span id="l8.941"> </span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-          // SetCellValue is called when the value of the cell has been set by the user.</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-          // This method is only called for columns of type other than text.</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-          setCellValue: function(aRow, aCol, aValue) {</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-              return null;</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineminus">-          },</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+            // SetCellValue is called when the value of the cell has been set by the user.</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+            // This method is only called for columns of type other than text.</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+            setCellValue: function(aRow, aCol, aValue) {</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+                return null;</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+            },</span>
<a href="#l8.952"></a><span id="l8.952"> </span>
<a href="#l8.953"></a><span id="l8.953" class="difflineminus">-          // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-          // If the empty string is returned, the :moz-tree-image pseudoelement will be used.</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-          getImageSrc: function(aRow, aCol) {</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-              // Return the empty string in order</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-              // to use moz-tree-image pseudoelement :</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-              // it is mandatory to return &quot;&quot; and not false :-(</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineminus">-          },</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+            // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+            // If the empty string is returned, the :moz-tree-image pseudoelement will be used.</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+            getImageSrc: function(aRow, aCol) {</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+                // Return the empty string in order</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineplus">+                // to use moz-tree-image pseudoelement :</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineplus">+                // it is mandatory to return &quot;&quot; and not false :-(</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineplus">+                return &quot;&quot;;</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineplus">+            },</span>
<a href="#l8.969"></a><span id="l8.969"> </span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-          // IsEditable is called to ask the view if the cell contents are editable.</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineminus">-          // A value of true will result in the tree popping up a text field when the user</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineminus">-          // tries to inline edit the cell.</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-          isEditable: function(aRow, aCol) {</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineminus">-              return true;</span>
<a href="#l8.975"></a><span id="l8.975" class="difflineminus">-          },</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineplus">+            // IsEditable is called to ask the view if the cell contents are editable.</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+            // A value of true will result in the tree popping up a text field when the user</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+            // tries to inline edit the cell.</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineplus">+            isEditable: function(aRow, aCol) {</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineplus">+                return true;</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+            },</span>
<a href="#l8.982"></a><span id="l8.982"> </span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-          // Called during initialization to link the view to the front end box object.</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-          setTree: function(aTreeBox) {</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-              this.treebox = aTreeBox;</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineminus">-          },</span>
<a href="#l8.987"></a><span id="l8.987" class="difflineplus">+            // Called during initialization to link the view to the front end box object.</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineplus">+            setTree: function(aTreeBox) {</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+                this.treebox = aTreeBox;</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineplus">+            },</span>
<a href="#l8.991"></a><span id="l8.991"> </span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-          // Methods that can be used to test whether or not a twisty should</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineminus">-          // be drawn, and if so, whether an open or closed twisty should be used.</span>
<a href="#l8.994"></a><span id="l8.994" class="difflineminus">-          isContainer: function(aRow) {</span>
<a href="#l8.995"></a><span id="l8.995" class="difflineminus">-              return false;</span>
<a href="#l8.996"></a><span id="l8.996" class="difflineminus">-          },</span>
<a href="#l8.997"></a><span id="l8.997" class="difflineminus">-          isContainerOpen: function(aRow) {</span>
<a href="#l8.998"></a><span id="l8.998" class="difflineminus">-              return false;</span>
<a href="#l8.999"></a><span id="l8.999" class="difflineminus">-          },</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineminus">-          isContainerEmpty: function(aRow) {</span>
<a href="#l8.1001"></a><span id="l8.1001" class="difflineminus">-              return false;</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineminus">-          },</span>
<a href="#l8.1003"></a><span id="l8.1003" class="difflineplus">+            // Methods that can be used to test whether or not a twisty should</span>
<a href="#l8.1004"></a><span id="l8.1004" class="difflineplus">+            // be drawn, and if so, whether an open or closed twisty should be used.</span>
<a href="#l8.1005"></a><span id="l8.1005" class="difflineplus">+            isContainer: function(aRow) {</span>
<a href="#l8.1006"></a><span id="l8.1006" class="difflineplus">+                return false;</span>
<a href="#l8.1007"></a><span id="l8.1007" class="difflineplus">+            },</span>
<a href="#l8.1008"></a><span id="l8.1008" class="difflineplus">+            isContainerOpen: function(aRow) {</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineplus">+                return false;</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineplus">+            },</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineplus">+            isContainerEmpty: function(aRow) {</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineplus">+                return false;</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+            },</span>
<a href="#l8.1014"></a><span id="l8.1014"> </span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-          // IsSeparator is used to determine if the row at index is a separator.</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-          // A value of true will result in the tree drawing a horizontal separator.</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-          // The tree uses the ::moz-tree-separator pseudoclass to draw the separator.</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-          isSeparator: function(aRow) {</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-              return false;</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-          },</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineplus">+            // IsSeparator is used to determine if the row at index is a separator.</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineplus">+            // A value of true will result in the tree drawing a horizontal separator.</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineplus">+            // The tree uses the ::moz-tree-separator pseudoclass to draw the separator.</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineplus">+            isSeparator: function(aRow) {</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineplus">+                return false;</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineplus">+            },</span>
<a href="#l8.1027"></a><span id="l8.1027"> </span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-          // Specifies if there is currently a sort on any column.</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-          // Used mostly by drag'n'drop to affect drop feedback.</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-          isSorted: function(aRow) {</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-              return false;</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-          },</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineplus">+            // Specifies if there is currently a sort on any column.</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineplus">+            // Used mostly by drag'n'drop to affect drop feedback.</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineplus">+            isSorted: function(aRow) {</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineplus">+                return false;</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineplus">+            },</span>
<a href="#l8.1038"></a><span id="l8.1038"> </span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-          canDrop: function() { return false; },</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+            canDrop: function() { return false; },</span>
<a href="#l8.1041"></a><span id="l8.1041"> </span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-          drop: function(aRow, aOrientation) {},</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineplus">+            drop: function(aRow, aOrientation) {},</span>
<a href="#l8.1044"></a><span id="l8.1044"> </span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-          getParentIndex: function(aRow) {</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-              return -1;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-          },</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineplus">+            getParentIndex: function(aRow) {</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineplus">+                return -1;</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineplus">+            },</span>
<a href="#l8.1051"></a><span id="l8.1051"> </span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineminus">-          // The level is an integer value that represents the level of indentation.</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineminus">-          // It is multiplied by the width specified in the :moz-tree-indentation</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineminus">-          // pseudoelement to compute the exact indendation.</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineminus">-          getLevel: function(aRow) {</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineminus">-              return 0;</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineminus">-          },</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+            // The level is an integer value that represents the level of indentation.</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineplus">+            // It is multiplied by the width specified in the :moz-tree-indentation</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineplus">+            // pseudoelement to compute the exact indendation.</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineplus">+            getLevel: function(aRow) {</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineplus">+                return 0;</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+            },</span>
<a href="#l8.1064"></a><span id="l8.1064"> </span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineminus">-          // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineminus">-          // If the empty string is returned, the :moz-tree-image pseudoelement</span>
<a href="#l8.1067"></a><span id="l8.1067" class="difflineminus">-          // will be used.</span>
<a href="#l8.1068"></a><span id="l8.1068" class="difflineminus">-          getImgSrc: function(aRow, aCol) {</span>
<a href="#l8.1069"></a><span id="l8.1069" class="difflineminus">-              return null;</span>
<a href="#l8.1070"></a><span id="l8.1070" class="difflineminus">-          },</span>
<a href="#l8.1071"></a><span id="l8.1071" class="difflineplus">+            // The image path for a given cell. For defining an icon for a cell.</span>
<a href="#l8.1072"></a><span id="l8.1072" class="difflineplus">+            // If the empty string is returned, the :moz-tree-image pseudoelement</span>
<a href="#l8.1073"></a><span id="l8.1073" class="difflineplus">+            // will be used.</span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineplus">+            getImgSrc: function(aRow, aCol) {</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineplus">+                return null;</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineplus">+            },</span>
<a href="#l8.1077"></a><span id="l8.1077"> </span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineminus">-          // The progress mode for a given cell. This method is only called for</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineminus">-          // columns of type |progressmeter|.</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineminus">-          getProgressMode: function(aRow, aCol) {</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineminus">-              switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.1082"></a><span id="l8.1082" class="difflineminus">-                  case &quot;percentComplete&quot;: {</span>
<a href="#l8.1083"></a><span id="l8.1083" class="difflineminus">-                      let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-                      if (aCol.element.boxObject.width &gt; 75 &amp;&amp;</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-                          task.percentComplete &gt; 0) {</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-                          // XXX Would be nice if we could use relative widths,</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-                          // i.e &quot;15ex&quot;, but there is no scriptable interface.</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-                          return Components.interfaces.nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-                      }</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-                      break;</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-                  }</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-              }</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineplus">+            // The progress mode for a given cell. This method is only called for</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineplus">+            // columns of type |progressmeter|.</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineplus">+            getProgressMode: function(aRow, aCol) {</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineplus">+                switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineplus">+                    case &quot;percentComplete&quot;: {</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineplus">+                        let task = this.binding.mTaskArray[aRow];</span>
<a href="#l8.1099"></a><span id="l8.1099" class="difflineplus">+                        if (aCol.element.boxObject.width &gt; 75 &amp;&amp;</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineplus">+                            task.percentComplete &gt; 0) {</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineplus">+                            // XXX Would be nice if we could use relative widths,</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineplus">+                            // i.e &quot;15ex&quot;, but there is no scriptable interface.</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineplus">+                            return Components.interfaces.nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineplus">+                        }</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineplus">+                        break;</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineplus">+                    }</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineplus">+                }</span>
<a href="#l8.1108"></a><span id="l8.1108"> </span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineminus">-              return Components.interfaces.nsITreeView.PROGRESS_NONE;</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineminus">-          },</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineplus">+                return Components.interfaces.nsITreeView.PROGRESS_NONE;</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineplus">+            },</span>
<a href="#l8.1113"></a><span id="l8.1113"> </span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineminus">-          /**</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineminus">-           * Task Tree Events</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-           */</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineminus">-          onSelect: function(event) {},</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineplus">+            /**</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineplus">+             * Task Tree Events</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineplus">+             */</span>
<a href="#l8.1121"></a><span id="l8.1121" class="difflineplus">+            onSelect: function(event) {},</span>
<a href="#l8.1122"></a><span id="l8.1122"> </span>
<a href="#l8.1123"></a><span id="l8.1123" class="difflineminus">-          onDoubleClick: function(event) {</span>
<a href="#l8.1124"></a><span id="l8.1124" class="difflineminus">-              if (event.button == 0) {</span>
<a href="#l8.1125"></a><span id="l8.1125" class="difflineminus">-                  let initialDate = cal.getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l8.1126"></a><span id="l8.1126" class="difflineminus">-                  let col = {};</span>
<a href="#l8.1127"></a><span id="l8.1127" class="difflineminus">-                  let item = this._getItemFromEvent(event, col);</span>
<a href="#l8.1128"></a><span id="l8.1128" class="difflineminus">-                  if (item) {</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineminus">-                      let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.1130"></a><span id="l8.1130" class="difflineminus">-                      if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l8.1131"></a><span id="l8.1131" class="difflineminus">-                          // item holds checkbox state toggled by first click,</span>
<a href="#l8.1132"></a><span id="l8.1132" class="difflineminus">-                          // so don't call modifyEventWithDialog</span>
<a href="#l8.1133"></a><span id="l8.1133" class="difflineminus">-                          // to make sure user notices state changed.</span>
<a href="#l8.1134"></a><span id="l8.1134" class="difflineminus">-                      } else {</span>
<a href="#l8.1135"></a><span id="l8.1135" class="difflineminus">-                          modifyEventWithDialog(item, null, true, initialDate);</span>
<a href="#l8.1136"></a><span id="l8.1136" class="difflineminus">-                      }</span>
<a href="#l8.1137"></a><span id="l8.1137" class="difflineminus">-                  } else {</span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-                      createTodoWithDialog(null, null, null, null, initialDate);</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineminus">-                  }</span>
<a href="#l8.1140"></a><span id="l8.1140" class="difflineminus">-              }</span>
<a href="#l8.1141"></a><span id="l8.1141" class="difflineminus">-          },</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineplus">+            onDoubleClick: function(event) {</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineplus">+                if (event.button == 0) {</span>
<a href="#l8.1144"></a><span id="l8.1144" class="difflineplus">+                    let initialDate = cal.getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l8.1145"></a><span id="l8.1145" class="difflineplus">+                    let col = {};</span>
<a href="#l8.1146"></a><span id="l8.1146" class="difflineplus">+                    let item = this._getItemFromEvent(event, col);</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineplus">+                    if (item) {</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineplus">+                        let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineplus">+                        if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineplus">+                            // item holds checkbox state toggled by first click,</span>
<a href="#l8.1151"></a><span id="l8.1151" class="difflineplus">+                            // so don't call modifyEventWithDialog</span>
<a href="#l8.1152"></a><span id="l8.1152" class="difflineplus">+                            // to make sure user notices state changed.</span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineplus">+                        } else {</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineplus">+                            modifyEventWithDialog(item, null, true, initialDate);</span>
<a href="#l8.1155"></a><span id="l8.1155" class="difflineplus">+                        }</span>
<a href="#l8.1156"></a><span id="l8.1156" class="difflineplus">+                    } else {</span>
<a href="#l8.1157"></a><span id="l8.1157" class="difflineplus">+                        createTodoWithDialog(null, null, null, null, initialDate);</span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineplus">+                    }</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineplus">+                }</span>
<a href="#l8.1160"></a><span id="l8.1160" class="difflineplus">+            },</span>
<a href="#l8.1161"></a><span id="l8.1161"> </span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-          onKeyPress: function(event) {</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-              const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-              switch (event.keyCode || event.which) {</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-                  case kKE.DOM_VK_DELETE: {</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineminus">-                      document.popupNode = this.binding;</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineminus">-                      document.getElementById(&quot;calendar_delete_todo_command&quot;).doCommand();</span>
<a href="#l8.1168"></a><span id="l8.1168" class="difflineminus">-                      event.preventDefault();</span>
<a href="#l8.1169"></a><span id="l8.1169" class="difflineminus">-                      event.stopPropagation();</span>
<a href="#l8.1170"></a><span id="l8.1170" class="difflineminus">-                      break;</span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-                  }</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineminus">-                  case kKE.DOM_VK_SPACE: {</span>
<a href="#l8.1173"></a><span id="l8.1173" class="difflineminus">-                      if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l8.1174"></a><span id="l8.1174" class="difflineminus">-                          let col = document.getAnonymousElementByAttribute(</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-                              this.binding, &quot;itemproperty&quot;, &quot;completed&quot;);</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineminus">-                          this.cycleCell(</span>
<a href="#l8.1177"></a><span id="l8.1177" class="difflineminus">-                              this.tree.currentIndex,</span>
<a href="#l8.1178"></a><span id="l8.1178" class="difflineminus">-                              { element: col });</span>
<a href="#l8.1179"></a><span id="l8.1179" class="difflineminus">-                      }</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-                      break;</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineminus">-                  }</span>
<a href="#l8.1182"></a><span id="l8.1182" class="difflineminus">-                  case kKE.DOM_VK_RETURN: {</span>
<a href="#l8.1183"></a><span id="l8.1183" class="difflineminus">-                      let index = this.tree.currentIndex;</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-                      if (index &gt; -1) {</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-                          modifyEventWithDialog(this.binding.mTaskArray[index]);</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineminus">-                      }</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineminus">-                      break;</span>
<a href="#l8.1188"></a><span id="l8.1188" class="difflineminus">-                  }</span>
<a href="#l8.1189"></a><span id="l8.1189" class="difflineminus">-              }</span>
<a href="#l8.1190"></a><span id="l8.1190" class="difflineminus">-          },</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineplus">+            onKeyPress: function(event) {</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineplus">+                const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l8.1193"></a><span id="l8.1193" class="difflineplus">+                switch (event.keyCode || event.which) {</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineplus">+                    case kKE.DOM_VK_DELETE: {</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineplus">+                        document.popupNode = this.binding;</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineplus">+                        document.getElementById(&quot;calendar_delete_todo_command&quot;).doCommand();</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineplus">+                        event.preventDefault();</span>
<a href="#l8.1198"></a><span id="l8.1198" class="difflineplus">+                        event.stopPropagation();</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineplus">+                        break;</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineplus">+                    }</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineplus">+                    case kKE.DOM_VK_SPACE: {</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineplus">+                        if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l8.1203"></a><span id="l8.1203" class="difflineplus">+                            let col = document.getAnonymousElementByAttribute(</span>
<a href="#l8.1204"></a><span id="l8.1204" class="difflineplus">+                                this.binding, &quot;itemproperty&quot;, &quot;completed&quot;);</span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineplus">+                            this.cycleCell(</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineplus">+                                this.tree.currentIndex,</span>
<a href="#l8.1207"></a><span id="l8.1207" class="difflineplus">+                                { element: col });</span>
<a href="#l8.1208"></a><span id="l8.1208" class="difflineplus">+                        }</span>
<a href="#l8.1209"></a><span id="l8.1209" class="difflineplus">+                        break;</span>
<a href="#l8.1210"></a><span id="l8.1210" class="difflineplus">+                    }</span>
<a href="#l8.1211"></a><span id="l8.1211" class="difflineplus">+                    case kKE.DOM_VK_RETURN: {</span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineplus">+                        let index = this.tree.currentIndex;</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineplus">+                        if (index &gt; -1) {</span>
<a href="#l8.1214"></a><span id="l8.1214" class="difflineplus">+                            modifyEventWithDialog(this.binding.mTaskArray[index]);</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineplus">+                        }</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineplus">+                        break;</span>
<a href="#l8.1217"></a><span id="l8.1217" class="difflineplus">+                    }</span>
<a href="#l8.1218"></a><span id="l8.1218" class="difflineplus">+                }</span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineplus">+            },</span>
<a href="#l8.1220"></a><span id="l8.1220"> </span>
<a href="#l8.1221"></a><span id="l8.1221" class="difflineminus">-          // Set the context menu on mousedown to change it before it is opened</span>
<a href="#l8.1222"></a><span id="l8.1222" class="difflineminus">-          onMouseDown: function(event) {</span>
<a href="#l8.1223"></a><span id="l8.1223" class="difflineminus">-              let tree = document.getAnonymousElementByAttribute(this.binding,</span>
<a href="#l8.1224"></a><span id="l8.1224" class="difflineminus">-                                                                 &quot;anonid&quot;,</span>
<a href="#l8.1225"></a><span id="l8.1225" class="difflineminus">-                                                                 &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1226"></a><span id="l8.1226" class="difflineplus">+            // Set the context menu on mousedown to change it before it is opened</span>
<a href="#l8.1227"></a><span id="l8.1227" class="difflineplus">+            onMouseDown: function(event) {</span>
<a href="#l8.1228"></a><span id="l8.1228" class="difflineplus">+                let tree = document.getAnonymousElementByAttribute(this.binding,</span>
<a href="#l8.1229"></a><span id="l8.1229" class="difflineplus">+                                                                   &quot;anonid&quot;,</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineplus">+                                                                   &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1231"></a><span id="l8.1231"> </span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-              if (!this._getItemFromEvent(event)) {</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-                  tree.view.selection.invalidateSelection();</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineminus">-              }</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineminus">-          },</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineplus">+                if (!this._getItemFromEvent(event)) {</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineplus">+                    tree.view.selection.invalidateSelection();</span>
<a href="#l8.1238"></a><span id="l8.1238" class="difflineplus">+                }</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineplus">+            },</span>
<a href="#l8.1240"></a><span id="l8.1240"> </span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineminus">-          /**</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineminus">-           * Private methods and attributes</span>
<a href="#l8.1243"></a><span id="l8.1243" class="difflineminus">-           */</span>
<a href="#l8.1244"></a><span id="l8.1244" class="difflineplus">+            /**</span>
<a href="#l8.1245"></a><span id="l8.1245" class="difflineplus">+             * Private methods and attributes</span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineplus">+             */</span>
<a href="#l8.1247"></a><span id="l8.1247"> </span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineminus">-          _getItemFromEvent: function(event, aCol, aRow) {</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineminus">-              aRow = aRow || {};</span>
<a href="#l8.1250"></a><span id="l8.1250" class="difflineminus">-              let childElt = {};</span>
<a href="#l8.1251"></a><span id="l8.1251" class="difflineminus">-              this.treebox.getCellAt(event.clientX, event.clientY, aRow, aCol || {}, childElt);</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineminus">-              if (!childElt.value) {</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineminus">-                  return false;</span>
<a href="#l8.1254"></a><span id="l8.1254" class="difflineminus">-              }</span>
<a href="#l8.1255"></a><span id="l8.1255" class="difflineminus">-              return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.binding.mTaskArray[aRow.value];</span>
<a href="#l8.1256"></a><span id="l8.1256" class="difflineminus">-          },</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineplus">+            _getItemFromEvent: function(event, aCol, aRow) {</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineplus">+                aRow = aRow || {};</span>
<a href="#l8.1259"></a><span id="l8.1259" class="difflineplus">+                let childElt = {};</span>
<a href="#l8.1260"></a><span id="l8.1260" class="difflineplus">+                this.treebox.getCellAt(event.clientX, event.clientY, aRow, aCol || {}, childElt);</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineplus">+                if (!childElt.value) {</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineplus">+                    return false;</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineplus">+                }</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineplus">+                return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.binding.mTaskArray[aRow.value];</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineplus">+            },</span>
<a href="#l8.1266"></a><span id="l8.1266"> </span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineminus">-          // Helper function to display datetimes</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineminus">-          _formatDateTime: function(aDateTime) {</span>
<a href="#l8.1269"></a><span id="l8.1269" class="difflineminus">-              let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l8.1270"></a><span id="l8.1270" class="difflineminus">-                                            .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l8.1271"></a><span id="l8.1271" class="difflineplus">+            // Helper function to display datetimes</span>
<a href="#l8.1272"></a><span id="l8.1272" class="difflineplus">+            _formatDateTime: function(aDateTime) {</span>
<a href="#l8.1273"></a><span id="l8.1273" class="difflineplus">+                let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l8.1274"></a><span id="l8.1274" class="difflineplus">+                                              .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l8.1275"></a><span id="l8.1275"> </span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-              // datetime is from todo object, it is not a javascript date</span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-              if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineminus">-                  let dateTime = aDateTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineminus">-                  return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l8.1280"></a><span id="l8.1280" class="difflineminus">-              }</span>
<a href="#l8.1281"></a><span id="l8.1281" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineminus">-          }</span>
<a href="#l8.1283"></a><span id="l8.1283" class="difflineminus">-      })</span>
<a href="#l8.1284"></a><span id="l8.1284" class="difflineplus">+                // datetime is from todo object, it is not a javascript date</span>
<a href="#l8.1285"></a><span id="l8.1285" class="difflineplus">+                if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l8.1286"></a><span id="l8.1286" class="difflineplus">+                    let dateTime = aDateTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l8.1287"></a><span id="l8.1287" class="difflineplus">+                    return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l8.1288"></a><span id="l8.1288" class="difflineplus">+                }</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineplus">+                return &quot;&quot;;</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineplus">+            }</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineplus">+        })</span>
<a href="#l8.1292"></a><span id="l8.1292">       ]]&gt;&lt;/field&gt;</span>
<a href="#l8.1293"></a><span id="l8.1293"> </span>
<a href="#l8.1294"></a><span id="l8.1294">       &lt;!--</span>
<a href="#l8.1295"></a><span id="l8.1295">         Observer for the calendar event data source. This keeps the unifinder</span>
<a href="#l8.1296"></a><span id="l8.1296">         display up to date when the calendar event data is changed</span>
<a href="#l8.1297"></a><span id="l8.1297">         --&gt;</span>
<a href="#l8.1298"></a><span id="l8.1298">       &lt;field name=&quot;mTaskTreeObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1299"></a><span id="l8.1299" class="difflineminus">-      ({</span>
<a href="#l8.1300"></a><span id="l8.1300" class="difflineminus">-          binding: this,</span>
<a href="#l8.1301"></a><span id="l8.1301" class="difflineplus">+        ({</span>
<a href="#l8.1302"></a><span id="l8.1302" class="difflineplus">+            binding: this,</span>
<a href="#l8.1303"></a><span id="l8.1303"> </span>
<a href="#l8.1304"></a><span id="l8.1304" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l8.1305"></a><span id="l8.1305" class="difflineminus">-              Components.interfaces.calICompositeObserver,</span>
<a href="#l8.1306"></a><span id="l8.1306" class="difflineminus">-              Components.interfaces.calIObserver</span>
<a href="#l8.1307"></a><span id="l8.1307" class="difflineminus">-          ]),</span>
<a href="#l8.1308"></a><span id="l8.1308" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l8.1309"></a><span id="l8.1309" class="difflineplus">+                Components.interfaces.calICompositeObserver,</span>
<a href="#l8.1310"></a><span id="l8.1310" class="difflineplus">+                Components.interfaces.calIObserver</span>
<a href="#l8.1311"></a><span id="l8.1311" class="difflineplus">+            ]),</span>
<a href="#l8.1312"></a><span id="l8.1312"> </span>
<a href="#l8.1313"></a><span id="l8.1313" class="difflineminus">-          /**</span>
<a href="#l8.1314"></a><span id="l8.1314" class="difflineminus">-           * calIObserver methods and properties</span>
<a href="#l8.1315"></a><span id="l8.1315" class="difflineminus">-           */</span>
<a href="#l8.1316"></a><span id="l8.1316" class="difflineminus">-          onStartBatch: function() {</span>
<a href="#l8.1317"></a><span id="l8.1317" class="difflineminus">-          },</span>
<a href="#l8.1318"></a><span id="l8.1318" class="difflineplus">+            /**</span>
<a href="#l8.1319"></a><span id="l8.1319" class="difflineplus">+             * calIObserver methods and properties</span>
<a href="#l8.1320"></a><span id="l8.1320" class="difflineplus">+             */</span>
<a href="#l8.1321"></a><span id="l8.1321" class="difflineplus">+            onStartBatch: function() {</span>
<a href="#l8.1322"></a><span id="l8.1322" class="difflineplus">+            },</span>
<a href="#l8.1323"></a><span id="l8.1323"> </span>
<a href="#l8.1324"></a><span id="l8.1324" class="difflineminus">-          onEndBatch: function() {</span>
<a href="#l8.1325"></a><span id="l8.1325" class="difflineminus">-          },</span>
<a href="#l8.1326"></a><span id="l8.1326" class="difflineplus">+            onEndBatch: function() {</span>
<a href="#l8.1327"></a><span id="l8.1327" class="difflineplus">+            },</span>
<a href="#l8.1328"></a><span id="l8.1328"> </span>
<a href="#l8.1329"></a><span id="l8.1329" class="difflineminus">-          onLoad: function() {</span>
<a href="#l8.1330"></a><span id="l8.1330" class="difflineminus">-              this.binding.refresh();</span>
<a href="#l8.1331"></a><span id="l8.1331" class="difflineminus">-          },</span>
<a href="#l8.1332"></a><span id="l8.1332" class="difflineplus">+            onLoad: function() {</span>
<a href="#l8.1333"></a><span id="l8.1333" class="difflineplus">+                this.binding.refresh();</span>
<a href="#l8.1334"></a><span id="l8.1334" class="difflineplus">+            },</span>
<a href="#l8.1335"></a><span id="l8.1335"> </span>
<a href="#l8.1336"></a><span id="l8.1336" class="difflineminus">-          onAddItem: function(aItem) {</span>
<a href="#l8.1337"></a><span id="l8.1337" class="difflineminus">-              if (cal.isToDo(aItem)) {</span>
<a href="#l8.1338"></a><span id="l8.1338" class="difflineminus">-                  this.binding.mTreeView.addItems(this.binding.mFilter.getOccurrences(aItem));</span>
<a href="#l8.1339"></a><span id="l8.1339" class="difflineminus">-              }</span>
<a href="#l8.1340"></a><span id="l8.1340" class="difflineminus">-          },</span>
<a href="#l8.1341"></a><span id="l8.1341" class="difflineplus">+            onAddItem: function(aItem) {</span>
<a href="#l8.1342"></a><span id="l8.1342" class="difflineplus">+                if (cal.isToDo(aItem)) {</span>
<a href="#l8.1343"></a><span id="l8.1343" class="difflineplus">+                    this.binding.mTreeView.addItems(this.binding.mFilter.getOccurrences(aItem));</span>
<a href="#l8.1344"></a><span id="l8.1344" class="difflineplus">+                }</span>
<a href="#l8.1345"></a><span id="l8.1345" class="difflineplus">+            },</span>
<a href="#l8.1346"></a><span id="l8.1346"> </span>
<a href="#l8.1347"></a><span id="l8.1347" class="difflineminus">-          onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l8.1348"></a><span id="l8.1348" class="difflineminus">-              if (cal.isToDo(aNewItem) || cal.isToDo(aOldItem)) {</span>
<a href="#l8.1349"></a><span id="l8.1349" class="difflineminus">-                  this.binding.mTreeView.modifyItems(this.binding.mFilter.getOccurrences(aNewItem),</span>
<a href="#l8.1350"></a><span id="l8.1350" class="difflineminus">-                                                     this.binding.mFilter.getOccurrences(aOldItem));</span>
<a href="#l8.1351"></a><span id="l8.1351" class="difflineplus">+            onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l8.1352"></a><span id="l8.1352" class="difflineplus">+                if (cal.isToDo(aNewItem) || cal.isToDo(aOldItem)) {</span>
<a href="#l8.1353"></a><span id="l8.1353" class="difflineplus">+                    this.binding.mTreeView.modifyItems(this.binding.mFilter.getOccurrences(aNewItem),</span>
<a href="#l8.1354"></a><span id="l8.1354" class="difflineplus">+                                                       this.binding.mFilter.getOccurrences(aOldItem));</span>
<a href="#l8.1355"></a><span id="l8.1355"> </span>
<a href="#l8.1356"></a><span id="l8.1356" class="difflineminus">-                  // we also need to notify potential listeners.</span>
<a href="#l8.1357"></a><span id="l8.1357" class="difflineminus">-                  let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.1358"></a><span id="l8.1358" class="difflineminus">-                  event.initEvent(&quot;select&quot;, true, false);</span>
<a href="#l8.1359"></a><span id="l8.1359" class="difflineminus">-                  this.binding.dispatchEvent(event);</span>
<a href="#l8.1360"></a><span id="l8.1360" class="difflineminus">-              }</span>
<a href="#l8.1361"></a><span id="l8.1361" class="difflineminus">-          },</span>
<a href="#l8.1362"></a><span id="l8.1362" class="difflineplus">+                    // we also need to notify potential listeners.</span>
<a href="#l8.1363"></a><span id="l8.1363" class="difflineplus">+                    let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.1364"></a><span id="l8.1364" class="difflineplus">+                    event.initEvent(&quot;select&quot;, true, false);</span>
<a href="#l8.1365"></a><span id="l8.1365" class="difflineplus">+                    this.binding.dispatchEvent(event);</span>
<a href="#l8.1366"></a><span id="l8.1366" class="difflineplus">+                }</span>
<a href="#l8.1367"></a><span id="l8.1367" class="difflineplus">+            },</span>
<a href="#l8.1368"></a><span id="l8.1368"> </span>
<a href="#l8.1369"></a><span id="l8.1369" class="difflineminus">-          onDeleteItem: function(aDeletedItem) {</span>
<a href="#l8.1370"></a><span id="l8.1370" class="difflineminus">-              if (cal.isToDo(aDeletedItem)) {</span>
<a href="#l8.1371"></a><span id="l8.1371" class="difflineminus">-                  this.binding.mTreeView.removeItems(this.binding.mFilter.getOccurrences(aDeletedItem));</span>
<a href="#l8.1372"></a><span id="l8.1372" class="difflineminus">-              }</span>
<a href="#l8.1373"></a><span id="l8.1373" class="difflineminus">-          },</span>
<a href="#l8.1374"></a><span id="l8.1374" class="difflineplus">+            onDeleteItem: function(aDeletedItem) {</span>
<a href="#l8.1375"></a><span id="l8.1375" class="difflineplus">+                if (cal.isToDo(aDeletedItem)) {</span>
<a href="#l8.1376"></a><span id="l8.1376" class="difflineplus">+                    this.binding.mTreeView.removeItems(this.binding.mFilter.getOccurrences(aDeletedItem));</span>
<a href="#l8.1377"></a><span id="l8.1377" class="difflineplus">+                }</span>
<a href="#l8.1378"></a><span id="l8.1378" class="difflineplus">+            },</span>
<a href="#l8.1379"></a><span id="l8.1379"> </span>
<a href="#l8.1380"></a><span id="l8.1380" class="difflineminus">-          onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l8.1381"></a><span id="l8.1381" class="difflineminus">-          onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l8.1382"></a><span id="l8.1382" class="difflineminus">-              switch (aName) {</span>
<a href="#l8.1383"></a><span id="l8.1383" class="difflineminus">-                  case &quot;disabled&quot;:</span>
<a href="#l8.1384"></a><span id="l8.1384" class="difflineminus">-                      if (aValue) {</span>
<a href="#l8.1385"></a><span id="l8.1385" class="difflineminus">-                          this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l8.1386"></a><span id="l8.1386" class="difflineminus">-                      } else {</span>
<a href="#l8.1387"></a><span id="l8.1387" class="difflineminus">-                          this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l8.1388"></a><span id="l8.1388" class="difflineminus">-                      }</span>
<a href="#l8.1389"></a><span id="l8.1389" class="difflineminus">-                      break;</span>
<a href="#l8.1390"></a><span id="l8.1390" class="difflineminus">-              }</span>
<a href="#l8.1391"></a><span id="l8.1391" class="difflineminus">-          },</span>
<a href="#l8.1392"></a><span id="l8.1392" class="difflineplus">+            onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l8.1393"></a><span id="l8.1393" class="difflineplus">+            onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l8.1394"></a><span id="l8.1394" class="difflineplus">+                switch (aName) {</span>
<a href="#l8.1395"></a><span id="l8.1395" class="difflineplus">+                    case &quot;disabled&quot;:</span>
<a href="#l8.1396"></a><span id="l8.1396" class="difflineplus">+                        if (aValue) {</span>
<a href="#l8.1397"></a><span id="l8.1397" class="difflineplus">+                            this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l8.1398"></a><span id="l8.1398" class="difflineplus">+                        } else {</span>
<a href="#l8.1399"></a><span id="l8.1399" class="difflineplus">+                            this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l8.1400"></a><span id="l8.1400" class="difflineplus">+                        }</span>
<a href="#l8.1401"></a><span id="l8.1401" class="difflineplus">+                        break;</span>
<a href="#l8.1402"></a><span id="l8.1402" class="difflineplus">+                }</span>
<a href="#l8.1403"></a><span id="l8.1403" class="difflineplus">+            },</span>
<a href="#l8.1404"></a><span id="l8.1404"> </span>
<a href="#l8.1405"></a><span id="l8.1405" class="difflineminus">-          onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l8.1406"></a><span id="l8.1406" class="difflineminus">-              this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l8.1407"></a><span id="l8.1407" class="difflineminus">-          },</span>
<a href="#l8.1408"></a><span id="l8.1408" class="difflineplus">+            onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l8.1409"></a><span id="l8.1409" class="difflineplus">+                this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l8.1410"></a><span id="l8.1410" class="difflineplus">+            },</span>
<a href="#l8.1411"></a><span id="l8.1411"> </span>
<a href="#l8.1412"></a><span id="l8.1412" class="difflineminus">-          /**</span>
<a href="#l8.1413"></a><span id="l8.1413" class="difflineminus">-           * calICompositeObserver methods and properties</span>
<a href="#l8.1414"></a><span id="l8.1414" class="difflineminus">-           */</span>
<a href="#l8.1415"></a><span id="l8.1415" class="difflineminus">-          onCalendarAdded: function(aCalendar) {</span>
<a href="#l8.1416"></a><span id="l8.1416" class="difflineminus">-              if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1417"></a><span id="l8.1417" class="difflineminus">-                  this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l8.1418"></a><span id="l8.1418" class="difflineminus">-              }</span>
<a href="#l8.1419"></a><span id="l8.1419" class="difflineminus">-          },</span>
<a href="#l8.1420"></a><span id="l8.1420" class="difflineplus">+            /**</span>
<a href="#l8.1421"></a><span id="l8.1421" class="difflineplus">+             * calICompositeObserver methods and properties</span>
<a href="#l8.1422"></a><span id="l8.1422" class="difflineplus">+             */</span>
<a href="#l8.1423"></a><span id="l8.1423" class="difflineplus">+            onCalendarAdded: function(aCalendar) {</span>
<a href="#l8.1424"></a><span id="l8.1424" class="difflineplus">+                if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1425"></a><span id="l8.1425" class="difflineplus">+                    this.binding.onCalendarAdded(aCalendar);</span>
<a href="#l8.1426"></a><span id="l8.1426" class="difflineplus">+                }</span>
<a href="#l8.1427"></a><span id="l8.1427" class="difflineplus">+            },</span>
<a href="#l8.1428"></a><span id="l8.1428"> </span>
<a href="#l8.1429"></a><span id="l8.1429" class="difflineminus">-          onCalendarRemoved: function(aCalendar) {</span>
<a href="#l8.1430"></a><span id="l8.1430" class="difflineminus">-              this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l8.1431"></a><span id="l8.1431" class="difflineminus">-          },</span>
<a href="#l8.1432"></a><span id="l8.1432" class="difflineplus">+            onCalendarRemoved: function(aCalendar) {</span>
<a href="#l8.1433"></a><span id="l8.1433" class="difflineplus">+                this.binding.onCalendarRemoved(aCalendar);</span>
<a href="#l8.1434"></a><span id="l8.1434" class="difflineplus">+            },</span>
<a href="#l8.1435"></a><span id="l8.1435"> </span>
<a href="#l8.1436"></a><span id="l8.1436" class="difflineminus">-          onDefaultCalendarChanged: function(aNewDefaultCalendar) {}</span>
<a href="#l8.1437"></a><span id="l8.1437" class="difflineminus">-      })</span>
<a href="#l8.1438"></a><span id="l8.1438" class="difflineplus">+            onDefaultCalendarChanged: function(aNewDefaultCalendar) {}</span>
<a href="#l8.1439"></a><span id="l8.1439" class="difflineplus">+        })</span>
<a href="#l8.1440"></a><span id="l8.1440">       ]]&gt;&lt;/field&gt;</span>
<a href="#l8.1441"></a><span id="l8.1441"> </span>
<a href="#l8.1442"></a><span id="l8.1442">       &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l8.1443"></a><span id="l8.1443">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l8.1444"></a><span id="l8.1444">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l8.1445"></a><span id="l8.1445">         &lt;parameter name=&quot;aPrefName&quot;/&gt;</span>
<a href="#l8.1446"></a><span id="l8.1446">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1447"></a><span id="l8.1447" class="difflineminus">-          switch (aPrefName) {</span>
<a href="#l8.1448"></a><span id="l8.1448" class="difflineminus">-              case &quot;calendar.date.format&quot;:</span>
<a href="#l8.1449"></a><span id="l8.1449" class="difflineminus">-              case &quot;calendar.timezone.local&quot;:</span>
<a href="#l8.1450"></a><span id="l8.1450" class="difflineminus">-                  this.refresh();</span>
<a href="#l8.1451"></a><span id="l8.1451" class="difflineminus">-                  break;</span>
<a href="#l8.1452"></a><span id="l8.1452" class="difflineminus">-          }</span>
<a href="#l8.1453"></a><span id="l8.1453" class="difflineplus">+            switch (aPrefName) {</span>
<a href="#l8.1454"></a><span id="l8.1454" class="difflineplus">+                case &quot;calendar.date.format&quot;:</span>
<a href="#l8.1455"></a><span id="l8.1455" class="difflineplus">+                case &quot;calendar.timezone.local&quot;:</span>
<a href="#l8.1456"></a><span id="l8.1456" class="difflineplus">+                    this.refresh();</span>
<a href="#l8.1457"></a><span id="l8.1457" class="difflineplus">+                    break;</span>
<a href="#l8.1458"></a><span id="l8.1458" class="difflineplus">+            }</span>
<a href="#l8.1459"></a><span id="l8.1459"> </span>
<a href="#l8.1460"></a><span id="l8.1460">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1461"></a><span id="l8.1461">       &lt;/method&gt;</span>
<a href="#l8.1462"></a><span id="l8.1462"> </span>
<a href="#l8.1463"></a><span id="l8.1463">       &lt;method name=&quot;refreshFromCalendar&quot;&gt;</span>
<a href="#l8.1464"></a><span id="l8.1464">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l8.1465"></a><span id="l8.1465">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1466"></a><span id="l8.1466" class="difflineminus">-          let refreshJob = {</span>
<a href="#l8.1467"></a><span id="l8.1467" class="difflineminus">-              QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l8.1468"></a><span id="l8.1468" class="difflineminus">-              binding: this,</span>
<a href="#l8.1469"></a><span id="l8.1469" class="difflineminus">-              calendar: null,</span>
<a href="#l8.1470"></a><span id="l8.1470" class="difflineminus">-              items: null,</span>
<a href="#l8.1471"></a><span id="l8.1471" class="difflineminus">-              operation: null,</span>
<a href="#l8.1472"></a><span id="l8.1472" class="difflineplus">+            let refreshJob = {</span>
<a href="#l8.1473"></a><span id="l8.1473" class="difflineplus">+                QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l8.1474"></a><span id="l8.1474" class="difflineplus">+                binding: this,</span>
<a href="#l8.1475"></a><span id="l8.1475" class="difflineplus">+                calendar: null,</span>
<a href="#l8.1476"></a><span id="l8.1476" class="difflineplus">+                items: null,</span>
<a href="#l8.1477"></a><span id="l8.1477" class="difflineplus">+                operation: null,</span>
<a href="#l8.1478"></a><span id="l8.1478"> </span>
<a href="#l8.1479"></a><span id="l8.1479" class="difflineminus">-              onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l8.1480"></a><span id="l8.1480" class="difflineminus">-                  if (aOpCalendar.id in this.binding.mPendingRefreshJobs) {</span>
<a href="#l8.1481"></a><span id="l8.1481" class="difflineminus">-                      delete this.binding.mPendingRefreshJobs[aOpCalendar.id];</span>
<a href="#l8.1482"></a><span id="l8.1482" class="difflineminus">-                  }</span>
<a href="#l8.1483"></a><span id="l8.1483" class="difflineplus">+                onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l8.1484"></a><span id="l8.1484" class="difflineplus">+                    if (aOpCalendar.id in this.binding.mPendingRefreshJobs) {</span>
<a href="#l8.1485"></a><span id="l8.1485" class="difflineplus">+                        delete this.binding.mPendingRefreshJobs[aOpCalendar.id];</span>
<a href="#l8.1486"></a><span id="l8.1486" class="difflineplus">+                    }</span>
<a href="#l8.1487"></a><span id="l8.1487"> </span>
<a href="#l8.1488"></a><span id="l8.1488" class="difflineminus">-                  let oldItems = this.binding.mTaskArray.filter(item =&gt; item.calendar.id == aOpCalendar.id);</span>
<a href="#l8.1489"></a><span id="l8.1489" class="difflineminus">-                  this.binding.mTreeView.modifyItems(this.items, oldItems);</span>
<a href="#l8.1490"></a><span id="l8.1490" class="difflineminus">-              },</span>
<a href="#l8.1491"></a><span id="l8.1491" class="difflineplus">+                    let oldItems = this.binding.mTaskArray.filter(item =&gt; item.calendar.id == aOpCalendar.id);</span>
<a href="#l8.1492"></a><span id="l8.1492" class="difflineplus">+                    this.binding.mTreeView.modifyItems(this.items, oldItems);</span>
<a href="#l8.1493"></a><span id="l8.1493" class="difflineplus">+                },</span>
<a href="#l8.1494"></a><span id="l8.1494"> </span>
<a href="#l8.1495"></a><span id="l8.1495" class="difflineminus">-              onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l8.1496"></a><span id="l8.1496" class="difflineminus">-                  this.items = this.items.concat(aItems);</span>
<a href="#l8.1497"></a><span id="l8.1497" class="difflineminus">-              },</span>
<a href="#l8.1498"></a><span id="l8.1498" class="difflineplus">+                onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l8.1499"></a><span id="l8.1499" class="difflineplus">+                    this.items = this.items.concat(aItems);</span>
<a href="#l8.1500"></a><span id="l8.1500" class="difflineplus">+                },</span>
<a href="#l8.1501"></a><span id="l8.1501"> </span>
<a href="#l8.1502"></a><span id="l8.1502" class="difflineminus">-              cancel: function() {</span>
<a href="#l8.1503"></a><span id="l8.1503" class="difflineminus">-                  if (this.operation &amp;&amp; this.operation.isPending) {</span>
<a href="#l8.1504"></a><span id="l8.1504" class="difflineminus">-                      this.operation.cancel();</span>
<a href="#l8.1505"></a><span id="l8.1505" class="difflineminus">-                      this.operation = null;</span>
<a href="#l8.1506"></a><span id="l8.1506" class="difflineminus">-                      this.items = [];</span>
<a href="#l8.1507"></a><span id="l8.1507" class="difflineminus">-                  }</span>
<a href="#l8.1508"></a><span id="l8.1508" class="difflineminus">-              },</span>
<a href="#l8.1509"></a><span id="l8.1509" class="difflineplus">+                cancel: function() {</span>
<a href="#l8.1510"></a><span id="l8.1510" class="difflineplus">+                    if (this.operation &amp;&amp; this.operation.isPending) {</span>
<a href="#l8.1511"></a><span id="l8.1511" class="difflineplus">+                        this.operation.cancel();</span>
<a href="#l8.1512"></a><span id="l8.1512" class="difflineplus">+                        this.operation = null;</span>
<a href="#l8.1513"></a><span id="l8.1513" class="difflineplus">+                        this.items = [];</span>
<a href="#l8.1514"></a><span id="l8.1514" class="difflineplus">+                    }</span>
<a href="#l8.1515"></a><span id="l8.1515" class="difflineplus">+                },</span>
<a href="#l8.1516"></a><span id="l8.1516"> </span>
<a href="#l8.1517"></a><span id="l8.1517" class="difflineminus">-              execute: function() {</span>
<a href="#l8.1518"></a><span id="l8.1518" class="difflineminus">-                  if (aCalendar.id in this.binding.mPendingRefreshJobs) {</span>
<a href="#l8.1519"></a><span id="l8.1519" class="difflineminus">-                      this.binding.mPendingRefreshJobs[aCalendar.id].cancel();</span>
<a href="#l8.1520"></a><span id="l8.1520" class="difflineminus">-                  }</span>
<a href="#l8.1521"></a><span id="l8.1521" class="difflineminus">-                  this.calendar = aCalendar;</span>
<a href="#l8.1522"></a><span id="l8.1522" class="difflineminus">-                  this.items = [];</span>
<a href="#l8.1523"></a><span id="l8.1523" class="difflineplus">+                execute: function() {</span>
<a href="#l8.1524"></a><span id="l8.1524" class="difflineplus">+                    if (aCalendar.id in this.binding.mPendingRefreshJobs) {</span>
<a href="#l8.1525"></a><span id="l8.1525" class="difflineplus">+                        this.binding.mPendingRefreshJobs[aCalendar.id].cancel();</span>
<a href="#l8.1526"></a><span id="l8.1526" class="difflineplus">+                    }</span>
<a href="#l8.1527"></a><span id="l8.1527" class="difflineplus">+                    this.calendar = aCalendar;</span>
<a href="#l8.1528"></a><span id="l8.1528" class="difflineplus">+                    this.items = [];</span>
<a href="#l8.1529"></a><span id="l8.1529"> </span>
<a href="#l8.1530"></a><span id="l8.1530" class="difflineminus">-                  let operation = this.binding.mFilter.getItems(aCalendar,</span>
<a href="#l8.1531"></a><span id="l8.1531" class="difflineminus">-                                                                aCalendar.ITEM_FILTER_TYPE_TODO,</span>
<a href="#l8.1532"></a><span id="l8.1532" class="difflineminus">-                                                                this);</span>
<a href="#l8.1533"></a><span id="l8.1533" class="difflineminus">-                  if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l8.1534"></a><span id="l8.1534" class="difflineminus">-                      this.operation = operation;</span>
<a href="#l8.1535"></a><span id="l8.1535" class="difflineminus">-                      this.binding.mPendingRefreshJobs[aCalendar.id] = this;</span>
<a href="#l8.1536"></a><span id="l8.1536" class="difflineminus">-                  }</span>
<a href="#l8.1537"></a><span id="l8.1537" class="difflineminus">-              }</span>
<a href="#l8.1538"></a><span id="l8.1538" class="difflineminus">-          };</span>
<a href="#l8.1539"></a><span id="l8.1539" class="difflineplus">+                    let operation = this.binding.mFilter.getItems(aCalendar,</span>
<a href="#l8.1540"></a><span id="l8.1540" class="difflineplus">+                                                                  aCalendar.ITEM_FILTER_TYPE_TODO,</span>
<a href="#l8.1541"></a><span id="l8.1541" class="difflineplus">+                                                                  this);</span>
<a href="#l8.1542"></a><span id="l8.1542" class="difflineplus">+                    if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l8.1543"></a><span id="l8.1543" class="difflineplus">+                        this.operation = operation;</span>
<a href="#l8.1544"></a><span id="l8.1544" class="difflineplus">+                        this.binding.mPendingRefreshJobs[aCalendar.id] = this;</span>
<a href="#l8.1545"></a><span id="l8.1545" class="difflineplus">+                    }</span>
<a href="#l8.1546"></a><span id="l8.1546" class="difflineplus">+                }</span>
<a href="#l8.1547"></a><span id="l8.1547" class="difflineplus">+            };</span>
<a href="#l8.1548"></a><span id="l8.1548"> </span>
<a href="#l8.1549"></a><span id="l8.1549" class="difflineminus">-          refreshJob.execute();</span>
<a href="#l8.1550"></a><span id="l8.1550" class="difflineplus">+            refreshJob.execute();</span>
<a href="#l8.1551"></a><span id="l8.1551">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1552"></a><span id="l8.1552">       &lt;/method&gt;</span>
<a href="#l8.1553"></a><span id="l8.1553"> </span>
<a href="#l8.1554"></a><span id="l8.1554">       &lt;method name=&quot;selectAll&quot;&gt;</span>
<a href="#l8.1555"></a><span id="l8.1555">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1556"></a><span id="l8.1556" class="difflineminus">-          if (this.mTreeView.selection) {</span>
<a href="#l8.1557"></a><span id="l8.1557" class="difflineminus">-              this.mTreeView.selection.selectAll();</span>
<a href="#l8.1558"></a><span id="l8.1558" class="difflineminus">-          }</span>
<a href="#l8.1559"></a><span id="l8.1559" class="difflineplus">+            if (this.mTreeView.selection) {</span>
<a href="#l8.1560"></a><span id="l8.1560" class="difflineplus">+                this.mTreeView.selection.selectAll();</span>
<a href="#l8.1561"></a><span id="l8.1561" class="difflineplus">+            }</span>
<a href="#l8.1562"></a><span id="l8.1562">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1563"></a><span id="l8.1563">       &lt;/method&gt;</span>
<a href="#l8.1564"></a><span id="l8.1564"> </span>
<a href="#l8.1565"></a><span id="l8.1565">       &lt;!-- Called by event observers to update the display --&gt;</span>
<a href="#l8.1566"></a><span id="l8.1566">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l8.1567"></a><span id="l8.1567">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l8.1568"></a><span id="l8.1568">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1569"></a><span id="l8.1569" class="difflineminus">-          let cals = cal.getCompositeCalendar(window).getCalendars({}) || [];</span>
<a href="#l8.1570"></a><span id="l8.1570" class="difflineminus">-          for (let calendar of cals) {</span>
<a href="#l8.1571"></a><span id="l8.1571" class="difflineminus">-              if (!calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1572"></a><span id="l8.1572" class="difflineminus">-                  this.refreshFromCalendar(calendar, aFilter);</span>
<a href="#l8.1573"></a><span id="l8.1573" class="difflineminus">-              }</span>
<a href="#l8.1574"></a><span id="l8.1574" class="difflineminus">-          }</span>
<a href="#l8.1575"></a><span id="l8.1575" class="difflineplus">+            let cals = cal.getCompositeCalendar(window).getCalendars({}) || [];</span>
<a href="#l8.1576"></a><span id="l8.1576" class="difflineplus">+            for (let calendar of cals) {</span>
<a href="#l8.1577"></a><span id="l8.1577" class="difflineplus">+                if (!calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1578"></a><span id="l8.1578" class="difflineplus">+                    this.refreshFromCalendar(calendar, aFilter);</span>
<a href="#l8.1579"></a><span id="l8.1579" class="difflineplus">+                }</span>
<a href="#l8.1580"></a><span id="l8.1580" class="difflineplus">+            }</span>
<a href="#l8.1581"></a><span id="l8.1581">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1582"></a><span id="l8.1582">       &lt;/method&gt;</span>
<a href="#l8.1583"></a><span id="l8.1583"> </span>
<a href="#l8.1584"></a><span id="l8.1584">       &lt;method name=&quot;onCalendarAdded&quot;&gt;</span>
<a href="#l8.1585"></a><span id="l8.1585">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l8.1586"></a><span id="l8.1586">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l8.1587"></a><span id="l8.1587">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1588"></a><span id="l8.1588" class="difflineminus">-          if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1589"></a><span id="l8.1589" class="difflineminus">-              this.refreshFromCalendar(aCalendar, aFilter);</span>
<a href="#l8.1590"></a><span id="l8.1590" class="difflineminus">-          }</span>
<a href="#l8.1591"></a><span id="l8.1591" class="difflineplus">+            if (!aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l8.1592"></a><span id="l8.1592" class="difflineplus">+                this.refreshFromCalendar(aCalendar, aFilter);</span>
<a href="#l8.1593"></a><span id="l8.1593" class="difflineplus">+            }</span>
<a href="#l8.1594"></a><span id="l8.1594">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1595"></a><span id="l8.1595">       &lt;/method&gt;</span>
<a href="#l8.1596"></a><span id="l8.1596"> </span>
<a href="#l8.1597"></a><span id="l8.1597">       &lt;method name=&quot;onCalendarRemoved&quot;&gt;</span>
<a href="#l8.1598"></a><span id="l8.1598">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l8.1599"></a><span id="l8.1599">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1600"></a><span id="l8.1600" class="difflineminus">-          let tasks = this.mTaskArray.filter(task =&gt; task.calendar.id == aCalendar.id);</span>
<a href="#l8.1601"></a><span id="l8.1601" class="difflineminus">-          this.mTreeView.removeItems(tasks);</span>
<a href="#l8.1602"></a><span id="l8.1602" class="difflineplus">+            let tasks = this.mTaskArray.filter(task =&gt; task.calendar.id == aCalendar.id);</span>
<a href="#l8.1603"></a><span id="l8.1603" class="difflineplus">+            this.mTreeView.removeItems(tasks);</span>
<a href="#l8.1604"></a><span id="l8.1604">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1605"></a><span id="l8.1605">       &lt;/method&gt;</span>
<a href="#l8.1606"></a><span id="l8.1606"> </span>
<a href="#l8.1607"></a><span id="l8.1607">       &lt;method name=&quot;sortItems&quot;&gt;</span>
<a href="#l8.1608"></a><span id="l8.1608">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1609"></a><span id="l8.1609" class="difflineminus">-          if (this.mTreeView.selectedColumn) {</span>
<a href="#l8.1610"></a><span id="l8.1610" class="difflineminus">-              let modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l8.1611"></a><span id="l8.1611" class="difflineminus">-              let column = this.mTreeView.selectedColumn;</span>
<a href="#l8.1612"></a><span id="l8.1612" class="difflineminus">-              cal.sortEntry.mSortKey = column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l8.1613"></a><span id="l8.1613" class="difflineminus">-                                       ? column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l8.1614"></a><span id="l8.1614" class="difflineminus">-                                       : column.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.1615"></a><span id="l8.1615" class="difflineminus">-              let sortType = cal.getSortTypeForSortKey(cal.sortEntry.mSortKey);</span>
<a href="#l8.1616"></a><span id="l8.1616" class="difflineplus">+            if (this.mTreeView.selectedColumn) {</span>
<a href="#l8.1617"></a><span id="l8.1617" class="difflineplus">+                let modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l8.1618"></a><span id="l8.1618" class="difflineplus">+                let column = this.mTreeView.selectedColumn;</span>
<a href="#l8.1619"></a><span id="l8.1619" class="difflineplus">+                cal.sortEntry.mSortKey = column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l8.1620"></a><span id="l8.1620" class="difflineplus">+                                         ? column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l8.1621"></a><span id="l8.1621" class="difflineplus">+                                         : column.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l8.1622"></a><span id="l8.1622" class="difflineplus">+                let sortType = cal.getSortTypeForSortKey(cal.sortEntry.mSortKey);</span>
<a href="#l8.1623"></a><span id="l8.1623"> </span>
<a href="#l8.1624"></a><span id="l8.1624" class="difflineminus">-              // sort (key,item) entries</span>
<a href="#l8.1625"></a><span id="l8.1625" class="difflineminus">-              cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l8.1626"></a><span id="l8.1626" class="difflineminus">-              let entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l8.1627"></a><span id="l8.1627" class="difflineminus">-              entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l8.1628"></a><span id="l8.1628" class="difflineminus">-              this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l8.1629"></a><span id="l8.1629" class="difflineminus">-          }</span>
<a href="#l8.1630"></a><span id="l8.1630" class="difflineplus">+                // sort (key,item) entries</span>
<a href="#l8.1631"></a><span id="l8.1631" class="difflineplus">+                cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l8.1632"></a><span id="l8.1632" class="difflineplus">+                let entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l8.1633"></a><span id="l8.1633" class="difflineplus">+                entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l8.1634"></a><span id="l8.1634" class="difflineplus">+                this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l8.1635"></a><span id="l8.1635" class="difflineplus">+            }</span>
<a href="#l8.1636"></a><span id="l8.1636"> </span>
<a href="#l8.1637"></a><span id="l8.1637" class="difflineminus">-          this.recreateHashTable();</span>
<a href="#l8.1638"></a><span id="l8.1638" class="difflineplus">+            this.recreateHashTable();</span>
<a href="#l8.1639"></a><span id="l8.1639">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1640"></a><span id="l8.1640">       &lt;/method&gt;</span>
<a href="#l8.1641"></a><span id="l8.1641"> </span>
<a href="#l8.1642"></a><span id="l8.1642">       &lt;method name=&quot;recreateHashTable&quot;&gt;</span>
<a href="#l8.1643"></a><span id="l8.1643">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1644"></a><span id="l8.1644" class="difflineminus">-          this.mHash2Index = {};</span>
<a href="#l8.1645"></a><span id="l8.1645" class="difflineminus">-          for (let i = 0; i &lt; this.mTaskArray.length; i++) {</span>
<a href="#l8.1646"></a><span id="l8.1646" class="difflineminus">-              let item = this.mTaskArray[i];</span>
<a href="#l8.1647"></a><span id="l8.1647" class="difflineminus">-              this.mHash2Index[item.hashId] = i;</span>
<a href="#l8.1648"></a><span id="l8.1648" class="difflineminus">-          }</span>
<a href="#l8.1649"></a><span id="l8.1649" class="difflineminus">-          if (this.mTreeView.treebox) {</span>
<a href="#l8.1650"></a><span id="l8.1650" class="difflineminus">-              this.mTreeView.treebox.invalidate();</span>
<a href="#l8.1651"></a><span id="l8.1651" class="difflineminus">-          }</span>
<a href="#l8.1652"></a><span id="l8.1652" class="difflineplus">+            this.mHash2Index = {};</span>
<a href="#l8.1653"></a><span id="l8.1653" class="difflineplus">+            for (let i = 0; i &lt; this.mTaskArray.length; i++) {</span>
<a href="#l8.1654"></a><span id="l8.1654" class="difflineplus">+                let item = this.mTaskArray[i];</span>
<a href="#l8.1655"></a><span id="l8.1655" class="difflineplus">+                this.mHash2Index[item.hashId] = i;</span>
<a href="#l8.1656"></a><span id="l8.1656" class="difflineplus">+            }</span>
<a href="#l8.1657"></a><span id="l8.1657" class="difflineplus">+            if (this.mTreeView.treebox) {</span>
<a href="#l8.1658"></a><span id="l8.1658" class="difflineplus">+                this.mTreeView.treebox.invalidate();</span>
<a href="#l8.1659"></a><span id="l8.1659" class="difflineplus">+            }</span>
<a href="#l8.1660"></a><span id="l8.1660">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1661"></a><span id="l8.1661">       &lt;/method&gt;</span>
<a href="#l8.1662"></a><span id="l8.1662"> </span>
<a href="#l8.1663"></a><span id="l8.1663">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l8.1664"></a><span id="l8.1664">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1665"></a><span id="l8.1665" class="difflineminus">-          let initialDate = currentView().selectedDay;</span>
<a href="#l8.1666"></a><span id="l8.1666" class="difflineminus">-          return initialDate ? initialDate : cal.now();</span>
<a href="#l8.1667"></a><span id="l8.1667" class="difflineplus">+            let initialDate = currentView().selectedDay;</span>
<a href="#l8.1668"></a><span id="l8.1668" class="difflineplus">+            return initialDate ? initialDate : cal.now();</span>
<a href="#l8.1669"></a><span id="l8.1669">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1670"></a><span id="l8.1670">       &lt;/method&gt;</span>
<a href="#l8.1671"></a><span id="l8.1671"> </span>
<a href="#l8.1672"></a><span id="l8.1672">       &lt;method name=&quot;doUpdateFilter&quot;&gt;</span>
<a href="#l8.1673"></a><span id="l8.1673">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l8.1674"></a><span id="l8.1674">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1675"></a><span id="l8.1675" class="difflineminus">-          let needsRefresh = false;</span>
<a href="#l8.1676"></a><span id="l8.1676" class="difflineminus">-          let oldStart = this.mFilter.mStartDate;</span>
<a href="#l8.1677"></a><span id="l8.1677" class="difflineminus">-          let oldEnd = this.mFilter.mEndDate;</span>
<a href="#l8.1678"></a><span id="l8.1678" class="difflineminus">-          let filterText = this.mFilter.filterText || &quot;&quot;;</span>
<a href="#l8.1679"></a><span id="l8.1679" class="difflineplus">+            let needsRefresh = false;</span>
<a href="#l8.1680"></a><span id="l8.1680" class="difflineplus">+            let oldStart = this.mFilter.mStartDate;</span>
<a href="#l8.1681"></a><span id="l8.1681" class="difflineplus">+            let oldEnd = this.mFilter.mEndDate;</span>
<a href="#l8.1682"></a><span id="l8.1682" class="difflineplus">+            let filterText = this.mFilter.filterText || &quot;&quot;;</span>
<a href="#l8.1683"></a><span id="l8.1683"> </span>
<a href="#l8.1684"></a><span id="l8.1684" class="difflineminus">-          if (aFilter) {</span>
<a href="#l8.1685"></a><span id="l8.1685" class="difflineminus">-              let props = this.mFilter.filterProperties;</span>
<a href="#l8.1686"></a><span id="l8.1686" class="difflineminus">-              this.mFilter.applyFilter(aFilter);</span>
<a href="#l8.1687"></a><span id="l8.1687" class="difflineminus">-              needsRefresh = !props || !props.equals(this.mFilter.filterProperties);</span>
<a href="#l8.1688"></a><span id="l8.1688" class="difflineminus">-          } else {</span>
<a href="#l8.1689"></a><span id="l8.1689" class="difflineminus">-              this.mFilter.updateFilterDates();</span>
<a href="#l8.1690"></a><span id="l8.1690" class="difflineminus">-          }</span>
<a href="#l8.1691"></a><span id="l8.1691" class="difflineplus">+            if (aFilter) {</span>
<a href="#l8.1692"></a><span id="l8.1692" class="difflineplus">+                let props = this.mFilter.filterProperties;</span>
<a href="#l8.1693"></a><span id="l8.1693" class="difflineplus">+                this.mFilter.applyFilter(aFilter);</span>
<a href="#l8.1694"></a><span id="l8.1694" class="difflineplus">+                needsRefresh = !props || !props.equals(this.mFilter.filterProperties);</span>
<a href="#l8.1695"></a><span id="l8.1695" class="difflineplus">+            } else {</span>
<a href="#l8.1696"></a><span id="l8.1696" class="difflineplus">+                this.mFilter.updateFilterDates();</span>
<a href="#l8.1697"></a><span id="l8.1697" class="difflineplus">+            }</span>
<a href="#l8.1698"></a><span id="l8.1698"> </span>
<a href="#l8.1699"></a><span id="l8.1699" class="difflineminus">-          if (this.mTextFilterField) {</span>
<a href="#l8.1700"></a><span id="l8.1700" class="difflineminus">-              let field = document.getElementById(this.mTextFilterField);</span>
<a href="#l8.1701"></a><span id="l8.1701" class="difflineminus">-              if (field) {</span>
<a href="#l8.1702"></a><span id="l8.1702" class="difflineminus">-                  this.mFilter.filterText = field.value;</span>
<a href="#l8.1703"></a><span id="l8.1703" class="difflineminus">-                  needsRefresh = needsRefresh || filterText.toLowerCase() != this.mFilter.filterText.toLowerCase();</span>
<a href="#l8.1704"></a><span id="l8.1704" class="difflineminus">-              }</span>
<a href="#l8.1705"></a><span id="l8.1705" class="difflineminus">-          }</span>
<a href="#l8.1706"></a><span id="l8.1706" class="difflineplus">+            if (this.mTextFilterField) {</span>
<a href="#l8.1707"></a><span id="l8.1707" class="difflineplus">+                let field = document.getElementById(this.mTextFilterField);</span>
<a href="#l8.1708"></a><span id="l8.1708" class="difflineplus">+                if (field) {</span>
<a href="#l8.1709"></a><span id="l8.1709" class="difflineplus">+                    this.mFilter.filterText = field.value;</span>
<a href="#l8.1710"></a><span id="l8.1710" class="difflineplus">+                    needsRefresh = needsRefresh || filterText.toLowerCase() != this.mFilter.filterText.toLowerCase();</span>
<a href="#l8.1711"></a><span id="l8.1711" class="difflineplus">+                }</span>
<a href="#l8.1712"></a><span id="l8.1712" class="difflineplus">+            }</span>
<a href="#l8.1713"></a><span id="l8.1713"> </span>
<a href="#l8.1714"></a><span id="l8.1714" class="difflineminus">-          // we only need to refresh the tree if the filter properties or date range changed</span>
<a href="#l8.1715"></a><span id="l8.1715" class="difflineminus">-          if (needsRefresh ||</span>
<a href="#l8.1716"></a><span id="l8.1716" class="difflineminus">-              !((!oldStart &amp;&amp; !this.mFilter.mStartDate) ||</span>
<a href="#l8.1717"></a><span id="l8.1717" class="difflineminus">-                (oldStart &amp;&amp; this.mFilter.mStartDate &amp;&amp; oldStart.compare(this.mFilter.mStartDate) == 0)) ||</span>
<a href="#l8.1718"></a><span id="l8.1718" class="difflineminus">-              !((!oldEnd &amp;&amp; !this.mFilter.mEndDate) ||</span>
<a href="#l8.1719"></a><span id="l8.1719" class="difflineminus">-                (oldEnd &amp;&amp; this.mFilter.mEndDate &amp;&amp; oldEnd.compare(this.mFilter.mEndDate) == 0))) {</span>
<a href="#l8.1720"></a><span id="l8.1720" class="difflineminus">-              this.refresh();</span>
<a href="#l8.1721"></a><span id="l8.1721" class="difflineminus">-          }</span>
<a href="#l8.1722"></a><span id="l8.1722" class="difflineplus">+            // we only need to refresh the tree if the filter properties or date range changed</span>
<a href="#l8.1723"></a><span id="l8.1723" class="difflineplus">+            if (needsRefresh ||</span>
<a href="#l8.1724"></a><span id="l8.1724" class="difflineplus">+                !((!oldStart &amp;&amp; !this.mFilter.mStartDate) ||</span>
<a href="#l8.1725"></a><span id="l8.1725" class="difflineplus">+                  (oldStart &amp;&amp; this.mFilter.mStartDate &amp;&amp; oldStart.compare(this.mFilter.mStartDate) == 0)) ||</span>
<a href="#l8.1726"></a><span id="l8.1726" class="difflineplus">+                !((!oldEnd &amp;&amp; !this.mFilter.mEndDate) ||</span>
<a href="#l8.1727"></a><span id="l8.1727" class="difflineplus">+                  (oldEnd &amp;&amp; this.mFilter.mEndDate &amp;&amp; oldEnd.compare(this.mFilter.mEndDate) == 0))) {</span>
<a href="#l8.1728"></a><span id="l8.1728" class="difflineplus">+                this.refresh();</span>
<a href="#l8.1729"></a><span id="l8.1729" class="difflineplus">+            }</span>
<a href="#l8.1730"></a><span id="l8.1730">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1731"></a><span id="l8.1731">       &lt;/method&gt;</span>
<a href="#l8.1732"></a><span id="l8.1732"> </span>
<a href="#l8.1733"></a><span id="l8.1733">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l8.1734"></a><span id="l8.1734">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l8.1735"></a><span id="l8.1735">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1736"></a><span id="l8.1736" class="difflineminus">-          this.doUpdateFilter(aFilter);</span>
<a href="#l8.1737"></a><span id="l8.1737" class="difflineplus">+            this.doUpdateFilter(aFilter);</span>
<a href="#l8.1738"></a><span id="l8.1738">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1739"></a><span id="l8.1739">       &lt;/method&gt;</span>
<a href="#l8.1740"></a><span id="l8.1740"> </span>
<a href="#l8.1741"></a><span id="l8.1741">       &lt;method name=&quot;updateFocus&quot;&gt;</span>
<a href="#l8.1742"></a><span id="l8.1742">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1743"></a><span id="l8.1743" class="difflineminus">-          let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1744"></a><span id="l8.1744" class="difflineminus">-          let menuOpen = false;</span>
<a href="#l8.1745"></a><span id="l8.1745" class="difflineplus">+            let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1746"></a><span id="l8.1746" class="difflineplus">+            let menuOpen = false;</span>
<a href="#l8.1747"></a><span id="l8.1747"> </span>
<a href="#l8.1748"></a><span id="l8.1748" class="difflineminus">-          // we need to consider the tree focused if the context menu is open.</span>
<a href="#l8.1749"></a><span id="l8.1749" class="difflineminus">-          if (this.hasAttribute(&quot;context&quot;)) {</span>
<a href="#l8.1750"></a><span id="l8.1750" class="difflineminus">-              let context = document.getElementById(this.getAttribute(&quot;context&quot;));</span>
<a href="#l8.1751"></a><span id="l8.1751" class="difflineminus">-              if (context &amp;&amp; context.state) {</span>
<a href="#l8.1752"></a><span id="l8.1752" class="difflineminus">-                  menuOpen = (context.state == &quot;open&quot;) || (context.state == &quot;showing&quot;);</span>
<a href="#l8.1753"></a><span id="l8.1753" class="difflineminus">-              }</span>
<a href="#l8.1754"></a><span id="l8.1754" class="difflineminus">-          }</span>
<a href="#l8.1755"></a><span id="l8.1755" class="difflineplus">+            // we need to consider the tree focused if the context menu is open.</span>
<a href="#l8.1756"></a><span id="l8.1756" class="difflineplus">+            if (this.hasAttribute(&quot;context&quot;)) {</span>
<a href="#l8.1757"></a><span id="l8.1757" class="difflineplus">+                let context = document.getElementById(this.getAttribute(&quot;context&quot;));</span>
<a href="#l8.1758"></a><span id="l8.1758" class="difflineplus">+                if (context &amp;&amp; context.state) {</span>
<a href="#l8.1759"></a><span id="l8.1759" class="difflineplus">+                    menuOpen = (context.state == &quot;open&quot;) || (context.state == &quot;showing&quot;);</span>
<a href="#l8.1760"></a><span id="l8.1760" class="difflineplus">+                }</span>
<a href="#l8.1761"></a><span id="l8.1761" class="difflineplus">+            }</span>
<a href="#l8.1762"></a><span id="l8.1762"> </span>
<a href="#l8.1763"></a><span id="l8.1763" class="difflineminus">-          let focused = (document.activeElement == tree) || menuOpen;</span>
<a href="#l8.1764"></a><span id="l8.1764" class="difflineplus">+            let focused = (document.activeElement == tree) || menuOpen;</span>
<a href="#l8.1765"></a><span id="l8.1765"> </span>
<a href="#l8.1766"></a><span id="l8.1766" class="difflineminus">-          calendarController.onSelectionChanged({ detail: focused ? this.selectedTasks : [] });</span>
<a href="#l8.1767"></a><span id="l8.1767" class="difflineminus">-          calendarController.todo_tasktree_focused = focused;</span>
<a href="#l8.1768"></a><span id="l8.1768" class="difflineplus">+            calendarController.onSelectionChanged({ detail: focused ? this.selectedTasks : [] });</span>
<a href="#l8.1769"></a><span id="l8.1769" class="difflineplus">+            calendarController.todo_tasktree_focused = focused;</span>
<a href="#l8.1770"></a><span id="l8.1770">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1771"></a><span id="l8.1771">       &lt;/method&gt;</span>
<a href="#l8.1772"></a><span id="l8.1772">     &lt;/implementation&gt;</span>
<a href="#l8.1773"></a><span id="l8.1773"> </span>
<a href="#l8.1774"></a><span id="l8.1774">     &lt;handlers&gt;</span>
<a href="#l8.1775"></a><span id="l8.1775">       &lt;handler event=&quot;select&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1776"></a><span id="l8.1776" class="difflineminus">-        this.mTreeView.onSelect(event);</span>
<a href="#l8.1777"></a><span id="l8.1777" class="difflineminus">-        if (calendarController.todo_tasktree_focused) {</span>
<a href="#l8.1778"></a><span id="l8.1778" class="difflineminus">-            calendarController.onSelectionChanged({ detail: this.selectedTasks });</span>
<a href="#l8.1779"></a><span id="l8.1779" class="difflineminus">-        }</span>
<a href="#l8.1780"></a><span id="l8.1780" class="difflineplus">+          this.mTreeView.onSelect(event);</span>
<a href="#l8.1781"></a><span id="l8.1781" class="difflineplus">+          if (calendarController.todo_tasktree_focused) {</span>
<a href="#l8.1782"></a><span id="l8.1782" class="difflineplus">+              calendarController.onSelectionChanged({ detail: this.selectedTasks });</span>
<a href="#l8.1783"></a><span id="l8.1783" class="difflineplus">+          }</span>
<a href="#l8.1784"></a><span id="l8.1784">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1785"></a><span id="l8.1785">       &lt;handler event=&quot;focus&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1786"></a><span id="l8.1786" class="difflineminus">-        this.updateFocus();</span>
<a href="#l8.1787"></a><span id="l8.1787" class="difflineplus">+          this.updateFocus();</span>
<a href="#l8.1788"></a><span id="l8.1788">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1789"></a><span id="l8.1789">       &lt;handler event=&quot;blur&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1790"></a><span id="l8.1790" class="difflineminus">-        this.updateFocus();</span>
<a href="#l8.1791"></a><span id="l8.1791" class="difflineplus">+          this.updateFocus();</span>
<a href="#l8.1792"></a><span id="l8.1792">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1793"></a><span id="l8.1793">       &lt;handler event=&quot;keypress&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1794"></a><span id="l8.1794" class="difflineminus">-        this.mTreeView.onKeyPress(event);</span>
<a href="#l8.1795"></a><span id="l8.1795" class="difflineplus">+          this.mTreeView.onKeyPress(event);</span>
<a href="#l8.1796"></a><span id="l8.1796">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1797"></a><span id="l8.1797">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1798"></a><span id="l8.1798" class="difflineminus">-        this.mTreeView.onMouseDown(event);</span>
<a href="#l8.1799"></a><span id="l8.1799" class="difflineplus">+          this.mTreeView.onMouseDown(event);</span>
<a href="#l8.1800"></a><span id="l8.1800">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1801"></a><span id="l8.1801">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l8.1802"></a><span id="l8.1802" class="difflineminus">-        if (event.originalTarget.localName != &quot;treechildren&quot;) {</span>
<a href="#l8.1803"></a><span id="l8.1803" class="difflineminus">-            // We should only drag treechildren, not for example the scrollbar.</span>
<a href="#l8.1804"></a><span id="l8.1804" class="difflineminus">-            return;</span>
<a href="#l8.1805"></a><span id="l8.1805" class="difflineminus">-        }</span>
<a href="#l8.1806"></a><span id="l8.1806" class="difflineminus">-        let item = this.mTreeView._getItemFromEvent(event);</span>
<a href="#l8.1807"></a><span id="l8.1807" class="difflineminus">-        if (!item || item.calendar.readOnly) {</span>
<a href="#l8.1808"></a><span id="l8.1808" class="difflineminus">-            return;</span>
<a href="#l8.1809"></a><span id="l8.1809" class="difflineminus">-        }</span>
<a href="#l8.1810"></a><span id="l8.1810" class="difflineplus">+          if (event.originalTarget.localName != &quot;treechildren&quot;) {</span>
<a href="#l8.1811"></a><span id="l8.1811" class="difflineplus">+              // We should only drag treechildren, not for example the scrollbar.</span>
<a href="#l8.1812"></a><span id="l8.1812" class="difflineplus">+              return;</span>
<a href="#l8.1813"></a><span id="l8.1813" class="difflineplus">+          }</span>
<a href="#l8.1814"></a><span id="l8.1814" class="difflineplus">+          let item = this.mTreeView._getItemFromEvent(event);</span>
<a href="#l8.1815"></a><span id="l8.1815" class="difflineplus">+          if (!item || item.calendar.readOnly) {</span>
<a href="#l8.1816"></a><span id="l8.1816" class="difflineplus">+              return;</span>
<a href="#l8.1817"></a><span id="l8.1817" class="difflineplus">+          }</span>
<a href="#l8.1818"></a><span id="l8.1818"> </span>
<a href="#l8.1819"></a><span id="l8.1819" class="difflineminus">-        let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1820"></a><span id="l8.1820" class="difflineplus">+          let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.1821"></a><span id="l8.1821"> </span>
<a href="#l8.1822"></a><span id="l8.1822" class="difflineminus">-        // let's build the drag region</span>
<a href="#l8.1823"></a><span id="l8.1823" class="difflineminus">-        let region = null;</span>
<a href="#l8.1824"></a><span id="l8.1824" class="difflineminus">-        try {</span>
<a href="#l8.1825"></a><span id="l8.1825" class="difflineminus">-            region = Components.classes[&quot;@mozilla.org/gfx/region;1&quot;].createInstance(Components.interfaces.nsIScriptableRegion);</span>
<a href="#l8.1826"></a><span id="l8.1826" class="difflineminus">-            region.init();</span>
<a href="#l8.1827"></a><span id="l8.1827" class="difflineminus">-            let treeBox = tree.treeBox;</span>
<a href="#l8.1828"></a><span id="l8.1828" class="difflineminus">-            let bodyBox = treeBox.treeBody.boxObject;</span>
<a href="#l8.1829"></a><span id="l8.1829" class="difflineminus">-            let sel = tree.view.selection;</span>
<a href="#l8.1830"></a><span id="l8.1830" class="difflineplus">+          // let's build the drag region</span>
<a href="#l8.1831"></a><span id="l8.1831" class="difflineplus">+          let region = null;</span>
<a href="#l8.1832"></a><span id="l8.1832" class="difflineplus">+          try {</span>
<a href="#l8.1833"></a><span id="l8.1833" class="difflineplus">+              region = Components.classes[&quot;@mozilla.org/gfx/region;1&quot;].createInstance(Components.interfaces.nsIScriptableRegion);</span>
<a href="#l8.1834"></a><span id="l8.1834" class="difflineplus">+              region.init();</span>
<a href="#l8.1835"></a><span id="l8.1835" class="difflineplus">+              let treeBox = tree.treeBox;</span>
<a href="#l8.1836"></a><span id="l8.1836" class="difflineplus">+              let bodyBox = treeBox.treeBody.boxObject;</span>
<a href="#l8.1837"></a><span id="l8.1837" class="difflineplus">+              let sel = tree.view.selection;</span>
<a href="#l8.1838"></a><span id="l8.1838"> </span>
<a href="#l8.1839"></a><span id="l8.1839" class="difflineminus">-            let rowX = bodyBox.x;</span>
<a href="#l8.1840"></a><span id="l8.1840" class="difflineminus">-            let rowY = bodyBox.y;</span>
<a href="#l8.1841"></a><span id="l8.1841" class="difflineminus">-            let rowHeight = treeBox.rowHeight;</span>
<a href="#l8.1842"></a><span id="l8.1842" class="difflineminus">-            let rowWidth = bodyBox.width;</span>
<a href="#l8.1843"></a><span id="l8.1843" class="difflineplus">+              let rowX = bodyBox.x;</span>
<a href="#l8.1844"></a><span id="l8.1844" class="difflineplus">+              let rowY = bodyBox.y;</span>
<a href="#l8.1845"></a><span id="l8.1845" class="difflineplus">+              let rowHeight = treeBox.rowHeight;</span>
<a href="#l8.1846"></a><span id="l8.1846" class="difflineplus">+              let rowWidth = bodyBox.width;</span>
<a href="#l8.1847"></a><span id="l8.1847"> </span>
<a href="#l8.1848"></a><span id="l8.1848" class="difflineminus">-            // add a rectangle for each visible selected row</span>
<a href="#l8.1849"></a><span id="l8.1849" class="difflineminus">-            for (let i = treeBox.getFirstVisibleRow(); i &lt;= treeBox.getLastVisibleRow(); i++) {</span>
<a href="#l8.1850"></a><span id="l8.1850" class="difflineminus">-                if (sel.isSelected(i)) {</span>
<a href="#l8.1851"></a><span id="l8.1851" class="difflineminus">-                    region.unionRect(rowX, rowY, rowWidth, rowHeight);</span>
<a href="#l8.1852"></a><span id="l8.1852" class="difflineminus">-                }</span>
<a href="#l8.1853"></a><span id="l8.1853" class="difflineminus">-                rowY = rowY + rowHeight;</span>
<a href="#l8.1854"></a><span id="l8.1854" class="difflineminus">-            }</span>
<a href="#l8.1855"></a><span id="l8.1855" class="difflineplus">+              // add a rectangle for each visible selected row</span>
<a href="#l8.1856"></a><span id="l8.1856" class="difflineplus">+              for (let i = treeBox.getFirstVisibleRow(); i &lt;= treeBox.getLastVisibleRow(); i++) {</span>
<a href="#l8.1857"></a><span id="l8.1857" class="difflineplus">+                  if (sel.isSelected(i)) {</span>
<a href="#l8.1858"></a><span id="l8.1858" class="difflineplus">+                      region.unionRect(rowX, rowY, rowWidth, rowHeight);</span>
<a href="#l8.1859"></a><span id="l8.1859" class="difflineplus">+                  }</span>
<a href="#l8.1860"></a><span id="l8.1860" class="difflineplus">+                  rowY = rowY + rowHeight;</span>
<a href="#l8.1861"></a><span id="l8.1861" class="difflineplus">+              }</span>
<a href="#l8.1862"></a><span id="l8.1862"> </span>
<a href="#l8.1863"></a><span id="l8.1863" class="difflineminus">-            // and finally, clip the result to be sure we don't spill over...</span>
<a href="#l8.1864"></a><span id="l8.1864" class="difflineminus">-            if (!region.isEmpty()) {</span>
<a href="#l8.1865"></a><span id="l8.1865" class="difflineminus">-                region.intersectRect(bodyBox.x, bodyBox.y, bodyBox.width, bodyBox.height);</span>
<a href="#l8.1866"></a><span id="l8.1866" class="difflineminus">-            }</span>
<a href="#l8.1867"></a><span id="l8.1867" class="difflineminus">-        } catch (ex) {</span>
<a href="#l8.1868"></a><span id="l8.1868" class="difflineminus">-            cal.ASSERT(false, &quot;Error while building selection region: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l8.1869"></a><span id="l8.1869" class="difflineminus">-            region = null;</span>
<a href="#l8.1870"></a><span id="l8.1870" class="difflineminus">-        }</span>
<a href="#l8.1871"></a><span id="l8.1871" class="difflineminus">-        invokeEventDragSession(item, event.target);</span>
<a href="#l8.1872"></a><span id="l8.1872" class="difflineplus">+              // and finally, clip the result to be sure we don't spill over...</span>
<a href="#l8.1873"></a><span id="l8.1873" class="difflineplus">+              if (!region.isEmpty()) {</span>
<a href="#l8.1874"></a><span id="l8.1874" class="difflineplus">+                  region.intersectRect(bodyBox.x, bodyBox.y, bodyBox.width, bodyBox.height);</span>
<a href="#l8.1875"></a><span id="l8.1875" class="difflineplus">+              }</span>
<a href="#l8.1876"></a><span id="l8.1876" class="difflineplus">+          } catch (ex) {</span>
<a href="#l8.1877"></a><span id="l8.1877" class="difflineplus">+              cal.ASSERT(false, &quot;Error while building selection region: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l8.1878"></a><span id="l8.1878" class="difflineplus">+              region = null;</span>
<a href="#l8.1879"></a><span id="l8.1879" class="difflineplus">+          }</span>
<a href="#l8.1880"></a><span id="l8.1880" class="difflineplus">+          invokeEventDragSession(item, event.target);</span>
<a href="#l8.1881"></a><span id="l8.1881">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l8.1882"></a><span id="l8.1882">     &lt;/handlers&gt;</span>
<a href="#l8.1883"></a><span id="l8.1883"> </span>
<a href="#l8.1884"></a><span id="l8.1884">   &lt;/binding&gt;</span>
<a href="#l8.1885"></a><span id="l8.1885"> </span>
<a href="#l8.1886"></a><span id="l8.1886">   &lt;binding id=&quot;calendar-task-tree-todaypane&quot; extends=&quot;chrome://calendar/content/calendar-task-tree.xml#calendar-task-tree&quot;&gt;</span>
<a href="#l8.1887"></a><span id="l8.1887">     &lt;implementation&gt;</span>
<a href="#l8.1888"></a><span id="l8.1888">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l8.1889"></a><span id="l8.1889" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.1890"></a><span id="l8.1890" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.1891"></a><span id="l8.1891">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l8.1892"></a><span id="l8.1892"> </span>
<a href="#l8.1893"></a><span id="l8.1893">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l8.1894"></a><span id="l8.1894">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1895"></a><span id="l8.1895" class="difflineminus">-          let initialDate = agendaListbox.today ? agendaListbox.today.start : cal.now();</span>
<a href="#l8.1896"></a><span id="l8.1896" class="difflineminus">-          return initialDate ? initialDate : cal.now();</span>
<a href="#l8.1897"></a><span id="l8.1897" class="difflineplus">+            let initialDate = agendaListbox.today ? agendaListbox.today.start : cal.now();</span>
<a href="#l8.1898"></a><span id="l8.1898" class="difflineplus">+            return initialDate ? initialDate : cal.now();</span>
<a href="#l8.1899"></a><span id="l8.1899">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1900"></a><span id="l8.1900">       &lt;/method&gt;</span>
<a href="#l8.1901"></a><span id="l8.1901"> </span>
<a href="#l8.1902"></a><span id="l8.1902">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l8.1903"></a><span id="l8.1903">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l8.1904"></a><span id="l8.1904">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.1905"></a><span id="l8.1905" class="difflineminus">-          this.mFilter.selectedDate = agendaListbox.today &amp;&amp; agendaListbox.today.start ?</span>
<a href="#l8.1906"></a><span id="l8.1906" class="difflineminus">-                                      agendaListbox.today.start : cal.now();</span>
<a href="#l8.1907"></a><span id="l8.1907" class="difflineminus">-          this.doUpdateFilter(aFilter);</span>
<a href="#l8.1908"></a><span id="l8.1908" class="difflineplus">+            this.mFilter.selectedDate = agendaListbox.today &amp;&amp; agendaListbox.today.start ?</span>
<a href="#l8.1909"></a><span id="l8.1909" class="difflineplus">+                                        agendaListbox.today.start : cal.now();</span>
<a href="#l8.1910"></a><span id="l8.1910" class="difflineplus">+            this.doUpdateFilter(aFilter);</span>
<a href="#l8.1911"></a><span id="l8.1911">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.1912"></a><span id="l8.1912">       &lt;/method&gt;</span>
<a href="#l8.1913"></a><span id="l8.1913">     &lt;/implementation&gt;</span>
<a href="#l8.1914"></a><span id="l8.1914">   &lt;/binding&gt;</span>
<a href="#l8.1915"></a><span id="l8.1915"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -59,317 +59,317 @@</span>
<a href="#l9.4"></a><span id="l9.4">             &lt;/xul:box&gt;</span>
<a href="#l9.5"></a><span id="l9.5">           &lt;/xul:box&gt;</span>
<a href="#l9.6"></a><span id="l9.6">         &lt;/xul:hbox&gt;</span>
<a href="#l9.7"></a><span id="l9.7">       &lt;/xul:vbox&gt;</span>
<a href="#l9.8"></a><span id="l9.8">     &lt;/content&gt;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">     &lt;implementation&gt;</span>
<a href="#l9.11"></a><span id="l9.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-        this.eventNameTextbox.onblur = () =&gt; {</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-            this.stopEditing(true);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-        };</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-        this.eventNameTextbox.onkeypress = (event) =&gt; {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-            // save on enter</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-            if (event.keyCode == 13) {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-                this.stopEditing(true);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-            // abort on escape</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-            } else if (event.keyCode == 27) {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-                this.stopEditing(false);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-            }</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-        };</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-        let stopPropagationIfEditing = (event) =&gt; {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-            if (this.mEditing) {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-                event.stopPropagation();</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-            }</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-        };</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-        // while editing, single click positions cursor, so don't propagate.</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-        this.eventNameTextbox.onclick = stopPropagationIfEditing;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-        // while editing, double click selects words, so don't propagate.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-        this.eventNameTextbox.ondblclick = stopPropagationIfEditing;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-        // while editing, don't propagate mousedown/up (selects calEvent).</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-        this.eventNameTextbox.onmousedown = stopPropagationIfEditing;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-        this.eventNameTextbox.onmouseup = stopPropagationIfEditing;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+          this.eventNameTextbox.onblur = () =&gt; {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+              this.stopEditing(true);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+          };</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+          this.eventNameTextbox.onkeypress = (event) =&gt; {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+              // save on enter</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+              if (event.keyCode == 13) {</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+                  this.stopEditing(true);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+              // abort on escape</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+              } else if (event.keyCode == 27) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+                  this.stopEditing(false);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+              }</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+          };</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+          let stopPropagationIfEditing = (event) =&gt; {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+              if (this.mEditing) {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+                  event.stopPropagation();</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+              }</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+          };</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+          // while editing, single click positions cursor, so don't propagate.</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+          this.eventNameTextbox.onclick = stopPropagationIfEditing;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+          // while editing, double click selects words, so don't propagate.</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+          this.eventNameTextbox.ondblclick = stopPropagationIfEditing;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+          // while editing, don't propagate mousedown/up (selects calEvent).</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+          this.eventNameTextbox.onmousedown = stopPropagationIfEditing;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+          this.eventNameTextbox.onmouseup = stopPropagationIfEditing;</span>
<a href="#l9.67"></a><span id="l9.67">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">       &lt;field name=&quot;mOccurrence&quot;&gt;null&lt;/field&gt;</span>
<a href="#l9.70"></a><span id="l9.70">       &lt;field name=&quot;mSelected&quot;&gt;false&lt;/field&gt;</span>
<a href="#l9.71"></a><span id="l9.71">       &lt;field name=&quot;mCalendarView&quot;&gt;null&lt;/field&gt;</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">       &lt;property name=&quot;parentBox&quot;</span>
<a href="#l9.74"></a><span id="l9.74">                 onget=&quot;return this.mParentBox;&quot;</span>
<a href="#l9.75"></a><span id="l9.75">                 onset=&quot;this.mParentBox = val;&quot;/&gt;</span>
<a href="#l9.76"></a><span id="l9.76"> </span>
<a href="#l9.77"></a><span id="l9.77">       &lt;property name=&quot;selected&quot;&gt;</span>
<a href="#l9.78"></a><span id="l9.78">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-          return this.mSelected;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+            return this.mSelected;</span>
<a href="#l9.81"></a><span id="l9.81">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l9.82"></a><span id="l9.82">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-          if (val &amp;&amp; !this.mSelected) {</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-              this.mSelected = true;</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-              this.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-          } else if (!val &amp;&amp; this.mSelected) {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-              this.mSelected = false;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-              this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-          }</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-          return val;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+            if (val &amp;&amp; !this.mSelected) {</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                this.mSelected = true;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+                this.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+            } else if (!val &amp;&amp; this.mSelected) {</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+                this.mSelected = false;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+                this.removeAttribute(&quot;selected&quot;);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+            }</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+            return val;</span>
<a href="#l9.99"></a><span id="l9.99">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l9.100"></a><span id="l9.100">       &lt;/property&gt;</span>
<a href="#l9.101"></a><span id="l9.101">       &lt;property name=&quot;calendarView&quot;&gt;</span>
<a href="#l9.102"></a><span id="l9.102">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-          return this.mCalendarView;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+            return this.mCalendarView;</span>
<a href="#l9.105"></a><span id="l9.105">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l9.106"></a><span id="l9.106">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-          this.mCalendarView = val;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-          return val;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+            this.mCalendarView = val;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+            return val;</span>
<a href="#l9.111"></a><span id="l9.111">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l9.112"></a><span id="l9.112">       &lt;/property&gt;</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114">       &lt;property name=&quot;occurrence&quot;&gt;</span>
<a href="#l9.115"></a><span id="l9.115">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-          return this.mOccurrence;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+            return this.mOccurrence;</span>
<a href="#l9.118"></a><span id="l9.118">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l9.119"></a><span id="l9.119">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-          this.mOccurrence = val;</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-          this.setEditableLabel();</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-          this.setCSSClasses();</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-          return val;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+            this.mOccurrence = val;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+            this.setEditableLabel();</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+            this.setCSSClasses();</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+            return val;</span>
<a href="#l9.128"></a><span id="l9.128">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l9.129"></a><span id="l9.129">       &lt;/property&gt;</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131">       &lt;property name=&quot;eventNameLabel&quot; readonly=&quot;true&quot;</span>
<a href="#l9.132"></a><span id="l9.132">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name');&quot;/&gt;</span>
<a href="#l9.133"></a><span id="l9.133">       &lt;property name=&quot;eventNameTextbox&quot; readonly=&quot;true&quot;</span>
<a href="#l9.134"></a><span id="l9.134">         onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'event-name-textbox');&quot;/&gt;</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136">       &lt;method name=&quot;setEditableLabel&quot;&gt;</span>
<a href="#l9.137"></a><span id="l9.137">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-          let evl = this.eventNameLabel;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-          let item = this.mOccurrence;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-          evl.value = (item.title ? item.title.replace(/\n/g, &quot; &quot;)</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-                                  : cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+            let evl = this.eventNameLabel;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+            let item = this.mOccurrence;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+            evl.value = (item.title ? item.title.replace(/\n/g, &quot; &quot;)</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+                                    : cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l9.146"></a><span id="l9.146">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.147"></a><span id="l9.147">       &lt;/method&gt;</span>
<a href="#l9.148"></a><span id="l9.148"> </span>
<a href="#l9.149"></a><span id="l9.149">       &lt;method name=&quot;setCSSClasses&quot;&gt;</span>
<a href="#l9.150"></a><span id="l9.150">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-          let item = this.mOccurrence;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-          this.setAttribute(&quot;calendar-uri&quot;, item.calendar.uri.spec);</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-          this.setAttribute(&quot;calendar-id&quot;, item.calendar.id);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-          let categoriesArray = item.getCategories({});</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-          if (categoriesArray.length &gt; 0) {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-              let cssClassesArray = categoriesArray.map(cal.formatStringForCSSRule);</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-              this.setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-          }</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+            let item = this.mOccurrence;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+            this.setAttribute(&quot;calendar-uri&quot;, item.calendar.uri.spec);</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+            this.setAttribute(&quot;calendar-id&quot;, item.calendar.id);</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+            let categoriesArray = item.getCategories({});</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+            if (categoriesArray.length &gt; 0) {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+                let cssClassesArray = categoriesArray.map(cal.formatStringForCSSRule);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+                this.setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+            }</span>
<a href="#l9.167"></a><span id="l9.167"> </span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-          // Add alarm icons as needed.</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-          let alarms = item.getAlarms({});</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-          if (alarms.length &amp;&amp; Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-              let iconsBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-icons-box&quot;);</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-              cal.alarms.addReminderImages(iconsBox, alarms);</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+            // Add alarm icons as needed.</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+            let alarms = item.getAlarms({});</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+            if (alarms.length &amp;&amp; Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+                let iconsBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-icons-box&quot;);</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+                cal.alarms.addReminderImages(iconsBox, alarms);</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-              // Set suppressed status on the icons box</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-              setElementValue(iconsBox,</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-                              item.calendar.getProperty(&quot;suppressAlarms&quot;) || false,</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-                              &quot;suppressed&quot;);</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-          }</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+                // Set suppressed status on the icons box</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+                setElementValue(iconsBox,</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+                                item.calendar.getProperty(&quot;suppressAlarms&quot;) || false,</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+                                &quot;suppressed&quot;);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+            }</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-          // Item classification / privacy</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-          let classificationBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-classification-box&quot;);</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-          if (classificationBox) {</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-              classificationBox.setAttribute(&quot;classification&quot;, item.privacy || &quot;PUBLIC&quot;);</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-          }</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+            // Item classification / privacy</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+            let classificationBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-classification-box&quot;);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+            if (classificationBox) {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+                classificationBox.setAttribute(&quot;classification&quot;, item.privacy || &quot;PUBLIC&quot;);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+            }</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-          // Set up event box attributes for use in css selectors. Note if</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-          // something is added here, it should also be xbl:inherited correctly</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-          // in the &lt;content&gt; section of this binding, and all that inherit it.</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+            // Set up event box attributes for use in css selectors. Note if</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+            // something is added here, it should also be xbl:inherited correctly</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+            // in the &lt;content&gt; section of this binding, and all that inherit it.</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-          // Event type specific properties</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-          if (cal.isEvent(item)) {</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-              if (item.startDate.isDate) {</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-                  this.setAttribute(&quot;allday&quot;, &quot;true&quot;);</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-              }</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-              this.setAttribute(&quot;itemType&quot;, &quot;event&quot;);</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-          } else if (cal.isToDo(item)) {</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-              // progress attribute</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-              this.setAttribute(&quot;progress&quot;, cal.getProgressAtom(item));</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-              // Attribute for tasks and tasks image.</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-              this.setAttribute(&quot;itemType&quot;, &quot;todo&quot;);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-              if (item.entryDate &amp;&amp; !item.dueDate) {</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-                  this.setAttribute(&quot;todoType&quot;, &quot;start&quot;);</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-              } else if (!item.entryDate &amp;&amp; item.dueDate) {</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-                  this.setAttribute(&quot;todoType&quot;, &quot;end&quot;);</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-              }</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-          }</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+            // Event type specific properties</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+            if (cal.isEvent(item)) {</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+                if (item.startDate.isDate) {</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+                    this.setAttribute(&quot;allday&quot;, &quot;true&quot;);</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+                }</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+                this.setAttribute(&quot;itemType&quot;, &quot;event&quot;);</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+            } else if (cal.isToDo(item)) {</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+                // progress attribute</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+                this.setAttribute(&quot;progress&quot;, cal.getProgressAtom(item));</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+                // Attribute for tasks and tasks image.</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+                this.setAttribute(&quot;itemType&quot;, &quot;todo&quot;);</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+                if (item.entryDate &amp;&amp; !item.dueDate) {</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+                    this.setAttribute(&quot;todoType&quot;, &quot;start&quot;);</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+                } else if (!item.entryDate &amp;&amp; item.dueDate) {</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+                    this.setAttribute(&quot;todoType&quot;, &quot;end&quot;);</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+                }</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+            }</span>
<a href="#l9.242"></a><span id="l9.242"> </span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-          if (this.calendarView &amp;&amp;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-              item.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-              this.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-          }</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+            if (this.calendarView &amp;&amp;</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+                item.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+                this.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+            }</span>
<a href="#l9.251"></a><span id="l9.251"> </span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-          if (alarms.length) {</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-              this.setAttribute(&quot;alarm&quot;, &quot;true&quot;);</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-          }</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+            if (alarms.length) {</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+                this.setAttribute(&quot;alarm&quot;, &quot;true&quot;);</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+            }</span>
<a href="#l9.258"></a><span id="l9.258"> </span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-          // priority</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-          if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-              this.setAttribute(&quot;priority&quot;, &quot;high&quot;);</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-          } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-              this.setAttribute(&quot;priority&quot;, &quot;low&quot;);</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-          }</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+            // priority</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+            if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+                this.setAttribute(&quot;priority&quot;, &quot;high&quot;);</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+            } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+                this.setAttribute(&quot;priority&quot;, &quot;low&quot;);</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+            }</span>
<a href="#l9.271"></a><span id="l9.271"> </span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-          // status attribute</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-          if (item.status) {</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-              this.setAttribute(&quot;status&quot;, item.status.toUpperCase());</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-          }</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+            // status attribute</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+            if (item.status) {</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+                this.setAttribute(&quot;status&quot;, item.status.toUpperCase());</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+            }</span>
<a href="#l9.280"></a><span id="l9.280"> </span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-          // item class</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-          if (item.hasProperty(&quot;CLASS&quot;)) {</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-              this.setAttribute(&quot;itemclass&quot;, item.getProperty(&quot;CLASS&quot;));</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-          }</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+            // item class</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+            if (item.hasProperty(&quot;CLASS&quot;)) {</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+                this.setAttribute(&quot;itemclass&quot;, item.getProperty(&quot;CLASS&quot;));</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+            }</span>
<a href="#l9.289"></a><span id="l9.289"> </span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-          // calendar name</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-          this.setAttribute(&quot;calendar&quot;, item.calendar.name.toLowerCase());</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+            // calendar name</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+            this.setAttribute(&quot;calendar&quot;, item.calendar.name.toLowerCase());</span>
<a href="#l9.294"></a><span id="l9.294"> </span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-          // Invitation</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-          if (cal.isInvitation(item)) {</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-              this.setAttribute(&quot;invitation-status&quot;, cal.getInvitedAttendee(item).participationStatus);</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-              this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-          } else if (!cal.isCalendarWritable(item.calendar)) {</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-              this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-          }</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+            // Invitation</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+            if (cal.isInvitation(item)) {</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+                this.setAttribute(&quot;invitation-status&quot;, cal.getInvitedAttendee(item).participationStatus);</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+                this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+            } else if (!cal.isCalendarWritable(item.calendar)) {</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+                this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+            }</span>
<a href="#l9.309"></a><span id="l9.309">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.310"></a><span id="l9.310">       &lt;/method&gt;</span>
<a href="#l9.311"></a><span id="l9.311"> </span>
<a href="#l9.312"></a><span id="l9.312">       &lt;method name=&quot;startEditing&quot;&gt;</span>
<a href="#l9.313"></a><span id="l9.313">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-          this.editingTimer = null;</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-          this.mOriginalTextLabel = this.mOccurrence.title;</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+            this.editingTimer = null;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+            this.mOriginalTextLabel = this.mOccurrence.title;</span>
<a href="#l9.318"></a><span id="l9.318"> </span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-          this.eventNameLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+            this.eventNameLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l9.321"></a><span id="l9.321"> </span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-          this.mEditing = true;</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+            this.mEditing = true;</span>
<a href="#l9.324"></a><span id="l9.324"> </span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-          this.eventNameTextbox.value = this.mOriginalTextLabel;</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-          this.eventNameTextbox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-          this.eventNameTextbox.select();</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+            this.eventNameTextbox.value = this.mOriginalTextLabel;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+            this.eventNameTextbox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+            this.eventNameTextbox.select();</span>
<a href="#l9.331"></a><span id="l9.331">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.332"></a><span id="l9.332">       &lt;/method&gt;</span>
<a href="#l9.333"></a><span id="l9.333">       &lt;method name=&quot;select&quot;&gt;</span>
<a href="#l9.334"></a><span id="l9.334">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l9.335"></a><span id="l9.335">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-          if (!this.calendarView) {</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-              return;</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-          }</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-          let items = this.calendarView.mSelectedItems.slice();</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-          if (event.ctrlKey || event.metaKey) {</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-              if (this.selected) {</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-                  let pos = items.indexOf(this.mOccurrence);</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-                  items.splice(pos, 1);</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-              } else {</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-                  items.push(this.mOccurrence);</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-              }</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-          } else {</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-              items = [this.mOccurrence];</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-          }</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-          this.calendarView.setSelectedItems(items.length, items);</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+            if (!this.calendarView) {</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+                return;</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+            }</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+            let items = this.calendarView.mSelectedItems.slice();</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+            if (event.ctrlKey || event.metaKey) {</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+                if (this.selected) {</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+                    let pos = items.indexOf(this.mOccurrence);</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+                    items.splice(pos, 1);</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+                } else {</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+                    items.push(this.mOccurrence);</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+                }</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+            } else {</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+                items = [this.mOccurrence];</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+            }</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+            this.calendarView.setSelectedItems(items.length, items);</span>
<a href="#l9.366"></a><span id="l9.366">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.367"></a><span id="l9.367">       &lt;/method&gt;</span>
<a href="#l9.368"></a><span id="l9.368">       &lt;method name=&quot;stopEditing&quot;&gt;</span>
<a href="#l9.369"></a><span id="l9.369">         &lt;parameter name=&quot;saveChanges&quot;/&gt;</span>
<a href="#l9.370"></a><span id="l9.370">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-          if (!this.mEditing) {</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-              return;</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-          }</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+            if (!this.mEditing) {</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+                return;</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+            }</span>
<a href="#l9.377"></a><span id="l9.377"> </span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-          this.mEditing = false;</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+            this.mEditing = false;</span>
<a href="#l9.380"></a><span id="l9.380"> </span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-          if (saveChanges &amp;&amp; (this.eventNameTextbox.value != this.mOriginalTextLabel)) {</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-              this.calendarView.controller.modifyOccurrence(this.mOccurrence,</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-                                                            null, null,</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-                                                            this.eventNameTextbox.value);</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+            if (saveChanges &amp;&amp; (this.eventNameTextbox.value != this.mOriginalTextLabel)) {</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+                this.calendarView.controller.modifyOccurrence(this.mOccurrence,</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+                                                              null, null,</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+                                                              this.eventNameTextbox.value);</span>
<a href="#l9.389"></a><span id="l9.389"> </span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-              // Note that as soon as we do the modifyItem, this element ceases to exist,</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-              // so don't bother trying to modify anything further here! ('this' exists,</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-              // because it's being kept alive, but our child content etc. is all gone)</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-              return;</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-          }</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+                // Note that as soon as we do the modifyItem, this element ceases to exist,</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+                // so don't bother trying to modify anything further here! ('this' exists,</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+                // because it's being kept alive, but our child content etc. is all gone)</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineplus">+                return;</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+            }</span>
<a href="#l9.400"></a><span id="l9.400"> </span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-          this.eventNameTextbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-          this.eventNameLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+            this.eventNameTextbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+            this.eventNameLabel.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l9.405"></a><span id="l9.405">         ]]&gt;&lt;/body&gt;</span>
<a href="#l9.406"></a><span id="l9.406">       &lt;/method&gt;</span>
<a href="#l9.407"></a><span id="l9.407">     &lt;/implementation&gt;</span>
<a href="#l9.408"></a><span id="l9.408"> </span>
<a href="#l9.409"></a><span id="l9.409">     &lt;handlers&gt;</span>
<a href="#l9.410"></a><span id="l9.410">       &lt;handler event=&quot;contextmenu&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-        // If the middle/right button was used for click just select the item.</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-        if (!this.selected) {</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-            this.select(event);</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-        }</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+          // If the middle/right button was used for click just select the item.</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+          if (!this.selected) {</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+              this.select(event);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+          }</span>
<a href="#l9.419"></a><span id="l9.419">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.420"></a><span id="l9.420">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-        if (this.mEditing) {</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-            return;</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-        }</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+          if (this.mEditing) {</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+              return;</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+          }</span>
<a href="#l9.427"></a><span id="l9.427"> </span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-        // If the left button was used and the item is already selected</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-        // and there are no multiple items selected start</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-        // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-        // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+          // If the left button was used and the item is already selected</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+          // and there are no multiple items selected start</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+          // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+          // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l9.436"></a><span id="l9.436"> </span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-        if (this.selected &amp;&amp; !(event.ctrlKey || event.metaKey) &amp;&amp;</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-              cal.isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-            if (this.editingTimer) {</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-                clearTimeout(this.editingTimer);</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-            }</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-            this.editingTimer = setTimeout(() =&gt; this.startEditing(), 350);</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-        } else {</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-            this.select(event);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-        }</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+          if (this.selected &amp;&amp; !(event.ctrlKey || event.metaKey) &amp;&amp;</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+                cal.isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+              if (this.editingTimer) {</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+                  clearTimeout(this.editingTimer);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+              }</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+              this.editingTimer = setTimeout(() =&gt; this.startEditing(), 350);</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+          } else {</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+              this.select(event);</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+          }</span>
<a href="#l9.457"></a><span id="l9.457">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.458"></a><span id="l9.458"> </span>
<a href="#l9.459"></a><span id="l9.459">       &lt;handler event=&quot;dblclick&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l9.462"></a><span id="l9.462"> </span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-        // stop 'single click edit' timeout (if started)</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-        if (this.editingTimer) {</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-            clearTimeout(this.editingTimer);</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-            this.editingTimer = null;</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-        }</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+          // stop 'single click edit' timeout (if started)</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+          if (this.editingTimer) {</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+              clearTimeout(this.editingTimer);</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+              this.editingTimer = null;</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+          }</span>
<a href="#l9.473"></a><span id="l9.473"> </span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-        if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-            let item = event.ctrlKey ? this.mOccurrence.parentItem : this.mOccurrence;</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-            this.calendarView.controller.modifyOccurrence(item);</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineminus">-        }</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+          if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+              let item = event.ctrlKey ? this.mOccurrence.parentItem : this.mOccurrence;</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+              this.calendarView.controller.modifyOccurrence(item);</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+          }</span>
<a href="#l9.482"></a><span id="l9.482">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.483"></a><span id="l9.483">       &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-        if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-            onMouseOverItem(event);</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-        }</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+          if (this.calendarView &amp;&amp; this.calendarView.controller) {</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+              onMouseOverItem(event);</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineplus">+          }</span>
<a href="#l9.492"></a><span id="l9.492">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.493"></a><span id="l9.493">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-        if (event.target.localName == &quot;calendar-event-box&quot;) {</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-            return;</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-        }</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-        let item = this.occurrence;</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-        let isInvitation = item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item);</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-        if (!cal.isCalendarWritable(item.calendar) || !cal.userCanModifyItem(item) || isInvitation) {</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-            return;</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-        }</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-        if (!this.selected) {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-            this.select(event);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-        }</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-        invokeEventDragSession(item, this);</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+          if (event.target.localName == &quot;calendar-event-box&quot;) {</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+              return;</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+          }</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+          let item = this.occurrence;</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+          let isInvitation = item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item);</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+          if (!cal.isCalendarWritable(item.calendar) || !cal.userCanModifyItem(item) || isInvitation) {</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+              return;</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+          }</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+          if (!this.selected) {</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+              this.select(event);</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+          }</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+          invokeEventDragSession(item, this);</span>
<a href="#l9.518"></a><span id="l9.518">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l9.519"></a><span id="l9.519">     &lt;/handlers&gt;</span>
<a href="#l9.520"></a><span id="l9.520">   &lt;/binding&gt;</span>
<a href="#l9.521"></a><span id="l9.521"> </span>
<a href="#l9.522"></a><span id="l9.522">   &lt;binding id=&quot;calendar-category-box&quot;&gt;</span>
<a href="#l9.523"></a><span id="l9.523">     &lt;!-- calendar-views.css makes this binding hide if the categories attribute</span>
<a href="#l9.524"></a><span id="l9.524">          is not specified --&gt;</span>
<a href="#l9.525"></a><span id="l9.525">     &lt;content&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,292 +8,292 @@</span>
<a href="#l10.4"></a><span id="l10.4">           xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l10.5"></a><span id="l10.5">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l10.6"></a><span id="l10.6">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   &lt;binding id=&quot;calendar-day-view&quot;</span>
<a href="#l10.9"></a><span id="l10.9">            extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.15"></a><span id="l10.15">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-          return &quot;day-view-observer&quot;;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+            return &quot;day-view-observer&quot;;</span>
<a href="#l10.19"></a><span id="l10.19">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.20"></a><span id="l10.20">       &lt;/property&gt;</span>
<a href="#l10.21"></a><span id="l10.21">       &lt;property name=&quot;supportsWorkdaysOnly&quot;</span>
<a href="#l10.22"></a><span id="l10.22">                 readonly=&quot;true&quot;</span>
<a href="#l10.23"></a><span id="l10.23">                 onget=&quot;return false;&quot;/&gt;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">       &lt;!-- Public methods --&gt;</span>
<a href="#l10.26"></a><span id="l10.26">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l10.27"></a><span id="l10.27">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l10.28"></a><span id="l10.28">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-          if (!aDate) {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-              this.refresh();</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-              return;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-          }</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-          aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-          this.setDateRange(aDate, aDate);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-          this.selectedDay = aDate;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+            if (!aDate) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+                this.refresh();</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+                return;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+            }</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+            aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+            this.setDateRange(aDate, aDate);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+            this.selectedDay = aDate;</span>
<a href="#l10.43"></a><span id="l10.43">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.44"></a><span id="l10.44">       &lt;/method&gt;</span>
<a href="#l10.45"></a><span id="l10.45">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l10.46"></a><span id="l10.46">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l10.47"></a><span id="l10.47">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-          if (aNumber) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-              let currentDay = this.startDay.clone();</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-              currentDay.day += aNumber;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-              this.goToDay(currentDay);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-          } else {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-              this.goToDay(cal.now());</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-          }</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+            if (aNumber) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+                let currentDay = this.startDay.clone();</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+                currentDay.day += aNumber;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+                this.goToDay(currentDay);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+            } else {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+                this.goToDay(cal.now());</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+            }</span>
<a href="#l10.62"></a><span id="l10.62">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.63"></a><span id="l10.63">       &lt;/method&gt;</span>
<a href="#l10.64"></a><span id="l10.64">     &lt;/implementation&gt;</span>
<a href="#l10.65"></a><span id="l10.65">   &lt;/binding&gt;</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">   &lt;binding id=&quot;calendar-week-view&quot;</span>
<a href="#l10.68"></a><span id="l10.68">            extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l10.69"></a><span id="l10.69">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l10.70"></a><span id="l10.70">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-        // add a listener for the mode change</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-        this.mModeHandler = (event) =&gt; {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-            if (event.attrName == &quot;mode&quot;) {</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-                this.onModeChanged(event);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-            }</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-        };</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-        document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+          // add a listener for the mode change</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+          this.mModeHandler = (event) =&gt; {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+              if (event.attrName == &quot;mode&quot;) {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+                  this.onModeChanged(event);</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+              }</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+          };</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+          document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l10.88"></a><span id="l10.88">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.89"></a><span id="l10.89">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-        document.getElementById(&quot;modeBroadcaster&quot;).removeEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+          document.getElementById(&quot;modeBroadcaster&quot;).removeEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l10.92"></a><span id="l10.92">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l10.95"></a><span id="l10.95">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-          return &quot;week-view-observer&quot;;</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+            return &quot;week-view-observer&quot;;</span>
<a href="#l10.98"></a><span id="l10.98">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.99"></a><span id="l10.99">       &lt;/property&gt;</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101">       &lt;method name=&quot;onModeChanged&quot;&gt;</span>
<a href="#l10.102"></a><span id="l10.102">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l10.103"></a><span id="l10.103">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-          let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-          if (currentMode != &quot;calendar&quot;) {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-              timeIndicator.cancel();</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-          }</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+            let currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+            if (currentMode != &quot;calendar&quot;) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+                timeIndicator.cancel();</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+            }</span>
<a href="#l10.112"></a><span id="l10.112">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.113"></a><span id="l10.113">       &lt;/method&gt;</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">       &lt;!--Public methods--&gt;</span>
<a href="#l10.116"></a><span id="l10.116">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l10.117"></a><span id="l10.117">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l10.118"></a><span id="l10.118">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-          this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+            this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-          if (!aDate) {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-              this.refresh();</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-              return;</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-          }</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-          aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-          let weekStart = cal.getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-          let weekEnd = weekStart.clone();</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-          weekEnd.day += 6;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-          this.setDateRange(weekStart, weekEnd);</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-          this.selectedDay = aDate;</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+            if (!aDate) {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+                this.refresh();</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+                return;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+            }</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+            aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+            let weekStart = cal.getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+            let weekEnd = weekStart.clone();</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+            weekEnd.day += 6;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+            this.setDateRange(weekStart, weekEnd);</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+            this.selectedDay = aDate;</span>
<a href="#l10.142"></a><span id="l10.142">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.143"></a><span id="l10.143">       &lt;/method&gt;</span>
<a href="#l10.144"></a><span id="l10.144">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l10.145"></a><span id="l10.145">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l10.146"></a><span id="l10.146">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-          if (aNumber) {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-              let date = this.selectedDay.clone();</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-              date.day += 7 * aNumber;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-              this.goToDay(date);</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-          } else {</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-              this.goToDay(cal.now());</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-          }</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+            if (aNumber) {</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+                let date = this.selectedDay.clone();</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+                date.day += 7 * aNumber;</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+                this.goToDay(date);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+            } else {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+                this.goToDay(cal.now());</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+            }</span>
<a href="#l10.161"></a><span id="l10.161">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.162"></a><span id="l10.162">       &lt;/method&gt;</span>
<a href="#l10.163"></a><span id="l10.163">     &lt;/implementation&gt;</span>
<a href="#l10.164"></a><span id="l10.164">   &lt;/binding&gt;</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">   &lt;binding id=&quot;calendar-multiweek-view&quot; extends=&quot;chrome://calendar/content/calendar-month-view.xml#calendar-month-base-view&quot;&gt;</span>
<a href="#l10.167"></a><span id="l10.167">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l10.168"></a><span id="l10.168">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-        this.mWeeksInView = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+          this.mWeeksInView = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.175"></a><span id="l10.175">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.176"></a><span id="l10.176"> </span>
<a href="#l10.177"></a><span id="l10.177">       &lt;field name=&quot;mWeeksInView&quot;&gt;4&lt;/field&gt;</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179">       &lt;property name=&quot;weeksInView&quot;&gt;</span>
<a href="#l10.180"></a><span id="l10.180">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-          return this.mWeeksInView;</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+            return this.mWeeksInView;</span>
<a href="#l10.183"></a><span id="l10.183">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.184"></a><span id="l10.184">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-          this.mWeeksInView = val;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-          Preferences.set(&quot;calendar.weeks.inview&quot;, Number(val));</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-          this.refreshView();</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-          return val;</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+            this.mWeeksInView = val;</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+            Preferences.set(&quot;calendar.weeks.inview&quot;, Number(val));</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+            this.refreshView();</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+            return val;</span>
<a href="#l10.193"></a><span id="l10.193">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.194"></a><span id="l10.194">       &lt;/property&gt;</span>
<a href="#l10.195"></a><span id="l10.195"> </span>
<a href="#l10.196"></a><span id="l10.196">       &lt;property name=&quot;supportsZoom&quot; readonly=&quot;true&quot;</span>
<a href="#l10.197"></a><span id="l10.197">                 onget=&quot;return true;&quot;/&gt;</span>
<a href="#l10.198"></a><span id="l10.198"> </span>
<a href="#l10.199"></a><span id="l10.199">       &lt;method name=&quot;zoomIn&quot;&gt;</span>
<a href="#l10.200"></a><span id="l10.200">         &lt;parameter name=&quot;aLevel&quot;/&gt;</span>
<a href="#l10.201"></a><span id="l10.201">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-          let visibleWeeks = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-          visibleWeeks += (aLevel || 1);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+            let visibleWeeks = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+            visibleWeeks += (aLevel || 1);</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-          Preferences.set(&quot;calendar.weeks.inview&quot;, Math.min(visibleWeeks, 6));</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+            Preferences.set(&quot;calendar.weeks.inview&quot;, Math.min(visibleWeeks, 6));</span>
<a href="#l10.209"></a><span id="l10.209">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.210"></a><span id="l10.210">       &lt;/method&gt;</span>
<a href="#l10.211"></a><span id="l10.211"> </span>
<a href="#l10.212"></a><span id="l10.212">       &lt;method name=&quot;zoomOut&quot;&gt;</span>
<a href="#l10.213"></a><span id="l10.213">         &lt;parameter name=&quot;aLevel&quot;/&gt;</span>
<a href="#l10.214"></a><span id="l10.214">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-          let visibleWeeks = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-          visibleWeeks -= aLevel || 1;</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+            let visibleWeeks = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+            visibleWeeks -= aLevel || 1;</span>
<a href="#l10.219"></a><span id="l10.219"> </span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-          Preferences.set(&quot;calendar.weeks.inview&quot;, Math.max(visibleWeeks, 2));</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+            Preferences.set(&quot;calendar.weeks.inview&quot;, Math.max(visibleWeeks, 2));</span>
<a href="#l10.222"></a><span id="l10.222">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.223"></a><span id="l10.223">       &lt;/method&gt;</span>
<a href="#l10.224"></a><span id="l10.224"> </span>
<a href="#l10.225"></a><span id="l10.225">       &lt;method name=&quot;zoomReset&quot;&gt;</span>
<a href="#l10.226"></a><span id="l10.226">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-          Preferences.set(&quot;calendar.view.visiblehours&quot;, 4);</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+            Preferences.set(&quot;calendar.view.visiblehours&quot;, 4);</span>
<a href="#l10.229"></a><span id="l10.229">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.230"></a><span id="l10.230">       &lt;/method&gt;</span>
<a href="#l10.231"></a><span id="l10.231"> </span>
<a href="#l10.232"></a><span id="l10.232">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l10.233"></a><span id="l10.233">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-          return &quot;multiweek-view-observer&quot;;</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+            return &quot;multiweek-view-observer&quot;;</span>
<a href="#l10.236"></a><span id="l10.236">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.237"></a><span id="l10.237">       &lt;/property&gt;</span>
<a href="#l10.238"></a><span id="l10.238"> </span>
<a href="#l10.239"></a><span id="l10.239">       &lt;!--Public methods--&gt;</span>
<a href="#l10.240"></a><span id="l10.240">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l10.241"></a><span id="l10.241">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l10.242"></a><span id="l10.242">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-          this.showFullMonth = false;</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-          this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+            this.showFullMonth = false;</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+            this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.247"></a><span id="l10.247"> </span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-          // If aDate is null it means that only a refresh is needed</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-          // without changing the start and end of the view.</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-          if (aDate) {</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-              aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-              // Get the first date that should be shown. This is the</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-              // start of the week of the day that we're centering around</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-              // adjusted for the day the week starts on and the number</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-              // of previous weeks we're supposed to display.</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-              let dayStart = cal.getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-              dayStart.day -= 7 * Preferences.get(&quot;calendar.previousweeks.inview&quot;, 0);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-              // The last day we're supposed to show</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-              let dayEnd = dayStart.clone();</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-              dayEnd.day += (7 * this.mWeeksInView) - 1;</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-              this.setDateRange(dayStart, dayEnd);</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-              this.selectedDay = aDate;</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-          } else {</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-              this.refresh();</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-          }</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+            // If aDate is null it means that only a refresh is needed</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+            // without changing the start and end of the view.</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+            if (aDate) {</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+                aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+                // Get the first date that should be shown. This is the</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+                // start of the week of the day that we're centering around</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+                // adjusted for the day the week starts on and the number</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+                // of previous weeks we're supposed to display.</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+                let dayStart = cal.getWeekInfoService().getStartOfWeek(aDate);</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+                dayStart.day -= 7 * Preferences.get(&quot;calendar.previousweeks.inview&quot;, 0);</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+                // The last day we're supposed to show</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+                let dayEnd = dayStart.clone();</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+                dayEnd.day += (7 * this.mWeeksInView) - 1;</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+                this.setDateRange(dayStart, dayEnd);</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+                this.selectedDay = aDate;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+            } else {</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+                this.refresh();</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+            }</span>
<a href="#l10.284"></a><span id="l10.284">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.285"></a><span id="l10.285">       &lt;/method&gt;</span>
<a href="#l10.286"></a><span id="l10.286"> </span>
<a href="#l10.287"></a><span id="l10.287">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l10.288"></a><span id="l10.288">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l10.289"></a><span id="l10.289">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-          if (aNumber) {</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-              let date = this.startDay.clone();</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-              let savedSelectedDay = this.selectedDay.clone();</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-              // aNumber only corresponds to the number of weeks to move</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-              // make sure to compensate for previous weeks in view too</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-              date.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-              this.goToDay(date);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-              savedSelectedDay.day += 7 * aNumber;</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-              this.selectedDay = savedSelectedDay;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-          } else {</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-              let date = cal.now();</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-              this.goToDay(date);</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-              this.selectedDay = date;</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-          }</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+            if (aNumber) {</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+                let date = this.startDay.clone();</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+                let savedSelectedDay = this.selectedDay.clone();</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+                // aNumber only corresponds to the number of weeks to move</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+                // make sure to compensate for previous weeks in view too</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+                date.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+                this.goToDay(date);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+                savedSelectedDay.day += 7 * aNumber;</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+                this.selectedDay = savedSelectedDay;</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+            } else {</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+                let date = cal.now();</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+                this.goToDay(date);</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+                this.selectedDay = date;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+            }</span>
<a href="#l10.318"></a><span id="l10.318">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.319"></a><span id="l10.319">       &lt;/method&gt;</span>
<a href="#l10.320"></a><span id="l10.320">     &lt;/implementation&gt;</span>
<a href="#l10.321"></a><span id="l10.321">   &lt;/binding&gt;</span>
<a href="#l10.322"></a><span id="l10.322"> </span>
<a href="#l10.323"></a><span id="l10.323">   &lt;binding id=&quot;calendar-month-view&quot; extends=&quot;chrome://calendar/content/calendar-month-view.xml#calendar-month-base-view&quot;&gt;</span>
<a href="#l10.324"></a><span id="l10.324">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l10.325"></a><span id="l10.325">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.328"></a><span id="l10.328">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.329"></a><span id="l10.329"> </span>
<a href="#l10.330"></a><span id="l10.330">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l10.331"></a><span id="l10.331">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-          return &quot;month-view-observer&quot;;</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+            return &quot;month-view-observer&quot;;</span>
<a href="#l10.334"></a><span id="l10.334">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.335"></a><span id="l10.335">       &lt;/property&gt;</span>
<a href="#l10.336"></a><span id="l10.336"> </span>
<a href="#l10.337"></a><span id="l10.337">       &lt;!--Public methods--&gt;</span>
<a href="#l10.338"></a><span id="l10.338">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l10.339"></a><span id="l10.339">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l10.340"></a><span id="l10.340">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-          this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+            this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.343"></a><span id="l10.343"> </span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-          if (aDate) {</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-              aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-          }</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-          this.showDate(aDate);</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+            if (aDate) {</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+                aDate = aDate.getInTimezone(this.timezone);</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+            }</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+            this.showDate(aDate);</span>
<a href="#l10.352"></a><span id="l10.352">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.353"></a><span id="l10.353">       &lt;/method&gt;</span>
<a href="#l10.354"></a><span id="l10.354">       &lt;method name=&quot;getRangeDescription&quot;&gt;</span>
<a href="#l10.355"></a><span id="l10.355">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineminus">-          let monthName = cal.formatMonth(this.rangeStartDate.month + 1,</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-                                          &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-          return cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;, [monthName, this.rangeStartDate.year]);</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+            let monthName = cal.formatMonth(this.rangeStartDate.month + 1,</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+                                            &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;, [monthName, this.rangeStartDate.year]);</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l10.364"></a><span id="l10.364">        &lt;/method&gt;</span>
<a href="#l10.365"></a><span id="l10.365">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l10.366"></a><span id="l10.366">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l10.367"></a><span id="l10.367">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-          let dates = this.getDateList({});</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-          this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+            let dates = this.getDateList({});</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+            this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l10.372"></a><span id="l10.372"> </span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-          if (aNumber) {</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-              // The first few dates in this list are likely in the month</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-              // prior to the one actually being shown (since the month</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineminus">-              // probably doesn't start on a Sunday).  The 7th item must</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-              // be in correct month though.</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineminus">-              let date = dates[6].clone();</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+            if (aNumber) {</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+                // The first few dates in this list are likely in the month</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+                // prior to the one actually being shown (since the month</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+                // probably doesn't start on a Sunday).  The 7th item must</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+                // be in correct month though.</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+                let date = dates[6].clone();</span>
<a href="#l10.385"></a><span id="l10.385"> </span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-              date.month += aNumber;</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-              // Need to store this before we move</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-              let oldSelectedDay = this.selectedDay;</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+                date.month += aNumber;</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+                // Need to store this before we move</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+                let oldSelectedDay = this.selectedDay;</span>
<a href="#l10.392"></a><span id="l10.392"> </span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-              this.goToDay(date);</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+                this.goToDay(date);</span>
<a href="#l10.395"></a><span id="l10.395"> </span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-              // Most of the time we want to select the date with the</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-              // same day number in the next month</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-              let newSelectedDay = oldSelectedDay.clone();</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-              newSelectedDay.month += aNumber;</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-              // correct for accidental rollover into the next month</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-              if ((newSelectedDay.month - aNumber + 12) % 12 != oldSelectedDay.month) {</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-                  newSelectedDay.month -= 1;</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-                  newSelectedDay.day = newSelectedDay.endOfMonth.day;</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-              }</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+                // Most of the time we want to select the date with the</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+                // same day number in the next month</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+                let newSelectedDay = oldSelectedDay.clone();</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+                newSelectedDay.month += aNumber;</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+                // correct for accidental rollover into the next month</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+                if ((newSelectedDay.month - aNumber + 12) % 12 != oldSelectedDay.month) {</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+                    newSelectedDay.month -= 1;</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+                    newSelectedDay.day = newSelectedDay.endOfMonth.day;</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+                }</span>
<a href="#l10.414"></a><span id="l10.414"> </span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-              this.selectedDay = newSelectedDay;</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-          } else {</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-              let date = cal.now();</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-              this.goToDay(date);</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-              this.selectedDay = date;</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-          }</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+                this.selectedDay = newSelectedDay;</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+            } else {</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+                let date = cal.now();</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+                this.goToDay(date);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+                this.selectedDay = date;</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+            }</span>
<a href="#l10.427"></a><span id="l10.427">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.428"></a><span id="l10.428">       &lt;/method&gt;</span>
<a href="#l10.429"></a><span id="l10.429">     &lt;/implementation&gt;</span>
<a href="#l10.430"></a><span id="l10.430">   &lt;/binding&gt;</span>
<a href="#l10.431"></a><span id="l10.431"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -61,402 +61,402 @@</span>
<a href="#l11.4"></a><span id="l11.4">       &lt;field name=&quot;mRowHeight&quot;&gt;0&lt;/field&gt;</span>
<a href="#l11.5"></a><span id="l11.5">       &lt;field name=&quot;mNumColumns&quot;&gt;0&lt;/field&gt;</span>
<a href="#l11.6"></a><span id="l11.6">       &lt;field name=&quot;mIsOffline&quot;&gt;0&lt;/field&gt;</span>
<a href="#l11.7"></a><span id="l11.7">       &lt;field name=&quot;mIsReadOnly&quot;&gt;false&lt;/field&gt;</span>
<a href="#l11.8"></a><span id="l11.8">       &lt;field name=&quot;mIsInvitation&quot;&gt;false&lt;/field&gt;</span>
<a href="#l11.9"></a><span id="l11.9">       &lt;field name=&quot;mPopupOpen&quot;&gt;false&lt;/field&gt;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+          Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-        this.mMaxAttendees = 0;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+          this.mMaxAttendees = 0;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+          window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l11.24"></a><span id="l11.24">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l11.27"></a><span id="l11.27">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-          this.onInitialize();</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+            this.onInitialize();</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-          // this trigger the continous update chain, which</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-          // effectively calls this.onModify() on predefined</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-          // time intervals [each second].</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-          let self = this;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-          let callback = function() {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-              setTimeout(callback, 1000);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-              self.onModify();</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-          };</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-          callback();</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+            // this trigger the continous update chain, which</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+            // effectively calls this.onModify() on predefined</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+            // time intervals [each second].</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+            let self = this;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+            let callback = function() {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+                setTimeout(callback, 1000);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+                self.onModify();</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+            };</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+            callback();</span>
<a href="#l11.49"></a><span id="l11.49">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.50"></a><span id="l11.50">       &lt;/method&gt;</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l11.53"></a><span id="l11.53">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-          let args = window.arguments[0];</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-          let organizer = args.organizer;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-          let attendees = args.attendees;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-          let calendar = args.calendar;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+            let args = window.arguments[0];</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+            let organizer = args.organizer;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+            let attendees = args.attendees;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+            let calendar = args.calendar;</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-          this.mIsReadOnly = calendar.readOnly;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+            this.mIsReadOnly = calendar.readOnly;</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-          // assume we're the organizer [in case that the calendar</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-          // does not support the concept of identities].</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-          let organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-                             ? organizer.id</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-                             : calendar.getProperty(&quot;organizerId&quot;));</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+            // assume we're the organizer [in case that the calendar</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+            // does not support the concept of identities].</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+            let organizerID = ((organizer &amp;&amp; organizer.id)</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                               ? organizer.id</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+                               : calendar.getProperty(&quot;organizerId&quot;));</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-          calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-          this.mIsInvitation = (calendar &amp;&amp; calendar.isInvitation(args.item));</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+            calendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+            this.mIsInvitation = (calendar &amp;&amp; calendar.isInvitation(args.item));</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-          let listbox =</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-          let template =</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-          template.focus();</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+            let listbox =</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+            let template =</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+            template.focus();</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-          if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-              listbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-          }</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+            if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+                listbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+            }</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-          // TODO: the organizer should show up in the attendee list, but this information</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-          // should be based on the organizer contained in the appropriate field of calIItemBase.</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-          // This is currently not supported, since we're still missing calendar identities.</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-          if (organizerID &amp;&amp; organizerID != &quot;&quot;) {</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-              if (organizer) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-                  if (!organizer.id) {</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-                      organizer.id = organizerID;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-                  }</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-                  if (!organizer.role) {</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-                      organizer.role = &quot;CHAIR&quot;;</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-                  }</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-                  if (!organizer.participationStatus) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-                      organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-                  }</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-              } else {</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-                  organizer = this.createAttendee();</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-                  organizer.id = organizerID;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-                  organizer.role = &quot;CHAIR&quot;;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-                  organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-              }</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-              if (!organizer.commonName || !organizer.commonName.length) {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-                  organizer.commonName = calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-              }</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-              organizer.isOrganizer = true;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-              this.appendAttendee(organizer, listbox, template, true);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-          }</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+            // TODO: the organizer should show up in the attendee list, but this information</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+            // should be based on the organizer contained in the appropriate field of calIItemBase.</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+            // This is currently not supported, since we're still missing calendar identities.</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+            if (organizerID &amp;&amp; organizerID != &quot;&quot;) {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+                if (organizer) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+                    if (!organizer.id) {</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                        organizer.id = organizerID;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+                    }</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+                    if (!organizer.role) {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+                        organizer.role = &quot;CHAIR&quot;;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+                    }</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+                    if (!organizer.participationStatus) {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+                        organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+                    }</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+                } else {</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+                    organizer = this.createAttendee();</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+                    organizer.id = organizerID;</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+                    organizer.role = &quot;CHAIR&quot;;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+                    organizer.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+                }</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+                if (!organizer.commonName || !organizer.commonName.length) {</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+                    organizer.commonName = calendar.getProperty(&quot;organizerCN&quot;);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+                }</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+                organizer.isOrganizer = true;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+                this.appendAttendee(organizer, listbox, template, true);</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+            }</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-          let numRowsAdded = 0;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-          if (attendees.length &gt; 0) {</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-              for (let attendee of attendees) {</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-                  this.appendAttendee(attendee, listbox, template, false);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-                  numRowsAdded++;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-              }</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-          }</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-          if (numRowsAdded == 0) {</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-              this.appendAttendee(null, listbox, template, false);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-          }</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+            let numRowsAdded = 0;</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+            if (attendees.length &gt; 0) {</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+                for (let attendee of attendees) {</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+                    this.appendAttendee(attendee, listbox, template, false);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+                    numRowsAdded++;</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+                }</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+            }</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+            if (numRowsAdded == 0) {</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+                this.appendAttendee(null, listbox, template, false);</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+            }</span>
<a href="#l11.177"></a><span id="l11.177"> </span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-          // detach the template item from the listbox, but hold the reference.</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-          // until this function returns we add at least a single copy of this template back again.</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-          template.remove();</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+            // detach the template item from the listbox, but hold the reference.</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+            // until this function returns we add at least a single copy of this template back again.</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+            template.remove();</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-          this.setFocus(this.mMaxAttendees);</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+            this.setFocus(this.mMaxAttendees);</span>
<a href="#l11.187"></a><span id="l11.187">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.188"></a><span id="l11.188">       &lt;/method&gt;</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190">       &lt;!-- appends a new row using an existing attendee structure --&gt;</span>
<a href="#l11.191"></a><span id="l11.191">       &lt;method name=&quot;appendAttendee&quot;&gt;</span>
<a href="#l11.192"></a><span id="l11.192">         &lt;parameter name=&quot;aAttendee&quot;/&gt;</span>
<a href="#l11.193"></a><span id="l11.193">         &lt;parameter name=&quot;aParentNode&quot;/&gt;</span>
<a href="#l11.194"></a><span id="l11.194">         &lt;parameter name=&quot;aTemplateNode&quot;/&gt;</span>
<a href="#l11.195"></a><span id="l11.195">         &lt;parameter name=&quot;aDisableIfOrganizer&quot;/&gt;</span>
<a href="#l11.196"></a><span id="l11.196">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-          // create a new listbox item and append it to our parent control.</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-          let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+            // create a new listbox item and append it to our parent control.</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+            let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-          let input =</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-                  newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-          let roleStatusIcon =</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-                  newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-          let userTypeIcon =</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-                  newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+            let input =</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+                    newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+            let roleStatusIcon =</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+                    newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+            let userTypeIcon =</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+                    newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.220"></a><span id="l11.220"> </span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-          // We always clone the first row. The problem is that the first row</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-          // could be focused. When we clone that row, we end up with a cloned</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-          // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-          // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-          // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-          // rather than using the real visible first row of the listbox.</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-          // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-          // is never copied when the node is cloned.</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-          if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-              input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-          }</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+            // We always clone the first row. The problem is that the first row</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+            // could be focused. When we clone that row, we end up with a cloned</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+            // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+            // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+            // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+            // rather than using the real visible first row of the listbox.</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+            // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+            // is never copied when the node is cloned.</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+            if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+                input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+            }</span>
<a href="#l11.243"></a><span id="l11.243"> </span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-          aParentNode.appendChild(newNode);</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+            aParentNode.appendChild(newNode);</span>
<a href="#l11.246"></a><span id="l11.246"> </span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-          // the template could have its fields disabled,</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-          // that's why we need to reset their status.</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-          input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-          userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-          roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+            // the template could have its fields disabled,</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+            // that's why we need to reset their status.</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+            input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+            userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+            roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-          if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-              input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-              userTypeIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-              roleStatusIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-          }</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+            if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+                input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+                userTypeIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+                roleStatusIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+            }</span>
<a href="#l11.268"></a><span id="l11.268"> </span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-          // disable the input-field [name &lt;email&gt;] if this attendee</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-          // appears to be the organizer.</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-          if (aDisableIfOrganizer &amp;&amp; aAttendee &amp;&amp; aAttendee.isOrganizer) {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-              input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-          }</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+            // disable the input-field [name &lt;email&gt;] if this attendee</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+            // appears to be the organizer.</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+            if (aDisableIfOrganizer &amp;&amp; aAttendee &amp;&amp; aAttendee.isOrganizer) {</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+                input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+            }</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-          this.mMaxAttendees++;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-          let rowNumber = this.mMaxAttendees;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-          if (rowNumber &gt;= 0) {</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-              roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-              userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-              input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-          }</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+            this.mMaxAttendees++;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+            let rowNumber = this.mMaxAttendees;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+            if (rowNumber &gt;= 0) {</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+                roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+                userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+                input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+            }</span>
<a href="#l11.294"></a><span id="l11.294"> </span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-          if (!aAttendee) {</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-              aAttendee = this.createAttendee();</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-          }</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+            if (!aAttendee) {</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+                aAttendee = this.createAttendee();</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+            }</span>
<a href="#l11.301"></a><span id="l11.301"> </span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-          // construct the display string from common name and/or email address.</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-          let commonName = aAttendee.commonName || &quot;&quot;;</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-          let inputValue = cal.removeMailTo(aAttendee.id || &quot;&quot;);</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-          if (commonName.length) {</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-              // Make the commonName appear in quotes if it contains a</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-              // character that could confuse the header parser</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-              if (commonName.search(/[,;&lt;&gt;@]/) != -1) {</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-                  commonName = '&quot;' + commonName + '&quot;';</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-              }</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-              inputValue = inputValue.length ? commonName + &quot; &lt;&quot; + inputValue + &quot;&gt;&quot; : commonName;</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-          }</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+            // construct the display string from common name and/or email address.</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+            let commonName = aAttendee.commonName || &quot;&quot;;</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+            let inputValue = cal.removeMailTo(aAttendee.id || &quot;&quot;);</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+            if (commonName.length) {</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+                // Make the commonName appear in quotes if it contains a</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+                // character that could confuse the header parser</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+                if (commonName.search(/[,;&lt;&gt;@]/) != -1) {</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+                    commonName = '&quot;' + commonName + '&quot;';</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+                }</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+                inputValue = inputValue.length ? commonName + &quot; &lt;&quot; + inputValue + &quot;&gt;&quot; : commonName;</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+            }</span>
<a href="#l11.324"></a><span id="l11.324"> </span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-          // trim spaces if any</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-          inputValue = inputValue.trim();</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+            // trim spaces if any</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+            inputValue = inputValue.trim();</span>
<a href="#l11.329"></a><span id="l11.329"> </span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-          // don't set value with null, otherwise autocomplete stops working,</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-          // but make sure attendee and dirty are set</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-          if (inputValue.length) {</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-              input.setAttribute(&quot;value&quot;, inputValue);</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-              input.value = inputValue;</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-          }</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-          input.attendee = aAttendee;</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-          input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+            // don't set value with null, otherwise autocomplete stops working,</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+            // but make sure attendee and dirty are set</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+            if (inputValue.length) {</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+                input.setAttribute(&quot;value&quot;, inputValue);</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+                input.value = inputValue;</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+            }</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+            input.attendee = aAttendee;</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+            input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.346"></a><span id="l11.346"> </span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-          if (aAttendee) {</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-              // Set up userType</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-              setElementValue(userTypeIcon, aAttendee.userType || false, &quot;cutype&quot;);</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-              this.updateTooltip(userTypeIcon);</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+            if (aAttendee) {</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+                // Set up userType</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+                setElementValue(userTypeIcon, aAttendee.userType || false, &quot;cutype&quot;);</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+                this.updateTooltip(userTypeIcon);</span>
<a href="#l11.355"></a><span id="l11.355"> </span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-              // Set up role/status icon</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-              if (aAttendee.isOrganizer) {</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-                  roleStatusIcon.setAttribute(&quot;class&quot;, &quot;status-icon&quot;);</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-                  setElementValue(roleStatusIcon, aAttendee.participationStatus || false, &quot;status&quot;);</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-              } else {</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-                  roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-                  setElementValue(roleStatusIcon, aAttendee.role || false, &quot;role&quot;);</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-              }</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-              this.updateTooltip(roleStatusIcon);</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-          }</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+                // Set up role/status icon</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+                if (aAttendee.isOrganizer) {</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+                    roleStatusIcon.setAttribute(&quot;class&quot;, &quot;status-icon&quot;);</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+                    setElementValue(roleStatusIcon, aAttendee.participationStatus || false, &quot;status&quot;);</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+                } else {</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+                    roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+                    setElementValue(roleStatusIcon, aAttendee.role || false, &quot;role&quot;);</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+                }</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+                this.updateTooltip(roleStatusIcon);</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+            }</span>
<a href="#l11.376"></a><span id="l11.376"> </span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-          return true;</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+            return true;</span>
<a href="#l11.379"></a><span id="l11.379">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.380"></a><span id="l11.380">       &lt;/method&gt;</span>
<a href="#l11.381"></a><span id="l11.381"> </span>
<a href="#l11.382"></a><span id="l11.382">       &lt;method name=&quot;appendNewRow&quot;&gt;</span>
<a href="#l11.383"></a><span id="l11.383">         &lt;parameter name=&quot;aSetFocus&quot;/&gt;</span>
<a href="#l11.384"></a><span id="l11.384">         &lt;parameter name=&quot;aInsertAfter&quot;/&gt;</span>
<a href="#l11.385"></a><span id="l11.385">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-          let listbox =</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-          let listitem1 = this.getListItem(1);</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-          let newNode = null;</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+            let listbox =</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+            let listitem1 = this.getListItem(1);</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+            let newNode = null;</span>
<a href="#l11.396"></a><span id="l11.396"> </span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-          if (listbox &amp;&amp; listitem1) {</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-              let newAttendee = this.createAttendee();</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-              let nextDummy = this.getNextDummyRow();</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-              newNode = listitem1.cloneNode(true);</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+            if (listbox &amp;&amp; listitem1) {</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+                let newAttendee = this.createAttendee();</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+                let nextDummy = this.getNextDummyRow();</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+                newNode = listitem1.cloneNode(true);</span>
<a href="#l11.405"></a><span id="l11.405"> </span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-              if (aInsertAfter) {</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-                  listbox.insertBefore(newNode, aInsertAfter.nextSibling);</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-              } else if (nextDummy) {</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-                  listbox.replaceChild(newNode, nextDummy);</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-              } else {</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-                  listbox.appendChild(newNode);</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-              }</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+                if (aInsertAfter) {</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+                    listbox.insertBefore(newNode, aInsertAfter.nextSibling);</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+                } else if (nextDummy) {</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+                    listbox.replaceChild(newNode, nextDummy);</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+                } else {</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+                    listbox.appendChild(newNode);</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+                }</span>
<a href="#l11.420"></a><span id="l11.420"> </span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-              let input =</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-                      newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-              let roleStatusIcon =</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-                      newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-              let userTypeIcon =</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-                      newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+                let input =</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+                        newNode, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+                let roleStatusIcon =</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+                        newNode, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+                let userTypeIcon =</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+                        newNode, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.439"></a><span id="l11.439"> </span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-              // the template could have its fields disabled,</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-              // that's why we need to reset their status.</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-              input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-              roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-              userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+                // the template could have its fields disabled,</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+                // that's why we need to reset their status.</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+                input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+                roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+                userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.450"></a><span id="l11.450"> </span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-              if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-                  input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-                  roleStatusIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-                  userTypeIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-              }</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+                if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+                    input.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+                    roleStatusIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+                    userTypeIcon.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+                }</span>
<a href="#l11.461"></a><span id="l11.461"> </span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-              this.mMaxAttendees++;</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-              let rowNumber = this.mMaxAttendees;</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-              if (rowNumber &gt;= 0) {</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-                  roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-                  userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-                  input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-              }</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+                this.mMaxAttendees++;</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+                let rowNumber = this.mMaxAttendees;</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+                if (rowNumber &gt;= 0) {</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+                    roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+                    userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+                    input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+                }</span>
<a href="#l11.476"></a><span id="l11.476"> </span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-              input.value = null;</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-              input.removeAttribute(&quot;value&quot;);</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-              input.attendee = newAttendee;</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+                input.value = null;</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+                input.removeAttribute(&quot;value&quot;);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+                input.attendee = newAttendee;</span>
<a href="#l11.483"></a><span id="l11.483"> </span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-              // set role and participation status</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-              roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-              roleStatusIcon.setAttribute(&quot;role&quot;, &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-              userTypeIcon.setAttribute(&quot;cutype&quot;, &quot;INDIVIDUAL&quot;);</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+                // set role and participation status</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+                roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+                roleStatusIcon.setAttribute(&quot;role&quot;, &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+                userTypeIcon.setAttribute(&quot;cutype&quot;, &quot;INDIVIDUAL&quot;);</span>
<a href="#l11.492"></a><span id="l11.492"> </span>
<a href="#l11.493"></a><span id="l11.493" class="difflineminus">-              // Set tooltip for rolenames and usertype icon</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineminus">-              this.updateTooltip(roleStatusIcon);</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-              this.updateTooltip(userTypeIcon);</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+                // Set tooltip for rolenames and usertype icon</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+                this.updateTooltip(roleStatusIcon);</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+                this.updateTooltip(userTypeIcon);</span>
<a href="#l11.499"></a><span id="l11.499"> </span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-              // We always clone the first row.  The problem is that the first row</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-              // could be focused.  When we clone that row, we end up with a cloned</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-              // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-              // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-              // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-              // rather than using the real visible first row of the listbox.</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineminus">-              // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-              // is never copied when the node is cloned.</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-              if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineminus">-                  input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-              }</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+                // We always clone the first row.  The problem is that the first row</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+                // could be focused.  When we clone that row, we end up with a cloned</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+                // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+                // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+                // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+                // rather than using the real visible first row of the listbox.</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+                // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+                // is never copied when the node is cloned.</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+                if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+                    input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+                }</span>
<a href="#l11.522"></a><span id="l11.522"> </span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-              // focus on new input widget</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-              if (aSetFocus) {</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-                  this.setFocus(newNode);</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-              }</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineminus">-          }</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-          return newNode;</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+                // focus on new input widget</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+                if (aSetFocus) {</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+                    this.setFocus(newNode);</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+                }</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+            }</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+            return newNode;</span>
<a href="#l11.535"></a><span id="l11.535">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.536"></a><span id="l11.536">       &lt;/method&gt;</span>
<a href="#l11.537"></a><span id="l11.537"> </span>
<a href="#l11.538"></a><span id="l11.538">       &lt;property name=&quot;attendees&quot;&gt;</span>
<a href="#l11.539"></a><span id="l11.539">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineminus">-          let attendees = [];</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+            let attendees = [];</span>
<a href="#l11.542"></a><span id="l11.542"> </span>
<a href="#l11.543"></a><span id="l11.543" class="difflineminus">-          for (let i = 1; true; i++) {</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineminus">-              let inputField = this.getInputElement(i);</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-              if (!inputField) {</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-                  break;</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-              } else if (inputField.value == &quot;&quot;) {</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineminus">-                  continue;</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineminus">-              }</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+            for (let i = 1; true; i++) {</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+                let inputField = this.getInputElement(i);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+                if (!inputField) {</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+                    break;</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+                } else if (inputField.value == &quot;&quot;) {</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+                    continue;</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+                }</span>
<a href="#l11.557"></a><span id="l11.557"> </span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-              // the inputfield already has a reference to the attendee</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineminus">-              // object, we just need to fill in the name.</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineminus">-              let attendee = inputField.attendee.clone();</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineminus">-              if (attendee.isOrganizer) {</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineminus">-                  continue;</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineminus">-              }</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+                // the inputfield already has a reference to the attendee</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+                // object, we just need to fill in the name.</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+                let attendee = inputField.attendee.clone();</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+                if (attendee.isOrganizer) {</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+                    continue;</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+                }</span>
<a href="#l11.570"></a><span id="l11.570"> </span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-              attendee.role = this.getRoleElement(i).getAttribute(&quot;role&quot;);</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-              // attendee.participationStatus = this.getStatusElement(i).getAttribute(&quot;status&quot;);</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineminus">-              let userType = this.getUserTypeElement(i).getAttribute(&quot;cutype&quot;);</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-              attendee.userType = (userType == &quot;INDIVIDUAL&quot; ? null : userType); // INDIVIDUAL is the default</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+                attendee.role = this.getRoleElement(i).getAttribute(&quot;role&quot;);</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+                // attendee.participationStatus = this.getStatusElement(i).getAttribute(&quot;status&quot;);</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+                let userType = this.getUserTypeElement(i).getAttribute(&quot;cutype&quot;);</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+                attendee.userType = (userType == &quot;INDIVIDUAL&quot; ? null : userType); // INDIVIDUAL is the default</span>
<a href="#l11.579"></a><span id="l11.579"> </span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-              // break the list of potentially many attendees back into individual names. This</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-              // is required in case the user entered comma-separated attendees in one field and</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-              // then clicked OK without switching to the next line.</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineminus">-              let parsedInput = MailServices.headerParser.makeFromDisplayAddress(inputField.value);</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-              let j = 0;</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-              let addAttendee = function(aAddress) {</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineminus">-                  if (j &gt; 0) {</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-                      attendee = attendee.clone();</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-                  }</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-                  attendee.id = cal.prependMailTo(aAddress.email);</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-                  if (aAddress.name.length &gt; 0) {</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-                      // we remove any double quotes within CN due to bug 1209399</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineminus">-                      attendee.commonName = aAddress.name.replace(/(?:[\\]&quot;|&quot;)/, &quot;&quot;);</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineminus">-                  }</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineminus">-                  attendees.push(attendee);</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineminus">-                  j++;</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-              };</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineminus">-              parsedInput.forEach(addAttendee);</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-          }</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineplus">+                // break the list of potentially many attendees back into individual names. This</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineplus">+                // is required in case the user entered comma-separated attendees in one field and</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineplus">+                // then clicked OK without switching to the next line.</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineplus">+                let parsedInput = MailServices.headerParser.makeFromDisplayAddress(inputField.value);</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineplus">+                let j = 0;</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+                let addAttendee = function(aAddress) {</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+                    if (j &gt; 0) {</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineplus">+                        attendee = attendee.clone();</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineplus">+                    }</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineplus">+                    attendee.id = cal.prependMailTo(aAddress.email);</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineplus">+                    if (aAddress.name.length &gt; 0) {</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineplus">+                        // we remove any double quotes within CN due to bug 1209399</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineplus">+                        attendee.commonName = aAddress.name.replace(/(?:[\\]&quot;|&quot;)/, &quot;&quot;);</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+                    }</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+                    attendees.push(attendee);</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+                    j++;</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+                };</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineplus">+                parsedInput.forEach(addAttendee);</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+            }</span>
<a href="#l11.618"></a><span id="l11.618"> </span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-          return attendees;</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+            return attendees;</span>
<a href="#l11.621"></a><span id="l11.621">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.622"></a><span id="l11.622">       &lt;/property&gt;</span>
<a href="#l11.623"></a><span id="l11.623"> </span>
<a href="#l11.624"></a><span id="l11.624">       &lt;property name=&quot;organizer&quot;&gt;</span>
<a href="#l11.625"></a><span id="l11.625">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-          for (let i = 1; true; i++) {</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-              let inputField = this.getInputElement(i);</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-              if (!inputField) {</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-                  break;</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineminus">-              } else if (inputField.value == &quot;&quot;) {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineminus">-                  continue;</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineminus">-              }</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineplus">+            for (let i = 1; true; i++) {</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineplus">+                let inputField = this.getInputElement(i);</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineplus">+                if (!inputField) {</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineplus">+                    break;</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+                } else if (inputField.value == &quot;&quot;) {</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+                    continue;</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineplus">+                }</span>
<a href="#l11.640"></a><span id="l11.640"> </span>
<a href="#l11.641"></a><span id="l11.641" class="difflineminus">-              // The inputfield already has a reference to the attendee</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineminus">-              // object, we just need to fill in the name.</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineminus">-              let attendee = inputField.attendee.clone();</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineplus">+                // The inputfield already has a reference to the attendee</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineplus">+                // object, we just need to fill in the name.</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineplus">+                let attendee = inputField.attendee.clone();</span>
<a href="#l11.647"></a><span id="l11.647"> </span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-              // attendee.role = this.getRoleElement(i).getAttribute(&quot;role&quot;);</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-              attendee.participationStatus = this.getStatusElement(i).getAttribute(&quot;status&quot;);</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-              // Organizers do not have a CUTYPE</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-              attendee.userType = null;</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineplus">+                // attendee.role = this.getRoleElement(i).getAttribute(&quot;role&quot;);</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+                attendee.participationStatus = this.getStatusElement(i).getAttribute(&quot;status&quot;);</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+                // Organizers do not have a CUTYPE</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+                attendee.userType = null;</span>
<a href="#l11.656"></a><span id="l11.656"> </span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-              // break the list of potentially many attendees back into individual names</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineminus">-              let parsedInput = MailServices.headerParser.makeFromDisplayAddress(inputField.value);</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineminus">-              if (parsedInput[0].email &gt; 0) {</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineminus">-                  attendee.id = cal.prependMailTo(parsedInput[0].email);</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineminus">-              }</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-              if (parsedInput[0].name.length &gt; 0) {</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineminus">-                  attendee.commonName = parsedInput[0].name;</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineminus">-              }</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineplus">+                // break the list of potentially many attendees back into individual names</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineplus">+                let parsedInput = MailServices.headerParser.makeFromDisplayAddress(inputField.value);</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineplus">+                if (parsedInput[0].email &gt; 0) {</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+                    attendee.id = cal.prependMailTo(parsedInput[0].email);</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+                }</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+                if (parsedInput[0].name.length &gt; 0) {</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineplus">+                    attendee.commonName = parsedInput[0].name;</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineplus">+                }</span>
<a href="#l11.673"></a><span id="l11.673"> </span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-              if (attendee.isOrganizer) {</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineminus">-                  return attendee;</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineminus">-              }</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-          }</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineplus">+                if (attendee.isOrganizer) {</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+                    return attendee;</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineplus">+                }</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineplus">+            }</span>
<a href="#l11.682"></a><span id="l11.682"> </span>
<a href="#l11.683"></a><span id="l11.683" class="difflineminus">-          return null;</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineplus">+            return null;</span>
<a href="#l11.685"></a><span id="l11.685">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.686"></a><span id="l11.686">       &lt;/property&gt;</span>
<a href="#l11.687"></a><span id="l11.687"> </span>
<a href="#l11.688"></a><span id="l11.688">       &lt;method name=&quot;_resolveListByName&quot;&gt;</span>
<a href="#l11.689"></a><span id="l11.689">         &lt;parameter name=&quot;value&quot;/&gt;</span>
<a href="#l11.690"></a><span id="l11.690">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineminus">-            let entries = MailServices.headerParser.makeFromDisplayAddress(value);</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineminus">-            return entries.length ? this._findListInAddrBooks(entries[0].name) : null;</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+              let entries = MailServices.headerParser.makeFromDisplayAddress(value);</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineplus">+              return entries.length ? this._findListInAddrBooks(entries[0].name) : null;</span>
<a href="#l11.695"></a><span id="l11.695">           ]]&gt;&lt;/body&gt;</span>
<a href="#l11.696"></a><span id="l11.696">     &lt;/method&gt;</span>
<a href="#l11.697"></a><span id="l11.697"> </span>
<a href="#l11.698"></a><span id="l11.698">     &lt;method name=&quot;_findListInAddrBooks&quot;&gt;</span>
<a href="#l11.699"></a><span id="l11.699">         &lt;parameter name=&quot;entryname&quot;/&gt;</span>
<a href="#l11.700"></a><span id="l11.700">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.701"></a><span id="l11.701">             let allAddressBooks = MailServices.ab.directories;</span>
<a href="#l11.702"></a><span id="l11.702"> </span>
<a href="#l11.703"></a><span id="l11.703" class="difflineat">@@ -489,713 +489,713 @@</span>
<a href="#l11.704"></a><span id="l11.704">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.705"></a><span id="l11.705">     &lt;/method&gt;</span>
<a href="#l11.706"></a><span id="l11.706"> </span>
<a href="#l11.707"></a><span id="l11.707">     &lt;method name=&quot;_getListEntriesInt&quot;&gt;</span>
<a href="#l11.708"></a><span id="l11.708">         &lt;parameter name=&quot;mailingList&quot;/&gt;</span>
<a href="#l11.709"></a><span id="l11.709">         &lt;parameter name=&quot;attendees&quot;/&gt;</span>
<a href="#l11.710"></a><span id="l11.710">         &lt;parameter name=&quot;allListsUri&quot;/&gt;</span>
<a href="#l11.711"></a><span id="l11.711">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-            let addressLists = mailingList.addressLists;</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineminus">-            for (let i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineminus">-                let abCard = addressLists.queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineminus">-                let thisId = abCard.primaryEmail;</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-                if (abCard.displayName.length &gt; 0) {</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineminus">-                    let rCn = abCard.displayName;</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineminus">-                    if (rCn.includes(&quot;,&quot;)) {</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineminus">-                        rCn = '&quot;' + rCn + '&quot;';</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineminus">-                    }</span>
<a href="#l11.721"></a><span id="l11.721" class="difflineminus">-                    thisId = rCn + &quot; &lt;&quot; + thisId + &quot;&gt;&quot;;</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineminus">-                }</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineminus">-                if (attendees.some(att =&gt; att == thisId)) {</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-                    continue;</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-                }</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+              let addressLists = mailingList.addressLists;</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineplus">+              for (let i = 0; i &lt; addressLists.length; i++) {</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineplus">+                  let abCard = addressLists.queryElementAt(i, Components.interfaces.nsIAbCard);</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineplus">+                  let thisId = abCard.primaryEmail;</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineplus">+                  if (abCard.displayName.length &gt; 0) {</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+                      let rCn = abCard.displayName;</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+                      if (rCn.includes(&quot;,&quot;)) {</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+                          rCn = '&quot;' + rCn + '&quot;';</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineplus">+                      }</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineplus">+                      thisId = rCn + &quot; &lt;&quot; + thisId + &quot;&gt;&quot;;</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineplus">+                  }</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineplus">+                  if (attendees.some(att =&gt; att == thisId)) {</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineplus">+                      continue;</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+                  }</span>
<a href="#l11.740"></a><span id="l11.740"> </span>
<a href="#l11.741"></a><span id="l11.741" class="difflineminus">-                if (abCard.displayName.length &gt; 0) {</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineminus">-                    let list = this._findListInAddrBooks(abCard.displayName);</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineminus">-                    if (list) {</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineminus">-                        if (allListsUri.some(uri =&gt; uri == list.URI)) {</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineminus">-                            continue;</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineminus">-                        }</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineminus">-                        allListsUri.push(list.URI);</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineplus">+                  if (abCard.displayName.length &gt; 0) {</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineplus">+                      let list = this._findListInAddrBooks(abCard.displayName);</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineplus">+                      if (list) {</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+                          if (allListsUri.some(uri =&gt; uri == list.URI)) {</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+                              continue;</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+                          }</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+                          allListsUri.push(list.URI);</span>
<a href="#l11.755"></a><span id="l11.755"> </span>
<a href="#l11.756"></a><span id="l11.756" class="difflineminus">-                        this._getListEntriesInt(list, attendees, allListsUri);</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineplus">+                          this._getListEntriesInt(list, attendees, allListsUri);</span>
<a href="#l11.758"></a><span id="l11.758"> </span>
<a href="#l11.759"></a><span id="l11.759" class="difflineminus">-                        continue;</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineminus">-                    }</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineminus">-                }</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineplus">+                          continue;</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineplus">+                      }</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+                  }</span>
<a href="#l11.765"></a><span id="l11.765"> </span>
<a href="#l11.766"></a><span id="l11.766" class="difflineminus">-                attendees.push(thisId);</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineminus">-            }</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineplus">+                  attendees.push(thisId);</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineplus">+              }</span>
<a href="#l11.770"></a><span id="l11.770"> </span>
<a href="#l11.771"></a><span id="l11.771" class="difflineminus">-            return attendees;</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+              return attendees;</span>
<a href="#l11.773"></a><span id="l11.773">           ]]&gt;&lt;/body&gt;</span>
<a href="#l11.774"></a><span id="l11.774">     &lt;/method&gt;</span>
<a href="#l11.775"></a><span id="l11.775"> </span>
<a href="#l11.776"></a><span id="l11.776">     &lt;method name=&quot;_getListEntries&quot;&gt;</span>
<a href="#l11.777"></a><span id="l11.777">         &lt;parameter name=&quot;mailingList&quot;/&gt;</span>
<a href="#l11.778"></a><span id="l11.778">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.779"></a><span id="l11.779"> </span>
<a href="#l11.780"></a><span id="l11.780" class="difflineminus">-            let attendees = [];</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineminus">-            let allListsUri = [];</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineplus">+              let attendees = [];</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineplus">+              let allListsUri = [];</span>
<a href="#l11.784"></a><span id="l11.784"> </span>
<a href="#l11.785"></a><span id="l11.785" class="difflineminus">-            allListsUri.push(mailingList.URI);</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineplus">+              allListsUri.push(mailingList.URI);</span>
<a href="#l11.787"></a><span id="l11.787"> </span>
<a href="#l11.788"></a><span id="l11.788" class="difflineminus">-            this._getListEntriesInt(mailingList, attendees, allListsUri);</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineplus">+              this._getListEntriesInt(mailingList, attendees, allListsUri);</span>
<a href="#l11.790"></a><span id="l11.790"> </span>
<a href="#l11.791"></a><span id="l11.791" class="difflineminus">-            return attendees;</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineplus">+              return attendees;</span>
<a href="#l11.793"></a><span id="l11.793"> </span>
<a href="#l11.794"></a><span id="l11.794">           ]]&gt;&lt;/body&gt;</span>
<a href="#l11.795"></a><span id="l11.795">     &lt;/method&gt;</span>
<a href="#l11.796"></a><span id="l11.796"> </span>
<a href="#l11.797"></a><span id="l11.797">     &lt;method name=&quot;_fillListItemWithEntry&quot;&gt;</span>
<a href="#l11.798"></a><span id="l11.798">         &lt;parameter name=&quot;listitem&quot;/&gt;</span>
<a href="#l11.799"></a><span id="l11.799">         &lt;parameter name=&quot;entry&quot;/&gt;</span>
<a href="#l11.800"></a><span id="l11.800">         &lt;parameter name=&quot;rowNumber&quot;/&gt;</span>
<a href="#l11.801"></a><span id="l11.801">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-            let newAttendee = this.createAttendee(entry);</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-            let input = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineminus">-            input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineminus">-            input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineplus">+              let newAttendee = this.createAttendee(entry);</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineplus">+              let input = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineplus">+              input.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineplus">+              input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + rowNumber);</span>
<a href="#l11.810"></a><span id="l11.810"> </span>
<a href="#l11.811"></a><span id="l11.811" class="difflineminus">-            input.attendee = newAttendee;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineminus">-            input.value = entry;</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-            input.setAttribute(&quot;value&quot;, entry);</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-            input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-            if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineminus">-                input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineminus">-            }</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineplus">+              input.attendee = newAttendee;</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineplus">+              input.value = entry;</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+              input.setAttribute(&quot;value&quot;, entry);</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineplus">+              input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+              if (input.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineplus">+                  input.removeAttribute(&quot;focused&quot;);</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineplus">+              }</span>
<a href="#l11.825"></a><span id="l11.825"> </span>
<a href="#l11.826"></a><span id="l11.826" class="difflineminus">-            let roleStatusIcon = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineminus">-            roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineminus">-            roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineminus">-            roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineminus">-            roleStatusIcon.setAttribute(&quot;role&quot;, newAttendee.role);</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineplus">+              let roleStatusIcon = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineplus">+              roleStatusIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineplus">+              roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + rowNumber);</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+              roleStatusIcon.setAttribute(&quot;class&quot;, &quot;role-icon&quot;);</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineplus">+              roleStatusIcon.setAttribute(&quot;role&quot;, newAttendee.role);</span>
<a href="#l11.836"></a><span id="l11.836"> </span>
<a href="#l11.837"></a><span id="l11.837" class="difflineminus">-            let userTypeIcon = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.838"></a><span id="l11.838" class="difflineminus">-            userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineminus">-            userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineminus">-            userTypeIcon.setAttribute(&quot;cutype&quot;, newAttendee.userType);</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineplus">+              let userTypeIcon = document.getAnonymousElementByAttribute(listitem, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+              userTypeIcon.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.843"></a><span id="l11.843" class="difflineplus">+              userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + rowNumber);</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineplus">+              userTypeIcon.setAttribute(&quot;cutype&quot;, newAttendee.userType);</span>
<a href="#l11.845"></a><span id="l11.845">           ]]&gt;&lt;/body&gt;</span>
<a href="#l11.846"></a><span id="l11.846">     &lt;/method&gt;</span>
<a href="#l11.847"></a><span id="l11.847"> </span>
<a href="#l11.848"></a><span id="l11.848">     &lt;method name=&quot;resolvePotentialList&quot;&gt;</span>
<a href="#l11.849"></a><span id="l11.849">       &lt;parameter name=&quot;aInput&quot;/&gt;</span>
<a href="#l11.850"></a><span id="l11.850">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineminus">-          let fieldValue = aInput.value;</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineminus">-          if (aInput.id.length &gt; 0 &amp;&amp; fieldValue.length &gt; 0) {</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineminus">-              let mailingList = this._resolveListByName(fieldValue);</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineminus">-              if (mailingList) {</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineminus">-                  let entries = this._getListEntries(mailingList);</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineminus">-                  if (entries.length &gt; 0) {</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineminus">-                      let currentIndex = parseInt(aInput.id.substr(13), 10);</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineminus">-                      let template = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineminus">-                      let currentNode = template.parentNode.childNodes[currentIndex];</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineminus">-                      this._fillListItemWithEntry(currentNode, entries[0], currentIndex);</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineminus">-                      entries.shift();</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-                      let nextNode = template.parentNode.childNodes[currentIndex + 1];</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-                      currentIndex++;</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineminus">-                      for (let entry of entries) {</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineminus">-                          currentNode = template.cloneNode(true);</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineminus">-                          template.parentNode.insertBefore(currentNode, nextNode);</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineminus">-                          this._fillListItemWithEntry(currentNode, entry, currentIndex);</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineminus">-                          currentIndex++;</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineminus">-                      }</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineminus">-                      this.mMaxAttendees += entries.length;</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineminus">-                      for (let i = currentIndex; i &lt;= this.mMaxAttendees; i++) {</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineminus">-                          let row = template.parentNode.childNodes[i];</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineminus">-                          let roleStatusIcon = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineminus">-                          roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + i);</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+            let fieldValue = aInput.value;</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineplus">+            if (aInput.id.length &gt; 0 &amp;&amp; fieldValue.length &gt; 0) {</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineplus">+                let mailingList = this._resolveListByName(fieldValue);</span>
<a href="#l11.878"></a><span id="l11.878" class="difflineplus">+                if (mailingList) {</span>
<a href="#l11.879"></a><span id="l11.879" class="difflineplus">+                    let entries = this._getListEntries(mailingList);</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineplus">+                    if (entries.length &gt; 0) {</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineplus">+                        let currentIndex = parseInt(aInput.id.substr(13), 10);</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+                        let template = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineplus">+                        let currentNode = template.parentNode.childNodes[currentIndex];</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+                        this._fillListItemWithEntry(currentNode, entries[0], currentIndex);</span>
<a href="#l11.885"></a><span id="l11.885" class="difflineplus">+                        entries.shift();</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineplus">+                        let nextNode = template.parentNode.childNodes[currentIndex + 1];</span>
<a href="#l11.887"></a><span id="l11.887" class="difflineplus">+                        currentIndex++;</span>
<a href="#l11.888"></a><span id="l11.888" class="difflineplus">+                        for (let entry of entries) {</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineplus">+                            currentNode = template.cloneNode(true);</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+                            template.parentNode.insertBefore(currentNode, nextNode);</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineplus">+                            this._fillListItemWithEntry(currentNode, entry, currentIndex);</span>
<a href="#l11.892"></a><span id="l11.892" class="difflineplus">+                            currentIndex++;</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineplus">+                        }</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineplus">+                        this.mMaxAttendees += entries.length;</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+                        for (let i = currentIndex; i &lt;= this.mMaxAttendees; i++) {</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineplus">+                            let row = template.parentNode.childNodes[i];</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineplus">+                            let roleStatusIcon = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;rolestatus-icon&quot;);</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineplus">+                            roleStatusIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol1#&quot; + i);</span>
<a href="#l11.899"></a><span id="l11.899"> </span>
<a href="#l11.900"></a><span id="l11.900" class="difflineminus">-                          let userTypeIcon = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">-                          userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + i);</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineplus">+                            let userTypeIcon = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;usertype-icon&quot;);</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineplus">+                            userTypeIcon.setAttribute(&quot;id&quot;, &quot;attendeeCol2#&quot; + i);</span>
<a href="#l11.904"></a><span id="l11.904"> </span>
<a href="#l11.905"></a><span id="l11.905" class="difflineminus">-                          let input = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineminus">-                          input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + i);</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineminus">-                          input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineminus">-                      }</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineminus">-                  }</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineminus">-              }</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineminus">-          }</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+                            let input = document.getAnonymousElementByAttribute(row, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineplus">+                            input.setAttribute(&quot;id&quot;, &quot;attendeeCol3#&quot; + i);</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineplus">+                            input.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineplus">+                        }</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineplus">+                    }</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineplus">+                }</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineplus">+            }</span>
<a href="#l11.919"></a><span id="l11.919">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.920"></a><span id="l11.920">       &lt;/method&gt;</span>
<a href="#l11.921"></a><span id="l11.921"> </span>
<a href="#l11.922"></a><span id="l11.922">       &lt;method name=&quot;onModify&quot;&gt;</span>
<a href="#l11.923"></a><span id="l11.923">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineminus">-          let list = [];</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxAttendees; i++) {</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineminus">-              // retrieve the string from the appropriate row</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineminus">-              let input = this.getInputElement(i);</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineminus">-              if (input &amp;&amp; input.value) {</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineminus">-                  // parse the string to break this down to individual names and addresses</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineminus">-                  let parsedInput = MailServices.headerParser.makeFromDisplayAddress(input.value);</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineminus">-                  let email = cal.prependMailTo(parsedInput[0].email);</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+            let list = [];</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxAttendees; i++) {</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+                // retrieve the string from the appropriate row</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineplus">+                let input = this.getInputElement(i);</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineplus">+                if (input &amp;&amp; input.value) {</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+                    // parse the string to break this down to individual names and addresses</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineplus">+                    let parsedInput = MailServices.headerParser.makeFromDisplayAddress(input.value);</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineplus">+                    let email = cal.prependMailTo(parsedInput[0].email);</span>
<a href="#l11.940"></a><span id="l11.940"> </span>
<a href="#l11.941"></a><span id="l11.941" class="difflineminus">-                  let isdirty = false;</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineminus">-                  if (input.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineminus">-                      isdirty = input.getAttribute(&quot;dirty&quot;);</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineminus">-                  }</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineminus">-                  input.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineminus">-                  let entry = {</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineminus">-                      dirty: isdirty,</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineminus">-                      calid: email</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineminus">-                  };</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineminus">-                  list.push(entry);</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineminus">-              }</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineminus">-          }</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineplus">+                    let isdirty = false;</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+                    if (input.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineplus">+                        isdirty = input.getAttribute(&quot;dirty&quot;);</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineplus">+                    }</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineplus">+                    input.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+                    let entry = {</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineplus">+                        dirty: isdirty,</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineplus">+                        calid: email</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+                    };</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineplus">+                    list.push(entry);</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+                }</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineplus">+            }</span>
<a href="#l11.965"></a><span id="l11.965"> </span>
<a href="#l11.966"></a><span id="l11.966" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineminus">-          event.initEvent(&quot;modify&quot;, true, false);</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineminus">-          event.details = list;</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineplus">+            event.initEvent(&quot;modify&quot;, true, false);</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+            event.details = list;</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l11.974"></a><span id="l11.974">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.975"></a><span id="l11.975">       &lt;/method&gt;</span>
<a href="#l11.976"></a><span id="l11.976"> </span>
<a href="#l11.977"></a><span id="l11.977">      &lt;method name=&quot;updateTooltip&quot;&gt;</span>
<a href="#l11.978"></a><span id="l11.978">       &lt;parameter name=&quot;targetIcon&quot;/&gt;</span>
<a href="#l11.979"></a><span id="l11.979">       &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineminus">-        // Function setting the tooltip of attendeeicons based on their role</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineminus">-        if (targetIcon.className == &quot;role-icon&quot;) {</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineminus">-            let role = targetIcon.getAttribute(&quot;role&quot;);</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineminus">-            // Set tooltip for rolenames</span>
<a href="#l11.984"></a><span id="l11.984" class="difflineplus">+          // Function setting the tooltip of attendeeicons based on their role</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineplus">+          if (targetIcon.className == &quot;role-icon&quot;) {</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+              let role = targetIcon.getAttribute(&quot;role&quot;);</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+              // Set tooltip for rolenames</span>
<a href="#l11.988"></a><span id="l11.988"> </span>
<a href="#l11.989"></a><span id="l11.989" class="difflineminus">-            const roleMap = {</span>
<a href="#l11.990"></a><span id="l11.990" class="difflineminus">-                &quot;REQ-PARTICIPANT&quot;: &quot;required&quot;,</span>
<a href="#l11.991"></a><span id="l11.991" class="difflineminus">-                &quot;OPT-PARTICIPANT&quot;: &quot;optional&quot;,</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineminus">-                &quot;NON-PARTICIPANT&quot;: &quot;nonparticipant&quot;,</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineminus">-                &quot;CHAIR&quot;: &quot;chair&quot;</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineminus">-            };</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+              const roleMap = {</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+                  &quot;REQ-PARTICIPANT&quot;: &quot;required&quot;,</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+                  &quot;OPT-PARTICIPANT&quot;: &quot;optional&quot;,</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+                  &quot;NON-PARTICIPANT&quot;: &quot;nonparticipant&quot;,</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+                  &quot;CHAIR&quot;: &quot;chair&quot;</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+              };</span>
<a href="#l11.1001"></a><span id="l11.1001"> </span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineminus">-            let roleNameString = &quot;event.attendee.role.&quot; + (role in roleMap ? roleMap[role] : &quot;unknown&quot;);</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineminus">-            let tooltip = cal.calGetString(&quot;calendar-event-dialog-attendees&quot;,</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineminus">-                                           roleNameString,</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineminus">-                                           role in roleMap ? null : [role]);</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineminus">-            targetIcon.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineminus">-        } else if (targetIcon.className == &quot;usertype-icon&quot;) {</span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineminus">-            let cutype = targetIcon.getAttribute(&quot;cutype&quot;);</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineminus">-            const cutypeMap = {</span>
<a href="#l11.1010"></a><span id="l11.1010" class="difflineminus">-                INDIVIDUAL: &quot;individual&quot;,</span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineminus">-                GROUP: &quot;group&quot;,</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineminus">-                RESOURCE: &quot;resource&quot;,</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineminus">-                ROOM: &quot;room&quot;,</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineminus">-                // I've decided UNKNOWN will not be handled.</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineminus">-            };</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+              let roleNameString = &quot;event.attendee.role.&quot; + (role in roleMap ? roleMap[role] : &quot;unknown&quot;);</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+              let tooltip = cal.calGetString(&quot;calendar-event-dialog-attendees&quot;,</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+                                             roleNameString,</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineplus">+                                             role in roleMap ? null : [role]);</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+              targetIcon.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+          } else if (targetIcon.className == &quot;usertype-icon&quot;) {</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineplus">+              let cutype = targetIcon.getAttribute(&quot;cutype&quot;);</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+              const cutypeMap = {</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+                  INDIVIDUAL: &quot;individual&quot;,</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineplus">+                  GROUP: &quot;group&quot;,</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineplus">+                  RESOURCE: &quot;resource&quot;,</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineplus">+                  ROOM: &quot;room&quot;,</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineplus">+                  // I've decided UNKNOWN will not be handled.</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+              };</span>
<a href="#l11.1030"></a><span id="l11.1030"> </span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineminus">-            let cutypeString = &quot;event.attendee.usertype.&quot; + (cutype in cutypeMap ? cutypeMap[cutype] : &quot;unknown&quot;);</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineminus">-            let tooltip = cal.calGetString(&quot;calendar-event-dialog-attendees&quot;,</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineminus">-                                           cutypeString,</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineminus">-                                           cutype in cutypeMap ? null : [cutype]);</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineminus">-            targetIcon.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineminus">-        }</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+              let cutypeString = &quot;event.attendee.usertype.&quot; + (cutype in cutypeMap ? cutypeMap[cutype] : &quot;unknown&quot;);</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+              let tooltip = cal.calGetString(&quot;calendar-event-dialog-attendees&quot;,</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineplus">+                                             cutypeString,</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+                                             cutype in cutypeMap ? null : [cutype]);</span>
<a href="#l11.1041"></a><span id="l11.1041" class="difflineplus">+              targetIcon.setAttribute(&quot;tooltiptext&quot;, tooltip);</span>
<a href="#l11.1042"></a><span id="l11.1042" class="difflineplus">+          }</span>
<a href="#l11.1043"></a><span id="l11.1043">       ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1044"></a><span id="l11.1044">       &lt;/method&gt;</span>
<a href="#l11.1045"></a><span id="l11.1045"> </span>
<a href="#l11.1046"></a><span id="l11.1046">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l11.1047"></a><span id="l11.1047">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.1048"></a><span id="l11.1048">             return this.mRowHeight * this.mMaxAttendees;</span>
<a href="#l11.1049"></a><span id="l11.1049">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.1050"></a><span id="l11.1050">       &lt;/property&gt;</span>
<a href="#l11.1051"></a><span id="l11.1051"> </span>
<a href="#l11.1052"></a><span id="l11.1052">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l11.1053"></a><span id="l11.1053">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineminus">-          setTimeout(() =&gt; {</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineminus">-              this.calcContentHeight();</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineminus">-              this.createOrRemoveDummyRows();</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineminus">-          }, 0);</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineplus">+            setTimeout(() =&gt; {</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+                this.calcContentHeight();</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+                this.createOrRemoveDummyRows();</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+            }, 0);</span>
<a href="#l11.1062"></a><span id="l11.1062">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1063"></a><span id="l11.1063">       &lt;/method&gt;</span>
<a href="#l11.1064"></a><span id="l11.1064"> </span>
<a href="#l11.1065"></a><span id="l11.1065">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l11.1066"></a><span id="l11.1066">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineminus">-          let listbox =</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineminus">-          let items = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1071"></a><span id="l11.1071" class="difflineminus">-          this.mContentHeight = 0;</span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineminus">-          if (items.length &gt; 0) {</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineminus">-              let i = 0;</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineminus">-              do {</span>
<a href="#l11.1075"></a><span id="l11.1075" class="difflineminus">-                  this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-                  ++i;</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-              } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineminus">-              this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineminus">-          }</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineplus">+            let listbox =</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+            let items = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+            this.mContentHeight = 0;</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+            if (items.length &gt; 0) {</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineplus">+                let i = 0;</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineplus">+                do {</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineplus">+                    this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineplus">+                    ++i;</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineplus">+                } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineplus">+                this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineplus">+            }</span>
<a href="#l11.1093"></a><span id="l11.1093">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1094"></a><span id="l11.1094">       &lt;/method&gt;</span>
<a href="#l11.1095"></a><span id="l11.1095"> </span>
<a href="#l11.1096"></a><span id="l11.1096">       &lt;method name=&quot;createOrRemoveDummyRows&quot;&gt;</span>
<a href="#l11.1097"></a><span id="l11.1097">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineminus">-          let listbox =</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineminus">-          let listboxHeight = listbox.boxObject.height;</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineplus">+            let listbox =</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineplus">+            let listboxHeight = listbox.boxObject.height;</span>
<a href="#l11.1106"></a><span id="l11.1106"> </span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineminus">-          // remove rows to remove scrollbar</span>
<a href="#l11.1108"></a><span id="l11.1108" class="difflineminus">-          let kids = listbox.childNodes;</span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineminus">-          for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineminus">-              if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineminus">-                  this.mContentHeight -= this.mRowHeight;</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineminus">-                  kids[i].remove();</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineminus">-              }</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineminus">-          }</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineplus">+            // remove rows to remove scrollbar</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+            let kids = listbox.childNodes;</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+            for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineplus">+                if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+                    this.mContentHeight -= this.mRowHeight;</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+                    kids[i].remove();</span>
<a href="#l11.1121"></a><span id="l11.1121" class="difflineplus">+                }</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineplus">+            }</span>
<a href="#l11.1123"></a><span id="l11.1123"> </span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineminus">-          // add rows to fill space</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineminus">-          if (this.mRowHeight) {</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineminus">-              while (this.mContentHeight + this.mRowHeight &lt; listboxHeight) {</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineminus">-                  this.createDummyItem(listbox);</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineminus">-                  this.mContentHeight += this.mRowHeight;</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineminus">-              }</span>
<a href="#l11.1130"></a><span id="l11.1130" class="difflineminus">-          }</span>
<a href="#l11.1131"></a><span id="l11.1131" class="difflineplus">+            // add rows to fill space</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineplus">+            if (this.mRowHeight) {</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineplus">+                while (this.mContentHeight + this.mRowHeight &lt; listboxHeight) {</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineplus">+                    this.createDummyItem(listbox);</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineplus">+                    this.mContentHeight += this.mRowHeight;</span>
<a href="#l11.1136"></a><span id="l11.1136" class="difflineplus">+                }</span>
<a href="#l11.1137"></a><span id="l11.1137" class="difflineplus">+            }</span>
<a href="#l11.1138"></a><span id="l11.1138">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1139"></a><span id="l11.1139">       &lt;/method&gt;</span>
<a href="#l11.1140"></a><span id="l11.1140"> </span>
<a href="#l11.1141"></a><span id="l11.1141">       &lt;method name=&quot;createDummyCell&quot;&gt;</span>
<a href="#l11.1142"></a><span id="l11.1142">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l11.1143"></a><span id="l11.1143">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineminus">-          let cell = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listcell&quot;);</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineminus">-          cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineminus">-          if (aParent) {</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineminus">-              aParent.appendChild(cell);</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineminus">-          }</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineminus">-          return cell;</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineplus">+            let cell = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listcell&quot;);</span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineplus">+            cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineplus">+            if (aParent) {</span>
<a href="#l11.1153"></a><span id="l11.1153" class="difflineplus">+                aParent.appendChild(cell);</span>
<a href="#l11.1154"></a><span id="l11.1154" class="difflineplus">+            }</span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineplus">+            return cell;</span>
<a href="#l11.1156"></a><span id="l11.1156">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1157"></a><span id="l11.1157">       &lt;/method&gt;</span>
<a href="#l11.1158"></a><span id="l11.1158"> </span>
<a href="#l11.1159"></a><span id="l11.1159">       &lt;method name=&quot;createDummyItem&quot;&gt;</span>
<a href="#l11.1160"></a><span id="l11.1160">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l11.1161"></a><span id="l11.1161">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1162"></a><span id="l11.1162" class="difflineminus">-          let titem = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1163"></a><span id="l11.1163" class="difflineminus">-          titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l11.1164"></a><span id="l11.1164" class="difflineminus">-          titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineminus">-          for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineminus">-              this.createDummyCell(titem);</span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineminus">-          }</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineminus">-          if (aParent) {</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineminus">-              aParent.appendChild(titem);</span>
<a href="#l11.1170"></a><span id="l11.1170" class="difflineminus">-          }</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineminus">-          return titem;</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineplus">+            let titem = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1173"></a><span id="l11.1173" class="difflineplus">+            titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineplus">+            titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineplus">+            for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l11.1176"></a><span id="l11.1176" class="difflineplus">+                this.createDummyCell(titem);</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineplus">+            }</span>
<a href="#l11.1178"></a><span id="l11.1178" class="difflineplus">+            if (aParent) {</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineplus">+                aParent.appendChild(titem);</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineplus">+            }</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineplus">+            return titem;</span>
<a href="#l11.1182"></a><span id="l11.1182">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1183"></a><span id="l11.1183">       &lt;/method&gt;</span>
<a href="#l11.1184"></a><span id="l11.1184"> </span>
<a href="#l11.1185"></a><span id="l11.1185">       &lt;!-- gets the next row from the top down --&gt;</span>
<a href="#l11.1186"></a><span id="l11.1186">       &lt;method name=&quot;getNextDummyRow&quot;&gt;</span>
<a href="#l11.1187"></a><span id="l11.1187">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineminus">-          let listbox =</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineminus">-          let kids = listbox.childNodes;</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineminus">-          for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l11.1193"></a><span id="l11.1193" class="difflineminus">-              if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l11.1194"></a><span id="l11.1194" class="difflineminus">-                  return kids[i];</span>
<a href="#l11.1195"></a><span id="l11.1195" class="difflineminus">-              }</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineminus">-          }</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineminus">-          return null;</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineplus">+            let listbox =</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineplus">+            let kids = listbox.childNodes;</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+            for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l11.1203"></a><span id="l11.1203" class="difflineplus">+                if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l11.1204"></a><span id="l11.1204" class="difflineplus">+                    return kids[i];</span>
<a href="#l11.1205"></a><span id="l11.1205" class="difflineplus">+                }</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineplus">+            }</span>
<a href="#l11.1207"></a><span id="l11.1207" class="difflineplus">+            return null;</span>
<a href="#l11.1208"></a><span id="l11.1208">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1209"></a><span id="l11.1209">       &lt;/method&gt;</span>
<a href="#l11.1210"></a><span id="l11.1210"> </span>
<a href="#l11.1211"></a><span id="l11.1211">       &lt;!-- This method returns the &lt;xul:listitem&gt; at row numer 'aRow' --&gt;</span>
<a href="#l11.1212"></a><span id="l11.1212">       &lt;method name=&quot;getListItem&quot;&gt;</span>
<a href="#l11.1213"></a><span id="l11.1213">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1214"></a><span id="l11.1214">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineminus">-          let listbox =</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineminus">-          if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l11.1219"></a><span id="l11.1219" class="difflineminus">-              let listitems = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineminus">-              if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineminus">-                  return listitems[aRow - 1];</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineminus">-              }</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineminus">-          }</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineminus">-          return 0;</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+            let listbox =</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+            if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineplus">+                let listitems = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l11.1230"></a><span id="l11.1230" class="difflineplus">+                if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineplus">+                    return listitems[aRow - 1];</span>
<a href="#l11.1232"></a><span id="l11.1232" class="difflineplus">+                }</span>
<a href="#l11.1233"></a><span id="l11.1233" class="difflineplus">+            }</span>
<a href="#l11.1234"></a><span id="l11.1234" class="difflineplus">+            return 0;</span>
<a href="#l11.1235"></a><span id="l11.1235">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1236"></a><span id="l11.1236">       &lt;/method&gt;</span>
<a href="#l11.1237"></a><span id="l11.1237"> </span>
<a href="#l11.1238"></a><span id="l11.1238">       &lt;method name=&quot;getInputFromListitem&quot;&gt;</span>
<a href="#l11.1239"></a><span id="l11.1239">         &lt;parameter name=&quot;aListItem&quot;/&gt;</span>
<a href="#l11.1240"></a><span id="l11.1240">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineminus">-          return aListItem.getElementsByTagNameNS(&quot;*&quot;, &quot;textbox&quot;)[0];</span>
<a href="#l11.1242"></a><span id="l11.1242" class="difflineplus">+            return aListItem.getElementsByTagNameNS(&quot;*&quot;, &quot;textbox&quot;)[0];</span>
<a href="#l11.1243"></a><span id="l11.1243">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1244"></a><span id="l11.1244">       &lt;/method&gt;</span>
<a href="#l11.1245"></a><span id="l11.1245"> </span>
<a href="#l11.1246"></a><span id="l11.1246">       &lt;method name=&quot;getRowByInputElement&quot;&gt;</span>
<a href="#l11.1247"></a><span id="l11.1247">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l11.1248"></a><span id="l11.1248">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1249"></a><span id="l11.1249" class="difflineminus">-          let row = 0;</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineminus">-          while (aElement &amp;&amp; aElement.localName != &quot;listitem&quot;) {</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineminus">-              aElement = aElement.parentNode;</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineminus">-          }</span>
<a href="#l11.1253"></a><span id="l11.1253" class="difflineminus">-          if (aElement) {</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineminus">-              while (aElement) {</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineminus">-                  if (aElement.localName == &quot;listitem&quot;) {</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineminus">-                      ++row;</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineminus">-                  }</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineminus">-                  aElement = aElement.previousSibling;</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineminus">-              }</span>
<a href="#l11.1260"></a><span id="l11.1260" class="difflineminus">-          }</span>
<a href="#l11.1261"></a><span id="l11.1261" class="difflineminus">-          return row;</span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineplus">+            let row = 0;</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineplus">+            while (aElement &amp;&amp; aElement.localName != &quot;listitem&quot;) {</span>
<a href="#l11.1264"></a><span id="l11.1264" class="difflineplus">+                aElement = aElement.parentNode;</span>
<a href="#l11.1265"></a><span id="l11.1265" class="difflineplus">+            }</span>
<a href="#l11.1266"></a><span id="l11.1266" class="difflineplus">+            if (aElement) {</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineplus">+                while (aElement) {</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineplus">+                    if (aElement.localName == &quot;listitem&quot;) {</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineplus">+                        ++row;</span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineplus">+                    }</span>
<a href="#l11.1271"></a><span id="l11.1271" class="difflineplus">+                    aElement = aElement.previousSibling;</span>
<a href="#l11.1272"></a><span id="l11.1272" class="difflineplus">+                }</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineplus">+            }</span>
<a href="#l11.1274"></a><span id="l11.1274" class="difflineplus">+            return row;</span>
<a href="#l11.1275"></a><span id="l11.1275">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1276"></a><span id="l11.1276">       &lt;/method&gt;</span>
<a href="#l11.1277"></a><span id="l11.1277"> </span>
<a href="#l11.1278"></a><span id="l11.1278">       &lt;!-- This method returns the &lt;xul:textbox&gt; that contains</span>
<a href="#l11.1279"></a><span id="l11.1279">            the name of the attendee at row number 'aRow' --&gt;</span>
<a href="#l11.1280"></a><span id="l11.1280">       &lt;method name=&quot;getInputElement&quot;&gt;</span>
<a href="#l11.1281"></a><span id="l11.1281">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1282"></a><span id="l11.1282">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1283"></a><span id="l11.1283" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol3#&quot; + aRow);</span>
<a href="#l11.1284"></a><span id="l11.1284" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol3#&quot; + aRow);</span>
<a href="#l11.1285"></a><span id="l11.1285">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1286"></a><span id="l11.1286">       &lt;/method&gt;</span>
<a href="#l11.1287"></a><span id="l11.1287"> </span>
<a href="#l11.1288"></a><span id="l11.1288">       &lt;method name=&quot;getRoleElement&quot;&gt;</span>
<a href="#l11.1289"></a><span id="l11.1289">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1290"></a><span id="l11.1290">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1291"></a><span id="l11.1291" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol1#&quot; + aRow);</span>
<a href="#l11.1292"></a><span id="l11.1292" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol1#&quot; + aRow);</span>
<a href="#l11.1293"></a><span id="l11.1293">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1294"></a><span id="l11.1294">       &lt;/method&gt;</span>
<a href="#l11.1295"></a><span id="l11.1295"> </span>
<a href="#l11.1296"></a><span id="l11.1296">       &lt;method name=&quot;getStatusElement&quot;&gt;</span>
<a href="#l11.1297"></a><span id="l11.1297">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1298"></a><span id="l11.1298">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol1#&quot; + aRow);</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol1#&quot; + aRow);</span>
<a href="#l11.1301"></a><span id="l11.1301">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1302"></a><span id="l11.1302">       &lt;/method&gt;</span>
<a href="#l11.1303"></a><span id="l11.1303"> </span>
<a href="#l11.1304"></a><span id="l11.1304">       &lt;method name=&quot;getUserTypeElement&quot;&gt;</span>
<a href="#l11.1305"></a><span id="l11.1305">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1306"></a><span id="l11.1306">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol2#&quot; + aRow);</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;id&quot;, &quot;attendeeCol2#&quot; + aRow);</span>
<a href="#l11.1309"></a><span id="l11.1309">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1310"></a><span id="l11.1310">       &lt;/method&gt;</span>
<a href="#l11.1311"></a><span id="l11.1311"> </span>
<a href="#l11.1312"></a><span id="l11.1312">       &lt;method name=&quot;setFocus&quot;&gt;</span>
<a href="#l11.1313"></a><span id="l11.1313">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1314"></a><span id="l11.1314">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineminus">-          let self = this;</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineminus">-          let set_focus = function() {</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineminus">-              let node;</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineminus">-              if (typeof aRow == &quot;number&quot;) {</span>
<a href="#l11.1319"></a><span id="l11.1319" class="difflineminus">-                  node = self.getListItem(aRow);</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineminus">-              } else {</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineminus">-                  node = aRow;</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineminus">-              }</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+            let self = this;</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+            let set_focus = function() {</span>
<a href="#l11.1325"></a><span id="l11.1325" class="difflineplus">+                let node;</span>
<a href="#l11.1326"></a><span id="l11.1326" class="difflineplus">+                if (typeof aRow == &quot;number&quot;) {</span>
<a href="#l11.1327"></a><span id="l11.1327" class="difflineplus">+                    node = self.getListItem(aRow);</span>
<a href="#l11.1328"></a><span id="l11.1328" class="difflineplus">+                } else {</span>
<a href="#l11.1329"></a><span id="l11.1329" class="difflineplus">+                    node = aRow;</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineplus">+                }</span>
<a href="#l11.1331"></a><span id="l11.1331"> </span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineminus">-              // do we need to scroll in order to see the selected row?</span>
<a href="#l11.1333"></a><span id="l11.1333" class="difflineminus">-              let listbox =</span>
<a href="#l11.1334"></a><span id="l11.1334" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineminus">-                      self, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1336"></a><span id="l11.1336" class="difflineminus">-              let firstVisibleRow = listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l11.1337"></a><span id="l11.1337" class="difflineminus">-              let numOfVisibleRows = listbox.getNumberOfVisibleRows();</span>
<a href="#l11.1338"></a><span id="l11.1338" class="difflineminus">-              if (aRow &lt;= firstVisibleRow) {</span>
<a href="#l11.1339"></a><span id="l11.1339" class="difflineminus">-                  listbox.scrollToIndex(aRow - 1);</span>
<a href="#l11.1340"></a><span id="l11.1340" class="difflineminus">-              } else if (aRow - 1 &gt;= (firstVisibleRow + numOfVisibleRows)) {</span>
<a href="#l11.1341"></a><span id="l11.1341" class="difflineminus">-                  listbox.scrollToIndex(aRow - numOfVisibleRows);</span>
<a href="#l11.1342"></a><span id="l11.1342" class="difflineminus">-              }</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineminus">-              let input =</span>
<a href="#l11.1344"></a><span id="l11.1344" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.1345"></a><span id="l11.1345" class="difflineminus">-                      node, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.1346"></a><span id="l11.1346" class="difflineminus">-              input.focus();</span>
<a href="#l11.1347"></a><span id="l11.1347" class="difflineminus">-          };</span>
<a href="#l11.1348"></a><span id="l11.1348" class="difflineminus">-          setTimeout(set_focus, 0);</span>
<a href="#l11.1349"></a><span id="l11.1349" class="difflineplus">+                // do we need to scroll in order to see the selected row?</span>
<a href="#l11.1350"></a><span id="l11.1350" class="difflineplus">+                let listbox =</span>
<a href="#l11.1351"></a><span id="l11.1351" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineplus">+                        self, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineplus">+                let firstVisibleRow = listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+                let numOfVisibleRows = listbox.getNumberOfVisibleRows();</span>
<a href="#l11.1355"></a><span id="l11.1355" class="difflineplus">+                if (aRow &lt;= firstVisibleRow) {</span>
<a href="#l11.1356"></a><span id="l11.1356" class="difflineplus">+                    listbox.scrollToIndex(aRow - 1);</span>
<a href="#l11.1357"></a><span id="l11.1357" class="difflineplus">+                } else if (aRow - 1 &gt;= (firstVisibleRow + numOfVisibleRows)) {</span>
<a href="#l11.1358"></a><span id="l11.1358" class="difflineplus">+                    listbox.scrollToIndex(aRow - numOfVisibleRows);</span>
<a href="#l11.1359"></a><span id="l11.1359" class="difflineplus">+                }</span>
<a href="#l11.1360"></a><span id="l11.1360" class="difflineplus">+                let input =</span>
<a href="#l11.1361"></a><span id="l11.1361" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.1362"></a><span id="l11.1362" class="difflineplus">+                        node, &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.1363"></a><span id="l11.1363" class="difflineplus">+                input.focus();</span>
<a href="#l11.1364"></a><span id="l11.1364" class="difflineplus">+            };</span>
<a href="#l11.1365"></a><span id="l11.1365" class="difflineplus">+            setTimeout(set_focus, 0);</span>
<a href="#l11.1366"></a><span id="l11.1366">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1367"></a><span id="l11.1367">       &lt;/method&gt;</span>
<a href="#l11.1368"></a><span id="l11.1368"> </span>
<a href="#l11.1369"></a><span id="l11.1369">       &lt;property name=&quot;firstVisibleRow&quot;&gt;</span>
<a href="#l11.1370"></a><span id="l11.1370">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineminus">-          let listbox =</span>
<a href="#l11.1372"></a><span id="l11.1372" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1373"></a><span id="l11.1373" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1374"></a><span id="l11.1374" class="difflineminus">-          return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l11.1375"></a><span id="l11.1375" class="difflineplus">+            let listbox =</span>
<a href="#l11.1376"></a><span id="l11.1376" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1377"></a><span id="l11.1377" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1378"></a><span id="l11.1378" class="difflineplus">+            return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l11.1379"></a><span id="l11.1379">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.1380"></a><span id="l11.1380">       &lt;/property&gt;</span>
<a href="#l11.1381"></a><span id="l11.1381"> </span>
<a href="#l11.1382"></a><span id="l11.1382">       &lt;method name=&quot;createAttendee&quot;&gt;</span>
<a href="#l11.1383"></a><span id="l11.1383">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1384"></a><span id="l11.1384" class="difflineminus">-          let attendee = cal.createAttendee();</span>
<a href="#l11.1385"></a><span id="l11.1385" class="difflineminus">-          attendee.id = &quot;&quot;;</span>
<a href="#l11.1386"></a><span id="l11.1386" class="difflineminus">-          attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l11.1387"></a><span id="l11.1387" class="difflineminus">-          attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l11.1388"></a><span id="l11.1388" class="difflineminus">-          attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l11.1389"></a><span id="l11.1389" class="difflineminus">-          return attendee;</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineplus">+            let attendee = cal.createAttendee();</span>
<a href="#l11.1391"></a><span id="l11.1391" class="difflineplus">+            attendee.id = &quot;&quot;;</span>
<a href="#l11.1392"></a><span id="l11.1392" class="difflineplus">+            attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l11.1393"></a><span id="l11.1393" class="difflineplus">+            attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l11.1394"></a><span id="l11.1394" class="difflineplus">+            attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l11.1395"></a><span id="l11.1395" class="difflineplus">+            return attendee;</span>
<a href="#l11.1396"></a><span id="l11.1396">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1397"></a><span id="l11.1397">       &lt;/method&gt;</span>
<a href="#l11.1398"></a><span id="l11.1398"> </span>
<a href="#l11.1399"></a><span id="l11.1399">       &lt;property name=&quot;numColumns&quot;&gt;</span>
<a href="#l11.1400"></a><span id="l11.1400">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineminus">-          if (!this.mNumColumns) {</span>
<a href="#l11.1402"></a><span id="l11.1402" class="difflineminus">-              let listbox =</span>
<a href="#l11.1403"></a><span id="l11.1403" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.1404"></a><span id="l11.1404" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1405"></a><span id="l11.1405" class="difflineminus">-              let listCols = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listcol&quot;);</span>
<a href="#l11.1406"></a><span id="l11.1406" class="difflineminus">-              this.mNumColumns = listCols.length;</span>
<a href="#l11.1407"></a><span id="l11.1407" class="difflineminus">-              if (!this.mNumColumns) {</span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineminus">-                  this.mNumColumns = 1;</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineminus">-              }</span>
<a href="#l11.1410"></a><span id="l11.1410" class="difflineminus">-          }</span>
<a href="#l11.1411"></a><span id="l11.1411" class="difflineminus">-          return this.mNumColumns;</span>
<a href="#l11.1412"></a><span id="l11.1412" class="difflineplus">+            if (!this.mNumColumns) {</span>
<a href="#l11.1413"></a><span id="l11.1413" class="difflineplus">+                let listbox =</span>
<a href="#l11.1414"></a><span id="l11.1414" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.1415"></a><span id="l11.1415" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1416"></a><span id="l11.1416" class="difflineplus">+                let listCols = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listcol&quot;);</span>
<a href="#l11.1417"></a><span id="l11.1417" class="difflineplus">+                this.mNumColumns = listCols.length;</span>
<a href="#l11.1418"></a><span id="l11.1418" class="difflineplus">+                if (!this.mNumColumns) {</span>
<a href="#l11.1419"></a><span id="l11.1419" class="difflineplus">+                    this.mNumColumns = 1;</span>
<a href="#l11.1420"></a><span id="l11.1420" class="difflineplus">+                }</span>
<a href="#l11.1421"></a><span id="l11.1421" class="difflineplus">+            }</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineplus">+            return this.mNumColumns;</span>
<a href="#l11.1423"></a><span id="l11.1423">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.1424"></a><span id="l11.1424">       &lt;/property&gt;</span>
<a href="#l11.1425"></a><span id="l11.1425"> </span>
<a href="#l11.1426"></a><span id="l11.1426">       &lt;property name=&quot;ratio&quot;&gt;</span>
<a href="#l11.1427"></a><span id="l11.1427">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1428"></a><span id="l11.1428" class="difflineminus">-          let listbox =</span>
<a href="#l11.1429"></a><span id="l11.1429" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1430"></a><span id="l11.1430" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1431"></a><span id="l11.1431" class="difflineminus">-          let rowcount = listbox.getRowCount();</span>
<a href="#l11.1432"></a><span id="l11.1432" class="difflineminus">-          listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l11.1433"></a><span id="l11.1433" class="difflineminus">-          return val;</span>
<a href="#l11.1434"></a><span id="l11.1434" class="difflineplus">+            let listbox =</span>
<a href="#l11.1435"></a><span id="l11.1435" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l11.1436"></a><span id="l11.1436" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l11.1437"></a><span id="l11.1437" class="difflineplus">+            let rowcount = listbox.getRowCount();</span>
<a href="#l11.1438"></a><span id="l11.1438" class="difflineplus">+            listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l11.1439"></a><span id="l11.1439" class="difflineplus">+            return val;</span>
<a href="#l11.1440"></a><span id="l11.1440">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.1441"></a><span id="l11.1441">       &lt;/property&gt;</span>
<a href="#l11.1442"></a><span id="l11.1442"> </span>
<a href="#l11.1443"></a><span id="l11.1443">       &lt;method name=&quot;returnHit&quot;&gt;</span>
<a href="#l11.1444"></a><span id="l11.1444">         &lt;parameter name=&quot;element&quot;/&gt;</span>
<a href="#l11.1445"></a><span id="l11.1445">         &lt;parameter name=&quot;noAdvance&quot;/&gt;</span>
<a href="#l11.1446"></a><span id="l11.1446">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1447"></a><span id="l11.1447" class="difflineminus">-          function parseHeaderValue(aMsgIAddressObject) {</span>
<a href="#l11.1448"></a><span id="l11.1448" class="difflineminus">-              if (aMsgIAddressObject.name.match(/[&lt;&gt;@,]/)) {</span>
<a href="#l11.1449"></a><span id="l11.1449" class="difflineminus">-                  // special handling only needed for a name with a comma which are not already quoted</span>
<a href="#l11.1450"></a><span id="l11.1450" class="difflineminus">-                  return (aMsgIAddressObject.name.match(/^&quot;.*&quot;$/)</span>
<a href="#l11.1451"></a><span id="l11.1451" class="difflineminus">-                          ? aMsgIAddressObject.name</span>
<a href="#l11.1452"></a><span id="l11.1452" class="difflineminus">-                          : '&quot;' + aMsgIAddressObject.name + '&quot;'</span>
<a href="#l11.1453"></a><span id="l11.1453" class="difflineminus">-                         ) + &quot; &lt;&quot; + aMsgIAddressObject.email + &quot;&gt;&quot;;</span>
<a href="#l11.1454"></a><span id="l11.1454" class="difflineminus">-              } else {</span>
<a href="#l11.1455"></a><span id="l11.1455" class="difflineminus">-                  return aMsgIAddressObject.toString();</span>
<a href="#l11.1456"></a><span id="l11.1456" class="difflineminus">-              }</span>
<a href="#l11.1457"></a><span id="l11.1457" class="difflineminus">-          }</span>
<a href="#l11.1458"></a><span id="l11.1458" class="difflineplus">+            function parseHeaderValue(aMsgIAddressObject) {</span>
<a href="#l11.1459"></a><span id="l11.1459" class="difflineplus">+                if (aMsgIAddressObject.name.match(/[&lt;&gt;@,]/)) {</span>
<a href="#l11.1460"></a><span id="l11.1460" class="difflineplus">+                    // special handling only needed for a name with a comma which are not already quoted</span>
<a href="#l11.1461"></a><span id="l11.1461" class="difflineplus">+                    return (aMsgIAddressObject.name.match(/^&quot;.*&quot;$/)</span>
<a href="#l11.1462"></a><span id="l11.1462" class="difflineplus">+                            ? aMsgIAddressObject.name</span>
<a href="#l11.1463"></a><span id="l11.1463" class="difflineplus">+                            : '&quot;' + aMsgIAddressObject.name + '&quot;'</span>
<a href="#l11.1464"></a><span id="l11.1464" class="difflineplus">+                           ) + &quot; &lt;&quot; + aMsgIAddressObject.email + &quot;&gt;&quot;;</span>
<a href="#l11.1465"></a><span id="l11.1465" class="difflineplus">+                } else {</span>
<a href="#l11.1466"></a><span id="l11.1466" class="difflineplus">+                    return aMsgIAddressObject.toString();</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineplus">+                }</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineplus">+            }</span>
<a href="#l11.1469"></a><span id="l11.1469"> </span>
<a href="#l11.1470"></a><span id="l11.1470" class="difflineminus">-          let arrowLength = 1;</span>
<a href="#l11.1471"></a><span id="l11.1471" class="difflineminus">-          if (element.value.includes(&quot;,&quot;) || element.value.match(/^[^&quot;].*[&lt;&gt;@,].*[^&quot;] &lt;.+@.+&gt;$/)) {</span>
<a href="#l11.1472"></a><span id="l11.1472" class="difflineminus">-              let strippedAddresses = element.value.replace(/.* &gt;&gt; /, &quot;&quot;);</span>
<a href="#l11.1473"></a><span id="l11.1473" class="difflineminus">-              let addresses = MailServices.headerParser.makeFromDisplayAddress(strippedAddresses);</span>
<a href="#l11.1474"></a><span id="l11.1474" class="difflineminus">-              element.value = parseHeaderValue(addresses[0]);</span>
<a href="#l11.1475"></a><span id="l11.1475" class="difflineplus">+            let arrowLength = 1;</span>
<a href="#l11.1476"></a><span id="l11.1476" class="difflineplus">+            if (element.value.includes(&quot;,&quot;) || element.value.match(/^[^&quot;].*[&lt;&gt;@,].*[^&quot;] &lt;.+@.+&gt;$/)) {</span>
<a href="#l11.1477"></a><span id="l11.1477" class="difflineplus">+                let strippedAddresses = element.value.replace(/.* &gt;&gt; /, &quot;&quot;);</span>
<a href="#l11.1478"></a><span id="l11.1478" class="difflineplus">+                let addresses = MailServices.headerParser.makeFromDisplayAddress(strippedAddresses);</span>
<a href="#l11.1479"></a><span id="l11.1479" class="difflineplus">+                element.value = parseHeaderValue(addresses[0]);</span>
<a href="#l11.1480"></a><span id="l11.1480"> </span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineminus">-              // the following code is needed to split attendees, if the user enters a comma</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineminus">-              // separated list of attendees without using autocomplete functionality</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineminus">-              let insertAfterItem = this.getListItem(this.getRowByInputElement(element));</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineminus">-              for (let key in addresses) {</span>
<a href="#l11.1485"></a><span id="l11.1485" class="difflineminus">-                  if (key &gt; 0) {</span>
<a href="#l11.1486"></a><span id="l11.1486" class="difflineminus">-                      insertAfterItem = this.appendNewRow(false, insertAfterItem);</span>
<a href="#l11.1487"></a><span id="l11.1487" class="difflineminus">-                      let textinput = this.getInputFromListitem(insertAfterItem);</span>
<a href="#l11.1488"></a><span id="l11.1488" class="difflineminus">-                      textinput.value = parseHeaderValue(addresses[key]);</span>
<a href="#l11.1489"></a><span id="l11.1489" class="difflineminus">-                  }</span>
<a href="#l11.1490"></a><span id="l11.1490" class="difflineminus">-              }</span>
<a href="#l11.1491"></a><span id="l11.1491" class="difflineminus">-              arrowLength = addresses.length;</span>
<a href="#l11.1492"></a><span id="l11.1492" class="difflineminus">-          }</span>
<a href="#l11.1493"></a><span id="l11.1493" class="difflineplus">+                // the following code is needed to split attendees, if the user enters a comma</span>
<a href="#l11.1494"></a><span id="l11.1494" class="difflineplus">+                // separated list of attendees without using autocomplete functionality</span>
<a href="#l11.1495"></a><span id="l11.1495" class="difflineplus">+                let insertAfterItem = this.getListItem(this.getRowByInputElement(element));</span>
<a href="#l11.1496"></a><span id="l11.1496" class="difflineplus">+                for (let key in addresses) {</span>
<a href="#l11.1497"></a><span id="l11.1497" class="difflineplus">+                    if (key &gt; 0) {</span>
<a href="#l11.1498"></a><span id="l11.1498" class="difflineplus">+                        insertAfterItem = this.appendNewRow(false, insertAfterItem);</span>
<a href="#l11.1499"></a><span id="l11.1499" class="difflineplus">+                        let textinput = this.getInputFromListitem(insertAfterItem);</span>
<a href="#l11.1500"></a><span id="l11.1500" class="difflineplus">+                        textinput.value = parseHeaderValue(addresses[key]);</span>
<a href="#l11.1501"></a><span id="l11.1501" class="difflineplus">+                    }</span>
<a href="#l11.1502"></a><span id="l11.1502" class="difflineplus">+                }</span>
<a href="#l11.1503"></a><span id="l11.1503" class="difflineplus">+                arrowLength = addresses.length;</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineplus">+            }</span>
<a href="#l11.1505"></a><span id="l11.1505"> </span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineminus">-          if (!noAdvance) {</span>
<a href="#l11.1507"></a><span id="l11.1507" class="difflineminus">-              this.arrowHit(element, arrowLength);</span>
<a href="#l11.1508"></a><span id="l11.1508" class="difflineminus">-          }</span>
<a href="#l11.1509"></a><span id="l11.1509" class="difflineplus">+            if (!noAdvance) {</span>
<a href="#l11.1510"></a><span id="l11.1510" class="difflineplus">+                this.arrowHit(element, arrowLength);</span>
<a href="#l11.1511"></a><span id="l11.1511" class="difflineplus">+            }</span>
<a href="#l11.1512"></a><span id="l11.1512">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1513"></a><span id="l11.1513">       &lt;/method&gt;</span>
<a href="#l11.1514"></a><span id="l11.1514"> </span>
<a href="#l11.1515"></a><span id="l11.1515">       &lt;method name=&quot;arrowHit&quot;&gt;</span>
<a href="#l11.1516"></a><span id="l11.1516">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l11.1517"></a><span id="l11.1517">         &lt;parameter name=&quot;aDirection&quot;/&gt;</span>
<a href="#l11.1518"></a><span id="l11.1518">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1519"></a><span id="l11.1519" class="difflineminus">-          let row = this.getRowByInputElement(aElement) + aDirection;</span>
<a href="#l11.1520"></a><span id="l11.1520" class="difflineminus">-          if (row) {</span>
<a href="#l11.1521"></a><span id="l11.1521" class="difflineminus">-              if (row &gt; this.mMaxAttendees) {</span>
<a href="#l11.1522"></a><span id="l11.1522" class="difflineminus">-                  this.appendNewRow(true);</span>
<a href="#l11.1523"></a><span id="l11.1523" class="difflineminus">-              } else {</span>
<a href="#l11.1524"></a><span id="l11.1524" class="difflineminus">-                  let input = this.getInputElement(row);</span>
<a href="#l11.1525"></a><span id="l11.1525" class="difflineminus">-                  if (input.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineminus">-                      return;</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineminus">-                  }</span>
<a href="#l11.1528"></a><span id="l11.1528" class="difflineminus">-                  this.setFocus(row);</span>
<a href="#l11.1529"></a><span id="l11.1529" class="difflineminus">-              }</span>
<a href="#l11.1530"></a><span id="l11.1530" class="difflineminus">-              let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1531"></a><span id="l11.1531" class="difflineminus">-              event.initEvent(&quot;rowchange&quot;, true, false);</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineminus">-              event.details = row;</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineminus">-              this.dispatchEvent(event);</span>
<a href="#l11.1534"></a><span id="l11.1534" class="difflineminus">-          }</span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineplus">+            let row = this.getRowByInputElement(aElement) + aDirection;</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineplus">+            if (row) {</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineplus">+                if (row &gt; this.mMaxAttendees) {</span>
<a href="#l11.1538"></a><span id="l11.1538" class="difflineplus">+                    this.appendNewRow(true);</span>
<a href="#l11.1539"></a><span id="l11.1539" class="difflineplus">+                } else {</span>
<a href="#l11.1540"></a><span id="l11.1540" class="difflineplus">+                    let input = this.getInputElement(row);</span>
<a href="#l11.1541"></a><span id="l11.1541" class="difflineplus">+                    if (input.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l11.1542"></a><span id="l11.1542" class="difflineplus">+                        return;</span>
<a href="#l11.1543"></a><span id="l11.1543" class="difflineplus">+                    }</span>
<a href="#l11.1544"></a><span id="l11.1544" class="difflineplus">+                    this.setFocus(row);</span>
<a href="#l11.1545"></a><span id="l11.1545" class="difflineplus">+                }</span>
<a href="#l11.1546"></a><span id="l11.1546" class="difflineplus">+                let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1547"></a><span id="l11.1547" class="difflineplus">+                event.initEvent(&quot;rowchange&quot;, true, false);</span>
<a href="#l11.1548"></a><span id="l11.1548" class="difflineplus">+                event.details = row;</span>
<a href="#l11.1549"></a><span id="l11.1549" class="difflineplus">+                this.dispatchEvent(event);</span>
<a href="#l11.1550"></a><span id="l11.1550" class="difflineplus">+            }</span>
<a href="#l11.1551"></a><span id="l11.1551">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1552"></a><span id="l11.1552">       &lt;/method&gt;</span>
<a href="#l11.1553"></a><span id="l11.1553"> </span>
<a href="#l11.1554"></a><span id="l11.1554">       &lt;method name=&quot;deleteHit&quot;&gt;</span>
<a href="#l11.1555"></a><span id="l11.1555">         &lt;parameter name=&quot;aElement&quot;/&gt;</span>
<a href="#l11.1556"></a><span id="l11.1556">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1557"></a><span id="l11.1557" class="difflineminus">-          // don't delete the row if only the organizer is remaining</span>
<a href="#l11.1558"></a><span id="l11.1558" class="difflineminus">-          if (this.mMaxAttendees &lt;= 1) {</span>
<a href="#l11.1559"></a><span id="l11.1559" class="difflineminus">-              return;</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineminus">-          }</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineplus">+            // don't delete the row if only the organizer is remaining</span>
<a href="#l11.1562"></a><span id="l11.1562" class="difflineplus">+            if (this.mMaxAttendees &lt;= 1) {</span>
<a href="#l11.1563"></a><span id="l11.1563" class="difflineplus">+                return;</span>
<a href="#l11.1564"></a><span id="l11.1564" class="difflineplus">+            }</span>
<a href="#l11.1565"></a><span id="l11.1565"> </span>
<a href="#l11.1566"></a><span id="l11.1566" class="difflineminus">-          let row = this.getRowByInputElement(aElement);</span>
<a href="#l11.1567"></a><span id="l11.1567" class="difflineminus">-          this.deleteRow(row);</span>
<a href="#l11.1568"></a><span id="l11.1568" class="difflineminus">-          if (row &gt; 0) {</span>
<a href="#l11.1569"></a><span id="l11.1569" class="difflineminus">-              row = row - 1;</span>
<a href="#l11.1570"></a><span id="l11.1570" class="difflineminus">-          }</span>
<a href="#l11.1571"></a><span id="l11.1571" class="difflineminus">-          this.setFocus(row);</span>
<a href="#l11.1572"></a><span id="l11.1572" class="difflineminus">-          this.onModify();</span>
<a href="#l11.1573"></a><span id="l11.1573" class="difflineplus">+            let row = this.getRowByInputElement(aElement);</span>
<a href="#l11.1574"></a><span id="l11.1574" class="difflineplus">+            this.deleteRow(row);</span>
<a href="#l11.1575"></a><span id="l11.1575" class="difflineplus">+            if (row &gt; 0) {</span>
<a href="#l11.1576"></a><span id="l11.1576" class="difflineplus">+                row = row - 1;</span>
<a href="#l11.1577"></a><span id="l11.1577" class="difflineplus">+            }</span>
<a href="#l11.1578"></a><span id="l11.1578" class="difflineplus">+            this.setFocus(row);</span>
<a href="#l11.1579"></a><span id="l11.1579" class="difflineplus">+            this.onModify();</span>
<a href="#l11.1580"></a><span id="l11.1580"> </span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1582"></a><span id="l11.1582" class="difflineminus">-          event.initEvent(&quot;rowchange&quot;, true, false);</span>
<a href="#l11.1583"></a><span id="l11.1583" class="difflineminus">-          event.details = row;</span>
<a href="#l11.1584"></a><span id="l11.1584" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l11.1585"></a><span id="l11.1585" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.1586"></a><span id="l11.1586" class="difflineplus">+            event.initEvent(&quot;rowchange&quot;, true, false);</span>
<a href="#l11.1587"></a><span id="l11.1587" class="difflineplus">+            event.details = row;</span>
<a href="#l11.1588"></a><span id="l11.1588" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l11.1589"></a><span id="l11.1589">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1590"></a><span id="l11.1590">       &lt;/method&gt;</span>
<a href="#l11.1591"></a><span id="l11.1591"> </span>
<a href="#l11.1592"></a><span id="l11.1592">       &lt;method name=&quot;deleteRow&quot;&gt;</span>
<a href="#l11.1593"></a><span id="l11.1593">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1594"></a><span id="l11.1594">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1595"></a><span id="l11.1595" class="difflineminus">-          // reset id's in order to not break the sequence</span>
<a href="#l11.1596"></a><span id="l11.1596" class="difflineminus">-          let maxAttendees = this.mMaxAttendees;</span>
<a href="#l11.1597"></a><span id="l11.1597" class="difflineminus">-          this.removeRow(aRow);</span>
<a href="#l11.1598"></a><span id="l11.1598" class="difflineminus">-          let numberOfCols = this.numColumns;</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineminus">-          for (let row = aRow + 1; row &lt;= maxAttendees; row++) {</span>
<a href="#l11.1600"></a><span id="l11.1600" class="difflineminus">-              for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l11.1601"></a><span id="l11.1601" class="difflineminus">-                  let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l11.1602"></a><span id="l11.1602" class="difflineminus">-                  let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l11.1603"></a><span id="l11.1603" class="difflineminus">-                  if (elem) {</span>
<a href="#l11.1604"></a><span id="l11.1604" class="difflineminus">-                      elem.setAttribute(&quot;id&quot;, &quot;attendeeCol&quot; + col + &quot;#&quot; + (row - 1));</span>
<a href="#l11.1605"></a><span id="l11.1605" class="difflineminus">-                  }</span>
<a href="#l11.1606"></a><span id="l11.1606" class="difflineminus">-              }</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineminus">-          }</span>
<a href="#l11.1608"></a><span id="l11.1608" class="difflineplus">+            // reset id's in order to not break the sequence</span>
<a href="#l11.1609"></a><span id="l11.1609" class="difflineplus">+            let maxAttendees = this.mMaxAttendees;</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineplus">+            this.removeRow(aRow);</span>
<a href="#l11.1611"></a><span id="l11.1611" class="difflineplus">+            let numberOfCols = this.numColumns;</span>
<a href="#l11.1612"></a><span id="l11.1612" class="difflineplus">+            for (let row = aRow + 1; row &lt;= maxAttendees; row++) {</span>
<a href="#l11.1613"></a><span id="l11.1613" class="difflineplus">+                for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l11.1614"></a><span id="l11.1614" class="difflineplus">+                    let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineplus">+                    let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineplus">+                    if (elem) {</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineplus">+                        elem.setAttribute(&quot;id&quot;, &quot;attendeeCol&quot; + col + &quot;#&quot; + (row - 1));</span>
<a href="#l11.1618"></a><span id="l11.1618" class="difflineplus">+                    }</span>
<a href="#l11.1619"></a><span id="l11.1619" class="difflineplus">+                }</span>
<a href="#l11.1620"></a><span id="l11.1620" class="difflineplus">+            }</span>
<a href="#l11.1621"></a><span id="l11.1621">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1622"></a><span id="l11.1622">       &lt;/method&gt;</span>
<a href="#l11.1623"></a><span id="l11.1623"> </span>
<a href="#l11.1624"></a><span id="l11.1624">       &lt;method name=&quot;removeRow&quot;&gt;</span>
<a href="#l11.1625"></a><span id="l11.1625">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l11.1626"></a><span id="l11.1626">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.1627"></a><span id="l11.1627" class="difflineminus">-          this.getListItem(aRow).remove();</span>
<a href="#l11.1628"></a><span id="l11.1628" class="difflineminus">-          this.fitDummyRows();</span>
<a href="#l11.1629"></a><span id="l11.1629" class="difflineminus">-          this.mMaxAttendees--;</span>
<a href="#l11.1630"></a><span id="l11.1630" class="difflineplus">+            this.getListItem(aRow).remove();</span>
<a href="#l11.1631"></a><span id="l11.1631" class="difflineplus">+            this.fitDummyRows();</span>
<a href="#l11.1632"></a><span id="l11.1632" class="difflineplus">+            this.mMaxAttendees--;</span>
<a href="#l11.1633"></a><span id="l11.1633">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.1634"></a><span id="l11.1634">       &lt;/method&gt;</span>
<a href="#l11.1635"></a><span id="l11.1635">     &lt;/implementation&gt;</span>
<a href="#l11.1636"></a><span id="l11.1636"> </span>
<a href="#l11.1637"></a><span id="l11.1637">     &lt;handlers&gt;</span>
<a href="#l11.1638"></a><span id="l11.1638">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.1639"></a><span id="l11.1639" class="difflineminus">-        function cycle(values, current) {</span>
<a href="#l11.1640"></a><span id="l11.1640" class="difflineminus">-            let nextIndex = (values.indexOf(current) + 1) % values.length;</span>
<a href="#l11.1641"></a><span id="l11.1641" class="difflineminus">-            return values[nextIndex];</span>
<a href="#l11.1642"></a><span id="l11.1642" class="difflineminus">-        }</span>
<a href="#l11.1643"></a><span id="l11.1643" class="difflineplus">+          function cycle(values, current) {</span>
<a href="#l11.1644"></a><span id="l11.1644" class="difflineplus">+              let nextIndex = (values.indexOf(current) + 1) % values.length;</span>
<a href="#l11.1645"></a><span id="l11.1645" class="difflineplus">+              return values[nextIndex];</span>
<a href="#l11.1646"></a><span id="l11.1646" class="difflineplus">+          }</span>
<a href="#l11.1647"></a><span id="l11.1647"> </span>
<a href="#l11.1648"></a><span id="l11.1648" class="difflineminus">-        let target = event.originalTarget;</span>
<a href="#l11.1649"></a><span id="l11.1649" class="difflineminus">-        if (target.className == &quot;role-icon&quot;) {</span>
<a href="#l11.1650"></a><span id="l11.1650" class="difflineminus">-            if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot;) {</span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineminus">-                const roleCycle = [</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineminus">-                    &quot;REQ-PARTICIPANT&quot;, &quot;OPT-PARTICIPANT&quot;,</span>
<a href="#l11.1653"></a><span id="l11.1653" class="difflineminus">-                    &quot;NON-PARTICIPANT&quot;, &quot;CHAIR&quot;</span>
<a href="#l11.1654"></a><span id="l11.1654" class="difflineminus">-                ];</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineplus">+          let target = event.originalTarget;</span>
<a href="#l11.1656"></a><span id="l11.1656" class="difflineplus">+          if (target.className == &quot;role-icon&quot;) {</span>
<a href="#l11.1657"></a><span id="l11.1657" class="difflineplus">+              if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot;) {</span>
<a href="#l11.1658"></a><span id="l11.1658" class="difflineplus">+                  const roleCycle = [</span>
<a href="#l11.1659"></a><span id="l11.1659" class="difflineplus">+                      &quot;REQ-PARTICIPANT&quot;, &quot;OPT-PARTICIPANT&quot;,</span>
<a href="#l11.1660"></a><span id="l11.1660" class="difflineplus">+                      &quot;NON-PARTICIPANT&quot;, &quot;CHAIR&quot;</span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineplus">+                  ];</span>
<a href="#l11.1662"></a><span id="l11.1662"> </span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineminus">-                let nextValue = cycle(roleCycle, target.getAttribute(&quot;role&quot;));</span>
<a href="#l11.1664"></a><span id="l11.1664" class="difflineminus">-                target.setAttribute(&quot;role&quot;, nextValue);</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineminus">-                this.updateTooltip(target);</span>
<a href="#l11.1666"></a><span id="l11.1666" class="difflineminus">-            }</span>
<a href="#l11.1667"></a><span id="l11.1667" class="difflineminus">-        } else if (target.className == &quot;status-icon&quot;) {</span>
<a href="#l11.1668"></a><span id="l11.1668" class="difflineminus">-            if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot;) {</span>
<a href="#l11.1669"></a><span id="l11.1669" class="difflineminus">-                const statusCycle = [&quot;ACCEPTED&quot;, &quot;DECLINED&quot;, &quot;TENTATIVE&quot;];</span>
<a href="#l11.1670"></a><span id="l11.1670" class="difflineplus">+                  let nextValue = cycle(roleCycle, target.getAttribute(&quot;role&quot;));</span>
<a href="#l11.1671"></a><span id="l11.1671" class="difflineplus">+                  target.setAttribute(&quot;role&quot;, nextValue);</span>
<a href="#l11.1672"></a><span id="l11.1672" class="difflineplus">+                  this.updateTooltip(target);</span>
<a href="#l11.1673"></a><span id="l11.1673" class="difflineplus">+              }</span>
<a href="#l11.1674"></a><span id="l11.1674" class="difflineplus">+          } else if (target.className == &quot;status-icon&quot;) {</span>
<a href="#l11.1675"></a><span id="l11.1675" class="difflineplus">+              if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot;) {</span>
<a href="#l11.1676"></a><span id="l11.1676" class="difflineplus">+                  const statusCycle = [&quot;ACCEPTED&quot;, &quot;DECLINED&quot;, &quot;TENTATIVE&quot;];</span>
<a href="#l11.1677"></a><span id="l11.1677"> </span>
<a href="#l11.1678"></a><span id="l11.1678" class="difflineminus">-                let nextValue = cycle(statusCycle, target.getAttribute(&quot;status&quot;));</span>
<a href="#l11.1679"></a><span id="l11.1679" class="difflineminus">-                target.setAttribute(&quot;status&quot;, nextValue);</span>
<a href="#l11.1680"></a><span id="l11.1680" class="difflineminus">-                this.updateTooltip(target);</span>
<a href="#l11.1681"></a><span id="l11.1681" class="difflineminus">-            }</span>
<a href="#l11.1682"></a><span id="l11.1682" class="difflineminus">-        } else if (target.className == &quot;usertype-icon&quot;) {</span>
<a href="#l11.1683"></a><span id="l11.1683" class="difflineminus">-            let fieldNum = target.getAttribute(&quot;id&quot;).split(&quot;#&quot;)[1];</span>
<a href="#l11.1684"></a><span id="l11.1684" class="difflineminus">-            let inputField = this.getInputElement(fieldNum);</span>
<a href="#l11.1685"></a><span id="l11.1685" class="difflineminus">-            if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot; &amp;&amp;</span>
<a href="#l11.1686"></a><span id="l11.1686" class="difflineminus">-                !inputField.attendee.isOrganizer) {</span>
<a href="#l11.1687"></a><span id="l11.1687" class="difflineminus">-                const cutypeCycle = [&quot;INDIVIDUAL&quot;, &quot;GROUP&quot;, &quot;RESOURCE&quot;, &quot;ROOM&quot;];</span>
<a href="#l11.1688"></a><span id="l11.1688" class="difflineplus">+                  let nextValue = cycle(statusCycle, target.getAttribute(&quot;status&quot;));</span>
<a href="#l11.1689"></a><span id="l11.1689" class="difflineplus">+                  target.setAttribute(&quot;status&quot;, nextValue);</span>
<a href="#l11.1690"></a><span id="l11.1690" class="difflineplus">+                  this.updateTooltip(target);</span>
<a href="#l11.1691"></a><span id="l11.1691" class="difflineplus">+              }</span>
<a href="#l11.1692"></a><span id="l11.1692" class="difflineplus">+          } else if (target.className == &quot;usertype-icon&quot;) {</span>
<a href="#l11.1693"></a><span id="l11.1693" class="difflineplus">+              let fieldNum = target.getAttribute(&quot;id&quot;).split(&quot;#&quot;)[1];</span>
<a href="#l11.1694"></a><span id="l11.1694" class="difflineplus">+              let inputField = this.getInputElement(fieldNum);</span>
<a href="#l11.1695"></a><span id="l11.1695" class="difflineplus">+              if (target.getAttribute(&quot;disabled&quot;) != &quot;true&quot; &amp;&amp;</span>
<a href="#l11.1696"></a><span id="l11.1696" class="difflineplus">+                  !inputField.attendee.isOrganizer) {</span>
<a href="#l11.1697"></a><span id="l11.1697" class="difflineplus">+                  const cutypeCycle = [&quot;INDIVIDUAL&quot;, &quot;GROUP&quot;, &quot;RESOURCE&quot;, &quot;ROOM&quot;];</span>
<a href="#l11.1698"></a><span id="l11.1698"> </span>
<a href="#l11.1699"></a><span id="l11.1699" class="difflineminus">-                let nextValue = cycle(cutypeCycle, target.getAttribute(&quot;cutype&quot;));</span>
<a href="#l11.1700"></a><span id="l11.1700" class="difflineminus">-                target.setAttribute(&quot;cutype&quot;, nextValue);</span>
<a href="#l11.1701"></a><span id="l11.1701" class="difflineminus">-                this.updateTooltip(target);</span>
<a href="#l11.1702"></a><span id="l11.1702" class="difflineminus">-            }</span>
<a href="#l11.1703"></a><span id="l11.1703" class="difflineminus">-        } else if (this.mIsReadOnly || this.mIsInvitation || target == null ||</span>
<a href="#l11.1704"></a><span id="l11.1704" class="difflineminus">-                   (target.localName != &quot;listboxbody&quot; &amp;&amp;</span>
<a href="#l11.1705"></a><span id="l11.1705" class="difflineminus">-                    target.localName != &quot;listcell&quot; &amp;&amp;</span>
<a href="#l11.1706"></a><span id="l11.1706" class="difflineminus">-                    target.localName != &quot;listitem&quot;)) {</span>
<a href="#l11.1707"></a><span id="l11.1707" class="difflineminus">-            // These are cases where we don't want to append a new row, keep</span>
<a href="#l11.1708"></a><span id="l11.1708" class="difflineminus">-            // them here so we can put the rest in the else case.</span>
<a href="#l11.1709"></a><span id="l11.1709" class="difflineminus">-        } else {</span>
<a href="#l11.1710"></a><span id="l11.1710" class="difflineminus">-            let lastInput = this.getInputElement(this.mMaxAttendees);</span>
<a href="#l11.1711"></a><span id="l11.1711" class="difflineminus">-            if (lastInput &amp;&amp; lastInput.value) {</span>
<a href="#l11.1712"></a><span id="l11.1712" class="difflineminus">-                this.appendNewRow(true);</span>
<a href="#l11.1713"></a><span id="l11.1713" class="difflineminus">-            }</span>
<a href="#l11.1714"></a><span id="l11.1714" class="difflineminus">-        }</span>
<a href="#l11.1715"></a><span id="l11.1715" class="difflineplus">+                  let nextValue = cycle(cutypeCycle, target.getAttribute(&quot;cutype&quot;));</span>
<a href="#l11.1716"></a><span id="l11.1716" class="difflineplus">+                  target.setAttribute(&quot;cutype&quot;, nextValue);</span>
<a href="#l11.1717"></a><span id="l11.1717" class="difflineplus">+                  this.updateTooltip(target);</span>
<a href="#l11.1718"></a><span id="l11.1718" class="difflineplus">+              }</span>
<a href="#l11.1719"></a><span id="l11.1719" class="difflineplus">+          } else if (this.mIsReadOnly || this.mIsInvitation || target == null ||</span>
<a href="#l11.1720"></a><span id="l11.1720" class="difflineplus">+                     (target.localName != &quot;listboxbody&quot; &amp;&amp;</span>
<a href="#l11.1721"></a><span id="l11.1721" class="difflineplus">+                      target.localName != &quot;listcell&quot; &amp;&amp;</span>
<a href="#l11.1722"></a><span id="l11.1722" class="difflineplus">+                      target.localName != &quot;listitem&quot;)) {</span>
<a href="#l11.1723"></a><span id="l11.1723" class="difflineplus">+              // These are cases where we don't want to append a new row, keep</span>
<a href="#l11.1724"></a><span id="l11.1724" class="difflineplus">+              // them here so we can put the rest in the else case.</span>
<a href="#l11.1725"></a><span id="l11.1725" class="difflineplus">+          } else {</span>
<a href="#l11.1726"></a><span id="l11.1726" class="difflineplus">+              let lastInput = this.getInputElement(this.mMaxAttendees);</span>
<a href="#l11.1727"></a><span id="l11.1727" class="difflineplus">+              if (lastInput &amp;&amp; lastInput.value) {</span>
<a href="#l11.1728"></a><span id="l11.1728" class="difflineplus">+                  this.appendNewRow(true);</span>
<a href="#l11.1729"></a><span id="l11.1729" class="difflineplus">+              }</span>
<a href="#l11.1730"></a><span id="l11.1730" class="difflineplus">+          }</span>
<a href="#l11.1731"></a><span id="l11.1731">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.1732"></a><span id="l11.1732"> </span>
<a href="#l11.1733"></a><span id="l11.1733">       &lt;handler event=&quot;popupshown&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.1734"></a><span id="l11.1734" class="difflineminus">-        this.mPopupOpen = true;</span>
<a href="#l11.1735"></a><span id="l11.1735" class="difflineplus">+          this.mPopupOpen = true;</span>
<a href="#l11.1736"></a><span id="l11.1736">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.1737"></a><span id="l11.1737"> </span>
<a href="#l11.1738"></a><span id="l11.1738">       &lt;handler event=&quot;popuphidden&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.1739"></a><span id="l11.1739" class="difflineminus">-        this.mPopupOpen = false;</span>
<a href="#l11.1740"></a><span id="l11.1740" class="difflineplus">+          this.mPopupOpen = false;</span>
<a href="#l11.1741"></a><span id="l11.1741">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.1742"></a><span id="l11.1742"> </span>
<a href="#l11.1743"></a><span id="l11.1743">       &lt;handler event=&quot;keydown&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.1744"></a><span id="l11.1744" class="difflineminus">-        if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.1745"></a><span id="l11.1745" class="difflineminus">-            return;</span>
<a href="#l11.1746"></a><span id="l11.1746" class="difflineminus">-        }</span>
<a href="#l11.1747"></a><span id="l11.1747" class="difflineminus">-        if (event.originalTarget.localName == &quot;input&quot;) {</span>
<a href="#l11.1748"></a><span id="l11.1748" class="difflineminus">-            switch (event.keyCode) {</span>
<a href="#l11.1749"></a><span id="l11.1749" class="difflineminus">-                case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l11.1750"></a><span id="l11.1750" class="difflineminus">-                case KeyEvent.DOM_VK_BACK_SPACE: {</span>
<a href="#l11.1751"></a><span id="l11.1751" class="difflineminus">-                    let curRowId = this.getRowByInputElement(event.originalTarget);</span>
<a href="#l11.1752"></a><span id="l11.1752" class="difflineminus">-                    let allSelected = (event.originalTarget.textLength ==</span>
<a href="#l11.1753"></a><span id="l11.1753" class="difflineminus">-                                       event.originalTarget.selectionEnd -</span>
<a href="#l11.1754"></a><span id="l11.1754" class="difflineminus">-                                       event.originalTarget.selectionStart);</span>
<a href="#l11.1755"></a><span id="l11.1755" class="difflineplus">+          if (this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.1756"></a><span id="l11.1756" class="difflineplus">+              return;</span>
<a href="#l11.1757"></a><span id="l11.1757" class="difflineplus">+          }</span>
<a href="#l11.1758"></a><span id="l11.1758" class="difflineplus">+          if (event.originalTarget.localName == &quot;input&quot;) {</span>
<a href="#l11.1759"></a><span id="l11.1759" class="difflineplus">+              switch (event.keyCode) {</span>
<a href="#l11.1760"></a><span id="l11.1760" class="difflineplus">+                  case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l11.1761"></a><span id="l11.1761" class="difflineplus">+                  case KeyEvent.DOM_VK_BACK_SPACE: {</span>
<a href="#l11.1762"></a><span id="l11.1762" class="difflineplus">+                      let curRowId = this.getRowByInputElement(event.originalTarget);</span>
<a href="#l11.1763"></a><span id="l11.1763" class="difflineplus">+                      let allSelected = (event.originalTarget.textLength ==</span>
<a href="#l11.1764"></a><span id="l11.1764" class="difflineplus">+                                         event.originalTarget.selectionEnd -</span>
<a href="#l11.1765"></a><span id="l11.1765" class="difflineplus">+                                         event.originalTarget.selectionStart);</span>
<a href="#l11.1766"></a><span id="l11.1766"> </span>
<a href="#l11.1767"></a><span id="l11.1767" class="difflineminus">-                    if (!event.originalTarget.value ||</span>
<a href="#l11.1768"></a><span id="l11.1768" class="difflineminus">-                        event.originalTarget.textLength &lt; 2 ||</span>
<a href="#l11.1769"></a><span id="l11.1769" class="difflineminus">-                        allSelected) {</span>
<a href="#l11.1770"></a><span id="l11.1770" class="difflineminus">-                        // if the user selected the entire attendee string, only one character was</span>
<a href="#l11.1771"></a><span id="l11.1771" class="difflineminus">-                        // left or the row was already empty before hitting the key, we remove the</span>
<a href="#l11.1772"></a><span id="l11.1772" class="difflineminus">-                        //  entire row to assure the attendee is deleted</span>
<a href="#l11.1773"></a><span id="l11.1773" class="difflineminus">-                        this.deleteHit(event.originalTarget);</span>
<a href="#l11.1774"></a><span id="l11.1774" class="difflineplus">+                      if (!event.originalTarget.value ||</span>
<a href="#l11.1775"></a><span id="l11.1775" class="difflineplus">+                          event.originalTarget.textLength &lt; 2 ||</span>
<a href="#l11.1776"></a><span id="l11.1776" class="difflineplus">+                          allSelected) {</span>
<a href="#l11.1777"></a><span id="l11.1777" class="difflineplus">+                          // if the user selected the entire attendee string, only one character was</span>
<a href="#l11.1778"></a><span id="l11.1778" class="difflineplus">+                          // left or the row was already empty before hitting the key, we remove the</span>
<a href="#l11.1779"></a><span id="l11.1779" class="difflineplus">+                          //  entire row to assure the attendee is deleted</span>
<a href="#l11.1780"></a><span id="l11.1780" class="difflineplus">+                          this.deleteHit(event.originalTarget);</span>
<a href="#l11.1781"></a><span id="l11.1781"> </span>
<a href="#l11.1782"></a><span id="l11.1782" class="difflineminus">-                        // if the last row was removed, we append an empty one which has the focus</span>
<a href="#l11.1783"></a><span id="l11.1783" class="difflineminus">-                        // to enable adding a new attendee directly with freebusy information cleared</span>
<a href="#l11.1784"></a><span id="l11.1784" class="difflineminus">-                        let targetRowId = (event.keyCode == KeyEvent.DOM_VK_BACK_SPACE &amp;&amp; curRowId &gt; 2)</span>
<a href="#l11.1785"></a><span id="l11.1785" class="difflineminus">-                                          ? curRowId - 1 : curRowId;</span>
<a href="#l11.1786"></a><span id="l11.1786" class="difflineminus">-                        if (this.mMaxAttendees == 1) {</span>
<a href="#l11.1787"></a><span id="l11.1787" class="difflineminus">-                            this.appendNewRow(true);</span>
<a href="#l11.1788"></a><span id="l11.1788" class="difflineminus">-                        } else {</span>
<a href="#l11.1789"></a><span id="l11.1789" class="difflineminus">-                            this.setFocus(targetRowId);</span>
<a href="#l11.1790"></a><span id="l11.1790" class="difflineminus">-                        }</span>
<a href="#l11.1791"></a><span id="l11.1791" class="difflineplus">+                          // if the last row was removed, we append an empty one which has the focus</span>
<a href="#l11.1792"></a><span id="l11.1792" class="difflineplus">+                          // to enable adding a new attendee directly with freebusy information cleared</span>
<a href="#l11.1793"></a><span id="l11.1793" class="difflineplus">+                          let targetRowId = (event.keyCode == KeyEvent.DOM_VK_BACK_SPACE &amp;&amp; curRowId &gt; 2)</span>
<a href="#l11.1794"></a><span id="l11.1794" class="difflineplus">+                                            ? curRowId - 1 : curRowId;</span>
<a href="#l11.1795"></a><span id="l11.1795" class="difflineplus">+                          if (this.mMaxAttendees == 1) {</span>
<a href="#l11.1796"></a><span id="l11.1796" class="difflineplus">+                              this.appendNewRow(true);</span>
<a href="#l11.1797"></a><span id="l11.1797" class="difflineplus">+                          } else {</span>
<a href="#l11.1798"></a><span id="l11.1798" class="difflineplus">+                              this.setFocus(targetRowId);</span>
<a href="#l11.1799"></a><span id="l11.1799" class="difflineplus">+                          }</span>
<a href="#l11.1800"></a><span id="l11.1800"> </span>
<a href="#l11.1801"></a><span id="l11.1801" class="difflineminus">-                        // set cursor to begin or end of focused input box based on deletion direction</span>
<a href="#l11.1802"></a><span id="l11.1802" class="difflineminus">-                        let cPos = 0;</span>
<a href="#l11.1803"></a><span id="l11.1803" class="difflineminus">-                        let input = document.getAnonymousElementByAttribute(this.getListItem(targetRowId),</span>
<a href="#l11.1804"></a><span id="l11.1804" class="difflineminus">-                                                                            &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.1805"></a><span id="l11.1805" class="difflineminus">-                        if (targetRowId != curRowId) {</span>
<a href="#l11.1806"></a><span id="l11.1806" class="difflineminus">-                            cPos = input.textLength;</span>
<a href="#l11.1807"></a><span id="l11.1807" class="difflineminus">-                        }</span>
<a href="#l11.1808"></a><span id="l11.1808" class="difflineminus">-                        input.setSelectionRange(cPos, cPos);</span>
<a href="#l11.1809"></a><span id="l11.1809" class="difflineminus">-                    }</span>
<a href="#l11.1810"></a><span id="l11.1810" class="difflineplus">+                          // set cursor to begin or end of focused input box based on deletion direction</span>
<a href="#l11.1811"></a><span id="l11.1811" class="difflineplus">+                          let cPos = 0;</span>
<a href="#l11.1812"></a><span id="l11.1812" class="difflineplus">+                          let input = document.getAnonymousElementByAttribute(this.getListItem(targetRowId),</span>
<a href="#l11.1813"></a><span id="l11.1813" class="difflineplus">+                                                                              &quot;anonid&quot;, &quot;input&quot;);</span>
<a href="#l11.1814"></a><span id="l11.1814" class="difflineplus">+                          if (targetRowId != curRowId) {</span>
<a href="#l11.1815"></a><span id="l11.1815" class="difflineplus">+                              cPos = input.textLength;</span>
<a href="#l11.1816"></a><span id="l11.1816" class="difflineplus">+                          }</span>
<a href="#l11.1817"></a><span id="l11.1817" class="difflineplus">+                          input.setSelectionRange(cPos, cPos);</span>
<a href="#l11.1818"></a><span id="l11.1818" class="difflineplus">+                      }</span>
<a href="#l11.1819"></a><span id="l11.1819"> </span>
<a href="#l11.1820"></a><span id="l11.1820" class="difflineminus">-                    event.stopPropagation();</span>
<a href="#l11.1821"></a><span id="l11.1821" class="difflineminus">-                    break;</span>
<a href="#l11.1822"></a><span id="l11.1822" class="difflineminus">-                }</span>
<a href="#l11.1823"></a><span id="l11.1823" class="difflineminus">-            }</span>
<a href="#l11.1824"></a><span id="l11.1824" class="difflineminus">-        }</span>
<a href="#l11.1825"></a><span id="l11.1825" class="difflineplus">+                      event.stopPropagation();</span>
<a href="#l11.1826"></a><span id="l11.1826" class="difflineplus">+                      break;</span>
<a href="#l11.1827"></a><span id="l11.1827" class="difflineplus">+                  }</span>
<a href="#l11.1828"></a><span id="l11.1828" class="difflineplus">+              }</span>
<a href="#l11.1829"></a><span id="l11.1829" class="difflineplus">+          }</span>
<a href="#l11.1830"></a><span id="l11.1830">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.1831"></a><span id="l11.1831"> </span>
<a href="#l11.1832"></a><span id="l11.1832">       &lt;handler event=&quot;keypress&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.1833"></a><span id="l11.1833" class="difflineminus">-        // In case we're currently showing the autocompletion popup</span>
<a href="#l11.1834"></a><span id="l11.1834" class="difflineminus">-        // don't care about keypress-events and let them go. Otherwise</span>
<a href="#l11.1835"></a><span id="l11.1835" class="difflineminus">-        // this event indicates the user wants to travel between</span>
<a href="#l11.1836"></a><span id="l11.1836" class="difflineminus">-        // the different attendees. In this case we set the focus</span>
<a href="#l11.1837"></a><span id="l11.1837" class="difflineminus">-        // appropriately and stop the event propagation.</span>
<a href="#l11.1838"></a><span id="l11.1838" class="difflineminus">-        if (this.mPopupOpen || this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.1839"></a><span id="l11.1839" class="difflineminus">-            return;</span>
<a href="#l11.1840"></a><span id="l11.1840" class="difflineminus">-        }</span>
<a href="#l11.1841"></a><span id="l11.1841" class="difflineminus">-        if (event.originalTarget.localName == &quot;input&quot;) {</span>
<a href="#l11.1842"></a><span id="l11.1842" class="difflineminus">-            switch (event.keyCode) {</span>
<a href="#l11.1843"></a><span id="l11.1843" class="difflineminus">-                case KeyEvent.DOM_VK_UP:</span>
<a href="#l11.1844"></a><span id="l11.1844" class="difflineminus">-                    this.arrowHit(event.originalTarget, -1);</span>
<a href="#l11.1845"></a><span id="l11.1845" class="difflineminus">-                    event.stopPropagation();</span>
<a href="#l11.1846"></a><span id="l11.1846" class="difflineminus">-                    break;</span>
<a href="#l11.1847"></a><span id="l11.1847" class="difflineminus">-                case KeyEvent.DOM_VK_DOWN:</span>
<a href="#l11.1848"></a><span id="l11.1848" class="difflineminus">-                    this.arrowHit(event.originalTarget, 1);</span>
<a href="#l11.1849"></a><span id="l11.1849" class="difflineminus">-                    event.stopPropagation();</span>
<a href="#l11.1850"></a><span id="l11.1850" class="difflineminus">-                    break;</span>
<a href="#l11.1851"></a><span id="l11.1851" class="difflineminus">-                case KeyEvent.DOM_VK_TAB:</span>
<a href="#l11.1852"></a><span id="l11.1852" class="difflineminus">-                    this.arrowHit(event.originalTarget, event.shiftKey ? -1 : +1);</span>
<a href="#l11.1853"></a><span id="l11.1853" class="difflineminus">-                    break;</span>
<a href="#l11.1854"></a><span id="l11.1854" class="difflineminus">-            }</span>
<a href="#l11.1855"></a><span id="l11.1855" class="difflineminus">-        }</span>
<a href="#l11.1856"></a><span id="l11.1856" class="difflineplus">+          // In case we're currently showing the autocompletion popup</span>
<a href="#l11.1857"></a><span id="l11.1857" class="difflineplus">+          // don't care about keypress-events and let them go. Otherwise</span>
<a href="#l11.1858"></a><span id="l11.1858" class="difflineplus">+          // this event indicates the user wants to travel between</span>
<a href="#l11.1859"></a><span id="l11.1859" class="difflineplus">+          // the different attendees. In this case we set the focus</span>
<a href="#l11.1860"></a><span id="l11.1860" class="difflineplus">+          // appropriately and stop the event propagation.</span>
<a href="#l11.1861"></a><span id="l11.1861" class="difflineplus">+          if (this.mPopupOpen || this.mIsReadOnly || this.mIsInvitation) {</span>
<a href="#l11.1862"></a><span id="l11.1862" class="difflineplus">+              return;</span>
<a href="#l11.1863"></a><span id="l11.1863" class="difflineplus">+          }</span>
<a href="#l11.1864"></a><span id="l11.1864" class="difflineplus">+          if (event.originalTarget.localName == &quot;input&quot;) {</span>
<a href="#l11.1865"></a><span id="l11.1865" class="difflineplus">+              switch (event.keyCode) {</span>
<a href="#l11.1866"></a><span id="l11.1866" class="difflineplus">+                  case KeyEvent.DOM_VK_UP:</span>
<a href="#l11.1867"></a><span id="l11.1867" class="difflineplus">+                      this.arrowHit(event.originalTarget, -1);</span>
<a href="#l11.1868"></a><span id="l11.1868" class="difflineplus">+                      event.stopPropagation();</span>
<a href="#l11.1869"></a><span id="l11.1869" class="difflineplus">+                      break;</span>
<a href="#l11.1870"></a><span id="l11.1870" class="difflineplus">+                  case KeyEvent.DOM_VK_DOWN:</span>
<a href="#l11.1871"></a><span id="l11.1871" class="difflineplus">+                      this.arrowHit(event.originalTarget, 1);</span>
<a href="#l11.1872"></a><span id="l11.1872" class="difflineplus">+                      event.stopPropagation();</span>
<a href="#l11.1873"></a><span id="l11.1873" class="difflineplus">+                      break;</span>
<a href="#l11.1874"></a><span id="l11.1874" class="difflineplus">+                  case KeyEvent.DOM_VK_TAB:</span>
<a href="#l11.1875"></a><span id="l11.1875" class="difflineplus">+                      this.arrowHit(event.originalTarget, event.shiftKey ? -1 : +1);</span>
<a href="#l11.1876"></a><span id="l11.1876" class="difflineplus">+                      break;</span>
<a href="#l11.1877"></a><span id="l11.1877" class="difflineplus">+              }</span>
<a href="#l11.1878"></a><span id="l11.1878" class="difflineplus">+          }</span>
<a href="#l11.1879"></a><span id="l11.1879">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.1880"></a><span id="l11.1880">     &lt;/handlers&gt;</span>
<a href="#l11.1881"></a><span id="l11.1881">   &lt;/binding&gt;</span>
<a href="#l11.1882"></a><span id="l11.1882"> </span>
<a href="#l11.1883"></a><span id="l11.1883">   &lt;!-- the 'selection-bar' binding implements the vertical bar that provides</span>
<a href="#l11.1884"></a><span id="l11.1884">        a visual indication for the time range the event is configured for. --&gt;</span>
<a href="#l11.1885"></a><span id="l11.1885">   &lt;binding id=&quot;selection-bar&quot;&gt;</span>
<a href="#l11.1886"></a><span id="l11.1886">     &lt;content&gt;</span>
<a href="#l11.1887"></a><span id="l11.1887" class="difflineat">@@ -1228,380 +1228,380 @@</span>
<a href="#l11.1888"></a><span id="l11.1888">       &lt;!-- constant that defines at which ratio an event is clipped, when moved or resized --&gt;</span>
<a href="#l11.1889"></a><span id="l11.1889">       &lt;field name=&quot;mfClipRatio&quot;&gt;0.7&lt;/field&gt;</span>
<a href="#l11.1890"></a><span id="l11.1890">       &lt;field name=&quot;mLeftBox&quot;/&gt;</span>
<a href="#l11.1891"></a><span id="l11.1891">       &lt;field name=&quot;mRightBox&quot;/&gt;</span>
<a href="#l11.1892"></a><span id="l11.1892">       &lt;field name=&quot;mSelectionbar&quot;/&gt;</span>
<a href="#l11.1893"></a><span id="l11.1893"> </span>
<a href="#l11.1894"></a><span id="l11.1894">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l11.1895"></a><span id="l11.1895">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.1896"></a><span id="l11.1896" class="difflineminus">-          return this.mZoomFactor;</span>
<a href="#l11.1897"></a><span id="l11.1897" class="difflineplus">+            return this.mZoomFactor;</span>
<a href="#l11.1898"></a><span id="l11.1898">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.1899"></a><span id="l11.1899">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1900"></a><span id="l11.1900" class="difflineminus">-          this.mZoomFactor = val;</span>
<a href="#l11.1901"></a><span id="l11.1901" class="difflineminus">-          return val;</span>
<a href="#l11.1902"></a><span id="l11.1902" class="difflineplus">+            this.mZoomFactor = val;</span>
<a href="#l11.1903"></a><span id="l11.1903" class="difflineplus">+            return val;</span>
<a href="#l11.1904"></a><span id="l11.1904">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.1905"></a><span id="l11.1905">       &lt;/property&gt;</span>
<a href="#l11.1906"></a><span id="l11.1906"> </span>
<a href="#l11.1907"></a><span id="l11.1907">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l11.1908"></a><span id="l11.1908">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.1909"></a><span id="l11.1909" class="difflineminus">-          return this.mForce24Hours;</span>
<a href="#l11.1910"></a><span id="l11.1910" class="difflineplus">+            return this.mForce24Hours;</span>
<a href="#l11.1911"></a><span id="l11.1911">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.1912"></a><span id="l11.1912">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1913"></a><span id="l11.1913" class="difflineminus">-          this.mForce24Hours = val;</span>
<a href="#l11.1914"></a><span id="l11.1914" class="difflineminus">-          this.initTimeRange();</span>
<a href="#l11.1915"></a><span id="l11.1915" class="difflineminus">-          this.update();</span>
<a href="#l11.1916"></a><span id="l11.1916" class="difflineminus">-          return val;</span>
<a href="#l11.1917"></a><span id="l11.1917" class="difflineplus">+            this.mForce24Hours = val;</span>
<a href="#l11.1918"></a><span id="l11.1918" class="difflineplus">+            this.initTimeRange();</span>
<a href="#l11.1919"></a><span id="l11.1919" class="difflineplus">+            this.update();</span>
<a href="#l11.1920"></a><span id="l11.1920" class="difflineplus">+            return val;</span>
<a href="#l11.1921"></a><span id="l11.1921">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.1922"></a><span id="l11.1922">       &lt;/property&gt;</span>
<a href="#l11.1923"></a><span id="l11.1923"> </span>
<a href="#l11.1924"></a><span id="l11.1924">       &lt;property name=&quot;ratio&quot;&gt;</span>
<a href="#l11.1925"></a><span id="l11.1925">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1926"></a><span id="l11.1926" class="difflineminus">-          this.mRatio = val;</span>
<a href="#l11.1927"></a><span id="l11.1927" class="difflineminus">-          this.update();</span>
<a href="#l11.1928"></a><span id="l11.1928" class="difflineminus">-          return val;</span>
<a href="#l11.1929"></a><span id="l11.1929" class="difflineplus">+            this.mRatio = val;</span>
<a href="#l11.1930"></a><span id="l11.1930" class="difflineplus">+            this.update();</span>
<a href="#l11.1931"></a><span id="l11.1931" class="difflineplus">+            return val;</span>
<a href="#l11.1932"></a><span id="l11.1932">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.1933"></a><span id="l11.1933">       &lt;/property&gt;</span>
<a href="#l11.1934"></a><span id="l11.1934"> </span>
<a href="#l11.1935"></a><span id="l11.1935">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l11.1936"></a><span id="l11.1936" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l11.1937"></a><span id="l11.1937" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.1938"></a><span id="l11.1938" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l11.1939"></a><span id="l11.1939" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.1940"></a><span id="l11.1940"> </span>
<a href="#l11.1941"></a><span id="l11.1941" class="difflineminus">-        this.initTimeRange();</span>
<a href="#l11.1942"></a><span id="l11.1942" class="difflineplus">+          this.initTimeRange();</span>
<a href="#l11.1943"></a><span id="l11.1943"> </span>
<a href="#l11.1944"></a><span id="l11.1944" class="difflineminus">-        // The basedate is the date/time from which the display</span>
<a href="#l11.1945"></a><span id="l11.1945" class="difflineminus">-        // of the timebar starts. The range is the number of days</span>
<a href="#l11.1946"></a><span id="l11.1946" class="difflineminus">-        // we should be able to show. the start- and enddate</span>
<a href="#l11.1947"></a><span id="l11.1947" class="difflineminus">-        // is the time the event is scheduled for.</span>
<a href="#l11.1948"></a><span id="l11.1948" class="difflineminus">-        this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l11.1949"></a><span id="l11.1949" class="difflineminus">-        this.mSelectionbar =</span>
<a href="#l11.1950"></a><span id="l11.1950" class="difflineminus">-            document.getAnonymousElementByAttribute(</span>
<a href="#l11.1951"></a><span id="l11.1951" class="difflineminus">-                this, &quot;anonid&quot;, &quot;selection-bar&quot;);</span>
<a href="#l11.1952"></a><span id="l11.1952" class="difflineplus">+          // The basedate is the date/time from which the display</span>
<a href="#l11.1953"></a><span id="l11.1953" class="difflineplus">+          // of the timebar starts. The range is the number of days</span>
<a href="#l11.1954"></a><span id="l11.1954" class="difflineplus">+          // we should be able to show. the start- and enddate</span>
<a href="#l11.1955"></a><span id="l11.1955" class="difflineplus">+          // is the time the event is scheduled for.</span>
<a href="#l11.1956"></a><span id="l11.1956" class="difflineplus">+          this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l11.1957"></a><span id="l11.1957" class="difflineplus">+          this.mSelectionbar =</span>
<a href="#l11.1958"></a><span id="l11.1958" class="difflineplus">+              document.getAnonymousElementByAttribute(</span>
<a href="#l11.1959"></a><span id="l11.1959" class="difflineplus">+                  this, &quot;anonid&quot;, &quot;selection-bar&quot;);</span>
<a href="#l11.1960"></a><span id="l11.1960">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l11.1961"></a><span id="l11.1961"> </span>
<a href="#l11.1962"></a><span id="l11.1962">       &lt;property name=&quot;baseDate&quot;&gt;</span>
<a href="#l11.1963"></a><span id="l11.1963">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1964"></a><span id="l11.1964" class="difflineminus">-          // we need to convert the date/time in question in</span>
<a href="#l11.1965"></a><span id="l11.1965" class="difflineminus">-          // order to calculate with hours that are aligned</span>
<a href="#l11.1966"></a><span id="l11.1966" class="difflineminus">-          // with our timebar display.</span>
<a href="#l11.1967"></a><span id="l11.1967" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.1968"></a><span id="l11.1968" class="difflineminus">-          this.mBaseDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.1969"></a><span id="l11.1969" class="difflineminus">-          this.mBaseDate.isDate = true;</span>
<a href="#l11.1970"></a><span id="l11.1970" class="difflineminus">-          this.mBaseDate.makeImmutable();</span>
<a href="#l11.1971"></a><span id="l11.1971" class="difflineminus">-          return val;</span>
<a href="#l11.1972"></a><span id="l11.1972" class="difflineplus">+            // we need to convert the date/time in question in</span>
<a href="#l11.1973"></a><span id="l11.1973" class="difflineplus">+            // order to calculate with hours that are aligned</span>
<a href="#l11.1974"></a><span id="l11.1974" class="difflineplus">+            // with our timebar display.</span>
<a href="#l11.1975"></a><span id="l11.1975" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.1976"></a><span id="l11.1976" class="difflineplus">+            this.mBaseDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.1977"></a><span id="l11.1977" class="difflineplus">+            this.mBaseDate.isDate = true;</span>
<a href="#l11.1978"></a><span id="l11.1978" class="difflineplus">+            this.mBaseDate.makeImmutable();</span>
<a href="#l11.1979"></a><span id="l11.1979" class="difflineplus">+            return val;</span>
<a href="#l11.1980"></a><span id="l11.1980">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.1981"></a><span id="l11.1981">       &lt;/property&gt;</span>
<a href="#l11.1982"></a><span id="l11.1982"> </span>
<a href="#l11.1983"></a><span id="l11.1983">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l11.1984"></a><span id="l11.1984">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.1985"></a><span id="l11.1985" class="difflineminus">-          // currently we *always* set the basedate to be</span>
<a href="#l11.1986"></a><span id="l11.1986" class="difflineminus">-          // equal to the startdate. we'll most probably</span>
<a href="#l11.1987"></a><span id="l11.1987" class="difflineminus">-          // want to change this later.</span>
<a href="#l11.1988"></a><span id="l11.1988" class="difflineminus">-          this.baseDate = val;</span>
<a href="#l11.1989"></a><span id="l11.1989" class="difflineminus">-          // we need to convert the date/time in question in</span>
<a href="#l11.1990"></a><span id="l11.1990" class="difflineminus">-          // order to calculate with hours that are aligned</span>
<a href="#l11.1991"></a><span id="l11.1991" class="difflineminus">-          // with our timebar display.</span>
<a href="#l11.1992"></a><span id="l11.1992" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.1993"></a><span id="l11.1993" class="difflineminus">-          this.mStartDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.1994"></a><span id="l11.1994" class="difflineminus">-          this.mStartDate.makeImmutable();</span>
<a href="#l11.1995"></a><span id="l11.1995" class="difflineminus">-          return val;</span>
<a href="#l11.1996"></a><span id="l11.1996" class="difflineplus">+            // currently we *always* set the basedate to be</span>
<a href="#l11.1997"></a><span id="l11.1997" class="difflineplus">+            // equal to the startdate. we'll most probably</span>
<a href="#l11.1998"></a><span id="l11.1998" class="difflineplus">+            // want to change this later.</span>
<a href="#l11.1999"></a><span id="l11.1999" class="difflineplus">+            this.baseDate = val;</span>
<a href="#l11.2000"></a><span id="l11.2000" class="difflineplus">+            // we need to convert the date/time in question in</span>
<a href="#l11.2001"></a><span id="l11.2001" class="difflineplus">+            // order to calculate with hours that are aligned</span>
<a href="#l11.2002"></a><span id="l11.2002" class="difflineplus">+            // with our timebar display.</span>
<a href="#l11.2003"></a><span id="l11.2003" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.2004"></a><span id="l11.2004" class="difflineplus">+            this.mStartDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.2005"></a><span id="l11.2005" class="difflineplus">+            this.mStartDate.makeImmutable();</span>
<a href="#l11.2006"></a><span id="l11.2006" class="difflineplus">+            return val;</span>
<a href="#l11.2007"></a><span id="l11.2007">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.2008"></a><span id="l11.2008">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.2009"></a><span id="l11.2009" class="difflineminus">-          return this.mStartDate;</span>
<a href="#l11.2010"></a><span id="l11.2010" class="difflineplus">+            return this.mStartDate;</span>
<a href="#l11.2011"></a><span id="l11.2011">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.2012"></a><span id="l11.2012">       &lt;/property&gt;</span>
<a href="#l11.2013"></a><span id="l11.2013"> </span>
<a href="#l11.2014"></a><span id="l11.2014">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l11.2015"></a><span id="l11.2015">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.2016"></a><span id="l11.2016" class="difflineminus">-          // we need to convert the date/time in question in</span>
<a href="#l11.2017"></a><span id="l11.2017" class="difflineminus">-          // order to calculate with hours that are aligned</span>
<a href="#l11.2018"></a><span id="l11.2018" class="difflineminus">-          // with our timebar display.</span>
<a href="#l11.2019"></a><span id="l11.2019" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.2020"></a><span id="l11.2020" class="difflineminus">-          this.mEndDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.2021"></a><span id="l11.2021" class="difflineminus">-          if (this.mEndDate.isDate) {</span>
<a href="#l11.2022"></a><span id="l11.2022" class="difflineminus">-              this.mEndDate.day += 1;</span>
<a href="#l11.2023"></a><span id="l11.2023" class="difflineminus">-          }</span>
<a href="#l11.2024"></a><span id="l11.2024" class="difflineminus">-          this.mEndDate.makeImmutable();</span>
<a href="#l11.2025"></a><span id="l11.2025" class="difflineminus">-          return val;</span>
<a href="#l11.2026"></a><span id="l11.2026" class="difflineplus">+            // we need to convert the date/time in question in</span>
<a href="#l11.2027"></a><span id="l11.2027" class="difflineplus">+            // order to calculate with hours that are aligned</span>
<a href="#l11.2028"></a><span id="l11.2028" class="difflineplus">+            // with our timebar display.</span>
<a href="#l11.2029"></a><span id="l11.2029" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l11.2030"></a><span id="l11.2030" class="difflineplus">+            this.mEndDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.2031"></a><span id="l11.2031" class="difflineplus">+            if (this.mEndDate.isDate) {</span>
<a href="#l11.2032"></a><span id="l11.2032" class="difflineplus">+                this.mEndDate.day += 1;</span>
<a href="#l11.2033"></a><span id="l11.2033" class="difflineplus">+            }</span>
<a href="#l11.2034"></a><span id="l11.2034" class="difflineplus">+            this.mEndDate.makeImmutable();</span>
<a href="#l11.2035"></a><span id="l11.2035" class="difflineplus">+            return val;</span>
<a href="#l11.2036"></a><span id="l11.2036">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.2037"></a><span id="l11.2037">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.2038"></a><span id="l11.2038" class="difflineminus">-          return this.mEndDate;</span>
<a href="#l11.2039"></a><span id="l11.2039" class="difflineplus">+            return this.mEndDate;</span>
<a href="#l11.2040"></a><span id="l11.2040">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.2041"></a><span id="l11.2041">       &lt;/property&gt;</span>
<a href="#l11.2042"></a><span id="l11.2042"> </span>
<a href="#l11.2043"></a><span id="l11.2043">       &lt;property name=&quot;leftdragWidth&quot;&gt;</span>
<a href="#l11.2044"></a><span id="l11.2044">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.2045"></a><span id="l11.2045" class="difflineminus">-          if (!this.mLeftBox) {</span>
<a href="#l11.2046"></a><span id="l11.2046" class="difflineminus">-              this.mLeftBox =</span>
<a href="#l11.2047"></a><span id="l11.2047" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.2048"></a><span id="l11.2048" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;leftbox&quot;);</span>
<a href="#l11.2049"></a><span id="l11.2049" class="difflineminus">-          }</span>
<a href="#l11.2050"></a><span id="l11.2050" class="difflineminus">-          return this.mLeftBox.boxObject.width;</span>
<a href="#l11.2051"></a><span id="l11.2051" class="difflineplus">+            if (!this.mLeftBox) {</span>
<a href="#l11.2052"></a><span id="l11.2052" class="difflineplus">+                this.mLeftBox =</span>
<a href="#l11.2053"></a><span id="l11.2053" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.2054"></a><span id="l11.2054" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;leftbox&quot;);</span>
<a href="#l11.2055"></a><span id="l11.2055" class="difflineplus">+            }</span>
<a href="#l11.2056"></a><span id="l11.2056" class="difflineplus">+            return this.mLeftBox.boxObject.width;</span>
<a href="#l11.2057"></a><span id="l11.2057">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.2058"></a><span id="l11.2058">       &lt;/property&gt;</span>
<a href="#l11.2059"></a><span id="l11.2059">       &lt;property name=&quot;rightdragWidth&quot;&gt;</span>
<a href="#l11.2060"></a><span id="l11.2060">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.2061"></a><span id="l11.2061" class="difflineminus">-          if (!this.mRightBox) {</span>
<a href="#l11.2062"></a><span id="l11.2062" class="difflineminus">-              this.mRightBox =</span>
<a href="#l11.2063"></a><span id="l11.2063" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l11.2064"></a><span id="l11.2064" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;rightbox&quot;);</span>
<a href="#l11.2065"></a><span id="l11.2065" class="difflineminus">-          }</span>
<a href="#l11.2066"></a><span id="l11.2066" class="difflineminus">-          return this.mRightBox.boxObject.width;</span>
<a href="#l11.2067"></a><span id="l11.2067" class="difflineplus">+            if (!this.mRightBox) {</span>
<a href="#l11.2068"></a><span id="l11.2068" class="difflineplus">+                this.mRightBox =</span>
<a href="#l11.2069"></a><span id="l11.2069" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l11.2070"></a><span id="l11.2070" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;rightbox&quot;);</span>
<a href="#l11.2071"></a><span id="l11.2071" class="difflineplus">+            }</span>
<a href="#l11.2072"></a><span id="l11.2072" class="difflineplus">+            return this.mRightBox.boxObject.width;</span>
<a href="#l11.2073"></a><span id="l11.2073">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.2074"></a><span id="l11.2074">       &lt;/property&gt;</span>
<a href="#l11.2075"></a><span id="l11.2075"> </span>
<a href="#l11.2076"></a><span id="l11.2076">       &lt;method name=&quot;init&quot;&gt;</span>
<a href="#l11.2077"></a><span id="l11.2077">         &lt;parameter name=&quot;width&quot;/&gt;</span>
<a href="#l11.2078"></a><span id="l11.2078">         &lt;parameter name=&quot;height&quot;/&gt;</span>
<a href="#l11.2079"></a><span id="l11.2079">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2080"></a><span id="l11.2080" class="difflineminus">-          this.mContentWidth = width;</span>
<a href="#l11.2081"></a><span id="l11.2081" class="difflineminus">-          this.mHeaderHeight = height + 2;</span>
<a href="#l11.2082"></a><span id="l11.2082" class="difflineminus">-          this.mMargin = 0;</span>
<a href="#l11.2083"></a><span id="l11.2083" class="difflineminus">-          this.update();</span>
<a href="#l11.2084"></a><span id="l11.2084" class="difflineplus">+            this.mContentWidth = width;</span>
<a href="#l11.2085"></a><span id="l11.2085" class="difflineplus">+            this.mHeaderHeight = height + 2;</span>
<a href="#l11.2086"></a><span id="l11.2086" class="difflineplus">+            this.mMargin = 0;</span>
<a href="#l11.2087"></a><span id="l11.2087" class="difflineplus">+            this.update();</span>
<a href="#l11.2088"></a><span id="l11.2088">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2089"></a><span id="l11.2089">       &lt;/method&gt;</span>
<a href="#l11.2090"></a><span id="l11.2090"> </span>
<a href="#l11.2091"></a><span id="l11.2091">       &lt;!-- given some specific date this method calculates the</span>
<a href="#l11.2092"></a><span id="l11.2092">            corrposonding offset in fractional hours --&gt;</span>
<a href="#l11.2093"></a><span id="l11.2093">       &lt;method name=&quot;date2offset&quot;&gt;</span>
<a href="#l11.2094"></a><span id="l11.2094">         &lt;parameter name=&quot;date&quot;/&gt;</span>
<a href="#l11.2095"></a><span id="l11.2095">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2096"></a><span id="l11.2096" class="difflineminus">-          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2097"></a><span id="l11.2097" class="difflineminus">-          let diff = date.subtractDate(this.mBaseDate);</span>
<a href="#l11.2098"></a><span id="l11.2098" class="difflineminus">-          let offset = diff.days * num_hours;</span>
<a href="#l11.2099"></a><span id="l11.2099" class="difflineminus">-          let hours = (diff.hours - this.mStartHour) + (diff.minutes / 60.0);</span>
<a href="#l11.2100"></a><span id="l11.2100" class="difflineminus">-          if (hours &lt; 0) {</span>
<a href="#l11.2101"></a><span id="l11.2101" class="difflineminus">-              hours = 0;</span>
<a href="#l11.2102"></a><span id="l11.2102" class="difflineminus">-          }</span>
<a href="#l11.2103"></a><span id="l11.2103" class="difflineminus">-          if (hours &gt; num_hours) {</span>
<a href="#l11.2104"></a><span id="l11.2104" class="difflineminus">-              hours = num_hours;</span>
<a href="#l11.2105"></a><span id="l11.2105" class="difflineminus">-          }</span>
<a href="#l11.2106"></a><span id="l11.2106" class="difflineminus">-          offset += hours;</span>
<a href="#l11.2107"></a><span id="l11.2107" class="difflineminus">-          return offset;</span>
<a href="#l11.2108"></a><span id="l11.2108" class="difflineplus">+            let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2109"></a><span id="l11.2109" class="difflineplus">+            let diff = date.subtractDate(this.mBaseDate);</span>
<a href="#l11.2110"></a><span id="l11.2110" class="difflineplus">+            let offset = diff.days * num_hours;</span>
<a href="#l11.2111"></a><span id="l11.2111" class="difflineplus">+            let hours = (diff.hours - this.mStartHour) + (diff.minutes / 60.0);</span>
<a href="#l11.2112"></a><span id="l11.2112" class="difflineplus">+            if (hours &lt; 0) {</span>
<a href="#l11.2113"></a><span id="l11.2113" class="difflineplus">+                hours = 0;</span>
<a href="#l11.2114"></a><span id="l11.2114" class="difflineplus">+            }</span>
<a href="#l11.2115"></a><span id="l11.2115" class="difflineplus">+            if (hours &gt; num_hours) {</span>
<a href="#l11.2116"></a><span id="l11.2116" class="difflineplus">+                hours = num_hours;</span>
<a href="#l11.2117"></a><span id="l11.2117" class="difflineplus">+            }</span>
<a href="#l11.2118"></a><span id="l11.2118" class="difflineplus">+            offset += hours;</span>
<a href="#l11.2119"></a><span id="l11.2119" class="difflineplus">+            return offset;</span>
<a href="#l11.2120"></a><span id="l11.2120">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2121"></a><span id="l11.2121">       &lt;/method&gt;</span>
<a href="#l11.2122"></a><span id="l11.2122"> </span>
<a href="#l11.2123"></a><span id="l11.2123">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l11.2124"></a><span id="l11.2124">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2125"></a><span id="l11.2125" class="difflineminus">-          if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l11.2126"></a><span id="l11.2126" class="difflineminus">-              return;</span>
<a href="#l11.2127"></a><span id="l11.2127" class="difflineminus">-          }</span>
<a href="#l11.2128"></a><span id="l11.2128" class="difflineplus">+            if (!this.mStartDate || !this.mEndDate) {</span>
<a href="#l11.2129"></a><span id="l11.2129" class="difflineplus">+                return;</span>
<a href="#l11.2130"></a><span id="l11.2130" class="difflineplus">+            }</span>
<a href="#l11.2131"></a><span id="l11.2131"> </span>
<a href="#l11.2132"></a><span id="l11.2132" class="difflineminus">-          // Calculate the relation of startdate/basedate and enddate/startdate.</span>
<a href="#l11.2133"></a><span id="l11.2133" class="difflineminus">-          let offset = this.mStartDate.subtractDate(this.mBaseDate);</span>
<a href="#l11.2134"></a><span id="l11.2134" class="difflineplus">+            // Calculate the relation of startdate/basedate and enddate/startdate.</span>
<a href="#l11.2135"></a><span id="l11.2135" class="difflineplus">+            let offset = this.mStartDate.subtractDate(this.mBaseDate);</span>
<a href="#l11.2136"></a><span id="l11.2136"> </span>
<a href="#l11.2137"></a><span id="l11.2137" class="difflineminus">-          // Calculate how much pixels a single hour and a single day take up.</span>
<a href="#l11.2138"></a><span id="l11.2138" class="difflineminus">-          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2139"></a><span id="l11.2139" class="difflineminus">-          let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l11.2140"></a><span id="l11.2140" class="difflineplus">+            // Calculate how much pixels a single hour and a single day take up.</span>
<a href="#l11.2141"></a><span id="l11.2141" class="difflineplus">+            let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2142"></a><span id="l11.2142" class="difflineplus">+            let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l11.2143"></a><span id="l11.2143"> </span>
<a href="#l11.2144"></a><span id="l11.2144" class="difflineminus">-          // Calculate the offset in fractional hours that corrospond</span>
<a href="#l11.2145"></a><span id="l11.2145" class="difflineminus">-          // to our start- and end-time.</span>
<a href="#l11.2146"></a><span id="l11.2146" class="difflineminus">-          let start_offset_in_hours = this.date2offset(this.mStartDate);</span>
<a href="#l11.2147"></a><span id="l11.2147" class="difflineminus">-          let end_offset_in_hours = this.date2offset(this.mEndDate);</span>
<a href="#l11.2148"></a><span id="l11.2148" class="difflineminus">-          let duration_in_hours = end_offset_in_hours - start_offset_in_hours;</span>
<a href="#l11.2149"></a><span id="l11.2149" class="difflineplus">+            // Calculate the offset in fractional hours that corrospond</span>
<a href="#l11.2150"></a><span id="l11.2150" class="difflineplus">+            // to our start- and end-time.</span>
<a href="#l11.2151"></a><span id="l11.2151" class="difflineplus">+            let start_offset_in_hours = this.date2offset(this.mStartDate);</span>
<a href="#l11.2152"></a><span id="l11.2152" class="difflineplus">+            let end_offset_in_hours = this.date2offset(this.mEndDate);</span>
<a href="#l11.2153"></a><span id="l11.2153" class="difflineplus">+            let duration_in_hours = end_offset_in_hours - start_offset_in_hours;</span>
<a href="#l11.2154"></a><span id="l11.2154"> </span>
<a href="#l11.2155"></a><span id="l11.2155" class="difflineminus">-          // Calculate width &amp; margin for the selection bar based on the</span>
<a href="#l11.2156"></a><span id="l11.2156" class="difflineminus">-          // relation of startdate/basedate and enddate/startdate.</span>
<a href="#l11.2157"></a><span id="l11.2157" class="difflineminus">-          // This is a simple conversion from hours to pixels.</span>
<a href="#l11.2158"></a><span id="l11.2158" class="difflineminus">-          this.mWidth = duration_in_hours * hour_width;</span>
<a href="#l11.2159"></a><span id="l11.2159" class="difflineminus">-          let totaldragwidths = this.leftdragWidth + this.rightdragWidth;</span>
<a href="#l11.2160"></a><span id="l11.2160" class="difflineminus">-          if (this.mWidth &lt; totaldragwidths) {</span>
<a href="#l11.2161"></a><span id="l11.2161" class="difflineminus">-              this.mWidth = totaldragwidths;</span>
<a href="#l11.2162"></a><span id="l11.2162" class="difflineminus">-          }</span>
<a href="#l11.2163"></a><span id="l11.2163" class="difflineminus">-          this.mMargin = start_offset_in_hours * hour_width;</span>
<a href="#l11.2164"></a><span id="l11.2164" class="difflineplus">+            // Calculate width &amp; margin for the selection bar based on the</span>
<a href="#l11.2165"></a><span id="l11.2165" class="difflineplus">+            // relation of startdate/basedate and enddate/startdate.</span>
<a href="#l11.2166"></a><span id="l11.2166" class="difflineplus">+            // This is a simple conversion from hours to pixels.</span>
<a href="#l11.2167"></a><span id="l11.2167" class="difflineplus">+            this.mWidth = duration_in_hours * hour_width;</span>
<a href="#l11.2168"></a><span id="l11.2168" class="difflineplus">+            let totaldragwidths = this.leftdragWidth + this.rightdragWidth;</span>
<a href="#l11.2169"></a><span id="l11.2169" class="difflineplus">+            if (this.mWidth &lt; totaldragwidths) {</span>
<a href="#l11.2170"></a><span id="l11.2170" class="difflineplus">+                this.mWidth = totaldragwidths;</span>
<a href="#l11.2171"></a><span id="l11.2171" class="difflineplus">+            }</span>
<a href="#l11.2172"></a><span id="l11.2172" class="difflineplus">+            this.mMargin = start_offset_in_hours * hour_width;</span>
<a href="#l11.2173"></a><span id="l11.2173"> </span>
<a href="#l11.2174"></a><span id="l11.2174" class="difflineminus">-          // Calculate the difference between content and container in pixels.</span>
<a href="#l11.2175"></a><span id="l11.2175" class="difflineminus">-          // The container is the window showing this control, the content is the</span>
<a href="#l11.2176"></a><span id="l11.2176" class="difflineminus">-          // total number of pixels the selection bar can theoretically take up.</span>
<a href="#l11.2177"></a><span id="l11.2177" class="difflineminus">-          let total_width = this.mContentWidth * this.mRange - this.parentNode.boxObject.width;</span>
<a href="#l11.2178"></a><span id="l11.2178" class="difflineplus">+            // Calculate the difference between content and container in pixels.</span>
<a href="#l11.2179"></a><span id="l11.2179" class="difflineplus">+            // The container is the window showing this control, the content is the</span>
<a href="#l11.2180"></a><span id="l11.2180" class="difflineplus">+            // total number of pixels the selection bar can theoretically take up.</span>
<a href="#l11.2181"></a><span id="l11.2181" class="difflineplus">+            let total_width = this.mContentWidth * this.mRange - this.parentNode.boxObject.width;</span>
<a href="#l11.2182"></a><span id="l11.2182"> </span>
<a href="#l11.2183"></a><span id="l11.2183" class="difflineminus">-          // Calculate the current scroll offset.</span>
<a href="#l11.2184"></a><span id="l11.2184" class="difflineminus">-          offset = Math.floor(total_width * this.mRatio);</span>
<a href="#l11.2185"></a><span id="l11.2185" class="difflineplus">+            // Calculate the current scroll offset.</span>
<a href="#l11.2186"></a><span id="l11.2186" class="difflineplus">+            offset = Math.floor(total_width * this.mRatio);</span>
<a href="#l11.2187"></a><span id="l11.2187"> </span>
<a href="#l11.2188"></a><span id="l11.2188" class="difflineminus">-          // The final margin is the difference between the date-based margin</span>
<a href="#l11.2189"></a><span id="l11.2189" class="difflineminus">-          // and the scroll-based margin.</span>
<a href="#l11.2190"></a><span id="l11.2190" class="difflineminus">-          this.mMargin -= offset;</span>
<a href="#l11.2191"></a><span id="l11.2191" class="difflineplus">+            // The final margin is the difference between the date-based margin</span>
<a href="#l11.2192"></a><span id="l11.2192" class="difflineplus">+            // and the scroll-based margin.</span>
<a href="#l11.2193"></a><span id="l11.2193" class="difflineplus">+            this.mMargin -= offset;</span>
<a href="#l11.2194"></a><span id="l11.2194"> </span>
<a href="#l11.2195"></a><span id="l11.2195" class="difflineminus">-          // Set the styles based on the calculations above for the 'selection-bar'.</span>
<a href="#l11.2196"></a><span id="l11.2196" class="difflineminus">-          let style = &quot;width: &quot; + this.mWidth +</span>
<a href="#l11.2197"></a><span id="l11.2197" class="difflineminus">-                      &quot;px; margin-inline-start: &quot; + this.mMargin +</span>
<a href="#l11.2198"></a><span id="l11.2198" class="difflineminus">-                      &quot;px; margin-top: &quot; + this.mHeaderHeight + &quot;px;&quot;;</span>
<a href="#l11.2199"></a><span id="l11.2199" class="difflineminus">-          this.mSelectionbar.setAttribute(&quot;style&quot;, style);</span>
<a href="#l11.2200"></a><span id="l11.2200" class="difflineplus">+            // Set the styles based on the calculations above for the 'selection-bar'.</span>
<a href="#l11.2201"></a><span id="l11.2201" class="difflineplus">+            let style = &quot;width: &quot; + this.mWidth +</span>
<a href="#l11.2202"></a><span id="l11.2202" class="difflineplus">+                        &quot;px; margin-inline-start: &quot; + this.mMargin +</span>
<a href="#l11.2203"></a><span id="l11.2203" class="difflineplus">+                        &quot;px; margin-top: &quot; + this.mHeaderHeight + &quot;px;&quot;;</span>
<a href="#l11.2204"></a><span id="l11.2204" class="difflineplus">+            this.mSelectionbar.setAttribute(&quot;style&quot;, style);</span>
<a href="#l11.2205"></a><span id="l11.2205"> </span>
<a href="#l11.2206"></a><span id="l11.2206" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.2207"></a><span id="l11.2207" class="difflineminus">-          event.initEvent(&quot;timechange&quot;, true, false);</span>
<a href="#l11.2208"></a><span id="l11.2208" class="difflineminus">-          event.startDate = this.mStartDate;</span>
<a href="#l11.2209"></a><span id="l11.2209" class="difflineminus">-          event.endDate = this.mEndDate.clone();</span>
<a href="#l11.2210"></a><span id="l11.2210" class="difflineminus">-          if (event.endDate.isDate) {</span>
<a href="#l11.2211"></a><span id="l11.2211" class="difflineminus">-              event.endDate.day--;</span>
<a href="#l11.2212"></a><span id="l11.2212" class="difflineminus">-          }</span>
<a href="#l11.2213"></a><span id="l11.2213" class="difflineminus">-          event.endDate.makeImmutable();</span>
<a href="#l11.2214"></a><span id="l11.2214" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l11.2215"></a><span id="l11.2215" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l11.2216"></a><span id="l11.2216" class="difflineplus">+            event.initEvent(&quot;timechange&quot;, true, false);</span>
<a href="#l11.2217"></a><span id="l11.2217" class="difflineplus">+            event.startDate = this.mStartDate;</span>
<a href="#l11.2218"></a><span id="l11.2218" class="difflineplus">+            event.endDate = this.mEndDate.clone();</span>
<a href="#l11.2219"></a><span id="l11.2219" class="difflineplus">+            if (event.endDate.isDate) {</span>
<a href="#l11.2220"></a><span id="l11.2220" class="difflineplus">+                event.endDate.day--;</span>
<a href="#l11.2221"></a><span id="l11.2221" class="difflineplus">+            }</span>
<a href="#l11.2222"></a><span id="l11.2222" class="difflineplus">+            event.endDate.makeImmutable();</span>
<a href="#l11.2223"></a><span id="l11.2223" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l11.2224"></a><span id="l11.2224">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2225"></a><span id="l11.2225">       &lt;/method&gt;</span>
<a href="#l11.2226"></a><span id="l11.2226"> </span>
<a href="#l11.2227"></a><span id="l11.2227">       &lt;method name=&quot;setWidth&quot;&gt;</span>
<a href="#l11.2228"></a><span id="l11.2228">         &lt;parameter name=&quot;width&quot;/&gt;</span>
<a href="#l11.2229"></a><span id="l11.2229">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2230"></a><span id="l11.2230">             let scrollbox =</span>
<a href="#l11.2231"></a><span id="l11.2231">                 document.getAnonymousElementByAttribute(</span>
<a href="#l11.2232"></a><span id="l11.2232">                     this, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l11.2233"></a><span id="l11.2233">             scrollbox.setAttribute(&quot;width&quot;, width);</span>
<a href="#l11.2234"></a><span id="l11.2234">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2235"></a><span id="l11.2235">       &lt;/method&gt;</span>
<a href="#l11.2236"></a><span id="l11.2236"> </span>
<a href="#l11.2237"></a><span id="l11.2237">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l11.2238"></a><span id="l11.2238">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2239"></a><span id="l11.2239" class="difflineminus">-          if (this.force24Hours) {</span>
<a href="#l11.2240"></a><span id="l11.2240" class="difflineminus">-              this.mStartHour = 0;</span>
<a href="#l11.2241"></a><span id="l11.2241" class="difflineminus">-              this.mEndHour = 24;</span>
<a href="#l11.2242"></a><span id="l11.2242" class="difflineminus">-          } else {</span>
<a href="#l11.2243"></a><span id="l11.2243" class="difflineminus">-              this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l11.2244"></a><span id="l11.2244" class="difflineminus">-              this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l11.2245"></a><span id="l11.2245" class="difflineminus">-          }</span>
<a href="#l11.2246"></a><span id="l11.2246" class="difflineplus">+            if (this.force24Hours) {</span>
<a href="#l11.2247"></a><span id="l11.2247" class="difflineplus">+                this.mStartHour = 0;</span>
<a href="#l11.2248"></a><span id="l11.2248" class="difflineplus">+                this.mEndHour = 24;</span>
<a href="#l11.2249"></a><span id="l11.2249" class="difflineplus">+            } else {</span>
<a href="#l11.2250"></a><span id="l11.2250" class="difflineplus">+                this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l11.2251"></a><span id="l11.2251" class="difflineplus">+                this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l11.2252"></a><span id="l11.2252" class="difflineplus">+            }</span>
<a href="#l11.2253"></a><span id="l11.2253">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2254"></a><span id="l11.2254">       &lt;/method&gt;</span>
<a href="#l11.2255"></a><span id="l11.2255"> </span>
<a href="#l11.2256"></a><span id="l11.2256">       &lt;method name=&quot;moveTime&quot;&gt;</span>
<a href="#l11.2257"></a><span id="l11.2257">         &lt;parameter name=&quot;time&quot;/&gt;</span>
<a href="#l11.2258"></a><span id="l11.2258">         &lt;parameter name=&quot;delta&quot;/&gt;</span>
<a href="#l11.2259"></a><span id="l11.2259">         &lt;parameter name=&quot;doclip&quot;/&gt;</span>
<a href="#l11.2260"></a><span id="l11.2260">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.2261"></a><span id="l11.2261" class="difflineminus">-          let newTime = time.clone();</span>
<a href="#l11.2262"></a><span id="l11.2262" class="difflineminus">-          let clip_minutes = 60 * this.zoomFactor / 100;</span>
<a href="#l11.2263"></a><span id="l11.2263" class="difflineminus">-          if (newTime.isDate) {</span>
<a href="#l11.2264"></a><span id="l11.2264" class="difflineminus">-              clip_minutes = 60 * 24;</span>
<a href="#l11.2265"></a><span id="l11.2265" class="difflineminus">-          }</span>
<a href="#l11.2266"></a><span id="l11.2266" class="difflineminus">-          let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2267"></a><span id="l11.2267" class="difflineminus">-          let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l11.2268"></a><span id="l11.2268" class="difflineminus">-          let minutes_per_pixel = 60 / hour_width;</span>
<a href="#l11.2269"></a><span id="l11.2269" class="difflineminus">-          let minute_shift = minutes_per_pixel * delta;</span>
<a href="#l11.2270"></a><span id="l11.2270" class="difflineminus">-          let isClipped = Math.abs(minute_shift) &gt;= (this.mfClipRatio * clip_minutes);</span>
<a href="#l11.2271"></a><span id="l11.2271" class="difflineminus">-          if (isClipped) {</span>
<a href="#l11.2272"></a><span id="l11.2272" class="difflineminus">-              if (delta &gt; 0) {</span>
<a href="#l11.2273"></a><span id="l11.2273" class="difflineminus">-                  if (time.isDate) {</span>
<a href="#l11.2274"></a><span id="l11.2274" class="difflineminus">-                      newTime.day++;</span>
<a href="#l11.2275"></a><span id="l11.2275" class="difflineminus">-                  } else {</span>
<a href="#l11.2276"></a><span id="l11.2276" class="difflineminus">-                      if (doclip) {</span>
<a href="#l11.2277"></a><span id="l11.2277" class="difflineminus">-                          newTime.minute -= newTime.minute % clip_minutes;</span>
<a href="#l11.2278"></a><span id="l11.2278" class="difflineminus">-                      }</span>
<a href="#l11.2279"></a><span id="l11.2279" class="difflineminus">-                      newTime.minute += clip_minutes;</span>
<a href="#l11.2280"></a><span id="l11.2280" class="difflineminus">-                  }</span>
<a href="#l11.2281"></a><span id="l11.2281" class="difflineminus">-              } else if (delta &lt; 0) {</span>
<a href="#l11.2282"></a><span id="l11.2282" class="difflineminus">-                  if (time.isDate) {</span>
<a href="#l11.2283"></a><span id="l11.2283" class="difflineminus">-                      newTime.day--;</span>
<a href="#l11.2284"></a><span id="l11.2284" class="difflineminus">-                  } else {</span>
<a href="#l11.2285"></a><span id="l11.2285" class="difflineminus">-                      if (doclip) {</span>
<a href="#l11.2286"></a><span id="l11.2286" class="difflineminus">-                          newTime.minute -= newTime.minute % clip_minutes;</span>
<a href="#l11.2287"></a><span id="l11.2287" class="difflineminus">-                      }</span>
<a href="#l11.2288"></a><span id="l11.2288" class="difflineminus">-                      newTime.minute -= clip_minutes;</span>
<a href="#l11.2289"></a><span id="l11.2289" class="difflineminus">-                  }</span>
<a href="#l11.2290"></a><span id="l11.2290" class="difflineminus">-              }</span>
<a href="#l11.2291"></a><span id="l11.2291" class="difflineminus">-          }</span>
<a href="#l11.2292"></a><span id="l11.2292" class="difflineplus">+            let newTime = time.clone();</span>
<a href="#l11.2293"></a><span id="l11.2293" class="difflineplus">+            let clip_minutes = 60 * this.zoomFactor / 100;</span>
<a href="#l11.2294"></a><span id="l11.2294" class="difflineplus">+            if (newTime.isDate) {</span>
<a href="#l11.2295"></a><span id="l11.2295" class="difflineplus">+                clip_minutes = 60 * 24;</span>
<a href="#l11.2296"></a><span id="l11.2296" class="difflineplus">+            }</span>
<a href="#l11.2297"></a><span id="l11.2297" class="difflineplus">+            let num_hours = this.mEndHour - this.mStartHour;</span>
<a href="#l11.2298"></a><span id="l11.2298" class="difflineplus">+            let hour_width = this.mContentWidth / num_hours;</span>
<a href="#l11.2299"></a><span id="l11.2299" class="difflineplus">+            let minutes_per_pixel = 60 / hour_width;</span>
<a href="#l11.2300"></a><span id="l11.2300" class="difflineplus">+            let minute_shift = minutes_per_pixel * delta;</span>
<a href="#l11.2301"></a><span id="l11.2301" class="difflineplus">+            let isClipped = Math.abs(minute_shift) &gt;= (this.mfClipRatio * clip_minutes);</span>
<a href="#l11.2302"></a><span id="l11.2302" class="difflineplus">+            if (isClipped) {</span>
<a href="#l11.2303"></a><span id="l11.2303" class="difflineplus">+                if (delta &gt; 0) {</span>
<a href="#l11.2304"></a><span id="l11.2304" class="difflineplus">+                    if (time.isDate) {</span>
<a href="#l11.2305"></a><span id="l11.2305" class="difflineplus">+                        newTime.day++;</span>
<a href="#l11.2306"></a><span id="l11.2306" class="difflineplus">+                    } else {</span>
<a href="#l11.2307"></a><span id="l11.2307" class="difflineplus">+                        if (doclip) {</span>
<a href="#l11.2308"></a><span id="l11.2308" class="difflineplus">+                            newTime.minute -= newTime.minute % clip_minutes;</span>
<a href="#l11.2309"></a><span id="l11.2309" class="difflineplus">+                        }</span>
<a href="#l11.2310"></a><span id="l11.2310" class="difflineplus">+                        newTime.minute += clip_minutes;</span>
<a href="#l11.2311"></a><span id="l11.2311" class="difflineplus">+                    }</span>
<a href="#l11.2312"></a><span id="l11.2312" class="difflineplus">+                } else if (delta &lt; 0) {</span>
<a href="#l11.2313"></a><span id="l11.2313" class="difflineplus">+                    if (time.isDate) {</span>
<a href="#l11.2314"></a><span id="l11.2314" class="difflineplus">+                        newTime.day--;</span>
<a href="#l11.2315"></a><span id="l11.2315" class="difflineplus">+                    } else {</span>
<a href="#l11.2316"></a><span id="l11.2316" class="difflineplus">+                        if (doclip) {</span>
<a href="#l11.2317"></a><span id="l11.2317" class="difflineplus">+                            newTime.minute -= newTime.minute % clip_minutes;</span>
<a href="#l11.2318"></a><span id="l11.2318" class="difflineplus">+                        }</span>
<a href="#l11.2319"></a><span id="l11.2319" class="difflineplus">+                        newTime.minute -= clip_minutes;</span>
<a href="#l11.2320"></a><span id="l11.2320" class="difflineplus">+                    }</span>
<a href="#l11.2321"></a><span id="l11.2321" class="difflineplus">+                }</span>
<a href="#l11.2322"></a><span id="l11.2322" class="difflineplus">+            }</span>
<a href="#l11.2323"></a><span id="l11.2323"> </span>
<a href="#l11.2324"></a><span id="l11.2324" class="difflineminus">-          if (!newTime.isDate) {</span>
<a href="#l11.2325"></a><span id="l11.2325" class="difflineminus">-              if (newTime.hour &lt; this.mStartHour) {</span>
<a href="#l11.2326"></a><span id="l11.2326" class="difflineminus">-                  newTime.hour = this.mEndHour - 1;</span>
<a href="#l11.2327"></a><span id="l11.2327" class="difflineminus">-                  newTime.day--;</span>
<a href="#l11.2328"></a><span id="l11.2328" class="difflineminus">-              }</span>
<a href="#l11.2329"></a><span id="l11.2329" class="difflineminus">-              if (newTime.hour &gt;= this.mEndHour) {</span>
<a href="#l11.2330"></a><span id="l11.2330" class="difflineminus">-                  newTime.hour = this.mStartHour;</span>
<a href="#l11.2331"></a><span id="l11.2331" class="difflineminus">-                  newTime.day++;</span>
<a href="#l11.2332"></a><span id="l11.2332" class="difflineminus">-              }</span>
<a href="#l11.2333"></a><span id="l11.2333" class="difflineminus">-          }</span>
<a href="#l11.2334"></a><span id="l11.2334" class="difflineplus">+            if (!newTime.isDate) {</span>
<a href="#l11.2335"></a><span id="l11.2335" class="difflineplus">+                if (newTime.hour &lt; this.mStartHour) {</span>
<a href="#l11.2336"></a><span id="l11.2336" class="difflineplus">+                    newTime.hour = this.mEndHour - 1;</span>
<a href="#l11.2337"></a><span id="l11.2337" class="difflineplus">+                    newTime.day--;</span>
<a href="#l11.2338"></a><span id="l11.2338" class="difflineplus">+                }</span>
<a href="#l11.2339"></a><span id="l11.2339" class="difflineplus">+                if (newTime.hour &gt;= this.mEndHour) {</span>
<a href="#l11.2340"></a><span id="l11.2340" class="difflineplus">+                    newTime.hour = this.mStartHour;</span>
<a href="#l11.2341"></a><span id="l11.2341" class="difflineplus">+                    newTime.day++;</span>
<a href="#l11.2342"></a><span id="l11.2342" class="difflineplus">+                }</span>
<a href="#l11.2343"></a><span id="l11.2343" class="difflineplus">+            }</span>
<a href="#l11.2344"></a><span id="l11.2344"> </span>
<a href="#l11.2345"></a><span id="l11.2345" class="difflineminus">-          return newTime;</span>
<a href="#l11.2346"></a><span id="l11.2346" class="difflineplus">+            return newTime;</span>
<a href="#l11.2347"></a><span id="l11.2347">         ]]&gt;&lt;/body&gt;</span>
<a href="#l11.2348"></a><span id="l11.2348">       &lt;/method&gt;</span>
<a href="#l11.2349"></a><span id="l11.2349">     &lt;/implementation&gt;</span>
<a href="#l11.2350"></a><span id="l11.2350"> </span>
<a href="#l11.2351"></a><span id="l11.2351">     &lt;handlers&gt;</span>
<a href="#l11.2352"></a><span id="l11.2352">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.2353"></a><span id="l11.2353" class="difflineminus">-        let element = event.target;</span>
<a href="#l11.2354"></a><span id="l11.2354" class="difflineminus">-        this.mMouseX = event.screenX;</span>
<a href="#l11.2355"></a><span id="l11.2355" class="difflineminus">-        let mouseX = event.clientX - element.boxObject.x;</span>
<a href="#l11.2356"></a><span id="l11.2356" class="difflineplus">+          let element = event.target;</span>
<a href="#l11.2357"></a><span id="l11.2357" class="difflineplus">+          this.mMouseX = event.screenX;</span>
<a href="#l11.2358"></a><span id="l11.2358" class="difflineplus">+          let mouseX = event.clientX - element.boxObject.x;</span>
<a href="#l11.2359"></a><span id="l11.2359"> </span>
<a href="#l11.2360"></a><span id="l11.2360" class="difflineminus">-        if (mouseX &gt;= this.mMargin) {</span>
<a href="#l11.2361"></a><span id="l11.2361" class="difflineminus">-            if (mouseX &lt;= (this.mMargin + this.mWidth)) {</span>
<a href="#l11.2362"></a><span id="l11.2362" class="difflineminus">-                if (mouseX &lt;= (this.mMargin + this.leftdragWidth)) {</span>
<a href="#l11.2363"></a><span id="l11.2363" class="difflineminus">-                    // Move the startdate only...</span>
<a href="#l11.2364"></a><span id="l11.2364" class="difflineminus">-                    window.setCursor(&quot;w-resize&quot;);</span>
<a href="#l11.2365"></a><span id="l11.2365" class="difflineminus">-                    this.mDragState = 2;</span>
<a href="#l11.2366"></a><span id="l11.2366" class="difflineminus">-                } else if (mouseX &gt;= (this.mMargin + this.mWidth - (this.rightdragWidth))) {</span>
<a href="#l11.2367"></a><span id="l11.2367" class="difflineminus">-                    // Move the enddate only..</span>
<a href="#l11.2368"></a><span id="l11.2368" class="difflineminus">-                    window.setCursor(&quot;e-resize&quot;);</span>
<a href="#l11.2369"></a><span id="l11.2369" class="difflineminus">-                    this.mDragState = 3;</span>
<a href="#l11.2370"></a><span id="l11.2370" class="difflineminus">-                } else {</span>
<a href="#l11.2371"></a><span id="l11.2371" class="difflineminus">-                    // Move the startdate and the enddate</span>
<a href="#l11.2372"></a><span id="l11.2372" class="difflineminus">-                    this.mDragState = 1;</span>
<a href="#l11.2373"></a><span id="l11.2373" class="difflineminus">-                    window.setCursor(&quot;grab&quot;);</span>
<a href="#l11.2374"></a><span id="l11.2374" class="difflineminus">-                }</span>
<a href="#l11.2375"></a><span id="l11.2375" class="difflineminus">-            }</span>
<a href="#l11.2376"></a><span id="l11.2376" class="difflineminus">-        }</span>
<a href="#l11.2377"></a><span id="l11.2377" class="difflineplus">+          if (mouseX &gt;= this.mMargin) {</span>
<a href="#l11.2378"></a><span id="l11.2378" class="difflineplus">+              if (mouseX &lt;= (this.mMargin + this.mWidth)) {</span>
<a href="#l11.2379"></a><span id="l11.2379" class="difflineplus">+                  if (mouseX &lt;= (this.mMargin + this.leftdragWidth)) {</span>
<a href="#l11.2380"></a><span id="l11.2380" class="difflineplus">+                      // Move the startdate only...</span>
<a href="#l11.2381"></a><span id="l11.2381" class="difflineplus">+                      window.setCursor(&quot;w-resize&quot;);</span>
<a href="#l11.2382"></a><span id="l11.2382" class="difflineplus">+                      this.mDragState = 2;</span>
<a href="#l11.2383"></a><span id="l11.2383" class="difflineplus">+                  } else if (mouseX &gt;= (this.mMargin + this.mWidth - (this.rightdragWidth))) {</span>
<a href="#l11.2384"></a><span id="l11.2384" class="difflineplus">+                      // Move the enddate only..</span>
<a href="#l11.2385"></a><span id="l11.2385" class="difflineplus">+                      window.setCursor(&quot;e-resize&quot;);</span>
<a href="#l11.2386"></a><span id="l11.2386" class="difflineplus">+                      this.mDragState = 3;</span>
<a href="#l11.2387"></a><span id="l11.2387" class="difflineplus">+                  } else {</span>
<a href="#l11.2388"></a><span id="l11.2388" class="difflineplus">+                      // Move the startdate and the enddate</span>
<a href="#l11.2389"></a><span id="l11.2389" class="difflineplus">+                      this.mDragState = 1;</span>
<a href="#l11.2390"></a><span id="l11.2390" class="difflineplus">+                      window.setCursor(&quot;grab&quot;);</span>
<a href="#l11.2391"></a><span id="l11.2391" class="difflineplus">+                  }</span>
<a href="#l11.2392"></a><span id="l11.2392" class="difflineplus">+              }</span>
<a href="#l11.2393"></a><span id="l11.2393" class="difflineplus">+          }</span>
<a href="#l11.2394"></a><span id="l11.2394">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.2395"></a><span id="l11.2395"> </span>
<a href="#l11.2396"></a><span id="l11.2396">       &lt;handler event=&quot;mousemove&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.2397"></a><span id="l11.2397" class="difflineminus">-        let mouseX = event.screenX;</span>
<a href="#l11.2398"></a><span id="l11.2398" class="difflineminus">-        if (this.mDragState == 1) {</span>
<a href="#l11.2399"></a><span id="l11.2399" class="difflineminus">-            // Move the startdate and the enddate</span>
<a href="#l11.2400"></a><span id="l11.2400" class="difflineminus">-            let delta = mouseX - this.mMouseX;</span>
<a href="#l11.2401"></a><span id="l11.2401" class="difflineminus">-            let newStart = this.moveTime(this.mStartDate, delta, false);</span>
<a href="#l11.2402"></a><span id="l11.2402" class="difflineminus">-            if (newStart.compare(this.mStartDate) != 0) {</span>
<a href="#l11.2403"></a><span id="l11.2403" class="difflineminus">-                newEnd = this.moveTime(this.mEndDate, delta, false);</span>
<a href="#l11.2404"></a><span id="l11.2404" class="difflineplus">+          let mouseX = event.screenX;</span>
<a href="#l11.2405"></a><span id="l11.2405" class="difflineplus">+          if (this.mDragState == 1) {</span>
<a href="#l11.2406"></a><span id="l11.2406" class="difflineplus">+              // Move the startdate and the enddate</span>
<a href="#l11.2407"></a><span id="l11.2407" class="difflineplus">+              let delta = mouseX - this.mMouseX;</span>
<a href="#l11.2408"></a><span id="l11.2408" class="difflineplus">+              let newStart = this.moveTime(this.mStartDate, delta, false);</span>
<a href="#l11.2409"></a><span id="l11.2409" class="difflineplus">+              if (newStart.compare(this.mStartDate) != 0) {</span>
<a href="#l11.2410"></a><span id="l11.2410" class="difflineplus">+                  newEnd = this.moveTime(this.mEndDate, delta, false);</span>
<a href="#l11.2411"></a><span id="l11.2411"> </span>
<a href="#l11.2412"></a><span id="l11.2412" class="difflineminus">-                // We need to adapt this date in case we're dealing with</span>
<a href="#l11.2413"></a><span id="l11.2413" class="difflineminus">-                // an all-day event. This is because setting 'endDate' will</span>
<a href="#l11.2414"></a><span id="l11.2414" class="difflineminus">-                // automatically add one day extra for all-day events.</span>
<a href="#l11.2415"></a><span id="l11.2415" class="difflineminus">-                if (newEnd.isDate) {</span>
<a href="#l11.2416"></a><span id="l11.2416" class="difflineminus">-                    newEnd.day--;</span>
<a href="#l11.2417"></a><span id="l11.2417" class="difflineminus">-                }</span>
<a href="#l11.2418"></a><span id="l11.2418" class="difflineplus">+                  // We need to adapt this date in case we're dealing with</span>
<a href="#l11.2419"></a><span id="l11.2419" class="difflineplus">+                  // an all-day event. This is because setting 'endDate' will</span>
<a href="#l11.2420"></a><span id="l11.2420" class="difflineplus">+                  // automatically add one day extra for all-day events.</span>
<a href="#l11.2421"></a><span id="l11.2421" class="difflineplus">+                  if (newEnd.isDate) {</span>
<a href="#l11.2422"></a><span id="l11.2422" class="difflineplus">+                      newEnd.day--;</span>
<a href="#l11.2423"></a><span id="l11.2423" class="difflineplus">+                  }</span>
<a href="#l11.2424"></a><span id="l11.2424"> </span>
<a href="#l11.2425"></a><span id="l11.2425" class="difflineminus">-                this.startDate = newStart;</span>
<a href="#l11.2426"></a><span id="l11.2426" class="difflineminus">-                this.endDate = newEnd;</span>
<a href="#l11.2427"></a><span id="l11.2427" class="difflineminus">-                this.mMouseX = mouseX;</span>
<a href="#l11.2428"></a><span id="l11.2428" class="difflineminus">-                this.update();</span>
<a href="#l11.2429"></a><span id="l11.2429" class="difflineminus">-            }</span>
<a href="#l11.2430"></a><span id="l11.2430" class="difflineminus">-        } else if (this.mDragState == 2) {</span>
<a href="#l11.2431"></a><span id="l11.2431" class="difflineminus">-            // Move the startdate only...</span>
<a href="#l11.2432"></a><span id="l11.2432" class="difflineminus">-            let delta = event.screenX - this.mSelectionbar.boxObject.screenX;</span>
<a href="#l11.2433"></a><span id="l11.2433" class="difflineminus">-            let newStart = this.moveTime(this.mStartDate, delta, true);</span>
<a href="#l11.2434"></a><span id="l11.2434" class="difflineminus">-            if (newStart.compare(this.mEndDate) &gt;= 0) {</span>
<a href="#l11.2435"></a><span id="l11.2435" class="difflineminus">-                if (this.mStartDate.isDate) {</span>
<a href="#l11.2436"></a><span id="l11.2436" class="difflineminus">-                    return;</span>
<a href="#l11.2437"></a><span id="l11.2437" class="difflineminus">-                }</span>
<a href="#l11.2438"></a><span id="l11.2438" class="difflineminus">-                newStart = this.mEndDate;</span>
<a href="#l11.2439"></a><span id="l11.2439" class="difflineminus">-            }</span>
<a href="#l11.2440"></a><span id="l11.2440" class="difflineminus">-            if (newStart.compare(this.mStartDate) != 0) {</span>
<a href="#l11.2441"></a><span id="l11.2441" class="difflineminus">-                this.startDate = newStart;</span>
<a href="#l11.2442"></a><span id="l11.2442" class="difflineminus">-                this.update();</span>
<a href="#l11.2443"></a><span id="l11.2443" class="difflineminus">-            }</span>
<a href="#l11.2444"></a><span id="l11.2444" class="difflineminus">-        } else if (this.mDragState == 3) {</span>
<a href="#l11.2445"></a><span id="l11.2445" class="difflineminus">-            // Move the enddate only..</span>
<a href="#l11.2446"></a><span id="l11.2446" class="difflineminus">-            let delta = mouseX - (this.mSelectionbar.boxObject.screenX +</span>
<a href="#l11.2447"></a><span id="l11.2447" class="difflineminus">-                                  this.mSelectionbar.boxObject.width);</span>
<a href="#l11.2448"></a><span id="l11.2448" class="difflineminus">-            let newEnd = this.moveTime(this.mEndDate, delta, true);</span>
<a href="#l11.2449"></a><span id="l11.2449" class="difflineminus">-            if (newEnd.compare(this.mStartDate) &lt; 0) {</span>
<a href="#l11.2450"></a><span id="l11.2450" class="difflineminus">-                newEnd = this.mStartDate;</span>
<a href="#l11.2451"></a><span id="l11.2451" class="difflineminus">-            }</span>
<a href="#l11.2452"></a><span id="l11.2452" class="difflineminus">-            if (newEnd.compare(this.mEndDate) != 0) {</span>
<a href="#l11.2453"></a><span id="l11.2453" class="difflineminus">-                // We need to adapt this date in case we're dealing with</span>
<a href="#l11.2454"></a><span id="l11.2454" class="difflineminus">-                // an all-day event. This is because setting 'endDate' will</span>
<a href="#l11.2455"></a><span id="l11.2455" class="difflineminus">-                // automatically add one day extra for all-day events.</span>
<a href="#l11.2456"></a><span id="l11.2456" class="difflineminus">-                if (newEnd.isDate) {</span>
<a href="#l11.2457"></a><span id="l11.2457" class="difflineminus">-                    newEnd.day--;</span>
<a href="#l11.2458"></a><span id="l11.2458" class="difflineminus">-                }</span>
<a href="#l11.2459"></a><span id="l11.2459" class="difflineplus">+                  this.startDate = newStart;</span>
<a href="#l11.2460"></a><span id="l11.2460" class="difflineplus">+                  this.endDate = newEnd;</span>
<a href="#l11.2461"></a><span id="l11.2461" class="difflineplus">+                  this.mMouseX = mouseX;</span>
<a href="#l11.2462"></a><span id="l11.2462" class="difflineplus">+                  this.update();</span>
<a href="#l11.2463"></a><span id="l11.2463" class="difflineplus">+              }</span>
<a href="#l11.2464"></a><span id="l11.2464" class="difflineplus">+          } else if (this.mDragState == 2) {</span>
<a href="#l11.2465"></a><span id="l11.2465" class="difflineplus">+              // Move the startdate only...</span>
<a href="#l11.2466"></a><span id="l11.2466" class="difflineplus">+              let delta = event.screenX - this.mSelectionbar.boxObject.screenX;</span>
<a href="#l11.2467"></a><span id="l11.2467" class="difflineplus">+              let newStart = this.moveTime(this.mStartDate, delta, true);</span>
<a href="#l11.2468"></a><span id="l11.2468" class="difflineplus">+              if (newStart.compare(this.mEndDate) &gt;= 0) {</span>
<a href="#l11.2469"></a><span id="l11.2469" class="difflineplus">+                  if (this.mStartDate.isDate) {</span>
<a href="#l11.2470"></a><span id="l11.2470" class="difflineplus">+                      return;</span>
<a href="#l11.2471"></a><span id="l11.2471" class="difflineplus">+                  }</span>
<a href="#l11.2472"></a><span id="l11.2472" class="difflineplus">+                  newStart = this.mEndDate;</span>
<a href="#l11.2473"></a><span id="l11.2473" class="difflineplus">+              }</span>
<a href="#l11.2474"></a><span id="l11.2474" class="difflineplus">+              if (newStart.compare(this.mStartDate) != 0) {</span>
<a href="#l11.2475"></a><span id="l11.2475" class="difflineplus">+                  this.startDate = newStart;</span>
<a href="#l11.2476"></a><span id="l11.2476" class="difflineplus">+                  this.update();</span>
<a href="#l11.2477"></a><span id="l11.2477" class="difflineplus">+              }</span>
<a href="#l11.2478"></a><span id="l11.2478" class="difflineplus">+          } else if (this.mDragState == 3) {</span>
<a href="#l11.2479"></a><span id="l11.2479" class="difflineplus">+              // Move the enddate only..</span>
<a href="#l11.2480"></a><span id="l11.2480" class="difflineplus">+              let delta = mouseX - (this.mSelectionbar.boxObject.screenX +</span>
<a href="#l11.2481"></a><span id="l11.2481" class="difflineplus">+                                    this.mSelectionbar.boxObject.width);</span>
<a href="#l11.2482"></a><span id="l11.2482" class="difflineplus">+              let newEnd = this.moveTime(this.mEndDate, delta, true);</span>
<a href="#l11.2483"></a><span id="l11.2483" class="difflineplus">+              if (newEnd.compare(this.mStartDate) &lt; 0) {</span>
<a href="#l11.2484"></a><span id="l11.2484" class="difflineplus">+                  newEnd = this.mStartDate;</span>
<a href="#l11.2485"></a><span id="l11.2485" class="difflineplus">+              }</span>
<a href="#l11.2486"></a><span id="l11.2486" class="difflineplus">+              if (newEnd.compare(this.mEndDate) != 0) {</span>
<a href="#l11.2487"></a><span id="l11.2487" class="difflineplus">+                  // We need to adapt this date in case we're dealing with</span>
<a href="#l11.2488"></a><span id="l11.2488" class="difflineplus">+                  // an all-day event. This is because setting 'endDate' will</span>
<a href="#l11.2489"></a><span id="l11.2489" class="difflineplus">+                  // automatically add one day extra for all-day events.</span>
<a href="#l11.2490"></a><span id="l11.2490" class="difflineplus">+                  if (newEnd.isDate) {</span>
<a href="#l11.2491"></a><span id="l11.2491" class="difflineplus">+                      newEnd.day--;</span>
<a href="#l11.2492"></a><span id="l11.2492" class="difflineplus">+                  }</span>
<a href="#l11.2493"></a><span id="l11.2493"> </span>
<a href="#l11.2494"></a><span id="l11.2494" class="difflineminus">-                // Don't allow all-day events to be shorter than a single day.</span>
<a href="#l11.2495"></a><span id="l11.2495" class="difflineminus">-                if (!newEnd.isDate || (newEnd.compare(this.startDate) &gt;= 0)) {</span>
<a href="#l11.2496"></a><span id="l11.2496" class="difflineminus">-                    this.endDate = newEnd;</span>
<a href="#l11.2497"></a><span id="l11.2497" class="difflineminus">-                    this.update();</span>
<a href="#l11.2498"></a><span id="l11.2498" class="difflineminus">-                }</span>
<a href="#l11.2499"></a><span id="l11.2499" class="difflineminus">-            }</span>
<a href="#l11.2500"></a><span id="l11.2500" class="difflineminus">-        }</span>
<a href="#l11.2501"></a><span id="l11.2501" class="difflineplus">+                  // Don't allow all-day events to be shorter than a single day.</span>
<a href="#l11.2502"></a><span id="l11.2502" class="difflineplus">+                  if (!newEnd.isDate || (newEnd.compare(this.startDate) &gt;= 0)) {</span>
<a href="#l11.2503"></a><span id="l11.2503" class="difflineplus">+                      this.endDate = newEnd;</span>
<a href="#l11.2504"></a><span id="l11.2504" class="difflineplus">+                      this.update();</span>
<a href="#l11.2505"></a><span id="l11.2505" class="difflineplus">+                  }</span>
<a href="#l11.2506"></a><span id="l11.2506" class="difflineplus">+              }</span>
<a href="#l11.2507"></a><span id="l11.2507" class="difflineplus">+          }</span>
<a href="#l11.2508"></a><span id="l11.2508">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.2509"></a><span id="l11.2509"> </span>
<a href="#l11.2510"></a><span id="l11.2510">       &lt;handler event=&quot;mouseup&quot;&gt;&lt;![CDATA[</span>
<a href="#l11.2511"></a><span id="l11.2511" class="difflineminus">-        this.mDragState = 0;</span>
<a href="#l11.2512"></a><span id="l11.2512" class="difflineminus">-        window.setCursor(&quot;auto&quot;);</span>
<a href="#l11.2513"></a><span id="l11.2513" class="difflineplus">+          this.mDragState = 0;</span>
<a href="#l11.2514"></a><span id="l11.2514" class="difflineplus">+          window.setCursor(&quot;auto&quot;);</span>
<a href="#l11.2515"></a><span id="l11.2515">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l11.2516"></a><span id="l11.2516">     &lt;/handlers&gt;</span>
<a href="#l11.2517"></a><span id="l11.2517">   &lt;/binding&gt;</span>
<a href="#l11.2518"></a><span id="l11.2518"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -30,47 +30,47 @@</span>
<a href="#l12.4"></a><span id="l12.4">           &lt;children/&gt;</span>
<a href="#l12.5"></a><span id="l12.5">         &lt;/xul:box&gt;</span>
<a href="#l12.6"></a><span id="l12.6">       &lt;/xul:box&gt;</span>
<a href="#l12.7"></a><span id="l12.7">     &lt;/content&gt;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">     &lt;implementation&gt;</span>
<a href="#l12.10"></a><span id="l12.10">       &lt;property name=&quot;x&quot;&gt;</span>
<a href="#l12.11"></a><span id="l12.11">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-          let content =</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-          let margin = getComputedStyle(content, null).marginInlineStart;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-          return -parseInt(margin.replace(/px/, &quot;&quot;), 10);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+            let content =</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+            let margin = getComputedStyle(content, null).marginInlineStart;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+            return -parseInt(margin.replace(/px/, &quot;&quot;), 10);</span>
<a href="#l12.22"></a><span id="l12.22">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.23"></a><span id="l12.23">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-          let content =</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-          content.setAttribute(&quot;style&quot;,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-                               &quot;margin-inline-start: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-          return val;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+            let content =</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+            content.setAttribute(&quot;style&quot;,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+                                 &quot;margin-inline-start: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+            return val;</span>
<a href="#l12.36"></a><span id="l12.36">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.37"></a><span id="l12.37">       &lt;/property&gt;</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39">       &lt;property name=&quot;y&quot;&gt;</span>
<a href="#l12.40"></a><span id="l12.40">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-          let content =</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-          let margin = getComputedStyle(content, null).marginTop;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-          return -parseInt(margin.replace(/px/, &quot;&quot;), 10);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+            let content =</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+            let margin = getComputedStyle(content, null).marginTop;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+            return -parseInt(margin.replace(/px/, &quot;&quot;), 10);</span>
<a href="#l12.51"></a><span id="l12.51">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.52"></a><span id="l12.52">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-          let content =</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-          content.setAttribute(&quot;style&quot;,</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-                               &quot;margin-top: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-          return val;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+            let content =</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;content&quot;);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+            content.setAttribute(&quot;style&quot;,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+                                 &quot;margin-top: &quot; + (-val) + &quot;px;&quot;);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+            return val;</span>
<a href="#l12.65"></a><span id="l12.65">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.66"></a><span id="l12.66">       &lt;/property&gt;</span>
<a href="#l12.67"></a><span id="l12.67">     &lt;/implementation&gt;</span>
<a href="#l12.68"></a><span id="l12.68">   &lt;/binding&gt;</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">   &lt;!--</span>
<a href="#l12.71"></a><span id="l12.71">   ########################################################################</span>
<a href="#l12.72"></a><span id="l12.72">   ## freebusy-day</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineat">@@ -92,139 +92,139 @@</span>
<a href="#l12.74"></a><span id="l12.74">       &lt;field name=&quot;mEndDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l12.75"></a><span id="l12.75">       &lt;field name=&quot;mStartHour&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.76"></a><span id="l12.76">       &lt;field name=&quot;mEndHour&quot;&gt;24&lt;/field&gt;</span>
<a href="#l12.77"></a><span id="l12.77">       &lt;field name=&quot;mForce24Hours&quot;&gt;false&lt;/field&gt;</span>
<a href="#l12.78"></a><span id="l12.78">       &lt;field name=&quot;mZoomFactor&quot;&gt;100&lt;/field&gt;</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l12.81"></a><span id="l12.81">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-          return this.mZoomFactor;</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+            return this.mZoomFactor;</span>
<a href="#l12.84"></a><span id="l12.84">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.85"></a><span id="l12.85">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-          this.mZoomFactor = val;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-          let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-          removeChildren(hours);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-          return val;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+            this.mZoomFactor = val;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+            let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+            removeChildren(hours);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+            return val;</span>
<a href="#l12.94"></a><span id="l12.94">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.95"></a><span id="l12.95">       &lt;/property&gt;</span>
<a href="#l12.96"></a><span id="l12.96"> </span>
<a href="#l12.97"></a><span id="l12.97">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l12.98"></a><span id="l12.98">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.99"></a><span id="l12.99">             return this.mForce24Hours;</span>
<a href="#l12.100"></a><span id="l12.100">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.101"></a><span id="l12.101">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-          this.mForce24Hours = val;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-          this.initTimeRange();</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+            this.mForce24Hours = val;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+            this.initTimeRange();</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-          let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-          removeChildren(hours);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-          return val;</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+            let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+            removeChildren(hours);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+            return val;</span>
<a href="#l12.113"></a><span id="l12.113">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.114"></a><span id="l12.114">       &lt;/property&gt;</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.119"></a><span id="l12.119"> </span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-        this.initTimeRange();</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+          this.initTimeRange();</span>
<a href="#l12.122"></a><span id="l12.122">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l12.125"></a><span id="l12.125">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-          if (this.force24Hours) {</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-              this.mStartHour = 0;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-              this.mEndHour = 24;</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-          } else {</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-              this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-              this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-          }</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+            if (this.force24Hours) {</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+                this.mStartHour = 0;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+                this.mEndHour = 24;</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+            } else {</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+                this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+                this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+            }</span>
<a href="#l12.140"></a><span id="l12.140">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.141"></a><span id="l12.141">       &lt;/method&gt;</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l12.144"></a><span id="l12.144">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-          this.mStartDate = val.clone();</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-          this.mStartDate.minute = 0;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-          this.mStartDate.second = 0;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-          this.mStartDate.makeImmutable();</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-          return val;</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+            this.mStartDate = val.clone();</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+            this.mStartDate.minute = 0;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+            this.mStartDate.second = 0;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+            this.mStartDate.makeImmutable();</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+            return val;</span>
<a href="#l12.155"></a><span id="l12.155">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.156"></a><span id="l12.156">       &lt;/property&gt;</span>
<a href="#l12.157"></a><span id="l12.157"> </span>
<a href="#l12.158"></a><span id="l12.158">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l12.159"></a><span id="l12.159">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-          this.mEndDate = val.clone();</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-          this.mEndDate.makeImmutable();</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-          return val;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+            this.mEndDate = val.clone();</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+            this.mEndDate.makeImmutable();</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+            return val;</span>
<a href="#l12.166"></a><span id="l12.166">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.167"></a><span id="l12.167">       &lt;/property&gt;</span>
<a href="#l12.168"></a><span id="l12.168"> </span>
<a href="#l12.169"></a><span id="l12.169">       &lt;property name=&quot;dayHeight&quot;&gt;</span>
<a href="#l12.170"></a><span id="l12.170">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineminus">-          let day =</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-          return day.boxObject.height;</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+            let day =</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+            return day.boxObject.height;</span>
<a href="#l12.179"></a><span id="l12.179">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.180"></a><span id="l12.180">       &lt;/property&gt;</span>
<a href="#l12.181"></a><span id="l12.181"> </span>
<a href="#l12.182"></a><span id="l12.182">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l12.183"></a><span id="l12.183">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-          let date = val.clone();</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-          date.hour = 0;</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-          date.minute = 0;</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-          date.isDate = false;</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+            let date = val.clone();</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+            date.hour = 0;</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+            date.minute = 0;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+            date.isDate = false;</span>
<a href="#l12.192"></a><span id="l12.192"> </span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-          if (!this.mDateFormatter) {</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-              this.mDateFormatter =</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-                  Components.classes[</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-                      &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-                          .getService(</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-                              Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-          }</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+            if (!this.mDateFormatter) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                this.mDateFormatter =</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+                    Components.classes[</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+                        &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                            .getService(</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+                                Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+            }</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-          // First set the formatted date string as title</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-          let day =</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-          let dateValue = this.mZoomFactor &gt; 100 ? this.mDateFormatter.formatDateShort(date)</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-                                                 : this.mDateFormatter.formatDateLong(date);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-          day.setAttribute(&quot;value&quot;, dateValue);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+            // First set the formatted date string as title</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+            let day =</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;day&quot;);</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+            let dateValue = this.mZoomFactor &gt; 100 ? this.mDateFormatter.formatDateShort(date)</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+                                                   : this.mDateFormatter.formatDateLong(date);</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+            day.setAttribute(&quot;value&quot;, dateValue);</span>
<a href="#l12.222"></a><span id="l12.222"> </span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-          // Now create as many 'hour' elements as needed</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-          let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-          let hours =</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-          date.hour = this.mStartHour;</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-          if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-              let template = createXULElement(&quot;text&quot;);</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-              template.className = &quot;freebusy-timebar-hour&quot;;</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-              let count = Math.ceil(</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-                  (this.mEndHour - this.mStartHour) * 60 / step_in_minutes);</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-              let remain = count;</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-              let first = true;</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-              while (remain--) {</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-                  let newNode = template.cloneNode(false);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-                  let value = this.mDateFormatter.formatTime(date);</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-                  if (first) {</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-                      newNode.className += &quot; first-in-day&quot;;</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-                      first = false;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-                  }</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-                  newNode.setAttribute(&quot;value&quot;, value);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-                  hours.appendChild(newNode);</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-                  date.minute += step_in_minutes;</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+            // Now create as many 'hour' elements as needed</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+            let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+            let hours =</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+            date.hour = this.mStartHour;</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+            if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+                let template = createXULElement(&quot;text&quot;);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+                template.className = &quot;freebusy-timebar-hour&quot;;</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+                let count = Math.ceil(</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+                    (this.mEndHour - this.mStartHour) * 60 / step_in_minutes);</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+                let remain = count;</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+                let first = true;</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+                while (remain--) {</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+                    let newNode = template.cloneNode(false);</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+                    let value = this.mDateFormatter.formatTime(date);</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+                    if (first) {</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+                        newNode.className += &quot; first-in-day&quot;;</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+                        first = false;</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+                    }</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+                    newNode.setAttribute(&quot;value&quot;, value);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+                    hours.appendChild(newNode);</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+                    date.minute += step_in_minutes;</span>
<a href="#l12.269"></a><span id="l12.269"> </span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-                  if (remain == 0) {</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-                      newNode.className += &quot; last-in-day&quot;;</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-                  }</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-              }</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-          }</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+                    if (remain == 0) {</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+                        newNode.className += &quot; last-in-day&quot;;</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+                    }</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+                }</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+            }</span>
<a href="#l12.280"></a><span id="l12.280"> </span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-          return val;</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+            return val;</span>
<a href="#l12.283"></a><span id="l12.283">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.284"></a><span id="l12.284">       &lt;/property&gt;</span>
<a href="#l12.285"></a><span id="l12.285">     &lt;/implementation&gt;</span>
<a href="#l12.286"></a><span id="l12.286">   &lt;/binding&gt;</span>
<a href="#l12.287"></a><span id="l12.287"> </span>
<a href="#l12.288"></a><span id="l12.288">   &lt;!--</span>
<a href="#l12.289"></a><span id="l12.289">   ########################################################################</span>
<a href="#l12.290"></a><span id="l12.290">   ## freebusy-timebar</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineat">@@ -262,211 +262,211 @@</span>
<a href="#l12.292"></a><span id="l12.292">       &lt;field name=&quot;mScrollOffset&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.293"></a><span id="l12.293">       &lt;field name=&quot;mStartHour&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.294"></a><span id="l12.294">       &lt;field name=&quot;mEndHour&quot;&gt;24&lt;/field&gt;</span>
<a href="#l12.295"></a><span id="l12.295">       &lt;field name=&quot;mForce24Hours&quot;&gt;false&lt;/field&gt;</span>
<a href="#l12.296"></a><span id="l12.296">       &lt;field name=&quot;mZoomFactor&quot;&gt;100&lt;/field&gt;</span>
<a href="#l12.297"></a><span id="l12.297"> </span>
<a href="#l12.298"></a><span id="l12.298">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l12.299"></a><span id="l12.299">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-          return this.mZoomFactor;</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+            return this.mZoomFactor;</span>
<a href="#l12.302"></a><span id="l12.302">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.303"></a><span id="l12.303">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-          this.mZoomFactor = val;</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+            this.mZoomFactor = val;</span>
<a href="#l12.306"></a><span id="l12.306"> </span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-          let template =</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-          let parent = template.parentNode;</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-          while (parent.childNodes.length &gt; 1) {</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-              parent.lastChild.remove();</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-          }</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+            let template =</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+            let parent = template.parentNode;</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+            while (parent.childNodes.length &gt; 1) {</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+                parent.lastChild.remove();</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+            }</span>
<a href="#l12.321"></a><span id="l12.321"> </span>
<a href="#l12.322"></a><span id="l12.322" class="difflineminus">-          template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-          template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+            template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+            template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.326"></a><span id="l12.326"> </span>
<a href="#l12.327"></a><span id="l12.327" class="difflineminus">-          this.onLoad();</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+            this.onLoad();</span>
<a href="#l12.329"></a><span id="l12.329"> </span>
<a href="#l12.330"></a><span id="l12.330" class="difflineminus">-          return val;</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+            return val;</span>
<a href="#l12.332"></a><span id="l12.332">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.333"></a><span id="l12.333">       &lt;/property&gt;</span>
<a href="#l12.334"></a><span id="l12.334"> </span>
<a href="#l12.335"></a><span id="l12.335">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l12.336"></a><span id="l12.336">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-          return this.mForce24Hours;</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+            return this.mForce24Hours;</span>
<a href="#l12.339"></a><span id="l12.339">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.340"></a><span id="l12.340">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-          this.mForce24Hours = val;</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineminus">-          this.initTimeRange();</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+            this.mForce24Hours = val;</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+            this.initTimeRange();</span>
<a href="#l12.345"></a><span id="l12.345"> </span>
<a href="#l12.346"></a><span id="l12.346" class="difflineminus">-          let template =</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+            let template =</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.352"></a><span id="l12.352"> </span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-          let parent = template.parentNode;</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-          while (parent.childNodes.length &gt; 1) {</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineminus">-              parent.lastChild.remove();</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-          }</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+            let parent = template.parentNode;</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+            while (parent.childNodes.length &gt; 1) {</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+                parent.lastChild.remove();</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+            }</span>
<a href="#l12.361"></a><span id="l12.361"> </span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-          template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-          template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+            template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+            template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.366"></a><span id="l12.366"> </span>
<a href="#l12.367"></a><span id="l12.367" class="difflineminus">-          this.onLoad();</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+            this.onLoad();</span>
<a href="#l12.369"></a><span id="l12.369"> </span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-          return val;</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+            return val;</span>
<a href="#l12.372"></a><span id="l12.372">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.373"></a><span id="l12.373">       &lt;/property&gt;</span>
<a href="#l12.374"></a><span id="l12.374"> </span>
<a href="#l12.375"></a><span id="l12.375">       &lt;property name=&quot;contentWidth&quot;&gt;</span>
<a href="#l12.376"></a><span id="l12.376">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-          // Calculate the difference between the first to day-elements, since</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-          // the width of the head element does not specify the width we need</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-          // due to an arbitrary margin value.</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineminus">-          let template =</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-          return template.nextSibling.boxObject.x - template.boxObject.x;</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+            // Calculate the difference between the first to day-elements, since</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+            // the width of the head element does not specify the width we need</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+            // due to an arbitrary margin value.</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+            let template =</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+            return template.nextSibling.boxObject.x - template.boxObject.x;</span>
<a href="#l12.391"></a><span id="l12.391">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.392"></a><span id="l12.392">       &lt;/property&gt;</span>
<a href="#l12.393"></a><span id="l12.393"> </span>
<a href="#l12.394"></a><span id="l12.394">       &lt;property name=&quot;containerWidth&quot;&gt;</span>
<a href="#l12.395"></a><span id="l12.395">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-          return this.parentNode.boxObject.width;</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+            return this.parentNode.boxObject.width;</span>
<a href="#l12.398"></a><span id="l12.398">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.399"></a><span id="l12.399">       &lt;/property&gt;</span>
<a href="#l12.400"></a><span id="l12.400"> </span>
<a href="#l12.401"></a><span id="l12.401">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l12.402"></a><span id="l12.402">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-          this.mStartDate = val.clone();</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineminus">-          this.mStartDate.makeImmutable();</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineminus">-          return val;</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+            this.mStartDate = val.clone();</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+            this.mStartDate.makeImmutable();</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+            return val;</span>
<a href="#l12.409"></a><span id="l12.409">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.410"></a><span id="l12.410">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-          return this.mStartDate;</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+            return this.mStartDate;</span>
<a href="#l12.413"></a><span id="l12.413">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.414"></a><span id="l12.414">       &lt;/property&gt;</span>
<a href="#l12.415"></a><span id="l12.415"> </span>
<a href="#l12.416"></a><span id="l12.416">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l12.417"></a><span id="l12.417">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineminus">-          this.mEndDate = val.clone();</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineminus">-          this.mEndDate.makeImmutable();</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-          return val;</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+            this.mEndDate = val.clone();</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+            this.mEndDate.makeImmutable();</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+            return val;</span>
<a href="#l12.424"></a><span id="l12.424">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.425"></a><span id="l12.425">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-          return this.mEndDate;</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+            return this.mEndDate;</span>
<a href="#l12.428"></a><span id="l12.428">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.429"></a><span id="l12.429">       &lt;/property&gt;</span>
<a href="#l12.430"></a><span id="l12.430"> </span>
<a href="#l12.431"></a><span id="l12.431">       &lt;property name=&quot;dayOffset&quot;&gt;</span>
<a href="#l12.432"></a><span id="l12.432">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineminus">-          this.mDayOffset = val;</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineminus">-          let container =</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-          let date = this.mStartDate.clone();</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-          date.day += val;</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-          let numChilds = container.childNodes.length;</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineminus">-          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineminus">-              let child = container.childNodes[i];</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-              child.date = date;</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineminus">-              date.day++;</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-          }</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-          return val;</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+            this.mDayOffset = val;</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+            let container =</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineplus">+            let date = this.mStartDate.clone();</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineplus">+            date.day += val;</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+            let numChilds = container.childNodes.length;</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+            for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+                let child = container.childNodes[i];</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+                child.date = date;</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+                date.day++;</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+            }</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+            return val;</span>
<a href="#l12.459"></a><span id="l12.459">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.460"></a><span id="l12.460">       &lt;/property&gt;</span>
<a href="#l12.461"></a><span id="l12.461"> </span>
<a href="#l12.462"></a><span id="l12.462">       &lt;property name=&quot;step&quot;&gt;</span>
<a href="#l12.463"></a><span id="l12.463">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-          // How much pixels spans a single day</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-          let oneday = this.contentWidth;</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineplus">+            // How much pixels spans a single day</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+            let oneday = this.contentWidth;</span>
<a href="#l12.468"></a><span id="l12.468"> </span>
<a href="#l12.469"></a><span id="l12.469" class="difflineminus">-          // The difference in pixels between the content and the container.</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineminus">-          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineplus">+            // The difference in pixels between the content and the container.</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+            let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.473"></a><span id="l12.473"> </span>
<a href="#l12.474"></a><span id="l12.474" class="difflineminus">-          // What we want to know is the scale of the total shift</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineminus">-          // needed to step one block further. Since the content</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineminus">-          // is divided into 'numHours' equal parts, we can simply state:</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-          let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-          return (this.contentWidth) / (numHours * shift);</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+            // What we want to know is the scale of the total shift</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+            // needed to step one block further. Since the content</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+            // is divided into 'numHours' equal parts, we can simply state:</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineplus">+            let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineplus">+            return (this.contentWidth) / (numHours * shift);</span>
<a href="#l12.484"></a><span id="l12.484">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.485"></a><span id="l12.485">       &lt;/property&gt;</span>
<a href="#l12.486"></a><span id="l12.486"> </span>
<a href="#l12.487"></a><span id="l12.487">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l12.488"></a><span id="l12.488">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineminus">-          this.mScrollOffset = val;</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineplus">+            this.mScrollOffset = val;</span>
<a href="#l12.491"></a><span id="l12.491"> </span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-          // How much pixels spans a single day</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineminus">-          let oneday = this.contentWidth;</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+            // How much pixels spans a single day</span>
<a href="#l12.495"></a><span id="l12.495" class="difflineplus">+            let oneday = this.contentWidth;</span>
<a href="#l12.496"></a><span id="l12.496"> </span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-          // The difference in pixels between the content and the container.</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineminus">-          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineplus">+            // The difference in pixels between the content and the container.</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineplus">+            let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.501"></a><span id="l12.501"> </span>
<a href="#l12.502"></a><span id="l12.502" class="difflineminus">-          // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineminus">-          // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l12.504"></a><span id="l12.504" class="difflineminus">-          let offset = Math.floor(val * shift);</span>
<a href="#l12.505"></a><span id="l12.505" class="difflineplus">+            // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineplus">+            // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineplus">+            let offset = Math.floor(val * shift);</span>
<a href="#l12.508"></a><span id="l12.508"> </span>
<a href="#l12.509"></a><span id="l12.509" class="difflineminus">-          // Now find out how much days this offset effectively skips.</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-          // this is a simple division which always yields a positive integer value.</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineminus">-          this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineplus">+            // Now find out how much days this offset effectively skips.</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineplus">+            // this is a simple division which always yields a positive integer value.</span>
<a href="#l12.514"></a><span id="l12.514" class="difflineplus">+            this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l12.515"></a><span id="l12.515"> </span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-          // Set the pixel offset for the content which will always need</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineminus">-          // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineminus">-          offset %= oneday;</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+            // Set the pixel offset for the content which will always need</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineplus">+            // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineplus">+            offset %= oneday;</span>
<a href="#l12.522"></a><span id="l12.522"> </span>
<a href="#l12.523"></a><span id="l12.523" class="difflineminus">-          // Set the offset at the content node.</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-          let container =</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-          container.x = offset;</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-          return val;</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineplus">+            // Set the offset at the content node.</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineplus">+            let container =</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineplus">+            container.x = offset;</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+            return val;</span>
<a href="#l12.535"></a><span id="l12.535">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.536"></a><span id="l12.536">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineminus">-          return this.mScrollOffset;</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineplus">+            return this.mScrollOffset;</span>
<a href="#l12.539"></a><span id="l12.539">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.540"></a><span id="l12.540">       &lt;/property&gt;</span>
<a href="#l12.541"></a><span id="l12.541"> </span>
<a href="#l12.542"></a><span id="l12.542">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.547"></a><span id="l12.547"> </span>
<a href="#l12.548"></a><span id="l12.548" class="difflineminus">-        let args = window.arguments[0];</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineminus">-        let startTime = args.startTime;</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineminus">-        let endTime = args.endTime;</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineplus">+          let args = window.arguments[0];</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineplus">+          let startTime = args.startTime;</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineplus">+          let endTime = args.endTime;</span>
<a href="#l12.554"></a><span id="l12.554"> </span>
<a href="#l12.555"></a><span id="l12.555" class="difflineminus">-        this.initTimeRange();</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineplus">+          this.initTimeRange();</span>
<a href="#l12.557"></a><span id="l12.557"> </span>
<a href="#l12.558"></a><span id="l12.558" class="difflineminus">-        // The basedate is the date/time from which the display</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineminus">-        // of the timebar starts. The range is the number of days</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineminus">-        // we should be able to show. The start- and enddate</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-        // is the time the event is scheduled for.</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineminus">-        this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineminus">-        this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineminus">-        this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+          // The basedate is the date/time from which the display</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+          // of the timebar starts. The range is the number of days</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineplus">+          // we should be able to show. The start- and enddate</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineplus">+          // is the time the event is scheduled for.</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineplus">+          this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+          this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+          this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.574"></a><span id="l12.574"> </span>
<a href="#l12.575"></a><span id="l12.575" class="difflineminus">-        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+          window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l12.577"></a><span id="l12.577">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.578"></a><span id="l12.578"> </span>
<a href="#l12.579"></a><span id="l12.579">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l12.580"></a><span id="l12.580">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineminus">-          let date = this.mStartDate.clone();</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineminus">-          let template =</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineminus">-          let parent = template.parentNode;</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineminus">-          let numChilds = parent.childNodes.length;</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineminus">-          for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineminus">-              let child = parent.childNodes[i];</span>
<a href="#l12.589"></a><span id="l12.589" class="difflineminus">-              child.startDate = this.mStartDate;</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineminus">-              child.endDate = this.mEndDate;</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineminus">-              child.date = date;</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineminus">-              date.day++;</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineminus">-          }</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineminus">-          let offset = this.mDayOffset;</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-          this.dayOffset = offset;</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+            let date = this.mStartDate.clone();</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+            let template =</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineplus">+            let parent = template.parentNode;</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineplus">+            let numChilds = parent.childNodes.length;</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineplus">+            for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineplus">+                let child = parent.childNodes[i];</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineplus">+                child.startDate = this.mStartDate;</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+                child.endDate = this.mEndDate;</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineplus">+                child.date = date;</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineplus">+                date.day++;</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineplus">+            }</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineplus">+            let offset = this.mDayOffset;</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+            this.dayOffset = offset;</span>
<a href="#l12.611"></a><span id="l12.611">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.612"></a><span id="l12.612">       &lt;/method&gt;</span>
<a href="#l12.613"></a><span id="l12.613"> </span>
<a href="#l12.614"></a><span id="l12.614">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l12.615"></a><span id="l12.615">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.616"></a><span id="l12.616">             this.initialize();</span>
<a href="#l12.617"></a><span id="l12.617">             let template =</span>
<a href="#l12.618"></a><span id="l12.618">                 document.getAnonymousElementByAttribute(</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineat">@@ -476,70 +476,70 @@</span>
<a href="#l12.620"></a><span id="l12.620">             event.details = this.contentWidth;</span>
<a href="#l12.621"></a><span id="l12.621">             event.height = template.dayHeight;</span>
<a href="#l12.622"></a><span id="l12.622">             this.dispatchEvent(event);</span>
<a href="#l12.623"></a><span id="l12.623">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.624"></a><span id="l12.624">       &lt;/method&gt;</span>
<a href="#l12.625"></a><span id="l12.625"> </span>
<a href="#l12.626"></a><span id="l12.626">       &lt;method name=&quot;initialize&quot;&gt;</span>
<a href="#l12.627"></a><span id="l12.627">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineminus">-          let args = window.arguments[0];</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineminus">-          let startTime = args.startTime;</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineminus">-          let endTime = args.endTime;</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineplus">+            let args = window.arguments[0];</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineplus">+            let startTime = args.startTime;</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineplus">+            let endTime = args.endTime;</span>
<a href="#l12.634"></a><span id="l12.634"> </span>
<a href="#l12.635"></a><span id="l12.635" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineminus">-          this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-          this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineplus">+            this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineplus">+            this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.641"></a><span id="l12.641"> </span>
<a href="#l12.642"></a><span id="l12.642" class="difflineminus">-          // Set the number of 'freebusy-day'-elements</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-          // we need to fill up the content box.</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineminus">-          // TODO: hardcoded value</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineminus">-          this.mNumDays = 4 * this.mZoomFactor / 100;</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineminus">-          if (this.mNumDays &lt; 2) {</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineminus">-              this.mNumDays = 2;</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineminus">-          }</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineplus">+            // Set the number of 'freebusy-day'-elements</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+            // we need to fill up the content box.</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+            // TODO: hardcoded value</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+            this.mNumDays = 4 * this.mZoomFactor / 100;</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineplus">+            if (this.mNumDays &lt; 2) {</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineplus">+                this.mNumDays = 2;</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineplus">+            }</span>
<a href="#l12.656"></a><span id="l12.656"> </span>
<a href="#l12.657"></a><span id="l12.657" class="difflineminus">-          // Now create those elements and set their date property.</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-          let date = this.mStartDate.clone();</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineminus">-          let template =</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineminus">-          template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineminus">-          template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineminus">-          template.startDate = this.mStartDate;</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineminus">-          template.endDate = this.mEndDate;</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-          template.date = date;</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-          let parent = template.parentNode;</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineminus">-          if (parent.childNodes.length &lt;= 1) {</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineminus">-              let count = this.mNumDays - 1;</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineminus">-              if (count &gt; 0) {</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineminus">-                  for (let i = 0; i &lt; count; i++) {</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineminus">-                      date.day++;</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineminus">-                      let newNode = template.cloneNode(false);</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-                      newNode.force24Hours = this.mForce24Hours;</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineminus">-                      newNode.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineminus">-                      newNode.startDate = this.mStartDate;</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineminus">-                      newNode.endDate = this.mEndDate;</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineminus">-                      newNode.date = date;</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineminus">-                      parent.appendChild(newNode);</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineminus">-                  }</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineminus">-              }</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineminus">-          }</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineplus">+            // Now create those elements and set their date property.</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineplus">+            let date = this.mStartDate.clone();</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineplus">+            let template =</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.687"></a><span id="l12.687" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;template&quot;);</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineplus">+            template.force24Hours = this.mForce24Hours;</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+            template.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+            template.startDate = this.mStartDate;</span>
<a href="#l12.691"></a><span id="l12.691" class="difflineplus">+            template.endDate = this.mEndDate;</span>
<a href="#l12.692"></a><span id="l12.692" class="difflineplus">+            template.date = date;</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineplus">+            let parent = template.parentNode;</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineplus">+            if (parent.childNodes.length &lt;= 1) {</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineplus">+                let count = this.mNumDays - 1;</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineplus">+                if (count &gt; 0) {</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineplus">+                    for (let i = 0; i &lt; count; i++) {</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineplus">+                        date.day++;</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineplus">+                        let newNode = template.cloneNode(false);</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineplus">+                        newNode.force24Hours = this.mForce24Hours;</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineplus">+                        newNode.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineplus">+                        newNode.startDate = this.mStartDate;</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineplus">+                        newNode.endDate = this.mEndDate;</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineplus">+                        newNode.date = date;</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineplus">+                        parent.appendChild(newNode);</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineplus">+                    }</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineplus">+                }</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+            }</span>
<a href="#l12.709"></a><span id="l12.709">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.710"></a><span id="l12.710">       &lt;/method&gt;</span>
<a href="#l12.711"></a><span id="l12.711"> </span>
<a href="#l12.712"></a><span id="l12.712">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l12.713"></a><span id="l12.713">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.714"></a><span id="l12.714" class="difflineminus">-          if (this.force24Hours) {</span>
<a href="#l12.715"></a><span id="l12.715" class="difflineminus">-              this.mStartHour = 0;</span>
<a href="#l12.716"></a><span id="l12.716" class="difflineminus">-              this.mEndHour = 24;</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineminus">-          } else {</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineminus">-              this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineminus">-              this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.720"></a><span id="l12.720" class="difflineminus">-          }</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineplus">+            if (this.force24Hours) {</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineplus">+                this.mStartHour = 0;</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineplus">+                this.mEndHour = 24;</span>
<a href="#l12.724"></a><span id="l12.724" class="difflineplus">+            } else {</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineplus">+                this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineplus">+                this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineplus">+            }</span>
<a href="#l12.728"></a><span id="l12.728">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.729"></a><span id="l12.729">       &lt;/method&gt;</span>
<a href="#l12.730"></a><span id="l12.730">     &lt;/implementation&gt;</span>
<a href="#l12.731"></a><span id="l12.731">   &lt;/binding&gt;</span>
<a href="#l12.732"></a><span id="l12.732"> </span>
<a href="#l12.733"></a><span id="l12.733">   &lt;!--</span>
<a href="#l12.734"></a><span id="l12.734">   ########################################################################</span>
<a href="#l12.735"></a><span id="l12.735">   ## freebusy-row</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineat">@@ -561,417 +561,417 @@</span>
<a href="#l12.737"></a><span id="l12.737">       &lt;field name=&quot;mRange&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.738"></a><span id="l12.738">       &lt;field name=&quot;mStartHour&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.739"></a><span id="l12.739">       &lt;field name=&quot;mEndHour&quot;&gt;24&lt;/field&gt;</span>
<a href="#l12.740"></a><span id="l12.740">       &lt;field name=&quot;mForce24Hours&quot;&gt;false&lt;/field&gt;</span>
<a href="#l12.741"></a><span id="l12.741">       &lt;field name=&quot;mZoomFactor&quot;&gt;100&lt;/field&gt;</span>
<a href="#l12.742"></a><span id="l12.742"> </span>
<a href="#l12.743"></a><span id="l12.743">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l12.744"></a><span id="l12.744">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineminus">-          return this.mZoomFactor;</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineplus">+            return this.mZoomFactor;</span>
<a href="#l12.747"></a><span id="l12.747">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.748"></a><span id="l12.748">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineminus">-          this.mZoomFactor = val;</span>
<a href="#l12.750"></a><span id="l12.750" class="difflineplus">+            this.mZoomFactor = val;</span>
<a href="#l12.751"></a><span id="l12.751"> </span>
<a href="#l12.752"></a><span id="l12.752" class="difflineminus">-          let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineminus">-          removeChildren(hours);</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineminus">-          this.onLoad();</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineplus">+            let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineplus">+            removeChildren(hours);</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineplus">+            this.onLoad();</span>
<a href="#l12.758"></a><span id="l12.758"> </span>
<a href="#l12.759"></a><span id="l12.759" class="difflineminus">-          return val;</span>
<a href="#l12.760"></a><span id="l12.760" class="difflineplus">+            return val;</span>
<a href="#l12.761"></a><span id="l12.761">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.762"></a><span id="l12.762">       &lt;/property&gt;</span>
<a href="#l12.763"></a><span id="l12.763"> </span>
<a href="#l12.764"></a><span id="l12.764">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l12.765"></a><span id="l12.765">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.766"></a><span id="l12.766" class="difflineminus">-          return this.mForce24Hours;</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineplus">+            return this.mForce24Hours;</span>
<a href="#l12.768"></a><span id="l12.768">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.769"></a><span id="l12.769">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.770"></a><span id="l12.770" class="difflineminus">-          this.mForce24Hours = val;</span>
<a href="#l12.771"></a><span id="l12.771" class="difflineminus">-          this.initTimeRange();</span>
<a href="#l12.772"></a><span id="l12.772" class="difflineplus">+            this.mForce24Hours = val;</span>
<a href="#l12.773"></a><span id="l12.773" class="difflineplus">+            this.initTimeRange();</span>
<a href="#l12.774"></a><span id="l12.774"> </span>
<a href="#l12.775"></a><span id="l12.775" class="difflineminus">-          let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.776"></a><span id="l12.776" class="difflineminus">-          removeChildren(hours);</span>
<a href="#l12.777"></a><span id="l12.777" class="difflineminus">-          this.onLoad();</span>
<a href="#l12.778"></a><span id="l12.778" class="difflineplus">+            let hours = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.779"></a><span id="l12.779" class="difflineplus">+            removeChildren(hours);</span>
<a href="#l12.780"></a><span id="l12.780" class="difflineplus">+            this.onLoad();</span>
<a href="#l12.781"></a><span id="l12.781"> </span>
<a href="#l12.782"></a><span id="l12.782" class="difflineminus">-          return val;</span>
<a href="#l12.783"></a><span id="l12.783" class="difflineplus">+            return val;</span>
<a href="#l12.784"></a><span id="l12.784">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.785"></a><span id="l12.785">       &lt;/property&gt;</span>
<a href="#l12.786"></a><span id="l12.786"> </span>
<a href="#l12.787"></a><span id="l12.787">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l12.788"></a><span id="l12.788">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.789"></a><span id="l12.789" class="difflineminus">-          this.mStartDate = val.clone();</span>
<a href="#l12.790"></a><span id="l12.790" class="difflineminus">-          this.mStartDate.isDate = false;</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineminus">-          this.mStartDate.makeImmutable();</span>
<a href="#l12.792"></a><span id="l12.792" class="difflineminus">-          return val;</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineplus">+            this.mStartDate = val.clone();</span>
<a href="#l12.794"></a><span id="l12.794" class="difflineplus">+            this.mStartDate.isDate = false;</span>
<a href="#l12.795"></a><span id="l12.795" class="difflineplus">+            this.mStartDate.makeImmutable();</span>
<a href="#l12.796"></a><span id="l12.796" class="difflineplus">+            return val;</span>
<a href="#l12.797"></a><span id="l12.797">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.798"></a><span id="l12.798">       &lt;/property&gt;</span>
<a href="#l12.799"></a><span id="l12.799"> </span>
<a href="#l12.800"></a><span id="l12.800">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l12.801"></a><span id="l12.801">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.802"></a><span id="l12.802" class="difflineminus">-          this.mEndDate = val.clone();</span>
<a href="#l12.803"></a><span id="l12.803" class="difflineminus">-          this.mEndDate.isDate = false;</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineminus">-          this.mEndDate.makeImmutable();</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineminus">-          return val;</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineplus">+            this.mEndDate = val.clone();</span>
<a href="#l12.807"></a><span id="l12.807" class="difflineplus">+            this.mEndDate.isDate = false;</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineplus">+            this.mEndDate.makeImmutable();</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineplus">+            return val;</span>
<a href="#l12.810"></a><span id="l12.810">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.811"></a><span id="l12.811">       &lt;/property&gt;</span>
<a href="#l12.812"></a><span id="l12.812"> </span>
<a href="#l12.813"></a><span id="l12.813">       &lt;property name=&quot;numHours&quot;&gt;</span>
<a href="#l12.814"></a><span id="l12.814">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-          let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineminus">-          return Math.ceil(numHours * 100 / this.mZoomFactor);</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineplus">+            let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineplus">+            return Math.ceil(numHours * 100 / this.mZoomFactor);</span>
<a href="#l12.819"></a><span id="l12.819">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.820"></a><span id="l12.820">       &lt;/property&gt;</span>
<a href="#l12.821"></a><span id="l12.821"> </span>
<a href="#l12.822"></a><span id="l12.822">       &lt;property name=&quot;contentWidth&quot;&gt;</span>
<a href="#l12.823"></a><span id="l12.823">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.824"></a><span id="l12.824" class="difflineminus">-          let hours =</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.827"></a><span id="l12.827" class="difflineminus">-          return (hours.childNodes[1].boxObject.x -</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineminus">-                  hours.childNodes[0].boxObject.x) *</span>
<a href="#l12.829"></a><span id="l12.829" class="difflineminus">-                  this.numHours;</span>
<a href="#l12.830"></a><span id="l12.830" class="difflineplus">+            let hours =</span>
<a href="#l12.831"></a><span id="l12.831" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.832"></a><span id="l12.832" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.833"></a><span id="l12.833" class="difflineplus">+            return (hours.childNodes[1].boxObject.x -</span>
<a href="#l12.834"></a><span id="l12.834" class="difflineplus">+                    hours.childNodes[0].boxObject.x) *</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineplus">+                    this.numHours;</span>
<a href="#l12.836"></a><span id="l12.836">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.837"></a><span id="l12.837">       &lt;/property&gt;</span>
<a href="#l12.838"></a><span id="l12.838"> </span>
<a href="#l12.839"></a><span id="l12.839">       &lt;property name=&quot;containerWidth&quot;&gt;</span>
<a href="#l12.840"></a><span id="l12.840">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.841"></a><span id="l12.841" class="difflineminus">-          // Step up the hierarchy until we reach the listbox</span>
<a href="#l12.842"></a><span id="l12.842" class="difflineminus">-          return this.parentNode</span>
<a href="#l12.843"></a><span id="l12.843" class="difflineminus">-                     .parentNode</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineminus">-                     .parentNode</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineminus">-                     .parentNode.boxObject.width;</span>
<a href="#l12.846"></a><span id="l12.846" class="difflineplus">+            // Step up the hierarchy until we reach the listbox</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineplus">+            return this.parentNode</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineplus">+                       .parentNode</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineplus">+                       .parentNode</span>
<a href="#l12.850"></a><span id="l12.850" class="difflineplus">+                       .parentNode.boxObject.width;</span>
<a href="#l12.851"></a><span id="l12.851">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.852"></a><span id="l12.852">       &lt;/property&gt;</span>
<a href="#l12.853"></a><span id="l12.853"> </span>
<a href="#l12.854"></a><span id="l12.854">       &lt;property name=&quot;dayOffset&quot;&gt;</span>
<a href="#l12.855"></a><span id="l12.855">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineminus">-          this.mOffset = val * this.numHours;</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineminus">-          this.showState();</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineminus">-          return val;</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineplus">+            this.mOffset = val * this.numHours;</span>
<a href="#l12.860"></a><span id="l12.860" class="difflineplus">+            this.showState();</span>
<a href="#l12.861"></a><span id="l12.861" class="difflineplus">+            return val;</span>
<a href="#l12.862"></a><span id="l12.862">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.863"></a><span id="l12.863">       &lt;/property&gt;</span>
<a href="#l12.864"></a><span id="l12.864"> </span>
<a href="#l12.865"></a><span id="l12.865">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l12.866"></a><span id="l12.866">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineminus">-          return this.contentWidth * this.mRange;</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineplus">+            return this.contentWidth * this.mRange;</span>
<a href="#l12.869"></a><span id="l12.869">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.870"></a><span id="l12.870">       &lt;/property&gt;</span>
<a href="#l12.871"></a><span id="l12.871"> </span>
<a href="#l12.872"></a><span id="l12.872">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l12.873"></a><span id="l12.873">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineminus">-          // How much pixels spans a single day</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineminus">-          let oneday = this.contentWidth;</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineminus">-          if (oneday &lt;= 0) {</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineminus">-              return val;</span>
<a href="#l12.878"></a><span id="l12.878" class="difflineminus">-          }</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineplus">+            // How much pixels spans a single day</span>
<a href="#l12.880"></a><span id="l12.880" class="difflineplus">+            let oneday = this.contentWidth;</span>
<a href="#l12.881"></a><span id="l12.881" class="difflineplus">+            if (oneday &lt;= 0) {</span>
<a href="#l12.882"></a><span id="l12.882" class="difflineplus">+                return val;</span>
<a href="#l12.883"></a><span id="l12.883" class="difflineplus">+            }</span>
<a href="#l12.884"></a><span id="l12.884"> </span>
<a href="#l12.885"></a><span id="l12.885" class="difflineminus">-          // The difference in pixels between the content and the container.</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineminus">-          let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.887"></a><span id="l12.887" class="difflineplus">+            // The difference in pixels between the content and the container.</span>
<a href="#l12.888"></a><span id="l12.888" class="difflineplus">+            let shift = (oneday * this.mRange) - (this.containerWidth);</span>
<a href="#l12.889"></a><span id="l12.889"> </span>
<a href="#l12.890"></a><span id="l12.890" class="difflineminus">-          // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l12.891"></a><span id="l12.891" class="difflineminus">-          // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l12.892"></a><span id="l12.892" class="difflineminus">-          let offset = Math.floor(val * shift);</span>
<a href="#l12.893"></a><span id="l12.893" class="difflineplus">+            // Now calculate the (positive) offset in pixels which the content</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineplus">+            // needs to be shifted. This is a simple scaling in one dimension.</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineplus">+            let offset = Math.floor(val * shift);</span>
<a href="#l12.896"></a><span id="l12.896"> </span>
<a href="#l12.897"></a><span id="l12.897" class="difflineminus">-          // Now find out how much days this offset effectively skips.</span>
<a href="#l12.898"></a><span id="l12.898" class="difflineminus">-          // this is a simple division which always yields a positive integer value.</span>
<a href="#l12.899"></a><span id="l12.899" class="difflineminus">-          this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l12.900"></a><span id="l12.900" class="difflineplus">+            // Now find out how much days this offset effectively skips.</span>
<a href="#l12.901"></a><span id="l12.901" class="difflineplus">+            // this is a simple division which always yields a positive integer value.</span>
<a href="#l12.902"></a><span id="l12.902" class="difflineplus">+            this.dayOffset = (offset - (offset % oneday)) / oneday;</span>
<a href="#l12.903"></a><span id="l12.903"> </span>
<a href="#l12.904"></a><span id="l12.904" class="difflineminus">-          // Set the pixel offset for the content which will always need</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineminus">-          // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l12.906"></a><span id="l12.906" class="difflineminus">-          offset %= oneday;</span>
<a href="#l12.907"></a><span id="l12.907" class="difflineplus">+            // Set the pixel offset for the content which will always need</span>
<a href="#l12.908"></a><span id="l12.908" class="difflineplus">+            // to be in the range [0 &lt;= offset &lt;= oneday].</span>
<a href="#l12.909"></a><span id="l12.909" class="difflineplus">+            offset %= oneday;</span>
<a href="#l12.910"></a><span id="l12.910"> </span>
<a href="#l12.911"></a><span id="l12.911" class="difflineminus">-          // Set the offset at the content node.</span>
<a href="#l12.912"></a><span id="l12.912" class="difflineminus">-          let container =</span>
<a href="#l12.913"></a><span id="l12.913" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.914"></a><span id="l12.914" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.915"></a><span id="l12.915" class="difflineminus">-          container.x = offset;</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineminus">-          return val;</span>
<a href="#l12.917"></a><span id="l12.917" class="difflineplus">+            // Set the offset at the content node.</span>
<a href="#l12.918"></a><span id="l12.918" class="difflineplus">+            let container =</span>
<a href="#l12.919"></a><span id="l12.919" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.920"></a><span id="l12.920" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l12.921"></a><span id="l12.921" class="difflineplus">+            container.x = offset;</span>
<a href="#l12.922"></a><span id="l12.922" class="difflineplus">+            return val;</span>
<a href="#l12.923"></a><span id="l12.923">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.924"></a><span id="l12.924">       &lt;/property&gt;</span>
<a href="#l12.925"></a><span id="l12.925"> </span>
<a href="#l12.926"></a><span id="l12.926">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.927"></a><span id="l12.927" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.928"></a><span id="l12.928" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.929"></a><span id="l12.929" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.930"></a><span id="l12.930" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.931"></a><span id="l12.931"> </span>
<a href="#l12.932"></a><span id="l12.932" class="difflineminus">-        this.initTimeRange();</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineminus">-        this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineminus">-        this.onLoad();</span>
<a href="#l12.935"></a><span id="l12.935" class="difflineplus">+          this.initTimeRange();</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineplus">+          this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineplus">+          this.onLoad();</span>
<a href="#l12.938"></a><span id="l12.938">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.939"></a><span id="l12.939"> </span>
<a href="#l12.940"></a><span id="l12.940">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l12.941"></a><span id="l12.941">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.942"></a><span id="l12.942" class="difflineminus">-          let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.943"></a><span id="l12.943" class="difflineminus">-          this.mState = new Array(this.mRange * numHours);</span>
<a href="#l12.944"></a><span id="l12.944" class="difflineminus">-          for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.945"></a><span id="l12.945" class="difflineminus">-              this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l12.946"></a><span id="l12.946" class="difflineminus">-          }</span>
<a href="#l12.947"></a><span id="l12.947" class="difflineplus">+            let numHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.948"></a><span id="l12.948" class="difflineplus">+            this.mState = new Array(this.mRange * numHours);</span>
<a href="#l12.949"></a><span id="l12.949" class="difflineplus">+            for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.950"></a><span id="l12.950" class="difflineplus">+                this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l12.951"></a><span id="l12.951" class="difflineplus">+            }</span>
<a href="#l12.952"></a><span id="l12.952"> </span>
<a href="#l12.953"></a><span id="l12.953" class="difflineminus">-          let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineminus">-          let formatter = Components.classes[</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineminus">-              &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l12.956"></a><span id="l12.956" class="difflineminus">-                  .getService(</span>
<a href="#l12.957"></a><span id="l12.957" class="difflineminus">-                      Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineminus">-          let date = cal.jsDateToDateTime(new Date());</span>
<a href="#l12.959"></a><span id="l12.959" class="difflineminus">-          date.hour = this.mStartHour;</span>
<a href="#l12.960"></a><span id="l12.960" class="difflineminus">-          date.minute = 0;</span>
<a href="#l12.961"></a><span id="l12.961" class="difflineminus">-          let hours =</span>
<a href="#l12.962"></a><span id="l12.962" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.963"></a><span id="l12.963" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.964"></a><span id="l12.964" class="difflineminus">-          if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l12.965"></a><span id="l12.965" class="difflineminus">-              let template = createXULElement(&quot;text&quot;);</span>
<a href="#l12.966"></a><span id="l12.966" class="difflineminus">-              template.className = &quot;freebusy-grid&quot;;</span>
<a href="#l12.967"></a><span id="l12.967" class="difflineminus">-              // TODO: hardcoded value</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineminus">-              let num_days = Math.max(2, 4 * this.mZoomFactor / 100);</span>
<a href="#l12.969"></a><span id="l12.969" class="difflineminus">-              let count = Math.ceil(</span>
<a href="#l12.970"></a><span id="l12.970" class="difflineminus">-                  (this.mEndHour - this.mStartHour) * 60 / step_in_minutes);</span>
<a href="#l12.971"></a><span id="l12.971" class="difflineminus">-              let remain = count;</span>
<a href="#l12.972"></a><span id="l12.972" class="difflineminus">-              for (let day = 1; day &lt;= num_days; day++) {</span>
<a href="#l12.973"></a><span id="l12.973" class="difflineminus">-                  let first = true;</span>
<a href="#l12.974"></a><span id="l12.974" class="difflineminus">-                  while (remain--) {</span>
<a href="#l12.975"></a><span id="l12.975" class="difflineminus">-                      let newNode = template.cloneNode(false);</span>
<a href="#l12.976"></a><span id="l12.976" class="difflineminus">-                      let value = formatter.formatTime(date);</span>
<a href="#l12.977"></a><span id="l12.977" class="difflineminus">-                      if (first) {</span>
<a href="#l12.978"></a><span id="l12.978" class="difflineminus">-                          newNode.className += &quot; first-in-day&quot;;</span>
<a href="#l12.979"></a><span id="l12.979" class="difflineminus">-                          first = false;</span>
<a href="#l12.980"></a><span id="l12.980" class="difflineminus">-                      }</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineplus">+            let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineplus">+            let formatter = Components.classes[</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineplus">+                &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l12.984"></a><span id="l12.984" class="difflineplus">+                    .getService(</span>
<a href="#l12.985"></a><span id="l12.985" class="difflineplus">+                        Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l12.986"></a><span id="l12.986" class="difflineplus">+            let date = cal.jsDateToDateTime(new Date());</span>
<a href="#l12.987"></a><span id="l12.987" class="difflineplus">+            date.hour = this.mStartHour;</span>
<a href="#l12.988"></a><span id="l12.988" class="difflineplus">+            date.minute = 0;</span>
<a href="#l12.989"></a><span id="l12.989" class="difflineplus">+            let hours =</span>
<a href="#l12.990"></a><span id="l12.990" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.991"></a><span id="l12.991" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.992"></a><span id="l12.992" class="difflineplus">+            if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l12.993"></a><span id="l12.993" class="difflineplus">+                let template = createXULElement(&quot;text&quot;);</span>
<a href="#l12.994"></a><span id="l12.994" class="difflineplus">+                template.className = &quot;freebusy-grid&quot;;</span>
<a href="#l12.995"></a><span id="l12.995" class="difflineplus">+                // TODO: hardcoded value</span>
<a href="#l12.996"></a><span id="l12.996" class="difflineplus">+                let num_days = Math.max(2, 4 * this.mZoomFactor / 100);</span>
<a href="#l12.997"></a><span id="l12.997" class="difflineplus">+                let count = Math.ceil(</span>
<a href="#l12.998"></a><span id="l12.998" class="difflineplus">+                    (this.mEndHour - this.mStartHour) * 60 / step_in_minutes);</span>
<a href="#l12.999"></a><span id="l12.999" class="difflineplus">+                let remain = count;</span>
<a href="#l12.1000"></a><span id="l12.1000" class="difflineplus">+                for (let day = 1; day &lt;= num_days; day++) {</span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineplus">+                    let first = true;</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineplus">+                    while (remain--) {</span>
<a href="#l12.1003"></a><span id="l12.1003" class="difflineplus">+                        let newNode = template.cloneNode(false);</span>
<a href="#l12.1004"></a><span id="l12.1004" class="difflineplus">+                        let value = formatter.formatTime(date);</span>
<a href="#l12.1005"></a><span id="l12.1005" class="difflineplus">+                        if (first) {</span>
<a href="#l12.1006"></a><span id="l12.1006" class="difflineplus">+                            newNode.className += &quot; first-in-day&quot;;</span>
<a href="#l12.1007"></a><span id="l12.1007" class="difflineplus">+                            first = false;</span>
<a href="#l12.1008"></a><span id="l12.1008" class="difflineplus">+                        }</span>
<a href="#l12.1009"></a><span id="l12.1009"> </span>
<a href="#l12.1010"></a><span id="l12.1010" class="difflineminus">-                      newNode.setAttribute(&quot;value&quot;, value);</span>
<a href="#l12.1011"></a><span id="l12.1011" class="difflineminus">-                      hours.appendChild(newNode);</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineminus">-                      date.minute += step_in_minutes;</span>
<a href="#l12.1013"></a><span id="l12.1013" class="difflineplus">+                        newNode.setAttribute(&quot;value&quot;, value);</span>
<a href="#l12.1014"></a><span id="l12.1014" class="difflineplus">+                        hours.appendChild(newNode);</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineplus">+                        date.minute += step_in_minutes;</span>
<a href="#l12.1016"></a><span id="l12.1016"> </span>
<a href="#l12.1017"></a><span id="l12.1017" class="difflineminus">-                      if (remain == 0) {</span>
<a href="#l12.1018"></a><span id="l12.1018" class="difflineminus">-                          newNode.className += &quot; last-in-day&quot;;</span>
<a href="#l12.1019"></a><span id="l12.1019" class="difflineminus">-                      }</span>
<a href="#l12.1020"></a><span id="l12.1020" class="difflineminus">-                  }</span>
<a href="#l12.1021"></a><span id="l12.1021" class="difflineminus">-                  date.hour = this.mStartHour;</span>
<a href="#l12.1022"></a><span id="l12.1022" class="difflineminus">-                  date.day++;</span>
<a href="#l12.1023"></a><span id="l12.1023" class="difflineminus">-                  remain = count;</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineminus">-              }</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineminus">-          }</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineplus">+                        if (remain == 0) {</span>
<a href="#l12.1027"></a><span id="l12.1027" class="difflineplus">+                            newNode.className += &quot; last-in-day&quot;;</span>
<a href="#l12.1028"></a><span id="l12.1028" class="difflineplus">+                        }</span>
<a href="#l12.1029"></a><span id="l12.1029" class="difflineplus">+                    }</span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineplus">+                    date.hour = this.mStartHour;</span>
<a href="#l12.1031"></a><span id="l12.1031" class="difflineplus">+                    date.day++;</span>
<a href="#l12.1032"></a><span id="l12.1032" class="difflineplus">+                    remain = count;</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineplus">+                }</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineplus">+            }</span>
<a href="#l12.1035"></a><span id="l12.1035">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1036"></a><span id="l12.1036">       &lt;/method&gt;</span>
<a href="#l12.1037"></a><span id="l12.1037"> </span>
<a href="#l12.1038"></a><span id="l12.1038">       &lt;method name=&quot;onFreeBusy&quot;&gt;</span>
<a href="#l12.1039"></a><span id="l12.1039">         &lt;parameter name=&quot;aEntries&quot;/&gt;</span>
<a href="#l12.1040"></a><span id="l12.1040">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1041"></a><span id="l12.1041" class="difflineminus">-          // The argument denotes the requested freebusy intervals.</span>
<a href="#l12.1042"></a><span id="l12.1042" class="difflineminus">-          // We need to set our state array according to this</span>
<a href="#l12.1043"></a><span id="l12.1043" class="difflineminus">-          // result. After the state has been updated we call showState()</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineminus">-          // which will map the entries to attributes on the xul elements.</span>
<a href="#l12.1045"></a><span id="l12.1045" class="difflineminus">-          if (aEntries) {</span>
<a href="#l12.1046"></a><span id="l12.1046" class="difflineminus">-              // Remember the free/busy array which is used to find a</span>
<a href="#l12.1047"></a><span id="l12.1047" class="difflineminus">-              // new time for an event. We store this array only if</span>
<a href="#l12.1048"></a><span id="l12.1048" class="difflineminus">-              // the provider returned a valid array. In any other case</span>
<a href="#l12.1049"></a><span id="l12.1049" class="difflineminus">-              // (temporarily clean the display) we keep the last know result.</span>
<a href="#l12.1050"></a><span id="l12.1050" class="difflineminus">-              this.mEntries = aEntries;</span>
<a href="#l12.1051"></a><span id="l12.1051" class="difflineplus">+            // The argument denotes the requested freebusy intervals.</span>
<a href="#l12.1052"></a><span id="l12.1052" class="difflineplus">+            // We need to set our state array according to this</span>
<a href="#l12.1053"></a><span id="l12.1053" class="difflineplus">+            // result. After the state has been updated we call showState()</span>
<a href="#l12.1054"></a><span id="l12.1054" class="difflineplus">+            // which will map the entries to attributes on the xul elements.</span>
<a href="#l12.1055"></a><span id="l12.1055" class="difflineplus">+            if (aEntries) {</span>
<a href="#l12.1056"></a><span id="l12.1056" class="difflineplus">+                // Remember the free/busy array which is used to find a</span>
<a href="#l12.1057"></a><span id="l12.1057" class="difflineplus">+                // new time for an event. We store this array only if</span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineplus">+                // the provider returned a valid array. In any other case</span>
<a href="#l12.1059"></a><span id="l12.1059" class="difflineplus">+                // (temporarily clean the display) we keep the last know result.</span>
<a href="#l12.1060"></a><span id="l12.1060" class="difflineplus">+                this.mEntries = aEntries;</span>
<a href="#l12.1061"></a><span id="l12.1061"> </span>
<a href="#l12.1062"></a><span id="l12.1062" class="difflineminus">-              let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1063"></a><span id="l12.1063" class="difflineplus">+                let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1064"></a><span id="l12.1064"> </span>
<a href="#l12.1065"></a><span id="l12.1065" class="difflineminus">-              let start = this.mStartDate.clone();</span>
<a href="#l12.1066"></a><span id="l12.1066" class="difflineminus">-              start.hour = 0;</span>
<a href="#l12.1067"></a><span id="l12.1067" class="difflineminus">-              start.minute = 0;</span>
<a href="#l12.1068"></a><span id="l12.1068" class="difflineminus">-              start.second = 0;</span>
<a href="#l12.1069"></a><span id="l12.1069" class="difflineminus">-              start.timezone = kDefaultTimezone;</span>
<a href="#l12.1070"></a><span id="l12.1070" class="difflineminus">-              let end = start.clone();</span>
<a href="#l12.1071"></a><span id="l12.1071" class="difflineminus">-              end.day += this.mRange;</span>
<a href="#l12.1072"></a><span id="l12.1072" class="difflineminus">-              end.timezone = kDefaultTimezone;</span>
<a href="#l12.1073"></a><span id="l12.1073" class="difflineplus">+                let start = this.mStartDate.clone();</span>
<a href="#l12.1074"></a><span id="l12.1074" class="difflineplus">+                start.hour = 0;</span>
<a href="#l12.1075"></a><span id="l12.1075" class="difflineplus">+                start.minute = 0;</span>
<a href="#l12.1076"></a><span id="l12.1076" class="difflineplus">+                start.second = 0;</span>
<a href="#l12.1077"></a><span id="l12.1077" class="difflineplus">+                start.timezone = kDefaultTimezone;</span>
<a href="#l12.1078"></a><span id="l12.1078" class="difflineplus">+                let end = start.clone();</span>
<a href="#l12.1079"></a><span id="l12.1079" class="difflineplus">+                end.day += this.mRange;</span>
<a href="#l12.1080"></a><span id="l12.1080" class="difflineplus">+                end.timezone = kDefaultTimezone;</span>
<a href="#l12.1081"></a><span id="l12.1081"> </span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineminus">-              // First of all set all state slots to 'free'</span>
<a href="#l12.1083"></a><span id="l12.1083" class="difflineminus">-              for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.1084"></a><span id="l12.1084" class="difflineminus">-                  this.mState[i] = Components.interfaces.calIFreeBusyInterval.FREE;</span>
<a href="#l12.1085"></a><span id="l12.1085" class="difflineminus">-              }</span>
<a href="#l12.1086"></a><span id="l12.1086" class="difflineplus">+                // First of all set all state slots to 'free'</span>
<a href="#l12.1087"></a><span id="l12.1087" class="difflineplus">+                for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.1088"></a><span id="l12.1088" class="difflineplus">+                    this.mState[i] = Components.interfaces.calIFreeBusyInterval.FREE;</span>
<a href="#l12.1089"></a><span id="l12.1089" class="difflineplus">+                }</span>
<a href="#l12.1090"></a><span id="l12.1090"> </span>
<a href="#l12.1091"></a><span id="l12.1091" class="difflineminus">-              // Iterate all incoming freebusy entries</span>
<a href="#l12.1092"></a><span id="l12.1092" class="difflineminus">-              for (let entry of aEntries) {</span>
<a href="#l12.1093"></a><span id="l12.1093" class="difflineminus">-                  let rangeStart = entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1094"></a><span id="l12.1094" class="difflineminus">-                  let rangeEnd = entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1095"></a><span id="l12.1095" class="difflineplus">+                // Iterate all incoming freebusy entries</span>
<a href="#l12.1096"></a><span id="l12.1096" class="difflineplus">+                for (let entry of aEntries) {</span>
<a href="#l12.1097"></a><span id="l12.1097" class="difflineplus">+                    let rangeStart = entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1098"></a><span id="l12.1098" class="difflineplus">+                    let rangeEnd = entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1099"></a><span id="l12.1099"> </span>
<a href="#l12.1100"></a><span id="l12.1100" class="difflineminus">-                  if (rangeStart.compare(start) &lt; 0) {</span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineminus">-                      rangeStart = start.clone();</span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineminus">-                  }</span>
<a href="#l12.1103"></a><span id="l12.1103" class="difflineminus">-                  if (rangeEnd.compare(end) &gt; 0) {</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineminus">-                      rangeEnd = end.clone();</span>
<a href="#l12.1105"></a><span id="l12.1105" class="difflineminus">-                  }</span>
<a href="#l12.1106"></a><span id="l12.1106" class="difflineplus">+                    if (rangeStart.compare(start) &lt; 0) {</span>
<a href="#l12.1107"></a><span id="l12.1107" class="difflineplus">+                        rangeStart = start.clone();</span>
<a href="#l12.1108"></a><span id="l12.1108" class="difflineplus">+                    }</span>
<a href="#l12.1109"></a><span id="l12.1109" class="difflineplus">+                    if (rangeEnd.compare(end) &gt; 0) {</span>
<a href="#l12.1110"></a><span id="l12.1110" class="difflineplus">+                        rangeEnd = end.clone();</span>
<a href="#l12.1111"></a><span id="l12.1111" class="difflineplus">+                    }</span>
<a href="#l12.1112"></a><span id="l12.1112"> </span>
<a href="#l12.1113"></a><span id="l12.1113" class="difflineminus">-                  let rangeDuration = rangeEnd.subtractDate(rangeStart);</span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineminus">-                  let rangeStartHour = rangeStart.hour;</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineminus">-                  let rangeEndHour = rangeStartHour + (rangeDuration.inSeconds / 3600);</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineplus">+                    let rangeDuration = rangeEnd.subtractDate(rangeStart);</span>
<a href="#l12.1117"></a><span id="l12.1117" class="difflineplus">+                    let rangeStartHour = rangeStart.hour;</span>
<a href="#l12.1118"></a><span id="l12.1118" class="difflineplus">+                    let rangeEndHour = rangeStartHour + (rangeDuration.inSeconds / 3600);</span>
<a href="#l12.1119"></a><span id="l12.1119"> </span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineminus">-                  if ((rangeStartHour &lt; this.mEndHour) &amp;&amp;</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineminus">-                      (rangeEndHour &gt;= this.mStartHour)) {</span>
<a href="#l12.1122"></a><span id="l12.1122" class="difflineminus">-                      let dayingrid = start.clone();</span>
<a href="#l12.1123"></a><span id="l12.1123" class="difflineminus">-                      dayingrid.year = rangeStart.year;</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineminus">-                      dayingrid.month = rangeStart.month;</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineminus">-                      dayingrid.day = rangeStart.day;</span>
<a href="#l12.1126"></a><span id="l12.1126" class="difflineminus">-                      dayingrid.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1127"></a><span id="l12.1127" class="difflineplus">+                    if ((rangeStartHour &lt; this.mEndHour) &amp;&amp;</span>
<a href="#l12.1128"></a><span id="l12.1128" class="difflineplus">+                        (rangeEndHour &gt;= this.mStartHour)) {</span>
<a href="#l12.1129"></a><span id="l12.1129" class="difflineplus">+                        let dayingrid = start.clone();</span>
<a href="#l12.1130"></a><span id="l12.1130" class="difflineplus">+                        dayingrid.year = rangeStart.year;</span>
<a href="#l12.1131"></a><span id="l12.1131" class="difflineplus">+                        dayingrid.month = rangeStart.month;</span>
<a href="#l12.1132"></a><span id="l12.1132" class="difflineplus">+                        dayingrid.day = rangeStart.day;</span>
<a href="#l12.1133"></a><span id="l12.1133" class="difflineplus">+                        dayingrid.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1134"></a><span id="l12.1134"> </span>
<a href="#l12.1135"></a><span id="l12.1135" class="difflineminus">-                      // Ok, this is an entry we're interested in. Find out</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineminus">-                      // which hours are actually occupied.</span>
<a href="#l12.1137"></a><span id="l12.1137" class="difflineminus">-                      let offset = rangeStart.subtractDate(dayingrid);</span>
<a href="#l12.1138"></a><span id="l12.1138" class="difflineplus">+                        // Ok, this is an entry we're interested in. Find out</span>
<a href="#l12.1139"></a><span id="l12.1139" class="difflineplus">+                        // which hours are actually occupied.</span>
<a href="#l12.1140"></a><span id="l12.1140" class="difflineplus">+                        let offset = rangeStart.subtractDate(dayingrid);</span>
<a href="#l12.1141"></a><span id="l12.1141"> </span>
<a href="#l12.1142"></a><span id="l12.1142" class="difflineminus">-                      // Calculate how many days we're offset from the</span>
<a href="#l12.1143"></a><span id="l12.1143" class="difflineminus">-                      // start of the grid. Eliminate hours in case</span>
<a href="#l12.1144"></a><span id="l12.1144" class="difflineminus">-                      // we encounter the daylight-saving hop.</span>
<a href="#l12.1145"></a><span id="l12.1145" class="difflineminus">-                      let dayoffset = dayingrid.subtractDate(start);</span>
<a href="#l12.1146"></a><span id="l12.1146" class="difflineminus">-                      dayoffset.hours = 0;</span>
<a href="#l12.1147"></a><span id="l12.1147" class="difflineplus">+                        // Calculate how many days we're offset from the</span>
<a href="#l12.1148"></a><span id="l12.1148" class="difflineplus">+                        // start of the grid. Eliminate hours in case</span>
<a href="#l12.1149"></a><span id="l12.1149" class="difflineplus">+                        // we encounter the daylight-saving hop.</span>
<a href="#l12.1150"></a><span id="l12.1150" class="difflineplus">+                        let dayoffset = dayingrid.subtractDate(start);</span>
<a href="#l12.1151"></a><span id="l12.1151" class="difflineplus">+                        dayoffset.hours = 0;</span>
<a href="#l12.1152"></a><span id="l12.1152"> </span>
<a href="#l12.1153"></a><span id="l12.1153" class="difflineminus">-                      // Add both offsets to find the total offset.</span>
<a href="#l12.1154"></a><span id="l12.1154" class="difflineminus">-                      // dayoffset -&gt; offset in days from start of grid</span>
<a href="#l12.1155"></a><span id="l12.1155" class="difflineminus">-                      // offset -&gt; offset in hours from start of current day</span>
<a href="#l12.1156"></a><span id="l12.1156" class="difflineminus">-                      offset.addDuration(dayoffset);</span>
<a href="#l12.1157"></a><span id="l12.1157" class="difflineplus">+                        // Add both offsets to find the total offset.</span>
<a href="#l12.1158"></a><span id="l12.1158" class="difflineplus">+                        // dayoffset -&gt; offset in days from start of grid</span>
<a href="#l12.1159"></a><span id="l12.1159" class="difflineplus">+                        // offset -&gt; offset in hours from start of current day</span>
<a href="#l12.1160"></a><span id="l12.1160" class="difflineplus">+                        offset.addDuration(dayoffset);</span>
<a href="#l12.1161"></a><span id="l12.1161"> </span>
<a href="#l12.1162"></a><span id="l12.1162" class="difflineminus">-                      let duration = rangeEnd.subtractDate(rangeStart);</span>
<a href="#l12.1163"></a><span id="l12.1163" class="difflineminus">-                      let start_in_minutes = Math.floor(offset.inSeconds / 60);</span>
<a href="#l12.1164"></a><span id="l12.1164" class="difflineminus">-                      let end_in_minutes = Math.ceil((duration.inSeconds / 60) +</span>
<a href="#l12.1165"></a><span id="l12.1165" class="difflineminus">-                                                     (offset.inSeconds / 60));</span>
<a href="#l12.1166"></a><span id="l12.1166" class="difflineplus">+                        let duration = rangeEnd.subtractDate(rangeStart);</span>
<a href="#l12.1167"></a><span id="l12.1167" class="difflineplus">+                        let start_in_minutes = Math.floor(offset.inSeconds / 60);</span>
<a href="#l12.1168"></a><span id="l12.1168" class="difflineplus">+                        let end_in_minutes = Math.ceil((duration.inSeconds / 60) +</span>
<a href="#l12.1169"></a><span id="l12.1169" class="difflineplus">+                                                       (offset.inSeconds / 60));</span>
<a href="#l12.1170"></a><span id="l12.1170"> </span>
<a href="#l12.1171"></a><span id="l12.1171" class="difflineminus">-                      let minute2offset = function(value, fNumHours, numHours, start_hour, zoomfactor) {</span>
<a href="#l12.1172"></a><span id="l12.1172" class="difflineminus">-                          // 'value' is some integer in the interval [0, range * 24 * 60].</span>
<a href="#l12.1173"></a><span id="l12.1173" class="difflineminus">-                          // we need to map this offset into our array which</span>
<a href="#l12.1174"></a><span id="l12.1174" class="difflineminus">-                          // holds elements for 'range' days with [start, end] hours each.</span>
<a href="#l12.1175"></a><span id="l12.1175" class="difflineminus">-                          let minutes_per_day = 24 * 60;</span>
<a href="#l12.1176"></a><span id="l12.1176" class="difflineminus">-                          let day = (value - (value % minutes_per_day)) / minutes_per_day;</span>
<a href="#l12.1177"></a><span id="l12.1177" class="difflineminus">-                          let minute = Math.floor(value % minutes_per_day) - (start_hour * 60);</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineplus">+                        let minute2offset = function(value, fNumHours, numHours, start_hour, zoomfactor) {</span>
<a href="#l12.1179"></a><span id="l12.1179" class="difflineplus">+                            // 'value' is some integer in the interval [0, range * 24 * 60].</span>
<a href="#l12.1180"></a><span id="l12.1180" class="difflineplus">+                            // we need to map this offset into our array which</span>
<a href="#l12.1181"></a><span id="l12.1181" class="difflineplus">+                            // holds elements for 'range' days with [start, end] hours each.</span>
<a href="#l12.1182"></a><span id="l12.1182" class="difflineplus">+                            let minutes_per_day = 24 * 60;</span>
<a href="#l12.1183"></a><span id="l12.1183" class="difflineplus">+                            let day = (value - (value % minutes_per_day)) / minutes_per_day;</span>
<a href="#l12.1184"></a><span id="l12.1184" class="difflineplus">+                            let minute = Math.floor(value % minutes_per_day) - (start_hour * 60);</span>
<a href="#l12.1185"></a><span id="l12.1185"> </span>
<a href="#l12.1186"></a><span id="l12.1186" class="difflineminus">-                          minute = Math.max(0, minute);</span>
<a href="#l12.1187"></a><span id="l12.1187" class="difflineplus">+                            minute = Math.max(0, minute);</span>
<a href="#l12.1188"></a><span id="l12.1188"> </span>
<a href="#l12.1189"></a><span id="l12.1189" class="difflineminus">-                          if (minute &gt;= (numHours * 60)) {</span>
<a href="#l12.1190"></a><span id="l12.1190" class="difflineminus">-                              minute = (numHours * 60) - 1;</span>
<a href="#l12.1191"></a><span id="l12.1191" class="difflineminus">-                          }</span>
<a href="#l12.1192"></a><span id="l12.1192" class="difflineminus">-                          // How to get from minutes to offset?</span>
<a href="#l12.1193"></a><span id="l12.1193" class="difflineminus">-                          // 60 = 100%, 30 = 50%, 15 = 25%, etc.</span>
<a href="#l12.1194"></a><span id="l12.1194" class="difflineminus">-                          let minutes_per_block = 60 * zoomfactor / 100;</span>
<a href="#l12.1195"></a><span id="l12.1195" class="difflineplus">+                            if (minute &gt;= (numHours * 60)) {</span>
<a href="#l12.1196"></a><span id="l12.1196" class="difflineplus">+                                minute = (numHours * 60) - 1;</span>
<a href="#l12.1197"></a><span id="l12.1197" class="difflineplus">+                            }</span>
<a href="#l12.1198"></a><span id="l12.1198" class="difflineplus">+                            // How to get from minutes to offset?</span>
<a href="#l12.1199"></a><span id="l12.1199" class="difflineplus">+                            // 60 = 100%, 30 = 50%, 15 = 25%, etc.</span>
<a href="#l12.1200"></a><span id="l12.1200" class="difflineplus">+                            let minutes_per_block = 60 * zoomfactor / 100;</span>
<a href="#l12.1201"></a><span id="l12.1201"> </span>
<a href="#l12.1202"></a><span id="l12.1202" class="difflineminus">-                          let block = Math.floor(minute / minutes_per_block);</span>
<a href="#l12.1203"></a><span id="l12.1203" class="difflineplus">+                            let block = Math.floor(minute / minutes_per_block);</span>
<a href="#l12.1204"></a><span id="l12.1204"> </span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineminus">-                          return Math.ceil(fNumHours) * day + block;</span>
<a href="#l12.1206"></a><span id="l12.1206" class="difflineminus">-                      };</span>
<a href="#l12.1207"></a><span id="l12.1207" class="difflineplus">+                            return Math.ceil(fNumHours) * day + block;</span>
<a href="#l12.1208"></a><span id="l12.1208" class="difflineplus">+                        };</span>
<a href="#l12.1209"></a><span id="l12.1209"> </span>
<a href="#l12.1210"></a><span id="l12.1210" class="difflineminus">-                      // Number of hours (fractional representation)</span>
<a href="#l12.1211"></a><span id="l12.1211" class="difflineminus">-                      let calcNumHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.1212"></a><span id="l12.1212" class="difflineminus">-                      let fNumHours = calcNumHours * 100 / this.mZoomFactor;</span>
<a href="#l12.1213"></a><span id="l12.1213" class="difflineplus">+                        // Number of hours (fractional representation)</span>
<a href="#l12.1214"></a><span id="l12.1214" class="difflineplus">+                        let calcNumHours = this.mEndHour - this.mStartHour;</span>
<a href="#l12.1215"></a><span id="l12.1215" class="difflineplus">+                        let fNumHours = calcNumHours * 100 / this.mZoomFactor;</span>
<a href="#l12.1216"></a><span id="l12.1216"> </span>
<a href="#l12.1217"></a><span id="l12.1217" class="difflineminus">-                      let start_offset =</span>
<a href="#l12.1218"></a><span id="l12.1218" class="difflineminus">-                          minute2offset(start_in_minutes,</span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineminus">-                                        fNumHours,</span>
<a href="#l12.1220"></a><span id="l12.1220" class="difflineminus">-                                        calcNumHours,</span>
<a href="#l12.1221"></a><span id="l12.1221" class="difflineminus">-                                        this.mStartHour,</span>
<a href="#l12.1222"></a><span id="l12.1222" class="difflineminus">-                                        this.mZoomFactor);</span>
<a href="#l12.1223"></a><span id="l12.1223" class="difflineminus">-                      let end_offset =</span>
<a href="#l12.1224"></a><span id="l12.1224" class="difflineminus">-                          minute2offset(end_in_minutes - 1,</span>
<a href="#l12.1225"></a><span id="l12.1225" class="difflineminus">-                                        fNumHours,</span>
<a href="#l12.1226"></a><span id="l12.1226" class="difflineminus">-                                        calcNumHours,</span>
<a href="#l12.1227"></a><span id="l12.1227" class="difflineminus">-                                        this.mStartHour,</span>
<a href="#l12.1228"></a><span id="l12.1228" class="difflineminus">-                                        this.mZoomFactor);</span>
<a href="#l12.1229"></a><span id="l12.1229" class="difflineplus">+                        let start_offset =</span>
<a href="#l12.1230"></a><span id="l12.1230" class="difflineplus">+                            minute2offset(start_in_minutes,</span>
<a href="#l12.1231"></a><span id="l12.1231" class="difflineplus">+                                          fNumHours,</span>
<a href="#l12.1232"></a><span id="l12.1232" class="difflineplus">+                                          calcNumHours,</span>
<a href="#l12.1233"></a><span id="l12.1233" class="difflineplus">+                                          this.mStartHour,</span>
<a href="#l12.1234"></a><span id="l12.1234" class="difflineplus">+                                          this.mZoomFactor);</span>
<a href="#l12.1235"></a><span id="l12.1235" class="difflineplus">+                        let end_offset =</span>
<a href="#l12.1236"></a><span id="l12.1236" class="difflineplus">+                            minute2offset(end_in_minutes - 1,</span>
<a href="#l12.1237"></a><span id="l12.1237" class="difflineplus">+                                          fNumHours,</span>
<a href="#l12.1238"></a><span id="l12.1238" class="difflineplus">+                                          calcNumHours,</span>
<a href="#l12.1239"></a><span id="l12.1239" class="difflineplus">+                                          this.mStartHour,</span>
<a href="#l12.1240"></a><span id="l12.1240" class="difflineplus">+                                          this.mZoomFactor);</span>
<a href="#l12.1241"></a><span id="l12.1241"> </span>
<a href="#l12.1242"></a><span id="l12.1242" class="difflineminus">-                      // Set all affected state slots</span>
<a href="#l12.1243"></a><span id="l12.1243" class="difflineminus">-                      for (let i = start_offset; i &lt;= end_offset; i++) {</span>
<a href="#l12.1244"></a><span id="l12.1244" class="difflineminus">-                          this.mState[i] = entry.freeBusyType;</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineminus">-                      }</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineminus">-                  }</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineminus">-              }</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineminus">-          } else {</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineminus">-              // First of all set all state slots to 'unknown'</span>
<a href="#l12.1250"></a><span id="l12.1250" class="difflineminus">-              for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.1251"></a><span id="l12.1251" class="difflineminus">-                  this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l12.1252"></a><span id="l12.1252" class="difflineminus">-              }</span>
<a href="#l12.1253"></a><span id="l12.1253" class="difflineminus">-          }</span>
<a href="#l12.1254"></a><span id="l12.1254" class="difflineplus">+                        // Set all affected state slots</span>
<a href="#l12.1255"></a><span id="l12.1255" class="difflineplus">+                        for (let i = start_offset; i &lt;= end_offset; i++) {</span>
<a href="#l12.1256"></a><span id="l12.1256" class="difflineplus">+                            this.mState[i] = entry.freeBusyType;</span>
<a href="#l12.1257"></a><span id="l12.1257" class="difflineplus">+                        }</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineplus">+                    }</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineplus">+                }</span>
<a href="#l12.1260"></a><span id="l12.1260" class="difflineplus">+            } else {</span>
<a href="#l12.1261"></a><span id="l12.1261" class="difflineplus">+                // First of all set all state slots to 'unknown'</span>
<a href="#l12.1262"></a><span id="l12.1262" class="difflineplus">+                for (let i = 0; i &lt; this.mState.length; i++) {</span>
<a href="#l12.1263"></a><span id="l12.1263" class="difflineplus">+                    this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineplus">+                }</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+            }</span>
<a href="#l12.1266"></a><span id="l12.1266"> </span>
<a href="#l12.1267"></a><span id="l12.1267" class="difflineminus">-          this.showState();</span>
<a href="#l12.1268"></a><span id="l12.1268" class="difflineplus">+            this.showState();</span>
<a href="#l12.1269"></a><span id="l12.1269">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1270"></a><span id="l12.1270">       &lt;/method&gt;</span>
<a href="#l12.1271"></a><span id="l12.1271"> </span>
<a href="#l12.1272"></a><span id="l12.1272">       &lt;method name=&quot;showState&quot;&gt;</span>
<a href="#l12.1273"></a><span id="l12.1273">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1274"></a><span id="l12.1274" class="difflineminus">-          let hours =</span>
<a href="#l12.1275"></a><span id="l12.1275" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1276"></a><span id="l12.1276" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.1277"></a><span id="l12.1277" class="difflineminus">-          for (let i = 0; i &lt; hours.childNodes.length; i++) {</span>
<a href="#l12.1278"></a><span id="l12.1278" class="difflineminus">-              let hour = hours.childNodes[i];</span>
<a href="#l12.1279"></a><span id="l12.1279" class="difflineminus">-              switch (this.mState[i + this.mOffset]) {</span>
<a href="#l12.1280"></a><span id="l12.1280" class="difflineminus">-                  case Components.interfaces.calIFreeBusyInterval.FREE:</span>
<a href="#l12.1281"></a><span id="l12.1281" class="difflineminus">-                      hour.setAttribute(&quot;state&quot;, &quot;free&quot;);</span>
<a href="#l12.1282"></a><span id="l12.1282" class="difflineminus">-                      break;</span>
<a href="#l12.1283"></a><span id="l12.1283" class="difflineminus">-                  case Components.interfaces.calIFreeBusyInterval.BUSY:</span>
<a href="#l12.1284"></a><span id="l12.1284" class="difflineminus">-                      hour.setAttribute(&quot;state&quot;, &quot;busy&quot;);</span>
<a href="#l12.1285"></a><span id="l12.1285" class="difflineminus">-                      break;</span>
<a href="#l12.1286"></a><span id="l12.1286" class="difflineminus">-                  case Components.interfaces.calIFreeBusyInterval.BUSY_TENTATIVE:</span>
<a href="#l12.1287"></a><span id="l12.1287" class="difflineminus">-                      hour.setAttribute(&quot;state&quot;, &quot;busy_tentative&quot;);</span>
<a href="#l12.1288"></a><span id="l12.1288" class="difflineminus">-                      break;</span>
<a href="#l12.1289"></a><span id="l12.1289" class="difflineminus">-                  case Components.interfaces.calIFreeBusyInterval.BUSY_UNAVAILABLE:</span>
<a href="#l12.1290"></a><span id="l12.1290" class="difflineminus">-                      hour.setAttribute(&quot;state&quot;, &quot;busy_unavailable&quot;);</span>
<a href="#l12.1291"></a><span id="l12.1291" class="difflineminus">-                      break;</span>
<a href="#l12.1292"></a><span id="l12.1292" class="difflineminus">-                  default:</span>
<a href="#l12.1293"></a><span id="l12.1293" class="difflineminus">-                      hour.removeAttribute(&quot;state&quot;);</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineminus">-              }</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineminus">-          }</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineplus">+            let hours =</span>
<a href="#l12.1297"></a><span id="l12.1297" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1298"></a><span id="l12.1298" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l12.1299"></a><span id="l12.1299" class="difflineplus">+            for (let i = 0; i &lt; hours.childNodes.length; i++) {</span>
<a href="#l12.1300"></a><span id="l12.1300" class="difflineplus">+                let hour = hours.childNodes[i];</span>
<a href="#l12.1301"></a><span id="l12.1301" class="difflineplus">+                switch (this.mState[i + this.mOffset]) {</span>
<a href="#l12.1302"></a><span id="l12.1302" class="difflineplus">+                    case Components.interfaces.calIFreeBusyInterval.FREE:</span>
<a href="#l12.1303"></a><span id="l12.1303" class="difflineplus">+                        hour.setAttribute(&quot;state&quot;, &quot;free&quot;);</span>
<a href="#l12.1304"></a><span id="l12.1304" class="difflineplus">+                        break;</span>
<a href="#l12.1305"></a><span id="l12.1305" class="difflineplus">+                    case Components.interfaces.calIFreeBusyInterval.BUSY:</span>
<a href="#l12.1306"></a><span id="l12.1306" class="difflineplus">+                        hour.setAttribute(&quot;state&quot;, &quot;busy&quot;);</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineplus">+                        break;</span>
<a href="#l12.1308"></a><span id="l12.1308" class="difflineplus">+                    case Components.interfaces.calIFreeBusyInterval.BUSY_TENTATIVE:</span>
<a href="#l12.1309"></a><span id="l12.1309" class="difflineplus">+                        hour.setAttribute(&quot;state&quot;, &quot;busy_tentative&quot;);</span>
<a href="#l12.1310"></a><span id="l12.1310" class="difflineplus">+                        break;</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineplus">+                    case Components.interfaces.calIFreeBusyInterval.BUSY_UNAVAILABLE:</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineplus">+                        hour.setAttribute(&quot;state&quot;, &quot;busy_unavailable&quot;);</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineplus">+                        break;</span>
<a href="#l12.1314"></a><span id="l12.1314" class="difflineplus">+                    default:</span>
<a href="#l12.1315"></a><span id="l12.1315" class="difflineplus">+                        hour.removeAttribute(&quot;state&quot;);</span>
<a href="#l12.1316"></a><span id="l12.1316" class="difflineplus">+                }</span>
<a href="#l12.1317"></a><span id="l12.1317" class="difflineplus">+            }</span>
<a href="#l12.1318"></a><span id="l12.1318">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1319"></a><span id="l12.1319">       &lt;/method&gt;</span>
<a href="#l12.1320"></a><span id="l12.1320"> </span>
<a href="#l12.1321"></a><span id="l12.1321">       &lt;method name=&quot;nextSlot&quot;&gt;</span>
<a href="#l12.1322"></a><span id="l12.1322">         &lt;parameter name=&quot;aStartTime&quot;/&gt;</span>
<a href="#l12.1323"></a><span id="l12.1323">         &lt;parameter name=&quot;aEndTime&quot;/&gt;</span>
<a href="#l12.1324"></a><span id="l12.1324">         &lt;parameter name=&quot;allDay&quot;/&gt;</span>
<a href="#l12.1325"></a><span id="l12.1325">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1326"></a><span id="l12.1326" class="difflineminus">-          let newTime = aStartTime.clone();</span>
<a href="#l12.1327"></a><span id="l12.1327" class="difflineminus">-          let duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l12.1328"></a><span id="l12.1328" class="difflineminus">-          let newEndTime = newTime.clone();</span>
<a href="#l12.1329"></a><span id="l12.1329" class="difflineminus">-          newEndTime.addDuration(duration);</span>
<a href="#l12.1330"></a><span id="l12.1330" class="difflineplus">+            let newTime = aStartTime.clone();</span>
<a href="#l12.1331"></a><span id="l12.1331" class="difflineplus">+            let duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l12.1332"></a><span id="l12.1332" class="difflineplus">+            let newEndTime = newTime.clone();</span>
<a href="#l12.1333"></a><span id="l12.1333" class="difflineplus">+            newEndTime.addDuration(duration);</span>
<a href="#l12.1334"></a><span id="l12.1334"> </span>
<a href="#l12.1335"></a><span id="l12.1335" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1336"></a><span id="l12.1336" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1337"></a><span id="l12.1337"> </span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineminus">-          if (this.mEntries) {</span>
<a href="#l12.1339"></a><span id="l12.1339" class="difflineminus">-              for (let entry of this.mEntries) {</span>
<a href="#l12.1340"></a><span id="l12.1340" class="difflineminus">-                  let rangeStart =</span>
<a href="#l12.1341"></a><span id="l12.1341" class="difflineminus">-                      entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1342"></a><span id="l12.1342" class="difflineminus">-                  let rangeEnd =</span>
<a href="#l12.1343"></a><span id="l12.1343" class="difflineminus">-                      entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1344"></a><span id="l12.1344" class="difflineplus">+            if (this.mEntries) {</span>
<a href="#l12.1345"></a><span id="l12.1345" class="difflineplus">+                for (let entry of this.mEntries) {</span>
<a href="#l12.1346"></a><span id="l12.1346" class="difflineplus">+                    let rangeStart =</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineplus">+                        entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1348"></a><span id="l12.1348" class="difflineplus">+                    let rangeEnd =</span>
<a href="#l12.1349"></a><span id="l12.1349" class="difflineplus">+                        entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1350"></a><span id="l12.1350"> </span>
<a href="#l12.1351"></a><span id="l12.1351" class="difflineminus">-                  let isZeroLength = !newTime.compare(newEndTime);</span>
<a href="#l12.1352"></a><span id="l12.1352" class="difflineminus">-                  if ((isZeroLength &amp;&amp;</span>
<a href="#l12.1353"></a><span id="l12.1353" class="difflineminus">-                       newTime.compare(rangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l12.1354"></a><span id="l12.1354" class="difflineminus">-                       newTime.compare(rangeEnd) &lt; 0) ||</span>
<a href="#l12.1355"></a><span id="l12.1355" class="difflineminus">-                      (!isZeroLength &amp;&amp;</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineminus">-                       newTime.compare(rangeEnd) &lt; 0 &amp;&amp;</span>
<a href="#l12.1357"></a><span id="l12.1357" class="difflineminus">-                       newEndTime.compare(rangeStart) &gt; 0)) {</span>
<a href="#l12.1358"></a><span id="l12.1358" class="difflineminus">-                      // Current range of event conflicts with another event.</span>
<a href="#l12.1359"></a><span id="l12.1359" class="difflineminus">-                      // we need to find a new time for this event. A trivial approach</span>
<a href="#l12.1360"></a><span id="l12.1360" class="difflineminus">-                      // is to set the new start-time of the event equal to the end-time</span>
<a href="#l12.1361"></a><span id="l12.1361" class="difflineminus">-                      // of the conflict-range. All-day events need to be considered</span>
<a href="#l12.1362"></a><span id="l12.1362" class="difflineminus">-                      // separately, in which case we skip to the next day.</span>
<a href="#l12.1363"></a><span id="l12.1363" class="difflineminus">-                      newTime = rangeEnd.clone();</span>
<a href="#l12.1364"></a><span id="l12.1364" class="difflineminus">-                      if (allDay) {</span>
<a href="#l12.1365"></a><span id="l12.1365" class="difflineminus">-                          if (!((newTime.hour == 0) &amp;&amp;</span>
<a href="#l12.1366"></a><span id="l12.1366" class="difflineminus">-                               (newTime.minute == 0) &amp;&amp;</span>
<a href="#l12.1367"></a><span id="l12.1367" class="difflineminus">-                               (newTime.second == 0))) {</span>
<a href="#l12.1368"></a><span id="l12.1368" class="difflineminus">-                              newTime.day++;</span>
<a href="#l12.1369"></a><span id="l12.1369" class="difflineminus">-                              newTime.hour = 0;</span>
<a href="#l12.1370"></a><span id="l12.1370" class="difflineminus">-                              newTime.minute = 0;</span>
<a href="#l12.1371"></a><span id="l12.1371" class="difflineminus">-                              newTime.second = 0;</span>
<a href="#l12.1372"></a><span id="l12.1372" class="difflineminus">-                          }</span>
<a href="#l12.1373"></a><span id="l12.1373" class="difflineminus">-                      }</span>
<a href="#l12.1374"></a><span id="l12.1374" class="difflineminus">-                      newEndTime = newTime.clone();</span>
<a href="#l12.1375"></a><span id="l12.1375" class="difflineminus">-                      newEndTime.addDuration(duration);</span>
<a href="#l12.1376"></a><span id="l12.1376" class="difflineminus">-                  }</span>
<a href="#l12.1377"></a><span id="l12.1377" class="difflineminus">-              }</span>
<a href="#l12.1378"></a><span id="l12.1378" class="difflineminus">-          }</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineplus">+                    let isZeroLength = !newTime.compare(newEndTime);</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineplus">+                    if ((isZeroLength &amp;&amp;</span>
<a href="#l12.1381"></a><span id="l12.1381" class="difflineplus">+                         newTime.compare(rangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l12.1382"></a><span id="l12.1382" class="difflineplus">+                         newTime.compare(rangeEnd) &lt; 0) ||</span>
<a href="#l12.1383"></a><span id="l12.1383" class="difflineplus">+                        (!isZeroLength &amp;&amp;</span>
<a href="#l12.1384"></a><span id="l12.1384" class="difflineplus">+                         newTime.compare(rangeEnd) &lt; 0 &amp;&amp;</span>
<a href="#l12.1385"></a><span id="l12.1385" class="difflineplus">+                         newEndTime.compare(rangeStart) &gt; 0)) {</span>
<a href="#l12.1386"></a><span id="l12.1386" class="difflineplus">+                        // Current range of event conflicts with another event.</span>
<a href="#l12.1387"></a><span id="l12.1387" class="difflineplus">+                        // we need to find a new time for this event. A trivial approach</span>
<a href="#l12.1388"></a><span id="l12.1388" class="difflineplus">+                        // is to set the new start-time of the event equal to the end-time</span>
<a href="#l12.1389"></a><span id="l12.1389" class="difflineplus">+                        // of the conflict-range. All-day events need to be considered</span>
<a href="#l12.1390"></a><span id="l12.1390" class="difflineplus">+                        // separately, in which case we skip to the next day.</span>
<a href="#l12.1391"></a><span id="l12.1391" class="difflineplus">+                        newTime = rangeEnd.clone();</span>
<a href="#l12.1392"></a><span id="l12.1392" class="difflineplus">+                        if (allDay) {</span>
<a href="#l12.1393"></a><span id="l12.1393" class="difflineplus">+                            if (!((newTime.hour == 0) &amp;&amp;</span>
<a href="#l12.1394"></a><span id="l12.1394" class="difflineplus">+                                 (newTime.minute == 0) &amp;&amp;</span>
<a href="#l12.1395"></a><span id="l12.1395" class="difflineplus">+                                 (newTime.second == 0))) {</span>
<a href="#l12.1396"></a><span id="l12.1396" class="difflineplus">+                                newTime.day++;</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineplus">+                                newTime.hour = 0;</span>
<a href="#l12.1398"></a><span id="l12.1398" class="difflineplus">+                                newTime.minute = 0;</span>
<a href="#l12.1399"></a><span id="l12.1399" class="difflineplus">+                                newTime.second = 0;</span>
<a href="#l12.1400"></a><span id="l12.1400" class="difflineplus">+                            }</span>
<a href="#l12.1401"></a><span id="l12.1401" class="difflineplus">+                        }</span>
<a href="#l12.1402"></a><span id="l12.1402" class="difflineplus">+                        newEndTime = newTime.clone();</span>
<a href="#l12.1403"></a><span id="l12.1403" class="difflineplus">+                        newEndTime.addDuration(duration);</span>
<a href="#l12.1404"></a><span id="l12.1404" class="difflineplus">+                    }</span>
<a href="#l12.1405"></a><span id="l12.1405" class="difflineplus">+                }</span>
<a href="#l12.1406"></a><span id="l12.1406" class="difflineplus">+            }</span>
<a href="#l12.1407"></a><span id="l12.1407"> </span>
<a href="#l12.1408"></a><span id="l12.1408" class="difflineminus">-          return newTime;</span>
<a href="#l12.1409"></a><span id="l12.1409" class="difflineplus">+            return newTime;</span>
<a href="#l12.1410"></a><span id="l12.1410">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1411"></a><span id="l12.1411">       &lt;/method&gt;</span>
<a href="#l12.1412"></a><span id="l12.1412"> </span>
<a href="#l12.1413"></a><span id="l12.1413">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l12.1414"></a><span id="l12.1414">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1415"></a><span id="l12.1415" class="difflineminus">-          if (this.force24Hours) {</span>
<a href="#l12.1416"></a><span id="l12.1416" class="difflineminus">-              this.mStartHour = 0;</span>
<a href="#l12.1417"></a><span id="l12.1417" class="difflineminus">-              this.mEndHour = 24;</span>
<a href="#l12.1418"></a><span id="l12.1418" class="difflineminus">-          } else {</span>
<a href="#l12.1419"></a><span id="l12.1419" class="difflineminus">-              this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.1420"></a><span id="l12.1420" class="difflineminus">-              this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineminus">-          }</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineplus">+            if (this.force24Hours) {</span>
<a href="#l12.1423"></a><span id="l12.1423" class="difflineplus">+                this.mStartHour = 0;</span>
<a href="#l12.1424"></a><span id="l12.1424" class="difflineplus">+                this.mEndHour = 24;</span>
<a href="#l12.1425"></a><span id="l12.1425" class="difflineplus">+            } else {</span>
<a href="#l12.1426"></a><span id="l12.1426" class="difflineplus">+                this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.1427"></a><span id="l12.1427" class="difflineplus">+                this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.1428"></a><span id="l12.1428" class="difflineplus">+            }</span>
<a href="#l12.1429"></a><span id="l12.1429">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1430"></a><span id="l12.1430">       &lt;/method&gt;</span>
<a href="#l12.1431"></a><span id="l12.1431">     &lt;/implementation&gt;</span>
<a href="#l12.1432"></a><span id="l12.1432">   &lt;/binding&gt;</span>
<a href="#l12.1433"></a><span id="l12.1433"> </span>
<a href="#l12.1434"></a><span id="l12.1434">   &lt;!-- ############################################################################# --&gt;</span>
<a href="#l12.1435"></a><span id="l12.1435">   &lt;!-- 'freebusy-grid'-binding                                                       --&gt;</span>
<a href="#l12.1436"></a><span id="l12.1436">   &lt;!-- ############################################################################# --&gt;</span>
<a href="#l12.1437"></a><span id="l12.1437" class="difflineat">@@ -1014,589 +1014,589 @@</span>
<a href="#l12.1438"></a><span id="l12.1438">       &lt;field name=&quot;mRange&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.1439"></a><span id="l12.1439">       &lt;field name=&quot;mStartHour&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.1440"></a><span id="l12.1440">       &lt;field name=&quot;mEndHour&quot;&gt;24&lt;/field&gt;</span>
<a href="#l12.1441"></a><span id="l12.1441">       &lt;field name=&quot;mForce24Hours&quot;&gt;false&lt;/field&gt;</span>
<a href="#l12.1442"></a><span id="l12.1442">       &lt;field name=&quot;mZoomFactor&quot;&gt;100&lt;/field&gt;</span>
<a href="#l12.1443"></a><span id="l12.1443"> </span>
<a href="#l12.1444"></a><span id="l12.1444">       &lt;property name=&quot;zoomFactor&quot;&gt;</span>
<a href="#l12.1445"></a><span id="l12.1445">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1446"></a><span id="l12.1446" class="difflineminus">-          return this.mZoomFactor;</span>
<a href="#l12.1447"></a><span id="l12.1447" class="difflineplus">+            return this.mZoomFactor;</span>
<a href="#l12.1448"></a><span id="l12.1448">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1449"></a><span id="l12.1449">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1450"></a><span id="l12.1450" class="difflineminus">-          this.mZoomFactor = val;</span>
<a href="#l12.1451"></a><span id="l12.1451" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1452"></a><span id="l12.1452" class="difflineminus">-              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1453"></a><span id="l12.1453" class="difflineminus">-              freebusy.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.1454"></a><span id="l12.1454" class="difflineminus">-          }</span>
<a href="#l12.1455"></a><span id="l12.1455" class="difflineminus">-          this.forceRefresh();</span>
<a href="#l12.1456"></a><span id="l12.1456" class="difflineminus">-          return val;</span>
<a href="#l12.1457"></a><span id="l12.1457" class="difflineplus">+            this.mZoomFactor = val;</span>
<a href="#l12.1458"></a><span id="l12.1458" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1459"></a><span id="l12.1459" class="difflineplus">+                let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1460"></a><span id="l12.1460" class="difflineplus">+                freebusy.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.1461"></a><span id="l12.1461" class="difflineplus">+            }</span>
<a href="#l12.1462"></a><span id="l12.1462" class="difflineplus">+            this.forceRefresh();</span>
<a href="#l12.1463"></a><span id="l12.1463" class="difflineplus">+            return val;</span>
<a href="#l12.1464"></a><span id="l12.1464">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1465"></a><span id="l12.1465">       &lt;/property&gt;</span>
<a href="#l12.1466"></a><span id="l12.1466"> </span>
<a href="#l12.1467"></a><span id="l12.1467">       &lt;property name=&quot;force24Hours&quot;&gt;</span>
<a href="#l12.1468"></a><span id="l12.1468">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1469"></a><span id="l12.1469" class="difflineminus">-          return this.mForce24Hours;</span>
<a href="#l12.1470"></a><span id="l12.1470" class="difflineplus">+            return this.mForce24Hours;</span>
<a href="#l12.1471"></a><span id="l12.1471">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1472"></a><span id="l12.1472">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1473"></a><span id="l12.1473" class="difflineminus">-          this.mForce24Hours = val;</span>
<a href="#l12.1474"></a><span id="l12.1474" class="difflineminus">-          this.initTimeRange();</span>
<a href="#l12.1475"></a><span id="l12.1475" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1476"></a><span id="l12.1476" class="difflineminus">-              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1477"></a><span id="l12.1477" class="difflineminus">-              freebusy.force24Hours = this.mForce24Hours;</span>
<a href="#l12.1478"></a><span id="l12.1478" class="difflineminus">-          }</span>
<a href="#l12.1479"></a><span id="l12.1479" class="difflineminus">-          return val;</span>
<a href="#l12.1480"></a><span id="l12.1480" class="difflineplus">+            this.mForce24Hours = val;</span>
<a href="#l12.1481"></a><span id="l12.1481" class="difflineplus">+            this.initTimeRange();</span>
<a href="#l12.1482"></a><span id="l12.1482" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1483"></a><span id="l12.1483" class="difflineplus">+                let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1484"></a><span id="l12.1484" class="difflineplus">+                freebusy.force24Hours = this.mForce24Hours;</span>
<a href="#l12.1485"></a><span id="l12.1485" class="difflineplus">+            }</span>
<a href="#l12.1486"></a><span id="l12.1486" class="difflineplus">+            return val;</span>
<a href="#l12.1487"></a><span id="l12.1487">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1488"></a><span id="l12.1488">       &lt;/property&gt;</span>
<a href="#l12.1489"></a><span id="l12.1489"> </span>
<a href="#l12.1490"></a><span id="l12.1490">       &lt;property name=&quot;firstVisibleRow&quot;&gt;</span>
<a href="#l12.1491"></a><span id="l12.1491">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1492"></a><span id="l12.1492" class="difflineminus">-          let listbox =</span>
<a href="#l12.1493"></a><span id="l12.1493" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1494"></a><span id="l12.1494" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1495"></a><span id="l12.1495" class="difflineminus">-          return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l12.1496"></a><span id="l12.1496" class="difflineplus">+            let listbox =</span>
<a href="#l12.1497"></a><span id="l12.1497" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1498"></a><span id="l12.1498" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1499"></a><span id="l12.1499" class="difflineplus">+            return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l12.1500"></a><span id="l12.1500">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1501"></a><span id="l12.1501">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1502"></a><span id="l12.1502" class="difflineminus">-          let listbox =</span>
<a href="#l12.1503"></a><span id="l12.1503" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1505"></a><span id="l12.1505" class="difflineminus">-          listbox.scrollToIndex(val);</span>
<a href="#l12.1506"></a><span id="l12.1506" class="difflineminus">-          return val;</span>
<a href="#l12.1507"></a><span id="l12.1507" class="difflineplus">+            let listbox =</span>
<a href="#l12.1508"></a><span id="l12.1508" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1509"></a><span id="l12.1509" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1510"></a><span id="l12.1510" class="difflineplus">+            listbox.scrollToIndex(val);</span>
<a href="#l12.1511"></a><span id="l12.1511" class="difflineplus">+            return val;</span>
<a href="#l12.1512"></a><span id="l12.1512">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1513"></a><span id="l12.1513">       &lt;/property&gt;</span>
<a href="#l12.1514"></a><span id="l12.1514"> </span>
<a href="#l12.1515"></a><span id="l12.1515">       &lt;property name=&quot;ratio&quot;&gt;</span>
<a href="#l12.1516"></a><span id="l12.1516">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1517"></a><span id="l12.1517" class="difflineminus">-          let listbox =</span>
<a href="#l12.1518"></a><span id="l12.1518" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1519"></a><span id="l12.1519" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1520"></a><span id="l12.1520" class="difflineminus">-          let rowcount = listbox.getRowCount();</span>
<a href="#l12.1521"></a><span id="l12.1521" class="difflineminus">-          listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l12.1522"></a><span id="l12.1522" class="difflineminus">-          return val;</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineplus">+            let listbox =</span>
<a href="#l12.1524"></a><span id="l12.1524" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1525"></a><span id="l12.1525" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1526"></a><span id="l12.1526" class="difflineplus">+            let rowcount = listbox.getRowCount();</span>
<a href="#l12.1527"></a><span id="l12.1527" class="difflineplus">+            listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l12.1528"></a><span id="l12.1528" class="difflineplus">+            return val;</span>
<a href="#l12.1529"></a><span id="l12.1529">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1530"></a><span id="l12.1530">       &lt;/property&gt;</span>
<a href="#l12.1531"></a><span id="l12.1531"> </span>
<a href="#l12.1532"></a><span id="l12.1532">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.1533"></a><span id="l12.1533" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.1534"></a><span id="l12.1534" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.1535"></a><span id="l12.1535" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.1536"></a><span id="l12.1536" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.1537"></a><span id="l12.1537"> </span>
<a href="#l12.1538"></a><span id="l12.1538" class="difflineminus">-        this.initTimeRange();</span>
<a href="#l12.1539"></a><span id="l12.1539" class="difflineplus">+          this.initTimeRange();</span>
<a href="#l12.1540"></a><span id="l12.1540"> </span>
<a href="#l12.1541"></a><span id="l12.1541" class="difflineminus">-        this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.1542"></a><span id="l12.1542" class="difflineplus">+          this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l12.1543"></a><span id="l12.1543"> </span>
<a href="#l12.1544"></a><span id="l12.1544" class="difflineminus">-        this.mMaxFreeBusy = 0;</span>
<a href="#l12.1545"></a><span id="l12.1545" class="difflineminus">-        this.mPendingRequests = [];</span>
<a href="#l12.1546"></a><span id="l12.1546" class="difflineplus">+          this.mMaxFreeBusy = 0;</span>
<a href="#l12.1547"></a><span id="l12.1547" class="difflineplus">+          this.mPendingRequests = [];</span>
<a href="#l12.1548"></a><span id="l12.1548"> </span>
<a href="#l12.1549"></a><span id="l12.1549" class="difflineminus">-        window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l12.1550"></a><span id="l12.1550" class="difflineminus">-        window.addEventListener(&quot;unload&quot;, this.onUnload.bind(this), true);</span>
<a href="#l12.1551"></a><span id="l12.1551" class="difflineplus">+          window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l12.1552"></a><span id="l12.1552" class="difflineplus">+          window.addEventListener(&quot;unload&quot;, this.onUnload.bind(this), true);</span>
<a href="#l12.1553"></a><span id="l12.1553">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.1554"></a><span id="l12.1554"> </span>
<a href="#l12.1555"></a><span id="l12.1555">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l12.1556"></a><span id="l12.1556">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1557"></a><span id="l12.1557" class="difflineminus">-          return this.mStartDate;</span>
<a href="#l12.1558"></a><span id="l12.1558" class="difflineplus">+            return this.mStartDate;</span>
<a href="#l12.1559"></a><span id="l12.1559">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1560"></a><span id="l12.1560">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1561"></a><span id="l12.1561" class="difflineminus">-          this.mStartDate = val.clone();</span>
<a href="#l12.1562"></a><span id="l12.1562" class="difflineminus">-          this.mStartDate.makeImmutable();</span>
<a href="#l12.1563"></a><span id="l12.1563" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1564"></a><span id="l12.1564" class="difflineminus">-              this.getFreeBusyElement(i).startDate = val;</span>
<a href="#l12.1565"></a><span id="l12.1565" class="difflineminus">-          }</span>
<a href="#l12.1566"></a><span id="l12.1566" class="difflineminus">-          return val;</span>
<a href="#l12.1567"></a><span id="l12.1567" class="difflineplus">+            this.mStartDate = val.clone();</span>
<a href="#l12.1568"></a><span id="l12.1568" class="difflineplus">+            this.mStartDate.makeImmutable();</span>
<a href="#l12.1569"></a><span id="l12.1569" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1570"></a><span id="l12.1570" class="difflineplus">+                this.getFreeBusyElement(i).startDate = val;</span>
<a href="#l12.1571"></a><span id="l12.1571" class="difflineplus">+            }</span>
<a href="#l12.1572"></a><span id="l12.1572" class="difflineplus">+            return val;</span>
<a href="#l12.1573"></a><span id="l12.1573">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1574"></a><span id="l12.1574">       &lt;/property&gt;</span>
<a href="#l12.1575"></a><span id="l12.1575"> </span>
<a href="#l12.1576"></a><span id="l12.1576">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l12.1577"></a><span id="l12.1577">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1578"></a><span id="l12.1578" class="difflineminus">-          return this.mEndDate;</span>
<a href="#l12.1579"></a><span id="l12.1579" class="difflineplus">+            return this.mEndDate;</span>
<a href="#l12.1580"></a><span id="l12.1580">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1581"></a><span id="l12.1581">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1582"></a><span id="l12.1582" class="difflineminus">-          this.mEndDate = val.clone();</span>
<a href="#l12.1583"></a><span id="l12.1583" class="difflineminus">-          this.mEndDate.makeImmutable();</span>
<a href="#l12.1584"></a><span id="l12.1584" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1585"></a><span id="l12.1585" class="difflineminus">-              this.getFreeBusyElement(i).endDate = val;</span>
<a href="#l12.1586"></a><span id="l12.1586" class="difflineminus">-          }</span>
<a href="#l12.1587"></a><span id="l12.1587" class="difflineminus">-          return val;</span>
<a href="#l12.1588"></a><span id="l12.1588" class="difflineplus">+            this.mEndDate = val.clone();</span>
<a href="#l12.1589"></a><span id="l12.1589" class="difflineplus">+            this.mEndDate.makeImmutable();</span>
<a href="#l12.1590"></a><span id="l12.1590" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1591"></a><span id="l12.1591" class="difflineplus">+                this.getFreeBusyElement(i).endDate = val;</span>
<a href="#l12.1592"></a><span id="l12.1592" class="difflineplus">+            }</span>
<a href="#l12.1593"></a><span id="l12.1593" class="difflineplus">+            return val;</span>
<a href="#l12.1594"></a><span id="l12.1594">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1595"></a><span id="l12.1595">       &lt;/property&gt;</span>
<a href="#l12.1596"></a><span id="l12.1596"> </span>
<a href="#l12.1597"></a><span id="l12.1597">       &lt;property name=&quot;documentSize&quot;&gt;</span>
<a href="#l12.1598"></a><span id="l12.1598">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.1599"></a><span id="l12.1599" class="difflineminus">-          return this.getFreeBusyElement(1).documentSize;</span>
<a href="#l12.1600"></a><span id="l12.1600" class="difflineplus">+            return this.getFreeBusyElement(1).documentSize;</span>
<a href="#l12.1601"></a><span id="l12.1601">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.1602"></a><span id="l12.1602">       &lt;/property&gt;</span>
<a href="#l12.1603"></a><span id="l12.1603"> </span>
<a href="#l12.1604"></a><span id="l12.1604">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l12.1605"></a><span id="l12.1605">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1606"></a><span id="l12.1606" class="difflineminus">-          this.onInitialize();</span>
<a href="#l12.1607"></a><span id="l12.1607" class="difflineplus">+            this.onInitialize();</span>
<a href="#l12.1608"></a><span id="l12.1608">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1609"></a><span id="l12.1609">       &lt;/method&gt;</span>
<a href="#l12.1610"></a><span id="l12.1610"> </span>
<a href="#l12.1611"></a><span id="l12.1611">       &lt;method name=&quot;onUnload&quot;&gt;</span>
<a href="#l12.1612"></a><span id="l12.1612">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1613"></a><span id="l12.1613" class="difflineminus">-          // Cancel pending free/busy requests</span>
<a href="#l12.1614"></a><span id="l12.1614" class="difflineminus">-          for (let request of this.mPendingRequests) {</span>
<a href="#l12.1615"></a><span id="l12.1615" class="difflineminus">-              request.cancel(null);</span>
<a href="#l12.1616"></a><span id="l12.1616" class="difflineminus">-          }</span>
<a href="#l12.1617"></a><span id="l12.1617" class="difflineplus">+            // Cancel pending free/busy requests</span>
<a href="#l12.1618"></a><span id="l12.1618" class="difflineplus">+            for (let request of this.mPendingRequests) {</span>
<a href="#l12.1619"></a><span id="l12.1619" class="difflineplus">+                request.cancel(null);</span>
<a href="#l12.1620"></a><span id="l12.1620" class="difflineplus">+            }</span>
<a href="#l12.1621"></a><span id="l12.1621"> </span>
<a href="#l12.1622"></a><span id="l12.1622" class="difflineminus">-          this.mPendingRequests = [];</span>
<a href="#l12.1623"></a><span id="l12.1623" class="difflineplus">+            this.mPendingRequests = [];</span>
<a href="#l12.1624"></a><span id="l12.1624">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1625"></a><span id="l12.1625">       &lt;/method&gt;</span>
<a href="#l12.1626"></a><span id="l12.1626"> </span>
<a href="#l12.1627"></a><span id="l12.1627">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l12.1628"></a><span id="l12.1628">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1629"></a><span id="l12.1629" class="difflineminus">-          let args = window.arguments[0];</span>
<a href="#l12.1630"></a><span id="l12.1630" class="difflineminus">-          let startTime = args.startTime;</span>
<a href="#l12.1631"></a><span id="l12.1631" class="difflineminus">-          let endTime = args.endTime;</span>
<a href="#l12.1632"></a><span id="l12.1632" class="difflineplus">+            let args = window.arguments[0];</span>
<a href="#l12.1633"></a><span id="l12.1633" class="difflineplus">+            let startTime = args.startTime;</span>
<a href="#l12.1634"></a><span id="l12.1634" class="difflineplus">+            let endTime = args.endTime;</span>
<a href="#l12.1635"></a><span id="l12.1635"> </span>
<a href="#l12.1636"></a><span id="l12.1636" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1637"></a><span id="l12.1637" class="difflineminus">-          this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1638"></a><span id="l12.1638" class="difflineminus">-          this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1639"></a><span id="l12.1639" class="difflineplus">+            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l12.1640"></a><span id="l12.1640" class="difflineplus">+            this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1641"></a><span id="l12.1641" class="difflineplus">+            this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.1642"></a><span id="l12.1642"> </span>
<a href="#l12.1643"></a><span id="l12.1643" class="difflineminus">-          let listbox =</span>
<a href="#l12.1644"></a><span id="l12.1644" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1645"></a><span id="l12.1645" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1646"></a><span id="l12.1646" class="difflineminus">-          let template =</span>
<a href="#l12.1647"></a><span id="l12.1647" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1648"></a><span id="l12.1648" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1649"></a><span id="l12.1649" class="difflineminus">-          this.appendNewRow(listbox, template, null);</span>
<a href="#l12.1650"></a><span id="l12.1650" class="difflineminus">-          template.remove();</span>
<a href="#l12.1651"></a><span id="l12.1651" class="difflineplus">+            let listbox =</span>
<a href="#l12.1652"></a><span id="l12.1652" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1653"></a><span id="l12.1653" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1654"></a><span id="l12.1654" class="difflineplus">+            let template =</span>
<a href="#l12.1655"></a><span id="l12.1655" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1656"></a><span id="l12.1656" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1657"></a><span id="l12.1657" class="difflineplus">+            this.appendNewRow(listbox, template, null);</span>
<a href="#l12.1658"></a><span id="l12.1658" class="difflineplus">+            template.remove();</span>
<a href="#l12.1659"></a><span id="l12.1659"> </span>
<a href="#l12.1660"></a><span id="l12.1660" class="difflineminus">-          this.updateFreeBusy();</span>
<a href="#l12.1661"></a><span id="l12.1661" class="difflineplus">+            this.updateFreeBusy();</span>
<a href="#l12.1662"></a><span id="l12.1662">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1663"></a><span id="l12.1663">       &lt;/method&gt;</span>
<a href="#l12.1664"></a><span id="l12.1664"> </span>
<a href="#l12.1665"></a><span id="l12.1665">       &lt;method name=&quot;onChangeCalendar&quot;&gt;</span>
<a href="#l12.1666"></a><span id="l12.1666">         &lt;parameter name=&quot;calendar&quot;/&gt;</span>
<a href="#l12.1667"></a><span id="l12.1667">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1668"></a><span id="l12.1668">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1669"></a><span id="l12.1669">       &lt;/method&gt;</span>
<a href="#l12.1670"></a><span id="l12.1670"> </span>
<a href="#l12.1671"></a><span id="l12.1671">       &lt;!-- appends a new empty row --&gt;</span>
<a href="#l12.1672"></a><span id="l12.1672">       &lt;method name=&quot;appendNewRow&quot;&gt;</span>
<a href="#l12.1673"></a><span id="l12.1673">         &lt;parameter name=&quot;aParentNode&quot;/&gt;</span>
<a href="#l12.1674"></a><span id="l12.1674">         &lt;parameter name=&quot;aTemplateNode&quot;/&gt;</span>
<a href="#l12.1675"></a><span id="l12.1675">         &lt;parameter name=&quot;aReplaceNode&quot;/&gt;</span>
<a href="#l12.1676"></a><span id="l12.1676">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1677"></a><span id="l12.1677" class="difflineminus">-          this.mMaxFreeBusy++;</span>
<a href="#l12.1678"></a><span id="l12.1678" class="difflineminus">-          let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l12.1679"></a><span id="l12.1679" class="difflineminus">-          if (aReplaceNode) {</span>
<a href="#l12.1680"></a><span id="l12.1680" class="difflineminus">-              aParentNode.replaceChild(newNode, aReplaceNode);</span>
<a href="#l12.1681"></a><span id="l12.1681" class="difflineminus">-          } else {</span>
<a href="#l12.1682"></a><span id="l12.1682" class="difflineminus">-              aParentNode.appendChild(newNode);</span>
<a href="#l12.1683"></a><span id="l12.1683" class="difflineminus">-          }</span>
<a href="#l12.1684"></a><span id="l12.1684" class="difflineplus">+            this.mMaxFreeBusy++;</span>
<a href="#l12.1685"></a><span id="l12.1685" class="difflineplus">+            let newNode = aTemplateNode.cloneNode(true);</span>
<a href="#l12.1686"></a><span id="l12.1686" class="difflineplus">+            if (aReplaceNode) {</span>
<a href="#l12.1687"></a><span id="l12.1687" class="difflineplus">+                aParentNode.replaceChild(newNode, aReplaceNode);</span>
<a href="#l12.1688"></a><span id="l12.1688" class="difflineplus">+            } else {</span>
<a href="#l12.1689"></a><span id="l12.1689" class="difflineplus">+                aParentNode.appendChild(newNode);</span>
<a href="#l12.1690"></a><span id="l12.1690" class="difflineplus">+            }</span>
<a href="#l12.1691"></a><span id="l12.1691"> </span>
<a href="#l12.1692"></a><span id="l12.1692" class="difflineminus">-          let grid =</span>
<a href="#l12.1693"></a><span id="l12.1693" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.1694"></a><span id="l12.1694" class="difflineminus">-                  newNode, &quot;anonid&quot;, &quot;grid&quot;);</span>
<a href="#l12.1695"></a><span id="l12.1695" class="difflineminus">-          let rowNumber = this.mMaxFreeBusy;</span>
<a href="#l12.1696"></a><span id="l12.1696" class="difflineminus">-          if (rowNumber &gt;= 0) {</span>
<a href="#l12.1697"></a><span id="l12.1697" class="difflineminus">-              grid.setAttribute(&quot;id&quot;, &quot;attendeeCol4#&quot; + rowNumber);</span>
<a href="#l12.1698"></a><span id="l12.1698" class="difflineminus">-          }</span>
<a href="#l12.1699"></a><span id="l12.1699" class="difflineplus">+            let grid =</span>
<a href="#l12.1700"></a><span id="l12.1700" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.1701"></a><span id="l12.1701" class="difflineplus">+                    newNode, &quot;anonid&quot;, &quot;grid&quot;);</span>
<a href="#l12.1702"></a><span id="l12.1702" class="difflineplus">+            let rowNumber = this.mMaxFreeBusy;</span>
<a href="#l12.1703"></a><span id="l12.1703" class="difflineplus">+            if (rowNumber &gt;= 0) {</span>
<a href="#l12.1704"></a><span id="l12.1704" class="difflineplus">+                grid.setAttribute(&quot;id&quot;, &quot;attendeeCol4#&quot; + rowNumber);</span>
<a href="#l12.1705"></a><span id="l12.1705" class="difflineplus">+            }</span>
<a href="#l12.1706"></a><span id="l12.1706"> </span>
<a href="#l12.1707"></a><span id="l12.1707" class="difflineminus">-          // Propagate start/enddate to the new row.</span>
<a href="#l12.1708"></a><span id="l12.1708" class="difflineminus">-          grid.startDate = this.mStartDate;</span>
<a href="#l12.1709"></a><span id="l12.1709" class="difflineminus">-          grid.endDate = this.mEndDate;</span>
<a href="#l12.1710"></a><span id="l12.1710" class="difflineplus">+            // Propagate start/enddate to the new row.</span>
<a href="#l12.1711"></a><span id="l12.1711" class="difflineplus">+            grid.startDate = this.mStartDate;</span>
<a href="#l12.1712"></a><span id="l12.1712" class="difflineplus">+            grid.endDate = this.mEndDate;</span>
<a href="#l12.1713"></a><span id="l12.1713"> </span>
<a href="#l12.1714"></a><span id="l12.1714" class="difflineminus">-          grid.force24Hours = this.mForce24Hours;</span>
<a href="#l12.1715"></a><span id="l12.1715" class="difflineminus">-          grid.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.1716"></a><span id="l12.1716" class="difflineplus">+            grid.force24Hours = this.mForce24Hours;</span>
<a href="#l12.1717"></a><span id="l12.1717" class="difflineplus">+            grid.zoomFactor = this.mZoomFactor;</span>
<a href="#l12.1718"></a><span id="l12.1718"> </span>
<a href="#l12.1719"></a><span id="l12.1719" class="difflineminus">-          // We always clone the first row.  The problem is that the first row</span>
<a href="#l12.1720"></a><span id="l12.1720" class="difflineminus">-          // could be focused.  When we clone that row, we end up with a cloned</span>
<a href="#l12.1721"></a><span id="l12.1721" class="difflineminus">-          // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l12.1722"></a><span id="l12.1722" class="difflineminus">-          // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l12.1723"></a><span id="l12.1723" class="difflineminus">-          // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l12.1724"></a><span id="l12.1724" class="difflineminus">-          // rather than using the real visible first row of the listbox.</span>
<a href="#l12.1725"></a><span id="l12.1725" class="difflineminus">-          // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l12.1726"></a><span id="l12.1726" class="difflineminus">-          // is never copied when the node is cloned.</span>
<a href="#l12.1727"></a><span id="l12.1727" class="difflineminus">-          if (grid.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l12.1728"></a><span id="l12.1728" class="difflineminus">-              grid.removeAttribute(&quot;focused&quot;);</span>
<a href="#l12.1729"></a><span id="l12.1729" class="difflineminus">-          }</span>
<a href="#l12.1730"></a><span id="l12.1730" class="difflineplus">+            // We always clone the first row.  The problem is that the first row</span>
<a href="#l12.1731"></a><span id="l12.1731" class="difflineplus">+            // could be focused.  When we clone that row, we end up with a cloned</span>
<a href="#l12.1732"></a><span id="l12.1732" class="difflineplus">+            // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l12.1733"></a><span id="l12.1733" class="difflineplus">+            // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l12.1734"></a><span id="l12.1734" class="difflineplus">+            // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l12.1735"></a><span id="l12.1735" class="difflineplus">+            // rather than using the real visible first row of the listbox.</span>
<a href="#l12.1736"></a><span id="l12.1736" class="difflineplus">+            // For now we'll just put in a hack that ensures the focused attribute</span>
<a href="#l12.1737"></a><span id="l12.1737" class="difflineplus">+            // is never copied when the node is cloned.</span>
<a href="#l12.1738"></a><span id="l12.1738" class="difflineplus">+            if (grid.getAttribute(&quot;focused&quot;) != &quot;&quot;) {</span>
<a href="#l12.1739"></a><span id="l12.1739" class="difflineplus">+                grid.removeAttribute(&quot;focused&quot;);</span>
<a href="#l12.1740"></a><span id="l12.1740" class="difflineplus">+            }</span>
<a href="#l12.1741"></a><span id="l12.1741">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1742"></a><span id="l12.1742">       &lt;/method&gt;</span>
<a href="#l12.1743"></a><span id="l12.1743"> </span>
<a href="#l12.1744"></a><span id="l12.1744">       &lt;property name=&quot;scroll&quot;&gt;</span>
<a href="#l12.1745"></a><span id="l12.1745">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l12.1746"></a><span id="l12.1746" class="difflineminus">-          this.mScrollOffset = val;</span>
<a href="#l12.1747"></a><span id="l12.1747" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1748"></a><span id="l12.1748" class="difflineminus">-              this.getFreeBusyElement(i).scroll = val;</span>
<a href="#l12.1749"></a><span id="l12.1749" class="difflineminus">-          }</span>
<a href="#l12.1750"></a><span id="l12.1750" class="difflineminus">-          return val;</span>
<a href="#l12.1751"></a><span id="l12.1751" class="difflineplus">+            this.mScrollOffset = val;</span>
<a href="#l12.1752"></a><span id="l12.1752" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1753"></a><span id="l12.1753" class="difflineplus">+                this.getFreeBusyElement(i).scroll = val;</span>
<a href="#l12.1754"></a><span id="l12.1754" class="difflineplus">+            }</span>
<a href="#l12.1755"></a><span id="l12.1755" class="difflineplus">+            return val;</span>
<a href="#l12.1756"></a><span id="l12.1756">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l12.1757"></a><span id="l12.1757">       &lt;/property&gt;</span>
<a href="#l12.1758"></a><span id="l12.1758"> </span>
<a href="#l12.1759"></a><span id="l12.1759">       &lt;method name=&quot;onModify&quot;&gt;</span>
<a href="#l12.1760"></a><span id="l12.1760">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l12.1761"></a><span id="l12.1761">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1762"></a><span id="l12.1762" class="difflineminus">-          // Add or remove rows depending on the number of items</span>
<a href="#l12.1763"></a><span id="l12.1763" class="difflineminus">-          // contained in the list passed as argument.</span>
<a href="#l12.1764"></a><span id="l12.1764" class="difflineminus">-          let list = event.details;</span>
<a href="#l12.1765"></a><span id="l12.1765" class="difflineminus">-          if (this.mMaxFreeBusy != list.length) {</span>
<a href="#l12.1766"></a><span id="l12.1766" class="difflineminus">-              let listbox =</span>
<a href="#l12.1767"></a><span id="l12.1767" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l12.1768"></a><span id="l12.1768" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1769"></a><span id="l12.1769" class="difflineminus">-              let template =</span>
<a href="#l12.1770"></a><span id="l12.1770" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l12.1771"></a><span id="l12.1771" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1772"></a><span id="l12.1772" class="difflineminus">-              while (this.mMaxFreeBusy &lt; list.length) {</span>
<a href="#l12.1773"></a><span id="l12.1773" class="difflineminus">-                  let nextDummy = this.getNextDummyRow();</span>
<a href="#l12.1774"></a><span id="l12.1774" class="difflineminus">-                  this.appendNewRow(listbox, template, nextDummy);</span>
<a href="#l12.1775"></a><span id="l12.1775" class="difflineminus">-                  template =</span>
<a href="#l12.1776"></a><span id="l12.1776" class="difflineminus">-                      document.getAnonymousElementByAttribute(</span>
<a href="#l12.1777"></a><span id="l12.1777" class="difflineminus">-                          this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1778"></a><span id="l12.1778" class="difflineminus">-              }</span>
<a href="#l12.1779"></a><span id="l12.1779" class="difflineminus">-              while (this.mMaxFreeBusy &gt; list.length) {</span>
<a href="#l12.1780"></a><span id="l12.1780" class="difflineminus">-                  this.deleteRow(this.mMaxFreeBusy);</span>
<a href="#l12.1781"></a><span id="l12.1781" class="difflineminus">-              }</span>
<a href="#l12.1782"></a><span id="l12.1782" class="difflineminus">-          }</span>
<a href="#l12.1783"></a><span id="l12.1783" class="difflineplus">+            // Add or remove rows depending on the number of items</span>
<a href="#l12.1784"></a><span id="l12.1784" class="difflineplus">+            // contained in the list passed as argument.</span>
<a href="#l12.1785"></a><span id="l12.1785" class="difflineplus">+            let list = event.details;</span>
<a href="#l12.1786"></a><span id="l12.1786" class="difflineplus">+            if (this.mMaxFreeBusy != list.length) {</span>
<a href="#l12.1787"></a><span id="l12.1787" class="difflineplus">+                let listbox =</span>
<a href="#l12.1788"></a><span id="l12.1788" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l12.1789"></a><span id="l12.1789" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.1790"></a><span id="l12.1790" class="difflineplus">+                let template =</span>
<a href="#l12.1791"></a><span id="l12.1791" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l12.1792"></a><span id="l12.1792" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1793"></a><span id="l12.1793" class="difflineplus">+                while (this.mMaxFreeBusy &lt; list.length) {</span>
<a href="#l12.1794"></a><span id="l12.1794" class="difflineplus">+                    let nextDummy = this.getNextDummyRow();</span>
<a href="#l12.1795"></a><span id="l12.1795" class="difflineplus">+                    this.appendNewRow(listbox, template, nextDummy);</span>
<a href="#l12.1796"></a><span id="l12.1796" class="difflineplus">+                    template =</span>
<a href="#l12.1797"></a><span id="l12.1797" class="difflineplus">+                        document.getAnonymousElementByAttribute(</span>
<a href="#l12.1798"></a><span id="l12.1798" class="difflineplus">+                            this, &quot;anonid&quot;, &quot;item&quot;);</span>
<a href="#l12.1799"></a><span id="l12.1799" class="difflineplus">+                }</span>
<a href="#l12.1800"></a><span id="l12.1800" class="difflineplus">+                while (this.mMaxFreeBusy &gt; list.length) {</span>
<a href="#l12.1801"></a><span id="l12.1801" class="difflineplus">+                    this.deleteRow(this.mMaxFreeBusy);</span>
<a href="#l12.1802"></a><span id="l12.1802" class="difflineplus">+                }</span>
<a href="#l12.1803"></a><span id="l12.1803" class="difflineplus">+            }</span>
<a href="#l12.1804"></a><span id="l12.1804"> </span>
<a href="#l12.1805"></a><span id="l12.1805" class="difflineminus">-          // Store the attributes in our grid rows.</span>
<a href="#l12.1806"></a><span id="l12.1806" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1807"></a><span id="l12.1807" class="difflineminus">-              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1808"></a><span id="l12.1808" class="difflineminus">-              freebusy.setAttribute(&quot;calid&quot;, list[i - 1].calid);</span>
<a href="#l12.1809"></a><span id="l12.1809" class="difflineminus">-              freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l12.1810"></a><span id="l12.1810" class="difflineminus">-              if (list[i - 1].dirty) {</span>
<a href="#l12.1811"></a><span id="l12.1811" class="difflineminus">-                  freebusy.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.1812"></a><span id="l12.1812" class="difflineminus">-              }</span>
<a href="#l12.1813"></a><span id="l12.1813" class="difflineminus">-          }</span>
<a href="#l12.1814"></a><span id="l12.1814" class="difflineplus">+            // Store the attributes in our grid rows.</span>
<a href="#l12.1815"></a><span id="l12.1815" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1816"></a><span id="l12.1816" class="difflineplus">+                let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1817"></a><span id="l12.1817" class="difflineplus">+                freebusy.setAttribute(&quot;calid&quot;, list[i - 1].calid);</span>
<a href="#l12.1818"></a><span id="l12.1818" class="difflineplus">+                freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l12.1819"></a><span id="l12.1819" class="difflineplus">+                if (list[i - 1].dirty) {</span>
<a href="#l12.1820"></a><span id="l12.1820" class="difflineplus">+                    freebusy.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.1821"></a><span id="l12.1821" class="difflineplus">+                }</span>
<a href="#l12.1822"></a><span id="l12.1822" class="difflineplus">+            }</span>
<a href="#l12.1823"></a><span id="l12.1823"> </span>
<a href="#l12.1824"></a><span id="l12.1824" class="difflineminus">-          // Align all rows</span>
<a href="#l12.1825"></a><span id="l12.1825" class="difflineminus">-          this.scroll = this.mScrollOffset;</span>
<a href="#l12.1826"></a><span id="l12.1826" class="difflineplus">+            // Align all rows</span>
<a href="#l12.1827"></a><span id="l12.1827" class="difflineplus">+            this.scroll = this.mScrollOffset;</span>
<a href="#l12.1828"></a><span id="l12.1828"> </span>
<a href="#l12.1829"></a><span id="l12.1829" class="difflineminus">-          this.updateFreeBusy();</span>
<a href="#l12.1830"></a><span id="l12.1830" class="difflineplus">+            this.updateFreeBusy();</span>
<a href="#l12.1831"></a><span id="l12.1831">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1832"></a><span id="l12.1832">       &lt;/method&gt;</span>
<a href="#l12.1833"></a><span id="l12.1833"> </span>
<a href="#l12.1834"></a><span id="l12.1834">       &lt;!-- updateFreeBusy(), implementation of the core functionality of this binding --&gt;</span>
<a href="#l12.1835"></a><span id="l12.1835">       &lt;method name=&quot;updateFreeBusy&quot;&gt;</span>
<a href="#l12.1836"></a><span id="l12.1836">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1837"></a><span id="l12.1837" class="difflineminus">-          let fbService = cal.getFreeBusyService();</span>
<a href="#l12.1838"></a><span id="l12.1838" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1839"></a><span id="l12.1839" class="difflineminus">-              // Retrieve the string from the appropriate row</span>
<a href="#l12.1840"></a><span id="l12.1840" class="difflineminus">-              let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1841"></a><span id="l12.1841" class="difflineminus">-              if (freebusy.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l12.1842"></a><span id="l12.1842" class="difflineminus">-                  freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l12.1843"></a><span id="l12.1843" class="difflineminus">-                  let calid = freebusy.getAttribute(&quot;calid&quot;);</span>
<a href="#l12.1844"></a><span id="l12.1844" class="difflineminus">-                  if (calid &amp;&amp; calid.length &gt; 0) {</span>
<a href="#l12.1845"></a><span id="l12.1845" class="difflineminus">-                      // Define the datetime range we would like to ask for.</span>
<a href="#l12.1846"></a><span id="l12.1846" class="difflineminus">-                      let start = this.mStartDate.clone();</span>
<a href="#l12.1847"></a><span id="l12.1847" class="difflineminus">-                      start.hour = 0;</span>
<a href="#l12.1848"></a><span id="l12.1848" class="difflineminus">-                      start.minute = 0;</span>
<a href="#l12.1849"></a><span id="l12.1849" class="difflineminus">-                      start.second = 0;</span>
<a href="#l12.1850"></a><span id="l12.1850" class="difflineminus">-                      let end = start.clone();</span>
<a href="#l12.1851"></a><span id="l12.1851" class="difflineminus">-                      end.day += this.mRange;</span>
<a href="#l12.1852"></a><span id="l12.1852" class="difflineminus">-                      // Update with 'no data available' until response will be received</span>
<a href="#l12.1853"></a><span id="l12.1853" class="difflineminus">-                      freebusy.onFreeBusy(null);</span>
<a href="#l12.1854"></a><span id="l12.1854" class="difflineminus">-                      try {</span>
<a href="#l12.1855"></a><span id="l12.1855" class="difflineminus">-                          let listener = new calFreeBusyListener(freebusy, this);</span>
<a href="#l12.1856"></a><span id="l12.1856" class="difflineminus">-                          let request = fbService.getFreeBusyIntervals(calid,</span>
<a href="#l12.1857"></a><span id="l12.1857" class="difflineminus">-                                                                       start,</span>
<a href="#l12.1858"></a><span id="l12.1858" class="difflineminus">-                                                                       end,</span>
<a href="#l12.1859"></a><span id="l12.1859" class="difflineminus">-                                                                       Components.interfaces.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l12.1860"></a><span id="l12.1860" class="difflineminus">-                                                                       listener);</span>
<a href="#l12.1861"></a><span id="l12.1861" class="difflineminus">-                          if (request &amp;&amp; request.isPending) {</span>
<a href="#l12.1862"></a><span id="l12.1862" class="difflineminus">-                              this.mPendingRequests.push(request);</span>
<a href="#l12.1863"></a><span id="l12.1863" class="difflineminus">-                          }</span>
<a href="#l12.1864"></a><span id="l12.1864" class="difflineminus">-                      } catch (ex) {</span>
<a href="#l12.1865"></a><span id="l12.1865" class="difflineminus">-                          Components.utils.reportError(ex);</span>
<a href="#l12.1866"></a><span id="l12.1866" class="difflineminus">-                      }</span>
<a href="#l12.1867"></a><span id="l12.1867" class="difflineminus">-                  }</span>
<a href="#l12.1868"></a><span id="l12.1868" class="difflineminus">-              }</span>
<a href="#l12.1869"></a><span id="l12.1869" class="difflineminus">-          }</span>
<a href="#l12.1870"></a><span id="l12.1870" class="difflineplus">+            let fbService = cal.getFreeBusyService();</span>
<a href="#l12.1871"></a><span id="l12.1871" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1872"></a><span id="l12.1872" class="difflineplus">+                // Retrieve the string from the appropriate row</span>
<a href="#l12.1873"></a><span id="l12.1873" class="difflineplus">+                let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l12.1874"></a><span id="l12.1874" class="difflineplus">+                if (freebusy.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l12.1875"></a><span id="l12.1875" class="difflineplus">+                    freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l12.1876"></a><span id="l12.1876" class="difflineplus">+                    let calid = freebusy.getAttribute(&quot;calid&quot;);</span>
<a href="#l12.1877"></a><span id="l12.1877" class="difflineplus">+                    if (calid &amp;&amp; calid.length &gt; 0) {</span>
<a href="#l12.1878"></a><span id="l12.1878" class="difflineplus">+                        // Define the datetime range we would like to ask for.</span>
<a href="#l12.1879"></a><span id="l12.1879" class="difflineplus">+                        let start = this.mStartDate.clone();</span>
<a href="#l12.1880"></a><span id="l12.1880" class="difflineplus">+                        start.hour = 0;</span>
<a href="#l12.1881"></a><span id="l12.1881" class="difflineplus">+                        start.minute = 0;</span>
<a href="#l12.1882"></a><span id="l12.1882" class="difflineplus">+                        start.second = 0;</span>
<a href="#l12.1883"></a><span id="l12.1883" class="difflineplus">+                        let end = start.clone();</span>
<a href="#l12.1884"></a><span id="l12.1884" class="difflineplus">+                        end.day += this.mRange;</span>
<a href="#l12.1885"></a><span id="l12.1885" class="difflineplus">+                        // Update with 'no data available' until response will be received</span>
<a href="#l12.1886"></a><span id="l12.1886" class="difflineplus">+                        freebusy.onFreeBusy(null);</span>
<a href="#l12.1887"></a><span id="l12.1887" class="difflineplus">+                        try {</span>
<a href="#l12.1888"></a><span id="l12.1888" class="difflineplus">+                            let listener = new calFreeBusyListener(freebusy, this);</span>
<a href="#l12.1889"></a><span id="l12.1889" class="difflineplus">+                            let request = fbService.getFreeBusyIntervals(calid,</span>
<a href="#l12.1890"></a><span id="l12.1890" class="difflineplus">+                                                                         start,</span>
<a href="#l12.1891"></a><span id="l12.1891" class="difflineplus">+                                                                         end,</span>
<a href="#l12.1892"></a><span id="l12.1892" class="difflineplus">+                                                                         Components.interfaces.calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l12.1893"></a><span id="l12.1893" class="difflineplus">+                                                                         listener);</span>
<a href="#l12.1894"></a><span id="l12.1894" class="difflineplus">+                            if (request &amp;&amp; request.isPending) {</span>
<a href="#l12.1895"></a><span id="l12.1895" class="difflineplus">+                                this.mPendingRequests.push(request);</span>
<a href="#l12.1896"></a><span id="l12.1896" class="difflineplus">+                            }</span>
<a href="#l12.1897"></a><span id="l12.1897" class="difflineplus">+                        } catch (ex) {</span>
<a href="#l12.1898"></a><span id="l12.1898" class="difflineplus">+                            Components.utils.reportError(ex);</span>
<a href="#l12.1899"></a><span id="l12.1899" class="difflineplus">+                        }</span>
<a href="#l12.1900"></a><span id="l12.1900" class="difflineplus">+                    }</span>
<a href="#l12.1901"></a><span id="l12.1901" class="difflineplus">+                }</span>
<a href="#l12.1902"></a><span id="l12.1902" class="difflineplus">+            }</span>
<a href="#l12.1903"></a><span id="l12.1903">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.1904"></a><span id="l12.1904">       &lt;/method&gt;</span>
<a href="#l12.1905"></a><span id="l12.1905"> </span>
<a href="#l12.1906"></a><span id="l12.1906">       &lt;method name=&quot;nextSlot&quot;&gt;</span>
<a href="#l12.1907"></a><span id="l12.1907">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.1908"></a><span id="l12.1908" class="difflineminus">-          let startTime = this.mStartDate.clone();</span>
<a href="#l12.1909"></a><span id="l12.1909" class="difflineminus">-          let endTime = this.mEndDate.clone();</span>
<a href="#l12.1910"></a><span id="l12.1910" class="difflineplus">+            let startTime = this.mStartDate.clone();</span>
<a href="#l12.1911"></a><span id="l12.1911" class="difflineplus">+            let endTime = this.mEndDate.clone();</span>
<a href="#l12.1912"></a><span id="l12.1912"> </span>
<a href="#l12.1913"></a><span id="l12.1913" class="difflineminus">-          startTime.isDate = false;</span>
<a href="#l12.1914"></a><span id="l12.1914" class="difflineminus">-          endTime.isDate = false;</span>
<a href="#l12.1915"></a><span id="l12.1915" class="difflineplus">+            startTime.isDate = false;</span>
<a href="#l12.1916"></a><span id="l12.1916" class="difflineplus">+            endTime.isDate = false;</span>
<a href="#l12.1917"></a><span id="l12.1917"> </span>
<a href="#l12.1918"></a><span id="l12.1918" class="difflineminus">-          let allDay = this.mStartDate.isDate;</span>
<a href="#l12.1919"></a><span id="l12.1919" class="difflineminus">-          let step_in_minutes = Math.floor(60 * this.zoomFactor / 100);</span>
<a href="#l12.1920"></a><span id="l12.1920" class="difflineminus">-          if (allDay) {</span>
<a href="#l12.1921"></a><span id="l12.1921" class="difflineminus">-              step_in_minutes = 60 * 24;</span>
<a href="#l12.1922"></a><span id="l12.1922" class="difflineminus">-              endTime.day++;</span>
<a href="#l12.1923"></a><span id="l12.1923" class="difflineminus">-          }</span>
<a href="#l12.1924"></a><span id="l12.1924" class="difflineplus">+            let allDay = this.mStartDate.isDate;</span>
<a href="#l12.1925"></a><span id="l12.1925" class="difflineplus">+            let step_in_minutes = Math.floor(60 * this.zoomFactor / 100);</span>
<a href="#l12.1926"></a><span id="l12.1926" class="difflineplus">+            if (allDay) {</span>
<a href="#l12.1927"></a><span id="l12.1927" class="difflineplus">+                step_in_minutes = 60 * 24;</span>
<a href="#l12.1928"></a><span id="l12.1928" class="difflineplus">+                endTime.day++;</span>
<a href="#l12.1929"></a><span id="l12.1929" class="difflineplus">+            }</span>
<a href="#l12.1930"></a><span id="l12.1930"> </span>
<a href="#l12.1931"></a><span id="l12.1931" class="difflineminus">-          let duration = endTime.subtractDate(startTime);</span>
<a href="#l12.1932"></a><span id="l12.1932" class="difflineplus">+            let duration = endTime.subtractDate(startTime);</span>
<a href="#l12.1933"></a><span id="l12.1933"> </span>
<a href="#l12.1934"></a><span id="l12.1934" class="difflineminus">-          startTime.minute += step_in_minutes;</span>
<a href="#l12.1935"></a><span id="l12.1935" class="difflineplus">+            startTime.minute += step_in_minutes;</span>
<a href="#l12.1936"></a><span id="l12.1936"> </span>
<a href="#l12.1937"></a><span id="l12.1937" class="difflineminus">-          if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l12.1938"></a><span id="l12.1938" class="difflineminus">-              startTime.hour = this.mStartHour;</span>
<a href="#l12.1939"></a><span id="l12.1939" class="difflineminus">-              startTime.minute = 0;</span>
<a href="#l12.1940"></a><span id="l12.1940" class="difflineminus">-          }</span>
<a href="#l12.1941"></a><span id="l12.1941" class="difflineplus">+            if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l12.1942"></a><span id="l12.1942" class="difflineplus">+                startTime.hour = this.mStartHour;</span>
<a href="#l12.1943"></a><span id="l12.1943" class="difflineplus">+                startTime.minute = 0;</span>
<a href="#l12.1944"></a><span id="l12.1944" class="difflineplus">+            }</span>
<a href="#l12.1945"></a><span id="l12.1945"> </span>
<a href="#l12.1946"></a><span id="l12.1946" class="difflineminus">-          endTime = startTime.clone();</span>
<a href="#l12.1947"></a><span id="l12.1947" class="difflineminus">-          endTime.addDuration(duration);</span>
<a href="#l12.1948"></a><span id="l12.1948" class="difflineminus">-          if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.1949"></a><span id="l12.1949" class="difflineminus">-              startTime.day++;</span>
<a href="#l12.1950"></a><span id="l12.1950" class="difflineminus">-              startTime.hour = this.mStartHour;</span>
<a href="#l12.1951"></a><span id="l12.1951" class="difflineminus">-              startTime.minute = 0;</span>
<a href="#l12.1952"></a><span id="l12.1952" class="difflineminus">-              endTime = startTime.clone();</span>
<a href="#l12.1953"></a><span id="l12.1953" class="difflineminus">-              endTime.addDuration(duration);</span>
<a href="#l12.1954"></a><span id="l12.1954" class="difflineminus">-              if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.1955"></a><span id="l12.1955" class="difflineminus">-                  return this.mStartDate.clone();</span>
<a href="#l12.1956"></a><span id="l12.1956" class="difflineminus">-              }</span>
<a href="#l12.1957"></a><span id="l12.1957" class="difflineminus">-          }</span>
<a href="#l12.1958"></a><span id="l12.1958" class="difflineplus">+            endTime = startTime.clone();</span>
<a href="#l12.1959"></a><span id="l12.1959" class="difflineplus">+            endTime.addDuration(duration);</span>
<a href="#l12.1960"></a><span id="l12.1960" class="difflineplus">+            if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.1961"></a><span id="l12.1961" class="difflineplus">+                startTime.day++;</span>
<a href="#l12.1962"></a><span id="l12.1962" class="difflineplus">+                startTime.hour = this.mStartHour;</span>
<a href="#l12.1963"></a><span id="l12.1963" class="difflineplus">+                startTime.minute = 0;</span>
<a href="#l12.1964"></a><span id="l12.1964" class="difflineplus">+                endTime = startTime.clone();</span>
<a href="#l12.1965"></a><span id="l12.1965" class="difflineplus">+                endTime.addDuration(duration);</span>
<a href="#l12.1966"></a><span id="l12.1966" class="difflineplus">+                if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.1967"></a><span id="l12.1967" class="difflineplus">+                    return this.mStartDate.clone();</span>
<a href="#l12.1968"></a><span id="l12.1968" class="difflineplus">+                }</span>
<a href="#l12.1969"></a><span id="l12.1969" class="difflineplus">+            }</span>
<a href="#l12.1970"></a><span id="l12.1970"> </span>
<a href="#l12.1971"></a><span id="l12.1971" class="difflineminus">-          // Now iterate all freebusy-rows and ask each one</span>
<a href="#l12.1972"></a><span id="l12.1972" class="difflineminus">-          // if it wants to modify the suggested time slot.</span>
<a href="#l12.1973"></a><span id="l12.1973" class="difflineminus">-          // we keep iterating the rows until all of them</span>
<a href="#l12.1974"></a><span id="l12.1974" class="difflineminus">-          // are happy with it.</span>
<a href="#l12.1975"></a><span id="l12.1975" class="difflineminus">-          let recheck;</span>
<a href="#l12.1976"></a><span id="l12.1976" class="difflineminus">-          do {</span>
<a href="#l12.1977"></a><span id="l12.1977" class="difflineminus">-              recheck = false;</span>
<a href="#l12.1978"></a><span id="l12.1978" class="difflineplus">+            // Now iterate all freebusy-rows and ask each one</span>
<a href="#l12.1979"></a><span id="l12.1979" class="difflineplus">+            // if it wants to modify the suggested time slot.</span>
<a href="#l12.1980"></a><span id="l12.1980" class="difflineplus">+            // we keep iterating the rows until all of them</span>
<a href="#l12.1981"></a><span id="l12.1981" class="difflineplus">+            // are happy with it.</span>
<a href="#l12.1982"></a><span id="l12.1982" class="difflineplus">+            let recheck;</span>
<a href="#l12.1983"></a><span id="l12.1983" class="difflineplus">+            do {</span>
<a href="#l12.1984"></a><span id="l12.1984" class="difflineplus">+                recheck = false;</span>
<a href="#l12.1985"></a><span id="l12.1985"> </span>
<a href="#l12.1986"></a><span id="l12.1986" class="difflineminus">-              for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1987"></a><span id="l12.1987" class="difflineminus">-                  let row = this.getFreeBusyElement(i);</span>
<a href="#l12.1988"></a><span id="l12.1988" class="difflineminus">-                  let newTime = row.nextSlot(startTime, endTime, allDay);</span>
<a href="#l12.1989"></a><span id="l12.1989" class="difflineminus">-                  if (newTime) {</span>
<a href="#l12.1990"></a><span id="l12.1990" class="difflineminus">-                      if (newTime.compare(startTime) != 0) {</span>
<a href="#l12.1991"></a><span id="l12.1991" class="difflineminus">-                          startTime = newTime;</span>
<a href="#l12.1992"></a><span id="l12.1992" class="difflineplus">+                for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.1993"></a><span id="l12.1993" class="difflineplus">+                    let row = this.getFreeBusyElement(i);</span>
<a href="#l12.1994"></a><span id="l12.1994" class="difflineplus">+                    let newTime = row.nextSlot(startTime, endTime, allDay);</span>
<a href="#l12.1995"></a><span id="l12.1995" class="difflineplus">+                    if (newTime) {</span>
<a href="#l12.1996"></a><span id="l12.1996" class="difflineplus">+                        if (newTime.compare(startTime) != 0) {</span>
<a href="#l12.1997"></a><span id="l12.1997" class="difflineplus">+                            startTime = newTime;</span>
<a href="#l12.1998"></a><span id="l12.1998"> </span>
<a href="#l12.1999"></a><span id="l12.1999" class="difflineminus">-                          if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l12.2000"></a><span id="l12.2000" class="difflineminus">-                              startTime.hour = this.mStartHour;</span>
<a href="#l12.2001"></a><span id="l12.2001" class="difflineminus">-                              startTime.minute = 0;</span>
<a href="#l12.2002"></a><span id="l12.2002" class="difflineminus">-                          }</span>
<a href="#l12.2003"></a><span id="l12.2003" class="difflineplus">+                            if (startTime.hour &lt; this.mStartHour) {</span>
<a href="#l12.2004"></a><span id="l12.2004" class="difflineplus">+                                startTime.hour = this.mStartHour;</span>
<a href="#l12.2005"></a><span id="l12.2005" class="difflineplus">+                                startTime.minute = 0;</span>
<a href="#l12.2006"></a><span id="l12.2006" class="difflineplus">+                            }</span>
<a href="#l12.2007"></a><span id="l12.2007"> </span>
<a href="#l12.2008"></a><span id="l12.2008" class="difflineminus">-                          endTime = startTime.clone();</span>
<a href="#l12.2009"></a><span id="l12.2009" class="difflineminus">-                          endTime.addDuration(duration);</span>
<a href="#l12.2010"></a><span id="l12.2010" class="difflineplus">+                            endTime = startTime.clone();</span>
<a href="#l12.2011"></a><span id="l12.2011" class="difflineplus">+                            endTime.addDuration(duration);</span>
<a href="#l12.2012"></a><span id="l12.2012"> </span>
<a href="#l12.2013"></a><span id="l12.2013" class="difflineminus">-                          if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.2014"></a><span id="l12.2014" class="difflineminus">-                              startTime.day++;</span>
<a href="#l12.2015"></a><span id="l12.2015" class="difflineminus">-                              startTime.hour = this.mStartHour;</span>
<a href="#l12.2016"></a><span id="l12.2016" class="difflineminus">-                              startTime.minute = 0;</span>
<a href="#l12.2017"></a><span id="l12.2017" class="difflineminus">-                              endTime = startTime.clone();</span>
<a href="#l12.2018"></a><span id="l12.2018" class="difflineminus">-                              endTime.addDuration(duration);</span>
<a href="#l12.2019"></a><span id="l12.2019" class="difflineminus">-                          }</span>
<a href="#l12.2020"></a><span id="l12.2020" class="difflineplus">+                            if (endTime.hour &gt; this.mEndHour) {</span>
<a href="#l12.2021"></a><span id="l12.2021" class="difflineplus">+                                startTime.day++;</span>
<a href="#l12.2022"></a><span id="l12.2022" class="difflineplus">+                                startTime.hour = this.mStartHour;</span>
<a href="#l12.2023"></a><span id="l12.2023" class="difflineplus">+                                startTime.minute = 0;</span>
<a href="#l12.2024"></a><span id="l12.2024" class="difflineplus">+                                endTime = startTime.clone();</span>
<a href="#l12.2025"></a><span id="l12.2025" class="difflineplus">+                                endTime.addDuration(duration);</span>
<a href="#l12.2026"></a><span id="l12.2026" class="difflineplus">+                            }</span>
<a href="#l12.2027"></a><span id="l12.2027"> </span>
<a href="#l12.2028"></a><span id="l12.2028" class="difflineminus">-                          recheck = true;</span>
<a href="#l12.2029"></a><span id="l12.2029" class="difflineminus">-                      }</span>
<a href="#l12.2030"></a><span id="l12.2030" class="difflineminus">-                  } else {</span>
<a href="#l12.2031"></a><span id="l12.2031" class="difflineminus">-                      // A new slot could not be found</span>
<a href="#l12.2032"></a><span id="l12.2032" class="difflineminus">-                      // and the given time was also invalid.</span>
<a href="#l12.2033"></a><span id="l12.2033" class="difflineminus">-                      return this.mStartDate.clone();</span>
<a href="#l12.2034"></a><span id="l12.2034" class="difflineminus">-                  }</span>
<a href="#l12.2035"></a><span id="l12.2035" class="difflineminus">-              }</span>
<a href="#l12.2036"></a><span id="l12.2036" class="difflineminus">-          } while (recheck);</span>
<a href="#l12.2037"></a><span id="l12.2037" class="difflineplus">+                            recheck = true;</span>
<a href="#l12.2038"></a><span id="l12.2038" class="difflineplus">+                        }</span>
<a href="#l12.2039"></a><span id="l12.2039" class="difflineplus">+                    } else {</span>
<a href="#l12.2040"></a><span id="l12.2040" class="difflineplus">+                        // A new slot could not be found</span>
<a href="#l12.2041"></a><span id="l12.2041" class="difflineplus">+                        // and the given time was also invalid.</span>
<a href="#l12.2042"></a><span id="l12.2042" class="difflineplus">+                        return this.mStartDate.clone();</span>
<a href="#l12.2043"></a><span id="l12.2043" class="difflineplus">+                    }</span>
<a href="#l12.2044"></a><span id="l12.2044" class="difflineplus">+                }</span>
<a href="#l12.2045"></a><span id="l12.2045" class="difflineplus">+            } while (recheck);</span>
<a href="#l12.2046"></a><span id="l12.2046"> </span>
<a href="#l12.2047"></a><span id="l12.2047" class="difflineminus">-          // Return the unmodifed startdate of the item</span>
<a href="#l12.2048"></a><span id="l12.2048" class="difflineminus">-          // in case no possible match was found.</span>
<a href="#l12.2049"></a><span id="l12.2049" class="difflineminus">-          if (startTime.compare(this.mStartDate) == 0) {</span>
<a href="#l12.2050"></a><span id="l12.2050" class="difflineminus">-              return this.mStartDate.clone();</span>
<a href="#l12.2051"></a><span id="l12.2051" class="difflineminus">-          }</span>
<a href="#l12.2052"></a><span id="l12.2052" class="difflineplus">+            // Return the unmodifed startdate of the item</span>
<a href="#l12.2053"></a><span id="l12.2053" class="difflineplus">+            // in case no possible match was found.</span>
<a href="#l12.2054"></a><span id="l12.2054" class="difflineplus">+            if (startTime.compare(this.mStartDate) == 0) {</span>
<a href="#l12.2055"></a><span id="l12.2055" class="difflineplus">+                return this.mStartDate.clone();</span>
<a href="#l12.2056"></a><span id="l12.2056" class="difflineplus">+            }</span>
<a href="#l12.2057"></a><span id="l12.2057"> </span>
<a href="#l12.2058"></a><span id="l12.2058" class="difflineminus">-          // Special case for allday events - if the original</span>
<a href="#l12.2059"></a><span id="l12.2059" class="difflineminus">-          // datetime was indeed a date we need to carry this</span>
<a href="#l12.2060"></a><span id="l12.2060" class="difflineminus">-          // state over to the calculated datetime.</span>
<a href="#l12.2061"></a><span id="l12.2061" class="difflineminus">-          if (this.mStartDate.isDate) {</span>
<a href="#l12.2062"></a><span id="l12.2062" class="difflineminus">-              startTime.isDate = true;</span>
<a href="#l12.2063"></a><span id="l12.2063" class="difflineminus">-          }</span>
<a href="#l12.2064"></a><span id="l12.2064" class="difflineplus">+            // Special case for allday events - if the original</span>
<a href="#l12.2065"></a><span id="l12.2065" class="difflineplus">+            // datetime was indeed a date we need to carry this</span>
<a href="#l12.2066"></a><span id="l12.2066" class="difflineplus">+            // state over to the calculated datetime.</span>
<a href="#l12.2067"></a><span id="l12.2067" class="difflineplus">+            if (this.mStartDate.isDate) {</span>
<a href="#l12.2068"></a><span id="l12.2068" class="difflineplus">+                startTime.isDate = true;</span>
<a href="#l12.2069"></a><span id="l12.2069" class="difflineplus">+            }</span>
<a href="#l12.2070"></a><span id="l12.2070"> </span>
<a href="#l12.2071"></a><span id="l12.2071" class="difflineminus">-          // In case the new starttime happens to be scheduled</span>
<a href="#l12.2072"></a><span id="l12.2072" class="difflineminus">-          // on a different day, we also need to update the</span>
<a href="#l12.2073"></a><span id="l12.2073" class="difflineminus">-          // complete freebusy informations and appropriate</span>
<a href="#l12.2074"></a><span id="l12.2074" class="difflineminus">-          // underlying arrays holding the informaion.</span>
<a href="#l12.2075"></a><span id="l12.2075" class="difflineminus">-          if (this.mStartDate.day != startTime.day) {</span>
<a href="#l12.2076"></a><span id="l12.2076" class="difflineminus">-              for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.2077"></a><span id="l12.2077" class="difflineminus">-                  let fbelem = this.getFreeBusyElement(i);</span>
<a href="#l12.2078"></a><span id="l12.2078" class="difflineminus">-                  fbelem.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.2079"></a><span id="l12.2079" class="difflineminus">-              }</span>
<a href="#l12.2080"></a><span id="l12.2080" class="difflineminus">-              this.updateFreeBusy();</span>
<a href="#l12.2081"></a><span id="l12.2081" class="difflineminus">-          }</span>
<a href="#l12.2082"></a><span id="l12.2082" class="difflineplus">+            // In case the new starttime happens to be scheduled</span>
<a href="#l12.2083"></a><span id="l12.2083" class="difflineplus">+            // on a different day, we also need to update the</span>
<a href="#l12.2084"></a><span id="l12.2084" class="difflineplus">+            // complete freebusy informations and appropriate</span>
<a href="#l12.2085"></a><span id="l12.2085" class="difflineplus">+            // underlying arrays holding the informaion.</span>
<a href="#l12.2086"></a><span id="l12.2086" class="difflineplus">+            if (this.mStartDate.day != startTime.day) {</span>
<a href="#l12.2087"></a><span id="l12.2087" class="difflineplus">+                for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.2088"></a><span id="l12.2088" class="difflineplus">+                    let fbelem = this.getFreeBusyElement(i);</span>
<a href="#l12.2089"></a><span id="l12.2089" class="difflineplus">+                    fbelem.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.2090"></a><span id="l12.2090" class="difflineplus">+                }</span>
<a href="#l12.2091"></a><span id="l12.2091" class="difflineplus">+                this.updateFreeBusy();</span>
<a href="#l12.2092"></a><span id="l12.2092" class="difflineplus">+            }</span>
<a href="#l12.2093"></a><span id="l12.2093"> </span>
<a href="#l12.2094"></a><span id="l12.2094" class="difflineminus">-          // Return the new starttime of the item.</span>
<a href="#l12.2095"></a><span id="l12.2095" class="difflineminus">-          return startTime;</span>
<a href="#l12.2096"></a><span id="l12.2096" class="difflineplus">+            // Return the new starttime of the item.</span>
<a href="#l12.2097"></a><span id="l12.2097" class="difflineplus">+            return startTime;</span>
<a href="#l12.2098"></a><span id="l12.2098">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2099"></a><span id="l12.2099">       &lt;/method&gt;</span>
<a href="#l12.2100"></a><span id="l12.2100"> </span>
<a href="#l12.2101"></a><span id="l12.2101">       &lt;method name=&quot;forceRefresh&quot;&gt;</span>
<a href="#l12.2102"></a><span id="l12.2102">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2103"></a><span id="l12.2103" class="difflineminus">-          for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.2104"></a><span id="l12.2104" class="difflineminus">-              let row = this.getFreeBusyElement(i);</span>
<a href="#l12.2105"></a><span id="l12.2105" class="difflineminus">-              row.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.2106"></a><span id="l12.2106" class="difflineminus">-          }</span>
<a href="#l12.2107"></a><span id="l12.2107" class="difflineminus">-          this.updateFreeBusy();</span>
<a href="#l12.2108"></a><span id="l12.2108" class="difflineplus">+            for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l12.2109"></a><span id="l12.2109" class="difflineplus">+                let row = this.getFreeBusyElement(i);</span>
<a href="#l12.2110"></a><span id="l12.2110" class="difflineplus">+                row.setAttribute(&quot;dirty&quot;, &quot;true&quot;);</span>
<a href="#l12.2111"></a><span id="l12.2111" class="difflineplus">+            }</span>
<a href="#l12.2112"></a><span id="l12.2112" class="difflineplus">+            this.updateFreeBusy();</span>
<a href="#l12.2113"></a><span id="l12.2113">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2114"></a><span id="l12.2114">       &lt;/method&gt;</span>
<a href="#l12.2115"></a><span id="l12.2115"> </span>
<a href="#l12.2116"></a><span id="l12.2116">       &lt;!-- This method returns the &lt;xul:listitem&gt; at row numer 'aRow' --&gt;</span>
<a href="#l12.2117"></a><span id="l12.2117">       &lt;method name=&quot;getListItem&quot;&gt;</span>
<a href="#l12.2118"></a><span id="l12.2118">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l12.2119"></a><span id="l12.2119">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2120"></a><span id="l12.2120" class="difflineminus">-          let listbox =</span>
<a href="#l12.2121"></a><span id="l12.2121" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.2122"></a><span id="l12.2122" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2123"></a><span id="l12.2123" class="difflineminus">-          if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l12.2124"></a><span id="l12.2124" class="difflineminus">-              let listitems = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l12.2125"></a><span id="l12.2125" class="difflineminus">-              if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l12.2126"></a><span id="l12.2126" class="difflineminus">-                  return listitems[aRow - 1];</span>
<a href="#l12.2127"></a><span id="l12.2127" class="difflineminus">-              }</span>
<a href="#l12.2128"></a><span id="l12.2128" class="difflineminus">-          }</span>
<a href="#l12.2129"></a><span id="l12.2129" class="difflineminus">-          return 0;</span>
<a href="#l12.2130"></a><span id="l12.2130" class="difflineplus">+            let listbox =</span>
<a href="#l12.2131"></a><span id="l12.2131" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.2132"></a><span id="l12.2132" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2133"></a><span id="l12.2133" class="difflineplus">+            if (listbox &amp;&amp; aRow &gt; 0) {</span>
<a href="#l12.2134"></a><span id="l12.2134" class="difflineplus">+                let listitems = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l12.2135"></a><span id="l12.2135" class="difflineplus">+                if (listitems &amp;&amp; listitems.length &gt;= aRow) {</span>
<a href="#l12.2136"></a><span id="l12.2136" class="difflineplus">+                    return listitems[aRow - 1];</span>
<a href="#l12.2137"></a><span id="l12.2137" class="difflineplus">+                }</span>
<a href="#l12.2138"></a><span id="l12.2138" class="difflineplus">+            }</span>
<a href="#l12.2139"></a><span id="l12.2139" class="difflineplus">+            return 0;</span>
<a href="#l12.2140"></a><span id="l12.2140">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2141"></a><span id="l12.2141">       &lt;/method&gt;</span>
<a href="#l12.2142"></a><span id="l12.2142"> </span>
<a href="#l12.2143"></a><span id="l12.2143">       &lt;method name=&quot;getFreeBusyElement&quot;&gt;</span>
<a href="#l12.2144"></a><span id="l12.2144">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l12.2145"></a><span id="l12.2145">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2146"></a><span id="l12.2146" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l12.2147"></a><span id="l12.2147" class="difflineminus">-                                                         &quot;attendeeCol4#&quot; + aRow);</span>
<a href="#l12.2148"></a><span id="l12.2148" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l12.2149"></a><span id="l12.2149" class="difflineplus">+                                                           &quot;attendeeCol4#&quot; + aRow);</span>
<a href="#l12.2150"></a><span id="l12.2150">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2151"></a><span id="l12.2151">       &lt;/method&gt;</span>
<a href="#l12.2152"></a><span id="l12.2152"> </span>
<a href="#l12.2153"></a><span id="l12.2153">       &lt;method name=&quot;deleteRow&quot;&gt;</span>
<a href="#l12.2154"></a><span id="l12.2154">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l12.2155"></a><span id="l12.2155">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2156"></a><span id="l12.2156" class="difflineminus">-          // Reset id's in order to not break the sequence</span>
<a href="#l12.2157"></a><span id="l12.2157" class="difflineminus">-          let max = this.mMaxFreeBusy;</span>
<a href="#l12.2158"></a><span id="l12.2158" class="difflineminus">-          this.removeRow(aRow);</span>
<a href="#l12.2159"></a><span id="l12.2159" class="difflineminus">-          let numberOfCols = this.numColumns;</span>
<a href="#l12.2160"></a><span id="l12.2160" class="difflineminus">-          for (let row = aRow + 1; row &lt;= max; row++) {</span>
<a href="#l12.2161"></a><span id="l12.2161" class="difflineminus">-              for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l12.2162"></a><span id="l12.2162" class="difflineminus">-                  let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l12.2163"></a><span id="l12.2163" class="difflineminus">-                  let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l12.2164"></a><span id="l12.2164" class="difflineminus">-                  if (elem) {</span>
<a href="#l12.2165"></a><span id="l12.2165" class="difflineminus">-                      elem.setAttribute(</span>
<a href="#l12.2166"></a><span id="l12.2166" class="difflineminus">-                          &quot;id&quot;,</span>
<a href="#l12.2167"></a><span id="l12.2167" class="difflineminus">-                          &quot;attendeeCol&quot; + (col) + &quot;#&quot; + (row - 1));</span>
<a href="#l12.2168"></a><span id="l12.2168" class="difflineminus">-                  }</span>
<a href="#l12.2169"></a><span id="l12.2169" class="difflineminus">-              }</span>
<a href="#l12.2170"></a><span id="l12.2170" class="difflineminus">-          }</span>
<a href="#l12.2171"></a><span id="l12.2171" class="difflineplus">+            // Reset id's in order to not break the sequence</span>
<a href="#l12.2172"></a><span id="l12.2172" class="difflineplus">+            let max = this.mMaxFreeBusy;</span>
<a href="#l12.2173"></a><span id="l12.2173" class="difflineplus">+            this.removeRow(aRow);</span>
<a href="#l12.2174"></a><span id="l12.2174" class="difflineplus">+            let numberOfCols = this.numColumns;</span>
<a href="#l12.2175"></a><span id="l12.2175" class="difflineplus">+            for (let row = aRow + 1; row &lt;= max; row++) {</span>
<a href="#l12.2176"></a><span id="l12.2176" class="difflineplus">+                for (let col = 1; col &lt;= numberOfCols; col++) {</span>
<a href="#l12.2177"></a><span id="l12.2177" class="difflineplus">+                    let colID = &quot;attendeeCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l12.2178"></a><span id="l12.2178" class="difflineplus">+                    let elem = document.getAnonymousElementByAttribute(this, &quot;id&quot;, colID);</span>
<a href="#l12.2179"></a><span id="l12.2179" class="difflineplus">+                    if (elem) {</span>
<a href="#l12.2180"></a><span id="l12.2180" class="difflineplus">+                        elem.setAttribute(</span>
<a href="#l12.2181"></a><span id="l12.2181" class="difflineplus">+                            &quot;id&quot;,</span>
<a href="#l12.2182"></a><span id="l12.2182" class="difflineplus">+                            &quot;attendeeCol&quot; + (col) + &quot;#&quot; + (row - 1));</span>
<a href="#l12.2183"></a><span id="l12.2183" class="difflineplus">+                    }</span>
<a href="#l12.2184"></a><span id="l12.2184" class="difflineplus">+                }</span>
<a href="#l12.2185"></a><span id="l12.2185" class="difflineplus">+            }</span>
<a href="#l12.2186"></a><span id="l12.2186">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2187"></a><span id="l12.2187">       &lt;/method&gt;</span>
<a href="#l12.2188"></a><span id="l12.2188"> </span>
<a href="#l12.2189"></a><span id="l12.2189">       &lt;method name=&quot;removeRow&quot;&gt;</span>
<a href="#l12.2190"></a><span id="l12.2190">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l12.2191"></a><span id="l12.2191">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2192"></a><span id="l12.2192" class="difflineminus">-          this.getListItem(aRow).remove();</span>
<a href="#l12.2193"></a><span id="l12.2193" class="difflineminus">-          this.fitDummyRows();</span>
<a href="#l12.2194"></a><span id="l12.2194" class="difflineminus">-          this.mMaxFreeBusy--;</span>
<a href="#l12.2195"></a><span id="l12.2195" class="difflineplus">+            this.getListItem(aRow).remove();</span>
<a href="#l12.2196"></a><span id="l12.2196" class="difflineplus">+            this.fitDummyRows();</span>
<a href="#l12.2197"></a><span id="l12.2197" class="difflineplus">+            this.mMaxFreeBusy--;</span>
<a href="#l12.2198"></a><span id="l12.2198">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2199"></a><span id="l12.2199">       &lt;/method&gt;</span>
<a href="#l12.2200"></a><span id="l12.2200"> </span>
<a href="#l12.2201"></a><span id="l12.2201">       &lt;!-- gets the next row from the top down --&gt;</span>
<a href="#l12.2202"></a><span id="l12.2202">       &lt;method name=&quot;getNextDummyRow&quot;&gt;</span>
<a href="#l12.2203"></a><span id="l12.2203">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2204"></a><span id="l12.2204" class="difflineminus">-          let listbox =</span>
<a href="#l12.2205"></a><span id="l12.2205" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.2206"></a><span id="l12.2206" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2207"></a><span id="l12.2207" class="difflineminus">-          let kids = listbox.childNodes;</span>
<a href="#l12.2208"></a><span id="l12.2208" class="difflineminus">-          for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l12.2209"></a><span id="l12.2209" class="difflineminus">-              if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l12.2210"></a><span id="l12.2210" class="difflineminus">-                  return kids[i];</span>
<a href="#l12.2211"></a><span id="l12.2211" class="difflineminus">-              }</span>
<a href="#l12.2212"></a><span id="l12.2212" class="difflineminus">-          }</span>
<a href="#l12.2213"></a><span id="l12.2213" class="difflineminus">-          return null;</span>
<a href="#l12.2214"></a><span id="l12.2214" class="difflineplus">+            let listbox =</span>
<a href="#l12.2215"></a><span id="l12.2215" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.2216"></a><span id="l12.2216" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2217"></a><span id="l12.2217" class="difflineplus">+            let kids = listbox.childNodes;</span>
<a href="#l12.2218"></a><span id="l12.2218" class="difflineplus">+            for (let i = 0; i &lt; kids.length; ++i) {</span>
<a href="#l12.2219"></a><span id="l12.2219" class="difflineplus">+                if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l12.2220"></a><span id="l12.2220" class="difflineplus">+                    return kids[i];</span>
<a href="#l12.2221"></a><span id="l12.2221" class="difflineplus">+                }</span>
<a href="#l12.2222"></a><span id="l12.2222" class="difflineplus">+            }</span>
<a href="#l12.2223"></a><span id="l12.2223" class="difflineplus">+            return null;</span>
<a href="#l12.2224"></a><span id="l12.2224">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2225"></a><span id="l12.2225">       &lt;/method&gt;</span>
<a href="#l12.2226"></a><span id="l12.2226"> </span>
<a href="#l12.2227"></a><span id="l12.2227">       &lt;method name=&quot;fitDummyRows&quot;&gt;</span>
<a href="#l12.2228"></a><span id="l12.2228">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2229"></a><span id="l12.2229" class="difflineminus">-          setTimeout(() =&gt; {</span>
<a href="#l12.2230"></a><span id="l12.2230" class="difflineminus">-              this.calcContentHeight();</span>
<a href="#l12.2231"></a><span id="l12.2231" class="difflineminus">-              this.createOrRemoveDummyRows();</span>
<a href="#l12.2232"></a><span id="l12.2232" class="difflineminus">-          }, 0);</span>
<a href="#l12.2233"></a><span id="l12.2233" class="difflineplus">+            setTimeout(() =&gt; {</span>
<a href="#l12.2234"></a><span id="l12.2234" class="difflineplus">+                this.calcContentHeight();</span>
<a href="#l12.2235"></a><span id="l12.2235" class="difflineplus">+                this.createOrRemoveDummyRows();</span>
<a href="#l12.2236"></a><span id="l12.2236" class="difflineplus">+            }, 0);</span>
<a href="#l12.2237"></a><span id="l12.2237">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2238"></a><span id="l12.2238">       &lt;/method&gt;</span>
<a href="#l12.2239"></a><span id="l12.2239"> </span>
<a href="#l12.2240"></a><span id="l12.2240">       &lt;method name=&quot;calcContentHeight&quot;&gt;</span>
<a href="#l12.2241"></a><span id="l12.2241">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2242"></a><span id="l12.2242" class="difflineminus">-          let listbox =</span>
<a href="#l12.2243"></a><span id="l12.2243" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.2244"></a><span id="l12.2244" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2245"></a><span id="l12.2245" class="difflineminus">-          let items = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l12.2246"></a><span id="l12.2246" class="difflineminus">-          this.mContentHeight = 0;</span>
<a href="#l12.2247"></a><span id="l12.2247" class="difflineminus">-          if (items.length &gt; 0) {</span>
<a href="#l12.2248"></a><span id="l12.2248" class="difflineminus">-              let i = 0;</span>
<a href="#l12.2249"></a><span id="l12.2249" class="difflineminus">-              do {</span>
<a href="#l12.2250"></a><span id="l12.2250" class="difflineminus">-                  this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l12.2251"></a><span id="l12.2251" class="difflineminus">-                  ++i;</span>
<a href="#l12.2252"></a><span id="l12.2252" class="difflineminus">-              } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l12.2253"></a><span id="l12.2253" class="difflineminus">-              this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l12.2254"></a><span id="l12.2254" class="difflineminus">-          }</span>
<a href="#l12.2255"></a><span id="l12.2255" class="difflineplus">+            let listbox =</span>
<a href="#l12.2256"></a><span id="l12.2256" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.2257"></a><span id="l12.2257" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2258"></a><span id="l12.2258" class="difflineplus">+            let items = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listitem&quot;);</span>
<a href="#l12.2259"></a><span id="l12.2259" class="difflineplus">+            this.mContentHeight = 0;</span>
<a href="#l12.2260"></a><span id="l12.2260" class="difflineplus">+            if (items.length &gt; 0) {</span>
<a href="#l12.2261"></a><span id="l12.2261" class="difflineplus">+                let i = 0;</span>
<a href="#l12.2262"></a><span id="l12.2262" class="difflineplus">+                do {</span>
<a href="#l12.2263"></a><span id="l12.2263" class="difflineplus">+                    this.mRowHeight = items[i].boxObject.height;</span>
<a href="#l12.2264"></a><span id="l12.2264" class="difflineplus">+                    ++i;</span>
<a href="#l12.2265"></a><span id="l12.2265" class="difflineplus">+                } while (i &lt; items.length &amp;&amp; !this.mRowHeight);</span>
<a href="#l12.2266"></a><span id="l12.2266" class="difflineplus">+                this.mContentHeight = this.mRowHeight * items.length;</span>
<a href="#l12.2267"></a><span id="l12.2267" class="difflineplus">+            }</span>
<a href="#l12.2268"></a><span id="l12.2268">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2269"></a><span id="l12.2269">       &lt;/method&gt;</span>
<a href="#l12.2270"></a><span id="l12.2270"> </span>
<a href="#l12.2271"></a><span id="l12.2271">       &lt;method name=&quot;createOrRemoveDummyRows&quot;&gt;</span>
<a href="#l12.2272"></a><span id="l12.2272">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2273"></a><span id="l12.2273" class="difflineminus">-          let listbox =</span>
<a href="#l12.2274"></a><span id="l12.2274" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l12.2275"></a><span id="l12.2275" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2276"></a><span id="l12.2276" class="difflineminus">-          let listboxHeight = listbox.boxObject.height;</span>
<a href="#l12.2277"></a><span id="l12.2277" class="difflineplus">+            let listbox =</span>
<a href="#l12.2278"></a><span id="l12.2278" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l12.2279"></a><span id="l12.2279" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2280"></a><span id="l12.2280" class="difflineplus">+            let listboxHeight = listbox.boxObject.height;</span>
<a href="#l12.2281"></a><span id="l12.2281"> </span>
<a href="#l12.2282"></a><span id="l12.2282" class="difflineminus">-          // Remove rows to remove scrollbar</span>
<a href="#l12.2283"></a><span id="l12.2283" class="difflineminus">-          let kids = listbox.childNodes;</span>
<a href="#l12.2284"></a><span id="l12.2284" class="difflineminus">-          for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l12.2285"></a><span id="l12.2285" class="difflineminus">-              if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l12.2286"></a><span id="l12.2286" class="difflineminus">-                  this.mContentHeight -= this.mRowHeight;</span>
<a href="#l12.2287"></a><span id="l12.2287" class="difflineminus">-                  kids[i].remove();</span>
<a href="#l12.2288"></a><span id="l12.2288" class="difflineminus">-              }</span>
<a href="#l12.2289"></a><span id="l12.2289" class="difflineminus">-          }</span>
<a href="#l12.2290"></a><span id="l12.2290" class="difflineplus">+            // Remove rows to remove scrollbar</span>
<a href="#l12.2291"></a><span id="l12.2291" class="difflineplus">+            let kids = listbox.childNodes;</span>
<a href="#l12.2292"></a><span id="l12.2292" class="difflineplus">+            for (let i = kids.length - 1; this.mContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l12.2293"></a><span id="l12.2293" class="difflineplus">+                if (kids[i].hasAttribute(&quot;_isDummyRow&quot;)) {</span>
<a href="#l12.2294"></a><span id="l12.2294" class="difflineplus">+                    this.mContentHeight -= this.mRowHeight;</span>
<a href="#l12.2295"></a><span id="l12.2295" class="difflineplus">+                    kids[i].remove();</span>
<a href="#l12.2296"></a><span id="l12.2296" class="difflineplus">+                }</span>
<a href="#l12.2297"></a><span id="l12.2297" class="difflineplus">+            }</span>
<a href="#l12.2298"></a><span id="l12.2298"> </span>
<a href="#l12.2299"></a><span id="l12.2299" class="difflineminus">-          // Add rows to fill space</span>
<a href="#l12.2300"></a><span id="l12.2300" class="difflineminus">-          if (this.mRowHeight) {</span>
<a href="#l12.2301"></a><span id="l12.2301" class="difflineminus">-              while (this.mContentHeight + this.mRowHeight &lt; listboxHeight) {</span>
<a href="#l12.2302"></a><span id="l12.2302" class="difflineminus">-                  this.createDummyItem(listbox);</span>
<a href="#l12.2303"></a><span id="l12.2303" class="difflineminus">-                  this.mContentHeight += this.mRowHeight;</span>
<a href="#l12.2304"></a><span id="l12.2304" class="difflineminus">-              }</span>
<a href="#l12.2305"></a><span id="l12.2305" class="difflineminus">-          }</span>
<a href="#l12.2306"></a><span id="l12.2306" class="difflineplus">+            // Add rows to fill space</span>
<a href="#l12.2307"></a><span id="l12.2307" class="difflineplus">+            if (this.mRowHeight) {</span>
<a href="#l12.2308"></a><span id="l12.2308" class="difflineplus">+                while (this.mContentHeight + this.mRowHeight &lt; listboxHeight) {</span>
<a href="#l12.2309"></a><span id="l12.2309" class="difflineplus">+                    this.createDummyItem(listbox);</span>
<a href="#l12.2310"></a><span id="l12.2310" class="difflineplus">+                    this.mContentHeight += this.mRowHeight;</span>
<a href="#l12.2311"></a><span id="l12.2311" class="difflineplus">+                }</span>
<a href="#l12.2312"></a><span id="l12.2312" class="difflineplus">+            }</span>
<a href="#l12.2313"></a><span id="l12.2313">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2314"></a><span id="l12.2314">       &lt;/method&gt;</span>
<a href="#l12.2315"></a><span id="l12.2315"> </span>
<a href="#l12.2316"></a><span id="l12.2316">       &lt;method name=&quot;createDummyCell&quot;&gt;</span>
<a href="#l12.2317"></a><span id="l12.2317">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l12.2318"></a><span id="l12.2318">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2319"></a><span id="l12.2319" class="difflineminus">-          let cell = document.createElement(&quot;listcell&quot;);</span>
<a href="#l12.2320"></a><span id="l12.2320" class="difflineminus">-          cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l12.2321"></a><span id="l12.2321" class="difflineminus">-          if (aParent) {</span>
<a href="#l12.2322"></a><span id="l12.2322" class="difflineminus">-              aParent.appendChild(cell);</span>
<a href="#l12.2323"></a><span id="l12.2323" class="difflineminus">-          }</span>
<a href="#l12.2324"></a><span id="l12.2324" class="difflineminus">-          return cell;</span>
<a href="#l12.2325"></a><span id="l12.2325" class="difflineplus">+            let cell = document.createElement(&quot;listcell&quot;);</span>
<a href="#l12.2326"></a><span id="l12.2326" class="difflineplus">+            cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l12.2327"></a><span id="l12.2327" class="difflineplus">+            if (aParent) {</span>
<a href="#l12.2328"></a><span id="l12.2328" class="difflineplus">+                aParent.appendChild(cell);</span>
<a href="#l12.2329"></a><span id="l12.2329" class="difflineplus">+            }</span>
<a href="#l12.2330"></a><span id="l12.2330" class="difflineplus">+            return cell;</span>
<a href="#l12.2331"></a><span id="l12.2331">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2332"></a><span id="l12.2332">       &lt;/method&gt;</span>
<a href="#l12.2333"></a><span id="l12.2333"> </span>
<a href="#l12.2334"></a><span id="l12.2334">       &lt;method name=&quot;createDummyItem&quot;&gt;</span>
<a href="#l12.2335"></a><span id="l12.2335">         &lt;parameter name=&quot;aParent&quot;/&gt;</span>
<a href="#l12.2336"></a><span id="l12.2336">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2337"></a><span id="l12.2337" class="difflineminus">-          let titem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l12.2338"></a><span id="l12.2338" class="difflineminus">-          titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l12.2339"></a><span id="l12.2339" class="difflineminus">-          titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l12.2340"></a><span id="l12.2340" class="difflineminus">-          for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l12.2341"></a><span id="l12.2341" class="difflineminus">-              this.createDummyCell(titem);</span>
<a href="#l12.2342"></a><span id="l12.2342" class="difflineminus">-          }</span>
<a href="#l12.2343"></a><span id="l12.2343" class="difflineminus">-          if (aParent) {</span>
<a href="#l12.2344"></a><span id="l12.2344" class="difflineminus">-              aParent.appendChild(titem);</span>
<a href="#l12.2345"></a><span id="l12.2345" class="difflineminus">-          }</span>
<a href="#l12.2346"></a><span id="l12.2346" class="difflineminus">-          return titem;</span>
<a href="#l12.2347"></a><span id="l12.2347" class="difflineplus">+            let titem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l12.2348"></a><span id="l12.2348" class="difflineplus">+            titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l12.2349"></a><span id="l12.2349" class="difflineplus">+            titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l12.2350"></a><span id="l12.2350" class="difflineplus">+            for (let i = this.numColumns; i &gt; 0; i--) {</span>
<a href="#l12.2351"></a><span id="l12.2351" class="difflineplus">+                this.createDummyCell(titem);</span>
<a href="#l12.2352"></a><span id="l12.2352" class="difflineplus">+            }</span>
<a href="#l12.2353"></a><span id="l12.2353" class="difflineplus">+            if (aParent) {</span>
<a href="#l12.2354"></a><span id="l12.2354" class="difflineplus">+                aParent.appendChild(titem);</span>
<a href="#l12.2355"></a><span id="l12.2355" class="difflineplus">+            }</span>
<a href="#l12.2356"></a><span id="l12.2356" class="difflineplus">+            return titem;</span>
<a href="#l12.2357"></a><span id="l12.2357">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2358"></a><span id="l12.2358">       &lt;/method&gt;</span>
<a href="#l12.2359"></a><span id="l12.2359"> </span>
<a href="#l12.2360"></a><span id="l12.2360">       &lt;property name=&quot;numColumns&quot;&gt;</span>
<a href="#l12.2361"></a><span id="l12.2361">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l12.2362"></a><span id="l12.2362" class="difflineminus">-          if (!this.mNumColumns) {</span>
<a href="#l12.2363"></a><span id="l12.2363" class="difflineminus">-              let listbox =</span>
<a href="#l12.2364"></a><span id="l12.2364" class="difflineminus">-                  document.getAnonymousElementByAttribute(</span>
<a href="#l12.2365"></a><span id="l12.2365" class="difflineminus">-                      this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2366"></a><span id="l12.2366" class="difflineminus">-              let listCols = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listcol&quot;);</span>
<a href="#l12.2367"></a><span id="l12.2367" class="difflineminus">-              this.mNumColumns = listCols.length || 1;</span>
<a href="#l12.2368"></a><span id="l12.2368" class="difflineminus">-          }</span>
<a href="#l12.2369"></a><span id="l12.2369" class="difflineminus">-          return this.mNumColumns;</span>
<a href="#l12.2370"></a><span id="l12.2370" class="difflineplus">+            if (!this.mNumColumns) {</span>
<a href="#l12.2371"></a><span id="l12.2371" class="difflineplus">+                let listbox =</span>
<a href="#l12.2372"></a><span id="l12.2372" class="difflineplus">+                    document.getAnonymousElementByAttribute(</span>
<a href="#l12.2373"></a><span id="l12.2373" class="difflineplus">+                        this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l12.2374"></a><span id="l12.2374" class="difflineplus">+                let listCols = listbox.getElementsByTagNameNS(&quot;*&quot;, &quot;listcol&quot;);</span>
<a href="#l12.2375"></a><span id="l12.2375" class="difflineplus">+                this.mNumColumns = listCols.length || 1;</span>
<a href="#l12.2376"></a><span id="l12.2376" class="difflineplus">+            }</span>
<a href="#l12.2377"></a><span id="l12.2377" class="difflineplus">+            return this.mNumColumns;</span>
<a href="#l12.2378"></a><span id="l12.2378">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l12.2379"></a><span id="l12.2379">       &lt;/property&gt;</span>
<a href="#l12.2380"></a><span id="l12.2380"> </span>
<a href="#l12.2381"></a><span id="l12.2381">       &lt;method name=&quot;initTimeRange&quot;&gt;</span>
<a href="#l12.2382"></a><span id="l12.2382">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.2383"></a><span id="l12.2383" class="difflineminus">-          if (this.force24Hours) {</span>
<a href="#l12.2384"></a><span id="l12.2384" class="difflineminus">-              this.mStartHour = 0;</span>
<a href="#l12.2385"></a><span id="l12.2385" class="difflineminus">-              this.mEndHour = 24;</span>
<a href="#l12.2386"></a><span id="l12.2386" class="difflineminus">-          } else {</span>
<a href="#l12.2387"></a><span id="l12.2387" class="difflineminus">-              this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.2388"></a><span id="l12.2388" class="difflineminus">-              this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.2389"></a><span id="l12.2389" class="difflineminus">-          }</span>
<a href="#l12.2390"></a><span id="l12.2390" class="difflineplus">+            if (this.force24Hours) {</span>
<a href="#l12.2391"></a><span id="l12.2391" class="difflineplus">+                this.mStartHour = 0;</span>
<a href="#l12.2392"></a><span id="l12.2392" class="difflineplus">+                this.mEndHour = 24;</span>
<a href="#l12.2393"></a><span id="l12.2393" class="difflineplus">+            } else {</span>
<a href="#l12.2394"></a><span id="l12.2394" class="difflineplus">+                this.mStartHour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l12.2395"></a><span id="l12.2395" class="difflineplus">+                this.mEndHour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l12.2396"></a><span id="l12.2396" class="difflineplus">+            }</span>
<a href="#l12.2397"></a><span id="l12.2397">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.2398"></a><span id="l12.2398">       &lt;/method&gt;</span>
<a href="#l12.2399"></a><span id="l12.2399">     &lt;/implementation&gt;</span>
<a href="#l12.2400"></a><span id="l12.2400">   &lt;/binding&gt;</span>
<a href="#l12.2401"></a><span id="l12.2401"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -31,217 +31,217 @@</span>
<a href="#l13.4"></a><span id="l13.4">     &lt;/content&gt;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">     &lt;implementation&gt;</span>
<a href="#l13.7"></a><span id="l13.7">       &lt;field name=&quot;mRecurrenceInfo&quot;&gt;null&lt;/field&gt;</span>
<a href="#l13.8"></a><span id="l13.8">       &lt;field name=&quot;mResizeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l13.9"></a><span id="l13.9">       &lt;field name=&quot;mDateTime&quot;&gt;null&lt;/field&gt;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-        this.mResizeHandler = this.onResize.bind(this);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-        window.addEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+          this.mResizeHandler = this.onResize.bind(this);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+          window.addEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l13.19"></a><span id="l13.19">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-        window.removeEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+          window.removeEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l13.24"></a><span id="l13.24">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">       &lt;property name=&quot;dateTime&quot;&gt;</span>
<a href="#l13.27"></a><span id="l13.27">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l13.28"></a><span id="l13.28">             this.mDateTime = val.clone();</span>
<a href="#l13.29"></a><span id="l13.29">             return this.mDateTime;</span>
<a href="#l13.30"></a><span id="l13.30">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l13.31"></a><span id="l13.31">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l13.32"></a><span id="l13.32">             if (this.mDateTime == null) {</span>
<a href="#l13.33"></a><span id="l13.33">                 this.mDateTime = cal.now();</span>
<a href="#l13.34"></a><span id="l13.34">             }</span>
<a href="#l13.35"></a><span id="l13.35">             return this.mDateTime;</span>
<a href="#l13.36"></a><span id="l13.36">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l13.37"></a><span id="l13.37">       &lt;/property&gt;</span>
<a href="#l13.38"></a><span id="l13.38">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l13.39"></a><span id="l13.39">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-          let minimonth =</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;minimonth&quot;);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+            let minimonth =</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;minimonth&quot;);</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-          let row =</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-          let rows = row.parentNode;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+            let row =</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+            let rows = row.parentNode;</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-          let contentWidth = minimonth.boxObject.width;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-          let containerWidth =</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-              document.getAnonymousNodes(this)[0]</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-                  .boxObject.width;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+            let contentWidth = minimonth.boxObject.width;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+            let containerWidth =</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+                document.getAnonymousNodes(this)[0]</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+                    .boxObject.width;</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-          // Now find out how much elements can be displayed.</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-          // this is a simple division which always yields a positive integer value.</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-          let numHorizontal =</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-              (containerWidth -</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-                  (containerWidth % contentWidth)) /</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-                      contentWidth;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+            // Now find out how much elements can be displayed.</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+            // this is a simple division which always yields a positive integer value.</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+            let numHorizontal =</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+                (containerWidth -</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+                    (containerWidth % contentWidth)) /</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+                        contentWidth;</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-          let contentHeight = minimonth.boxObject.height;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-          let containerHeight =</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-              document.getAnonymousNodes(this)[0]</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-                  .boxObject.height;</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+            let contentHeight = minimonth.boxObject.height;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+            let containerHeight =</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+                document.getAnonymousNodes(this)[0]</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+                    .boxObject.height;</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-          // Now find out how much elements can be displayed.</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-          // this is a simple division which always yields a positive integer value.</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-          let numVertical =</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-              (containerHeight -</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-                  (containerHeight % contentHeight)) /</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-                      contentHeight;</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-          numVertical = Math.max(1, numVertical);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+            // Now find out how much elements can be displayed.</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+            // this is a simple division which always yields a positive integer value.</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+            let numVertical =</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+                (containerHeight -</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+                    (containerHeight % contentHeight)) /</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+                        contentHeight;</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+            numVertical = Math.max(1, numVertical);</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-          // Count the number of existing rows</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-          let numRows = 0;</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-          let rowIterator = row;</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-          while (rowIterator) {</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-              numRows++;</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-              rowIterator = rowIterator.nextSibling;</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-          }</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+            // Count the number of existing rows</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+            let numRows = 0;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+            let rowIterator = row;</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+            while (rowIterator) {</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+                numRows++;</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+                rowIterator = rowIterator.nextSibling;</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+            }</span>
<a href="#l13.116"></a><span id="l13.116"> </span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-          // Adjust rows</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-          while (numRows &lt; numVertical) {</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-              let newNode = row.cloneNode(true);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-              rows.appendChild(newNode);</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-              numRows++;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-          }</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-          while (numRows &gt; numVertical) {</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-              rows.firstChild.remove();</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-              numRows--;</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-          }</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+            // Adjust rows</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+            while (numRows &lt; numVertical) {</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+                let newNode = row.cloneNode(true);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+                rows.appendChild(newNode);</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+                numRows++;</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+            }</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+            while (numRows &gt; numVertical) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+                rows.firstChild.remove();</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+                numRows--;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+            }</span>
<a href="#l13.137"></a><span id="l13.137"> </span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-          // Adjust columns in the grid</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-          let column =</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-              document.getAnonymousElementByAttribute(</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;column&quot;);</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-          let columns = column.parentNode;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-          while ((columns.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-              let newColumn = column.cloneNode(false);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-              columns.insertBefore(newColumn, column.nextSibling);</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-          }</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-          while ((columns.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-              columns.firstChild.remove();</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-          }</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+            // Adjust columns in the grid</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+            let column =</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+                document.getAnonymousElementByAttribute(</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;column&quot;);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+            let columns = column.parentNode;</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+            while ((columns.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+                let newColumn = column.cloneNode(false);</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+                columns.insertBefore(newColumn, column.nextSibling);</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+            }</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+            while ((columns.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+                columns.firstChild.remove();</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+            }</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-          // Walk all rows and adjust column elements</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-          row = document.getAnonymousElementByAttribute(</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-                   this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-          while (row) {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-              let firstChild = row.firstChild;</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-              while ((row.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-                  let newNode = firstChild.cloneNode(true);</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-                  firstChild.parentNode.insertBefore(newNode, firstChild);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-              }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-              while ((row.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-                  row.firstChild.remove();</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-              }</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-              row = row.nextSibling;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-          }</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+            // Walk all rows and adjust column elements</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+            row = document.getAnonymousElementByAttribute(</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+                     this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+            while (row) {</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+                let firstChild = row.firstChild;</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+                while ((row.childNodes.length - 1) &lt; numHorizontal) {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+                    let newNode = firstChild.cloneNode(true);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+                    firstChild.parentNode.insertBefore(newNode, firstChild);</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+                }</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+                while ((row.childNodes.length - 1) &gt; numHorizontal) {</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+                    row.firstChild.remove();</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+                }</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+                row = row.nextSibling;</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+            }</span>
<a href="#l13.191"></a><span id="l13.191"> </span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-          this.updateContent();</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-          this.updatePreview(this.mRecurrenceInfo);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+            this.updateContent();</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+            this.updatePreview(this.mRecurrenceInfo);</span>
<a href="#l13.196"></a><span id="l13.196">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.197"></a><span id="l13.197">       &lt;/method&gt;</span>
<a href="#l13.198"></a><span id="l13.198"> </span>
<a href="#l13.199"></a><span id="l13.199">       &lt;method name=&quot;updateContent&quot;&gt;</span>
<a href="#l13.200"></a><span id="l13.200">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-          let date = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-          let row = document.getAnonymousElementByAttribute(</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-                        this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-          while (row) {</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-              let numChilds = row.childNodes.length - 1;</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-              for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-                  let minimonth = row.childNodes[i];</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-                  minimonth.showMonth(date);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-                  date.setMonth(date.getMonth() + 1);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-              }</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-              row = row.nextSibling;</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-          }</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+            let date = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+            let row = document.getAnonymousElementByAttribute(</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+            while (row) {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+                let numChilds = row.childNodes.length - 1;</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+                for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+                    let minimonth = row.childNodes[i];</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+                    minimonth.showMonth(date);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+                    date.setMonth(date.getMonth() + 1);</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+                }</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+                row = row.nextSibling;</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+            }</span>
<a href="#l13.225"></a><span id="l13.225">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.226"></a><span id="l13.226">       &lt;/method&gt;</span>
<a href="#l13.227"></a><span id="l13.227"> </span>
<a href="#l13.228"></a><span id="l13.228">       &lt;method name=&quot;updatePreview&quot;&gt;</span>
<a href="#l13.229"></a><span id="l13.229">         &lt;parameter name=&quot;aRecurrenceInfo&quot;/&gt;</span>
<a href="#l13.230"></a><span id="l13.230">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-          this.mRecurrenceInfo = aRecurrenceInfo;</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-          let start = this.dateTime.clone();</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-          start.day = 1;</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-          start.hour = 0;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-          start.minute = 0;</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-          start.second = 0;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-          let end = start.clone();</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-          end.month++;</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+            this.mRecurrenceInfo = aRecurrenceInfo;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+            let start = this.dateTime.clone();</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+            start.day = 1;</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+            start.hour = 0;</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+            start.minute = 0;</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+            start.second = 0;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+            let end = start.clone();</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+            end.month++;</span>
<a href="#l13.247"></a><span id="l13.247"> </span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-          // the 'minimonth' controls are arranged in a</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-          // grid, sorted by rows first -&gt; iterate the rows that may exist.</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-          let row = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-          while (row) {</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-              // now iterater all the child nodes of this row</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-              // in order to visit each minimonth in turn.</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-              let numChilds = row.childNodes.length - 1;</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-              for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-                  // we now have one of the minimonth controls while 'start'</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-                  // and 'end' are set to the interval this minimonth shows.</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-                  let minimonth = row.childNodes[i];</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-                  minimonth.showMonth(cal.dateTimeToJsDate(start));</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-                  if (aRecurrenceInfo) {</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-                      // retrieve an array of dates that represents all occurrences</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-                      // that fall into this time interval [start,end[.</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-                      // note: the following loop assumes that this array conains</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-                      // dates that are strictly monotonically increasing.</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-                      // should getOccurrenceDates() not enforce this assumption we</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-                      // need to fall back to some different algorithm.</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-                      let dates = aRecurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+            // the 'minimonth' controls are arranged in a</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+            // grid, sorted by rows first -&gt; iterate the rows that may exist.</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+            let row = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+            while (row) {</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+                // now iterater all the child nodes of this row</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+                // in order to visit each minimonth in turn.</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+                let numChilds = row.childNodes.length - 1;</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+                for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+                    // we now have one of the minimonth controls while 'start'</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+                    // and 'end' are set to the interval this minimonth shows.</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+                    let minimonth = row.childNodes[i];</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+                    minimonth.showMonth(cal.dateTimeToJsDate(start));</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+                    if (aRecurrenceInfo) {</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+                        // retrieve an array of dates that represents all occurrences</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+                        // that fall into this time interval [start,end[.</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+                        // note: the following loop assumes that this array conains</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+                        // dates that are strictly monotonically increasing.</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+                        // should getOccurrenceDates() not enforce this assumption we</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+                        // need to fall back to some different algorithm.</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+                        let dates = aRecurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l13.288"></a><span id="l13.288"> </span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-                      // now run throgh all days of this month and set the</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-                      // 'busy' attribute with respect to the occurrence array.</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-                      let index = 0;</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-                      let occurrence = null;</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-                      if (index &lt; dates.length) {</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-                          occurrence =</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-                              dates[index++]</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-                                  .getInTimezone(start.timezone);</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-                      }</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-                      let current = start.clone();</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-                      while (current.compare(end) &lt; 0) {</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-                          let box = minimonth.getBoxForDate(current);</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-                          if (box) {</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-                              if (occurrence &amp;&amp;</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-                                  occurrence.day == current.day &amp;&amp;</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-                                  occurrence.month == current.month &amp;&amp;</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-                                  occurrence.year == current.year) {</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-                                  box.setAttribute(&quot;busy&quot;, 1);</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-                                  if (index &lt; dates.length) {</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-                                      occurrence =</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-                                          dates[index++]</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-                                              .getInTimezone(start.timezone);</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-                                      // take into account that the very next occurrence</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-                                      // can happen at the same day as the previous one.</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-                                      if (occurrence.day == current.day &amp;&amp;</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-                                          occurrence.month == current.month &amp;&amp;</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-                                          occurrence.year == current.year) {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-                                          continue;</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-                                      }</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-                                  } else {</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-                                      occurrence = null;</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-                                  }</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-                              } else {</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-                                  box.removeAttribute(&quot;busy&quot;);</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-                              }</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-                          }</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-                          current.day++;</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-                      }</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-                  }</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-                  start.month++;</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-                  end.month++;</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-              }</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-              row = row.nextSibling;</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-          }</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+                        // now run throgh all days of this month and set the</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+                        // 'busy' attribute with respect to the occurrence array.</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+                        let index = 0;</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+                        let occurrence = null;</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+                        if (index &lt; dates.length) {</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+                            occurrence =</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+                                dates[index++]</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+                                    .getInTimezone(start.timezone);</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+                        }</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+                        let current = start.clone();</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+                        while (current.compare(end) &lt; 0) {</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+                            let box = minimonth.getBoxForDate(current);</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+                            if (box) {</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+                                if (occurrence &amp;&amp;</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+                                    occurrence.day == current.day &amp;&amp;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+                                    occurrence.month == current.month &amp;&amp;</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+                                    occurrence.year == current.year) {</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+                                    box.setAttribute(&quot;busy&quot;, 1);</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+                                    if (index &lt; dates.length) {</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+                                        occurrence =</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+                                            dates[index++]</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+                                                .getInTimezone(start.timezone);</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+                                        // take into account that the very next occurrence</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+                                        // can happen at the same day as the previous one.</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+                                        if (occurrence.day == current.day &amp;&amp;</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+                                            occurrence.month == current.month &amp;&amp;</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+                                            occurrence.year == current.year) {</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+                                            continue;</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+                                        }</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+                                    } else {</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+                                        occurrence = null;</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+                                    }</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+                                } else {</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+                                    box.removeAttribute(&quot;busy&quot;);</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+                                }</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+                            }</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+                            current.day++;</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+                        }</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+                    }</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+                    start.month++;</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+                    end.month++;</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+                }</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+                row = row.nextSibling;</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+            }</span>
<a href="#l13.377"></a><span id="l13.377">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.378"></a><span id="l13.378">       &lt;/method&gt;</span>
<a href="#l13.379"></a><span id="l13.379">     &lt;/implementation&gt;</span>
<a href="#l13.380"></a><span id="l13.380">   &lt;/binding&gt;</span>
<a href="#l13.381"></a><span id="l13.381"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -14,20 +14,20 @@</span>
<a href="#l14.4"></a><span id="l14.4">   &lt;binding id=&quot;calendar-invitations-richlistbox&quot;</span>
<a href="#l14.5"></a><span id="l14.5">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistbox&quot;</span>
<a href="#l14.6"></a><span id="l14.6">            xbl:inherits=&quot;flex&quot;&gt;</span>
<a href="#l14.7"></a><span id="l14.7">     &lt;implementation&gt;</span>
<a href="#l14.8"></a><span id="l14.8">       &lt;!-- methods --&gt;</span>
<a href="#l14.9"></a><span id="l14.9">       &lt;method name=&quot;addCalendarItem&quot;&gt;</span>
<a href="#l14.10"></a><span id="l14.10">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l14.11"></a><span id="l14.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-          let newNode = createXULElement(&quot;calendar-invitations-richlistitem&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-          this.appendChild(newNode);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-          newNode.setAttribute(&quot;anonid&quot;, &quot;invitations-listitem&quot;);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-          newNode.calendarItem = aItem;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+            let newNode = createXULElement(&quot;calendar-invitations-richlistitem&quot;);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+            this.appendChild(newNode);</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+            newNode.setAttribute(&quot;anonid&quot;, &quot;invitations-listitem&quot;);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+            newNode.calendarItem = aItem;</span>
<a href="#l14.20"></a><span id="l14.20">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.21"></a><span id="l14.21">       &lt;/method&gt;</span>
<a href="#l14.22"></a><span id="l14.22">     &lt;/implementation&gt;</span>
<a href="#l14.23"></a><span id="l14.23">   &lt;/binding&gt;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">   &lt;binding id=&quot;calendar-invitations-richlistitem&quot;</span>
<a href="#l14.26"></a><span id="l14.26">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l14.27"></a><span id="l14.27">     &lt;content&gt;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineat">@@ -66,175 +66,174 @@</span>
<a href="#l14.29"></a><span id="l14.29">       &lt;!-- fields --&gt;</span>
<a href="#l14.30"></a><span id="l14.30">       &lt;field name=&quot;mDateFormatter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.31"></a><span id="l14.31">       &lt;field name=&quot;mCalendarItem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.32"></a><span id="l14.32">       &lt;field name=&quot;mInitialParticipationStatus&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.33"></a><span id="l14.33">       &lt;field name=&quot;mParticipationStatus&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">       &lt;property name=&quot;mStrings&quot;&gt;</span>
<a href="#l14.36"></a><span id="l14.36">         &lt;getter&gt;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-          return {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-              alldayEvent: &quot;&amp;calendar.invitations.list.alldayevent.text;&quot;,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-              recurrentEvent: &quot;&amp;calendar.invitations.list.recurrentevent.text;&quot;,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-              location: &quot;&amp;calendar.invitations.list.location.text;&quot;,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-              organizer: &quot;&amp;calendar.invitations.list.organizer.text;&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-              attendee: &quot;&amp;calendar.invitations.list.attendee.text;&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-              none: &quot;&amp;calendar.invitations.list.none.text;&quot;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-          };</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+            return {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+                alldayEvent: &quot;&amp;calendar.invitations.list.alldayevent.text;&quot;,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+                recurrentEvent: &quot;&amp;calendar.invitations.list.recurrentevent.text;&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                location: &quot;&amp;calendar.invitations.list.location.text;&quot;,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+                organizer: &quot;&amp;calendar.invitations.list.organizer.text;&quot;,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+                attendee: &quot;&amp;calendar.invitations.list.attendee.text;&quot;,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+                none: &quot;&amp;calendar.invitations.list.none.text;&quot;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+            };</span>
<a href="#l14.53"></a><span id="l14.53">         &lt;/getter&gt;</span>
<a href="#l14.54"></a><span id="l14.54">       &lt;/property&gt;</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">       &lt;!-- properties --&gt;</span>
<a href="#l14.57"></a><span id="l14.57">       &lt;property name=&quot;calendarItem&quot;&gt;</span>
<a href="#l14.58"></a><span id="l14.58">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-          return this.mCalendarItem;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+            return this.mCalendarItem;</span>
<a href="#l14.61"></a><span id="l14.61">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l14.62"></a><span id="l14.62">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-          this.setCalendarItem(val);</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-          return val;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+            this.setCalendarItem(val);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+            return val;</span>
<a href="#l14.67"></a><span id="l14.67">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.68"></a><span id="l14.68">       &lt;/property&gt;</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">       &lt;property name=&quot;initialParticipationStatus&quot;&gt;</span>
<a href="#l14.71"></a><span id="l14.71">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-          return this.mInitialParticipationStatus;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+            return this.mInitialParticipationStatus;</span>
<a href="#l14.74"></a><span id="l14.74">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l14.75"></a><span id="l14.75">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-          this.mInitialParticipationStatus = val;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-          return val;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+            this.mInitialParticipationStatus = val;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+            return val;</span>
<a href="#l14.80"></a><span id="l14.80">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.81"></a><span id="l14.81">       &lt;/property&gt;</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83">       &lt;property name=&quot;participationStatus&quot;&gt;</span>
<a href="#l14.84"></a><span id="l14.84">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-          return this.mParticipationStatus;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+            return this.mParticipationStatus;</span>
<a href="#l14.87"></a><span id="l14.87">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l14.88"></a><span id="l14.88">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-          this.mParticipationStatus = val;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-          let icon = document.getAnonymousElementByAttribute(</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-              this, &quot;anonid&quot;, &quot;icon&quot;);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-          icon.setAttribute(&quot;status&quot;, val);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-          return val;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+            this.mParticipationStatus = val;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+            let icon = document.getAnonymousElementByAttribute(</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+                this, &quot;anonid&quot;, &quot;icon&quot;);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+            icon.setAttribute(&quot;status&quot;, val);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+            return val;</span>
<a href="#l14.99"></a><span id="l14.99">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.100"></a><span id="l14.100">       &lt;/property&gt;</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102">       &lt;!-- constructor --&gt;</span>
<a href="#l14.103"></a><span id="l14.103">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-        this.mDateFormatter = cal.getDateFormatter();</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+          this.mDateFormatter = cal.getDateFormatter();</span>
<a href="#l14.108"></a><span id="l14.108">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">       &lt;!-- methods --&gt;</span>
<a href="#l14.111"></a><span id="l14.111">       &lt;method name=&quot;setCalendarItem&quot;&gt;</span>
<a href="#l14.112"></a><span id="l14.112">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l14.113"></a><span id="l14.113">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-          this.mCalendarItem = aItem;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-          this.mInitialParticipationStatus =</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-              this.getCalendarItemParticipationStatus(aItem);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-          this.participationStatus = this.mInitialParticipationStatus;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+            this.mCalendarItem = aItem;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+            this.mInitialParticipationStatus =</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+                this.getCalendarItemParticipationStatus(aItem);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+            this.participationStatus = this.mInitialParticipationStatus;</span>
<a href="#l14.122"></a><span id="l14.122"> </span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-          let titleLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-              this, &quot;anonid&quot;, &quot;title&quot;);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-          titleLabel.setAttribute(&quot;value&quot;, aItem.title);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+            let titleLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+                this, &quot;anonid&quot;, &quot;title&quot;);</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+            titleLabel.setAttribute(&quot;value&quot;, aItem.title);</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-          let dateLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-              this, &quot;anonid&quot;, &quot;date&quot;);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-          let dateString = this.mDateFormatter.formatItemInterval(aItem);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-          if (aItem.startDate.isDate) {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-              dateString += &quot;, &quot; + this.mStrings.alldayEvent;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-          }</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-          dateLabel.setAttribute(&quot;value&quot;, dateString);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+            let dateLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+                this, &quot;anonid&quot;, &quot;date&quot;);</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+            let dateString = this.mDateFormatter.formatItemInterval(aItem);</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+            if (aItem.startDate.isDate) {</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+                dateString += &quot;, &quot; + this.mStrings.alldayEvent;</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+            }</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+            dateLabel.setAttribute(&quot;value&quot;, dateString);</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-          let recurrenceLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-              this, &quot;anonid&quot;, &quot;recurrence&quot;);</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-          if (aItem.recurrenceInfo) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-              recurrenceLabel.setAttribute(&quot;value&quot;, this.mStrings.recurrentEvent);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-          } else {</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-              recurrenceLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-              let spacer = document.getAnonymousElementByAttribute(</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-                  this, &quot;anonid&quot;, &quot;spacer&quot;);</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-              spacer.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-          }</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+            let recurrenceLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+                this, &quot;anonid&quot;, &quot;recurrence&quot;);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+            if (aItem.recurrenceInfo) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+                recurrenceLabel.setAttribute(&quot;value&quot;, this.mStrings.recurrentEvent);</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+            } else {</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+                recurrenceLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+                let spacer = document.getAnonymousElementByAttribute(</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+                    this, &quot;anonid&quot;, &quot;spacer&quot;);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+                spacer.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+            }</span>
<a href="#l14.165"></a><span id="l14.165"> </span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-          let locationLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-              this, &quot;anonid&quot;, &quot;location&quot;);</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-          let locationString = this.mStrings.location;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-          let locationProperty = aItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-          if (locationProperty &amp;&amp; locationProperty.length &gt; 0) {</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-              locationString += locationProperty;</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-          } else {</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-              locationString += this.mStrings.none;</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-          }</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-          locationLabel.setAttribute(&quot;value&quot;, locationString);</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+            let locationLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+                this, &quot;anonid&quot;, &quot;location&quot;);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+            let locationString = this.mStrings.location;</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+            let locationProperty = aItem.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+            if (locationProperty &amp;&amp; locationProperty.length &gt; 0) {</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+                locationString += locationProperty;</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+            } else {</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+                locationString += this.mStrings.none;</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+            }</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+            locationLabel.setAttribute(&quot;value&quot;, locationString);</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-          let organizerLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-              this, &quot;anonid&quot;, &quot;organizer&quot;);</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-          let organizerString = this.mStrings.organizer;</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-          let org = aItem.organizer;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineminus">-          if (org) {</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-              if (org.commonName &amp;&amp; org.commonName.length &gt; 0) {</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-                  organizerString += org.commonName;</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-              } else if (org.id) {</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-                  organizerString += org.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-              }</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-          }</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-          organizerLabel.setAttribute(&quot;value&quot;, organizerString);</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+            let organizerLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+                this, &quot;anonid&quot;, &quot;organizer&quot;);</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+            let organizerString = this.mStrings.organizer;</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+            let org = aItem.organizer;</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+            if (org) {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+                if (org.commonName &amp;&amp; org.commonName.length &gt; 0) {</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+                    organizerString += org.commonName;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+                } else if (org.id) {</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+                    organizerString += org.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+                }</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+            }</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+            organizerLabel.setAttribute(&quot;value&quot;, organizerString);</span>
<a href="#l14.211"></a><span id="l14.211"> </span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-          let attendeeLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-              this, &quot;anonid&quot;, &quot;attendee&quot;);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-          let attendeeString = this.mStrings.attendee;</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-          let att = cal.getInvitedAttendee(aItem);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-          if (att) {</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-              if (att.commonName &amp;&amp; att.commonName.length &gt; 0) {</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-                  attendeeString += att.commonName;</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-              } else if (att.id) {</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-                  attendeeString += att.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-              }</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-          }</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineminus">-          attendeeLabel.setAttribute(&quot;value&quot;, attendeeString);</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-          this.setAttribute(&quot;itemId&quot;, aItem.hashId);</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineminus">-          ]]&gt;</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+            let attendeeLabel = document.getAnonymousElementByAttribute(</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+                this, &quot;anonid&quot;, &quot;attendee&quot;);</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+            let attendeeString = this.mStrings.attendee;</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+            let att = cal.getInvitedAttendee(aItem);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+            if (att) {</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+                if (att.commonName &amp;&amp; att.commonName.length &gt; 0) {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+                    attendeeString += att.commonName;</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+                } else if (att.id) {</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+                    attendeeString += att.id.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+                }</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+            }</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+            attendeeLabel.setAttribute(&quot;value&quot;, attendeeString);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+            this.setAttribute(&quot;itemId&quot;, aItem.hashId);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l14.241"></a><span id="l14.241">       &lt;/method&gt;</span>
<a href="#l14.242"></a><span id="l14.242"> </span>
<a href="#l14.243"></a><span id="l14.243">       &lt;method name=&quot;getCalendarItemParticipationStatus&quot;&gt;</span>
<a href="#l14.244"></a><span id="l14.244">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l14.245"></a><span id="l14.245">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-          let att = cal.getInvitedAttendee(aItem);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-          return (att ? att.participationStatus : null);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+            let att = cal.getInvitedAttendee(aItem);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+            return (att ? att.participationStatus : null);</span>
<a href="#l14.250"></a><span id="l14.250">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.251"></a><span id="l14.251">       &lt;/method&gt;</span>
<a href="#l14.252"></a><span id="l14.252"> </span>
<a href="#l14.253"></a><span id="l14.253">       &lt;method name=&quot;setCalendarItemParticipationStatus&quot;&gt;</span>
<a href="#l14.254"></a><span id="l14.254">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l14.255"></a><span id="l14.255">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l14.256"></a><span id="l14.256">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-          let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-          if (calendar) {</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-              let att = calendar.getInvitedAttendee(aItem);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-              if (att) {</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-                  let att_ = att.clone();</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-                  att_.participationStatus = aStatus;</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+            let calendar = cal.wrapInstance(aItem.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+            if (calendar) {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+                let att = calendar.getInvitedAttendee(aItem);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+                if (att) {</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+                    let att_ = att.clone();</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+                    att_.participationStatus = aStatus;</span>
<a href="#l14.269"></a><span id="l14.269"> </span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-                  // Update attendee</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-                  aItem.removeAttendee(att);</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-                  aItem.addAttendee(att_);</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-                  return true;</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-              }</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-          }</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-          return false;</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+                    // Update attendee</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+                    aItem.removeAttendee(att);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+                    aItem.addAttendee(att_);</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+                    return true;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+                }</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+            }</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+            return false;</span>
<a href="#l14.284"></a><span id="l14.284">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.285"></a><span id="l14.285">       &lt;/method&gt;</span>
<a href="#l14.286"></a><span id="l14.286"> </span>
<a href="#l14.287"></a><span id="l14.287">       &lt;method name=&quot;accept&quot;&gt;</span>
<a href="#l14.288"></a><span id="l14.288">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-          this.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+            this.participationStatus = &quot;ACCEPTED&quot;;</span>
<a href="#l14.291"></a><span id="l14.291">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.292"></a><span id="l14.292">       &lt;/method&gt;</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">       &lt;method name=&quot;decline&quot;&gt;</span>
<a href="#l14.295"></a><span id="l14.295">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-          this.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+            this.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l14.298"></a><span id="l14.298">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.299"></a><span id="l14.299">       &lt;/method&gt;</span>
<a href="#l14.300"></a><span id="l14.300">     &lt;/implementation&gt;</span>
<a href="#l14.301"></a><span id="l14.301">   &lt;/binding&gt;</span>
<a href="#l14.302"></a><span id="l14.302"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -54,138 +54,138 @@</span>
<a href="#l15.4"></a><span id="l15.4">         &lt;xul:button anonid=&quot;alarm-dismiss-button&quot;</span>
<a href="#l15.5"></a><span id="l15.5">                     label=&quot;&amp;calendar.alarm.dismiss.label;&quot;</span>
<a href="#l15.6"></a><span id="l15.6">                     oncommand=&quot;dismissAlarm()&quot;/&gt;</span>
<a href="#l15.7"></a><span id="l15.7">       &lt;/xul:vbox&gt;</span>
<a href="#l15.8"></a><span id="l15.8">     &lt;/content&gt;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">     &lt;implementation&gt;</span>
<a href="#l15.11"></a><span id="l15.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">       &lt;field name=&quot;mItem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.17"></a><span id="l15.17">       &lt;field name=&quot;mAlarm&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">       &lt;property name=&quot;item&quot;</span>
<a href="#l15.20"></a><span id="l15.20">                 onget=&quot;return this.mItem;&quot;</span>
<a href="#l15.21"></a><span id="l15.21">                 onset=&quot;this.mItem = val; this.updateLabels(); return val;&quot;/&gt;</span>
<a href="#l15.22"></a><span id="l15.22">       &lt;property name=&quot;alarm&quot;</span>
<a href="#l15.23"></a><span id="l15.23">                 onget=&quot;return this.mAlarm;&quot;</span>
<a href="#l15.24"></a><span id="l15.24">                 onset=&quot;this.mAlarm = val; this.updateLabels(); return val;&quot;/&gt;</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">       &lt;method name=&quot;updateLabels&quot;&gt;</span>
<a href="#l15.27"></a><span id="l15.27">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-          if (!this.mItem || !this.mAlarm) {</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-              // Setup not complete, do nothing for now.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-              return;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-          }</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+            if (!this.mItem || !this.mAlarm) {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+                // Setup not complete, do nothing for now.</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+                return;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+            }</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-          let formatter = cal.getDateFormatter();</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-          let titleLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-title-label&quot;);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-          let locationDescription = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-description&quot;);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-          let dateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-date-label&quot;);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+            let formatter = cal.getDateFormatter();</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+            let titleLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-title-label&quot;);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+            let locationDescription = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-description&quot;);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+            let dateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-date-label&quot;);</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-          // Dates</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-          if (cal.isEvent(this.mItem)) {</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-              dateLabel.textContent = formatter.formatItemInterval(this.mItem);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-          } else if (cal.isToDo(this.mItem)) {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-              let startDate = this.mItem.entryDate || this.mItem.dueDate;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-              if (startDate) {</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-                  // A Task with a start or due date, show with label</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-                  startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-                  dateLabel.textContent = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-                                                           &quot;alarmStarts&quot;,</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-                                                           [formatter.formatDateTime(startDate)]);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-              } else {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-                  // If the task has no start date, then format the alarm date.</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-                  dateLabel.textContent = formatter.formatDateTime(this.mAlarm.alarmDate);</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-              }</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-          } else {</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-              throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-          }</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+            // Dates</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+            if (cal.isEvent(this.mItem)) {</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+                dateLabel.textContent = formatter.formatItemInterval(this.mItem);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+            } else if (cal.isToDo(this.mItem)) {</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+                let startDate = this.mItem.entryDate || this.mItem.dueDate;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+                if (startDate) {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                    // A Task with a start or due date, show with label</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+                    startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                    dateLabel.textContent = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+                                                             &quot;alarmStarts&quot;,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                                                             [formatter.formatDateTime(startDate)]);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+                } else {</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+                    // If the task has no start date, then format the alarm date.</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+                    dateLabel.textContent = formatter.formatDateTime(this.mAlarm.alarmDate);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+                }</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+            } else {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+                throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+            }</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-          // Relative date</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-          this.updateRelativeDateLabel();</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+            // Relative date</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+            this.updateRelativeDateLabel();</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-          // Title, location</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-          titleLabel.textContent = this.mItem.title || &quot;&quot;;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-          locationDescription.textContent = this.mItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-          locationDescription.hidden = (locationDescription.textContent.length &lt; 1);</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+            // Title, location</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+            titleLabel.textContent = this.mItem.title || &quot;&quot;;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+            locationDescription.textContent = this.mItem.getProperty(&quot;LOCATION&quot;) || &quot;&quot;;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+            locationDescription.hidden = (locationDescription.textContent.length &lt; 1);</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-label&quot;).hidden =</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-              (locationDescription.textContent.length &lt; 1);</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-location-label&quot;).hidden =</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+                (locationDescription.textContent.length &lt; 1);</span>
<a href="#l15.101"></a><span id="l15.101">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.102"></a><span id="l15.102">       &lt;/method&gt;</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">       &lt;method name=&quot;updateRelativeDateLabel&quot;&gt;</span>
<a href="#l15.105"></a><span id="l15.105">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-          let formatter = cal.getDateFormatter();</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-          let item = this.mItem;</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-          let relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-          let relativeDateString;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-          let startDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-          if (startDate) {</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-              startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-              let currentDate = cal.now();</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-              let sinceDayStart = (currentDate.hour * 3600) + (currentDate.minute * 60);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+            let formatter = cal.getDateFormatter();</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+            let item = this.mItem;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+            let relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+            let relativeDateString;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+            let startDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+            if (startDate) {</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+                startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+                let currentDate = cal.now();</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+                let sinceDayStart = (currentDate.hour * 3600) + (currentDate.minute * 60);</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-              currentDate.second = 0;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-              startDate.second = 0;</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+                currentDate.second = 0;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+                startDate.second = 0;</span>
<a href="#l15.129"></a><span id="l15.129"> </span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-              let sinceAlarm = currentDate.subtractDate(startDate).inSeconds;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-              this.mAlarmToday = (sinceAlarm &lt; sinceDayStart) &amp;&amp; (sinceAlarm &gt; sinceDayStart - 86400);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+                let sinceAlarm = currentDate.subtractDate(startDate).inSeconds;</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+                this.mAlarmToday = (sinceAlarm &lt; sinceDayStart) &amp;&amp; (sinceAlarm &gt; sinceDayStart - 86400);</span>
<a href="#l15.134"></a><span id="l15.134"> </span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-              if (this.mAlarmToday) {</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-                  // The alarm is today</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-                                                        &quot;alarmTodayAt&quot;,</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-              } else if (sinceAlarm &lt;= sinceDayStart - 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart - 172800) {</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-                  // The alarm is tomorrow</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-                                                        &quot;alarmTomorrowAt&quot;,</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-              } else if (sinceAlarm &lt; sinceDayStart + 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart) {</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-                  // The alarm is yesterday</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-                                                        &quot;alarmYesterdayAt&quot;,</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-              } else {</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-                  // The alarm is way back</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-                  relativeDateString = [formatter.formatDateTime(startDate)];</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-              }</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-          } else {</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-              // No start or end date, therefore the alarm must be absolute and</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-              // have an alarm date.</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-              relativeDateString = [formatter.formatDateTime(this.mAlarm.alarmDate)];</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-          }</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+                if (this.mAlarmToday) {</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+                    // The alarm is today</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+                    relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+                                                          &quot;alarmTodayAt&quot;,</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+                                                          [formatter.formatTime(startDate)]);</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+                } else if (sinceAlarm &lt;= sinceDayStart - 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart - 172800) {</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+                    // The alarm is tomorrow</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+                    relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+                                                          &quot;alarmTomorrowAt&quot;,</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+                                                          [formatter.formatTime(startDate)]);</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+                } else if (sinceAlarm &lt; sinceDayStart + 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart) {</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+                    // The alarm is yesterday</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+                    relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+                                                          &quot;alarmYesterdayAt&quot;,</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+                                                          [formatter.formatTime(startDate)]);</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+                } else {</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+                    // The alarm is way back</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+                    relativeDateString = [formatter.formatDateTime(startDate)];</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+                }</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+            } else {</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+                // No start or end date, therefore the alarm must be absolute and</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+                // have an alarm date.</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+                relativeDateString = [formatter.formatDateTime(this.mAlarm.alarmDate)];</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+            }</span>
<a href="#l15.183"></a><span id="l15.183"> </span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-          relativeDateLabel.textContent = relativeDateString;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+            relativeDateLabel.textContent = relativeDateString;</span>
<a href="#l15.186"></a><span id="l15.186">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.187"></a><span id="l15.187">       &lt;/method&gt;</span>
<a href="#l15.188"></a><span id="l15.188"> </span>
<a href="#l15.189"></a><span id="l15.189">       &lt;method name=&quot;showDetails&quot;&gt;</span>
<a href="#l15.190"></a><span id="l15.190">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l15.191"></a><span id="l15.191">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-          if (event.type == &quot;click&quot; ||</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-              (event.type == &quot;keypress&quot; &amp;&amp;</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-               event.keyCode == event.DOM_VK_RETURN)) {</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-              let detailsEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-              detailsEvent.initEvent(&quot;itemdetails&quot;, true, false);</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-              this.dispatchEvent(detailsEvent);</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-          }</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+            if (event.type == &quot;click&quot; ||</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+                (event.type == &quot;keypress&quot; &amp;&amp;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+                 event.keyCode == event.DOM_VK_RETURN)) {</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+                let detailsEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+                detailsEvent.initEvent(&quot;itemdetails&quot;, true, false);</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+                this.dispatchEvent(detailsEvent);</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+            }</span>
<a href="#l15.206"></a><span id="l15.206">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.207"></a><span id="l15.207">       &lt;/method&gt;</span>
<a href="#l15.208"></a><span id="l15.208"> </span>
<a href="#l15.209"></a><span id="l15.209">       &lt;method name=&quot;dismissAlarm&quot;&gt;</span>
<a href="#l15.210"></a><span id="l15.210">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-          let dismissEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-          dismissEvent.initEvent(&quot;dismiss&quot;, true, false);</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-          this.dispatchEvent(dismissEvent);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+            let dismissEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+            dismissEvent.initEvent(&quot;dismiss&quot;, true, false);</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+            this.dispatchEvent(dismissEvent);</span>
<a href="#l15.217"></a><span id="l15.217">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.218"></a><span id="l15.218">       &lt;/method&gt;</span>
<a href="#l15.219"></a><span id="l15.219">     &lt;/implementation&gt;</span>
<a href="#l15.220"></a><span id="l15.220">   &lt;/binding&gt;</span>
<a href="#l15.221"></a><span id="l15.221"> </span>
<a href="#l15.222"></a><span id="l15.222">   &lt;binding id=&quot;calendar-snooze-popup&quot;&gt;</span>
<a href="#l15.223"></a><span id="l15.223">     &lt;content ignorekeys=&quot;true&quot;&gt;</span>
<a href="#l15.224"></a><span id="l15.224">       &lt;xul:menuitem label=&quot;&amp;calendar.alarm.snooze.5minutes.label;&quot;</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineat">@@ -238,115 +238,115 @@</span>
<a href="#l15.226"></a><span id="l15.226">         &lt;xul:toolbarbutton anonid=&quot;snooze-popup-cancel&quot;</span>
<a href="#l15.227"></a><span id="l15.227">                            class=&quot;snooze-popup-button snooze-popup-cancel-button&quot;</span>
<a href="#l15.228"></a><span id="l15.228">                            aria-label=&quot;&amp;calendar.alarm.snooze.cancel;&quot;</span>
<a href="#l15.229"></a><span id="l15.229">                            oncommand=&quot;snoozeCancel()&quot;/&gt;</span>
<a href="#l15.230"></a><span id="l15.230">       &lt;/xul:hbox&gt;</span>
<a href="#l15.231"></a><span id="l15.231">     &lt;/content&gt;</span>
<a href="#l15.232"></a><span id="l15.232">     &lt;implementation&gt;</span>
<a href="#l15.233"></a><span id="l15.233">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.238"></a><span id="l15.238"> </span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-        let snoozePref = Preferences.get(&quot;calendar.alarms.defaultsnoozelength&quot;, 0);</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-        if (snoozePref &lt;= 0) {</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-            snoozePref = 5;</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-        }</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+          let snoozePref = Preferences.get(&quot;calendar.alarms.defaultsnoozelength&quot;, 0);</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+          if (snoozePref &lt;= 0) {</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+              snoozePref = 5;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+          }</span>
<a href="#l15.247"></a><span id="l15.247"> </span>
<a href="#l15.248"></a><span id="l15.248" class="difflineminus">-        let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-        let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+          let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+          let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-        let selectedIndex = 0;</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-        if ((snoozePref % 60) == 0) {</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-            snoozePref = snoozePref / 60;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-            if ((snoozePref % 24) == 0) {</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-                snoozePref = snoozePref / 24;</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-                selectedIndex = 2; // Days</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-            } else {</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-                selectedIndex = 1; // Hours</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-            }</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-        } else {</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineminus">-            selectedIndex = 0; // Minutes</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineminus">-        }</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+          let selectedIndex = 0;</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+          if ((snoozePref % 60) == 0) {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+              snoozePref = snoozePref / 60;</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+              if ((snoozePref % 24) == 0) {</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+                  snoozePref = snoozePref / 24;</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+                  selectedIndex = 2; // Days</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+              } else {</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+                  selectedIndex = 1; // Hours</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+              }</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+          } else {</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+              selectedIndex = 0; // Minutes</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+          }</span>
<a href="#l15.277"></a><span id="l15.277"> </span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-        unitList.selectedIndex = selectedIndex;</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-        unitValue.value = snoozePref;</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+          unitList.selectedIndex = selectedIndex;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+          unitValue.value = snoozePref;</span>
<a href="#l15.282"></a><span id="l15.282"> </span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-        updateAccessibleName();</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+          updateAccessibleName();</span>
<a href="#l15.285"></a><span id="l15.285">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.286"></a><span id="l15.286"> </span>
<a href="#l15.287"></a><span id="l15.287">       &lt;method name=&quot;snoozeAlarm&quot;&gt;</span>
<a href="#l15.288"></a><span id="l15.288">         &lt;parameter name=&quot;minutes&quot;/&gt;</span>
<a href="#l15.289"></a><span id="l15.289">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-          let snoozeEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-          snoozeEvent.initEvent(&quot;snooze&quot;, true, false);</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-          snoozeEvent.detail = minutes;</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+            let snoozeEvent = document.createEvent(&quot;Events&quot;);</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+            snoozeEvent.initEvent(&quot;snooze&quot;, true, false);</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+            snoozeEvent.detail = minutes;</span>
<a href="#l15.296"></a><span id="l15.296"> </span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-          // The onsnooze attribute is set on the menupopup, this binding is</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-          // instanciated on the menupopup's arrowscrollbox. Therefore we need</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-          // to go up one node.</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-          let handler = this.parentNode.getAttribute(&quot;onsnooze&quot;);</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-          let cancel = false;</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-          if (handler) {</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-              let func = new Function(&quot;event&quot;, handler);</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-              cancel = (func.call(this, snoozeEvent) === false);</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-          }</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+            // The onsnooze attribute is set on the menupopup, this binding is</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+            // instanciated on the menupopup's arrowscrollbox. Therefore we need</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+            // to go up one node.</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+            let handler = this.parentNode.getAttribute(&quot;onsnooze&quot;);</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+            let cancel = false;</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+            if (handler) {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+                let func = new Function(&quot;event&quot;, handler);</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+                cancel = (func.call(this, snoozeEvent) === false);</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+            }</span>
<a href="#l15.315"></a><span id="l15.315"> </span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-          if (!cancel) {</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-              this.dispatchEvent(snoozeEvent);</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-          }</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+            if (!cancel) {</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+                this.dispatchEvent(snoozeEvent);</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+            }</span>
<a href="#l15.322"></a><span id="l15.322">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.323"></a><span id="l15.323">       &lt;/method&gt;</span>
<a href="#l15.324"></a><span id="l15.324"> </span>
<a href="#l15.325"></a><span id="l15.325">       &lt;method name=&quot;snoozeItem&quot;&gt;</span>
<a href="#l15.326"></a><span id="l15.326">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l15.327"></a><span id="l15.327">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-          this.snoozeAlarm(event.target.value);</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+            this.snoozeAlarm(event.target.value);</span>
<a href="#l15.330"></a><span id="l15.330">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.331"></a><span id="l15.331">       &lt;/method&gt;</span>
<a href="#l15.332"></a><span id="l15.332"> </span>
<a href="#l15.333"></a><span id="l15.333">       &lt;method name=&quot;snoozeOk&quot;&gt;</span>
<a href="#l15.334"></a><span id="l15.334">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-          let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-          let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+            let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+            let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.339"></a><span id="l15.339"> </span>
<a href="#l15.340"></a><span id="l15.340" class="difflineminus">-          let minutes = (unitList.value || 1) * unitValue.value;</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineminus">-          this.snoozeAlarm(minutes);</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineplus">+            let minutes = (unitList.value || 1) * unitValue.value;</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineplus">+            this.snoozeAlarm(minutes);</span>
<a href="#l15.344"></a><span id="l15.344">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.345"></a><span id="l15.345">       &lt;/method&gt;</span>
<a href="#l15.346"></a><span id="l15.346"> </span>
<a href="#l15.347"></a><span id="l15.347">       &lt;method name=&quot;snoozeCancel&quot;&gt;</span>
<a href="#l15.348"></a><span id="l15.348">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-          this.parentNode.hidePopup();</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+            this.parentNode.hidePopup();</span>
<a href="#l15.351"></a><span id="l15.351">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.352"></a><span id="l15.352">       &lt;/method&gt;</span>
<a href="#l15.353"></a><span id="l15.353"> </span>
<a href="#l15.354"></a><span id="l15.354">       &lt;method name=&quot;updateAccessibleName&quot;&gt;</span>
<a href="#l15.355"></a><span id="l15.355">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-          let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-          let unitPopup = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menupopup&quot;);</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-          let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-          let okButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-popup-ok&quot;);</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineplus">+            let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+            let unitPopup = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menupopup&quot;);</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+            let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+            let okButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-popup-ok&quot;);</span>
<a href="#l15.364"></a><span id="l15.364"> </span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-          function unitName(list) {</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-              return { 1: &quot;unitMinutes&quot;, 60: &quot;unitHours&quot;, 1440: &quot;unitDays&quot; }[list.value] || &quot;unitMinutes&quot;;</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-          }</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+            function unitName(list) {</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+                return { 1: &quot;unitMinutes&quot;, 60: &quot;unitHours&quot;, 1440: &quot;unitDays&quot; }[list.value] || &quot;unitMinutes&quot;;</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineplus">+            }</span>
<a href="#l15.371"></a><span id="l15.371"> </span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-          let pluralString = cal.calGetString(&quot;calendar&quot;, unitName(unitList));</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-          let unitPlural = PluralForm.get(unitValue.value, pluralString)</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-                                     .replace(&quot;#1&quot;, unitValue.value);</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+            let pluralString = cal.calGetString(&quot;calendar&quot;, unitName(unitList));</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineplus">+            let unitPlural = PluralForm.get(unitValue.value, pluralString)</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineplus">+                                       .replace(&quot;#1&quot;, unitValue.value);</span>
<a href="#l15.378"></a><span id="l15.378"> </span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-          let accessibleString = cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineminus">-                                                  &quot;reminderSnoozeOkA11y&quot;,</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-                                                  [unitPlural]);</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-          okButton.setAttribute(&quot;aria-label&quot;, accessibleString);</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+            let accessibleString = cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineplus">+                                                    &quot;reminderSnoozeOkA11y&quot;,</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineplus">+                                                    [unitPlural]);</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineplus">+            okButton.setAttribute(&quot;aria-label&quot;, accessibleString);</span>
<a href="#l15.387"></a><span id="l15.387"> </span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-          let items = unitPopup.getElementsByTagName(&quot;xul:menuitem&quot;);</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineminus">-          for (let menuItem of items) {</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineminus">-              pluralString = cal.calGetString(&quot;calendar&quot;, unitName(menuItem));</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-              menuItem.label = PluralForm.get(unitValue.value, pluralString)</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineminus">-                                         .replace(&quot;#1&quot;, &quot;&quot;).trim();</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineminus">-          }</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+            let items = unitPopup.getElementsByTagName(&quot;xul:menuitem&quot;);</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+            for (let menuItem of items) {</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+                pluralString = cal.calGetString(&quot;calendar&quot;, unitName(menuItem));</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+                menuItem.label = PluralForm.get(unitValue.value, pluralString)</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineplus">+                                           .replace(&quot;#1&quot;, &quot;&quot;).trim();</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineplus">+            }</span>
<a href="#l15.400"></a><span id="l15.400">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.401"></a><span id="l15.401">       &lt;/method&gt;</span>
<a href="#l15.402"></a><span id="l15.402">     &lt;/implementation&gt;</span>
<a href="#l15.403"></a><span id="l15.403">   &lt;/binding&gt;</span>
<a href="#l15.404"></a><span id="l15.404"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -11,162 +11,162 @@</span>
<a href="#l16.4"></a><span id="l16.4">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l16.5"></a><span id="l16.5">   &lt;binding id=&quot;full-calendar-list-tree&quot; extends=&quot;#calendar-list-tree&quot;&gt;</span>
<a href="#l16.6"></a><span id="l16.6">     &lt;!--</span>
<a href="#l16.7"></a><span id="l16.7">       - This binding implements a full calendar list, that automatically adds</span>
<a href="#l16.8"></a><span id="l16.8">       - and removes calendars when a calendar is registered or unregistered.</span>
<a href="#l16.9"></a><span id="l16.9">       --&gt;</span>
<a href="#l16.10"></a><span id="l16.10">     &lt;implementation&gt;</span>
<a href="#l16.11"></a><span id="l16.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-        let calMgr = cal.getCalendarManager();</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-        calMgr.addObserver(this.calMgrObserver);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+          let calMgr = cal.getCalendarManager();</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+          calMgr.addObserver(this.calMgrObserver);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l16.20"></a><span id="l16.20">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-        let calMgr = cal.getCalendarManager();</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-        calMgr.removeObserver(this.calMgrObserver);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-        this.calMgrObserver.listTree = null;</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+          let calMgr = cal.getCalendarManager();</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+          calMgr.removeObserver(this.calMgrObserver);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+          this.calMgrObserver.listTree = null;</span>
<a href="#l16.27"></a><span id="l16.27">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">       &lt;field name=&quot;mAddingFromComposite&quot;&gt;false&lt;/field&gt;</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31">       &lt;property name=&quot;compositeCalendar&quot;&gt;</span>
<a href="#l16.32"></a><span id="l16.32">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-          if (!this.mCompositeCalendar) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-              throw Components.Exception(&quot;Calendar list has no composite calendar yet&quot;,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-                                         Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-          }</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-          return this.mCompositeCalendar;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+            if (!this.mCompositeCalendar) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+                throw Components.Exception(&quot;Calendar list has no composite calendar yet&quot;,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+                                           Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+            }</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+            return this.mCompositeCalendar;</span>
<a href="#l16.43"></a><span id="l16.43">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.44"></a><span id="l16.44">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-          this.mCompositeCalendar = val;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-          this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+            this.mCompositeCalendar = val;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+            this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-          // Now that we have a composite calendar, we can get all calendars</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-          // from the calendar manager.</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-          this.mAddingFromComposite = true;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-          let calendars = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-          calendars.forEach(this.addCalendar, this);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-          this.mAddingFromComposite = false;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+            // Now that we have a composite calendar, we can get all calendars</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+            // from the calendar manager.</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+            this.mAddingFromComposite = true;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+            let calendars = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+            calendars.forEach(this.addCalendar, this);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+            this.mAddingFromComposite = false;</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-          return val;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+            return val;</span>
<a href="#l16.65"></a><span id="l16.65">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.66"></a><span id="l16.66">       &lt;/property&gt;</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68">       &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l16.69"></a><span id="l16.69">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-          return this.mCalendarList;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l16.72"></a><span id="l16.72">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.73"></a><span id="l16.73">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-          // Setting calendars externally is not wanted. This is done internally</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-          // in the compositeCalendar setter.</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-          throw Components.Exception(&quot;Seting calendars on type='full' is not supported&quot;,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-                                     Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+            // Setting calendars externally is not wanted. This is done internally</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+            // in the compositeCalendar setter.</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+            throw Components.Exception(&quot;Seting calendars on type='full' is not supported&quot;,</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+                                       Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l16.82"></a><span id="l16.82">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.83"></a><span id="l16.83">       &lt;/property&gt;</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85">       &lt;field name=&quot;calMgrObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-      ({</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-          listTree: this,</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarManagerObserver]),</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+        ({</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+            listTree: this,</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarManagerObserver]),</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-          // calICalendarManagerObserver</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-          onCalendarRegistered: function(aCalendar) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-              this.listTree.addCalendar(aCalendar);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-              let composite = this.listTree.compositeCalendar;</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-              let inComposite = aCalendar.getProperty(composite.prefPrefix +</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-                                                      &quot;-in-composite&quot;);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-              if ((inComposite === null) || inComposite) {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                  composite.addCalendar(aCalendar);</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-              }</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-          },</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+            // calICalendarManagerObserver</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+            onCalendarRegistered: function(aCalendar) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+                this.listTree.addCalendar(aCalendar);</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+                let composite = this.listTree.compositeCalendar;</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+                let inComposite = aCalendar.getProperty(composite.prefPrefix +</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+                                                        &quot;-in-composite&quot;);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+                if ((inComposite === null) || inComposite) {</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+                    composite.addCalendar(aCalendar);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+                }</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+            },</span>
<a href="#l16.113"></a><span id="l16.113"> </span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-          onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-              this.listTree.removeCalendar(aCalendar);</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-          },</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+            onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+                this.listTree.removeCalendar(aCalendar);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+            },</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-          onCalendarDeleting: function(aCalendar) {</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-              // Now that the calendar is unregistered, update the commands to</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-              // make sure that New Event/Task commands are correctly</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-              // enabled/disabled.</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-              document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-          }</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-      })</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+            onCalendarDeleting: function(aCalendar) {</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+                // Now that the calendar is unregistered, update the commands to</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+                // make sure that New Event/Task commands are correctly</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+                // enabled/disabled.</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+                document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+            }</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+        })</span>
<a href="#l16.135"></a><span id="l16.135">       ]]&gt;&lt;/field&gt;</span>
<a href="#l16.136"></a><span id="l16.136">       &lt;field name=&quot;compositeObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-      ({</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-          listTree: this,</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-              Components.interfaces.calICompositeObserver,</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-              Components.interfaces.calIObserver</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-          ]),</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+        ({</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+            listTree: this,</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+                Components.interfaces.calICompositeObserver,</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+                Components.interfaces.calIObserver</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+            ]),</span>
<a href="#l16.149"></a><span id="l16.149"> </span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-          // calICompositeObserver</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-          onCalendarAdded: function(aCalendar) {</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-              // Make sure the checkbox state is updated</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-              this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-          },</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+            // calICompositeObserver</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+            onCalendarAdded: function(aCalendar) {</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+                // Make sure the checkbox state is updated</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+                this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+            },</span>
<a href="#l16.160"></a><span id="l16.160"> </span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-          onCalendarRemoved: function(aCalendar) {</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-              // Make sure the checkbox state is updated</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-              this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-          },</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+            onCalendarRemoved: function(aCalendar) {</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+                // Make sure the checkbox state is updated</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+                this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+            },</span>
<a href="#l16.169"></a><span id="l16.169"> </span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-          onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-          },</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+            onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+            },</span>
<a href="#l16.174"></a><span id="l16.174"> </span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-          // calIObserver</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-          onStartBatch: function() { },</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-          onEndBatch: function() { },</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-          onLoad: function() { },</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+            // calIObserver</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+            onStartBatch: function() { },</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+            onEndBatch: function() { },</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+            onLoad: function() { },</span>
<a href="#l16.183"></a><span id="l16.183"> </span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-          onAddItem: function(aItem) {</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-              if (aItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-                  this.listTree.ensureCalendarVisible(aItem.calendar);</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-              }</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-          },</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-          onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-              if (aNewItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-                  this.listTree.ensureCalendarVisible(aNewItem.calendar);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-              }</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-          },</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-          onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-          onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+            onAddItem: function(aItem) {</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+                if (aItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+                    this.listTree.ensureCalendarVisible(aItem.calendar);</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+                }</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+            },</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+            onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+                if (aNewItem.calendar.type != &quot;caldav&quot;) {</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+                    this.listTree.ensureCalendarVisible(aNewItem.calendar);</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+                }</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+            },</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+            onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+            onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l16.208"></a><span id="l16.208"> </span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-          onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-              switch (aName) {</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-                  case &quot;disabled&quot;:</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-                  case &quot;readOnly&quot;:</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-                      calendarUpdateNewItemsCommand();</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-                      document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-                      break;</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-              }</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-          },</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+            onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+                switch (aName) {</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+                    case &quot;disabled&quot;:</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+                    case &quot;readOnly&quot;:</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+                        calendarUpdateNewItemsCommand();</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+                        document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+                        break;</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+                }</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+            },</span>
<a href="#l16.227"></a><span id="l16.227"> </span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-          onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-          }</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-      })</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+            onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+            }</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+        })</span>
<a href="#l16.234"></a><span id="l16.234">       ]]&gt;&lt;/field&gt;</span>
<a href="#l16.235"></a><span id="l16.235">     &lt;/implementation&gt;</span>
<a href="#l16.236"></a><span id="l16.236">     &lt;handlers&gt;</span>
<a href="#l16.237"></a><span id="l16.237">       &lt;handler event=&quot;dblclick&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-        let col = {};</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-        let calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-        if (event.button != 0 ||</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-            (col.value &amp;&amp; col.value.element &amp;&amp;</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-             col.value.element.getAttribute(&quot;anonid&quot;) == &quot;checkbox-treecol&quot;)) {</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-            // Only left clicks that are not on the checkbox column</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-            return;</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-        }</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-        if (calendar) {</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-            cal.openCalendarProperties(window, calendar);</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-        } else {</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-            cal.openCalendarWizard(window);</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-        }</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+          let col = {};</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+          let calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+          if (event.button != 0 ||</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+              (col.value &amp;&amp; col.value.element &amp;&amp;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+               col.value.element.getAttribute(&quot;anonid&quot;) == &quot;checkbox-treecol&quot;)) {</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+              // Only left clicks that are not on the checkbox column</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+              return;</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+          }</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+          if (calendar) {</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+              cal.openCalendarProperties(window, calendar);</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+          } else {</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+              cal.openCalendarWizard(window);</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+          }</span>
<a href="#l16.264"></a><span id="l16.264">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.265"></a><span id="l16.265">     &lt;/handlers&gt;</span>
<a href="#l16.266"></a><span id="l16.266">   &lt;/binding&gt;</span>
<a href="#l16.267"></a><span id="l16.267"> </span>
<a href="#l16.268"></a><span id="l16.268">   &lt;binding id=&quot;calendar-list-tree&quot;&gt;</span>
<a href="#l16.269"></a><span id="l16.269">     &lt;content&gt;</span>
<a href="#l16.270"></a><span id="l16.270">       &lt;xul:tree anonid=&quot;tree&quot;</span>
<a href="#l16.271"></a><span id="l16.271">                 xbl:inherits=&quot;hidecolumnpicker&quot;</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineat">@@ -224,156 +224,156 @@</span>
<a href="#l16.273"></a><span id="l16.273">       &lt;field name=&quot;treebox&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.274"></a><span id="l16.274">       &lt;field name=&quot;ruleCache&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.275"></a><span id="l16.275">       &lt;field name=&quot;mCachedSheet&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.276"></a><span id="l16.276"> </span>
<a href="#l16.277"></a><span id="l16.277">       &lt;field name=&quot;mCycleCalendarFlag&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.278"></a><span id="l16.278">       &lt;field name=&quot;mCycleTimer&quot;&gt;null&lt;/field&gt;</span>
<a href="#l16.279"></a><span id="l16.279"> </span>
<a href="#l16.280"></a><span id="l16.280">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-        this.tree.view = this;</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineminus">-        this.ruleCache = {};</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineminus">-        this.mCycleCalendarFlag = {};</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+          this.tree.view = this;</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+          this.ruleCache = {};</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+          this.mCycleCalendarFlag = {};</span>
<a href="#l16.291"></a><span id="l16.291">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l16.292"></a><span id="l16.292">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-        // Clean up the calendar manager observers. Do not use removeCalendar</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-        // here since that will remove the calendar from the composite calendar.</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-        for (let calendar of this.mCalendarList) {</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-            calendar.removeObserver(this.calObserver);</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-        }</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+          // Clean up the calendar manager observers. Do not use removeCalendar</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+          // here since that will remove the calendar from the composite calendar.</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+          for (let calendar of this.mCalendarList) {</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+              calendar.removeObserver(this.calObserver);</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+          }</span>
<a href="#l16.303"></a><span id="l16.303"> </span>
<a href="#l16.304"></a><span id="l16.304" class="difflineminus">-        this.tree.view = null;</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineminus">-        this.calObserver.listTree = null;</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+          this.tree.view = null;</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+          this.calObserver.listTree = null;</span>
<a href="#l16.308"></a><span id="l16.308"> </span>
<a href="#l16.309"></a><span id="l16.309" class="difflineminus">-        if (this.mCompositeCalendar) {</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineminus">-            this.mCompositeCalendar.removeObserver(this.compositeObserver);</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-        }</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+          if (this.mCompositeCalendar) {</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+              this.mCompositeCalendar.removeObserver(this.compositeObserver);</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+          }</span>
<a href="#l16.315"></a><span id="l16.315">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l16.316"></a><span id="l16.316"> </span>
<a href="#l16.317"></a><span id="l16.317">       &lt;field name=&quot;calObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineminus">-      ({</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineminus">-          listTree: this,</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+        ({</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+            listTree: this,</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l16.324"></a><span id="l16.324"> </span>
<a href="#l16.325"></a><span id="l16.325" class="difflineminus">-          // calIObserver. Note that each registered calendar uses this observer</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineminus">-          onStartBatch: function() { },</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineminus">-          onEndBatch: function() { },</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineminus">-          onLoad: function() { },</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+            // calIObserver. Note that each registered calendar uses this observer</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+            onStartBatch: function() { },</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+            onEndBatch: function() { },</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+            onLoad: function() { },</span>
<a href="#l16.333"></a><span id="l16.333"> </span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-          onAddItem: function(aItem) { },</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-          onModifyItem: function(aNewItem, aOldItem) { },</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-          onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-          onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+            onAddItem: function(aItem) { },</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+            onModifyItem: function(aNewItem, aOldItem) { },</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+            onDeleteItem: function(aDeletedItem) { },</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+            onError: function(aCalendar, aErrNo, aMessage) { },</span>
<a href="#l16.342"></a><span id="l16.342"> </span>
<a href="#l16.343"></a><span id="l16.343" class="difflineminus">-          onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineminus">-              switch (aName) {</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineminus">-                  case &quot;color&quot;:</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-                      // TODO See other TODO in this file about updateStyleSheetForViews</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-                      if (&quot;updateStyleSheetForViews&quot; in window) {</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-                          updateStyleSheetForViews(aCalendar);</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineminus">-                      }</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineminus">-                      this.listTree.updateCalendarColor(aCalendar);</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-                      // Fall through, update item in any case</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-                  case &quot;name&quot;:</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-                  case &quot;currentStatus&quot;:</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineminus">-                  case &quot;readOnly&quot;:</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineminus">-                  case &quot;disabled&quot;:</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineminus">-                      this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-                      // Fall through, update commands in any cases.</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineminus">-              }</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineminus">-          },</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+            onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+                switch (aName) {</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+                    case &quot;color&quot;:</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+                        // TODO See other TODO in this file about updateStyleSheetForViews</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+                        if (&quot;updateStyleSheetForViews&quot; in window) {</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+                            updateStyleSheetForViews(aCalendar);</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+                        }</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+                        this.listTree.updateCalendarColor(aCalendar);</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+                        // Fall through, update item in any case</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+                    case &quot;name&quot;:</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+                    case &quot;currentStatus&quot;:</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+                    case &quot;readOnly&quot;:</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+                    case &quot;disabled&quot;:</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+                        this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+                        // Fall through, update commands in any cases.</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+                }</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+            },</span>
<a href="#l16.377"></a><span id="l16.377"> </span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-          onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-              // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineminus">-              // but should not be the same as the value, set it to a different</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-              // value.</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-              this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineminus">-          }</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineminus">-      })</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+            onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+                // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+                // but should not be the same as the value, set it to a different</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+                // value.</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+                this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+            }</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+        })</span>
<a href="#l16.392"></a><span id="l16.392">       ]]&gt;&lt;/field&gt;</span>
<a href="#l16.393"></a><span id="l16.393"> </span>
<a href="#l16.394"></a><span id="l16.394">       &lt;field name=&quot;compositeObserver&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-      ({</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-          listTree: this,</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineminus">-          QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICompositeObserver]),</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+        ({</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+            listTree: this,</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICompositeObserver]),</span>
<a href="#l16.401"></a><span id="l16.401"> </span>
<a href="#l16.402"></a><span id="l16.402" class="difflineminus">-          // calICompositeObserver</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineminus">-          onCalendarAdded: function(aCalendar) {</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineminus">-              // Make sure the checkbox state is updated</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineminus">-              this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineminus">-          },</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+            // calICompositeObserver</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+            onCalendarAdded: function(aCalendar) {</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+                // Make sure the checkbox state is updated</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+                this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+            },</span>
<a href="#l16.412"></a><span id="l16.412"> </span>
<a href="#l16.413"></a><span id="l16.413" class="difflineminus">-          onCalendarRemoved: function(aCalendar) {</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineminus">-              // Make sure the checkbox state is updated</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineminus">-              this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineminus">-          },</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+            onCalendarRemoved: function(aCalendar) {</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+                // Make sure the checkbox state is updated</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+                this.listTree.updateCalendar(aCalendar);</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+            },</span>
<a href="#l16.421"></a><span id="l16.421"> </span>
<a href="#l16.422"></a><span id="l16.422" class="difflineminus">-          onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineminus">-          }</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineminus">-      })</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+            onDefaultCalendarChanged: function(aCalendar) {</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+            }</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+        })</span>
<a href="#l16.428"></a><span id="l16.428">       ]]&gt;&lt;/field&gt;</span>
<a href="#l16.429"></a><span id="l16.429"> </span>
<a href="#l16.430"></a><span id="l16.430">       &lt;property name=&quot;treechildren&quot;</span>
<a href="#l16.431"></a><span id="l16.431">                 readonly=&quot;true&quot;</span>
<a href="#l16.432"></a><span id="l16.432">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'treechildren')&quot;/&gt;</span>
<a href="#l16.433"></a><span id="l16.433">       &lt;property name=&quot;tree&quot;</span>
<a href="#l16.434"></a><span id="l16.434">                 readonly=&quot;true&quot;</span>
<a href="#l16.435"></a><span id="l16.435">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'tree')&quot;/&gt;</span>
<a href="#l16.436"></a><span id="l16.436"> </span>
<a href="#l16.437"></a><span id="l16.437"> </span>
<a href="#l16.438"></a><span id="l16.438">       &lt;property name=&quot;sheet&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l16.439"></a><span id="l16.439">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineminus">-          if (!this.mCachedSheet) {</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineminus">-              for (let sheet of document.styleSheets) {</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineminus">-                  if (sheet.href == &quot;chrome://calendar/skin/calendar-management.css&quot;) {</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineminus">-                      this.mCachedSheet = sheet;</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineminus">-                      break;</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineminus">-                  }</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineminus">-              }</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineminus">-              if (!this.mCachedSheet) {</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-                  cal.ERROR(&quot;Could not find calendar-management.css, needs to be added to &quot; +</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineminus">-                            window.document.title + &quot;'s stylesheets&quot;);</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineminus">-              }</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineminus">-          }</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+            if (!this.mCachedSheet) {</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+                for (let sheet of document.styleSheets) {</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+                    if (sheet.href == &quot;chrome://calendar/skin/calendar-management.css&quot;) {</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+                        this.mCachedSheet = sheet;</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+                        break;</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+                    }</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+                }</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+                if (!this.mCachedSheet) {</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+                    cal.ERROR(&quot;Could not find calendar-management.css, needs to be added to &quot; +</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+                              window.document.title + &quot;'s stylesheets&quot;);</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+                }</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+            }</span>
<a href="#l16.464"></a><span id="l16.464"> </span>
<a href="#l16.465"></a><span id="l16.465" class="difflineminus">-          return this.mCachedSheet;</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+            return this.mCachedSheet;</span>
<a href="#l16.467"></a><span id="l16.467">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.468"></a><span id="l16.468">       &lt;/property&gt;</span>
<a href="#l16.469"></a><span id="l16.469"> </span>
<a href="#l16.470"></a><span id="l16.470">       &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l16.471"></a><span id="l16.471">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineminus">-          return this.mCalendarList;</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l16.474"></a><span id="l16.474">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.475"></a><span id="l16.475">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineminus">-          this.mCalendarList = val;</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineminus">-          this.mCalendarList.forEach(this.addCalendar, this);</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineminus">-          return this.mCalendarList;</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+            this.mCalendarList = val;</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+            this.mCalendarList.forEach(this.addCalendar, this);</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l16.482"></a><span id="l16.482">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.483"></a><span id="l16.483">       &lt;/property&gt;</span>
<a href="#l16.484"></a><span id="l16.484"> </span>
<a href="#l16.485"></a><span id="l16.485">       &lt;property name=&quot;compositeCalendar&quot;&gt;</span>
<a href="#l16.486"></a><span id="l16.486">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineminus">-          if (!this.mCompositeCalendar) {</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineminus">-              this.mCompositeCalendar =</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineminus">-                  Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineminus">-                            .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineminus">-          }</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+            if (!this.mCompositeCalendar) {</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+                this.mCompositeCalendar =</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+                    Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+                              .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+            }</span>
<a href="#l16.497"></a><span id="l16.497"> </span>
<a href="#l16.498"></a><span id="l16.498" class="difflineminus">-          return this.mCompositeCalendar;</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+            return this.mCompositeCalendar;</span>
<a href="#l16.500"></a><span id="l16.500">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l16.501"></a><span id="l16.501">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineminus">-          if (this.mCompositeCalendar) {</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineminus">-              throw Components.Exception(&quot;A composite calendar has already been set&quot;,</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineminus">-                                         Components.results.NS_ERROR_ALREADY_INITIALIZED);</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineminus">-          }</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineminus">-          this.mCompositeCalendar = val;</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineminus">-          this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineminus">-          return val;</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+            if (this.mCompositeCalendar) {</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+                throw Components.Exception(&quot;A composite calendar has already been set&quot;,</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+                                           Components.results.NS_ERROR_ALREADY_INITIALIZED);</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+            }</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+            this.mCompositeCalendar = val;</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+            this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+            return val;</span>
<a href="#l16.516"></a><span id="l16.516">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l16.517"></a><span id="l16.517">       &lt;/property&gt;</span>
<a href="#l16.518"></a><span id="l16.518"> </span>
<a href="#l16.519"></a><span id="l16.519">       &lt;property name=&quot;sortOrder&quot;</span>
<a href="#l16.520"></a><span id="l16.520">                 readonly=&quot;true&quot;</span>
<a href="#l16.521"></a><span id="l16.521">                 onget=&quot;return this.mCalendarList.map(x =&gt; x.id);&quot;/&gt;</span>
<a href="#l16.522"></a><span id="l16.522">       &lt;property name=&quot;selectedCalendars&quot;</span>
<a href="#l16.523"></a><span id="l16.523">                 readonly=&quot;true&quot;</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineat">@@ -386,433 +386,433 @@</span>
<a href="#l16.525"></a><span id="l16.525">                 onset=&quot;return setBooleanAttribute(this, 'writable', val);&quot;/&gt;</span>
<a href="#l16.526"></a><span id="l16.526">       &lt;property name=&quot;ignoreDisabledState&quot;</span>
<a href="#l16.527"></a><span id="l16.527">                 onget=&quot;return (this.getAttribute('ignoredisabledstate') == 'true');&quot;</span>
<a href="#l16.528"></a><span id="l16.528">                 onset=&quot;return setBooleanAttribute(this, 'ignoredisabledstate', val);&quot;/&gt;</span>
<a href="#l16.529"></a><span id="l16.529"> </span>
<a href="#l16.530"></a><span id="l16.530">       &lt;method name=&quot;sortOrderChanged&quot;&gt;</span>
<a href="#l16.531"></a><span id="l16.531">         &lt;parameter name=&quot;&quot;/&gt;</span>
<a href="#l16.532"></a><span id="l16.532">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineminus">-          if (this.mAddingFromComposite) {</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineminus">-              return;</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-          }</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineminus">-          event.initEvent(&quot;SortOrderChanged&quot;, true, false);</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineminus">-          event.sortOrder = this.sortOrder;</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+            if (this.mAddingFromComposite) {</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineplus">+                return;</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineplus">+            }</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+            event.initEvent(&quot;SortOrderChanged&quot;, true, false);</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineplus">+            event.sortOrder = this.sortOrder;</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l16.547"></a><span id="l16.547"> </span>
<a href="#l16.548"></a><span id="l16.548" class="difflineminus">-          let handler = this.getAttribute(&quot;onSortOrderChanged&quot;);</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineminus">-          if (handler) {</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineminus">-              // Call the given code in a function</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineminus">-              let func = new Function(&quot;event&quot;, handler);</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineminus">-              func(event);</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineminus">-          }</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineplus">+            let handler = this.getAttribute(&quot;onSortOrderChanged&quot;);</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineplus">+            if (handler) {</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+                // Call the given code in a function</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineplus">+                let func = new Function(&quot;event&quot;, handler);</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+                func(event);</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+            }</span>
<a href="#l16.560"></a><span id="l16.560">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.561"></a><span id="l16.561">       &lt;/method&gt;</span>
<a href="#l16.562"></a><span id="l16.562">       &lt;method name=&quot;displayScrollbarSpacer&quot;&gt;</span>
<a href="#l16.563"></a><span id="l16.563">         &lt;parameter name=&quot;aShouldDisplay&quot;/&gt;</span>
<a href="#l16.564"></a><span id="l16.564">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-          let spacer = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbar-spacer&quot;);</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineminus">-          spacer.collapsed = !aShouldDisplay;</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+            let spacer = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;scrollbar-spacer&quot;);</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+            spacer.collapsed = !aShouldDisplay;</span>
<a href="#l16.569"></a><span id="l16.569">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.570"></a><span id="l16.570">       &lt;/method&gt;</span>
<a href="#l16.571"></a><span id="l16.571"> </span>
<a href="#l16.572"></a><span id="l16.572">       &lt;method name=&quot;ensureCalendarVisible&quot;&gt;</span>
<a href="#l16.573"></a><span id="l16.573">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l16.574"></a><span id="l16.574">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineminus">-          this.compositeCalendar.addCalendar(aCalendar);</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+            this.compositeCalendar.addCalendar(aCalendar);</span>
<a href="#l16.577"></a><span id="l16.577">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.578"></a><span id="l16.578">       &lt;/method&gt;</span>
<a href="#l16.579"></a><span id="l16.579"> </span>
<a href="#l16.580"></a><span id="l16.580">       &lt;method name=&quot;getColumn&quot;&gt;</span>
<a href="#l16.581"></a><span id="l16.581">         &lt;parameter name=&quot;aAnonId&quot;/&gt;</span>
<a href="#l16.582"></a><span id="l16.582">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineminus">-          let colElem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, aAnonId);</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineminus">-          return this.treebox.columns.getColumnFor(colElem);</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+            let colElem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, aAnonId);</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+            return this.treebox.columns.getColumnFor(colElem);</span>
<a href="#l16.587"></a><span id="l16.587">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.588"></a><span id="l16.588">       &lt;/method&gt;</span>
<a href="#l16.589"></a><span id="l16.589"> </span>
<a href="#l16.590"></a><span id="l16.590">       &lt;method name=&quot;findIndexById&quot;&gt;</span>
<a href="#l16.591"></a><span id="l16.591">         &lt;!--</span>
<a href="#l16.592"></a><span id="l16.592">           - Find the array index of the calendar with the passed id.</span>
<a href="#l16.593"></a><span id="l16.593">           -</span>
<a href="#l16.594"></a><span id="l16.594">           - @param aId           The calendar id to find an index for.</span>
<a href="#l16.595"></a><span id="l16.595">           - @return              The array index, or -1 if not found.</span>
<a href="#l16.596"></a><span id="l16.596">           --&gt;</span>
<a href="#l16.597"></a><span id="l16.597">         &lt;parameter name=&quot;aId&quot;/&gt;</span>
<a href="#l16.598"></a><span id="l16.598">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineminus">-          for (let i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineminus">-              if (this.mCalendarList[i].id == aId) {</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineminus">-                  return i;</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-              }</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineminus">-          }</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineminus">-          return -1;</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineplus">+            for (let i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineplus">+                if (this.mCalendarList[i].id == aId) {</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+                    return i;</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+                }</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+            }</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+            return -1;</span>
<a href="#l16.611"></a><span id="l16.611">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.612"></a><span id="l16.612">       &lt;/method&gt;</span>
<a href="#l16.613"></a><span id="l16.613"> </span>
<a href="#l16.614"></a><span id="l16.614">       &lt;method name=&quot;addCalendar&quot;&gt;</span>
<a href="#l16.615"></a><span id="l16.615">         &lt;!--</span>
<a href="#l16.616"></a><span id="l16.616">           - Add a calendar to the calendar list</span>
<a href="#l16.617"></a><span id="l16.617">           -</span>
<a href="#l16.618"></a><span id="l16.618">           - @param aCalendar     The calendar to add.</span>
<a href="#l16.619"></a><span id="l16.619">           --&gt;</span>
<a href="#l16.620"></a><span id="l16.620">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l16.621"></a><span id="l16.621">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l16.624"></a><span id="l16.624"> </span>
<a href="#l16.625"></a><span id="l16.625" class="difflineminus">-          let initialSortOrderPos = aCalendar.getProperty(&quot;initialSortOrderPos&quot;);</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineminus">-          if (initialSortOrderPos != null &amp;&amp; initialSortOrderPos &lt; this.mCalendarList.length) {</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineminus">-              // Insert the calendar at the requested sort order position</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineminus">-              // and then discard the property</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineminus">-              this.mCalendarList.splice(initialSortOrderPos, 0, aCalendar);</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineminus">-              aCalendar.deleteProperty(&quot;initialSortOrderPos&quot;);</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineminus">-          } else {</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineminus">-              this.mCalendarList.push(aCalendar);</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-          }</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineminus">-          this.treebox.rowCountChanged(this.mCalendarList.length - 1, 1);</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineplus">+            let initialSortOrderPos = aCalendar.getProperty(&quot;initialSortOrderPos&quot;);</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineplus">+            if (initialSortOrderPos != null &amp;&amp; initialSortOrderPos &lt; this.mCalendarList.length) {</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+                // Insert the calendar at the requested sort order position</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineplus">+                // and then discard the property</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineplus">+                this.mCalendarList.splice(initialSortOrderPos, 0, aCalendar);</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+                aCalendar.deleteProperty(&quot;initialSortOrderPos&quot;);</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+            } else {</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+                this.mCalendarList.push(aCalendar);</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineplus">+            }</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineplus">+            this.treebox.rowCountChanged(this.mCalendarList.length - 1, 1);</span>
<a href="#l16.645"></a><span id="l16.645"> </span>
<a href="#l16.646"></a><span id="l16.646" class="difflineminus">-          if (!composite.defaultCalendar ||</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineminus">-              aCalendar.id == composite.defaultCalendar.id) {</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineminus">-              this.tree.view.selection.select(this.mCalendarList.length - 1);</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineminus">-          }</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineplus">+            if (!composite.defaultCalendar ||</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineplus">+                aCalendar.id == composite.defaultCalendar.id) {</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+                this.tree.view.selection.select(this.mCalendarList.length - 1);</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+            }</span>
<a href="#l16.654"></a><span id="l16.654"> </span>
<a href="#l16.655"></a><span id="l16.655" class="difflineminus">-          this.updateCalendarColor(aCalendar);</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+            this.updateCalendarColor(aCalendar);</span>
<a href="#l16.657"></a><span id="l16.657"> </span>
<a href="#l16.658"></a><span id="l16.658" class="difflineminus">-          // TODO This should be done only once outside of this binding, but to</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineminus">-          // do that right, we need to have an easy way to register an observer</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineminus">-          // all calendar properties. This could be the calendar manager that</span>
<a href="#l16.661"></a><span id="l16.661" class="difflineminus">-          // holds an observer on every calendar anyway, which would then use the</span>
<a href="#l16.662"></a><span id="l16.662" class="difflineminus">-          // global observer service which clients can register with.</span>
<a href="#l16.663"></a><span id="l16.663" class="difflineminus">-          if (&quot;updateStyleSheetForViews&quot; in window) {</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineminus">-              updateStyleSheetForViews(aCalendar);</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineminus">-          }</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineplus">+            // TODO This should be done only once outside of this binding, but to</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineplus">+            // do that right, we need to have an easy way to register an observer</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineplus">+            // all calendar properties. This could be the calendar manager that</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineplus">+            // holds an observer on every calendar anyway, which would then use the</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineplus">+            // global observer service which clients can register with.</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+            if (&quot;updateStyleSheetForViews&quot; in window) {</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineplus">+                updateStyleSheetForViews(aCalendar);</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineplus">+            }</span>
<a href="#l16.674"></a><span id="l16.674"> </span>
<a href="#l16.675"></a><span id="l16.675" class="difflineminus">-          // Watch the calendar for changes, i.e color.</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineminus">-          aCalendar.addObserver(this.calObserver);</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+            // Watch the calendar for changes, i.e color.</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+            aCalendar.addObserver(this.calObserver);</span>
<a href="#l16.679"></a><span id="l16.679"> </span>
<a href="#l16.680"></a><span id="l16.680" class="difflineminus">-          // Adding a calendar causes the sortorder to be changed.</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineminus">-          this.sortOrderChanged();</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineplus">+            // Adding a calendar causes the sortorder to be changed.</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineplus">+            this.sortOrderChanged();</span>
<a href="#l16.684"></a><span id="l16.684"> </span>
<a href="#l16.685"></a><span id="l16.685" class="difflineminus">-          // Re-assign defaultCalendar, sometimes it is not the right one after</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineminus">-          // remove &amp; add calendar.</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineminus">-          if (composite.defaultCalendar &amp;&amp; this.tree.currentIndex &gt; -1) {</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineminus">-              let currentCal = this.getCalendar(this.tree.currentIndex);</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineminus">-              if (composite.defaultCalendar.id != currentCal.id) {</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineminus">-                  composite.defaultCalendar = currentCal;</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineminus">-              }</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineminus">-          }</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineplus">+            // Re-assign defaultCalendar, sometimes it is not the right one after</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+            // remove &amp; add calendar.</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineplus">+            if (composite.defaultCalendar &amp;&amp; this.tree.currentIndex &gt; -1) {</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineplus">+                let currentCal = this.getCalendar(this.tree.currentIndex);</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineplus">+                if (composite.defaultCalendar.id != currentCal.id) {</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineplus">+                    composite.defaultCalendar = currentCal;</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+                }</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineplus">+            }</span>
<a href="#l16.701"></a><span id="l16.701">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.702"></a><span id="l16.702">       &lt;/method&gt;</span>
<a href="#l16.703"></a><span id="l16.703"> </span>
<a href="#l16.704"></a><span id="l16.704">       &lt;method name=&quot;removeCalendar&quot;&gt;</span>
<a href="#l16.705"></a><span id="l16.705">         &lt;!--</span>
<a href="#l16.706"></a><span id="l16.706">           - Remove a calendar from the calendar list</span>
<a href="#l16.707"></a><span id="l16.707">           -</span>
<a href="#l16.708"></a><span id="l16.708">           - @param aCalendar     The calendar to remove.</span>
<a href="#l16.709"></a><span id="l16.709">           --&gt;</span>
<a href="#l16.710"></a><span id="l16.710">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l16.711"></a><span id="l16.711">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineminus">-          let index = this.findIndexById(aCalendar.id);</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineminus">-          if (index &lt; 0) {</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineminus">-              return;</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineminus">-          }</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineplus">+            let index = this.findIndexById(aCalendar.id);</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineplus">+            if (index &lt; 0) {</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineplus">+                return;</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineplus">+            }</span>
<a href="#l16.720"></a><span id="l16.720"> </span>
<a href="#l16.721"></a><span id="l16.721" class="difflineminus">-          this.mCalendarList.splice(index, 1);</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineminus">-          if (index == this.rowCount) {</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineminus">-              index--;</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineminus">-          }</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineplus">+            this.mCalendarList.splice(index, 1);</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineplus">+            if (index == this.rowCount) {</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineplus">+                index--;</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineplus">+            }</span>
<a href="#l16.729"></a><span id="l16.729"> </span>
<a href="#l16.730"></a><span id="l16.730" class="difflineminus">-          this.tree.view.selection.select(index + 1);</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineminus">-          this.treebox.rowCountChanged(index, -1);</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineplus">+            this.tree.view.selection.select(index + 1);</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+            this.treebox.rowCountChanged(index, -1);</span>
<a href="#l16.734"></a><span id="l16.734"> </span>
<a href="#l16.735"></a><span id="l16.735" class="difflineminus">-          aCalendar.removeObserver(this.calObserver);</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+            aCalendar.removeObserver(this.calObserver);</span>
<a href="#l16.737"></a><span id="l16.737"> </span>
<a href="#l16.738"></a><span id="l16.738" class="difflineminus">-          // Make sure the calendar is removed from the composite calendar</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineminus">-          this.compositeCalendar.removeCalendar(aCalendar);</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+            // Make sure the calendar is removed from the composite calendar</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+            this.compositeCalendar.removeCalendar(aCalendar);</span>
<a href="#l16.742"></a><span id="l16.742"> </span>
<a href="#l16.743"></a><span id="l16.743" class="difflineminus">-          // Remove the css style rule from the sheet.</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineminus">-          let sheet = this.sheet;</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineminus">-          for (let i = 0; i &lt; sheet.cssRules.length; i++) {</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineminus">-              if (sheet.cssRules[i] == this.ruleCache[aCalendar.id]) {</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineminus">-                  sheet.deleteRule(i);</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineminus">-                  delete this.ruleCache[aCalendar.id];</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineminus">-                  break;</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineminus">-              }</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineminus">-          }</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineplus">+            // Remove the css style rule from the sheet.</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineplus">+            let sheet = this.sheet;</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineplus">+            for (let i = 0; i &lt; sheet.cssRules.length; i++) {</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineplus">+                if (sheet.cssRules[i] == this.ruleCache[aCalendar.id]) {</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineplus">+                    sheet.deleteRule(i);</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+                    delete this.ruleCache[aCalendar.id];</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+                    break;</span>
<a href="#l16.759"></a><span id="l16.759" class="difflineplus">+                }</span>
<a href="#l16.760"></a><span id="l16.760" class="difflineplus">+            }</span>
<a href="#l16.761"></a><span id="l16.761"> </span>
<a href="#l16.762"></a><span id="l16.762" class="difflineminus">-          this.sortOrderChanged();</span>
<a href="#l16.763"></a><span id="l16.763" class="difflineplus">+            this.sortOrderChanged();</span>
<a href="#l16.764"></a><span id="l16.764">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.765"></a><span id="l16.765">       &lt;/method&gt;</span>
<a href="#l16.766"></a><span id="l16.766"> </span>
<a href="#l16.767"></a><span id="l16.767">       &lt;method name=&quot;updateCalendar&quot;&gt;</span>
<a href="#l16.768"></a><span id="l16.768">         &lt;!--</span>
<a href="#l16.769"></a><span id="l16.769">           - Update a calendar's tree row (to refresh the color and such)</span>
<a href="#l16.770"></a><span id="l16.770">           -</span>
<a href="#l16.771"></a><span id="l16.771">           - @param aCalendar     The calendar to update.</span>
<a href="#l16.772"></a><span id="l16.772">           --&gt;</span>
<a href="#l16.773"></a><span id="l16.773">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l16.774"></a><span id="l16.774">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.775"></a><span id="l16.775" class="difflineminus">-          this.treebox.invalidateRow(this.findIndexById(aCalendar.id));</span>
<a href="#l16.776"></a><span id="l16.776" class="difflineplus">+            this.treebox.invalidateRow(this.findIndexById(aCalendar.id));</span>
<a href="#l16.777"></a><span id="l16.777">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.778"></a><span id="l16.778">       &lt;/method&gt;</span>
<a href="#l16.779"></a><span id="l16.779"> </span>
<a href="#l16.780"></a><span id="l16.780">       &lt;method name=&quot;updateCalendarColor&quot;&gt;</span>
<a href="#l16.781"></a><span id="l16.781">         &lt;!--</span>
<a href="#l16.782"></a><span id="l16.782">           - Update a calendar's color rules.</span>
<a href="#l16.783"></a><span id="l16.783">           -</span>
<a href="#l16.784"></a><span id="l16.784">           - @param aCalendar     The calendar to update.</span>
<a href="#l16.785"></a><span id="l16.785">           --&gt;</span>
<a href="#l16.786"></a><span id="l16.786">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l16.787"></a><span id="l16.787">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.788"></a><span id="l16.788" class="difflineminus">-          let color = aCalendar.getProperty(&quot;color&quot;) || &quot;#a8c2e1&quot;;</span>
<a href="#l16.789"></a><span id="l16.789" class="difflineminus">-          let sheet = this.sheet;</span>
<a href="#l16.790"></a><span id="l16.790" class="difflineminus">-          if (!(aCalendar.id in this.ruleCache)) {</span>
<a href="#l16.791"></a><span id="l16.791" class="difflineminus">-              let ruleString = &quot;calendar-list-tree &gt; tree &gt; treechildren&quot; +</span>
<a href="#l16.792"></a><span id="l16.792" class="difflineminus">-                               &quot;::-moz-tree-cell(color-treecol, id-&quot; +</span>
<a href="#l16.793"></a><span id="l16.793" class="difflineminus">-                               aCalendar.id + &quot;) {}&quot;;</span>
<a href="#l16.794"></a><span id="l16.794" class="difflineplus">+            let color = aCalendar.getProperty(&quot;color&quot;) || &quot;#a8c2e1&quot;;</span>
<a href="#l16.795"></a><span id="l16.795" class="difflineplus">+            let sheet = this.sheet;</span>
<a href="#l16.796"></a><span id="l16.796" class="difflineplus">+            if (!(aCalendar.id in this.ruleCache)) {</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineplus">+                let ruleString = &quot;calendar-list-tree &gt; tree &gt; treechildren&quot; +</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineplus">+                                 &quot;::-moz-tree-cell(color-treecol, id-&quot; +</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+                                 aCalendar.id + &quot;) {}&quot;;</span>
<a href="#l16.800"></a><span id="l16.800"> </span>
<a href="#l16.801"></a><span id="l16.801" class="difflineminus">-              let ruleIndex = sheet.insertRule(ruleString, sheet.cssRules.length);</span>
<a href="#l16.802"></a><span id="l16.802" class="difflineminus">-              this.ruleCache[aCalendar.id] = sheet.cssRules[ruleIndex];</span>
<a href="#l16.803"></a><span id="l16.803" class="difflineminus">-          }</span>
<a href="#l16.804"></a><span id="l16.804" class="difflineminus">-          this.ruleCache[aCalendar.id].style.backgroundColor = color;</span>
<a href="#l16.805"></a><span id="l16.805" class="difflineplus">+                let ruleIndex = sheet.insertRule(ruleString, sheet.cssRules.length);</span>
<a href="#l16.806"></a><span id="l16.806" class="difflineplus">+                this.ruleCache[aCalendar.id] = sheet.cssRules[ruleIndex];</span>
<a href="#l16.807"></a><span id="l16.807" class="difflineplus">+            }</span>
<a href="#l16.808"></a><span id="l16.808" class="difflineplus">+            this.ruleCache[aCalendar.id].style.backgroundColor = color;</span>
<a href="#l16.809"></a><span id="l16.809">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.810"></a><span id="l16.810">       &lt;/method&gt;</span>
<a href="#l16.811"></a><span id="l16.811"> </span>
<a href="#l16.812"></a><span id="l16.812">       &lt;method name=&quot;getCalendarFromEvent&quot;&gt;</span>
<a href="#l16.813"></a><span id="l16.813">         &lt;!--</span>
<a href="#l16.814"></a><span id="l16.814">           - Get the calendar from the given DOM event. This can be a Mouse event or a</span>
<a href="#l16.815"></a><span id="l16.815">           - keyboard event.</span>
<a href="#l16.816"></a><span id="l16.816">           -</span>
<a href="#l16.817"></a><span id="l16.817">           - @param event     The DOM event to check</span>
<a href="#l16.818"></a><span id="l16.818">           - @param aCol      An out-object for the column id.</span>
<a href="#l16.819"></a><span id="l16.819">           - @param aRow      An out-object for the row index.</span>
<a href="#l16.820"></a><span id="l16.820">           --&gt;</span>
<a href="#l16.821"></a><span id="l16.821">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l16.822"></a><span id="l16.822">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.823"></a><span id="l16.823">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.824"></a><span id="l16.824">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.825"></a><span id="l16.825" class="difflineminus">-          if (event.clientX &amp;&amp; event.clientY) {</span>
<a href="#l16.826"></a><span id="l16.826" class="difflineminus">-              // If we have a client point, get the row directly from the client</span>
<a href="#l16.827"></a><span id="l16.827" class="difflineminus">-              // point.</span>
<a href="#l16.828"></a><span id="l16.828" class="difflineminus">-              aRow = aRow || {};</span>
<a href="#l16.829"></a><span id="l16.829" class="difflineminus">-              this.treebox.getCellAt(event.clientX,</span>
<a href="#l16.830"></a><span id="l16.830" class="difflineminus">-                                     event.clientY,</span>
<a href="#l16.831"></a><span id="l16.831" class="difflineminus">-                                     aRow,</span>
<a href="#l16.832"></a><span id="l16.832" class="difflineminus">-                                     aCol || {},</span>
<a href="#l16.833"></a><span id="l16.833" class="difflineminus">-                                     {});</span>
<a href="#l16.834"></a><span id="l16.834" class="difflineminus">-          } else if (document.popupNode &amp;&amp; document.popupNode.contextCalendar) {</span>
<a href="#l16.835"></a><span id="l16.835" class="difflineminus">-              // Otherwise, we can try to get the context calendar from the popupNode.</span>
<a href="#l16.836"></a><span id="l16.836" class="difflineminus">-              return document.popupNode.contextCalendar;</span>
<a href="#l16.837"></a><span id="l16.837" class="difflineminus">-          }</span>
<a href="#l16.838"></a><span id="l16.838" class="difflineminus">-          return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.mCalendarList[aRow.value];</span>
<a href="#l16.839"></a><span id="l16.839" class="difflineplus">+            if (event.clientX &amp;&amp; event.clientY) {</span>
<a href="#l16.840"></a><span id="l16.840" class="difflineplus">+                // If we have a client point, get the row directly from the client</span>
<a href="#l16.841"></a><span id="l16.841" class="difflineplus">+                // point.</span>
<a href="#l16.842"></a><span id="l16.842" class="difflineplus">+                aRow = aRow || {};</span>
<a href="#l16.843"></a><span id="l16.843" class="difflineplus">+                this.treebox.getCellAt(event.clientX,</span>
<a href="#l16.844"></a><span id="l16.844" class="difflineplus">+                                       event.clientY,</span>
<a href="#l16.845"></a><span id="l16.845" class="difflineplus">+                                       aRow,</span>
<a href="#l16.846"></a><span id="l16.846" class="difflineplus">+                                       aCol || {},</span>
<a href="#l16.847"></a><span id="l16.847" class="difflineplus">+                                       {});</span>
<a href="#l16.848"></a><span id="l16.848" class="difflineplus">+            } else if (document.popupNode &amp;&amp; document.popupNode.contextCalendar) {</span>
<a href="#l16.849"></a><span id="l16.849" class="difflineplus">+                // Otherwise, we can try to get the context calendar from the popupNode.</span>
<a href="#l16.850"></a><span id="l16.850" class="difflineplus">+                return document.popupNode.contextCalendar;</span>
<a href="#l16.851"></a><span id="l16.851" class="difflineplus">+            }</span>
<a href="#l16.852"></a><span id="l16.852" class="difflineplus">+            return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.mCalendarList[aRow.value];</span>
<a href="#l16.853"></a><span id="l16.853">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.854"></a><span id="l16.854">       &lt;/method&gt;</span>
<a href="#l16.855"></a><span id="l16.855"> </span>
<a href="#l16.856"></a><span id="l16.856">       &lt;method name=&quot;getCalendar&quot;&gt;</span>
<a href="#l16.857"></a><span id="l16.857">         &lt;!--</span>
<a href="#l16.858"></a><span id="l16.858">           - Get the calendar from a certain index.</span>
<a href="#l16.859"></a><span id="l16.859">           -</span>
<a href="#l16.860"></a><span id="l16.860">           - @param aIndex     The index to get the calendar for.</span>
<a href="#l16.861"></a><span id="l16.861">           --&gt;</span>
<a href="#l16.862"></a><span id="l16.862">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l16.863"></a><span id="l16.863">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.864"></a><span id="l16.864" class="difflineminus">-          let index = Math.max(0, Math.min(this.mCalendarList.length - 1, aIndex));</span>
<a href="#l16.865"></a><span id="l16.865" class="difflineminus">-          return this.mCalendarList[index];</span>
<a href="#l16.866"></a><span id="l16.866" class="difflineplus">+            let index = Math.max(0, Math.min(this.mCalendarList.length - 1, aIndex));</span>
<a href="#l16.867"></a><span id="l16.867" class="difflineplus">+            return this.mCalendarList[index];</span>
<a href="#l16.868"></a><span id="l16.868">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.869"></a><span id="l16.869">       &lt;/method&gt;</span>
<a href="#l16.870"></a><span id="l16.870"> </span>
<a href="#l16.871"></a><span id="l16.871">       &lt;!-- Implement nsITreeView --&gt;</span>
<a href="#l16.872"></a><span id="l16.872">       &lt;property name=&quot;rowCount&quot;</span>
<a href="#l16.873"></a><span id="l16.873">                 readonly=&quot;true&quot;</span>
<a href="#l16.874"></a><span id="l16.874">                 onget=&quot;return this.mCalendarList.length&quot;/&gt;</span>
<a href="#l16.875"></a><span id="l16.875"> </span>
<a href="#l16.876"></a><span id="l16.876">       &lt;method name=&quot;getCellProperties&quot;&gt;</span>
<a href="#l16.877"></a><span id="l16.877">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.878"></a><span id="l16.878">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.879"></a><span id="l16.879">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.880"></a><span id="l16.880" class="difflineminus">-          try {</span>
<a href="#l16.881"></a><span id="l16.881" class="difflineminus">-              let rowProps = this.getRowProperties(aRow);</span>
<a href="#l16.882"></a><span id="l16.882" class="difflineminus">-              let colProps = this.getColumnProperties(aCol);</span>
<a href="#l16.883"></a><span id="l16.883" class="difflineminus">-              return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l16.884"></a><span id="l16.884" class="difflineminus">-          } catch (e) {</span>
<a href="#l16.885"></a><span id="l16.885" class="difflineminus">-              // It seems errors in these functions are not shown, do this</span>
<a href="#l16.886"></a><span id="l16.886" class="difflineminus">-              // explicitly.</span>
<a href="#l16.887"></a><span id="l16.887" class="difflineminus">-              cal.ERROR(&quot;Error getting cell props: &quot; + e);</span>
<a href="#l16.888"></a><span id="l16.888" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l16.889"></a><span id="l16.889" class="difflineminus">-          }</span>
<a href="#l16.890"></a><span id="l16.890" class="difflineplus">+            try {</span>
<a href="#l16.891"></a><span id="l16.891" class="difflineplus">+                let rowProps = this.getRowProperties(aRow);</span>
<a href="#l16.892"></a><span id="l16.892" class="difflineplus">+                let colProps = this.getColumnProperties(aCol);</span>
<a href="#l16.893"></a><span id="l16.893" class="difflineplus">+                return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l16.894"></a><span id="l16.894" class="difflineplus">+            } catch (e) {</span>
<a href="#l16.895"></a><span id="l16.895" class="difflineplus">+                // It seems errors in these functions are not shown, do this</span>
<a href="#l16.896"></a><span id="l16.896" class="difflineplus">+                // explicitly.</span>
<a href="#l16.897"></a><span id="l16.897" class="difflineplus">+                cal.ERROR(&quot;Error getting cell props: &quot; + e);</span>
<a href="#l16.898"></a><span id="l16.898" class="difflineplus">+                return &quot;&quot;;</span>
<a href="#l16.899"></a><span id="l16.899" class="difflineplus">+            }</span>
<a href="#l16.900"></a><span id="l16.900">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.901"></a><span id="l16.901">       &lt;/method&gt;</span>
<a href="#l16.902"></a><span id="l16.902"> </span>
<a href="#l16.903"></a><span id="l16.903">       &lt;method name=&quot;getRowProperties&quot;&gt;</span>
<a href="#l16.904"></a><span id="l16.904">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.905"></a><span id="l16.905">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.906"></a><span id="l16.906" class="difflineminus">-          let properties = [];</span>
<a href="#l16.907"></a><span id="l16.907" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l16.908"></a><span id="l16.908" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l16.909"></a><span id="l16.909" class="difflineplus">+            let properties = [];</span>
<a href="#l16.910"></a><span id="l16.910" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l16.911"></a><span id="l16.911" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l16.912"></a><span id="l16.912"> </span>
<a href="#l16.913"></a><span id="l16.913" class="difflineminus">-          // Set up the composite calendar status</span>
<a href="#l16.914"></a><span id="l16.914" class="difflineminus">-          properties.push(composite.getCalendarById(calendar.id) ? &quot;checked&quot; : &quot;unchecked&quot;);</span>
<a href="#l16.915"></a><span id="l16.915" class="difflineplus">+            // Set up the composite calendar status</span>
<a href="#l16.916"></a><span id="l16.916" class="difflineplus">+            properties.push(composite.getCalendarById(calendar.id) ? &quot;checked&quot; : &quot;unchecked&quot;);</span>
<a href="#l16.917"></a><span id="l16.917"> </span>
<a href="#l16.918"></a><span id="l16.918" class="difflineminus">-          // Set up the calendar id</span>
<a href="#l16.919"></a><span id="l16.919" class="difflineminus">-          properties.push(&quot;id-&quot; + calendar.id);</span>
<a href="#l16.920"></a><span id="l16.920" class="difflineplus">+            // Set up the calendar id</span>
<a href="#l16.921"></a><span id="l16.921" class="difflineplus">+            properties.push(&quot;id-&quot; + calendar.id);</span>
<a href="#l16.922"></a><span id="l16.922"> </span>
<a href="#l16.923"></a><span id="l16.923" class="difflineminus">-          // Get the calendar color</span>
<a href="#l16.924"></a><span id="l16.924" class="difflineminus">-          let color = (calendar.getProperty(&quot;color&quot;) || &quot;&quot;).substr(1);</span>
<a href="#l16.925"></a><span id="l16.925" class="difflineplus">+            // Get the calendar color</span>
<a href="#l16.926"></a><span id="l16.926" class="difflineplus">+            let color = (calendar.getProperty(&quot;color&quot;) || &quot;&quot;).substr(1);</span>
<a href="#l16.927"></a><span id="l16.927"> </span>
<a href="#l16.928"></a><span id="l16.928" class="difflineminus">-          // Set up the calendar color (background)</span>
<a href="#l16.929"></a><span id="l16.929" class="difflineminus">-          properties.push(&quot;color-&quot; + (color || &quot;default&quot;));</span>
<a href="#l16.930"></a><span id="l16.930" class="difflineplus">+            // Set up the calendar color (background)</span>
<a href="#l16.931"></a><span id="l16.931" class="difflineplus">+            properties.push(&quot;color-&quot; + (color || &quot;default&quot;));</span>
<a href="#l16.932"></a><span id="l16.932"> </span>
<a href="#l16.933"></a><span id="l16.933" class="difflineminus">-          // Set a property to get the contrasting text color (foreground)</span>
<a href="#l16.934"></a><span id="l16.934" class="difflineminus">-          properties.push(cal.getContrastingTextColor(color || &quot;a8c2e1&quot;));</span>
<a href="#l16.935"></a><span id="l16.935" class="difflineplus">+            // Set a property to get the contrasting text color (foreground)</span>
<a href="#l16.936"></a><span id="l16.936" class="difflineplus">+            properties.push(cal.getContrastingTextColor(color || &quot;a8c2e1&quot;));</span>
<a href="#l16.937"></a><span id="l16.937"> </span>
<a href="#l16.938"></a><span id="l16.938" class="difflineminus">-          let currentStatus = calendar.getProperty(&quot;currentStatus&quot;);</span>
<a href="#l16.939"></a><span id="l16.939" class="difflineminus">-          if (!Components.isSuccessCode(currentStatus)) {</span>
<a href="#l16.940"></a><span id="l16.940" class="difflineminus">-              // 'readfailed' is supposed to &quot;win&quot; over 'readonly', meaning that</span>
<a href="#l16.941"></a><span id="l16.941" class="difflineminus">-              // if reading from a calendar fails there is no further need to also display</span>
<a href="#l16.942"></a><span id="l16.942" class="difflineminus">-              // information about 'readonly' status</span>
<a href="#l16.943"></a><span id="l16.943" class="difflineminus">-              properties.push(&quot;readfailed&quot;);</span>
<a href="#l16.944"></a><span id="l16.944" class="difflineminus">-          } else if (calendar.readOnly) {</span>
<a href="#l16.945"></a><span id="l16.945" class="difflineminus">-              properties.push(&quot;readonly&quot;);</span>
<a href="#l16.946"></a><span id="l16.946" class="difflineminus">-          }</span>
<a href="#l16.947"></a><span id="l16.947" class="difflineplus">+            let currentStatus = calendar.getProperty(&quot;currentStatus&quot;);</span>
<a href="#l16.948"></a><span id="l16.948" class="difflineplus">+            if (!Components.isSuccessCode(currentStatus)) {</span>
<a href="#l16.949"></a><span id="l16.949" class="difflineplus">+                // 'readfailed' is supposed to &quot;win&quot; over 'readonly', meaning that</span>
<a href="#l16.950"></a><span id="l16.950" class="difflineplus">+                // if reading from a calendar fails there is no further need to also display</span>
<a href="#l16.951"></a><span id="l16.951" class="difflineplus">+                // information about 'readonly' status</span>
<a href="#l16.952"></a><span id="l16.952" class="difflineplus">+                properties.push(&quot;readfailed&quot;);</span>
<a href="#l16.953"></a><span id="l16.953" class="difflineplus">+            } else if (calendar.readOnly) {</span>
<a href="#l16.954"></a><span id="l16.954" class="difflineplus">+                properties.push(&quot;readonly&quot;);</span>
<a href="#l16.955"></a><span id="l16.955" class="difflineplus">+            }</span>
<a href="#l16.956"></a><span id="l16.956"> </span>
<a href="#l16.957"></a><span id="l16.957" class="difflineminus">-          // Set up the disabled state</span>
<a href="#l16.958"></a><span id="l16.958" class="difflineminus">-          properties.push(!this.ignoreDisabledState &amp;&amp; calendar.getProperty(&quot;disabled&quot;) ?</span>
<a href="#l16.959"></a><span id="l16.959" class="difflineminus">-                          &quot;disabled&quot; : &quot;enabled&quot;);</span>
<a href="#l16.960"></a><span id="l16.960" class="difflineplus">+            // Set up the disabled state</span>
<a href="#l16.961"></a><span id="l16.961" class="difflineplus">+            properties.push(!this.ignoreDisabledState &amp;&amp; calendar.getProperty(&quot;disabled&quot;) ?</span>
<a href="#l16.962"></a><span id="l16.962" class="difflineplus">+                            &quot;disabled&quot; : &quot;enabled&quot;);</span>
<a href="#l16.963"></a><span id="l16.963"> </span>
<a href="#l16.964"></a><span id="l16.964" class="difflineminus">-          return properties.join(&quot; &quot;);</span>
<a href="#l16.965"></a><span id="l16.965" class="difflineplus">+            return properties.join(&quot; &quot;);</span>
<a href="#l16.966"></a><span id="l16.966">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.967"></a><span id="l16.967">       &lt;/method&gt;</span>
<a href="#l16.968"></a><span id="l16.968"> </span>
<a href="#l16.969"></a><span id="l16.969">       &lt;method name=&quot;getColumnProperties&quot;&gt;</span>
<a href="#l16.970"></a><span id="l16.970">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.971"></a><span id="l16.971">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.972"></a><span id="l16.972" class="difflineminus">-          // Workaround for anonymous treecols</span>
<a href="#l16.973"></a><span id="l16.973" class="difflineminus">-          return aCol.element.getAttribute(&quot;anonid&quot;);</span>
<a href="#l16.974"></a><span id="l16.974" class="difflineplus">+            // Workaround for anonymous treecols</span>
<a href="#l16.975"></a><span id="l16.975" class="difflineplus">+            return aCol.element.getAttribute(&quot;anonid&quot;);</span>
<a href="#l16.976"></a><span id="l16.976">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.977"></a><span id="l16.977">       &lt;/method&gt;</span>
<a href="#l16.978"></a><span id="l16.978"> </span>
<a href="#l16.979"></a><span id="l16.979">       &lt;method name=&quot;isContainer&quot;&gt;</span>
<a href="#l16.980"></a><span id="l16.980">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.981"></a><span id="l16.981">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.982"></a><span id="l16.982" class="difflineminus">-          return false;</span>
<a href="#l16.983"></a><span id="l16.983" class="difflineplus">+            return false;</span>
<a href="#l16.984"></a><span id="l16.984">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.985"></a><span id="l16.985">       &lt;/method&gt;</span>
<a href="#l16.986"></a><span id="l16.986"> </span>
<a href="#l16.987"></a><span id="l16.987">       &lt;method name=&quot;isContainerOpen&quot;&gt;</span>
<a href="#l16.988"></a><span id="l16.988">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.989"></a><span id="l16.989">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.990"></a><span id="l16.990" class="difflineminus">-          return false;</span>
<a href="#l16.991"></a><span id="l16.991" class="difflineplus">+            return false;</span>
<a href="#l16.992"></a><span id="l16.992">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.993"></a><span id="l16.993">       &lt;/method&gt;</span>
<a href="#l16.994"></a><span id="l16.994"> </span>
<a href="#l16.995"></a><span id="l16.995">       &lt;method name=&quot;isContainerEmpty&quot;&gt;</span>
<a href="#l16.996"></a><span id="l16.996">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.997"></a><span id="l16.997">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.998"></a><span id="l16.998" class="difflineminus">-          return false;</span>
<a href="#l16.999"></a><span id="l16.999" class="difflineplus">+            return false;</span>
<a href="#l16.1000"></a><span id="l16.1000">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1001"></a><span id="l16.1001">       &lt;/method&gt;</span>
<a href="#l16.1002"></a><span id="l16.1002"> </span>
<a href="#l16.1003"></a><span id="l16.1003">       &lt;method name=&quot;isSeparator&quot;&gt;</span>
<a href="#l16.1004"></a><span id="l16.1004">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1005"></a><span id="l16.1005">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1006"></a><span id="l16.1006" class="difflineminus">-          return false;</span>
<a href="#l16.1007"></a><span id="l16.1007" class="difflineplus">+            return false;</span>
<a href="#l16.1008"></a><span id="l16.1008">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1009"></a><span id="l16.1009">       &lt;/method&gt;</span>
<a href="#l16.1010"></a><span id="l16.1010"> </span>
<a href="#l16.1011"></a><span id="l16.1011">       &lt;method name=&quot;isSorted&quot;&gt;</span>
<a href="#l16.1012"></a><span id="l16.1012">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1013"></a><span id="l16.1013">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1014"></a><span id="l16.1014" class="difflineminus">-          return false;</span>
<a href="#l16.1015"></a><span id="l16.1015" class="difflineplus">+            return false;</span>
<a href="#l16.1016"></a><span id="l16.1016">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1017"></a><span id="l16.1017">       &lt;/method&gt;</span>
<a href="#l16.1018"></a><span id="l16.1018"> </span>
<a href="#l16.1019"></a><span id="l16.1019">       &lt;method name=&quot;onDragStart&quot;&gt;</span>
<a href="#l16.1020"></a><span id="l16.1020">         &lt;!--</span>
<a href="#l16.1021"></a><span id="l16.1021">           - Initiate a drag operation for the calendar list. Can be used in the</span>
<a href="#l16.1022"></a><span id="l16.1022">           - dragstart handler.</span>
<a href="#l16.1023"></a><span id="l16.1023">           -</span>
<a href="#l16.1024"></a><span id="l16.1024">           - @param event     The DOM event containing drag information.</span>
<a href="#l16.1025"></a><span id="l16.1025">           --&gt;</span>
<a href="#l16.1026"></a><span id="l16.1026">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l16.1027"></a><span id="l16.1027">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1028"></a><span id="l16.1028" class="difflineminus">-          let calendar = this.getCalendarFromEvent(event);</span>
<a href="#l16.1029"></a><span id="l16.1029" class="difflineminus">-          if (this.allowDrag &amp;&amp; event.dataTransfer) {</span>
<a href="#l16.1030"></a><span id="l16.1030" class="difflineminus">-              // Setting data starts a drag session, do this only if dragging</span>
<a href="#l16.1031"></a><span id="l16.1031" class="difflineminus">-              // is enabled for this binding.</span>
<a href="#l16.1032"></a><span id="l16.1032" class="difflineminus">-              event.dataTransfer.setData(&quot;application/x-moz-calendarID&quot;, calendar.id);</span>
<a href="#l16.1033"></a><span id="l16.1033" class="difflineminus">-              event.dataTransfer.effectAllowed = &quot;move&quot;;</span>
<a href="#l16.1034"></a><span id="l16.1034" class="difflineminus">-          }</span>
<a href="#l16.1035"></a><span id="l16.1035" class="difflineplus">+            let calendar = this.getCalendarFromEvent(event);</span>
<a href="#l16.1036"></a><span id="l16.1036" class="difflineplus">+            if (this.allowDrag &amp;&amp; event.dataTransfer) {</span>
<a href="#l16.1037"></a><span id="l16.1037" class="difflineplus">+                // Setting data starts a drag session, do this only if dragging</span>
<a href="#l16.1038"></a><span id="l16.1038" class="difflineplus">+                // is enabled for this binding.</span>
<a href="#l16.1039"></a><span id="l16.1039" class="difflineplus">+                event.dataTransfer.setData(&quot;application/x-moz-calendarID&quot;, calendar.id);</span>
<a href="#l16.1040"></a><span id="l16.1040" class="difflineplus">+                event.dataTransfer.effectAllowed = &quot;move&quot;;</span>
<a href="#l16.1041"></a><span id="l16.1041" class="difflineplus">+            }</span>
<a href="#l16.1042"></a><span id="l16.1042">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1043"></a><span id="l16.1043">       &lt;/method&gt;</span>
<a href="#l16.1044"></a><span id="l16.1044"> </span>
<a href="#l16.1045"></a><span id="l16.1045">       &lt;method name=&quot;canDrop&quot;&gt;</span>
<a href="#l16.1046"></a><span id="l16.1046">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1047"></a><span id="l16.1047">         &lt;parameter name=&quot;aOrientation&quot;/&gt;</span>
<a href="#l16.1048"></a><span id="l16.1048">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1049"></a><span id="l16.1049" class="difflineminus">-          let dragSession = cal.getDragService().getCurrentSession();</span>
<a href="#l16.1050"></a><span id="l16.1050" class="difflineminus">-          let dataTransfer = dragSession &amp;&amp; dragSession.dataTransfer;</span>
<a href="#l16.1051"></a><span id="l16.1051" class="difflineminus">-          if (!this.allowDrag || !dataTransfer) {</span>
<a href="#l16.1052"></a><span id="l16.1052" class="difflineminus">-              // If dragging is not allowed or there is no data transfer then</span>
<a href="#l16.1053"></a><span id="l16.1053" class="difflineminus">-              // we can't drop (i.e dropping a file on the calendar list).</span>
<a href="#l16.1054"></a><span id="l16.1054" class="difflineminus">-              return false;</span>
<a href="#l16.1055"></a><span id="l16.1055" class="difflineminus">-          }</span>
<a href="#l16.1056"></a><span id="l16.1056" class="difflineplus">+            let dragSession = cal.getDragService().getCurrentSession();</span>
<a href="#l16.1057"></a><span id="l16.1057" class="difflineplus">+            let dataTransfer = dragSession &amp;&amp; dragSession.dataTransfer;</span>
<a href="#l16.1058"></a><span id="l16.1058" class="difflineplus">+            if (!this.allowDrag || !dataTransfer) {</span>
<a href="#l16.1059"></a><span id="l16.1059" class="difflineplus">+                // If dragging is not allowed or there is no data transfer then</span>
<a href="#l16.1060"></a><span id="l16.1060" class="difflineplus">+                // we can't drop (i.e dropping a file on the calendar list).</span>
<a href="#l16.1061"></a><span id="l16.1061" class="difflineplus">+                return false;</span>
<a href="#l16.1062"></a><span id="l16.1062" class="difflineplus">+            }</span>
<a href="#l16.1063"></a><span id="l16.1063"> </span>
<a href="#l16.1064"></a><span id="l16.1064" class="difflineminus">-          let dragCalId = dataTransfer.getData(&quot;application/x-moz-calendarID&quot;);</span>
<a href="#l16.1065"></a><span id="l16.1065" class="difflineplus">+            let dragCalId = dataTransfer.getData(&quot;application/x-moz-calendarID&quot;);</span>
<a href="#l16.1066"></a><span id="l16.1066"> </span>
<a href="#l16.1067"></a><span id="l16.1067" class="difflineminus">-          return (aOrientation != Components.interfaces.nsITreeView.DROP_ON &amp;&amp;</span>
<a href="#l16.1068"></a><span id="l16.1068" class="difflineminus">-                  dragCalId != null);</span>
<a href="#l16.1069"></a><span id="l16.1069" class="difflineplus">+            return (aOrientation != Components.interfaces.nsITreeView.DROP_ON &amp;&amp;</span>
<a href="#l16.1070"></a><span id="l16.1070" class="difflineplus">+                    dragCalId != null);</span>
<a href="#l16.1071"></a><span id="l16.1071">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1072"></a><span id="l16.1072">       &lt;/method&gt;</span>
<a href="#l16.1073"></a><span id="l16.1073"> </span>
<a href="#l16.1074"></a><span id="l16.1074">       &lt;method name=&quot;drop&quot;&gt;</span>
<a href="#l16.1075"></a><span id="l16.1075">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1076"></a><span id="l16.1076">         &lt;parameter name=&quot;aOrientation&quot;/&gt;</span>
<a href="#l16.1077"></a><span id="l16.1077">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1078"></a><span id="l16.1078" class="difflineminus">-          let dragSession = cal.getDragService().getCurrentSession();</span>
<a href="#l16.1079"></a><span id="l16.1079" class="difflineminus">-          let dataTransfer = dragSession.dataTransfer;</span>
<a href="#l16.1080"></a><span id="l16.1080" class="difflineminus">-          let dragCalId = dataTransfer &amp;&amp;</span>
<a href="#l16.1081"></a><span id="l16.1081" class="difflineminus">-                          dataTransfer.getData(&quot;application/x-moz-calendarID&quot;);</span>
<a href="#l16.1082"></a><span id="l16.1082" class="difflineminus">-          if (!this.allowDrag || !dataTransfer || !dragCalId) {</span>
<a href="#l16.1083"></a><span id="l16.1083" class="difflineminus">-              return false;</span>
<a href="#l16.1084"></a><span id="l16.1084" class="difflineminus">-          }</span>
<a href="#l16.1085"></a><span id="l16.1085" class="difflineplus">+            let dragSession = cal.getDragService().getCurrentSession();</span>
<a href="#l16.1086"></a><span id="l16.1086" class="difflineplus">+            let dataTransfer = dragSession.dataTransfer;</span>
<a href="#l16.1087"></a><span id="l16.1087" class="difflineplus">+            let dragCalId = dataTransfer &amp;&amp;</span>
<a href="#l16.1088"></a><span id="l16.1088" class="difflineplus">+                            dataTransfer.getData(&quot;application/x-moz-calendarID&quot;);</span>
<a href="#l16.1089"></a><span id="l16.1089" class="difflineplus">+            if (!this.allowDrag || !dataTransfer || !dragCalId) {</span>
<a href="#l16.1090"></a><span id="l16.1090" class="difflineplus">+                return false;</span>
<a href="#l16.1091"></a><span id="l16.1091" class="difflineplus">+            }</span>
<a href="#l16.1092"></a><span id="l16.1092"> </span>
<a href="#l16.1093"></a><span id="l16.1093" class="difflineminus">-          let oldIndex = -1;</span>
<a href="#l16.1094"></a><span id="l16.1094" class="difflineminus">-          for (let i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l16.1095"></a><span id="l16.1095" class="difflineminus">-              if (this.mCalendarList[i].id == dragCalId) {</span>
<a href="#l16.1096"></a><span id="l16.1096" class="difflineminus">-                  oldIndex = i;</span>
<a href="#l16.1097"></a><span id="l16.1097" class="difflineminus">-                  break;</span>
<a href="#l16.1098"></a><span id="l16.1098" class="difflineminus">-              }</span>
<a href="#l16.1099"></a><span id="l16.1099" class="difflineminus">-          }</span>
<a href="#l16.1100"></a><span id="l16.1100" class="difflineminus">-          if (oldIndex &lt; 0) {</span>
<a href="#l16.1101"></a><span id="l16.1101" class="difflineminus">-              return false;</span>
<a href="#l16.1102"></a><span id="l16.1102" class="difflineminus">-          }</span>
<a href="#l16.1103"></a><span id="l16.1103" class="difflineplus">+            let oldIndex = -1;</span>
<a href="#l16.1104"></a><span id="l16.1104" class="difflineplus">+            for (let i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l16.1105"></a><span id="l16.1105" class="difflineplus">+                if (this.mCalendarList[i].id == dragCalId) {</span>
<a href="#l16.1106"></a><span id="l16.1106" class="difflineplus">+                    oldIndex = i;</span>
<a href="#l16.1107"></a><span id="l16.1107" class="difflineplus">+                    break;</span>
<a href="#l16.1108"></a><span id="l16.1108" class="difflineplus">+                }</span>
<a href="#l16.1109"></a><span id="l16.1109" class="difflineplus">+            }</span>
<a href="#l16.1110"></a><span id="l16.1110" class="difflineplus">+            if (oldIndex &lt; 0) {</span>
<a href="#l16.1111"></a><span id="l16.1111" class="difflineplus">+                return false;</span>
<a href="#l16.1112"></a><span id="l16.1112" class="difflineplus">+            }</span>
<a href="#l16.1113"></a><span id="l16.1113"> </span>
<a href="#l16.1114"></a><span id="l16.1114" class="difflineminus">-          // If no row is specified (-1), then assume append.</span>
<a href="#l16.1115"></a><span id="l16.1115" class="difflineminus">-          let row = (aRow &lt; 0 ? this.mCalendarList.length - 1 : aRow);</span>
<a href="#l16.1116"></a><span id="l16.1116" class="difflineminus">-          let targetIndex = row + Math.max(0, aOrientation);</span>
<a href="#l16.1117"></a><span id="l16.1117" class="difflineplus">+            // If no row is specified (-1), then assume append.</span>
<a href="#l16.1118"></a><span id="l16.1118" class="difflineplus">+            let row = (aRow &lt; 0 ? this.mCalendarList.length - 1 : aRow);</span>
<a href="#l16.1119"></a><span id="l16.1119" class="difflineplus">+            let targetIndex = row + Math.max(0, aOrientation);</span>
<a href="#l16.1120"></a><span id="l16.1120"> </span>
<a href="#l16.1121"></a><span id="l16.1121" class="difflineminus">-          // We don't need to move if the target row has the same index as the old</span>
<a href="#l16.1122"></a><span id="l16.1122" class="difflineminus">-          // row. The same goes for dropping after the row before the old row or</span>
<a href="#l16.1123"></a><span id="l16.1123" class="difflineminus">-          // before the row after the old row. Think about it :-)</span>
<a href="#l16.1124"></a><span id="l16.1124" class="difflineminus">-          if (aRow != oldIndex &amp;&amp; row + aOrientation != oldIndex) {</span>
<a href="#l16.1125"></a><span id="l16.1125" class="difflineminus">-              // Add the new one, remove the old one.</span>
<a href="#l16.1126"></a><span id="l16.1126" class="difflineminus">-              this.mCalendarList.splice(targetIndex, 0, this.mCalendarList[oldIndex]);</span>
<a href="#l16.1127"></a><span id="l16.1127" class="difflineminus">-              this.mCalendarList.splice(oldIndex + (oldIndex &gt; targetIndex ? 1 : 0), 1);</span>
<a href="#l16.1128"></a><span id="l16.1128" class="difflineplus">+            // We don't need to move if the target row has the same index as the old</span>
<a href="#l16.1129"></a><span id="l16.1129" class="difflineplus">+            // row. The same goes for dropping after the row before the old row or</span>
<a href="#l16.1130"></a><span id="l16.1130" class="difflineplus">+            // before the row after the old row. Think about it :-)</span>
<a href="#l16.1131"></a><span id="l16.1131" class="difflineplus">+            if (aRow != oldIndex &amp;&amp; row + aOrientation != oldIndex) {</span>
<a href="#l16.1132"></a><span id="l16.1132" class="difflineplus">+                // Add the new one, remove the old one.</span>
<a href="#l16.1133"></a><span id="l16.1133" class="difflineplus">+                this.mCalendarList.splice(targetIndex, 0, this.mCalendarList[oldIndex]);</span>
<a href="#l16.1134"></a><span id="l16.1134" class="difflineplus">+                this.mCalendarList.splice(oldIndex + (oldIndex &gt; targetIndex ? 1 : 0), 1);</span>
<a href="#l16.1135"></a><span id="l16.1135"> </span>
<a href="#l16.1136"></a><span id="l16.1136" class="difflineminus">-              // Invalidate the tree rows between the old item and the new one.</span>
<a href="#l16.1137"></a><span id="l16.1137" class="difflineminus">-              if (oldIndex &lt; targetIndex) {</span>
<a href="#l16.1138"></a><span id="l16.1138" class="difflineminus">-                  this.treebox.invalidateRange(oldIndex, targetIndex);</span>
<a href="#l16.1139"></a><span id="l16.1139" class="difflineminus">-              } else {</span>
<a href="#l16.1140"></a><span id="l16.1140" class="difflineminus">-                  this.treebox.invalidateRange(targetIndex, oldIndex);</span>
<a href="#l16.1141"></a><span id="l16.1141" class="difflineminus">-              }</span>
<a href="#l16.1142"></a><span id="l16.1142" class="difflineplus">+                // Invalidate the tree rows between the old item and the new one.</span>
<a href="#l16.1143"></a><span id="l16.1143" class="difflineplus">+                if (oldIndex &lt; targetIndex) {</span>
<a href="#l16.1144"></a><span id="l16.1144" class="difflineplus">+                    this.treebox.invalidateRange(oldIndex, targetIndex);</span>
<a href="#l16.1145"></a><span id="l16.1145" class="difflineplus">+                } else {</span>
<a href="#l16.1146"></a><span id="l16.1146" class="difflineplus">+                    this.treebox.invalidateRange(targetIndex, oldIndex);</span>
<a href="#l16.1147"></a><span id="l16.1147" class="difflineplus">+                }</span>
<a href="#l16.1148"></a><span id="l16.1148"> </span>
<a href="#l16.1149"></a><span id="l16.1149" class="difflineminus">-              // Fire event</span>
<a href="#l16.1150"></a><span id="l16.1150" class="difflineminus">-              this.sortOrderChanged();</span>
<a href="#l16.1151"></a><span id="l16.1151" class="difflineminus">-          }</span>
<a href="#l16.1152"></a><span id="l16.1152" class="difflineminus">-          return true;</span>
<a href="#l16.1153"></a><span id="l16.1153" class="difflineplus">+                // Fire event</span>
<a href="#l16.1154"></a><span id="l16.1154" class="difflineplus">+                this.sortOrderChanged();</span>
<a href="#l16.1155"></a><span id="l16.1155" class="difflineplus">+            }</span>
<a href="#l16.1156"></a><span id="l16.1156" class="difflineplus">+            return true;</span>
<a href="#l16.1157"></a><span id="l16.1157">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1158"></a><span id="l16.1158">       &lt;/method&gt;</span>
<a href="#l16.1159"></a><span id="l16.1159"> </span>
<a href="#l16.1160"></a><span id="l16.1160">       &lt;method name=&quot;foreignDrop&quot;&gt;</span>
<a href="#l16.1161"></a><span id="l16.1161">         &lt;!--</span>
<a href="#l16.1162"></a><span id="l16.1162">           - This function can be used by other nodes to simulate dropping on the</span>
<a href="#l16.1163"></a><span id="l16.1163">           - tree. This can be used for example on the tree header so that the row</span>
<a href="#l16.1164"></a><span id="l16.1164">           - will be inserted before the first visible row. The event client</span>
<a href="#l16.1165"></a><span id="l16.1165" class="difflineat">@@ -821,64 +821,64 @@</span>
<a href="#l16.1166"></a><span id="l16.1166">           - of treechildren).</span>
<a href="#l16.1167"></a><span id="l16.1167">           -</span>
<a href="#l16.1168"></a><span id="l16.1168">           - @param event     The DOM drop event.</span>
<a href="#l16.1169"></a><span id="l16.1169">           - @return          Boolean indicating if the drop succeeded.</span>
<a href="#l16.1170"></a><span id="l16.1170">           -</span>
<a href="#l16.1171"></a><span id="l16.1171">           --&gt;</span>
<a href="#l16.1172"></a><span id="l16.1172">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l16.1173"></a><span id="l16.1173">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1174"></a><span id="l16.1174" class="difflineminus">-          let hasDropped;</span>
<a href="#l16.1175"></a><span id="l16.1175" class="difflineminus">-          if (event.clientY &lt; this.tree.boxObject.y) {</span>
<a href="#l16.1176"></a><span id="l16.1176" class="difflineminus">-              hasDropped = this.drop(this.treebox.getFirstVisibleRow(), -1);</span>
<a href="#l16.1177"></a><span id="l16.1177" class="difflineminus">-          } else {</span>
<a href="#l16.1178"></a><span id="l16.1178" class="difflineminus">-              hasDropped = this.drop(this.treebox.getLastVisibleRow(), 1);</span>
<a href="#l16.1179"></a><span id="l16.1179" class="difflineminus">-          }</span>
<a href="#l16.1180"></a><span id="l16.1180" class="difflineminus">-          if (hasDropped) {</span>
<a href="#l16.1181"></a><span id="l16.1181" class="difflineminus">-              event.preventDefault();</span>
<a href="#l16.1182"></a><span id="l16.1182" class="difflineminus">-          }</span>
<a href="#l16.1183"></a><span id="l16.1183" class="difflineminus">-          return hasDropped;</span>
<a href="#l16.1184"></a><span id="l16.1184" class="difflineplus">+            let hasDropped;</span>
<a href="#l16.1185"></a><span id="l16.1185" class="difflineplus">+            if (event.clientY &lt; this.tree.boxObject.y) {</span>
<a href="#l16.1186"></a><span id="l16.1186" class="difflineplus">+                hasDropped = this.drop(this.treebox.getFirstVisibleRow(), -1);</span>
<a href="#l16.1187"></a><span id="l16.1187" class="difflineplus">+            } else {</span>
<a href="#l16.1188"></a><span id="l16.1188" class="difflineplus">+                hasDropped = this.drop(this.treebox.getLastVisibleRow(), 1);</span>
<a href="#l16.1189"></a><span id="l16.1189" class="difflineplus">+            }</span>
<a href="#l16.1190"></a><span id="l16.1190" class="difflineplus">+            if (hasDropped) {</span>
<a href="#l16.1191"></a><span id="l16.1191" class="difflineplus">+                event.preventDefault();</span>
<a href="#l16.1192"></a><span id="l16.1192" class="difflineplus">+            }</span>
<a href="#l16.1193"></a><span id="l16.1193" class="difflineplus">+            return hasDropped;</span>
<a href="#l16.1194"></a><span id="l16.1194">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1195"></a><span id="l16.1195">       &lt;/method&gt;</span>
<a href="#l16.1196"></a><span id="l16.1196"> </span>
<a href="#l16.1197"></a><span id="l16.1197">       &lt;method name=&quot;foreignCanDrop&quot;&gt;</span>
<a href="#l16.1198"></a><span id="l16.1198">         &lt;!--</span>
<a href="#l16.1199"></a><span id="l16.1199">           - Similar function to foreignCanDrop but for the dragenter event</span>
<a href="#l16.1200"></a><span id="l16.1200">           - @see ::foreignDrop</span>
<a href="#l16.1201"></a><span id="l16.1201">           --&gt;</span>
<a href="#l16.1202"></a><span id="l16.1202">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l16.1203"></a><span id="l16.1203">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1204"></a><span id="l16.1204" class="difflineminus">-          // The dragenter/dragover events expect false to be returned when</span>
<a href="#l16.1205"></a><span id="l16.1205" class="difflineminus">-          // dropping is allowed, therefore we return !canDrop.</span>
<a href="#l16.1206"></a><span id="l16.1206" class="difflineminus">-          if (event.clientY &lt; this.tree.boxObject.y) {</span>
<a href="#l16.1207"></a><span id="l16.1207" class="difflineminus">-              return !this.canDrop(this.treebox.getFirstVisibleRow(), -1);</span>
<a href="#l16.1208"></a><span id="l16.1208" class="difflineminus">-          } else {</span>
<a href="#l16.1209"></a><span id="l16.1209" class="difflineminus">-              return !this.canDrop(this.treebox.getLastVisibleRow(), 1);</span>
<a href="#l16.1210"></a><span id="l16.1210" class="difflineminus">-          }</span>
<a href="#l16.1211"></a><span id="l16.1211" class="difflineplus">+            // The dragenter/dragover events expect false to be returned when</span>
<a href="#l16.1212"></a><span id="l16.1212" class="difflineplus">+            // dropping is allowed, therefore we return !canDrop.</span>
<a href="#l16.1213"></a><span id="l16.1213" class="difflineplus">+            if (event.clientY &lt; this.tree.boxObject.y) {</span>
<a href="#l16.1214"></a><span id="l16.1214" class="difflineplus">+                return !this.canDrop(this.treebox.getFirstVisibleRow(), -1);</span>
<a href="#l16.1215"></a><span id="l16.1215" class="difflineplus">+            } else {</span>
<a href="#l16.1216"></a><span id="l16.1216" class="difflineplus">+                return !this.canDrop(this.treebox.getLastVisibleRow(), 1);</span>
<a href="#l16.1217"></a><span id="l16.1217" class="difflineplus">+            }</span>
<a href="#l16.1218"></a><span id="l16.1218">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1219"></a><span id="l16.1219">       &lt;/method&gt;</span>
<a href="#l16.1220"></a><span id="l16.1220"> </span>
<a href="#l16.1221"></a><span id="l16.1221">       &lt;method name=&quot;getParentIndex&quot;&gt;</span>
<a href="#l16.1222"></a><span id="l16.1222">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1223"></a><span id="l16.1223">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1224"></a><span id="l16.1224" class="difflineminus">-          return -1;</span>
<a href="#l16.1225"></a><span id="l16.1225" class="difflineplus">+            return -1;</span>
<a href="#l16.1226"></a><span id="l16.1226">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1227"></a><span id="l16.1227">       &lt;/method&gt;</span>
<a href="#l16.1228"></a><span id="l16.1228"> </span>
<a href="#l16.1229"></a><span id="l16.1229">       &lt;method name=&quot;hasNextSibling&quot;&gt;</span>
<a href="#l16.1230"></a><span id="l16.1230">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1231"></a><span id="l16.1231">         &lt;parameter name=&quot;aAfterIndex&quot;/&gt;</span>
<a href="#l16.1232"></a><span id="l16.1232">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1233"></a><span id="l16.1233">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1234"></a><span id="l16.1234">       &lt;/method&gt;</span>
<a href="#l16.1235"></a><span id="l16.1235"> </span>
<a href="#l16.1236"></a><span id="l16.1236">       &lt;method name=&quot;getLevel&quot;&gt;</span>
<a href="#l16.1237"></a><span id="l16.1237">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1238"></a><span id="l16.1238">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1239"></a><span id="l16.1239" class="difflineminus">-          return 0;</span>
<a href="#l16.1240"></a><span id="l16.1240" class="difflineplus">+            return 0;</span>
<a href="#l16.1241"></a><span id="l16.1241">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1242"></a><span id="l16.1242">       &lt;/method&gt;</span>
<a href="#l16.1243"></a><span id="l16.1243"> </span>
<a href="#l16.1244"></a><span id="l16.1244">       &lt;method name=&quot;getImageSrc&quot;&gt;</span>
<a href="#l16.1245"></a><span id="l16.1245">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1246"></a><span id="l16.1246">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1247"></a><span id="l16.1247">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1248"></a><span id="l16.1248">       &lt;/method&gt;</span>
<a href="#l16.1249"></a><span id="l16.1249" class="difflineat">@@ -889,46 +889,46 @@</span>
<a href="#l16.1250"></a><span id="l16.1250">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1251"></a><span id="l16.1251">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1252"></a><span id="l16.1252">       &lt;/method&gt;</span>
<a href="#l16.1253"></a><span id="l16.1253"> </span>
<a href="#l16.1254"></a><span id="l16.1254">       &lt;method name=&quot;getCellValue&quot;&gt;</span>
<a href="#l16.1255"></a><span id="l16.1255">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1256"></a><span id="l16.1256">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1257"></a><span id="l16.1257">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1258"></a><span id="l16.1258" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1259"></a><span id="l16.1259" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l16.1260"></a><span id="l16.1260" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1261"></a><span id="l16.1261" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l16.1262"></a><span id="l16.1262"> </span>
<a href="#l16.1263"></a><span id="l16.1263" class="difflineminus">-          switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1264"></a><span id="l16.1264" class="difflineminus">-              case &quot;checkbox-treecol&quot;:</span>
<a href="#l16.1265"></a><span id="l16.1265" class="difflineminus">-                  return composite.getCalendarById(calendar.id) ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l16.1266"></a><span id="l16.1266" class="difflineminus">-              case &quot;status-treecol&quot;:</span>
<a href="#l16.1267"></a><span id="l16.1267" class="difflineminus">-                  // The value of this cell shows the calendar readonly state</span>
<a href="#l16.1268"></a><span id="l16.1268" class="difflineminus">-                  return (calendar.readOnly ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l16.1269"></a><span id="l16.1269" class="difflineminus">-          }</span>
<a href="#l16.1270"></a><span id="l16.1270" class="difflineminus">-          return null;</span>
<a href="#l16.1271"></a><span id="l16.1271" class="difflineplus">+            switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1272"></a><span id="l16.1272" class="difflineplus">+                case &quot;checkbox-treecol&quot;:</span>
<a href="#l16.1273"></a><span id="l16.1273" class="difflineplus">+                    return composite.getCalendarById(calendar.id) ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l16.1274"></a><span id="l16.1274" class="difflineplus">+                case &quot;status-treecol&quot;:</span>
<a href="#l16.1275"></a><span id="l16.1275" class="difflineplus">+                    // The value of this cell shows the calendar readonly state</span>
<a href="#l16.1276"></a><span id="l16.1276" class="difflineplus">+                    return (calendar.readOnly ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l16.1277"></a><span id="l16.1277" class="difflineplus">+            }</span>
<a href="#l16.1278"></a><span id="l16.1278" class="difflineplus">+            return null;</span>
<a href="#l16.1279"></a><span id="l16.1279">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1280"></a><span id="l16.1280">       &lt;/method&gt;</span>
<a href="#l16.1281"></a><span id="l16.1281"> </span>
<a href="#l16.1282"></a><span id="l16.1282">       &lt;method name=&quot;getCellText&quot;&gt;</span>
<a href="#l16.1283"></a><span id="l16.1283">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1284"></a><span id="l16.1284">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1285"></a><span id="l16.1285">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1286"></a><span id="l16.1286" class="difflineminus">-          switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1287"></a><span id="l16.1287" class="difflineminus">-              case &quot;calendarname-treecol&quot;:</span>
<a href="#l16.1288"></a><span id="l16.1288" class="difflineminus">-                  return this.getCalendar(aRow).name;</span>
<a href="#l16.1289"></a><span id="l16.1289" class="difflineminus">-          }</span>
<a href="#l16.1290"></a><span id="l16.1290" class="difflineminus">-          return &quot;&quot;;</span>
<a href="#l16.1291"></a><span id="l16.1291" class="difflineplus">+            switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1292"></a><span id="l16.1292" class="difflineplus">+                case &quot;calendarname-treecol&quot;:</span>
<a href="#l16.1293"></a><span id="l16.1293" class="difflineplus">+                    return this.getCalendar(aRow).name;</span>
<a href="#l16.1294"></a><span id="l16.1294" class="difflineplus">+            }</span>
<a href="#l16.1295"></a><span id="l16.1295" class="difflineplus">+            return &quot;&quot;;</span>
<a href="#l16.1296"></a><span id="l16.1296">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1297"></a><span id="l16.1297">       &lt;/method&gt;</span>
<a href="#l16.1298"></a><span id="l16.1298"> </span>
<a href="#l16.1299"></a><span id="l16.1299">       &lt;method name=&quot;setTree&quot;&gt;</span>
<a href="#l16.1300"></a><span id="l16.1300">         &lt;parameter name=&quot;aTreeBox&quot;/&gt;</span>
<a href="#l16.1301"></a><span id="l16.1301">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1302"></a><span id="l16.1302" class="difflineminus">-          this.treebox = aTreeBox;</span>
<a href="#l16.1303"></a><span id="l16.1303" class="difflineplus">+            this.treebox = aTreeBox;</span>
<a href="#l16.1304"></a><span id="l16.1304">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1305"></a><span id="l16.1305">       &lt;/method&gt;</span>
<a href="#l16.1306"></a><span id="l16.1306"> </span>
<a href="#l16.1307"></a><span id="l16.1307">       &lt;method name=&quot;toggleOpenState&quot;&gt;</span>
<a href="#l16.1308"></a><span id="l16.1308">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1309"></a><span id="l16.1309">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1310"></a><span id="l16.1310">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1311"></a><span id="l16.1311">       &lt;/method&gt;</span>
<a href="#l16.1312"></a><span id="l16.1312" class="difflineat">@@ -938,78 +938,78 @@</span>
<a href="#l16.1313"></a><span id="l16.1313">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1314"></a><span id="l16.1314">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1315"></a><span id="l16.1315">       &lt;/method&gt;</span>
<a href="#l16.1316"></a><span id="l16.1316"> </span>
<a href="#l16.1317"></a><span id="l16.1317">       &lt;method name=&quot;cycleCell&quot;&gt;</span>
<a href="#l16.1318"></a><span id="l16.1318">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1319"></a><span id="l16.1319">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1320"></a><span id="l16.1320">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1321"></a><span id="l16.1321" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1322"></a><span id="l16.1322" class="difflineminus">-          if (this.mCycleCalendarFlag[calendar.id]) {</span>
<a href="#l16.1323"></a><span id="l16.1323" class="difflineminus">-              delete this.mCycleCalendarFlag[calendar.id];</span>
<a href="#l16.1324"></a><span id="l16.1324" class="difflineminus">-          } else {</span>
<a href="#l16.1325"></a><span id="l16.1325" class="difflineminus">-              this.mCycleCalendarFlag[calendar.id] = calendar;</span>
<a href="#l16.1326"></a><span id="l16.1326" class="difflineminus">-          }</span>
<a href="#l16.1327"></a><span id="l16.1327" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1328"></a><span id="l16.1328" class="difflineplus">+            if (this.mCycleCalendarFlag[calendar.id]) {</span>
<a href="#l16.1329"></a><span id="l16.1329" class="difflineplus">+                delete this.mCycleCalendarFlag[calendar.id];</span>
<a href="#l16.1330"></a><span id="l16.1330" class="difflineplus">+            } else {</span>
<a href="#l16.1331"></a><span id="l16.1331" class="difflineplus">+                this.mCycleCalendarFlag[calendar.id] = calendar;</span>
<a href="#l16.1332"></a><span id="l16.1332" class="difflineplus">+            }</span>
<a href="#l16.1333"></a><span id="l16.1333"> </span>
<a href="#l16.1334"></a><span id="l16.1334" class="difflineminus">-          if (this.mCycleTimer) {</span>
<a href="#l16.1335"></a><span id="l16.1335" class="difflineminus">-              clearTimeout(this.mCycleTimer);</span>
<a href="#l16.1336"></a><span id="l16.1336" class="difflineminus">-          }</span>
<a href="#l16.1337"></a><span id="l16.1337" class="difflineminus">-          this.treebox.invalidateRow(aRow);</span>
<a href="#l16.1338"></a><span id="l16.1338" class="difflineminus">-          this.mCycleTimer = setTimeout(this.cycleCellCommit.bind(this), 200);</span>
<a href="#l16.1339"></a><span id="l16.1339" class="difflineplus">+            if (this.mCycleTimer) {</span>
<a href="#l16.1340"></a><span id="l16.1340" class="difflineplus">+                clearTimeout(this.mCycleTimer);</span>
<a href="#l16.1341"></a><span id="l16.1341" class="difflineplus">+            }</span>
<a href="#l16.1342"></a><span id="l16.1342" class="difflineplus">+            this.treebox.invalidateRow(aRow);</span>
<a href="#l16.1343"></a><span id="l16.1343" class="difflineplus">+            this.mCycleTimer = setTimeout(this.cycleCellCommit.bind(this), 200);</span>
<a href="#l16.1344"></a><span id="l16.1344">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1345"></a><span id="l16.1345">       &lt;/method&gt;</span>
<a href="#l16.1346"></a><span id="l16.1346"> </span>
<a href="#l16.1347"></a><span id="l16.1347">       &lt;method name=&quot;cycleCellCommit&quot;&gt;</span>
<a href="#l16.1348"></a><span id="l16.1348">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1349"></a><span id="l16.1349" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l16.1350"></a><span id="l16.1350" class="difflineminus">-          try {</span>
<a href="#l16.1351"></a><span id="l16.1351" class="difflineminus">-              composite.startBatch();</span>
<a href="#l16.1352"></a><span id="l16.1352" class="difflineminus">-              for (let id in this.mCycleCalendarFlag) {</span>
<a href="#l16.1353"></a><span id="l16.1353" class="difflineminus">-                  if (composite.getCalendarById(id)) {</span>
<a href="#l16.1354"></a><span id="l16.1354" class="difflineminus">-                      composite.removeCalendar(this.mCycleCalendarFlag[id]);</span>
<a href="#l16.1355"></a><span id="l16.1355" class="difflineminus">-                  } else {</span>
<a href="#l16.1356"></a><span id="l16.1356" class="difflineminus">-                      composite.addCalendar(this.mCycleCalendarFlag[id]);</span>
<a href="#l16.1357"></a><span id="l16.1357" class="difflineminus">-                  }</span>
<a href="#l16.1358"></a><span id="l16.1358" class="difflineminus">-                  delete this.mCycleCalendarFlag[id];</span>
<a href="#l16.1359"></a><span id="l16.1359" class="difflineminus">-              }</span>
<a href="#l16.1360"></a><span id="l16.1360" class="difflineminus">-          } finally {</span>
<a href="#l16.1361"></a><span id="l16.1361" class="difflineminus">-              composite.endBatch();</span>
<a href="#l16.1362"></a><span id="l16.1362" class="difflineminus">-          }</span>
<a href="#l16.1363"></a><span id="l16.1363" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l16.1364"></a><span id="l16.1364" class="difflineplus">+            try {</span>
<a href="#l16.1365"></a><span id="l16.1365" class="difflineplus">+                composite.startBatch();</span>
<a href="#l16.1366"></a><span id="l16.1366" class="difflineplus">+                for (let id in this.mCycleCalendarFlag) {</span>
<a href="#l16.1367"></a><span id="l16.1367" class="difflineplus">+                    if (composite.getCalendarById(id)) {</span>
<a href="#l16.1368"></a><span id="l16.1368" class="difflineplus">+                        composite.removeCalendar(this.mCycleCalendarFlag[id]);</span>
<a href="#l16.1369"></a><span id="l16.1369" class="difflineplus">+                    } else {</span>
<a href="#l16.1370"></a><span id="l16.1370" class="difflineplus">+                        composite.addCalendar(this.mCycleCalendarFlag[id]);</span>
<a href="#l16.1371"></a><span id="l16.1371" class="difflineplus">+                    }</span>
<a href="#l16.1372"></a><span id="l16.1372" class="difflineplus">+                    delete this.mCycleCalendarFlag[id];</span>
<a href="#l16.1373"></a><span id="l16.1373" class="difflineplus">+                }</span>
<a href="#l16.1374"></a><span id="l16.1374" class="difflineplus">+            } finally {</span>
<a href="#l16.1375"></a><span id="l16.1375" class="difflineplus">+                composite.endBatch();</span>
<a href="#l16.1376"></a><span id="l16.1376" class="difflineplus">+            }</span>
<a href="#l16.1377"></a><span id="l16.1377">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1378"></a><span id="l16.1378">       &lt;/method&gt;</span>
<a href="#l16.1379"></a><span id="l16.1379"> </span>
<a href="#l16.1380"></a><span id="l16.1380">       &lt;method name=&quot;isEditable&quot;&gt;</span>
<a href="#l16.1381"></a><span id="l16.1381">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1382"></a><span id="l16.1382">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1383"></a><span id="l16.1383">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1384"></a><span id="l16.1384" class="difflineminus">-          return false;</span>
<a href="#l16.1385"></a><span id="l16.1385" class="difflineplus">+            return false;</span>
<a href="#l16.1386"></a><span id="l16.1386">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1387"></a><span id="l16.1387">       &lt;/method&gt;</span>
<a href="#l16.1388"></a><span id="l16.1388"> </span>
<a href="#l16.1389"></a><span id="l16.1389">       &lt;method name=&quot;setCellValue&quot;&gt;</span>
<a href="#l16.1390"></a><span id="l16.1390">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1391"></a><span id="l16.1391">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1392"></a><span id="l16.1392">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l16.1393"></a><span id="l16.1393">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1394"></a><span id="l16.1394" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1395"></a><span id="l16.1395" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l16.1396"></a><span id="l16.1396" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l16.1397"></a><span id="l16.1397" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l16.1398"></a><span id="l16.1398"> </span>
<a href="#l16.1399"></a><span id="l16.1399" class="difflineminus">-          switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1400"></a><span id="l16.1400" class="difflineminus">-              case &quot;checkbox-treecol&quot;:</span>
<a href="#l16.1401"></a><span id="l16.1401" class="difflineminus">-                  if (aValue == &quot;true&quot;) {</span>
<a href="#l16.1402"></a><span id="l16.1402" class="difflineminus">-                      composite.addCalendar(calendar);</span>
<a href="#l16.1403"></a><span id="l16.1403" class="difflineminus">-                  } else {</span>
<a href="#l16.1404"></a><span id="l16.1404" class="difflineminus">-                      composite.removeCalendar(calendar);</span>
<a href="#l16.1405"></a><span id="l16.1405" class="difflineminus">-                  }</span>
<a href="#l16.1406"></a><span id="l16.1406" class="difflineminus">-                  break;</span>
<a href="#l16.1407"></a><span id="l16.1407" class="difflineminus">-              default:</span>
<a href="#l16.1408"></a><span id="l16.1408" class="difflineminus">-                  return null;</span>
<a href="#l16.1409"></a><span id="l16.1409" class="difflineminus">-          }</span>
<a href="#l16.1410"></a><span id="l16.1410" class="difflineminus">-          return aValue;</span>
<a href="#l16.1411"></a><span id="l16.1411" class="difflineplus">+            switch (aCol.element.getAttribute(&quot;anonid&quot;)) {</span>
<a href="#l16.1412"></a><span id="l16.1412" class="difflineplus">+                case &quot;checkbox-treecol&quot;:</span>
<a href="#l16.1413"></a><span id="l16.1413" class="difflineplus">+                    if (aValue == &quot;true&quot;) {</span>
<a href="#l16.1414"></a><span id="l16.1414" class="difflineplus">+                        composite.addCalendar(calendar);</span>
<a href="#l16.1415"></a><span id="l16.1415" class="difflineplus">+                    } else {</span>
<a href="#l16.1416"></a><span id="l16.1416" class="difflineplus">+                        composite.removeCalendar(calendar);</span>
<a href="#l16.1417"></a><span id="l16.1417" class="difflineplus">+                    }</span>
<a href="#l16.1418"></a><span id="l16.1418" class="difflineplus">+                    break;</span>
<a href="#l16.1419"></a><span id="l16.1419" class="difflineplus">+                default:</span>
<a href="#l16.1420"></a><span id="l16.1420" class="difflineplus">+                    return null;</span>
<a href="#l16.1421"></a><span id="l16.1421" class="difflineplus">+            }</span>
<a href="#l16.1422"></a><span id="l16.1422" class="difflineplus">+            return aValue;</span>
<a href="#l16.1423"></a><span id="l16.1423">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1424"></a><span id="l16.1424">       &lt;/method&gt;</span>
<a href="#l16.1425"></a><span id="l16.1425"> </span>
<a href="#l16.1426"></a><span id="l16.1426">       &lt;method name=&quot;setCellText&quot;&gt;</span>
<a href="#l16.1427"></a><span id="l16.1427">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1428"></a><span id="l16.1428">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1429"></a><span id="l16.1429">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l16.1430"></a><span id="l16.1430">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1431"></a><span id="l16.1431" class="difflineat">@@ -1034,79 +1034,79 @@</span>
<a href="#l16.1432"></a><span id="l16.1432">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l16.1433"></a><span id="l16.1433">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l16.1434"></a><span id="l16.1434">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l16.1435"></a><span id="l16.1435">         ]]&gt;&lt;/body&gt;</span>
<a href="#l16.1436"></a><span id="l16.1436">       &lt;/method&gt;</span>
<a href="#l16.1437"></a><span id="l16.1437">     &lt;/implementation&gt;</span>
<a href="#l16.1438"></a><span id="l16.1438">     &lt;handlers&gt;</span>
<a href="#l16.1439"></a><span id="l16.1439">       &lt;handler event=&quot;select&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.1440"></a><span id="l16.1440" class="difflineminus">-        this.compositeCalendar.defaultCalendar = this.getCalendar(this.tree.currentIndex);</span>
<a href="#l16.1441"></a><span id="l16.1441" class="difflineplus">+          this.compositeCalendar.defaultCalendar = this.getCalendar(this.tree.currentIndex);</span>
<a href="#l16.1442"></a><span id="l16.1442">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.1443"></a><span id="l16.1443"> </span>
<a href="#l16.1444"></a><span id="l16.1444">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DELETE&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.1445"></a><span id="l16.1445" class="difflineminus">-        if (this.writable) {</span>
<a href="#l16.1446"></a><span id="l16.1446" class="difflineminus">-            promptDeleteCalendar(this.compositeCalendar.defaultCalendar);</span>
<a href="#l16.1447"></a><span id="l16.1447" class="difflineminus">-            event.preventDefault();</span>
<a href="#l16.1448"></a><span id="l16.1448" class="difflineminus">-        }</span>
<a href="#l16.1449"></a><span id="l16.1449" class="difflineplus">+          if (this.writable) {</span>
<a href="#l16.1450"></a><span id="l16.1450" class="difflineplus">+              promptDeleteCalendar(this.compositeCalendar.defaultCalendar);</span>
<a href="#l16.1451"></a><span id="l16.1451" class="difflineplus">+              event.preventDefault();</span>
<a href="#l16.1452"></a><span id="l16.1452" class="difflineplus">+          }</span>
<a href="#l16.1453"></a><span id="l16.1453">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.1454"></a><span id="l16.1454"> </span>
<a href="#l16.1455"></a><span id="l16.1455">       &lt;!-- use key=&quot; &quot; since keycode=&quot;VK_SPACE&quot; doesn't work --&gt;</span>
<a href="#l16.1456"></a><span id="l16.1456">       &lt;handler event=&quot;keypress&quot; key=&quot; &quot;&gt;&lt;![CDATA[</span>
<a href="#l16.1457"></a><span id="l16.1457" class="difflineminus">-        if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l16.1458"></a><span id="l16.1458" class="difflineminus">-            this.cycleCell(this.tree.currentIndex, this.getColumn(&quot;checkbox-treecol&quot;));</span>
<a href="#l16.1459"></a><span id="l16.1459" class="difflineminus">-            event.preventDefault();</span>
<a href="#l16.1460"></a><span id="l16.1460" class="difflineminus">-        }</span>
<a href="#l16.1461"></a><span id="l16.1461" class="difflineplus">+          if (this.tree.currentIndex &gt; -1) {</span>
<a href="#l16.1462"></a><span id="l16.1462" class="difflineplus">+              this.cycleCell(this.tree.currentIndex, this.getColumn(&quot;checkbox-treecol&quot;));</span>
<a href="#l16.1463"></a><span id="l16.1463" class="difflineplus">+              event.preventDefault();</span>
<a href="#l16.1464"></a><span id="l16.1464" class="difflineplus">+          }</span>
<a href="#l16.1465"></a><span id="l16.1465">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.1466"></a><span id="l16.1466"> </span>
<a href="#l16.1467"></a><span id="l16.1467">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;control&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.1468"></a><span id="l16.1468" class="difflineminus">-        if (!this.allowDrag) {</span>
<a href="#l16.1469"></a><span id="l16.1469" class="difflineminus">-            return;</span>
<a href="#l16.1470"></a><span id="l16.1470" class="difflineminus">-        }</span>
<a href="#l16.1471"></a><span id="l16.1471" class="difflineplus">+          if (!this.allowDrag) {</span>
<a href="#l16.1472"></a><span id="l16.1472" class="difflineplus">+              return;</span>
<a href="#l16.1473"></a><span id="l16.1473" class="difflineplus">+          }</span>
<a href="#l16.1474"></a><span id="l16.1474"> </span>
<a href="#l16.1475"></a><span id="l16.1475" class="difflineminus">-        let idx = this.tree.currentIndex;</span>
<a href="#l16.1476"></a><span id="l16.1476" class="difflineplus">+          let idx = this.tree.currentIndex;</span>
<a href="#l16.1477"></a><span id="l16.1477"> </span>
<a href="#l16.1478"></a><span id="l16.1478" class="difflineminus">-        if (idx &lt; this.mCalendarList.length - 1) {</span>
<a href="#l16.1479"></a><span id="l16.1479" class="difflineminus">-            this.mCalendarList.splice(idx + 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l16.1480"></a><span id="l16.1480" class="difflineminus">-            this.treebox.invalidateRange(idx, idx + 1);</span>
<a href="#l16.1481"></a><span id="l16.1481" class="difflineplus">+          if (idx &lt; this.mCalendarList.length - 1) {</span>
<a href="#l16.1482"></a><span id="l16.1482" class="difflineplus">+              this.mCalendarList.splice(idx + 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l16.1483"></a><span id="l16.1483" class="difflineplus">+              this.treebox.invalidateRange(idx, idx + 1);</span>
<a href="#l16.1484"></a><span id="l16.1484"> </span>
<a href="#l16.1485"></a><span id="l16.1485" class="difflineminus">-            if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l16.1486"></a><span id="l16.1486" class="difflineminus">-                this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l16.1487"></a><span id="l16.1487" class="difflineminus">-                this.tree.view.selection.toggleSelect(idx + 1);</span>
<a href="#l16.1488"></a><span id="l16.1488" class="difflineminus">-            }</span>
<a href="#l16.1489"></a><span id="l16.1489" class="difflineminus">-            if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l16.1490"></a><span id="l16.1490" class="difflineminus">-                this.tree.view.selection.currentIndex = idx + 1;</span>
<a href="#l16.1491"></a><span id="l16.1491" class="difflineminus">-            }</span>
<a href="#l16.1492"></a><span id="l16.1492" class="difflineplus">+              if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l16.1493"></a><span id="l16.1493" class="difflineplus">+                  this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l16.1494"></a><span id="l16.1494" class="difflineplus">+                  this.tree.view.selection.toggleSelect(idx + 1);</span>
<a href="#l16.1495"></a><span id="l16.1495" class="difflineplus">+              }</span>
<a href="#l16.1496"></a><span id="l16.1496" class="difflineplus">+              if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l16.1497"></a><span id="l16.1497" class="difflineplus">+                  this.tree.view.selection.currentIndex = idx + 1;</span>
<a href="#l16.1498"></a><span id="l16.1498" class="difflineplus">+              }</span>
<a href="#l16.1499"></a><span id="l16.1499"> </span>
<a href="#l16.1500"></a><span id="l16.1500" class="difflineminus">-            // Fire event</span>
<a href="#l16.1501"></a><span id="l16.1501" class="difflineminus">-            this.sortOrderChanged();</span>
<a href="#l16.1502"></a><span id="l16.1502" class="difflineminus">-        }</span>
<a href="#l16.1503"></a><span id="l16.1503" class="difflineminus">-        // Don't call the default &lt;key&gt; handler.</span>
<a href="#l16.1504"></a><span id="l16.1504" class="difflineminus">-        event.preventDefault();</span>
<a href="#l16.1505"></a><span id="l16.1505" class="difflineplus">+              // Fire event</span>
<a href="#l16.1506"></a><span id="l16.1506" class="difflineplus">+              this.sortOrderChanged();</span>
<a href="#l16.1507"></a><span id="l16.1507" class="difflineplus">+          }</span>
<a href="#l16.1508"></a><span id="l16.1508" class="difflineplus">+          // Don't call the default &lt;key&gt; handler.</span>
<a href="#l16.1509"></a><span id="l16.1509" class="difflineplus">+          event.preventDefault();</span>
<a href="#l16.1510"></a><span id="l16.1510">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.1511"></a><span id="l16.1511"> </span>
<a href="#l16.1512"></a><span id="l16.1512">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control&quot;&gt;&lt;![CDATA[</span>
<a href="#l16.1513"></a><span id="l16.1513" class="difflineminus">-        if (!this.allowDrag) {</span>
<a href="#l16.1514"></a><span id="l16.1514" class="difflineminus">-            return;</span>
<a href="#l16.1515"></a><span id="l16.1515" class="difflineminus">-        }</span>
<a href="#l16.1516"></a><span id="l16.1516" class="difflineplus">+          if (!this.allowDrag) {</span>
<a href="#l16.1517"></a><span id="l16.1517" class="difflineplus">+              return;</span>
<a href="#l16.1518"></a><span id="l16.1518" class="difflineplus">+          }</span>
<a href="#l16.1519"></a><span id="l16.1519"> </span>
<a href="#l16.1520"></a><span id="l16.1520" class="difflineminus">-        let idx = this.tree.currentIndex;</span>
<a href="#l16.1521"></a><span id="l16.1521" class="difflineminus">-        if (idx &gt; 0) {</span>
<a href="#l16.1522"></a><span id="l16.1522" class="difflineminus">-            this.mCalendarList.splice(idx - 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l16.1523"></a><span id="l16.1523" class="difflineminus">-            this.treebox.invalidateRange(idx - 1, idx);</span>
<a href="#l16.1524"></a><span id="l16.1524" class="difflineplus">+          let idx = this.tree.currentIndex;</span>
<a href="#l16.1525"></a><span id="l16.1525" class="difflineplus">+          if (idx &gt; 0) {</span>
<a href="#l16.1526"></a><span id="l16.1526" class="difflineplus">+              this.mCalendarList.splice(idx - 1, 0, this.mCalendarList.splice(idx, 1)[0]);</span>
<a href="#l16.1527"></a><span id="l16.1527" class="difflineplus">+              this.treebox.invalidateRange(idx - 1, idx);</span>
<a href="#l16.1528"></a><span id="l16.1528"> </span>
<a href="#l16.1529"></a><span id="l16.1529" class="difflineminus">-            if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l16.1530"></a><span id="l16.1530" class="difflineminus">-                this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l16.1531"></a><span id="l16.1531" class="difflineminus">-                this.tree.view.selection.toggleSelect(idx - 1);</span>
<a href="#l16.1532"></a><span id="l16.1532" class="difflineminus">-            }</span>
<a href="#l16.1533"></a><span id="l16.1533" class="difflineminus">-            if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l16.1534"></a><span id="l16.1534" class="difflineminus">-                this.tree.view.selection.currentIndex = idx - 1;</span>
<a href="#l16.1535"></a><span id="l16.1535" class="difflineminus">-            }</span>
<a href="#l16.1536"></a><span id="l16.1536" class="difflineplus">+              if (this.tree.view.selection.isSelected(idx)) {</span>
<a href="#l16.1537"></a><span id="l16.1537" class="difflineplus">+                  this.tree.view.selection.toggleSelect(idx);</span>
<a href="#l16.1538"></a><span id="l16.1538" class="difflineplus">+                  this.tree.view.selection.toggleSelect(idx - 1);</span>
<a href="#l16.1539"></a><span id="l16.1539" class="difflineplus">+              }</span>
<a href="#l16.1540"></a><span id="l16.1540" class="difflineplus">+              if (this.tree.view.selection.currentIndex == idx) {</span>
<a href="#l16.1541"></a><span id="l16.1541" class="difflineplus">+                  this.tree.view.selection.currentIndex = idx - 1;</span>
<a href="#l16.1542"></a><span id="l16.1542" class="difflineplus">+              }</span>
<a href="#l16.1543"></a><span id="l16.1543"> </span>
<a href="#l16.1544"></a><span id="l16.1544" class="difflineminus">-            // Fire event</span>
<a href="#l16.1545"></a><span id="l16.1545" class="difflineminus">-            this.sortOrderChanged();</span>
<a href="#l16.1546"></a><span id="l16.1546" class="difflineminus">-        }</span>
<a href="#l16.1547"></a><span id="l16.1547" class="difflineminus">-        // Don't call the default &lt;key&gt; handler.</span>
<a href="#l16.1548"></a><span id="l16.1548" class="difflineminus">-        event.preventDefault();</span>
<a href="#l16.1549"></a><span id="l16.1549" class="difflineplus">+              // Fire event</span>
<a href="#l16.1550"></a><span id="l16.1550" class="difflineplus">+              this.sortOrderChanged();</span>
<a href="#l16.1551"></a><span id="l16.1551" class="difflineplus">+          }</span>
<a href="#l16.1552"></a><span id="l16.1552" class="difflineplus">+          // Don't call the default &lt;key&gt; handler.</span>
<a href="#l16.1553"></a><span id="l16.1553" class="difflineplus">+          event.preventDefault();</span>
<a href="#l16.1554"></a><span id="l16.1554">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l16.1555"></a><span id="l16.1555">     &lt;/handlers&gt;</span>
<a href="#l16.1556"></a><span id="l16.1556">   &lt;/binding&gt;</span>
<a href="#l16.1557"></a><span id="l16.1557"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-subscriptions-list.xml</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-subscriptions-list.xml</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -14,29 +14,29 @@</span>
<a href="#l17.4"></a><span id="l17.4">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistbox&quot;</span>
<a href="#l17.5"></a><span id="l17.5">            xbl:inherits=&quot;flex&quot;&gt;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">     &lt;implementation&gt;</span>
<a href="#l17.8"></a><span id="l17.8">       &lt;method name=&quot;addCalendar&quot;&gt;</span>
<a href="#l17.9"></a><span id="l17.9">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l17.10"></a><span id="l17.10">         &lt;parameter name=&quot;bSubscribed&quot;/&gt;</span>
<a href="#l17.11"></a><span id="l17.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-          let newNode = createXULElement(&quot;calendar-subscriptions-richlistitem&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-          this.appendChild(newNode);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-          newNode.setAttribute(&quot;anonid&quot;, &quot;subscriptions-listitem&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-          newNode.calendar = aCalendar;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-          newNode.subscribed = bSubscribed;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+            let newNode = createXULElement(&quot;calendar-subscriptions-richlistitem&quot;);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+            this.appendChild(newNode);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+            newNode.setAttribute(&quot;anonid&quot;, &quot;subscriptions-listitem&quot;);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+            newNode.calendar = aCalendar;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+            newNode.subscribed = bSubscribed;</span>
<a href="#l17.22"></a><span id="l17.22">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.23"></a><span id="l17.23">       &lt;/method&gt;</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">       &lt;method name=&quot;clear&quot;&gt;</span>
<a href="#l17.26"></a><span id="l17.26">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-          while (this.hasChildNodes()) {</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-              this.lastChild.remove();</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-          }</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+            while (this.hasChildNodes()) {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                this.lastChild.remove();</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+            }</span>
<a href="#l17.33"></a><span id="l17.33">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.34"></a><span id="l17.34">       &lt;/method&gt;</span>
<a href="#l17.35"></a><span id="l17.35">     &lt;/implementation&gt;</span>
<a href="#l17.36"></a><span id="l17.36">   &lt;/binding&gt;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   &lt;binding id=&quot;calendar-subscriptions-richlistitem&quot;</span>
<a href="#l17.39"></a><span id="l17.39">            extends=&quot;chrome://global/content/bindings/richlistbox.xml#richlistitem&quot;&gt;</span>
<a href="#l17.40"></a><span id="l17.40">     &lt;content&gt;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineat">@@ -47,83 +47,83 @@</span>
<a href="#l17.42"></a><span id="l17.42">     &lt;/content&gt;</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44">     &lt;implementation&gt;</span>
<a href="#l17.45"></a><span id="l17.45">       &lt;field name=&quot;mCalendar&quot;&gt;null&lt;/field&gt;</span>
<a href="#l17.46"></a><span id="l17.46">       &lt;field name=&quot;mSubscribed&quot;&gt;false&lt;/field&gt;</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">       &lt;property name=&quot;calendar&quot;&gt;</span>
<a href="#l17.49"></a><span id="l17.49">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-          return this.mCalendar;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+            return this.mCalendar;</span>
<a href="#l17.52"></a><span id="l17.52">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l17.53"></a><span id="l17.53">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-          this.setCalendar(val);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-          return val;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+            this.setCalendar(val);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+            return val;</span>
<a href="#l17.58"></a><span id="l17.58">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l17.59"></a><span id="l17.59">       &lt;/property&gt;</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61">       &lt;property name=&quot;subscribed&quot;&gt;</span>
<a href="#l17.62"></a><span id="l17.62">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-          return this.mSubscribed;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+            return this.mSubscribed;</span>
<a href="#l17.65"></a><span id="l17.65">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l17.66"></a><span id="l17.66">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-          this.mSubscribed = val;</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-          this.checked = val;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-          return val;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+            this.mSubscribed = val;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+            this.checked = val;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+            return val;</span>
<a href="#l17.73"></a><span id="l17.73">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l17.74"></a><span id="l17.74">       &lt;/property&gt;</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76">       &lt;property name=&quot;checked&quot;&gt;</span>
<a href="#l17.77"></a><span id="l17.77">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-            this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-          if (checkbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-              return true;</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-          } else {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-              return false;</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-          }</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+            let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+              this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+            if (checkbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+                return true;</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+            } else {</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+                return false;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+            }</span>
<a href="#l17.92"></a><span id="l17.92">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l17.93"></a><span id="l17.93">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-            this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-          if (val) {</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-              checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-          } else {</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-              checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-          }</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-          return val;</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+            let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+              this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+            if (val) {</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+                checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+            } else {</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+                checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+            }</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+            return val;</span>
<a href="#l17.110"></a><span id="l17.110">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l17.111"></a><span id="l17.111">       &lt;/property&gt;</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113">       &lt;property name=&quot;disabled&quot;&gt;</span>
<a href="#l17.114"></a><span id="l17.114">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-            this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-          if (checkbox.getAttribute(&quot;disabled&quot;) == &quot;true&quot;) {</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-              return true;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-          } else {</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-              return false;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-          }</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+            let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+              this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+            if (checkbox.getAttribute(&quot;disabled&quot;) == &quot;true&quot;) {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+                return true;</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+            } else {</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+                return false;</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+            }</span>
<a href="#l17.129"></a><span id="l17.129">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l17.130"></a><span id="l17.130">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-          let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-            this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-          if (val) {</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-              checkbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-          } else {</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-              checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-          }</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-          return val;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+            let checkbox = document.getAnonymousElementByAttribute(</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+              this, &quot;anonid&quot;, &quot;subscription-checkbox&quot;);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+            if (val) {</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+                checkbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+            } else {</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+                checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+            }</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+            return val;</span>
<a href="#l17.147"></a><span id="l17.147">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l17.148"></a><span id="l17.148">       &lt;/property&gt;</span>
<a href="#l17.149"></a><span id="l17.149"> </span>
<a href="#l17.150"></a><span id="l17.150">       &lt;method name=&quot;setCalendar&quot;&gt;</span>
<a href="#l17.151"></a><span id="l17.151">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l17.152"></a><span id="l17.152">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-          this.mCalendar = aCalendar;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-          let label = document.getAnonymousElementByAttribute(</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-              this, &quot;anonid&quot;, &quot;subscription-name&quot;);</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-          label.setAttribute(&quot;value&quot;, aCalendar.name);</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+            this.mCalendar = aCalendar;</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+            let label = document.getAnonymousElementByAttribute(</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+                this, &quot;anonid&quot;, &quot;subscription-name&quot;);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+            label.setAttribute(&quot;value&quot;, aCalendar.name);</span>
<a href="#l17.161"></a><span id="l17.161">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.162"></a><span id="l17.162">       &lt;/method&gt;</span>
<a href="#l17.163"></a><span id="l17.163">     &lt;/implementation&gt;</span>
<a href="#l17.164"></a><span id="l17.164">   &lt;/binding&gt;</span>
<a href="#l17.165"></a><span id="l17.165"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -42,174 +42,174 @@</span>
<a href="#l18.4"></a><span id="l18.4">                    onselect=&quot;document.getBindingParent(this).selectCategory()&quot;</span>
<a href="#l18.5"></a><span id="l18.5">                    selType=&quot;multiple&quot;</span>
<a href="#l18.6"></a><span id="l18.6">                    &gt;</span>
<a href="#l18.7"></a><span id="l18.7">         &lt;children/&gt;</span>
<a href="#l18.8"></a><span id="l18.8">       &lt;/xul:listbox&gt;</span>
<a href="#l18.9"></a><span id="l18.9">     &lt;/content&gt;</span>
<a href="#l18.10"></a><span id="l18.10">     &lt;implementation&gt;</span>
<a href="#l18.11"></a><span id="l18.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.14"></a><span id="l18.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16">       &lt;field name=&quot;_maxCount&quot;&gt;0&lt;/field&gt;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18">       &lt;property name=&quot;categories&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l18.19"></a><span id="l18.19">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-          let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-          if (this.maxCount == 1) {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-              let selectedItem = categoryListbox.selectedItem;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-              return selectedItem ? [selectedItem.getAttribute(&quot;value&quot;)] : [];</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-          } else {</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-              let checkedNodes = categoryListbox.getElementsByAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-              let sliceEnd = this.maxCount &gt; 0 ? this.maxCount : checkedNodes.length;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-              return Array.from(checkedNodes).slice(0, sliceEnd)</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-                                             .map(x =&gt; x.getAttribute(&quot;value&quot;));</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-          }</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+            let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+            if (this.maxCount == 1) {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+                let selectedItem = categoryListbox.selectedItem;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+                return selectedItem ? [selectedItem.getAttribute(&quot;value&quot;)] : [];</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+            } else {</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+                let checkedNodes = categoryListbox.getElementsByAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                let sliceEnd = this.maxCount &gt; 0 ? this.maxCount : checkedNodes.length;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+                return Array.from(checkedNodes).slice(0, sliceEnd)</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+                                               .map(x =&gt; x.getAttribute(&quot;value&quot;));</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+            }</span>
<a href="#l18.40"></a><span id="l18.40">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.41"></a><span id="l18.41">       &lt;/property&gt;</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43">       &lt;property name=&quot;maxCount&quot;&gt;</span>
<a href="#l18.44"></a><span id="l18.44">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-          return this._maxCount;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+            return this._maxCount;</span>
<a href="#l18.47"></a><span id="l18.47">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.48"></a><span id="l18.48">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-          if (this._maxCount != val) {</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-              this._maxCount = val;</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-              this.setupSelection();</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-          }</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+            if (this._maxCount != val) {</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+                this._maxCount = val;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                this.setupSelection();</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+            }</span>
<a href="#l18.57"></a><span id="l18.57">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l18.58"></a><span id="l18.58">       &lt;/property&gt;</span>
<a href="#l18.59"></a><span id="l18.59"> </span>
<a href="#l18.60"></a><span id="l18.60">       &lt;method name=&quot;selectCategory&quot;&gt;</span>
<a href="#l18.61"></a><span id="l18.61">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-          this.setupSelection();</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-          if (this.maxCount == 1) {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-              this.hidePopup();</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-          }</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+            this.setupSelection();</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+            if (this.maxCount == 1) {</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+                this.hidePopup();</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+            }</span>
<a href="#l18.70"></a><span id="l18.70">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.71"></a><span id="l18.71">       &lt;/method&gt;</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">       &lt;method name=&quot;setupSelection&quot;&gt;</span>
<a href="#l18.74"></a><span id="l18.74">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-          let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-          categoryListbox.setAttribute(&quot;seltype&quot;, this.maxCount == 1 ? &quot;single&quot; : &quot;multiple&quot;);</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+            let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+            categoryListbox.setAttribute(&quot;seltype&quot;, this.maxCount == 1 ? &quot;single&quot; : &quot;multiple&quot;);</span>
<a href="#l18.79"></a><span id="l18.79"> </span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-          if (this.maxCount == 1) {</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-              for (let node of categoryListbox.childNodes) {</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-                  // Single selection doesn't have checkboxes</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-                  node.removeAttribute(&quot;type&quot;);</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+            if (this.maxCount == 1) {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+                for (let node of categoryListbox.childNodes) {</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+                    // Single selection doesn't have checkboxes</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+                    node.removeAttribute(&quot;type&quot;);</span>
<a href="#l18.88"></a><span id="l18.88"> </span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-                  // Even though we have single select, these may be checked</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-                  // in case the user switches between calendars that support</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-                  // one vs multiple categories. Uncheck the other nodes to</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-                  // make sure the UX is not weird.</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-                  setBooleanAttribute(node, &quot;checked&quot;, node == categoryListbox.selectedItem);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-              }</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-          } else {</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-              let categoryTextbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;category-textbox&quot;);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-              let maxCountReached = this.maxCount &gt; 0 &amp;&amp; this.categories.length == this.maxCount;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-              setBooleanAttribute(categoryTextbox, &quot;disabled&quot;, maxCountReached);</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+                    // Even though we have single select, these may be checked</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+                    // in case the user switches between calendars that support</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+                    // one vs multiple categories. Uncheck the other nodes to</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+                    // make sure the UX is not weird.</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+                    setBooleanAttribute(node, &quot;checked&quot;, node == categoryListbox.selectedItem);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+                }</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+            } else {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+                let categoryTextbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;category-textbox&quot;);</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+                let maxCountReached = this.maxCount &gt; 0 &amp;&amp; this.categories.length == this.maxCount;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+                setBooleanAttribute(categoryTextbox, &quot;disabled&quot;, maxCountReached);</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-              for (let node of categoryListbox.childNodes) {</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-                  // Multiselect has checkboxes</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-                  node.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+                for (let node of categoryListbox.childNodes) {</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+                    // Multiselect has checkboxes</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+                    node.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.116"></a><span id="l18.116"> </span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-                  if (maxCountReached &amp;&amp; node.getAttribute(&quot;checked&quot;) != &quot;true&quot;) {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-                      // If the maxcount is reached, disable all unchecked items</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-                      node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-                  } else if (!maxCountReached) {</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-                      // If its not reached, remove the disabled attribute</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-                      node.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-                  }</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-              }</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-          }</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+                    if (maxCountReached &amp;&amp; node.getAttribute(&quot;checked&quot;) != &quot;true&quot;) {</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+                        // If the maxcount is reached, disable all unchecked items</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+                        node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+                    } else if (!maxCountReached) {</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+                        // If its not reached, remove the disabled attribute</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+                        node.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+                    }</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+                }</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+            }</span>
<a href="#l18.135"></a><span id="l18.135">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.136"></a><span id="l18.136">       &lt;/method&gt;</span>
<a href="#l18.137"></a><span id="l18.137"> </span>
<a href="#l18.138"></a><span id="l18.138">       &lt;method name=&quot;insertCategory&quot;&gt;</span>
<a href="#l18.139"></a><span id="l18.139">         &lt;parameter name=&quot;category&quot; /&gt;</span>
<a href="#l18.140"></a><span id="l18.140">         &lt;parameter name=&quot;categories&quot; /&gt;</span>
<a href="#l18.141"></a><span id="l18.141">         &lt;parameter name=&quot;categoryListbox&quot; /&gt;</span>
<a href="#l18.142"></a><span id="l18.142">         &lt;parameter name=&quot;compare&quot; /&gt;</span>
<a href="#l18.143"></a><span id="l18.143">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-          let newIndex = cal.binaryInsert(categories, category, compare, true);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-          let item = categoryListbox.childNodes[Math.min(newIndex, categoryListbox.childNodes.length - 1)];</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+            let newIndex = cal.binaryInsert(categories, category, compare, true);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+            let item = categoryListbox.childNodes[Math.min(newIndex, categoryListbox.childNodes.length - 1)];</span>
<a href="#l18.148"></a><span id="l18.148"> </span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-          if (!item || item.getAttribute(&quot;value&quot;) != category) {</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-              // The item doesn't exist, insert it at the correct spot.</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-              item = categoryListbox.insertItemAt(newIndex, category, category);</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+            if (!item || item.getAttribute(&quot;value&quot;) != category) {</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+                // The item doesn't exist, insert it at the correct spot.</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+                item = categoryListbox.insertItemAt(newIndex, category, category);</span>
<a href="#l18.155"></a><span id="l18.155"> </span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-              if (this.maxCount != 1) {</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-                  item.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-              }</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-          }</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+                if (this.maxCount != 1) {</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+                    item.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+                }</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+            }</span>
<a href="#l18.164"></a><span id="l18.164"> </span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-          item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-          return item;</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-          ]]&gt;&lt;/body&gt;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+            item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+            return item;</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l18.171"></a><span id="l18.171">       &lt;/method&gt;</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173">       &lt;method name=&quot;addNewCategory&quot;&gt;</span>
<a href="#l18.174"></a><span id="l18.174">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-          let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-          let categoryTextbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;category-textbox&quot;);</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-          let category = categoryTextbox.value;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+            let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+            let categoryTextbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;category-textbox&quot;);</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+            let category = categoryTextbox.value;</span>
<a href="#l18.181"></a><span id="l18.181"> </span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-          if (!category) {</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-              return;</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-          }</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+            if (!category) {</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+                return;</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+            }</span>
<a href="#l18.188"></a><span id="l18.188"> </span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-          let localeCollator = cal.createLocaleCollator();</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-          let compare = localeCollator.compareString.bind(localeCollator, 0);</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+            let localeCollator = cal.createLocaleCollator();</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+            let compare = localeCollator.compareString.bind(localeCollator, 0);</span>
<a href="#l18.193"></a><span id="l18.193"> </span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-          let children = categoryListbox.childNodes;</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-          let categories = [];</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-          for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-              categories.push(children[i].label);</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-          }</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+            let children = categoryListbox.childNodes;</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+            let categories = [];</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+            for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+                categories.push(children[i].label);</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+            }</span>
<a href="#l18.204"></a><span id="l18.204"> </span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-          let item = this.insertCategory(category, categories, categoryListbox, compare);</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-          categoryTextbox.value = &quot;&quot;;</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+            let item = this.insertCategory(category, categories, categoryListbox, compare);</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+            categoryTextbox.value = &quot;&quot;;</span>
<a href="#l18.209"></a><span id="l18.209"> </span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-          if (this.maxCount == 1) {</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-              categoryListbox.selectedItem = item;</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-          } else {</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-              this.selectCategory();</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-          }</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+            if (this.maxCount == 1) {</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+                categoryListbox.selectedItem = item;</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+            } else {</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+                this.selectCategory();</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+            }</span>
<a href="#l18.220"></a><span id="l18.220"> </span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-          categoryListbox.ensureElementIsVisible(item);</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+            categoryListbox.ensureElementIsVisible(item);</span>
<a href="#l18.223"></a><span id="l18.223">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.224"></a><span id="l18.224">       &lt;/method&gt;</span>
<a href="#l18.225"></a><span id="l18.225"> </span>
<a href="#l18.226"></a><span id="l18.226">       &lt;method name=&quot;loadItem&quot;&gt;</span>
<a href="#l18.227"></a><span id="l18.227">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l18.228"></a><span id="l18.228">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineminus">-          let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineminus">-          let categoryList = cal.getPrefCategoriesArray();</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+            let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+            let categoryList = cal.getPrefCategoriesArray();</span>
<a href="#l18.233"></a><span id="l18.233"> </span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-          cal.sortArrayByLocaleCollator(categoryList);</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+            cal.sortArrayByLocaleCollator(categoryList);</span>
<a href="#l18.236"></a><span id="l18.236"> </span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-          removeChildren(categoryListbox);</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+            removeChildren(categoryListbox);</span>
<a href="#l18.239"></a><span id="l18.239"> </span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-          for (let cat of categoryList) {</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-              // First insert all categories from the prefs</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-              let item = categoryListbox.appendItem(cat, cat);</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-              item.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-          }</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+            for (let cat of categoryList) {</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+                // First insert all categories from the prefs</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+                let item = categoryListbox.appendItem(cat, cat);</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+                item.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineplus">+            }</span>
<a href="#l18.250"></a><span id="l18.250"> </span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-          if (aItem) {</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-              let localeCollator = cal.createLocaleCollator();</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-              let compare = localeCollator.compareString.bind(localeCollator, 0);</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+            if (aItem) {</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+                let localeCollator = cal.createLocaleCollator();</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+                let compare = localeCollator.compareString.bind(localeCollator, 0);</span>
<a href="#l18.257"></a><span id="l18.257"> </span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-              // Ensure the item's categories are in the list and they are checked.</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-              for (let cat of aItem.getCategories({})) {</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-                  this.insertCategory(cat, categoryList, categoryListbox, compare);</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-              }</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-          }</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+                // Ensure the item's categories are in the list and they are checked.</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+                for (let cat of aItem.getCategories({})) {</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+                    this.insertCategory(cat, categoryList, categoryListbox, compare);</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+                }</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+            }</span>
<a href="#l18.268"></a><span id="l18.268">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.269"></a><span id="l18.269">       &lt;/method&gt;</span>
<a href="#l18.270"></a><span id="l18.270">     &lt;/implementation&gt;</span>
<a href="#l18.271"></a><span id="l18.271">   &lt;/binding&gt;</span>
<a href="#l18.272"></a><span id="l18.272"> </span>
<a href="#l18.273"></a><span id="l18.273">   &lt;binding id=&quot;doubleimage-toolbarbutton&quot; extends=&quot;chrome://global/content/bindings/toolbarbutton.xml#toolbarbutton&quot;&gt;</span>
<a href="#l18.274"></a><span id="l18.274">     &lt;resources&gt;</span>
<a href="#l18.275"></a><span id="l18.275">       &lt;stylesheet src=&quot;chrome://calendar/skin/widgets/calendar-widgets.css&quot;/&gt;</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineat">@@ -233,24 +233,24 @@</span>
<a href="#l18.277"></a><span id="l18.277">       &lt;/xul:stack&gt;</span>
<a href="#l18.278"></a><span id="l18.278">       &lt;xul:label class=&quot;toolbarbutton-text&quot; crop=&quot;right&quot; flex=&quot;1&quot;</span>
<a href="#l18.279"></a><span id="l18.279">                  xbl:inherits=&quot;value=label,accesskey,crop,toolbarmode,buttonstyle&quot;/&gt;</span>
<a href="#l18.280"></a><span id="l18.280">       &lt;xul:image class=&quot;toolbarbutton-icon-end&quot; xbl:inherits=&quot;validate,src-end=image,toolbarmode,buttonstyle&quot;/&gt;</span>
<a href="#l18.281"></a><span id="l18.281">     &lt;/content&gt;</span>
<a href="#l18.282"></a><span id="l18.282"> </span>
<a href="#l18.283"></a><span id="l18.283">     &lt;implementation&gt;</span>
<a href="#l18.284"></a><span id="l18.284">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-        this.setUpTodayDate();</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+          this.setUpTodayDate();</span>
<a href="#l18.289"></a><span id="l18.289">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.290"></a><span id="l18.290"> </span>
<a href="#l18.291"></a><span id="l18.291">       &lt;method name=&quot;setUpTodayDate&quot;&gt;</span>
<a href="#l18.292"></a><span id="l18.292">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-          let dayNumber = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.now().day + &quot;.number&quot;);</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-label&quot;).value = dayNumber;</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+            let dayNumber = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.now().day + &quot;.number&quot;);</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-label&quot;).value = dayNumber;</span>
<a href="#l18.297"></a><span id="l18.297">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.298"></a><span id="l18.298">       &lt;/method&gt;</span>
<a href="#l18.299"></a><span id="l18.299">     &lt;/implementation&gt;</span>
<a href="#l18.300"></a><span id="l18.300">    &lt;/binding&gt;</span>
<a href="#l18.301"></a><span id="l18.301"> </span>
<a href="#l18.302"></a><span id="l18.302">   &lt;!-- this binding directly extends to a checkbox but is visualized as</span>
<a href="#l18.303"></a><span id="l18.303">        a treenode in a treecontrol--&gt;</span>
<a href="#l18.304"></a><span id="l18.304">   &lt;binding id=&quot;treenode-checkbox&quot; extends=&quot;chrome://global/content/bindings/checkbox.xml#checkbox-baseline&quot;&gt;</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineat">@@ -263,30 +263,30 @@</span>
<a href="#l18.306"></a><span id="l18.306">        sets the &quot;orient&quot; attribute to &quot;vertical&quot; thus behaving like a vbox--&gt;</span>
<a href="#l18.307"></a><span id="l18.307">   &lt;binding id=&quot;modevbox&quot; extends=&quot;chrome://calendar/content/widgets/calendar-widgets.xml#modebox&quot;&gt;</span>
<a href="#l18.308"></a><span id="l18.308">     &lt;resources&gt;</span>
<a href="#l18.309"></a><span id="l18.309">       &lt;stylesheet src=&quot;chrome://calendar/skin/widgets/calendar-widgets.css&quot;/&gt;</span>
<a href="#l18.310"></a><span id="l18.310">     &lt;/resources&gt;</span>
<a href="#l18.311"></a><span id="l18.311"> </span>
<a href="#l18.312"></a><span id="l18.312">     &lt;implementation&gt;</span>
<a href="#l18.313"></a><span id="l18.313">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineminus">-        this.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+          this.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l18.316"></a><span id="l18.316">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.317"></a><span id="l18.317">     &lt;/implementation&gt;</span>
<a href="#l18.318"></a><span id="l18.318">   &lt;/binding&gt;</span>
<a href="#l18.319"></a><span id="l18.319"> </span>
<a href="#l18.320"></a><span id="l18.320">   &lt;!-- this binding directly extends to a xul:box element and automatically</span>
<a href="#l18.321"></a><span id="l18.321">        sets the &quot;orient&quot; attribute to &quot;horizontal&quot; thus behaving like a vbox--&gt;</span>
<a href="#l18.322"></a><span id="l18.322">   &lt;binding id=&quot;modehbox&quot; extends=&quot;chrome://calendar/content/widgets/calendar-widgets.xml#modebox&quot;&gt;</span>
<a href="#l18.323"></a><span id="l18.323">     &lt;resources&gt;</span>
<a href="#l18.324"></a><span id="l18.324">       &lt;stylesheet src=&quot;chrome://calendar/skin/widgets/calendar-widgets.css&quot;/&gt;</span>
<a href="#l18.325"></a><span id="l18.325">     &lt;/resources&gt;</span>
<a href="#l18.326"></a><span id="l18.326">     &lt;implementation&gt;</span>
<a href="#l18.327"></a><span id="l18.327">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-         this.setAttribute(&quot;orient&quot;, &quot;horizontal&quot;);</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+          this.setAttribute(&quot;orient&quot;, &quot;horizontal&quot;);</span>
<a href="#l18.330"></a><span id="l18.330">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.331"></a><span id="l18.331">     &lt;/implementation&gt;</span>
<a href="#l18.332"></a><span id="l18.332">   &lt;/binding&gt;</span>
<a href="#l18.333"></a><span id="l18.333"> </span>
<a href="#l18.334"></a><span id="l18.334">   &lt;!-- this binding directly extends to a xul:box element and enriches this with some functionality: It is designed</span>
<a href="#l18.335"></a><span id="l18.335">       to be displayed only 1) in given application modes (e.g &quot;task&quot; mode, &quot;calendar&quot; mode) and 2) only in relation</span>
<a href="#l18.336"></a><span id="l18.336">       to the &quot;checked&quot; attribute of command or a checkbox control.</span>
<a href="#l18.337"></a><span id="l18.337">     - The attribute &quot;mode&quot; denotes a coma-separated list of all modes that the binding should not be collapsed in,</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineat">@@ -309,416 +309,416 @@</span>
<a href="#l18.339"></a><span id="l18.339">     &lt;/resources&gt;</span>
<a href="#l18.340"></a><span id="l18.340">     &lt;implementation&gt;</span>
<a href="#l18.341"></a><span id="l18.341">       &lt;field name=&quot;mBroadcaster&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l18.342"></a><span id="l18.342">       &lt;field name=&quot;mModHandler&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l18.343"></a><span id="l18.343">       &lt;field name=&quot;mRefControl&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l18.344"></a><span id="l18.344">       &lt;field name=&quot;mControlHandler&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l18.345"></a><span id="l18.345"> </span>
<a href="#l18.346"></a><span id="l18.346">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-        if (this.hasAttribute(&quot;broadcaster&quot;)) {</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-            this.setAttribute(&quot;broadcaster&quot;, this.getAttribute(&quot;broadcaster&quot;));</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineminus">-        }</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineminus">-        if (this.hasAttribute(&quot;refcontrol&quot;)) {</span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-            this.mRefControl = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-            if (this.mRefControl &amp;&amp; ((this.mRefControl.localName == &quot;treenode-checkbox&quot;) ||</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-                                  (this.mRefControl.localName == &quot;checkbox&quot;))) {</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-                this.mControlHandler = {</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-                    binding: this,</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-                    handleEvent: function(aEvent, aHandled) {</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-                        return this.binding.onCheckboxStateChange(aEvent, this.binding);</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-                    }</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-                };</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-                this.mRefControl.addEventListener(&quot;CheckboxStateChange&quot;, this.mControlHandler, true);</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineminus">-            }</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineminus">-        }</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineplus">+          if (this.hasAttribute(&quot;broadcaster&quot;)) {</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineplus">+              this.setAttribute(&quot;broadcaster&quot;, this.getAttribute(&quot;broadcaster&quot;));</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineplus">+          }</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineplus">+          if (this.hasAttribute(&quot;refcontrol&quot;)) {</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineplus">+              this.mRefControl = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineplus">+              if (this.mRefControl &amp;&amp; ((this.mRefControl.localName == &quot;treenode-checkbox&quot;) ||</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineplus">+                                    (this.mRefControl.localName == &quot;checkbox&quot;))) {</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineplus">+                  this.mControlHandler = {</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineplus">+                      binding: this,</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineplus">+                      handleEvent: function(aEvent, aHandled) {</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineplus">+                          return this.binding.onCheckboxStateChange(aEvent, this.binding);</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineplus">+                      }</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineplus">+                  };</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineplus">+                  this.mRefControl.addEventListener(&quot;CheckboxStateChange&quot;, this.mControlHandler, true);</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineplus">+              }</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineplus">+          }</span>
<a href="#l18.379"></a><span id="l18.379">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.380"></a><span id="l18.380"> </span>
<a href="#l18.381"></a><span id="l18.381">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-        if (this.mBroadcaster) {</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineminus">-            this.mBroadcaster.removeEventListener(&quot;DOMAttrModified&quot;, this.mModHandler, true);</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-        }</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-        if (this.mRefControl) {</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-            this.mRefControl.removeEventListener(&quot;CheckboxStateChange&quot;, this.mControlHandler, true);</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-        }</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineplus">+          if (this.mBroadcaster) {</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineplus">+              this.mBroadcaster.removeEventListener(&quot;DOMAttrModified&quot;, this.mModHandler, true);</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineplus">+          }</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+          if (this.mRefControl) {</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineplus">+              this.mRefControl.removeEventListener(&quot;CheckboxStateChange&quot;, this.mControlHandler, true);</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineplus">+          }</span>
<a href="#l18.394"></a><span id="l18.394">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l18.395"></a><span id="l18.395"> </span>
<a href="#l18.396"></a><span id="l18.396">       &lt;property name=&quot;currentMode&quot;&gt;</span>
<a href="#l18.397"></a><span id="l18.397">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-          if (this.mBroadcaster &amp;&amp; this.mBroadcaster.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-              return this.mBroadcaster.getAttribute(&quot;mode&quot;);</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineminus">-          } else {</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineminus">-          }</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineplus">+            if (this.mBroadcaster &amp;&amp; this.mBroadcaster.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineplus">+                return this.mBroadcaster.getAttribute(&quot;mode&quot;);</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+            } else {</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineplus">+                return &quot;&quot;;</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineplus">+            }</span>
<a href="#l18.408"></a><span id="l18.408">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l18.409"></a><span id="l18.409">       &lt;/property&gt;</span>
<a href="#l18.410"></a><span id="l18.410"> </span>
<a href="#l18.411"></a><span id="l18.411">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l18.412"></a><span id="l18.412">         &lt;parameter name=&quot;aMode&quot;/&gt;</span>
<a href="#l18.413"></a><span id="l18.413">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineminus">-          let lMode = aMode || this.currentMode;</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineminus">-          if (!this.isVisibleInMode(lMode)) {</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineminus">-              return false;</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-          }</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineminus">-          let collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineminus">-          return !collapsedModes.includes(lMode);</span>
<a href="#l18.420"></a><span id="l18.420" class="difflineplus">+            let lMode = aMode || this.currentMode;</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineplus">+            if (!this.isVisibleInMode(lMode)) {</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineplus">+                return false;</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineplus">+            }</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineplus">+            let collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineplus">+            return !collapsedModes.includes(lMode);</span>
<a href="#l18.426"></a><span id="l18.426">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.427"></a><span id="l18.427">       &lt;/method&gt;</span>
<a href="#l18.428"></a><span id="l18.428"> </span>
<a href="#l18.429"></a><span id="l18.429">       &lt;method name=&quot;setModeAttribute&quot;&gt;</span>
<a href="#l18.430"></a><span id="l18.430">         &lt;parameter name=&quot;aModeAttribute&quot;/&gt;</span>
<a href="#l18.431"></a><span id="l18.431">         &lt;parameter name=&quot;aModeValue&quot;/&gt;</span>
<a href="#l18.432"></a><span id="l18.432">         &lt;parameter name=&quot;amode&quot;/&gt;</span>
<a href="#l18.433"></a><span id="l18.433">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-          if (this.hasAttribute(aModeAttribute)) {</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineminus">-              let lMode = amode || this.currentMode;</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineminus">-              let modeAttributeValues = this.getAttribute(aModeAttribute).split(&quot;,&quot;);</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineminus">-              let modes = this.getAttribute(&quot;mode&quot;).split(&quot;,&quot;);</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineminus">-              modeAttributeValues[modes.indexOf(lMode)] = aModeValue;</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineminus">-              this.setAttribute(aModeAttribute, modeAttributeValues.join(&quot;,&quot;));</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineminus">-          }</span>
<a href="#l18.441"></a><span id="l18.441" class="difflineplus">+            if (this.hasAttribute(aModeAttribute)) {</span>
<a href="#l18.442"></a><span id="l18.442" class="difflineplus">+                let lMode = amode || this.currentMode;</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineplus">+                let modeAttributeValues = this.getAttribute(aModeAttribute).split(&quot;,&quot;);</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineplus">+                let modes = this.getAttribute(&quot;mode&quot;).split(&quot;,&quot;);</span>
<a href="#l18.445"></a><span id="l18.445" class="difflineplus">+                modeAttributeValues[modes.indexOf(lMode)] = aModeValue;</span>
<a href="#l18.446"></a><span id="l18.446" class="difflineplus">+                this.setAttribute(aModeAttribute, modeAttributeValues.join(&quot;,&quot;));</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineplus">+            }</span>
<a href="#l18.448"></a><span id="l18.448">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.449"></a><span id="l18.449">       &lt;/method&gt;</span>
<a href="#l18.450"></a><span id="l18.450"> </span>
<a href="#l18.451"></a><span id="l18.451">       &lt;method name=&quot;getModeAttribute&quot;&gt;</span>
<a href="#l18.452"></a><span id="l18.452">         &lt;parameter name=&quot;aModeAttribute&quot;/&gt;</span>
<a href="#l18.453"></a><span id="l18.453">         &lt;parameter name=&quot;aAttribute&quot;/&gt;</span>
<a href="#l18.454"></a><span id="l18.454">         &lt;parameter name=&quot;amode&quot;/&gt;</span>
<a href="#l18.455"></a><span id="l18.455">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-          if (this.hasAttribute(aModeAttribute)) {</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-              let lMode = amode || this.currentMode;</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-              let modeAttributeValues = this.getAttribute(aModeAttribute).split(&quot;,&quot;);</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-              let modes = this.getAttribute(&quot;mode&quot;).split(&quot;,&quot;);</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-              return modeAttributeValues[modes.indexOf(lMode)];</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-          } else {</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineminus">-              return &quot;&quot;;</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineminus">-          }</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineplus">+            if (this.hasAttribute(aModeAttribute)) {</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineplus">+                let lMode = amode || this.currentMode;</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineplus">+                let modeAttributeValues = this.getAttribute(aModeAttribute).split(&quot;,&quot;);</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineplus">+                let modes = this.getAttribute(&quot;mode&quot;).split(&quot;,&quot;);</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineplus">+                return modeAttributeValues[modes.indexOf(lMode)];</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineplus">+            } else {</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineplus">+                return &quot;&quot;;</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineplus">+            }</span>
<a href="#l18.472"></a><span id="l18.472">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.473"></a><span id="l18.473">       &lt;/method&gt;</span>
<a href="#l18.474"></a><span id="l18.474"> </span>
<a href="#l18.475"></a><span id="l18.475">       &lt;method name=&quot;setVisible&quot;&gt;</span>
<a href="#l18.476"></a><span id="l18.476">         &lt;parameter name=&quot;aVisible&quot;/&gt;</span>
<a href="#l18.477"></a><span id="l18.477">         &lt;parameter name=&quot;aPushModeCollapsedAttribute&quot;/&gt;</span>
<a href="#l18.478"></a><span id="l18.478">         &lt;parameter name=&quot;aNotifyRefControl&quot;/&gt;</span>
<a href="#l18.479"></a><span id="l18.479">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineminus">-          let notifyRefControl = aNotifyRefControl == null || aNotifyRefControl === true;</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineminus">-          let pushModeCollapsedAttribute = aPushModeCollapsedAttribute == null ||</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineminus">-                                           aPushModeCollapsedAttribute === true;</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineminus">-          let collapsedModes = [];</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineminus">-          let modeIndex = -1;</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineminus">-          let display = aVisible;</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineminus">-          let collapsedInMode = false;</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-          if (this.hasAttribute(&quot;collapsedinmodes&quot;)) {</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-              collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineminus">-              modeIndex = collapsedModes.indexOf(this.currentMode);</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineminus">-              collapsedInMode = modeIndex &gt; -1;</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineminus">-          }</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineminus">-          if (aVisible === true &amp;&amp; pushModeCollapsedAttribute == false) {</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineminus">-              display = (aVisible === true) &amp;&amp; (!collapsedInMode);</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineminus">-          }</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineplus">+            let notifyRefControl = aNotifyRefControl == null || aNotifyRefControl === true;</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineplus">+            let pushModeCollapsedAttribute = aPushModeCollapsedAttribute == null ||</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineplus">+                                             aPushModeCollapsedAttribute === true;</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineplus">+            let collapsedModes = [];</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineplus">+            let modeIndex = -1;</span>
<a href="#l18.500"></a><span id="l18.500" class="difflineplus">+            let display = aVisible;</span>
<a href="#l18.501"></a><span id="l18.501" class="difflineplus">+            let collapsedInMode = false;</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineplus">+            if (this.hasAttribute(&quot;collapsedinmodes&quot;)) {</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineplus">+                collapsedModes = this.getAttribute(&quot;collapsedinmodes&quot;).split(&quot;,&quot;);</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineplus">+                modeIndex = collapsedModes.indexOf(this.currentMode);</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineplus">+                collapsedInMode = modeIndex &gt; -1;</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineplus">+            }</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineplus">+            if (aVisible === true &amp;&amp; pushModeCollapsedAttribute == false) {</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineplus">+                display = (aVisible === true) &amp;&amp; (!collapsedInMode);</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineplus">+            }</span>
<a href="#l18.510"></a><span id="l18.510"> </span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-          setBooleanAttribute(this, &quot;collapsed&quot;, !display || !this.isVisibleInMode());</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineminus">-          if (pushModeCollapsedAttribute) {</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineminus">-              if (!display) {</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineminus">-                  if (modeIndex == -1) {</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineminus">-                      collapsedModes.push(this.currentMode);</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineminus">-                      if (this.getAttribute(&quot;collapsedinmodes&quot;) == &quot;,&quot;) {</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineminus">-                          collapsedModes.splice(0, 2);</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-                      }</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineminus">-                  }</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineminus">-              } else if (modeIndex &gt; -1) {</span>
<a href="#l18.521"></a><span id="l18.521" class="difflineminus">-                  collapsedModes.splice(modeIndex, 1);</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineminus">-                  if (collapsedModes.join(&quot;,&quot;) == &quot;&quot;) {</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineminus">-                      collapsedModes[0] = &quot;,&quot;;</span>
<a href="#l18.524"></a><span id="l18.524" class="difflineminus">-                  }</span>
<a href="#l18.525"></a><span id="l18.525" class="difflineminus">-              }</span>
<a href="#l18.526"></a><span id="l18.526" class="difflineminus">-              this.setAttribute(&quot;collapsedinmodes&quot;, collapsedModes.join(&quot;,&quot;));</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineminus">-              let id = this.getAttribute(&quot;id&quot;);</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineminus">-              if (id) {</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineminus">-                  document.persist(id, &quot;collapsedinmodes&quot;);</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineminus">-              }</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineminus">-          }</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineminus">-          if (notifyRefControl === true) {</span>
<a href="#l18.533"></a><span id="l18.533" class="difflineminus">-              if (this.hasAttribute(&quot;refcontrol&quot;)) {</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-                  let command = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineminus">-                  if (command) {</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineminus">-                      command.setAttribute(&quot;checked&quot;, display);</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-                      setBooleanAttribute(command, &quot;disabled&quot;, !this.isVisibleInMode());</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineminus">-                  }</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineminus">-              }</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineminus">-          }</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineplus">+            setBooleanAttribute(this, &quot;collapsed&quot;, !display || !this.isVisibleInMode());</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineplus">+            if (pushModeCollapsedAttribute) {</span>
<a href="#l18.543"></a><span id="l18.543" class="difflineplus">+                if (!display) {</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineplus">+                    if (modeIndex == -1) {</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineplus">+                        collapsedModes.push(this.currentMode);</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineplus">+                        if (this.getAttribute(&quot;collapsedinmodes&quot;) == &quot;,&quot;) {</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineplus">+                            collapsedModes.splice(0, 2);</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineplus">+                        }</span>
<a href="#l18.549"></a><span id="l18.549" class="difflineplus">+                    }</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineplus">+                } else if (modeIndex &gt; -1) {</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineplus">+                    collapsedModes.splice(modeIndex, 1);</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineplus">+                    if (collapsedModes.join(&quot;,&quot;) == &quot;&quot;) {</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineplus">+                        collapsedModes[0] = &quot;,&quot;;</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineplus">+                    }</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineplus">+                }</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineplus">+                this.setAttribute(&quot;collapsedinmodes&quot;, collapsedModes.join(&quot;,&quot;));</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineplus">+                let id = this.getAttribute(&quot;id&quot;);</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineplus">+                if (id) {</span>
<a href="#l18.559"></a><span id="l18.559" class="difflineplus">+                    document.persist(id, &quot;collapsedinmodes&quot;);</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineplus">+                }</span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+            }</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+            if (notifyRefControl === true) {</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineplus">+                if (this.hasAttribute(&quot;refcontrol&quot;)) {</span>
<a href="#l18.564"></a><span id="l18.564" class="difflineplus">+                    let command = document.getElementById(this.getAttribute(&quot;refcontrol&quot;));</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineplus">+                    if (command) {</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineplus">+                        command.setAttribute(&quot;checked&quot;, display);</span>
<a href="#l18.567"></a><span id="l18.567" class="difflineplus">+                        setBooleanAttribute(command, &quot;disabled&quot;, !this.isVisibleInMode());</span>
<a href="#l18.568"></a><span id="l18.568" class="difflineplus">+                    }</span>
<a href="#l18.569"></a><span id="l18.569" class="difflineplus">+                }</span>
<a href="#l18.570"></a><span id="l18.570" class="difflineplus">+            }</span>
<a href="#l18.571"></a><span id="l18.571">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.572"></a><span id="l18.572">       &lt;/method&gt;</span>
<a href="#l18.573"></a><span id="l18.573"> </span>
<a href="#l18.574"></a><span id="l18.574">       &lt;method name=&quot;isVisibleInMode&quot;&gt;</span>
<a href="#l18.575"></a><span id="l18.575">         &lt;parameter name=&quot;aMode&quot;/&gt;</span>
<a href="#l18.576"></a><span id="l18.576">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineminus">-          let lMode = aMode || this.currentMode;</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-          let display = true;</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineminus">-          let lModes = [];</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineminus">-          if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineminus">-              let modeString = this.getAttribute(&quot;mode&quot;);</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineminus">-              lModes = modeString.split(&quot;,&quot;);</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineminus">-          }</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineminus">-          if (lModes &amp;&amp; lModes.length &gt; 0) {</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineminus">-              display = lModes.includes(lMode);</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineminus">-          }</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineminus">-          return display;</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineplus">+            let lMode = aMode || this.currentMode;</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineplus">+            let display = true;</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineplus">+            let lModes = [];</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineplus">+            if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineplus">+                let modeString = this.getAttribute(&quot;mode&quot;);</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineplus">+                lModes = modeString.split(&quot;,&quot;);</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineplus">+            }</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineplus">+            if (lModes &amp;&amp; lModes.length &gt; 0) {</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineplus">+                display = lModes.includes(lMode);</span>
<a href="#l18.597"></a><span id="l18.597" class="difflineplus">+            }</span>
<a href="#l18.598"></a><span id="l18.598" class="difflineplus">+            return display;</span>
<a href="#l18.599"></a><span id="l18.599">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.600"></a><span id="l18.600">       &lt;/method&gt;</span>
<a href="#l18.601"></a><span id="l18.601"> </span>
<a href="#l18.602"></a><span id="l18.602">       &lt;method name=&quot;onModeModified&quot;&gt;</span>
<a href="#l18.603"></a><span id="l18.603">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l18.604"></a><span id="l18.604">         &lt;parameter name=&quot;aBinding&quot;/&gt;</span>
<a href="#l18.605"></a><span id="l18.605">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.606"></a><span id="l18.606" class="difflineminus">-          if (aEvent.attrName == &quot;mode&quot;) {</span>
<a href="#l18.607"></a><span id="l18.607" class="difflineminus">-              let display = aBinding.isVisibleInMode(aEvent.newValue);</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineminus">-              aBinding.setVisible(display, false, true);</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineminus">-          }</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineplus">+            if (aEvent.attrName == &quot;mode&quot;) {</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+                let display = aBinding.isVisibleInMode(aEvent.newValue);</span>
<a href="#l18.612"></a><span id="l18.612" class="difflineplus">+                aBinding.setVisible(display, false, true);</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineplus">+            }</span>
<a href="#l18.614"></a><span id="l18.614">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.615"></a><span id="l18.615">       &lt;/method&gt;</span>
<a href="#l18.616"></a><span id="l18.616"> </span>
<a href="#l18.617"></a><span id="l18.617">       &lt;method name=&quot;togglePane&quot;&gt;</span>
<a href="#l18.618"></a><span id="l18.618">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l18.619"></a><span id="l18.619">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineminus">-          let command = aEvent.target;</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineminus">-          let newValue = (command.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineminus">-          command.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineminus">-          this.setVisible(newValue == &quot;true&quot;, true, true);</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineplus">+            let command = aEvent.target;</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineplus">+            let newValue = (command.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineplus">+            command.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineplus">+            this.setVisible(newValue == &quot;true&quot;, true, true);</span>
<a href="#l18.628"></a><span id="l18.628">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.629"></a><span id="l18.629">       &lt;/method&gt;</span>
<a href="#l18.630"></a><span id="l18.630"> </span>
<a href="#l18.631"></a><span id="l18.631">       &lt;method name=&quot;onCheckboxStateChange&quot;&gt;</span>
<a href="#l18.632"></a><span id="l18.632">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l18.633"></a><span id="l18.633">         &lt;parameter name=&quot;aBinding&quot;/&gt;</span>
<a href="#l18.634"></a><span id="l18.634">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineminus">-          let newValue = aEvent.target.checked;</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineminus">-          this.setVisible(newValue, true, true);</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineplus">+            let newValue = aEvent.target.checked;</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+            this.setVisible(newValue, true, true);</span>
<a href="#l18.639"></a><span id="l18.639">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.640"></a><span id="l18.640">       &lt;/method&gt;</span>
<a href="#l18.641"></a><span id="l18.641"> </span>
<a href="#l18.642"></a><span id="l18.642">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l18.643"></a><span id="l18.643">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l18.644"></a><span id="l18.644">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l18.645"></a><span id="l18.645">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineminus">-          if (aAttr == &quot;broadcaster&quot;) {</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineminus">-              this.mBroadcaster = document.getElementById(aVal);</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineminus">-              if (this.mBroadcaster) {</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineminus">-                  this.mModHandler = {</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineminus">-                      binding: this,</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineminus">-                      handleEvent: function(aEvent, aHandled) {</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineminus">-                          return this.binding.onModeModified(aEvent, this.binding);</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineminus">-                      }</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineminus">-                  };</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineminus">-                  this.mBroadcaster.addEventListener(&quot;DOMAttrModified&quot;, this.mModHandler, true);</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineminus">-              }</span>
<a href="#l18.657"></a><span id="l18.657" class="difflineminus">-          }</span>
<a href="#l18.658"></a><span id="l18.658" class="difflineminus">-          return XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l18.659"></a><span id="l18.659" class="difflineplus">+            if (aAttr == &quot;broadcaster&quot;) {</span>
<a href="#l18.660"></a><span id="l18.660" class="difflineplus">+                this.mBroadcaster = document.getElementById(aVal);</span>
<a href="#l18.661"></a><span id="l18.661" class="difflineplus">+                if (this.mBroadcaster) {</span>
<a href="#l18.662"></a><span id="l18.662" class="difflineplus">+                    this.mModHandler = {</span>
<a href="#l18.663"></a><span id="l18.663" class="difflineplus">+                        binding: this,</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineplus">+                        handleEvent: function(aEvent, aHandled) {</span>
<a href="#l18.665"></a><span id="l18.665" class="difflineplus">+                            return this.binding.onModeModified(aEvent, this.binding);</span>
<a href="#l18.666"></a><span id="l18.666" class="difflineplus">+                        }</span>
<a href="#l18.667"></a><span id="l18.667" class="difflineplus">+                    };</span>
<a href="#l18.668"></a><span id="l18.668" class="difflineplus">+                    this.mBroadcaster.addEventListener(&quot;DOMAttrModified&quot;, this.mModHandler, true);</span>
<a href="#l18.669"></a><span id="l18.669" class="difflineplus">+                }</span>
<a href="#l18.670"></a><span id="l18.670" class="difflineplus">+            }</span>
<a href="#l18.671"></a><span id="l18.671" class="difflineplus">+            return XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l18.672"></a><span id="l18.672">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.673"></a><span id="l18.673">       &lt;/method&gt;</span>
<a href="#l18.674"></a><span id="l18.674">     &lt;/implementation&gt;</span>
<a href="#l18.675"></a><span id="l18.675">   &lt;/binding&gt;</span>
<a href="#l18.676"></a><span id="l18.676"> </span>
<a href="#l18.677"></a><span id="l18.677">   &lt;!-- This binding may server as a droptarget container for arbitrary items</span>
<a href="#l18.678"></a><span id="l18.678">        it contains methods to add DropShadows. This binding is meant to be used</span>
<a href="#l18.679"></a><span id="l18.679">        as a parent binding. The methods may be overwritten. --&gt;</span>
<a href="#l18.680"></a><span id="l18.680">   &lt;binding id=&quot;dragndropContainer&quot;&gt;</span>
<a href="#l18.681"></a><span id="l18.681">     &lt;implementation&gt;</span>
<a href="#l18.682"></a><span id="l18.682">       &lt;field name=&quot;mDropShadows&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l18.683"></a><span id="l18.683">       &lt;field name=&quot;mCalendarView&quot;&gt;null&lt;/field&gt;</span>
<a href="#l18.684"></a><span id="l18.684"> </span>
<a href="#l18.685"></a><span id="l18.685">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l18.686"></a><span id="l18.686" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.687"></a><span id="l18.687" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.688"></a><span id="l18.688">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l18.689"></a><span id="l18.689"> </span>
<a href="#l18.690"></a><span id="l18.690">       &lt;!-- The ViewController that supports the interface 'calICalendarView'--&gt;</span>
<a href="#l18.691"></a><span id="l18.691">       &lt;property name=&quot;calendarView&quot;</span>
<a href="#l18.692"></a><span id="l18.692">                 onget=&quot;return this.mCalendarView;&quot;</span>
<a href="#l18.693"></a><span id="l18.693">                 onset=&quot;return (this.mCalendarView = val);&quot;/&gt;</span>
<a href="#l18.694"></a><span id="l18.694"> </span>
<a href="#l18.695"></a><span id="l18.695">       &lt;!-- method to add individual code e.g to set up the new item during</span>
<a href="#l18.696"></a><span id="l18.696">        'ondrop' --&gt;</span>
<a href="#l18.697"></a><span id="l18.697">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l18.698"></a><span id="l18.698">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l18.699"></a><span id="l18.699">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineminus">-          // method that may be overridden by derived bindings...</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineplus">+            // method that may be overridden by derived bindings...</span>
<a href="#l18.702"></a><span id="l18.702">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.703"></a><span id="l18.703">       &lt;/method&gt;</span>
<a href="#l18.704"></a><span id="l18.704"> </span>
<a href="#l18.705"></a><span id="l18.705">       &lt;method name=&quot;getDropShadows&quot;&gt;</span>
<a href="#l18.706"></a><span id="l18.706">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.707"></a><span id="l18.707" class="difflineminus">-          return this.mDropShadows;</span>
<a href="#l18.708"></a><span id="l18.708" class="difflineplus">+            return this.mDropShadows;</span>
<a href="#l18.709"></a><span id="l18.709">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.710"></a><span id="l18.710">       &lt;/method&gt;</span>
<a href="#l18.711"></a><span id="l18.711"> </span>
<a href="#l18.712"></a><span id="l18.712">       &lt;!-- Adds the dropshadows to the children of the binding. The dropshadows</span>
<a href="#l18.713"></a><span id="l18.713">            are added at the first position of the children --&gt;</span>
<a href="#l18.714"></a><span id="l18.714">       &lt;method name=&quot;addDropShadows&quot;&gt;</span>
<a href="#l18.715"></a><span id="l18.715">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineminus">-          if (this.mDropShadows) {</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineminus">-              if (this.getElementsByAttribute(&quot;class&quot;, &quot;dropshadow&quot;).length == 0) {</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineminus">-                  let offset = this.calendarView.mShadowOffset;</span>
<a href="#l18.719"></a><span id="l18.719" class="difflineminus">-                  let shadowStartDate = this.date.clone();</span>
<a href="#l18.720"></a><span id="l18.720" class="difflineminus">-                  shadowStartDate.addDuration(offset);</span>
<a href="#l18.721"></a><span id="l18.721" class="difflineminus">-                  this.calendarView.mDropShadows = [];</span>
<a href="#l18.722"></a><span id="l18.722" class="difflineminus">-                  for (let i = 0; i &lt; this.calendarView.mDropShadowsLength; i++) {</span>
<a href="#l18.723"></a><span id="l18.723" class="difflineminus">-                      let box = this.calendarView.findDayBoxForDate(shadowStartDate);</span>
<a href="#l18.724"></a><span id="l18.724" class="difflineminus">-                      if (!box) {</span>
<a href="#l18.725"></a><span id="l18.725" class="difflineminus">-                          // Dragging to the end or beginning of a view</span>
<a href="#l18.726"></a><span id="l18.726" class="difflineminus">-                          shadowStartDate.day += 1;</span>
<a href="#l18.727"></a><span id="l18.727" class="difflineminus">-                          continue;</span>
<a href="#l18.728"></a><span id="l18.728" class="difflineminus">-                      }</span>
<a href="#l18.729"></a><span id="l18.729" class="difflineminus">-                      let dropshadow = createXULElement(&quot;box&quot;);</span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-                      dropshadow.setAttribute(&quot;class&quot;, &quot;dropshadow&quot;);</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-                      if (box.hasChildNodes()) {</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-                          box.insertBefore(dropshadow, box.firstChild);</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineminus">-                      } else {</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineminus">-                          box.appendChild(dropshadow);</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-                      }</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineminus">-                      shadowStartDate.day += 1;</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineminus">-                      this.calendarView.mDropShadows.push(box);</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineminus">-                  }</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineminus">-              }</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineminus">-          }</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineplus">+            if (this.mDropShadows) {</span>
<a href="#l18.742"></a><span id="l18.742" class="difflineplus">+                if (this.getElementsByAttribute(&quot;class&quot;, &quot;dropshadow&quot;).length == 0) {</span>
<a href="#l18.743"></a><span id="l18.743" class="difflineplus">+                    let offset = this.calendarView.mShadowOffset;</span>
<a href="#l18.744"></a><span id="l18.744" class="difflineplus">+                    let shadowStartDate = this.date.clone();</span>
<a href="#l18.745"></a><span id="l18.745" class="difflineplus">+                    shadowStartDate.addDuration(offset);</span>
<a href="#l18.746"></a><span id="l18.746" class="difflineplus">+                    this.calendarView.mDropShadows = [];</span>
<a href="#l18.747"></a><span id="l18.747" class="difflineplus">+                    for (let i = 0; i &lt; this.calendarView.mDropShadowsLength; i++) {</span>
<a href="#l18.748"></a><span id="l18.748" class="difflineplus">+                        let box = this.calendarView.findDayBoxForDate(shadowStartDate);</span>
<a href="#l18.749"></a><span id="l18.749" class="difflineplus">+                        if (!box) {</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineplus">+                            // Dragging to the end or beginning of a view</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineplus">+                            shadowStartDate.day += 1;</span>
<a href="#l18.752"></a><span id="l18.752" class="difflineplus">+                            continue;</span>
<a href="#l18.753"></a><span id="l18.753" class="difflineplus">+                        }</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineplus">+                        let dropshadow = createXULElement(&quot;box&quot;);</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineplus">+                        dropshadow.setAttribute(&quot;class&quot;, &quot;dropshadow&quot;);</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineplus">+                        if (box.hasChildNodes()) {</span>
<a href="#l18.757"></a><span id="l18.757" class="difflineplus">+                            box.insertBefore(dropshadow, box.firstChild);</span>
<a href="#l18.758"></a><span id="l18.758" class="difflineplus">+                        } else {</span>
<a href="#l18.759"></a><span id="l18.759" class="difflineplus">+                            box.appendChild(dropshadow);</span>
<a href="#l18.760"></a><span id="l18.760" class="difflineplus">+                        }</span>
<a href="#l18.761"></a><span id="l18.761" class="difflineplus">+                        shadowStartDate.day += 1;</span>
<a href="#l18.762"></a><span id="l18.762" class="difflineplus">+                        this.calendarView.mDropShadows.push(box);</span>
<a href="#l18.763"></a><span id="l18.763" class="difflineplus">+                    }</span>
<a href="#l18.764"></a><span id="l18.764" class="difflineplus">+                }</span>
<a href="#l18.765"></a><span id="l18.765" class="difflineplus">+            }</span>
<a href="#l18.766"></a><span id="l18.766">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.767"></a><span id="l18.767">       &lt;/method&gt;</span>
<a href="#l18.768"></a><span id="l18.768"> </span>
<a href="#l18.769"></a><span id="l18.769">       &lt;!-- removes all dropShadows from the binding. Dropshadows are recognized</span>
<a href="#l18.770"></a><span id="l18.770">            as such by carrying an attribute &quot;dropshadow&quot; --&gt;</span>
<a href="#l18.771"></a><span id="l18.771">       &lt;method name=&quot;removeDropShadows&quot;&gt;</span>
<a href="#l18.772"></a><span id="l18.772">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.773"></a><span id="l18.773" class="difflineminus">-          // method that may be overwritten by derived bindings...</span>
<a href="#l18.774"></a><span id="l18.774" class="difflineminus">-          if (this.calendarView.mDropShadows) {</span>
<a href="#l18.775"></a><span id="l18.775" class="difflineminus">-              for (let shadow of this.calendarView.mDropShadows) {</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineminus">-                  cal.removeChildElementsByAttribute(shadow, &quot;class&quot;, &quot;dropshadow&quot;);</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineminus">-              }</span>
<a href="#l18.778"></a><span id="l18.778" class="difflineminus">-          }</span>
<a href="#l18.779"></a><span id="l18.779" class="difflineminus">-          this.calendarView.mDropShadows = null;</span>
<a href="#l18.780"></a><span id="l18.780" class="difflineplus">+            // method that may be overwritten by derived bindings...</span>
<a href="#l18.781"></a><span id="l18.781" class="difflineplus">+            if (this.calendarView.mDropShadows) {</span>
<a href="#l18.782"></a><span id="l18.782" class="difflineplus">+                for (let shadow of this.calendarView.mDropShadows) {</span>
<a href="#l18.783"></a><span id="l18.783" class="difflineplus">+                    cal.removeChildElementsByAttribute(shadow, &quot;class&quot;, &quot;dropshadow&quot;);</span>
<a href="#l18.784"></a><span id="l18.784" class="difflineplus">+                }</span>
<a href="#l18.785"></a><span id="l18.785" class="difflineplus">+            }</span>
<a href="#l18.786"></a><span id="l18.786" class="difflineplus">+            this.calendarView.mDropShadows = null;</span>
<a href="#l18.787"></a><span id="l18.787">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.788"></a><span id="l18.788">       &lt;/method&gt;</span>
<a href="#l18.789"></a><span id="l18.789"> </span>
<a href="#l18.790"></a><span id="l18.790">       &lt;!-- By setting the attribute &quot;dropbox&quot; to &quot;true&quot; or &quot;false&quot; the</span>
<a href="#l18.791"></a><span id="l18.791">            dropshadows are added or removed --&gt;</span>
<a href="#l18.792"></a><span id="l18.792">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l18.793"></a><span id="l18.793">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l18.794"></a><span id="l18.794">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l18.795"></a><span id="l18.795">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineminus">-          if (aAttr == &quot;dropbox&quot;) {</span>
<a href="#l18.797"></a><span id="l18.797" class="difflineminus">-              let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineminus">-              let startingDayBox = session.sourceNode.mParentBox;</span>
<a href="#l18.799"></a><span id="l18.799" class="difflineminus">-              if (session) {</span>
<a href="#l18.800"></a><span id="l18.800" class="difflineminus">-                  session.canDrop = true;</span>
<a href="#l18.801"></a><span id="l18.801" class="difflineminus">-                  // no shadows when dragging in the initial position</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineminus">-                  if (aVal == &quot;true&quot; &amp;&amp; this != startingDayBox) {</span>
<a href="#l18.803"></a><span id="l18.803" class="difflineminus">-                      this.mDropShadows = [session.sourceNode.sourceObject];</span>
<a href="#l18.804"></a><span id="l18.804" class="difflineminus">-                      this.addDropShadows();</span>
<a href="#l18.805"></a><span id="l18.805" class="difflineminus">-                  } else {</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineminus">-                      this.removeDropShadows();</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-                  }</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineminus">-              }</span>
<a href="#l18.809"></a><span id="l18.809" class="difflineminus">-          }</span>
<a href="#l18.810"></a><span id="l18.810" class="difflineminus">-          return XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l18.811"></a><span id="l18.811" class="difflineplus">+            if (aAttr == &quot;dropbox&quot;) {</span>
<a href="#l18.812"></a><span id="l18.812" class="difflineplus">+                let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.813"></a><span id="l18.813" class="difflineplus">+                let startingDayBox = session.sourceNode.mParentBox;</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineplus">+                if (session) {</span>
<a href="#l18.815"></a><span id="l18.815" class="difflineplus">+                    session.canDrop = true;</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineplus">+                    // no shadows when dragging in the initial position</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineplus">+                    if (aVal == &quot;true&quot; &amp;&amp; this != startingDayBox) {</span>
<a href="#l18.818"></a><span id="l18.818" class="difflineplus">+                        this.mDropShadows = [session.sourceNode.sourceObject];</span>
<a href="#l18.819"></a><span id="l18.819" class="difflineplus">+                        this.addDropShadows();</span>
<a href="#l18.820"></a><span id="l18.820" class="difflineplus">+                    } else {</span>
<a href="#l18.821"></a><span id="l18.821" class="difflineplus">+                        this.removeDropShadows();</span>
<a href="#l18.822"></a><span id="l18.822" class="difflineplus">+                    }</span>
<a href="#l18.823"></a><span id="l18.823" class="difflineplus">+                }</span>
<a href="#l18.824"></a><span id="l18.824" class="difflineplus">+            }</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineplus">+            return XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l18.826"></a><span id="l18.826">         ]]&gt;&lt;/body&gt;</span>
<a href="#l18.827"></a><span id="l18.827">       &lt;/method&gt;</span>
<a href="#l18.828"></a><span id="l18.828">     &lt;/implementation&gt;</span>
<a href="#l18.829"></a><span id="l18.829"> </span>
<a href="#l18.830"></a><span id="l18.830">     &lt;handlers&gt;</span>
<a href="#l18.831"></a><span id="l18.831">       &lt;handler event=&quot;dragstart&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineminus">-        let draggedDOMNode = event.target;</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineminus">-        if (!draggedDOMNode || draggedDOMNode.parentNode != this) {</span>
<a href="#l18.834"></a><span id="l18.834" class="difflineminus">-            return;</span>
<a href="#l18.835"></a><span id="l18.835" class="difflineminus">-        }</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineminus">-        let item = draggedDOMNode.occurrence.clone();</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineminus">-        let beginMoveDate = draggedDOMNode.mParentBox.date;</span>
<a href="#l18.838"></a><span id="l18.838" class="difflineminus">-        let itemStartDate = (item.startDate || item.entryDate || item.dueDate).getInTimezone(calendarView.mTimezone);</span>
<a href="#l18.839"></a><span id="l18.839" class="difflineminus">-        let itemEndDate = (item.endDate || item.dueDate || item.entryDate).getInTimezone(calendarView.mTimezone);</span>
<a href="#l18.840"></a><span id="l18.840" class="difflineminus">-        let oneMoreDay = (itemEndDate.hour &gt; 0 || itemEndDate.minute &gt; 0);</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineminus">-        itemStartDate.isDate = true;</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineminus">-        itemEndDate.isDate = true;</span>
<a href="#l18.843"></a><span id="l18.843" class="difflineminus">-        let offsetDuration = itemStartDate.subtractDate(beginMoveDate);</span>
<a href="#l18.844"></a><span id="l18.844" class="difflineminus">-        let lenDuration = itemEndDate.subtractDate(itemStartDate);</span>
<a href="#l18.845"></a><span id="l18.845" class="difflineminus">-        let len = lenDuration.weeks * 7 + lenDuration.days;</span>
<a href="#l18.846"></a><span id="l18.846" class="difflineminus">-        this.calendarView.mShadowOffset = offsetDuration;</span>
<a href="#l18.847"></a><span id="l18.847" class="difflineminus">-        this.calendarView.mDropShadowsLength = oneMoreDay ? len + 1 : len;</span>
<a href="#l18.848"></a><span id="l18.848" class="difflineplus">+          let draggedDOMNode = event.target;</span>
<a href="#l18.849"></a><span id="l18.849" class="difflineplus">+          if (!draggedDOMNode || draggedDOMNode.parentNode != this) {</span>
<a href="#l18.850"></a><span id="l18.850" class="difflineplus">+              return;</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineplus">+          }</span>
<a href="#l18.852"></a><span id="l18.852" class="difflineplus">+          let item = draggedDOMNode.occurrence.clone();</span>
<a href="#l18.853"></a><span id="l18.853" class="difflineplus">+          let beginMoveDate = draggedDOMNode.mParentBox.date;</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineplus">+          let itemStartDate = (item.startDate || item.entryDate || item.dueDate).getInTimezone(calendarView.mTimezone);</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineplus">+          let itemEndDate = (item.endDate || item.dueDate || item.entryDate).getInTimezone(calendarView.mTimezone);</span>
<a href="#l18.856"></a><span id="l18.856" class="difflineplus">+          let oneMoreDay = (itemEndDate.hour &gt; 0 || itemEndDate.minute &gt; 0);</span>
<a href="#l18.857"></a><span id="l18.857" class="difflineplus">+          itemStartDate.isDate = true;</span>
<a href="#l18.858"></a><span id="l18.858" class="difflineplus">+          itemEndDate.isDate = true;</span>
<a href="#l18.859"></a><span id="l18.859" class="difflineplus">+          let offsetDuration = itemStartDate.subtractDate(beginMoveDate);</span>
<a href="#l18.860"></a><span id="l18.860" class="difflineplus">+          let lenDuration = itemEndDate.subtractDate(itemStartDate);</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineplus">+          let len = lenDuration.weeks * 7 + lenDuration.days;</span>
<a href="#l18.862"></a><span id="l18.862" class="difflineplus">+          this.calendarView.mShadowOffset = offsetDuration;</span>
<a href="#l18.863"></a><span id="l18.863" class="difflineplus">+          this.calendarView.mDropShadowsLength = oneMoreDay ? len + 1 : len;</span>
<a href="#l18.864"></a><span id="l18.864">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.865"></a><span id="l18.865"> </span>
<a href="#l18.866"></a><span id="l18.866">       &lt;handler event=&quot;dragover&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.867"></a><span id="l18.867" class="difflineminus">-        let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.868"></a><span id="l18.868" class="difflineminus">-        if (!session || !session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.869"></a><span id="l18.869" class="difflineminus">-            // No source item? Then this is not for us.</span>
<a href="#l18.870"></a><span id="l18.870" class="difflineminus">-            return;</span>
<a href="#l18.871"></a><span id="l18.871" class="difflineminus">-        }</span>
<a href="#l18.872"></a><span id="l18.872" class="difflineplus">+          let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.873"></a><span id="l18.873" class="difflineplus">+          if (!session || !session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.874"></a><span id="l18.874" class="difflineplus">+              // No source item? Then this is not for us.</span>
<a href="#l18.875"></a><span id="l18.875" class="difflineplus">+              return;</span>
<a href="#l18.876"></a><span id="l18.876" class="difflineplus">+          }</span>
<a href="#l18.877"></a><span id="l18.877"> </span>
<a href="#l18.878"></a><span id="l18.878" class="difflineminus">-        // We handled the event</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineminus">-        event.preventDefault();</span>
<a href="#l18.880"></a><span id="l18.880" class="difflineplus">+          // We handled the event</span>
<a href="#l18.881"></a><span id="l18.881" class="difflineplus">+          event.preventDefault();</span>
<a href="#l18.882"></a><span id="l18.882">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.883"></a><span id="l18.883"> </span>
<a href="#l18.884"></a><span id="l18.884">       &lt;handler event=&quot;dragenter&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.885"></a><span id="l18.885" class="difflineminus">-        if (event.target.localName == this.localName) {</span>
<a href="#l18.886"></a><span id="l18.886" class="difflineminus">-            let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.887"></a><span id="l18.887" class="difflineminus">-            if (session) {</span>
<a href="#l18.888"></a><span id="l18.888" class="difflineminus">-                if (!session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.889"></a><span id="l18.889" class="difflineminus">-                    // No source item? Then this is not for us.</span>
<a href="#l18.890"></a><span id="l18.890" class="difflineminus">-                    return;</span>
<a href="#l18.891"></a><span id="l18.891" class="difflineminus">-                }</span>
<a href="#l18.892"></a><span id="l18.892" class="difflineplus">+          if (event.target.localName == this.localName) {</span>
<a href="#l18.893"></a><span id="l18.893" class="difflineplus">+              let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.894"></a><span id="l18.894" class="difflineplus">+              if (session) {</span>
<a href="#l18.895"></a><span id="l18.895" class="difflineplus">+                  if (!session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.896"></a><span id="l18.896" class="difflineplus">+                      // No source item? Then this is not for us.</span>
<a href="#l18.897"></a><span id="l18.897" class="difflineplus">+                      return;</span>
<a href="#l18.898"></a><span id="l18.898" class="difflineplus">+                  }</span>
<a href="#l18.899"></a><span id="l18.899"> </span>
<a href="#l18.900"></a><span id="l18.900" class="difflineminus">-                // We can drop now, tell the drag service.</span>
<a href="#l18.901"></a><span id="l18.901" class="difflineminus">-                event.preventDefault();</span>
<a href="#l18.902"></a><span id="l18.902" class="difflineplus">+                  // We can drop now, tell the drag service.</span>
<a href="#l18.903"></a><span id="l18.903" class="difflineplus">+                  event.preventDefault();</span>
<a href="#l18.904"></a><span id="l18.904"> </span>
<a href="#l18.905"></a><span id="l18.905" class="difflineminus">-                if (!this.hasAttribute(&quot;dropbox&quot;) || this.getAttribute(&quot;dropbox&quot;) == &quot;false&quot;) {</span>
<a href="#l18.906"></a><span id="l18.906" class="difflineminus">-                    // As it turned out it was not possible to remove the remaining dropshadows</span>
<a href="#l18.907"></a><span id="l18.907" class="difflineminus">-                    // at the &quot;dragleave&quot; or &quot;dragexit&quot; event, majorly because it was not reliably</span>
<a href="#l18.908"></a><span id="l18.908" class="difflineminus">-                    // fired. As the dragndropcontainer may be anonymous it is further on not</span>
<a href="#l18.909"></a><span id="l18.909" class="difflineminus">-                    // possible to remove the dropshadows by something like</span>
<a href="#l18.910"></a><span id="l18.910" class="difflineminus">-                    // &quot;document.getElementsByAttribute('dropbox').removeDropShadows();&quot;;</span>
<a href="#l18.911"></a><span id="l18.911" class="difflineminus">-                    // So we have to remove them at the currentView(). The restriction of course is</span>
<a href="#l18.912"></a><span id="l18.912" class="difflineminus">-                    // that these containers so far may not be used for drag and drop from/to e.g.</span>
<a href="#l18.913"></a><span id="l18.913" class="difflineminus">-                    // the today-pane.</span>
<a href="#l18.914"></a><span id="l18.914" class="difflineminus">-                    currentView().removeDropShadows();</span>
<a href="#l18.915"></a><span id="l18.915" class="difflineminus">-                }</span>
<a href="#l18.916"></a><span id="l18.916" class="difflineminus">-                this.setAttribute(&quot;dropbox&quot;, &quot;true&quot;);</span>
<a href="#l18.917"></a><span id="l18.917" class="difflineminus">-            }</span>
<a href="#l18.918"></a><span id="l18.918" class="difflineminus">-        }</span>
<a href="#l18.919"></a><span id="l18.919" class="difflineplus">+                  if (!this.hasAttribute(&quot;dropbox&quot;) || this.getAttribute(&quot;dropbox&quot;) == &quot;false&quot;) {</span>
<a href="#l18.920"></a><span id="l18.920" class="difflineplus">+                      // As it turned out it was not possible to remove the remaining dropshadows</span>
<a href="#l18.921"></a><span id="l18.921" class="difflineplus">+                      // at the &quot;dragleave&quot; or &quot;dragexit&quot; event, majorly because it was not reliably</span>
<a href="#l18.922"></a><span id="l18.922" class="difflineplus">+                      // fired. As the dragndropcontainer may be anonymous it is further on not</span>
<a href="#l18.923"></a><span id="l18.923" class="difflineplus">+                      // possible to remove the dropshadows by something like</span>
<a href="#l18.924"></a><span id="l18.924" class="difflineplus">+                      // &quot;document.getElementsByAttribute('dropbox').removeDropShadows();&quot;;</span>
<a href="#l18.925"></a><span id="l18.925" class="difflineplus">+                      // So we have to remove them at the currentView(). The restriction of course is</span>
<a href="#l18.926"></a><span id="l18.926" class="difflineplus">+                      // that these containers so far may not be used for drag and drop from/to e.g.</span>
<a href="#l18.927"></a><span id="l18.927" class="difflineplus">+                      // the today-pane.</span>
<a href="#l18.928"></a><span id="l18.928" class="difflineplus">+                      currentView().removeDropShadows();</span>
<a href="#l18.929"></a><span id="l18.929" class="difflineplus">+                  }</span>
<a href="#l18.930"></a><span id="l18.930" class="difflineplus">+                  this.setAttribute(&quot;dropbox&quot;, &quot;true&quot;);</span>
<a href="#l18.931"></a><span id="l18.931" class="difflineplus">+              }</span>
<a href="#l18.932"></a><span id="l18.932" class="difflineplus">+          }</span>
<a href="#l18.933"></a><span id="l18.933">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.934"></a><span id="l18.934"> </span>
<a href="#l18.935"></a><span id="l18.935">       &lt;handler event=&quot;drop&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.936"></a><span id="l18.936" class="difflineminus">-        let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.937"></a><span id="l18.937" class="difflineminus">-        if (!session || !session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.938"></a><span id="l18.938" class="difflineminus">-            // No source node? Not our drag.</span>
<a href="#l18.939"></a><span id="l18.939" class="difflineminus">-            return;</span>
<a href="#l18.940"></a><span id="l18.940" class="difflineminus">-        }</span>
<a href="#l18.941"></a><span id="l18.941" class="difflineminus">-        let item = session.sourceNode.sourceObject.clone();</span>
<a href="#l18.942"></a><span id="l18.942" class="difflineminus">-        this.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l18.943"></a><span id="l18.943" class="difflineminus">-        let transfer = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l18.944"></a><span id="l18.944" class="difflineminus">-                                 .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l18.945"></a><span id="l18.945" class="difflineminus">-        transfer.init(null);</span>
<a href="#l18.946"></a><span id="l18.946" class="difflineplus">+          let session = cal.getDragService().getCurrentSession();</span>
<a href="#l18.947"></a><span id="l18.947" class="difflineplus">+          if (!session || !session.sourceNode || !session.sourceNode.sourceObject) {</span>
<a href="#l18.948"></a><span id="l18.948" class="difflineplus">+              // No source node? Not our drag.</span>
<a href="#l18.949"></a><span id="l18.949" class="difflineplus">+              return;</span>
<a href="#l18.950"></a><span id="l18.950" class="difflineplus">+          }</span>
<a href="#l18.951"></a><span id="l18.951" class="difflineplus">+          let item = session.sourceNode.sourceObject.clone();</span>
<a href="#l18.952"></a><span id="l18.952" class="difflineplus">+          this.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l18.953"></a><span id="l18.953" class="difflineplus">+          let transfer = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l18.954"></a><span id="l18.954" class="difflineplus">+                                   .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l18.955"></a><span id="l18.955" class="difflineplus">+          transfer.init(null);</span>
<a href="#l18.956"></a><span id="l18.956"> </span>
<a href="#l18.957"></a><span id="l18.957" class="difflineminus">-        if (cal.isEvent(item)) {</span>
<a href="#l18.958"></a><span id="l18.958" class="difflineminus">-            transfer.addDataFlavor(&quot;application/x-moz-cal-event&quot;);</span>
<a href="#l18.959"></a><span id="l18.959" class="difflineminus">-        } else {</span>
<a href="#l18.960"></a><span id="l18.960" class="difflineminus">-            transfer.addDataFlavor(&quot;application/x-moz-cal-task&quot;);</span>
<a href="#l18.961"></a><span id="l18.961" class="difflineminus">-        }</span>
<a href="#l18.962"></a><span id="l18.962" class="difflineplus">+          if (cal.isEvent(item)) {</span>
<a href="#l18.963"></a><span id="l18.963" class="difflineplus">+              transfer.addDataFlavor(&quot;application/x-moz-cal-event&quot;);</span>
<a href="#l18.964"></a><span id="l18.964" class="difflineplus">+          } else {</span>
<a href="#l18.965"></a><span id="l18.965" class="difflineplus">+              transfer.addDataFlavor(&quot;application/x-moz-cal-task&quot;);</span>
<a href="#l18.966"></a><span id="l18.966" class="difflineplus">+          }</span>
<a href="#l18.967"></a><span id="l18.967"> </span>
<a href="#l18.968"></a><span id="l18.968" class="difflineminus">-        session.getData(transfer, 0);</span>
<a href="#l18.969"></a><span id="l18.969" class="difflineminus">-        item = session.sourceNode.sourceObject;</span>
<a href="#l18.970"></a><span id="l18.970" class="difflineplus">+          session.getData(transfer, 0);</span>
<a href="#l18.971"></a><span id="l18.971" class="difflineplus">+          item = session.sourceNode.sourceObject;</span>
<a href="#l18.972"></a><span id="l18.972"> </span>
<a href="#l18.973"></a><span id="l18.973" class="difflineminus">-        let newItem = this.onDropItem(item).clone();</span>
<a href="#l18.974"></a><span id="l18.974" class="difflineminus">-        let newStart = newItem.startDate || newItem.entryDate || newItem.dueDate;</span>
<a href="#l18.975"></a><span id="l18.975" class="difflineminus">-        let newEnd = newItem.endDate || newItem.dueDate || newItem.entryDate;</span>
<a href="#l18.976"></a><span id="l18.976" class="difflineminus">-        let offset = this.calendarView.mShadowOffset;</span>
<a href="#l18.977"></a><span id="l18.977" class="difflineminus">-        newStart.addDuration(offset);</span>
<a href="#l18.978"></a><span id="l18.978" class="difflineminus">-        newEnd.addDuration(offset);</span>
<a href="#l18.979"></a><span id="l18.979" class="difflineminus">-        this.calendarView.controller.modifyOccurrence(item, newStart, newEnd);</span>
<a href="#l18.980"></a><span id="l18.980" class="difflineplus">+          let newItem = this.onDropItem(item).clone();</span>
<a href="#l18.981"></a><span id="l18.981" class="difflineplus">+          let newStart = newItem.startDate || newItem.entryDate || newItem.dueDate;</span>
<a href="#l18.982"></a><span id="l18.982" class="difflineplus">+          let newEnd = newItem.endDate || newItem.dueDate || newItem.entryDate;</span>
<a href="#l18.983"></a><span id="l18.983" class="difflineplus">+          let offset = this.calendarView.mShadowOffset;</span>
<a href="#l18.984"></a><span id="l18.984" class="difflineplus">+          newStart.addDuration(offset);</span>
<a href="#l18.985"></a><span id="l18.985" class="difflineplus">+          newEnd.addDuration(offset);</span>
<a href="#l18.986"></a><span id="l18.986" class="difflineplus">+          this.calendarView.controller.modifyOccurrence(item, newStart, newEnd);</span>
<a href="#l18.987"></a><span id="l18.987"> </span>
<a href="#l18.988"></a><span id="l18.988" class="difflineminus">-        // We handled the event</span>
<a href="#l18.989"></a><span id="l18.989" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l18.990"></a><span id="l18.990" class="difflineplus">+          // We handled the event</span>
<a href="#l18.991"></a><span id="l18.991" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l18.992"></a><span id="l18.992">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.993"></a><span id="l18.993"> </span>
<a href="#l18.994"></a><span id="l18.994">       &lt;handler event=&quot;dragend&quot;&gt;&lt;![CDATA[</span>
<a href="#l18.995"></a><span id="l18.995" class="difflineminus">-        currentView().removeDropShadows();</span>
<a href="#l18.996"></a><span id="l18.996" class="difflineplus">+          currentView().removeDropShadows();</span>
<a href="#l18.997"></a><span id="l18.997">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l18.998"></a><span id="l18.998">     &lt;/handlers&gt;</span>
<a href="#l18.999"></a><span id="l18.999">   &lt;/binding&gt;</span>
<a href="#l18.1000"></a><span id="l18.1000"> </span>
<a href="#l18.1001"></a><span id="l18.1001">   &lt;binding id=&quot;view-tab&quot; extends=&quot;chrome://global/content/bindings/tabbox.xml#tab&quot;&gt;</span>
<a href="#l18.1002"></a><span id="l18.1002">     &lt;resources&gt;</span>
<a href="#l18.1003"></a><span id="l18.1003">       &lt;stylesheet src=&quot;chrome://calendar/skin/widgets/calendar-widgets.css&quot;/&gt;</span>
<a href="#l18.1004"></a><span id="l18.1004">     &lt;/resources&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -129,194 +129,194 @@</span>
<a href="#l19.4"></a><span id="l19.4">       &lt;/xul:popupset&gt;</span>
<a href="#l19.5"></a><span id="l19.5">     &lt;/content&gt;</span>
<a href="#l19.6"></a><span id="l19.6">     &lt;implementation&gt;</span>
<a href="#l19.7"></a><span id="l19.7">       &lt;field name=&quot;kMinimonth&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.8"></a><span id="l19.8">       &lt;field name=&quot;mPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.9"></a><span id="l19.9">       &lt;field name=&quot;mScrollYearsHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.10"></a><span id="l19.10">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l19.11"></a><span id="l19.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-        this.kMinimonth = cal.getParentNodeOrThis(this, &quot;minimonth&quot;);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;back-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;today-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;forward-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+          this.kMinimonth = cal.getParentNodeOrThis(this, &quot;minimonth&quot;);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;back-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;today-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;forward-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-        this.mScrollYearsHandler = this.scrollYears.bind(this);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;)</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-                .addEventListener(&quot;wheel&quot;, this.mScrollYearsHandler, true);</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+          this.mScrollYearsHandler = this.scrollYears.bind(this);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;)</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+                  .addEventListener(&quot;wheel&quot;, this.mScrollYearsHandler, true);</span>
<a href="#l19.30"></a><span id="l19.30">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;)</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-                .removeEventListener(&quot;wheel&quot;, this.mScrollYearsHandler, true);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-        this.mScrollYearsHandler = null;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;)</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+                  .removeEventListener(&quot;wheel&quot;, this.mScrollYearsHandler, true);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+          this.mScrollYearsHandler = null;</span>
<a href="#l19.39"></a><span id="l19.39">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l19.40"></a><span id="l19.40"> </span>
<a href="#l19.41"></a><span id="l19.41">       &lt;method name=&quot;showPopupList&quot;&gt;</span>
<a href="#l19.42"></a><span id="l19.42">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l19.43"></a><span id="l19.43">         &lt;parameter name=&quot;aPopupAnonId&quot;/&gt;</span>
<a href="#l19.44"></a><span id="l19.44">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-          // Close open popups (if any), to prevent linux crashes</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-          if (this.mPopup) {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-              this.mPopup.hidePopup();</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-          }</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-          this.mPopup = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, aPopupAnonId);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-          this.mPopup.openPopup(aEvent.target, &quot;after_start&quot;);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+            // Close open popups (if any), to prevent linux crashes</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+            if (this.mPopup) {</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+                this.mPopup.hidePopup();</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+            }</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+            this.mPopup = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, aPopupAnonId);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+            this.mPopup.openPopup(aEvent.target, &quot;after_start&quot;);</span>
<a href="#l19.57"></a><span id="l19.57">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.58"></a><span id="l19.58">       &lt;/method&gt;</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60">       &lt;method name=&quot;hidePopupList&quot;&gt;</span>
<a href="#l19.61"></a><span id="l19.61">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-          // Close open popups (if any)</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-          let popup = this.mPopup;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-          this.mPopup = null;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-          if (popup) {</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-              popup.hidePopup();</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-          }</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+            // Close open popups (if any)</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+            let popup = this.mPopup;</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+            this.mPopup = null;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+            if (popup) {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+                popup.hidePopup();</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+            }</span>
<a href="#l19.74"></a><span id="l19.74">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.75"></a><span id="l19.75">       &lt;/method&gt;</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77">       &lt;method name=&quot;firePopupListHidden&quot;&gt;</span>
<a href="#l19.78"></a><span id="l19.78">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-          if (this.mPopup) {</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-              this.mPopup = null;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-              this.kMinimonth.fireEvent(&quot;popuplisthidden&quot;);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-          }</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+            if (this.mPopup) {</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+                this.mPopup = null;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+                this.kMinimonth.fireEvent(&quot;popuplisthidden&quot;);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+            }</span>
<a href="#l19.87"></a><span id="l19.87">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.88"></a><span id="l19.88">       &lt;/method&gt;</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90">       &lt;method name=&quot;onMonthsPopupCommand&quot;&gt;</span>
<a href="#l19.91"></a><span id="l19.91">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l19.92"></a><span id="l19.92">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-          let popup = cal.getParentNodeOrThis(aItem, &quot;menupopup&quot;);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-          let triggerNode = popup.triggerNode || popup.anchorNode;</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-          let deck = triggerNode.parentNode;</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+            let popup = cal.getParentNodeOrThis(aItem, &quot;menupopup&quot;);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+            let triggerNode = popup.triggerNode || popup.anchorNode;</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+            let deck = triggerNode.parentNode;</span>
<a href="#l19.99"></a><span id="l19.99"> </span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-          this.hidePopupList();</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-          this.kMinimonth.switchMonth(aItem.getAttribute(&quot;index&quot;));</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+            this.hidePopupList();</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+            this.kMinimonth.switchMonth(aItem.getAttribute(&quot;index&quot;));</span>
<a href="#l19.104"></a><span id="l19.104"> </span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-          deck.childNodes[deck.selectedIndex].focus();</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+            deck.childNodes[deck.selectedIndex].focus();</span>
<a href="#l19.107"></a><span id="l19.107">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.108"></a><span id="l19.108">       &lt;/method&gt;</span>
<a href="#l19.109"></a><span id="l19.109"> </span>
<a href="#l19.110"></a><span id="l19.110">       &lt;method name=&quot;onYearsPopupCommand&quot;&gt;</span>
<a href="#l19.111"></a><span id="l19.111">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l19.112"></a><span id="l19.112">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-          this.hidePopupList();</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-          let value = aItem.getAttribute(&quot;label&quot;);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-          if (value) {</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-              this.kMinimonth.switchYear(value);</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-          }</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+            this.hidePopupList();</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+            let value = aItem.getAttribute(&quot;label&quot;);</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+            if (value) {</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+                this.kMinimonth.switchYear(value);</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+            }</span>
<a href="#l19.123"></a><span id="l19.123">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.124"></a><span id="l19.124">       &lt;/method&gt;</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126">       &lt;method name=&quot;updateMonthPopup&quot;&gt;</span>
<a href="#l19.127"></a><span id="l19.127">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.128"></a><span id="l19.128">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-          let months = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;months-popup&quot;).childNodes;</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-          let month = aDate.getMonth();</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-          for (let i = 0; i &lt; months.length; i++) {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-              months[i].setAttribute(&quot;current&quot;, i == month ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-          }</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+            let months = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;months-popup&quot;).childNodes;</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+            let month = aDate.getMonth();</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+            for (let i = 0; i &lt; months.length; i++) {</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+                months[i].setAttribute(&quot;current&quot;, i == month ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+            }</span>
<a href="#l19.139"></a><span id="l19.139">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.140"></a><span id="l19.140">       &lt;/method&gt;</span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142">       &lt;method name=&quot;updateYearPopup&quot;&gt;</span>
<a href="#l19.143"></a><span id="l19.143">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.144"></a><span id="l19.144">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-          let years = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;).childNodes;</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-          let year = new Date(aDate);</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-          let compFullYear = aDate.getFullYear();</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-          year.setFullYear(Math.max(1, compFullYear - Math.trunc(years.length / 2) + 1));</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-          for (let i = 1; i &lt; years.length - 1; i++) {</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-              let curfullYear = year.getFullYear();</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-              years[i].setAttribute(&quot;label&quot;, curfullYear);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-              years[i].setAttribute(&quot;current&quot;, curfullYear == compFullYear ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-              year.setFullYear(curfullYear + 1);</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-          }</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+            let years = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;).childNodes;</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+            let year = new Date(aDate);</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+            let compFullYear = aDate.getFullYear();</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+            year.setFullYear(Math.max(1, compFullYear - Math.trunc(years.length / 2) + 1));</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+            for (let i = 1; i &lt; years.length - 1; i++) {</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+                let curfullYear = year.getFullYear();</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+                years[i].setAttribute(&quot;label&quot;, curfullYear);</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+                years[i].setAttribute(&quot;current&quot;, curfullYear == compFullYear ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+                year.setFullYear(curfullYear + 1);</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+            }</span>
<a href="#l19.165"></a><span id="l19.165">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.166"></a><span id="l19.166">       &lt;/method&gt;</span>
<a href="#l19.167"></a><span id="l19.167"> </span>
<a href="#l19.168"></a><span id="l19.168">       &lt;method name=&quot;scrollYears&quot;&gt;</span>
<a href="#l19.169"></a><span id="l19.169">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l19.170"></a><span id="l19.170">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-          let yearPopup = cal.getParentNodeOrThis(event.target, &quot;menupopup&quot;);</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-          const pixelThreshold = 75;</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-          if (yearPopup) {</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-              let monthList = yearPopup.getElementsByAttribute(&quot;class&quot;, &quot;minimonth-list&quot;);</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-              if (monthList &amp;&amp; monthList.length &gt; 0) {</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-                  if (event.deltaMode == event.DOM_DELTA_PAGE) {</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-                      let dir = event.deltaY &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-                      this.moveYears(dir, Math.abs(event.deltaY) * monthList.length);</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-                  } else if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-                      let dir = event.deltaY &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-                      this.moveYears(dir, 1);</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-                  } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-                      this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-                      if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-                          this.moveYears(&quot;down&quot;, 1);</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-                          this.mPixelScrollDelta = 0;</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-                      } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-                          this.moveYears(&quot;up&quot;, 1);</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-                          this.mPixelScrollDelta = 0;</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-                      }</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-                  }</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineplus">+            let yearPopup = cal.getParentNodeOrThis(event.target, &quot;menupopup&quot;);</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+            const pixelThreshold = 75;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+            if (yearPopup) {</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+                let monthList = yearPopup.getElementsByAttribute(&quot;class&quot;, &quot;minimonth-list&quot;);</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+                if (monthList &amp;&amp; monthList.length &gt; 0) {</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+                    if (event.deltaMode == event.DOM_DELTA_PAGE) {</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+                        let dir = event.deltaY &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+                        this.moveYears(dir, Math.abs(event.deltaY) * monthList.length);</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+                    } else if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+                        let dir = event.deltaY &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+                        this.moveYears(dir, 1);</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+                    } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+                        this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+                        if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+                            this.moveYears(&quot;down&quot;, 1);</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineplus">+                            this.mPixelScrollDelta = 0;</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+                        } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+                            this.moveYears(&quot;up&quot;, 1);</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+                            this.mPixelScrollDelta = 0;</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+                        }</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+                    }</span>
<a href="#l19.213"></a><span id="l19.213"> </span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-                  event.stopPropagation();</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-                  event.preventDefault();</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-              }</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-          }</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+                    event.stopPropagation();</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+                    event.preventDefault();</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+                }</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+            }</span>
<a href="#l19.222"></a><span id="l19.222">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.223"></a><span id="l19.223">       &lt;/method&gt;</span>
<a href="#l19.224"></a><span id="l19.224"> </span>
<a href="#l19.225"></a><span id="l19.225">       &lt;method name=&quot;moveYears&quot;&gt;</span>
<a href="#l19.226"></a><span id="l19.226">         &lt;parameter name=&quot;direction&quot;/&gt;</span>
<a href="#l19.227"></a><span id="l19.227">         &lt;parameter name=&quot;scrollOffset&quot;/&gt;</span>
<a href="#l19.228"></a><span id="l19.228">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineminus">-          // Update the year popup</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineminus">-          let years = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;).childNodes;</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineminus">-          let current = this.getAttribute(&quot;year&quot;);</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-          let offset;</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-          switch (direction) {</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-              case &quot;reset&quot;: {</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-                  let middleyear = years[Math.floor(years.length / 2)].getAttribute(&quot;label&quot;);</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-                  if (current &lt;= (years.length / 2)) {</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-                      offset = 1 - years[1].getAttribute(&quot;label&quot;);</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-                  } else {</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineminus">-                      offset = current - middleyear;</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-                  }</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-                  break;</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-              }</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-              case &quot;up&quot;: {</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-                  offset = -Math.abs(scrollOffset) || -1;</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-                  break;</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-              }</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-              case &quot;down&quot;: {</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-                  offset = Math.abs(scrollOffset) || 1;</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-                  break;</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-              }</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-          }</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+            // Update the year popup</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+            let years = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;).childNodes;</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+            let current = this.getAttribute(&quot;year&quot;);</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+            let offset;</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+            switch (direction) {</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+                case &quot;reset&quot;: {</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+                    let middleyear = years[Math.floor(years.length / 2)].getAttribute(&quot;label&quot;);</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+                    if (current &lt;= (years.length / 2)) {</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+                        offset = 1 - years[1].getAttribute(&quot;label&quot;);</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineplus">+                    } else {</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+                        offset = current - middleyear;</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+                    }</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+                    break;</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+                }</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+                case &quot;up&quot;: {</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineplus">+                    offset = -Math.abs(scrollOffset) || -1;</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineplus">+                    break;</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineplus">+                }</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineplus">+                case &quot;down&quot;: {</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineplus">+                    offset = Math.abs(scrollOffset) || 1;</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineplus">+                    break;</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+                }</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+            }</span>
<a href="#l19.275"></a><span id="l19.275"> </span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-          // Disable the up arrow when we get to the year 1.</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-          years[0].disabled = parseInt(years[1].getAttribute(&quot;label&quot;), 10) + offset &lt; 2;</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+            // Disable the up arrow when we get to the year 1.</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineplus">+            years[0].disabled = parseInt(years[1].getAttribute(&quot;label&quot;), 10) + offset &lt; 2;</span>
<a href="#l19.280"></a><span id="l19.280"> </span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-          if (!offset) {</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-              // No need to loop through when the offset is zero.</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-              return;</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-          }</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+            if (!offset) {</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+                // No need to loop through when the offset is zero.</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineplus">+                return;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+            }</span>
<a href="#l19.289"></a><span id="l19.289"> </span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-          // Go through all visible years and set the new value. Be sure to</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-          // skip the autorepeatbuttons.</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-          for (let i = 1; i &lt; years.length - 1; i++) {</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-              let value = parseInt(years[i].getAttribute(&quot;label&quot;), 10) + offset;</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-              years[i].setAttribute(&quot;label&quot;, value);</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-              years[i].setAttribute(&quot;current&quot;, value == current ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-          }</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+            // Go through all visible years and set the new value. Be sure to</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+            // skip the autorepeatbuttons.</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+            for (let i = 1; i &lt; years.length - 1; i++) {</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+                let value = parseInt(years[i].getAttribute(&quot;label&quot;), 10) + offset;</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+                years[i].setAttribute(&quot;label&quot;, value);</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+                years[i].setAttribute(&quot;current&quot;, value == current ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+            }</span>
<a href="#l19.304"></a><span id="l19.304">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.305"></a><span id="l19.305">       &lt;/method&gt;</span>
<a href="#l19.306"></a><span id="l19.306">     &lt;/implementation&gt;</span>
<a href="#l19.307"></a><span id="l19.307"> </span>
<a href="#l19.308"></a><span id="l19.308">     &lt;handlers&gt;</span>
<a href="#l19.309"></a><span id="l19.309">       &lt;handler event=&quot;bindingattached&quot; action=&quot;this.initialize();&quot;/&gt;</span>
<a href="#l19.310"></a><span id="l19.310">     &lt;/handlers&gt;</span>
<a href="#l19.311"></a><span id="l19.311">   &lt;/binding&gt;</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineat">@@ -409,75 +409,75 @@</span>
<a href="#l19.313"></a><span id="l19.313"> </span>
<a href="#l19.314"></a><span id="l19.314">       &lt;property name=&quot;extra&quot;</span>
<a href="#l19.315"></a><span id="l19.315">                 onget=&quot;return this.mExtraDate&quot;</span>
<a href="#l19.316"></a><span id="l19.316">                 onset=&quot;this.mExtraDate = val&quot;/&gt;</span>
<a href="#l19.317"></a><span id="l19.317"> </span>
<a href="#l19.318"></a><span id="l19.318">        &lt;!--returns the first (inclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l19.319"></a><span id="l19.319">       &lt;property name=&quot;firstDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l19.320"></a><span id="l19.320">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-          let date = this._getCalBoxNode(1, 1).date;</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-          return cal.jsDateToDateTime(date);</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+            let date = this._getCalBoxNode(1, 1).date;</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+            return cal.jsDateToDateTime(date);</span>
<a href="#l19.325"></a><span id="l19.325">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l19.326"></a><span id="l19.326">       &lt;/property&gt;</span>
<a href="#l19.327"></a><span id="l19.327"> </span>
<a href="#l19.328"></a><span id="l19.328">        &lt;!--returns the last (exclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l19.329"></a><span id="l19.329">       &lt;property name=&quot;lastDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l19.330"></a><span id="l19.330">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-          let date = this._getCalBoxNode(6, 7).date;</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-          let lastDateTime = cal.jsDateToDateTime(date);</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-          lastDateTime.day = lastDateTime.day + 1;</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineminus">-          return lastDateTime;</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineplus">+            let date = this._getCalBoxNode(6, 7).date;</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+            let lastDateTime = cal.jsDateToDateTime(date);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+            lastDateTime.day = lastDateTime.day + 1;</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+            return lastDateTime;</span>
<a href="#l19.339"></a><span id="l19.339">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l19.340"></a><span id="l19.340">       &lt;/property&gt;</span>
<a href="#l19.341"></a><span id="l19.341"> </span>
<a href="#l19.342"></a><span id="l19.342">       &lt;field name=&quot;mDaymap&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.343"></a><span id="l19.343">       &lt;field name=&quot;mValue&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.344"></a><span id="l19.344">       &lt;field name=&quot;mEditorDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.345"></a><span id="l19.345">       &lt;field name=&quot;mExtraDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l19.346"></a><span id="l19.346">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l19.347"></a><span id="l19.347">       &lt;field name=&quot;mIsReadOnly&quot;&gt;false&lt;/field&gt;</span>
<a href="#l19.348"></a><span id="l19.348">       &lt;field name=&quot;mObservesComposite&quot;&gt;false&lt;/field&gt;</span>
<a href="#l19.349"></a><span id="l19.349">       &lt;field name=&quot;mShowWeekNumber&quot;&gt;true&lt;/field&gt;</span>
<a href="#l19.350"></a><span id="l19.350"> </span>
<a href="#l19.351"></a><span id="l19.351">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.358"></a><span id="l19.358"> </span>
<a href="#l19.359"></a><span id="l19.359" class="difflineminus">-        this.mToday = false;</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-        this.mSelected = false;</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-        this.mExtra = false;</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineminus">-        this.mValue = new Date(); // Default to &quot;today&quot;</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineminus">-        this.mFocused = null;</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineminus">-        // save references for convenience</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineminus">-        if (this.hasAttribute(&quot;readonly&quot;)) {</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineminus">-            this.mIsReadOnly = this.getAttribute(&quot;readonly&quot;) == &quot;true&quot;;</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineminus">-        }</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineminus">-        this.refreshDisplay();</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineminus">-        if (this.hasAttribute(&quot;freebusy&quot;)) {</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineminus">-            this._setFreeBusy(this.getAttribute(&quot;freebusy&quot;) == &quot;true&quot;);</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineminus">-        }</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineminus">-        this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineplus">+          this.mToday = false;</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+          this.mSelected = false;</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+          this.mExtra = false;</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineplus">+          this.mValue = new Date(); // Default to &quot;today&quot;</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineplus">+          this.mFocused = null;</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+          // save references for convenience</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+          if (this.hasAttribute(&quot;readonly&quot;)) {</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+              this.mIsReadOnly = this.getAttribute(&quot;readonly&quot;) == &quot;true&quot;;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+          }</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineplus">+          this.refreshDisplay();</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+          if (this.hasAttribute(&quot;freebusy&quot;)) {</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+              this._setFreeBusy(this.getAttribute(&quot;freebusy&quot;) == &quot;true&quot;);</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+          }</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineplus">+          this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l19.387"></a><span id="l19.387"> </span>
<a href="#l19.388"></a><span id="l19.388" class="difflineminus">-        // Add pref observer</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-        let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-        branch.addObserver(&quot;calendar.&quot;, this);</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineplus">+          // Add pref observer</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+          branch.addObserver(&quot;calendar.&quot;, this);</span>
<a href="#l19.394"></a><span id="l19.394">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l19.395"></a><span id="l19.395"> </span>
<a href="#l19.396"></a><span id="l19.396">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.399"></a><span id="l19.399"> </span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-        if (this.mObservesComposite == true) {</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-            cal.getCompositeCalendar(window).removeObserver(this);</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-        }</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineplus">+          if (this.mObservesComposite == true) {</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineplus">+              cal.getCompositeCalendar(window).removeObserver(this);</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineplus">+          }</span>
<a href="#l19.406"></a><span id="l19.406"> </span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-        // Remove pref observer</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineminus">-        let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineminus">-        branch.removeObserver(&quot;calendar.&quot;, this);</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineplus">+          // Remove pref observer</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+          branch.removeObserver(&quot;calendar.&quot;, this);</span>
<a href="#l19.413"></a><span id="l19.413">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l19.414"></a><span id="l19.414"> </span>
<a href="#l19.415"></a><span id="l19.415">       &lt;!-- calIOperationListener methods --&gt;</span>
<a href="#l19.416"></a><span id="l19.416">       &lt;method name=&quot;onOperationComplete&quot;&gt;</span>
<a href="#l19.417"></a><span id="l19.417">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.418"></a><span id="l19.418">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l19.419"></a><span id="l19.419">         &lt;parameter name=&quot;aOperationType&quot;/&gt;</span>
<a href="#l19.420"></a><span id="l19.420">         &lt;parameter name=&quot;aId&quot;/&gt;</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineat">@@ -489,129 +489,129 @@</span>
<a href="#l19.422"></a><span id="l19.422">       &lt;method name=&quot;onGetResult&quot;&gt;</span>
<a href="#l19.423"></a><span id="l19.423">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.424"></a><span id="l19.424">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l19.425"></a><span id="l19.425">         &lt;parameter name=&quot;aItemType&quot;/&gt;</span>
<a href="#l19.426"></a><span id="l19.426">         &lt;parameter name=&quot;aDetail&quot;/&gt;</span>
<a href="#l19.427"></a><span id="l19.427">         &lt;parameter name=&quot;aCount&quot;/&gt;</span>
<a href="#l19.428"></a><span id="l19.428">         &lt;parameter name=&quot;aItems&quot;/&gt;</span>
<a href="#l19.429"></a><span id="l19.429">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-          if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-              return;</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineminus">-          }</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-          for (let item of aItems) {</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-              this.setBusyDaysForOccurrence(item, true);</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineminus">-          }</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineplus">+            if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineplus">+                return;</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineplus">+            }</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineplus">+            for (let item of aItems) {</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineplus">+                this.setBusyDaysForOccurrence(item, true);</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+            }</span>
<a href="#l19.442"></a><span id="l19.442">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.443"></a><span id="l19.443">       &lt;/method&gt;</span>
<a href="#l19.444"></a><span id="l19.444"> </span>
<a href="#l19.445"></a><span id="l19.445">       &lt;method name=&quot;setBusyDaysForItem&quot;&gt;</span>
<a href="#l19.446"></a><span id="l19.446">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l19.447"></a><span id="l19.447">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l19.448"></a><span id="l19.448">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-          let items = [aItem];</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-          if (aItem.recurrenceInfo) {</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-              let startDate = this.firstDate;</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-              let endDate = this.lastDate;</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineminus">-              items = aItem.getOccurrencesBetween(startDate, endDate, {});</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineminus">-          }</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-          for (let item of items) {</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineminus">-              this.setBusyDaysForOccurrence(item, aState);</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-          }</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineplus">+            let items = [aItem];</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineplus">+            if (aItem.recurrenceInfo) {</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineplus">+                let startDate = this.firstDate;</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineplus">+                let endDate = this.lastDate;</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineplus">+                items = aItem.getOccurrencesBetween(startDate, endDate, {});</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineplus">+            }</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineplus">+            for (let item of items) {</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+                this.setBusyDaysForOccurrence(item, aState);</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+            }</span>
<a href="#l19.467"></a><span id="l19.467">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.468"></a><span id="l19.468">       &lt;/method&gt;</span>
<a href="#l19.469"></a><span id="l19.469"> </span>
<a href="#l19.470"></a><span id="l19.470">       &lt;method name=&quot;parseBoxBusy&quot;&gt;</span>
<a href="#l19.471"></a><span id="l19.471">         &lt;parameter name=&quot;aBox&quot;/&gt;</span>
<a href="#l19.472"></a><span id="l19.472">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineminus">-          let boxBusy = {};</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineplus">+            let boxBusy = {};</span>
<a href="#l19.475"></a><span id="l19.475"> </span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-          let busyStr = aBox.getAttribute(&quot;busy&quot;);</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineminus">-          if (busyStr &amp;&amp; busyStr.length &gt; 0) {</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineminus">-              let calChunks = busyStr.split(&quot;\u001A&quot;);</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineminus">-              for (let chunk of calChunks) {</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineminus">-                  let expr = chunk.split(&quot;=&quot;);</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-                  boxBusy[expr[0]] = parseInt(expr[1], 10);</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-              }</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineminus">-          }</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineplus">+            let busyStr = aBox.getAttribute(&quot;busy&quot;);</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineplus">+            if (busyStr &amp;&amp; busyStr.length &gt; 0) {</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineplus">+                let calChunks = busyStr.split(&quot;\u001A&quot;);</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+                for (let chunk of calChunks) {</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+                    let expr = chunk.split(&quot;=&quot;);</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineplus">+                    boxBusy[expr[0]] = parseInt(expr[1], 10);</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineplus">+                }</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineplus">+            }</span>
<a href="#l19.492"></a><span id="l19.492"> </span>
<a href="#l19.493"></a><span id="l19.493" class="difflineminus">-          return boxBusy;</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+            return boxBusy;</span>
<a href="#l19.495"></a><span id="l19.495">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.496"></a><span id="l19.496">       &lt;/method&gt;</span>
<a href="#l19.497"></a><span id="l19.497"> </span>
<a href="#l19.498"></a><span id="l19.498">       &lt;method name=&quot;updateBoxBusy&quot;&gt;</span>
<a href="#l19.499"></a><span id="l19.499">         &lt;parameter name=&quot;aBox&quot;/&gt;</span>
<a href="#l19.500"></a><span id="l19.500">         &lt;parameter name=&quot;aBoxBusy&quot;/&gt;</span>
<a href="#l19.501"></a><span id="l19.501">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineminus">-          let calChunks = [];</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+            let calChunks = [];</span>
<a href="#l19.504"></a><span id="l19.504"> </span>
<a href="#l19.505"></a><span id="l19.505" class="difflineminus">-          for (let calId in aBoxBusy) {</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineminus">-              if (aBoxBusy[calId]) {</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineminus">-                  calChunks.push(calId + &quot;=&quot; + aBoxBusy[calId]);</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineminus">-              }</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineminus">-          }</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+            for (let calId in aBoxBusy) {</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineplus">+                if (aBoxBusy[calId]) {</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineplus">+                    calChunks.push(calId + &quot;=&quot; + aBoxBusy[calId]);</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+                }</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+            }</span>
<a href="#l19.515"></a><span id="l19.515"> </span>
<a href="#l19.516"></a><span id="l19.516" class="difflineminus">-          if (calChunks.length &gt; 0) {</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineminus">-              let busyStr = calChunks.join(&quot;\u001A&quot;);</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineminus">-              aBox.setAttribute(&quot;busy&quot;, busyStr);</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineminus">-          } else {</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineminus">-              aBox.removeAttribute(&quot;busy&quot;);</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineminus">-          }</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineplus">+            if (calChunks.length &gt; 0) {</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineplus">+                let busyStr = calChunks.join(&quot;\u001A&quot;);</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineplus">+                aBox.setAttribute(&quot;busy&quot;, busyStr);</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineplus">+            } else {</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+                aBox.removeAttribute(&quot;busy&quot;);</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineplus">+            }</span>
<a href="#l19.528"></a><span id="l19.528">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.529"></a><span id="l19.529">       &lt;/method&gt;</span>
<a href="#l19.530"></a><span id="l19.530"> </span>
<a href="#l19.531"></a><span id="l19.531">       &lt;method name=&quot;removeCalendarFromBoxBusy&quot;&gt;</span>
<a href="#l19.532"></a><span id="l19.532">         &lt;parameter name=&quot;aBox&quot;/&gt;</span>
<a href="#l19.533"></a><span id="l19.533">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.534"></a><span id="l19.534">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineminus">-          let boxBusy = this.parseBoxBusy(aBox);</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineminus">-          if (boxBusy[aCalendar.id]) {</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineminus">-              delete boxBusy[aCalendar.id];</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineminus">-          }</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-          this.updateBoxBusy(aBox, boxBusy);</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+            let boxBusy = this.parseBoxBusy(aBox);</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineplus">+            if (boxBusy[aCalendar.id]) {</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineplus">+                delete boxBusy[aCalendar.id];</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineplus">+            }</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+            this.updateBoxBusy(aBox, boxBusy);</span>
<a href="#l19.545"></a><span id="l19.545">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.546"></a><span id="l19.546">       &lt;/method&gt;</span>
<a href="#l19.547"></a><span id="l19.547"> </span>
<a href="#l19.548"></a><span id="l19.548">       &lt;method name=&quot;setBusyDaysForOccurrence&quot;&gt;</span>
<a href="#l19.549"></a><span id="l19.549">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l19.550"></a><span id="l19.550">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l19.551"></a><span id="l19.551">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineminus">-          if (aOccurrence.getProperty(&quot;TRANSP&quot;) == &quot;TRANSPARENT&quot;) {</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineminus">-              // Skip transparent events</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineminus">-              return;</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineminus">-          }</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineminus">-          let start = aOccurrence[cal.calGetStartDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineminus">-          let end = aOccurrence[cal.calGetEndDateProp(aOccurrence)] || start;</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineminus">-          if (!start) {</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineminus">-              return;</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineminus">-          }</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+            if (aOccurrence.getProperty(&quot;TRANSP&quot;) == &quot;TRANSPARENT&quot;) {</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+                // Skip transparent events</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+                return;</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineplus">+            }</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineplus">+            let start = aOccurrence[cal.calGetStartDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineplus">+            let end = aOccurrence[cal.calGetEndDateProp(aOccurrence)] || start;</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineplus">+            if (!start) {</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+                return;</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+            }</span>
<a href="#l19.570"></a><span id="l19.570"> </span>
<a href="#l19.571"></a><span id="l19.571" class="difflineminus">-          // We need to compare with midnight of the current day, so reset the</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineminus">-          // time here.</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineminus">-          let current = start.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineminus">-          current.hour = 0;</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineminus">-          current.minute = 0;</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineminus">-          current.second = 0;</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineplus">+            // We need to compare with midnight of the current day, so reset the</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineplus">+            // time here.</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineplus">+            let current = start.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineplus">+            current.hour = 0;</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineplus">+            current.minute = 0;</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineplus">+            current.second = 0;</span>
<a href="#l19.583"></a><span id="l19.583"> </span>
<a href="#l19.584"></a><span id="l19.584" class="difflineminus">-          // Cache the result so the compare isn't called in each iteration.</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-          let compareResult = (start.compare(end) == 0 ? 1 : 0);</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+            // Cache the result so the compare isn't called in each iteration.</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineplus">+            let compareResult = (start.compare(end) == 0 ? 1 : 0);</span>
<a href="#l19.588"></a><span id="l19.588"> </span>
<a href="#l19.589"></a><span id="l19.589" class="difflineminus">-          // Setup the busy days.</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineminus">-          while (current.compare(end) &lt; compareResult) {</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineminus">-              let box = this.getBoxForDate(current);</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineminus">-              if (box) {</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineminus">-                  let busyCalendars = this.parseBoxBusy(box);</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineminus">-                  if (!busyCalendars[aOccurrence.calendar.id]) {</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineminus">-                      busyCalendars[aOccurrence.calendar.id] = 0;</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineminus">-                  }</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineminus">-                  busyCalendars[aOccurrence.calendar.id] += (aState ? 1 : -1);</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineminus">-                  this.updateBoxBusy(box, busyCalendars);</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineminus">-              }</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineminus">-              current.day++;</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineminus">-          }</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineplus">+            // Setup the busy days.</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+            while (current.compare(end) &lt; compareResult) {</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+                let box = this.getBoxForDate(current);</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+                if (box) {</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+                    let busyCalendars = this.parseBoxBusy(box);</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+                    if (!busyCalendars[aOccurrence.calendar.id]) {</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+                        busyCalendars[aOccurrence.calendar.id] = 0;</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+                    }</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+                    busyCalendars[aOccurrence.calendar.id] += (aState ? 1 : -1);</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+                    this.updateBoxBusy(box, busyCalendars);</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+                }</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+                current.day++;</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+            }</span>
<a href="#l19.615"></a><span id="l19.615">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.616"></a><span id="l19.616">       &lt;/method&gt;</span>
<a href="#l19.617"></a><span id="l19.617"> </span>
<a href="#l19.618"></a><span id="l19.618">        &lt;!--calIObserver methods --&gt;</span>
<a href="#l19.619"></a><span id="l19.619">       &lt;method name=&quot;onStartBatch&quot;&gt;</span>
<a href="#l19.620"></a><span id="l19.620">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.621"></a><span id="l19.621">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.622"></a><span id="l19.622">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineat">@@ -627,33 +627,33 @@</span>
<a href="#l19.624"></a><span id="l19.624">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.625"></a><span id="l19.625">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.626"></a><span id="l19.626">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.627"></a><span id="l19.627">       &lt;/method&gt;</span>
<a href="#l19.628"></a><span id="l19.628"> </span>
<a href="#l19.629"></a><span id="l19.629">       &lt;method name=&quot;onAddItem&quot;&gt;</span>
<a href="#l19.630"></a><span id="l19.630">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l19.631"></a><span id="l19.631">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineminus">-          this.setBusyDaysForItem(aItem, true);</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+            this.setBusyDaysForItem(aItem, true);</span>
<a href="#l19.634"></a><span id="l19.634">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.635"></a><span id="l19.635">       &lt;/method&gt;</span>
<a href="#l19.636"></a><span id="l19.636"> </span>
<a href="#l19.637"></a><span id="l19.637">       &lt;method name=&quot;onDeleteItem&quot;&gt;</span>
<a href="#l19.638"></a><span id="l19.638">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l19.639"></a><span id="l19.639">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineminus">-          this.setBusyDaysForItem(aItem, false);</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+            this.setBusyDaysForItem(aItem, false);</span>
<a href="#l19.642"></a><span id="l19.642">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.643"></a><span id="l19.643">       &lt;/method&gt;</span>
<a href="#l19.644"></a><span id="l19.644"> </span>
<a href="#l19.645"></a><span id="l19.645">       &lt;method name=&quot;onModifyItem&quot;&gt;</span>
<a href="#l19.646"></a><span id="l19.646">         &lt;parameter name=&quot;aNewItem&quot;/&gt;</span>
<a href="#l19.647"></a><span id="l19.647">         &lt;parameter name=&quot;aOldItem&quot;/&gt;</span>
<a href="#l19.648"></a><span id="l19.648">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineminus">-          this.setBusyDaysForItem(aOldItem, false);</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineminus">-          this.setBusyDaysForItem(aNewItem, true);</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+            this.setBusyDaysForItem(aOldItem, false);</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+            this.setBusyDaysForItem(aNewItem, true);</span>
<a href="#l19.653"></a><span id="l19.653">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.654"></a><span id="l19.654">       &lt;/method&gt;</span>
<a href="#l19.655"></a><span id="l19.655"> </span>
<a href="#l19.656"></a><span id="l19.656">       &lt;method name=&quot;onError&quot;&gt;</span>
<a href="#l19.657"></a><span id="l19.657">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.658"></a><span id="l19.658">         &lt;parameter name=&quot;aErrNo&quot;/&gt;</span>
<a href="#l19.659"></a><span id="l19.659">         &lt;parameter name=&quot;aMessage&quot;/&gt;</span>
<a href="#l19.660"></a><span id="l19.660">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineat">@@ -661,678 +661,678 @@</span>
<a href="#l19.662"></a><span id="l19.662">       &lt;/method&gt;</span>
<a href="#l19.663"></a><span id="l19.663"> </span>
<a href="#l19.664"></a><span id="l19.664">       &lt;method name=&quot;onPropertyChanged&quot;&gt;</span>
<a href="#l19.665"></a><span id="l19.665">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.666"></a><span id="l19.666">         &lt;parameter name=&quot;aName&quot;/&gt;</span>
<a href="#l19.667"></a><span id="l19.667">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l19.668"></a><span id="l19.668">         &lt;parameter name=&quot;aOldValue&quot;/&gt;</span>
<a href="#l19.669"></a><span id="l19.669">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineminus">-          switch (aName) {</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineminus">-              case &quot;disabled&quot;:</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineminus">-                  this.resetAttributesForDate();</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineminus">-                  this.getItems();</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineminus">-                  break;</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineminus">-          }</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineplus">+            switch (aName) {</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+                case &quot;disabled&quot;:</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+                    this.resetAttributesForDate();</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+                    this.getItems();</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+                    break;</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+            }</span>
<a href="#l19.682"></a><span id="l19.682">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.683"></a><span id="l19.683">       &lt;/method&gt;</span>
<a href="#l19.684"></a><span id="l19.684"> </span>
<a href="#l19.685"></a><span id="l19.685">       &lt;method name=&quot;onPropertyDeleting&quot;&gt;</span>
<a href="#l19.686"></a><span id="l19.686">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.687"></a><span id="l19.687">         &lt;parameter name=&quot;aName&quot;/&gt;</span>
<a href="#l19.688"></a><span id="l19.688">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-          this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineplus">+            this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l19.691"></a><span id="l19.691">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.692"></a><span id="l19.692">       &lt;/method&gt;</span>
<a href="#l19.693"></a><span id="l19.693"> </span>
<a href="#l19.694"></a><span id="l19.694">        &lt;!-- calICompositeObserver methods --&gt;</span>
<a href="#l19.695"></a><span id="l19.695">       &lt;method name=&quot;onCalendarAdded&quot;&gt;</span>
<a href="#l19.696"></a><span id="l19.696">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.697"></a><span id="l19.697">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.698"></a><span id="l19.698">             this.getItems(aCalendar);</span>
<a href="#l19.699"></a><span id="l19.699">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.700"></a><span id="l19.700">       &lt;/method&gt;</span>
<a href="#l19.701"></a><span id="l19.701"> </span>
<a href="#l19.702"></a><span id="l19.702">       &lt;method name=&quot;onCalendarRemoved&quot;&gt;</span>
<a href="#l19.703"></a><span id="l19.703">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.704"></a><span id="l19.704">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineminus">-          for (let day in this.mDayMap) {</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineminus">-              this.removeCalendarFromBoxBusy(this.mDayMap[day], aCalendar);</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineminus">-          }</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+            for (let day in this.mDayMap) {</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+                this.removeCalendarFromBoxBusy(this.mDayMap[day], aCalendar);</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+            }</span>
<a href="#l19.711"></a><span id="l19.711">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.712"></a><span id="l19.712">       &lt;/method&gt;</span>
<a href="#l19.713"></a><span id="l19.713"> </span>
<a href="#l19.714"></a><span id="l19.714">       &lt;method name=&quot;onDefaultCalendarChanged&quot;&gt;</span>
<a href="#l19.715"></a><span id="l19.715">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.716"></a><span id="l19.716">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.717"></a><span id="l19.717">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.718"></a><span id="l19.718">       &lt;/method&gt;</span>
<a href="#l19.719"></a><span id="l19.719"> </span>
<a href="#l19.720"></a><span id="l19.720">       &lt;!-- nsIObserver methods --&gt;</span>
<a href="#l19.721"></a><span id="l19.721">       &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l19.722"></a><span id="l19.722">         &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l19.723"></a><span id="l19.723">         &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l19.724"></a><span id="l19.724">         &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l19.725"></a><span id="l19.725">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineminus">-          switch (aData) {</span>
<a href="#l19.727"></a><span id="l19.727" class="difflineminus">-              case &quot;calendar.week.start&quot;:</span>
<a href="#l19.728"></a><span id="l19.728" class="difflineminus">-              case &quot;calendar.view-minimonth.showWeekNumber&quot;:</span>
<a href="#l19.729"></a><span id="l19.729" class="difflineminus">-                  this.refreshDisplay();</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineminus">-                  break;</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineminus">-          }</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineplus">+            switch (aData) {</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+                case &quot;calendar.week.start&quot;:</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineplus">+                case &quot;calendar.view-minimonth.showWeekNumber&quot;:</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineplus">+                    this.refreshDisplay();</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineplus">+                    break;</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineplus">+            }</span>
<a href="#l19.738"></a><span id="l19.738">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.739"></a><span id="l19.739">       &lt;/method&gt;</span>
<a href="#l19.740"></a><span id="l19.740"> </span>
<a href="#l19.741"></a><span id="l19.741">       &lt;method name=&quot;refreshDisplay&quot;&gt;</span>
<a href="#l19.742"></a><span id="l19.742">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineminus">-          // Find out which should be the first day of the week</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineminus">-          this.weekStart = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineminus">-          this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineminus">-          if (!this.mValue) {</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineminus">-              this.mValue = new Date();</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineminus">-          }</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineminus">-          this.setHeader();</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineminus">-          this.showMonth(this.mValue);</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineminus">-          this.updateAccessibleLabel();</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineplus">+            // Find out which should be the first day of the week</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineplus">+            this.weekStart = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineplus">+            this.mShowWeekNumber = Preferences.get(&quot;calendar.view-minimonth.showWeekNumber&quot;, true);</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineplus">+            if (!this.mValue) {</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineplus">+                this.mValue = new Date();</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineplus">+            }</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+            this.setHeader();</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineplus">+            this.showMonth(this.mValue);</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineplus">+            this.updateAccessibleLabel();</span>
<a href="#l19.761"></a><span id="l19.761">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.762"></a><span id="l19.762">       &lt;/method&gt;</span>
<a href="#l19.763"></a><span id="l19.763"> </span>
<a href="#l19.764"></a><span id="l19.764">       &lt;method name=&quot;_getCalBoxNode&quot;&gt;</span>
<a href="#l19.765"></a><span id="l19.765">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l19.766"></a><span id="l19.766">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l19.767"></a><span id="l19.767">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineminus">-          if (!this.mCalBox) {</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineminus">-              this.mCalBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineminus">-          }</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineminus">-          return this.mCalBox.children[aRow].children[aCol];</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+            if (!this.mCalBox) {</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineplus">+                this.mCalBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineplus">+            }</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineplus">+            return this.mCalBox.children[aRow].children[aCol];</span>
<a href="#l19.776"></a><span id="l19.776">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.777"></a><span id="l19.777">       &lt;/method&gt;</span>
<a href="#l19.778"></a><span id="l19.778"> </span>
<a href="#l19.779"></a><span id="l19.779">       &lt;method name=&quot;setHeader&quot;&gt;</span>
<a href="#l19.780"></a><span id="l19.780">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineminus">-          // Reset the headers</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineminus">-          let dayList = new Array(7);</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineminus">-          let longDayList = new Array(7);</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineminus">-          let tempDate = new Date();</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineminus">-          let i, j;</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineminus">-          let useOSFormat;</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineminus">-          tempDate.setDate(tempDate.getDate() - (tempDate.getDay() - this.weekStart));</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineminus">-          for (i = 0; i &lt; 7; i++) {</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineminus">-              // if available, use UILocale days, else operating system format</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineminus">-              try {</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineminus">-                  dayList[i] = cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineminus">-                               &quot;day.&quot; + (tempDate.getDay() + 1) + &quot;.short&quot;);</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineminus">-              } catch (e) {</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineminus">-                  dayList[i] = tempDate.toLocaleDateString(undefined, { weekday: &quot;short&quot; });</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineminus">-                  useOSFormat = true;</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineminus">-              }</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineminus">-              longDayList[i] = tempDate.toLocaleDateString(undefined, { weekday: &quot;long&quot; });</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineminus">-              tempDate.setDate(tempDate.getDate() + 1);</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineminus">-          }</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineplus">+            // Reset the headers</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineplus">+            let dayList = new Array(7);</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineplus">+            let longDayList = new Array(7);</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineplus">+            let tempDate = new Date();</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineplus">+            let i, j;</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+            let useOSFormat;</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineplus">+            tempDate.setDate(tempDate.getDate() - (tempDate.getDay() - this.weekStart));</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineplus">+            for (i = 0; i &lt; 7; i++) {</span>
<a href="#l19.808"></a><span id="l19.808" class="difflineplus">+                // if available, use UILocale days, else operating system format</span>
<a href="#l19.809"></a><span id="l19.809" class="difflineplus">+                try {</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineplus">+                    dayList[i] = cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineplus">+                                 &quot;day.&quot; + (tempDate.getDay() + 1) + &quot;.short&quot;);</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineplus">+                } catch (e) {</span>
<a href="#l19.813"></a><span id="l19.813" class="difflineplus">+                    dayList[i] = tempDate.toLocaleDateString(undefined, { weekday: &quot;short&quot; });</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineplus">+                    useOSFormat = true;</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineplus">+                }</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineplus">+                longDayList[i] = tempDate.toLocaleDateString(undefined, { weekday: &quot;long&quot; });</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineplus">+                tempDate.setDate(tempDate.getDate() + 1);</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineplus">+            }</span>
<a href="#l19.819"></a><span id="l19.819"> </span>
<a href="#l19.820"></a><span id="l19.820" class="difflineminus">-          if (useOSFormat) {</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-              // To keep datepicker popup compact, shrink localized weekday</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineminus">-              // abbreviations down to 1 or 2 chars so each column of week can</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineminus">-              // be as narrow as 2 digits.</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineminus">-              //</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineminus">-              // 1. Compute the minLength of the day name abbreviations.</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineminus">-              let minLength = dayList[0].length;</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineminus">-              for (i = 1; i &lt; dayList.length; i++) {</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineminus">-                  minLength = Math.min(minLength, dayList[i].length);</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineminus">-              }</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineminus">-              // 2. If some day name abbrev. is longer than 2 chars (not Catalan),</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineminus">-              //    and ALL localized day names share same prefix (as in Chinese),</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineminus">-              //    then trim shared &quot;day-&quot; prefix.</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineminus">-              if (dayList.some(dayAbbr =&gt; dayAbbr.length &gt; 2)) {</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineminus">-                  for (let endPrefix = 0; endPrefix &lt; minLength; endPrefix++) {</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineminus">-                      let suffix = dayList[0][endPrefix];</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineminus">-                      if (dayList.some(dayAbbr =&gt; dayAbbr[endPrefix] != suffix)) {</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineminus">-                          if (endPrefix &gt; 0) {</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineminus">-                              for (i = 0; i &lt; dayList.length; i++) { // trim prefix chars.</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineminus">-                                  dayList[i] = dayList[i].substring(endPrefix);</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineminus">-                              }</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineminus">-                          }</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineminus">-                          break;</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineminus">-                      }</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineminus">-                  }</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineminus">-              }</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineminus">-              // 3. trim each day abbreviation to 1 char if unique, else 2 chars.</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineminus">-              for (i = 0; i &lt; dayList.length; i++) {</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineminus">-                  let foundMatch = 1;</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineminus">-                  for (j = 0; j &lt; dayList.length; j++) {</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineminus">-                      if (i != j) {</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineminus">-                          if (dayList[i].substring(0, 1) == dayList[j].substring(0, 1)) {</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineminus">-                              foundMatch = 2;</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineminus">-                              break;</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineminus">-                          }</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineminus">-                      }</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineminus">-                  }</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineminus">-                  dayList[i] = dayList[i].substring(0, foundMatch);</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineminus">-              }</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineminus">-          }</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineplus">+            if (useOSFormat) {</span>
<a href="#l19.861"></a><span id="l19.861" class="difflineplus">+                // To keep datepicker popup compact, shrink localized weekday</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineplus">+                // abbreviations down to 1 or 2 chars so each column of week can</span>
<a href="#l19.863"></a><span id="l19.863" class="difflineplus">+                // be as narrow as 2 digits.</span>
<a href="#l19.864"></a><span id="l19.864" class="difflineplus">+                //</span>
<a href="#l19.865"></a><span id="l19.865" class="difflineplus">+                // 1. Compute the minLength of the day name abbreviations.</span>
<a href="#l19.866"></a><span id="l19.866" class="difflineplus">+                let minLength = dayList[0].length;</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineplus">+                for (i = 1; i &lt; dayList.length; i++) {</span>
<a href="#l19.868"></a><span id="l19.868" class="difflineplus">+                    minLength = Math.min(minLength, dayList[i].length);</span>
<a href="#l19.869"></a><span id="l19.869" class="difflineplus">+                }</span>
<a href="#l19.870"></a><span id="l19.870" class="difflineplus">+                // 2. If some day name abbrev. is longer than 2 chars (not Catalan),</span>
<a href="#l19.871"></a><span id="l19.871" class="difflineplus">+                //    and ALL localized day names share same prefix (as in Chinese),</span>
<a href="#l19.872"></a><span id="l19.872" class="difflineplus">+                //    then trim shared &quot;day-&quot; prefix.</span>
<a href="#l19.873"></a><span id="l19.873" class="difflineplus">+                if (dayList.some(dayAbbr =&gt; dayAbbr.length &gt; 2)) {</span>
<a href="#l19.874"></a><span id="l19.874" class="difflineplus">+                    for (let endPrefix = 0; endPrefix &lt; minLength; endPrefix++) {</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineplus">+                        let suffix = dayList[0][endPrefix];</span>
<a href="#l19.876"></a><span id="l19.876" class="difflineplus">+                        if (dayList.some(dayAbbr =&gt; dayAbbr[endPrefix] != suffix)) {</span>
<a href="#l19.877"></a><span id="l19.877" class="difflineplus">+                            if (endPrefix &gt; 0) {</span>
<a href="#l19.878"></a><span id="l19.878" class="difflineplus">+                                for (i = 0; i &lt; dayList.length; i++) { // trim prefix chars.</span>
<a href="#l19.879"></a><span id="l19.879" class="difflineplus">+                                    dayList[i] = dayList[i].substring(endPrefix);</span>
<a href="#l19.880"></a><span id="l19.880" class="difflineplus">+                                }</span>
<a href="#l19.881"></a><span id="l19.881" class="difflineplus">+                            }</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineplus">+                            break;</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineplus">+                        }</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineplus">+                    }</span>
<a href="#l19.885"></a><span id="l19.885" class="difflineplus">+                }</span>
<a href="#l19.886"></a><span id="l19.886" class="difflineplus">+                // 3. trim each day abbreviation to 1 char if unique, else 2 chars.</span>
<a href="#l19.887"></a><span id="l19.887" class="difflineplus">+                for (i = 0; i &lt; dayList.length; i++) {</span>
<a href="#l19.888"></a><span id="l19.888" class="difflineplus">+                    let foundMatch = 1;</span>
<a href="#l19.889"></a><span id="l19.889" class="difflineplus">+                    for (j = 0; j &lt; dayList.length; j++) {</span>
<a href="#l19.890"></a><span id="l19.890" class="difflineplus">+                        if (i != j) {</span>
<a href="#l19.891"></a><span id="l19.891" class="difflineplus">+                            if (dayList[i].substring(0, 1) == dayList[j].substring(0, 1)) {</span>
<a href="#l19.892"></a><span id="l19.892" class="difflineplus">+                                foundMatch = 2;</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineplus">+                                break;</span>
<a href="#l19.894"></a><span id="l19.894" class="difflineplus">+                            }</span>
<a href="#l19.895"></a><span id="l19.895" class="difflineplus">+                        }</span>
<a href="#l19.896"></a><span id="l19.896" class="difflineplus">+                    }</span>
<a href="#l19.897"></a><span id="l19.897" class="difflineplus">+                    dayList[i] = dayList[i].substring(0, foundMatch);</span>
<a href="#l19.898"></a><span id="l19.898" class="difflineplus">+                }</span>
<a href="#l19.899"></a><span id="l19.899" class="difflineplus">+            }</span>
<a href="#l19.900"></a><span id="l19.900"> </span>
<a href="#l19.901"></a><span id="l19.901" class="difflineminus">-          setBooleanAttribute(this._getCalBoxNode(0, 0), &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineminus">-          for (let column = 1; column &lt; 8; column++) {</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineminus">-              let node = this._getCalBoxNode(0, column);</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineminus">-              node.textContent = dayList[column - 1];</span>
<a href="#l19.905"></a><span id="l19.905" class="difflineminus">-              node.setAttribute(&quot;aria-label&quot;, longDayList[column - 1]);</span>
<a href="#l19.906"></a><span id="l19.906" class="difflineminus">-          }</span>
<a href="#l19.907"></a><span id="l19.907" class="difflineplus">+            setBooleanAttribute(this._getCalBoxNode(0, 0), &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l19.908"></a><span id="l19.908" class="difflineplus">+            for (let column = 1; column &lt; 8; column++) {</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineplus">+                let node = this._getCalBoxNode(0, column);</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineplus">+                node.textContent = dayList[column - 1];</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineplus">+                node.setAttribute(&quot;aria-label&quot;, longDayList[column - 1]);</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineplus">+            }</span>
<a href="#l19.913"></a><span id="l19.913">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.914"></a><span id="l19.914">       &lt;/method&gt;</span>
<a href="#l19.915"></a><span id="l19.915"> </span>
<a href="#l19.916"></a><span id="l19.916">       &lt;method name=&quot;showMonth&quot;&gt;</span>
<a href="#l19.917"></a><span id="l19.917">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.918"></a><span id="l19.918">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineminus">-          // Use mExtraDate if aDate is null.</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineminus">-          aDate = new Date(aDate || this.mExtraDate);</span>
<a href="#l19.921"></a><span id="l19.921" class="difflineplus">+            // Use mExtraDate if aDate is null.</span>
<a href="#l19.922"></a><span id="l19.922" class="difflineplus">+            aDate = new Date(aDate || this.mExtraDate);</span>
<a href="#l19.923"></a><span id="l19.923"> </span>
<a href="#l19.924"></a><span id="l19.924" class="difflineminus">-          aDate.setDate(1);</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineminus">-          // We set the hour and minute to something highly unlikely to be the</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineminus">-          // exact change point of DST, so timezones like America/Sao Paulo</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineminus">-          // don't display some days twice.</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineminus">-          aDate.setHours(12);</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineminus">-          aDate.setMinutes(34);</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineminus">-          aDate.setSeconds(0);</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineminus">-          aDate.setMilliseconds(0);</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineminus">-          // Don't fire onmonthchange event upon initialization</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineminus">-          let monthChanged = this.mEditorDate &amp;&amp; (this.mEditorDate.valueOf() != aDate.valueOf());</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineminus">-          this.mEditorDate = aDate; // only place mEditorDate is set.</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineplus">+            aDate.setDate(1);</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineplus">+            // We set the hour and minute to something highly unlikely to be the</span>
<a href="#l19.937"></a><span id="l19.937" class="difflineplus">+            // exact change point of DST, so timezones like America/Sao Paulo</span>
<a href="#l19.938"></a><span id="l19.938" class="difflineplus">+            // don't display some days twice.</span>
<a href="#l19.939"></a><span id="l19.939" class="difflineplus">+            aDate.setHours(12);</span>
<a href="#l19.940"></a><span id="l19.940" class="difflineplus">+            aDate.setMinutes(34);</span>
<a href="#l19.941"></a><span id="l19.941" class="difflineplus">+            aDate.setSeconds(0);</span>
<a href="#l19.942"></a><span id="l19.942" class="difflineplus">+            aDate.setMilliseconds(0);</span>
<a href="#l19.943"></a><span id="l19.943" class="difflineplus">+            // Don't fire onmonthchange event upon initialization</span>
<a href="#l19.944"></a><span id="l19.944" class="difflineplus">+            let monthChanged = this.mEditorDate &amp;&amp; (this.mEditorDate.valueOf() != aDate.valueOf());</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineplus">+            this.mEditorDate = aDate; // only place mEditorDate is set.</span>
<a href="#l19.946"></a><span id="l19.946"> </span>
<a href="#l19.947"></a><span id="l19.947" class="difflineminus">-          if (this.mToday) {</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineminus">-              this.mToday.removeAttribute(&quot;today&quot;);</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineminus">-              this.mToday = null;</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineminus">-          }</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineplus">+            if (this.mToday) {</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineplus">+                this.mToday.removeAttribute(&quot;today&quot;);</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineplus">+                this.mToday = null;</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineplus">+            }</span>
<a href="#l19.955"></a><span id="l19.955"> </span>
<a href="#l19.956"></a><span id="l19.956" class="difflineminus">-          if (this.mSelected) {</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineminus">-              this.mSelected.removeAttribute(&quot;selected&quot;);</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineminus">-              this.mSelected = null;</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineminus">-          }</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineplus">+            if (this.mSelected) {</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineplus">+                this.mSelected.removeAttribute(&quot;selected&quot;);</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineplus">+                this.mSelected = null;</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineplus">+            }</span>
<a href="#l19.964"></a><span id="l19.964"> </span>
<a href="#l19.965"></a><span id="l19.965" class="difflineminus">-          if (this.mExtra) {</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineminus">-              this.mExtra.removeAttribute(&quot;extra&quot;);</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineminus">-              this.mExtra = null;</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineminus">-          }</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineplus">+            if (this.mExtra) {</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineplus">+                this.mExtra.removeAttribute(&quot;extra&quot;);</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineplus">+                this.mExtra = null;</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineplus">+            }</span>
<a href="#l19.973"></a><span id="l19.973"> </span>
<a href="#l19.974"></a><span id="l19.974" class="difflineminus">-          // Update the month and year title</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineminus">-          this.setAttribute(&quot;month&quot;, aDate.getMonth());</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineminus">-          this.setAttribute(&quot;year&quot;, aDate.getFullYear());</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineminus">-          if (!this.mIsReadOnly) {</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineminus">-              // Update the month popup</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineminus">-              let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l19.980"></a><span id="l19.980" class="difflineminus">-              header.updateYearPopup(aDate);</span>
<a href="#l19.981"></a><span id="l19.981" class="difflineminus">-              header.updateMonthPopup(aDate);</span>
<a href="#l19.982"></a><span id="l19.982" class="difflineminus">-          }</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineminus">-          // Update the calendar</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineminus">-          let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineminus">-          let date = this._getStartDate(aDate);</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineplus">+            // Update the month and year title</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineplus">+            this.setAttribute(&quot;month&quot;, aDate.getMonth());</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineplus">+            this.setAttribute(&quot;year&quot;, aDate.getFullYear());</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineplus">+            if (!this.mIsReadOnly) {</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineplus">+                // Update the month popup</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineplus">+                let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineplus">+                header.updateYearPopup(aDate);</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineplus">+                header.updateMonthPopup(aDate);</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineplus">+            }</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineplus">+            // Update the calendar</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineplus">+            let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+            let date = this._getStartDate(aDate);</span>
<a href="#l19.998"></a><span id="l19.998"> </span>
<a href="#l19.999"></a><span id="l19.999" class="difflineminus">-          // get today's date</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineminus">-          let today = new Date();</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineplus">+            // get today's date</span>
<a href="#l19.1002"></a><span id="l19.1002" class="difflineplus">+            let today = new Date();</span>
<a href="#l19.1003"></a><span id="l19.1003"> </span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineminus">-          if (aDate.getFullYear() == (this.mValue || this.mExtraDate).getFullYear()) {</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineminus">-              calbox.setAttribute(&quot;aria-label&quot;, cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineminus">-                                  &quot;month.&quot; + (aDate.getMonth() + 1) + &quot;.name&quot;));</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineminus">-          } else {</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineminus">-              let monthName = cal.formatMonth(aDate.getMonth() + 1,</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineminus">-                                              &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineminus">-              let label = cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;,</span>
<a href="#l19.1011"></a><span id="l19.1011" class="difflineminus">-                                       [monthName, aDate.getFullYear()]);</span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineminus">-              calbox.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineminus">-          }</span>
<a href="#l19.1014"></a><span id="l19.1014" class="difflineplus">+            if (aDate.getFullYear() == (this.mValue || this.mExtraDate).getFullYear()) {</span>
<a href="#l19.1015"></a><span id="l19.1015" class="difflineplus">+                calbox.setAttribute(&quot;aria-label&quot;, cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineplus">+                                    &quot;month.&quot; + (aDate.getMonth() + 1) + &quot;.name&quot;));</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineplus">+            } else {</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineplus">+                let monthName = cal.formatMonth(aDate.getMonth() + 1,</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineplus">+                                                &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineplus">+                let label = cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;,</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineplus">+                                         [monthName, aDate.getFullYear()]);</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineplus">+                calbox.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineplus">+            }</span>
<a href="#l19.1024"></a><span id="l19.1024"> </span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineminus">-          this.mDayMap = {};</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineminus">-          let defaultTz = cal.calendarDefaultTimezone();</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineminus">-          let dateFormatter =</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineminus">-              Services.intl.createDateTimeFormat(undefined, { dateStyle: &quot;long&quot; });</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineminus">-          for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineminus">-              // Set the week number.</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineminus">-              let firstElement = this._getCalBoxNode(k, 0);</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineminus">-              setBooleanAttribute(firstElement, &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineminus">-              if (this.mShowWeekNumber) {</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineminus">-                  let weekNumber = cal.getWeekInfoService()</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineminus">-                                      .getWeekTitle(cal.jsDateToDateTime(date, defaultTz));</span>
<a href="#l19.1036"></a><span id="l19.1036" class="difflineminus">-                  let weekTitle = cal.calGetString(&quot;calendar&quot;, &quot;WeekTitle&quot;, [weekNumber]);</span>
<a href="#l19.1037"></a><span id="l19.1037" class="difflineminus">-                  firstElement.textContent = weekNumber;</span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineminus">-                  firstElement.setAttribute(&quot;aria-label&quot;, weekTitle);</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineminus">-              }</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineplus">+            this.mDayMap = {};</span>
<a href="#l19.1041"></a><span id="l19.1041" class="difflineplus">+            let defaultTz = cal.calendarDefaultTimezone();</span>
<a href="#l19.1042"></a><span id="l19.1042" class="difflineplus">+            let dateFormatter =</span>
<a href="#l19.1043"></a><span id="l19.1043" class="difflineplus">+                Services.intl.createDateTimeFormat(undefined, { dateStyle: &quot;long&quot; });</span>
<a href="#l19.1044"></a><span id="l19.1044" class="difflineplus">+            for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l19.1045"></a><span id="l19.1045" class="difflineplus">+                // Set the week number.</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineplus">+                let firstElement = this._getCalBoxNode(k, 0);</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineplus">+                setBooleanAttribute(firstElement, &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineplus">+                if (this.mShowWeekNumber) {</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineplus">+                    let weekNumber = cal.getWeekInfoService()</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineplus">+                                        .getWeekTitle(cal.jsDateToDateTime(date, defaultTz));</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineplus">+                    let weekTitle = cal.calGetString(&quot;calendar&quot;, &quot;WeekTitle&quot;, [weekNumber]);</span>
<a href="#l19.1052"></a><span id="l19.1052" class="difflineplus">+                    firstElement.textContent = weekNumber;</span>
<a href="#l19.1053"></a><span id="l19.1053" class="difflineplus">+                    firstElement.setAttribute(&quot;aria-label&quot;, weekTitle);</span>
<a href="#l19.1054"></a><span id="l19.1054" class="difflineplus">+                }</span>
<a href="#l19.1055"></a><span id="l19.1055"> </span>
<a href="#l19.1056"></a><span id="l19.1056" class="difflineminus">-              for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l19.1057"></a><span id="l19.1057" class="difflineminus">-                  let day = this._getCalBoxNode(k, i);</span>
<a href="#l19.1058"></a><span id="l19.1058" class="difflineminus">-                  let ymd = date.getFullYear() + &quot;-&quot; +</span>
<a href="#l19.1059"></a><span id="l19.1059" class="difflineminus">-                            date.getMonth() + &quot;-&quot; +</span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineminus">-                            date.getDate();</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineminus">-                  this.mDayMap[ymd] = day;</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineplus">+                for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l19.1063"></a><span id="l19.1063" class="difflineplus">+                    let day = this._getCalBoxNode(k, i);</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineplus">+                    let ymd = date.getFullYear() + &quot;-&quot; +</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineplus">+                              date.getMonth() + &quot;-&quot; +</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineplus">+                              date.getDate();</span>
<a href="#l19.1067"></a><span id="l19.1067" class="difflineplus">+                    this.mDayMap[ymd] = day;</span>
<a href="#l19.1068"></a><span id="l19.1068"> </span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineminus">-                  if (!this.mIsReadOnly) {</span>
<a href="#l19.1070"></a><span id="l19.1070" class="difflineminus">-                      day.setAttribute(&quot;interactive&quot;, &quot;true&quot;);</span>
<a href="#l19.1071"></a><span id="l19.1071" class="difflineminus">-                  }</span>
<a href="#l19.1072"></a><span id="l19.1072" class="difflineplus">+                    if (!this.mIsReadOnly) {</span>
<a href="#l19.1073"></a><span id="l19.1073" class="difflineplus">+                        day.setAttribute(&quot;interactive&quot;, &quot;true&quot;);</span>
<a href="#l19.1074"></a><span id="l19.1074" class="difflineplus">+                    }</span>
<a href="#l19.1075"></a><span id="l19.1075"> </span>
<a href="#l19.1076"></a><span id="l19.1076" class="difflineminus">-                  if (aDate.getMonth() == date.getMonth()) {</span>
<a href="#l19.1077"></a><span id="l19.1077" class="difflineminus">-                      day.removeAttribute(&quot;othermonth&quot;);</span>
<a href="#l19.1078"></a><span id="l19.1078" class="difflineminus">-                  } else {</span>
<a href="#l19.1079"></a><span id="l19.1079" class="difflineminus">-                      day.setAttribute(&quot;othermonth&quot;, &quot;true&quot;);</span>
<a href="#l19.1080"></a><span id="l19.1080" class="difflineminus">-                  }</span>
<a href="#l19.1081"></a><span id="l19.1081" class="difflineplus">+                    if (aDate.getMonth() == date.getMonth()) {</span>
<a href="#l19.1082"></a><span id="l19.1082" class="difflineplus">+                        day.removeAttribute(&quot;othermonth&quot;);</span>
<a href="#l19.1083"></a><span id="l19.1083" class="difflineplus">+                    } else {</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineplus">+                        day.setAttribute(&quot;othermonth&quot;, &quot;true&quot;);</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineplus">+                    }</span>
<a href="#l19.1086"></a><span id="l19.1086"> </span>
<a href="#l19.1087"></a><span id="l19.1087" class="difflineminus">-                  // highlight today</span>
<a href="#l19.1088"></a><span id="l19.1088" class="difflineminus">-                  if (this._sameDay(today, date)) {</span>
<a href="#l19.1089"></a><span id="l19.1089" class="difflineminus">-                      this.mToday = day;</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineminus">-                      day.setAttribute(&quot;today&quot;, &quot;true&quot;);</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineminus">-                  }</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineplus">+                    // highlight today</span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineplus">+                    if (this._sameDay(today, date)) {</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineplus">+                        this.mToday = day;</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineplus">+                        day.setAttribute(&quot;today&quot;, &quot;true&quot;);</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineplus">+                    }</span>
<a href="#l19.1097"></a><span id="l19.1097"> </span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineminus">-                  // highlight the current date</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineminus">-                  let val = this.value;</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineminus">-                  if (this._sameDay(val, date)) {</span>
<a href="#l19.1101"></a><span id="l19.1101" class="difflineminus">-                      this.mSelected = day;</span>
<a href="#l19.1102"></a><span id="l19.1102" class="difflineminus">-                      day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l19.1103"></a><span id="l19.1103" class="difflineminus">-                  }</span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineplus">+                    // highlight the current date</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineplus">+                    let val = this.value;</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineplus">+                    if (this._sameDay(val, date)) {</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineplus">+                        this.mSelected = day;</span>
<a href="#l19.1108"></a><span id="l19.1108" class="difflineplus">+                        day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineplus">+                    }</span>
<a href="#l19.1110"></a><span id="l19.1110"> </span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineminus">-                  // highlight the extra date</span>
<a href="#l19.1112"></a><span id="l19.1112" class="difflineminus">-                  if (this._sameDay(this.mExtraDate, date)) {</span>
<a href="#l19.1113"></a><span id="l19.1113" class="difflineminus">-                      this.mExtra = day;</span>
<a href="#l19.1114"></a><span id="l19.1114" class="difflineminus">-                      day.setAttribute(&quot;extra&quot;, &quot;true&quot;);</span>
<a href="#l19.1115"></a><span id="l19.1115" class="difflineminus">-                  }</span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineplus">+                    // highlight the extra date</span>
<a href="#l19.1117"></a><span id="l19.1117" class="difflineplus">+                    if (this._sameDay(this.mExtraDate, date)) {</span>
<a href="#l19.1118"></a><span id="l19.1118" class="difflineplus">+                        this.mExtra = day;</span>
<a href="#l19.1119"></a><span id="l19.1119" class="difflineplus">+                        day.setAttribute(&quot;extra&quot;, &quot;true&quot;);</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineplus">+                    }</span>
<a href="#l19.1121"></a><span id="l19.1121"> </span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineminus">-                  if (aDate.getMonth() == date.getMonth() &amp;&amp;</span>
<a href="#l19.1123"></a><span id="l19.1123" class="difflineminus">-                      aDate.getFullYear() == date.getFullYear()) {</span>
<a href="#l19.1124"></a><span id="l19.1124" class="difflineminus">-                      day.setAttribute(&quot;aria-label&quot;, date.toLocaleDateString(undefined, { day: &quot;numeric&quot; }));</span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineminus">-                  } else {</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineminus">-                      day.setAttribute(&quot;aria-label&quot;, dateFormatter.format(date));</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineminus">-                  }</span>
<a href="#l19.1128"></a><span id="l19.1128" class="difflineplus">+                    if (aDate.getMonth() == date.getMonth() &amp;&amp;</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineplus">+                        aDate.getFullYear() == date.getFullYear()) {</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineplus">+                        day.setAttribute(&quot;aria-label&quot;, date.toLocaleDateString(undefined, { day: &quot;numeric&quot; }));</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineplus">+                    } else {</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineplus">+                        day.setAttribute(&quot;aria-label&quot;, dateFormatter.format(date));</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineplus">+                    }</span>
<a href="#l19.1134"></a><span id="l19.1134"> </span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineminus">-                  day.date = new Date(date);</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineminus">-                  day.textContent = date.getDate();</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineminus">-                  date.setDate(date.getDate() + 1);</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineplus">+                    day.date = new Date(date);</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineplus">+                    day.textContent = date.getDate();</span>
<a href="#l19.1140"></a><span id="l19.1140" class="difflineplus">+                    date.setDate(date.getDate() + 1);</span>
<a href="#l19.1141"></a><span id="l19.1141"> </span>
<a href="#l19.1142"></a><span id="l19.1142" class="difflineminus">-                  if (monthChanged) {</span>
<a href="#l19.1143"></a><span id="l19.1143" class="difflineminus">-                      this.resetAttributesForDate(day.date);</span>
<a href="#l19.1144"></a><span id="l19.1144" class="difflineminus">-                  }</span>
<a href="#l19.1145"></a><span id="l19.1145" class="difflineminus">-              }</span>
<a href="#l19.1146"></a><span id="l19.1146" class="difflineminus">-          }</span>
<a href="#l19.1147"></a><span id="l19.1147" class="difflineplus">+                    if (monthChanged) {</span>
<a href="#l19.1148"></a><span id="l19.1148" class="difflineplus">+                        this.resetAttributesForDate(day.date);</span>
<a href="#l19.1149"></a><span id="l19.1149" class="difflineplus">+                    }</span>
<a href="#l19.1150"></a><span id="l19.1150" class="difflineplus">+                }</span>
<a href="#l19.1151"></a><span id="l19.1151" class="difflineplus">+            }</span>
<a href="#l19.1152"></a><span id="l19.1152"> </span>
<a href="#l19.1153"></a><span id="l19.1153" class="difflineminus">-          if (!this.mFocused) {</span>
<a href="#l19.1154"></a><span id="l19.1154" class="difflineminus">-              this.setFocusedDate(this.mValue || this.mExtraDate);</span>
<a href="#l19.1155"></a><span id="l19.1155" class="difflineminus">-          }</span>
<a href="#l19.1156"></a><span id="l19.1156" class="difflineplus">+            if (!this.mFocused) {</span>
<a href="#l19.1157"></a><span id="l19.1157" class="difflineplus">+                this.setFocusedDate(this.mValue || this.mExtraDate);</span>
<a href="#l19.1158"></a><span id="l19.1158" class="difflineplus">+            }</span>
<a href="#l19.1159"></a><span id="l19.1159"> </span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineminus">-          if (monthChanged) {</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineminus">-              this.fireEvent(&quot;monthchange&quot;);</span>
<a href="#l19.1162"></a><span id="l19.1162" class="difflineminus">-          }</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineplus">+            if (monthChanged) {</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineplus">+                this.fireEvent(&quot;monthchange&quot;);</span>
<a href="#l19.1165"></a><span id="l19.1165" class="difflineplus">+            }</span>
<a href="#l19.1166"></a><span id="l19.1166"> </span>
<a href="#l19.1167"></a><span id="l19.1167" class="difflineminus">-          if (this.getAttribute(&quot;freebusy&quot;) == &quot;true&quot;) {</span>
<a href="#l19.1168"></a><span id="l19.1168" class="difflineminus">-              this.getItems();</span>
<a href="#l19.1169"></a><span id="l19.1169" class="difflineminus">-          }</span>
<a href="#l19.1170"></a><span id="l19.1170" class="difflineplus">+            if (this.getAttribute(&quot;freebusy&quot;) == &quot;true&quot;) {</span>
<a href="#l19.1171"></a><span id="l19.1171" class="difflineplus">+                this.getItems();</span>
<a href="#l19.1172"></a><span id="l19.1172" class="difflineplus">+            }</span>
<a href="#l19.1173"></a><span id="l19.1173">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1174"></a><span id="l19.1174">       &lt;/method&gt;</span>
<a href="#l19.1175"></a><span id="l19.1175"> </span>
<a href="#l19.1176"></a><span id="l19.1176">       &lt;!--Attention - duplicate!!!!--&gt;</span>
<a href="#l19.1177"></a><span id="l19.1177">       &lt;method name=&quot;fireEvent&quot;&gt;</span>
<a href="#l19.1178"></a><span id="l19.1178">         &lt;parameter name=&quot;aEventName&quot;/&gt;</span>
<a href="#l19.1179"></a><span id="l19.1179">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l19.1181"></a><span id="l19.1181" class="difflineminus">-          event.initEvent(aEventName, true, true);</span>
<a href="#l19.1182"></a><span id="l19.1182" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l19.1183"></a><span id="l19.1183" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l19.1184"></a><span id="l19.1184" class="difflineplus">+            event.initEvent(aEventName, true, true);</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l19.1186"></a><span id="l19.1186">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1187"></a><span id="l19.1187">       &lt;/method&gt;</span>
<a href="#l19.1188"></a><span id="l19.1188"> </span>
<a href="#l19.1189"></a><span id="l19.1189">       &lt;method name=&quot;getBoxForDate&quot;&gt;</span>
<a href="#l19.1190"></a><span id="l19.1190">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.1191"></a><span id="l19.1191">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1192"></a><span id="l19.1192" class="difflineminus">-          // aDate is a calIDateTime</span>
<a href="#l19.1193"></a><span id="l19.1193" class="difflineminus">-          let ymd = [aDate.year, aDate.month, aDate.day].join(&quot;-&quot;);</span>
<a href="#l19.1194"></a><span id="l19.1194" class="difflineminus">-          return (ymd in this.mDayMap ? this.mDayMap[ymd] : null);</span>
<a href="#l19.1195"></a><span id="l19.1195" class="difflineplus">+            // aDate is a calIDateTime</span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineplus">+            let ymd = [aDate.year, aDate.month, aDate.day].join(&quot;-&quot;);</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineplus">+            return (ymd in this.mDayMap ? this.mDayMap[ymd] : null);</span>
<a href="#l19.1198"></a><span id="l19.1198">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1199"></a><span id="l19.1199">       &lt;/method&gt;</span>
<a href="#l19.1200"></a><span id="l19.1200"> </span>
<a href="#l19.1201"></a><span id="l19.1201">       &lt;method name=&quot;resetAttributesForDate&quot;&gt;</span>
<a href="#l19.1202"></a><span id="l19.1202">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.1203"></a><span id="l19.1203">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1204"></a><span id="l19.1204" class="difflineminus">-          function removeForBox(aBox) {</span>
<a href="#l19.1205"></a><span id="l19.1205" class="difflineminus">-              let allowedAttributes = 0;</span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineminus">-              while (aBox.attributes.length &gt; allowedAttributes) {</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineminus">-                  switch (aBox.attributes[allowedAttributes].nodeName) {</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineminus">-                      case &quot;selected&quot;:</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineminus">-                      case &quot;othermonth&quot;:</span>
<a href="#l19.1210"></a><span id="l19.1210" class="difflineminus">-                      case &quot;today&quot;:</span>
<a href="#l19.1211"></a><span id="l19.1211" class="difflineminus">-                      case &quot;extra&quot;:</span>
<a href="#l19.1212"></a><span id="l19.1212" class="difflineminus">-                      case &quot;interactive&quot;:</span>
<a href="#l19.1213"></a><span id="l19.1213" class="difflineminus">-                      case &quot;class&quot;:</span>
<a href="#l19.1214"></a><span id="l19.1214" class="difflineminus">-                      case &quot;tabindex&quot;:</span>
<a href="#l19.1215"></a><span id="l19.1215" class="difflineminus">-                      case &quot;role&quot;:</span>
<a href="#l19.1216"></a><span id="l19.1216" class="difflineminus">-                      case &quot;aria-label&quot;:</span>
<a href="#l19.1217"></a><span id="l19.1217" class="difflineminus">-                          allowedAttributes++;</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineminus">-                          break;</span>
<a href="#l19.1219"></a><span id="l19.1219" class="difflineminus">-                      default:</span>
<a href="#l19.1220"></a><span id="l19.1220" class="difflineminus">-                          aBox.removeAttribute(aBox.attributes[allowedAttributes].nodeName);</span>
<a href="#l19.1221"></a><span id="l19.1221" class="difflineminus">-                          break;</span>
<a href="#l19.1222"></a><span id="l19.1222" class="difflineminus">-                  }</span>
<a href="#l19.1223"></a><span id="l19.1223" class="difflineminus">-              }</span>
<a href="#l19.1224"></a><span id="l19.1224" class="difflineminus">-          }</span>
<a href="#l19.1225"></a><span id="l19.1225" class="difflineplus">+            function removeForBox(aBox) {</span>
<a href="#l19.1226"></a><span id="l19.1226" class="difflineplus">+                let allowedAttributes = 0;</span>
<a href="#l19.1227"></a><span id="l19.1227" class="difflineplus">+                while (aBox.attributes.length &gt; allowedAttributes) {</span>
<a href="#l19.1228"></a><span id="l19.1228" class="difflineplus">+                    switch (aBox.attributes[allowedAttributes].nodeName) {</span>
<a href="#l19.1229"></a><span id="l19.1229" class="difflineplus">+                        case &quot;selected&quot;:</span>
<a href="#l19.1230"></a><span id="l19.1230" class="difflineplus">+                        case &quot;othermonth&quot;:</span>
<a href="#l19.1231"></a><span id="l19.1231" class="difflineplus">+                        case &quot;today&quot;:</span>
<a href="#l19.1232"></a><span id="l19.1232" class="difflineplus">+                        case &quot;extra&quot;:</span>
<a href="#l19.1233"></a><span id="l19.1233" class="difflineplus">+                        case &quot;interactive&quot;:</span>
<a href="#l19.1234"></a><span id="l19.1234" class="difflineplus">+                        case &quot;class&quot;:</span>
<a href="#l19.1235"></a><span id="l19.1235" class="difflineplus">+                        case &quot;tabindex&quot;:</span>
<a href="#l19.1236"></a><span id="l19.1236" class="difflineplus">+                        case &quot;role&quot;:</span>
<a href="#l19.1237"></a><span id="l19.1237" class="difflineplus">+                        case &quot;aria-label&quot;:</span>
<a href="#l19.1238"></a><span id="l19.1238" class="difflineplus">+                            allowedAttributes++;</span>
<a href="#l19.1239"></a><span id="l19.1239" class="difflineplus">+                            break;</span>
<a href="#l19.1240"></a><span id="l19.1240" class="difflineplus">+                        default:</span>
<a href="#l19.1241"></a><span id="l19.1241" class="difflineplus">+                            aBox.removeAttribute(aBox.attributes[allowedAttributes].nodeName);</span>
<a href="#l19.1242"></a><span id="l19.1242" class="difflineplus">+                            break;</span>
<a href="#l19.1243"></a><span id="l19.1243" class="difflineplus">+                    }</span>
<a href="#l19.1244"></a><span id="l19.1244" class="difflineplus">+                }</span>
<a href="#l19.1245"></a><span id="l19.1245" class="difflineplus">+            }</span>
<a href="#l19.1246"></a><span id="l19.1246"> </span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineminus">-          if (aDate) {</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineminus">-              let box = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1249"></a><span id="l19.1249" class="difflineminus">-              if (box) {</span>
<a href="#l19.1250"></a><span id="l19.1250" class="difflineminus">-                  removeForBox(box);</span>
<a href="#l19.1251"></a><span id="l19.1251" class="difflineminus">-              }</span>
<a href="#l19.1252"></a><span id="l19.1252" class="difflineminus">-          } else {</span>
<a href="#l19.1253"></a><span id="l19.1253" class="difflineminus">-              for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l19.1254"></a><span id="l19.1254" class="difflineminus">-                  for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l19.1255"></a><span id="l19.1255" class="difflineminus">-                      removeForBox(this._getCalBoxNode(k, i));</span>
<a href="#l19.1256"></a><span id="l19.1256" class="difflineminus">-                  }</span>
<a href="#l19.1257"></a><span id="l19.1257" class="difflineminus">-              }</span>
<a href="#l19.1258"></a><span id="l19.1258" class="difflineminus">-          }</span>
<a href="#l19.1259"></a><span id="l19.1259" class="difflineplus">+            if (aDate) {</span>
<a href="#l19.1260"></a><span id="l19.1260" class="difflineplus">+                let box = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1261"></a><span id="l19.1261" class="difflineplus">+                if (box) {</span>
<a href="#l19.1262"></a><span id="l19.1262" class="difflineplus">+                    removeForBox(box);</span>
<a href="#l19.1263"></a><span id="l19.1263" class="difflineplus">+                }</span>
<a href="#l19.1264"></a><span id="l19.1264" class="difflineplus">+            } else {</span>
<a href="#l19.1265"></a><span id="l19.1265" class="difflineplus">+                for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l19.1266"></a><span id="l19.1266" class="difflineplus">+                    for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l19.1267"></a><span id="l19.1267" class="difflineplus">+                        removeForBox(this._getCalBoxNode(k, i));</span>
<a href="#l19.1268"></a><span id="l19.1268" class="difflineplus">+                    }</span>
<a href="#l19.1269"></a><span id="l19.1269" class="difflineplus">+                }</span>
<a href="#l19.1270"></a><span id="l19.1270" class="difflineplus">+            }</span>
<a href="#l19.1271"></a><span id="l19.1271">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1272"></a><span id="l19.1272">       &lt;/method&gt;</span>
<a href="#l19.1273"></a><span id="l19.1273"> </span>
<a href="#l19.1274"></a><span id="l19.1274">       &lt;method name=&quot;_setFreeBusy&quot;&gt;</span>
<a href="#l19.1275"></a><span id="l19.1275">         &lt;parameter name=&quot;aFreeBusy&quot;/&gt;</span>
<a href="#l19.1276"></a><span id="l19.1276">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1277"></a><span id="l19.1277" class="difflineminus">-          if (aFreeBusy == true) {</span>
<a href="#l19.1278"></a><span id="l19.1278" class="difflineminus">-              if (this.mObservesComposite == false) {</span>
<a href="#l19.1279"></a><span id="l19.1279" class="difflineminus">-                  cal.getCompositeCalendar(window).addObserver(this);</span>
<a href="#l19.1280"></a><span id="l19.1280" class="difflineminus">-                  this.mObservesComposite = true;</span>
<a href="#l19.1281"></a><span id="l19.1281" class="difflineminus">-                  this.getItems();</span>
<a href="#l19.1282"></a><span id="l19.1282" class="difflineminus">-              }</span>
<a href="#l19.1283"></a><span id="l19.1283" class="difflineminus">-          } else if (this.mObservesComposite == true) {</span>
<a href="#l19.1284"></a><span id="l19.1284" class="difflineminus">-              cal.getCompositeCalendar(window).removeObserver(this);</span>
<a href="#l19.1285"></a><span id="l19.1285" class="difflineminus">-              this.mObservesComposite = false;</span>
<a href="#l19.1286"></a><span id="l19.1286" class="difflineminus">-          }</span>
<a href="#l19.1287"></a><span id="l19.1287" class="difflineplus">+            if (aFreeBusy == true) {</span>
<a href="#l19.1288"></a><span id="l19.1288" class="difflineplus">+                if (this.mObservesComposite == false) {</span>
<a href="#l19.1289"></a><span id="l19.1289" class="difflineplus">+                    cal.getCompositeCalendar(window).addObserver(this);</span>
<a href="#l19.1290"></a><span id="l19.1290" class="difflineplus">+                    this.mObservesComposite = true;</span>
<a href="#l19.1291"></a><span id="l19.1291" class="difflineplus">+                    this.getItems();</span>
<a href="#l19.1292"></a><span id="l19.1292" class="difflineplus">+                }</span>
<a href="#l19.1293"></a><span id="l19.1293" class="difflineplus">+            } else if (this.mObservesComposite == true) {</span>
<a href="#l19.1294"></a><span id="l19.1294" class="difflineplus">+                cal.getCompositeCalendar(window).removeObserver(this);</span>
<a href="#l19.1295"></a><span id="l19.1295" class="difflineplus">+                this.mObservesComposite = false;</span>
<a href="#l19.1296"></a><span id="l19.1296" class="difflineplus">+            }</span>
<a href="#l19.1297"></a><span id="l19.1297">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1298"></a><span id="l19.1298">       &lt;/method&gt;</span>
<a href="#l19.1299"></a><span id="l19.1299"> </span>
<a href="#l19.1300"></a><span id="l19.1300">       &lt;method name=&quot;removeAttribute&quot;&gt;</span>
<a href="#l19.1301"></a><span id="l19.1301">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l19.1302"></a><span id="l19.1302">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1303"></a><span id="l19.1303" class="difflineminus">-          if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l19.1304"></a><span id="l19.1304" class="difflineminus">-              this._setFreeBusy(false);</span>
<a href="#l19.1305"></a><span id="l19.1305" class="difflineminus">-          }</span>
<a href="#l19.1306"></a><span id="l19.1306" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l19.1307"></a><span id="l19.1307" class="difflineminus">-          let ret = XULElement.prototype.removeAttribute.call(this, aAttr);</span>
<a href="#l19.1308"></a><span id="l19.1308" class="difflineminus">-          return ret;</span>
<a href="#l19.1309"></a><span id="l19.1309" class="difflineplus">+            if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l19.1310"></a><span id="l19.1310" class="difflineplus">+                this._setFreeBusy(false);</span>
<a href="#l19.1311"></a><span id="l19.1311" class="difflineplus">+            }</span>
<a href="#l19.1312"></a><span id="l19.1312" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l19.1313"></a><span id="l19.1313" class="difflineplus">+            let ret = XULElement.prototype.removeAttribute.call(this, aAttr);</span>
<a href="#l19.1314"></a><span id="l19.1314" class="difflineplus">+            return ret;</span>
<a href="#l19.1315"></a><span id="l19.1315">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1316"></a><span id="l19.1316">       &lt;/method&gt;</span>
<a href="#l19.1317"></a><span id="l19.1317"> </span>
<a href="#l19.1318"></a><span id="l19.1318">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l19.1319"></a><span id="l19.1319">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l19.1320"></a><span id="l19.1320">         &lt;parameter name=&quot;aVal&quot;/&gt;</span>
<a href="#l19.1321"></a><span id="l19.1321">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1322"></a><span id="l19.1322" class="difflineminus">-          if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l19.1323"></a><span id="l19.1323" class="difflineminus">-              this._setFreeBusy(aVal == &quot;true&quot;);</span>
<a href="#l19.1324"></a><span id="l19.1324" class="difflineminus">-          }</span>
<a href="#l19.1325"></a><span id="l19.1325" class="difflineminus">-          // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l19.1326"></a><span id="l19.1326" class="difflineminus">-          let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l19.1327"></a><span id="l19.1327" class="difflineminus">-          return ret;</span>
<a href="#l19.1328"></a><span id="l19.1328" class="difflineplus">+            if (aAttr == &quot;freebusy&quot;) {</span>
<a href="#l19.1329"></a><span id="l19.1329" class="difflineplus">+                this._setFreeBusy(aVal == &quot;true&quot;);</span>
<a href="#l19.1330"></a><span id="l19.1330" class="difflineplus">+            }</span>
<a href="#l19.1331"></a><span id="l19.1331" class="difflineplus">+            // this should be done using lookupMethod(), see bug 286629</span>
<a href="#l19.1332"></a><span id="l19.1332" class="difflineplus">+            let ret = XULElement.prototype.setAttribute.call(this, aAttr, aVal);</span>
<a href="#l19.1333"></a><span id="l19.1333" class="difflineplus">+            return ret;</span>
<a href="#l19.1334"></a><span id="l19.1334">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1335"></a><span id="l19.1335">       &lt;/method&gt;</span>
<a href="#l19.1336"></a><span id="l19.1336"> </span>
<a href="#l19.1337"></a><span id="l19.1337">       &lt;method name=&quot;getItems&quot;&gt;</span>
<a href="#l19.1338"></a><span id="l19.1338">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l19.1339"></a><span id="l19.1339">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1340"></a><span id="l19.1340" class="difflineminus">-          // The minimonth automatically clears extra styles on a month change.</span>
<a href="#l19.1341"></a><span id="l19.1341" class="difflineminus">-          // Therefore we only need to fill the minimonth with new info.</span>
<a href="#l19.1342"></a><span id="l19.1342" class="difflineplus">+            // The minimonth automatically clears extra styles on a month change.</span>
<a href="#l19.1343"></a><span id="l19.1343" class="difflineplus">+            // Therefore we only need to fill the minimonth with new info.</span>
<a href="#l19.1344"></a><span id="l19.1344"> </span>
<a href="#l19.1345"></a><span id="l19.1345" class="difflineminus">-          let calendar = aCalendar || cal.getCompositeCalendar(window);</span>
<a href="#l19.1346"></a><span id="l19.1346" class="difflineminus">-          let filter = calendar.ITEM_FILTER_COMPLETED_ALL |</span>
<a href="#l19.1347"></a><span id="l19.1347" class="difflineminus">-                       calendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l19.1348"></a><span id="l19.1348" class="difflineminus">-                       calendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l19.1349"></a><span id="l19.1349" class="difflineplus">+            let calendar = aCalendar || cal.getCompositeCalendar(window);</span>
<a href="#l19.1350"></a><span id="l19.1350" class="difflineplus">+            let filter = calendar.ITEM_FILTER_COMPLETED_ALL |</span>
<a href="#l19.1351"></a><span id="l19.1351" class="difflineplus">+                         calendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l19.1352"></a><span id="l19.1352" class="difflineplus">+                         calendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l19.1353"></a><span id="l19.1353"> </span>
<a href="#l19.1354"></a><span id="l19.1354" class="difflineminus">-          // Get new info</span>
<a href="#l19.1355"></a><span id="l19.1355" class="difflineminus">-          calendar.getItems(filter,</span>
<a href="#l19.1356"></a><span id="l19.1356" class="difflineminus">-                            0,</span>
<a href="#l19.1357"></a><span id="l19.1357" class="difflineminus">-                            this.firstDate,</span>
<a href="#l19.1358"></a><span id="l19.1358" class="difflineminus">-                            this.lastDate,</span>
<a href="#l19.1359"></a><span id="l19.1359" class="difflineminus">-                            this);</span>
<a href="#l19.1360"></a><span id="l19.1360" class="difflineplus">+            // Get new info</span>
<a href="#l19.1361"></a><span id="l19.1361" class="difflineplus">+            calendar.getItems(filter,</span>
<a href="#l19.1362"></a><span id="l19.1362" class="difflineplus">+                              0,</span>
<a href="#l19.1363"></a><span id="l19.1363" class="difflineplus">+                              this.firstDate,</span>
<a href="#l19.1364"></a><span id="l19.1364" class="difflineplus">+                              this.lastDate,</span>
<a href="#l19.1365"></a><span id="l19.1365" class="difflineplus">+                              this);</span>
<a href="#l19.1366"></a><span id="l19.1366">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1367"></a><span id="l19.1367">       &lt;/method&gt;</span>
<a href="#l19.1368"></a><span id="l19.1368"> </span>
<a href="#l19.1369"></a><span id="l19.1369">       &lt;method name=&quot;updateAccessibleLabel&quot;&gt;</span>
<a href="#l19.1370"></a><span id="l19.1370">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1371"></a><span id="l19.1371" class="difflineminus">-          let label;</span>
<a href="#l19.1372"></a><span id="l19.1372" class="difflineminus">-          if (this.mValue) {</span>
<a href="#l19.1373"></a><span id="l19.1373" class="difflineminus">-              let dateFormatter =</span>
<a href="#l19.1374"></a><span id="l19.1374" class="difflineminus">-                  Services.intl.createDateTimeFormat(undefined, { dateStyle: &quot;long&quot; });</span>
<a href="#l19.1375"></a><span id="l19.1375" class="difflineminus">-              label = dateFormatter.format(this.mValue);</span>
<a href="#l19.1376"></a><span id="l19.1376" class="difflineminus">-          } else {</span>
<a href="#l19.1377"></a><span id="l19.1377" class="difflineminus">-              label = cal.calGetString(&quot;calendar&quot;, &quot;minimonthNoSelectedDate&quot;);</span>
<a href="#l19.1378"></a><span id="l19.1378" class="difflineminus">-          }</span>
<a href="#l19.1379"></a><span id="l19.1379" class="difflineminus">-          this.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l19.1380"></a><span id="l19.1380" class="difflineplus">+            let label;</span>
<a href="#l19.1381"></a><span id="l19.1381" class="difflineplus">+            if (this.mValue) {</span>
<a href="#l19.1382"></a><span id="l19.1382" class="difflineplus">+                let dateFormatter =</span>
<a href="#l19.1383"></a><span id="l19.1383" class="difflineplus">+                    Services.intl.createDateTimeFormat(undefined, { dateStyle: &quot;long&quot; });</span>
<a href="#l19.1384"></a><span id="l19.1384" class="difflineplus">+                label = dateFormatter.format(this.mValue);</span>
<a href="#l19.1385"></a><span id="l19.1385" class="difflineplus">+            } else {</span>
<a href="#l19.1386"></a><span id="l19.1386" class="difflineplus">+                label = cal.calGetString(&quot;calendar&quot;, &quot;minimonthNoSelectedDate&quot;);</span>
<a href="#l19.1387"></a><span id="l19.1387" class="difflineplus">+            }</span>
<a href="#l19.1388"></a><span id="l19.1388" class="difflineplus">+            this.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l19.1389"></a><span id="l19.1389">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1390"></a><span id="l19.1390">       &lt;/method&gt;</span>
<a href="#l19.1391"></a><span id="l19.1391"> </span>
<a href="#l19.1392"></a><span id="l19.1392">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l19.1393"></a><span id="l19.1393">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l19.1394"></a><span id="l19.1394">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1395"></a><span id="l19.1395" class="difflineminus">-          this.mValue = aValue;</span>
<a href="#l19.1396"></a><span id="l19.1396" class="difflineminus">-          if (this.mValue) {</span>
<a href="#l19.1397"></a><span id="l19.1397" class="difflineminus">-              this.fireEvent(&quot;change&quot;);</span>
<a href="#l19.1398"></a><span id="l19.1398" class="difflineminus">-          }</span>
<a href="#l19.1399"></a><span id="l19.1399" class="difflineminus">-          this.showMonth(aValue);</span>
<a href="#l19.1400"></a><span id="l19.1400" class="difflineminus">-          if (aValue) {</span>
<a href="#l19.1401"></a><span id="l19.1401" class="difflineminus">-              this.setFocusedDate(aValue);</span>
<a href="#l19.1402"></a><span id="l19.1402" class="difflineminus">-          }</span>
<a href="#l19.1403"></a><span id="l19.1403" class="difflineminus">-          this.updateAccessibleLabel();</span>
<a href="#l19.1404"></a><span id="l19.1404" class="difflineplus">+            this.mValue = aValue;</span>
<a href="#l19.1405"></a><span id="l19.1405" class="difflineplus">+            if (this.mValue) {</span>
<a href="#l19.1406"></a><span id="l19.1406" class="difflineplus">+                this.fireEvent(&quot;change&quot;);</span>
<a href="#l19.1407"></a><span id="l19.1407" class="difflineplus">+            }</span>
<a href="#l19.1408"></a><span id="l19.1408" class="difflineplus">+            this.showMonth(aValue);</span>
<a href="#l19.1409"></a><span id="l19.1409" class="difflineplus">+            if (aValue) {</span>
<a href="#l19.1410"></a><span id="l19.1410" class="difflineplus">+                this.setFocusedDate(aValue);</span>
<a href="#l19.1411"></a><span id="l19.1411" class="difflineplus">+            }</span>
<a href="#l19.1412"></a><span id="l19.1412" class="difflineplus">+            this.updateAccessibleLabel();</span>
<a href="#l19.1413"></a><span id="l19.1413">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1414"></a><span id="l19.1414">       &lt;/method&gt;</span>
<a href="#l19.1415"></a><span id="l19.1415"> </span>
<a href="#l19.1416"></a><span id="l19.1416">       &lt;method name=&quot;setFocusedDate&quot;&gt;</span>
<a href="#l19.1417"></a><span id="l19.1417">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.1418"></a><span id="l19.1418">         &lt;parameter name=&quot;aForceFocus&quot;/&gt;</span>
<a href="#l19.1419"></a><span id="l19.1419">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1420"></a><span id="l19.1420" class="difflineminus">-          let newFocused = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1421"></a><span id="l19.1421" class="difflineminus">-          if (!newFocused) {</span>
<a href="#l19.1422"></a><span id="l19.1422" class="difflineminus">-              return;</span>
<a href="#l19.1423"></a><span id="l19.1423" class="difflineminus">-          }</span>
<a href="#l19.1424"></a><span id="l19.1424" class="difflineminus">-          if (this.mFocused) {</span>
<a href="#l19.1425"></a><span id="l19.1425" class="difflineminus">-              this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;-1&quot;);</span>
<a href="#l19.1426"></a><span id="l19.1426" class="difflineminus">-          }</span>
<a href="#l19.1427"></a><span id="l19.1427" class="difflineminus">-          this.mFocused = newFocused;</span>
<a href="#l19.1428"></a><span id="l19.1428" class="difflineminus">-          this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;0&quot;);</span>
<a href="#l19.1429"></a><span id="l19.1429" class="difflineminus">-          // only actually move the focus if it is already in the calendar box</span>
<a href="#l19.1430"></a><span id="l19.1430" class="difflineminus">-          if (!aForceFocus) {</span>
<a href="#l19.1431"></a><span id="l19.1431" class="difflineminus">-              let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.1432"></a><span id="l19.1432" class="difflineminus">-              aForceFocus = calbox.contains(document.commandDispatcher.focusedElement);</span>
<a href="#l19.1433"></a><span id="l19.1433" class="difflineminus">-          }</span>
<a href="#l19.1434"></a><span id="l19.1434" class="difflineminus">-          if (aForceFocus) {</span>
<a href="#l19.1435"></a><span id="l19.1435" class="difflineminus">-              this.mFocused.focus();</span>
<a href="#l19.1436"></a><span id="l19.1436" class="difflineminus">-          }</span>
<a href="#l19.1437"></a><span id="l19.1437" class="difflineplus">+            let newFocused = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1438"></a><span id="l19.1438" class="difflineplus">+            if (!newFocused) {</span>
<a href="#l19.1439"></a><span id="l19.1439" class="difflineplus">+                return;</span>
<a href="#l19.1440"></a><span id="l19.1440" class="difflineplus">+            }</span>
<a href="#l19.1441"></a><span id="l19.1441" class="difflineplus">+            if (this.mFocused) {</span>
<a href="#l19.1442"></a><span id="l19.1442" class="difflineplus">+                this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;-1&quot;);</span>
<a href="#l19.1443"></a><span id="l19.1443" class="difflineplus">+            }</span>
<a href="#l19.1444"></a><span id="l19.1444" class="difflineplus">+            this.mFocused = newFocused;</span>
<a href="#l19.1445"></a><span id="l19.1445" class="difflineplus">+            this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;0&quot;);</span>
<a href="#l19.1446"></a><span id="l19.1446" class="difflineplus">+            // only actually move the focus if it is already in the calendar box</span>
<a href="#l19.1447"></a><span id="l19.1447" class="difflineplus">+            if (!aForceFocus) {</span>
<a href="#l19.1448"></a><span id="l19.1448" class="difflineplus">+                let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.1449"></a><span id="l19.1449" class="difflineplus">+                aForceFocus = calbox.contains(document.commandDispatcher.focusedElement);</span>
<a href="#l19.1450"></a><span id="l19.1450" class="difflineplus">+            }</span>
<a href="#l19.1451"></a><span id="l19.1451" class="difflineplus">+            if (aForceFocus) {</span>
<a href="#l19.1452"></a><span id="l19.1452" class="difflineplus">+                this.mFocused.focus();</span>
<a href="#l19.1453"></a><span id="l19.1453" class="difflineplus">+            }</span>
<a href="#l19.1454"></a><span id="l19.1454">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1455"></a><span id="l19.1455">       &lt;/method&gt;</span>
<a href="#l19.1456"></a><span id="l19.1456"> </span>
<a href="#l19.1457"></a><span id="l19.1457">       &lt;method name=&quot;focusDate&quot;&gt;</span>
<a href="#l19.1458"></a><span id="l19.1458">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.1459"></a><span id="l19.1459">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1460"></a><span id="l19.1460" class="difflineminus">-          this.showMonth(aDate);</span>
<a href="#l19.1461"></a><span id="l19.1461" class="difflineminus">-          this.setFocusedDate(aDate);</span>
<a href="#l19.1462"></a><span id="l19.1462" class="difflineplus">+            this.showMonth(aDate);</span>
<a href="#l19.1463"></a><span id="l19.1463" class="difflineplus">+            this.setFocusedDate(aDate);</span>
<a href="#l19.1464"></a><span id="l19.1464">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1465"></a><span id="l19.1465">       &lt;/method&gt;</span>
<a href="#l19.1466"></a><span id="l19.1466"> </span>
<a href="#l19.1467"></a><span id="l19.1467">       &lt;method name=&quot;hidePopupList&quot;&gt;</span>
<a href="#l19.1468"></a><span id="l19.1468">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1469"></a><span id="l19.1469" class="difflineminus">-          if (!this.mIsReadOnly) {</span>
<a href="#l19.1470"></a><span id="l19.1470" class="difflineminus">-              let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l19.1471"></a><span id="l19.1471" class="difflineminus">-              header.hidePopupList();</span>
<a href="#l19.1472"></a><span id="l19.1472" class="difflineminus">-          }</span>
<a href="#l19.1473"></a><span id="l19.1473" class="difflineplus">+            if (!this.mIsReadOnly) {</span>
<a href="#l19.1474"></a><span id="l19.1474" class="difflineplus">+                let header = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-header&quot;);</span>
<a href="#l19.1475"></a><span id="l19.1475" class="difflineplus">+                header.hidePopupList();</span>
<a href="#l19.1476"></a><span id="l19.1476" class="difflineplus">+            }</span>
<a href="#l19.1477"></a><span id="l19.1477">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1478"></a><span id="l19.1478">       &lt;/method&gt;</span>
<a href="#l19.1479"></a><span id="l19.1479"> </span>
<a href="#l19.1480"></a><span id="l19.1480">       &lt;method name=&quot;switchMonth&quot;&gt;</span>
<a href="#l19.1481"></a><span id="l19.1481">         &lt;parameter name=&quot;aMonth&quot;/&gt;</span>
<a href="#l19.1482"></a><span id="l19.1482">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1483"></a><span id="l19.1483" class="difflineminus">-          let newMonth = new Date(this.mEditorDate);</span>
<a href="#l19.1484"></a><span id="l19.1484" class="difflineminus">-          newMonth.setMonth(aMonth);</span>
<a href="#l19.1485"></a><span id="l19.1485" class="difflineminus">-          this.showMonth(newMonth);</span>
<a href="#l19.1486"></a><span id="l19.1486" class="difflineplus">+            let newMonth = new Date(this.mEditorDate);</span>
<a href="#l19.1487"></a><span id="l19.1487" class="difflineplus">+            newMonth.setMonth(aMonth);</span>
<a href="#l19.1488"></a><span id="l19.1488" class="difflineplus">+            this.showMonth(newMonth);</span>
<a href="#l19.1489"></a><span id="l19.1489">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1490"></a><span id="l19.1490">       &lt;/method&gt;</span>
<a href="#l19.1491"></a><span id="l19.1491"> </span>
<a href="#l19.1492"></a><span id="l19.1492">       &lt;method name=&quot;switchYear&quot;&gt;</span>
<a href="#l19.1493"></a><span id="l19.1493">         &lt;parameter name=&quot;aYear&quot;/&gt;</span>
<a href="#l19.1494"></a><span id="l19.1494">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1495"></a><span id="l19.1495" class="difflineminus">-          let newMonth = new Date(this.mEditorDate);</span>
<a href="#l19.1496"></a><span id="l19.1496" class="difflineminus">-          newMonth.setFullYear(aYear);</span>
<a href="#l19.1497"></a><span id="l19.1497" class="difflineminus">-          this.showMonth(newMonth);</span>
<a href="#l19.1498"></a><span id="l19.1498" class="difflineplus">+            let newMonth = new Date(this.mEditorDate);</span>
<a href="#l19.1499"></a><span id="l19.1499" class="difflineplus">+            newMonth.setFullYear(aYear);</span>
<a href="#l19.1500"></a><span id="l19.1500" class="difflineplus">+            this.showMonth(newMonth);</span>
<a href="#l19.1501"></a><span id="l19.1501">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1502"></a><span id="l19.1502">       &lt;/method&gt;</span>
<a href="#l19.1503"></a><span id="l19.1503"> </span>
<a href="#l19.1504"></a><span id="l19.1504">       &lt;method name=&quot;selectDate&quot;&gt;</span>
<a href="#l19.1505"></a><span id="l19.1505">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l19.1506"></a><span id="l19.1506">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l19.1507"></a><span id="l19.1507">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1508"></a><span id="l19.1508" class="difflineminus">-          if (!aMainDate || aDate &lt; this._getStartDate(aMainDate) || aDate &gt; this._getEndDate(aMainDate)) {</span>
<a href="#l19.1509"></a><span id="l19.1509" class="difflineminus">-              aMainDate = new Date(aDate);</span>
<a href="#l19.1510"></a><span id="l19.1510" class="difflineminus">-              aMainDate.setDate(1);</span>
<a href="#l19.1511"></a><span id="l19.1511" class="difflineminus">-          }</span>
<a href="#l19.1512"></a><span id="l19.1512" class="difflineminus">-          // note, that aMainDate and this.mEditorDate refer to the first day</span>
<a href="#l19.1513"></a><span id="l19.1513" class="difflineminus">-          // of the corresponding month</span>
<a href="#l19.1514"></a><span id="l19.1514" class="difflineminus">-          let sameMonth = this._sameDay(aMainDate, this.mEditorDate);</span>
<a href="#l19.1515"></a><span id="l19.1515" class="difflineminus">-          let sameDate = this._sameDay(aDate, this.mValue);</span>
<a href="#l19.1516"></a><span id="l19.1516" class="difflineminus">-          if (!sameMonth &amp;&amp; !sameDate) {</span>
<a href="#l19.1517"></a><span id="l19.1517" class="difflineminus">-              // change month and select day</span>
<a href="#l19.1518"></a><span id="l19.1518" class="difflineminus">-              this.mValue = aDate;</span>
<a href="#l19.1519"></a><span id="l19.1519" class="difflineminus">-              this.showMonth(aMainDate);</span>
<a href="#l19.1520"></a><span id="l19.1520" class="difflineminus">-          } else if (!sameMonth) {</span>
<a href="#l19.1521"></a><span id="l19.1521" class="difflineminus">-              // change month only</span>
<a href="#l19.1522"></a><span id="l19.1522" class="difflineminus">-              this.showMonth(aMainDate);</span>
<a href="#l19.1523"></a><span id="l19.1523" class="difflineminus">-          } else if (!sameDate) {</span>
<a href="#l19.1524"></a><span id="l19.1524" class="difflineminus">-              // select day only</span>
<a href="#l19.1525"></a><span id="l19.1525" class="difflineminus">-              let day = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1526"></a><span id="l19.1526" class="difflineminus">-              if (this.mSelected) {</span>
<a href="#l19.1527"></a><span id="l19.1527" class="difflineminus">-                  this.mSelected.removeAttribute(&quot;selected&quot;);</span>
<a href="#l19.1528"></a><span id="l19.1528" class="difflineminus">-              }</span>
<a href="#l19.1529"></a><span id="l19.1529" class="difflineminus">-              this.mSelected = day;</span>
<a href="#l19.1530"></a><span id="l19.1530" class="difflineminus">-              day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l19.1531"></a><span id="l19.1531" class="difflineminus">-              this.mValue = aDate;</span>
<a href="#l19.1532"></a><span id="l19.1532" class="difflineminus">-              this.setFocusedDate(aDate);</span>
<a href="#l19.1533"></a><span id="l19.1533" class="difflineminus">-          }</span>
<a href="#l19.1534"></a><span id="l19.1534" class="difflineplus">+            if (!aMainDate || aDate &lt; this._getStartDate(aMainDate) || aDate &gt; this._getEndDate(aMainDate)) {</span>
<a href="#l19.1535"></a><span id="l19.1535" class="difflineplus">+                aMainDate = new Date(aDate);</span>
<a href="#l19.1536"></a><span id="l19.1536" class="difflineplus">+                aMainDate.setDate(1);</span>
<a href="#l19.1537"></a><span id="l19.1537" class="difflineplus">+            }</span>
<a href="#l19.1538"></a><span id="l19.1538" class="difflineplus">+            // note, that aMainDate and this.mEditorDate refer to the first day</span>
<a href="#l19.1539"></a><span id="l19.1539" class="difflineplus">+            // of the corresponding month</span>
<a href="#l19.1540"></a><span id="l19.1540" class="difflineplus">+            let sameMonth = this._sameDay(aMainDate, this.mEditorDate);</span>
<a href="#l19.1541"></a><span id="l19.1541" class="difflineplus">+            let sameDate = this._sameDay(aDate, this.mValue);</span>
<a href="#l19.1542"></a><span id="l19.1542" class="difflineplus">+            if (!sameMonth &amp;&amp; !sameDate) {</span>
<a href="#l19.1543"></a><span id="l19.1543" class="difflineplus">+                // change month and select day</span>
<a href="#l19.1544"></a><span id="l19.1544" class="difflineplus">+                this.mValue = aDate;</span>
<a href="#l19.1545"></a><span id="l19.1545" class="difflineplus">+                this.showMonth(aMainDate);</span>
<a href="#l19.1546"></a><span id="l19.1546" class="difflineplus">+            } else if (!sameMonth) {</span>
<a href="#l19.1547"></a><span id="l19.1547" class="difflineplus">+                // change month only</span>
<a href="#l19.1548"></a><span id="l19.1548" class="difflineplus">+                this.showMonth(aMainDate);</span>
<a href="#l19.1549"></a><span id="l19.1549" class="difflineplus">+            } else if (!sameDate) {</span>
<a href="#l19.1550"></a><span id="l19.1550" class="difflineplus">+                // select day only</span>
<a href="#l19.1551"></a><span id="l19.1551" class="difflineplus">+                let day = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l19.1552"></a><span id="l19.1552" class="difflineplus">+                if (this.mSelected) {</span>
<a href="#l19.1553"></a><span id="l19.1553" class="difflineplus">+                    this.mSelected.removeAttribute(&quot;selected&quot;);</span>
<a href="#l19.1554"></a><span id="l19.1554" class="difflineplus">+                }</span>
<a href="#l19.1555"></a><span id="l19.1555" class="difflineplus">+                this.mSelected = day;</span>
<a href="#l19.1556"></a><span id="l19.1556" class="difflineplus">+                day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l19.1557"></a><span id="l19.1557" class="difflineplus">+                this.mValue = aDate;</span>
<a href="#l19.1558"></a><span id="l19.1558" class="difflineplus">+                this.setFocusedDate(aDate);</span>
<a href="#l19.1559"></a><span id="l19.1559" class="difflineplus">+            }</span>
<a href="#l19.1560"></a><span id="l19.1560">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1561"></a><span id="l19.1561">       &lt;/method&gt;</span>
<a href="#l19.1562"></a><span id="l19.1562"> </span>
<a href="#l19.1563"></a><span id="l19.1563">       &lt;method name=&quot;_getStartDate&quot;&gt;</span>
<a href="#l19.1564"></a><span id="l19.1564">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l19.1565"></a><span id="l19.1565">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1566"></a><span id="l19.1566" class="difflineminus">-          let date = new Date(aMainDate);</span>
<a href="#l19.1567"></a><span id="l19.1567" class="difflineminus">-          let firstWeekday = (7 + aMainDate.getDay() - this.weekStart) % 7;</span>
<a href="#l19.1568"></a><span id="l19.1568" class="difflineminus">-          date.setDate(date.getDate() - firstWeekday);</span>
<a href="#l19.1569"></a><span id="l19.1569" class="difflineminus">-          return date;</span>
<a href="#l19.1570"></a><span id="l19.1570" class="difflineplus">+            let date = new Date(aMainDate);</span>
<a href="#l19.1571"></a><span id="l19.1571" class="difflineplus">+            let firstWeekday = (7 + aMainDate.getDay() - this.weekStart) % 7;</span>
<a href="#l19.1572"></a><span id="l19.1572" class="difflineplus">+            date.setDate(date.getDate() - firstWeekday);</span>
<a href="#l19.1573"></a><span id="l19.1573" class="difflineplus">+            return date;</span>
<a href="#l19.1574"></a><span id="l19.1574">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1575"></a><span id="l19.1575">       &lt;/method&gt;</span>
<a href="#l19.1576"></a><span id="l19.1576"> </span>
<a href="#l19.1577"></a><span id="l19.1577">       &lt;method name=&quot;_getEndDate&quot;&gt;</span>
<a href="#l19.1578"></a><span id="l19.1578">         &lt;parameter name=&quot;aMainDate&quot;/&gt;</span>
<a href="#l19.1579"></a><span id="l19.1579">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1580"></a><span id="l19.1580" class="difflineminus">-          let date = this._getStartDate(aMainDate);</span>
<a href="#l19.1581"></a><span id="l19.1581" class="difflineminus">-          let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.1582"></a><span id="l19.1582" class="difflineminus">-          let days = (calbox.childNodes.length - 1) * 7;</span>
<a href="#l19.1583"></a><span id="l19.1583" class="difflineminus">-          date.setDate(date.getDate() + days - 1);</span>
<a href="#l19.1584"></a><span id="l19.1584" class="difflineminus">-          return date;</span>
<a href="#l19.1585"></a><span id="l19.1585" class="difflineplus">+            let date = this._getStartDate(aMainDate);</span>
<a href="#l19.1586"></a><span id="l19.1586" class="difflineplus">+            let calbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;minimonth-calendar&quot;);</span>
<a href="#l19.1587"></a><span id="l19.1587" class="difflineplus">+            let days = (calbox.childNodes.length - 1) * 7;</span>
<a href="#l19.1588"></a><span id="l19.1588" class="difflineplus">+            date.setDate(date.getDate() + days - 1);</span>
<a href="#l19.1589"></a><span id="l19.1589" class="difflineplus">+            return date;</span>
<a href="#l19.1590"></a><span id="l19.1590">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1591"></a><span id="l19.1591">       &lt;/method&gt;</span>
<a href="#l19.1592"></a><span id="l19.1592"> </span>
<a href="#l19.1593"></a><span id="l19.1593">       &lt;method name=&quot;_sameDay&quot;&gt;</span>
<a href="#l19.1594"></a><span id="l19.1594">         &lt;parameter name=&quot;aDate1&quot;/&gt;</span>
<a href="#l19.1595"></a><span id="l19.1595">         &lt;parameter name=&quot;aDate2&quot;/&gt;</span>
<a href="#l19.1596"></a><span id="l19.1596">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1597"></a><span id="l19.1597" class="difflineminus">-          if (aDate1 &amp;&amp; aDate2 &amp;&amp;</span>
<a href="#l19.1598"></a><span id="l19.1598" class="difflineminus">-             (aDate1.getDate() == aDate2.getDate()) &amp;&amp;</span>
<a href="#l19.1599"></a><span id="l19.1599" class="difflineminus">-             (aDate1.getMonth() == aDate2.getMonth()) &amp;&amp;</span>
<a href="#l19.1600"></a><span id="l19.1600" class="difflineminus">-             (aDate1.getFullYear() == aDate2.getFullYear())) {</span>
<a href="#l19.1601"></a><span id="l19.1601" class="difflineminus">-              return true;</span>
<a href="#l19.1602"></a><span id="l19.1602" class="difflineminus">-          }</span>
<a href="#l19.1603"></a><span id="l19.1603" class="difflineminus">-          return false;</span>
<a href="#l19.1604"></a><span id="l19.1604" class="difflineplus">+            if (aDate1 &amp;&amp; aDate2 &amp;&amp;</span>
<a href="#l19.1605"></a><span id="l19.1605" class="difflineplus">+               (aDate1.getDate() == aDate2.getDate()) &amp;&amp;</span>
<a href="#l19.1606"></a><span id="l19.1606" class="difflineplus">+               (aDate1.getMonth() == aDate2.getMonth()) &amp;&amp;</span>
<a href="#l19.1607"></a><span id="l19.1607" class="difflineplus">+               (aDate1.getFullYear() == aDate2.getFullYear())) {</span>
<a href="#l19.1608"></a><span id="l19.1608" class="difflineplus">+                return true;</span>
<a href="#l19.1609"></a><span id="l19.1609" class="difflineplus">+            }</span>
<a href="#l19.1610"></a><span id="l19.1610" class="difflineplus">+            return false;</span>
<a href="#l19.1611"></a><span id="l19.1611">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1612"></a><span id="l19.1612">       &lt;/method&gt;</span>
<a href="#l19.1613"></a><span id="l19.1613"> </span>
<a href="#l19.1614"></a><span id="l19.1614">       &lt;method name=&quot;advanceMonth&quot;&gt;</span>
<a href="#l19.1615"></a><span id="l19.1615">         &lt;parameter name=&quot;aDir&quot;/&gt;</span>
<a href="#l19.1616"></a><span id="l19.1616">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1617"></a><span id="l19.1617" class="difflineminus">-          let advEditorDate = new Date(this.mEditorDate); // at 1st of month</span>
<a href="#l19.1618"></a><span id="l19.1618" class="difflineminus">-          let advMonth = this.mEditorDate.getMonth() + aDir;</span>
<a href="#l19.1619"></a><span id="l19.1619" class="difflineminus">-          advEditorDate.setMonth(advMonth);</span>
<a href="#l19.1620"></a><span id="l19.1620" class="difflineminus">-          this.showMonth(advEditorDate);</span>
<a href="#l19.1621"></a><span id="l19.1621" class="difflineplus">+            let advEditorDate = new Date(this.mEditorDate); // at 1st of month</span>
<a href="#l19.1622"></a><span id="l19.1622" class="difflineplus">+            let advMonth = this.mEditorDate.getMonth() + aDir;</span>
<a href="#l19.1623"></a><span id="l19.1623" class="difflineplus">+            advEditorDate.setMonth(advMonth);</span>
<a href="#l19.1624"></a><span id="l19.1624" class="difflineplus">+            this.showMonth(advEditorDate);</span>
<a href="#l19.1625"></a><span id="l19.1625">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1626"></a><span id="l19.1626">       &lt;/method&gt;</span>
<a href="#l19.1627"></a><span id="l19.1627"> </span>
<a href="#l19.1628"></a><span id="l19.1628">       &lt;method name=&quot;moveByOffset&quot;&gt;</span>
<a href="#l19.1629"></a><span id="l19.1629">         &lt;parameter name=&quot;aYears&quot;/&gt;</span>
<a href="#l19.1630"></a><span id="l19.1630">         &lt;parameter name=&quot;aMonths&quot;/&gt;</span>
<a href="#l19.1631"></a><span id="l19.1631">         &lt;parameter name=&quot;aDays&quot;/&gt;</span>
<a href="#l19.1632"></a><span id="l19.1632">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1633"></a><span id="l19.1633" class="difflineminus">-          let day = new Date(this.mFocused.date.getFullYear() + aYears,</span>
<a href="#l19.1634"></a><span id="l19.1634" class="difflineminus">-                             this.mFocused.date.getMonth() + aMonths,</span>
<a href="#l19.1635"></a><span id="l19.1635" class="difflineminus">-                             this.mFocused.date.getDate() + aDays);</span>
<a href="#l19.1636"></a><span id="l19.1636" class="difflineminus">-          this.focusDate(day);</span>
<a href="#l19.1637"></a><span id="l19.1637" class="difflineplus">+            let day = new Date(this.mFocused.date.getFullYear() + aYears,</span>
<a href="#l19.1638"></a><span id="l19.1638" class="difflineplus">+                               this.mFocused.date.getMonth() + aMonths,</span>
<a href="#l19.1639"></a><span id="l19.1639" class="difflineplus">+                               this.mFocused.date.getDate() + aDays);</span>
<a href="#l19.1640"></a><span id="l19.1640" class="difflineplus">+            this.focusDate(day);</span>
<a href="#l19.1641"></a><span id="l19.1641">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1642"></a><span id="l19.1642">       &lt;/method&gt;</span>
<a href="#l19.1643"></a><span id="l19.1643"> </span>
<a href="#l19.1644"></a><span id="l19.1644">       &lt;method name=&quot;focusCalendar&quot;&gt;</span>
<a href="#l19.1645"></a><span id="l19.1645">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1646"></a><span id="l19.1646" class="difflineminus">-          this.mFocused.focus();</span>
<a href="#l19.1647"></a><span id="l19.1647" class="difflineplus">+            this.mFocused.focus();</span>
<a href="#l19.1648"></a><span id="l19.1648">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1649"></a><span id="l19.1649">       &lt;/method&gt;</span>
<a href="#l19.1650"></a><span id="l19.1650"> </span>
<a href="#l19.1651"></a><span id="l19.1651">       &lt;method name=&quot;onDayActivate&quot;&gt;</span>
<a href="#l19.1652"></a><span id="l19.1652">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l19.1653"></a><span id="l19.1653">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1654"></a><span id="l19.1654" class="difflineminus">-          if (aEvent.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1655"></a><span id="l19.1655" class="difflineminus">-              // the associated date might change when setting this.value if month changes</span>
<a href="#l19.1656"></a><span id="l19.1656" class="difflineminus">-              let date = aEvent.originalTarget.date;</span>
<a href="#l19.1657"></a><span id="l19.1657" class="difflineminus">-              if (!this.mIsReadOnly) {</span>
<a href="#l19.1658"></a><span id="l19.1658" class="difflineminus">-                  this.value = date;</span>
<a href="#l19.1659"></a><span id="l19.1659" class="difflineminus">-                  this.fireEvent(&quot;select&quot;);</span>
<a href="#l19.1660"></a><span id="l19.1660" class="difflineminus">-              }</span>
<a href="#l19.1661"></a><span id="l19.1661" class="difflineminus">-              this.setFocusedDate(date, true);</span>
<a href="#l19.1662"></a><span id="l19.1662" class="difflineplus">+            if (aEvent.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1663"></a><span id="l19.1663" class="difflineplus">+                // the associated date might change when setting this.value if month changes</span>
<a href="#l19.1664"></a><span id="l19.1664" class="difflineplus">+                let date = aEvent.originalTarget.date;</span>
<a href="#l19.1665"></a><span id="l19.1665" class="difflineplus">+                if (!this.mIsReadOnly) {</span>
<a href="#l19.1666"></a><span id="l19.1666" class="difflineplus">+                    this.value = date;</span>
<a href="#l19.1667"></a><span id="l19.1667" class="difflineplus">+                    this.fireEvent(&quot;select&quot;);</span>
<a href="#l19.1668"></a><span id="l19.1668" class="difflineplus">+                }</span>
<a href="#l19.1669"></a><span id="l19.1669" class="difflineplus">+                this.setFocusedDate(date, true);</span>
<a href="#l19.1670"></a><span id="l19.1670"> </span>
<a href="#l19.1671"></a><span id="l19.1671" class="difflineminus">-              aEvent.stopPropagation();</span>
<a href="#l19.1672"></a><span id="l19.1672" class="difflineminus">-              aEvent.preventDefault();</span>
<a href="#l19.1673"></a><span id="l19.1673" class="difflineminus">-          }</span>
<a href="#l19.1674"></a><span id="l19.1674" class="difflineplus">+                aEvent.stopPropagation();</span>
<a href="#l19.1675"></a><span id="l19.1675" class="difflineplus">+                aEvent.preventDefault();</span>
<a href="#l19.1676"></a><span id="l19.1676" class="difflineplus">+            }</span>
<a href="#l19.1677"></a><span id="l19.1677">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1678"></a><span id="l19.1678">       &lt;/method&gt;</span>
<a href="#l19.1679"></a><span id="l19.1679"> </span>
<a href="#l19.1680"></a><span id="l19.1680">       &lt;method name=&quot;onDayMovement&quot;&gt;</span>
<a href="#l19.1681"></a><span id="l19.1681">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l19.1682"></a><span id="l19.1682">         &lt;parameter name=&quot;aYears&quot;/&gt;</span>
<a href="#l19.1683"></a><span id="l19.1683">         &lt;parameter name=&quot;aMonths&quot;/&gt;</span>
<a href="#l19.1684"></a><span id="l19.1684">         &lt;parameter name=&quot;aDays&quot;/&gt;</span>
<a href="#l19.1685"></a><span id="l19.1685">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.1686"></a><span id="l19.1686" class="difflineminus">-          if (aEvent.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1687"></a><span id="l19.1687" class="difflineminus">-              this.moveByOffset(aYears, aMonths, aDays);</span>
<a href="#l19.1688"></a><span id="l19.1688" class="difflineminus">-              aEvent.stopPropagation();</span>
<a href="#l19.1689"></a><span id="l19.1689" class="difflineminus">-              aEvent.preventDefault();</span>
<a href="#l19.1690"></a><span id="l19.1690" class="difflineminus">-          }</span>
<a href="#l19.1691"></a><span id="l19.1691" class="difflineplus">+            if (aEvent.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1692"></a><span id="l19.1692" class="difflineplus">+                this.moveByOffset(aYears, aMonths, aDays);</span>
<a href="#l19.1693"></a><span id="l19.1693" class="difflineplus">+                aEvent.stopPropagation();</span>
<a href="#l19.1694"></a><span id="l19.1694" class="difflineplus">+                aEvent.preventDefault();</span>
<a href="#l19.1695"></a><span id="l19.1695" class="difflineplus">+            }</span>
<a href="#l19.1696"></a><span id="l19.1696">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.1697"></a><span id="l19.1697">       &lt;/method&gt;</span>
<a href="#l19.1698"></a><span id="l19.1698">     &lt;/implementation&gt;</span>
<a href="#l19.1699"></a><span id="l19.1699"> </span>
<a href="#l19.1700"></a><span id="l19.1700">     &lt;handlers&gt;</span>
<a href="#l19.1701"></a><span id="l19.1701">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l19.1702"></a><span id="l19.1702" class="difflineminus">-        const pixelThreshold = 150;</span>
<a href="#l19.1703"></a><span id="l19.1703" class="difflineminus">-        let deltaView = 0;</span>
<a href="#l19.1704"></a><span id="l19.1704" class="difflineminus">-        if (this.mIsReadOnly) {</span>
<a href="#l19.1705"></a><span id="l19.1705" class="difflineminus">-            // No scrolling on readonly months</span>
<a href="#l19.1706"></a><span id="l19.1706" class="difflineminus">-            return;</span>
<a href="#l19.1707"></a><span id="l19.1707" class="difflineminus">-        }</span>
<a href="#l19.1708"></a><span id="l19.1708" class="difflineminus">-        if (event.deltaMode == event.DOM_DELTA_LINE ||</span>
<a href="#l19.1709"></a><span id="l19.1709" class="difflineminus">-            event.deltaMode == event.DOM_DELTA_PAGE) {</span>
<a href="#l19.1710"></a><span id="l19.1710" class="difflineminus">-            if (event.deltaY != 0) {</span>
<a href="#l19.1711"></a><span id="l19.1711" class="difflineminus">-                deltaView = event.deltaY &gt; 0 ? 1 : -1;</span>
<a href="#l19.1712"></a><span id="l19.1712" class="difflineminus">-            }</span>
<a href="#l19.1713"></a><span id="l19.1713" class="difflineminus">-        } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l19.1714"></a><span id="l19.1714" class="difflineminus">-            this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l19.1715"></a><span id="l19.1715" class="difflineminus">-            if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l19.1716"></a><span id="l19.1716" class="difflineminus">-                deltaView = 1;</span>
<a href="#l19.1717"></a><span id="l19.1717" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l19.1718"></a><span id="l19.1718" class="difflineminus">-            } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l19.1719"></a><span id="l19.1719" class="difflineminus">-                deltaView = -1;</span>
<a href="#l19.1720"></a><span id="l19.1720" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l19.1721"></a><span id="l19.1721" class="difflineminus">-            }</span>
<a href="#l19.1722"></a><span id="l19.1722" class="difflineminus">-        }</span>
<a href="#l19.1723"></a><span id="l19.1723" class="difflineplus">+          const pixelThreshold = 150;</span>
<a href="#l19.1724"></a><span id="l19.1724" class="difflineplus">+          let deltaView = 0;</span>
<a href="#l19.1725"></a><span id="l19.1725" class="difflineplus">+          if (this.mIsReadOnly) {</span>
<a href="#l19.1726"></a><span id="l19.1726" class="difflineplus">+              // No scrolling on readonly months</span>
<a href="#l19.1727"></a><span id="l19.1727" class="difflineplus">+              return;</span>
<a href="#l19.1728"></a><span id="l19.1728" class="difflineplus">+          }</span>
<a href="#l19.1729"></a><span id="l19.1729" class="difflineplus">+          if (event.deltaMode == event.DOM_DELTA_LINE ||</span>
<a href="#l19.1730"></a><span id="l19.1730" class="difflineplus">+              event.deltaMode == event.DOM_DELTA_PAGE) {</span>
<a href="#l19.1731"></a><span id="l19.1731" class="difflineplus">+              if (event.deltaY != 0) {</span>
<a href="#l19.1732"></a><span id="l19.1732" class="difflineplus">+                  deltaView = event.deltaY &gt; 0 ? 1 : -1;</span>
<a href="#l19.1733"></a><span id="l19.1733" class="difflineplus">+              }</span>
<a href="#l19.1734"></a><span id="l19.1734" class="difflineplus">+          } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l19.1735"></a><span id="l19.1735" class="difflineplus">+              this.mPixelScrollDelta += event.deltaY;</span>
<a href="#l19.1736"></a><span id="l19.1736" class="difflineplus">+              if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l19.1737"></a><span id="l19.1737" class="difflineplus">+                  deltaView = 1;</span>
<a href="#l19.1738"></a><span id="l19.1738" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l19.1739"></a><span id="l19.1739" class="difflineplus">+              } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l19.1740"></a><span id="l19.1740" class="difflineplus">+                  deltaView = -1;</span>
<a href="#l19.1741"></a><span id="l19.1741" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l19.1742"></a><span id="l19.1742" class="difflineplus">+              }</span>
<a href="#l19.1743"></a><span id="l19.1743" class="difflineplus">+          }</span>
<a href="#l19.1744"></a><span id="l19.1744"> </span>
<a href="#l19.1745"></a><span id="l19.1745" class="difflineminus">-        if (deltaView != 0) {</span>
<a href="#l19.1746"></a><span id="l19.1746" class="difflineminus">-            this.advanceMonth(deltaView);</span>
<a href="#l19.1747"></a><span id="l19.1747" class="difflineminus">-        }</span>
<a href="#l19.1748"></a><span id="l19.1748" class="difflineplus">+          if (deltaView != 0) {</span>
<a href="#l19.1749"></a><span id="l19.1749" class="difflineplus">+              this.advanceMonth(deltaView);</span>
<a href="#l19.1750"></a><span id="l19.1750" class="difflineplus">+          }</span>
<a href="#l19.1751"></a><span id="l19.1751"> </span>
<a href="#l19.1752"></a><span id="l19.1752" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l19.1753"></a><span id="l19.1753" class="difflineminus">-        event.preventDefault();</span>
<a href="#l19.1754"></a><span id="l19.1754" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l19.1755"></a><span id="l19.1755" class="difflineplus">+          event.preventDefault();</span>
<a href="#l19.1756"></a><span id="l19.1756">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l19.1757"></a><span id="l19.1757">       &lt;!-- day handlers --&gt;</span>
<a href="#l19.1758"></a><span id="l19.1758">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_LEFT&quot; modifiers=&quot;control shift any&quot;</span>
<a href="#l19.1759"></a><span id="l19.1759">                action=&quot;this.onDayMovement(event, 0, 0, -1);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1760"></a><span id="l19.1760">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RIGHT&quot; modifiers=&quot;control shift any&quot;</span>
<a href="#l19.1761"></a><span id="l19.1761">                action=&quot;this.onDayMovement(event, 0, 0, 1);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1762"></a><span id="l19.1762">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control shift any&quot;</span>
<a href="#l19.1763"></a><span id="l19.1763">                action=&quot;this.onDayMovement(event, 0, 0, -7);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1764"></a><span id="l19.1764" class="difflineat">@@ -1343,31 +1343,31 @@</span>
<a href="#l19.1765"></a><span id="l19.1765">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_PAGE_DOWN&quot;</span>
<a href="#l19.1766"></a><span id="l19.1766">                action=&quot;this.onDayMovement(event, 0, 1, 0);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1767"></a><span id="l19.1767">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_PAGE_UP&quot; modifiers=&quot;shift&quot;</span>
<a href="#l19.1768"></a><span id="l19.1768">                action=&quot;this.onDayMovement(event, -1, 0, 0);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1769"></a><span id="l19.1769">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_PAGE_DOWN&quot; modifiers=&quot;shift&quot;</span>
<a href="#l19.1770"></a><span id="l19.1770">                action=&quot;this.onDayMovement(event, 1, 0, 0);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1771"></a><span id="l19.1771">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ESCAPE&quot;</span>
<a href="#l19.1772"></a><span id="l19.1772">                phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l19.1773"></a><span id="l19.1773" class="difflineminus">-        if (event.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1774"></a><span id="l19.1774" class="difflineminus">-            this.focusDate(this.mValue || this.mExtraDate);</span>
<a href="#l19.1775"></a><span id="l19.1775" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l19.1776"></a><span id="l19.1776" class="difflineminus">-            event.preventDefault();</span>
<a href="#l19.1777"></a><span id="l19.1777" class="difflineminus">-        }</span>
<a href="#l19.1778"></a><span id="l19.1778" class="difflineplus">+          if (event.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1779"></a><span id="l19.1779" class="difflineplus">+              this.focusDate(this.mValue || this.mExtraDate);</span>
<a href="#l19.1780"></a><span id="l19.1780" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l19.1781"></a><span id="l19.1781" class="difflineplus">+              event.preventDefault();</span>
<a href="#l19.1782"></a><span id="l19.1782" class="difflineplus">+          }</span>
<a href="#l19.1783"></a><span id="l19.1783">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l19.1784"></a><span id="l19.1784">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_HOME&quot;</span>
<a href="#l19.1785"></a><span id="l19.1785">                phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l19.1786"></a><span id="l19.1786" class="difflineminus">-        if (event.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1787"></a><span id="l19.1787" class="difflineminus">-            let today = new Date();</span>
<a href="#l19.1788"></a><span id="l19.1788" class="difflineminus">-            this.update(today);</span>
<a href="#l19.1789"></a><span id="l19.1789" class="difflineminus">-            this.focusDate(today);</span>
<a href="#l19.1790"></a><span id="l19.1790" class="difflineplus">+          if (event.originalTarget.className == &quot;minimonth-day&quot;) {</span>
<a href="#l19.1791"></a><span id="l19.1791" class="difflineplus">+              let today = new Date();</span>
<a href="#l19.1792"></a><span id="l19.1792" class="difflineplus">+              this.update(today);</span>
<a href="#l19.1793"></a><span id="l19.1793" class="difflineplus">+              this.focusDate(today);</span>
<a href="#l19.1794"></a><span id="l19.1794"> </span>
<a href="#l19.1795"></a><span id="l19.1795" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l19.1796"></a><span id="l19.1796" class="difflineminus">-            event.preventDefault();</span>
<a href="#l19.1797"></a><span id="l19.1797" class="difflineminus">-        }</span>
<a href="#l19.1798"></a><span id="l19.1798" class="difflineplus">+              event.stopPropagation();</span>
<a href="#l19.1799"></a><span id="l19.1799" class="difflineplus">+              event.preventDefault();</span>
<a href="#l19.1800"></a><span id="l19.1800" class="difflineplus">+          }</span>
<a href="#l19.1801"></a><span id="l19.1801">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l19.1802"></a><span id="l19.1802">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;</span>
<a href="#l19.1803"></a><span id="l19.1803">                action=&quot;onDayActivate(event);&quot; phase=&quot;target&quot;/&gt;</span>
<a href="#l19.1804"></a><span id="l19.1804">       &lt;handler event=&quot;click&quot; button=&quot;0&quot; action=&quot;onDayActivate(event);&quot;/&gt;</span>
<a href="#l19.1805"></a><span id="l19.1805">     &lt;/handlers&gt;</span>
<a href="#l19.1806"></a><span id="l19.1806">   &lt;/binding&gt;</span>
<a href="#l19.1807"></a><span id="l19.1807"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -54,177 +54,177 @@</span>
<a href="#l20.4"></a><span id="l20.4">     &lt;implementation&gt;</span>
<a href="#l20.5"></a><span id="l20.5">       &lt;field name=&quot;mRelativeDates&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.6"></a><span id="l20.6">       &lt;field name=&quot;mDayNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.7"></a><span id="l20.7">       &lt;field name=&quot;mRelationWords&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.8"></a><span id="l20.8">       &lt;field name=&quot;mMonthLongNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.9"></a><span id="l20.9">       &lt;field name=&quot;mMonthShortNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-        let goButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-go-button&quot;);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-        goButton.setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;go&quot;));</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-        // Load the stuff we're going to use to parse written dates</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-        this.mRelativeDates = [</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;today&quot;).toLowerCase(), offset: 0 },</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;yesterday&quot;).toLowerCase(), offset: -1 },</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;tomorrow&quot;).toLowerCase(), offset: 1 }];</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-        for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-            this.mDayNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-        }</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+          let goButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-go-button&quot;);</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+          goButton.setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;go&quot;));</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+          // Load the stuff we're going to use to parse written dates</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+          this.mRelativeDates = [</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;today&quot;).toLowerCase(), offset: 0 },</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;yesterday&quot;).toLowerCase(), offset: -1 },</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;tomorrow&quot;).toLowerCase(), offset: 1 }];</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+          for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+              this.mDayNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+          }</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-        for (let i = 1; i &lt;= 12; i++) {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-            this.mMonthLongNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-            this.mMonthShortNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.Mmm&quot;).toLowerCase());</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-        }</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+          for (let i = 1; i &lt;= 12; i++) {</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+              this.mMonthLongNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+              this.mMonthShortNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.Mmm&quot;).toLowerCase());</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+          }</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-        // note that some languages have different conjugations of</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-        // next/last depending on the day</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-        this.mRelationWords = [</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;last1&quot;), offset: -1 },</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;last2&quot;), offset: -1 },</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;next1&quot;), offset: 0 },</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-            { word: cal.calGetString(&quot;calendar&quot;, &quot;next2&quot;), offset: 0 }];</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+          // note that some languages have different conjugations of</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+          // next/last depending on the day</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+          this.mRelationWords = [</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;last1&quot;), offset: -1 },</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;last2&quot;), offset: -1 },</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;next1&quot;), offset: 0 },</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+              { word: cal.calGetString(&quot;calendar&quot;, &quot;next2&quot;), offset: 0 }];</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-        // Set the value to today</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-        let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-        text.value = cal.calGetString(&quot;calendar&quot;, &quot;today&quot;);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+          // Set the value to today</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+          let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+          text.value = cal.calGetString(&quot;calendar&quot;, &quot;today&quot;);</span>
<a href="#l20.65"></a><span id="l20.65">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">       &lt;property name=&quot;value&quot;&gt;</span>
<a href="#l20.68"></a><span id="l20.68">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-          return this.mValue;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+            return this.mValue;</span>
<a href="#l20.71"></a><span id="l20.71">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.72"></a><span id="l20.72">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-          let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-          try {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-              text.value = this.formatDate(val);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-          } catch (ex) {</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-              // Don't fail if date formatting fails.</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-          }</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-          return val;</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+            let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+            try {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+                text.value = this.formatDate(val);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+            } catch (ex) {</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+                // Don't fail if date formatting fails.</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+            }</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+            return val;</span>
<a href="#l20.87"></a><span id="l20.87">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l20.88"></a><span id="l20.88">       &lt;/property&gt;</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">       &lt;method name=&quot;fireGoEvent&quot;&gt;</span>
<a href="#l20.91"></a><span id="l20.91">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-          let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-          let date = this.parseLanguageDate(text.value);</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-          if (!date) {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-              date = this.parseDateTime(text.value);</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-          }</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-          let prettyDate;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-          if (date) {</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-              // format fails if year &lt;= 1600 on win2k, so try format first.</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-              try {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-                  prettyDate = this.formatDate(date);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-              } catch (ex) {</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-                  // Don't fail if date formatting fails.</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-              }</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-          }</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-          if (date &amp;&amp; prettyDate) {</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-              this.mValue = date;</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-              text.value = prettyDate;</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-              this.fireEvent(&quot;command&quot;, date);</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-          }</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+            let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+            let date = this.parseLanguageDate(text.value);</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+            if (!date) {</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+                date = this.parseDateTime(text.value);</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+            }</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+            let prettyDate;</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+            if (date) {</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+                // format fails if year &lt;= 1600 on win2k, so try format first.</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+                try {</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+                    prettyDate = this.formatDate(date);</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+                } catch (ex) {</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+                    // Don't fail if date formatting fails.</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+                }</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+            }</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+            if (date &amp;&amp; prettyDate) {</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+                this.mValue = date;</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+                text.value = prettyDate;</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+                this.fireEvent(&quot;command&quot;, date);</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+            }</span>
<a href="#l20.130"></a><span id="l20.130">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.131"></a><span id="l20.131">       &lt;/method&gt;</span>
<a href="#l20.132"></a><span id="l20.132"> </span>
<a href="#l20.133"></a><span id="l20.133">       &lt;!-- This function will take written (with words) dates and, if</span>
<a href="#l20.134"></a><span id="l20.134">          - possible, return a Date() object described by the words.  Note</span>
<a href="#l20.135"></a><span id="l20.135">          - that this function will not parse explicit dates, like 1/1/06,</span>
<a href="#l20.136"></a><span id="l20.136">          - you should use parseDateTime for that.</span>
<a href="#l20.137"></a><span id="l20.137">         --&gt;</span>
<a href="#l20.138"></a><span id="l20.138">       &lt;method name=&quot;parseLanguageDate&quot;&gt;</span>
<a href="#l20.139"></a><span id="l20.139">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.140"></a><span id="l20.140">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-          if (!aValue) {</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-              return null;</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-          }</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-          let val = aValue.toLowerCase();</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-          // Look for the easy ones like today, tomorrow, etc</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-          for (let rel of this.mRelativeDates) {</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-              if (val == rel.word) {</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-                  let now = new Date();</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-                  now.setDate(now.getDate() + rel.offset);</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-                  return now;</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-              }</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-          }</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+            if (!aValue) {</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+                return null;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+            }</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+            let val = aValue.toLowerCase();</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+            // Look for the easy ones like today, tomorrow, etc</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+            for (let rel of this.mRelativeDates) {</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+                if (val == rel.word) {</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+                    let now = new Date();</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+                    now.setDate(now.getDate() + rel.offset);</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+                    return now;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+                }</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+            }</span>
<a href="#l20.165"></a><span id="l20.165"> </span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-          let self = this;</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+            let self = this;</span>
<a href="#l20.168"></a><span id="l20.168"> </span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-          // Takes a written day of the week and returns a js-date</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-          // corresponding to the nearest day in the future that is</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-          // that day of the week</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-          function getDateForDay(aWord) {</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-              for (let i in self.mDayNames) {</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-                  if (aWord != self.mDayNames[i]) {</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-                      continue;</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-                  }</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-                  // Figure out what day of the week today is.</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-                  let today = cal.now();</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+            // Takes a written day of the week and returns a js-date</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+            // corresponding to the nearest day in the future that is</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+            // that day of the week</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+            function getDateForDay(aWord) {</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+                for (let i in self.mDayNames) {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+                    if (aWord != self.mDayNames[i]) {</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+                        continue;</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+                    }</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+                    // Figure out what day of the week today is.</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+                    let today = cal.now();</span>
<a href="#l20.189"></a><span id="l20.189"> </span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-                  // i-weekday gets the offset. Add 7 to ensure that the %</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-                  // operation stays positive.</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-                  let offset = (i - today.weekday + 7) % 7;</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-                  today.day = today.day + offset;</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-                  return cal.dateTimeToJsDate(today);</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-              }</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-              return null;</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-          }</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+                    // i-weekday gets the offset. Add 7 to ensure that the %</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+                    // operation stays positive.</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+                    let offset = (i - today.weekday + 7) % 7;</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+                    today.day = today.day + offset;</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+                    return cal.dateTimeToJsDate(today);</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+                }</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+                return null;</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+            }</span>
<a href="#l20.206"></a><span id="l20.206"> </span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-          // Remove commas</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-          val = val.replace(&quot;,&quot;, &quot;&quot;);</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+            // Remove commas</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+            val = val.replace(&quot;,&quot;, &quot;&quot;);</span>
<a href="#l20.211"></a><span id="l20.211"> </span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-          if (!val.includes(&quot; &quot;)) {</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-              // Just a single word, or a single date.</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-              return getDateForDay(val);</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-          }</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+            if (!val.includes(&quot; &quot;)) {</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+                // Just a single word, or a single date.</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+                return getDateForDay(val);</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+            }</span>
<a href="#l20.220"></a><span id="l20.220"> </span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-          // Replace month names with numbers</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-          for (let i in this.mMonthLongNames) {</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-              if (val.includes(this.mMonthLongNames[i])) {</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-                  let newVal = val.replace(this.mMonthLongNames[i], Number(i) + 1);</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-                  newVal = newVal.replace(&quot; &quot;, &quot;/&quot;);</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-                  return this.parseDateTime(newVal);</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-              }</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-          }</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+            // Replace month names with numbers</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+            for (let i in this.mMonthLongNames) {</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+                if (val.includes(this.mMonthLongNames[i])) {</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+                    let newVal = val.replace(this.mMonthLongNames[i], Number(i) + 1);</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+                    newVal = newVal.replace(&quot; &quot;, &quot;/&quot;);</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+                    return this.parseDateTime(newVal);</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+                }</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+            }</span>
<a href="#l20.237"></a><span id="l20.237"> </span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-          // Same for short month names</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-          for (let i in this.mMonthShortNames) {</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-              if (val.includes(this.mMonthShortNames[i])) {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-                  let newVal = val.replace(this.mMonthShortNames[i], Number(i) + 1);</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-                  newVal = newVal.replace(&quot; &quot;, &quot;/&quot;);</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-                  return this.parseDateTime(newVal);</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-              }</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-          }</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+            // Same for short month names</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+            for (let i in this.mMonthShortNames) {</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+                if (val.includes(this.mMonthShortNames[i])) {</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+                    let newVal = val.replace(this.mMonthShortNames[i], Number(i) + 1);</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+                    newVal = newVal.replace(&quot; &quot;, &quot;/&quot;);</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+                    return this.parseDateTime(newVal);</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+                }</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+            }</span>
<a href="#l20.254"></a><span id="l20.254"> </span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-          // Now for the cool 'next' and 'last'</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-          let words = val.split(&quot; &quot;);</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-          let offset, day;</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-          for (let word of words) {</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-              for (let rel of this.mRelationWords) {</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-                  if (word == rel.word) {</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-                      offset = rel.offset;</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-                      break;</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-                  }</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-              }</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-              for (let i in this.mDayNames) {</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-                  if (word == this.mDayNames[i]) {</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-                      day = getDateForDay(word);</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-                      break;</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-                  }</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-              }</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-          }</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+            // Now for the cool 'next' and 'last'</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineplus">+            let words = val.split(&quot; &quot;);</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+            let offset, day;</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+            for (let word of words) {</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineplus">+                for (let rel of this.mRelationWords) {</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineplus">+                    if (word == rel.word) {</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+                        offset = rel.offset;</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+                        break;</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+                    }</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+                }</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+                for (let i in this.mDayNames) {</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+                    if (word == this.mDayNames[i]) {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+                        day = getDateForDay(word);</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+                        break;</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+                    }</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+                }</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+            }</span>
<a href="#l20.289"></a><span id="l20.289"> </span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-          if (day &amp;&amp; offset != undefined) {</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-              day.setDate(day.getDate() + (7 * offset));</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-              return day;</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-          }</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-          return null;</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+            if (day &amp;&amp; offset != undefined) {</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+                day.setDate(day.getDate() + (7 * offset));</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+                return day;</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+            }</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+            return null;</span>
<a href="#l20.300"></a><span id="l20.300">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.301"></a><span id="l20.301">       &lt;/method&gt;</span>
<a href="#l20.302"></a><span id="l20.302">     &lt;/implementation&gt;</span>
<a href="#l20.303"></a><span id="l20.303">   &lt;/binding&gt;</span>
<a href="#l20.304"></a><span id="l20.304"> </span>
<a href="#l20.305"></a><span id="l20.305">   &lt;binding id=&quot;datepicker&quot; extends=&quot;chrome://calendar/content/datetimepickers/datetimepickers.xml#datetimepicker-base&quot;&gt;</span>
<a href="#l20.306"></a><span id="l20.306">     &lt;!-- Desired behavior: when user is done editing the date field</span>
<a href="#l20.307"></a><span id="l20.307">          and either leaves the field (onblur) or closes the dialog</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineat">@@ -264,31 +264,31 @@</span>
<a href="#l20.309"></a><span id="l20.309">             &lt;xul:minimonth/&gt;</span>
<a href="#l20.310"></a><span id="l20.310">           &lt;/xul:panel&gt;</span>
<a href="#l20.311"></a><span id="l20.311">         &lt;/xul:menulist&gt;</span>
<a href="#l20.312"></a><span id="l20.312">       &lt;/xul:hbox&gt;</span>
<a href="#l20.313"></a><span id="l20.313">     &lt;/content&gt;</span>
<a href="#l20.314"></a><span id="l20.314"> </span>
<a href="#l20.315"></a><span id="l20.315">     &lt;implementation&gt;</span>
<a href="#l20.316"></a><span id="l20.316">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-        let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-        this.kTextBox = hbox.firstChild;</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineplus">+          let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineplus">+          this.kTextBox = hbox.firstChild;</span>
<a href="#l20.321"></a><span id="l20.321"> </span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-        let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-        if (val) {</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-            this.value = new Date(val); // setting value property calls update</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-        } else {</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-            this.value = new Date();</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-        }</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineplus">+          if (val) {</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineplus">+              this.value = new Date(val); // setting value property calls update</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineplus">+          } else {</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineplus">+              this.value = new Date();</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+          }</span>
<a href="#l20.334"></a><span id="l20.334"> </span>
<a href="#l20.335"></a><span id="l20.335" class="difflineminus">-        this.kTextBox.kDatePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineminus">-        this.kTextBox.firstChild.kDatePicker = this;</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-        this.kMinimonth = this.kTextBox.firstChild.firstChild;</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-        this.mInPopup = false;</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineminus">-        this.kMinimonth.addEventListener(&quot;select&quot;, this.clickDate);</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+          this.kTextBox.kDatePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+          this.kTextBox.firstChild.kDatePicker = this;</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+          this.kMinimonth = this.kTextBox.firstChild.firstChild;</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineplus">+          this.mInPopup = false;</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineplus">+          this.kMinimonth.addEventListener(&quot;select&quot;, this.clickDate);</span>
<a href="#l20.345"></a><span id="l20.345">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.346"></a><span id="l20.346"> </span>
<a href="#l20.347"></a><span id="l20.347">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l20.348"></a><span id="l20.348">           this.kMinimonth.removeEventListener(&quot;select&quot;, this.clickDate);</span>
<a href="#l20.349"></a><span id="l20.349">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l20.350"></a><span id="l20.350"> </span>
<a href="#l20.351"></a><span id="l20.351">       &lt;!-- This property will be overlayed in some extended binding --&gt;</span>
<a href="#l20.352"></a><span id="l20.352">       &lt;property name=&quot;valueValid&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineat">@@ -300,97 +300,97 @@</span>
<a href="#l20.354"></a><span id="l20.354">       &lt;property name=&quot;extraDate&quot;</span>
<a href="#l20.355"></a><span id="l20.355">                 onget=&quot;return this.kMinimonth.extra&quot;</span>
<a href="#l20.356"></a><span id="l20.356">                 onset=&quot;this.kMinimonth.extra = val&quot;/&gt;</span>
<a href="#l20.357"></a><span id="l20.357"> </span>
<a href="#l20.358"></a><span id="l20.358">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l20.359"></a><span id="l20.359">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.360"></a><span id="l20.360">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.361"></a><span id="l20.361">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-          if (aValue != null) {</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-              // format fails if year &lt;= 1600 on win2k, so try format first.</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-              let formattedValue = null;</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-              try {</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-                  formattedValue = this.formatDate(aValue);</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-              } catch (ex) {</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-                  // formattedValue is checked for a value below</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-              }</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineplus">+            if (aValue != null) {</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineplus">+                // format fails if year &lt;= 1600 on win2k, so try format first.</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineplus">+                let formattedValue = null;</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineplus">+                try {</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineplus">+                    formattedValue = this.formatDate(aValue);</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineplus">+                } catch (ex) {</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineplus">+                    // formattedValue is checked for a value below</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineplus">+                }</span>
<a href="#l20.378"></a><span id="l20.378"> </span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-              if (formattedValue) {</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-                  // format succeeded, safe to set value</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-                  let dateChanged = true;</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineminus">-                  if (this.valueValid) {</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineminus">-                      dateChanged = this.mValue.getDate() != aValue.getDate() ||</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-                                    this.mValue.getMonth() != aValue.getMonth() ||</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-                                    this.mValue.getFullYear() != aValue.getFullYear();</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-                  }</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-                  this.mValue = aValue;</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-                  this.kTextBox.value = formattedValue;</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-                  if (aRefresh &amp;&amp; dateChanged) {</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-                      this.fireEvent(&quot;change&quot;);</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-                  }</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-              }</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-          } else if (this.mValue) {</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-              // invalid date, revert to previous date</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineminus">-              // set textBox.value property, not attribute</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineminus">-              this.kTextBox.value = this.formatDate(this.mValue);</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineminus">-          }</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+                if (formattedValue) {</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+                    // format succeeded, safe to set value</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+                    let dateChanged = true;</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+                    if (this.valueValid) {</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+                        dateChanged = this.mValue.getDate() != aValue.getDate() ||</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineplus">+                                      this.mValue.getMonth() != aValue.getMonth() ||</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineplus">+                                      this.mValue.getFullYear() != aValue.getFullYear();</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineplus">+                    }</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+                    this.mValue = aValue;</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineplus">+                    this.kTextBox.value = formattedValue;</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+                    if (aRefresh &amp;&amp; dateChanged) {</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+                        this.fireEvent(&quot;change&quot;);</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineplus">+                    }</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineplus">+                }</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineplus">+            } else if (this.mValue) {</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineplus">+                // invalid date, revert to previous date</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineplus">+                // set textBox.value property, not attribute</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineplus">+                this.kTextBox.value = this.formatDate(this.mValue);</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineplus">+            }</span>
<a href="#l20.417"></a><span id="l20.417">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.418"></a><span id="l20.418">       &lt;/method&gt;</span>
<a href="#l20.419"></a><span id="l20.419"> </span>
<a href="#l20.420"></a><span id="l20.420">       &lt;method name=&quot;onPopup&quot;&gt;</span>
<a href="#l20.421"></a><span id="l20.421">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-          this.mInPopup = true;</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-          this.kMinimonth.update(this.mValue);</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-          this.mInPopup = false;</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineplus">+            this.mInPopup = true;</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineplus">+            this.kMinimonth.update(this.mValue);</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+            this.mInPopup = false;</span>
<a href="#l20.428"></a><span id="l20.428">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.429"></a><span id="l20.429">       &lt;/method&gt;</span>
<a href="#l20.430"></a><span id="l20.430"> </span>
<a href="#l20.431"></a><span id="l20.431">       &lt;method name=&quot;parseTextBoxDate&quot;&gt;</span>
<a href="#l20.432"></a><span id="l20.432">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.433"></a><span id="l20.433">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l20.434"></a><span id="l20.434">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineminus">-          // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineminus">-          // fired inside the update method.</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineminus">-          if (aEvent) {</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-              aEvent.stopPropagation();</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-          }</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineminus">-          this.update(this.parseDateTime(this.kTextBox.value), aRefresh);</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineminus">-          this.lastDateParseIncludedTime = false;</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineplus">+            // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineplus">+            // fired inside the update method.</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineplus">+            if (aEvent) {</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+                aEvent.stopPropagation();</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineplus">+            }</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineplus">+            this.update(this.parseDateTime(this.kTextBox.value), aRefresh);</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineplus">+            this.lastDateParseIncludedTime = false;</span>
<a href="#l20.449"></a><span id="l20.449">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.450"></a><span id="l20.450">       &lt;/method&gt;</span>
<a href="#l20.451"></a><span id="l20.451"> </span>
<a href="#l20.452"></a><span id="l20.452">       &lt;method name=&quot;select&quot;&gt;</span>
<a href="#l20.453"></a><span id="l20.453">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineminus">-          // select all in text box</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineminus">-          this.kTextBox.select();</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineplus">+            // select all in text box</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+            this.kTextBox.select();</span>
<a href="#l20.458"></a><span id="l20.458">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.459"></a><span id="l20.459">       &lt;/method&gt;</span>
<a href="#l20.460"></a><span id="l20.460"> </span>
<a href="#l20.461"></a><span id="l20.461">       &lt;method name=&quot;clickDate&quot;&gt;</span>
<a href="#l20.462"></a><span id="l20.462">         &lt;parameter name=&quot;aEvent&quot; /&gt;</span>
<a href="#l20.463"></a><span id="l20.463">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineminus">-          let datepicker = aEvent.target.parentNode.parentNode.kDatePicker;</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-          if (!datepicker.mInPopup) {</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-              // aEvent.target is the minimonth</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-              datepicker.update(new Date(aEvent.target.value), true);</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineminus">-              // select changed value so no cursor appears (can't type to it).</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineminus">-              datepicker.select();</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-              aEvent.target.parentNode.hidePopup();</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineminus">-          }</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineplus">+            let datepicker = aEvent.target.parentNode.parentNode.kDatePicker;</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineplus">+            if (!datepicker.mInPopup) {</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineplus">+                // aEvent.target is the minimonth</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+                datepicker.update(new Date(aEvent.target.value), true);</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+                // select changed value so no cursor appears (can't type to it).</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+                datepicker.select();</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineplus">+                aEvent.target.parentNode.hidePopup();</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineplus">+            }</span>
<a href="#l20.480"></a><span id="l20.480">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.481"></a><span id="l20.481">       &lt;/method&gt;</span>
<a href="#l20.482"></a><span id="l20.482"> </span>
<a href="#l20.483"></a><span id="l20.483">       &lt;/implementation&gt;</span>
<a href="#l20.484"></a><span id="l20.484"> </span>
<a href="#l20.485"></a><span id="l20.485">       &lt;handlers&gt;</span>
<a href="#l20.486"></a><span id="l20.486">           &lt;handler event=&quot;bindingattached&quot; action=&quot;this.initialize();&quot;/&gt;</span>
<a href="#l20.487"></a><span id="l20.487"> </span>
<a href="#l20.488"></a><span id="l20.488">           &lt;handler event=&quot;blur&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-            this.parseTextBoxDate(true);</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+              this.parseTextBoxDate(true);</span>
<a href="#l20.491"></a><span id="l20.491">           ]]&gt;&lt;/handler&gt;</span>
<a href="#l20.492"></a><span id="l20.492">       &lt;/handlers&gt;</span>
<a href="#l20.493"></a><span id="l20.493"> </span>
<a href="#l20.494"></a><span id="l20.494">   &lt;/binding&gt;</span>
<a href="#l20.495"></a><span id="l20.495"> </span>
<a href="#l20.496"></a><span id="l20.496">   &lt;binding id=&quot;datepicker-forever&quot; extends=&quot;chrome://calendar/content/datetimepickers/datetimepickers.xml#datepicker&quot;&gt;</span>
<a href="#l20.497"></a><span id="l20.497">     &lt;content&gt;</span>
<a href="#l20.498"></a><span id="l20.498">       &lt;xul:hbox flex=&quot;1&quot; id=&quot;hbox&quot; class=&quot;datepicker-box-class&quot;&gt;</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineat">@@ -413,99 +413,99 @@</span>
<a href="#l20.500"></a><span id="l20.500">         &lt;/xul:menulist&gt;</span>
<a href="#l20.501"></a><span id="l20.501">       &lt;/xul:hbox&gt;</span>
<a href="#l20.502"></a><span id="l20.502">     &lt;/content&gt;</span>
<a href="#l20.503"></a><span id="l20.503"> </span>
<a href="#l20.504"></a><span id="l20.504">     &lt;implementation&gt;</span>
<a href="#l20.505"></a><span id="l20.505">       &lt;field name=&quot;mForeverStr&quot;&gt;null&lt;/field&gt;</span>
<a href="#l20.506"></a><span id="l20.506"> </span>
<a href="#l20.507"></a><span id="l20.507">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.510"></a><span id="l20.510"> </span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-        this.mForeverStr = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceForeverLabel&quot;);</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-        document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;menuitemForever&quot;)</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-                .setAttribute(&quot;label&quot;, this.mForeverStr);</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineplus">+          this.mForeverStr = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceForeverLabel&quot;);</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;menuitemForever&quot;)</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineplus">+                  .setAttribute(&quot;label&quot;, this.mForeverStr);</span>
<a href="#l20.517"></a><span id="l20.517">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.518"></a><span id="l20.518"> </span>
<a href="#l20.519"></a><span id="l20.519">       &lt;method name=&quot;parseTextBoxDate&quot;&gt;</span>
<a href="#l20.520"></a><span id="l20.520">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.521"></a><span id="l20.521">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l20.522"></a><span id="l20.522">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineminus">-          if (this.kTextBox.value.toLowerCase() == this.mForeverStr.toLowerCase()) {</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineminus">-              this.mValue = &quot;forever&quot;;</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineminus">-              this.kTextBox.value = this.mForeverStr;</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineminus">-          } else {</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineminus">-              // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineminus">-              // fired inside the update method.</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineminus">-              if (aEvent) {</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineminus">-                  aEvent.stopPropagation();</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineminus">-              }</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineminus">-              let date = this.parseDateTime(this.kTextBox.value);</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-              if (date) {</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-                  this.update(date, aRefresh);</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-              } else {</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-                  // Invalid date, revert to previous date.</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineminus">-                  this.kTextBox.value = this.mValue == &quot;forever&quot; ? this.mForeverStr</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-                                                                 : this.formatDate(this.mValue);</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-              }</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-              this.lastDateParseIncludedTime = false;</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineminus">-          }</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineplus">+            if (this.kTextBox.value.toLowerCase() == this.mForeverStr.toLowerCase()) {</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineplus">+                this.mValue = &quot;forever&quot;;</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineplus">+                this.kTextBox.value = this.mForeverStr;</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineplus">+            } else {</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineplus">+                // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineplus">+                // fired inside the update method.</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineplus">+                if (aEvent) {</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineplus">+                    aEvent.stopPropagation();</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineplus">+                }</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineplus">+                let date = this.parseDateTime(this.kTextBox.value);</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineplus">+                if (date) {</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineplus">+                    this.update(date, aRefresh);</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineplus">+                } else {</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineplus">+                    // Invalid date, revert to previous date.</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineplus">+                    this.kTextBox.value = this.mValue == &quot;forever&quot; ? this.mForeverStr</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineplus">+                                                                   : this.formatDate(this.mValue);</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineplus">+                }</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+                this.lastDateParseIncludedTime = false;</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineplus">+            }</span>
<a href="#l20.561"></a><span id="l20.561">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.562"></a><span id="l20.562">       &lt;/method&gt;</span>
<a href="#l20.563"></a><span id="l20.563"> </span>
<a href="#l20.564"></a><span id="l20.564">       &lt;method name=&quot;onMenuitemForever&quot;&gt;</span>
<a href="#l20.565"></a><span id="l20.565">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineminus">-          if (this.kTextBox.value.toLowerCase() == this.mForeverStr.toLowerCase()) {</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineminus">-              this.mValue = &quot;forever&quot;;</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineminus">-          }</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineplus">+            if (this.kTextBox.value.toLowerCase() == this.mForeverStr.toLowerCase()) {</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineplus">+                this.mValue = &quot;forever&quot;;</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineplus">+            }</span>
<a href="#l20.572"></a><span id="l20.572">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.573"></a><span id="l20.573">       &lt;/method&gt;</span>
<a href="#l20.574"></a><span id="l20.574"> </span>
<a href="#l20.575"></a><span id="l20.575">       &lt;property name=&quot;value&quot;&gt;</span>
<a href="#l20.576"></a><span id="l20.576">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-          return this.mValue;</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineplus">+            return this.mValue;</span>
<a href="#l20.579"></a><span id="l20.579">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.580"></a><span id="l20.580">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineminus">-          if (val == &quot;forever&quot;) {</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineminus">-              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;foreverMenulist&quot;).selectedIndex = 1;</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineminus">-              this.mValue = &quot;forever&quot;;</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-              this.kTextBox.value = this.mForeverStr;</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-          } else {</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-              this.update(val, false);</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineminus">-          }</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineplus">+            if (val == &quot;forever&quot;) {</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineplus">+                document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;foreverMenulist&quot;).selectedIndex = 1;</span>
<a href="#l20.590"></a><span id="l20.590" class="difflineplus">+                this.mValue = &quot;forever&quot;;</span>
<a href="#l20.591"></a><span id="l20.591" class="difflineplus">+                this.kTextBox.value = this.mForeverStr;</span>
<a href="#l20.592"></a><span id="l20.592" class="difflineplus">+            } else {</span>
<a href="#l20.593"></a><span id="l20.593" class="difflineplus">+                this.update(val, false);</span>
<a href="#l20.594"></a><span id="l20.594" class="difflineplus">+            }</span>
<a href="#l20.595"></a><span id="l20.595">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l20.596"></a><span id="l20.596">       &lt;/property&gt;</span>
<a href="#l20.597"></a><span id="l20.597"> </span>
<a href="#l20.598"></a><span id="l20.598">       &lt;property name=&quot;menuitemForever&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l20.599"></a><span id="l20.599">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineminus">-          return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;menuitemForever&quot;);</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineplus">+            return document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;menuitemForever&quot;);</span>
<a href="#l20.602"></a><span id="l20.602">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.603"></a><span id="l20.603">       &lt;/property&gt;</span>
<a href="#l20.604"></a><span id="l20.604"> </span>
<a href="#l20.605"></a><span id="l20.605">       &lt;method name=&quot;onPopup&quot;&gt;</span>
<a href="#l20.606"></a><span id="l20.606">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l20.607"></a><span id="l20.607">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineminus">-          // avoid reinitializing during reshow, for bugs 273914 &amp; 278877 workaround</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineminus">-          if (!this.mIsReshowing) {</span>
<a href="#l20.610"></a><span id="l20.610" class="difflineminus">-              this.mInPopup = true;</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-              if (this.mValue == &quot;forever&quot;) {</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineminus">-                  this.kMinimonth.update(null);</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineminus">-                  this.menuitemForever.setAttribute(&quot;highlight&quot;, &quot;true&quot;);</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineminus">-              } else {</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineminus">-                  this.kMinimonth.update(this.mValue);</span>
<a href="#l20.616"></a><span id="l20.616" class="difflineminus">-                  this.menuitemForever.removeAttribute(&quot;highlight&quot;);</span>
<a href="#l20.617"></a><span id="l20.617" class="difflineminus">-              }</span>
<a href="#l20.618"></a><span id="l20.618" class="difflineminus">-              this.mInPopup = false;</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineminus">-          }</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineplus">+            // avoid reinitializing during reshow, for bugs 273914 &amp; 278877 workaround</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineplus">+            if (!this.mIsReshowing) {</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineplus">+                this.mInPopup = true;</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineplus">+                if (this.mValue == &quot;forever&quot;) {</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineplus">+                    this.kMinimonth.update(null);</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineplus">+                    this.menuitemForever.setAttribute(&quot;highlight&quot;, &quot;true&quot;);</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineplus">+                } else {</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineplus">+                    this.kMinimonth.update(this.mValue);</span>
<a href="#l20.628"></a><span id="l20.628" class="difflineplus">+                    this.menuitemForever.removeAttribute(&quot;highlight&quot;);</span>
<a href="#l20.629"></a><span id="l20.629" class="difflineplus">+                }</span>
<a href="#l20.630"></a><span id="l20.630" class="difflineplus">+                this.mInPopup = false;</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineplus">+            }</span>
<a href="#l20.632"></a><span id="l20.632">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.633"></a><span id="l20.633">       &lt;/method&gt;</span>
<a href="#l20.634"></a><span id="l20.634"> </span>
<a href="#l20.635"></a><span id="l20.635">       &lt;property name=&quot;valueValid&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l20.636"></a><span id="l20.636">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l20.637"></a><span id="l20.637" class="difflineminus">-          return (this.mValue != null &amp;&amp; this.mValue != &quot;forever&quot;);</span>
<a href="#l20.638"></a><span id="l20.638" class="difflineplus">+            return (this.mValue != null &amp;&amp; this.mValue != &quot;forever&quot;);</span>
<a href="#l20.639"></a><span id="l20.639">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l20.640"></a><span id="l20.640">       &lt;/property&gt;</span>
<a href="#l20.641"></a><span id="l20.641">     &lt;/implementation&gt;</span>
<a href="#l20.642"></a><span id="l20.642">   &lt;/binding&gt;</span>
<a href="#l20.643"></a><span id="l20.643"> </span>
<a href="#l20.644"></a><span id="l20.644">   &lt;binding id=&quot;timepicker&quot; extends=&quot;chrome://calendar/content/datetimepickers/datetimepickers.xml#datetimepicker-base&quot;&gt;</span>
<a href="#l20.645"></a><span id="l20.645">     &lt;!-- Desired behavior: when user is done editing the time field</span>
<a href="#l20.646"></a><span id="l20.646">          and either leaves the field (onblur) or closes the dialog</span>
<a href="#l20.647"></a><span id="l20.647" class="difflineat">@@ -541,112 +541,112 @@</span>
<a href="#l20.648"></a><span id="l20.648">             &lt;xul:timepicker-grids anonid=&quot;timepickerGrids&quot;/&gt;</span>
<a href="#l20.649"></a><span id="l20.649">           &lt;/xul:menupopup&gt;</span>
<a href="#l20.650"></a><span id="l20.650">         &lt;/xul:menulist&gt;</span>
<a href="#l20.651"></a><span id="l20.651">       &lt;/xul:hbox&gt;</span>
<a href="#l20.652"></a><span id="l20.652">     &lt;/content&gt;</span>
<a href="#l20.653"></a><span id="l20.653"> </span>
<a href="#l20.654"></a><span id="l20.654">     &lt;implementation&gt;</span>
<a href="#l20.655"></a><span id="l20.655">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineminus">-        let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l20.657"></a><span id="l20.657" class="difflineminus">-        this.kTextBox = hbox.childNodes[0];</span>
<a href="#l20.658"></a><span id="l20.658" class="difflineminus">-        this.kTextBox.kTimePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l20.659"></a><span id="l20.659" class="difflineplus">+          let hbox = document.getAnonymousNodes(this)[0];</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineplus">+          this.kTextBox = hbox.childNodes[0];</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineplus">+          this.kTextBox.kTimePicker = this; // enable call back to method in Moz1.7</span>
<a href="#l20.662"></a><span id="l20.662"> </span>
<a href="#l20.663"></a><span id="l20.663" class="difflineminus">-        let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.664"></a><span id="l20.664" class="difflineminus">-        if (val) {</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineminus">-            this.value = new Date(val);</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineminus">-        } else {</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineminus">-            this.value = new Date();</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineminus">-        }</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineplus">+          if (val) {</span>
<a href="#l20.671"></a><span id="l20.671" class="difflineplus">+              this.value = new Date(val);</span>
<a href="#l20.672"></a><span id="l20.672" class="difflineplus">+          } else {</span>
<a href="#l20.673"></a><span id="l20.673" class="difflineplus">+              this.value = new Date();</span>
<a href="#l20.674"></a><span id="l20.674" class="difflineplus">+          }</span>
<a href="#l20.675"></a><span id="l20.675"> </span>
<a href="#l20.676"></a><span id="l20.676" class="difflineminus">-        // Change the grids in the timepicker-grids for 12-hours time format.</span>
<a href="#l20.677"></a><span id="l20.677" class="difflineminus">-        if (this.ampmIndex) {</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineminus">-            // Find the locale strings for the AM/PM prefix/suffix.</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-            let amTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineminus">-            let pmTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l20.681"></a><span id="l20.681" class="difflineminus">-            let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.682"></a><span id="l20.682" class="difflineminus">-            amTime = formatter.format(amTime);</span>
<a href="#l20.683"></a><span id="l20.683" class="difflineminus">-            pmTime = formatter.format(pmTime);</span>
<a href="#l20.684"></a><span id="l20.684" class="difflineminus">-            let amLabel = this.parseTimeRegExp.exec(amTime)[this.ampmIndex] || &quot;AM&quot;;</span>
<a href="#l20.685"></a><span id="l20.685" class="difflineminus">-            let pmLabel = this.parseTimeRegExp.exec(pmTime)[this.ampmIndex] || &quot;PM&quot;;</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineplus">+          // Change the grids in the timepicker-grids for 12-hours time format.</span>
<a href="#l20.687"></a><span id="l20.687" class="difflineplus">+          if (this.ampmIndex) {</span>
<a href="#l20.688"></a><span id="l20.688" class="difflineplus">+              // Find the locale strings for the AM/PM prefix/suffix.</span>
<a href="#l20.689"></a><span id="l20.689" class="difflineplus">+              let amTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineplus">+              let pmTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineplus">+              let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineplus">+              amTime = formatter.format(amTime);</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineplus">+              pmTime = formatter.format(pmTime);</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineplus">+              let amLabel = this.parseTimeRegExp.exec(amTime)[this.ampmIndex] || &quot;AM&quot;;</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineplus">+              let pmLabel = this.parseTimeRegExp.exec(pmTime)[this.ampmIndex] || &quot;PM&quot;;</span>
<a href="#l20.696"></a><span id="l20.696"> </span>
<a href="#l20.697"></a><span id="l20.697" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timepickerGrids&quot;)</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-                    .changeTo12HoursFormat(amLabel, pmLabel);</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-        }</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineplus">+              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;timepickerGrids&quot;)</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineplus">+                      .changeTo12HoursFormat(amLabel, pmLabel);</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineplus">+          }</span>
<a href="#l20.703"></a><span id="l20.703">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.704"></a><span id="l20.704"> </span>
<a href="#l20.705"></a><span id="l20.705">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l20.706"></a><span id="l20.706">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.707"></a><span id="l20.707">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.708"></a><span id="l20.708">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineminus">-          let timeChanged = false;</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineminus">-          if (aValue != null) {</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineminus">-              if (this.mValue) {</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineminus">-                  timeChanged = this.mValue.getHours() != aValue.getHours() ||</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineminus">-                                this.mValue.getMinutes() != aValue.getMinutes();</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineminus">-              }</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineminus">-              this.mValue = aValue;</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineminus">-          }</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineminus">-          // set textBox.value property, not attribute</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-          this.kTextBox.value = this.formatTime(this.mValue);</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineplus">+            let timeChanged = false;</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineplus">+            if (aValue != null) {</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineplus">+                if (this.mValue) {</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineplus">+                    timeChanged = this.mValue.getHours() != aValue.getHours() ||</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineplus">+                                  this.mValue.getMinutes() != aValue.getMinutes();</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineplus">+                }</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineplus">+                this.mValue = aValue;</span>
<a href="#l20.726"></a><span id="l20.726" class="difflineplus">+            }</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineplus">+            // set textBox.value property, not attribute</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineplus">+            this.kTextBox.value = this.formatTime(this.mValue);</span>
<a href="#l20.729"></a><span id="l20.729"> </span>
<a href="#l20.730"></a><span id="l20.730" class="difflineminus">-          if (aValue != null &amp;&amp; aRefresh &amp;&amp; timeChanged) {</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineminus">-              let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineminus">-              event.initEvent(&quot;change&quot;, true, true);</span>
<a href="#l20.733"></a><span id="l20.733" class="difflineminus">-              this.dispatchEvent(event);</span>
<a href="#l20.734"></a><span id="l20.734" class="difflineminus">-          }</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineplus">+            if (aValue != null &amp;&amp; aRefresh &amp;&amp; timeChanged) {</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineplus">+                let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineplus">+                event.initEvent(&quot;change&quot;, true, true);</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineplus">+                this.dispatchEvent(event);</span>
<a href="#l20.739"></a><span id="l20.739" class="difflineplus">+            }</span>
<a href="#l20.740"></a><span id="l20.740">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.741"></a><span id="l20.741">       &lt;/method&gt;</span>
<a href="#l20.742"></a><span id="l20.742"> </span>
<a href="#l20.743"></a><span id="l20.743">       &lt;method name=&quot;parseTextBoxTime&quot;&gt;</span>
<a href="#l20.744"></a><span id="l20.744">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.745"></a><span id="l20.745">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l20.746"></a><span id="l20.746">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-          // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineminus">-          // fired inside the update method.</span>
<a href="#l20.749"></a><span id="l20.749" class="difflineminus">-          if (aEvent) {</span>
<a href="#l20.750"></a><span id="l20.750" class="difflineminus">-              aEvent.stopPropagation();</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineminus">-          }</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-          let time = this.parseTime(this.kTextBox.value);</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-          this.update(time, aRefresh);</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-          return time;</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineplus">+            // Stop the &quot;change&quot; event propagation. It will be properly</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineplus">+            // fired inside the update method.</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineplus">+            if (aEvent) {</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineplus">+                aEvent.stopPropagation();</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineplus">+            }</span>
<a href="#l20.760"></a><span id="l20.760" class="difflineplus">+            let time = this.parseTime(this.kTextBox.value);</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineplus">+            this.update(time, aRefresh);</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineplus">+            return time;</span>
<a href="#l20.763"></a><span id="l20.763">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.764"></a><span id="l20.764">       &lt;/method&gt;</span>
<a href="#l20.765"></a><span id="l20.765"> </span>
<a href="#l20.766"></a><span id="l20.766">       &lt;method name=&quot;onPopup&quot;&gt;</span>
<a href="#l20.767"></a><span id="l20.767">         &lt;parameter name=&quot;aPopup&quot; /&gt;</span>
<a href="#l20.768"></a><span id="l20.768">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineminus">-          // select all to remove cursor since can't type while popped-up</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineminus">-          this.select();</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineminus">-          let timePickerGrid = aPopup.childNodes[0];</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineminus">-          timePickerGrid.onPopupShowing(this, aPopup);</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineplus">+            // select all to remove cursor since can't type while popped-up</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineplus">+            this.select();</span>
<a href="#l20.775"></a><span id="l20.775" class="difflineplus">+            let timePickerGrid = aPopup.childNodes[0];</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineplus">+            timePickerGrid.onPopupShowing(this, aPopup);</span>
<a href="#l20.777"></a><span id="l20.777">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.778"></a><span id="l20.778">       &lt;/method&gt;</span>
<a href="#l20.779"></a><span id="l20.779"> </span>
<a href="#l20.780"></a><span id="l20.780">       &lt;method name=&quot;onHide&quot;&gt;</span>
<a href="#l20.781"></a><span id="l20.781">         &lt;parameter name=&quot;aPopup&quot;/&gt;</span>
<a href="#l20.782"></a><span id="l20.782">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineminus">-          // This is the timepicker grid.  Why aren't we using anonid?</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineminus">-          aPopup.childNodes[0].onPopupHiding();</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineplus">+            // This is the timepicker grid.  Why aren't we using anonid?</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineplus">+            aPopup.childNodes[0].onPopupHiding();</span>
<a href="#l20.787"></a><span id="l20.787">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.788"></a><span id="l20.788">       &lt;/method&gt;</span>
<a href="#l20.789"></a><span id="l20.789"> </span>
<a href="#l20.790"></a><span id="l20.790">       &lt;method name=&quot;select&quot;&gt;</span>
<a href="#l20.791"></a><span id="l20.791">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineminus">-          // select all in text box</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-          this.kTextBox.select();</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineplus">+            // select all in text box</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineplus">+            this.kTextBox.select();</span>
<a href="#l20.796"></a><span id="l20.796">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.797"></a><span id="l20.797">       &lt;/method&gt;</span>
<a href="#l20.798"></a><span id="l20.798"> </span>
<a href="#l20.799"></a><span id="l20.799">     &lt;/implementation&gt;</span>
<a href="#l20.800"></a><span id="l20.800"> </span>
<a href="#l20.801"></a><span id="l20.801">     &lt;handlers&gt;</span>
<a href="#l20.802"></a><span id="l20.802">       &lt;handler event=&quot;bindingattached&quot; action=&quot;this.initialize();&quot;/&gt;</span>
<a href="#l20.803"></a><span id="l20.803">       &lt;handler event=&quot;blur&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.804"></a><span id="l20.804" class="difflineminus">-        this.parseTextBoxTime(true);</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineplus">+          this.parseTextBoxTime(true);</span>
<a href="#l20.806"></a><span id="l20.806">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l20.807"></a><span id="l20.807">     &lt;/handlers&gt;</span>
<a href="#l20.808"></a><span id="l20.808">   &lt;/binding&gt;</span>
<a href="#l20.809"></a><span id="l20.809"> </span>
<a href="#l20.810"></a><span id="l20.810">   &lt;binding id=&quot;timepicker-hour&quot;&gt;</span>
<a href="#l20.811"></a><span id="l20.811">     &lt;content&gt;</span>
<a href="#l20.812"></a><span id="l20.812">       &lt;xul:spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l20.813"></a><span id="l20.813">       &lt;xul:vbox anonid=&quot;hourbox&quot;</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineat">@@ -661,43 +661,43 @@</span>
<a href="#l20.815"></a><span id="l20.815">     &lt;/content&gt;</span>
<a href="#l20.816"></a><span id="l20.816"> </span>
<a href="#l20.817"></a><span id="l20.817">     &lt;implementation&gt;</span>
<a href="#l20.818"></a><span id="l20.818">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l20.819"></a><span id="l20.819">     &lt;/implementation&gt;</span>
<a href="#l20.820"></a><span id="l20.820"> </span>
<a href="#l20.821"></a><span id="l20.821">     &lt;handlers&gt;</span>
<a href="#l20.822"></a><span id="l20.822">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineminus">-        const pixelThreshold = 50;</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineminus">-        let deltaView = 0;</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineplus">+          const pixelThreshold = 50;</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineplus">+          let deltaView = 0;</span>
<a href="#l20.827"></a><span id="l20.827"> </span>
<a href="#l20.828"></a><span id="l20.828" class="difflineminus">-        if (event.deltaMode == event.DOM_DELTA_PAGE ||</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-            event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineminus">-            // Line/Page scrolling is usually vertical</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineminus">-            if (event.deltaY) {</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineminus">-                deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineminus">-            }</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineminus">-        } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineminus">-            // The natural direction for pixel scrolling is left/right</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineminus">-            this.mPixelScrollDelta += event.deltaX;</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineminus">-            if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineminus">-                deltaView = 1;</span>
<a href="#l20.839"></a><span id="l20.839" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineminus">-            } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-                deltaView = -1;</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineminus">-            }</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineminus">-        }</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineplus">+          if (event.deltaMode == event.DOM_DELTA_PAGE ||</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineplus">+              event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l20.847"></a><span id="l20.847" class="difflineplus">+              // Line/Page scrolling is usually vertical</span>
<a href="#l20.848"></a><span id="l20.848" class="difflineplus">+              if (event.deltaY) {</span>
<a href="#l20.849"></a><span id="l20.849" class="difflineplus">+                  deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineplus">+              }</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineplus">+          } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineplus">+              // The natural direction for pixel scrolling is left/right</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineplus">+              this.mPixelScrollDelta += event.deltaX;</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineplus">+              if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineplus">+                  deltaView = 1;</span>
<a href="#l20.856"></a><span id="l20.856" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l20.857"></a><span id="l20.857" class="difflineplus">+              } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l20.858"></a><span id="l20.858" class="difflineplus">+                  deltaView = -1;</span>
<a href="#l20.859"></a><span id="l20.859" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineplus">+              }</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineplus">+          }</span>
<a href="#l20.862"></a><span id="l20.862"> </span>
<a href="#l20.863"></a><span id="l20.863" class="difflineminus">-        if (deltaView != 0) {</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineminus">-            moveHours(deltaView);</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineminus">-        }</span>
<a href="#l20.866"></a><span id="l20.866" class="difflineplus">+          if (deltaView != 0) {</span>
<a href="#l20.867"></a><span id="l20.867" class="difflineplus">+              moveHours(deltaView);</span>
<a href="#l20.868"></a><span id="l20.868" class="difflineplus">+          }</span>
<a href="#l20.869"></a><span id="l20.869"> </span>
<a href="#l20.870"></a><span id="l20.870" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l20.871"></a><span id="l20.871" class="difflineminus">-        event.preventDefault();</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineplus">+          event.preventDefault();</span>
<a href="#l20.874"></a><span id="l20.874">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l20.875"></a><span id="l20.875">     &lt;/handlers&gt;</span>
<a href="#l20.876"></a><span id="l20.876">   &lt;/binding&gt;</span>
<a href="#l20.877"></a><span id="l20.877"> </span>
<a href="#l20.878"></a><span id="l20.878">   &lt;binding id=&quot;timepicker-minute&quot;&gt;</span>
<a href="#l20.879"></a><span id="l20.879">     &lt;content&gt;</span>
<a href="#l20.880"></a><span id="l20.880">       &lt;xul:spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l20.881"></a><span id="l20.881">       &lt;xul:vbox anonid=&quot;minutebox&quot;</span>
<a href="#l20.882"></a><span id="l20.882" class="difflineat">@@ -710,43 +710,43 @@</span>
<a href="#l20.883"></a><span id="l20.883">     &lt;/content&gt;</span>
<a href="#l20.884"></a><span id="l20.884"> </span>
<a href="#l20.885"></a><span id="l20.885">     &lt;implementation&gt;</span>
<a href="#l20.886"></a><span id="l20.886">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l20.887"></a><span id="l20.887">     &lt;/implementation&gt;</span>
<a href="#l20.888"></a><span id="l20.888"> </span>
<a href="#l20.889"></a><span id="l20.889">     &lt;handlers&gt;</span>
<a href="#l20.890"></a><span id="l20.890">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineminus">-        const pixelThreshold = 50;</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineminus">-        let deltaView = 0;</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineplus">+          const pixelThreshold = 50;</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineplus">+          let deltaView = 0;</span>
<a href="#l20.895"></a><span id="l20.895"> </span>
<a href="#l20.896"></a><span id="l20.896" class="difflineminus">-        if (event.deltaMode == event.DOM_DELTA_PAGE ||</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineminus">-            event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineminus">-            // Line/Page scrolling is usually vertical</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineminus">-            if (event.deltaY) {</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineminus">-                deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l20.901"></a><span id="l20.901" class="difflineminus">-            }</span>
<a href="#l20.902"></a><span id="l20.902" class="difflineminus">-        } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l20.903"></a><span id="l20.903" class="difflineminus">-            // The natural direction for pixel scrolling is left/right</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineminus">-            this.mPixelScrollDelta += event.deltaX;</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineminus">-            if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineminus">-                deltaView = 1;</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineminus">-            } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l20.909"></a><span id="l20.909" class="difflineminus">-                deltaView = -1;</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineminus">-                this.mPixelScrollDelta = 0;</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineminus">-            }</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineminus">-        }</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineplus">+          if (event.deltaMode == event.DOM_DELTA_PAGE ||</span>
<a href="#l20.914"></a><span id="l20.914" class="difflineplus">+              event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineplus">+              // Line/Page scrolling is usually vertical</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineplus">+              if (event.deltaY) {</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineplus">+                  deltaView = event.deltaY &lt; 0 ? -1 : 1;</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineplus">+              }</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineplus">+          } else if (event.deltaMode == event.DOM_DELTA_PIXEL) {</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineplus">+              // The natural direction for pixel scrolling is left/right</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineplus">+              this.mPixelScrollDelta += event.deltaX;</span>
<a href="#l20.922"></a><span id="l20.922" class="difflineplus">+              if (this.mPixelScrollDelta &gt; pixelThreshold) {</span>
<a href="#l20.923"></a><span id="l20.923" class="difflineplus">+                  deltaView = 1;</span>
<a href="#l20.924"></a><span id="l20.924" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineplus">+              } else if (this.mPixelScrollDelta &lt; -pixelThreshold) {</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineplus">+                  deltaView = -1;</span>
<a href="#l20.927"></a><span id="l20.927" class="difflineplus">+                  this.mPixelScrollDelta = 0;</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineplus">+              }</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineplus">+          }</span>
<a href="#l20.930"></a><span id="l20.930"> </span>
<a href="#l20.931"></a><span id="l20.931" class="difflineminus">-        if (deltaView != 0) {</span>
<a href="#l20.932"></a><span id="l20.932" class="difflineminus">-            moveMinutes(deltaView);</span>
<a href="#l20.933"></a><span id="l20.933" class="difflineminus">-        }</span>
<a href="#l20.934"></a><span id="l20.934" class="difflineplus">+          if (deltaView != 0) {</span>
<a href="#l20.935"></a><span id="l20.935" class="difflineplus">+              moveMinutes(deltaView);</span>
<a href="#l20.936"></a><span id="l20.936" class="difflineplus">+          }</span>
<a href="#l20.937"></a><span id="l20.937"> </span>
<a href="#l20.938"></a><span id="l20.938" class="difflineminus">-        event.stopPropagation();</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-        event.preventDefault();</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineplus">+          event.preventDefault();</span>
<a href="#l20.942"></a><span id="l20.942">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l20.943"></a><span id="l20.943">     &lt;/handlers&gt;</span>
<a href="#l20.944"></a><span id="l20.944">   &lt;/binding&gt;</span>
<a href="#l20.945"></a><span id="l20.945"> </span>
<a href="#l20.946"></a><span id="l20.946">   &lt;binding id=&quot;timepicker-grids&quot; extends=&quot;xul:box&quot;&gt;</span>
<a href="#l20.947"></a><span id="l20.947">     &lt;resources&gt;</span>
<a href="#l20.948"></a><span id="l20.948">       &lt;stylesheet src=&quot;chrome://lightning-common/skin/datetimepickers.css&quot;/&gt;</span>
<a href="#l20.949"></a><span id="l20.949">     &lt;/resources&gt;</span>
<a href="#l20.950"></a><span id="l20.950" class="difflineat">@@ -1041,313 +1041,313 @@</span>
<a href="#l20.951"></a><span id="l20.951">             &lt;label class=&quot;time-picker-more-control-label&quot; value=&quot;&amp;laquo;&quot; onclick=&quot;clickLess()&quot;/&gt;</span>
<a href="#l20.952"></a><span id="l20.952">           &lt;/hbox&gt;</span>
<a href="#l20.953"></a><span id="l20.953">         &lt;/vbox&gt; &lt;!-- One  Minute Grid Box --&gt;</span>
<a href="#l20.954"></a><span id="l20.954">       &lt;/vbox&gt; &lt;!-- Box to hold time picker internals --&gt;</span>
<a href="#l20.955"></a><span id="l20.955">     &lt;/content&gt;</span>
<a href="#l20.956"></a><span id="l20.956"> </span>
<a href="#l20.957"></a><span id="l20.957">     &lt;implementation&gt;</span>
<a href="#l20.958"></a><span id="l20.958">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineminus">-        // set by onPopupShowing</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineminus">-        this.mPicker = null;</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineminus">-        this.mPopup = null;</span>
<a href="#l20.962"></a><span id="l20.962" class="difflineplus">+          // set by onPopupShowing</span>
<a href="#l20.963"></a><span id="l20.963" class="difflineplus">+          this.mPicker = null;</span>
<a href="#l20.964"></a><span id="l20.964" class="difflineplus">+          this.mPopup = null;</span>
<a href="#l20.965"></a><span id="l20.965"> </span>
<a href="#l20.966"></a><span id="l20.966" class="difflineminus">-        // The currently selected time</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineminus">-        this.mSelectedTime = new Date();</span>
<a href="#l20.968"></a><span id="l20.968" class="difflineminus">-        // The selected hour and selected minute items</span>
<a href="#l20.969"></a><span id="l20.969" class="difflineminus">-        this.mSelectedHourItem = null;</span>
<a href="#l20.970"></a><span id="l20.970" class="difflineminus">-        this.mSelectedMinuteItem = null;</span>
<a href="#l20.971"></a><span id="l20.971" class="difflineminus">-        // constants use to specify one and five minute view</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineminus">-        this.kMINUTE_VIEW_FIVE = 5;</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineminus">-        this.kMINUTE_VIEW_ONE = 1;</span>
<a href="#l20.974"></a><span id="l20.974" class="difflineplus">+          // The currently selected time</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineplus">+          this.mSelectedTime = new Date();</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineplus">+          // The selected hour and selected minute items</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineplus">+          this.mSelectedHourItem = null;</span>
<a href="#l20.978"></a><span id="l20.978" class="difflineplus">+          this.mSelectedMinuteItem = null;</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineplus">+          // constants use to specify one and five minute view</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineplus">+          this.kMINUTE_VIEW_FIVE = 5;</span>
<a href="#l20.981"></a><span id="l20.981" class="difflineplus">+          this.kMINUTE_VIEW_ONE = 1;</span>
<a href="#l20.982"></a><span id="l20.982">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.983"></a><span id="l20.983"> </span>
<a href="#l20.984"></a><span id="l20.984">       &lt;!-- Set up the picker, called when the popup pops --&gt;</span>
<a href="#l20.985"></a><span id="l20.985">       &lt;method name=&quot;onPopupShowing&quot;&gt;</span>
<a href="#l20.986"></a><span id="l20.986">         &lt;parameter name=&quot;aPicker&quot;/&gt;</span>
<a href="#l20.987"></a><span id="l20.987">         &lt;parameter name=&quot;aPopup&quot;/&gt;</span>
<a href="#l20.988"></a><span id="l20.988">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineminus">-          this.mPicker = aPicker;</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineminus">-          this.mPopup = aPopup;</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineplus">+            this.mPicker = aPicker;</span>
<a href="#l20.992"></a><span id="l20.992" class="difflineplus">+            this.mPopup = aPopup;</span>
<a href="#l20.993"></a><span id="l20.993"> </span>
<a href="#l20.994"></a><span id="l20.994" class="difflineminus">-          // if there is a Date object in the popup item's</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineminus">-          // value attribute, use it, otherwise use Now.</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineminus">-          let inputTime = this.mPicker.value;</span>
<a href="#l20.997"></a><span id="l20.997" class="difflineminus">-          if (inputTime) {</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineminus">-              this.mSelectedTime = new Date(inputTime);</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineminus">-          } else {</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineminus">-              this.mSelectedTime = new Date();</span>
<a href="#l20.1001"></a><span id="l20.1001" class="difflineminus">-          }</span>
<a href="#l20.1002"></a><span id="l20.1002" class="difflineplus">+            // if there is a Date object in the popup item's</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineplus">+            // value attribute, use it, otherwise use Now.</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineplus">+            let inputTime = this.mPicker.value;</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineplus">+            if (inputTime) {</span>
<a href="#l20.1006"></a><span id="l20.1006" class="difflineplus">+                this.mSelectedTime = new Date(inputTime);</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineplus">+            } else {</span>
<a href="#l20.1008"></a><span id="l20.1008" class="difflineplus">+                this.mSelectedTime = new Date();</span>
<a href="#l20.1009"></a><span id="l20.1009" class="difflineplus">+            }</span>
<a href="#l20.1010"></a><span id="l20.1010"> </span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineminus">-          // select the hour item</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineminus">-          let hours24 = this.mSelectedTime.getHours();</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineminus">-          let hourItemId = &quot;time-picker-hour-box-&quot; + hours24;</span>
<a href="#l20.1014"></a><span id="l20.1014" class="difflineminus">-          let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l20.1015"></a><span id="l20.1015" class="difflineminus">-          this.selectHourItem(hourItem);</span>
<a href="#l20.1016"></a><span id="l20.1016" class="difflineplus">+            // select the hour item</span>
<a href="#l20.1017"></a><span id="l20.1017" class="difflineplus">+            let hours24 = this.mSelectedTime.getHours();</span>
<a href="#l20.1018"></a><span id="l20.1018" class="difflineplus">+            let hourItemId = &quot;time-picker-hour-box-&quot; + hours24;</span>
<a href="#l20.1019"></a><span id="l20.1019" class="difflineplus">+            let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineplus">+            this.selectHourItem(hourItem);</span>
<a href="#l20.1021"></a><span id="l20.1021"> </span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineminus">-          // Show the five minute view if we are an even five minutes,</span>
<a href="#l20.1023"></a><span id="l20.1023" class="difflineminus">-          // otherwise one minute view</span>
<a href="#l20.1024"></a><span id="l20.1024" class="difflineminus">-          let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l20.1025"></a><span id="l20.1025" class="difflineplus">+            // Show the five minute view if we are an even five minutes,</span>
<a href="#l20.1026"></a><span id="l20.1026" class="difflineplus">+            // otherwise one minute view</span>
<a href="#l20.1027"></a><span id="l20.1027" class="difflineplus">+            let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l20.1028"></a><span id="l20.1028"> </span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineminus">-          if (minutesByFive == this.mSelectedTime.getMinutes()) {</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineminus">-              this.clickLess();</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineminus">-          } else {</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineminus">-              this.clickMore();</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineminus">-          }</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineplus">+            if (minutesByFive == this.mSelectedTime.getMinutes()) {</span>
<a href="#l20.1035"></a><span id="l20.1035" class="difflineplus">+                this.clickLess();</span>
<a href="#l20.1036"></a><span id="l20.1036" class="difflineplus">+            } else {</span>
<a href="#l20.1037"></a><span id="l20.1037" class="difflineplus">+                this.clickMore();</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineplus">+            }</span>
<a href="#l20.1039"></a><span id="l20.1039">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1040"></a><span id="l20.1040">       &lt;/method&gt;</span>
<a href="#l20.1041"></a><span id="l20.1041"> </span>
<a href="#l20.1042"></a><span id="l20.1042">       &lt;method name=&quot;onPopupHiding&quot;&gt;</span>
<a href="#l20.1043"></a><span id="l20.1043">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineminus">-          if (this.hasChanged) {</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineminus">-              this.timeSelected();</span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineminus">-          }</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineplus">+            if (this.hasChanged) {</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineplus">+                this.timeSelected();</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineplus">+            }</span>
<a href="#l20.1050"></a><span id="l20.1050">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1051"></a><span id="l20.1051">       &lt;/method&gt;</span>
<a href="#l20.1052"></a><span id="l20.1052"> </span>
<a href="#l20.1053"></a><span id="l20.1053">       &lt;!-- Called when the more tab is clicked, and possibly at startup --&gt;</span>
<a href="#l20.1054"></a><span id="l20.1054">       &lt;method name=&quot;clickMore&quot;&gt;</span>
<a href="#l20.1055"></a><span id="l20.1055">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1056"></a><span id="l20.1056" class="difflineminus">-          // switch to one minute view</span>
<a href="#l20.1057"></a><span id="l20.1057" class="difflineminus">-          this.switchMinuteView(this.kMINUTE_VIEW_ONE);</span>
<a href="#l20.1058"></a><span id="l20.1058" class="difflineplus">+            // switch to one minute view</span>
<a href="#l20.1059"></a><span id="l20.1059" class="difflineplus">+            this.switchMinuteView(this.kMINUTE_VIEW_ONE);</span>
<a href="#l20.1060"></a><span id="l20.1060"> </span>
<a href="#l20.1061"></a><span id="l20.1061" class="difflineminus">-          // select minute box corresponding to the time</span>
<a href="#l20.1062"></a><span id="l20.1062" class="difflineminus">-          let minutes = this.mSelectedTime.getMinutes();</span>
<a href="#l20.1063"></a><span id="l20.1063" class="difflineminus">-          let oneMinuteItemId = &quot;time-picker-one-minute-box-&quot; + minutes;</span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineminus">-          let oneMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, oneMinuteItemId);</span>
<a href="#l20.1065"></a><span id="l20.1065" class="difflineminus">-          this.selectMinuteItem(oneMinuteItem);</span>
<a href="#l20.1066"></a><span id="l20.1066" class="difflineplus">+            // select minute box corresponding to the time</span>
<a href="#l20.1067"></a><span id="l20.1067" class="difflineplus">+            let minutes = this.mSelectedTime.getMinutes();</span>
<a href="#l20.1068"></a><span id="l20.1068" class="difflineplus">+            let oneMinuteItemId = &quot;time-picker-one-minute-box-&quot; + minutes;</span>
<a href="#l20.1069"></a><span id="l20.1069" class="difflineplus">+            let oneMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, oneMinuteItemId);</span>
<a href="#l20.1070"></a><span id="l20.1070" class="difflineplus">+            this.selectMinuteItem(oneMinuteItem);</span>
<a href="#l20.1071"></a><span id="l20.1071">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1072"></a><span id="l20.1072">       &lt;/method&gt;</span>
<a href="#l20.1073"></a><span id="l20.1073"> </span>
<a href="#l20.1074"></a><span id="l20.1074">       &lt;!-- Called when the less tab is clicked, and possibly at startup --&gt;</span>
<a href="#l20.1075"></a><span id="l20.1075">       &lt;method name=&quot;clickLess&quot;&gt;</span>
<a href="#l20.1076"></a><span id="l20.1076">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1077"></a><span id="l20.1077" class="difflineminus">-          // switch to five minute view</span>
<a href="#l20.1078"></a><span id="l20.1078" class="difflineminus">-          this.switchMinuteView(this.kMINUTE_VIEW_FIVE);</span>
<a href="#l20.1079"></a><span id="l20.1079" class="difflineplus">+            // switch to five minute view</span>
<a href="#l20.1080"></a><span id="l20.1080" class="difflineplus">+            this.switchMinuteView(this.kMINUTE_VIEW_FIVE);</span>
<a href="#l20.1081"></a><span id="l20.1081"> </span>
<a href="#l20.1082"></a><span id="l20.1082" class="difflineminus">-          // select closest five minute box,</span>
<a href="#l20.1083"></a><span id="l20.1083" class="difflineminus">-          // BUT leave the selected time at what may NOT be an even five minutes</span>
<a href="#l20.1084"></a><span id="l20.1084" class="difflineminus">-          // So that If they click more again the proper non-even-five minute</span>
<a href="#l20.1085"></a><span id="l20.1085" class="difflineminus">-          // box will be selected</span>
<a href="#l20.1086"></a><span id="l20.1086" class="difflineminus">-          let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l20.1087"></a><span id="l20.1087" class="difflineminus">-          let fiveMinuteItemId = &quot;time-picker-five-minute-box-&quot; + minutesByFive;</span>
<a href="#l20.1088"></a><span id="l20.1088" class="difflineminus">-          let fiveMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, fiveMinuteItemId);</span>
<a href="#l20.1089"></a><span id="l20.1089" class="difflineminus">-          this.selectMinuteItem(fiveMinuteItem);</span>
<a href="#l20.1090"></a><span id="l20.1090" class="difflineplus">+            // select closest five minute box,</span>
<a href="#l20.1091"></a><span id="l20.1091" class="difflineplus">+            // BUT leave the selected time at what may NOT be an even five minutes</span>
<a href="#l20.1092"></a><span id="l20.1092" class="difflineplus">+            // So that If they click more again the proper non-even-five minute</span>
<a href="#l20.1093"></a><span id="l20.1093" class="difflineplus">+            // box will be selected</span>
<a href="#l20.1094"></a><span id="l20.1094" class="difflineplus">+            let minutesByFive = this.calcNearestFiveMinutes(this.mSelectedTime);</span>
<a href="#l20.1095"></a><span id="l20.1095" class="difflineplus">+            let fiveMinuteItemId = &quot;time-picker-five-minute-box-&quot; + minutesByFive;</span>
<a href="#l20.1096"></a><span id="l20.1096" class="difflineplus">+            let fiveMinuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, fiveMinuteItemId);</span>
<a href="#l20.1097"></a><span id="l20.1097" class="difflineplus">+            this.selectMinuteItem(fiveMinuteItem);</span>
<a href="#l20.1098"></a><span id="l20.1098">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1099"></a><span id="l20.1099">       &lt;/method&gt;</span>
<a href="#l20.1100"></a><span id="l20.1100"> </span>
<a href="#l20.1101"></a><span id="l20.1101">       &lt;!-- Called when one of the hour boxes is clicked --&gt;</span>
<a href="#l20.1102"></a><span id="l20.1102">       &lt;method name=&quot;clickHour&quot;&gt;</span>
<a href="#l20.1103"></a><span id="l20.1103">         &lt;parameter name=&quot;hourItem&quot;/&gt;</span>
<a href="#l20.1104"></a><span id="l20.1104">         &lt;parameter name=&quot;hourNumber&quot;/&gt;</span>
<a href="#l20.1105"></a><span id="l20.1105">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineminus">-          // select the item</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineminus">-          this.selectHourItem(hourItem);</span>
<a href="#l20.1108"></a><span id="l20.1108" class="difflineplus">+            // select the item</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineplus">+            this.selectHourItem(hourItem);</span>
<a href="#l20.1110"></a><span id="l20.1110"> </span>
<a href="#l20.1111"></a><span id="l20.1111" class="difflineminus">-          // Change the hour in the selected time.</span>
<a href="#l20.1112"></a><span id="l20.1112" class="difflineminus">-          this.mSelectedTime.setHours(hourNumber);</span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineplus">+            // Change the hour in the selected time.</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineplus">+            this.mSelectedTime.setHours(hourNumber);</span>
<a href="#l20.1115"></a><span id="l20.1115"> </span>
<a href="#l20.1116"></a><span id="l20.1116" class="difflineminus">-          this.hasChanged = true;</span>
<a href="#l20.1117"></a><span id="l20.1117" class="difflineplus">+            this.hasChanged = true;</span>
<a href="#l20.1118"></a><span id="l20.1118">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1119"></a><span id="l20.1119">       &lt;/method&gt;</span>
<a href="#l20.1120"></a><span id="l20.1120"> </span>
<a href="#l20.1121"></a><span id="l20.1121">       &lt;!-- Called when one of the hour boxes is double clicked</span>
<a href="#l20.1122"></a><span id="l20.1122">            Sets the time to the selected hour, on the hour, and closes the popup --&gt;</span>
<a href="#l20.1123"></a><span id="l20.1123">       &lt;method name=&quot;doubleClickHour&quot;&gt;</span>
<a href="#l20.1124"></a><span id="l20.1124">         &lt;parameter name=&quot;hourItem&quot;/&gt;</span>
<a href="#l20.1125"></a><span id="l20.1125">         &lt;parameter name=&quot;hourNumber&quot;/&gt;</span>
<a href="#l20.1126"></a><span id="l20.1126">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1127"></a><span id="l20.1127" class="difflineminus">-          // set the minutes to :00</span>
<a href="#l20.1128"></a><span id="l20.1128" class="difflineminus">-          this.mSelectedTime.setMinutes(0);</span>
<a href="#l20.1129"></a><span id="l20.1129" class="difflineplus">+            // set the minutes to :00</span>
<a href="#l20.1130"></a><span id="l20.1130" class="difflineplus">+            this.mSelectedTime.setMinutes(0);</span>
<a href="#l20.1131"></a><span id="l20.1131"> </span>
<a href="#l20.1132"></a><span id="l20.1132" class="difflineminus">-          // remove the popup grid</span>
<a href="#l20.1133"></a><span id="l20.1133" class="difflineminus">-          this.mPopup.hidePopup();</span>
<a href="#l20.1134"></a><span id="l20.1134" class="difflineplus">+            // remove the popup grid</span>
<a href="#l20.1135"></a><span id="l20.1135" class="difflineplus">+            this.mPopup.hidePopup();</span>
<a href="#l20.1136"></a><span id="l20.1136">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1137"></a><span id="l20.1137">       &lt;/method&gt;</span>
<a href="#l20.1138"></a><span id="l20.1138"> </span>
<a href="#l20.1139"></a><span id="l20.1139">       &lt;!-- Called when one of the minute boxes is clicked,</span>
<a href="#l20.1140"></a><span id="l20.1140">            Calls the client's onchange and Closes the popup --&gt;</span>
<a href="#l20.1141"></a><span id="l20.1141">       &lt;method name=&quot;clickMinute&quot;&gt;</span>
<a href="#l20.1142"></a><span id="l20.1142">         &lt;parameter name=&quot;minuteItem&quot;/&gt;</span>
<a href="#l20.1143"></a><span id="l20.1143">         &lt;parameter name=&quot;minuteNumber&quot;/&gt;</span>
<a href="#l20.1144"></a><span id="l20.1144">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1145"></a><span id="l20.1145" class="difflineminus">-          // set the minutes in the selected time</span>
<a href="#l20.1146"></a><span id="l20.1146" class="difflineminus">-          this.mSelectedTime.setMinutes(minuteNumber);</span>
<a href="#l20.1147"></a><span id="l20.1147" class="difflineminus">-          this.selectMinuteItem(minuteItem);</span>
<a href="#l20.1148"></a><span id="l20.1148" class="difflineminus">-          this.hasChanged = true;</span>
<a href="#l20.1149"></a><span id="l20.1149" class="difflineminus">-          // remove the popup grid</span>
<a href="#l20.1150"></a><span id="l20.1150" class="difflineminus">-          this.mPopup.hidePopup();</span>
<a href="#l20.1151"></a><span id="l20.1151" class="difflineplus">+            // set the minutes in the selected time</span>
<a href="#l20.1152"></a><span id="l20.1152" class="difflineplus">+            this.mSelectedTime.setMinutes(minuteNumber);</span>
<a href="#l20.1153"></a><span id="l20.1153" class="difflineplus">+            this.selectMinuteItem(minuteItem);</span>
<a href="#l20.1154"></a><span id="l20.1154" class="difflineplus">+            this.hasChanged = true;</span>
<a href="#l20.1155"></a><span id="l20.1155" class="difflineplus">+            // remove the popup grid</span>
<a href="#l20.1156"></a><span id="l20.1156" class="difflineplus">+            this.mPopup.hidePopup();</span>
<a href="#l20.1157"></a><span id="l20.1157">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1158"></a><span id="l20.1158">       &lt;/method&gt;</span>
<a href="#l20.1159"></a><span id="l20.1159"> </span>
<a href="#l20.1160"></a><span id="l20.1160">       &lt;!-- Called by clickMinute when one of the minute boxes is clicked,</span>
<a href="#l20.1161"></a><span id="l20.1161">            Sets the value property and calls the client's onchange. --&gt;</span>
<a href="#l20.1162"></a><span id="l20.1162">       &lt;method name=&quot;timeSelected&quot;&gt;</span>
<a href="#l20.1163"></a><span id="l20.1163">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1164"></a><span id="l20.1164" class="difflineminus">-          // Copy picked time to avoid problems changing Date object in place</span>
<a href="#l20.1165"></a><span id="l20.1165" class="difflineminus">-          let pickedTime = new Date(this.mSelectedTime);</span>
<a href="#l20.1166"></a><span id="l20.1166" class="difflineplus">+            // Copy picked time to avoid problems changing Date object in place</span>
<a href="#l20.1167"></a><span id="l20.1167" class="difflineplus">+            let pickedTime = new Date(this.mSelectedTime);</span>
<a href="#l20.1168"></a><span id="l20.1168"> </span>
<a href="#l20.1169"></a><span id="l20.1169" class="difflineminus">-          // put the picked time in the value property, and update</span>
<a href="#l20.1170"></a><span id="l20.1170" class="difflineminus">-          this.mPicker.update(pickedTime, true);</span>
<a href="#l20.1171"></a><span id="l20.1171" class="difflineminus">-          // select changed value so no cursor appears (can't type to it).</span>
<a href="#l20.1172"></a><span id="l20.1172" class="difflineminus">-          this.mPicker.select();</span>
<a href="#l20.1173"></a><span id="l20.1173" class="difflineplus">+            // put the picked time in the value property, and update</span>
<a href="#l20.1174"></a><span id="l20.1174" class="difflineplus">+            this.mPicker.update(pickedTime, true);</span>
<a href="#l20.1175"></a><span id="l20.1175" class="difflineplus">+            // select changed value so no cursor appears (can't type to it).</span>
<a href="#l20.1176"></a><span id="l20.1176" class="difflineplus">+            this.mPicker.select();</span>
<a href="#l20.1177"></a><span id="l20.1177">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1178"></a><span id="l20.1178">       &lt;/method&gt;</span>
<a href="#l20.1179"></a><span id="l20.1179"> </span>
<a href="#l20.1180"></a><span id="l20.1180">       &lt;!-- Helper function to switch between &quot;one&quot; and &quot;five&quot; minute views --&gt;</span>
<a href="#l20.1181"></a><span id="l20.1181">       &lt;method name=&quot;switchMinuteView&quot;&gt;</span>
<a href="#l20.1182"></a><span id="l20.1182">         &lt;parameter name=&quot;view&quot;/&gt;</span>
<a href="#l20.1183"></a><span id="l20.1183">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1184"></a><span id="l20.1184" class="difflineminus">-          let fiveMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l20.1185"></a><span id="l20.1185" class="difflineminus">-          let oneMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-one-minute-grid-box&quot;);</span>
<a href="#l20.1186"></a><span id="l20.1186" class="difflineplus">+            let fiveMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l20.1187"></a><span id="l20.1187" class="difflineplus">+            let oneMinuteBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-one-minute-grid-box&quot;);</span>
<a href="#l20.1188"></a><span id="l20.1188"> </span>
<a href="#l20.1189"></a><span id="l20.1189" class="difflineminus">-          if (view == this.kMINUTE_VIEW_ONE) {</span>
<a href="#l20.1190"></a><span id="l20.1190" class="difflineminus">-              fiveMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l20.1191"></a><span id="l20.1191" class="difflineminus">-              oneMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l20.1192"></a><span id="l20.1192" class="difflineminus">-          } else {</span>
<a href="#l20.1193"></a><span id="l20.1193" class="difflineminus">-              fiveMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l20.1194"></a><span id="l20.1194" class="difflineminus">-              oneMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l20.1195"></a><span id="l20.1195" class="difflineminus">-          }</span>
<a href="#l20.1196"></a><span id="l20.1196" class="difflineplus">+            if (view == this.kMINUTE_VIEW_ONE) {</span>
<a href="#l20.1197"></a><span id="l20.1197" class="difflineplus">+                fiveMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l20.1198"></a><span id="l20.1198" class="difflineplus">+                oneMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l20.1199"></a><span id="l20.1199" class="difflineplus">+            } else {</span>
<a href="#l20.1200"></a><span id="l20.1200" class="difflineplus">+                fiveMinuteBox.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l20.1201"></a><span id="l20.1201" class="difflineplus">+                oneMinuteBox.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l20.1202"></a><span id="l20.1202" class="difflineplus">+            }</span>
<a href="#l20.1203"></a><span id="l20.1203">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1204"></a><span id="l20.1204">       &lt;/method&gt;</span>
<a href="#l20.1205"></a><span id="l20.1205"> </span>
<a href="#l20.1206"></a><span id="l20.1206">       &lt;!-- Helper function to select an hour item --&gt;</span>
<a href="#l20.1207"></a><span id="l20.1207">       &lt;method name=&quot;selectHourItem&quot;&gt;</span>
<a href="#l20.1208"></a><span id="l20.1208">         &lt;parameter name=&quot;hourItem&quot;/&gt;</span>
<a href="#l20.1209"></a><span id="l20.1209">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1210"></a><span id="l20.1210" class="difflineminus">-          // clear old selection, if there is one</span>
<a href="#l20.1211"></a><span id="l20.1211" class="difflineminus">-          if (this.mSelectedHourItem != null) {</span>
<a href="#l20.1212"></a><span id="l20.1212" class="difflineminus">-              this.mSelectedHourItem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l20.1213"></a><span id="l20.1213" class="difflineminus">-          }</span>
<a href="#l20.1214"></a><span id="l20.1214" class="difflineminus">-          // set selected attribute, to cause the selected style to apply</span>
<a href="#l20.1215"></a><span id="l20.1215" class="difflineminus">-          hourItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l20.1216"></a><span id="l20.1216" class="difflineminus">-          // remember the selected item so we can deselect it</span>
<a href="#l20.1217"></a><span id="l20.1217" class="difflineminus">-          this.mSelectedHourItem = hourItem;</span>
<a href="#l20.1218"></a><span id="l20.1218" class="difflineplus">+            // clear old selection, if there is one</span>
<a href="#l20.1219"></a><span id="l20.1219" class="difflineplus">+            if (this.mSelectedHourItem != null) {</span>
<a href="#l20.1220"></a><span id="l20.1220" class="difflineplus">+                this.mSelectedHourItem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l20.1221"></a><span id="l20.1221" class="difflineplus">+            }</span>
<a href="#l20.1222"></a><span id="l20.1222" class="difflineplus">+            // set selected attribute, to cause the selected style to apply</span>
<a href="#l20.1223"></a><span id="l20.1223" class="difflineplus">+            hourItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l20.1224"></a><span id="l20.1224" class="difflineplus">+            // remember the selected item so we can deselect it</span>
<a href="#l20.1225"></a><span id="l20.1225" class="difflineplus">+            this.mSelectedHourItem = hourItem;</span>
<a href="#l20.1226"></a><span id="l20.1226">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1227"></a><span id="l20.1227">       &lt;/method&gt;</span>
<a href="#l20.1228"></a><span id="l20.1228"> </span>
<a href="#l20.1229"></a><span id="l20.1229">       &lt;!-- Helper function to select an minute item --&gt;</span>
<a href="#l20.1230"></a><span id="l20.1230">       &lt;method name=&quot;selectMinuteItem&quot;&gt;</span>
<a href="#l20.1231"></a><span id="l20.1231">         &lt;parameter name=&quot;minuteItem&quot;/&gt;</span>
<a href="#l20.1232"></a><span id="l20.1232">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1233"></a><span id="l20.1233" class="difflineminus">-          // clear old selection, if there is one</span>
<a href="#l20.1234"></a><span id="l20.1234" class="difflineminus">-          if (this.mSelectedMinuteItem != null) {</span>
<a href="#l20.1235"></a><span id="l20.1235" class="difflineminus">-              this.mSelectedMinuteItem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l20.1236"></a><span id="l20.1236" class="difflineminus">-          }</span>
<a href="#l20.1237"></a><span id="l20.1237" class="difflineminus">-          // set selected attribute, to cause the selected style to apply</span>
<a href="#l20.1238"></a><span id="l20.1238" class="difflineminus">-          minuteItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l20.1239"></a><span id="l20.1239" class="difflineminus">-          // remember the selected item so we can deselect it</span>
<a href="#l20.1240"></a><span id="l20.1240" class="difflineminus">-          this.mSelectedMinuteItem = minuteItem;</span>
<a href="#l20.1241"></a><span id="l20.1241" class="difflineplus">+            // clear old selection, if there is one</span>
<a href="#l20.1242"></a><span id="l20.1242" class="difflineplus">+            if (this.mSelectedMinuteItem != null) {</span>
<a href="#l20.1243"></a><span id="l20.1243" class="difflineplus">+                this.mSelectedMinuteItem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l20.1244"></a><span id="l20.1244" class="difflineplus">+            }</span>
<a href="#l20.1245"></a><span id="l20.1245" class="difflineplus">+            // set selected attribute, to cause the selected style to apply</span>
<a href="#l20.1246"></a><span id="l20.1246" class="difflineplus">+            minuteItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l20.1247"></a><span id="l20.1247" class="difflineplus">+            // remember the selected item so we can deselect it</span>
<a href="#l20.1248"></a><span id="l20.1248" class="difflineplus">+            this.mSelectedMinuteItem = minuteItem;</span>
<a href="#l20.1249"></a><span id="l20.1249">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1250"></a><span id="l20.1250">       &lt;/method&gt;</span>
<a href="#l20.1251"></a><span id="l20.1251"> </span>
<a href="#l20.1252"></a><span id="l20.1252">       &lt;method name=&quot;moveMinutes&quot;&gt;</span>
<a href="#l20.1253"></a><span id="l20.1253">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l20.1254"></a><span id="l20.1254">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1255"></a><span id="l20.1255" class="difflineminus">-          if (!this.mSelectedTime) {</span>
<a href="#l20.1256"></a><span id="l20.1256" class="difflineminus">-              return;</span>
<a href="#l20.1257"></a><span id="l20.1257" class="difflineminus">-          }</span>
<a href="#l20.1258"></a><span id="l20.1258" class="difflineplus">+            if (!this.mSelectedTime) {</span>
<a href="#l20.1259"></a><span id="l20.1259" class="difflineplus">+                return;</span>
<a href="#l20.1260"></a><span id="l20.1260" class="difflineplus">+            }</span>
<a href="#l20.1261"></a><span id="l20.1261"> </span>
<a href="#l20.1262"></a><span id="l20.1262" class="difflineminus">-          let idPrefix = &quot;time-picker-one-minute-box-&quot;;</span>
<a href="#l20.1263"></a><span id="l20.1263" class="difflineplus">+            let idPrefix = &quot;time-picker-one-minute-box-&quot;;</span>
<a href="#l20.1264"></a><span id="l20.1264"> </span>
<a href="#l20.1265"></a><span id="l20.1265" class="difflineminus">-          // Everything above assumes that we are showing the one-minute-grid,</span>
<a href="#l20.1266"></a><span id="l20.1266" class="difflineminus">-          // If not, we need to do these corrections;</span>
<a href="#l20.1267"></a><span id="l20.1267" class="difflineminus">-          let fiveMinuteBox = document.getAnonymousElementByAttribute(</span>
<a href="#l20.1268"></a><span id="l20.1268" class="difflineminus">-                              this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l20.1269"></a><span id="l20.1269" class="difflineplus">+            // Everything above assumes that we are showing the one-minute-grid,</span>
<a href="#l20.1270"></a><span id="l20.1270" class="difflineplus">+            // If not, we need to do these corrections;</span>
<a href="#l20.1271"></a><span id="l20.1271" class="difflineplus">+            let fiveMinuteBox = document.getAnonymousElementByAttribute(</span>
<a href="#l20.1272"></a><span id="l20.1272" class="difflineplus">+                                this, &quot;anonid&quot;, &quot;time-picker-five-minute-grid-box&quot;);</span>
<a href="#l20.1273"></a><span id="l20.1273"> </span>
<a href="#l20.1274"></a><span id="l20.1274" class="difflineminus">-          if (fiveMinuteBox.getAttribute(&quot;hidden&quot;) == &quot;false&quot;) {</span>
<a href="#l20.1275"></a><span id="l20.1275" class="difflineminus">-              aNumber *= 5;</span>
<a href="#l20.1276"></a><span id="l20.1276" class="difflineminus">-              idPrefix = &quot;time-picker-five-minute-box-&quot;;</span>
<a href="#l20.1277"></a><span id="l20.1277" class="difflineplus">+            if (fiveMinuteBox.getAttribute(&quot;hidden&quot;) == &quot;false&quot;) {</span>
<a href="#l20.1278"></a><span id="l20.1278" class="difflineplus">+                aNumber *= 5;</span>
<a href="#l20.1279"></a><span id="l20.1279" class="difflineplus">+                idPrefix = &quot;time-picker-five-minute-box-&quot;;</span>
<a href="#l20.1280"></a><span id="l20.1280"> </span>
<a href="#l20.1281"></a><span id="l20.1281" class="difflineminus">-              // If the detailed view was shown before, then mSelectedTime.getMinutes</span>
<a href="#l20.1282"></a><span id="l20.1282" class="difflineminus">-              // might not be a multiple of 5.</span>
<a href="#l20.1283"></a><span id="l20.1283" class="difflineminus">-              this.mSelectedTime.setMinutes(this.calcNearestFiveMinutes(this.mSelectedTime));</span>
<a href="#l20.1284"></a><span id="l20.1284" class="difflineminus">-          }</span>
<a href="#l20.1285"></a><span id="l20.1285" class="difflineplus">+                // If the detailed view was shown before, then mSelectedTime.getMinutes</span>
<a href="#l20.1286"></a><span id="l20.1286" class="difflineplus">+                // might not be a multiple of 5.</span>
<a href="#l20.1287"></a><span id="l20.1287" class="difflineplus">+                this.mSelectedTime.setMinutes(this.calcNearestFiveMinutes(this.mSelectedTime));</span>
<a href="#l20.1288"></a><span id="l20.1288" class="difflineplus">+            }</span>
<a href="#l20.1289"></a><span id="l20.1289"> </span>
<a href="#l20.1290"></a><span id="l20.1290" class="difflineminus">-          let newMinutes = this.mSelectedTime.getMinutes() + aNumber;</span>
<a href="#l20.1291"></a><span id="l20.1291" class="difflineplus">+            let newMinutes = this.mSelectedTime.getMinutes() + aNumber;</span>
<a href="#l20.1292"></a><span id="l20.1292"> </span>
<a href="#l20.1293"></a><span id="l20.1293" class="difflineminus">-          // Handle rollover cases</span>
<a href="#l20.1294"></a><span id="l20.1294" class="difflineminus">-          if (newMinutes &lt; 0) {</span>
<a href="#l20.1295"></a><span id="l20.1295" class="difflineminus">-              newMinutes += 60;</span>
<a href="#l20.1296"></a><span id="l20.1296" class="difflineminus">-          }</span>
<a href="#l20.1297"></a><span id="l20.1297" class="difflineminus">-          if (newMinutes &gt; 59) {</span>
<a href="#l20.1298"></a><span id="l20.1298" class="difflineminus">-              newMinutes -= 60;</span>
<a href="#l20.1299"></a><span id="l20.1299" class="difflineminus">-          }</span>
<a href="#l20.1300"></a><span id="l20.1300" class="difflineplus">+            // Handle rollover cases</span>
<a href="#l20.1301"></a><span id="l20.1301" class="difflineplus">+            if (newMinutes &lt; 0) {</span>
<a href="#l20.1302"></a><span id="l20.1302" class="difflineplus">+                newMinutes += 60;</span>
<a href="#l20.1303"></a><span id="l20.1303" class="difflineplus">+            }</span>
<a href="#l20.1304"></a><span id="l20.1304" class="difflineplus">+            if (newMinutes &gt; 59) {</span>
<a href="#l20.1305"></a><span id="l20.1305" class="difflineplus">+                newMinutes -= 60;</span>
<a href="#l20.1306"></a><span id="l20.1306" class="difflineplus">+            }</span>
<a href="#l20.1307"></a><span id="l20.1307"> </span>
<a href="#l20.1308"></a><span id="l20.1308" class="difflineminus">-          this.mSelectedTime.setMinutes(newMinutes);</span>
<a href="#l20.1309"></a><span id="l20.1309" class="difflineplus">+            this.mSelectedTime.setMinutes(newMinutes);</span>
<a href="#l20.1310"></a><span id="l20.1310"> </span>
<a href="#l20.1311"></a><span id="l20.1311" class="difflineminus">-          let minuteItemId = idPrefix + this.mSelectedTime.getMinutes();</span>
<a href="#l20.1312"></a><span id="l20.1312" class="difflineminus">-          let minuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, minuteItemId);</span>
<a href="#l20.1313"></a><span id="l20.1313" class="difflineplus">+            let minuteItemId = idPrefix + this.mSelectedTime.getMinutes();</span>
<a href="#l20.1314"></a><span id="l20.1314" class="difflineplus">+            let minuteItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, minuteItemId);</span>
<a href="#l20.1315"></a><span id="l20.1315"> </span>
<a href="#l20.1316"></a><span id="l20.1316" class="difflineminus">-          this.selectMinuteItem(minuteItem);</span>
<a href="#l20.1317"></a><span id="l20.1317" class="difflineminus">-          this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l20.1318"></a><span id="l20.1318" class="difflineminus">-          this.hasChanged = true;</span>
<a href="#l20.1319"></a><span id="l20.1319" class="difflineplus">+            this.selectMinuteItem(minuteItem);</span>
<a href="#l20.1320"></a><span id="l20.1320" class="difflineplus">+            this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l20.1321"></a><span id="l20.1321" class="difflineplus">+            this.hasChanged = true;</span>
<a href="#l20.1322"></a><span id="l20.1322">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1323"></a><span id="l20.1323">       &lt;/method&gt;</span>
<a href="#l20.1324"></a><span id="l20.1324"> </span>
<a href="#l20.1325"></a><span id="l20.1325">       &lt;method name=&quot;moveHours&quot;&gt;</span>
<a href="#l20.1326"></a><span id="l20.1326">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l20.1327"></a><span id="l20.1327">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1328"></a><span id="l20.1328" class="difflineminus">-          if (!this.mSelectedTime) {</span>
<a href="#l20.1329"></a><span id="l20.1329" class="difflineminus">-              return;</span>
<a href="#l20.1330"></a><span id="l20.1330" class="difflineminus">-          }</span>
<a href="#l20.1331"></a><span id="l20.1331" class="difflineplus">+            if (!this.mSelectedTime) {</span>
<a href="#l20.1332"></a><span id="l20.1332" class="difflineplus">+                return;</span>
<a href="#l20.1333"></a><span id="l20.1333" class="difflineplus">+            }</span>
<a href="#l20.1334"></a><span id="l20.1334"> </span>
<a href="#l20.1335"></a><span id="l20.1335" class="difflineminus">-          let newHours = this.mSelectedTime.getHours() + aNumber;</span>
<a href="#l20.1336"></a><span id="l20.1336" class="difflineplus">+            let newHours = this.mSelectedTime.getHours() + aNumber;</span>
<a href="#l20.1337"></a><span id="l20.1337"> </span>
<a href="#l20.1338"></a><span id="l20.1338" class="difflineminus">-          // Handle rollover cases</span>
<a href="#l20.1339"></a><span id="l20.1339" class="difflineminus">-          if (newHours &lt; 0) {</span>
<a href="#l20.1340"></a><span id="l20.1340" class="difflineminus">-              newHours += 24;</span>
<a href="#l20.1341"></a><span id="l20.1341" class="difflineminus">-          }</span>
<a href="#l20.1342"></a><span id="l20.1342" class="difflineminus">-          if (newHours &gt; 23) {</span>
<a href="#l20.1343"></a><span id="l20.1343" class="difflineminus">-              newHours -= 24;</span>
<a href="#l20.1344"></a><span id="l20.1344" class="difflineminus">-          }</span>
<a href="#l20.1345"></a><span id="l20.1345" class="difflineplus">+            // Handle rollover cases</span>
<a href="#l20.1346"></a><span id="l20.1346" class="difflineplus">+            if (newHours &lt; 0) {</span>
<a href="#l20.1347"></a><span id="l20.1347" class="difflineplus">+                newHours += 24;</span>
<a href="#l20.1348"></a><span id="l20.1348" class="difflineplus">+            }</span>
<a href="#l20.1349"></a><span id="l20.1349" class="difflineplus">+            if (newHours &gt; 23) {</span>
<a href="#l20.1350"></a><span id="l20.1350" class="difflineplus">+                newHours -= 24;</span>
<a href="#l20.1351"></a><span id="l20.1351" class="difflineplus">+            }</span>
<a href="#l20.1352"></a><span id="l20.1352"> </span>
<a href="#l20.1353"></a><span id="l20.1353" class="difflineminus">-          this.mSelectedTime.setHours(newHours);</span>
<a href="#l20.1354"></a><span id="l20.1354" class="difflineplus">+            this.mSelectedTime.setHours(newHours);</span>
<a href="#l20.1355"></a><span id="l20.1355"> </span>
<a href="#l20.1356"></a><span id="l20.1356" class="difflineminus">-          let hourItemId = &quot;time-picker-hour-box-&quot; + this.mSelectedTime.getHours();</span>
<a href="#l20.1357"></a><span id="l20.1357" class="difflineminus">-          let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l20.1358"></a><span id="l20.1358" class="difflineplus">+            let hourItemId = &quot;time-picker-hour-box-&quot; + this.mSelectedTime.getHours();</span>
<a href="#l20.1359"></a><span id="l20.1359" class="difflineplus">+            let hourItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, hourItemId);</span>
<a href="#l20.1360"></a><span id="l20.1360"> </span>
<a href="#l20.1361"></a><span id="l20.1361" class="difflineminus">-          this.selectHourItem(hourItem);</span>
<a href="#l20.1362"></a><span id="l20.1362" class="difflineminus">-          this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l20.1363"></a><span id="l20.1363" class="difflineminus">-          this.hasChanged = true;</span>
<a href="#l20.1364"></a><span id="l20.1364" class="difflineplus">+            this.selectHourItem(hourItem);</span>
<a href="#l20.1365"></a><span id="l20.1365" class="difflineplus">+            this.mPicker.kTextBox.value = this.mPicker.formatTime(this.mSelectedTime);</span>
<a href="#l20.1366"></a><span id="l20.1366" class="difflineplus">+            this.hasChanged = true;</span>
<a href="#l20.1367"></a><span id="l20.1367">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1368"></a><span id="l20.1368">       &lt;/method&gt;</span>
<a href="#l20.1369"></a><span id="l20.1369"> </span>
<a href="#l20.1370"></a><span id="l20.1370">       &lt;!-- Helper function to calulate the nearest even five minutes --&gt;</span>
<a href="#l20.1371"></a><span id="l20.1371">       &lt;method name=&quot;calcNearestFiveMinutes&quot;&gt;</span>
<a href="#l20.1372"></a><span id="l20.1372">         &lt;parameter name=&quot;time&quot;/&gt;</span>
<a href="#l20.1373"></a><span id="l20.1373">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1374"></a><span id="l20.1374" class="difflineminus">-          let minutes = time.getMinutes();</span>
<a href="#l20.1375"></a><span id="l20.1375" class="difflineminus">-          let minutesByFive = Math.round(minutes / 5) * 5;</span>
<a href="#l20.1376"></a><span id="l20.1376" class="difflineplus">+            let minutes = time.getMinutes();</span>
<a href="#l20.1377"></a><span id="l20.1377" class="difflineplus">+            let minutesByFive = Math.round(minutes / 5) * 5;</span>
<a href="#l20.1378"></a><span id="l20.1378"> </span>
<a href="#l20.1379"></a><span id="l20.1379" class="difflineminus">-          if (minutesByFive &gt; 59) {</span>
<a href="#l20.1380"></a><span id="l20.1380" class="difflineminus">-              minutesByFive = 55;</span>
<a href="#l20.1381"></a><span id="l20.1381" class="difflineminus">-          }</span>
<a href="#l20.1382"></a><span id="l20.1382" class="difflineminus">-          return minutesByFive;</span>
<a href="#l20.1383"></a><span id="l20.1383" class="difflineplus">+            if (minutesByFive &gt; 59) {</span>
<a href="#l20.1384"></a><span id="l20.1384" class="difflineplus">+                minutesByFive = 55;</span>
<a href="#l20.1385"></a><span id="l20.1385" class="difflineplus">+            }</span>
<a href="#l20.1386"></a><span id="l20.1386" class="difflineplus">+            return minutesByFive;</span>
<a href="#l20.1387"></a><span id="l20.1387">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1388"></a><span id="l20.1388">       &lt;/method&gt;</span>
<a href="#l20.1389"></a><span id="l20.1389"> </span>
<a href="#l20.1390"></a><span id="l20.1390">       &lt;method name=&quot;changeTo12HoursFormat&quot;&gt;</span>
<a href="#l20.1391"></a><span id="l20.1391">         &lt;parameter name=&quot;aAmLabel&quot;/&gt;</span>
<a href="#l20.1392"></a><span id="l20.1392">         &lt;parameter name=&quot;aPmLabel&quot;/&gt;</span>
<a href="#l20.1393"></a><span id="l20.1393">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1394"></a><span id="l20.1394" class="difflineminus">-          let amLabelBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;amLabelBox&quot;);</span>
<a href="#l20.1395"></a><span id="l20.1395" class="difflineminus">-          amLabelBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l20.1396"></a><span id="l20.1396" class="difflineminus">-          amLabelBox.firstChild.setAttribute(&quot;value&quot;, aAmLabel);</span>
<a href="#l20.1397"></a><span id="l20.1397" class="difflineminus">-          let pmLabelBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;pmLabelBox&quot;);</span>
<a href="#l20.1398"></a><span id="l20.1398" class="difflineminus">-          pmLabelBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l20.1399"></a><span id="l20.1399" class="difflineminus">-          pmLabelBox.firstChild.setAttribute(&quot;value&quot;, aPmLabel);</span>
<a href="#l20.1400"></a><span id="l20.1400" class="difflineminus">-          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-box-0&quot;)</span>
<a href="#l20.1401"></a><span id="l20.1401" class="difflineminus">-                  .setAttribute(&quot;label&quot;, &quot;12&quot;);</span>
<a href="#l20.1402"></a><span id="l20.1402" class="difflineminus">-          for (let i = 13; i &lt; 24; i++) {</span>
<a href="#l20.1403"></a><span id="l20.1403" class="difflineminus">-              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-box-&quot; + i)</span>
<a href="#l20.1404"></a><span id="l20.1404" class="difflineminus">-                      .setAttribute(&quot;label&quot;, i - 12);</span>
<a href="#l20.1405"></a><span id="l20.1405" class="difflineminus">-          }</span>
<a href="#l20.1406"></a><span id="l20.1406" class="difflineminus">-          document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-grid&quot;)</span>
<a href="#l20.1407"></a><span id="l20.1407" class="difflineminus">-                  .setAttribute(&quot;format12hours&quot;, &quot;true&quot;);</span>
<a href="#l20.1408"></a><span id="l20.1408" class="difflineplus">+            let amLabelBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;amLabelBox&quot;);</span>
<a href="#l20.1409"></a><span id="l20.1409" class="difflineplus">+            amLabelBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l20.1410"></a><span id="l20.1410" class="difflineplus">+            amLabelBox.firstChild.setAttribute(&quot;value&quot;, aAmLabel);</span>
<a href="#l20.1411"></a><span id="l20.1411" class="difflineplus">+            let pmLabelBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;pmLabelBox&quot;);</span>
<a href="#l20.1412"></a><span id="l20.1412" class="difflineplus">+            pmLabelBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l20.1413"></a><span id="l20.1413" class="difflineplus">+            pmLabelBox.firstChild.setAttribute(&quot;value&quot;, aPmLabel);</span>
<a href="#l20.1414"></a><span id="l20.1414" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-box-0&quot;)</span>
<a href="#l20.1415"></a><span id="l20.1415" class="difflineplus">+                    .setAttribute(&quot;label&quot;, &quot;12&quot;);</span>
<a href="#l20.1416"></a><span id="l20.1416" class="difflineplus">+            for (let i = 13; i &lt; 24; i++) {</span>
<a href="#l20.1417"></a><span id="l20.1417" class="difflineplus">+                document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-box-&quot; + i)</span>
<a href="#l20.1418"></a><span id="l20.1418" class="difflineplus">+                        .setAttribute(&quot;label&quot;, i - 12);</span>
<a href="#l20.1419"></a><span id="l20.1419" class="difflineplus">+            }</span>
<a href="#l20.1420"></a><span id="l20.1420" class="difflineplus">+            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker-hour-grid&quot;)</span>
<a href="#l20.1421"></a><span id="l20.1421" class="difflineplus">+                    .setAttribute(&quot;format12hours&quot;, &quot;true&quot;);</span>
<a href="#l20.1422"></a><span id="l20.1422">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1423"></a><span id="l20.1423">       &lt;/method&gt;</span>
<a href="#l20.1424"></a><span id="l20.1424">     &lt;/implementation&gt;</span>
<a href="#l20.1425"></a><span id="l20.1425"> </span>
<a href="#l20.1426"></a><span id="l20.1426">     &lt;handlers&gt;</span>
<a href="#l20.1427"></a><span id="l20.1427">       &lt;handler event=&quot;bindingattached&quot; action=&quot;this.initialize();&quot;/&gt;</span>
<a href="#l20.1428"></a><span id="l20.1428">     &lt;/handlers&gt;</span>
<a href="#l20.1429"></a><span id="l20.1429">   &lt;/binding&gt;</span>
<a href="#l20.1430"></a><span id="l20.1430" class="difflineat">@@ -1375,76 +1375,76 @@</span>
<a href="#l20.1431"></a><span id="l20.1431"> </span>
<a href="#l20.1432"></a><span id="l20.1432">       &lt;!-- timepicker may be disabled alone for all day events --&gt;</span>
<a href="#l20.1433"></a><span id="l20.1433">       &lt;property name=&quot;timepickerdisabled&quot;</span>
<a href="#l20.1434"></a><span id="l20.1434">                 onset=&quot;if (val) this.kTimePicker.setAttribute('disabled', 'true');</span>
<a href="#l20.1435"></a><span id="l20.1435">                        else this.kTimePicker.removeAttribute('disabled');&quot;</span>
<a href="#l20.1436"></a><span id="l20.1436">                 onget=&quot;return this.kTimePicker.getAttribute('disabled')=='true';&quot;/&gt;</span>
<a href="#l20.1437"></a><span id="l20.1437"> </span>
<a href="#l20.1438"></a><span id="l20.1438">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.1439"></a><span id="l20.1439" class="difflineminus">-        this.kDatePicker =</span>
<a href="#l20.1440"></a><span id="l20.1440" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-picker&quot;);</span>
<a href="#l20.1441"></a><span id="l20.1441" class="difflineminus">-        this.kTimePicker =</span>
<a href="#l20.1442"></a><span id="l20.1442" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l20.1443"></a><span id="l20.1443" class="difflineplus">+          this.kDatePicker =</span>
<a href="#l20.1444"></a><span id="l20.1444" class="difflineplus">+              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-picker&quot;);</span>
<a href="#l20.1445"></a><span id="l20.1445" class="difflineplus">+          this.kTimePicker =</span>
<a href="#l20.1446"></a><span id="l20.1446" class="difflineplus">+              document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l20.1447"></a><span id="l20.1447"> </span>
<a href="#l20.1448"></a><span id="l20.1448" class="difflineminus">-        let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.1449"></a><span id="l20.1449" class="difflineminus">-        this.mValue = (val ? new Date(val)</span>
<a href="#l20.1450"></a><span id="l20.1450" class="difflineminus">-                           : new Date());</span>
<a href="#l20.1451"></a><span id="l20.1451" class="difflineplus">+          let val = this.getAttribute(&quot;value&quot;);</span>
<a href="#l20.1452"></a><span id="l20.1452" class="difflineplus">+          this.mValue = (val ? new Date(val)</span>
<a href="#l20.1453"></a><span id="l20.1453" class="difflineplus">+                             : new Date());</span>
<a href="#l20.1454"></a><span id="l20.1454">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.1455"></a><span id="l20.1455"> </span>
<a href="#l20.1456"></a><span id="l20.1456">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l20.1457"></a><span id="l20.1457">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.1458"></a><span id="l20.1458">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.1459"></a><span id="l20.1459">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1460"></a><span id="l20.1460" class="difflineminus">-          if (aValue != null) {</span>
<a href="#l20.1461"></a><span id="l20.1461" class="difflineminus">-              this.mValue = aValue;</span>
<a href="#l20.1462"></a><span id="l20.1462" class="difflineminus">-          }</span>
<a href="#l20.1463"></a><span id="l20.1463" class="difflineminus">-          // set textBox.value property, not attribute</span>
<a href="#l20.1464"></a><span id="l20.1464" class="difflineminus">-          this.kDatePicker.update(this.mValue, aRefresh);</span>
<a href="#l20.1465"></a><span id="l20.1465" class="difflineminus">-          this.kTimePicker.update(this.mValue, aRefresh);</span>
<a href="#l20.1466"></a><span id="l20.1466" class="difflineminus">-          if (aRefresh) {</span>
<a href="#l20.1467"></a><span id="l20.1467" class="difflineminus">-              this.fireEvent(&quot;change&quot;);</span>
<a href="#l20.1468"></a><span id="l20.1468" class="difflineminus">-          }</span>
<a href="#l20.1469"></a><span id="l20.1469" class="difflineplus">+            if (aValue != null) {</span>
<a href="#l20.1470"></a><span id="l20.1470" class="difflineplus">+                this.mValue = aValue;</span>
<a href="#l20.1471"></a><span id="l20.1471" class="difflineplus">+            }</span>
<a href="#l20.1472"></a><span id="l20.1472" class="difflineplus">+            // set textBox.value property, not attribute</span>
<a href="#l20.1473"></a><span id="l20.1473" class="difflineplus">+            this.kDatePicker.update(this.mValue, aRefresh);</span>
<a href="#l20.1474"></a><span id="l20.1474" class="difflineplus">+            this.kTimePicker.update(this.mValue, aRefresh);</span>
<a href="#l20.1475"></a><span id="l20.1475" class="difflineplus">+            if (aRefresh) {</span>
<a href="#l20.1476"></a><span id="l20.1476" class="difflineplus">+                this.fireEvent(&quot;change&quot;);</span>
<a href="#l20.1477"></a><span id="l20.1477" class="difflineplus">+            }</span>
<a href="#l20.1478"></a><span id="l20.1478">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1479"></a><span id="l20.1479">       &lt;/method&gt;</span>
<a href="#l20.1480"></a><span id="l20.1480"> </span>
<a href="#l20.1481"></a><span id="l20.1481">       &lt;!-- Date was changed by gui: update value. --&gt;</span>
<a href="#l20.1482"></a><span id="l20.1482">       &lt;method name=&quot;onDatePick&quot;&gt;</span>
<a href="#l20.1483"></a><span id="l20.1483">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1484"></a><span id="l20.1484" class="difflineminus">-          let tempTime;</span>
<a href="#l20.1485"></a><span id="l20.1485" class="difflineminus">-          if (this.kDatePicker.lastDateParseIncludedTime) {</span>
<a href="#l20.1486"></a><span id="l20.1486" class="difflineminus">-              tempTime = new Date(this.kDatePicker.value);</span>
<a href="#l20.1487"></a><span id="l20.1487" class="difflineminus">-          } else {</span>
<a href="#l20.1488"></a><span id="l20.1488" class="difflineminus">-              tempTime = new Date(this.mValue);</span>
<a href="#l20.1489"></a><span id="l20.1489" class="difflineminus">-          }</span>
<a href="#l20.1490"></a><span id="l20.1490" class="difflineminus">-          let newDate = new Date(this.kDatePicker.value);</span>
<a href="#l20.1491"></a><span id="l20.1491" class="difflineminus">-          // Note: create new date because setting month and date of month in</span>
<a href="#l20.1492"></a><span id="l20.1492" class="difflineminus">-          // either order can lead to unexpected results (month may be advanced</span>
<a href="#l20.1493"></a><span id="l20.1493" class="difflineminus">-          // automatically if day of month is temporarily out of range).</span>
<a href="#l20.1494"></a><span id="l20.1494" class="difflineminus">-          let dateTime = new Date(newDate.getFullYear(),</span>
<a href="#l20.1495"></a><span id="l20.1495" class="difflineminus">-                                  newDate.getMonth(),</span>
<a href="#l20.1496"></a><span id="l20.1496" class="difflineminus">-                                  newDate.getDate(),</span>
<a href="#l20.1497"></a><span id="l20.1497" class="difflineminus">-                                  tempTime.getHours(),</span>
<a href="#l20.1498"></a><span id="l20.1498" class="difflineminus">-                                  tempTime.getMinutes(),</span>
<a href="#l20.1499"></a><span id="l20.1499" class="difflineminus">-                                  tempTime.getSeconds());</span>
<a href="#l20.1500"></a><span id="l20.1500" class="difflineminus">-          this.mValue = dateTime;</span>
<a href="#l20.1501"></a><span id="l20.1501" class="difflineminus">-          this.kTimePicker.update(dateTime, false);</span>
<a href="#l20.1502"></a><span id="l20.1502" class="difflineplus">+            let tempTime;</span>
<a href="#l20.1503"></a><span id="l20.1503" class="difflineplus">+            if (this.kDatePicker.lastDateParseIncludedTime) {</span>
<a href="#l20.1504"></a><span id="l20.1504" class="difflineplus">+                tempTime = new Date(this.kDatePicker.value);</span>
<a href="#l20.1505"></a><span id="l20.1505" class="difflineplus">+            } else {</span>
<a href="#l20.1506"></a><span id="l20.1506" class="difflineplus">+                tempTime = new Date(this.mValue);</span>
<a href="#l20.1507"></a><span id="l20.1507" class="difflineplus">+            }</span>
<a href="#l20.1508"></a><span id="l20.1508" class="difflineplus">+            let newDate = new Date(this.kDatePicker.value);</span>
<a href="#l20.1509"></a><span id="l20.1509" class="difflineplus">+            // Note: create new date because setting month and date of month in</span>
<a href="#l20.1510"></a><span id="l20.1510" class="difflineplus">+            // either order can lead to unexpected results (month may be advanced</span>
<a href="#l20.1511"></a><span id="l20.1511" class="difflineplus">+            // automatically if day of month is temporarily out of range).</span>
<a href="#l20.1512"></a><span id="l20.1512" class="difflineplus">+            let dateTime = new Date(newDate.getFullYear(),</span>
<a href="#l20.1513"></a><span id="l20.1513" class="difflineplus">+                                    newDate.getMonth(),</span>
<a href="#l20.1514"></a><span id="l20.1514" class="difflineplus">+                                    newDate.getDate(),</span>
<a href="#l20.1515"></a><span id="l20.1515" class="difflineplus">+                                    tempTime.getHours(),</span>
<a href="#l20.1516"></a><span id="l20.1516" class="difflineplus">+                                    tempTime.getMinutes(),</span>
<a href="#l20.1517"></a><span id="l20.1517" class="difflineplus">+                                    tempTime.getSeconds());</span>
<a href="#l20.1518"></a><span id="l20.1518" class="difflineplus">+            this.mValue = dateTime;</span>
<a href="#l20.1519"></a><span id="l20.1519" class="difflineplus">+            this.kTimePicker.update(dateTime, false);</span>
<a href="#l20.1520"></a><span id="l20.1520">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1521"></a><span id="l20.1521">       &lt;/method&gt;</span>
<a href="#l20.1522"></a><span id="l20.1522"> </span>
<a href="#l20.1523"></a><span id="l20.1523">       &lt;!-- Time was changed by gui: update value --&gt;</span>
<a href="#l20.1524"></a><span id="l20.1524">       &lt;method name=&quot;onTimePick&quot;&gt;</span>
<a href="#l20.1525"></a><span id="l20.1525">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1526"></a><span id="l20.1526" class="difflineminus">-          let dateTime = new Date(this.mValue);</span>
<a href="#l20.1527"></a><span id="l20.1527" class="difflineminus">-          let newTime = this.kTimePicker.value;</span>
<a href="#l20.1528"></a><span id="l20.1528" class="difflineminus">-          dateTime.setHours(newTime.getHours());</span>
<a href="#l20.1529"></a><span id="l20.1529" class="difflineminus">-          dateTime.setMinutes(newTime.getMinutes());</span>
<a href="#l20.1530"></a><span id="l20.1530" class="difflineminus">-          dateTime.setSeconds(newTime.getSeconds());</span>
<a href="#l20.1531"></a><span id="l20.1531" class="difflineminus">-          this.mValue = dateTime;</span>
<a href="#l20.1532"></a><span id="l20.1532" class="difflineminus">-          this.kDatePicker.update(dateTime, false);</span>
<a href="#l20.1533"></a><span id="l20.1533" class="difflineplus">+            let dateTime = new Date(this.mValue);</span>
<a href="#l20.1534"></a><span id="l20.1534" class="difflineplus">+            let newTime = this.kTimePicker.value;</span>
<a href="#l20.1535"></a><span id="l20.1535" class="difflineplus">+            dateTime.setHours(newTime.getHours());</span>
<a href="#l20.1536"></a><span id="l20.1536" class="difflineplus">+            dateTime.setMinutes(newTime.getMinutes());</span>
<a href="#l20.1537"></a><span id="l20.1537" class="difflineplus">+            dateTime.setSeconds(newTime.getSeconds());</span>
<a href="#l20.1538"></a><span id="l20.1538" class="difflineplus">+            this.mValue = dateTime;</span>
<a href="#l20.1539"></a><span id="l20.1539" class="difflineplus">+            this.kDatePicker.update(dateTime, false);</span>
<a href="#l20.1540"></a><span id="l20.1540">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1541"></a><span id="l20.1541">       &lt;/method&gt;</span>
<a href="#l20.1542"></a><span id="l20.1542">     &lt;/implementation&gt;</span>
<a href="#l20.1543"></a><span id="l20.1543"> </span>
<a href="#l20.1544"></a><span id="l20.1544">     &lt;handlers&gt;</span>
<a href="#l20.1545"></a><span id="l20.1545">       &lt;handler event=&quot;bindingattached&quot; action=&quot;this.initialize();&quot;/&gt;</span>
<a href="#l20.1546"></a><span id="l20.1546">     &lt;/handlers&gt;</span>
<a href="#l20.1547"></a><span id="l20.1547"> </span>
<a href="#l20.1548"></a><span id="l20.1548" class="difflineat">@@ -1452,142 +1452,142 @@</span>
<a href="#l20.1549"></a><span id="l20.1549"> </span>
<a href="#l20.1550"></a><span id="l20.1550">   &lt;binding id=&quot;datetimepicker-base&quot; extends=&quot;chrome://global/content/bindings/general.xml#basecontrol&quot;</span>
<a href="#l20.1551"></a><span id="l20.1551">            inherits=&quot;value,onchange&quot;&gt;</span>
<a href="#l20.1552"></a><span id="l20.1552">     &lt;resources&gt;</span>
<a href="#l20.1553"></a><span id="l20.1553">       &lt;stylesheet src=&quot;chrome://lightning-common/skin/datetimepickers.css&quot;/&gt;</span>
<a href="#l20.1554"></a><span id="l20.1554">     &lt;/resources&gt;</span>
<a href="#l20.1555"></a><span id="l20.1555">     &lt;implementation&gt;</span>
<a href="#l20.1556"></a><span id="l20.1556">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l20.1557"></a><span id="l20.1557" class="difflineminus">-        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.1558"></a><span id="l20.1558" class="difflineminus">-        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.1559"></a><span id="l20.1559" class="difflineplus">+          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.1560"></a><span id="l20.1560" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.1561"></a><span id="l20.1561"> </span>
<a href="#l20.1562"></a><span id="l20.1562" class="difflineminus">-        this.kTimeFormatObject = { timeStyle: &quot;short&quot; };</span>
<a href="#l20.1563"></a><span id="l20.1563" class="difflineminus">-        this.initDateFormat();</span>
<a href="#l20.1564"></a><span id="l20.1564" class="difflineminus">-        this.initTimeFormat();</span>
<a href="#l20.1565"></a><span id="l20.1565" class="difflineplus">+          this.kTimeFormatObject = { timeStyle: &quot;short&quot; };</span>
<a href="#l20.1566"></a><span id="l20.1566" class="difflineplus">+          this.initDateFormat();</span>
<a href="#l20.1567"></a><span id="l20.1567" class="difflineplus">+          this.initTimeFormat();</span>
<a href="#l20.1568"></a><span id="l20.1568">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l20.1569"></a><span id="l20.1569"> </span>
<a href="#l20.1570"></a><span id="l20.1570">       &lt;property name=&quot;value&quot;</span>
<a href="#l20.1571"></a><span id="l20.1571">                 onget=&quot;return this.mValue&quot;</span>
<a href="#l20.1572"></a><span id="l20.1572">                 onset=&quot;this.update(val, false)&quot;/&gt;</span>
<a href="#l20.1573"></a><span id="l20.1573"> </span>
<a href="#l20.1574"></a><span id="l20.1574">       &lt;property name=&quot;lastDateParseIncludedTime&quot;</span>
<a href="#l20.1575"></a><span id="l20.1575">                 onget=&quot;return this.mLastDateParseIncludedTime;&quot;</span>
<a href="#l20.1576"></a><span id="l20.1576">                 onset=&quot;this.mLastDateParseIncludedTime = val;&quot; /&gt;</span>
<a href="#l20.1577"></a><span id="l20.1577"> </span>
<a href="#l20.1578"></a><span id="l20.1578">       &lt;method name=&quot;update&quot;&gt;</span>
<a href="#l20.1579"></a><span id="l20.1579">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.1580"></a><span id="l20.1580">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l20.1581"></a><span id="l20.1581">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1582"></a><span id="l20.1582" class="difflineminus">-          if (aValue != null) {</span>
<a href="#l20.1583"></a><span id="l20.1583" class="difflineminus">-              this.mValue = aValue;</span>
<a href="#l20.1584"></a><span id="l20.1584" class="difflineminus">-          }</span>
<a href="#l20.1585"></a><span id="l20.1585" class="difflineplus">+            if (aValue != null) {</span>
<a href="#l20.1586"></a><span id="l20.1586" class="difflineplus">+                this.mValue = aValue;</span>
<a href="#l20.1587"></a><span id="l20.1587" class="difflineplus">+            }</span>
<a href="#l20.1588"></a><span id="l20.1588">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1589"></a><span id="l20.1589">       &lt;/method&gt;</span>
<a href="#l20.1590"></a><span id="l20.1590"> </span>
<a href="#l20.1591"></a><span id="l20.1591">       &lt;method name=&quot;fireEvent&quot;&gt;</span>
<a href="#l20.1592"></a><span id="l20.1592">         &lt;parameter name=&quot;aEventName&quot;/&gt;</span>
<a href="#l20.1593"></a><span id="l20.1593">         &lt;parameter name=&quot;aDetail&quot;/&gt;</span>
<a href="#l20.1594"></a><span id="l20.1594">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1595"></a><span id="l20.1595" class="difflineminus">-          let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l20.1596"></a><span id="l20.1596" class="difflineminus">-          event.initEvent(aEventName, true, true);</span>
<a href="#l20.1597"></a><span id="l20.1597" class="difflineminus">-          event.detail = aDetail;</span>
<a href="#l20.1598"></a><span id="l20.1598" class="difflineminus">-          this.dispatchEvent(event);</span>
<a href="#l20.1599"></a><span id="l20.1599" class="difflineplus">+            let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l20.1600"></a><span id="l20.1600" class="difflineplus">+            event.initEvent(aEventName, true, true);</span>
<a href="#l20.1601"></a><span id="l20.1601" class="difflineplus">+            event.detail = aDetail;</span>
<a href="#l20.1602"></a><span id="l20.1602" class="difflineplus">+            this.dispatchEvent(event);</span>
<a href="#l20.1603"></a><span id="l20.1603">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1604"></a><span id="l20.1604">       &lt;/method&gt;</span>
<a href="#l20.1605"></a><span id="l20.1605"> </span>
<a href="#l20.1606"></a><span id="l20.1606">       &lt;!-- Parameter aValue may be a date or a date time. Dates are</span>
<a href="#l20.1607"></a><span id="l20.1607">            read according to locale/OS setting (d-m-y or m-d-y or ...).</span>
<a href="#l20.1608"></a><span id="l20.1608">            (see initDateFormat). Uses parseTime() for times.</span>
<a href="#l20.1609"></a><span id="l20.1609">       --&gt;</span>
<a href="#l20.1610"></a><span id="l20.1610">       &lt;method name=&quot;parseDateTime&quot;&gt;</span>
<a href="#l20.1611"></a><span id="l20.1611">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.1612"></a><span id="l20.1612">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1613"></a><span id="l20.1613" class="difflineminus">-          this.mLastDateParseIncludedTime = false;</span>
<a href="#l20.1614"></a><span id="l20.1614" class="difflineminus">-          let tempDate = null;</span>
<a href="#l20.1615"></a><span id="l20.1615" class="difflineminus">-          if (!this.probeSucceeded) {</span>
<a href="#l20.1616"></a><span id="l20.1616" class="difflineminus">-              return null; // avoid errors accessing uninitialized data.</span>
<a href="#l20.1617"></a><span id="l20.1617" class="difflineminus">-          }</span>
<a href="#l20.1618"></a><span id="l20.1618" class="difflineplus">+            this.mLastDateParseIncludedTime = false;</span>
<a href="#l20.1619"></a><span id="l20.1619" class="difflineplus">+            let tempDate = null;</span>
<a href="#l20.1620"></a><span id="l20.1620" class="difflineplus">+            if (!this.probeSucceeded) {</span>
<a href="#l20.1621"></a><span id="l20.1621" class="difflineplus">+                return null; // avoid errors accessing uninitialized data.</span>
<a href="#l20.1622"></a><span id="l20.1622" class="difflineplus">+            }</span>
<a href="#l20.1623"></a><span id="l20.1623"> </span>
<a href="#l20.1624"></a><span id="l20.1624" class="difflineminus">-          let year = Number.MIN_VALUE;</span>
<a href="#l20.1625"></a><span id="l20.1625" class="difflineminus">-          let month = -1;</span>
<a href="#l20.1626"></a><span id="l20.1626" class="difflineminus">-          let day = -1;</span>
<a href="#l20.1627"></a><span id="l20.1627" class="difflineminus">-          let timeString = null;</span>
<a href="#l20.1628"></a><span id="l20.1628" class="difflineplus">+            let year = Number.MIN_VALUE;</span>
<a href="#l20.1629"></a><span id="l20.1629" class="difflineplus">+            let month = -1;</span>
<a href="#l20.1630"></a><span id="l20.1630" class="difflineplus">+            let day = -1;</span>
<a href="#l20.1631"></a><span id="l20.1631" class="difflineplus">+            let timeString = null;</span>
<a href="#l20.1632"></a><span id="l20.1632"> </span>
<a href="#l20.1633"></a><span id="l20.1633" class="difflineminus">-          if (this.alphaMonths == null) {</span>
<a href="#l20.1634"></a><span id="l20.1634" class="difflineminus">-              // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l20.1635"></a><span id="l20.1635" class="difflineminus">-              // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l20.1636"></a><span id="l20.1636" class="difflineminus">-              // which do not match \w, esp. in CJK locales.)</span>
<a href="#l20.1637"></a><span id="l20.1637" class="difflineminus">-              // (.*)? binds to null if no suffix.</span>
<a href="#l20.1638"></a><span id="l20.1638" class="difflineminus">-              let parseNumShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)(.*)?$/;</span>
<a href="#l20.1639"></a><span id="l20.1639" class="difflineminus">-              let dateNumbersArray = parseNumShortDateRegex.exec(aValue);</span>
<a href="#l20.1640"></a><span id="l20.1640" class="difflineminus">-              if (dateNumbersArray != null) {</span>
<a href="#l20.1641"></a><span id="l20.1641" class="difflineminus">-                  year = Number(dateNumbersArray[this.yearIndex]);</span>
<a href="#l20.1642"></a><span id="l20.1642" class="difflineminus">-                  month = Number(dateNumbersArray[this.monthIndex]) - 1; // 0-based</span>
<a href="#l20.1643"></a><span id="l20.1643" class="difflineminus">-                  day = Number(dateNumbersArray[this.dayIndex]);</span>
<a href="#l20.1644"></a><span id="l20.1644" class="difflineminus">-                  timeString = dateNumbersArray[4];</span>
<a href="#l20.1645"></a><span id="l20.1645" class="difflineminus">-              }</span>
<a href="#l20.1646"></a><span id="l20.1646" class="difflineminus">-          } else {</span>
<a href="#l20.1647"></a><span id="l20.1647" class="difflineminus">-              // SHORT DATE WITH ALPHABETIC MONTH, such as &quot;dd MMM yy&quot; or &quot;MMMM dd, yyyy&quot;</span>
<a href="#l20.1648"></a><span id="l20.1648" class="difflineminus">-              // (\d+|[^\d\W]) is digits or letters, not both together.</span>
<a href="#l20.1649"></a><span id="l20.1649" class="difflineminus">-              // Allows 31dec1999 (no delimiters between parts) if OS does (w2k does not).</span>
<a href="#l20.1650"></a><span id="l20.1650" class="difflineminus">-              // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l20.1651"></a><span id="l20.1651" class="difflineminus">-              // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l20.1652"></a><span id="l20.1652" class="difflineminus">-              // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l20.1653"></a><span id="l20.1653" class="difflineminus">-              // regexp derived from the Alphabetic ranges in</span>
<a href="#l20.1654"></a><span id="l20.1654" class="difflineminus">-              // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l20.1655"></a><span id="l20.1655" class="difflineminus">-              // (.*)? binds to null if no suffix.</span>
<a href="#l20.1656"></a><span id="l20.1656" class="difflineminus">-              let parseAlphShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)(.*)?$/;</span>
<a href="#l20.1657"></a><span id="l20.1657" class="difflineminus">-              let datePartsArray = parseAlphShortDateRegex.exec(aValue);</span>
<a href="#l20.1658"></a><span id="l20.1658" class="difflineminus">-              if (datePartsArray != null) {</span>
<a href="#l20.1659"></a><span id="l20.1659" class="difflineminus">-                  year = Number(datePartsArray[this.yearIndex]);</span>
<a href="#l20.1660"></a><span id="l20.1660" class="difflineminus">-                  let monthString = datePartsArray[this.monthIndex].toUpperCase();</span>
<a href="#l20.1661"></a><span id="l20.1661" class="difflineminus">-                  for (let monthIdx = 0; monthIdx &lt; this.alphaMonths.length; monthIdx++) {</span>
<a href="#l20.1662"></a><span id="l20.1662" class="difflineminus">-                      if (monthString == this.alphaMonths[monthIdx]) {</span>
<a href="#l20.1663"></a><span id="l20.1663" class="difflineminus">-                          month = monthIdx;</span>
<a href="#l20.1664"></a><span id="l20.1664" class="difflineminus">-                          break;</span>
<a href="#l20.1665"></a><span id="l20.1665" class="difflineminus">-                      }</span>
<a href="#l20.1666"></a><span id="l20.1666" class="difflineminus">-                  }</span>
<a href="#l20.1667"></a><span id="l20.1667" class="difflineminus">-                  day = Number(datePartsArray[this.dayIndex]);</span>
<a href="#l20.1668"></a><span id="l20.1668" class="difflineminus">-                  timeString = datePartsArray[4];</span>
<a href="#l20.1669"></a><span id="l20.1669" class="difflineminus">-              }</span>
<a href="#l20.1670"></a><span id="l20.1670" class="difflineminus">-          }</span>
<a href="#l20.1671"></a><span id="l20.1671" class="difflineminus">-          if (year != Number.MIN_VALUE &amp;&amp; month != -1 &amp;&amp; day != -1) {</span>
<a href="#l20.1672"></a><span id="l20.1672" class="difflineminus">-              // year, month, day successfully parsed</span>
<a href="#l20.1673"></a><span id="l20.1673" class="difflineminus">-              if (year &gt;= 0 &amp;&amp; year &lt; 100) {</span>
<a href="#l20.1674"></a><span id="l20.1674" class="difflineminus">-                  // If 0 &lt;= year &lt; 100, treat as 2-digit year (like formatDate):</span>
<a href="#l20.1675"></a><span id="l20.1675" class="difflineminus">-                  //   parse year as up to 30 years in future or 69 years in past.</span>
<a href="#l20.1676"></a><span id="l20.1676" class="difflineminus">-                  //   (Covers 30-year mortgage and most working people's birthdate.)</span>
<a href="#l20.1677"></a><span id="l20.1677" class="difflineminus">-                  // otherwise will be treated as four digit year.</span>
<a href="#l20.1678"></a><span id="l20.1678" class="difflineminus">-                  let currentYear = new Date().getFullYear();</span>
<a href="#l20.1679"></a><span id="l20.1679" class="difflineminus">-                  let currentCentury = currentYear - currentYear % 100;</span>
<a href="#l20.1680"></a><span id="l20.1680" class="difflineminus">-                  year = currentCentury + year;</span>
<a href="#l20.1681"></a><span id="l20.1681" class="difflineminus">-                  if (year &lt; currentYear - 69) {</span>
<a href="#l20.1682"></a><span id="l20.1682" class="difflineminus">-                      year += 100;</span>
<a href="#l20.1683"></a><span id="l20.1683" class="difflineminus">-                  }</span>
<a href="#l20.1684"></a><span id="l20.1684" class="difflineminus">-                  if (year &gt; currentYear + 30) {</span>
<a href="#l20.1685"></a><span id="l20.1685" class="difflineminus">-                      year -= 100;</span>
<a href="#l20.1686"></a><span id="l20.1686" class="difflineminus">-                  }</span>
<a href="#l20.1687"></a><span id="l20.1687" class="difflineminus">-              }</span>
<a href="#l20.1688"></a><span id="l20.1688" class="difflineminus">-              // if time is also present, parse it</span>
<a href="#l20.1689"></a><span id="l20.1689" class="difflineminus">-              let hours = 0;</span>
<a href="#l20.1690"></a><span id="l20.1690" class="difflineminus">-              let minutes = 0;</span>
<a href="#l20.1691"></a><span id="l20.1691" class="difflineminus">-              let seconds = 0;</span>
<a href="#l20.1692"></a><span id="l20.1692" class="difflineminus">-              if (timeString != null) {</span>
<a href="#l20.1693"></a><span id="l20.1693" class="difflineminus">-                  let time = this.parseTime(timeString);</span>
<a href="#l20.1694"></a><span id="l20.1694" class="difflineminus">-                  if (time != null) {</span>
<a href="#l20.1695"></a><span id="l20.1695" class="difflineminus">-                      hours = time.getHours();</span>
<a href="#l20.1696"></a><span id="l20.1696" class="difflineminus">-                      minutes = time.getMinutes();</span>
<a href="#l20.1697"></a><span id="l20.1697" class="difflineminus">-                      seconds = time.getSeconds();</span>
<a href="#l20.1698"></a><span id="l20.1698" class="difflineminus">-                      this.mLastDateParseIncludedTime = true;</span>
<a href="#l20.1699"></a><span id="l20.1699" class="difflineminus">-                  }</span>
<a href="#l20.1700"></a><span id="l20.1700" class="difflineminus">-              }</span>
<a href="#l20.1701"></a><span id="l20.1701" class="difflineminus">-              tempDate = new Date(year, month, day, hours, minutes, seconds, 0);</span>
<a href="#l20.1702"></a><span id="l20.1702" class="difflineminus">-          } // else did not match regex, not a valid date</span>
<a href="#l20.1703"></a><span id="l20.1703" class="difflineminus">-          return tempDate;</span>
<a href="#l20.1704"></a><span id="l20.1704" class="difflineplus">+            if (this.alphaMonths == null) {</span>
<a href="#l20.1705"></a><span id="l20.1705" class="difflineplus">+                // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l20.1706"></a><span id="l20.1706" class="difflineplus">+                // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l20.1707"></a><span id="l20.1707" class="difflineplus">+                // which do not match \w, esp. in CJK locales.)</span>
<a href="#l20.1708"></a><span id="l20.1708" class="difflineplus">+                // (.*)? binds to null if no suffix.</span>
<a href="#l20.1709"></a><span id="l20.1709" class="difflineplus">+                let parseNumShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)(.*)?$/;</span>
<a href="#l20.1710"></a><span id="l20.1710" class="difflineplus">+                let dateNumbersArray = parseNumShortDateRegex.exec(aValue);</span>
<a href="#l20.1711"></a><span id="l20.1711" class="difflineplus">+                if (dateNumbersArray != null) {</span>
<a href="#l20.1712"></a><span id="l20.1712" class="difflineplus">+                    year = Number(dateNumbersArray[this.yearIndex]);</span>
<a href="#l20.1713"></a><span id="l20.1713" class="difflineplus">+                    month = Number(dateNumbersArray[this.monthIndex]) - 1; // 0-based</span>
<a href="#l20.1714"></a><span id="l20.1714" class="difflineplus">+                    day = Number(dateNumbersArray[this.dayIndex]);</span>
<a href="#l20.1715"></a><span id="l20.1715" class="difflineplus">+                    timeString = dateNumbersArray[4];</span>
<a href="#l20.1716"></a><span id="l20.1716" class="difflineplus">+                }</span>
<a href="#l20.1717"></a><span id="l20.1717" class="difflineplus">+            } else {</span>
<a href="#l20.1718"></a><span id="l20.1718" class="difflineplus">+                // SHORT DATE WITH ALPHABETIC MONTH, such as &quot;dd MMM yy&quot; or &quot;MMMM dd, yyyy&quot;</span>
<a href="#l20.1719"></a><span id="l20.1719" class="difflineplus">+                // (\d+|[^\d\W]) is digits or letters, not both together.</span>
<a href="#l20.1720"></a><span id="l20.1720" class="difflineplus">+                // Allows 31dec1999 (no delimiters between parts) if OS does (w2k does not).</span>
<a href="#l20.1721"></a><span id="l20.1721" class="difflineplus">+                // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l20.1722"></a><span id="l20.1722" class="difflineplus">+                // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l20.1723"></a><span id="l20.1723" class="difflineplus">+                // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l20.1724"></a><span id="l20.1724" class="difflineplus">+                // regexp derived from the Alphabetic ranges in</span>
<a href="#l20.1725"></a><span id="l20.1725" class="difflineplus">+                // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l20.1726"></a><span id="l20.1726" class="difflineplus">+                // (.*)? binds to null if no suffix.</span>
<a href="#l20.1727"></a><span id="l20.1727" class="difflineplus">+                let parseAlphShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)(.*)?$/;</span>
<a href="#l20.1728"></a><span id="l20.1728" class="difflineplus">+                let datePartsArray = parseAlphShortDateRegex.exec(aValue);</span>
<a href="#l20.1729"></a><span id="l20.1729" class="difflineplus">+                if (datePartsArray != null) {</span>
<a href="#l20.1730"></a><span id="l20.1730" class="difflineplus">+                    year = Number(datePartsArray[this.yearIndex]);</span>
<a href="#l20.1731"></a><span id="l20.1731" class="difflineplus">+                    let monthString = datePartsArray[this.monthIndex].toUpperCase();</span>
<a href="#l20.1732"></a><span id="l20.1732" class="difflineplus">+                    for (let monthIdx = 0; monthIdx &lt; this.alphaMonths.length; monthIdx++) {</span>
<a href="#l20.1733"></a><span id="l20.1733" class="difflineplus">+                        if (monthString == this.alphaMonths[monthIdx]) {</span>
<a href="#l20.1734"></a><span id="l20.1734" class="difflineplus">+                            month = monthIdx;</span>
<a href="#l20.1735"></a><span id="l20.1735" class="difflineplus">+                            break;</span>
<a href="#l20.1736"></a><span id="l20.1736" class="difflineplus">+                        }</span>
<a href="#l20.1737"></a><span id="l20.1737" class="difflineplus">+                    }</span>
<a href="#l20.1738"></a><span id="l20.1738" class="difflineplus">+                    day = Number(datePartsArray[this.dayIndex]);</span>
<a href="#l20.1739"></a><span id="l20.1739" class="difflineplus">+                    timeString = datePartsArray[4];</span>
<a href="#l20.1740"></a><span id="l20.1740" class="difflineplus">+                }</span>
<a href="#l20.1741"></a><span id="l20.1741" class="difflineplus">+            }</span>
<a href="#l20.1742"></a><span id="l20.1742" class="difflineplus">+            if (year != Number.MIN_VALUE &amp;&amp; month != -1 &amp;&amp; day != -1) {</span>
<a href="#l20.1743"></a><span id="l20.1743" class="difflineplus">+                // year, month, day successfully parsed</span>
<a href="#l20.1744"></a><span id="l20.1744" class="difflineplus">+                if (year &gt;= 0 &amp;&amp; year &lt; 100) {</span>
<a href="#l20.1745"></a><span id="l20.1745" class="difflineplus">+                    // If 0 &lt;= year &lt; 100, treat as 2-digit year (like formatDate):</span>
<a href="#l20.1746"></a><span id="l20.1746" class="difflineplus">+                    //   parse year as up to 30 years in future or 69 years in past.</span>
<a href="#l20.1747"></a><span id="l20.1747" class="difflineplus">+                    //   (Covers 30-year mortgage and most working people's birthdate.)</span>
<a href="#l20.1748"></a><span id="l20.1748" class="difflineplus">+                    // otherwise will be treated as four digit year.</span>
<a href="#l20.1749"></a><span id="l20.1749" class="difflineplus">+                    let currentYear = new Date().getFullYear();</span>
<a href="#l20.1750"></a><span id="l20.1750" class="difflineplus">+                    let currentCentury = currentYear - currentYear % 100;</span>
<a href="#l20.1751"></a><span id="l20.1751" class="difflineplus">+                    year = currentCentury + year;</span>
<a href="#l20.1752"></a><span id="l20.1752" class="difflineplus">+                    if (year &lt; currentYear - 69) {</span>
<a href="#l20.1753"></a><span id="l20.1753" class="difflineplus">+                        year += 100;</span>
<a href="#l20.1754"></a><span id="l20.1754" class="difflineplus">+                    }</span>
<a href="#l20.1755"></a><span id="l20.1755" class="difflineplus">+                    if (year &gt; currentYear + 30) {</span>
<a href="#l20.1756"></a><span id="l20.1756" class="difflineplus">+                        year -= 100;</span>
<a href="#l20.1757"></a><span id="l20.1757" class="difflineplus">+                    }</span>
<a href="#l20.1758"></a><span id="l20.1758" class="difflineplus">+                }</span>
<a href="#l20.1759"></a><span id="l20.1759" class="difflineplus">+                // if time is also present, parse it</span>
<a href="#l20.1760"></a><span id="l20.1760" class="difflineplus">+                let hours = 0;</span>
<a href="#l20.1761"></a><span id="l20.1761" class="difflineplus">+                let minutes = 0;</span>
<a href="#l20.1762"></a><span id="l20.1762" class="difflineplus">+                let seconds = 0;</span>
<a href="#l20.1763"></a><span id="l20.1763" class="difflineplus">+                if (timeString != null) {</span>
<a href="#l20.1764"></a><span id="l20.1764" class="difflineplus">+                    let time = this.parseTime(timeString);</span>
<a href="#l20.1765"></a><span id="l20.1765" class="difflineplus">+                    if (time != null) {</span>
<a href="#l20.1766"></a><span id="l20.1766" class="difflineplus">+                        hours = time.getHours();</span>
<a href="#l20.1767"></a><span id="l20.1767" class="difflineplus">+                        minutes = time.getMinutes();</span>
<a href="#l20.1768"></a><span id="l20.1768" class="difflineplus">+                        seconds = time.getSeconds();</span>
<a href="#l20.1769"></a><span id="l20.1769" class="difflineplus">+                        this.mLastDateParseIncludedTime = true;</span>
<a href="#l20.1770"></a><span id="l20.1770" class="difflineplus">+                    }</span>
<a href="#l20.1771"></a><span id="l20.1771" class="difflineplus">+                }</span>
<a href="#l20.1772"></a><span id="l20.1772" class="difflineplus">+                tempDate = new Date(year, month, day, hours, minutes, seconds, 0);</span>
<a href="#l20.1773"></a><span id="l20.1773" class="difflineplus">+            } // else did not match regex, not a valid date</span>
<a href="#l20.1774"></a><span id="l20.1774" class="difflineplus">+            return tempDate;</span>
<a href="#l20.1775"></a><span id="l20.1775">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1776"></a><span id="l20.1776">       &lt;/method&gt;</span>
<a href="#l20.1777"></a><span id="l20.1777"> </span>
<a href="#l20.1778"></a><span id="l20.1778">       &lt;!-- Parse a variety of time formats so that cut and paste is likely to work.</span>
<a href="#l20.1779"></a><span id="l20.1779">            separator:            ':'         '.'        ' '        symbol        none</span>
<a href="#l20.1780"></a><span id="l20.1780">                                  &quot;12:34:56&quot;  &quot;12.34.56&quot; &quot;12 34 56&quot; &quot;12h34m56s&quot;   &quot;123456&quot;</span>
<a href="#l20.1781"></a><span id="l20.1781">            seconds optional:     &quot;02:34&quot;     &quot;02.34&quot;    &quot;02 34&quot;    &quot;02h34m&quot;      &quot;0234&quot;</span>
<a href="#l20.1782"></a><span id="l20.1782">            minutes optional:     &quot;12&quot;        &quot;12&quot;       &quot;12&quot;       &quot;12h&quot;         &quot;12&quot;</span>
<a href="#l20.1783"></a><span id="l20.1783" class="difflineat">@@ -1598,164 +1598,164 @@</span>
<a href="#l20.1784"></a><span id="l20.1784">            am/pm cyrillic        &quot;02:34\u0430.\u043c.&quot;  &quot;02 34 \u0420 \u041c&quot;</span>
<a href="#l20.1785"></a><span id="l20.1785">            am/pm arabic          &quot;\u063502:34&quot; (RTL 02:34a) &quot;\u0645 02.34&quot; (RTL 02.34 p)</span>
<a href="#l20.1786"></a><span id="l20.1786">            above/below noon      &quot;\u4e0a\u534802:34&quot;    &quot;\u4e0b\u5348 02 34&quot;</span>
<a href="#l20.1787"></a><span id="l20.1787">            noon before/after     &quot;\u5348\u524d02:34&quot;    &quot;\u5348\u5f8c 02 34&quot;</span>
<a href="#l20.1788"></a><span id="l20.1788">       --&gt;</span>
<a href="#l20.1789"></a><span id="l20.1789">       &lt;method name=&quot;parseTime&quot;&gt;</span>
<a href="#l20.1790"></a><span id="l20.1790">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.1791"></a><span id="l20.1791">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1792"></a><span id="l20.1792" class="difflineminus">-          try {</span>
<a href="#l20.1793"></a><span id="l20.1793" class="difflineminus">-              let noon = cal.calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l20.1794"></a><span id="l20.1794" class="difflineminus">-              if (aValue.toLowerCase() == noon.toLowerCase()) {</span>
<a href="#l20.1795"></a><span id="l20.1795" class="difflineminus">-                  return new Date(0, 0, 0, 12, 0, 0, 0);</span>
<a href="#l20.1796"></a><span id="l20.1796" class="difflineminus">-              }</span>
<a href="#l20.1797"></a><span id="l20.1797" class="difflineplus">+            try {</span>
<a href="#l20.1798"></a><span id="l20.1798" class="difflineplus">+                let noon = cal.calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l20.1799"></a><span id="l20.1799" class="difflineplus">+                if (aValue.toLowerCase() == noon.toLowerCase()) {</span>
<a href="#l20.1800"></a><span id="l20.1800" class="difflineplus">+                    return new Date(0, 0, 0, 12, 0, 0, 0);</span>
<a href="#l20.1801"></a><span id="l20.1801" class="difflineplus">+                }</span>
<a href="#l20.1802"></a><span id="l20.1802"> </span>
<a href="#l20.1803"></a><span id="l20.1803" class="difflineminus">-              let midnight = cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l20.1804"></a><span id="l20.1804" class="difflineminus">-              if (aValue.toLowerCase() == midnight.toLowerCase()) {</span>
<a href="#l20.1805"></a><span id="l20.1805" class="difflineminus">-                  return new Date(0, 0, 0, 0, 0, 0, 0);</span>
<a href="#l20.1806"></a><span id="l20.1806" class="difflineminus">-              }</span>
<a href="#l20.1807"></a><span id="l20.1807" class="difflineminus">-          } catch (ex) {</span>
<a href="#l20.1808"></a><span id="l20.1808" class="difflineminus">-              // Try/catch this, since some people are apparently</span>
<a href="#l20.1809"></a><span id="l20.1809" class="difflineminus">-              // interested in using the datepicker in remote apps, where</span>
<a href="#l20.1810"></a><span id="l20.1810" class="difflineminus">-              // calGetString wouldn't exist</span>
<a href="#l20.1811"></a><span id="l20.1811" class="difflineminus">-          }</span>
<a href="#l20.1812"></a><span id="l20.1812" class="difflineplus">+                let midnight = cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l20.1813"></a><span id="l20.1813" class="difflineplus">+                if (aValue.toLowerCase() == midnight.toLowerCase()) {</span>
<a href="#l20.1814"></a><span id="l20.1814" class="difflineplus">+                    return new Date(0, 0, 0, 0, 0, 0, 0);</span>
<a href="#l20.1815"></a><span id="l20.1815" class="difflineplus">+                }</span>
<a href="#l20.1816"></a><span id="l20.1816" class="difflineplus">+            } catch (ex) {</span>
<a href="#l20.1817"></a><span id="l20.1817" class="difflineplus">+                // Try/catch this, since some people are apparently</span>
<a href="#l20.1818"></a><span id="l20.1818" class="difflineplus">+                // interested in using the datepicker in remote apps, where</span>
<a href="#l20.1819"></a><span id="l20.1819" class="difflineplus">+                // calGetString wouldn't exist</span>
<a href="#l20.1820"></a><span id="l20.1820" class="difflineplus">+            }</span>
<a href="#l20.1821"></a><span id="l20.1821"> </span>
<a href="#l20.1822"></a><span id="l20.1822" class="difflineminus">-          let time = null;</span>
<a href="#l20.1823"></a><span id="l20.1823" class="difflineminus">-          let timePartsArray = this.parseTimeRegExp.exec(aValue);</span>
<a href="#l20.1824"></a><span id="l20.1824" class="difflineminus">-          const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8;</span>
<a href="#l20.1825"></a><span id="l20.1825" class="difflineplus">+            let time = null;</span>
<a href="#l20.1826"></a><span id="l20.1826" class="difflineplus">+            let timePartsArray = this.parseTimeRegExp.exec(aValue);</span>
<a href="#l20.1827"></a><span id="l20.1827" class="difflineplus">+            const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8;</span>
<a href="#l20.1828"></a><span id="l20.1828"> </span>
<a href="#l20.1829"></a><span id="l20.1829" class="difflineminus">-          if (timePartsArray != null) {</span>
<a href="#l20.1830"></a><span id="l20.1830" class="difflineminus">-              let hoursString = timePartsArray[HR_INDEX];</span>
<a href="#l20.1831"></a><span id="l20.1831" class="difflineminus">-              let hours = Number(hoursString);</span>
<a href="#l20.1832"></a><span id="l20.1832" class="difflineminus">-              if (!(hours &gt;= 0 &amp;&amp; hours &lt; 24)) {</span>
<a href="#l20.1833"></a><span id="l20.1833" class="difflineminus">-                  return null;</span>
<a href="#l20.1834"></a><span id="l20.1834" class="difflineminus">-              }</span>
<a href="#l20.1835"></a><span id="l20.1835" class="difflineplus">+            if (timePartsArray != null) {</span>
<a href="#l20.1836"></a><span id="l20.1836" class="difflineplus">+                let hoursString = timePartsArray[HR_INDEX];</span>
<a href="#l20.1837"></a><span id="l20.1837" class="difflineplus">+                let hours = Number(hoursString);</span>
<a href="#l20.1838"></a><span id="l20.1838" class="difflineplus">+                if (!(hours &gt;= 0 &amp;&amp; hours &lt; 24)) {</span>
<a href="#l20.1839"></a><span id="l20.1839" class="difflineplus">+                    return null;</span>
<a href="#l20.1840"></a><span id="l20.1840" class="difflineplus">+                }</span>
<a href="#l20.1841"></a><span id="l20.1841"> </span>
<a href="#l20.1842"></a><span id="l20.1842" class="difflineminus">-              let minutesString = timePartsArray[MIN_INDEX];</span>
<a href="#l20.1843"></a><span id="l20.1843" class="difflineminus">-              let minutes = (minutesString == null ? 0 : Number(minutesString));</span>
<a href="#l20.1844"></a><span id="l20.1844" class="difflineminus">-              if (!(minutes &gt;= 0 &amp;&amp; minutes &lt; 60)) {</span>
<a href="#l20.1845"></a><span id="l20.1845" class="difflineminus">-                  return null;</span>
<a href="#l20.1846"></a><span id="l20.1846" class="difflineminus">-              }</span>
<a href="#l20.1847"></a><span id="l20.1847" class="difflineplus">+                let minutesString = timePartsArray[MIN_INDEX];</span>
<a href="#l20.1848"></a><span id="l20.1848" class="difflineplus">+                let minutes = (minutesString == null ? 0 : Number(minutesString));</span>
<a href="#l20.1849"></a><span id="l20.1849" class="difflineplus">+                if (!(minutes &gt;= 0 &amp;&amp; minutes &lt; 60)) {</span>
<a href="#l20.1850"></a><span id="l20.1850" class="difflineplus">+                    return null;</span>
<a href="#l20.1851"></a><span id="l20.1851" class="difflineplus">+                }</span>
<a href="#l20.1852"></a><span id="l20.1852"> </span>
<a href="#l20.1853"></a><span id="l20.1853" class="difflineminus">-              let secondsString = timePartsArray[SEC_INDEX];</span>
<a href="#l20.1854"></a><span id="l20.1854" class="difflineminus">-              let seconds = (secondsString == null ? 0 : Number(secondsString));</span>
<a href="#l20.1855"></a><span id="l20.1855" class="difflineminus">-              if (!(seconds &gt;= 0 &amp;&amp; seconds &lt; 60)) {</span>
<a href="#l20.1856"></a><span id="l20.1856" class="difflineminus">-                  return null;</span>
<a href="#l20.1857"></a><span id="l20.1857" class="difflineminus">-              }</span>
<a href="#l20.1858"></a><span id="l20.1858" class="difflineplus">+                let secondsString = timePartsArray[SEC_INDEX];</span>
<a href="#l20.1859"></a><span id="l20.1859" class="difflineplus">+                let seconds = (secondsString == null ? 0 : Number(secondsString));</span>
<a href="#l20.1860"></a><span id="l20.1860" class="difflineplus">+                if (!(seconds &gt;= 0 &amp;&amp; seconds &lt; 60)) {</span>
<a href="#l20.1861"></a><span id="l20.1861" class="difflineplus">+                    return null;</span>
<a href="#l20.1862"></a><span id="l20.1862" class="difflineplus">+                }</span>
<a href="#l20.1863"></a><span id="l20.1863"> </span>
<a href="#l20.1864"></a><span id="l20.1864" class="difflineminus">-              let ampmCode = null;</span>
<a href="#l20.1865"></a><span id="l20.1865" class="difflineminus">-              if (timePartsArray[PRE_INDEX] || timePartsArray[POST_INDEX]) {</span>
<a href="#l20.1866"></a><span id="l20.1866" class="difflineminus">-                  if (this.ampmIndex &amp;&amp; timePartsArray[this.ampmIndex]) {</span>
<a href="#l20.1867"></a><span id="l20.1867" class="difflineminus">-                      // try current format order first</span>
<a href="#l20.1868"></a><span id="l20.1868" class="difflineminus">-                      let ampmString = timePartsArray[this.ampmIndex];</span>
<a href="#l20.1869"></a><span id="l20.1869" class="difflineminus">-                      if (this.amRegExp.test(ampmString)) {</span>
<a href="#l20.1870"></a><span id="l20.1870" class="difflineminus">-                          ampmCode = &quot;AM&quot;;</span>
<a href="#l20.1871"></a><span id="l20.1871" class="difflineminus">-                      } else if (this.pmRegExp.test(ampmString)) {</span>
<a href="#l20.1872"></a><span id="l20.1872" class="difflineminus">-                          ampmCode = &quot;PM&quot;;</span>
<a href="#l20.1873"></a><span id="l20.1873" class="difflineminus">-                      }</span>
<a href="#l20.1874"></a><span id="l20.1874" class="difflineminus">-                  }</span>
<a href="#l20.1875"></a><span id="l20.1875" class="difflineminus">-                  if (ampmCode == null) { // not yet found</span>
<a href="#l20.1876"></a><span id="l20.1876" class="difflineminus">-                      // try any format order</span>
<a href="#l20.1877"></a><span id="l20.1877" class="difflineminus">-                      let preString = timePartsArray[PRE_INDEX];</span>
<a href="#l20.1878"></a><span id="l20.1878" class="difflineminus">-                      let postString = timePartsArray[POST_INDEX];</span>
<a href="#l20.1879"></a><span id="l20.1879" class="difflineminus">-                      if ((preString &amp;&amp; this.amRegExp.test(preString)) ||</span>
<a href="#l20.1880"></a><span id="l20.1880" class="difflineminus">-                          (postString &amp;&amp; this.amRegExp.test(postString))) {</span>
<a href="#l20.1881"></a><span id="l20.1881" class="difflineminus">-                          ampmCode = &quot;AM&quot;;</span>
<a href="#l20.1882"></a><span id="l20.1882" class="difflineminus">-                      } else if ((preString &amp;&amp; this.pmRegExp.test(preString)) ||</span>
<a href="#l20.1883"></a><span id="l20.1883" class="difflineminus">-                                 (postString &amp;&amp; this.pmRegExp.test(postString))) {</span>
<a href="#l20.1884"></a><span id="l20.1884" class="difflineminus">-                          ampmCode = &quot;PM&quot;;</span>
<a href="#l20.1885"></a><span id="l20.1885" class="difflineminus">-                      } // else no match, ignore and treat as 24hour time.</span>
<a href="#l20.1886"></a><span id="l20.1886" class="difflineminus">-                  }</span>
<a href="#l20.1887"></a><span id="l20.1887" class="difflineminus">-              }</span>
<a href="#l20.1888"></a><span id="l20.1888" class="difflineminus">-              if (ampmCode == &quot;AM&quot;) {</span>
<a href="#l20.1889"></a><span id="l20.1889" class="difflineminus">-                  if (hours == 12) {</span>
<a href="#l20.1890"></a><span id="l20.1890" class="difflineminus">-                      hours = 0;</span>
<a href="#l20.1891"></a><span id="l20.1891" class="difflineminus">-                  }</span>
<a href="#l20.1892"></a><span id="l20.1892" class="difflineminus">-              } else if (ampmCode == &quot;PM&quot;) {</span>
<a href="#l20.1893"></a><span id="l20.1893" class="difflineminus">-                  if (hours &lt; 12) {</span>
<a href="#l20.1894"></a><span id="l20.1894" class="difflineminus">-                      hours += 12;</span>
<a href="#l20.1895"></a><span id="l20.1895" class="difflineminus">-                  }</span>
<a href="#l20.1896"></a><span id="l20.1896" class="difflineminus">-              }</span>
<a href="#l20.1897"></a><span id="l20.1897" class="difflineminus">-              time = new Date(0, 0, 0, hours, minutes, seconds, 0);</span>
<a href="#l20.1898"></a><span id="l20.1898" class="difflineminus">-          }  // else did not match regex, not valid time</span>
<a href="#l20.1899"></a><span id="l20.1899" class="difflineminus">-          return time;</span>
<a href="#l20.1900"></a><span id="l20.1900" class="difflineplus">+                let ampmCode = null;</span>
<a href="#l20.1901"></a><span id="l20.1901" class="difflineplus">+                if (timePartsArray[PRE_INDEX] || timePartsArray[POST_INDEX]) {</span>
<a href="#l20.1902"></a><span id="l20.1902" class="difflineplus">+                    if (this.ampmIndex &amp;&amp; timePartsArray[this.ampmIndex]) {</span>
<a href="#l20.1903"></a><span id="l20.1903" class="difflineplus">+                        // try current format order first</span>
<a href="#l20.1904"></a><span id="l20.1904" class="difflineplus">+                        let ampmString = timePartsArray[this.ampmIndex];</span>
<a href="#l20.1905"></a><span id="l20.1905" class="difflineplus">+                        if (this.amRegExp.test(ampmString)) {</span>
<a href="#l20.1906"></a><span id="l20.1906" class="difflineplus">+                            ampmCode = &quot;AM&quot;;</span>
<a href="#l20.1907"></a><span id="l20.1907" class="difflineplus">+                        } else if (this.pmRegExp.test(ampmString)) {</span>
<a href="#l20.1908"></a><span id="l20.1908" class="difflineplus">+                            ampmCode = &quot;PM&quot;;</span>
<a href="#l20.1909"></a><span id="l20.1909" class="difflineplus">+                        }</span>
<a href="#l20.1910"></a><span id="l20.1910" class="difflineplus">+                    }</span>
<a href="#l20.1911"></a><span id="l20.1911" class="difflineplus">+                    if (ampmCode == null) { // not yet found</span>
<a href="#l20.1912"></a><span id="l20.1912" class="difflineplus">+                        // try any format order</span>
<a href="#l20.1913"></a><span id="l20.1913" class="difflineplus">+                        let preString = timePartsArray[PRE_INDEX];</span>
<a href="#l20.1914"></a><span id="l20.1914" class="difflineplus">+                        let postString = timePartsArray[POST_INDEX];</span>
<a href="#l20.1915"></a><span id="l20.1915" class="difflineplus">+                        if ((preString &amp;&amp; this.amRegExp.test(preString)) ||</span>
<a href="#l20.1916"></a><span id="l20.1916" class="difflineplus">+                            (postString &amp;&amp; this.amRegExp.test(postString))) {</span>
<a href="#l20.1917"></a><span id="l20.1917" class="difflineplus">+                            ampmCode = &quot;AM&quot;;</span>
<a href="#l20.1918"></a><span id="l20.1918" class="difflineplus">+                        } else if ((preString &amp;&amp; this.pmRegExp.test(preString)) ||</span>
<a href="#l20.1919"></a><span id="l20.1919" class="difflineplus">+                                   (postString &amp;&amp; this.pmRegExp.test(postString))) {</span>
<a href="#l20.1920"></a><span id="l20.1920" class="difflineplus">+                            ampmCode = &quot;PM&quot;;</span>
<a href="#l20.1921"></a><span id="l20.1921" class="difflineplus">+                        } // else no match, ignore and treat as 24hour time.</span>
<a href="#l20.1922"></a><span id="l20.1922" class="difflineplus">+                    }</span>
<a href="#l20.1923"></a><span id="l20.1923" class="difflineplus">+                }</span>
<a href="#l20.1924"></a><span id="l20.1924" class="difflineplus">+                if (ampmCode == &quot;AM&quot;) {</span>
<a href="#l20.1925"></a><span id="l20.1925" class="difflineplus">+                    if (hours == 12) {</span>
<a href="#l20.1926"></a><span id="l20.1926" class="difflineplus">+                        hours = 0;</span>
<a href="#l20.1927"></a><span id="l20.1927" class="difflineplus">+                    }</span>
<a href="#l20.1928"></a><span id="l20.1928" class="difflineplus">+                } else if (ampmCode == &quot;PM&quot;) {</span>
<a href="#l20.1929"></a><span id="l20.1929" class="difflineplus">+                    if (hours &lt; 12) {</span>
<a href="#l20.1930"></a><span id="l20.1930" class="difflineplus">+                        hours += 12;</span>
<a href="#l20.1931"></a><span id="l20.1931" class="difflineplus">+                    }</span>
<a href="#l20.1932"></a><span id="l20.1932" class="difflineplus">+                }</span>
<a href="#l20.1933"></a><span id="l20.1933" class="difflineplus">+                time = new Date(0, 0, 0, hours, minutes, seconds, 0);</span>
<a href="#l20.1934"></a><span id="l20.1934" class="difflineplus">+            }  // else did not match regex, not valid time</span>
<a href="#l20.1935"></a><span id="l20.1935" class="difflineplus">+            return time;</span>
<a href="#l20.1936"></a><span id="l20.1936">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.1937"></a><span id="l20.1937">       &lt;/method&gt;</span>
<a href="#l20.1938"></a><span id="l20.1938"> </span>
<a href="#l20.1939"></a><span id="l20.1939">       &lt;method name=&quot;initDateFormat&quot;&gt;</span>
<a href="#l20.1940"></a><span id="l20.1940">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.1941"></a><span id="l20.1941" class="difflineminus">-          // probe the dateformat</span>
<a href="#l20.1942"></a><span id="l20.1942" class="difflineminus">-          this.yearIndex = -1;</span>
<a href="#l20.1943"></a><span id="l20.1943" class="difflineminus">-          this.monthIndex = -1;</span>
<a href="#l20.1944"></a><span id="l20.1944" class="difflineminus">-          this.dayIndex = -1;</span>
<a href="#l20.1945"></a><span id="l20.1945" class="difflineminus">-          this.twoDigitYear = false;</span>
<a href="#l20.1946"></a><span id="l20.1946" class="difflineminus">-          this.alphaMonths = null;</span>
<a href="#l20.1947"></a><span id="l20.1947" class="difflineminus">-          this.probeSucceeded = false;</span>
<a href="#l20.1948"></a><span id="l20.1948" class="difflineminus">-          this.mLastDateParseIncludedTime = false;</span>
<a href="#l20.1949"></a><span id="l20.1949" class="difflineplus">+            // probe the dateformat</span>
<a href="#l20.1950"></a><span id="l20.1950" class="difflineplus">+            this.yearIndex = -1;</span>
<a href="#l20.1951"></a><span id="l20.1951" class="difflineplus">+            this.monthIndex = -1;</span>
<a href="#l20.1952"></a><span id="l20.1952" class="difflineplus">+            this.dayIndex = -1;</span>
<a href="#l20.1953"></a><span id="l20.1953" class="difflineplus">+            this.twoDigitYear = false;</span>
<a href="#l20.1954"></a><span id="l20.1954" class="difflineplus">+            this.alphaMonths = null;</span>
<a href="#l20.1955"></a><span id="l20.1955" class="difflineplus">+            this.probeSucceeded = false;</span>
<a href="#l20.1956"></a><span id="l20.1956" class="difflineplus">+            this.mLastDateParseIncludedTime = false;</span>
<a href="#l20.1957"></a><span id="l20.1957"> </span>
<a href="#l20.1958"></a><span id="l20.1958" class="difflineminus">-          // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l20.1959"></a><span id="l20.1959" class="difflineminus">-          // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l20.1960"></a><span id="l20.1960" class="difflineminus">-          // which do not match \w, esp. in CJK locales.)</span>
<a href="#l20.1961"></a><span id="l20.1961" class="difflineminus">-          this.parseShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)\D?$/;</span>
<a href="#l20.1962"></a><span id="l20.1962" class="difflineminus">-          let probeDate = new Date(2002, 2, 4); // month is 0-based</span>
<a href="#l20.1963"></a><span id="l20.1963" class="difflineminus">-          let probeString = this.formatDate(probeDate);</span>
<a href="#l20.1964"></a><span id="l20.1964" class="difflineminus">-          let probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.1965"></a><span id="l20.1965" class="difflineminus">-          if (probeArray) {</span>
<a href="#l20.1966"></a><span id="l20.1966" class="difflineminus">-              // Numeric month format</span>
<a href="#l20.1967"></a><span id="l20.1967" class="difflineminus">-              for (let i = 1; i &lt;= 3; i++) {</span>
<a href="#l20.1968"></a><span id="l20.1968" class="difflineminus">-                  switch (Number(probeArray[i])) {</span>
<a href="#l20.1969"></a><span id="l20.1969" class="difflineminus">-                      case 2: this.twoDigitYear = true; // falls through</span>
<a href="#l20.1970"></a><span id="l20.1970" class="difflineminus">-                      case 2002: this.yearIndex = i; break;</span>
<a href="#l20.1971"></a><span id="l20.1971" class="difflineminus">-                      case 3: this.monthIndex = i; break;</span>
<a href="#l20.1972"></a><span id="l20.1972" class="difflineminus">-                      case 4: this.dayIndex = i; break;</span>
<a href="#l20.1973"></a><span id="l20.1973" class="difflineminus">-                  }</span>
<a href="#l20.1974"></a><span id="l20.1974" class="difflineminus">-              }</span>
<a href="#l20.1975"></a><span id="l20.1975" class="difflineminus">-              // All three indexes are set (not -1) at this point.</span>
<a href="#l20.1976"></a><span id="l20.1976" class="difflineminus">-              this.probeSucceeded = true;</span>
<a href="#l20.1977"></a><span id="l20.1977" class="difflineminus">-          } else {</span>
<a href="#l20.1978"></a><span id="l20.1978" class="difflineminus">-              // SHORT DATE WITH ALPHABETIC MONTH, such as &quot;dd MMM yy&quot; or &quot;MMMM dd, yyyy&quot;</span>
<a href="#l20.1979"></a><span id="l20.1979" class="difflineminus">-              // (\d+|[^\d\W]) is digits or letters, not both together.</span>
<a href="#l20.1980"></a><span id="l20.1980" class="difflineminus">-              // Allows 31dec1999 (no delimiters between parts) if OS does (w2k does not).</span>
<a href="#l20.1981"></a><span id="l20.1981" class="difflineminus">-              // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l20.1982"></a><span id="l20.1982" class="difflineminus">-              // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l20.1983"></a><span id="l20.1983" class="difflineminus">-              // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l20.1984"></a><span id="l20.1984" class="difflineminus">-              // regexp derived from the Alphabetic ranges in</span>
<a href="#l20.1985"></a><span id="l20.1985" class="difflineminus">-              // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l20.1986"></a><span id="l20.1986" class="difflineminus">-              this.parseShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\s*$/;</span>
<a href="#l20.1987"></a><span id="l20.1987" class="difflineminus">-              probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.1988"></a><span id="l20.1988" class="difflineminus">-              if (probeArray != null) {</span>
<a href="#l20.1989"></a><span id="l20.1989" class="difflineminus">-                  for (let j = 1; j &lt;= 3; j++) {</span>
<a href="#l20.1990"></a><span id="l20.1990" class="difflineminus">-                      switch (Number(probeArray[j])) {</span>
<a href="#l20.1991"></a><span id="l20.1991" class="difflineminus">-                          case 2: this.twoDigitYear = true; // falls through</span>
<a href="#l20.1992"></a><span id="l20.1992" class="difflineminus">-                          case 2002: this.yearIndex = j; break;</span>
<a href="#l20.1993"></a><span id="l20.1993" class="difflineminus">-                          case 4: this.dayIndex = j; break;</span>
<a href="#l20.1994"></a><span id="l20.1994" class="difflineminus">-                          default: this.monthIndex = j; break;</span>
<a href="#l20.1995"></a><span id="l20.1995" class="difflineminus">-                      }</span>
<a href="#l20.1996"></a><span id="l20.1996" class="difflineminus">-                  }</span>
<a href="#l20.1997"></a><span id="l20.1997" class="difflineminus">-                  if (this.yearIndex != -1 &amp;&amp; this.dayIndex != -1 &amp;&amp; this.monthIndex != -1) {</span>
<a href="#l20.1998"></a><span id="l20.1998" class="difflineminus">-                      this.probeSucceeded = true;</span>
<a href="#l20.1999"></a><span id="l20.1999" class="difflineminus">-                      // Fill this.alphaMonths with month names.</span>
<a href="#l20.2000"></a><span id="l20.2000" class="difflineminus">-                      this.alphaMonths = new Array(12);</span>
<a href="#l20.2001"></a><span id="l20.2001" class="difflineminus">-                      for (let monthIdx = 0; monthIdx &lt; 12; monthIdx++) {</span>
<a href="#l20.2002"></a><span id="l20.2002" class="difflineminus">-                          probeDate.setMonth(monthIdx);</span>
<a href="#l20.2003"></a><span id="l20.2003" class="difflineminus">-                          probeString = this.formatDate(probeDate);</span>
<a href="#l20.2004"></a><span id="l20.2004" class="difflineminus">-                          probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.2005"></a><span id="l20.2005" class="difflineminus">-                          if (probeArray) {</span>
<a href="#l20.2006"></a><span id="l20.2006" class="difflineminus">-                              this.alphaMonths[monthIdx] = probeArray[this.monthIndex].toUpperCase();</span>
<a href="#l20.2007"></a><span id="l20.2007" class="difflineminus">-                          } else {</span>
<a href="#l20.2008"></a><span id="l20.2008" class="difflineminus">-                              this.probeSucceeded = false;</span>
<a href="#l20.2009"></a><span id="l20.2009" class="difflineminus">-                          }</span>
<a href="#l20.2010"></a><span id="l20.2010" class="difflineminus">-                      }</span>
<a href="#l20.2011"></a><span id="l20.2011" class="difflineminus">-                  }</span>
<a href="#l20.2012"></a><span id="l20.2012" class="difflineminus">-              }</span>
<a href="#l20.2013"></a><span id="l20.2013" class="difflineminus">-          }</span>
<a href="#l20.2014"></a><span id="l20.2014" class="difflineminus">-          if (!this.probeSucceeded) {</span>
<a href="#l20.2015"></a><span id="l20.2015" class="difflineminus">-              dump(&quot;\nOperating system short date format is not recognized: &quot; + probeString + &quot;\n&quot;);</span>
<a href="#l20.2016"></a><span id="l20.2016" class="difflineminus">-          }</span>
<a href="#l20.2017"></a><span id="l20.2017" class="difflineplus">+            // SHORT NUMERIC DATE, such as 2002-03-04, 4/3/2002, or CE2002Y03M04D.</span>
<a href="#l20.2018"></a><span id="l20.2018" class="difflineplus">+            // Made of digits &amp; nonDigits.  (Nondigits may be unicode letters</span>
<a href="#l20.2019"></a><span id="l20.2019" class="difflineplus">+            // which do not match \w, esp. in CJK locales.)</span>
<a href="#l20.2020"></a><span id="l20.2020" class="difflineplus">+            this.parseShortDateRegex = /^\D*(\d+)\D+(\d+)\D+(\d+)\D?$/;</span>
<a href="#l20.2021"></a><span id="l20.2021" class="difflineplus">+            let probeDate = new Date(2002, 2, 4); // month is 0-based</span>
<a href="#l20.2022"></a><span id="l20.2022" class="difflineplus">+            let probeString = this.formatDate(probeDate);</span>
<a href="#l20.2023"></a><span id="l20.2023" class="difflineplus">+            let probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.2024"></a><span id="l20.2024" class="difflineplus">+            if (probeArray) {</span>
<a href="#l20.2025"></a><span id="l20.2025" class="difflineplus">+                // Numeric month format</span>
<a href="#l20.2026"></a><span id="l20.2026" class="difflineplus">+                for (let i = 1; i &lt;= 3; i++) {</span>
<a href="#l20.2027"></a><span id="l20.2027" class="difflineplus">+                    switch (Number(probeArray[i])) {</span>
<a href="#l20.2028"></a><span id="l20.2028" class="difflineplus">+                        case 2: this.twoDigitYear = true; // falls through</span>
<a href="#l20.2029"></a><span id="l20.2029" class="difflineplus">+                        case 2002: this.yearIndex = i; break;</span>
<a href="#l20.2030"></a><span id="l20.2030" class="difflineplus">+                        case 3: this.monthIndex = i; break;</span>
<a href="#l20.2031"></a><span id="l20.2031" class="difflineplus">+                        case 4: this.dayIndex = i; break;</span>
<a href="#l20.2032"></a><span id="l20.2032" class="difflineplus">+                    }</span>
<a href="#l20.2033"></a><span id="l20.2033" class="difflineplus">+                }</span>
<a href="#l20.2034"></a><span id="l20.2034" class="difflineplus">+                // All three indexes are set (not -1) at this point.</span>
<a href="#l20.2035"></a><span id="l20.2035" class="difflineplus">+                this.probeSucceeded = true;</span>
<a href="#l20.2036"></a><span id="l20.2036" class="difflineplus">+            } else {</span>
<a href="#l20.2037"></a><span id="l20.2037" class="difflineplus">+                // SHORT DATE WITH ALPHABETIC MONTH, such as &quot;dd MMM yy&quot; or &quot;MMMM dd, yyyy&quot;</span>
<a href="#l20.2038"></a><span id="l20.2038" class="difflineplus">+                // (\d+|[^\d\W]) is digits or letters, not both together.</span>
<a href="#l20.2039"></a><span id="l20.2039" class="difflineplus">+                // Allows 31dec1999 (no delimiters between parts) if OS does (w2k does not).</span>
<a href="#l20.2040"></a><span id="l20.2040" class="difflineplus">+                // Allows Dec 31, 1999 (comma and space between parts)</span>
<a href="#l20.2041"></a><span id="l20.2041" class="difflineplus">+                // (Only accepts ASCII month names; JavaScript RegExp does not have an</span>
<a href="#l20.2042"></a><span id="l20.2042" class="difflineplus">+                // easy way to describe unicode letters short of a HUGE character range</span>
<a href="#l20.2043"></a><span id="l20.2043" class="difflineplus">+                // regexp derived from the Alphabetic ranges in</span>
<a href="#l20.2044"></a><span id="l20.2044" class="difflineplus">+                // http://www.unicode.org/Public/UNIDATA/DerivedCoreProperties.txt)</span>
<a href="#l20.2045"></a><span id="l20.2045" class="difflineplus">+                this.parseShortDateRegex = /^\s*(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\W{0,2}(\d+|[^\d\W]+)\s*$/;</span>
<a href="#l20.2046"></a><span id="l20.2046" class="difflineplus">+                probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.2047"></a><span id="l20.2047" class="difflineplus">+                if (probeArray != null) {</span>
<a href="#l20.2048"></a><span id="l20.2048" class="difflineplus">+                    for (let j = 1; j &lt;= 3; j++) {</span>
<a href="#l20.2049"></a><span id="l20.2049" class="difflineplus">+                        switch (Number(probeArray[j])) {</span>
<a href="#l20.2050"></a><span id="l20.2050" class="difflineplus">+                            case 2: this.twoDigitYear = true; // falls through</span>
<a href="#l20.2051"></a><span id="l20.2051" class="difflineplus">+                            case 2002: this.yearIndex = j; break;</span>
<a href="#l20.2052"></a><span id="l20.2052" class="difflineplus">+                            case 4: this.dayIndex = j; break;</span>
<a href="#l20.2053"></a><span id="l20.2053" class="difflineplus">+                            default: this.monthIndex = j; break;</span>
<a href="#l20.2054"></a><span id="l20.2054" class="difflineplus">+                        }</span>
<a href="#l20.2055"></a><span id="l20.2055" class="difflineplus">+                    }</span>
<a href="#l20.2056"></a><span id="l20.2056" class="difflineplus">+                    if (this.yearIndex != -1 &amp;&amp; this.dayIndex != -1 &amp;&amp; this.monthIndex != -1) {</span>
<a href="#l20.2057"></a><span id="l20.2057" class="difflineplus">+                        this.probeSucceeded = true;</span>
<a href="#l20.2058"></a><span id="l20.2058" class="difflineplus">+                        // Fill this.alphaMonths with month names.</span>
<a href="#l20.2059"></a><span id="l20.2059" class="difflineplus">+                        this.alphaMonths = new Array(12);</span>
<a href="#l20.2060"></a><span id="l20.2060" class="difflineplus">+                        for (let monthIdx = 0; monthIdx &lt; 12; monthIdx++) {</span>
<a href="#l20.2061"></a><span id="l20.2061" class="difflineplus">+                            probeDate.setMonth(monthIdx);</span>
<a href="#l20.2062"></a><span id="l20.2062" class="difflineplus">+                            probeString = this.formatDate(probeDate);</span>
<a href="#l20.2063"></a><span id="l20.2063" class="difflineplus">+                            probeArray = this.parseShortDateRegex.exec(probeString);</span>
<a href="#l20.2064"></a><span id="l20.2064" class="difflineplus">+                            if (probeArray) {</span>
<a href="#l20.2065"></a><span id="l20.2065" class="difflineplus">+                                this.alphaMonths[monthIdx] = probeArray[this.monthIndex].toUpperCase();</span>
<a href="#l20.2066"></a><span id="l20.2066" class="difflineplus">+                            } else {</span>
<a href="#l20.2067"></a><span id="l20.2067" class="difflineplus">+                                this.probeSucceeded = false;</span>
<a href="#l20.2068"></a><span id="l20.2068" class="difflineplus">+                            }</span>
<a href="#l20.2069"></a><span id="l20.2069" class="difflineplus">+                        }</span>
<a href="#l20.2070"></a><span id="l20.2070" class="difflineplus">+                    }</span>
<a href="#l20.2071"></a><span id="l20.2071" class="difflineplus">+                }</span>
<a href="#l20.2072"></a><span id="l20.2072" class="difflineplus">+            }</span>
<a href="#l20.2073"></a><span id="l20.2073" class="difflineplus">+            if (!this.probeSucceeded) {</span>
<a href="#l20.2074"></a><span id="l20.2074" class="difflineplus">+                dump(&quot;\nOperating system short date format is not recognized: &quot; + probeString + &quot;\n&quot;);</span>
<a href="#l20.2075"></a><span id="l20.2075" class="difflineplus">+            }</span>
<a href="#l20.2076"></a><span id="l20.2076">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.2077"></a><span id="l20.2077">       &lt;/method&gt;</span>
<a href="#l20.2078"></a><span id="l20.2078"> </span>
<a href="#l20.2079"></a><span id="l20.2079">       &lt;!-- Time format in 24-hour format or 12-hour format with am/pm string.</span>
<a href="#l20.2080"></a><span id="l20.2080">            Should match formats</span>
<a href="#l20.2081"></a><span id="l20.2081">                 HH:mm,       H:mm,       HH:mm:ss,       H:mm:ss</span>
<a href="#l20.2082"></a><span id="l20.2082">                 hh:mm tt,    h:mm tt,    hh:mm:ss tt,    h:mm:ss tt</span>
<a href="#l20.2083"></a><span id="l20.2083">              tt hh:mm,    tt h:mm,    tt hh:mm:ss,    tt h:mm:ss</span>
<a href="#l20.2084"></a><span id="l20.2084" class="difflineat">@@ -1764,120 +1764,120 @@</span>
<a href="#l20.2085"></a><span id="l20.2085">            hh is 12 hour digits, with leading 0.  h is 12 hour digits, no leading 0.</span>
<a href="#l20.2086"></a><span id="l20.2086">            mm and ss are is minutes and seconds digits, with leading 0.</span>
<a href="#l20.2087"></a><span id="l20.2087">            tt is localized AM or PM string.</span>
<a href="#l20.2088"></a><span id="l20.2088">            ':' may be ':' or a units marker such as 'h', 'm', or 's' in  15h12m00s</span>
<a href="#l20.2089"></a><span id="l20.2089">            or may be omitted as in 151200.</span>
<a href="#l20.2090"></a><span id="l20.2090">       --&gt;</span>
<a href="#l20.2091"></a><span id="l20.2091">       &lt;method name=&quot;initTimeFormat&quot;&gt;</span>
<a href="#l20.2092"></a><span id="l20.2092">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.2093"></a><span id="l20.2093" class="difflineminus">-          // probe the Time format</span>
<a href="#l20.2094"></a><span id="l20.2094" class="difflineminus">-          this.ampmIndex = null;</span>
<a href="#l20.2095"></a><span id="l20.2095" class="difflineminus">-          // Digits         HR       sep      MIN     sep      SEC     sep</span>
<a href="#l20.2096"></a><span id="l20.2096" class="difflineminus">-          //   Index:       2        3        4       5        6       7</span>
<a href="#l20.2097"></a><span id="l20.2097" class="difflineminus">-          let digitsExpr = &quot;(\\d?\\d)(\\D)?(?:(\\d\\d)(\\D)?(?:(\\d\\d)(\\D)?)?)?&quot;;</span>
<a href="#l20.2098"></a><span id="l20.2098" class="difflineminus">-          // any letters or '.': non-digit alphanumeric, period (a.m.), or space (P M)</span>
<a href="#l20.2099"></a><span id="l20.2099" class="difflineminus">-          let anyAmPmExpr = &quot;(?:[^\\d\\W]|[. ])+&quot;;</span>
<a href="#l20.2100"></a><span id="l20.2100" class="difflineminus">-          // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l20.2101"></a><span id="l20.2101" class="difflineminus">-          let probeTimeRegExp =</span>
<a href="#l20.2102"></a><span id="l20.2102" class="difflineminus">-              new RegExp(&quot;^(&quot; + anyAmPmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + anyAmPmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l20.2103"></a><span id="l20.2103" class="difflineminus">-          const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8; // eslint-disable-line no-unused-vars</span>
<a href="#l20.2104"></a><span id="l20.2104" class="difflineminus">-          let amProbeTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l20.2105"></a><span id="l20.2105" class="difflineminus">-          let pmProbeTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l20.2106"></a><span id="l20.2106" class="difflineminus">-          let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.2107"></a><span id="l20.2107" class="difflineminus">-          let amProbeString = formatter.format(amProbeTime);</span>
<a href="#l20.2108"></a><span id="l20.2108" class="difflineminus">-          let pmProbeString = formatter.format(pmProbeTime);</span>
<a href="#l20.2109"></a><span id="l20.2109" class="difflineminus">-          let amFormatExpr = null, pmFormatExpr = null;</span>
<a href="#l20.2110"></a><span id="l20.2110" class="difflineminus">-          if (amProbeString != pmProbeString) {</span>
<a href="#l20.2111"></a><span id="l20.2111" class="difflineminus">-              let amProbeArray = probeTimeRegExp.exec(amProbeString);</span>
<a href="#l20.2112"></a><span id="l20.2112" class="difflineminus">-              let pmProbeArray = probeTimeRegExp.exec(pmProbeString);</span>
<a href="#l20.2113"></a><span id="l20.2113" class="difflineminus">-              if (amProbeArray != null &amp;&amp; pmProbeArray != null) {</span>
<a href="#l20.2114"></a><span id="l20.2114" class="difflineminus">-                  if (amProbeArray[PRE_INDEX] &amp;&amp; pmProbeArray[PRE_INDEX] &amp;&amp;</span>
<a href="#l20.2115"></a><span id="l20.2115" class="difflineminus">-                      amProbeArray[PRE_INDEX] != pmProbeArray[PRE_INDEX]) {</span>
<a href="#l20.2116"></a><span id="l20.2116" class="difflineminus">-                      this.ampmIndex = PRE_INDEX;</span>
<a href="#l20.2117"></a><span id="l20.2117" class="difflineminus">-                  } else if (amProbeArray[POST_INDEX] &amp;&amp; pmProbeArray[POST_INDEX]) {</span>
<a href="#l20.2118"></a><span id="l20.2118" class="difflineminus">-                      if (amProbeArray[POST_INDEX] == pmProbeArray[POST_INDEX]) {</span>
<a href="#l20.2119"></a><span id="l20.2119" class="difflineminus">-                          // check if need to append previous character,</span>
<a href="#l20.2120"></a><span id="l20.2120" class="difflineminus">-                          // captured by the optional separator pattern after seconds digits,</span>
<a href="#l20.2121"></a><span id="l20.2121" class="difflineminus">-                          // or after minutes if no seconds, or after hours if no minutes.</span>
<a href="#l20.2122"></a><span id="l20.2122" class="difflineminus">-                          for (let k = SEC_INDEX; k &gt;= HR_INDEX; k -= 2) {</span>
<a href="#l20.2123"></a><span id="l20.2123" class="difflineminus">-                              let nextSepI = k + 1;</span>
<a href="#l20.2124"></a><span id="l20.2124" class="difflineminus">-                              let nextDigitsI = k + 2;</span>
<a href="#l20.2125"></a><span id="l20.2125" class="difflineminus">-                              if ((k == SEC_INDEX ||</span>
<a href="#l20.2126"></a><span id="l20.2126" class="difflineminus">-                                   (!amProbeArray[nextDigitsI] &amp;&amp; !pmProbeArray[nextDigitsI])) &amp;&amp;</span>
<a href="#l20.2127"></a><span id="l20.2127" class="difflineminus">-                                  amProbeArray[nextSepI] &amp;&amp; pmProbeArray[nextSepI] &amp;&amp;</span>
<a href="#l20.2128"></a><span id="l20.2128" class="difflineminus">-                                  amProbeArray[nextSepI] != pmProbeArray[nextSepI]) {</span>
<a href="#l20.2129"></a><span id="l20.2129" class="difflineminus">-                                  amProbeArray[POST_INDEX] =</span>
<a href="#l20.2130"></a><span id="l20.2130" class="difflineminus">-                                    amProbeArray[nextSepI] + amProbeArray[POST_INDEX];</span>
<a href="#l20.2131"></a><span id="l20.2131" class="difflineminus">-                                  pmProbeArray[POST_INDEX] =</span>
<a href="#l20.2132"></a><span id="l20.2132" class="difflineminus">-                                    pmProbeArray[nextSepI] + pmProbeArray[POST_INDEX];</span>
<a href="#l20.2133"></a><span id="l20.2133" class="difflineminus">-                                  this.ampmIndex = POST_INDEX;</span>
<a href="#l20.2134"></a><span id="l20.2134" class="difflineminus">-                                  break;</span>
<a href="#l20.2135"></a><span id="l20.2135" class="difflineminus">-                              }</span>
<a href="#l20.2136"></a><span id="l20.2136" class="difflineminus">-                          }</span>
<a href="#l20.2137"></a><span id="l20.2137" class="difflineminus">-                      } else {</span>
<a href="#l20.2138"></a><span id="l20.2138" class="difflineminus">-                          this.ampmIndex = POST_INDEX;</span>
<a href="#l20.2139"></a><span id="l20.2139" class="difflineminus">-                      }</span>
<a href="#l20.2140"></a><span id="l20.2140" class="difflineminus">-                  }</span>
<a href="#l20.2141"></a><span id="l20.2141" class="difflineminus">-                  if (this.ampmIndex) {</span>
<a href="#l20.2142"></a><span id="l20.2142" class="difflineminus">-                      let makeFormatRegExp = function(string) {</span>
<a href="#l20.2143"></a><span id="l20.2143" class="difflineminus">-                          // make expr to accept either as provided, lowercased, or uppercased</span>
<a href="#l20.2144"></a><span id="l20.2144" class="difflineminus">-                          let regExp = string.replace(/(\W)/g, &quot;[$1]&quot;); // escape punctuation</span>
<a href="#l20.2145"></a><span id="l20.2145" class="difflineminus">-                          let lowercased = string.toLowerCase();</span>
<a href="#l20.2146"></a><span id="l20.2146" class="difflineminus">-                          if (string != lowercased) {</span>
<a href="#l20.2147"></a><span id="l20.2147" class="difflineminus">-                              regExp += &quot;|&quot; + lowercased;</span>
<a href="#l20.2148"></a><span id="l20.2148" class="difflineminus">-                          }</span>
<a href="#l20.2149"></a><span id="l20.2149" class="difflineminus">-                          let uppercased = string.toUpperCase();</span>
<a href="#l20.2150"></a><span id="l20.2150" class="difflineminus">-                          if (string != uppercased) {</span>
<a href="#l20.2151"></a><span id="l20.2151" class="difflineminus">-                              regExp += &quot;|&quot; + uppercased;</span>
<a href="#l20.2152"></a><span id="l20.2152" class="difflineminus">-                          }</span>
<a href="#l20.2153"></a><span id="l20.2153" class="difflineminus">-                          return regExp;</span>
<a href="#l20.2154"></a><span id="l20.2154" class="difflineminus">-                      };</span>
<a href="#l20.2155"></a><span id="l20.2155" class="difflineminus">-                      amFormatExpr = makeFormatRegExp(amProbeArray[this.ampmIndex]);</span>
<a href="#l20.2156"></a><span id="l20.2156" class="difflineminus">-                      pmFormatExpr = makeFormatRegExp(pmProbeArray[this.ampmIndex]);</span>
<a href="#l20.2157"></a><span id="l20.2157" class="difflineminus">-                  }</span>
<a href="#l20.2158"></a><span id="l20.2158" class="difflineminus">-              }</span>
<a href="#l20.2159"></a><span id="l20.2159" class="difflineminus">-          }</span>
<a href="#l20.2160"></a><span id="l20.2160" class="difflineminus">-          // International formats ([roman, cyrillic]|arabic|chinese/kanji characters)</span>
<a href="#l20.2161"></a><span id="l20.2161" class="difflineminus">-          // covering languages of U.N. (en,fr,sp,ru,ar,zh) and G8 (en,fr,de,it,ru,ja).</span>
<a href="#l20.2162"></a><span id="l20.2162" class="difflineminus">-          // See examples at parseTimeOfDay.</span>
<a href="#l20.2163"></a><span id="l20.2163" class="difflineminus">-          let amExpr =</span>
<a href="#l20.2164"></a><span id="l20.2164" class="difflineminus">-              &quot;[Aa\u0410\u0430][. ]?[Mm\u041c\u043c][. ]?|\u0635|\u4e0a\u5348|\u5348\u524d&quot;;</span>
<a href="#l20.2165"></a><span id="l20.2165" class="difflineminus">-          let pmExpr =</span>
<a href="#l20.2166"></a><span id="l20.2166" class="difflineminus">-              &quot;[Pp\u0420\u0440][. ]?[Mm\u041c\u043c][. ]?|\u0645|\u4e0b\u5348|\u5348\u5f8c&quot;;</span>
<a href="#l20.2167"></a><span id="l20.2167" class="difflineminus">-          if (this.ampmIndex) {</span>
<a href="#l20.2168"></a><span id="l20.2168" class="difflineminus">-              amExpr = amFormatExpr + &quot;|&quot; + amExpr;</span>
<a href="#l20.2169"></a><span id="l20.2169" class="difflineminus">-              pmExpr = pmFormatExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l20.2170"></a><span id="l20.2170" class="difflineminus">-          }</span>
<a href="#l20.2171"></a><span id="l20.2171" class="difflineminus">-          let ampmExpr = amExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l20.2172"></a><span id="l20.2172" class="difflineminus">-          // Must build am/pm formats into parse time regexp so that it can</span>
<a href="#l20.2173"></a><span id="l20.2173" class="difflineminus">-          // match them without mistaking the initial char for an optional divider.</span>
<a href="#l20.2174"></a><span id="l20.2174" class="difflineminus">-          // (For example, want to be able to parse both &quot;12:34pm&quot; and</span>
<a href="#l20.2175"></a><span id="l20.2175" class="difflineminus">-          // &quot;12H34M56Spm&quot; for any characters H,M,S and any language's &quot;pm&quot;.</span>
<a href="#l20.2176"></a><span id="l20.2176" class="difflineminus">-          // The character between the last digit and the &quot;pm&quot; is optional.</span>
<a href="#l20.2177"></a><span id="l20.2177" class="difflineminus">-          // Must recogize &quot;pm&quot; directly, otherwise in &quot;12:34pm&quot; the &quot;S&quot; pattern</span>
<a href="#l20.2178"></a><span id="l20.2178" class="difflineminus">-          // matches the &quot;p&quot; character so only &quot;m&quot; is matched as ampm suffix.)</span>
<a href="#l20.2179"></a><span id="l20.2179" class="difflineminus">-          //</span>
<a href="#l20.2180"></a><span id="l20.2180" class="difflineminus">-          // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l20.2181"></a><span id="l20.2181" class="difflineminus">-          this.parseTimeRegExp =</span>
<a href="#l20.2182"></a><span id="l20.2182" class="difflineminus">-              new RegExp(&quot;(&quot; + ampmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + ampmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l20.2183"></a><span id="l20.2183" class="difflineminus">-          this.amRegExp = new RegExp(&quot;^(?:&quot; + amExpr + &quot;)$&quot;);</span>
<a href="#l20.2184"></a><span id="l20.2184" class="difflineminus">-          this.pmRegExp = new RegExp(&quot;^(?:&quot; + pmExpr + &quot;)$&quot;);</span>
<a href="#l20.2185"></a><span id="l20.2185" class="difflineplus">+            // probe the Time format</span>
<a href="#l20.2186"></a><span id="l20.2186" class="difflineplus">+            this.ampmIndex = null;</span>
<a href="#l20.2187"></a><span id="l20.2187" class="difflineplus">+            // Digits         HR       sep      MIN     sep      SEC     sep</span>
<a href="#l20.2188"></a><span id="l20.2188" class="difflineplus">+            //   Index:       2        3        4       5        6       7</span>
<a href="#l20.2189"></a><span id="l20.2189" class="difflineplus">+            let digitsExpr = &quot;(\\d?\\d)(\\D)?(?:(\\d\\d)(\\D)?(?:(\\d\\d)(\\D)?)?)?&quot;;</span>
<a href="#l20.2190"></a><span id="l20.2190" class="difflineplus">+            // any letters or '.': non-digit alphanumeric, period (a.m.), or space (P M)</span>
<a href="#l20.2191"></a><span id="l20.2191" class="difflineplus">+            let anyAmPmExpr = &quot;(?:[^\\d\\W]|[. ])+&quot;;</span>
<a href="#l20.2192"></a><span id="l20.2192" class="difflineplus">+            // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l20.2193"></a><span id="l20.2193" class="difflineplus">+            let probeTimeRegExp =</span>
<a href="#l20.2194"></a><span id="l20.2194" class="difflineplus">+                new RegExp(&quot;^(&quot; + anyAmPmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + anyAmPmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l20.2195"></a><span id="l20.2195" class="difflineplus">+            const PRE_INDEX = 1, HR_INDEX = 2, MIN_INDEX = 4, SEC_INDEX = 6, POST_INDEX = 8; // eslint-disable-line no-unused-vars</span>
<a href="#l20.2196"></a><span id="l20.2196" class="difflineplus">+            let amProbeTime = new Date(2000, 0, 1, 6, 12, 34);</span>
<a href="#l20.2197"></a><span id="l20.2197" class="difflineplus">+            let pmProbeTime = new Date(2000, 0, 1, 18, 12, 34);</span>
<a href="#l20.2198"></a><span id="l20.2198" class="difflineplus">+            let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.2199"></a><span id="l20.2199" class="difflineplus">+            let amProbeString = formatter.format(amProbeTime);</span>
<a href="#l20.2200"></a><span id="l20.2200" class="difflineplus">+            let pmProbeString = formatter.format(pmProbeTime);</span>
<a href="#l20.2201"></a><span id="l20.2201" class="difflineplus">+            let amFormatExpr = null, pmFormatExpr = null;</span>
<a href="#l20.2202"></a><span id="l20.2202" class="difflineplus">+            if (amProbeString != pmProbeString) {</span>
<a href="#l20.2203"></a><span id="l20.2203" class="difflineplus">+                let amProbeArray = probeTimeRegExp.exec(amProbeString);</span>
<a href="#l20.2204"></a><span id="l20.2204" class="difflineplus">+                let pmProbeArray = probeTimeRegExp.exec(pmProbeString);</span>
<a href="#l20.2205"></a><span id="l20.2205" class="difflineplus">+                if (amProbeArray != null &amp;&amp; pmProbeArray != null) {</span>
<a href="#l20.2206"></a><span id="l20.2206" class="difflineplus">+                    if (amProbeArray[PRE_INDEX] &amp;&amp; pmProbeArray[PRE_INDEX] &amp;&amp;</span>
<a href="#l20.2207"></a><span id="l20.2207" class="difflineplus">+                        amProbeArray[PRE_INDEX] != pmProbeArray[PRE_INDEX]) {</span>
<a href="#l20.2208"></a><span id="l20.2208" class="difflineplus">+                        this.ampmIndex = PRE_INDEX;</span>
<a href="#l20.2209"></a><span id="l20.2209" class="difflineplus">+                    } else if (amProbeArray[POST_INDEX] &amp;&amp; pmProbeArray[POST_INDEX]) {</span>
<a href="#l20.2210"></a><span id="l20.2210" class="difflineplus">+                        if (amProbeArray[POST_INDEX] == pmProbeArray[POST_INDEX]) {</span>
<a href="#l20.2211"></a><span id="l20.2211" class="difflineplus">+                            // check if need to append previous character,</span>
<a href="#l20.2212"></a><span id="l20.2212" class="difflineplus">+                            // captured by the optional separator pattern after seconds digits,</span>
<a href="#l20.2213"></a><span id="l20.2213" class="difflineplus">+                            // or after minutes if no seconds, or after hours if no minutes.</span>
<a href="#l20.2214"></a><span id="l20.2214" class="difflineplus">+                            for (let k = SEC_INDEX; k &gt;= HR_INDEX; k -= 2) {</span>
<a href="#l20.2215"></a><span id="l20.2215" class="difflineplus">+                                let nextSepI = k + 1;</span>
<a href="#l20.2216"></a><span id="l20.2216" class="difflineplus">+                                let nextDigitsI = k + 2;</span>
<a href="#l20.2217"></a><span id="l20.2217" class="difflineplus">+                                if ((k == SEC_INDEX ||</span>
<a href="#l20.2218"></a><span id="l20.2218" class="difflineplus">+                                     (!amProbeArray[nextDigitsI] &amp;&amp; !pmProbeArray[nextDigitsI])) &amp;&amp;</span>
<a href="#l20.2219"></a><span id="l20.2219" class="difflineplus">+                                    amProbeArray[nextSepI] &amp;&amp; pmProbeArray[nextSepI] &amp;&amp;</span>
<a href="#l20.2220"></a><span id="l20.2220" class="difflineplus">+                                    amProbeArray[nextSepI] != pmProbeArray[nextSepI]) {</span>
<a href="#l20.2221"></a><span id="l20.2221" class="difflineplus">+                                    amProbeArray[POST_INDEX] =</span>
<a href="#l20.2222"></a><span id="l20.2222" class="difflineplus">+                                      amProbeArray[nextSepI] + amProbeArray[POST_INDEX];</span>
<a href="#l20.2223"></a><span id="l20.2223" class="difflineplus">+                                    pmProbeArray[POST_INDEX] =</span>
<a href="#l20.2224"></a><span id="l20.2224" class="difflineplus">+                                      pmProbeArray[nextSepI] + pmProbeArray[POST_INDEX];</span>
<a href="#l20.2225"></a><span id="l20.2225" class="difflineplus">+                                    this.ampmIndex = POST_INDEX;</span>
<a href="#l20.2226"></a><span id="l20.2226" class="difflineplus">+                                    break;</span>
<a href="#l20.2227"></a><span id="l20.2227" class="difflineplus">+                                }</span>
<a href="#l20.2228"></a><span id="l20.2228" class="difflineplus">+                            }</span>
<a href="#l20.2229"></a><span id="l20.2229" class="difflineplus">+                        } else {</span>
<a href="#l20.2230"></a><span id="l20.2230" class="difflineplus">+                            this.ampmIndex = POST_INDEX;</span>
<a href="#l20.2231"></a><span id="l20.2231" class="difflineplus">+                        }</span>
<a href="#l20.2232"></a><span id="l20.2232" class="difflineplus">+                    }</span>
<a href="#l20.2233"></a><span id="l20.2233" class="difflineplus">+                    if (this.ampmIndex) {</span>
<a href="#l20.2234"></a><span id="l20.2234" class="difflineplus">+                        let makeFormatRegExp = function(string) {</span>
<a href="#l20.2235"></a><span id="l20.2235" class="difflineplus">+                            // make expr to accept either as provided, lowercased, or uppercased</span>
<a href="#l20.2236"></a><span id="l20.2236" class="difflineplus">+                            let regExp = string.replace(/(\W)/g, &quot;[$1]&quot;); // escape punctuation</span>
<a href="#l20.2237"></a><span id="l20.2237" class="difflineplus">+                            let lowercased = string.toLowerCase();</span>
<a href="#l20.2238"></a><span id="l20.2238" class="difflineplus">+                            if (string != lowercased) {</span>
<a href="#l20.2239"></a><span id="l20.2239" class="difflineplus">+                                regExp += &quot;|&quot; + lowercased;</span>
<a href="#l20.2240"></a><span id="l20.2240" class="difflineplus">+                            }</span>
<a href="#l20.2241"></a><span id="l20.2241" class="difflineplus">+                            let uppercased = string.toUpperCase();</span>
<a href="#l20.2242"></a><span id="l20.2242" class="difflineplus">+                            if (string != uppercased) {</span>
<a href="#l20.2243"></a><span id="l20.2243" class="difflineplus">+                                regExp += &quot;|&quot; + uppercased;</span>
<a href="#l20.2244"></a><span id="l20.2244" class="difflineplus">+                            }</span>
<a href="#l20.2245"></a><span id="l20.2245" class="difflineplus">+                            return regExp;</span>
<a href="#l20.2246"></a><span id="l20.2246" class="difflineplus">+                        };</span>
<a href="#l20.2247"></a><span id="l20.2247" class="difflineplus">+                        amFormatExpr = makeFormatRegExp(amProbeArray[this.ampmIndex]);</span>
<a href="#l20.2248"></a><span id="l20.2248" class="difflineplus">+                        pmFormatExpr = makeFormatRegExp(pmProbeArray[this.ampmIndex]);</span>
<a href="#l20.2249"></a><span id="l20.2249" class="difflineplus">+                    }</span>
<a href="#l20.2250"></a><span id="l20.2250" class="difflineplus">+                }</span>
<a href="#l20.2251"></a><span id="l20.2251" class="difflineplus">+            }</span>
<a href="#l20.2252"></a><span id="l20.2252" class="difflineplus">+            // International formats ([roman, cyrillic]|arabic|chinese/kanji characters)</span>
<a href="#l20.2253"></a><span id="l20.2253" class="difflineplus">+            // covering languages of U.N. (en,fr,sp,ru,ar,zh) and G8 (en,fr,de,it,ru,ja).</span>
<a href="#l20.2254"></a><span id="l20.2254" class="difflineplus">+            // See examples at parseTimeOfDay.</span>
<a href="#l20.2255"></a><span id="l20.2255" class="difflineplus">+            let amExpr =</span>
<a href="#l20.2256"></a><span id="l20.2256" class="difflineplus">+                &quot;[Aa\u0410\u0430][. ]?[Mm\u041c\u043c][. ]?|\u0635|\u4e0a\u5348|\u5348\u524d&quot;;</span>
<a href="#l20.2257"></a><span id="l20.2257" class="difflineplus">+            let pmExpr =</span>
<a href="#l20.2258"></a><span id="l20.2258" class="difflineplus">+                &quot;[Pp\u0420\u0440][. ]?[Mm\u041c\u043c][. ]?|\u0645|\u4e0b\u5348|\u5348\u5f8c&quot;;</span>
<a href="#l20.2259"></a><span id="l20.2259" class="difflineplus">+            if (this.ampmIndex) {</span>
<a href="#l20.2260"></a><span id="l20.2260" class="difflineplus">+                amExpr = amFormatExpr + &quot;|&quot; + amExpr;</span>
<a href="#l20.2261"></a><span id="l20.2261" class="difflineplus">+                pmExpr = pmFormatExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l20.2262"></a><span id="l20.2262" class="difflineplus">+            }</span>
<a href="#l20.2263"></a><span id="l20.2263" class="difflineplus">+            let ampmExpr = amExpr + &quot;|&quot; + pmExpr;</span>
<a href="#l20.2264"></a><span id="l20.2264" class="difflineplus">+            // Must build am/pm formats into parse time regexp so that it can</span>
<a href="#l20.2265"></a><span id="l20.2265" class="difflineplus">+            // match them without mistaking the initial char for an optional divider.</span>
<a href="#l20.2266"></a><span id="l20.2266" class="difflineplus">+            // (For example, want to be able to parse both &quot;12:34pm&quot; and</span>
<a href="#l20.2267"></a><span id="l20.2267" class="difflineplus">+            // &quot;12H34M56Spm&quot; for any characters H,M,S and any language's &quot;pm&quot;.</span>
<a href="#l20.2268"></a><span id="l20.2268" class="difflineplus">+            // The character between the last digit and the &quot;pm&quot; is optional.</span>
<a href="#l20.2269"></a><span id="l20.2269" class="difflineplus">+            // Must recogize &quot;pm&quot; directly, otherwise in &quot;12:34pm&quot; the &quot;S&quot; pattern</span>
<a href="#l20.2270"></a><span id="l20.2270" class="difflineplus">+            // matches the &quot;p&quot; character so only &quot;m&quot; is matched as ampm suffix.)</span>
<a href="#l20.2271"></a><span id="l20.2271" class="difflineplus">+            //</span>
<a href="#l20.2272"></a><span id="l20.2272" class="difflineplus">+            // digitsExpr has 6 captures, so index of first ampmExpr is 1, of last is 8.</span>
<a href="#l20.2273"></a><span id="l20.2273" class="difflineplus">+            this.parseTimeRegExp =</span>
<a href="#l20.2274"></a><span id="l20.2274" class="difflineplus">+                new RegExp(&quot;(&quot; + ampmExpr + &quot;)?\\s?&quot; + digitsExpr + &quot;(&quot; + ampmExpr + &quot;)?\\s*$&quot;);</span>
<a href="#l20.2275"></a><span id="l20.2275" class="difflineplus">+            this.amRegExp = new RegExp(&quot;^(?:&quot; + amExpr + &quot;)$&quot;);</span>
<a href="#l20.2276"></a><span id="l20.2276" class="difflineplus">+            this.pmRegExp = new RegExp(&quot;^(?:&quot; + pmExpr + &quot;)$&quot;);</span>
<a href="#l20.2277"></a><span id="l20.2277">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.2278"></a><span id="l20.2278">       &lt;/method&gt;</span>
<a href="#l20.2279"></a><span id="l20.2279"> </span>
<a href="#l20.2280"></a><span id="l20.2280">       &lt;method name=&quot;formatDate&quot;&gt;</span>
<a href="#l20.2281"></a><span id="l20.2281">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l20.2282"></a><span id="l20.2282">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.2283"></a><span id="l20.2283" class="difflineminus">-          return cal.getDateFormatter().formatDateShort(cal.jsDateToDateTime(aDate, cal.floating()));</span>
<a href="#l20.2284"></a><span id="l20.2284" class="difflineplus">+            return cal.getDateFormatter().formatDateShort(cal.jsDateToDateTime(aDate, cal.floating()));</span>
<a href="#l20.2285"></a><span id="l20.2285">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.2286"></a><span id="l20.2286">       &lt;/method&gt;</span>
<a href="#l20.2287"></a><span id="l20.2287"> </span>
<a href="#l20.2288"></a><span id="l20.2288">       &lt;method name=&quot;formatTime&quot;&gt;</span>
<a href="#l20.2289"></a><span id="l20.2289">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l20.2290"></a><span id="l20.2290">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l20.2291"></a><span id="l20.2291" class="difflineminus">-          let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.2292"></a><span id="l20.2292" class="difflineminus">-          return formatter.format(aValue);</span>
<a href="#l20.2293"></a><span id="l20.2293" class="difflineplus">+            let formatter = Services.intl.createDateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l20.2294"></a><span id="l20.2294" class="difflineplus">+            return formatter.format(aValue);</span>
<a href="#l20.2295"></a><span id="l20.2295">         ]]&gt;&lt;/body&gt;</span>
<a href="#l20.2296"></a><span id="l20.2296">       &lt;/method&gt;</span>
<a href="#l20.2297"></a><span id="l20.2297">     &lt;/implementation&gt;</span>
<a href="#l20.2298"></a><span id="l20.2298">   &lt;/binding&gt;</span>
<a href="#l20.2299"></a><span id="l20.2299"> &lt;/bindings&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

