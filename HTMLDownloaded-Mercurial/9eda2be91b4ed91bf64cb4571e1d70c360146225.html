<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29420:9eda2be91b4ed91bf64cb4571e1d70c360146225</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9eda2be91b4ed91bf64cb4571e1d70c360146225" />
<meta property="og:url" content="/comm-central/rev/9eda2be91b4ed91bf64cb4571e1d70c360146225" />
<meta property="og:description" content="Bug 1633620 - Stop using URLs to search address books. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9eda2be91b4ed91bf64cb4571e1d70c360146225 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9eda2be91b4ed91bf64cb4571e1d70c360146225">shortlog</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9eda2be91b4ed91bf64cb4571e1d70c360146225">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225">files</a> |
changeset |
<a href="/comm-central/raw-rev/9eda2be91b4ed91bf64cb4571e1d70c360146225">raw</a>  | <a href="/comm-central/archive/9eda2be91b4ed91bf64cb4571e1d70c360146225.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1633620">Bug 1633620</a> - Stop using URLs to search address books. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 06 Apr 2020 21:52:53 +1200</td></tr>

<tr>
 <td>changeset 29420</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9eda2be91b4ed91bf64cb4571e1d70c360146225">9eda2be91b4ed91bf64cb4571e1d70c360146225</a></td>
</tr>



<tr>
<td>parent 29419</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/69e91e0bc92ce7e94f97a3069e2949bbca3c840f">69e91e0bc92ce7e94f97a3069e2949bbca3c840f</a>
</td>
</tr>

<tr>
<td>child 29421</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a34c59e873c92c1d65c9dd3715d260698083d887">a34c59e873c92c1d65c9dd3715d260698083d887</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9eda2be91b4ed91bf64cb4571e1d70c360146225">17361</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 29 Apr 2020 01:06:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a34c59e873c9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a34c59e873c92c1d65c9dd3715d260698083d887">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a34c59e873c92c1d65c9dd3715d260698083d887&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a34c59e873c92c1d65c9dd3715d260698083d887&newProject=comm-central&newRevision=370823b8dff7d6ea7eb19587aa92c709443df5c1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a34c59e873c92c1d65c9dd3715d260698083d887&newProject=comm-central&newRevision=370823b8dff7d6ea7eb19587aa92c709443df5c1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a34c59e873c92c1d65c9dd3715d260698083d887&newProject=comm-central&newRevision=370823b8dff7d6ea7eb19587aa92c709443df5c1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1633620">1633620</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1633620">Bug 1633620</a> - Stop using URLs to search address books. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">mail/components/addrbook/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">mail/components/addrbook/content/abContactsPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">mail/components/addrbook/content/abContactsPanel.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/abContactsPanel.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">mail/components/addrbook/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">mail/components/addrbook/content/addressbook.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/content/addressbook.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">mail/components/addrbook/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">mail/components/addrbook/test/browser/browser_contact_tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_contact_tree.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">mail/components/addrbook/test/browser/browser_mailing_lists.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_mailing_lists.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">mail/components/addrbook/test/browser/browser_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/components/addrbook/test/browser/browser_search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">mail/test/browser/addrbook/browser_addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mail/test/browser/addrbook/browser_addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">mailnews/addrbook/content/abDragDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abDragDrop.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">mailnews/addrbook/content/abView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/content/abView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">mailnews/addrbook/src/AbAutoCompleteSearch.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">mailnews/addrbook/src/nsAbLDAPDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbLDAPDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">mailnews/addrbook/src/nsAbOSXDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">mailnews/addrbook/src/nsAbOSXDirectory.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/src/nsAbOSXDirectory.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">mailnews/addrbook/test/unit/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/head.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">mailnews/addrbook/test/unit/test_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/test_search.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">mailnews/addrbook/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/addrbook/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/9eda2be91b4ed91bf64cb4571e1d70c360146225/mailnews/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/addrbook/content/abCommon.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -520,17 +520,17 @@ function AbDelete() {</span>
<a href="#l1.4"></a><span id="l1.4">       let cardArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l1.5"></a><span id="l1.5">         Ci.nsIMutableArray</span>
<a href="#l1.6"></a><span id="l1.6">       );</span>
<a href="#l1.7"></a><span id="l1.7">       cardArray.appendElement(cards[i]);</span>
<a href="#l1.8"></a><span id="l1.8">       if (directory) {</span>
<a href="#l1.9"></a><span id="l1.9">         directory.deleteCards(cardArray);</span>
<a href="#l1.10"></a><span id="l1.10">       }</span>
<a href="#l1.11"></a><span id="l1.11">     }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    SetAbView(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    SetAbView();</span>
<a href="#l1.14"></a><span id="l1.14">   } else {</span>
<a href="#l1.15"></a><span id="l1.15">     // Delete cards from address books or mailing lists.</span>
<a href="#l1.16"></a><span id="l1.16">     gAbView.deleteSelectedCards();</span>
<a href="#l1.17"></a><span id="l1.17">   }</span>
<a href="#l1.18"></a><span id="l1.18"> }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> function AbNewCard() {</span>
<a href="#l1.21"></a><span id="l1.21">   goNewCardDialog(getSelectedDirectoryURI());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -219,26 +219,27 @@ function onEnterInSearchBar() {</span>
<a href="#l2.4"></a><span id="l2.4">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l2.5"></a><span id="l2.5">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l2.6"></a><span id="l2.6">     /* eslint-disable no-global-assign */</span>
<a href="#l2.7"></a><span id="l2.7">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l2.8"></a><span id="l2.8">     /* eslint-enable no-global-assign */</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   let searchURI = getSelectedDirectoryURI();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  let searchQuery;</span>
<a href="#l2.13"></a><span id="l2.13">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   // Use helper method to split up search query to multi-word search</span>
<a href="#l2.16"></a><span id="l2.16">   // query against multiple fields.</span>
<a href="#l2.17"></a><span id="l2.17">   if (searchInput) {</span>
<a href="#l2.18"></a><span id="l2.18">     let searchWords = getSearchTokens(searchInput.value);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    searchURI += generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    searchQuery = generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l2.21"></a><span id="l2.21">   }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  SetAbView(searchURI);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  SetAbView(searchURI, searchQuery);</span>
<a href="#l2.25"></a><span id="l2.25"> }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> /**</span>
<a href="#l2.28"></a><span id="l2.28">  * Open a menupopup as a context menu</span>
<a href="#l2.29"></a><span id="l2.29">  *</span>
<a href="#l2.30"></a><span id="l2.30">  * @param aContextMenuID The ID of a menupopup to be shown as context menu</span>
<a href="#l2.31"></a><span id="l2.31">  * @param aEvent         The event which triggered this.</span>
<a href="#l2.32"></a><span id="l2.32">  * @param positionArray  An optional array containing the parameters for openPopup() method;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.xhtml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,16 +25,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">   &lt;script src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">   &lt;script src=&quot;chrome://global/content/editMenuOverlay.js&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6">   &lt;script src=&quot;chrome://communicator/content/utilityOverlay.js&quot;/&gt;</span>
<a href="#l3.7"></a><span id="l3.7">   &lt;script src=&quot;chrome://messenger/content/addressbook/addressbook.js&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8">   &lt;script src=&quot;chrome://messenger/content/addressbook/abDragDrop.js&quot;/&gt;</span>
<a href="#l3.9"></a><span id="l3.9">   &lt;script src=&quot;chrome://messenger/content/addressbook/abCommon.js&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   &lt;script src=&quot;chrome://messenger/content/addressbook/abResultsPane.js&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;script src=&quot;chrome://messenger/content/addressbook/abContactsPanel.js&quot;/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  &lt;script src=&quot;chrome://messenger/content/jsTreeView.js&quot;/&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  &lt;script src=&quot;chrome://messenger/content/addressbook/abView.js&quot;/&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   &lt;commandset id=&quot;CommandUpdate_AddressBook&quot;</span>
<a href="#l3.16"></a><span id="l3.16">               commandupdater=&quot;true&quot;</span>
<a href="#l3.17"></a><span id="l3.17">               events=&quot;focus,addrbook-select&quot;</span>
<a href="#l3.18"></a><span id="l3.18">               oncommandupdate=&quot;CommandUpdate_AddressBook()&quot;&gt;</span>
<a href="#l3.19"></a><span id="l3.19">     &lt;command id=&quot;cmd_addrTo&quot; oncommand=&quot;addSelectedAddresses('addr_to')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.20"></a><span id="l3.20">     &lt;command id=&quot;cmd_addrCc&quot; oncommand=&quot;addSelectedAddresses('addr_cc')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21">     &lt;command id=&quot;cmd_addrBcc&quot; oncommand=&quot;addSelectedAddresses('addr_bcc')&quot; disabled=&quot;true&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -140,16 +140,19 @@ function OnUnloadAddressBook() {</span>
<a href="#l4.4"></a><span id="l4.4">   CloseAbView();</span>
<a href="#l4.5"></a><span id="l4.5"> }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> var gAddressBookAbViewListener = {</span>
<a href="#l4.8"></a><span id="l4.8">   onSelectionChanged() {</span>
<a href="#l4.9"></a><span id="l4.9">     ResultsPaneSelectionChanged();</span>
<a href="#l4.10"></a><span id="l4.10">   },</span>
<a href="#l4.11"></a><span id="l4.11">   onCountChanged(total) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    // For some unknown reason the tree needs this before the changes show up.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    // The view is already gAbView but setting it again works.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    gAbResultsTree.view = gAbView;</span>
<a href="#l4.15"></a><span id="l4.15">     SetStatusText(total);</span>
<a href="#l4.16"></a><span id="l4.16">     window.dispatchEvent(new CustomEvent(&quot;countchange&quot;));</span>
<a href="#l4.17"></a><span id="l4.17">   },</span>
<a href="#l4.18"></a><span id="l4.18"> };</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> function GetAbViewListener() {</span>
<a href="#l4.21"></a><span id="l4.21">   return gAddressBookAbViewListener;</span>
<a href="#l4.22"></a><span id="l4.22"> }</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -732,45 +735,46 @@ function onEnterInSearchBar() {</span>
<a href="#l4.24"></a><span id="l4.24">   ClearCardViewPane();</span>
<a href="#l4.25"></a><span id="l4.25">   if (!gQueryURIFormat) {</span>
<a href="#l4.26"></a><span id="l4.26">     // Get model query from pref. We don't want the query starting with &quot;?&quot;</span>
<a href="#l4.27"></a><span id="l4.27">     // as we have to prefix &quot;?and&quot; to this format.</span>
<a href="#l4.28"></a><span id="l4.28">     gQueryURIFormat = getModelQuery(&quot;mail.addr_book.quicksearchquery.format&quot;);</span>
<a href="#l4.29"></a><span id="l4.29">   }</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   let searchURI = getSelectedDirectoryURI();</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  let searchQuery;</span>
<a href="#l4.33"></a><span id="l4.33">   if (!searchURI) {</span>
<a href="#l4.34"></a><span id="l4.34">     return;</span>
<a href="#l4.35"></a><span id="l4.35">   }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   /*</span>
<a href="#l4.38"></a><span id="l4.38">    XXX todo, handle the case where the LDAP url</span>
<a href="#l4.39"></a><span id="l4.39">    already has a query, like</span>
<a href="#l4.40"></a><span id="l4.40">    moz-abldapdirectory://nsdirectory.netscape.com:389/ou=People,dc=netscape,dc=com?(or(Department,=,Applications))</span>
<a href="#l4.41"></a><span id="l4.41">   */</span>
<a href="#l4.42"></a><span id="l4.42">   let searchInput = document.getElementById(&quot;peopleSearchInput&quot;);</span>
<a href="#l4.43"></a><span id="l4.43">   // Use helper method to split up search query to multi-word search</span>
<a href="#l4.44"></a><span id="l4.44">   // query against multiple fields.</span>
<a href="#l4.45"></a><span id="l4.45">   if (searchInput) {</span>
<a href="#l4.46"></a><span id="l4.46">     let searchWords = getSearchTokens(searchInput.value);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    searchURI += generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    searchQuery = generateQueryURI(gQueryURIFormat, searchWords);</span>
<a href="#l4.49"></a><span id="l4.49">   }</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   if (searchURI == kAllDirectoryRoot) {</span>
<a href="#l4.52"></a><span id="l4.52">     searchURI += &quot;?&quot;;</span>
<a href="#l4.53"></a><span id="l4.53">   }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   document</span>
<a href="#l4.56"></a><span id="l4.56">     .getElementById(&quot;localResultsOnlyMessage&quot;)</span>
<a href="#l4.57"></a><span id="l4.57">     .setAttribute(</span>
<a href="#l4.58"></a><span id="l4.58">       &quot;hidden&quot;,</span>
<a href="#l4.59"></a><span id="l4.59">       !gDirectoryTreeView.hasRemoteAB || searchURI != kAllDirectoryRoot + &quot;?&quot;</span>
<a href="#l4.60"></a><span id="l4.60">     );</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  SetAbView(searchURI);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  SetAbView(searchURI, searchQuery);</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   // XXX todo</span>
<a href="#l4.66"></a><span id="l4.66">   // this works for synchronous searches of local addressbooks,</span>
<a href="#l4.67"></a><span id="l4.67">   // but not for LDAP searches</span>
<a href="#l4.68"></a><span id="l4.68">   SelectFirstCard();</span>
<a href="#l4.69"></a><span id="l4.69"> }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71"> function SwitchPaneFocus(event) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.xhtml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   &lt;linkset&gt;</span>
<a href="#l5.6"></a><span id="l5.6">     &lt;html:link rel=&quot;localization&quot; href=&quot;toolkit/global/textActions.ftl&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">   &lt;/linkset&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> &lt;script src=&quot;chrome://messenger/content/button-menu-button.js&quot;/&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> &lt;script src=&quot;chrome://messenger/content/jsTreeView.js&quot;/&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> &lt;script src=&quot;chrome://messenger/content/addressbook/abTrees.js&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;script src=&quot;chrome://messenger/content/addressbook/abView.js&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13"> &lt;script src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14"> &lt;script src=&quot;chrome://messenger/content/mailCore.js&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15"> &lt;script src=&quot;chrome://messenger/content/addressbook/addressbook.js&quot;/&gt;</span>
<a href="#l5.16"></a><span id="l5.16"> &lt;script src=&quot;chrome://messenger/content/addressbook/map-list.js&quot;/&gt;</span>
<a href="#l5.17"></a><span id="l5.17"> &lt;script src=&quot;chrome://messenger/content/addressbook/abCommon.js&quot;/&gt;</span>
<a href="#l5.18"></a><span id="l5.18"> &lt;script src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19"> &lt;script src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> &lt;script src=&quot;chrome://messenger/content/msgPrintEngine.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser.ini</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser.ini</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,13 +4,14 @@ prefs =</span>
<a href="#l6.4"></a><span id="l6.4">   mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l6.5"></a><span id="l6.5">   mail.spotlight.firstRunDone=true</span>
<a href="#l6.6"></a><span id="l6.6">   mail.winsearch.firstRunDone=true</span>
<a href="#l6.7"></a><span id="l6.7">   mailnews.start_page.override_url=about:blank</span>
<a href="#l6.8"></a><span id="l6.8">   mailnews.start_page.url=about:blank</span>
<a href="#l6.9"></a><span id="l6.9"> subsuite = thunderbird</span>
<a href="#l6.10"></a><span id="l6.10"> tags = addrbook</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+[browser_contact_tree.js]</span>
<a href="#l6.13"></a><span id="l6.13"> [browser_directory_tree.js]</span>
<a href="#l6.14"></a><span id="l6.14"> [browser_ldap_search.js]</span>
<a href="#l6.15"></a><span id="l6.15"> support-files = ../../../../../mailnews/addrbook/test/unit/data/ldap_contacts.json</span>
<a href="#l6.16"></a><span id="l6.16"> [browser_mailing_lists.js]</span>
<a href="#l6.17"></a><span id="l6.17"> [browser_search.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser_contact_tree.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,240 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+var { toXPCOMArray } = ChromeUtils.import(</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+var { mailTestUtils } = ChromeUtils.import(</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  &quot;resource://testing-common/mailnews/MailTestUtils.jsm&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+function createAddressBook(name) {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  let dirPrefId = MailServices.ab.newAddressBook(name, &quot;&quot;, 101);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  return MailServices.ab.getDirectoryFromId(dirPrefId);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+}</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+function createContact(firstName, lastName) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  let contact = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    Ci.nsIAbCard</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  );</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  contact.displayName = `${firstName} ${lastName}`;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  contact.firstName = firstName;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  contact.lastName = lastName;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  contact.primaryEmail = `${firstName}.${lastName}@invalid`;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  return contact;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+}</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+function createMailingList(name) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  let list = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;].createInstance(</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    Ci.nsIAbDirectory</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  );</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  list.isMailList = true;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  list.dirName = name;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  return list;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+}</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+var observer = {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  topics: [</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    &quot;addrbook-directory-created&quot;,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    &quot;addrbook-directory-updated&quot;,</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    &quot;addrbook-directory-deleted&quot;,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    &quot;addrbook-contact-created&quot;,</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    &quot;addrbook-contact-updated&quot;,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;,</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    &quot;addrbook-list-created&quot;,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    &quot;addrbook-list-updated&quot;,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    &quot;addrbook-list-deleted&quot;,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    &quot;addrbook-list-member-added&quot;,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    &quot;addrbook-list-member-removed&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  ],</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  setUp() {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    for (let topic of this.topics) {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+      Services.obs.addObserver(observer, topic);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    }</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  },</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  cleanUp() {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+    for (let topic of this.topics) {</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+      Services.obs.removeObserver(observer, topic);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    }</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  },</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  promiseNotification() {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+      this.notificationPromise = resolve;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    });</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  },</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  resolveNotificationPromise() {</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    if (this.notificationPromise) {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      let resolve = this.notificationPromise;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+      delete this.notificationPromise;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+      resolve();</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    }</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  },</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  notifications: [],</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+    info([topic, subject, data]);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    this.notifications.push([topic, subject, data]);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+    this.resolveNotificationPromise();</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  },</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+};</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  function openRootDirectory() {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    mailTestUtils.treeClick(EventUtils, abWindow, abDirTree, 0, 0, {});</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  function openDirectory(directory) {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    for (let i = 0; i &lt; abDirTree.view.rowCount; i++) {</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+      abDirTree.changeOpenState(i, true);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    let row = abWindow.gDirectoryTreeView.getIndexForId(directory.URI);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    mailTestUtils.treeClick(EventUtils, abWindow, abDirTree, row, 0, {});</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  }</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  function deleteRowWithPrompt(row) {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    let promptPromise = BrowserTestUtils.promiseAlertDialogOpen(&quot;accept&quot;);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    mailTestUtils.treeClick(EventUtils, abWindow, abContactTree, row, 0, {});</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    EventUtils.synthesizeKey(&quot;VK_DELETE&quot;, {}, abWindow);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+    return promptPromise;</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  }</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  function checkRows(...expectedCards) {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    abContactTree.view.QueryInterface(Ci.nsIAbView);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+    Assert.equal(</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+      abContactTree.view.rowCount,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      expectedCards.length,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      &quot;rowCount correct&quot;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    );</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+    for (let i = 0; i &lt; expectedCards.length; i++) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      if (expectedCards[i].isMailList) {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+        Assert.equal(</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+          abContactTree.view.getCardFromRow(i).displayName,</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+          expectedCards[i].dirName</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+        );</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+      } else {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+        Assert.equal(</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+          abContactTree.view.getCardFromRow(i).displayName,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+          expectedCards[i].displayName</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+        );</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      }</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    }</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  }</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  let bookA = createAddressBook(&quot;book A&quot;);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  let contactA1 = bookA.addCard(createContact(&quot;contact&quot;, &quot;A1&quot;));</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  let bookB = createAddressBook(&quot;book B&quot;);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  let contactB1 = bookB.addCard(createContact(&quot;contact&quot;, &quot;B1&quot;));</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  let abWindow = await openAddressBookWindow();</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  let abDirTree = abWindow.GetDirTree();</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  let abContactTree = abWindow.document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  observer.setUp();</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  checkRows(contactA1, contactB1);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  // While in bookA, add a contact and list. Check that they show up.</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  checkRows(contactA1);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  let contactA2 = bookA.addCard(createContact(&quot;contact&quot;, &quot;A2&quot;)); // Add A2.</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  checkRows(contactA1, contactA2);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  let listC = bookA.addMailList(createMailingList(&quot;list C&quot;)); // Add C.</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  // Adding a mailing list changes the view. Go back to where we were.</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  checkRows(contactA1, contactA2, listC);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  listC.addCard(contactA1);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  checkRows(contactA1, contactA2, listC);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  checkRows(contactA1, contactA2, contactB1, listC);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  // While in listC, add a member and remove a member. Check that they show up</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  // or disappear as appropriate.</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  openDirectory(listC);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  checkRows(contactA1);</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  listC.addCard(contactA2);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  checkRows(contactA1, contactA2);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+  await deleteRowWithPrompt(0);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  checkRows(contactA1, contactA2, contactB1, listC);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  // While in bookA, delete a contact. Check it disappears.</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  checkRows(contactA1, contactA2, listC);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  await deleteRowWithPrompt(0); // Delete A1.</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  // Now do some things in an unrelated book. Check nothing changes here.</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  let contactB2 = bookB.addCard(createContact(&quot;contact&quot;, &quot;B2&quot;)); // Add B2.</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  let listD = bookB.addMailList(createMailingList(&quot;list D&quot;)); // Add D.</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+  // Adding a mailing list changes the view. Go back to where we were.</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  listD.addCard(contactB1);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  checkRows(contactA2, contactB1, contactB2, listC, listD);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  // While in listC, do some things in an unrelated list. Check nothing</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  // changes here.</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  openDirectory(listC);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  listD.addCard(contactB2);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+  listD.deleteCards(toXPCOMArray([contactB1], Ci.nsIMutableArray));</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  bookB.deleteCards(toXPCOMArray([contactB1], Ci.nsIMutableArray));</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  checkRows(contactA2, contactB2, listC, listD);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+  // While in bookA, do some things in an unrelated book. Check nothing</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  // changes here.</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  bookB.deleteDirectory(listD); // Delete D.</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+  // Removing a mailing list changes the view. Go back to where we were.</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  openDirectory(bookA);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+  checkRows(contactA2, listC);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+  await deleteRowWithPrompt(1); // Delete C.</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+  // While in &quot;All Address Books&quot;, make some changes and check that things</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  // appear or disappear as appropriate.</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  checkRows(contactA2, contactB2);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  let listE = bookB.addMailList(createMailingList(&quot;list E&quot;)); // Add E.</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  // Adding a mailing list changes the view. Go back to where we were.</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  checkRows(contactA2, contactB2, listE);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  listE.addCard(contactB2);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+  checkRows(contactA2, contactB2, listE);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  listE.deleteCards(toXPCOMArray([contactB2], Ci.nsIMutableArray));</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  checkRows(contactA2, contactB2, listE);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  bookB.deleteDirectory(listE); // Delete E.</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  // Removing a mailing list changes the view. Go back to where we were.</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  openRootDirectory();</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+  checkRows(contactA2, contactB2);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+  await deleteRowWithPrompt(1);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  checkRows(contactA2);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+  bookA.deleteCards(toXPCOMArray([contactA2], Ci.nsIMutableArray));</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  checkRows();</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+  abWindow.close();</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+  let deletePromise = observer.promiseNotification();</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+  MailServices.ab.deleteAddressBook(bookA.URI);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  await deletePromise;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  deletePromise = observer.promiseNotification();</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  MailServices.ab.deleteAddressBook(bookB.URI);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  await deletePromise;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  observer.cleanUp();</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser_mailing_lists.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser_mailing_lists.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -280,19 +280,22 @@ add_task(async () =&gt; {</span>
<a href="#l8.4"></a><span id="l8.4">   );</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   is(</span>
<a href="#l8.7"></a><span id="l8.7">     global.dirTree.view.getCellText(2, global.dirTree.columns[0]),</span>
<a href="#l8.8"></a><span id="l8.8">     inputs.abName,</span>
<a href="#l8.9"></a><span id="l8.9">     `address book (&quot;${inputs.abName}&quot;) is displayed in the address book list`</span>
<a href="#l8.10"></a><span id="l8.10">   );</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  // Expand the tree to reveal the mailing list.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  global.dirTreeClick(2, 1);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  EventUtils.sendKey(&quot;RETURN&quot;, global.abWindow);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  // Expand the tree to reveal the mailing list. It might already be expanded</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  // if earlier tests ran (which is a bug), so check first.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  if (global.dirTree.view.rowCount == 4) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    global.dirTreeClick(2, 1);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    EventUtils.sendKey(&quot;RETURN&quot;, global.abWindow);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   is(</span>
<a href="#l8.23"></a><span id="l8.23">     global.dirTree.view.getCellText(3, global.dirTree.columns[0]),</span>
<a href="#l8.24"></a><span id="l8.24">     inputs.mlName,</span>
<a href="#l8.25"></a><span id="l8.25">     `mailing list (&quot;${inputs.mlName}&quot;) is displayed in the address book list`</span>
<a href="#l8.26"></a><span id="l8.26">   );</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   // Open the mailing list dialog, the callback above interacts with it.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser_search.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser_search.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -30,17 +30,18 @@ add_task(async () =&gt; {</span>
<a href="#l9.4"></a><span id="l9.4">       }</span>
<a href="#l9.5"></a><span id="l9.5">     });</span>
<a href="#l9.6"></a><span id="l9.6">   }</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">   function checkRows(...expectedCards) {</span>
<a href="#l9.9"></a><span id="l9.9">     is(resultsTree.view.rowCount, expectedCards.length, &quot;rowCount correct&quot;);</span>
<a href="#l9.10"></a><span id="l9.10">     for (let i = 0; i &lt; expectedCards.length; i++) {</span>
<a href="#l9.11"></a><span id="l9.11">       is(</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        resultsTree.view.getCardFromRow(i).displayName,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+        resultsTree.view.QueryInterface(Ci.nsIAbView).getCardFromRow(i)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+          .displayName,</span>
<a href="#l9.15"></a><span id="l9.15">         expectedCards[i].displayName,</span>
<a href="#l9.16"></a><span id="l9.16">         `row ${i} has the right contact`</span>
<a href="#l9.17"></a><span id="l9.17">       );</span>
<a href="#l9.18"></a><span id="l9.18">     }</span>
<a href="#l9.19"></a><span id="l9.19">   }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   let personalBook = MailServices.ab.getDirectoryFromId(&quot;ldap_2.servers.pab&quot;);</span>
<a href="#l9.22"></a><span id="l9.22">   let historyBook = MailServices.ab.getDirectoryFromId(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/browser/addrbook/browser_addressBook.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/browser/addrbook/browser_addressBook.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -258,16 +258,17 @@ add_task(function test_deleting_contacts</span>
<a href="#l10.4"></a><span id="l10.4">   );</span>
<a href="#l10.5"></a><span id="l10.5">   confirmMultiple = confirmMultiple.replace(/.*;/, &quot;&quot;).replace(&quot;#1&quot;, &quot;3&quot;);</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">   // Add some contacts to the address book</span>
<a href="#l10.8"></a><span id="l10.8">   load_contacts_into_address_book(addrBook1, toDelete);</span>
<a href="#l10.9"></a><span id="l10.9">   select_address_book(addrBook1);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   let totalEntries = abController.window.gAbView.rowCount;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  Assert.equal(totalEntries, 4);</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14">   // Set the mock prompt to return false, so that the</span>
<a href="#l10.15"></a><span id="l10.15">   // contact should not be deleted.</span>
<a href="#l10.16"></a><span id="l10.16">   gMockPromptService.returnValue = false;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   // Now attempt to delete the contact</span>
<a href="#l10.19"></a><span id="l10.19">   select_contacts(toDelete);</span>
<a href="#l10.20"></a><span id="l10.20">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -342,17 +342,17 @@ var abDirTreeObserver = {</span>
<a href="#l11.4"></a><span id="l11.4">     } else {</span>
<a href="#l11.5"></a><span id="l11.5">       cardsTransferredText = PluralForm.get(</span>
<a href="#l11.6"></a><span id="l11.6">         numrows,</span>
<a href="#l11.7"></a><span id="l11.7">         gAddressBookBundle.getFormattedString(&quot;contactsCopied&quot;, [numrows])</span>
<a href="#l11.8"></a><span id="l11.8">       );</span>
<a href="#l11.9"></a><span id="l11.9">     }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">     if (srcURI == kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      SetAbView(srcURI);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      SetAbView();</span>
<a href="#l11.14"></a><span id="l11.14">     }</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">     document.getElementById(&quot;statusText&quot;).label = cardsTransferredText;</span>
<a href="#l11.17"></a><span id="l11.17">   },</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   onToggleOpenState() {},</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">   onCycleHeader(colID, elt) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l12.6"></a><span id="l12.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> /* import-globals-from ../../../mail/components/addrbook/content/abCommon.js */</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+/* import-globals-from abView.js */</span>
<a href="#l12.12"></a><span id="l12.12"> /* globals GetAbViewListener */</span>
<a href="#l12.13"></a><span id="l12.13"> // gCurFrame is SeaMonkey-only */</span>
<a href="#l12.14"></a><span id="l12.14"> /* globals gCurFrame */</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> /**</span>
<a href="#l12.17"></a><span id="l12.17">  * Use of items in this file require:</span>
<a href="#l12.18"></a><span id="l12.18">  *</span>
<a href="#l12.19"></a><span id="l12.19">  * getSelectedDirectoryURI()</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineat">@@ -36,17 +37,17 @@ var kCardsOnly = 4;</span>
<a href="#l12.21"></a><span id="l12.21"> // Global Variables</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> // gAbView holds an object with an nsIAbView interface</span>
<a href="#l12.24"></a><span id="l12.24"> var gAbView = null;</span>
<a href="#l12.25"></a><span id="l12.25"> // Holds a reference to the &quot;abResultsTree&quot; document element. Initially</span>
<a href="#l12.26"></a><span id="l12.26"> // set up by SetAbView.</span>
<a href="#l12.27"></a><span id="l12.27"> var gAbResultsTree = null;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-function SetAbView(aURI) {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+function SetAbView(aURI, aSearchQuery) {</span>
<a href="#l12.31"></a><span id="l12.31">   // If we don't have a URI, just clear the view and leave everything else</span>
<a href="#l12.32"></a><span id="l12.32">   // alone.</span>
<a href="#l12.33"></a><span id="l12.33">   if (!aURI) {</span>
<a href="#l12.34"></a><span id="l12.34">     if (gAbView) {</span>
<a href="#l12.35"></a><span id="l12.35">       gAbView.clearView();</span>
<a href="#l12.36"></a><span id="l12.36">     }</span>
<a href="#l12.37"></a><span id="l12.37">     return;</span>
<a href="#l12.38"></a><span id="l12.38">   }</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineat">@@ -70,55 +71,35 @@ function SetAbView(aURI) {</span>
<a href="#l12.40"></a><span id="l12.40">       sortColumn = gAbResultsTree.getAttribute(&quot;sortCol&quot;);</span>
<a href="#l12.41"></a><span id="l12.41">     }</span>
<a href="#l12.42"></a><span id="l12.42">     var sortColumnNode = document.getElementById(sortColumn);</span>
<a href="#l12.43"></a><span id="l12.43">     if (sortColumnNode &amp;&amp; sortColumnNode.hasAttribute(&quot;sortDirection&quot;)) {</span>
<a href="#l12.44"></a><span id="l12.44">       sortDirection = sortColumnNode.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l12.45"></a><span id="l12.45">     }</span>
<a href="#l12.46"></a><span id="l12.46">   }</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  var directory = GetDirectoryFromURI(aURI);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  if (!directory &amp;&amp; aURI.startsWith(&quot;moz-abdirectory://?&quot;)) {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-    // This is an obsolete reference to the root directory, which isn't a thing</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-    // any more. Fortunately all we need is a way to get the URI to gAbView, so</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    // we can pretend we have a real directory.</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    directory = {</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsIAbDirectory]),</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      get URI() {</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-        return aURI;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-      },</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-    };</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  }</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  if (!gAbView) {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-    gAbView = Cc[&quot;@mozilla.org/addressbook/abview;1&quot;].createInstance(</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-      Ci.nsIAbView</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    );</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  }</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  var actualSortColumn = gAbView.setView(</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    directory,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  gAbView = gAbResultsTree.view = new ABView(</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    GetDirectoryFromURI(aURI),</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    aSearchQuery,</span>
<a href="#l12.72"></a><span id="l12.72">     GetAbViewListener(),</span>
<a href="#l12.73"></a><span id="l12.73">     sortColumn,</span>
<a href="#l12.74"></a><span id="l12.74">     sortDirection</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  );</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  gAbResultsTree.view = gAbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  ).QueryInterface(Ci.nsITreeView);</span>
<a href="#l12.79"></a><span id="l12.79">   window.dispatchEvent(new CustomEvent(&quot;viewchange&quot;));</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-  UpdateSortIndicators(actualSortColumn, sortDirection);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  UpdateSortIndicators(sortColumn, sortDirection);</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84">   // If the selected address book is LDAP and the search box is empty,</span>
<a href="#l12.85"></a><span id="l12.85">   // inform the user of the empty results pane.</span>
<a href="#l12.86"></a><span id="l12.86">   let abResultsTree = document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l12.87"></a><span id="l12.87">   let cardViewOuterBox = document.getElementById(&quot;CardViewOuterBox&quot;);</span>
<a href="#l12.88"></a><span id="l12.88">   let blankResultsPaneMessageBox = document.getElementById(</span>
<a href="#l12.89"></a><span id="l12.89">     &quot;blankResultsPaneMessageBox&quot;</span>
<a href="#l12.90"></a><span id="l12.90">   );</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  if (aURI.startsWith(&quot;moz-abldapdirectory://&quot;) &amp;&amp; !aURI.includes(&quot;?&quot;)) {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  if (aURI.startsWith(&quot;moz-abldapdirectory://&quot;) &amp;&amp; !aSearchQuery) {</span>
<a href="#l12.93"></a><span id="l12.93">     if (abResultsTree) {</span>
<a href="#l12.94"></a><span id="l12.94">       abResultsTree.hidden = true;</span>
<a href="#l12.95"></a><span id="l12.95">     }</span>
<a href="#l12.96"></a><span id="l12.96">     if (cardViewOuterBox) {</span>
<a href="#l12.97"></a><span id="l12.97">       cardViewOuterBox.hidden = true;</span>
<a href="#l12.98"></a><span id="l12.98">     }</span>
<a href="#l12.99"></a><span id="l12.99">     if (blankResultsPaneMessageBox) {</span>
<a href="#l12.100"></a><span id="l12.100">       blankResultsPaneMessageBox.hidden = false;</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineat">@@ -132,19 +113,17 @@ function SetAbView(aURI) {</span>
<a href="#l12.102"></a><span id="l12.102">     }</span>
<a href="#l12.103"></a><span id="l12.103">     if (blankResultsPaneMessageBox) {</span>
<a href="#l12.104"></a><span id="l12.104">       blankResultsPaneMessageBox.hidden = true;</span>
<a href="#l12.105"></a><span id="l12.105">     }</span>
<a href="#l12.106"></a><span id="l12.106">   }</span>
<a href="#l12.107"></a><span id="l12.107"> }</span>
<a href="#l12.108"></a><span id="l12.108"> </span>
<a href="#l12.109"></a><span id="l12.109"> function CloseAbView() {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  if (gAbView) {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    gAbView.clearView();</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  }</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  gAbView = gAbResultsTree.view = null;</span>
<a href="#l12.114"></a><span id="l12.114"> }</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116"> function GetOneOrMoreCardsSelected() {</span>
<a href="#l12.117"></a><span id="l12.117">   return gAbView &amp;&amp; gAbView.selection.getRangeCount() &gt; 0;</span>
<a href="#l12.118"></a><span id="l12.118"> }</span>
<a href="#l12.119"></a><span id="l12.119"> </span>
<a href="#l12.120"></a><span id="l12.120"> function GetSelectedAddresses() {</span>
<a href="#l12.121"></a><span id="l12.121">   return GetAddressesForCards(GetSelectedAbCards());</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineat">@@ -237,17 +216,17 @@ function GetSelectedAbCards() {</span>
<a href="#l12.123"></a><span id="l12.123">       gCurFrame.getAttribute(&quot;src&quot;) == abPanelUrl &amp;&amp;</span>
<a href="#l12.124"></a><span id="l12.124">       document.commandDispatcher.focusedWindow ==</span>
<a href="#l12.125"></a><span id="l12.125">         gCurFrame.contentDocument.defaultView</span>
<a href="#l12.126"></a><span id="l12.126">     ) {</span>
<a href="#l12.127"></a><span id="l12.127">       abView = gCurFrame.contentDocument.defaultView.gAbView;</span>
<a href="#l12.128"></a><span id="l12.128">     }</span>
<a href="#l12.129"></a><span id="l12.129">   }</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-  if (!abView) {</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+  if (!abView || !abView.selection) {</span>
<a href="#l12.133"></a><span id="l12.133">     return [];</span>
<a href="#l12.134"></a><span id="l12.134">   }</span>
<a href="#l12.135"></a><span id="l12.135"> </span>
<a href="#l12.136"></a><span id="l12.136">   let cards = [];</span>
<a href="#l12.137"></a><span id="l12.137">   var count = abView.selection.getRangeCount();</span>
<a href="#l12.138"></a><span id="l12.138">   for (let i = 0; i &lt; count; ++i) {</span>
<a href="#l12.139"></a><span id="l12.139">     let start = {};</span>
<a href="#l12.140"></a><span id="l12.140">     let end = {};</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineat">@@ -382,16 +361,21 @@ function UpdateSortIndicators(colID, sor</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143">   // remove the sort indicator from all the columns</span>
<a href="#l12.144"></a><span id="l12.144">   // except the one we are sorted by</span>
<a href="#l12.145"></a><span id="l12.145">   var currCol = gAbResultsTree.firstElementChild.firstElementChild;</span>
<a href="#l12.146"></a><span id="l12.146">   while (currCol) {</span>
<a href="#l12.147"></a><span id="l12.147">     if (currCol != sortedColumn &amp;&amp; currCol.localName == &quot;treecol&quot;) {</span>
<a href="#l12.148"></a><span id="l12.148">       currCol.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l12.149"></a><span id="l12.149">     }</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+    // Change the column header's border colour to force it to redraw.</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    // Otherwise redrawing doesn't happen until something else causes it to.</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+    currCol.style.borderColor = currCol.style.borderColor</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+      ? null</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+      : &quot;transparent&quot;;</span>
<a href="#l12.155"></a><span id="l12.155">     currCol = currCol.nextElementSibling;</span>
<a href="#l12.156"></a><span id="l12.156">   }</span>
<a href="#l12.157"></a><span id="l12.157"> }</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159"> function InvalidateResultsPane() {</span>
<a href="#l12.160"></a><span id="l12.160">   if (gAbResultsTree) {</span>
<a href="#l12.161"></a><span id="l12.161">     gAbResultsTree.invalidate();</span>
<a href="#l12.162"></a><span id="l12.162">   }</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineat">@@ -421,16 +405,18 @@ var ResultsPaneController = {</span>
<a href="#l12.164"></a><span id="l12.164">         return true;</span>
<a href="#l12.165"></a><span id="l12.165">       case &quot;cmd_delete&quot;:</span>
<a href="#l12.166"></a><span id="l12.166">       case &quot;button_delete&quot;: {</span>
<a href="#l12.167"></a><span id="l12.167">         let numSelected;</span>
<a href="#l12.168"></a><span id="l12.168">         let enabled = false;</span>
<a href="#l12.169"></a><span id="l12.169">         if (gAbView &amp;&amp; gAbView.selection) {</span>
<a href="#l12.170"></a><span id="l12.170">           if (gAbView.directory) {</span>
<a href="#l12.171"></a><span id="l12.171">             enabled = !gAbView.directory.readOnly;</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+          } else {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+            enabled = true;</span>
<a href="#l12.174"></a><span id="l12.174">           }</span>
<a href="#l12.175"></a><span id="l12.175">           numSelected = gAbView.selection.count;</span>
<a href="#l12.176"></a><span id="l12.176">         } else {</span>
<a href="#l12.177"></a><span id="l12.177">           numSelected = 0;</span>
<a href="#l12.178"></a><span id="l12.178">         }</span>
<a href="#l12.179"></a><span id="l12.179">         enabled = enabled &amp;&amp; numSelected &gt; 0;</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181">         let labelAttr = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/addrbook/content/abView.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,234 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+/* globals MailServices, PROTO_TREE_VIEW, Services */</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+var { toXPCOMArray } = ChromeUtils.import(</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+function ABView(directory, searchQuery, listener, sortColumn, sortDirection) {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+  this.__proto__.__proto__ = new PROTO_TREE_VIEW();</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+  this.directory = directory;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  this.listener = listener;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  let directories = directory ? [directory] : MailServices.ab.directories;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  if (searchQuery) {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+    searchQuery = searchQuery.replace(/^\?+/, &quot;&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    for (let dir of directories) {</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+      dir.search(searchQuery, this);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+    }</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  } else {</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+    for (let dir of directories) {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      for (let card of dir.childCards) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+        this._rowMap.push(new abViewCard(card));</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+      }</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+    }</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    if (this.listener) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      this.listener.onCountChanged(this.rowCount);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    }</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  }</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  this.sortBy(sortColumn, sortDirection);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+}</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ABView.prototype = {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    Ci.nsITreeView,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+    Ci.nsIAbView,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    Ci.nsIAbDirSearchListener,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+    Ci.nsIObserver,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    Ci.nsISupportsWeakReference,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  ]),</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  _notifications: [</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    &quot;addrbook-contact-created&quot;,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    &quot;addrbook-list-member-added&quot;,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    &quot;addrbook-list-member-removed&quot;,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  ],</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  // nsITreeView</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  selectionChanged() {</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    if (this.listener) {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      this.listener.onSelectionChanged();</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+    }</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+  },</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  setTree(tree) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    this.tree = tree;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    for (let topic of this._notifications) {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      if (tree) {</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+        Services.obs.addObserver(this, topic, true);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+      } else {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+        Services.obs.removeObserver(this, topic);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+      }</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  },</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  // nsIAbView</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  deleteSelectedCards() {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    let directoryMap = new Map();</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+    for (let i = 0; i &lt; this.selection.getRangeCount(); i++) {</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      let start = {},</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+        finish = {};</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+      this.selection.getRangeAt(i, start, finish);</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+      for (let j = start.value; j &lt;= finish.value; j++) {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+        let card = this.getCardFromRow(j);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+        let directoryId = card.directoryId.split(&quot;&amp;&quot;)[0];</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+        let cardSet = directoryMap.get(directoryId);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+        if (!cardSet) {</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+          cardSet = new Set();</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+          directoryMap.set(directoryId, cardSet);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+        }</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+        cardSet.add(card);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+      }</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+    }</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    for (let [directoryId, cardSet] of directoryMap) {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+      let directory;</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+      if (this.directory &amp;&amp; this.directory.isMailList) {</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+        // Removes cards from the list instead of deleting them.</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+        directory = this.directory;</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+      } else {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+        directory = MailServices.ab.getDirectoryFromId(directoryId);</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+      }</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+      cardSet = [...cardSet];</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+      directory.deleteCards(</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+        toXPCOMArray(</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+          cardSet.filter(card =&gt; !card.isMailList),</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+          Ci.nsIMutableArray</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+        )</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+      );</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+      for (let card of cardSet.filter(card =&gt; card.isMailList)) {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+        MailServices.ab.deleteAddressBook(card.mailListURI);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+      }</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    }</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  },</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  getCardFromRow(row) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+    return this._rowMap[row] ? this._rowMap[row].card : null;</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+  },</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  sortColumn: &quot;&quot;,</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  sortDirection: &quot;&quot;,</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  sortBy(sortColumn, sortDirection, resort) {</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    if (sortColumn == this.sortColumn &amp;&amp; !resort) {</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      if (sortDirection == this.sortDirection) {</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+        return;</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+      }</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+      this._rowMap.reverse();</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    } else {</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+      this._rowMap.sort((a, b) =&gt; {</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+        let aText = a.getText(sortColumn);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+        let bText = b.getText(sortColumn);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+        if (aText == bText) {</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+          return 0;</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+        }</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+        return aText &lt; bText ? -1 : 1;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+      });</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    }</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+    if (this.tree) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+      this.tree.invalidate();</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+    }</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+    this.sortColumn = sortColumn;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+    this.sortDirection = sortDirection;</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  },</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  // nsIAbDirSearchListener</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+  onSearchFoundCard(card) {</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    this._rowMap.push(new abViewCard(card));</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  },</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+  onSearchFinished(result, errorMsg) {</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+    this.sortBy(this.sortColumn, this.sortDirection, true);</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    if (this.listener) {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+      this.listener.onCountChanged(this.rowCount);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+    }</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+  },</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  // nsIObserver</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    if (this.directory &amp;&amp; this.directory.UID != data) {</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+      // How did we get here?</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+      return;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+    }</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+    switch (topic) {</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+      case &quot;addrbook-list-member-added&quot;:</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+        if (!this.directory) {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+          break;</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+        }</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+      // Falls through.</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+      case &quot;addrbook-contact-created&quot;:</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+        this._rowMap.push(new abViewCard(subject));</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+        if (this.listener) {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+          this.listener.onCountChanged(this.rowCount);</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+        }</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+        break;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+      case &quot;addrbook-list-member-removed&quot;:</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+        if (!this.directory) {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+          break;</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+        }</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+      // Falls through.</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+      case &quot;addrbook-contact-deleted&quot;:</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+        for (let i = this._rowMap.length - 1; i &gt;= 0; i--) {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+          if (this._rowMap[i].card.equals(subject)) {</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+            this._rowMap.splice(i, 1);</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+          }</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+        }</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+        if (this.listener) {</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+          this.listener.onCountChanged(this.rowCount);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+        }</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+        break;</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+    }</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  },</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+};</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+function abViewCard(card) {</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  this.card = card;</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+}</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+abViewCard.prototype = {</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+  getText(columnID) {</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+    try {</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+      switch (columnID) {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+        case &quot;addrbook&quot;: {</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+          let { directoryId } = this.card;</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+          return directoryId.substring(directoryId.indexOf(&quot;&amp;&quot;) + 1);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+        }</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        case &quot;GeneratedName&quot;:</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+          return this.card.generateName(</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+            Services.prefs.getIntPref(&quot;mail.addr_book.lastnamefirst&quot;, 0)</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+          );</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+        case &quot;_PhoneticName&quot;:</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+          return this.card.generatePhoneticName(true);</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+        case &quot;ChatName&quot;:</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+          return this.card.isMailList ? &quot;&quot; : this.card.generateChatName();</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+        default:</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+          return this.card.isMailList</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+            ? &quot;&quot;</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+            : this.card.getPropertyAsAString(columnID);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+      }</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+    } catch (ex) {</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    }</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+  },</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+  get id() {</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+    return this.card.UID;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+  },</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+  get open() {</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+    return false;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+  },</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+  get level() {</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+    return 0;</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+  },</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+  get children() {</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+    return [];</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+  },</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+  getProperties() {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    return this.card.isMailList ? &quot;MailList&quot; : &quot;&quot;;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+  },</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -691,16 +691,149 @@ AddrBookDirectoryInner.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">   },</span>
<a href="#l14.5"></a><span id="l14.5">   get isQuery() {</span>
<a href="#l14.6"></a><span id="l14.6">     return !!this._query;</span>
<a href="#l14.7"></a><span id="l14.7">   },</span>
<a href="#l14.8"></a><span id="l14.8">   get supportsMailingLists() {</span>
<a href="#l14.9"></a><span id="l14.9">     return true;</span>
<a href="#l14.10"></a><span id="l14.10">   },</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  search(query, listener) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    if (!listener) {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      return;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    }</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    if (!query) {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+      listener.onSearchFinished(</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+        Ci.nsIAbDirectoryQueryResultListener.queryResultStopped,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+        &quot;No query specified.&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+      );</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+      return;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+    }</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+    if (query[0] == &quot;?&quot;) {</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+      query = query.substring(1);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    }</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+    let results = Array.from(</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+      this._lists.values(),</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+      list =&gt;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+        new AddrBookMailingList(</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+          list.uid,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+          this,</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+          list.localId,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+          list.name,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+          list.nickName,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+          list.description</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+        ).asCard</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    ).concat(Array.from(this._cards.values(), card =&gt; this._getCard(card)));</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    // Process the query string into a tree of conditions to match.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    let lispRegexp = /^\((and|or|not|([^\)]*)(\)+))/;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+    let index = 0;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    let rootQuery = { children: [], op: &quot;or&quot; };</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    let currentQuery = rootQuery;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    while (true) {</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+      let match = lispRegexp.exec(query.substring(index));</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+      if (!match) {</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+        break;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      }</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      index += match[0].length;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+      if ([&quot;and&quot;, &quot;or&quot;, &quot;not&quot;].includes(match[1])) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+        // For the opening bracket, step down a level.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+        let child = {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+          parent: currentQuery,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+          children: [],</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+          op: match[1],</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+        };</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+        currentQuery.children.push(child);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+        currentQuery = child;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+      } else {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        currentQuery.children.push(match[2]);</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        // For each closing bracket except the first, step up a level.</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+        for (let i = match[3].length - 1; i &gt; 0; i--) {</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+          currentQuery = currentQuery.parent;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+        }</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+      }</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    }</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    results = results.filter(card =&gt; {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+      let properties;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+      if (card.isMailList) {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+        properties = new Map([</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+          [&quot;DisplayName&quot;, card.displayName],</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+          [&quot;NickName&quot;, card.getProperty(&quot;NickName&quot;)],</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+          [&quot;Notes&quot;, card.getProperty(&quot;Notes&quot;)],</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+        ]);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+      } else {</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+        properties = this._loadCardProperties(card.UID);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+      }</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+      let matches = b =&gt; {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+        if (typeof b == &quot;string&quot;) {</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+          let [name, condition, value] = b.split(&quot;,&quot;);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+          if (name == &quot;IsMailList&quot; &amp;&amp; condition == &quot;=&quot;) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+            return card.isMailList == (value == &quot;TRUE&quot;);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+          }</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+          if (!properties.has(name)) {</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+            return condition == &quot;!ex&quot;;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+          }</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+          if (condition == &quot;ex&quot;) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+            return true;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+          }</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+          value = decodeURIComponent(value).toLowerCase();</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+          let cardValue = properties.get(name).toLowerCase();</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+          switch (condition) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+            case &quot;=&quot;:</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+              return cardValue == value;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+            case &quot;!=&quot;:</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+              return cardValue != value;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+            case &quot;lt&quot;:</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+              return cardValue &lt; value;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+            case &quot;gt&quot;:</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+              return cardValue &gt; value;</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+            case &quot;bw&quot;:</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+              return cardValue.startsWith(value);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+            case &quot;ew&quot;:</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+              return cardValue.endsWith(value);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+            case &quot;c&quot;:</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+              return cardValue.includes(value);</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+            case &quot;!c&quot;:</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+              return !cardValue.includes(value);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+            case &quot;~=&quot;:</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+            case &quot;regex&quot;:</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+            default:</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+              return false;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+          }</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+        }</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+        if (b.op == &quot;or&quot;) {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+          return b.children.some(bb =&gt; matches(bb));</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+        }</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+        if (b.op == &quot;and&quot;) {</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+          return b.children.every(bb =&gt; matches(bb));</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+        }</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+        if (b.op == &quot;not&quot;) {</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+          return !matches(b.children[0]);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+        }</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+        return false;</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+      };</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+      return matches(rootQuery);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    }, this);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+    for (let card of results) {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+      listener.onSearchFoundCard(card);</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+    }</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    listener.onSearchFinished(</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+      Ci.nsIAbDirectoryQueryResultListener.queryResultComplete,</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+      &quot;&quot;</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    );</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  },</span>
<a href="#l14.145"></a><span id="l14.145">   generateName(generateFormat, bundle) {</span>
<a href="#l14.146"></a><span id="l14.146">     return this.dirName;</span>
<a href="#l14.147"></a><span id="l14.147">   },</span>
<a href="#l14.148"></a><span id="l14.148">   cardForEmailAddress(emailAddress) {</span>
<a href="#l14.149"></a><span id="l14.149">     return (</span>
<a href="#l14.150"></a><span id="l14.150">       this.getCardFromProperty(&quot;PrimaryEmail&quot;, emailAddress, false) ||</span>
<a href="#l14.151"></a><span id="l14.151">       this.getCardFromProperty(&quot;SecondEmail&quot;, emailAddress, false)</span>
<a href="#l14.152"></a><span id="l14.152">     );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> interface nsIAbCard;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+interface nsIAbDirSearchListener;</span>
<a href="#l15.13"></a><span id="l15.13"> interface nsIArray;</span>
<a href="#l15.14"></a><span id="l15.14"> interface nsIMutableArray;</span>
<a href="#l15.15"></a><span id="l15.15"> interface nsISimpleEnumerator;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> /* moz-abdirectory:// is the URI to access nsAbBSDirectory,</span>
<a href="#l15.18"></a><span id="l15.18">  * which is the root directory for all types of address books</span>
<a href="#l15.19"></a><span id="l15.19">  * this is used to get all address book directories. */</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -189,16 +190,33 @@ interface nsIAbDirectory : nsISupports {</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23">   /**</span>
<a href="#l15.24"></a><span id="l15.24">    * Get the cards associated with the directory. This will return the cards</span>
<a href="#l15.25"></a><span id="l15.25">    * associated with the mailing lists too.</span>
<a href="#l15.26"></a><span id="l15.26">    */</span>
<a href="#l15.27"></a><span id="l15.27">   readonly attribute nsISimpleEnumerator childCards;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   /**</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+   * Searches the directory for cards matching query.</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+   *</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+   * The query takes the form:</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+   * (BOOL1(FIELD1,OP1,VALUE1)..(FIELDn,OPn,VALUEn)(BOOL2(FIELD1,OP1,VALUE1)...)...)</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+   *</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+   * BOOLn   A boolean operator joining subsequent terms delimited by ().</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+   *         For possible values see CreateBooleanExpression().</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+   * FIELDn  An addressbook card data field.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+   * OPn     An operator for the search term.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+   *         For possible values see CreateBooleanConditionString().</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+   * VALUEn  The value to be matched in the FIELDn via the OPn operator.</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+   *         The value must be URL encoded by the caller, if it contains any</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+   *         special characters including '(' and ')'.</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+   */</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  void search(in AString query, in nsIAbDirSearchListener listener);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  /**</span>
<a href="#l15.47"></a><span id="l15.47">    * Returns true if this directory represents a query - i.e. the rdf resource</span>
<a href="#l15.48"></a><span id="l15.48">    * was something like moz-abmdbdirectory://abook.mab?....</span>
<a href="#l15.49"></a><span id="l15.49">    */</span>
<a href="#l15.50"></a><span id="l15.50">   readonly attribute boolean isQuery;</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">   /**</span>
<a href="#l15.53"></a><span id="l15.53">    * Initializes a directory, pointing to a particular</span>
<a href="#l15.54"></a><span id="l15.54">    * URI</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/AbAutoCompleteSearch.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/AbAutoCompleteSearch.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -193,63 +193,58 @@ AbAutoCompleteSearch.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4">    * a mailing list) then the function will add a result for each email address</span>
<a href="#l16.5"></a><span id="l16.5">    * that exists.</span>
<a href="#l16.6"></a><span id="l16.6">    *</span>
<a href="#l16.7"></a><span id="l16.7">    * @param searchQuery  The boolean search query to use.</span>
<a href="#l16.8"></a><span id="l16.8">    * @param directory    An nsIAbDirectory to search.</span>
<a href="#l16.9"></a><span id="l16.9">    * @param result       The result element to append results to.</span>
<a href="#l16.10"></a><span id="l16.10">    */</span>
<a href="#l16.11"></a><span id="l16.11">   _searchCards(searchQuery, directory, result) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    let childCards;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    try {</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-      childCards = this._abManager.getDirectory(directory.URI + searchQuery)</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-        .childCards;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-    } catch (e) {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-      Cu.reportError(</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-        &quot;Error running addressbook query '&quot; + searchQuery + &quot;': &quot; + e</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-      );</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-      return;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-    }</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-</span>
<a href="#l16.23"></a><span id="l16.23">     // Cache this values to save going through xpconnect each time</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-    var commentColumn = this._commentColumn == 1 ? directory.dirName : &quot;&quot;;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+    let commentColumn = this._commentColumn == 1 ? directory.dirName : &quot;&quot;;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-    // Now iterate through all the cards.</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-    while (childCards.hasMoreElements()) {</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-      var card = childCards.getNext();</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-      if (card instanceof Ci.nsIAbCard) {</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-        if (card.isMailList) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-          this._addToResult(commentColumn, directory, card, &quot;&quot;, true, result);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-        } else {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-          let email = card.primaryEmail;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-          if (email) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-            this._addToResult(</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-              commentColumn,</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-              directory,</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-              card,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-              email,</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-              true,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-              result</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-            );</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+    if (searchQuery[0] == &quot;?&quot;) {</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+      searchQuery = searchQuery.substring(1);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+    }</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+      this._abManager.getDirectory(directory.URI).search(searchQuery, {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+        onSearchFoundCard: card =&gt; {</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+          if (card.isMailList) {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+            this._addToResult(commentColumn, directory, card, &quot;&quot;, true, result);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+          } else {</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+            let email = card.primaryEmail;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+            if (email) {</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+              this._addToResult(</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+                commentColumn,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+                directory,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+                card,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+                email,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+                true,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+                result</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+              );</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+            }</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+            email = card.getProperty(&quot;SecondEmail&quot;, &quot;&quot;);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+            if (email) {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+              this._addToResult(</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+                commentColumn,</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+                directory,</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+                card,</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+                email,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+                false,</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+                result</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+              );</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+            }</span>
<a href="#l16.76"></a><span id="l16.76">           }</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-          email = card.getProperty(&quot;SecondEmail&quot;, &quot;&quot;);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-          if (email) {</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-            this._addToResult(</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-              commentColumn,</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-              directory,</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-              card,</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-              email,</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-              false,</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-              result</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-            );</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-          }</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-        }</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-      }</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-    }</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+        },</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+        onSearchFinished(result, errorMsg) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+          resolve();</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+        },</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+      });</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    });</span>
<a href="#l16.98"></a><span id="l16.98">   },</span>
<a href="#l16.99"></a><span id="l16.99"> </span>
<a href="#l16.100"></a><span id="l16.100">   /**</span>
<a href="#l16.101"></a><span id="l16.101">    * Checks the parent card and email address of an autocomplete results entry</span>
<a href="#l16.102"></a><span id="l16.102">    * from a previous result against the search parameters to see if that entry</span>
<a href="#l16.103"></a><span id="l16.103">    * should still be included in the narrowed-down result.</span>
<a href="#l16.104"></a><span id="l16.104">    *</span>
<a href="#l16.105"></a><span id="l16.105">    * @param aCard        The card to check.</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineat">@@ -374,17 +369,17 @@ AbAutoCompleteSearch.prototype = {</span>
<a href="#l16.107"></a><span id="l16.107">   /**</span>
<a href="#l16.108"></a><span id="l16.108">    * Starts a search based on the given parameters.</span>
<a href="#l16.109"></a><span id="l16.109">    *</span>
<a href="#l16.110"></a><span id="l16.110">    * @see nsIAutoCompleteSearch for parameter details.</span>
<a href="#l16.111"></a><span id="l16.111">    *</span>
<a href="#l16.112"></a><span id="l16.112">    * It is expected that aSearchParam contains the identity (if any) to use</span>
<a href="#l16.113"></a><span id="l16.113">    * for determining if an address book should be autocompleted against.</span>
<a href="#l16.114"></a><span id="l16.114">    */</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-  startSearch(aSearchString, aSearchParam, aPreviousResult, aListener) {</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  async startSearch(aSearchString, aSearchParam, aPreviousResult, aListener) {</span>
<a href="#l16.117"></a><span id="l16.117">     let params = aSearchParam ? JSON.parse(aSearchParam) : {};</span>
<a href="#l16.118"></a><span id="l16.118">     var result = new nsAbAutoCompleteResult(aSearchString);</span>
<a href="#l16.119"></a><span id="l16.119">     if (&quot;type&quot; in params &amp;&amp; !this.applicableHeaders.has(params.type)) {</span>
<a href="#l16.120"></a><span id="l16.120">       result.searchResult = ACR.RESULT_IGNORED;</span>
<a href="#l16.121"></a><span id="l16.121">       aListener.onSearchResult(this, result);</span>
<a href="#l16.122"></a><span id="l16.122">       return;</span>
<a href="#l16.123"></a><span id="l16.123">     }</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125" class="difflineat">@@ -465,17 +460,17 @@ AbAutoCompleteSearch.prototype = {</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127">       // Now do the searching</span>
<a href="#l16.128"></a><span id="l16.128">       // We're not going to bother searching sub-directories, currently the</span>
<a href="#l16.129"></a><span id="l16.129">       // architecture forces all cards that are in mailing lists to be in ABs as</span>
<a href="#l16.130"></a><span id="l16.130">       // well, therefore by searching sub-directories (aka mailing lists) we're</span>
<a href="#l16.131"></a><span id="l16.131">       // just going to find duplicates.</span>
<a href="#l16.132"></a><span id="l16.132">       for (let dir of this._abManager.directories) {</span>
<a href="#l16.133"></a><span id="l16.133">         if (dir.useForAutocomplete(&quot;idKey&quot; in params ? params.idKey : null)) {</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-          this._searchCards(searchQuery, dir, result);</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+          await this._searchCards(searchQuery, dir, result);</span>
<a href="#l16.136"></a><span id="l16.136">         }</span>
<a href="#l16.137"></a><span id="l16.137">       }</span>
<a href="#l16.138"></a><span id="l16.138"> </span>
<a href="#l16.139"></a><span id="l16.139">       result._searchResults = [...result._collectedValues.values()];</span>
<a href="#l16.140"></a><span id="l16.140">     }</span>
<a href="#l16.141"></a><span id="l16.141"> </span>
<a href="#l16.142"></a><span id="l16.142">     // Sort the results. Scoring may have changed so do it even if this is</span>
<a href="#l16.143"></a><span id="l16.143">     // just filtered previous results.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -557,8 +557,13 @@ NS_IMETHODIMP nsAbDirProperty::SetLocali</span>
<a href="#l17.4"></a><span id="l17.4">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">   rv = locStr-&gt;SetData(NS_ConvertUTF8toUTF16(aValue));</span>
<a href="#l17.7"></a><span id="l17.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">   return m_DirectoryPrefs-&gt;SetComplexValue(</span>
<a href="#l17.10"></a><span id="l17.10">       aName, NS_GET_IID(nsIPrefLocalizedString), locStr);</span>
<a href="#l17.11"></a><span id="l17.11"> }</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::Search(const nsAString &amp;query,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+                                      nsIAbDirSearchListener *listener) {</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -129,20 +129,16 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetChil</span>
<a href="#l18.4"></a><span id="l18.4">         do_CreateInstance(NS_ABJSDIRECTORY_CONTRACTID, &amp;rv);</span>
<a href="#l18.5"></a><span id="l18.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7">     rv = directory-&gt;Init(localDirectoryURI.get());</span>
<a href="#l18.8"></a><span id="l18.8">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10">     rv = directory-&gt;GetChildCards(result);</span>
<a href="#l18.11"></a><span id="l18.11">   } else {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    // Start the search</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-    rv = StartSearch();</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-</span>
<a href="#l18.16"></a><span id="l18.16">     rv = NS_NewEmptyEnumerator(result);</span>
<a href="#l18.17"></a><span id="l18.17">   }</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.20"></a><span id="l18.20">   return rv;</span>
<a href="#l18.21"></a><span id="l18.21"> }</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> NS_IMETHODIMP nsAbLDAPDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineat">@@ -243,70 +239,92 @@ NS_IMETHODIMP nsAbLDAPDirectory::SetLDAP</span>
<a href="#l18.25"></a><span id="l18.25">         static_cast&lt;nsIAbDirectory *&gt;(this), &quot;IsSecure&quot;,</span>
<a href="#l18.26"></a><span id="l18.26">         (newIsNotSecure ? trueString : falseString),</span>
<a href="#l18.27"></a><span id="l18.27">         (newIsNotSecure ? falseString : trueString));</span>
<a href="#l18.28"></a><span id="l18.28">   }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30">   return NS_OK;</span>
<a href="#l18.31"></a><span id="l18.31"> }</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-nsresult nsAbLDAPDirectory::StartSearch() {</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  if (!mIsQueryURI || mQueryString.IsEmpty()) return NS_OK;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::Search(const nsAString &amp;query,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                                        nsIAbDirSearchListener *listener) {</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  // When offline, get the child cards from the local, replicated directory.</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  bool offline;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  nsresult rv = ioService-&gt;GetOffline(&amp;offline);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  if (offline) {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+    nsCString fileName;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    rv = GetReplicationFileName(fileName);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  nsresult rv = Initiate();</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    // If there is no fileName, bail out now.</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    if (fileName.IsEmpty()) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+      listener-&gt;OnSearchFinished(1, EmptyString());</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+      return NS_OK;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    }</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+    // Get the local directory.</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+    nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kJSDirectoryRoot));</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+    localDirectoryURI.Append(fileName);</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory =</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+        do_CreateInstance(NS_ABJSDIRECTORY_CONTRACTID, &amp;rv);</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+    rv = directory-&gt;Init(localDirectoryURI.get());</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+    // Perform the query.</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+    return directory-&gt;Search(query, listener);</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  }</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  rv = Initiate();</span>
<a href="#l18.72"></a><span id="l18.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74">   rv = StopSearch();</span>
<a href="#l18.75"></a><span id="l18.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">   nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l18.78"></a><span id="l18.78">       do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l18.79"></a><span id="l18.79">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.80"></a><span id="l18.80"> </span>
<a href="#l18.81"></a><span id="l18.81">   nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-  rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+  rv = nsAbQueryStringToExpression::Convert(NS_ConvertUTF16toUTF8(query),</span>
<a href="#l18.84"></a><span id="l18.84">                                             getter_AddRefs(expression));</span>
<a href="#l18.85"></a><span id="l18.85">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87">   rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l18.88"></a><span id="l18.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90">   rv = arguments-&gt;SetQuerySubDirectories(true);</span>
<a href="#l18.91"></a><span id="l18.91">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.92"></a><span id="l18.92"> </span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-  // Get the max hits to return</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  // Get the max hits to return.</span>
<a href="#l18.95"></a><span id="l18.95">   int32_t maxHits;</span>
<a href="#l18.96"></a><span id="l18.96">   rv = GetMaxHits(&amp;maxHits);</span>
<a href="#l18.97"></a><span id="l18.97">   if (NS_FAILED(rv)) maxHits = kDefaultMaxHits;</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-  // get the appropriate ldap attribute map, and pass it in via the</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-  // TypeSpecificArgument</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+  // Get the appropriate ldap attribute map, and pass it in via the</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  // TypeSpecificArgument.</span>
<a href="#l18.103"></a><span id="l18.103">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l18.104"></a><span id="l18.104">   rv = GetAttributeMap(getter_AddRefs(attrMap));</span>
<a href="#l18.105"></a><span id="l18.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.106"></a><span id="l18.106"> </span>
<a href="#l18.107"></a><span id="l18.107">   rv = arguments-&gt;SetTypeSpecificArg(attrMap);</span>
<a href="#l18.108"></a><span id="l18.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-  if (!mDirectoryQuery) {</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-    mDirectoryQuery =</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-        do_CreateInstance(NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-  }</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-  // Perform the query</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-  rv = mDirectoryQuery-&gt;DoQuery(this, arguments, this, maxHits, 0, &amp;mContext);</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+  mDirectoryQuery = do_CreateInstance(NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;rv);</span>
<a href="#l18.119"></a><span id="l18.119">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.120"></a><span id="l18.120"> </span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-  // Enter lock</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-  MutexAutoLock lock(mLock);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-  mPerformingQuery = true;</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-  mCache.Clear();</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-  return rv;</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  // Perform the query.</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  return mDirectoryQuery-&gt;DoQuery(this, arguments, listener, maxHits, 0,</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+                                  &amp;mContext);</span>
<a href="#l18.130"></a><span id="l18.130"> }</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132"> nsresult nsAbLDAPDirectory::StopSearch() {</span>
<a href="#l18.133"></a><span id="l18.133">   nsresult rv = Initiate();</span>
<a href="#l18.134"></a><span id="l18.134">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.135"></a><span id="l18.135"> </span>
<a href="#l18.136"></a><span id="l18.136">   // Enter lock</span>
<a href="#l18.137"></a><span id="l18.137">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -28,16 +28,18 @@ class nsAbLDAPDirectory : public nsAbDir</span>
<a href="#l19.4"></a><span id="l19.4">   NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   // nsIAbDirectory methods</span>
<a href="#l19.7"></a><span id="l19.7">   NS_IMETHOD GetPropertiesChromeURI(nsACString &amp;aResult) override;</span>
<a href="#l19.8"></a><span id="l19.8">   NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l19.9"></a><span id="l19.9">   NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l19.10"></a><span id="l19.10">   NS_IMETHOD GetChildCards(nsISimpleEnumerator **result) override;</span>
<a href="#l19.11"></a><span id="l19.11">   NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  NS_IMETHOD Search(const nsAString &amp;query,</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                    nsIAbDirSearchListener *listener) override;</span>
<a href="#l19.14"></a><span id="l19.14">   NS_IMETHOD HasCard(nsIAbCard *cards, bool *hasCard) override;</span>
<a href="#l19.15"></a><span id="l19.15">   NS_IMETHOD GetSupportsMailingLists(bool *aSupportsMailingsLists) override;</span>
<a href="#l19.16"></a><span id="l19.16">   NS_IMETHOD GetReadOnly(bool *aReadOnly) override;</span>
<a href="#l19.17"></a><span id="l19.17">   NS_IMETHOD GetIsRemote(bool *aIsRemote) override;</span>
<a href="#l19.18"></a><span id="l19.18">   NS_IMETHOD GetIsSecure(bool *aIsRemote) override;</span>
<a href="#l19.19"></a><span id="l19.19">   NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l19.20"></a><span id="l19.20">                                 bool *aResult) override;</span>
<a href="#l19.21"></a><span id="l19.21">   NS_IMETHOD AddCard(nsIAbCard *aChildCard, nsIAbCard **aAddedCard) override;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -46,17 +48,16 @@ class nsAbLDAPDirectory : public nsAbDir</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24">   NS_DECL_NSIABLDAPDIRECTORY</span>
<a href="#l19.25"></a><span id="l19.25">   NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27">  protected:</span>
<a href="#l19.28"></a><span id="l19.28">   virtual ~nsAbLDAPDirectory();</span>
<a href="#l19.29"></a><span id="l19.29">   nsresult Initiate();</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  nsresult StartSearch();</span>
<a href="#l19.32"></a><span id="l19.32">   nsresult StopSearch();</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34">   bool mPerformingQuery;</span>
<a href="#l19.35"></a><span id="l19.35">   int32_t mContext;</span>
<a href="#l19.36"></a><span id="l19.36">   int32_t mMaxHits;</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mCache;</span>
<a href="#l19.39"></a><span id="l19.39"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -74,16 +74,18 @@ class nsAbOSXDirectory final : public ns</span>
<a href="#l20.4"></a><span id="l20.4">   NS_IMETHOD GetCardFromProperty(const char *aProperty,</span>
<a href="#l20.5"></a><span id="l20.5">                                  const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l20.6"></a><span id="l20.6">                                  nsIAbCard **aResult) override;</span>
<a href="#l20.7"></a><span id="l20.7">   NS_IMETHOD GetCardsFromProperty(const char *aProperty,</span>
<a href="#l20.8"></a><span id="l20.8">                                   const nsACString &amp;aValue, bool aCaseSensitive,</span>
<a href="#l20.9"></a><span id="l20.9">                                   nsISimpleEnumerator **aResult) override;</span>
<a href="#l20.10"></a><span id="l20.10">   NS_IMETHOD CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l20.11"></a><span id="l20.11">                                  nsIAbCard **aResult) override;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  NS_IMETHOD Search(const nsAString &amp;query,</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+                    nsIAbDirSearchListener *listener) override;</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15">   // nsIAbOSXDirectory</span>
<a href="#l20.16"></a><span id="l20.16">   nsresult AssertChildNodes() override;</span>
<a href="#l20.17"></a><span id="l20.17">   nsresult AssertDirectory(nsIAbManager *aManager,</span>
<a href="#l20.18"></a><span id="l20.18">                            nsIAbDirectory *aDirectory) override;</span>
<a href="#l20.19"></a><span id="l20.19">   nsresult AssertCard(nsIAbManager *aManager, nsIAbCard *aCard) override;</span>
<a href="#l20.20"></a><span id="l20.20">   nsresult UnassertCard(nsIAbManager *aManager, nsIAbCard *aCard,</span>
<a href="#l20.21"></a><span id="l20.21">                         nsIMutableArray *aCardList) override;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -96,18 +98,16 @@ class nsAbOSXDirectory final : public ns</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   nsresult GetCardByUri(const nsACString &amp;aUri,</span>
<a href="#l20.25"></a><span id="l20.25">                         nsIAbOSXCard **aResult) override;</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">   nsresult GetRootOSXDirectory(nsIAbOSXDirectory **aResult);</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">  private:</span>
<a href="#l20.30"></a><span id="l20.30">   ~nsAbOSXDirectory();</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  nsresult FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-                          nsISimpleEnumerator **aCards);</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34">   // This is a list of nsIAbCards, kept separate from m_AddressList because:</span>
<a href="#l20.35"></a><span id="l20.35">   // - nsIAbDirectory items that are mailing lists, must keep a list of</span>
<a href="#l20.36"></a><span id="l20.36">   //   nsIAbCards in m_AddressList, however</span>
<a href="#l20.37"></a><span id="l20.37">   // - nsIAbDirectory items that are address books, must keep a list of</span>
<a href="#l20.38"></a><span id="l20.38">   //   nsIAbDirectory (i.e. mailing lists) in m_AddressList, AND no nsIAbCards.</span>
<a href="#l20.39"></a><span id="l20.39">   //</span>
<a href="#l20.40"></a><span id="l20.40">   // This wasn't too bad for mork, as that just gets a list from its database,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -211,218 +211,16 @@ static nsresult Sync(NSString *aUid) {</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5">   if (!inserted &amp;&amp; !updated &amp;&amp; !deleted) {</span>
<a href="#l21.6"></a><span id="l21.6">     // XXX This is supposed to mean &quot;everything was updated&quot;, but we get</span>
<a href="#l21.7"></a><span id="l21.7">     //     this whenever something has changed, so not sure what to do.</span>
<a href="#l21.8"></a><span id="l21.8">   }</span>
<a href="#l21.9"></a><span id="l21.9"> }</span>
<a href="#l21.10"></a><span id="l21.10"> @end</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-static nsresult MapConditionString(nsIAbBooleanConditionString *aCondition, bool aNegate,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                                   bool &amp;aCanHandle, ABSearchElement **aResult) {</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  aCanHandle = false;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  nsAbBooleanConditionType conditionType = 0;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  nsresult rv = aCondition-&gt;GetCondition(&amp;conditionType);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-  ABSearchComparison comparison;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-  switch (conditionType) {</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    case nsIAbBooleanConditionTypes::Contains: {</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-      if (!aNegate) {</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-        comparison = kABContainsSubString;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-        aCanHandle = true;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-      }</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-      break;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-    }</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    case nsIAbBooleanConditionTypes::DoesNotContain: {</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-      if (aNegate) {</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-        comparison = kABContainsSubString;</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-        aCanHandle = true;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-      }</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-      break;</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-    }</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-    case nsIAbBooleanConditionTypes::Is: {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-      comparison = aNegate ? kABNotEqual : kABEqual;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-      aCanHandle = true;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-      break;</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-    }</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-    case nsIAbBooleanConditionTypes::IsNot: {</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-      comparison = aNegate ? kABEqual : kABNotEqual;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-      aCanHandle = true;</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-      break;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-    }</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-    case nsIAbBooleanConditionTypes::BeginsWith: {</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-      if (!aNegate) {</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-        comparison = kABPrefixMatch;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-        aCanHandle = true;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-      }</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-      break;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-    }</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-    case nsIAbBooleanConditionTypes::EndsWith: {</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-      // comparison = kABSuffixMatch;</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-      break;</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-    }</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-    case nsIAbBooleanConditionTypes::LessThan: {</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-      comparison = aNegate ? kABGreaterThanOrEqual : kABLessThan;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-      aCanHandle = true;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-      break;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-    }</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-    case nsIAbBooleanConditionTypes::GreaterThan: {</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-      comparison = aNegate ? kABLessThanOrEqual : kABGreaterThan;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-      aCanHandle = true;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-      break;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-    }</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  }</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  if (!aCanHandle) return NS_OK;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  nsCString name;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  rv = aCondition-&gt;GetName(getter_Copies(name));</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-  nsString value;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-  rv = aCondition-&gt;GetValue(getter_Copies(value));</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-  uint32_t length = value.Length();</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  uint32_t i;</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-  for (i = 0; i &lt; nsAbOSXUtils::kPropertyMapSize; ++i) {</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-    if (name.Equals(nsAbOSXUtils::kPropertyMap[i].mPropertyName)) {</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-      *aResult = [ABPerson</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-          searchElementForProperty:nsAbOSXUtils::kPropertyMap[i].mOSXProperty</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-                             label:nsAbOSXUtils::kPropertyMap[i].mOSXLabel</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-                               key:nsAbOSXUtils::kPropertyMap[i].mOSXKey</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-                             value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-                                                                      value.get())</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-                                                           length:length]</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-                        comparison:comparison];</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-      return NS_OK;</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-    }</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-  }</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-  if (name.EqualsLiteral(&quot;DisplayName&quot;) &amp;&amp; comparison == kABContainsSubString) {</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-    ABSearchElement *first = [ABPerson</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-        searchElementForProperty:kABFirstNameProperty</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-                           label:nil</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-                             key:nil</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-                                                                    value.get())</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-                                                         length:length]</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-                      comparison:comparison];</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-    ABSearchElement *second = [ABPerson</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-        searchElementForProperty:kABLastNameProperty</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-                           label:nil</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-                             key:nil</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-                                                                    value.get())</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-                                                         length:length]</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-                      comparison:comparison];</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-    ABSearchElement *third = [ABGroup</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-        searchElementForProperty:kABGroupNameProperty</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-                           label:nil</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-                             key:nil</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-                           value:[NSString stringWithCharacters:reinterpret_cast&lt;const unichar *&gt;(</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-                                                                    value.get())</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-                                                         length:length]</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-                      comparison:comparison];</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-    *aResult = [ABSearchElement</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-        searchElementForConjunction:kABSearchOr</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-                           children:[NSArray arrayWithObjects:first, second, third, nil]];</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-    return NS_OK;</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-  }</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-  aCanHandle = false;</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineminus">-</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineminus">-  return NS_OK;</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineminus">-}</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-static nsresult BuildSearchElements(nsIAbBooleanExpression *aExpression, bool &amp;aCanHandle,</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-                                    ABSearchElement **aResult) {</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-  aCanHandle = true;</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; expressions;</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-  nsresult rv = aExpression-&gt;GetExpressions(getter_AddRefs(expressions));</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-  nsAbBooleanOperationType operation;</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-  rv = aExpression-&gt;GetOperation(&amp;operation);</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-  uint32_t count;</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-  rv = expressions-&gt;GetLength(&amp;count);</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-  NS_ASSERTION(count &gt; 1 &amp;&amp; operation != nsIAbBooleanOperationTypes::NOT,</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineminus">-               &quot;This doesn't make sense!&quot;);</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineminus">-</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-  NSMutableArray *array = nullptr;</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-  if (count &gt; 1) array = [[NSMutableArray alloc] init];</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-  uint32_t i;</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-  nsCOMPtr&lt;nsIAbBooleanConditionString&gt; condition;</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-  nsCOMPtr&lt;nsIAbBooleanExpression&gt; subExpression;</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-  for (i = 0; i &lt; count; ++i) {</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-    ABSearchElement *element = nullptr;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-    condition = do_QueryElementAt(expressions, i);</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-    if (condition) {</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-      rv = MapConditionString(condition, operation == nsIAbBooleanOperationTypes::NOT, aCanHandle,</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineminus">-                              &amp;element);</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-      if (NS_FAILED(rv)) break;</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-    } else {</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-      subExpression = do_QueryElementAt(expressions, i);</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-      if (subExpression) {</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-        rv = BuildSearchElements(subExpression, aCanHandle, &amp;element);</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-      }</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-    }</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-    if (!aCanHandle) {</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-      // remember to free the array when returning early</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-      [array release];</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-      return NS_OK;</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-    }</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-    if (element) {</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-      if (array)</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-        [array addObject:element];</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-      else</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-        *aResult = element;</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-    }</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-  }</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-  if (array) {</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineminus">-      ABSearchConjunction conjunction =</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineminus">-          operation == nsIAbBooleanOperationTypes::AND ? kABSearchAnd : kABSearchOr;</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-      *aResult = [ABSearchElement searchElementForConjunction:conjunction children:array];</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-    }</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-    [array release];</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineminus">-  }</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineminus">-</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-  return rv;</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineminus">-}</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineminus">-</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineminus">-static bool Search(nsIAbBooleanExpression *aExpression, NSArray **aResult) {</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-  bool canHandle = false;</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineminus">-  ABSearchElement *searchElement;</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineminus">-  nsresult rv = BuildSearchElements(aExpression, canHandle, &amp;searchElement);</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineminus">-</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineminus">-  if (canHandle)</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-    *aResult = [[ABAddressBook sharedAddressBook] recordsMatchingSearchElement:searchElement];</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-  return canHandle;</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-}</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-</span>
<a href="#l21.214"></a><span id="l21.214"> static uint32_t sObserverCount = 0;</span>
<a href="#l21.215"></a><span id="l21.215"> static ABChangedMonitor *sObserver = nullptr;</span>
<a href="#l21.216"></a><span id="l21.216"> </span>
<a href="#l21.217"></a><span id="l21.217"> nsAbOSXDirectory::nsAbOSXDirectory() {}</span>
<a href="#l21.218"></a><span id="l21.218"> </span>
<a href="#l21.219"></a><span id="l21.219"> nsAbOSXDirectory::~nsAbOSXDirectory() {</span>
<a href="#l21.220"></a><span id="l21.220">   if (--sObserverCount == 0) {</span>
<a href="#l21.221"></a><span id="l21.221">     [[NSNotificationCenter defaultCenter] removeObserver:sObserver];</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineat">@@ -832,61 +630,18 @@ nsAbOSXDirectory::GetChildNodes(nsISimpl</span>
<a href="#l21.223"></a><span id="l21.223"> }</span>
<a href="#l21.224"></a><span id="l21.224"> </span>
<a href="#l21.225"></a><span id="l21.225"> NS_IMETHODIMP</span>
<a href="#l21.226"></a><span id="l21.226"> nsAbOSXDirectory::GetChildCards(nsISimpleEnumerator **aCards) {</span>
<a href="#l21.227"></a><span id="l21.227">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l21.228"></a><span id="l21.228"> </span>
<a href="#l21.229"></a><span id="l21.229">   NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l21.230"></a><span id="l21.230"> </span>
<a href="#l21.231"></a><span id="l21.231" class="difflineminus">-  nsresult rv;</span>
<a href="#l21.232"></a><span id="l21.232" class="difflineminus">-  NSArray *cards;</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-  if (mIsQueryURI) {</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-    nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-    rv = nsAbQueryStringToExpression::Convert(mQueryString, getter_AddRefs(expression));</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">-</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineminus">-    bool canHandle = !m_IsMailList &amp;&amp; Search(expression, &amp;cards);</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineminus">-    if (!canHandle) return FallbackSearch(expression, aCards);</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineminus">-</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineminus">-    if (!mCardList)</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-      mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineminus">-    else</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-      mCardList-&gt;Clear();</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineminus">-</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineminus">-    // The uuid for initializing cards</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineminus">-    nsAutoCString ourUuid;</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineminus">-    GetUuid(ourUuid);</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineminus">-</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineminus">-    // Fill the results array and update the card list</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineminus">-    unsigned int nbCards = [cards count];</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-    unsigned int i;</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineminus">-    nsCOMPtr&lt;nsIAbOSXDirectory&gt; rootOSXDirectory;</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineminus">-    rv = GetRootOSXDirectory(getter_AddRefs(rootOSXDirectory));</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineminus">-</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineminus">-    for (i = 0; i &lt; nbCards; ++i) {</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineminus">-      rv = GetCard([cards objectAtIndex:i], getter_AddRefs(card), rootOSXDirectory);</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineminus">-</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineminus">-      if (NS_FAILED(rv)) rv = CreateCard([cards objectAtIndex:i], getter_AddRefs(card));</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineminus">-</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.266"></a><span id="l21.266" class="difflineminus">-      card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l21.267"></a><span id="l21.267" class="difflineminus">-</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-      mCardList-&gt;AppendElement(card);</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-    }</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineminus">-</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineminus">-    return NS_NewArrayEnumerator(aCards, mCardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l21.272"></a><span id="l21.272" class="difflineminus">-  }</span>
<a href="#l21.273"></a><span id="l21.273" class="difflineminus">-</span>
<a href="#l21.274"></a><span id="l21.274">   // Not a search, so just return the appropriate list of items.</span>
<a href="#l21.275"></a><span id="l21.275" class="difflineminus">-  return m_IsMailList ? NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbDirectory))</span>
<a href="#l21.276"></a><span id="l21.276" class="difflineplus">+  return m_IsMailList ? NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbCard))</span>
<a href="#l21.277"></a><span id="l21.277">                       : NS_NewArrayEnumerator(aCards, mCardList, NS_GET_IID(nsIAbCard));</span>
<a href="#l21.278"></a><span id="l21.278"> </span>
<a href="#l21.279"></a><span id="l21.279">   NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l21.280"></a><span id="l21.280"> }</span>
<a href="#l21.281"></a><span id="l21.281"> </span>
<a href="#l21.282"></a><span id="l21.282"> NS_IMETHODIMP</span>
<a href="#l21.283"></a><span id="l21.283"> nsAbOSXDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l21.284"></a><span id="l21.284">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineat">@@ -1087,69 +842,53 @@ nsAbOSXDirectory::OnSearchFoundCard(nsIA</span>
<a href="#l21.286"></a><span id="l21.286"> </span>
<a href="#l21.287"></a><span id="l21.287">   nsAutoCString ourUuid;</span>
<a href="#l21.288"></a><span id="l21.288">   GetUuid(ourUuid);</span>
<a href="#l21.289"></a><span id="l21.289">   aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l21.290"></a><span id="l21.290"> </span>
<a href="#l21.291"></a><span id="l21.291">   return NS_OK;</span>
<a href="#l21.292"></a><span id="l21.292"> }</span>
<a href="#l21.293"></a><span id="l21.293"> </span>
<a href="#l21.294"></a><span id="l21.294" class="difflineminus">-nsresult nsAbOSXDirectory::FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l21.295"></a><span id="l21.295" class="difflineminus">-                                          nsISimpleEnumerator **aCards) {</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineplus">+nsAbOSXDirectory::Search(const nsAString &amp;query, nsIAbDirSearchListener *listener) {</span>
<a href="#l21.298"></a><span id="l21.298">   nsresult rv;</span>
<a href="#l21.299"></a><span id="l21.299"> </span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-  if (mCardList)</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-    rv = mCardList-&gt;Clear();</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineminus">-  else</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineminus">-    mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l21.304"></a><span id="l21.304" class="difflineplus">+  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineplus">+  rv = nsAbQueryStringToExpression::Convert(NS_ConvertUTF16toUTF8(query),</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineplus">+                                            getter_AddRefs(expression));</span>
<a href="#l21.307"></a><span id="l21.307">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.308"></a><span id="l21.308"> </span>
<a href="#l21.309"></a><span id="l21.309" class="difflineminus">-  if (m_AddressList) {</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineminus">-    m_AddressList-&gt;Clear();</span>
<a href="#l21.311"></a><span id="l21.311" class="difflineminus">-  } else {</span>
<a href="#l21.312"></a><span id="l21.312" class="difflineminus">-    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l21.313"></a><span id="l21.313" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-  }</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineminus">-</span>
<a href="#l21.316"></a><span id="l21.316">   nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l21.317"></a><span id="l21.317">       do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l21.318"></a><span id="l21.318">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.319"></a><span id="l21.319"> </span>
<a href="#l21.320"></a><span id="l21.320" class="difflineminus">-  rv = arguments-&gt;SetExpression(aExpression);</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineplus">+  rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l21.322"></a><span id="l21.322">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.323"></a><span id="l21.323"> </span>
<a href="#l21.324"></a><span id="l21.324">   // Don't search the subdirectories. If the current directory is a mailing</span>
<a href="#l21.325"></a><span id="l21.325">   // list, it won't have any subdirectories. If the current directory is an</span>
<a href="#l21.326"></a><span id="l21.326">   // addressbook, searching both it and the subdirectories (the mailing</span>
<a href="#l21.327"></a><span id="l21.327">   // lists), will yield duplicate results because every entry in a mailing</span>
<a href="#l21.328"></a><span id="l21.328">   // list will be an entry in the parent addressbook.</span>
<a href="#l21.329"></a><span id="l21.329">   rv = arguments-&gt;SetQuerySubDirectories(false);</span>
<a href="#l21.330"></a><span id="l21.330">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.331"></a><span id="l21.331"> </span>
<a href="#l21.332"></a><span id="l21.332" class="difflineminus">-  // Get the directory without the query</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.335"></a><span id="l21.335" class="difflineminus">-</span>
<a href="#l21.336"></a><span id="l21.336" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-  rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l21.338"></a><span id="l21.338" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-</span>
<a href="#l21.340"></a><span id="l21.340">   // Initiate the proxy query with the no query directory</span>
<a href="#l21.341"></a><span id="l21.341">   nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy =</span>
<a href="#l21.342"></a><span id="l21.342">       do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l21.343"></a><span id="l21.343">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.344"></a><span id="l21.344"> </span>
<a href="#l21.345"></a><span id="l21.345">   rv = queryProxy-&gt;Initiate();</span>
<a href="#l21.346"></a><span id="l21.346">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.347"></a><span id="l21.347"> </span>
<a href="#l21.348"></a><span id="l21.348">   int32_t context = 0;</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineminus">-  rv = queryProxy-&gt;DoQuery(directory, arguments, this, -1, 0, &amp;context);</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineplus">+  rv = queryProxy-&gt;DoQuery(this, arguments, listener, -1, 0, &amp;context);</span>
<a href="#l21.351"></a><span id="l21.351">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.352"></a><span id="l21.352"> </span>
<a href="#l21.353"></a><span id="l21.353" class="difflineminus">-  return NS_NewArrayEnumerator(aCards, m_AddressList, NS_GET_IID(nsIAbDirectory));</span>
<a href="#l21.354"></a><span id="l21.354" class="difflineplus">+  return NS_OK;</span>
<a href="#l21.355"></a><span id="l21.355"> }</span>
<a href="#l21.356"></a><span id="l21.356"> </span>
<a href="#l21.357"></a><span id="l21.357"> nsresult nsAbOSXDirectory::DeleteUid(const nsACString &amp;aUid) {</span>
<a href="#l21.358"></a><span id="l21.358">   if (!m_AddressList) return NS_ERROR_NULL_POINTER;</span>
<a href="#l21.359"></a><span id="l21.359"> </span>
<a href="#l21.360"></a><span id="l21.360">   nsresult rv;</span>
<a href="#l21.361"></a><span id="l21.361">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.362"></a><span id="l21.362">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/head.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/head.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -26,8 +26,27 @@ function promiseDirectoryRemoved() {</span>
<a href="#l22.4"></a><span id="l22.4">       },</span>
<a href="#l22.5"></a><span id="l22.5">     };</span>
<a href="#l22.6"></a><span id="l22.6">     MailServices.ab.addAddressBookListener(</span>
<a href="#l22.7"></a><span id="l22.7">       observer,</span>
<a href="#l22.8"></a><span id="l22.8">       Ci.nsIAbListener.directoryRemoved</span>
<a href="#l22.9"></a><span id="l22.9">     );</span>
<a href="#l22.10"></a><span id="l22.10">   });</span>
<a href="#l22.11"></a><span id="l22.11"> }</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+function acObserver() {}</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+acObserver.prototype = {</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+  _search: null,</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+  _result: null,</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+  _resolve: null,</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+  onSearchResult(aSearch, aResult) {</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+    this._search = aSearch;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+    this._result = aResult;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+    this._resolve();</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+  },</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+  waitForResult() {</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+      this._resolve = resolve;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+    });</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  },</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch1.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -96,28 +96,16 @@ var inputs = [</span>
<a href="#l23.4"></a><span id="l23.4">   lastNames,</span>
<a href="#l23.5"></a><span id="l23.5">   displayNames,</span>
<a href="#l23.6"></a><span id="l23.6">   nickNames,</span>
<a href="#l23.7"></a><span id="l23.7">   emails,</span>
<a href="#l23.8"></a><span id="l23.8">   lists,</span>
<a href="#l23.9"></a><span id="l23.9">   bothNames,</span>
<a href="#l23.10"></a><span id="l23.10"> ];</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  _search: null,</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-  _result: null,</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-  },</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-};</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-</span>
<a href="#l23.24"></a><span id="l23.24"> var PAB_CARD_DATA = [</span>
<a href="#l23.25"></a><span id="l23.25">   {</span>
<a href="#l23.26"></a><span id="l23.26">     FirstName: &quot;firs&quot;,</span>
<a href="#l23.27"></a><span id="l23.27">     LastName: &quot;lastn&quot;,</span>
<a href="#l23.28"></a><span id="l23.28">     DisplayName: &quot;d&quot;,</span>
<a href="#l23.29"></a><span id="l23.29">     NickName: &quot;ni&quot;,</span>
<a href="#l23.30"></a><span id="l23.30">     PrimaryEmail: &quot;ema@foo.invalid&quot;,</span>
<a href="#l23.31"></a><span id="l23.31">     PreferDisplayName: true,</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineat">@@ -233,17 +221,17 @@ function setupAddressBookData(aDirURI, a</span>
<a href="#l23.33"></a><span id="l23.33">     list.isMailList = true;</span>
<a href="#l23.34"></a><span id="l23.34">     for (var prop in ld) {</span>
<a href="#l23.35"></a><span id="l23.35">       list[prop] = ld[prop];</span>
<a href="#l23.36"></a><span id="l23.36">     }</span>
<a href="#l23.37"></a><span id="l23.37">     ab.addMailList(list);</span>
<a href="#l23.38"></a><span id="l23.38">   });</span>
<a href="#l23.39"></a><span id="l23.39"> }</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-function run_test() {</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l23.43"></a><span id="l23.43">   // Set up addresses for in the personal address book.</span>
<a href="#l23.44"></a><span id="l23.44">   setupAddressBookData(kPABData.URI, PAB_CARD_DATA, PAB_LIST_DATA);</span>
<a href="#l23.45"></a><span id="l23.45">   // ... and collected addresses address book.</span>
<a href="#l23.46"></a><span id="l23.46">   setupAddressBookData(kCABData.URI, CAB_CARD_DATA, CAB_LIST_DATA);</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48">   // Test - Create a new search component</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineat">@@ -257,124 +245,144 @@ function run_test() {</span>
<a href="#l23.52"></a><span id="l23.52">   // Test - Check disabling of autocomplete</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54">   Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, false);</span>
<a href="#l23.55"></a><span id="l23.55"> </span>
<a href="#l23.56"></a><span id="l23.56">   let param = JSON.stringify({ type: &quot;addr_to&quot; });</span>
<a href="#l23.57"></a><span id="l23.57">   let paramNews = JSON.stringify({ type: &quot;addr_newsgroups&quot; });</span>
<a href="#l23.58"></a><span id="l23.58">   let paramFollowup = JSON.stringify({ type: &quot;addr_followup&quot; });</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  let resultPromise = obs.waitForResult();</span>
<a href="#l23.61"></a><span id="l23.61">   acs.startSearch(&quot;abc&quot;, param, null, obs);</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.63"></a><span id="l23.63"> </span>
<a href="#l23.64"></a><span id="l23.64">   Assert.equal(obs._search, acs);</span>
<a href="#l23.65"></a><span id="l23.65">   Assert.equal(obs._result.searchString, &quot;abc&quot;);</span>
<a href="#l23.66"></a><span id="l23.66">   Assert.equal(obs._result.searchResult, ACR.RESULT_NOMATCH);</span>
<a href="#l23.67"></a><span id="l23.67">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.68"></a><span id="l23.68">   Assert.equal(obs._result.matchCount, 0);</span>
<a href="#l23.69"></a><span id="l23.69"> </span>
<a href="#l23.70"></a><span id="l23.70">   // Test - Check Enabling of autocomplete, but with empty string.</span>
<a href="#l23.71"></a><span id="l23.71"> </span>
<a href="#l23.72"></a><span id="l23.72">   Services.prefs.setBoolPref(&quot;mail.enable_autocomplete&quot;, true);</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.75"></a><span id="l23.75">   acs.startSearch(null, param, null, obs);</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.77"></a><span id="l23.77"> </span>
<a href="#l23.78"></a><span id="l23.78">   Assert.equal(obs._search, acs);</span>
<a href="#l23.79"></a><span id="l23.79">   Assert.equal(obs._result.searchString, null);</span>
<a href="#l23.80"></a><span id="l23.80">   Assert.equal(obs._result.searchResult, ACR.RESULT_IGNORED);</span>
<a href="#l23.81"></a><span id="l23.81">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.82"></a><span id="l23.82">   Assert.equal(obs._result.matchCount, 0);</span>
<a href="#l23.83"></a><span id="l23.83">   Assert.equal(obs._result.defaultIndex, -1);</span>
<a href="#l23.84"></a><span id="l23.84"> </span>
<a href="#l23.85"></a><span id="l23.85">   // Test - Check ignoring result with comma</span>
<a href="#l23.86"></a><span id="l23.86"> </span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.88"></a><span id="l23.88">   acs.startSearch(&quot;a,b&quot;, param, null, obs);</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   Assert.equal(obs._search, acs);</span>
<a href="#l23.92"></a><span id="l23.92">   Assert.equal(obs._result.searchString, &quot;a,b&quot;);</span>
<a href="#l23.93"></a><span id="l23.93">   Assert.equal(obs._result.searchResult, ACR.RESULT_IGNORED);</span>
<a href="#l23.94"></a><span id="l23.94">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.95"></a><span id="l23.95">   Assert.equal(obs._result.matchCount, 0);</span>
<a href="#l23.96"></a><span id="l23.96">   Assert.equal(obs._result.defaultIndex, -1);</span>
<a href="#l23.97"></a><span id="l23.97"> </span>
<a href="#l23.98"></a><span id="l23.98">   // Test - No matches</span>
<a href="#l23.99"></a><span id="l23.99"> </span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.101"></a><span id="l23.101">   acs.startSearch(&quot;asjdkljdgfjglkfg&quot;, param, null, obs);</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104">   Assert.equal(obs._search, acs);</span>
<a href="#l23.105"></a><span id="l23.105">   Assert.equal(obs._result.searchString, &quot;asjdkljdgfjglkfg&quot;);</span>
<a href="#l23.106"></a><span id="l23.106">   Assert.equal(obs._result.searchResult, ACR.RESULT_NOMATCH);</span>
<a href="#l23.107"></a><span id="l23.107">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.108"></a><span id="l23.108">   Assert.equal(obs._result.matchCount, 0);</span>
<a href="#l23.109"></a><span id="l23.109">   Assert.equal(obs._result.defaultIndex, -1);</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111">   // Test - Matches</span>
<a href="#l23.112"></a><span id="l23.112"> </span>
<a href="#l23.113"></a><span id="l23.113">   // Basic quick-check</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.115"></a><span id="l23.115">   acs.startSearch(&quot;email&quot;, param, null, obs);</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.117"></a><span id="l23.117"> </span>
<a href="#l23.118"></a><span id="l23.118">   Assert.equal(obs._search, acs);</span>
<a href="#l23.119"></a><span id="l23.119">   Assert.equal(obs._result.searchString, &quot;email&quot;);</span>
<a href="#l23.120"></a><span id="l23.120">   Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l23.121"></a><span id="l23.121">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.122"></a><span id="l23.122">   Assert.equal(obs._result.matchCount, 2);</span>
<a href="#l23.123"></a><span id="l23.123">   Assert.equal(obs._result.defaultIndex, 0);</span>
<a href="#l23.124"></a><span id="l23.124"> </span>
<a href="#l23.125"></a><span id="l23.125">   Assert.equal(obs._result.getValueAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.126"></a><span id="l23.126">   Assert.equal(obs._result.getLabelAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.127"></a><span id="l23.127">   Assert.equal(obs._result.getCommentAt(0), &quot;&quot;);</span>
<a href="#l23.128"></a><span id="l23.128">   Assert.equal(obs._result.getStyleAt(0), &quot;local-abook&quot;);</span>
<a href="#l23.129"></a><span id="l23.129">   Assert.equal(obs._result.getImageAt(0), &quot;&quot;);</span>
<a href="#l23.130"></a><span id="l23.130"> </span>
<a href="#l23.131"></a><span id="l23.131">   // quick-check that nothing is found for addr_newsgroups</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+  resultPromise = obsNews.waitForResult();</span>
<a href="#l23.133"></a><span id="l23.133">   acs.startSearch(&quot;email&quot;, paramNews, null, obsNews);</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.135"></a><span id="l23.135">   Assert.ok(obsNews._result == null || obsNews._result.matchCount == 0);</span>
<a href="#l23.136"></a><span id="l23.136"> </span>
<a href="#l23.137"></a><span id="l23.137">   // quick-check that nothing is found for  addr_followup</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+  resultPromise = obsFollowup.waitForResult();</span>
<a href="#l23.139"></a><span id="l23.139">   acs.startSearch(&quot;a@b&quot;, paramFollowup, null, obsFollowup);</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.141"></a><span id="l23.141">   Assert.ok(obsFollowup._result == null || obsFollowup._result.matchCount == 0);</span>
<a href="#l23.142"></a><span id="l23.142"> </span>
<a href="#l23.143"></a><span id="l23.143">   // Now quick-check with the address book name in the comment column.</span>
<a href="#l23.144"></a><span id="l23.144">   Services.prefs.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.147"></a><span id="l23.147">   acs.startSearch(&quot;email&quot;, param, null, obs);</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150">   Assert.equal(obs._search, acs);</span>
<a href="#l23.151"></a><span id="l23.151">   Assert.equal(obs._result.searchString, &quot;email&quot;);</span>
<a href="#l23.152"></a><span id="l23.152">   Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l23.153"></a><span id="l23.153">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.154"></a><span id="l23.154">   Assert.equal(obs._result.matchCount, 2);</span>
<a href="#l23.155"></a><span id="l23.155">   Assert.equal(obs._result.defaultIndex, 0);</span>
<a href="#l23.156"></a><span id="l23.156"> </span>
<a href="#l23.157"></a><span id="l23.157">   Assert.equal(obs._result.getValueAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.158"></a><span id="l23.158">   Assert.equal(obs._result.getLabelAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.159"></a><span id="l23.159">   Assert.equal(obs._result.getCommentAt(0), kPABData.dirName);</span>
<a href="#l23.160"></a><span id="l23.160">   Assert.equal(obs._result.getStyleAt(0), &quot;local-abook&quot;);</span>
<a href="#l23.161"></a><span id="l23.161">   Assert.equal(obs._result.getImageAt(0), &quot;&quot;);</span>
<a href="#l23.162"></a><span id="l23.162"> </span>
<a href="#l23.163"></a><span id="l23.163">   // Check input with different case</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+  resultPromise = obs.waitForResult();</span>
<a href="#l23.165"></a><span id="l23.165">   acs.startSearch(&quot;EMAIL&quot;, param, null, obs);</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+  await resultPromise;</span>
<a href="#l23.167"></a><span id="l23.167"> </span>
<a href="#l23.168"></a><span id="l23.168">   Assert.equal(obs._search, acs);</span>
<a href="#l23.169"></a><span id="l23.169">   Assert.equal(obs._result.searchString, &quot;EMAIL&quot;);</span>
<a href="#l23.170"></a><span id="l23.170">   Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l23.171"></a><span id="l23.171">   Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l23.172"></a><span id="l23.172">   Assert.equal(obs._result.matchCount, 2);</span>
<a href="#l23.173"></a><span id="l23.173">   Assert.equal(obs._result.defaultIndex, 0);</span>
<a href="#l23.174"></a><span id="l23.174"> </span>
<a href="#l23.175"></a><span id="l23.175">   Assert.equal(obs._result.getValueAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.176"></a><span id="l23.176">   Assert.equal(obs._result.getLabelAt(0), &quot;dis &lt;email@foo.invalid&gt;&quot;);</span>
<a href="#l23.177"></a><span id="l23.177">   Assert.equal(obs._result.getCommentAt(0), kPABData.dirName);</span>
<a href="#l23.178"></a><span id="l23.178">   Assert.equal(obs._result.getStyleAt(0), &quot;local-abook&quot;);</span>
<a href="#l23.179"></a><span id="l23.179">   Assert.equal(obs._result.getImageAt(0), &quot;&quot;);</span>
<a href="#l23.180"></a><span id="l23.180"> </span>
<a href="#l23.181"></a><span id="l23.181">   // Now check multiple matches</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l23.184"></a><span id="l23.184">     let prevRes = obs._result;</span>
<a href="#l23.185"></a><span id="l23.185">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+    resultPromise = obs.waitForResult();</span>
<a href="#l23.187"></a><span id="l23.187">     acs.startSearch(element.search, param, prevRes, obs);</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineplus">+    await resultPromise;</span>
<a href="#l23.189"></a><span id="l23.189"> </span>
<a href="#l23.190"></a><span id="l23.190">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l23.191"></a><span id="l23.191">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l23.192"></a><span id="l23.192">     }</span>
<a href="#l23.193"></a><span id="l23.193"> </span>
<a href="#l23.194"></a><span id="l23.194">     for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l23.195"></a><span id="l23.195">       print(</span>
<a href="#l23.196"></a><span id="l23.196">         &quot;... expected &quot; +</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineat">@@ -405,22 +413,23 @@ function run_test() {</span>
<a href="#l23.198"></a><span id="l23.198">       Assert.equal(</span>
<a href="#l23.199"></a><span id="l23.199">         obs._result.getCommentAt(i),</span>
<a href="#l23.200"></a><span id="l23.200">         results[element.expected[i]].dirName</span>
<a href="#l23.201"></a><span id="l23.201">       );</span>
<a href="#l23.202"></a><span id="l23.202">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l23.203"></a><span id="l23.203">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l23.204"></a><span id="l23.204">     }</span>
<a href="#l23.205"></a><span id="l23.205">   }</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-  function checkInputSet(element, index, array) {</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-    element.forEach(checkInputItem);</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+  for (let inputSet of inputs) {</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+    for (let i = 0; i &lt; inputSet.length; i++) {</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineplus">+      await checkInputItem(inputSet[i], i);</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+    }</span>
<a href="#l23.213"></a><span id="l23.213">   }</span>
<a href="#l23.214"></a><span id="l23.214"> </span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-  inputs.forEach(checkInputSet);</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-</span>
<a href="#l23.217"></a><span id="l23.217">   // Test - Popularity Index</span>
<a href="#l23.218"></a><span id="l23.218">   print(&quot;Checking by popularity index:&quot;);</span>
<a href="#l23.219"></a><span id="l23.219">   let pab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l23.220"></a><span id="l23.220"> </span>
<a href="#l23.221"></a><span id="l23.221">   for (let card of pab.childCards) {</span>
<a href="#l23.222"></a><span id="l23.222">     if (card.isMailList) {</span>
<a href="#l23.223"></a><span id="l23.223">       continue;</span>
<a href="#l23.224"></a><span id="l23.224">     }</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineat">@@ -450,10 +459,12 @@ function run_test() {</span>
<a href="#l23.226"></a><span id="l23.226">     { search: &quot;d&quot;, expected: [1, 4, 2, 3, 0, 5, 9] },</span>
<a href="#l23.227"></a><span id="l23.227">     { search: &quot;di&quot;, expected: [1, 4, 2, 3, 5] },</span>
<a href="#l23.228"></a><span id="l23.228">     { search: &quot;dis&quot;, expected: [4, 2, 3, 5] },</span>
<a href="#l23.229"></a><span id="l23.229">     { search: &quot;disp&quot;, expected: [4, 3, 5] },</span>
<a href="#l23.230"></a><span id="l23.230">     { search: &quot;displ&quot;, expected: [4, 5] },</span>
<a href="#l23.231"></a><span id="l23.231">     { search: &quot;displa&quot;, expected: [5] },</span>
<a href="#l23.232"></a><span id="l23.232">   ];</span>
<a href="#l23.233"></a><span id="l23.233"> </span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-  popularitySearch.forEach(checkInputItem);</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-}</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineplus">+  for (let i = 0; i &lt; popularitySearch.length; i++) {</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+    await checkInputItem(popularitySearch[i], i);</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+  }</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch2.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -108,29 +108,17 @@ var firstNames = [</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> var lastNames = [</span>
<a href="#l24.6"></a><span id="l24.6">   { search: &quot;la&quot;, expected: [1, 2] },</span>
<a href="#l24.7"></a><span id="l24.7">   { search: &quot;las&quot;, expected: [2] },</span>
<a href="#l24.8"></a><span id="l24.8"> ];</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> var inputs = [firstNames, lastNames];</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  _search: null,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-  _result: null,</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  },</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-};</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-function run_test() {</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l24.26"></a><span id="l24.26">   // Test - Create a new search component</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l24.29"></a><span id="l24.29">     Ci.nsIAutoCompleteSearch</span>
<a href="#l24.30"></a><span id="l24.30">   );</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32">   var obs = new acObserver();</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34" class="difflineat">@@ -150,23 +138,25 @@ function run_test() {</span>
<a href="#l24.35"></a><span id="l24.35">       comment: results[i].dirName,</span>
<a href="#l24.36"></a><span id="l24.36">       card: createCard(i + 1, 0),</span>
<a href="#l24.37"></a><span id="l24.37">     });</span>
<a href="#l24.38"></a><span id="l24.38">   }</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40">   // Test - Matches</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42">   // Now check multiple matches</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l24.46"></a><span id="l24.46">     acs.startSearch(</span>
<a href="#l24.47"></a><span id="l24.47">       element.search,</span>
<a href="#l24.48"></a><span id="l24.48">       JSON.stringify({ type: &quot;addr_to&quot;, idKey: &quot;&quot; }),</span>
<a href="#l24.49"></a><span id="l24.49">       lastResult,</span>
<a href="#l24.50"></a><span id="l24.50">       obs</span>
<a href="#l24.51"></a><span id="l24.51">     );</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+    await resultPromise;</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54">     Assert.equal(obs._search, acs);</span>
<a href="#l24.55"></a><span id="l24.55">     Assert.equal(obs._result.searchString, element.search);</span>
<a href="#l24.56"></a><span id="l24.56">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l24.57"></a><span id="l24.57">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l24.58"></a><span id="l24.58">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60">     for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineat">@@ -181,14 +171,15 @@ function run_test() {</span>
<a href="#l24.62"></a><span id="l24.62">       Assert.equal(</span>
<a href="#l24.63"></a><span id="l24.63">         obs._result.getCommentAt(i),</span>
<a href="#l24.64"></a><span id="l24.64">         results[element.expected[i]].dirName</span>
<a href="#l24.65"></a><span id="l24.65">       );</span>
<a href="#l24.66"></a><span id="l24.66">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l24.67"></a><span id="l24.67">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l24.68"></a><span id="l24.68">     }</span>
<a href="#l24.69"></a><span id="l24.69">   }</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  function checkInputSet(element, index, array) {</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    element.forEach(checkInputItem);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  for (let inputSet of inputs) {</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+    for (let i = 0; i &lt; inputSet.length; i++) {</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+      await checkInputItem(inputSet[i], i);</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+    }</span>
<a href="#l24.77"></a><span id="l24.77">   }</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-  inputs.forEach(checkInputSet);</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-}</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch3.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -75,29 +75,17 @@ var cards = [</span>
<a href="#l25.4"></a><span id="l25.4"> ];</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> var duplicates = [</span>
<a href="#l25.7"></a><span id="l25.7">   { search: &quot;test&quot;, expected: [1, 2] },</span>
<a href="#l25.8"></a><span id="l25.8">   { search: &quot;first&quot;, expected: [6, 5, 3] },</span>
<a href="#l25.9"></a><span id="l25.9">   { search: &quot;(bracket)&quot;, expected: [7, 8] },</span>
<a href="#l25.10"></a><span id="l25.10"> ];</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  _search: null,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-  _result: null,</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  },</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-};</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-function run_test() {</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l25.26"></a><span id="l25.26">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l25.27"></a><span id="l25.27">   // popularity index and we don't need many.</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">   // Ensure all the directories are initialised.</span>
<a href="#l25.30"></a><span id="l25.30">   MailServices.ab.directories;</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l25.33"></a><span id="l25.33"> </span>
<a href="#l25.34"></a><span id="l25.34" class="difflineat">@@ -119,24 +107,26 @@ function run_test() {</span>
<a href="#l25.35"></a><span id="l25.35">   // Test - duplicate elements</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l25.38"></a><span id="l25.38">     Ci.nsIAutoCompleteSearch</span>
<a href="#l25.39"></a><span id="l25.39">   );</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">   var obs = new acObserver();</span>
<a href="#l25.42"></a><span id="l25.42"> </span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l25.45"></a><span id="l25.45">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l25.47"></a><span id="l25.47">     acs.startSearch(</span>
<a href="#l25.48"></a><span id="l25.48">       element.search,</span>
<a href="#l25.49"></a><span id="l25.49">       JSON.stringify({ type: &quot;addr_to&quot; }),</span>
<a href="#l25.50"></a><span id="l25.50">       null,</span>
<a href="#l25.51"></a><span id="l25.51">       obs</span>
<a href="#l25.52"></a><span id="l25.52">     );</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+    await resultPromise;</span>
<a href="#l25.54"></a><span id="l25.54"> </span>
<a href="#l25.55"></a><span id="l25.55">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l25.56"></a><span id="l25.56">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l25.57"></a><span id="l25.57">     }</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">     for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l25.60"></a><span id="l25.60">       print(</span>
<a href="#l25.61"></a><span id="l25.61">         &quot;... expected &quot; +</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineat">@@ -163,10 +153,12 @@ function run_test() {</span>
<a href="#l25.63"></a><span id="l25.63">       obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l25.64"></a><span id="l25.64">       Assert.equal(</span>
<a href="#l25.65"></a><span id="l25.65">         obs._result.getCardAt(i).firstName,</span>
<a href="#l25.66"></a><span id="l25.66">         cards[element.expected[i]].firstName</span>
<a href="#l25.67"></a><span id="l25.67">       );</span>
<a href="#l25.68"></a><span id="l25.68">     }</span>
<a href="#l25.69"></a><span id="l25.69">   }</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-  duplicates.forEach(checkInputItem);</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-}</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+  for (let i = 0; i &lt; duplicates.length; i++) {</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+    await checkInputItem(duplicates[i], i);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+  }</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch4.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -135,29 +135,17 @@ var reductionExpectedResults = [</span>
<a href="#l26.4"></a><span id="l26.4">     &quot;boo2@test.invalid&quot;,</span>
<a href="#l26.5"></a><span id="l26.5">     &quot;sortbasic &lt;foo_b@test.invalid&gt;&quot;,</span>
<a href="#l26.6"></a><span id="l26.6">     &quot;sortbasic &lt;foo_a@test.invalid&gt;&quot;,</span>
<a href="#l26.7"></a><span id="l26.7">   ],</span>
<a href="#l26.8"></a><span id="l26.8">   [&quot;boo1@test.invalid&quot;, &quot;boo2@test.invalid&quot;],</span>
<a href="#l26.9"></a><span id="l26.9">   [&quot;boo2@test.invalid&quot;],</span>
<a href="#l26.10"></a><span id="l26.10"> ];</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-  _search: null,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-  _result: null,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  },</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-};</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-function run_test() {</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l26.26"></a><span id="l26.26">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l26.27"></a><span id="l26.27">   // popularity index and we don't need many.</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29">   // Ensure all the directories are initialised.</span>
<a href="#l26.30"></a><span id="l26.30">   MailServices.ab.directories;</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l26.33"></a><span id="l26.33"> </span>
<a href="#l26.34"></a><span id="l26.34" class="difflineat">@@ -184,24 +172,26 @@ function run_test() {</span>
<a href="#l26.35"></a><span id="l26.35">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l26.36"></a><span id="l26.36">     Ci.nsIAutoCompleteSearch</span>
<a href="#l26.37"></a><span id="l26.37">   );</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39">   var obs = new acObserver();</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41">   print(&quot;Checking Initial Searches&quot;);</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-  function checkSearch(element, index, array) {</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+  async function checkSearch(element, index) {</span>
<a href="#l26.45"></a><span id="l26.45">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element);</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l26.47"></a><span id="l26.47">     acs.startSearch(</span>
<a href="#l26.48"></a><span id="l26.48">       element,</span>
<a href="#l26.49"></a><span id="l26.49">       JSON.stringify({ type: &quot;addr_to&quot;, idKey: &quot;&quot; }),</span>
<a href="#l26.50"></a><span id="l26.50">       null,</span>
<a href="#l26.51"></a><span id="l26.51">       obs</span>
<a href="#l26.52"></a><span id="l26.52">     );</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+    await resultPromise;</span>
<a href="#l26.54"></a><span id="l26.54"> </span>
<a href="#l26.55"></a><span id="l26.55">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l26.56"></a><span id="l26.56">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l26.57"></a><span id="l26.57">     }</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59">     Assert.equal(obs._search, acs);</span>
<a href="#l26.60"></a><span id="l26.60">     Assert.equal(obs._result.searchString, element);</span>
<a href="#l26.61"></a><span id="l26.61">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineat">@@ -213,29 +203,33 @@ function run_test() {</span>
<a href="#l26.63"></a><span id="l26.63">       Assert.equal(obs._result.getLabelAt(i), expectedResults[index][i]);</span>
<a href="#l26.64"></a><span id="l26.64">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l26.65"></a><span id="l26.65">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l26.66"></a><span id="l26.66">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l26.67"></a><span id="l26.67">       obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l26.68"></a><span id="l26.68">     }</span>
<a href="#l26.69"></a><span id="l26.69">   }</span>
<a href="#l26.70"></a><span id="l26.70"> </span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  searches.forEach(checkSearch);</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  for (let i = 0; i &lt; searches.length; i++) {</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+    await checkSearch(searches[i], i);</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+  }</span>
<a href="#l26.75"></a><span id="l26.75"> </span>
<a href="#l26.76"></a><span id="l26.76">   print(&quot;Checking Reduction of Search Results&quot;);</span>
<a href="#l26.77"></a><span id="l26.77"> </span>
<a href="#l26.78"></a><span id="l26.78">   var lastResult = null;</span>
<a href="#l26.79"></a><span id="l26.79"> </span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-  function checkReductionSearch(element, index, array) {</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+  async function checkReductionSearch(element, index) {</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l26.83"></a><span id="l26.83">     acs.startSearch(</span>
<a href="#l26.84"></a><span id="l26.84">       element,</span>
<a href="#l26.85"></a><span id="l26.85">       JSON.stringify({ type: &quot;addr_to&quot;, idKey: &quot;&quot; }),</span>
<a href="#l26.86"></a><span id="l26.86">       lastResult,</span>
<a href="#l26.87"></a><span id="l26.87">       obs</span>
<a href="#l26.88"></a><span id="l26.88">     );</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+    await resultPromise;</span>
<a href="#l26.90"></a><span id="l26.90"> </span>
<a href="#l26.91"></a><span id="l26.91">     Assert.equal(obs._search, acs);</span>
<a href="#l26.92"></a><span id="l26.92">     Assert.equal(obs._result.searchString, element);</span>
<a href="#l26.93"></a><span id="l26.93">     Assert.equal(obs._result.searchResult, ACR.RESULT_SUCCESS);</span>
<a href="#l26.94"></a><span id="l26.94">     Assert.equal(obs._result.errorDescription, null);</span>
<a href="#l26.95"></a><span id="l26.95">     Assert.equal(</span>
<a href="#l26.96"></a><span id="l26.96">       obs._result.matchCount,</span>
<a href="#l26.97"></a><span id="l26.97">       reductionExpectedResults[index].length</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineat">@@ -252,10 +246,13 @@ function run_test() {</span>
<a href="#l26.99"></a><span id="l26.99">       );</span>
<a href="#l26.100"></a><span id="l26.100">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l26.101"></a><span id="l26.101">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l26.102"></a><span id="l26.102">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l26.103"></a><span id="l26.103">       obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l26.104"></a><span id="l26.104">     }</span>
<a href="#l26.105"></a><span id="l26.105">     lastResult = obs._result;</span>
<a href="#l26.106"></a><span id="l26.106">   }</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-  reductionSearches.forEach(checkReductionSearch);</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-}</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+  for (let i = 0; i &lt; reductionSearches.length; i++) {</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+    await checkReductionSearch(reductionSearches[i], i);</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+  }</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch5.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -32,53 +32,43 @@ var lastNames = [</span>
<a href="#l27.4"></a><span id="l27.4">   { search: &quot;la&quot;, expected: [4, 0, 2, 3] },</span>
<a href="#l27.5"></a><span id="l27.5">   { search: &quot;las&quot;, expected: [4, 0, 3] },</span>
<a href="#l27.6"></a><span id="l27.6">   { search: &quot;last&quot;, expected: [4, 0] },</span>
<a href="#l27.7"></a><span id="l27.7">   { search: &quot;lastn&quot;, expected: [0] },</span>
<a href="#l27.8"></a><span id="l27.8"> ];</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> var inputs = [firstNames, lastNames];</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-  _search: null,</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-  _result: null,</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-  },</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-};</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-function run_test() {</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l27.26"></a><span id="l27.26">   loadABFile(&quot;../../../data/tb2hexpopularity&quot;, kPABData.fileName);</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28">   // Test - Create a new search component</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30">   let acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l27.31"></a><span id="l27.31">     Ci.nsIAutoCompleteSearch</span>
<a href="#l27.32"></a><span id="l27.32">   );</span>
<a href="#l27.33"></a><span id="l27.33"> </span>
<a href="#l27.34"></a><span id="l27.34">   let obs = new acObserver();</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36">   // Ensure we've got the comment column set up for extra checking.</span>
<a href="#l27.37"></a><span id="l27.37">   Services.prefs.setIntPref(&quot;mail.autoComplete.commentColumn&quot;, 1);</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39">   // Test - Matches</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41">   // Now check multiple matches</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l27.44"></a><span id="l27.44">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l27.46"></a><span id="l27.46">     acs.startSearch(</span>
<a href="#l27.47"></a><span id="l27.47">       element.search,</span>
<a href="#l27.48"></a><span id="l27.48">       JSON.stringify({ type: &quot;addr_to&quot; }),</span>
<a href="#l27.49"></a><span id="l27.49">       null,</span>
<a href="#l27.50"></a><span id="l27.50">       obs</span>
<a href="#l27.51"></a><span id="l27.51">     );</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+    await resultPromise;</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l27.55"></a><span id="l27.55">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l27.56"></a><span id="l27.56">     }</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58">     for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l27.59"></a><span id="l27.59">       print(</span>
<a href="#l27.60"></a><span id="l27.60">         &quot;... expected &quot; +</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineat">@@ -116,14 +106,15 @@ function run_test() {</span>
<a href="#l27.62"></a><span id="l27.62">         let result = obs._result.QueryInterface(Ci.nsIAbAutoCompleteResult);</span>
<a href="#l27.63"></a><span id="l27.63">         Assert.equal(</span>
<a href="#l27.64"></a><span id="l27.64">           result.getCardAt(i).getProperty(&quot;PopularityIndex&quot;, -1),</span>
<a href="#l27.65"></a><span id="l27.65">           10</span>
<a href="#l27.66"></a><span id="l27.66">         );</span>
<a href="#l27.67"></a><span id="l27.67">       }</span>
<a href="#l27.68"></a><span id="l27.68">     }</span>
<a href="#l27.69"></a><span id="l27.69">   }</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-  function checkInputSet(element, index, array) {</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-    element.forEach(checkInputItem);</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+  for (let inputSet of inputs) {</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+    for (let i = 0; i &lt; inputSet.length; i++) {</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+      await checkInputItem(inputSet[i], i);</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+    }</span>
<a href="#l27.77"></a><span id="l27.77">   }</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-  inputs.forEach(checkInputSet);</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-}</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch6.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -163,29 +163,17 @@ var inputs = [</span>
<a href="#l28.4"></a><span id="l28.4">   { search: &quot;sh&quot;, expected: [15, 14, 2, 16, 10, 7] },</span>
<a href="#l28.5"></a><span id="l28.5">   { search: &quot;st&quot;, expected: [3, 8] },</span>
<a href="#l28.6"></a><span id="l28.6">   { search: &quot;paul mary&quot;, expected: [11, 12] },</span>
<a href="#l28.7"></a><span id="l28.7">   { search: '&quot;paul mary&quot;', expected: [11] },</span>
<a href="#l28.8"></a><span id="l28.8">   { search: '&quot;iron man&quot; mr &quot;exp dev&quot;', expected: [13] },</span>
<a href="#l28.9"></a><span id="l28.9">   { search: &quot;short&quot;, expected: [14] },</span>
<a href="#l28.10"></a><span id="l28.10"> ];</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-  _search: null,</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  _result: null,</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-  },</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-};</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-function run_test() {</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l28.26"></a><span id="l28.26">   // We set up the cards for this test manually as it is easier to set the</span>
<a href="#l28.27"></a><span id="l28.27">   // popularity index and we don't need many.</span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29">   // Ensure all the directories are initialised.</span>
<a href="#l28.30"></a><span id="l28.30">   MailServices.ab.directories;</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32">   let ab = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34" class="difflineat">@@ -211,24 +199,26 @@ function run_test() {</span>
<a href="#l28.35"></a><span id="l28.35">   // Test - duplicate elements</span>
<a href="#l28.36"></a><span id="l28.36"> </span>
<a href="#l28.37"></a><span id="l28.37">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l28.38"></a><span id="l28.38">     Ci.nsIAutoCompleteSearch</span>
<a href="#l28.39"></a><span id="l28.39">   );</span>
<a href="#l28.40"></a><span id="l28.40"> </span>
<a href="#l28.41"></a><span id="l28.41">   var obs = new acObserver();</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l28.45"></a><span id="l28.45">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l28.47"></a><span id="l28.47">     acs.startSearch(</span>
<a href="#l28.48"></a><span id="l28.48">       element.search,</span>
<a href="#l28.49"></a><span id="l28.49">       JSON.stringify({ type: &quot;addr_to&quot; }),</span>
<a href="#l28.50"></a><span id="l28.50">       null,</span>
<a href="#l28.51"></a><span id="l28.51">       obs</span>
<a href="#l28.52"></a><span id="l28.52">     );</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    await resultPromise;</span>
<a href="#l28.54"></a><span id="l28.54"> </span>
<a href="#l28.55"></a><span id="l28.55">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l28.56"></a><span id="l28.56">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l28.57"></a><span id="l28.57">     }</span>
<a href="#l28.58"></a><span id="l28.58"> </span>
<a href="#l28.59"></a><span id="l28.59">     for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l28.60"></a><span id="l28.60">       print(</span>
<a href="#l28.61"></a><span id="l28.61">         &quot;... expected &quot; +</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineat">@@ -247,10 +237,12 @@ function run_test() {</span>
<a href="#l28.63"></a><span id="l28.63">     Assert.equal(obs._result.matchCount, element.expected.length);</span>
<a href="#l28.64"></a><span id="l28.64"> </span>
<a href="#l28.65"></a><span id="l28.65">     for (let i = 0; i &lt; element.expected.length; ++i) {</span>
<a href="#l28.66"></a><span id="l28.66">       Assert.equal(obs._result.getValueAt(i), cards[element.expected[i]].value);</span>
<a href="#l28.67"></a><span id="l28.67">       Assert.equal(obs._result.getLabelAt(i), cards[element.expected[i]].value);</span>
<a href="#l28.68"></a><span id="l28.68">     }</span>
<a href="#l28.69"></a><span id="l28.69">   }</span>
<a href="#l28.70"></a><span id="l28.70"> </span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-  inputs.forEach(checkInputItem);</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-}</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+  for (let i = 0; i &lt; inputs.length; i++) {</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+    await checkInputItem(inputs[i], i);</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+  }</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbAutoCompleteSearch7.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -22,28 +22,16 @@ var results = [</span>
<a href="#l29.4"></a><span id="l29.4"> var inputs = [</span>
<a href="#l29.5"></a><span id="l29.5">   [</span>
<a href="#l29.6"></a><span id="l29.6">     { search: &quot;t&quot;, expected: [2, 3, 0, 1, 4] },</span>
<a href="#l29.7"></a><span id="l29.7">     { search: &quot;tom&quot;, expected: [0, 1, 2, 3, 4] },</span>
<a href="#l29.8"></a><span id="l29.8">     { search: &quot;tomek&quot;, expected: [4] },</span>
<a href="#l29.9"></a><span id="l29.9">   ],</span>
<a href="#l29.10"></a><span id="l29.10"> ];</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-function acObserver() {}</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-acObserver.prototype = {</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-  _search: null,</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-  _result: null,</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-  onSearchResult(aSearch, aResult) {</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-    this._search = aSearch;</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-    this._result = aResult;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-  },</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-};</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-</span>
<a href="#l29.24"></a><span id="l29.24"> var PAB_CARD_DATA = [</span>
<a href="#l29.25"></a><span id="l29.25">   {</span>
<a href="#l29.26"></a><span id="l29.26">     FirstName: &quot;Tomas&quot;,</span>
<a href="#l29.27"></a><span id="l29.27">     LastName: &quot;Doe&quot;,</span>
<a href="#l29.28"></a><span id="l29.28">     DisplayName: &quot;Tomas Doe&quot;,</span>
<a href="#l29.29"></a><span id="l29.29">     NickName: &quot;tom&quot;,</span>
<a href="#l29.30"></a><span id="l29.30">     PrimaryEmail: &quot;tomez.doe@foo.invalid&quot;,</span>
<a href="#l29.31"></a><span id="l29.31">     SecondEmail: &quot;tomez.doe@foo2.invalid&quot;,</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineat">@@ -97,35 +85,37 @@ function setupAddressBookData(aDirURI, a</span>
<a href="#l29.33"></a><span id="l29.33">     list.isMailList = true;</span>
<a href="#l29.34"></a><span id="l29.34">     for (var prop in ld) {</span>
<a href="#l29.35"></a><span id="l29.35">       list[prop] = ld[prop];</span>
<a href="#l29.36"></a><span id="l29.36">     }</span>
<a href="#l29.37"></a><span id="l29.37">     ab.addMailList(list);</span>
<a href="#l29.38"></a><span id="l29.38">   });</span>
<a href="#l29.39"></a><span id="l29.39"> }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-function run_test() {</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l29.43"></a><span id="l29.43">   // Set up addresses for in the personal address book.</span>
<a href="#l29.44"></a><span id="l29.44">   setupAddressBookData(kPABData.URI, PAB_CARD_DATA, []);</span>
<a href="#l29.45"></a><span id="l29.45"> </span>
<a href="#l29.46"></a><span id="l29.46">   // Test - Create a new search component</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48">   var acs = Cc[&quot;@mozilla.org/autocomplete/search;1?name=addrbook&quot;].getService(</span>
<a href="#l29.49"></a><span id="l29.49">     Ci.nsIAutoCompleteSearch</span>
<a href="#l29.50"></a><span id="l29.50">   );</span>
<a href="#l29.51"></a><span id="l29.51"> </span>
<a href="#l29.52"></a><span id="l29.52">   var obs = new acObserver();</span>
<a href="#l29.53"></a><span id="l29.53"> </span>
<a href="#l29.54"></a><span id="l29.54">   let param = JSON.stringify({ type: &quot;addr_to&quot; });</span>
<a href="#l29.55"></a><span id="l29.55"> </span>
<a href="#l29.56"></a><span id="l29.56">   // Now check multiple matches</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  function checkInputItem(element, index, array) {</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+  async function checkInputItem(element, index) {</span>
<a href="#l29.59"></a><span id="l29.59">     let prevRes = obs._result;</span>
<a href="#l29.60"></a><span id="l29.60">     print(&quot;Search #&quot; + index + &quot;: search=&quot; + element.search);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+    let resultPromise = obs.waitForResult();</span>
<a href="#l29.62"></a><span id="l29.62">     acs.startSearch(element.search, param, prevRes, obs);</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+    await resultPromise;</span>
<a href="#l29.64"></a><span id="l29.64"> </span>
<a href="#l29.65"></a><span id="l29.65">     for (let i = 0; i &lt; obs._result.matchCount; i++) {</span>
<a href="#l29.66"></a><span id="l29.66">       print(&quot;... got &quot; + i + &quot;: &quot; + obs._result.getValueAt(i));</span>
<a href="#l29.67"></a><span id="l29.67">     }</span>
<a href="#l29.68"></a><span id="l29.68">     for (let i = 0; i &lt; element.expected.length; i++) {</span>
<a href="#l29.69"></a><span id="l29.69">       print(</span>
<a href="#l29.70"></a><span id="l29.70">         &quot;... expected &quot; +</span>
<a href="#l29.71"></a><span id="l29.71">           i +</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineat">@@ -152,14 +142,15 @@ function run_test() {</span>
<a href="#l29.73"></a><span id="l29.73">         obs._result.getLabelAt(i),</span>
<a href="#l29.74"></a><span id="l29.74">         results[element.expected[i]].email</span>
<a href="#l29.75"></a><span id="l29.75">       );</span>
<a href="#l29.76"></a><span id="l29.76">       Assert.equal(obs._result.getCommentAt(i), &quot;&quot;);</span>
<a href="#l29.77"></a><span id="l29.77">       Assert.equal(obs._result.getStyleAt(i), &quot;local-abook&quot;);</span>
<a href="#l29.78"></a><span id="l29.78">       Assert.equal(obs._result.getImageAt(i), &quot;&quot;);</span>
<a href="#l29.79"></a><span id="l29.79">     }</span>
<a href="#l29.80"></a><span id="l29.80">   }</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-  function checkInputSet(element, index, array) {</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-    element.forEach(checkInputItem);</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+  for (let inputSet of inputs) {</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+    for (let i = 0; i &lt; inputSet.length; i++) {</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+      await checkInputItem(inputSet[i], i);</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+    }</span>
<a href="#l29.88"></a><span id="l29.88">   }</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-  inputs.forEach(checkInputSet);</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-}</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_search.js</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+const { getModelQuery, generateQueryURI } = ChromeUtils.import(</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  &quot;resource:///modules/ABQueryUtils.jsm&quot;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+const jsonFile = do_get_file(&quot;data/ldap_contacts.json&quot;);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+  let contents = await OS.File.read(jsonFile.path);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  let contacts = await JSON.parse(new TextDecoder().decode(contents));</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+  let dirPrefId = MailServices.ab.newAddressBook(&quot;new book&quot;, &quot;&quot;, 101);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+  let book = MailServices.ab.getDirectoryFromId(dirPrefId);</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+  for (let [name, { attributes }] of Object.entries(contacts)) {</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+    let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+      Ci.nsIAbCard</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+    );</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+    card.displayName = attributes.cn;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+    card.firstName = attributes.givenName;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+    card.lastName = attributes.sn;</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+    card.primaryEmail = attributes.mail;</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+    contacts[name] = book.addCard(card);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+  }</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+  let doSearch = async function(searchString, ...expectedContacts) {</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+    let foundCards = await new Promise(resolve =&gt; {</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+      let listener = {</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+        cards: [],</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+        onSearchFoundCard(card) {</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+          this.cards.push(card);</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+        },</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+        onSearchFinished(result, errorMessage) {</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+          resolve(this.cards);</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+        },</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+      };</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+      book.search(searchString, listener);</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+    });</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+    Assert.equal(foundCards.length, expectedContacts.length);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+    for (let name of expectedContacts) {</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+      Assert.ok(foundCards.find(c =&gt; c.equals(contacts[name])));</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+    }</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+  };</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+  await doSearch(&quot;(DisplayName,c,watson)&quot;, &quot;john&quot;, &quot;mary&quot;);</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+  let modelQuery = getModelQuery(&quot;mail.addr_book.autocompletequery.format&quot;);</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+  await doSearch(</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    generateQueryURI(modelQuery, [&quot;holmes&quot;]),</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+    &quot;eurus&quot;,</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+    &quot;mycroft&quot;,</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+    &quot;sherlock&quot;</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+  );</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+  await doSearch(generateQueryURI(modelQuery, [&quot;adler&quot;]), &quot;irene&quot;);</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+  await doSearch(generateQueryURI(modelQuery, [&quot;redbeard&quot;]));</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -33,8 +33,9 @@ skip-if = debug # Fails for unknown reas</span>
<a href="#l31.4"></a><span id="l31.4"> [test_nsAbAutoCompleteSearch6.js]</span>
<a href="#l31.5"></a><span id="l31.5"> [test_nsAbAutoCompleteSearch7.js]</span>
<a href="#l31.6"></a><span id="l31.6"> [test_nsAbManager1.js]</span>
<a href="#l31.7"></a><span id="l31.7"> [test_nsAbManager2.js]</span>
<a href="#l31.8"></a><span id="l31.8"> [test_nsAbManager3.js]</span>
<a href="#l31.9"></a><span id="l31.9"> [test_nsAbManager4.js]</span>
<a href="#l31.10"></a><span id="l31.10"> [test_nsAbManager5.js]</span>
<a href="#l31.11"></a><span id="l31.11"> [test_nsIAbCard.js]</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+[test_search.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/jar.mn</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/jar.mn</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -7,16 +7,17 @@ messenger.jar:</span>
<a href="#l32.4"></a><span id="l32.4">     content/messenger/addressbook/pref-directory-add.xhtml                     (addrbook/prefs/content/pref-directory-add.xhtml)</span>
<a href="#l32.5"></a><span id="l32.5">     content/messenger/addressbook/pref-editdirectories.js                      (addrbook/prefs/content/pref-editdirectories.js)</span>
<a href="#l32.6"></a><span id="l32.6">     content/messenger/addressbook/pref-editdirectories.xhtml                   (addrbook/prefs/content/pref-editdirectories.xhtml)</span>
<a href="#l32.7"></a><span id="l32.7">     content/messenger/addressbook/abAddressBookNameDialog.js                   (addrbook/content/abAddressBookNameDialog.js)</span>
<a href="#l32.8"></a><span id="l32.8">     content/messenger/addressbook/abAddressBookNameDialog.xhtml                (addrbook/content/abAddressBookNameDialog.xhtml)</span>
<a href="#l32.9"></a><span id="l32.9">     content/messenger/addressbook/abResultsPane.js                             (addrbook/content/abResultsPane.js)</span>
<a href="#l32.10"></a><span id="l32.10">     content/messenger/addressbook/abDragDrop.js                                (addrbook/content/abDragDrop.js)</span>
<a href="#l32.11"></a><span id="l32.11">     content/messenger/addressbook/abMailListDialog.js                          (addrbook/content/abMailListDialog.js)</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+    content/messenger/addressbook/abView.js                                    (addrbook/content/abView.js)</span>
<a href="#l32.13"></a><span id="l32.13">     content/messenger/addressbook/map-list.js                                  (addrbook/content/map-list.js)</span>
<a href="#l32.14"></a><span id="l32.14">     content/messagebody/addressbook/print.css                                  (addrbook/content/print.css)</span>
<a href="#l32.15"></a><span id="l32.15"> *   content/messenger/AccountManager.xhtml                                     (base/prefs/content/AccountManager.xhtml)</span>
<a href="#l32.16"></a><span id="l32.16">     content/messenger/AccountManager.js                                        (base/prefs/content/AccountManager.js)</span>
<a href="#l32.17"></a><span id="l32.17">     content/messenger/am-main.xhtml                                            (base/prefs/content/am-main.xhtml)</span>
<a href="#l32.18"></a><span id="l32.18">     content/messenger/am-main.js                                               (base/prefs/content/am-main.js)</span>
<a href="#l32.19"></a><span id="l32.19"> #ifdef MOZ_SUITE</span>
<a href="#l32.20"></a><span id="l32.20">     content/messenger/am-help.js                                               (base/prefs/content/am-help.js)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

