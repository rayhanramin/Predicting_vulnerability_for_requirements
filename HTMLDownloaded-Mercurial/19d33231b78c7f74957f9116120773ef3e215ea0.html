<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25950:19d33231b78c7f74957f9116120773ef3e215ea0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 19d33231b78c7f74957f9116120773ef3e215ea0" />
<meta property="og:url" content="/comm-central/rev/19d33231b78c7f74957f9116120773ef3e215ea0" />
<meta property="og:description" content="Bug 1525190 - Run eslint --fix over chat modules code. r=florian" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 19d33231b78c7f74957f9116120773ef3e215ea0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/19d33231b78c7f74957f9116120773ef3e215ea0">shortlog</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/19d33231b78c7f74957f9116120773ef3e215ea0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0">files</a> |
changeset |
<a href="/comm-central/raw-rev/19d33231b78c7f74957f9116120773ef3e215ea0">raw</a>  | <a href="/comm-central/archive/19d33231b78c7f74957f9116120773ef3e215ea0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over chat modules code. r=florian
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 27 Feb 2019 08:11:42 -0500</td></tr>

<tr>
 <td>changeset 25950</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/19d33231b78c7f74957f9116120773ef3e215ea0">19d33231b78c7f74957f9116120773ef3e215ea0</a></td>
</tr>



<tr>
<td>parent 25949</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e0d601d1f154aed11ec1ea796c9553ab246ee129">e0d601d1f154aed11ec1ea796c9553ab246ee129</a>
</td>
</tr>

<tr>
<td>child 25951</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5b2feb6ef34995790afd24631089fbb41db101fa">5b2feb6ef34995790afd24631089fbb41db101fa</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=19d33231b78c7f74957f9116120773ef3e215ea0">15574</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Feb 2019 13:12:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@19d33231b78c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19d33231b78c7f74957f9116120773ef3e215ea0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19d33231b78c7f74957f9116120773ef3e215ea0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19d33231b78c7f74957f9116120773ef3e215ea0&newProject=comm-central&newRevision=19d33231b78c7f74957f9116120773ef3e215ea0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19d33231b78c7f74957f9116120773ef3e215ea0&newProject=comm-central&newRevision=19d33231b78c7f74957f9116120773ef3e215ea0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19d33231b78c7f74957f9116120773ef3e215ea0&newProject=comm-central&newRevision=19d33231b78c7f74957f9116120773ef3e215ea0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">1525190</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1525190">Bug 1525190</a> - Run eslint --fix over chat modules code. r=florian</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">chat/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">chat/content/conversation-browser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/conversation-browser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">chat/content/imAccountOptionsHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/content/imAccountOptionsHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">chat/modules/DNS.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/DNS.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">chat/modules/NormalizedMap.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/NormalizedMap.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">chat/modules/ToLocaleFormat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/ToLocaleFormat.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">chat/modules/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imStatusUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">chat/modules/test/test_filtering.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">file</a> |
<a href="/comm-central/annotate/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">annotate</a> |
<a href="/comm-central/diff/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">diff</a> |
<a href="/comm-central/comparison/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">comparison</a> |
<a href="/comm-central/log/19d33231b78c7f74957f9116120773ef3e215ea0/chat/modules/test/test_filtering.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/content/browserRequest.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/content/browserRequest.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -23,60 +23,60 @@ var reporterListener = {</span>
<a href="#l1.4"></a><span id="l1.4">   get securityDisplay() {</span>
<a href="#l1.5"></a><span id="l1.5">     delete this.securityDisplay;</span>
<a href="#l1.6"></a><span id="l1.6">     return this.securityDisplay = document.getElementById(&quot;security-display&quot;);</span>
<a href="#l1.7"></a><span id="l1.7">   },</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l1.10"></a><span id="l1.10">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  onStateChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                          /*in nsIRequest*/ aRequest,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                          /*in unsigned long*/ aStateFlags,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-                          /*in nsresult*/ aStatus) {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  onStateChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                /* in nsIRequest */ aRequest,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+                /* in unsigned long */ aStateFlags,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+                /* in nsresult */ aStatus) {</span>
<a href="#l1.20"></a><span id="l1.20">     if (aStateFlags &amp; wpl.STATE_START &amp;&amp;</span>
<a href="#l1.21"></a><span id="l1.21">         aStateFlags &amp; wpl.STATE_IS_NETWORK) {</span>
<a href="#l1.22"></a><span id="l1.22">       this.statusMeter.value = 0;</span>
<a href="#l1.23"></a><span id="l1.23">       this.statusMeter.parentNode.collapsed = false;</span>
<a href="#l1.24"></a><span id="l1.24">       this.securityLabel.collapsed = true;</span>
<a href="#l1.25"></a><span id="l1.25">     }</span>
<a href="#l1.26"></a><span id="l1.26">     else if (aStateFlags &amp; wpl.STATE_STOP &amp;&amp;</span>
<a href="#l1.27"></a><span id="l1.27">              aStateFlags &amp; wpl.STATE_IS_NETWORK) {</span>
<a href="#l1.28"></a><span id="l1.28">       this.statusMeter.parentNode.collapsed = true;</span>
<a href="#l1.29"></a><span id="l1.29">       this.securityLabel.collapsed = false;</span>
<a href="#l1.30"></a><span id="l1.30">     }</span>
<a href="#l1.31"></a><span id="l1.31">   },</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  onProgressChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-                             /*in nsIRequest*/ aRequest,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-                             /*in long*/ aCurSelfProgress,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-                             /*in long */aMaxSelfProgress,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-                             /*in long */aCurTotalProgress,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-                             /*in long */aMaxTotalProgress) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  onProgressChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                   /* in nsIRequest */ aRequest,</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+                   /* in long */ aCurSelfProgress,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+                   /* in long */ aMaxSelfProgress,</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                   /* in long */ aCurTotalProgress,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                   /* in long */ aMaxTotalProgress) {</span>
<a href="#l1.45"></a><span id="l1.45">     if (aMaxTotalProgress &gt; 0) {</span>
<a href="#l1.46"></a><span id="l1.46">       let percentage = (aCurTotalProgress * 100) / aMaxTotalProgress;</span>
<a href="#l1.47"></a><span id="l1.47">       this.statusMeter.value = percentage;</span>
<a href="#l1.48"></a><span id="l1.48">     }</span>
<a href="#l1.49"></a><span id="l1.49">   },</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  onLocationChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-                             /*in nsIRequest*/ aRequest,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-                             /*in nsIURI*/ aLocation) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-    this.securityDisplay.setAttribute('label', aLocation.host);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  onLocationChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                   /* in nsIRequest */ aRequest,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                   /* in nsIURI */ aLocation) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    this.securityDisplay.setAttribute(&quot;label&quot;, aLocation.host);</span>
<a href="#l1.59"></a><span id="l1.59">   },</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  onStatusChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-                           /*in nsIRequest*/ aRequest,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-                           /*in nsresult*/ aStatus,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-                           /*in wstring*/ aMessage) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  onStatusChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+                 /* in nsIRequest */ aRequest,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                 /* in nsresult */ aStatus,</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+                 /* in wstring */ aMessage) {</span>
<a href="#l1.69"></a><span id="l1.69">   },</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-  onSecurityChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-                             /*in nsIRequest*/ aRequest,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-                             /*in unsigned long*/ aState) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  onSecurityChange(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+                   /* in nsIRequest */ aRequest,</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+                   /* in unsigned long */ aState) {</span>
<a href="#l1.77"></a><span id="l1.77">     const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l1.78"></a><span id="l1.78">                               wpl.STATE_IS_BROKEN |</span>
<a href="#l1.79"></a><span id="l1.79">                               wpl.STATE_IS_INSECURE;</span>
<a href="#l1.80"></a><span id="l1.80">     let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l1.81"></a><span id="l1.81">     let level;</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">     switch (aState &amp; wpl_security_bits) {</span>
<a href="#l1.84"></a><span id="l1.84">       case wpl.STATE_IS_SECURE:</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineat">@@ -93,21 +93,21 @@ var reporterListener = {</span>
<a href="#l1.86"></a><span id="l1.86">     } else {</span>
<a href="#l1.87"></a><span id="l1.87">       this.securityButton.hidden = true;</span>
<a href="#l1.88"></a><span id="l1.88">       this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l1.89"></a><span id="l1.89">     }</span>
<a href="#l1.90"></a><span id="l1.90">     this.securityButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l1.91"></a><span id="l1.91">                                      browser.securityUI.tooltipText);</span>
<a href="#l1.92"></a><span id="l1.92">   },</span>
<a href="#l1.93"></a><span id="l1.93"> </span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  onContentBlockingEvent: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-                                   /*in nsIRequest*/ aRequest,</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-                                   /*in unsigned long*/ aEvent) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  }</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-}</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  onContentBlockingEvent(/* in nsIWebProgress */ aWebProgress,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+                         /* in nsIRequest */ aRequest,</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+                         /* in unsigned long */ aEvent) {</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  },</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+};</span>
<a href="#l1.104"></a><span id="l1.104"> </span>
<a href="#l1.105"></a><span id="l1.105"> function cancelRequest()</span>
<a href="#l1.106"></a><span id="l1.106"> {</span>
<a href="#l1.107"></a><span id="l1.107">   reportUserClosed();</span>
<a href="#l1.108"></a><span id="l1.108">   window.close();</span>
<a href="#l1.109"></a><span id="l1.109"> }</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111"> function reportUserClosed()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/content/conversation-browser.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/content/conversation-browser.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> &quot;use strict&quot;;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> /* global MozXULElement */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> var { initHTMLDocument, serializeSelection, getCurrentTheme, isNextMessage, getHTMLForMessage, insertHTMLForMessage } = ChromeUtils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> var { smileTextNode } = ChromeUtils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> var { cleanupImMarkup } = ChromeUtils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-(function () {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+(function() {</span>
<a href="#l2.14"></a><span id="l2.14">   // &lt;browser&gt; is lazily set up through setElementCreationCallback,</span>
<a href="#l2.15"></a><span id="l2.15">   // i.e. put into customElements the first time it's really seen.</span>
<a href="#l2.16"></a><span id="l2.16">   // Create a fake to ensure browser exists in customElements, since otherwise</span>
<a href="#l2.17"></a><span id="l2.17">   // we can't extend it. Then make sure this fake doesn't stay around.</span>
<a href="#l2.18"></a><span id="l2.18">   if (!customElements.get(&quot;browser&quot;)) {</span>
<a href="#l2.19"></a><span id="l2.19">     delete document.createElement(&quot;browser&quot;);</span>
<a href="#l2.20"></a><span id="l2.20">   }</span>
<a href="#l2.21"></a><span id="l2.21"> })();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -115,17 +115,17 @@ class MozConversationBrowser extends cus</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">       // loadURI can throw if the default browser is misconfigured.</span>
<a href="#l2.25"></a><span id="l2.25">       Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l2.26"></a><span id="l2.26">         .getService(Ci.nsIExternalProtocolService)</span>
<a href="#l2.27"></a><span id="l2.27">         .loadURI(uri);</span>
<a href="#l2.28"></a><span id="l2.28">     });</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">     this.addEventListener(&quot;keypress&quot;, (event) =&gt; {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      switch(event.keyCode) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+      switch (event.keyCode) {</span>
<a href="#l2.33"></a><span id="l2.33">         case KeyEvent.DOM_VK_PAGE_UP: {</span>
<a href="#l2.34"></a><span id="l2.34">           if (event.shiftKey) {</span>
<a href="#l2.35"></a><span id="l2.35">             this.contentWindow.scrollByPages(-1);</span>
<a href="#l2.36"></a><span id="l2.36">           } else if (event.altKey) {</span>
<a href="#l2.37"></a><span id="l2.37">             this.scrollToPreviousSection();</span>
<a href="#l2.38"></a><span id="l2.38">           }</span>
<a href="#l2.39"></a><span id="l2.39">           break;</span>
<a href="#l2.40"></a><span id="l2.40">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/content/imAccountOptionsHelper.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/content/imAccountOptionsHelper.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> var accountOptionsHelper = {</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-  createTextbox: function(aType, aValue, aLabel, aName, aContainerType) {</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  createTextbox(aType, aValue, aLabel, aName, aContainerType) {</span>
<a href="#l3.11"></a><span id="l3.11">     let container = document.createElement(aContainerType);</span>
<a href="#l3.12"></a><span id="l3.12">     if (aContainerType == &quot;row&quot;)</span>
<a href="#l3.13"></a><span id="l3.13">       container.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">     let label = document.createElement(&quot;label&quot;);</span>
<a href="#l3.16"></a><span id="l3.16">     label.textContent = aLabel;</span>
<a href="#l3.17"></a><span id="l3.17">     label.setAttribute(&quot;control&quot;, aName);</span>
<a href="#l3.18"></a><span id="l3.18">     container.appendChild(label);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineat">@@ -19,17 +19,17 @@ var accountOptionsHelper = {</span>
<a href="#l3.20"></a><span id="l3.20">     textbox.setAttribute(&quot;value&quot;, aValue);</span>
<a href="#l3.21"></a><span id="l3.21">     textbox.setAttribute(&quot;id&quot;, aName);</span>
<a href="#l3.22"></a><span id="l3.22">     textbox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">     container.appendChild(textbox);</span>
<a href="#l3.25"></a><span id="l3.25">     return container;</span>
<a href="#l3.26"></a><span id="l3.26">   },</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  createMenulist: function(aList, aLabel, aName) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  createMenulist(aList, aLabel, aName) {</span>
<a href="#l3.30"></a><span id="l3.30">     let vbox = document.createElement(&quot;vbox&quot;);</span>
<a href="#l3.31"></a><span id="l3.31">     vbox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33">     let label = document.createElement(&quot;label&quot;);</span>
<a href="#l3.34"></a><span id="l3.34">     label.setAttribute(&quot;value&quot;, aLabel);</span>
<a href="#l3.35"></a><span id="l3.35">     label.setAttribute(&quot;control&quot;, aName);</span>
<a href="#l3.36"></a><span id="l3.36">     vbox.appendChild(label);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38" class="difflineat">@@ -46,17 +46,17 @@ var accountOptionsHelper = {</span>
<a href="#l3.39"></a><span id="l3.39">     }</span>
<a href="#l3.40"></a><span id="l3.40">     vbox.appendChild(menulist);</span>
<a href="#l3.41"></a><span id="l3.41">     return vbox;</span>
<a href="#l3.42"></a><span id="l3.42">   },</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">   // Adds options with specific prefix for ids to UI according to their types</span>
<a href="#l3.45"></a><span id="l3.45">   // with optional attributes for each type and returns true if at least one</span>
<a href="#l3.46"></a><span id="l3.46">   // option has been added to UI, otherwise returns false.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  addOptions: function(aIdPrefix, aOptions, aAttributes) {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  addOptions(aIdPrefix, aOptions, aAttributes) {</span>
<a href="#l3.49"></a><span id="l3.49">     let rows = document.getElementById(&quot;protoSpecific&quot;);</span>
<a href="#l3.50"></a><span id="l3.50">     while (rows.hasChildNodes())</span>
<a href="#l3.51"></a><span id="l3.51">       rows.lastChild.remove();</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">     let containerType = &quot;row&quot;;</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     // TB's account options dialog doesn't use a grid element.</span>
<a href="#l3.56"></a><span id="l3.56">     if (rows.localName != &quot;rows&quot;)</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineat">@@ -93,10 +93,10 @@ var accountOptionsHelper = {</span>
<a href="#l3.58"></a><span id="l3.58">       if (aAttributes &amp;&amp; aAttributes[opt.type]) {</span>
<a href="#l3.59"></a><span id="l3.59">         let element = document.getElementById(name);</span>
<a href="#l3.60"></a><span id="l3.60">         for (let attr of aAttributes[opt.type])</span>
<a href="#l3.61"></a><span id="l3.61">           element.setAttribute(attr.name, attr.value);</span>
<a href="#l3.62"></a><span id="l3.62">       }</span>
<a href="#l3.63"></a><span id="l3.63">       haveOptions = true;</span>
<a href="#l3.64"></a><span id="l3.64">     }</span>
<a href="#l3.65"></a><span id="l3.65">     return haveOptions;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  }</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  },</span>
<a href="#l3.68"></a><span id="l3.68"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/modules/DNS.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/modules/DNS.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -21,17 +21,17 @@ var NS_T_SRV = 33; // DNS_TYPE_SRV</span>
<a href="#l4.4"></a><span id="l4.4"> function load_libresolv() {</span>
<a href="#l4.5"></a><span id="l4.5">   this._open();</span>
<a href="#l4.6"></a><span id="l4.6"> }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> load_libresolv.prototype = {</span>
<a href="#l4.9"></a><span id="l4.9">   library: null,</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   // Tries to find and load library.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  _open: function() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  _open() {</span>
<a href="#l4.14"></a><span id="l4.14">     function findLibrary() {</span>
<a href="#l4.15"></a><span id="l4.15">       let lastException = null;</span>
<a href="#l4.16"></a><span id="l4.16">       let libnames =</span>
<a href="#l4.17"></a><span id="l4.17">         [ctypes.libraryName(&quot;resolv.9&quot;), ctypes.libraryName(&quot;resolv&quot;)];</span>
<a href="#l4.18"></a><span id="l4.18">       for (let libname of libnames) {</span>
<a href="#l4.19"></a><span id="l4.19">         try {</span>
<a href="#l4.20"></a><span id="l4.20">           return ctypes.open(libname);</span>
<a href="#l4.21"></a><span id="l4.21">         } catch (ex) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -88,23 +88,23 @@ load_libresolv.prototype = {</span>
<a href="#l4.23"></a><span id="l4.23">     this.QUERYBUF_SIZE = 1024;</span>
<a href="#l4.24"></a><span id="l4.24">     this.NS_MAXCDNAME = 255;</span>
<a href="#l4.25"></a><span id="l4.25">     this.NS_HFIXEDSZ = 12;</span>
<a href="#l4.26"></a><span id="l4.26">     this.NS_QFIXEDSZ = 4;</span>
<a href="#l4.27"></a><span id="l4.27">     this.NS_RRFIXEDSZ = 10;</span>
<a href="#l4.28"></a><span id="l4.28">     this.NS_C_IN = 1;</span>
<a href="#l4.29"></a><span id="l4.29">   },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  close: function() {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  close() {</span>
<a href="#l4.33"></a><span id="l4.33">     this.library.close();</span>
<a href="#l4.34"></a><span id="l4.34">     this.library = null;</span>
<a href="#l4.35"></a><span id="l4.35">   },</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // Maps record to SRVRecord or TXTRecord according to aTypeID and return it.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  _mapAnswer: function(aTypeID, aAnswer, aIdx, aLength) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  _mapAnswer(aTypeID, aAnswer, aIdx, aLength) {</span>
<a href="#l4.40"></a><span id="l4.40">     if (aTypeID == NS_T_SRV) {</span>
<a href="#l4.41"></a><span id="l4.41">       let prio = this.ns_get16(aAnswer.addressOfElement(aIdx));</span>
<a href="#l4.42"></a><span id="l4.42">       let weight = this.ns_get16(aAnswer.addressOfElement(aIdx + 2));</span>
<a href="#l4.43"></a><span id="l4.43">       let port = this.ns_get16(aAnswer.addressOfElement(aIdx + 4));</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">       let hostbuf = ctypes.char.array(this.NS_MAXCDNAME)();</span>
<a href="#l4.46"></a><span id="l4.46">       let hostlen = this.dn_expand(aAnswer.addressOfElement(0),</span>
<a href="#l4.47"></a><span id="l4.47">                                    aAnswer.addressOfElement(aLength),</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -118,17 +118,17 @@ load_libresolv.prototype = {</span>
<a href="#l4.49"></a><span id="l4.49">       let data = ctypes.unsigned_char.ptr(aAnswer.addressOfElement(aIdx + 1));</span>
<a href="#l4.50"></a><span id="l4.50">       return new TXTRecord(data.readString());</span>
<a href="#l4.51"></a><span id="l4.51">     }</span>
<a href="#l4.52"></a><span id="l4.52">     return {};</span>
<a href="#l4.53"></a><span id="l4.53">   },</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   // Performs a DNS query for aTypeID on a certain address (aName) and returns</span>
<a href="#l4.56"></a><span id="l4.56">   // array of records of aTypeID.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  lookup: function(aName, aTypeID) {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  lookup(aName, aTypeID) {</span>
<a href="#l4.59"></a><span id="l4.59">     let qname = ctypes.char.array()(aName);</span>
<a href="#l4.60"></a><span id="l4.60">     let answer = ctypes.unsigned_char.array(this.QUERYBUF_SIZE)();</span>
<a href="#l4.61"></a><span id="l4.61">     let length =</span>
<a href="#l4.62"></a><span id="l4.62">       this.res_search(qname, this.NS_C_IN, aTypeID, answer, this.QUERYBUF_SIZE);</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">     // There is an error.</span>
<a href="#l4.65"></a><span id="l4.65">     if (length &lt; 0)</span>
<a href="#l4.66"></a><span id="l4.66">       return -1;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineat">@@ -158,103 +158,103 @@ load_libresolv.prototype = {</span>
<a href="#l4.68"></a><span id="l4.68">         resource.type = type;</span>
<a href="#l4.69"></a><span id="l4.69">         resource.nsclass = this.ns_get16(answer.addressOfElement(rridx + 2));</span>
<a href="#l4.70"></a><span id="l4.70">         resource.ttl = this.ns_get32(answer.addressOfElement(rridx + 4))|0;</span>
<a href="#l4.71"></a><span id="l4.71">         results.push(resource);</span>
<a href="#l4.72"></a><span id="l4.72">       }</span>
<a href="#l4.73"></a><span id="l4.73">       idx += dataLength;</span>
<a href="#l4.74"></a><span id="l4.74">     }</span>
<a href="#l4.75"></a><span id="l4.75">     return results;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  }</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  },</span>
<a href="#l4.78"></a><span id="l4.78"> };</span>
<a href="#l4.79"></a><span id="l4.79"> </span>
<a href="#l4.80"></a><span id="l4.80"> // For Windows.</span>
<a href="#l4.81"></a><span id="l4.81"> function load_dnsapi() {</span>
<a href="#l4.82"></a><span id="l4.82">   this._open();</span>
<a href="#l4.83"></a><span id="l4.83"> }</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85"> load_dnsapi.prototype = {</span>
<a href="#l4.86"></a><span id="l4.86">   library: null,</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">   // Tries to find and load library.</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-  _open: function() {</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  _open() {</span>
<a href="#l4.91"></a><span id="l4.91">     function declare(aSymbolName, ...aArgs) {</span>
<a href="#l4.92"></a><span id="l4.92">       try {</span>
<a href="#l4.93"></a><span id="l4.93">         return library.declare(aSymbolName, ...aArgs);</span>
<a href="#l4.94"></a><span id="l4.94">       } catch (ex) {</span>
<a href="#l4.95"></a><span id="l4.95">         throw new Error(&quot;Failed to declare &quot; + aSymbolName + &quot; Exception: &quot; +</span>
<a href="#l4.96"></a><span id="l4.96">                         ex + &quot;\n&quot;);</span>
<a href="#l4.97"></a><span id="l4.97">       }</span>
<a href="#l4.98"></a><span id="l4.98">     }</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">     let library = this.library = ctypes.open(ctypes.libraryName(&quot;DnsAPI&quot;));</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102">     this.DNS_SRV_DATA = ctypes.StructType(&quot;DNS_SRV_DATA&quot;, [</span>
<a href="#l4.103"></a><span id="l4.103">       { pNameTarget: ctypes.jschar.ptr },</span>
<a href="#l4.104"></a><span id="l4.104">       { wPriority: ctypes.unsigned_short },</span>
<a href="#l4.105"></a><span id="l4.105">       { wWeight: ctypes.unsigned_short },</span>
<a href="#l4.106"></a><span id="l4.106">       { wPort: ctypes.unsigned_short },</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-      { Pad: ctypes.unsigned_short }</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      { Pad: ctypes.unsigned_short },</span>
<a href="#l4.109"></a><span id="l4.109">     ]);</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111">     this.DNS_TXT_DATA = ctypes.StructType(&quot;DNS_TXT_DATA&quot;, [</span>
<a href="#l4.112"></a><span id="l4.112">       { dwStringCount: ctypes.unsigned_long },</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-      { pStringArray: ctypes.jschar.ptr.array(1) }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+      { pStringArray: ctypes.jschar.ptr.array(1) },</span>
<a href="#l4.115"></a><span id="l4.115">     ]);</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117">     this.DNS_RECORD = ctypes.StructType(&quot;_DnsRecord&quot;);</span>
<a href="#l4.118"></a><span id="l4.118">     this.DNS_RECORD.define([</span>
<a href="#l4.119"></a><span id="l4.119">       { pNext: this.DNS_RECORD.ptr },</span>
<a href="#l4.120"></a><span id="l4.120">       { pName: ctypes.jschar.ptr },</span>
<a href="#l4.121"></a><span id="l4.121">       { wType: ctypes.unsigned_short },</span>
<a href="#l4.122"></a><span id="l4.122">       { wDataLength: ctypes.unsigned_short },</span>
<a href="#l4.123"></a><span id="l4.123">       { Flags: ctypes.unsigned_long },</span>
<a href="#l4.124"></a><span id="l4.124">       { dwTtl: ctypes.unsigned_long },</span>
<a href="#l4.125"></a><span id="l4.125">       { dwReserved: ctypes.unsigned_long },</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-      { Data: this.DNS_SRV_DATA } // its a union, can be cast to many things</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+      { Data: this.DNS_SRV_DATA }, // it's a union, can be cast to many things</span>
<a href="#l4.128"></a><span id="l4.128">     ]);</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">     this.PDNS_RECORD = ctypes.PointerType(this.DNS_RECORD);</span>
<a href="#l4.131"></a><span id="l4.131">     this.DnsQuery_W =</span>
<a href="#l4.132"></a><span id="l4.132">       declare(&quot;DnsQuery_W&quot;, ctypes.winapi_abi, ctypes.long, ctypes.jschar.ptr,</span>
<a href="#l4.133"></a><span id="l4.133">               ctypes.unsigned_short, ctypes.unsigned_long, ctypes.voidptr_t,</span>
<a href="#l4.134"></a><span id="l4.134">               this.PDNS_RECORD.ptr, ctypes.voidptr_t.ptr);</span>
<a href="#l4.135"></a><span id="l4.135">     this.DnsRecordListFree =</span>
<a href="#l4.136"></a><span id="l4.136">       declare(&quot;DnsRecordListFree&quot;, ctypes.winapi_abi, ctypes.void_t,</span>
<a href="#l4.137"></a><span id="l4.137">               this.PDNS_RECORD, ctypes.int);</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139">     this.ERROR_SUCCESS = ctypes.Int64(0);</span>
<a href="#l4.140"></a><span id="l4.140">     this.DNS_QUERY_STANDARD = 0;</span>
<a href="#l4.141"></a><span id="l4.141">     this.DnsFreeRecordList = 1;</span>
<a href="#l4.142"></a><span id="l4.142">   },</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  close: function() {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  close() {</span>
<a href="#l4.146"></a><span id="l4.146">     this.library.close();</span>
<a href="#l4.147"></a><span id="l4.147">     this.library = null;</span>
<a href="#l4.148"></a><span id="l4.148">   },</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150">   // Maps record to SRVRecord or TXTRecord according to aTypeID and return it.</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-  _mapAnswer: function(aTypeID, aData) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  _mapAnswer(aTypeID, aData) {</span>
<a href="#l4.153"></a><span id="l4.153">     if (aTypeID == NS_T_SRV) {</span>
<a href="#l4.154"></a><span id="l4.154">       let srvdata = ctypes.cast(aData, this.DNS_SRV_DATA);</span>
<a href="#l4.155"></a><span id="l4.155">       return new SRVRecord(srvdata.wPriority, srvdata.wWeight,</span>
<a href="#l4.156"></a><span id="l4.156">                            srvdata.pNameTarget.readString(),</span>
<a href="#l4.157"></a><span id="l4.157">                            srvdata.wPort);</span>
<a href="#l4.158"></a><span id="l4.158">     }</span>
<a href="#l4.159"></a><span id="l4.159">     else if (aTypeID == NS_T_TXT) {</span>
<a href="#l4.160"></a><span id="l4.160">       let txtdata = ctypes.cast(aData, this.DNS_TXT_DATA);</span>
<a href="#l4.161"></a><span id="l4.161">       if (txtdata.dwStringCount &gt; 0)</span>
<a href="#l4.162"></a><span id="l4.162">         return new TXTRecord(txtdata.pStringArray[0].readString());</span>
<a href="#l4.163"></a><span id="l4.163">     }</span>
<a href="#l4.164"></a><span id="l4.164">     return {};</span>
<a href="#l4.165"></a><span id="l4.165">   },</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167">   // Performs a DNS query for aTypeID on a certain address (aName) and returns</span>
<a href="#l4.168"></a><span id="l4.168">   // array of records of aTypeID (e.g. SRVRecord or TXTRecord).</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-  lookup: function(aName, aTypeID) {</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  lookup(aName, aTypeID) {</span>
<a href="#l4.171"></a><span id="l4.171">     let queryResultsSet = this.PDNS_RECORD();</span>
<a href="#l4.172"></a><span id="l4.172">     let qname = ctypes.jschar.array()(aName);</span>
<a href="#l4.173"></a><span id="l4.173">     let dnsStatus = this.DnsQuery_W(qname, aTypeID, this.DNS_QUERY_STANDARD,</span>
<a href="#l4.174"></a><span id="l4.174">                                     null, queryResultsSet.address(), null);</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176">     // There is an error.</span>
<a href="#l4.177"></a><span id="l4.177">     if (ctypes.Int64.compare(dnsStatus, this.ERROR_SUCCESS) != 0)</span>
<a href="#l4.178"></a><span id="l4.178">       return -1;</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineat">@@ -269,17 +269,17 @@ load_dnsapi.prototype = {</span>
<a href="#l4.180"></a><span id="l4.180">         resource.nsclass = 0;</span>
<a href="#l4.181"></a><span id="l4.181">         resource.ttl = result.dwTtl | 0;</span>
<a href="#l4.182"></a><span id="l4.182">         results.push(resource);</span>
<a href="#l4.183"></a><span id="l4.183">       }</span>
<a href="#l4.184"></a><span id="l4.184">     }</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">     this.DnsRecordListFree(queryResultsSet, this.DnsFreeRecordList);</span>
<a href="#l4.187"></a><span id="l4.187">     return results;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-  }</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  },</span>
<a href="#l4.190"></a><span id="l4.190"> };</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192"> // Used to make results of different libraries consistent for SRV queries.</span>
<a href="#l4.193"></a><span id="l4.193"> function SRVRecord(aPrio, aWeight, aHost, aPort) {</span>
<a href="#l4.194"></a><span id="l4.194">   this.prio = aPrio;</span>
<a href="#l4.195"></a><span id="l4.195">   this.weight = aWeight;</span>
<a href="#l4.196"></a><span id="l4.196">   this.host = aHost;</span>
<a href="#l4.197"></a><span id="l4.197">   this.port = aPort;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineat">@@ -328,21 +328,21 @@ else {</span>
<a href="#l4.199"></a><span id="l4.199">      * error from the worker.</span>
<a href="#l4.200"></a><span id="l4.200">      *</span>
<a href="#l4.201"></a><span id="l4.201">      * Example: DNS.lookup(&quot;_caldavs._tcp.example.com&quot;, DNS.SRV)</span>
<a href="#l4.202"></a><span id="l4.202">      *</span>
<a href="#l4.203"></a><span id="l4.203">      * @param aName           The aName to look up.</span>
<a href="#l4.204"></a><span id="l4.204">      * @param aTypeID         The RR type to look up as a constant.</span>
<a href="#l4.205"></a><span id="l4.205">      * @return                A promise resolved when completed.</span>
<a href="#l4.206"></a><span id="l4.206">      */</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-    lookup: function(aName, aTypeID) {</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    lookup(aName, aTypeID) {</span>
<a href="#l4.209"></a><span id="l4.209">       let worker = new BasePromiseWorker(LOCATION);</span>
<a href="#l4.210"></a><span id="l4.210">       return worker.post(&quot;execute&quot;,</span>
<a href="#l4.211"></a><span id="l4.211">                          [Services.appinfo.OS, &quot;lookup&quot;, [...arguments]]);</span>
<a href="#l4.212"></a><span id="l4.212">     },</span>
<a href="#l4.213"></a><span id="l4.213"> </span>
<a href="#l4.214"></a><span id="l4.214">     /** Convenience functions */</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-    srv: function(aName) { return this.lookup(aName, NS_T_SRV); },</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    txt: function(aName) { return this.lookup(aName, NS_T_TXT); },</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-  }</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+    srv(aName) { return this.lookup(aName, NS_T_SRV); },</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+    txt(aName) { return this.lookup(aName, NS_T_TXT); },</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  };</span>
<a href="#l4.221"></a><span id="l4.221">   this.DNS = dns_async_front;</span>
<a href="#l4.222"></a><span id="l4.222">   this.EXPORTED_SYMBOLS = [&quot;DNS&quot;];</span>
<a href="#l4.223"></a><span id="l4.223"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/modules/NormalizedMap.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/modules/NormalizedMap.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -33,9 +33,9 @@ class NormalizedMap extends Map {</span>
<a href="#l5.4"></a><span id="l5.4">   // Anything that accepts a key as an input needs to be manually overridden.</span>
<a href="#l5.5"></a><span id="l5.5">   delete(key) { return super.delete(this._normalize(key)); }</span>
<a href="#l5.6"></a><span id="l5.6">   get(key) { return super.get(this._normalize(key)); }</span>
<a href="#l5.7"></a><span id="l5.7">   has(key) { return super.has(this._normalize(key)); }</span>
<a href="#l5.8"></a><span id="l5.8">   set(key, val) {</span>
<a href="#l5.9"></a><span id="l5.9">     super.set(this._normalize(key), val);</span>
<a href="#l5.10"></a><span id="l5.10">     return this;</span>
<a href="#l5.11"></a><span id="l5.11">   }</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-};</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/modules/ToLocaleFormat.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -25,17 +25,17 @@ function DayWithinYear(t) {</span>
<a href="#l6.4"></a><span id="l6.4"> function weekday(aDate, option) {</span>
<a href="#l6.5"></a><span id="l6.5">   return aDate.toLocaleString(undefined, {weekday: option});</span>
<a href="#l6.6"></a><span id="l6.6"> }</span>
<a href="#l6.7"></a><span id="l6.7"> function month(aDate, option) {</span>
<a href="#l6.8"></a><span id="l6.8">   return aDate.toLocaleString(undefined, {month: option});</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> function hourMinSecTwoDigits(aDate) {</span>
<a href="#l6.11"></a><span id="l6.11">   return aDate.toLocaleString(undefined, {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    hour: &quot;2-digit&quot;, minute: &quot;2-digit&quot;, second: &quot;2-digit&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    hour: &quot;2-digit&quot;, minute: &quot;2-digit&quot;, second: &quot;2-digit&quot;,</span>
<a href="#l6.14"></a><span id="l6.14">   });</span>
<a href="#l6.15"></a><span id="l6.15"> }</span>
<a href="#l6.16"></a><span id="l6.16"> function dayPeriod(aDate) {</span>
<a href="#l6.17"></a><span id="l6.17">   let dtf = Intl.DateTimeFormat(undefined, {hour: &quot;2-digit&quot;});</span>
<a href="#l6.18"></a><span id="l6.18">   let dayPeriodPart =</span>
<a href="#l6.19"></a><span id="l6.19">     dtf.resolvedOptions().hour12 &amp;&amp;</span>
<a href="#l6.20"></a><span id="l6.20">     dtf.formatToParts(aDate).find(part =&gt; part.type === &quot;dayPeriod&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">   return dayPeriodPart ? dayPeriodPart.value : &quot;&quot;;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -78,23 +78,23 @@ function timeZoneOffset(aDate) {</span>
<a href="#l6.23"></a><span id="l6.23"> function timeZone(aDate) {</span>
<a href="#l6.24"></a><span id="l6.24">   let dtf = Intl.DateTimeFormat(undefined, {timeZoneName: &quot;short&quot;});</span>
<a href="#l6.25"></a><span id="l6.25">   let timeZoneNamePart = dtf.formatToParts(aDate)</span>
<a href="#l6.26"></a><span id="l6.26">                             .find(part =&gt; part.type === &quot;timeZoneName&quot;);</span>
<a href="#l6.27"></a><span id="l6.27">   return timeZoneNamePart ? timeZoneNamePart.value : &quot;&quot;;</span>
<a href="#l6.28"></a><span id="l6.28"> }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  dateStyle: &quot;full&quot;, timeStyle: &quot;long&quot;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  dateStyle: &quot;full&quot;, timeStyle: &quot;long&quot;,</span>
<a href="#l6.33"></a><span id="l6.33"> });</span>
<a href="#l6.34"></a><span id="l6.34"> const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  dateStyle: &quot;full&quot;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  dateStyle: &quot;full&quot;,</span>
<a href="#l6.37"></a><span id="l6.37"> });</span>
<a href="#l6.38"></a><span id="l6.38"> const timeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  timeStyle: &quot;long&quot;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  timeStyle: &quot;long&quot;,</span>
<a href="#l6.41"></a><span id="l6.41"> });</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> const formatFunctions = {</span>
<a href="#l6.44"></a><span id="l6.44">   a: aDate =&gt; weekday(aDate, &quot;short&quot;),</span>
<a href="#l6.45"></a><span id="l6.45">   A: aDate =&gt; weekday(aDate, &quot;long&quot;),</span>
<a href="#l6.46"></a><span id="l6.46">   b: aDate =&gt; month(aDate, &quot;short&quot;),</span>
<a href="#l6.47"></a><span id="l6.47">   B: aDate =&gt; month(aDate, &quot;long&quot;),</span>
<a href="#l6.48"></a><span id="l6.48">   c: aDate =&gt; dateTimeFormatter.format(aDate),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -15,17 +15,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l7.4"></a><span id="l7.4">                           // an additional thing in a specific</span>
<a href="#l7.5"></a><span id="l7.5">                           // conversation but take into account all</span>
<a href="#l7.6"></a><span id="l7.6">                           // the other global settings.</span>
<a href="#l7.7"></a><span id="l7.7">   &quot;addGlobalAllowedTag&quot;,</span>
<a href="#l7.8"></a><span id="l7.8">   &quot;removeGlobalAllowedTag&quot;,</span>
<a href="#l7.9"></a><span id="l7.9">   &quot;addGlobalAllowedAttribute&quot;,</span>
<a href="#l7.10"></a><span id="l7.10">   &quot;removeGlobalAllowedAttribute&quot;,</span>
<a href="#l7.11"></a><span id="l7.11">   &quot;addGlobalAllowedStyleRule&quot;,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  &quot;removeGlobalAllowedStyleRule&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  &quot;removeGlobalAllowedStyleRule&quot;,</span>
<a href="#l7.14"></a><span id="l7.14"> ];</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> /*</span>
<a href="#l7.17"></a><span id="l7.17">  * Structure of a ruleset:</span>
<a href="#l7.18"></a><span id="l7.18">  * A ruleset is a JS object containing 3 sub-objects: attrs, tags and styles.</span>
<a href="#l7.19"></a><span id="l7.19">  *  - attrs: an object containing a list of attributes allowed for all tags.</span>
<a href="#l7.20"></a><span id="l7.20">  *      example: attrs: { 'style': true }</span>
<a href="#l7.21"></a><span id="l7.21">  *</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -48,123 +48,123 @@ var kAllowedMozClasses =</span>
<a href="#l7.23"></a><span id="l7.23">   aClassName =&gt; aClassName == &quot;moz-txt-underscore&quot; ||</span>
<a href="#l7.24"></a><span id="l7.24">                 aClassName == &quot;moz-txt-tag&quot; ||</span>
<a href="#l7.25"></a><span id="l7.25">                 aClassName == &quot;ib-person&quot;;</span>
<a href="#l7.26"></a><span id="l7.26"> var kAllowedAnchorClasses = aClassName =&gt; aClassName == &quot;ib-person&quot;;</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> /* Tags whose content should be fully removed, and reported in the Error Console. */</span>
<a href="#l7.29"></a><span id="l7.29"> var kForbiddenTags = {</span>
<a href="#l7.30"></a><span id="l7.30">   script: true,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  style: true</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  style: true,</span>
<a href="#l7.33"></a><span id="l7.33"> };</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35"> // in strict mode, remove all formatings. Keep only links and line breaks.</span>
<a href="#l7.36"></a><span id="l7.36"> var kStrictMode = {</span>
<a href="#l7.37"></a><span id="l7.37">   attrs: { },</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   tags: {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    'a': {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-      'title': true,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-      'href': kAllowedURLs,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-      'class': kAllowedAnchorClasses</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    &quot;a&quot;: {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      &quot;title&quot;: true,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l7.48"></a><span id="l7.48">     },</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    'br': true,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    'p': true</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    &quot;br&quot;: true,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    &quot;p&quot;: true,</span>
<a href="#l7.53"></a><span id="l7.53">   },</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  styles: { }</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  styles: { },</span>
<a href="#l7.57"></a><span id="l7.57"> };</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59"> // standard mode allows basic formattings (bold, italic, underlined)</span>
<a href="#l7.60"></a><span id="l7.60"> var kStandardMode = {</span>
<a href="#l7.61"></a><span id="l7.61">   attrs: {</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    'style': true</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    &quot;style&quot;: true,</span>
<a href="#l7.64"></a><span id="l7.64">   },</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">   tags: {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    'div': true,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    'a': {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-      'title': true,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-      'href': kAllowedURLs,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-      'class': kAllowedAnchorClasses</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    &quot;div&quot;: true,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    &quot;a&quot;: {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+      &quot;title&quot;: true,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l7.77"></a><span id="l7.77">     },</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    'em': true,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    'strong': true,</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    'b': true,</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-    'i': true,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    'u': true,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    'span': {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-      'class': kAllowedMozClasses</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    &quot;em&quot;: true,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    &quot;strong&quot;: true,</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    &quot;b&quot;: true,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    &quot;i&quot;: true,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    &quot;u&quot;: true,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    &quot;span&quot;: {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      &quot;class&quot;: kAllowedMozClasses,</span>
<a href="#l7.92"></a><span id="l7.92">     },</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    'br': true,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    'code': true,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    'ul': true,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-    'li': true,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-    'ol': true,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    'cite': true,</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-    'blockquote': true,</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-    'p': true</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    &quot;br&quot;: true,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    &quot;code&quot;: true,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    &quot;ul&quot;: true,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+    &quot;li&quot;: true,</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    &quot;ol&quot;: true,</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+    &quot;cite&quot;: true,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    &quot;blockquote&quot;: true,</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    &quot;p&quot;: true,</span>
<a href="#l7.109"></a><span id="l7.109">   },</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   styles: {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-    'font-style': true,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-    'font-weight': true,</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    'text-decoration-line': true</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  }</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    &quot;font-style&quot;: true,</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+    &quot;font-weight&quot;: true,</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    &quot;text-decoration-line&quot;: true,</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  },</span>
<a href="#l7.120"></a><span id="l7.120"> };</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122"> // permissive mode allows about anything that isn't going to mess up the chat window</span>
<a href="#l7.123"></a><span id="l7.123"> var kPermissiveMode = {</span>
<a href="#l7.124"></a><span id="l7.124">   attrs: {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-    'style': true</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    &quot;style&quot;: true,</span>
<a href="#l7.127"></a><span id="l7.127">   },</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  tags : {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    'div': true,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-    'a': {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-      'title': true,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      'href': kAllowedURLs,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-      'class': kAllowedAnchorClasses</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  tags: {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    &quot;div&quot;: true,</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    &quot;a&quot;: {</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      &quot;title&quot;: true,</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+      &quot;href&quot;: kAllowedURLs,</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+      &quot;class&quot;: kAllowedAnchorClasses,</span>
<a href="#l7.141"></a><span id="l7.141">     },</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-    'font': {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-      'face': true,</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-      'color': true,</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-      'size': true</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    &quot;font&quot;: {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+      &quot;face&quot;: true,</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+      &quot;color&quot;: true,</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+      &quot;size&quot;: true,</span>
<a href="#l7.150"></a><span id="l7.150">     },</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    'em': true,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    'strong': true,</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-    'b': true,</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    'i': true,</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    'u': true,</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-    'span': {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-      'class': kAllowedMozClasses</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    &quot;em&quot;: true,</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    &quot;strong&quot;: true,</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    &quot;b&quot;: true,</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    &quot;i&quot;: true,</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    &quot;u&quot;: true,</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    &quot;span&quot;: {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      &quot;class&quot;: kAllowedMozClasses,</span>
<a href="#l7.165"></a><span id="l7.165">     },</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-    'br': true,</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    'hr': true,</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-    'code': true,</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-    'ul': true,</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-    'li': true,</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    'ol': true,</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    'cite': true,</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-    'blockquote': true,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-    'p': true</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    &quot;br&quot;: true,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    &quot;hr&quot;: true,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    &quot;code&quot;: true,</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+    &quot;ul&quot;: true,</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    &quot;li&quot;: true,</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+    &quot;ol&quot;: true,</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    &quot;cite&quot;: true,</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+    &quot;blockquote&quot;: true,</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+    &quot;p&quot;: true,</span>
<a href="#l7.184"></a><span id="l7.184">   },</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">   // FIXME: should be possible to use functions to filter values</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  styles : {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    'color': true,</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-    'font': true,</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-    'font-family': true,</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-    'font-size': true,</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-    'font-style': true,</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-    'font-weight': true,</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-    'text-decoration-color': true,</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    'text-decoration-style': true,</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    'text-decoration-line': true</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-  }</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  styles: {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    &quot;color&quot;: true,</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    &quot;font&quot;: true,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    &quot;font-family&quot;: true,</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    &quot;font-size&quot;: true,</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    &quot;font-style&quot;: true,</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    &quot;font-weight&quot;: true,</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+    &quot;text-decoration-color&quot;: true,</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    &quot;text-decoration-style&quot;: true,</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+    &quot;text-decoration-line&quot;: true,</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  },</span>
<a href="#l7.209"></a><span id="l7.209"> };</span>
<a href="#l7.210"></a><span id="l7.210"> </span>
<a href="#l7.211"></a><span id="l7.211"> var kModePref = &quot;messenger.options.filterMode&quot;;</span>
<a href="#l7.212"></a><span id="l7.212"> var kModes = [kStrictMode, kStandardMode, kPermissiveMode];</span>
<a href="#l7.213"></a><span id="l7.213"> </span>
<a href="#l7.214"></a><span id="l7.214"> var gGlobalRuleset = null;</span>
<a href="#l7.215"></a><span id="l7.215"> </span>
<a href="#l7.216"></a><span id="l7.216"> function initGlobalRuleset()</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineat">@@ -178,17 +178,17 @@ var styleObserver = {</span>
<a href="#l7.218"></a><span id="l7.218">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l7.219"></a><span id="l7.219">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != kModePref)</span>
<a href="#l7.220"></a><span id="l7.220">       throw &quot;bad notification&quot;;</span>
<a href="#l7.221"></a><span id="l7.221"> </span>
<a href="#l7.222"></a><span id="l7.222">     if (!gGlobalRuleset)</span>
<a href="#l7.223"></a><span id="l7.223">       throw &quot;gGlobalRuleset not initialized&quot;;</span>
<a href="#l7.224"></a><span id="l7.224"> </span>
<a href="#l7.225"></a><span id="l7.225">     setBaseRuleset(getModePref(), gGlobalRuleset);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-  }</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+  },</span>
<a href="#l7.228"></a><span id="l7.228"> };</span>
<a href="#l7.229"></a><span id="l7.229"> </span>
<a href="#l7.230"></a><span id="l7.230"> function getModePref()</span>
<a href="#l7.231"></a><span id="l7.231"> {</span>
<a href="#l7.232"></a><span id="l7.232">   let baseNum = Services.prefs.getIntPref(kModePref);</span>
<a href="#l7.233"></a><span id="l7.233">   if (baseNum &lt; 0 || baseNum &gt; 2)</span>
<a href="#l7.234"></a><span id="l7.234">     baseNum = 1;</span>
<a href="#l7.235"></a><span id="l7.235"> </span>
<a href="#l7.236"></a><span id="l7.236" class="difflineat">@@ -201,17 +201,17 @@ function setBaseRuleset(aBase, aResult)</span>
<a href="#l7.237"></a><span id="l7.237">     aResult[property] = Object.create(aBase[property], aResult[property]);</span>
<a href="#l7.238"></a><span id="l7.238"> }</span>
<a href="#l7.239"></a><span id="l7.239"> </span>
<a href="#l7.240"></a><span id="l7.240"> function newRuleset(aBase)</span>
<a href="#l7.241"></a><span id="l7.241"> {</span>
<a href="#l7.242"></a><span id="l7.242">   let result = {</span>
<a href="#l7.243"></a><span id="l7.243">     tags: {},</span>
<a href="#l7.244"></a><span id="l7.244">     attrs: {},</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-    styles: {}</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    styles: {},</span>
<a href="#l7.247"></a><span id="l7.247">   };</span>
<a href="#l7.248"></a><span id="l7.248">   setBaseRuleset(aBase || getModePref(), result);</span>
<a href="#l7.249"></a><span id="l7.249">   return result;</span>
<a href="#l7.250"></a><span id="l7.250"> }</span>
<a href="#l7.251"></a><span id="l7.251"> </span>
<a href="#l7.252"></a><span id="l7.252"> function createDerivedRuleset()</span>
<a href="#l7.253"></a><span id="l7.253"> {</span>
<a href="#l7.254"></a><span id="l7.254">   if (!gGlobalRuleset)</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineat">@@ -285,17 +285,17 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l7.256"></a><span id="l7.256">           return (rule === true ||</span>
<a href="#l7.257"></a><span id="l7.257">                   (typeof rule == &quot;function&quot; &amp;&amp; rule(aAttr.value)));</span>
<a href="#l7.258"></a><span id="l7.258">       };</span>
<a href="#l7.259"></a><span id="l7.259">       for (let j = 0; j &lt; attrs.length; ++j) {</span>
<a href="#l7.260"></a><span id="l7.260">         let attr = attrs[j];</span>
<a href="#l7.261"></a><span id="l7.261">         // we check both the list of accepted attributes for all tags</span>
<a href="#l7.262"></a><span id="l7.262">         // and the list of accepted attributes for this specific tag.</span>
<a href="#l7.263"></a><span id="l7.263">         if (!(acceptFunction(aRules.attrs, attr) ||</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-              ((typeof aRules.tags[nodeName] ==  &quot;object&quot;) &amp;&amp;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+              ((typeof aRules.tags[nodeName] == &quot;object&quot;) &amp;&amp;</span>
<a href="#l7.266"></a><span id="l7.266">                acceptFunction(aRules.tags[nodeName], attr)))) {</span>
<a href="#l7.267"></a><span id="l7.267">           node.removeAttribute(attr.name);</span>
<a href="#l7.268"></a><span id="l7.268">           --j;</span>
<a href="#l7.269"></a><span id="l7.269">         }</span>
<a href="#l7.270"></a><span id="l7.270">       }</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272">       // cleanup style</span>
<a href="#l7.273"></a><span id="l7.273">       let style = node.style;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineat">@@ -317,17 +317,17 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l7.275"></a><span id="l7.275">         let trailingSemi = false;</span>
<a href="#l7.276"></a><span id="l7.276">         let attrs = node.getAttribute(&quot;style&quot;).trim();</span>
<a href="#l7.277"></a><span id="l7.277">         if (attrs.endsWith(&quot;;&quot;)) {</span>
<a href="#l7.278"></a><span id="l7.278">           attrs = attrs.slice(0, -1);</span>
<a href="#l7.279"></a><span id="l7.279">           trailingSemi = true;</span>
<a href="#l7.280"></a><span id="l7.280">         }</span>
<a href="#l7.281"></a><span id="l7.281">         attrs = attrs.split(&quot;;&quot;).map(a =&gt; a.trim());</span>
<a href="#l7.282"></a><span id="l7.282">         attrs.sort();</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-        node.setAttribute(&quot;style&quot;, attrs.join(&quot;; &quot;) + (trailingSemi?&quot;;&quot;:&quot;&quot;));</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+        node.setAttribute(&quot;style&quot;, attrs.join(&quot;; &quot;) + (trailingSemi ? &quot;;&quot; : &quot;&quot;));</span>
<a href="#l7.285"></a><span id="l7.285">       }</span>
<a href="#l7.286"></a><span id="l7.286">     }</span>
<a href="#l7.287"></a><span id="l7.287">     else {</span>
<a href="#l7.288"></a><span id="l7.288">       // We are on a text node, we need to apply the functions</span>
<a href="#l7.289"></a><span id="l7.289">       // provided in the aTextModifiers array.</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291">       // Each of these function should return the number of nodes added:</span>
<a href="#l7.292"></a><span id="l7.292">       //  * -1 if the current textnode was deleted</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -12,44 +12,44 @@ XPCOMUtils.defineLazyGetter(this, &quot;gText</span>
<a href="#l8.4"></a><span id="l8.4"> ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l8.5"></a><span id="l8.5">                                &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l8.8"></a><span id="l8.8">   &quot;smileImMarkup&quot;, // used to add smile:// img tags into IM markup.</span>
<a href="#l8.9"></a><span id="l8.9">   &quot;smileTextNode&quot;, // used to add smile:// img tags to the content of a textnode</span>
<a href="#l8.10"></a><span id="l8.10">   &quot;smileString&quot;, // used to add smile:// img tags into a string without parsing it as HTML. Be sure the string doesn't contain HTML tags.</span>
<a href="#l8.11"></a><span id="l8.11">   &quot;getSmileRealURI&quot;, // used to retrieve the chrome URI for a smile:// URI</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  &quot;getSmileyList&quot; // used to display a list of smileys in the UI</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  &quot;getSmileyList&quot;, // used to display a list of smileys in the UI</span>
<a href="#l8.14"></a><span id="l8.14"> ];</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> var kEmoticonsThemePref = &quot;messenger.options.emoticonsTheme&quot;;</span>
<a href="#l8.17"></a><span id="l8.17"> var kThemeFile = &quot;theme.json&quot;;</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> Object.defineProperty(this, &quot;gTheme&quot;, {</span>
<a href="#l8.20"></a><span id="l8.20">   configurable: true,</span>
<a href="#l8.21"></a><span id="l8.21">   enumerable: true,</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">   get() {</span>
<a href="#l8.24"></a><span id="l8.24">     delete this.gTheme;</span>
<a href="#l8.25"></a><span id="l8.25">     gPrefObserver.init();</span>
<a href="#l8.26"></a><span id="l8.26">     return this.gTheme = getTheme();</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  }</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  },</span>
<a href="#l8.29"></a><span id="l8.29"> });</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31"> var gPrefObserver = {</span>
<a href="#l8.32"></a><span id="l8.32">   init: function po_init() {</span>
<a href="#l8.33"></a><span id="l8.33">     Services.prefs.addObserver(kEmoticonsThemePref, gPrefObserver);</span>
<a href="#l8.34"></a><span id="l8.34">   },</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l8.37"></a><span id="l8.37">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != kEmoticonsThemePref)</span>
<a href="#l8.38"></a><span id="l8.38">       throw &quot;bad notification&quot;;</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">     gTheme = getTheme();</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  }</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  },</span>
<a href="#l8.43"></a><span id="l8.43"> };</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45"> function getSmileRealURI(aSmile)</span>
<a href="#l8.46"></a><span id="l8.46"> {</span>
<a href="#l8.47"></a><span id="l8.47">   aSmile = Cc[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l8.48"></a><span id="l8.48">              .getService(Ci.nsITextToSubURI)</span>
<a href="#l8.49"></a><span id="l8.49">              .unEscapeURIForUI(&quot;UTF-8&quot;, aSmile);</span>
<a href="#l8.50"></a><span id="l8.50">   if (aSmile in gTheme.iconsHash)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineat">@@ -72,20 +72,20 @@ function getSmileyList(aThemeName)</span>
<a href="#l8.52"></a><span id="l8.52">   return theme.json.smileys.map(addAbsoluteUrls);</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55"> function getTheme(aName)</span>
<a href="#l8.56"></a><span id="l8.56"> {</span>
<a href="#l8.57"></a><span id="l8.57">   let name = aName || Services.prefs.getCharPref(kEmoticonsThemePref);</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   let theme = {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    name: name,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    name,</span>
<a href="#l8.62"></a><span id="l8.62">     iconsHash: null,</span>
<a href="#l8.63"></a><span id="l8.63">     json: null,</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-    regExp: null</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    regExp: null,</span>
<a href="#l8.66"></a><span id="l8.66">   };</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">   if (name == &quot;none&quot;)</span>
<a href="#l8.69"></a><span id="l8.69">     return theme;</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">   if (name == &quot;default&quot;)</span>
<a href="#l8.72"></a><span id="l8.72">     theme.baseUri = &quot;chrome://instantbird-emoticons/skin/&quot;;</span>
<a href="#l8.73"></a><span id="l8.73">   else</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineat">@@ -100,17 +100,17 @@ function getTheme(aName)</span>
<a href="#l8.75"></a><span id="l8.75">     let bytes = NetUtil.readInputStream(stream, stream.available());</span>
<a href="#l8.76"></a><span id="l8.76">     theme.json = JSON.parse(gTextDecoder.decode(bytes));</span>
<a href="#l8.77"></a><span id="l8.77">     stream.close();</span>
<a href="#l8.78"></a><span id="l8.78">     theme.iconsHash = {};</span>
<a href="#l8.79"></a><span id="l8.79">     for (let smiley of theme.json.smileys) {</span>
<a href="#l8.80"></a><span id="l8.80">       for (let textCode of smiley.textCodes)</span>
<a href="#l8.81"></a><span id="l8.81">         theme.iconsHash[textCode] = smiley;</span>
<a href="#l8.82"></a><span id="l8.82">     }</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  } catch(e) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.85"></a><span id="l8.85">     Cu.reportError(e);</span>
<a href="#l8.86"></a><span id="l8.86">   }</span>
<a href="#l8.87"></a><span id="l8.87">   return theme;</span>
<a href="#l8.88"></a><span id="l8.88"> }</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90"> function getRegexp()</span>
<a href="#l8.91"></a><span id="l8.91"> {</span>
<a href="#l8.92"></a><span id="l8.92">   if (gTheme.regExp) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineat">@@ -140,17 +140,17 @@ function getRegexp()</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">   if (!emoticonList.length) {</span>
<a href="#l8.96"></a><span id="l8.96">     // the theme contains no valid emoticon, make sure we will return</span>
<a href="#l8.97"></a><span id="l8.97">     // early next time</span>
<a href="#l8.98"></a><span id="l8.98">     gTheme.iconsHash = null;</span>
<a href="#l8.99"></a><span id="l8.99">     return null;</span>
<a href="#l8.100"></a><span id="l8.100">   }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  gTheme.regExp = new RegExp(emoticonList.join('|'), 'g');</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  gTheme.regExp = new RegExp(emoticonList.join(&quot;|&quot;), &quot;g&quot;);</span>
<a href="#l8.104"></a><span id="l8.104">   return gTheme.regExp;</span>
<a href="#l8.105"></a><span id="l8.105"> }</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107"> // unused. May be useful later to process a string instead of an HTML node</span>
<a href="#l8.108"></a><span id="l8.108"> function smileString(aString)</span>
<a href="#l8.109"></a><span id="l8.109"> {</span>
<a href="#l8.110"></a><span id="l8.110">   const kSmileFormat = '&lt;img class=&quot;ib-img-smile&quot; src=&quot;smile://$&amp;&quot; alt=&quot;$&amp;&quot; title=&quot;$&amp;&quot;/&gt;';</span>
<a href="#l8.111"></a><span id="l8.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/modules/imStatusUtils.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/modules/imStatusUtils.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -32,31 +32,31 @@ statusAttributes[imIStatusInfo.STATUS_AW</span>
<a href="#l9.4"></a><span id="l9.4"> statusAttributes[imIStatusInfo.STATUS_UNAVAILABLE] = &quot;unavailable&quot;;</span>
<a href="#l9.5"></a><span id="l9.5"> statusAttributes[imIStatusInfo.STATUS_AVAILABLE] = &quot;available&quot;;</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> var Status = {</span>
<a href="#l9.8"></a><span id="l9.8">   toAttribute: aStatusType =&gt;</span>
<a href="#l9.9"></a><span id="l9.9">     aStatusType in statusAttributes ? statusAttributes[aStatusType] : &quot;unknown&quot;,</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   _labels: {},</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  toLabel: function(aStatusType, aStatusText) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  toLabel(aStatusType, aStatusText) {</span>
<a href="#l9.14"></a><span id="l9.14">     // aStatusType may be either one of the (integral) imIStatusInfo status</span>
<a href="#l9.15"></a><span id="l9.15">     // constants, or one of the statusAttributes.</span>
<a href="#l9.16"></a><span id="l9.16">     if (!(typeof aStatusType == &quot;string&quot;))</span>
<a href="#l9.17"></a><span id="l9.17">       aStatusType = this.toAttribute(aStatusType);</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">     if (!(aStatusType in this._labels))</span>
<a href="#l9.20"></a><span id="l9.20">       this._labels[aStatusType] = _(aStatusType + &quot;StatusType&quot;);</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">     let label = this._labels[aStatusType];</span>
<a href="#l9.23"></a><span id="l9.23">     if (aStatusText)</span>
<a href="#l9.24"></a><span id="l9.24">       label = _(&quot;statusWithStatusMessage&quot;, label, aStatusText);</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">     return label;</span>
<a href="#l9.27"></a><span id="l9.27">   },</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  toFlag: function(aAttribute) {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  toFlag(aAttribute) {</span>
<a href="#l9.31"></a><span id="l9.31">     for (let flag in statusAttributes)</span>
<a href="#l9.32"></a><span id="l9.32">       if (statusAttributes[flag] == aAttribute)</span>
<a href="#l9.33"></a><span id="l9.33">         return flag;</span>
<a href="#l9.34"></a><span id="l9.34">     return imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  }</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  },</span>
<a href="#l9.37"></a><span id="l9.37"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -6,17 +6,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l10.4"></a><span id="l10.4">   &quot;getCurrentTheme&quot;,</span>
<a href="#l10.5"></a><span id="l10.5">   &quot;getThemeByName&quot;,</span>
<a href="#l10.6"></a><span id="l10.6">   &quot;getHTMLForMessage&quot;,</span>
<a href="#l10.7"></a><span id="l10.7">   &quot;getThemeVariants&quot;,</span>
<a href="#l10.8"></a><span id="l10.8">   &quot;isNextMessage&quot;,</span>
<a href="#l10.9"></a><span id="l10.9">   &quot;insertHTMLForMessage&quot;,</span>
<a href="#l10.10"></a><span id="l10.10">   &quot;initHTMLDocument&quot;,</span>
<a href="#l10.11"></a><span id="l10.11">   &quot;getMessagesForRange&quot;,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  &quot;serializeSelection&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  &quot;serializeSelection&quot;,</span>
<a href="#l10.14"></a><span id="l10.14"> ];</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l10.17"></a><span id="l10.17"> const {DownloadUtils} = ChromeUtils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.19"></a><span id="l10.19"> Cu.importGlobalProperties([&quot;DOMParser&quot;, &quot;Element&quot;]);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> var kMessagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -39,17 +39,17 @@ XPCOMUtils.defineLazyGetter(this, &quot;TXTTo</span>
<a href="#l10.23"></a><span id="l10.23">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l10.24"></a><span id="l10.24">   return aTXT =&gt; cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l10.25"></a><span id="l10.25"> });</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> XPCOMUtils.defineLazyGetter(this, &quot;gTimeFormatter&quot;, () =&gt; {</span>
<a href="#l10.28"></a><span id="l10.28">   return new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l10.29"></a><span id="l10.29">     hour: &quot;2-digit&quot;,</span>
<a href="#l10.30"></a><span id="l10.30">     minute: &quot;2-digit&quot;,</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    second: &quot;2-digit&quot;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    second: &quot;2-digit&quot;,</span>
<a href="#l10.33"></a><span id="l10.33">   });</span>
<a href="#l10.34"></a><span id="l10.34"> });</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36"> ChromeUtils.defineModuleGetter(this,</span>
<a href="#l10.37"></a><span id="l10.37">   &quot;ToLocaleFormat&quot;, &quot;resource:///modules/ToLocaleFormat.jsm&quot;);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39"> var gCurrentTheme = null;</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -84,17 +84,17 @@ function HTMLTheme(aBaseURI)</span>
<a href="#l10.42"></a><span id="l10.42">     statusNext: &quot;NextStatus.html&quot;,</span>
<a href="#l10.43"></a><span id="l10.43">     incomingContent: &quot;Incoming/Content.html&quot;,</span>
<a href="#l10.44"></a><span id="l10.44">     incomingContext: &quot;Incoming/Context.html&quot;,</span>
<a href="#l10.45"></a><span id="l10.45">     incomingNextContent: &quot;Incoming/NextContent.html&quot;,</span>
<a href="#l10.46"></a><span id="l10.46">     incomingNextContext: &quot;Incoming/NextContext.html&quot;,</span>
<a href="#l10.47"></a><span id="l10.47">     outgoingContent: &quot;Outgoing/Content.html&quot;,</span>
<a href="#l10.48"></a><span id="l10.48">     outgoingContext: &quot;Outgoing/Context.html&quot;,</span>
<a href="#l10.49"></a><span id="l10.49">     outgoingNextContent: &quot;Outgoing/NextContent.html&quot;,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    outgoingNextContext: &quot;Outgoing/NextContext.html&quot;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    outgoingNextContext: &quot;Outgoing/NextContext.html&quot;,</span>
<a href="#l10.52"></a><span id="l10.52">   };</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54">   for (let id in files) {</span>
<a href="#l10.55"></a><span id="l10.55">     let html = getChromeFile(aBaseURI + files[id]);</span>
<a href="#l10.56"></a><span id="l10.56">     if (html)</span>
<a href="#l10.57"></a><span id="l10.57">       Object.defineProperty(this, id, {value: html});</span>
<a href="#l10.58"></a><span id="l10.58">   }</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60" class="difflineat">@@ -111,49 +111,49 @@ HTMLTheme.prototype = {</span>
<a href="#l10.61"></a><span id="l10.61">     throw &quot;Incoming/Content.html is a required file&quot;;</span>
<a href="#l10.62"></a><span id="l10.62">   },</span>
<a href="#l10.63"></a><span id="l10.63">   get incomingNextContent() { return this.incomingContent; },</span>
<a href="#l10.64"></a><span id="l10.64">   get outgoingContent() { return this.incomingContent; },</span>
<a href="#l10.65"></a><span id="l10.65">   get outgoingNextContent() { return this.incomingNextContent; },</span>
<a href="#l10.66"></a><span id="l10.66">   get incomingContext() { return this.incomingContent; },</span>
<a href="#l10.67"></a><span id="l10.67">   get incomingNextContext() { return this.incomingNextContent; },</span>
<a href="#l10.68"></a><span id="l10.68">   get outgoingContext() { return this.hasOwnProperty(&quot;outgoingContent&quot;) ? this.outgoingContent : this.incomingContext; },</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  get outgoingNextContext() { return this.hasOwnProperty(&quot;outgoingNextContent&quot;) ? this.outgoingNextContent : this.incomingNextContext; }</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+  get outgoingNextContext() { return this.hasOwnProperty(&quot;outgoingNextContent&quot;) ? this.outgoingNextContent : this.incomingNextContext; },</span>
<a href="#l10.71"></a><span id="l10.71"> };</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73"> function plistToJSON(aElt)</span>
<a href="#l10.74"></a><span id="l10.74"> {</span>
<a href="#l10.75"></a><span id="l10.75">   switch (aElt.localName) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-    case 'true':</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+    case &quot;true&quot;:</span>
<a href="#l10.78"></a><span id="l10.78">       return true;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-    case 'false':</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    case &quot;false&quot;:</span>
<a href="#l10.81"></a><span id="l10.81">       return false;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    case 'string':</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-    case 'data':</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    case &quot;string&quot;:</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+    case &quot;data&quot;:</span>
<a href="#l10.86"></a><span id="l10.86">       return aElt.textContent;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-    case 'real':</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    case &quot;real&quot;:</span>
<a href="#l10.89"></a><span id="l10.89">       return parseFloat(aElt.textContent);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    case 'integer':</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    case &quot;integer&quot;:</span>
<a href="#l10.92"></a><span id="l10.92">       return parseInt(aElt.textContent, 10);</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-    case 'dict':</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+    case &quot;dict&quot;:</span>
<a href="#l10.96"></a><span id="l10.96">       let res = {};</span>
<a href="#l10.97"></a><span id="l10.97">       let nodes = aElt.childNodes;</span>
<a href="#l10.98"></a><span id="l10.98">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-        if (nodes[i].nodeName == 'key') {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+        if (nodes[i].nodeName == &quot;key&quot;) {</span>
<a href="#l10.101"></a><span id="l10.101">           let key = nodes[i].textContent;</span>
<a href="#l10.102"></a><span id="l10.102">           ++i;</span>
<a href="#l10.103"></a><span id="l10.103">           while (!Element.isInstance(nodes[i]))</span>
<a href="#l10.104"></a><span id="l10.104">             ++i;</span>
<a href="#l10.105"></a><span id="l10.105">           res[key] = plistToJSON(nodes[i]);</span>
<a href="#l10.106"></a><span id="l10.106">         }</span>
<a href="#l10.107"></a><span id="l10.107">       }</span>
<a href="#l10.108"></a><span id="l10.108">       return res;</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-    case 'array':</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+    case &quot;array&quot;:</span>
<a href="#l10.112"></a><span id="l10.112">       let array = [];</span>
<a href="#l10.113"></a><span id="l10.113">       nodes = aElt.childNodes;</span>
<a href="#l10.114"></a><span id="l10.114">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l10.115"></a><span id="l10.115">         if (Element.isInstance(nodes[i]))</span>
<a href="#l10.116"></a><span id="l10.116">           array.push(plistToJSON(nodes[i]));</span>
<a href="#l10.117"></a><span id="l10.117">       }</span>
<a href="#l10.118"></a><span id="l10.118">       return array;</span>
<a href="#l10.119"></a><span id="l10.119"> </span>
<a href="#l10.120"></a><span id="l10.120" class="difflineat">@@ -176,17 +176,17 @@ function getInfoPlistContent(aBaseURI)</span>
<a href="#l10.121"></a><span id="l10.121">     if (doc.documentElement.localName != &quot;plist&quot;)</span>
<a href="#l10.122"></a><span id="l10.122">       throw &quot;Invalid Info.plist file&quot;;</span>
<a href="#l10.123"></a><span id="l10.123">     let node = doc.documentElement.firstChild;</span>
<a href="#l10.124"></a><span id="l10.124">     while (node &amp;&amp; !Element.isInstance(node))</span>
<a href="#l10.125"></a><span id="l10.125">       node = node.nextSibling;</span>
<a href="#l10.126"></a><span id="l10.126">     if (!node || node.localName != &quot;dict&quot;)</span>
<a href="#l10.127"></a><span id="l10.127">       throw &quot;Empty or invalid Info.plist file&quot;;</span>
<a href="#l10.128"></a><span id="l10.128">     return plistToJSON(node);</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-  } catch(e) {</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  } catch (e) {</span>
<a href="#l10.131"></a><span id="l10.131">     Cu.reportError(e);</span>
<a href="#l10.132"></a><span id="l10.132">     return null;</span>
<a href="#l10.133"></a><span id="l10.133">   }</span>
<a href="#l10.134"></a><span id="l10.134"> }</span>
<a href="#l10.135"></a><span id="l10.135"> </span>
<a href="#l10.136"></a><span id="l10.136"> function getChromeBaseURI(aThemeName)</span>
<a href="#l10.137"></a><span id="l10.137"> {</span>
<a href="#l10.138"></a><span id="l10.138">   if (DEFAULT_THEMES.includes(aThemeName))</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineat">@@ -199,37 +199,37 @@ function getThemeByName(aName)</span>
<a href="#l10.140"></a><span id="l10.140">   let baseURI = getChromeBaseURI(aName);</span>
<a href="#l10.141"></a><span id="l10.141">   let metadata = getInfoPlistContent(baseURI);</span>
<a href="#l10.142"></a><span id="l10.142">   if (!metadata)</span>
<a href="#l10.143"></a><span id="l10.143">     throw &quot;Cannot load theme &quot; + aName;</span>
<a href="#l10.144"></a><span id="l10.144"> </span>
<a href="#l10.145"></a><span id="l10.145">   return {</span>
<a href="#l10.146"></a><span id="l10.146">     name: aName,</span>
<a href="#l10.147"></a><span id="l10.147">     variant: &quot;default&quot;,</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-    baseURI: baseURI,</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-    metadata: metadata,</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+    baseURI,</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    metadata,</span>
<a href="#l10.152"></a><span id="l10.152">     html: new HTMLTheme(baseURI),</span>
<a href="#l10.153"></a><span id="l10.153">     showHeader: gPrefBranch.getBoolPref(kShowHeaderPref),</span>
<a href="#l10.154"></a><span id="l10.154">     combineConsecutive: gPrefBranch.getBoolPref(kCombineConsecutivePref),</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-    combineConsecutiveInterval: gPrefBranch.getIntPref(kCombineConsecutiveIntervalPref)</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+    combineConsecutiveInterval: gPrefBranch.getIntPref(kCombineConsecutiveIntervalPref),</span>
<a href="#l10.157"></a><span id="l10.157">   };</span>
<a href="#l10.158"></a><span id="l10.158"> }</span>
<a href="#l10.159"></a><span id="l10.159"> </span>
<a href="#l10.160"></a><span id="l10.160"> function getCurrentTheme()</span>
<a href="#l10.161"></a><span id="l10.161"> {</span>
<a href="#l10.162"></a><span id="l10.162">   let name = gPrefBranch.getCharPref(kThemePref);</span>
<a href="#l10.163"></a><span id="l10.163">   let variant = gPrefBranch.getCharPref(kVariantPref);</span>
<a href="#l10.164"></a><span id="l10.164">   if (gCurrentTheme &amp;&amp; gCurrentTheme.name == name &amp;&amp;</span>
<a href="#l10.165"></a><span id="l10.165">       gCurrentTheme.variant == variant)</span>
<a href="#l10.166"></a><span id="l10.166">     return gCurrentTheme;</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168">   try {</span>
<a href="#l10.169"></a><span id="l10.169">     gCurrentTheme = getThemeByName(name);</span>
<a href="#l10.170"></a><span id="l10.170">     gCurrentTheme.variant = variant;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-  } catch(e) {</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  } catch (e) {</span>
<a href="#l10.173"></a><span id="l10.173">     Cu.reportError(e);</span>
<a href="#l10.174"></a><span id="l10.174">     gCurrentTheme = getThemeByName(DEFAULT_THEME);</span>
<a href="#l10.175"></a><span id="l10.175">     gCurrentTheme.variant = &quot;default&quot;;</span>
<a href="#l10.176"></a><span id="l10.176">   }</span>
<a href="#l10.177"></a><span id="l10.177"> </span>
<a href="#l10.178"></a><span id="l10.178">   return gCurrentTheme;</span>
<a href="#l10.179"></a><span id="l10.179"> }</span>
<a href="#l10.180"></a><span id="l10.180"> </span>
<a href="#l10.181"></a><span id="l10.181" class="difflineat">@@ -333,51 +333,51 @@ function getStatusIconFromBuddy(aBuddy)</span>
<a href="#l10.182"></a><span id="l10.182">   return &quot;chrome://chat/skin/&quot; + status + &quot;-16.png&quot;;</span>
<a href="#l10.183"></a><span id="l10.183"> }</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185"> var headerFooterReplacements = {</span>
<a href="#l10.186"></a><span id="l10.186">   chatName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l10.187"></a><span id="l10.187">   sourceName: aConv =&gt; TXTToHTML(aConv.account.alias || aConv.account.name),</span>
<a href="#l10.188"></a><span id="l10.188">   destinationName: aConv =&gt; TXTToHTML(aConv.name),</span>
<a href="#l10.189"></a><span id="l10.189">   destinationDisplayName: aConv =&gt; TXTToHTML(aConv.title),</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-  incomingIconPath: function(aConv) {</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+  incomingIconPath(aConv) {</span>
<a href="#l10.192"></a><span id="l10.192">     let buddy;</span>
<a href="#l10.193"></a><span id="l10.193">     return (!aConv.isChat &amp;&amp; (buddy = aConv.buddy) &amp;&amp;</span>
<a href="#l10.194"></a><span id="l10.194">             buddy.buddyIconFilename) || &quot;incoming_icon.png&quot;;</span>
<a href="#l10.195"></a><span id="l10.195">   },</span>
<a href="#l10.196"></a><span id="l10.196">   outgoingIconPath: aConv =&gt; &quot;outgoing_icon.png&quot;,</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-  timeOpened: function(aConv, aFormat) {</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+  timeOpened(aConv, aFormat) {</span>
<a href="#l10.199"></a><span id="l10.199">     let date = new Date(aConv.startDate / 1000);</span>
<a href="#l10.200"></a><span id="l10.200">     if (aFormat)</span>
<a href="#l10.201"></a><span id="l10.201">       return ToLocaleFormat(aFormat, date);</span>
<a href="#l10.202"></a><span id="l10.202">     return gTimeFormatter.format(date);</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-  }</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+  },</span>
<a href="#l10.205"></a><span id="l10.205"> };</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207"> function formatAutoResponce(aTxt) {</span>
<a href="#l10.208"></a><span id="l10.208">   return Services.strings</span>
<a href="#l10.209"></a><span id="l10.209">                  .createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l10.210"></a><span id="l10.210">                  .formatStringFromName(&quot;autoReply&quot;, [aTxt], 1);</span>
<a href="#l10.211"></a><span id="l10.211"> }</span>
<a href="#l10.212"></a><span id="l10.212"> </span>
<a href="#l10.213"></a><span id="l10.213"> var statusMessageReplacements = {</span>
<a href="#l10.214"></a><span id="l10.214">   message: aMsg =&gt; &quot;&lt;span class=\&quot;ib-msg-txt\&quot;&gt;&quot; +</span>
<a href="#l10.215"></a><span id="l10.215">                    (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l10.216"></a><span id="l10.216">                    &quot;&lt;/span&gt;&quot;,</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-  time: function(aMsg, aFormat) {</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+  time(aMsg, aFormat) {</span>
<a href="#l10.219"></a><span id="l10.219">     let date = new Date(aMsg.time * 1000);</span>
<a href="#l10.220"></a><span id="l10.220">     if (aFormat)</span>
<a href="#l10.221"></a><span id="l10.221">       return ToLocaleFormat(aFormat, date);</span>
<a href="#l10.222"></a><span id="l10.222">     return gTimeFormatter.format(date);</span>
<a href="#l10.223"></a><span id="l10.223">   },</span>
<a href="#l10.224"></a><span id="l10.224">   timestamp: aMsg =&gt; aMsg.time,</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-  shortTime: function(aMsg) {</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+  shortTime(aMsg) {</span>
<a href="#l10.227"></a><span id="l10.227">     return gTimeFormatter.format(new Date(aMsg.time * 1000));</span>
<a href="#l10.228"></a><span id="l10.228">   },</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-  messageClasses: function(aMsg) {</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+  messageClasses(aMsg) {</span>
<a href="#l10.231"></a><span id="l10.231">     let msgClass = [];</span>
<a href="#l10.232"></a><span id="l10.232"> </span>
<a href="#l10.233"></a><span id="l10.233">     if (aMsg.system)</span>
<a href="#l10.234"></a><span id="l10.234">       msgClass.push(&quot;event&quot;);</span>
<a href="#l10.235"></a><span id="l10.235">     else {</span>
<a href="#l10.236"></a><span id="l10.236">       msgClass.push(&quot;message&quot;);</span>
<a href="#l10.237"></a><span id="l10.237"> </span>
<a href="#l10.238"></a><span id="l10.238">       if (aMsg.incoming)</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineat">@@ -399,24 +399,24 @@ var statusMessageReplacements = {</span>
<a href="#l10.240"></a><span id="l10.240">     if (aMsg.delayed)</span>
<a href="#l10.241"></a><span id="l10.241">       msgClass.push(&quot;delayed&quot;);</span>
<a href="#l10.242"></a><span id="l10.242">     if (aMsg.notification)</span>
<a href="#l10.243"></a><span id="l10.243">       msgClass.push(&quot;notification&quot;);</span>
<a href="#l10.244"></a><span id="l10.244">     if (aMsg.noFormat)</span>
<a href="#l10.245"></a><span id="l10.245">       msgClass.push(&quot;monospaced&quot;);</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247">     return msgClass.join(&quot; &quot;);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-  }</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+  },</span>
<a href="#l10.250"></a><span id="l10.250"> };</span>
<a href="#l10.251"></a><span id="l10.251"> </span>
<a href="#l10.252"></a><span id="l10.252"> function formatSender(aName) {</span>
<a href="#l10.253"></a><span id="l10.253">   return &quot;&lt;span class=\&quot;ib-sender\&quot;&gt;&quot; + TXTToHTML(aName) + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l10.254"></a><span id="l10.254"> }</span>
<a href="#l10.255"></a><span id="l10.255"> var messageReplacements = {</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-  userIconPath: function (aMsg) {</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+  userIconPath(aMsg) {</span>
<a href="#l10.258"></a><span id="l10.258">     // If the protocol plugin provides an icon for the message, use it.</span>
<a href="#l10.259"></a><span id="l10.259">     let iconURL = aMsg.iconURL;</span>
<a href="#l10.260"></a><span id="l10.260">     if (iconURL)</span>
<a href="#l10.261"></a><span id="l10.261">       return iconURL;</span>
<a href="#l10.262"></a><span id="l10.262"> </span>
<a href="#l10.263"></a><span id="l10.263">     // For outgoing messages, use the current user icon.</span>
<a href="#l10.264"></a><span id="l10.264">     if (aMsg.outgoing) {</span>
<a href="#l10.265"></a><span id="l10.265">       iconURL = aMsg.conversation.account.statusInfo.getUserIcon();</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineat">@@ -432,29 +432,29 @@ var messageReplacements = {</span>
<a href="#l10.267"></a><span id="l10.267">   senderColor: aMsg =&gt; aMsg.color,</span>
<a href="#l10.268"></a><span id="l10.268">   senderStatusIcon: aMsg =&gt; getStatusIconFromBuddy(getBuddyFromMessage(aMsg)),</span>
<a href="#l10.269"></a><span id="l10.269">   messageDirection: aMsg =&gt; &quot;ltr&quot;,</span>
<a href="#l10.270"></a><span id="l10.270">   // no theme actually use this, don't bother making sure this is the real</span>
<a href="#l10.271"></a><span id="l10.271">   // serverside alias</span>
<a href="#l10.272"></a><span id="l10.272">   senderDisplayName: aMsg =&gt; formatSender(aMsg.alias || aMsg.who),</span>
<a href="#l10.273"></a><span id="l10.273">   service: aMsg =&gt; aMsg.conversation.account.protocol.name,</span>
<a href="#l10.274"></a><span id="l10.274">   textbackgroundcolor: (aMsg, aFormat) =&gt; &quot;transparent&quot;, // FIXME?</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  __proto__: statusMessageReplacements</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+  __proto__: statusMessageReplacements,</span>
<a href="#l10.277"></a><span id="l10.277"> };</span>
<a href="#l10.278"></a><span id="l10.278"> </span>
<a href="#l10.279"></a><span id="l10.279"> var statusReplacements = {</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-  status: aMsg =&gt; &quot;&quot;, //FIXME</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-  statusIcon: function(aMsg) {</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+  status: aMsg =&gt; &quot;&quot;, // FIXME</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  statusIcon(aMsg) {</span>
<a href="#l10.284"></a><span id="l10.284">     let conv = aMsg.conversation;</span>
<a href="#l10.285"></a><span id="l10.285">     let buddy = null;</span>
<a href="#l10.286"></a><span id="l10.286">     if (!conv.isChat)</span>
<a href="#l10.287"></a><span id="l10.287">       buddy = conv.buddy;</span>
<a href="#l10.288"></a><span id="l10.288">     return getStatusIconFromBuddy(buddy);</span>
<a href="#l10.289"></a><span id="l10.289">   },</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-  __proto__: statusMessageReplacements</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  __proto__: statusMessageReplacements,</span>
<a href="#l10.292"></a><span id="l10.292"> };</span>
<a href="#l10.293"></a><span id="l10.293"> </span>
<a href="#l10.294"></a><span id="l10.294"> var kReplacementRegExp = /%([a-zA-Z]*)(\{([^\}]*)\})?%/g;</span>
<a href="#l10.295"></a><span id="l10.295"> </span>
<a href="#l10.296"></a><span id="l10.296"> function replaceKeywordsInHTML(aHTML, aReplacements, aReplacementArg)</span>
<a href="#l10.297"></a><span id="l10.297"> {</span>
<a href="#l10.298"></a><span id="l10.298">   kReplacementRegExp.lastIndex = 0;</span>
<a href="#l10.299"></a><span id="l10.299">   let previousIndex = 0;</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineat">@@ -748,35 +748,34 @@ function serializeSelection(aSelection)</span>
<a href="#l10.301"></a><span id="l10.301">           longSelection.push(message.getFormattedMessage());</span>
<a href="#l10.302"></a><span id="l10.302">       }</span>
<a href="#l10.303"></a><span id="l10.303">     }</span>
<a href="#l10.304"></a><span id="l10.304">     lastMessage = messages[messages.length - 1];</span>
<a href="#l10.305"></a><span id="l10.305">   }</span>
<a href="#l10.306"></a><span id="l10.306"> </span>
<a href="#l10.307"></a><span id="l10.307">   if (shortVersionPossible)</span>
<a href="#l10.308"></a><span id="l10.308">     return shortSelection || aSelection.toString();</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-  else</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-    return longSelection.join(kLineBreak);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+  return longSelection.join(kLineBreak);</span>
<a href="#l10.312"></a><span id="l10.312"> }</span>
<a href="#l10.313"></a><span id="l10.313"> </span>
<a href="#l10.314"></a><span id="l10.314"> function SelectedMessage(aRootNode, aRange)</span>
<a href="#l10.315"></a><span id="l10.315"> {</span>
<a href="#l10.316"></a><span id="l10.316">   this._rootNodes = [aRootNode];</span>
<a href="#l10.317"></a><span id="l10.317">   this._range = aRange;</span>
<a href="#l10.318"></a><span id="l10.318"> }</span>
<a href="#l10.319"></a><span id="l10.319"> </span>
<a href="#l10.320"></a><span id="l10.320"> SelectedMessage.prototype = {</span>
<a href="#l10.321"></a><span id="l10.321">   get msg() { return this._rootNodes[0]._originalMsg; },</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-  addRoot: function(aRootNode) {</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+  addRoot(aRootNode) {</span>
<a href="#l10.324"></a><span id="l10.324">     this._rootNodes.push(aRootNode);</span>
<a href="#l10.325"></a><span id="l10.325">   },</span>
<a href="#l10.326"></a><span id="l10.326"> </span>
<a href="#l10.327"></a><span id="l10.327">   // Helper function that returns the first span node of class</span>
<a href="#l10.328"></a><span id="l10.328">   // ib-msg-text under the rootNodes of the selected message.</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-  _getSpanNode: function() {</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+  _getSpanNode() {</span>
<a href="#l10.331"></a><span id="l10.331">     // first use the cached value if any</span>
<a href="#l10.332"></a><span id="l10.332">     if (this._spanNode)</span>
<a href="#l10.333"></a><span id="l10.333">       return this._spanNode;</span>
<a href="#l10.334"></a><span id="l10.334"> </span>
<a href="#l10.335"></a><span id="l10.335">     let spanNode = null;</span>
<a href="#l10.336"></a><span id="l10.336">     // If we could use NodeFilter.webidl, we wouldn't have to make up our own</span>
<a href="#l10.337"></a><span id="l10.337">     // object. FILTER_REJECT is not used here, but included for completeness.</span>
<a href="#l10.338"></a><span id="l10.338">     const NodeFilter = { SHOW_ELEMENT: 0x1, FILTER_ACCEPT: 1, FILTER_REJECT: 2, FILTER_SKIP: 3 };</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineat">@@ -800,17 +799,17 @@ SelectedMessage.prototype = {</span>
<a href="#l10.340"></a><span id="l10.340">       spanNode = treeWalker.nextNode();</span>
<a href="#l10.341"></a><span id="l10.341">     }</span>
<a href="#l10.342"></a><span id="l10.342"> </span>
<a href="#l10.343"></a><span id="l10.343">     return (this._spanNode = spanNode);</span>
<a href="#l10.344"></a><span id="l10.344">   },</span>
<a href="#l10.345"></a><span id="l10.345"> </span>
<a href="#l10.346"></a><span id="l10.346">   // Initialize _textSelected and _otherSelected; if _textSelected is true,</span>
<a href="#l10.347"></a><span id="l10.347">   // also initialize _selectedText and _cutBegin/End.</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-  _initSelectedText: function() {</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  _initSelectedText() {</span>
<a href="#l10.350"></a><span id="l10.350">     if (&quot;_textSelected&quot; in this)</span>
<a href="#l10.351"></a><span id="l10.351">       return; // already initialized</span>
<a href="#l10.352"></a><span id="l10.352"> </span>
<a href="#l10.353"></a><span id="l10.353">     let spanNode = this._getSpanNode();</span>
<a href="#l10.354"></a><span id="l10.354">     if (!spanNode) {</span>
<a href="#l10.355"></a><span id="l10.355">       // can happen if the message text is under a separate root node</span>
<a href="#l10.356"></a><span id="l10.356">       // that isn't selected at all</span>
<a href="#l10.357"></a><span id="l10.357">       this._textSelected = false;</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineat">@@ -865,29 +864,29 @@ SelectedMessage.prototype = {</span>
<a href="#l10.359"></a><span id="l10.359">   get cutBegin() {</span>
<a href="#l10.360"></a><span id="l10.360">     this._initSelectedText();</span>
<a href="#l10.361"></a><span id="l10.361">     return this._textSelected &amp;&amp; this._cutBegin;</span>
<a href="#l10.362"></a><span id="l10.362">   },</span>
<a href="#l10.363"></a><span id="l10.363">   get cutEnd() {</span>
<a href="#l10.364"></a><span id="l10.364">     this._initSelectedText();</span>
<a href="#l10.365"></a><span id="l10.365">     return this._textSelected &amp;&amp; this._cutEnd;</span>
<a href="#l10.366"></a><span id="l10.366">   },</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-  isTextSelected: function() {</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+  isTextSelected() {</span>
<a href="#l10.369"></a><span id="l10.369">     this._initSelectedText();</span>
<a href="#l10.370"></a><span id="l10.370">     return this._textSelected;</span>
<a href="#l10.371"></a><span id="l10.371">   },</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-  onlyTextSelected: function() {</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+  onlyTextSelected() {</span>
<a href="#l10.374"></a><span id="l10.374">     this._initSelectedText();</span>
<a href="#l10.375"></a><span id="l10.375">     return !this._otherSelected;</span>
<a href="#l10.376"></a><span id="l10.376">   },</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-  getSelectedText: function() {</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+  getSelectedText() {</span>
<a href="#l10.379"></a><span id="l10.379">     this._initSelectedText();</span>
<a href="#l10.380"></a><span id="l10.380">     return this._textSelected ? this._selectedText : &quot;&quot;;</span>
<a href="#l10.381"></a><span id="l10.381">   },</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-  getFormattedMessage: function() {</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+  getFormattedMessage() {</span>
<a href="#l10.384"></a><span id="l10.384">     // First, get the selected text</span>
<a href="#l10.385"></a><span id="l10.385">     this._initSelectedText();</span>
<a href="#l10.386"></a><span id="l10.386">     let msg = this.msg;</span>
<a href="#l10.387"></a><span id="l10.387">     let text;</span>
<a href="#l10.388"></a><span id="l10.388">     if (this._textSelected) {</span>
<a href="#l10.389"></a><span id="l10.389">       // Add ellipsis is needed</span>
<a href="#l10.390"></a><span id="l10.390">       text = (this._cutBegin ? getEllipsis() + &quot; &quot; : &quot;&quot;) +</span>
<a href="#l10.391"></a><span id="l10.391">              this._selectedText +</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineat">@@ -895,23 +894,23 @@ SelectedMessage.prototype = {</span>
<a href="#l10.393"></a><span id="l10.393">     }</span>
<a href="#l10.394"></a><span id="l10.394">     else {</span>
<a href="#l10.395"></a><span id="l10.395">       let div = this._rootNodes[0].ownerDocument.createElement(&quot;div&quot;);</span>
<a href="#l10.396"></a><span id="l10.396">       div.innerHTML = msg.autoResponse ? formatAutoResponce(msg.message) : msg.message;</span>
<a href="#l10.397"></a><span id="l10.397">       text = serializeNode(div);</span>
<a href="#l10.398"></a><span id="l10.398">     }</span>
<a href="#l10.399"></a><span id="l10.399"> </span>
<a href="#l10.400"></a><span id="l10.400">     // then get the suitable replacements and templates for this message</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-    let getLocalizedPrefWithDefault = function (aName, aDefault) {</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+    let getLocalizedPrefWithDefault = function(aName, aDefault) {</span>
<a href="#l10.403"></a><span id="l10.403">       try {</span>
<a href="#l10.404"></a><span id="l10.404">         let prefBranch =</span>
<a href="#l10.405"></a><span id="l10.405">           Services.prefs.getBranch(&quot;messenger.conversations.selections.&quot;);</span>
<a href="#l10.406"></a><span id="l10.406">         return prefBranch.getComplexValue(aName,</span>
<a href="#l10.407"></a><span id="l10.407">                                           Ci.nsIPrefLocalizedString).data;</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-      } catch(e) {</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+      } catch (e) {</span>
<a href="#l10.410"></a><span id="l10.410">         return aDefault;</span>
<a href="#l10.411"></a><span id="l10.411">       }</span>
<a href="#l10.412"></a><span id="l10.412">     };</span>
<a href="#l10.413"></a><span id="l10.413">     let html, replacements;</span>
<a href="#l10.414"></a><span id="l10.414">     if (msg.system) {</span>
<a href="#l10.415"></a><span id="l10.415">       replacements = statusReplacements;</span>
<a href="#l10.416"></a><span id="l10.416">       html = getLocalizedPrefWithDefault(&quot;systemMessagesTemplate&quot;,</span>
<a href="#l10.417"></a><span id="l10.417">                                          &quot;%time% - %message%&quot;);</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineat">@@ -930,38 +929,37 @@ SelectedMessage.prototype = {</span>
<a href="#l10.419"></a><span id="l10.419"> </span>
<a href="#l10.420"></a><span id="l10.420">     // Overrides default replacements so that they don't add a span node.</span>
<a href="#l10.421"></a><span id="l10.421">     // Also, this uses directly the text variable so that we don't</span>
<a href="#l10.422"></a><span id="l10.422">     // have to change the content of msg.message and revert it</span>
<a href="#l10.423"></a><span id="l10.423">     // afterwards.</span>
<a href="#l10.424"></a><span id="l10.424">     replacements = {</span>
<a href="#l10.425"></a><span id="l10.425">       message: aMsg =&gt; text,</span>
<a href="#l10.426"></a><span id="l10.426">       sender: aMsg =&gt; aMsg.alias || aMsg.who,</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineminus">-      __proto__: replacements</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+      __proto__: replacements,</span>
<a href="#l10.429"></a><span id="l10.429">     };</span>
<a href="#l10.430"></a><span id="l10.430"> </span>
<a href="#l10.431"></a><span id="l10.431">     // Finally, let the theme system do the magic!</span>
<a href="#l10.432"></a><span id="l10.432">     return replaceKeywordsInHTML(html, replacements, msg);</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-  }</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+  },</span>
<a href="#l10.435"></a><span id="l10.435"> };</span>
<a href="#l10.436"></a><span id="l10.436"> </span>
<a href="#l10.437"></a><span id="l10.437"> function getMessagesForRange(aRange)</span>
<a href="#l10.438"></a><span id="l10.438"> {</span>
<a href="#l10.439"></a><span id="l10.439">   let result = []; // will hold the final result</span>
<a href="#l10.440"></a><span id="l10.440">   let messages = {}; // used to prevent duplicate messages in the result array</span>
<a href="#l10.441"></a><span id="l10.441"> </span>
<a href="#l10.442"></a><span id="l10.442">   // cache the range boundaries, they will be used a lot</span>
<a href="#l10.443"></a><span id="l10.443">   let endNode = aRange.endContainer;</span>
<a href="#l10.444"></a><span id="l10.444">   let startNode = aRange.startContainer;</span>
<a href="#l10.445"></a><span id="l10.445"> </span>
<a href="#l10.446"></a><span id="l10.446">   // Helper function to recursively look for _originalMsg JS</span>
<a href="#l10.447"></a><span id="l10.447">   // properties on DOM nodes, and stop when endNode is reached.</span>
<a href="#l10.448"></a><span id="l10.448">   // Found nodes are pushed into the rootNodes array.</span>
<a href="#l10.449"></a><span id="l10.449">   let processSubtree = function(aNode) {</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-</span>
<a href="#l10.451"></a><span id="l10.451">     if (aNode._originalMsg) {</span>
<a href="#l10.452"></a><span id="l10.452">       // store the result</span>
<a href="#l10.453"></a><span id="l10.453">       if (!(aNode._originalMsg.id in messages)) {</span>
<a href="#l10.454"></a><span id="l10.454">         // we've found a new message!</span>
<a href="#l10.455"></a><span id="l10.455">         let newMessage = new SelectedMessage(aNode, aRange);</span>
<a href="#l10.456"></a><span id="l10.456">         messages[aNode._originalMsg.id] = newMessage;</span>
<a href="#l10.457"></a><span id="l10.457">         result.push(newMessage);</span>
<a href="#l10.458"></a><span id="l10.458">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -6,17 +6,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l11.4"></a><span id="l11.4">   &quot;XPCOMUtils&quot;,</span>
<a href="#l11.5"></a><span id="l11.5">   &quot;setTimeout&quot;,</span>
<a href="#l11.6"></a><span id="l11.6">   &quot;clearTimeout&quot;,</span>
<a href="#l11.7"></a><span id="l11.7">   &quot;executeSoon&quot;,</span>
<a href="#l11.8"></a><span id="l11.8">   &quot;nsSimpleEnumerator&quot;,</span>
<a href="#l11.9"></a><span id="l11.9">   &quot;EmptyEnumerator&quot;,</span>
<a href="#l11.10"></a><span id="l11.10">   &quot;ClassInfo&quot;,</span>
<a href="#l11.11"></a><span id="l11.11">   &quot;l10nHelper&quot;,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  &quot;initLogModule&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  &quot;initLogModule&quot;,</span>
<a href="#l11.14"></a><span id="l11.14"> ];</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> const {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> const {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> var kLogLevelPref = &quot;purple.debug.loglevel&quot;;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> /**</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -66,17 +66,17 @@ function scriptError(aModule, aLevel, aM</span>
<a href="#l11.23"></a><span id="l11.23">   }</span>
<a href="#l11.24"></a><span id="l11.24">   let fileName = caller.filename;</span>
<a href="#l11.25"></a><span id="l11.25">   let lineNumber = caller.lineNumber;</span>
<a href="#l11.26"></a><span id="l11.26">   if (aOriginalError) {</span>
<a href="#l11.27"></a><span id="l11.27">     aMessage += &quot;\n&quot; + (aOriginalError.message || aOriginalError);</span>
<a href="#l11.28"></a><span id="l11.28">     if (aOriginalError.fileName)</span>
<a href="#l11.29"></a><span id="l11.29">       fileName = aOriginalError.fileName;</span>
<a href="#l11.30"></a><span id="l11.30">     if (aOriginalError.lineNumber)</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-      lineNumber = aOriginalError.lineNumber</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      lineNumber = aOriginalError.lineNumber;</span>
<a href="#l11.33"></a><span id="l11.33">   }</span>
<a href="#l11.34"></a><span id="l11.34">   scriptError.init(aMessage, fileName, sourceLine, lineNumber, null, flag,</span>
<a href="#l11.35"></a><span id="l11.35">                    &quot;component javascript&quot;);</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37">   if (logLevel &lt;= aLevel) {</span>
<a href="#l11.38"></a><span id="l11.38">     dump(aModule + &quot;: &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l11.39"></a><span id="l11.39">     if (aLevel == Ci.imIDebugMessage.LEVEL_LOG &amp;&amp; logLevel == aLevel)</span>
<a href="#l11.40"></a><span id="l11.40">       Services.console.logStringMessage(aMessage);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -96,17 +96,17 @@ function initLogModule(aModule, aObj = {</span>
<a href="#l11.42"></a><span id="l11.42"> }</span>
<a href="#l11.43"></a><span id="l11.43"> XPCOMUtils.defineLazyGetter(Cu.getGlobalForObject({}), &quot;gLogLevels&quot;, function() {</span>
<a href="#l11.44"></a><span id="l11.44">   // This object functions both as an obsever as well as a dict keeping the</span>
<a href="#l11.45"></a><span id="l11.45">   // log levels with prefs; the log levels all start with &quot;level&quot; (i.e. &quot;level&quot;</span>
<a href="#l11.46"></a><span id="l11.46">   // for the global level, &quot;level.irc&quot; for the IRC module).  The dual-purpose</span>
<a href="#l11.47"></a><span id="l11.47">   // is necessary to make sure the observe is left alive while being a weak ref</span>
<a href="#l11.48"></a><span id="l11.48">   // to avoid cycles with the pref service.</span>
<a href="#l11.49"></a><span id="l11.49">   let logLevels = {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    observe(aSubject, aTopic, aData) {</span>
<a href="#l11.52"></a><span id="l11.52">       let module = &quot;level&quot; + aData.substr(kLogLevelPref.length);</span>
<a href="#l11.53"></a><span id="l11.53">       if (Services.prefs.getPrefType(aData) == Services.prefs.PREF_INT)</span>
<a href="#l11.54"></a><span id="l11.54">         gLogLevels[module] = Services.prefs.getIntPref(aData);</span>
<a href="#l11.55"></a><span id="l11.55">       else</span>
<a href="#l11.56"></a><span id="l11.56">         delete gLogLevels[module];</span>
<a href="#l11.57"></a><span id="l11.57">     },</span>
<a href="#l11.58"></a><span id="l11.58">     QueryInterface: ChromeUtils.generateQI([&quot;nsIObserver&quot;,</span>
<a href="#l11.59"></a><span id="l11.59">                                             &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineat">@@ -138,17 +138,17 @@ XPCOMUtils.defineLazyGetter(Cu.getGlobal</span>
<a href="#l11.61"></a><span id="l11.61"> function setTimeout(aFunction, aDelay)</span>
<a href="#l11.62"></a><span id="l11.62"> {</span>
<a href="#l11.63"></a><span id="l11.63">   let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l11.64"></a><span id="l11.64">   let args = Array.prototype.slice.call(arguments, 2);</span>
<a href="#l11.65"></a><span id="l11.65">   // A reference to the timer should be kept to ensure it won't be</span>
<a href="#l11.66"></a><span id="l11.66">   // GC'ed before firing the callback.</span>
<a href="#l11.67"></a><span id="l11.67">   let callback = {</span>
<a href="#l11.68"></a><span id="l11.68">     _timer: timer,</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    notify: function (aTimer) { aFunction.apply(null, args); delete this._timer; }</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+    notify(aTimer) { aFunction.apply(null, args); delete this._timer; },</span>
<a href="#l11.71"></a><span id="l11.71">   };</span>
<a href="#l11.72"></a><span id="l11.72">   timer.initWithCallback(callback, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l11.73"></a><span id="l11.73">   return timer;</span>
<a href="#l11.74"></a><span id="l11.74"> }</span>
<a href="#l11.75"></a><span id="l11.75"> function clearTimeout(aTimer)</span>
<a href="#l11.76"></a><span id="l11.76"> {</span>
<a href="#l11.77"></a><span id="l11.77">   if (aTimer)</span>
<a href="#l11.78"></a><span id="l11.78">     aTimer.cancel();</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineat">@@ -174,36 +174,37 @@ function ClassInfo(aInterfaces, aDescrip</span>
<a href="#l11.80"></a><span id="l11.80">       Services.console.logStringMessage(&quot;ClassInfo: unknown interface &quot; + i);</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82">   this._interfaces =</span>
<a href="#l11.83"></a><span id="l11.83">     aInterfaces.map(i =&gt; typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l11.84"></a><span id="l11.84"> </span>
<a href="#l11.85"></a><span id="l11.85">   this.classDescription = aDescription;</span>
<a href="#l11.86"></a><span id="l11.86"> }</span>
<a href="#l11.87"></a><span id="l11.87"> ClassInfo.prototype = {</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  QueryInterface: function ClassInfo_QueryInterface(iid) {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  // eslint-disable-next-line mozilla/use-chromeutils-generateqi</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  QueryInterface(iid) {</span>
<a href="#l11.91"></a><span id="l11.91">     if (iid.equals(Ci.nsISupports) || iid.equals(Ci.nsIClassInfo) ||</span>
<a href="#l11.92"></a><span id="l11.92">         this._interfaces.some(i =&gt; i.equals(iid)))</span>
<a href="#l11.93"></a><span id="l11.93">       return this;</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l11.96"></a><span id="l11.96">   },</span>
<a href="#l11.97"></a><span id="l11.97">   get interfaces() {</span>
<a href="#l11.98"></a><span id="l11.98">     return [Ci.nsIClassInfo, Ci.nsISupports].concat(this._interfaces);</span>
<a href="#l11.99"></a><span id="l11.99">   },</span>
<a href="#l11.100"></a><span id="l11.100">   getHelperForLanguage: language =&gt; null,</span>
<a href="#l11.101"></a><span id="l11.101">   contractID: null,</span>
<a href="#l11.102"></a><span id="l11.102">   classID: null,</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  flags: 0</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  flags: 0,</span>
<a href="#l11.105"></a><span id="l11.105"> };</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107"> function l10nHelper(aChromeURL)</span>
<a href="#l11.108"></a><span id="l11.108"> {</span>
<a href="#l11.109"></a><span id="l11.109">   let bundle = Services.strings.createBundle(aChromeURL);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-  return function (aStringId) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+  return function(aStringId) {</span>
<a href="#l11.112"></a><span id="l11.112">     try {</span>
<a href="#l11.113"></a><span id="l11.113">       if (arguments.length == 1)</span>
<a href="#l11.114"></a><span id="l11.114">         return bundle.GetStringFromName(aStringId);</span>
<a href="#l11.115"></a><span id="l11.115">       return bundle.formatStringFromName(aStringId,</span>
<a href="#l11.116"></a><span id="l11.116">                                          Array.prototype.slice.call(arguments, 1),</span>
<a href="#l11.117"></a><span id="l11.117">                                          arguments.length - 1);</span>
<a href="#l11.118"></a><span id="l11.118">     } catch (e) {</span>
<a href="#l11.119"></a><span id="l11.119">       Cu.reportError(e);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineat">@@ -221,25 +222,25 @@ function l10nHelper(aChromeURL)</span>
<a href="#l11.121"></a><span id="l11.121">  *   the items, which must all implement nsISupports</span>
<a href="#l11.122"></a><span id="l11.122">  */</span>
<a href="#l11.123"></a><span id="l11.123"> function nsSimpleEnumerator(items)</span>
<a href="#l11.124"></a><span id="l11.124"> {</span>
<a href="#l11.125"></a><span id="l11.125">   this._items = items;</span>
<a href="#l11.126"></a><span id="l11.126">   this._nextIndex = 0;</span>
<a href="#l11.127"></a><span id="l11.127"> }</span>
<a href="#l11.128"></a><span id="l11.128"> nsSimpleEnumerator.prototype = {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-  hasMoreElements: function() { return this._nextIndex &lt; this._items.length; },</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  getNext: function() {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  hasMoreElements() { return this._nextIndex &lt; this._items.length; },</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  getNext() {</span>
<a href="#l11.133"></a><span id="l11.133">     if (!this.hasMoreElements())</span>
<a href="#l11.134"></a><span id="l11.134">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l11.135"></a><span id="l11.135"> </span>
<a href="#l11.136"></a><span id="l11.136">     return this._items[this._nextIndex++];</span>
<a href="#l11.137"></a><span id="l11.137">   },</span>
<a href="#l11.138"></a><span id="l11.138">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  [Symbol.iterator]() { return this._items.values(); }</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  [Symbol.iterator]() { return this._items.values(); },</span>
<a href="#l11.141"></a><span id="l11.141"> };</span>
<a href="#l11.142"></a><span id="l11.142"> </span>
<a href="#l11.143"></a><span id="l11.143"> var EmptyEnumerator = {</span>
<a href="#l11.144"></a><span id="l11.144">   hasMoreElements: () =&gt; false,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-  getNext: function() { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  getNext() { throw Cr.NS_ERROR_NOT_AVAILABLE; },</span>
<a href="#l11.147"></a><span id="l11.147">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-  * [Symbol.iterator]() {}</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  * [Symbol.iterator]() {},</span>
<a href="#l11.150"></a><span id="l11.150"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,17 +7,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l12.4"></a><span id="l12.4">   &quot;GenericAccountBuddyPrototype&quot;,</span>
<a href="#l12.5"></a><span id="l12.5">   &quot;GenericConvIMPrototype&quot;,</span>
<a href="#l12.6"></a><span id="l12.6">   &quot;GenericConvChatPrototype&quot;,</span>
<a href="#l12.7"></a><span id="l12.7">   &quot;GenericConvChatBuddyPrototype&quot;,</span>
<a href="#l12.8"></a><span id="l12.8">   &quot;GenericConversationPrototype&quot;,</span>
<a href="#l12.9"></a><span id="l12.9">   &quot;GenericMessagePrototype&quot;,</span>
<a href="#l12.10"></a><span id="l12.10">   &quot;GenericProtocolPrototype&quot;,</span>
<a href="#l12.11"></a><span id="l12.11">   &quot;Message&quot;,</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  &quot;TooltipInfo&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  &quot;TooltipInfo&quot;,</span>
<a href="#l12.14"></a><span id="l12.14"> ];</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> const {</span>
<a href="#l12.17"></a><span id="l12.17">   EmptyEnumerator,</span>
<a href="#l12.18"></a><span id="l12.18">   initLogModule,</span>
<a href="#l12.19"></a><span id="l12.19">   XPCOMUtils,</span>
<a href="#l12.20"></a><span id="l12.20">   nsSimpleEnumerator,</span>
<a href="#l12.21"></a><span id="l12.21">   l10nHelper,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -32,41 +32,41 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, (</span>
<a href="#l12.23"></a><span id="l12.23"> var GenericAccountPrototype = {</span>
<a href="#l12.24"></a><span id="l12.24">   __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l12.25"></a><span id="l12.25">   get wrappedJSObject() { return this; },</span>
<a href="#l12.26"></a><span id="l12.26">   _init: function _init(aProtocol, aImAccount) {</span>
<a href="#l12.27"></a><span id="l12.27">     this.protocol = aProtocol;</span>
<a href="#l12.28"></a><span id="l12.28">     this.imAccount = aImAccount;</span>
<a href="#l12.29"></a><span id="l12.29">     initLogModule(aProtocol.id, this);</span>
<a href="#l12.30"></a><span id="l12.30">   },</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  remove: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  unInit: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  connect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  disconnect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  createConversation: function(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  joinChat: function(aComponents) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  setBool: function(aName, aVal) {},</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  setInt: function(aName, aVal) {},</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-  setString: function(aName, aVal) {},</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  observe(aSubject, aTopic, aData) {},</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  remove() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  unInit() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  connect() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  disconnect() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  createConversation(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  joinChat(aComponents) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  setBool(aName, aVal) {},</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  setInt(aName, aVal) {},</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  setString(aName, aVal) {},</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">   get name() { return this.imAccount.name; },</span>
<a href="#l12.53"></a><span id="l12.53">   get connected() { return this.imAccount.connected; },</span>
<a href="#l12.54"></a><span id="l12.54">   get connecting() { return this.imAccount.connecting; },</span>
<a href="#l12.55"></a><span id="l12.55">   get disconnected() { return this.imAccount.disconnected; },</span>
<a href="#l12.56"></a><span id="l12.56">   get disconnecting() { return this.imAccount.disconnecting; },</span>
<a href="#l12.57"></a><span id="l12.57">   _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l12.58"></a><span id="l12.58">   get connectionErrorReason() { return this._connectionErrorReason; },</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">   /*</span>
<a href="#l12.61"></a><span id="l12.61">    * Convert a socket's nsITransportSecurityInfo into a prplIAccount connection error. Store</span>
<a href="#l12.62"></a><span id="l12.62">    * the nsITransportSecurityInfo and the connection location on the account so the</span>
<a href="#l12.63"></a><span id="l12.63">    * certificate exception dialog can access the information.</span>
<a href="#l12.64"></a><span id="l12.64">    */</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  handleBadCertificate: function(aSocket, aIsSslError) {</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  handleBadCertificate(aSocket, aIsSslError) {</span>
<a href="#l12.67"></a><span id="l12.67">     this._connectionTarget = aSocket.host + &quot;:&quot; + aSocket.port;</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69">     if (aIsSslError)</span>
<a href="#l12.70"></a><span id="l12.70">       return Ci.prplIAccount.ERROR_ENCRYPTION_ERROR;</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72">     let secInfo = this._secInfo = aSocket.secInfo;</span>
<a href="#l12.73"></a><span id="l12.73">     if (!secInfo)</span>
<a href="#l12.74"></a><span id="l12.74">       return Ci.prplIAccount.ERROR_CERT_NOT_PROVIDED;</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineat">@@ -92,187 +92,187 @@ var GenericAccountPrototype = {</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77">     return Ci.prplIAccount.ERROR_CERT_OTHER_ERROR;</span>
<a href="#l12.78"></a><span id="l12.78">   },</span>
<a href="#l12.79"></a><span id="l12.79">   _connectionTarget: &quot;&quot;,</span>
<a href="#l12.80"></a><span id="l12.80">   get connectionTarget() { return this._connectionTarget; },</span>
<a href="#l12.81"></a><span id="l12.81">   _secInfo: null,</span>
<a href="#l12.82"></a><span id="l12.82">   get secInfo() { return this._secInfo; },</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-  reportConnected: function() {</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  reportConnected() {</span>
<a href="#l12.86"></a><span id="l12.86">     this.imAccount.observe(this, &quot;account-connected&quot;, null);</span>
<a href="#l12.87"></a><span id="l12.87">   },</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  reportConnecting: function(aConnectionStateMsg) {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  reportConnecting(aConnectionStateMsg) {</span>
<a href="#l12.90"></a><span id="l12.90">     // Delete any leftover errors from the previous connection.</span>
<a href="#l12.91"></a><span id="l12.91">     delete this._connectionTarget;</span>
<a href="#l12.92"></a><span id="l12.92">     delete this._secInfo;</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">     if (!this.connecting)</span>
<a href="#l12.95"></a><span id="l12.95">       this.imAccount.observe(this, &quot;account-connecting&quot;, null);</span>
<a href="#l12.96"></a><span id="l12.96">     if (aConnectionStateMsg)</span>
<a href="#l12.97"></a><span id="l12.97">       this.imAccount.observe(this, &quot;account-connect-progress&quot;, aConnectionStateMsg);</span>
<a href="#l12.98"></a><span id="l12.98">   },</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-  reportDisconnected: function() {</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  reportDisconnected() {</span>
<a href="#l12.101"></a><span id="l12.101">     this.imAccount.observe(this, &quot;account-disconnected&quot;, null);</span>
<a href="#l12.102"></a><span id="l12.102">   },</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  reportDisconnecting: function(aConnectionErrorReason, aConnectionErrorMessage) {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  reportDisconnecting(aConnectionErrorReason, aConnectionErrorMessage) {</span>
<a href="#l12.105"></a><span id="l12.105">     this._connectionErrorReason = aConnectionErrorReason;</span>
<a href="#l12.106"></a><span id="l12.106">     this.imAccount.observe(this, &quot;account-disconnecting&quot;, aConnectionErrorMessage);</span>
<a href="#l12.107"></a><span id="l12.107">     this.cancelPendingBuddyRequests();</span>
<a href="#l12.108"></a><span id="l12.108">   },</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">   // Called when the user adds a new buddy from the UI.</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  addBuddy: function(aTag, aName) {</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  addBuddy(aTag, aName) {</span>
<a href="#l12.113"></a><span id="l12.113">     Services.contacts</span>
<a href="#l12.114"></a><span id="l12.114">             .accountBuddyAdded(new AccountBuddy(this, null, aTag, aName));</span>
<a href="#l12.115"></a><span id="l12.115">   },</span>
<a href="#l12.116"></a><span id="l12.116">   // Called during startup for each of the buddies in the local buddy list.</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l12.119"></a><span id="l12.119">    try {</span>
<a href="#l12.120"></a><span id="l12.120">      return new AccountBuddy(this, aBuddy, aTag);</span>
<a href="#l12.121"></a><span id="l12.121">    } catch (x) {</span>
<a href="#l12.122"></a><span id="l12.122">      dump(x + &quot;\n&quot;);</span>
<a href="#l12.123"></a><span id="l12.123">      return null;</span>
<a href="#l12.124"></a><span id="l12.124">    }</span>
<a href="#l12.125"></a><span id="l12.125">   },</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127">   _pendingBuddyRequests: null,</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-  addBuddyRequest: function(aUserName, aGrantCallback, aDenyCallback) {</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  addBuddyRequest(aUserName, aGrantCallback, aDenyCallback) {</span>
<a href="#l12.130"></a><span id="l12.130">     if (!this._pendingBuddyRequests)</span>
<a href="#l12.131"></a><span id="l12.131">       this._pendingBuddyRequests = [];</span>
<a href="#l12.132"></a><span id="l12.132">     let buddyRequest = {</span>
<a href="#l12.133"></a><span id="l12.133">       get account() { return this._account.imAccount; },</span>
<a href="#l12.134"></a><span id="l12.134">       get userName() { return aUserName; },</span>
<a href="#l12.135"></a><span id="l12.135">       _account: this,</span>
<a href="#l12.136"></a><span id="l12.136">       // Grant and deny callbacks both receive the auth request object as an</span>
<a href="#l12.137"></a><span id="l12.137">       // argument for further use.</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-      grant: function() {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+      grant() {</span>
<a href="#l12.140"></a><span id="l12.140">         aGrantCallback(this);</span>
<a href="#l12.141"></a><span id="l12.141">         this._remove();</span>
<a href="#l12.142"></a><span id="l12.142">       },</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-      deny: function() {</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+      deny() {</span>
<a href="#l12.145"></a><span id="l12.145">         aDenyCallback(this);</span>
<a href="#l12.146"></a><span id="l12.146">         this._remove();</span>
<a href="#l12.147"></a><span id="l12.147">       },</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-      cancel: function() {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+      cancel() {</span>
<a href="#l12.150"></a><span id="l12.150">         Services.obs.notifyObservers(this,</span>
<a href="#l12.151"></a><span id="l12.151">                                      &quot;buddy-authorization-request-canceled&quot;);</span>
<a href="#l12.152"></a><span id="l12.152">         this._remove();</span>
<a href="#l12.153"></a><span id="l12.153">       },</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-      _remove: function() {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+      _remove() {</span>
<a href="#l12.156"></a><span id="l12.156">         this._account.removeBuddyRequest(this);</span>
<a href="#l12.157"></a><span id="l12.157">       },</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.prplIBuddyRequest])</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.prplIBuddyRequest]),</span>
<a href="#l12.160"></a><span id="l12.160">     };</span>
<a href="#l12.161"></a><span id="l12.161">     this._pendingBuddyRequests.push(buddyRequest);</span>
<a href="#l12.162"></a><span id="l12.162">     Services.obs.notifyObservers(buddyRequest, &quot;buddy-authorization-request&quot;);</span>
<a href="#l12.163"></a><span id="l12.163">   },</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-  removeBuddyRequest: function(aRequest) {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+  removeBuddyRequest(aRequest) {</span>
<a href="#l12.166"></a><span id="l12.166">     if (!this._pendingBuddyRequests)</span>
<a href="#l12.167"></a><span id="l12.167">       return;</span>
<a href="#l12.168"></a><span id="l12.168"> </span>
<a href="#l12.169"></a><span id="l12.169">     this._pendingBuddyRequests =</span>
<a href="#l12.170"></a><span id="l12.170">       this._pendingBuddyRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l12.171"></a><span id="l12.171">   },</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-  cancelPendingBuddyRequests: function() {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+  cancelPendingBuddyRequests() {</span>
<a href="#l12.174"></a><span id="l12.174">     if (!this._pendingBuddyRequests)</span>
<a href="#l12.175"></a><span id="l12.175">       return;</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177">     for (let request of this._pendingBuddyRequests)</span>
<a href="#l12.178"></a><span id="l12.178">       request.cancel();</span>
<a href="#l12.179"></a><span id="l12.179">     delete this._pendingBuddyRequests;</span>
<a href="#l12.180"></a><span id="l12.180">   },</span>
<a href="#l12.181"></a><span id="l12.181"> </span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-  requestBuddyInfo: function(aBuddyName) {},</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+  requestBuddyInfo(aBuddyName) {},</span>
<a href="#l12.184"></a><span id="l12.184"> </span>
<a href="#l12.185"></a><span id="l12.185">   get canJoinChat() { return false; },</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  getChatRoomFields: function() {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  getChatRoomFields() {</span>
<a href="#l12.188"></a><span id="l12.188">     if (!this.chatRoomFields)</span>
<a href="#l12.189"></a><span id="l12.189">       return EmptyEnumerator;</span>
<a href="#l12.190"></a><span id="l12.190"> </span>
<a href="#l12.191"></a><span id="l12.191">     let fields = [];</span>
<a href="#l12.192"></a><span id="l12.192">     for (let fieldName in this.chatRoomFields)</span>
<a href="#l12.193"></a><span id="l12.193">       fields.push(new ChatRoomField(fieldName, this.chatRoomFields[fieldName]));</span>
<a href="#l12.194"></a><span id="l12.194">     return new nsSimpleEnumerator(fields);</span>
<a href="#l12.195"></a><span id="l12.195">   },</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-  getChatRoomDefaultFieldValues: function(aDefaultChatName) {</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+  getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l12.198"></a><span id="l12.198">     if (!this.chatRoomFields)</span>
<a href="#l12.199"></a><span id="l12.199">       return EmptyEnumerator;</span>
<a href="#l12.200"></a><span id="l12.200"> </span>
<a href="#l12.201"></a><span id="l12.201">     let defaultFieldValues = [];</span>
<a href="#l12.202"></a><span id="l12.202">     for (let fieldName in this.chatRoomFields)</span>
<a href="#l12.203"></a><span id="l12.203">       defaultFieldValues[fieldName] = this.chatRoomFields[fieldName].default;</span>
<a href="#l12.204"></a><span id="l12.204"> </span>
<a href="#l12.205"></a><span id="l12.205">     if (aDefaultChatName &amp;&amp; &quot;parseDefaultChatName&quot; in this) {</span>
<a href="#l12.206"></a><span id="l12.206">       let parsedDefaultChatName = this.parseDefaultChatName(aDefaultChatName);</span>
<a href="#l12.207"></a><span id="l12.207">       for (let field in parsedDefaultChatName)</span>
<a href="#l12.208"></a><span id="l12.208">         defaultFieldValues[field] = parsedDefaultChatName[field];</span>
<a href="#l12.209"></a><span id="l12.209">     }</span>
<a href="#l12.210"></a><span id="l12.210"> </span>
<a href="#l12.211"></a><span id="l12.211">     return new ChatRoomFieldValues(defaultFieldValues);</span>
<a href="#l12.212"></a><span id="l12.212">   },</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-  requestRoomInfo: function(aCallback) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-  getRoomInfo: function(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+  requestRoomInfo(aCallback) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  getRoomInfo(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.217"></a><span id="l12.217">   get isRoomInfoStale() { return false; },</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-  getPref: function (aName, aType) {</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+  getPref(aName, aType) {</span>
<a href="#l12.221"></a><span id="l12.221">     return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l12.222"></a><span id="l12.222">            this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName) :</span>
<a href="#l12.223"></a><span id="l12.223">            this.protocol._getOptionDefault(aName);</span>
<a href="#l12.224"></a><span id="l12.224">   },</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-  getInt: function(aName) { return this.getPref(aName, &quot;Int&quot;); },</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-  getBool: function(aName) { return this.getPref(aName, &quot;Bool&quot;); },</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-  getString: function(aName) {</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+  getInt(aName) { return this.getPref(aName, &quot;Int&quot;); },</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+  getBool(aName) { return this.getPref(aName, &quot;Bool&quot;); },</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+  getString(aName) {</span>
<a href="#l12.231"></a><span id="l12.231">     return this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l12.232"></a><span id="l12.232">              this.prefs.getStringPref(aName) :</span>
<a href="#l12.233"></a><span id="l12.233">              this.protocol._getOptionDefault(aName);</span>
<a href="#l12.234"></a><span id="l12.234">   },</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236">   get prefs() {</span>
<a href="#l12.237"></a><span id="l12.237">     return this._prefs ||</span>
<a href="#l12.238"></a><span id="l12.238">            (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l12.239"></a><span id="l12.239">                                                    this.imAccount.id + &quot;.options.&quot;));</span>
<a href="#l12.240"></a><span id="l12.240">   },</span>
<a href="#l12.241"></a><span id="l12.241"> </span>
<a href="#l12.242"></a><span id="l12.242">   get normalizedName() { return this.normalize(this.name); },</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-  normalize: function(aName) { return aName.toLowerCase(); },</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+  normalize(aName) { return aName.toLowerCase(); },</span>
<a href="#l12.245"></a><span id="l12.245"> </span>
<a href="#l12.246"></a><span id="l12.246">   get HTMLEnabled() { return false; },</span>
<a href="#l12.247"></a><span id="l12.247">   get HTMLEscapePlainText() { return false; },</span>
<a href="#l12.248"></a><span id="l12.248">   get noBackgroundColors() { return true; },</span>
<a href="#l12.249"></a><span id="l12.249">   get autoResponses() { return false; },</span>
<a href="#l12.250"></a><span id="l12.250">   get singleFormatting() { return false; },</span>
<a href="#l12.251"></a><span id="l12.251">   get noFontSizes() { return false; },</span>
<a href="#l12.252"></a><span id="l12.252">   get noUrlDesc() { return false; },</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-  get noImages() { return true; }</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+  get noImages() { return true; },</span>
<a href="#l12.255"></a><span id="l12.255"> };</span>
<a href="#l12.256"></a><span id="l12.256"> </span>
<a href="#l12.257"></a><span id="l12.257"> </span>
<a href="#l12.258"></a><span id="l12.258"> var GenericAccountBuddyPrototype = {</span>
<a href="#l12.259"></a><span id="l12.259">   __proto__: ClassInfo(&quot;prplIAccountBuddy&quot;, &quot;generic account buddy object&quot;),</span>
<a href="#l12.260"></a><span id="l12.260">   get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l12.261"></a><span id="l12.261">   get LOG() { return this._account.LOG; },</span>
<a href="#l12.262"></a><span id="l12.262">   get WARN() { return this._account.WARN; },</span>
<a href="#l12.263"></a><span id="l12.263">   get ERROR() { return this._account.ERROR; },</span>
<a href="#l12.264"></a><span id="l12.264"> </span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-  _init: function(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+  _init(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l12.267"></a><span id="l12.267">     if (!aBuddy &amp;&amp; !aUserName)</span>
<a href="#l12.268"></a><span id="l12.268">       throw &quot;aUserName is required when aBuddy is null&quot;;</span>
<a href="#l12.269"></a><span id="l12.269"> </span>
<a href="#l12.270"></a><span id="l12.270">     this._tag = aTag;</span>
<a href="#l12.271"></a><span id="l12.271">     this._account = aAccount;</span>
<a href="#l12.272"></a><span id="l12.272">     this._buddy = aBuddy;</span>
<a href="#l12.273"></a><span id="l12.273">     if (aBuddy) {</span>
<a href="#l12.274"></a><span id="l12.274">       let displayName = aBuddy.displayName;</span>
<a href="#l12.275"></a><span id="l12.275">       if (displayName != aUserName)</span>
<a href="#l12.276"></a><span id="l12.276">         this._serverAlias = displayName;</span>
<a href="#l12.277"></a><span id="l12.277">     }</span>
<a href="#l12.278"></a><span id="l12.278">     this._userName = aUserName;</span>
<a href="#l12.279"></a><span id="l12.279">   },</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineminus">-  unInit: function() {</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+  unInit() {</span>
<a href="#l12.282"></a><span id="l12.282">     delete this._tag;</span>
<a href="#l12.283"></a><span id="l12.283">     delete this._account;</span>
<a href="#l12.284"></a><span id="l12.284">     delete this._buddy;</span>
<a href="#l12.285"></a><span id="l12.285">   },</span>
<a href="#l12.286"></a><span id="l12.286"> </span>
<a href="#l12.287"></a><span id="l12.287">   get account() { return this._account.imAccount; },</span>
<a href="#l12.288"></a><span id="l12.288">   set buddy(aBuddy) {</span>
<a href="#l12.289"></a><span id="l12.289">     if (this._buddy)</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineat">@@ -282,37 +282,37 @@ var GenericAccountBuddyPrototype = {</span>
<a href="#l12.291"></a><span id="l12.291">   get buddy() { return this._buddy; },</span>
<a href="#l12.292"></a><span id="l12.292">   get tag() { return this._tag; },</span>
<a href="#l12.293"></a><span id="l12.293">   set tag(aNewTag) {</span>
<a href="#l12.294"></a><span id="l12.294">     let oldTag = this._tag;</span>
<a href="#l12.295"></a><span id="l12.295">     this._tag = aNewTag;</span>
<a href="#l12.296"></a><span id="l12.296">     Services.contacts.accountBuddyMoved(this, oldTag, aNewTag);</span>
<a href="#l12.297"></a><span id="l12.297">   },</span>
<a href="#l12.298"></a><span id="l12.298"> </span>
<a href="#l12.299"></a><span id="l12.299" class="difflineminus">-  _notifyObservers: function(aTopic, aData) {</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+  _notifyObservers(aTopic, aData) {</span>
<a href="#l12.301"></a><span id="l12.301">     try {</span>
<a href="#l12.302"></a><span id="l12.302">       this._buddy.observe(this, &quot;account-buddy-&quot; + aTopic, aData);</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-    } catch(e) {</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.305"></a><span id="l12.305">       this.ERROR(e);</span>
<a href="#l12.306"></a><span id="l12.306">     }</span>
<a href="#l12.307"></a><span id="l12.307">   },</span>
<a href="#l12.308"></a><span id="l12.308"> </span>
<a href="#l12.309"></a><span id="l12.309">   _userName: &quot;&quot;,</span>
<a href="#l12.310"></a><span id="l12.310">   get userName() { return this._userName || this._buddy.userName; },</span>
<a href="#l12.311"></a><span id="l12.311">   get normalizedName() { return this._account.normalize(this.userName); },</span>
<a href="#l12.312"></a><span id="l12.312">   _serverAlias: &quot;&quot;,</span>
<a href="#l12.313"></a><span id="l12.313">   get serverAlias() { return this._serverAlias; },</span>
<a href="#l12.314"></a><span id="l12.314">   set serverAlias(aNewAlias) {</span>
<a href="#l12.315"></a><span id="l12.315">     let old = this.displayName;</span>
<a href="#l12.316"></a><span id="l12.316">     this._serverAlias = aNewAlias;</span>
<a href="#l12.317"></a><span id="l12.317">     if (old != this.displayName)</span>
<a href="#l12.318"></a><span id="l12.318">       this._notifyObservers(&quot;display-name-changed&quot;, old);</span>
<a href="#l12.319"></a><span id="l12.319">   },</span>
<a href="#l12.320"></a><span id="l12.320"> </span>
<a href="#l12.321"></a><span id="l12.321" class="difflineminus">-  remove: function() {</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+  remove() {</span>
<a href="#l12.323"></a><span id="l12.323">     Services.contacts.accountBuddyRemoved(this);</span>
<a href="#l12.324"></a><span id="l12.324">   },</span>
<a href="#l12.325"></a><span id="l12.325"> </span>
<a href="#l12.326"></a><span id="l12.326">   // imIStatusInfo implementation</span>
<a href="#l12.327"></a><span id="l12.327">   get displayName() { return this.serverAlias || this.userName; },</span>
<a href="#l12.328"></a><span id="l12.328">   _buddyIconFileName: &quot;&quot;,</span>
<a href="#l12.329"></a><span id="l12.329">   get buddyIconFilename() { return this._buddyIconFileName; },</span>
<a href="#l12.330"></a><span id="l12.330">   set buddyIconFilename(aNewFileName) {</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineat">@@ -327,17 +327,17 @@ var GenericAccountBuddyPrototype = {</span>
<a href="#l12.332"></a><span id="l12.332">   get mobile() { return this._statusType == Ci.imIStatusInfo.STATUS_MOBILE; },</span>
<a href="#l12.333"></a><span id="l12.333">   _statusText: &quot;&quot;,</span>
<a href="#l12.334"></a><span id="l12.334">   get statusText() { return this._statusText; },</span>
<a href="#l12.335"></a><span id="l12.335"> </span>
<a href="#l12.336"></a><span id="l12.336">   // This is for use by the protocol plugin, it's not exposed in the</span>
<a href="#l12.337"></a><span id="l12.337">   // imIStatusInfo interface.</span>
<a href="#l12.338"></a><span id="l12.338">   // All parameters are optional and will be ignored if they are null</span>
<a href="#l12.339"></a><span id="l12.339">   // or undefined.</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineminus">-  setStatus: function(aStatusType, aStatusText, aAvailabilityDetails) {</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+  setStatus(aStatusType, aStatusText, aAvailabilityDetails) {</span>
<a href="#l12.342"></a><span id="l12.342">     // Ignore omitted parameters.</span>
<a href="#l12.343"></a><span id="l12.343">     if (aStatusType === undefined || aStatusType === null)</span>
<a href="#l12.344"></a><span id="l12.344">       aStatusType = this._statusType;</span>
<a href="#l12.345"></a><span id="l12.345">     if (aStatusText === undefined || aStatusText === null)</span>
<a href="#l12.346"></a><span id="l12.346">       aStatusText = this._statusText;</span>
<a href="#l12.347"></a><span id="l12.347">     if (aAvailabilityDetails === undefined || aAvailabilityDetails === null)</span>
<a href="#l12.348"></a><span id="l12.348">       aAvailabilityDetails = this._availabilityDetails;</span>
<a href="#l12.349"></a><span id="l12.349"> </span>
<a href="#l12.350"></a><span id="l12.350" class="difflineat">@@ -363,33 +363,33 @@ var GenericAccountBuddyPrototype = {</span>
<a href="#l12.351"></a><span id="l12.351">     notifications.forEach(function(aTopic) {</span>
<a href="#l12.352"></a><span id="l12.352">       this._notifyObservers(aTopic);</span>
<a href="#l12.353"></a><span id="l12.353">     }, this);</span>
<a href="#l12.354"></a><span id="l12.354">   },</span>
<a href="#l12.355"></a><span id="l12.355"> </span>
<a href="#l12.356"></a><span id="l12.356">   _availabilityDetails: 0,</span>
<a href="#l12.357"></a><span id="l12.357">   get availabilityDetails() { return this._availabilityDetails; },</span>
<a href="#l12.358"></a><span id="l12.358"> </span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-  get canSendMessage() { return this.online /*|| this.account.canSendOfflineMessage(this) */; },</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+  get canSendMessage() { return this.online; },</span>
<a href="#l12.361"></a><span id="l12.361"> </span>
<a href="#l12.362"></a><span id="l12.362">   getTooltipInfo: () =&gt; EmptyEnumerator,</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-  createConversation: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+  createConversation() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.365"></a><span id="l12.365"> };</span>
<a href="#l12.366"></a><span id="l12.366"> </span>
<a href="#l12.367"></a><span id="l12.367"> // aUserName is required only if aBuddy is null, i.e., we are adding a buddy.</span>
<a href="#l12.368"></a><span id="l12.368"> function AccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l12.369"></a><span id="l12.369">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l12.370"></a><span id="l12.370"> }</span>
<a href="#l12.371"></a><span id="l12.371"> AccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l12.372"></a><span id="l12.372"> </span>
<a href="#l12.373"></a><span id="l12.373"> var GenericMessagePrototype = {</span>
<a href="#l12.374"></a><span id="l12.374">   __proto__: ClassInfo(&quot;prplIMessage&quot;, &quot;generic message object&quot;),</span>
<a href="#l12.375"></a><span id="l12.375"> </span>
<a href="#l12.376"></a><span id="l12.376">   _lastId: 0,</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-  _init: function (aWho, aMessage, aObject) {</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+  _init(aWho, aMessage, aObject) {</span>
<a href="#l12.379"></a><span id="l12.379">     this.id = ++GenericMessagePrototype._lastId;</span>
<a href="#l12.380"></a><span id="l12.380">     this.time = Math.floor(new Date() / 1000);</span>
<a href="#l12.381"></a><span id="l12.381">     this.who = aWho;</span>
<a href="#l12.382"></a><span id="l12.382">     this.message = aMessage;</span>
<a href="#l12.383"></a><span id="l12.383">     this.originalMessage = aMessage;</span>
<a href="#l12.384"></a><span id="l12.384"> </span>
<a href="#l12.385"></a><span id="l12.385">     if (aObject)</span>
<a href="#l12.386"></a><span id="l12.386">       for (let i in aObject)</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineat">@@ -426,21 +426,21 @@ var GenericMessagePrototype = {</span>
<a href="#l12.388"></a><span id="l12.388">   noLog: false,</span>
<a href="#l12.389"></a><span id="l12.389">   error: false,</span>
<a href="#l12.390"></a><span id="l12.390">   delayed: false,</span>
<a href="#l12.391"></a><span id="l12.391">   noFormat: false,</span>
<a href="#l12.392"></a><span id="l12.392">   containsImages: false,</span>
<a href="#l12.393"></a><span id="l12.393">   notification: false,</span>
<a href="#l12.394"></a><span id="l12.394">   noLinkification: false,</span>
<a href="#l12.395"></a><span id="l12.395"> </span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-  getActions: function(aCount) {</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+  getActions(aCount) {</span>
<a href="#l12.398"></a><span id="l12.398">     if (aCount)</span>
<a href="#l12.399"></a><span id="l12.399">       aCount.value = 0;</span>
<a href="#l12.400"></a><span id="l12.400">     return [];</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-  }</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+  },</span>
<a href="#l12.403"></a><span id="l12.403"> };</span>
<a href="#l12.404"></a><span id="l12.404"> </span>
<a href="#l12.405"></a><span id="l12.405"> function Message(aWho, aMessage, aObject) {</span>
<a href="#l12.406"></a><span id="l12.406">   this._init(aWho, aMessage, aObject);</span>
<a href="#l12.407"></a><span id="l12.407"> }</span>
<a href="#l12.408"></a><span id="l12.408"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l12.409"></a><span id="l12.409"> </span>
<a href="#l12.410"></a><span id="l12.410"> </span>
<a href="#l12.411"></a><span id="l12.411" class="difflineat">@@ -448,108 +448,108 @@ var GenericConversationPrototype = {</span>
<a href="#l12.412"></a><span id="l12.412">   __proto__: ClassInfo(&quot;prplIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l12.413"></a><span id="l12.413">   get wrappedJSObject() { return this; },</span>
<a href="#l12.414"></a><span id="l12.414"> </span>
<a href="#l12.415"></a><span id="l12.415">   get DEBUG() { return this._account.DEBUG; },</span>
<a href="#l12.416"></a><span id="l12.416">   get LOG() { return this._account.LOG; },</span>
<a href="#l12.417"></a><span id="l12.417">   get WARN() { return this._account.WARN; },</span>
<a href="#l12.418"></a><span id="l12.418">   get ERROR() { return this._account.ERROR; },</span>
<a href="#l12.419"></a><span id="l12.419"> </span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-  _init: function(aAccount, aName) {</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+  _init(aAccount, aName) {</span>
<a href="#l12.422"></a><span id="l12.422">     this._account = aAccount;</span>
<a href="#l12.423"></a><span id="l12.423">     this._name = aName;</span>
<a href="#l12.424"></a><span id="l12.424">     this._observers = [];</span>
<a href="#l12.425"></a><span id="l12.425">     this._date = new Date() * 1000;</span>
<a href="#l12.426"></a><span id="l12.426">     Services.conversations.addConversation(this);</span>
<a href="#l12.427"></a><span id="l12.427">   },</span>
<a href="#l12.428"></a><span id="l12.428"> </span>
<a href="#l12.429"></a><span id="l12.429">   _id: 0,</span>
<a href="#l12.430"></a><span id="l12.430">   get id() { return this._id; },</span>
<a href="#l12.431"></a><span id="l12.431">   set id(aId) {</span>
<a href="#l12.432"></a><span id="l12.432">     if (this._id)</span>
<a href="#l12.433"></a><span id="l12.433">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l12.434"></a><span id="l12.434">     this._id = aId;</span>
<a href="#l12.435"></a><span id="l12.435">   },</span>
<a href="#l12.436"></a><span id="l12.436"> </span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-  addObserver: function(aObserver) {</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l12.439"></a><span id="l12.439">     if (!this._observers.includes(aObserver))</span>
<a href="#l12.440"></a><span id="l12.440">       this._observers.push(aObserver);</span>
<a href="#l12.441"></a><span id="l12.441">   },</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-  removeObserver: function(aObserver) {</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l12.444"></a><span id="l12.444">     this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l12.445"></a><span id="l12.445">   },</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-  notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l12.448"></a><span id="l12.448">     for (let observer of this._observers) {</span>
<a href="#l12.449"></a><span id="l12.449">       try {</span>
<a href="#l12.450"></a><span id="l12.450">         observer.observe(aSubject, aTopic, aData);</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-      } catch(e) {</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+      } catch (e) {</span>
<a href="#l12.453"></a><span id="l12.453">         this.ERROR(e);</span>
<a href="#l12.454"></a><span id="l12.454">       }</span>
<a href="#l12.455"></a><span id="l12.455">     }</span>
<a href="#l12.456"></a><span id="l12.456">   },</span>
<a href="#l12.457"></a><span id="l12.457"> </span>
<a href="#l12.458"></a><span id="l12.458">   prepareForSending: (aOutgoingMessage, aCount) =&gt; null,</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-  prepareForDisplaying: function(aImMessage) {</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+  prepareForDisplaying(aImMessage) {</span>
<a href="#l12.461"></a><span id="l12.461">     if (aImMessage.displayMessage !== aImMessage.message) {</span>
<a href="#l12.462"></a><span id="l12.462">       this.DEBUG(&quot;Preparing:\n&quot; + aImMessage.message + &quot;\nDisplaying:\n&quot; +</span>
<a href="#l12.463"></a><span id="l12.463">                  aImMessage.displayMessage);</span>
<a href="#l12.464"></a><span id="l12.464">     }</span>
<a href="#l12.465"></a><span id="l12.465">   },</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-  sendMsg: function(aMsg) {</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l12.468"></a><span id="l12.468">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.469"></a><span id="l12.469">   },</span>
<a href="#l12.470"></a><span id="l12.470">   sendTyping: aString =&gt; Ci.prplIConversation.NO_TYPING_LIMIT,</span>
<a href="#l12.471"></a><span id="l12.471"> </span>
<a href="#l12.472"></a><span id="l12.472" class="difflineminus">-  close: function() {</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+  close() {</span>
<a href="#l12.474"></a><span id="l12.474">     Services.obs.notifyObservers(this, &quot;closing-conversation&quot;);</span>
<a href="#l12.475"></a><span id="l12.475">     Services.conversations.removeConversation(this);</span>
<a href="#l12.476"></a><span id="l12.476">   },</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-  unInit: function() {</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineplus">+  unInit() {</span>
<a href="#l12.479"></a><span id="l12.479">     delete this._account;</span>
<a href="#l12.480"></a><span id="l12.480">     delete this._observers;</span>
<a href="#l12.481"></a><span id="l12.481">   },</span>
<a href="#l12.482"></a><span id="l12.482"> </span>
<a href="#l12.483"></a><span id="l12.483" class="difflineminus">-  writeMessage: function(aWho, aText, aProperties) {</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineplus">+  writeMessage(aWho, aText, aProperties) {</span>
<a href="#l12.485"></a><span id="l12.485">     (new Message(aWho, aText, aProperties)).conversation = this;</span>
<a href="#l12.486"></a><span id="l12.486">   },</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488">   get account() { return this._account.imAccount; },</span>
<a href="#l12.489"></a><span id="l12.489">   get name() { return this._name; },</span>
<a href="#l12.490"></a><span id="l12.490">   get normalizedName() { return this._account.normalize(this.name); },</span>
<a href="#l12.491"></a><span id="l12.491">   get title() { return this.name; },</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-  get startDate() { return this._date; }</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+  get startDate() { return this._date; },</span>
<a href="#l12.494"></a><span id="l12.494"> };</span>
<a href="#l12.495"></a><span id="l12.495"> </span>
<a href="#l12.496"></a><span id="l12.496"> var GenericConvIMPrototype = {</span>
<a href="#l12.497"></a><span id="l12.497">   __proto__: GenericConversationPrototype,</span>
<a href="#l12.498"></a><span id="l12.498">   _interfaces: [Ci.prplIConversation, Ci.prplIConvIM],</span>
<a href="#l12.499"></a><span id="l12.499">   classDescription: &quot;generic ConvIM object&quot;,</span>
<a href="#l12.500"></a><span id="l12.500"> </span>
<a href="#l12.501"></a><span id="l12.501" class="difflineminus">-  updateTyping: function(aState, aName) {</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+  updateTyping(aState, aName) {</span>
<a href="#l12.503"></a><span id="l12.503">     if (aState == this.typingState)</span>
<a href="#l12.504"></a><span id="l12.504">       return;</span>
<a href="#l12.505"></a><span id="l12.505"> </span>
<a href="#l12.506"></a><span id="l12.506">     if (aState == Ci.prplIConvIM.NOT_TYPING)</span>
<a href="#l12.507"></a><span id="l12.507">       delete this.typingState;</span>
<a href="#l12.508"></a><span id="l12.508">     else</span>
<a href="#l12.509"></a><span id="l12.509">       this.typingState = aState;</span>
<a href="#l12.510"></a><span id="l12.510">     this.notifyObservers(null, &quot;update-typing&quot;, aName);</span>
<a href="#l12.511"></a><span id="l12.511">   },</span>
<a href="#l12.512"></a><span id="l12.512"> </span>
<a href="#l12.513"></a><span id="l12.513">   get isChat() { return false; },</span>
<a href="#l12.514"></a><span id="l12.514">   buddy: null,</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-  typingState: Ci.prplIConvIM.NOT_TYPING</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineplus">+  typingState: Ci.prplIConvIM.NOT_TYPING,</span>
<a href="#l12.517"></a><span id="l12.517"> };</span>
<a href="#l12.518"></a><span id="l12.518"> </span>
<a href="#l12.519"></a><span id="l12.519"> var GenericConvChatPrototype = {</span>
<a href="#l12.520"></a><span id="l12.520">   __proto__: GenericConversationPrototype,</span>
<a href="#l12.521"></a><span id="l12.521">   _interfaces: [Ci.prplIConversation, Ci.prplIConvChat],</span>
<a href="#l12.522"></a><span id="l12.522">   classDescription: &quot;generic ConvChat object&quot;,</span>
<a href="#l12.523"></a><span id="l12.523"> </span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-  _init: function(aAccount, aName, aNick) {</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineplus">+  _init(aAccount, aName, aNick) {</span>
<a href="#l12.526"></a><span id="l12.526">     this._participants = new Map();</span>
<a href="#l12.527"></a><span id="l12.527">     this.nick = aNick;</span>
<a href="#l12.528"></a><span id="l12.528">     GenericConversationPrototype._init.call(this, aAccount, aName);</span>
<a href="#l12.529"></a><span id="l12.529">   },</span>
<a href="#l12.530"></a><span id="l12.530"> </span>
<a href="#l12.531"></a><span id="l12.531">   get isChat() { return true; },</span>
<a href="#l12.532"></a><span id="l12.532"> </span>
<a href="#l12.533"></a><span id="l12.533">   // Stores the prplIChatRoomFieldValues required to join this channel</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineat">@@ -557,17 +557,17 @@ var GenericConvChatPrototype = {</span>
<a href="#l12.535"></a><span id="l12.535">   // automatically after disconnections.</span>
<a href="#l12.536"></a><span id="l12.536">   chatRoomFields: null,</span>
<a href="#l12.537"></a><span id="l12.537"> </span>
<a href="#l12.538"></a><span id="l12.538">   _topic: &quot;&quot;,</span>
<a href="#l12.539"></a><span id="l12.539">   _topicSetter: null,</span>
<a href="#l12.540"></a><span id="l12.540">   get topic() { return this._topic; },</span>
<a href="#l12.541"></a><span id="l12.541">   get topicSettable() { return false; },</span>
<a href="#l12.542"></a><span id="l12.542">   get topicSetter() { return this._topicSetter; },</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-  setTopic: function(aTopic, aTopicSetter, aQuiet) {</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineplus">+  setTopic(aTopic, aTopicSetter, aQuiet) {</span>
<a href="#l12.545"></a><span id="l12.545">     // Only change the topic if the topic and/or topic setter has changed.</span>
<a href="#l12.546"></a><span id="l12.546">     if (this._topic == aTopic &amp;&amp;</span>
<a href="#l12.547"></a><span id="l12.547">         (!this._topicSetter || this._topicSetter == aTopicSetter))</span>
<a href="#l12.548"></a><span id="l12.548">       return;</span>
<a href="#l12.549"></a><span id="l12.549"> </span>
<a href="#l12.550"></a><span id="l12.550">     this._topic = aTopic;</span>
<a href="#l12.551"></a><span id="l12.551">     this._topicSetter = aTopicSetter;</span>
<a href="#l12.552"></a><span id="l12.552"> </span>
<a href="#l12.553"></a><span id="l12.553" class="difflineat">@@ -614,29 +614,29 @@ var GenericConvChatPrototype = {</span>
<a href="#l12.554"></a><span id="l12.554">   get joining() { return this._joining; },</span>
<a href="#l12.555"></a><span id="l12.555">   set joining(aJoining) {</span>
<a href="#l12.556"></a><span id="l12.556">     if (aJoining == this._joining)</span>
<a href="#l12.557"></a><span id="l12.557">       return;</span>
<a href="#l12.558"></a><span id="l12.558">     this._joining = aJoining;</span>
<a href="#l12.559"></a><span id="l12.559">     this.notifyObservers(null, &quot;update-conv-chatjoining&quot;);</span>
<a href="#l12.560"></a><span id="l12.560">   },</span>
<a href="#l12.561"></a><span id="l12.561"> </span>
<a href="#l12.562"></a><span id="l12.562" class="difflineminus">-  getParticipant: function(aName) {</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+  getParticipant(aName) {</span>
<a href="#l12.564"></a><span id="l12.564">     return this._participants.has(aName) ? this._participants.get(aName) : null;</span>
<a href="#l12.565"></a><span id="l12.565">   },</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineminus">-  getParticipants: function() {</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+  getParticipants() {</span>
<a href="#l12.568"></a><span id="l12.568">     // Convert the values of the Map into a nsSimpleEnumerator.</span>
<a href="#l12.569"></a><span id="l12.569">     return new nsSimpleEnumerator(</span>
<a href="#l12.570"></a><span id="l12.570">       Array.from(this._participants.values())</span>
<a href="#l12.571"></a><span id="l12.571">     );</span>
<a href="#l12.572"></a><span id="l12.572">   },</span>
<a href="#l12.573"></a><span id="l12.573">   getNormalizedChatBuddyName: aChatBuddyName =&gt; aChatBuddyName,</span>
<a href="#l12.574"></a><span id="l12.574"> </span>
<a href="#l12.575"></a><span id="l12.575">   // Updates the nick of a participant in conversation to a new one.</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineminus">-  updateNick: function(aOldNick, aNewNick, isOwnNick) {</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+  updateNick(aOldNick, aNewNick, isOwnNick) {</span>
<a href="#l12.578"></a><span id="l12.578">     let message;</span>
<a href="#l12.579"></a><span id="l12.579">     let isParticipant = this._participants.has(aOldNick);</span>
<a href="#l12.580"></a><span id="l12.580">     if (isOwnNick) {</span>
<a href="#l12.581"></a><span id="l12.581">       // If this is the user's nick, change it.</span>
<a href="#l12.582"></a><span id="l12.582">       this.nick = aNewNick;</span>
<a href="#l12.583"></a><span id="l12.583">       message = _(&quot;nickSet.you&quot;, aNewNick);</span>
<a href="#l12.584"></a><span id="l12.584"> </span>
<a href="#l12.585"></a><span id="l12.585">       // If the account was disconnected, it's OK the user is not a participant.</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineat">@@ -659,47 +659,47 @@ var GenericConvChatPrototype = {</span>
<a href="#l12.587"></a><span id="l12.587">     participant.name = aNewNick;</span>
<a href="#l12.588"></a><span id="l12.588">     this._participants.set(aNewNick, participant);</span>
<a href="#l12.589"></a><span id="l12.589"> </span>
<a href="#l12.590"></a><span id="l12.590">     this.notifyObservers(participant, &quot;chat-buddy-update&quot;, aOldNick);</span>
<a href="#l12.591"></a><span id="l12.591">     this.writeMessage(aOldNick, message, {system: true});</span>
<a href="#l12.592"></a><span id="l12.592">   },</span>
<a href="#l12.593"></a><span id="l12.593"> </span>
<a href="#l12.594"></a><span id="l12.594">   // Removes a participant from conversation.</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-  removeParticipant: function(aNick) {</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+  removeParticipant(aNick) {</span>
<a href="#l12.597"></a><span id="l12.597">     if (!this._participants.has(aNick))</span>
<a href="#l12.598"></a><span id="l12.598">       return;</span>
<a href="#l12.599"></a><span id="l12.599"> </span>
<a href="#l12.600"></a><span id="l12.600">     let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.601"></a><span id="l12.601">                            .createInstance(Ci.nsISupportsString);</span>
<a href="#l12.602"></a><span id="l12.602">     stringNickname.data = aNick;</span>
<a href="#l12.603"></a><span id="l12.603">     this.notifyObservers(new nsSimpleEnumerator([stringNickname]),</span>
<a href="#l12.604"></a><span id="l12.604">                          &quot;chat-buddy-remove&quot;);</span>
<a href="#l12.605"></a><span id="l12.605">     this._participants.delete(aNick);</span>
<a href="#l12.606"></a><span id="l12.606">   },</span>
<a href="#l12.607"></a><span id="l12.607"> </span>
<a href="#l12.608"></a><span id="l12.608">   // Removes all participant in conversation.</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineminus">-  removeAllParticipants: function() {</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+  removeAllParticipants() {</span>
<a href="#l12.611"></a><span id="l12.611">     let stringNicknames = [];</span>
<a href="#l12.612"></a><span id="l12.612">     this._participants.forEach(function(aParticipant) {</span>
<a href="#l12.613"></a><span id="l12.613">       let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.614"></a><span id="l12.614">                               .createInstance(Ci.nsISupportsString);</span>
<a href="#l12.615"></a><span id="l12.615">       stringNickname.data = aParticipant.name;</span>
<a href="#l12.616"></a><span id="l12.616">       stringNicknames.push(stringNickname);</span>
<a href="#l12.617"></a><span id="l12.617">     });</span>
<a href="#l12.618"></a><span id="l12.618">     this.notifyObservers(new nsSimpleEnumerator(stringNicknames),</span>
<a href="#l12.619"></a><span id="l12.619">                          &quot;chat-buddy-remove&quot;);</span>
<a href="#l12.620"></a><span id="l12.620">     this._participants.clear();</span>
<a href="#l12.621"></a><span id="l12.621">   },</span>
<a href="#l12.622"></a><span id="l12.622"> </span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-  writeMessage: function (aWho, aText, aProperties) {</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+  writeMessage(aWho, aText, aProperties) {</span>
<a href="#l12.625"></a><span id="l12.625">     aProperties.containsNick =</span>
<a href="#l12.626"></a><span id="l12.626">       &quot;incoming&quot; in aProperties &amp;&amp; this._pingRegexp.test(aText);</span>
<a href="#l12.627"></a><span id="l12.627">     GenericConversationPrototype.writeMessage.apply(this, arguments);</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineminus">-  }</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineplus">+  },</span>
<a href="#l12.630"></a><span id="l12.630"> };</span>
<a href="#l12.631"></a><span id="l12.631"> </span>
<a href="#l12.632"></a><span id="l12.632"> var GenericConvChatBuddyPrototype = {</span>
<a href="#l12.633"></a><span id="l12.633">   __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;generic ConvChatBuddy object&quot;),</span>
<a href="#l12.634"></a><span id="l12.634"> </span>
<a href="#l12.635"></a><span id="l12.635">   _name: &quot;&quot;,</span>
<a href="#l12.636"></a><span id="l12.636">   get name() { return this._name; },</span>
<a href="#l12.637"></a><span id="l12.637">   set name(aName) { this._name = aName; },</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineat">@@ -710,17 +710,17 @@ var GenericConvChatBuddyPrototype = {</span>
<a href="#l12.639"></a><span id="l12.639">   get noFlags() {</span>
<a href="#l12.640"></a><span id="l12.640">     return !(this.voiced || this.halfOp || this.op ||</span>
<a href="#l12.641"></a><span id="l12.641">              this.founder || this.typing);</span>
<a href="#l12.642"></a><span id="l12.642">   },</span>
<a href="#l12.643"></a><span id="l12.643">   voiced: false,</span>
<a href="#l12.644"></a><span id="l12.644">   halfOp: false,</span>
<a href="#l12.645"></a><span id="l12.645">   op: false,</span>
<a href="#l12.646"></a><span id="l12.646">   founder: false,</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineminus">-  typing: false</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+  typing: false,</span>
<a href="#l12.649"></a><span id="l12.649"> };</span>
<a href="#l12.650"></a><span id="l12.650"> </span>
<a href="#l12.651"></a><span id="l12.651"> function TooltipInfo(aLabel, aValue, aType = Ci.prplITooltipInfo.pair) {</span>
<a href="#l12.652"></a><span id="l12.652">   this.type = aType;</span>
<a href="#l12.653"></a><span id="l12.653">   if (aType == Ci.prplITooltipInfo.status) {</span>
<a href="#l12.654"></a><span id="l12.654">     this.label = aLabel.toString();</span>
<a href="#l12.655"></a><span id="l12.655">     this.value = aValue || &quot;&quot;;</span>
<a href="#l12.656"></a><span id="l12.656">   }</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineat">@@ -775,30 +775,30 @@ function purplePref(aName, aOption) {</span>
<a href="#l12.658"></a><span id="l12.658">     this.masked = true;</span>
<a href="#l12.659"></a><span id="l12.659"> }</span>
<a href="#l12.660"></a><span id="l12.660"> purplePref.prototype = {</span>
<a href="#l12.661"></a><span id="l12.661">   __proto__: ClassInfo(&quot;prplIPref&quot;, &quot;generic account option preference&quot;),</span>
<a href="#l12.662"></a><span id="l12.662"> </span>
<a href="#l12.663"></a><span id="l12.663">   masked: false,</span>
<a href="#l12.664"></a><span id="l12.664"> </span>
<a href="#l12.665"></a><span id="l12.665">   // Default value</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-  getBool: function() { return this._defaultValue; },</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-  getInt: function() { return this._defaultValue; },</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineminus">-  getString: function() { return this._defaultValue; },</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineminus">-  getList: function() {</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineplus">+  getBool() { return this._defaultValue; },</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineplus">+  getInt() { return this._defaultValue; },</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineplus">+  getString() { return this._defaultValue; },</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineplus">+  getList() {</span>
<a href="#l12.674"></a><span id="l12.674">     // Convert a JavaScript object map {&quot;value 1&quot;: &quot;label 1&quot;, ...}</span>
<a href="#l12.675"></a><span id="l12.675">     let keys = Object.keys(this._listValues);</span>
<a href="#l12.676"></a><span id="l12.676">     if (!keys.length)</span>
<a href="#l12.677"></a><span id="l12.677">       return EmptyEnumerator;</span>
<a href="#l12.678"></a><span id="l12.678"> </span>
<a href="#l12.679"></a><span id="l12.679">     return new nsSimpleEnumerator(</span>
<a href="#l12.680"></a><span id="l12.680">       keys.map(key =&gt; new purpleKeyValuePair(this._listValues[key], key))</span>
<a href="#l12.681"></a><span id="l12.681">     );</span>
<a href="#l12.682"></a><span id="l12.682">   },</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineminus">-  getListDefault: function() { return this._defaultValue; }</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineplus">+  getListDefault() { return this._defaultValue; },</span>
<a href="#l12.685"></a><span id="l12.685"> };</span>
<a href="#l12.686"></a><span id="l12.686"> </span>
<a href="#l12.687"></a><span id="l12.687"> function purpleKeyValuePair(aName, aValue) {</span>
<a href="#l12.688"></a><span id="l12.688">   this.name = aName;</span>
<a href="#l12.689"></a><span id="l12.689">   this.value = aValue;</span>
<a href="#l12.690"></a><span id="l12.690"> }</span>
<a href="#l12.691"></a><span id="l12.691"> purpleKeyValuePair.prototype =</span>
<a href="#l12.692"></a><span id="l12.692">   ClassInfo(&quot;prplIKeyValuePair&quot;, &quot;generic Key Value Pair&quot;);</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineat">@@ -807,17 +807,17 @@ function UsernameSplit(aValues) {</span>
<a href="#l12.694"></a><span id="l12.694">   this._values = aValues;</span>
<a href="#l12.695"></a><span id="l12.695"> }</span>
<a href="#l12.696"></a><span id="l12.696"> UsernameSplit.prototype = {</span>
<a href="#l12.697"></a><span id="l12.697">   __proto__: ClassInfo(&quot;prplIUsernameSplit&quot;, &quot;username split object&quot;),</span>
<a href="#l12.698"></a><span id="l12.698"> </span>
<a href="#l12.699"></a><span id="l12.699">   get label() { return this._values.label; },</span>
<a href="#l12.700"></a><span id="l12.700">   get separator() { return this._values.separator; },</span>
<a href="#l12.701"></a><span id="l12.701">   get defaultValue() { return this._values.defaultValue; },</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineminus">-  get reverse() { return !!this._values.reverse; } // Ensure boolean</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineplus">+  get reverse() { return !!this._values.reverse; }, // Ensure boolean</span>
<a href="#l12.704"></a><span id="l12.704"> };</span>
<a href="#l12.705"></a><span id="l12.705"> </span>
<a href="#l12.706"></a><span id="l12.706"> function ChatRoomField(aIdentifier, aField) {</span>
<a href="#l12.707"></a><span id="l12.707">   this.identifier = aIdentifier;</span>
<a href="#l12.708"></a><span id="l12.708">   this.label = aField.label;</span>
<a href="#l12.709"></a><span id="l12.709">   this.required = !!aField.required;</span>
<a href="#l12.710"></a><span id="l12.710"> </span>
<a href="#l12.711"></a><span id="l12.711">   let type = &quot;TEXT&quot;;</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineat">@@ -834,64 +834,64 @@ ChatRoomField.prototype =</span>
<a href="#l12.713"></a><span id="l12.713">   ClassInfo(&quot;prplIChatRoomField&quot;, &quot;ChatRoomField object&quot;);</span>
<a href="#l12.714"></a><span id="l12.714"> </span>
<a href="#l12.715"></a><span id="l12.715"> function ChatRoomFieldValues(aMap) {</span>
<a href="#l12.716"></a><span id="l12.716">   this.values = aMap;</span>
<a href="#l12.717"></a><span id="l12.717"> }</span>
<a href="#l12.718"></a><span id="l12.718"> ChatRoomFieldValues.prototype = {</span>
<a href="#l12.719"></a><span id="l12.719">   __proto__: ClassInfo(&quot;prplIChatRoomFieldValues&quot;, &quot;ChatRoomFieldValues&quot;),</span>
<a href="#l12.720"></a><span id="l12.720"> </span>
<a href="#l12.721"></a><span id="l12.721" class="difflineminus">-  getValue: function(aIdentifier) {</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineplus">+  getValue(aIdentifier) {</span>
<a href="#l12.723"></a><span id="l12.723">     return this.values.hasOwnProperty(aIdentifier) ? this.values[aIdentifier] : null;</span>
<a href="#l12.724"></a><span id="l12.724">   },</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineminus">-  setValue: function(aIdentifier, aValue) {</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineplus">+  setValue(aIdentifier, aValue) {</span>
<a href="#l12.727"></a><span id="l12.727">     this.values[aIdentifier] = aValue;</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineminus">-  }</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineplus">+  },</span>
<a href="#l12.730"></a><span id="l12.730"> };</span>
<a href="#l12.731"></a><span id="l12.731"> </span>
<a href="#l12.732"></a><span id="l12.732"> // the name getter and the getAccount method need to be implemented by</span>
<a href="#l12.733"></a><span id="l12.733"> // protocol plugins.</span>
<a href="#l12.734"></a><span id="l12.734"> var GenericProtocolPrototype = {</span>
<a href="#l12.735"></a><span id="l12.735">   __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Generic protocol object&quot;),</span>
<a href="#l12.736"></a><span id="l12.736"> </span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-  init: function(aId) {</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineplus">+  init(aId) {</span>
<a href="#l12.739"></a><span id="l12.739">     if (aId != this.id)</span>
<a href="#l12.740"></a><span id="l12.740">       throw &quot;Creating an instance of &quot; + aId + &quot; but this object implements &quot; + this.id;</span>
<a href="#l12.741"></a><span id="l12.741">   },</span>
<a href="#l12.742"></a><span id="l12.742">   get id() { return &quot;prpl-&quot; + this.normalizedName; },</span>
<a href="#l12.743"></a><span id="l12.743">   // This is more aggressive than the account normalization of just</span>
<a href="#l12.744"></a><span id="l12.744">   // toLowerCase() since prpl names must be only letters/numbers.</span>
<a href="#l12.745"></a><span id="l12.745">   get normalizedName() { return this.name.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(); },</span>
<a href="#l12.746"></a><span id="l12.746">   get iconBaseURI() { return &quot;chrome://chat/skin/prpl-generic/&quot;; },</span>
<a href="#l12.747"></a><span id="l12.747"> </span>
<a href="#l12.748"></a><span id="l12.748" class="difflineminus">-  getAccount: function(aImAccount) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineplus">+  getAccount(aImAccount) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.750"></a><span id="l12.750"> </span>
<a href="#l12.751"></a><span id="l12.751" class="difflineminus">-  _getOptionDefault: function(aName) {</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineplus">+  _getOptionDefault(aName) {</span>
<a href="#l12.753"></a><span id="l12.753">     if (this.options &amp;&amp; this.options.hasOwnProperty(aName))</span>
<a href="#l12.754"></a><span id="l12.754">       return this.options[aName].default;</span>
<a href="#l12.755"></a><span id="l12.755">     throw aName + &quot; has no default value in &quot; + this.id + &quot;.&quot;;</span>
<a href="#l12.756"></a><span id="l12.756">   },</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineminus">-  getOptions: function() {</span>
<a href="#l12.758"></a><span id="l12.758" class="difflineplus">+  getOptions() {</span>
<a href="#l12.759"></a><span id="l12.759">     if (!this.options)</span>
<a href="#l12.760"></a><span id="l12.760">       return EmptyEnumerator;</span>
<a href="#l12.761"></a><span id="l12.761"> </span>
<a href="#l12.762"></a><span id="l12.762">     let purplePrefs = [];</span>
<a href="#l12.763"></a><span id="l12.763">     for (let [name, option] of Object.entries(this.options))</span>
<a href="#l12.764"></a><span id="l12.764">       purplePrefs.push(new purplePref(name, option));</span>
<a href="#l12.765"></a><span id="l12.765">     return new nsSimpleEnumerator(purplePrefs);</span>
<a href="#l12.766"></a><span id="l12.766">   },</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineminus">-  getUsernameSplit: function() {</span>
<a href="#l12.768"></a><span id="l12.768" class="difflineplus">+  getUsernameSplit() {</span>
<a href="#l12.769"></a><span id="l12.769">     if (!this.usernameSplits || !this.usernameSplits.length)</span>
<a href="#l12.770"></a><span id="l12.770">       return EmptyEnumerator;</span>
<a href="#l12.771"></a><span id="l12.771"> </span>
<a href="#l12.772"></a><span id="l12.772">     return new nsSimpleEnumerator(</span>
<a href="#l12.773"></a><span id="l12.773">       this.usernameSplits.map(split =&gt; new UsernameSplit(split)));</span>
<a href="#l12.774"></a><span id="l12.774">   },</span>
<a href="#l12.775"></a><span id="l12.775"> </span>
<a href="#l12.776"></a><span id="l12.776" class="difflineminus">-  registerCommands: function() {</span>
<a href="#l12.777"></a><span id="l12.777" class="difflineplus">+  registerCommands() {</span>
<a href="#l12.778"></a><span id="l12.778">     if (!this.commands)</span>
<a href="#l12.779"></a><span id="l12.779">       return;</span>
<a href="#l12.780"></a><span id="l12.780"> </span>
<a href="#l12.781"></a><span id="l12.781">     this.commands.forEach(function(command) {</span>
<a href="#l12.782"></a><span id="l12.782">       if (!command.hasOwnProperty(&quot;name&quot;) || !command.hasOwnProperty(&quot;run&quot;))</span>
<a href="#l12.783"></a><span id="l12.783">         throw &quot;Every command must have a name and a run function.&quot;;</span>
<a href="#l12.784"></a><span id="l12.784">       if (!(&quot;QueryInterface&quot; in command))</span>
<a href="#l12.785"></a><span id="l12.785">         command.QueryInterface = ChromeUtils.generateQI([Ci.imICommand]);</span>
<a href="#l12.786"></a><span id="l12.786" class="difflineat">@@ -900,24 +900,24 @@ var GenericProtocolPrototype = {</span>
<a href="#l12.787"></a><span id="l12.787">       if (!command.hasOwnProperty(&quot;priority&quot;))</span>
<a href="#l12.788"></a><span id="l12.788">         command.priority = Ci.imICommand.CMD_PRIORITY_PRPL;</span>
<a href="#l12.789"></a><span id="l12.789">       Services.cmd.registerCommand(command, this.id);</span>
<a href="#l12.790"></a><span id="l12.790">     }, this);</span>
<a href="#l12.791"></a><span id="l12.791">   },</span>
<a href="#l12.792"></a><span id="l12.792"> </span>
<a href="#l12.793"></a><span id="l12.793">   // NS_ERROR_XPC_JSOBJECT_HAS_NO_FUNCTION_NAMED errors are too noisy</span>
<a href="#l12.794"></a><span id="l12.794">   get usernameEmptyText() { return &quot;&quot;; },</span>
<a href="#l12.795"></a><span id="l12.795" class="difflineminus">-  accountExists: () =&gt; false, //FIXME</span>
<a href="#l12.796"></a><span id="l12.796" class="difflineplus">+  accountExists: () =&gt; false, // FIXME</span>
<a href="#l12.797"></a><span id="l12.797"> </span>
<a href="#l12.798"></a><span id="l12.798">   get uniqueChatName() { return false; },</span>
<a href="#l12.799"></a><span id="l12.799">   get chatHasTopic() { return false; },</span>
<a href="#l12.800"></a><span id="l12.800">   get noPassword() { return false; },</span>
<a href="#l12.801"></a><span id="l12.801">   get newMailNotification() { return false; },</span>
<a href="#l12.802"></a><span id="l12.802">   get imagesInIM() { return false; },</span>
<a href="#l12.803"></a><span id="l12.803">   get passwordOptional() { return false; },</span>
<a href="#l12.804"></a><span id="l12.804">   get usePointSize() { return true; },</span>
<a href="#l12.805"></a><span id="l12.805">   get registerNoScreenName() { return false; },</span>
<a href="#l12.806"></a><span id="l12.806">   get slashCommandsNative() { return false; },</span>
<a href="#l12.807"></a><span id="l12.807">   get usePurpleProxy() { return false; },</span>
<a href="#l12.808"></a><span id="l12.808"> </span>
<a href="#l12.809"></a><span id="l12.809">   get classDescription() { return this.name + &quot; Protocol&quot;; },</span>
<a href="#l12.810"></a><span id="l12.810" class="difflineminus">-  get contractID() { return &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;; }</span>
<a href="#l12.811"></a><span id="l12.811" class="difflineplus">+  get contractID() { return &quot;@mozilla.org/chat/&quot; + this.normalizedName + &quot;;1&quot;; },</span>
<a href="#l12.812"></a><span id="l12.812"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -153,18 +153,18 @@ var Socket = {</span>
<a href="#l13.4"></a><span id="l13.4">    *****************************************************************************</span>
<a href="#l13.5"></a><span id="l13.5">    ******************************* Public methods ******************************</span>
<a href="#l13.6"></a><span id="l13.6">    *****************************************************************************</span>
<a href="#l13.7"></a><span id="l13.7">    */</span>
<a href="#l13.8"></a><span id="l13.8">   // Synchronously open a connection.</span>
<a href="#l13.9"></a><span id="l13.9">   // It connects to aHost and aPort, but uses aOriginHost and aOriginPort for</span>
<a href="#l13.10"></a><span id="l13.10">   // checking the certificate for them (see nsIRoutedSocketTransportService</span>
<a href="#l13.11"></a><span id="l13.11">   // in nsISocketTransportService.idl).</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  connect: function(aOriginHost, aOriginPort, aSecurity, aProxy,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                    aHost = aOriginHost, aPort = aOriginPort) {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  connect(aOriginHost, aOriginPort, aSecurity, aProxy,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+          aHost = aOriginHost, aPort = aOriginPort) {</span>
<a href="#l13.16"></a><span id="l13.16">     if (Services.io.offline)</span>
<a href="#l13.17"></a><span id="l13.17">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">     // This won't work for Linux due to bug 758848.</span>
<a href="#l13.20"></a><span id="l13.20">     Services.obs.addObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">     this.LOG(&quot;Connecting to: &quot; + aHost + &quot;:&quot; + aPort);</span>
<a href="#l13.23"></a><span id="l13.23">     this.originHost = aOriginHost;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -191,26 +191,26 @@ var Socket = {</span>
<a href="#l13.25"></a><span id="l13.25">                               .getService(Ci.nsIProtocolProxyService);</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">         // Add a URI scheme since, by default, some protocols (i.e. IRC) don't</span>
<a href="#l13.28"></a><span id="l13.28">         // have a URI scheme before the host.</span>
<a href="#l13.29"></a><span id="l13.29">         let uri = Services.io.newURI(&quot;http://&quot; + this.host);</span>
<a href="#l13.30"></a><span id="l13.30">         // This will return null when the result is known immediately and</span>
<a href="#l13.31"></a><span id="l13.31">         // the callback will just be dispatched to the current thread.</span>
<a href="#l13.32"></a><span id="l13.32">         this._proxyCancel = proxyService.asyncResolve(uri, this.proxyFlags, this);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-      } catch(e) {</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+      } catch (e) {</span>
<a href="#l13.35"></a><span id="l13.35">         Cu.reportError(e);</span>
<a href="#l13.36"></a><span id="l13.36">         // We had some error getting the proxy service, just don't use one.</span>
<a href="#l13.37"></a><span id="l13.37">         this._createTransport(null);</span>
<a href="#l13.38"></a><span id="l13.38">       }</span>
<a href="#l13.39"></a><span id="l13.39">     }</span>
<a href="#l13.40"></a><span id="l13.40">   },</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42">   // Disconnect all open streams.</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  disconnect: function() {</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  disconnect() {</span>
<a href="#l13.45"></a><span id="l13.45">     this.LOG(&quot;Disconnect&quot;);</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">     // Don't handle any remaining unhandled data.</span>
<a href="#l13.48"></a><span id="l13.48">     this._pendingData = [];</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50">     // Close all input and output streams.</span>
<a href="#l13.51"></a><span id="l13.51">     if (&quot;_inputStream&quot; in this) {</span>
<a href="#l13.52"></a><span id="l13.52">       this._inputStream.close();</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineat">@@ -241,96 +241,96 @@ var Socket = {</span>
<a href="#l13.54"></a><span id="l13.54">     delete this._lastAliveTime;</span>
<a href="#l13.55"></a><span id="l13.55">     Services.obs.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">     this.disconnected = true;</span>
<a href="#l13.58"></a><span id="l13.58">   },</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60">   // Send data on the output stream. Provide aLoggedData to log something</span>
<a href="#l13.61"></a><span id="l13.61">   // different than what is actually sent.</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  sendData: function(/* string */ aData, aLoggedData = aData) {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  sendData(/* string */ aData, aLoggedData = aData) {</span>
<a href="#l13.64"></a><span id="l13.64">     this.LOG(&quot;Sending:\n&quot; + aLoggedData);</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">     try {</span>
<a href="#l13.67"></a><span id="l13.67">       this._outputStream.write(aData, aData.length);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-    } catch(e) {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    } catch (e) {</span>
<a href="#l13.70"></a><span id="l13.70">       Cu.reportError(e);</span>
<a href="#l13.71"></a><span id="l13.71">     }</span>
<a href="#l13.72"></a><span id="l13.72">   },</span>
<a href="#l13.73"></a><span id="l13.73"> </span>
<a href="#l13.74"></a><span id="l13.74">   // Send a string to the output stream after converting the encoding. Provide</span>
<a href="#l13.75"></a><span id="l13.75">   // aLoggedData to log something different than what is actually sent.</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-  sendString: function(aString, aEncoding = &quot;UTF-8&quot;, aLoggedData = aString) {</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+  sendString(aString, aEncoding = &quot;UTF-8&quot;, aLoggedData = aString) {</span>
<a href="#l13.78"></a><span id="l13.78">     this.LOG(&quot;Sending:\n&quot; + aLoggedData);</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">     let converter = new ScriptableUnicodeConverter();</span>
<a href="#l13.81"></a><span id="l13.81">     converter.charset = aEncoding;</span>
<a href="#l13.82"></a><span id="l13.82">     try {</span>
<a href="#l13.83"></a><span id="l13.83">       let stream = converter.convertToInputStream(aString);</span>
<a href="#l13.84"></a><span id="l13.84">       this._outputStream.writeFrom(stream, stream.available());</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-    } catch(e) {</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    } catch (e) {</span>
<a href="#l13.87"></a><span id="l13.87">       Cu.reportError(e);</span>
<a href="#l13.88"></a><span id="l13.88">     }</span>
<a href="#l13.89"></a><span id="l13.89">   },</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  sendBinaryData: function(/* ArrayBuffer */ aData, aLoggedData) {</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  sendBinaryData(/* ArrayBuffer */ aData, aLoggedData) {</span>
<a href="#l13.93"></a><span id="l13.93">     this.LOG(&quot;Sending binary data:\n&quot; + (aLoggedData ||</span>
<a href="#l13.94"></a><span id="l13.94">              &quot;&lt;&quot; + ArrayBufferToHexString(aData) + &quot;&gt;&quot;));</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">     let byteArray = ArrayBufferToBytes(aData);</span>
<a href="#l13.97"></a><span id="l13.97">     try {</span>
<a href="#l13.98"></a><span id="l13.98">       // Send the data as a byte array</span>
<a href="#l13.99"></a><span id="l13.99">       this._binaryOutputStream.writeByteArray(byteArray, byteArray.length);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-    } catch(e) {</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    } catch (e) {</span>
<a href="#l13.102"></a><span id="l13.102">       Cu.reportError(e);</span>
<a href="#l13.103"></a><span id="l13.103">     }</span>
<a href="#l13.104"></a><span id="l13.104">   },</span>
<a href="#l13.105"></a><span id="l13.105"> </span>
<a href="#l13.106"></a><span id="l13.106">   disconnected: true,</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-  startTLS: function() {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  startTLS() {</span>
<a href="#l13.110"></a><span id="l13.110">     this.transport.securityInfo.QueryInterface(Ci.nsISSLSocketControl).StartTLS();</span>
<a href="#l13.111"></a><span id="l13.111">   },</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113">   // If using the ping functionality, this should be called whenever a message is</span>
<a href="#l13.114"></a><span id="l13.114">   // received (e.g. when it is known the socket is still open). Calling this for</span>
<a href="#l13.115"></a><span id="l13.115">   // the first time enables the ping functionality.</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-  resetPingTimer: function() {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  resetPingTimer() {</span>
<a href="#l13.118"></a><span id="l13.118">     // Clearing and setting timeouts is expensive, so we do it at most</span>
<a href="#l13.119"></a><span id="l13.119">     // once per eventloop spin cycle.</span>
<a href="#l13.120"></a><span id="l13.120">     if (this._resetPingTimerPending)</span>
<a href="#l13.121"></a><span id="l13.121">       return;</span>
<a href="#l13.122"></a><span id="l13.122">     this._resetPingTimerPending = true;</span>
<a href="#l13.123"></a><span id="l13.123">     executeSoon(this._delayedResetPingTimer.bind(this));</span>
<a href="#l13.124"></a><span id="l13.124">   },</span>
<a href="#l13.125"></a><span id="l13.125">   kTimeBeforePing: 120000, // 2 min</span>
<a href="#l13.126"></a><span id="l13.126">   kTimeAfterPingBeforeDisconnect: 30000, // 30 s</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-  _delayedResetPingTimer: function() {</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  _delayedResetPingTimer() {</span>
<a href="#l13.129"></a><span id="l13.129">     if (!this._resetPingTimerPending)</span>
<a href="#l13.130"></a><span id="l13.130">       return;</span>
<a href="#l13.131"></a><span id="l13.131">     delete this._resetPingTimerPending;</span>
<a href="#l13.132"></a><span id="l13.132">     if (this._pingTimer)</span>
<a href="#l13.133"></a><span id="l13.133">       clearTimeout(this._pingTimer);</span>
<a href="#l13.134"></a><span id="l13.134">     // Send a ping every 2 minutes if there's no traffic on the socket.</span>
<a href="#l13.135"></a><span id="l13.135">     this._pingTimer = setTimeout(this._sendPing.bind(this), this.kTimeBeforePing);</span>
<a href="#l13.136"></a><span id="l13.136">   },</span>
<a href="#l13.137"></a><span id="l13.137"> </span>
<a href="#l13.138"></a><span id="l13.138">   // If using the ping functionality, this should be called when a ping receives</span>
<a href="#l13.139"></a><span id="l13.139">   // a response.</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  cancelDisconnectTimer: function() {</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+  cancelDisconnectTimer() {</span>
<a href="#l13.142"></a><span id="l13.142">     if (!this._disconnectTimer)</span>
<a href="#l13.143"></a><span id="l13.143">       return;</span>
<a href="#l13.144"></a><span id="l13.144">     clearTimeout(this._disconnectTimer);</span>
<a href="#l13.145"></a><span id="l13.145">     delete this._disconnectTimer;</span>
<a href="#l13.146"></a><span id="l13.146">   },</span>
<a href="#l13.147"></a><span id="l13.147"> </span>
<a href="#l13.148"></a><span id="l13.148">   // Plenty of time may have elapsed if the computer wakes from sleep, so check</span>
<a href="#l13.149"></a><span id="l13.149">   // if we should reconnect immediately.</span>
<a href="#l13.150"></a><span id="l13.150">   _lastAliveTime: null,</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l13.153"></a><span id="l13.153">     if (aTopic != &quot;wake_notification&quot;)</span>
<a href="#l13.154"></a><span id="l13.154">       return;</span>
<a href="#l13.155"></a><span id="l13.155">     let elapsedTime = Date.now() - this._lastAliveTime;</span>
<a href="#l13.156"></a><span id="l13.156">     // If there never was any activity before we went to sleep,</span>
<a href="#l13.157"></a><span id="l13.157">     // or if we've been waiting for a ping response for over 30s,</span>
<a href="#l13.158"></a><span id="l13.158">     // or if the last activity on the socket is longer ago than we usually</span>
<a href="#l13.159"></a><span id="l13.159">     //   allow before we timeout,</span>
<a href="#l13.160"></a><span id="l13.160">     // declare the connection timed out immediately.</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineat">@@ -349,17 +349,17 @@ var Socket = {</span>
<a href="#l13.162"></a><span id="l13.162">   /*</span>
<a href="#l13.163"></a><span id="l13.163">    *****************************************************************************</span>
<a href="#l13.164"></a><span id="l13.164">    ***************************** Interface methods *****************************</span>
<a href="#l13.165"></a><span id="l13.165">    *****************************************************************************</span>
<a href="#l13.166"></a><span id="l13.166">    */</span>
<a href="#l13.167"></a><span id="l13.167">   /*</span>
<a href="#l13.168"></a><span id="l13.168">    * nsIProtocolProxyCallback methods</span>
<a href="#l13.169"></a><span id="l13.169">    */</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-  onProxyAvailable: function(aRequest, aURI, aProxyInfo, aStatus) {</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  onProxyAvailable(aRequest, aURI, aProxyInfo, aStatus) {</span>
<a href="#l13.172"></a><span id="l13.172">     if (!(&quot;_proxyCancel&quot; in this)) {</span>
<a href="#l13.173"></a><span id="l13.173">       this.LOG(&quot;onProxyAvailable called, but disconnect() was called before.&quot;);</span>
<a href="#l13.174"></a><span id="l13.174">       return;</span>
<a href="#l13.175"></a><span id="l13.175">     }</span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177">     if (aProxyInfo) {</span>
<a href="#l13.178"></a><span id="l13.178">       if (aProxyInfo.type == &quot;http&quot;) {</span>
<a href="#l13.179"></a><span id="l13.179">         this.LOG(&quot;ignoring http proxy&quot;);</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineat">@@ -374,17 +374,17 @@ var Socket = {</span>
<a href="#l13.181"></a><span id="l13.181">     delete this._proxyCancel;</span>
<a href="#l13.182"></a><span id="l13.182">   },</span>
<a href="#l13.183"></a><span id="l13.183"> </span>
<a href="#l13.184"></a><span id="l13.184">   /*</span>
<a href="#l13.185"></a><span id="l13.185">    * nsIStreamListener methods</span>
<a href="#l13.186"></a><span id="l13.186">    */</span>
<a href="#l13.187"></a><span id="l13.187">   // onDataAvailable, called by Mozilla's networking code.</span>
<a href="#l13.188"></a><span id="l13.188">   // Buffers the data, and parses it into discrete messages.</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-  onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  onDataAvailable(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l13.191"></a><span id="l13.191">     if (this.disconnected)</span>
<a href="#l13.192"></a><span id="l13.192">       return;</span>
<a href="#l13.193"></a><span id="l13.193">     this._lastAliveTime = Date.now();</span>
<a href="#l13.194"></a><span id="l13.194">     if (this.binaryMode) {</span>
<a href="#l13.195"></a><span id="l13.195">       // Load the data from the stream</span>
<a href="#l13.196"></a><span id="l13.196">       this._incomingDataBuffer = this._incomingDataBuffer</span>
<a href="#l13.197"></a><span id="l13.197">                                      .concat(this._binaryInputStream</span>
<a href="#l13.198"></a><span id="l13.198">                                                  .readByteArray(aCount));</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineat">@@ -424,24 +424,24 @@ var Socket = {</span>
<a href="#l13.200"></a><span id="l13.200">         this._pendingData.push(this._scriptableInputStream.read(aCount));</span>
<a href="#l13.201"></a><span id="l13.201">       }</span>
<a href="#l13.202"></a><span id="l13.202">       this._activateQueue();</span>
<a href="#l13.203"></a><span id="l13.203">     }</span>
<a href="#l13.204"></a><span id="l13.204">   },</span>
<a href="#l13.205"></a><span id="l13.205"> </span>
<a href="#l13.206"></a><span id="l13.206">   _pendingData: [],</span>
<a href="#l13.207"></a><span id="l13.207">   _handlingQueue: false,</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-  _activateQueue: function() {</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+  _activateQueue() {</span>
<a href="#l13.210"></a><span id="l13.210">     if (this._handlingQueue)</span>
<a href="#l13.211"></a><span id="l13.211">       return;</span>
<a href="#l13.212"></a><span id="l13.212">     this._handlingQueue =</span>
<a href="#l13.213"></a><span id="l13.213">       this.window.requestIdleCallback(this._handleQueue.bind(this));</span>
<a href="#l13.214"></a><span id="l13.214">   },</span>
<a href="#l13.215"></a><span id="l13.215">   // Asynchronously send each string to the handle data function.</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-  _handleQueue: function(timing) {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  _handleQueue(timing) {</span>
<a href="#l13.218"></a><span id="l13.218">     while (this._pendingData.length) {</span>
<a href="#l13.219"></a><span id="l13.219">       this.onDataReceived(this._pendingData.shift());</span>
<a href="#l13.220"></a><span id="l13.220">       // One pendingData entry generally takes less than 1ms to handle.</span>
<a href="#l13.221"></a><span id="l13.221">       if (timing.timeRemaining() &lt; 1)</span>
<a href="#l13.222"></a><span id="l13.222">         break;</span>
<a href="#l13.223"></a><span id="l13.223">     }</span>
<a href="#l13.224"></a><span id="l13.224">     if (this._pendingData.length) {</span>
<a href="#l13.225"></a><span id="l13.225">       this._handlingQueue =</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineat">@@ -453,37 +453,37 @@ var Socket = {</span>
<a href="#l13.227"></a><span id="l13.227">     if (&quot;_stopRequestStatus&quot; in this)</span>
<a href="#l13.228"></a><span id="l13.228">       this._handleStopRequest(this._stopRequestStatus);</span>
<a href="#l13.229"></a><span id="l13.229">   },</span>
<a href="#l13.230"></a><span id="l13.230"> </span>
<a href="#l13.231"></a><span id="l13.231">   /*</span>
<a href="#l13.232"></a><span id="l13.232">    * nsIRequestObserver methods</span>
<a href="#l13.233"></a><span id="l13.233">    */</span>
<a href="#l13.234"></a><span id="l13.234">   // Signifies the beginning of an async request</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-  onStartRequest: function(aRequest, aContext) {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+  onStartRequest(aRequest, aContext) {</span>
<a href="#l13.237"></a><span id="l13.237">     if (this.disconnected) {</span>
<a href="#l13.238"></a><span id="l13.238">       // Ignore this if we're already disconnected.</span>
<a href="#l13.239"></a><span id="l13.239">       return;</span>
<a href="#l13.240"></a><span id="l13.240">     }</span>
<a href="#l13.241"></a><span id="l13.241">     this.DEBUG(&quot;onStartRequest&quot;);</span>
<a href="#l13.242"></a><span id="l13.242">   },</span>
<a href="#l13.243"></a><span id="l13.243">   // Called to signify the end of an asynchronous request.</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-  onStopRequest: function(aRequest, aContext, aStatus) {</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatus) {</span>
<a href="#l13.246"></a><span id="l13.246">     if (this.disconnected) {</span>
<a href="#l13.247"></a><span id="l13.247">       // We're already disconnected, so nothing left to do here.</span>
<a href="#l13.248"></a><span id="l13.248">       return;</span>
<a href="#l13.249"></a><span id="l13.249">     }</span>
<a href="#l13.250"></a><span id="l13.250"> </span>
<a href="#l13.251"></a><span id="l13.251">     this.DEBUG(&quot;onStopRequest (&quot; + aStatus + &quot;)&quot;);</span>
<a href="#l13.252"></a><span id="l13.252">     this._stopRequestStatus = aStatus;</span>
<a href="#l13.253"></a><span id="l13.253">     // The stop request will be handled when the queue is next empty.</span>
<a href="#l13.254"></a><span id="l13.254">     this._activateQueue();</span>
<a href="#l13.255"></a><span id="l13.255">   },</span>
<a href="#l13.256"></a><span id="l13.256">   // Close the connection after receiving a stop request.</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-  _handleStopRequest: function(aStatus) {</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+  _handleStopRequest(aStatus) {</span>
<a href="#l13.259"></a><span id="l13.259">     if (this.disconnected)</span>
<a href="#l13.260"></a><span id="l13.260">       return;</span>
<a href="#l13.261"></a><span id="l13.261">     this.disconnected = true;</span>
<a href="#l13.262"></a><span id="l13.262">     if (aStatus == NS_ERROR_NET_RESET)</span>
<a href="#l13.263"></a><span id="l13.263">       this.onConnectionReset();</span>
<a href="#l13.264"></a><span id="l13.264">     else if (aStatus == NS_ERROR_NET_TIMEOUT)</span>
<a href="#l13.265"></a><span id="l13.265">       this.onConnectionTimedOut();</span>
<a href="#l13.266"></a><span id="l13.266">     else if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineat">@@ -502,60 +502,60 @@ var Socket = {</span>
<a href="#l13.268"></a><span id="l13.268">     this.onConnectionClosed();</span>
<a href="#l13.269"></a><span id="l13.269">   },</span>
<a href="#l13.270"></a><span id="l13.270"> </span>
<a href="#l13.271"></a><span id="l13.271">   /*</span>
<a href="#l13.272"></a><span id="l13.272">    * nsIBadCertListener2</span>
<a href="#l13.273"></a><span id="l13.273">    */</span>
<a href="#l13.274"></a><span id="l13.274">   // Called when there's an error, return true to suppress the modal alert.</span>
<a href="#l13.275"></a><span id="l13.275">   // Whatever this function returns, NSS will close the connection.</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-  notifyCertProblem: function(aSocketInfo, aSecInfo, aTargetSite) {</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+  notifyCertProblem(aSocketInfo, aSecInfo, aTargetSite) {</span>
<a href="#l13.278"></a><span id="l13.278">     this.secInfo = aSecInfo;</span>
<a href="#l13.279"></a><span id="l13.279">     return true;</span>
<a href="#l13.280"></a><span id="l13.280">   },</span>
<a href="#l13.281"></a><span id="l13.281"> </span>
<a href="#l13.282"></a><span id="l13.282">   /*</span>
<a href="#l13.283"></a><span id="l13.283">    * nsITransportEventSink methods</span>
<a href="#l13.284"></a><span id="l13.284">    */</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-  onTransportStatus: function(aTransport, aStatus, aProgress, aProgressmax) {</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+  onTransportStatus(aTransport, aStatus, aProgress, aProgressmax) {</span>
<a href="#l13.287"></a><span id="l13.287">     // Don't send status change notifications after the socket has been closed.</span>
<a href="#l13.288"></a><span id="l13.288">     // The event sink can't be removed after opening the transport, so we can't</span>
<a href="#l13.289"></a><span id="l13.289">     // do better than adding a null check here.</span>
<a href="#l13.290"></a><span id="l13.290">     if (!this.transport)</span>
<a href="#l13.291"></a><span id="l13.291">       return;</span>
<a href="#l13.292"></a><span id="l13.292"> </span>
<a href="#l13.293"></a><span id="l13.293">     const nsITransportEventSinkStatus = {</span>
<a href="#l13.294"></a><span id="l13.294">          0x804b0003: &quot;STATUS_RESOLVING&quot;,</span>
<a href="#l13.295"></a><span id="l13.295">          0x804b000b: &quot;STATUS_RESOLVED&quot;,</span>
<a href="#l13.296"></a><span id="l13.296">          0x804b0007: &quot;STATUS_CONNECTING_TO&quot;,</span>
<a href="#l13.297"></a><span id="l13.297">          0x804b0004: &quot;STATUS_CONNECTED_TO&quot;,</span>
<a href="#l13.298"></a><span id="l13.298">          0x804b0005: &quot;STATUS_SENDING_TO&quot;,</span>
<a href="#l13.299"></a><span id="l13.299">          0x804b000a: &quot;STATUS_WAITING_FOR&quot;,</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-         0x804b0006: &quot;STATUS_RECEIVING_FROM&quot;</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+         0x804b0006: &quot;STATUS_RECEIVING_FROM&quot;,</span>
<a href="#l13.302"></a><span id="l13.302">     };</span>
<a href="#l13.303"></a><span id="l13.303">     let status = nsITransportEventSinkStatus[aStatus];</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-    this.DEBUG(&quot;onTransportStatus(&quot; + (status || (&quot;0x&quot; + aStatus.toString(16))) +&quot;)&quot;);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+    this.DEBUG(&quot;onTransportStatus(&quot; + (status || (&quot;0x&quot; + aStatus.toString(16))) + &quot;)&quot;);</span>
<a href="#l13.306"></a><span id="l13.306"> </span>
<a href="#l13.307"></a><span id="l13.307">     if (status == &quot;STATUS_CONNECTED_TO&quot;) {</span>
<a href="#l13.308"></a><span id="l13.308">       // Notify that the connection has been established.</span>
<a href="#l13.309"></a><span id="l13.309">       this.onConnection();</span>
<a href="#l13.310"></a><span id="l13.310">     }</span>
<a href="#l13.311"></a><span id="l13.311">   },</span>
<a href="#l13.312"></a><span id="l13.312"> </span>
<a href="#l13.313"></a><span id="l13.313">   /*</span>
<a href="#l13.314"></a><span id="l13.314">    *****************************************************************************</span>
<a href="#l13.315"></a><span id="l13.315">    ****************************** Private methods ******************************</span>
<a href="#l13.316"></a><span id="l13.316">    *****************************************************************************</span>
<a href="#l13.317"></a><span id="l13.317">    */</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-  _resetBuffers: function() {</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+  _resetBuffers() {</span>
<a href="#l13.320"></a><span id="l13.320">     this._incomingDataBuffer = this.binaryMode ? [] : &quot;&quot;;</span>
<a href="#l13.321"></a><span id="l13.321">     this._outgoingDataBuffer = [];</span>
<a href="#l13.322"></a><span id="l13.322">   },</span>
<a href="#l13.323"></a><span id="l13.323"> </span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-  _createTransport: function(aProxy) {</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+  _createTransport(aProxy) {</span>
<a href="#l13.326"></a><span id="l13.326">     this.proxy = aProxy;</span>
<a href="#l13.327"></a><span id="l13.327"> </span>
<a href="#l13.328"></a><span id="l13.328">     // Empty incoming and outgoing data storage buffers</span>
<a href="#l13.329"></a><span id="l13.329">     this._resetBuffers();</span>
<a href="#l13.330"></a><span id="l13.330"> </span>
<a href="#l13.331"></a><span id="l13.331">     // Create a routed socket transport</span>
<a href="#l13.332"></a><span id="l13.332">     // We connect to host and port, but the origin host and origin port are</span>
<a href="#l13.333"></a><span id="l13.333">     // given to PSM (e.g. check the certificate).</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineat">@@ -566,17 +566,17 @@ var Socket = {</span>
<a href="#l13.335"></a><span id="l13.335">                                      this.originHost, this.originPort,</span>
<a href="#l13.336"></a><span id="l13.336">                                      this.host, this.port,</span>
<a href="#l13.337"></a><span id="l13.337">                                      this.proxy);</span>
<a href="#l13.338"></a><span id="l13.338"> </span>
<a href="#l13.339"></a><span id="l13.339">     this._openStreams();</span>
<a href="#l13.340"></a><span id="l13.340">   },</span>
<a href="#l13.341"></a><span id="l13.341"> </span>
<a href="#l13.342"></a><span id="l13.342">   // Open the incoming and outgoing streams, and init the nsISocketTransport.</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-  _openStreams: function() {</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+  _openStreams() {</span>
<a href="#l13.345"></a><span id="l13.345">     // Security notification callbacks (must support nsIBadCertListener2</span>
<a href="#l13.346"></a><span id="l13.346">     // for SSL connections, and possibly other interfaces).</span>
<a href="#l13.347"></a><span id="l13.347">     this.transport.securityCallbacks = this;</span>
<a href="#l13.348"></a><span id="l13.348"> </span>
<a href="#l13.349"></a><span id="l13.349">     // Set the timeouts for the nsISocketTransport for both a connect event and</span>
<a href="#l13.350"></a><span id="l13.350">     // a read/write. Only set them if the user has provided them.</span>
<a href="#l13.351"></a><span id="l13.351">     if (this.connectTimeout) {</span>
<a href="#l13.352"></a><span id="l13.352">       this.transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_CONNECT,</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineat">@@ -615,54 +615,54 @@ var Socket = {</span>
<a href="#l13.354"></a><span id="l13.354">                                     0, // Use default segment size</span>
<a href="#l13.355"></a><span id="l13.355">                                     0, // Use default segment length</span>
<a href="#l13.356"></a><span id="l13.356">                                     false); // Do not close when done</span>
<a href="#l13.357"></a><span id="l13.357">     this.pump.asyncRead(this, this);</span>
<a href="#l13.358"></a><span id="l13.358">   },</span>
<a href="#l13.359"></a><span id="l13.359"> </span>
<a href="#l13.360"></a><span id="l13.360">   _pingTimer: null,</span>
<a href="#l13.361"></a><span id="l13.361">   _disconnectTimer: null,</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-  _sendPing: function() {</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+  _sendPing() {</span>
<a href="#l13.364"></a><span id="l13.364">     delete this._pingTimer;</span>
<a href="#l13.365"></a><span id="l13.365">     this.sendPing();</span>
<a href="#l13.366"></a><span id="l13.366">     this._disconnectTimer = setTimeout(this.onConnectionTimedOut.bind(this),</span>
<a href="#l13.367"></a><span id="l13.367">                                        this.kTimeAfterPingBeforeDisconnect);</span>
<a href="#l13.368"></a><span id="l13.368">   },</span>
<a href="#l13.369"></a><span id="l13.369"> </span>
<a href="#l13.370"></a><span id="l13.370">   /*</span>
<a href="#l13.371"></a><span id="l13.371">    *****************************************************************************</span>
<a href="#l13.372"></a><span id="l13.372">    ********************* Methods for subtypes to override **********************</span>
<a href="#l13.373"></a><span id="l13.373">    *****************************************************************************</span>
<a href="#l13.374"></a><span id="l13.374">    */</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-  LOG: function(aString) { },</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-  DEBUG: function(aString) { },</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+  LOG(aString) { },</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+  DEBUG(aString) { },</span>
<a href="#l13.379"></a><span id="l13.379">   // Called when a connection is established.</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-  onConnection: function() { },</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+  onConnection() { },</span>
<a href="#l13.382"></a><span id="l13.382">   // Called when a socket is accepted after listening.</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-  onConnectionHeard: function() { },</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+  onConnectionHeard() { },</span>
<a href="#l13.385"></a><span id="l13.385">   // Called when a connection times out.</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-  onConnectionTimedOut: function() { },</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+  onConnectionTimedOut() { },</span>
<a href="#l13.388"></a><span id="l13.388">   // Called when a socket request's network is reset.</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-  onConnectionReset: function() { },</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+  onConnectionReset() { },</span>
<a href="#l13.391"></a><span id="l13.391">   // Called when the certificate provided by the server didn't satisfy NSS.</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-  onBadCertificate: function(aNSSErrorMessage) { },</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+  onBadCertificate(aNSSErrorMessage) { },</span>
<a href="#l13.394"></a><span id="l13.394">   // Called when the other end has closed the connection.</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-  onConnectionClosed: function() { },</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+  onConnectionClosed() { },</span>
<a href="#l13.397"></a><span id="l13.397"> </span>
<a href="#l13.398"></a><span id="l13.398">   // Called when ASCII data is available.</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-  onDataReceived: function(/* string */ aData) { },</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+  onDataReceived(/* string */ aData) { },</span>
<a href="#l13.401"></a><span id="l13.401"> </span>
<a href="#l13.402"></a><span id="l13.402">   // Called when binary data is available.</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-  onBinaryDataReceived: function(/* ArrayBuffer */ aData) { },</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+  onBinaryDataReceived(/* ArrayBuffer */ aData) { },</span>
<a href="#l13.405"></a><span id="l13.405"> </span>
<a href="#l13.406"></a><span id="l13.406">   // If using the ping functionality, this is called when a new ping message</span>
<a href="#l13.407"></a><span id="l13.407">   // should be sent on the socket.</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-  sendPing: function() { },</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+  sendPing() { },</span>
<a href="#l13.410"></a><span id="l13.410"> </span>
<a href="#l13.411"></a><span id="l13.411">   /* QueryInterface and nsIInterfaceRequestor implementations */</span>
<a href="#l13.412"></a><span id="l13.412">   QueryInterface: ChromeUtils.generateQI([&quot;nsIStreamListener&quot;,</span>
<a href="#l13.413"></a><span id="l13.413">                                           &quot;nsIRequestObserver&quot;,</span>
<a href="#l13.414"></a><span id="l13.414">                                           &quot;nsITransportEventSink&quot;,</span>
<a href="#l13.415"></a><span id="l13.415">                                           &quot;nsIBadCertListener2&quot;,</span>
<a href="#l13.416"></a><span id="l13.416">                                           &quot;nsIProtocolProxyCallback&quot;]),</span>
<a href="#l13.417"></a><span id="l13.417"> </span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-  getInterface: function(iid) { return this.QueryInterface(iid); }</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+  getInterface(iid) { return this.QueryInterface(iid); },</span>
<a href="#l13.420"></a><span id="l13.420"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/modules/test/test_filtering.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/modules/test/test_filtering.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,27 +32,27 @@ function run_test() {</span>
<a href="#l14.4"></a><span id="l14.4"> }</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> // Sanity check: a string without HTML markup shouldn't be modified.</span>
<a href="#l14.7"></a><span id="l14.7"> function test_plainText() {</span>
<a href="#l14.8"></a><span id="l14.8">   const strings = [</span>
<a href="#l14.9"></a><span id="l14.9">     &quot;foo&quot;,</span>
<a href="#l14.10"></a><span id="l14.10">     &quot;foo  &quot;, // preserve trailing whitespace</span>
<a href="#l14.11"></a><span id="l14.11">     &quot;  foo&quot;, // preserve leading indent</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    &quot;&amp;lt;html&amp;gt;&amp;amp;&quot; // keep escaped characters</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    &quot;&amp;lt;html&amp;gt;&amp;amp;&quot;, // keep escaped characters</span>
<a href="#l14.14"></a><span id="l14.14">   ];</span>
<a href="#l14.15"></a><span id="l14.15">   for (let string of strings)</span>
<a href="#l14.16"></a><span id="l14.16">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.17"></a><span id="l14.17"> }</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> function test_paragraphs() {</span>
<a href="#l14.20"></a><span id="l14.20">   const strings = [</span>
<a href="#l14.21"></a><span id="l14.21">     &quot;&lt;p&gt;foo&lt;/p&gt;&lt;p&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l14.22"></a><span id="l14.22">     &quot;&lt;p&gt;foo&lt;br&gt;bar&lt;/p&gt;&quot;,</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    &quot;foo&lt;br&gt;bar&quot;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+    &quot;foo&lt;br&gt;bar&quot;,</span>
<a href="#l14.25"></a><span id="l14.25">   ];</span>
<a href="#l14.26"></a><span id="l14.26">   for (let string of strings)</span>
<a href="#l14.27"></a><span id="l14.27">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.28"></a><span id="l14.28"> }</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30"> function test_stripScripts() {</span>
<a href="#l14.31"></a><span id="l14.31">   const strings = [</span>
<a href="#l14.32"></a><span id="l14.32">     [&quot;&lt;script&gt;alert('hey')&lt;/script&gt;&quot;, &quot;&quot;],</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineat">@@ -65,30 +65,30 @@ function test_stripScripts() {</span>
<a href="#l14.34"></a><span id="l14.34"> }</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36"> function test_links() {</span>
<a href="#l14.37"></a><span id="l14.37">   // http, https, ftp and mailto links should be preserved.</span>
<a href="#l14.38"></a><span id="l14.38">   const ok = [</span>
<a href="#l14.39"></a><span id="l14.39">     &quot;http://example.com/&quot;,</span>
<a href="#l14.40"></a><span id="l14.40">     &quot;https://example.com/&quot;,</span>
<a href="#l14.41"></a><span id="l14.41">     &quot;ftp://example.com/&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    &quot;mailto:foo@example.com&quot;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    &quot;mailto:foo@example.com&quot;,</span>
<a href="#l14.44"></a><span id="l14.44">   ];</span>
<a href="#l14.45"></a><span id="l14.45">   for (let string of ok) {</span>
<a href="#l14.46"></a><span id="l14.46">     string = &quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l14.47"></a><span id="l14.47">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.48"></a><span id="l14.48">   }</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">   // other links should be removed</span>
<a href="#l14.51"></a><span id="l14.51">   const bad = [</span>
<a href="#l14.52"></a><span id="l14.52">     &quot;chrome://global/content/&quot;,</span>
<a href="#l14.53"></a><span id="l14.53">     &quot;about:&quot;,</span>
<a href="#l14.54"></a><span id="l14.54">     &quot;about:blank&quot;,</span>
<a href="#l14.55"></a><span id="l14.55">     &quot;foo://bar/&quot;,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-    &quot;&quot;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l14.58"></a><span id="l14.58">   ];</span>
<a href="#l14.59"></a><span id="l14.59">   for (let string of bad) {</span>
<a href="#l14.60"></a><span id="l14.60">     Assert.equal(&quot;&lt;a&gt;foo&lt;/a&gt;&quot;,</span>
<a href="#l14.61"></a><span id="l14.61">                  cleanupImMarkup(&quot;&lt;a href=\&quot;&quot; + string + &quot;\&quot;&gt;foo&lt;/a&gt;&quot;));</span>
<a href="#l14.62"></a><span id="l14.62">   }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   // keep link titles</span>
<a href="#l14.65"></a><span id="l14.65">   let string = &quot;&lt;a title=\&quot;foo bar\&quot;&gt;foo&lt;/a&gt;&quot;;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineat">@@ -146,34 +146,34 @@ function test_standardMode() {</span>
<a href="#l14.67"></a><span id="l14.67">   let string = &quot;&lt;font face=\&quot;Times\&quot; color=\&quot;pink\&quot; size=\&quot;3\&quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l14.68"></a><span id="l14.68">   Assert.equal(&quot;foo&quot;, cleanupImMarkup(string));</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">   // Discard hr</span>
<a href="#l14.71"></a><span id="l14.71">   Assert.equal(&quot;foobar&quot;, cleanupImMarkup(&quot;foo&lt;hr&gt;bar&quot;));</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73">   const okCSS = [</span>
<a href="#l14.74"></a><span id="l14.74">     &quot;font-style: italic&quot;,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    &quot;font-weight: bold&quot;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    &quot;font-weight: bold&quot;,</span>
<a href="#l14.77"></a><span id="l14.77">   ];</span>
<a href="#l14.78"></a><span id="l14.78">   for (let css of okCSS) {</span>
<a href="#l14.79"></a><span id="l14.79">     let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l14.80"></a><span id="l14.80">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.81"></a><span id="l14.81">   }</span>
<a href="#l14.82"></a><span id="l14.82">   // text-decoration is a shorthand for several text-decoration properties.</span>
<a href="#l14.83"></a><span id="l14.83">   Assert.equal(&quot;&lt;span style=\&quot;text-decoration-line: underline;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l14.84"></a><span id="l14.84">                cleanupImMarkup(&quot;&lt;span style=\&quot;text-decoration: underline\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">   const badCSS = [</span>
<a href="#l14.87"></a><span id="l14.87">     &quot;color: pink;&quot;,</span>
<a href="#l14.88"></a><span id="l14.88">     &quot;font-family: Times&quot;,</span>
<a href="#l14.89"></a><span id="l14.89">     &quot;font-size: larger&quot;,</span>
<a href="#l14.90"></a><span id="l14.90">     &quot;-moz-binding: url('chrome://global/content/bindings/textbox.xml#textbox');&quot;,</span>
<a href="#l14.91"></a><span id="l14.91">     &quot;display: none&quot;,</span>
<a href="#l14.92"></a><span id="l14.92">     &quot;visibility: hidden&quot;,</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    &quot;unsupported-by-gecko: blah&quot;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    &quot;unsupported-by-gecko: blah&quot;,</span>
<a href="#l14.95"></a><span id="l14.95">   ];</span>
<a href="#l14.96"></a><span id="l14.96">   for (let css of badCSS) {</span>
<a href="#l14.97"></a><span id="l14.97">     Assert.equal(&quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l14.98"></a><span id="l14.98">                  cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l14.99"></a><span id="l14.99">   }</span>
<a href="#l14.100"></a><span id="l14.100">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l14.101"></a><span id="l14.101">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l14.102"></a><span id="l14.102">   Assert.equal(&quot;&lt;span style=\&quot;font-style: normal; font-weight: normal;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineat">@@ -198,17 +198,17 @@ function test_permissiveMode() {</span>
<a href="#l14.104"></a><span id="l14.104">     let string = &quot;&lt;span class=\&quot;&quot; + className + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l14.105"></a><span id="l14.105">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.106"></a><span id="l14.106">   }</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108">   // Keep font settings</span>
<a href="#l14.109"></a><span id="l14.109">   const fontAttributes = [</span>
<a href="#l14.110"></a><span id="l14.110">     &quot;face=\&quot;Times\&quot;&quot;,</span>
<a href="#l14.111"></a><span id="l14.111">     &quot;color=\&quot;pink\&quot;&quot;,</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-    &quot;size=\&quot;3\&quot;&quot;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+    &quot;size=\&quot;3\&quot;&quot;,</span>
<a href="#l14.114"></a><span id="l14.114">   ];</span>
<a href="#l14.115"></a><span id="l14.115">   for (let fontAttribute of fontAttributes) {</span>
<a href="#l14.116"></a><span id="l14.116">     let string = &quot;&lt;font &quot; + fontAttribute + &quot;&gt;foo&lt;/font&gt;&quot;;</span>
<a href="#l14.117"></a><span id="l14.117">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.118"></a><span id="l14.118">   }</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120">   // Allow hr</span>
<a href="#l14.121"></a><span id="l14.121">   let string = &quot;foo&lt;hr&gt;bar&quot;;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineat">@@ -216,17 +216,17 @@ function test_permissiveMode() {</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124">   // Allow most CSS rules changing the text appearance.</span>
<a href="#l14.125"></a><span id="l14.125">   const okCSS = [</span>
<a href="#l14.126"></a><span id="l14.126">     &quot;font-style: italic&quot;,</span>
<a href="#l14.127"></a><span id="l14.127">     &quot;font-weight: bold&quot;,</span>
<a href="#l14.128"></a><span id="l14.128">     &quot;text-decoration: underline&quot;,</span>
<a href="#l14.129"></a><span id="l14.129">     &quot;color: pink;&quot;,</span>
<a href="#l14.130"></a><span id="l14.130">     &quot;font-family: Times&quot;,</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-    &quot;font-size: larger&quot;</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    &quot;font-size: larger&quot;,</span>
<a href="#l14.133"></a><span id="l14.133">   ];</span>
<a href="#l14.134"></a><span id="l14.134">   for (let css of okCSS) {</span>
<a href="#l14.135"></a><span id="l14.135">     let string = &quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;;</span>
<a href="#l14.136"></a><span id="l14.136">     Assert.equal(string, cleanupImMarkup(string));</span>
<a href="#l14.137"></a><span id="l14.137">   }</span>
<a href="#l14.138"></a><span id="l14.138"> </span>
<a href="#l14.139"></a><span id="l14.139">   // The shorthand 'font' is decomposed to non-shorthand properties,</span>
<a href="#l14.140"></a><span id="l14.140">   // and not recomposed as some non-shorthand properties are filtered out.</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineat">@@ -234,17 +234,17 @@ function test_permissiveMode() {</span>
<a href="#l14.142"></a><span id="l14.142">                &quot;font-style: normal; font-weight: normal;\&quot;&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l14.143"></a><span id="l14.143">                cleanupImMarkup(&quot;&lt;span style=\&quot;font: 15px normal\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145">   // But still filter out dangerous CSS rules.</span>
<a href="#l14.146"></a><span id="l14.146">   const badCSS = [</span>
<a href="#l14.147"></a><span id="l14.147">     &quot;-moz-binding: url('chrome://global/content/bindings/textbox.xml#textbox');&quot;,</span>
<a href="#l14.148"></a><span id="l14.148">     &quot;display: none&quot;,</span>
<a href="#l14.149"></a><span id="l14.149">     &quot;visibility: hidden&quot;,</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-    &quot;unsupported-by-gecko: blah&quot;</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    &quot;unsupported-by-gecko: blah&quot;,</span>
<a href="#l14.152"></a><span id="l14.152">   ];</span>
<a href="#l14.153"></a><span id="l14.153">   for (let css of badCSS) {</span>
<a href="#l14.154"></a><span id="l14.154">     Assert.equal(&quot;&lt;span&gt;foo&lt;/span&gt;&quot;,</span>
<a href="#l14.155"></a><span id="l14.155">                  cleanupImMarkup(&quot;&lt;span style=\&quot;&quot; + css + &quot;\&quot;&gt;foo&lt;/span&gt;&quot;));</span>
<a href="#l14.156"></a><span id="l14.156">   }</span>
<a href="#l14.157"></a><span id="l14.157"> </span>
<a href="#l14.158"></a><span id="l14.158">   run_next_test();</span>
<a href="#l14.159"></a><span id="l14.159"> }</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineat">@@ -322,25 +322,25 @@ function test_addGlobalAllowedStyleRule(</span>
<a href="#l14.161"></a><span id="l14.161"> function test_createDerivedRuleset() {</span>
<a href="#l14.162"></a><span id="l14.162">   Services.prefs.setIntPref(kModePref, kStandardMode);</span>
<a href="#l14.163"></a><span id="l14.163"> </span>
<a href="#l14.164"></a><span id="l14.164">   let rules = createDerivedRuleset();</span>
<a href="#l14.165"></a><span id="l14.165"> </span>
<a href="#l14.166"></a><span id="l14.166">   let string = &quot;&lt;hr&gt;&quot;;</span>
<a href="#l14.167"></a><span id="l14.167">   Assert.equal(&quot;&quot;, cleanupImMarkup(string));</span>
<a href="#l14.168"></a><span id="l14.168">   Assert.equal(&quot;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-  rules.tags[&quot;hr&quot;] = true;</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  rules.tags.hr = true;</span>
<a href="#l14.171"></a><span id="l14.171">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l14.172"></a><span id="l14.172"> </span>
<a href="#l14.173"></a><span id="l14.173">   string = &quot;&lt;br id=\&quot;123\&quot;&gt;&quot;;</span>
<a href="#l14.174"></a><span id="l14.174">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string));</span>
<a href="#l14.175"></a><span id="l14.175">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  rules.attrs[&quot;id&quot;] = true;</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+  rules.attrs.id = true;</span>
<a href="#l14.178"></a><span id="l14.178">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l14.179"></a><span id="l14.179"> </span>
<a href="#l14.180"></a><span id="l14.180">   string = &quot;&lt;br style=\&quot;clear: both;\&quot;&gt;&quot;;</span>
<a href="#l14.181"></a><span id="l14.181">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string));</span>
<a href="#l14.182"></a><span id="l14.182">   Assert.equal(&quot;&lt;br&gt;&quot;, cleanupImMarkup(string, rules));</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-  rules.styles[&quot;clear&quot;] = true;</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  rules.styles.clear = true;</span>
<a href="#l14.185"></a><span id="l14.185">   Assert.equal(string, cleanupImMarkup(string, rules));</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187">   run_next_test();</span>
<a href="#l14.188"></a><span id="l14.188"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

