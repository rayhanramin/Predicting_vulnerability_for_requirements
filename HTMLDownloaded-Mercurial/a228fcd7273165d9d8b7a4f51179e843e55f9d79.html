<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17140:a228fcd7273165d9d8b7a4f51179e843e55f9d79</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a228fcd7273165d9d8b7a4f51179e843e55f9d79" />
<meta property="og:url" content="/comm-central/rev/a228fcd7273165d9d8b7a4f51179e843e55f9d79" />
<meta property="og:description" content="Bug 789679 - make nsIMsgFolder::sizeOnDisk and related folder size variables 64 bit wide. r=rkent, r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a228fcd7273165d9d8b7a4f51179e843e55f9d79 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a228fcd7273165d9d8b7a4f51179e843e55f9d79">shortlog</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a228fcd7273165d9d8b7a4f51179e843e55f9d79">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79">files</a> |
changeset |
<a href="/comm-central/raw-rev/a228fcd7273165d9d8b7a4f51179e843e55f9d79">raw</a>  | <a href="/comm-central/archive/a228fcd7273165d9d8b7a4f51179e843e55f9d79.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=789679">Bug 789679</a> - make nsIMsgFolder::sizeOnDisk and related folder size variables 64 bit wide. r=rkent, r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 20 Nov 2014 14:07:00 -0500</td></tr>

<tr>
 <td>changeset 17140</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a228fcd7273165d9d8b7a4f51179e843e55f9d79">a228fcd7273165d9d8b7a4f51179e843e55f9d79</a></td>
</tr>



<tr>
<td>parent 17139</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6d2e86b2e14123fa455b44a62e80b78a033b405b">6d2e86b2e14123fa455b44a62e80b78a033b405b</a>
</td>
</tr>

<tr>
<td>child 17141</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d6dc036e0bf983e7e4930c3d5018e7f5f6b1e971">d6dc036e0bf983e7e4930c3d5018e7f5f6b1e971</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a228fcd7273165d9d8b7a4f51179e843e55f9d79">10608</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 25 Nov 2014 14:15:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4ba87503bd41 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ba87503bd41339a48b83b9f2b714509ba8afe86">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ba87503bd41339a48b83b9f2b714509ba8afe86&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ba87503bd41339a48b83b9f2b714509ba8afe86&newProject=comm-central&newRevision=6d2e86b2e14123fa455b44a62e80b78a033b405b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ba87503bd41339a48b83b9f2b714509ba8afe86&newProject=comm-central&newRevision=6d2e86b2e14123fa455b44a62e80b78a033b405b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ba87503bd41339a48b83b9f2b714509ba8afe86&newProject=comm-central&newRevision=6d2e86b2e14123fa455b44a62e80b78a033b405b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=789679">789679</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=789679">Bug 789679</a> - make nsIMsgFolder::sizeOnDisk and related folder size variables 64 bit wide. r=rkent, r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">mailnews/base/public/MailNewsTypes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/MailNewsTypes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">mailnews/base/public/nsIMsgFolderCacheElement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/public/nsIMsgFolderCacheElement.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">mailnews/base/src/nsMsgFolderCacheElement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderCacheElement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">mailnews/base/src/nsMsgFolderDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">mailnews/base/src/nsMsgFolderDataSource.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/src/nsMsgFolderDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">mailnews/base/util/nsMsgUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/base/util/nsMsgUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">mailnews/local/test/unit/test_over4GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/local/test/unit/test_over4GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">mailnews/news/src/nsNewsFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">file</a> |
<a href="/comm-central/annotate/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">annotate</a> |
<a href="/comm-central/diff/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">diff</a> |
<a href="/comm-central/comparison/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">comparison</a> |
<a href="/comm-central/log/a228fcd7273165d9d8b7a4f51179e843e55f9d79/mailnews/news/src/nsNewsFolder.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/MailNewsTypes.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/MailNewsTypes.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -25,9 +25,15 @@ const nsMsgKey nsMsgKey_None = 0xfffffff</span>
<a href="#l1.4"></a><span id="l1.4">  *  - nsMsgViewIndex - an index into the list of messages or folders or groups,</span>
<a href="#l1.5"></a><span id="l1.5">  *    where zero is the first one to show, one is the second, etc...</span>
<a href="#l1.6"></a><span id="l1.6">  *  - AB_SelectionIndex</span>
<a href="#l1.7"></a><span id="l1.7">  *  - AB_NameCompletionIndex</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> const nsMsgViewIndex nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/* kSizeUnknown is a special value of folder size that indicates the size</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * is unknown yet. Usually this causes the folder to determine the real size</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * immediately as it is queried by a consumer.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ */</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+const int64_t kSizeUnknown = -1;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -24,17 +24,18 @@ interface nsIMsgThread;</span>
<a href="#l2.4"></a><span id="l2.4"> interface nsIArray;</span>
<a href="#l2.5"></a><span id="l2.5"> interface nsIMutableArray;</span>
<a href="#l2.6"></a><span id="l2.6"> interface nsIMsgPluggableStore;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> typedef long nsMsgBiffState;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l2.11"></a><span id="l2.11"> typedef long nsMsgDispositionState;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(2e9227f3-5aaf-47c1-8103-411768287f8c)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+[scriptable, uuid(9ce446f3-398c-4462-a4c6-0ce562d5bd30)]</span>
<a href="#l2.15"></a><span id="l2.15"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l2.18"></a><span id="l2.18">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l2.19"></a><span id="l2.19">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   /// Returns an enumerator containing the messages within the current database.</span>
<a href="#l2.22"></a><span id="l2.22">   readonly attribute nsISimpleEnumerator messages;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -288,17 +289,17 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.24"></a><span id="l2.24">   readonly attribute boolean manyHeadersToDownload;</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   readonly attribute ACString relativePathName;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   /**</span>
<a href="#l2.29"></a><span id="l2.29">    * size of this folder on disk (not including .msf file)</span>
<a href="#l2.30"></a><span id="l2.30">    * for imap, it's the sum of the size of the messages</span>
<a href="#l2.31"></a><span id="l2.31">    */</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  attribute unsigned long sizeOnDisk;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  attribute long long sizeOnDisk;</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   readonly attribute ACString username;</span>
<a href="#l2.36"></a><span id="l2.36">   readonly attribute ACString hostname;</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   /**</span>
<a href="#l2.39"></a><span id="l2.39">    * Sets a flag on the folder. The known flags are defined in</span>
<a href="#l2.40"></a><span id="l2.40">    * nsMsgFolderFlags.h.</span>
<a href="#l2.41"></a><span id="l2.41">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderCacheElement.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderCacheElement.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,17 +1,19 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(D7ED2508-A608-46cd-AA01-FBB019B0FA44)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-interface nsIMsgFolderCacheElement : nsISupports </span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+[scriptable, uuid(c7392b12-f68a-46b2-af5e-d47350bb17c3)]</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+interface nsIMsgFolderCacheElement : nsISupports</span>
<a href="#l3.16"></a><span id="l3.16"> {</span>
<a href="#l3.17"></a><span id="l3.17">   attribute ACString key;</span>
<a href="#l3.18"></a><span id="l3.18">   ACString getStringProperty(in string propertyName);</span>
<a href="#l3.19"></a><span id="l3.19">   long getInt32Property(in string propertyName);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  long long getInt64Property(in string propertyName);</span>
<a href="#l3.21"></a><span id="l3.21">   void setStringProperty(in string propertyName, in ACString propertyValue);</span>
<a href="#l3.22"></a><span id="l3.22">   void setInt32Property(in string propertyName, in long propertyValue);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  void setInt64Property(in string propertyName, in long long propertyValue);</span>
<a href="#l3.24"></a><span id="l3.24"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCacheElement.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCacheElement.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -74,16 +74,39 @@ NS_IMETHODIMP nsMsgFolderCacheElement::G</span>
<a href="#l4.4"></a><span id="l4.4">   {</span>
<a href="#l4.5"></a><span id="l4.5">     NS_WARNING(&quot;Unexpected failure to decode hex string.&quot;);</span>
<a href="#l4.6"></a><span id="l4.6">     return NS_ERROR_FAILURE;</span>
<a href="#l4.7"></a><span id="l4.7">   }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   return NS_OK;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::GetInt64Property(const char *propertyName, int64_t *aResult)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  nsCString resultStr;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  GetStringProperty(propertyName, resultStr);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  if (resultStr.IsEmpty())</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  // This must be an inverse function to nsCString.AppentInt(),</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  // which uses snprintf(&quot;%x&quot;) internally, so that the wrapped negative numbers</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  // are decoded properly.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  if (PR_sscanf(resultStr.get(), &quot;%llx&quot;, aResult) != 1)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    NS_WARNING(&quot;Unexpected failure to decode hex string.&quot;);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  }</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+}</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+</span>
<a href="#l4.35"></a><span id="l4.35"> NS_IMETHODIMP nsMsgFolderCacheElement::SetStringProperty(const char *propertyName, const nsACString&amp; propertyValue)</span>
<a href="#l4.36"></a><span id="l4.36"> {</span>
<a href="#l4.37"></a><span id="l4.37">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l4.38"></a><span id="l4.38">   NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l4.39"></a><span id="l4.39">   nsresult rv = NS_OK;</span>
<a href="#l4.40"></a><span id="l4.40">   mdb_token property_token;</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">   if (m_owningCache)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -116,14 +139,26 @@ NS_IMETHODIMP nsMsgFolderCacheElement::S</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">   // This also supports encoding negative numbers into hex</span>
<a href="#l4.46"></a><span id="l4.46">   // by integer wrapping them (e.g. -1 -&gt; &quot;ffffffff&quot;).</span>
<a href="#l4.47"></a><span id="l4.47">   nsAutoCString propertyStr;</span>
<a href="#l4.48"></a><span id="l4.48">   propertyStr.AppendInt(propertyValue, 16);</span>
<a href="#l4.49"></a><span id="l4.49">   return SetStringProperty(propertyName, propertyStr);</span>
<a href="#l4.50"></a><span id="l4.50"> }</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+NS_IMETHODIMP nsMsgFolderCacheElement::SetInt64Property(const char *propertyName, int64_t propertyValue)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+{</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  NS_ENSURE_TRUE(m_mdbRow, NS_ERROR_FAILURE);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  // This also supports encoding negative numbers into hex</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  // by integer wrapping them (e.g. -1 -&gt; &quot;ffffffffffffffff&quot;).</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  nsAutoCString propertyStr;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  propertyStr.AppendInt(propertyValue, 16);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  return SetStringProperty(propertyName, propertyStr);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+}</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+</span>
<a href="#l4.64"></a><span id="l4.64"> void nsMsgFolderCacheElement::SetMDBRow(nsIMdbRow *row)</span>
<a href="#l4.65"></a><span id="l4.65"> {</span>
<a href="#l4.66"></a><span id="l4.66">   if (m_mdbRow)</span>
<a href="#l4.67"></a><span id="l4.67">     NS_RELEASE(m_mdbRow);</span>
<a href="#l4.68"></a><span id="l4.68">   NS_IF_ADDREF(m_mdbRow = row);</span>
<a href="#l4.69"></a><span id="l4.69"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderDataSource.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderDataSource.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -113,16 +113,18 @@ nsIAtom * nsMsgFolderDataSource::kSynchr</span>
<a href="#l5.4"></a><span id="l5.4"> nsIAtom * nsMsgFolderDataSource::kOpenAtom = nullptr;</span>
<a href="#l5.5"></a><span id="l5.5"> nsIAtom * nsMsgFolderDataSource::kIsDeferredAtom = nullptr;</span>
<a href="#l5.6"></a><span id="l5.6"> nsIAtom * nsMsgFolderDataSource::kIsSecureAtom = nullptr;</span>
<a href="#l5.7"></a><span id="l5.7"> nsIAtom * nsMsgFolderDataSource::kCanFileMessagesAtom = nullptr;</span>
<a href="#l5.8"></a><span id="l5.8"> nsIAtom * nsMsgFolderDataSource::kInVFEditSearchScopeAtom = nullptr;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> static const uint32_t kDisplayBlankCount = 0xFFFFFFFE;</span>
<a href="#l5.11"></a><span id="l5.11"> static const uint32_t kDisplayQuestionCount = 0xFFFFFFFF;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+static const int64_t kDisplayBlankCount64 = -2;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+static const int64_t kDisplayQuestionCount64 = -1;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> nsMsgFolderDataSource::nsMsgFolderDataSource()</span>
<a href="#l5.16"></a><span id="l5.16"> {</span>
<a href="#l5.17"></a><span id="l5.17">   // one-time initialization here</span>
<a href="#l5.18"></a><span id="l5.18">   nsIRDFService* rdf = getRDFService();</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   if (gFolderResourceRefCnt++ == 0) {</span>
<a href="#l5.21"></a><span id="l5.21">     nsCOMPtr&lt;nsIStringBundle&gt; sMessengerStringBundle;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -1449,29 +1451,29 @@ nsMsgFolderDataSource::createTotalMessag</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> nsresult</span>
<a href="#l5.25"></a><span id="l5.25"> nsMsgFolderDataSource::createFolderSizeNode(nsIMsgFolder *folder, nsIRDFNode **target)</span>
<a href="#l5.26"></a><span id="l5.26"> {</span>
<a href="#l5.27"></a><span id="l5.27">   bool isServer;</span>
<a href="#l5.28"></a><span id="l5.28">   nsresult rv = folder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l5.29"></a><span id="l5.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  int32_t folderSize;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  if(isServer)</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    folderSize = kDisplayBlankCount;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  int64_t folderSize;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  if (isServer) {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    folderSize = kDisplayBlankCount64;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  }</span>
<a href="#l5.38"></a><span id="l5.38">   else</span>
<a href="#l5.39"></a><span id="l5.39">   {</span>
<a href="#l5.40"></a><span id="l5.40">     // XXX todo, we are asserting here for news</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    // for offline news, we'd know the size on disk, right?</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    rv = folder-&gt;GetSizeOnDisk((uint32_t *) &amp;folderSize);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+    // for offline news, we'd know the size on disk, right? Yes, bug 851275.</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+    rv = folder-&gt;GetSizeOnDisk(&amp;folderSize);</span>
<a href="#l5.45"></a><span id="l5.45">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.46"></a><span id="l5.46">   }</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  GetFolderSizeNode(folderSize, target);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  return rv;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  return GetFolderSizeNode(folderSize, target);</span>
<a href="#l5.51"></a><span id="l5.51"> }</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53"> nsresult</span>
<a href="#l5.54"></a><span id="l5.54"> nsMsgFolderDataSource::createCharsetNode(nsIMsgFolder *folder, nsIRDFNode **target)</span>
<a href="#l5.55"></a><span id="l5.55"> {</span>
<a href="#l5.56"></a><span id="l5.56">   nsCString charset;</span>
<a href="#l5.57"></a><span id="l5.57">   nsresult rv = folder-&gt;GetCharset(charset);</span>
<a href="#l5.58"></a><span id="l5.58">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -1753,17 +1755,17 @@ nsMsgFolderDataSource::OnFolderSortOrder</span>
<a href="#l5.60"></a><span id="l5.60">     nsCOMPtr&lt;nsIRDFNode&gt; newNode;</span>
<a href="#l5.61"></a><span id="l5.61">     createFolderNameNode(folder, getter_AddRefs(newNode), true);</span>
<a href="#l5.62"></a><span id="l5.62">     NotifyPropertyChanged(folderResource, kNC_FolderTreeNameSort, newNode);</span>
<a href="#l5.63"></a><span id="l5.63">   }</span>
<a href="#l5.64"></a><span id="l5.64">   return NS_OK;</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> nsresult</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-nsMsgFolderDataSource::OnFolderSizePropertyChanged(nsIRDFResource *folderResource, int32_t oldValue, int32_t newValue)</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+nsMsgFolderDataSource::OnFolderSizePropertyChanged(nsIRDFResource *folderResource, int64_t oldValue, int64_t newValue)</span>
<a href="#l5.70"></a><span id="l5.70"> {</span>
<a href="#l5.71"></a><span id="l5.71">   nsCOMPtr&lt;nsIRDFNode&gt; newNode;</span>
<a href="#l5.72"></a><span id="l5.72">   GetFolderSizeNode(newValue, getter_AddRefs(newNode));</span>
<a href="#l5.73"></a><span id="l5.73">   NotifyPropertyChanged(folderResource, kNC_FolderSize, newNode);</span>
<a href="#l5.74"></a><span id="l5.74">   return NS_OK;</span>
<a href="#l5.75"></a><span id="l5.75"> }</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77"> nsresult</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineat">@@ -1784,28 +1786,27 @@ nsMsgFolderDataSource::GetNumMessagesNod</span>
<a href="#l5.79"></a><span id="l5.79">   else if (numMessages == kDisplayBlankCount || numMessages == 0)</span>
<a href="#l5.80"></a><span id="l5.80">     createNode(EmptyString().get(), node, getRDFService());</span>
<a href="#l5.81"></a><span id="l5.81">   else</span>
<a href="#l5.82"></a><span id="l5.82">     createIntNode(numMessages, node, getRDFService());</span>
<a href="#l5.83"></a><span id="l5.83">   return NS_OK;</span>
<a href="#l5.84"></a><span id="l5.84"> }</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86"> nsresult</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-nsMsgFolderDataSource::GetFolderSizeNode(int32_t aFolderSize, nsIRDFNode **aNode)</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+nsMsgFolderDataSource::GetFolderSizeNode(int64_t aFolderSize, nsIRDFNode **aNode)</span>
<a href="#l5.89"></a><span id="l5.89"> {</span>
<a href="#l5.90"></a><span id="l5.90">   nsresult rv;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-  uint32_t folderSize = aFolderSize;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  if (folderSize == kDisplayBlankCount || folderSize == 0)</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  if (aFolderSize == kDisplayBlankCount64)</span>
<a href="#l5.94"></a><span id="l5.94">     createNode(EmptyString().get(), aNode, getRDFService());</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-  else if(folderSize == kDisplayQuestionCount)</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  else if (aFolderSize == kDisplayQuestionCount64)</span>
<a href="#l5.97"></a><span id="l5.97">     createNode(MOZ_UTF16(&quot;???&quot;), aNode, getRDFService());</span>
<a href="#l5.98"></a><span id="l5.98">   else</span>
<a href="#l5.99"></a><span id="l5.99">   {</span>
<a href="#l5.100"></a><span id="l5.100">     nsAutoString sizeString;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-    rv = FormatFileSize(folderSize, true, sizeString);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    rv = FormatFileSize(aFolderSize, true, sizeString);</span>
<a href="#l5.103"></a><span id="l5.103">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.104"></a><span id="l5.104"> </span>
<a href="#l5.105"></a><span id="l5.105">     createNode(sizeString.get(), aNode, getRDFService());</span>
<a href="#l5.106"></a><span id="l5.106">   }</span>
<a href="#l5.107"></a><span id="l5.107">   return NS_OK;</span>
<a href="#l5.108"></a><span id="l5.108"> }</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110"> nsresult</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderDataSource.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderDataSource.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -171,24 +171,24 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   nsresult CreateUnreadMessagesNameString(int32_t unreadMessages, nsAutoString &amp;nameString);</span>
<a href="#l6.6"></a><span id="l6.6">   nsresult CreateArcsOutEnumerator();</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   virtual nsresult OnItemAddedOrRemoved(nsIMsgFolder *parentItem, nsISupports *item, bool added);</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   nsresult OnUnreadMessagePropertyChanged(nsIRDFResource *folderResource, int32_t oldValue, int32_t newValue);</span>
<a href="#l6.11"></a><span id="l6.11">   nsresult OnTotalMessagePropertyChanged(nsIRDFResource *folderResource, int32_t oldValue, int32_t newValue);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsresult OnFolderSizePropertyChanged(nsIRDFResource *folderResource, int32_t oldValue, int32_t newValue);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsresult OnFolderSizePropertyChanged(nsIRDFResource *folderResource, int64_t oldValue, int64_t newValue);</span>
<a href="#l6.14"></a><span id="l6.14">   nsresult OnFolderSortOrderPropertyChanged(nsIRDFResource *folderResource, int32_t oldValue, int32_t newValue);</span>
<a href="#l6.15"></a><span id="l6.15">   nsresult NotifyFolderTreeNameChanged(nsIMsgFolder *folder, nsIRDFResource *folderResource, int32_t aUnreadMessages);</span>
<a href="#l6.16"></a><span id="l6.16">   nsresult NotifyFolderTreeSimpleNameChanged(nsIMsgFolder *folder, nsIRDFResource *folderResource);</span>
<a href="#l6.17"></a><span id="l6.17">   nsresult NotifyFolderNameChanged(nsIMsgFolder *folder, nsIRDFResource *folderResource);</span>
<a href="#l6.18"></a><span id="l6.18">   nsresult NotifyAncestors(nsIMsgFolder *aFolder, nsIRDFResource *aPropertyResource, nsIRDFNode *aNode);</span>
<a href="#l6.19"></a><span id="l6.19">   nsresult GetNumMessagesNode(int32_t numMessages, nsIRDFNode **node);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  nsresult GetFolderSizeNode(int32_t folderSize, nsIRDFNode **node);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  nsresult GetFolderSizeNode(int64_t folderSize, nsIRDFNode **node);</span>
<a href="#l6.22"></a><span id="l6.22">   nsresult CreateLiterals(nsIRDFService *rdf);</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   virtual nsresult GetFolderDisplayName(nsIMsgFolder *folder, nsString&amp; folderName);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   static nsIRDFResource* kNC_Child;</span>
<a href="#l6.27"></a><span id="l6.27">   static nsIRDFResource* kNC_Folder;</span>
<a href="#l6.28"></a><span id="l6.28">   static nsIRDFResource* kNC_Name;</span>
<a href="#l6.29"></a><span id="l6.29">   static nsIRDFResource* kNC_Open;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -132,17 +132,17 @@ nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l7.4"></a><span id="l7.4">   mNumUnreadMessages(-1),</span>
<a href="#l7.5"></a><span id="l7.5">   mNumTotalMessages(-1),</span>
<a href="#l7.6"></a><span id="l7.6">   mNotifyCountChanges(true),</span>
<a href="#l7.7"></a><span id="l7.7">   mExpungedBytes(0),</span>
<a href="#l7.8"></a><span id="l7.8">   mInitializedFromCache(false),</span>
<a href="#l7.9"></a><span id="l7.9">   mSemaphoreHolder(nullptr),</span>
<a href="#l7.10"></a><span id="l7.10">   mNumPendingUnreadMessages(0),</span>
<a href="#l7.11"></a><span id="l7.11">   mNumPendingTotalMessages(0),</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  mFolderSize(0),</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  mFolderSize(kSizeUnknown),</span>
<a href="#l7.14"></a><span id="l7.14">   mNumNewBiffMessages(0),</span>
<a href="#l7.15"></a><span id="l7.15">   mIsCachable(true),</span>
<a href="#l7.16"></a><span id="l7.16">   mHaveParsedURI(false),</span>
<a href="#l7.17"></a><span id="l7.17">   mIsServerIsValid(false),</span>
<a href="#l7.18"></a><span id="l7.18">   mIsServer(false),</span>
<a href="#l7.19"></a><span id="l7.19">   mInVFEditSearchScope (false)</span>
<a href="#l7.20"></a><span id="l7.20"> {</span>
<a href="#l7.21"></a><span id="l7.21">   if (mInstanceCount++ &lt;=0) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -1297,17 +1297,17 @@ NS_IMETHODIMP nsMsgDBFolder::ReadFromFol</span>
<a href="#l7.23"></a><span id="l7.23">   nsCString charset;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   element-&gt;GetInt32Property(&quot;flags&quot;, (int32_t *) &amp;mFlags);</span>
<a href="#l7.26"></a><span id="l7.26">   element-&gt;GetInt32Property(&quot;totalMsgs&quot;, &amp;mNumTotalMessages);</span>
<a href="#l7.27"></a><span id="l7.27">   element-&gt;GetInt32Property(&quot;totalUnreadMsgs&quot;, &amp;mNumUnreadMessages);</span>
<a href="#l7.28"></a><span id="l7.28">   element-&gt;GetInt32Property(&quot;pendingUnreadMsgs&quot;, &amp;mNumPendingUnreadMessages);</span>
<a href="#l7.29"></a><span id="l7.29">   element-&gt;GetInt32Property(&quot;pendingMsgs&quot;, &amp;mNumPendingTotalMessages);</span>
<a href="#l7.30"></a><span id="l7.30">   element-&gt;GetInt32Property(&quot;expungedBytes&quot;, (int32_t *) &amp;mExpungedBytes);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  element-&gt;GetInt32Property(&quot;folderSize&quot;, (int32_t *) &amp;mFolderSize);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  element-&gt;GetInt64Property(&quot;folderSize&quot;, &amp;mFolderSize);</span>
<a href="#l7.33"></a><span id="l7.33">   element-&gt;GetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35"> #ifdef DEBUG_bienvenu1</span>
<a href="#l7.36"></a><span id="l7.36">   nsCString uri;</span>
<a href="#l7.37"></a><span id="l7.37">   GetURI(uri);</span>
<a href="#l7.38"></a><span id="l7.38">   printf(&quot;read total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l7.39"></a><span id="l7.39"> #endif</span>
<a href="#l7.40"></a><span id="l7.40">   mInitializedFromCache = true;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -1420,17 +1420,17 @@ NS_IMETHODIMP nsMsgDBFolder::WriteToFold</span>
<a href="#l7.42"></a><span id="l7.42">   nsresult rv = NS_OK;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   element-&gt;SetInt32Property(&quot;flags&quot;, (int32_t) mFlags);</span>
<a href="#l7.45"></a><span id="l7.45">   element-&gt;SetInt32Property(&quot;totalMsgs&quot;, mNumTotalMessages);</span>
<a href="#l7.46"></a><span id="l7.46">   element-&gt;SetInt32Property(&quot;totalUnreadMsgs&quot;, mNumUnreadMessages);</span>
<a href="#l7.47"></a><span id="l7.47">   element-&gt;SetInt32Property(&quot;pendingUnreadMsgs&quot;, mNumPendingUnreadMessages);</span>
<a href="#l7.48"></a><span id="l7.48">   element-&gt;SetInt32Property(&quot;pendingMsgs&quot;, mNumPendingTotalMessages);</span>
<a href="#l7.49"></a><span id="l7.49">   element-&gt;SetInt32Property(&quot;expungedBytes&quot;, mExpungedBytes);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  element-&gt;SetInt32Property(&quot;folderSize&quot;, mFolderSize);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  element-&gt;SetInt64Property(&quot;folderSize&quot;, mFolderSize);</span>
<a href="#l7.52"></a><span id="l7.52">   element-&gt;SetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54"> #ifdef DEBUG_bienvenu1</span>
<a href="#l7.55"></a><span id="l7.55">   nsCString uri;</span>
<a href="#l7.56"></a><span id="l7.56">   GetURI(uri);</span>
<a href="#l7.57"></a><span id="l7.57">   printf(&quot;writing total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l7.58"></a><span id="l7.58"> #endif</span>
<a href="#l7.59"></a><span id="l7.59">   return rv;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineat">@@ -4555,24 +4555,24 @@ NS_IMETHODIMP nsMsgDBFolder::GetLocked(b</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63"> NS_IMETHODIMP nsMsgDBFolder::GetRelativePathName(nsACString&amp; pathName)</span>
<a href="#l7.64"></a><span id="l7.64"> {</span>
<a href="#l7.65"></a><span id="l7.65">   pathName.Truncate();</span>
<a href="#l7.66"></a><span id="l7.66">   return NS_OK;</span>
<a href="#l7.67"></a><span id="l7.67"> }</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetSizeOnDisk(uint32_t *size)</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetSizeOnDisk(int64_t *size)</span>
<a href="#l7.71"></a><span id="l7.71"> {</span>
<a href="#l7.72"></a><span id="l7.72">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  *size = 0;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  *size = kSizeUnknown;</span>
<a href="#l7.75"></a><span id="l7.75">   return NS_OK;</span>
<a href="#l7.76"></a><span id="l7.76"> }</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::SetSizeOnDisk(uint32_t aSizeOnDisk)</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::SetSizeOnDisk(int64_t aSizeOnDisk)</span>
<a href="#l7.80"></a><span id="l7.80"> {</span>
<a href="#l7.81"></a><span id="l7.81">   NotifyIntPropertyChanged(kFolderSizeAtom, mFolderSize, aSizeOnDisk);</span>
<a href="#l7.82"></a><span id="l7.82">   mFolderSize = aSizeOnDisk;</span>
<a href="#l7.83"></a><span id="l7.83">   return NS_OK;</span>
<a href="#l7.84"></a><span id="l7.84"> }</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86"> NS_IMETHODIMP nsMsgDBFolder::GetUsername(nsACString&amp; userName)</span>
<a href="#l7.87"></a><span id="l7.87"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -201,17 +201,17 @@ protected:</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   nsWeakPtr mServer;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   // These values are used for tricking the front end into thinking that we have more </span>
<a href="#l8.8"></a><span id="l8.8">   // messages than are really in the DB.  This is usually after and IMAP message copy where</span>
<a href="#l8.9"></a><span id="l8.9">   // we don't want to do an expensive select until the user actually opens that folder</span>
<a href="#l8.10"></a><span id="l8.10">   int32_t mNumPendingUnreadMessages;</span>
<a href="#l8.11"></a><span id="l8.11">   int32_t mNumPendingTotalMessages;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  uint32_t mFolderSize;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  int64_t mFolderSize;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   int32_t mNumNewBiffMessages;</span>
<a href="#l8.16"></a><span id="l8.16">   bool mIsCachable;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   // these are previous set of new msgs, which we might</span>
<a href="#l8.19"></a><span id="l8.19">   // want to run junk controls on. This is in addition to &quot;new&quot; hdrs</span>
<a href="#l8.20"></a><span id="l8.20">   // in the db, which might get cleared because the user clicked away</span>
<a href="#l8.21"></a><span id="l8.21">   // from the folder.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -466,17 +466,17 @@ nsresult NS_MsgHashIfNecessary(nsAutoStr</span>
<a href="#l9.4"></a><span id="l9.4">     PR_snprintf(hashedname, 9, &quot;%08lx&quot;, (unsigned long) StringHash(name));</span>
<a href="#l9.5"></a><span id="l9.5">     name.SetLength(keptLength);</span>
<a href="#l9.6"></a><span id="l9.6">     name.Append(NS_ConvertASCIItoUTF16(hashedname));</span>
<a href="#l9.7"></a><span id="l9.7">   }</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   return NS_OK;</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsresult FormatFileSize(uint64_t size, bool useKB, nsAString &amp;formattedSize)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+nsresult FormatFileSize(int64_t size, bool useKB, nsAString &amp;formattedSize)</span>
<a href="#l9.14"></a><span id="l9.14"> {</span>
<a href="#l9.15"></a><span id="l9.15">   NS_NAMED_LITERAL_STRING(byteAbbr, &quot;byteAbbreviation2&quot;);</span>
<a href="#l9.16"></a><span id="l9.16">   NS_NAMED_LITERAL_STRING(kbAbbr,   &quot;kiloByteAbbreviation2&quot;);</span>
<a href="#l9.17"></a><span id="l9.17">   NS_NAMED_LITERAL_STRING(mbAbbr,   &quot;megaByteAbbreviation2&quot;);</span>
<a href="#l9.18"></a><span id="l9.18">   NS_NAMED_LITERAL_STRING(gbAbbr,   &quot;gigaByteAbbreviation2&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   const char16_t *sizeAbbrNames[] = {</span>
<a href="#l9.21"></a><span id="l9.21">     byteAbbr.get(), kbAbbr.get(), mbAbbr.get(), gbAbbr.get()</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -488,17 +488,17 @@ nsresult FormatFileSize(uint64_t size, b</span>
<a href="#l9.23"></a><span id="l9.23">     mozilla::services::GetStringBundleService();</span>
<a href="#l9.24"></a><span id="l9.24">   NS_ENSURE_TRUE(bundleSvc, NS_ERROR_UNEXPECTED);</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l9.27"></a><span id="l9.27">   rv = bundleSvc-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l9.28"></a><span id="l9.28">                                getter_AddRefs(bundle));</span>
<a href="#l9.29"></a><span id="l9.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  float unitSize = size;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  float unitSize = size &lt; 0 ? 0.0 : size;</span>
<a href="#l9.33"></a><span id="l9.33">   uint32_t unitIndex = 0;</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">   if (useKB) {</span>
<a href="#l9.36"></a><span id="l9.36">     // Start by formatting in kilobytes</span>
<a href="#l9.37"></a><span id="l9.37">     unitSize /= 1024;</span>
<a href="#l9.38"></a><span id="l9.38">     if (unitSize &lt; 0.1 &amp;&amp; unitSize != 0)</span>
<a href="#l9.39"></a><span id="l9.39">       unitSize = 0.1;</span>
<a href="#l9.40"></a><span id="l9.40">     unitIndex++;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -57,17 +57,17 @@ NS_MSG_BASE nsresult NS_MsgGetPriorityVa</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> NS_MSG_BASE nsresult NS_MsgGetUntranslatedPriorityName(</span>
<a href="#l10.6"></a><span id="l10.6">                        const nsMsgPriorityValue p,</span>
<a href="#l10.7"></a><span id="l10.7">                        nsACString &amp; outName);</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> NS_MSG_BASE nsresult NS_MsgHashIfNecessary(nsAutoString &amp;name);</span>
<a href="#l10.10"></a><span id="l10.10"> NS_MSG_BASE nsresult NS_MsgHashIfNecessary(nsAutoCString &amp;name);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-NS_MSG_BASE nsresult FormatFileSize(uint64_t size, bool useKB, nsAString &amp;formattedSize);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+NS_MSG_BASE nsresult FormatFileSize(int64_t size, bool useKB, nsAString &amp;formattedSize);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> /**</span>
<a href="#l10.17"></a><span id="l10.17">  * given a folder uri, return the path to folder in the user profile directory.</span>
<a href="#l10.18"></a><span id="l10.18">  *</span>
<a href="#l10.19"></a><span id="l10.19">  * @param aFolderURI uri of folder we want the path to, without the scheme</span>
<a href="#l10.20"></a><span id="l10.20">  * @param[out] aPathString result path string</span>
<a href="#l10.21"></a><span id="l10.21">  * @param aScheme scheme of the uri</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1758,17 +1758,17 @@ NS_IMETHODIMP nsImapMailFolder::GetDelet</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">   bool isServer;</span>
<a href="#l11.6"></a><span id="l11.6">   GetIsServer(&amp;isServer);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   *deletable = !(isServer || (mFlags &amp; nsMsgFolderFlags::SpecialUse));</span>
<a href="#l11.9"></a><span id="l11.9">   return NS_OK;</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-NS_IMETHODIMP nsImapMailFolder::GetSizeOnDisk(uint32_t * size)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::GetSizeOnDisk(int64_t *size)</span>
<a href="#l11.14"></a><span id="l11.14"> {</span>
<a href="#l11.15"></a><span id="l11.15">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l11.16"></a><span id="l11.16">   *size = mFolderSize;</span>
<a href="#l11.17"></a><span id="l11.17">   return NS_OK;</span>
<a href="#l11.18"></a><span id="l11.18"> }</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> NS_IMETHODIMP</span>
<a href="#l11.21"></a><span id="l11.21"> nsImapMailFolder::GetCanCreateSubfolders(bool *aResult)</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -4809,17 +4809,17 @@ nsresult nsImapMailFolder::SyncFlags(nsI</span>
<a href="#l11.23"></a><span id="l11.23">   flagState-&gt;GetPartialUIDFetch(&amp;partialUIDFetch);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   // update all of the database flags</span>
<a href="#l11.26"></a><span id="l11.26">   int32_t messageIndex;</span>
<a href="#l11.27"></a><span id="l11.27">   uint32_t messageSize;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">   // Take this opportunity to recalculate the folder size, if we're not a </span>
<a href="#l11.30"></a><span id="l11.30">   // partial (condstore) fetch.</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  uint64_t newFolderSize = 0;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  int64_t newFolderSize = 0;</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   flagState-&gt;GetNumberOfMessages(&amp;messageIndex);</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">   uint16_t supportedUserFlags;</span>
<a href="#l11.37"></a><span id="l11.37">   flagState-&gt;GetSupportedUserFlags(&amp;supportedUserFlags);</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   for (int32_t flagIndex = 0; flagIndex &lt; messageIndex; flagIndex++)</span>
<a href="#l11.40"></a><span id="l11.40">   {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -4842,18 +4842,18 @@ nsresult nsImapMailFolder::SyncFlags(nsI</span>
<a href="#l11.42"></a><span id="l11.42">     nsCString keywords;</span>
<a href="#l11.43"></a><span id="l11.43">     if (NS_SUCCEEDED(flagState-&gt;GetCustomFlags(uidOfMessage, getter_Copies(keywords))))</span>
<a href="#l11.44"></a><span id="l11.44">         HandleCustomFlags(uidOfMessage, dbHdr, supportedUserFlags, keywords);</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">     NotifyMessageFlagsFromHdr(dbHdr, uidOfMessage, flags);</span>
<a href="#l11.47"></a><span id="l11.47">   }</span>
<a href="#l11.48"></a><span id="l11.48">   if (!partialUIDFetch &amp;&amp; newFolderSize != mFolderSize)</span>
<a href="#l11.49"></a><span id="l11.49">   {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    uint32_t oldFolderSize = mFolderSize;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-    mFolderSize = (uint32_t) newFolderSize;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    int64_t oldFolderSize = mFolderSize;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    mFolderSize = newFolderSize;</span>
<a href="#l11.54"></a><span id="l11.54">     NotifyIntPropertyChanged(kFolderSizeAtom, oldFolderSize, mFolderSize);</span>
<a href="#l11.55"></a><span id="l11.55">   }</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">   return NS_OK;</span>
<a href="#l11.58"></a><span id="l11.58"> }</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60"> // helper routine to sync the flags on a given header</span>
<a href="#l11.61"></a><span id="l11.61"> nsresult</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -227,17 +227,17 @@ public:</span>
<a href="#l12.4"></a><span id="l12.4">   NS_IMETHOD GetPrettyName(nsAString&amp; prettyName) MOZ_OVERRIDE; // Override of the base, for top-level mail folder</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">   NS_IMETHOD GetFolderURL(nsACString&amp; url) MOZ_OVERRIDE;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   NS_IMETHOD UpdateSummaryTotals(bool force) MOZ_OVERRIDE;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   NS_IMETHOD GetDeletable (bool *deletable) MOZ_OVERRIDE;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  NS_IMETHOD GetSizeOnDisk(uint32_t * size) MOZ_OVERRIDE;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  NS_IMETHOD GetSizeOnDisk(int64_t *size) MOZ_OVERRIDE;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   NS_IMETHOD GetCanCreateSubfolders(bool *aResult) MOZ_OVERRIDE;</span>
<a href="#l12.16"></a><span id="l12.16">   NS_IMETHOD GetCanSubscribe(bool *aResult) MOZ_OVERRIDE;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">   NS_IMETHOD ApplyRetentionSettings() MOZ_OVERRIDE;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   NS_IMETHOD AddMessageDispositionState(nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) MOZ_OVERRIDE;</span>
<a href="#l12.21"></a><span id="l12.21">   NS_IMETHOD MarkMessagesRead(nsIArray *messages, bool markRead) MOZ_OVERRIDE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -192,16 +192,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Pars</span>
<a href="#l13.4"></a><span id="l13.4">     mReparseListener = aListener;</span>
<a href="#l13.5"></a><span id="l13.5">   // if parsing is synchronous, we need to set m_parsingFolder to</span>
<a href="#l13.6"></a><span id="l13.6">   // true before starting. And we need to open the db before</span>
<a href="#l13.7"></a><span id="l13.7">   // setting m_parsingFolder to true.</span>
<a href="#l13.8"></a><span id="l13.8"> //  OpenDatabase();</span>
<a href="#l13.9"></a><span id="l13.9">   rv = msgStore-&gt;RebuildIndex(this, mDatabase, aMsgWindow, this);</span>
<a href="#l13.10"></a><span id="l13.10">   if (NS_SUCCEEDED(rv))</span>
<a href="#l13.11"></a><span id="l13.11">     m_parsingFolder = true;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13">   return rv;</span>
<a href="#l13.14"></a><span id="l13.14"> }</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> // this won't force a reparse of the folder if the db is invalid.</span>
<a href="#l13.17"></a><span id="l13.17"> NS_IMETHODIMP</span>
<a href="#l13.18"></a><span id="l13.18"> nsMsgLocalMailFolder::GetMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20">   return GetDatabaseWOReparse(aMsgDatabase);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -1097,37 +1098,40 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetD</span>
<a href="#l13.22"></a><span id="l13.22">   bool isServer;</span>
<a href="#l13.23"></a><span id="l13.23">   GetIsServer(&amp;isServer);</span>
<a href="#l13.24"></a><span id="l13.24">   *deletable = !(isServer || (mFlags &amp; nsMsgFolderFlags::SpecialUse));</span>
<a href="#l13.25"></a><span id="l13.25">   return NS_OK;</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> NS_IMETHODIMP nsMsgLocalMailFolder::RefreshSizeOnDisk()</span>
<a href="#l13.29"></a><span id="l13.29"> {</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  uint32_t oldFolderSize = mFolderSize;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  mFolderSize = 0; // we set this to 0 to force it to get recalculated from disk</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  int64_t oldFolderSize = mFolderSize;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  // we set this to unknown to force it to get recalculated from disk</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  mFolderSize = kSizeUnknown;</span>
<a href="#l13.35"></a><span id="l13.35">   if (NS_SUCCEEDED(GetSizeOnDisk(&amp;mFolderSize)))</span>
<a href="#l13.36"></a><span id="l13.36">     NotifyIntPropertyChanged(kFolderSizeAtom, oldFolderSize, mFolderSize);</span>
<a href="#l13.37"></a><span id="l13.37">   return NS_OK;</span>
<a href="#l13.38"></a><span id="l13.38"> }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetSizeOnDisk(uint32_t* aSize)</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetSizeOnDisk(int64_t *aSize)</span>
<a href="#l13.42"></a><span id="l13.42"> {</span>
<a href="#l13.43"></a><span id="l13.43">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l13.44"></a><span id="l13.44">   nsresult rv = NS_OK;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  if (!mFolderSize)</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  if (mFolderSize == kSizeUnknown)</span>
<a href="#l13.47"></a><span id="l13.47">   {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l13.50"></a><span id="l13.50">     rv = GetFilePath(getter_AddRefs(file));</span>
<a href="#l13.51"></a><span id="l13.51">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    // Use a temporary variable so that we keep mFolderSize on kSizeUnknown</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    // if GetFileSize() fails.</span>
<a href="#l13.54"></a><span id="l13.54">     int64_t folderSize;</span>
<a href="#l13.55"></a><span id="l13.55">     rv = file-&gt;GetFileSize(&amp;folderSize);</span>
<a href="#l13.56"></a><span id="l13.56">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    mFolderSize = (uint32_t) folderSize;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+    mFolderSize = folderSize;</span>
<a href="#l13.60"></a><span id="l13.60">   }</span>
<a href="#l13.61"></a><span id="l13.61">   *aSize = mFolderSize;</span>
<a href="#l13.62"></a><span id="l13.62">   return rv;</span>
<a href="#l13.63"></a><span id="l13.63"> }</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65"> nsresult</span>
<a href="#l13.66"></a><span id="l13.66"> nsMsgLocalMailFolder::GetTrashFolder(nsIMsgFolder** result)</span>
<a href="#l13.67"></a><span id="l13.67"> {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineat">@@ -3135,16 +3139,27 @@ nsMsgLocalMailFolder::OnStopRunningUrl(n</span>
<a href="#l13.69"></a><span id="l13.69">     }</span>
<a href="#l13.70"></a><span id="l13.70">   }</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72">   if (m_parsingFolder)</span>
<a href="#l13.73"></a><span id="l13.73">   {</span>
<a href="#l13.74"></a><span id="l13.74">     // Clear this before calling OnStopRunningUrl, in case the url listener</span>
<a href="#l13.75"></a><span id="l13.75">     // tries to get the database.</span>
<a href="#l13.76"></a><span id="l13.76">     m_parsingFolder = false;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    // TODO: Updating the size should be pushed down into the msg store backend</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    // so that the size is recalculated as part of parsing the folder data</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    // (important for maildir), once GetSizeOnDisk is pushed into the msgStores</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    // (bug 1032360).</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    (void)RefreshSizeOnDisk();</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    // Update the summary totals so the front end will</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+    // show the right thing.</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    UpdateSummaryTotals(true);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+</span>
<a href="#l13.88"></a><span id="l13.88">     if (mReparseListener)</span>
<a href="#l13.89"></a><span id="l13.89">     {</span>
<a href="#l13.90"></a><span id="l13.90">       nsCOMPtr&lt;nsIUrlListener&gt; saveReparseListener = mReparseListener;</span>
<a href="#l13.91"></a><span id="l13.91">       mReparseListener = nullptr;</span>
<a href="#l13.92"></a><span id="l13.92">       saveReparseListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l13.93"></a><span id="l13.93">     }</span>
<a href="#l13.94"></a><span id="l13.94">   }</span>
<a href="#l13.95"></a><span id="l13.95">   if (mFlags &amp; nsMsgFolderFlags::Inbox)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -126,22 +126,22 @@ public:</span>
<a href="#l14.4"></a><span id="l14.4">   NS_IMETHOD Rename (const nsAString&amp; aNewName, nsIMsgWindow *msgWindow) MOZ_OVERRIDE;</span>
<a href="#l14.5"></a><span id="l14.5">   NS_IMETHOD RenameSubFolders (nsIMsgWindow *msgWindow, nsIMsgFolder *oldFolder) MOZ_OVERRIDE;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">   NS_IMETHOD GetPrettyName(nsAString&amp; prettyName) MOZ_OVERRIDE; // Override of the base, for top-level mail folder</span>
<a href="#l14.8"></a><span id="l14.8">   NS_IMETHOD SetPrettyName(const nsAString&amp; aName) MOZ_OVERRIDE;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">   NS_IMETHOD GetFolderURL(nsACString&amp; url) MOZ_OVERRIDE;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  NS_IMETHOD  GetManyHeadersToDownload(bool *retval) MOZ_OVERRIDE;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  NS_IMETHOD GetManyHeadersToDownload(bool *retval) MOZ_OVERRIDE;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">   NS_IMETHOD GetDeletable (bool *deletable) MOZ_OVERRIDE;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-  NS_IMETHOD GetSizeOnDisk(uint32_t* size) MOZ_OVERRIDE;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  NS_IMETHOD GetSizeOnDisk(int64_t *size) MOZ_OVERRIDE;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  NS_IMETHOD  GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **db) MOZ_OVERRIDE;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **db) MOZ_OVERRIDE;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22">   NS_IMETHOD DeleteMessages(nsIArray *messages, </span>
<a href="#l14.23"></a><span id="l14.23">                       nsIMsgWindow *msgWindow, bool</span>
<a href="#l14.24"></a><span id="l14.24">                       deleteStorage, bool isMove,</span>
<a href="#l14.25"></a><span id="l14.25">                       nsIMsgCopyServiceListener* listener, bool allowUndo) MOZ_OVERRIDE;</span>
<a href="#l14.26"></a><span id="l14.26">   NS_IMETHOD CopyMessages(nsIMsgFolder *srcFolder, nsIArray* messages,</span>
<a href="#l14.27"></a><span id="l14.27">                           bool isMove, nsIMsgWindow *msgWindow,</span>
<a href="#l14.28"></a><span id="l14.28">                           nsIMsgCopyServiceListener* listener, bool isFolder, bool allowUndo) MOZ_OVERRIDE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -30,90 +30,132 @@ Services.prefs.setCharPref(&quot;mail.serverD</span>
<a href="#l15.4"></a><span id="l15.4"> // If we're running out of memory parsing the folder, lowering the</span>
<a href="#l15.5"></a><span id="l15.5"> // block size might help, though it will slow the test down and consume</span>
<a href="#l15.6"></a><span id="l15.6"> // more disk space.</span>
<a href="#l15.7"></a><span id="l15.7"> const kSparseBlockSize = 102400000;</span>
<a href="#l15.8"></a><span id="l15.8"> const kSizeLimit = 0x100000000; // 4GiB</span>
<a href="#l15.9"></a><span id="l15.9"> const kNearLimit = kSizeLimit - 0x1000000; // -16MiB</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> var gGotAlert = false;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var gInboxFile = null;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-var gInboxSize = 0;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+var gInboxFile = null;         // The mbox file storing the Inbox folder</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+var gInboxSize = 0;            // The size of the Inbox folder</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+var gInbox;                    // The nsIMsgFolder object of the Inbox folder in Local Folders</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+var gExpectedNewMessages = 0;  // The number of messages pushed manually into the mbox file</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19"> // This alert() is triggered when file size becomes close (enough) to or</span>
<a href="#l15.20"></a><span id="l15.20"> // exceeds 4 GiB.</span>
<a href="#l15.21"></a><span id="l15.21"> // See hardcoded value in nsMsgBrkMBoxStore::HasSpaceAvailable().</span>
<a href="#l15.22"></a><span id="l15.22"> function alert(aDialogTitle, aText) {</span>
<a href="#l15.23"></a><span id="l15.23">   // See &quot;/*/locales/en-US/chrome/*/messenger.properties &gt; mailboxTooLarge&quot;.</span>
<a href="#l15.24"></a><span id="l15.24">   do_check_true(aText.startsWith(&quot;The folder Inbox is full, and can't hold any more messages.&quot;));</span>
<a href="#l15.25"></a><span id="l15.25">   gGotAlert = true;</span>
<a href="#l15.26"></a><span id="l15.26"> }</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+// A stub nsIMsgFolderListener that only listens to changes on Inbox and stores</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+// the seen values for interesting folder properties so we can later test them.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+var FListener = {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  folderSize: [-1], // an array of seen values of &quot;FolderSize&quot;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  totalMsgs: [-1],  // an array of seen values of &quot;TotalMessages&quot;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  // Returns the value that is stored 'aBack' entries from the last one in the history.</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  sizeHistory: function (aBack) {</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    return this.folderSize[this.folderSize.length - 1 - aBack];</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  },</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  msgsHistory: function (aBack) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+    return this.totalMsgs[this.totalMsgs.length - 1 - aBack];</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  },</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  OnItemAdded: function act_add(aRDFParentItem, aItem) {},</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  OnItemRemoved: function act_remove(aRDFParentItem, aItem) {},</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  OnItemPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  OnItemIntPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+    if (aItem.prettyName == &quot;Inbox&quot;) {</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+      dump(&quot;Property change on folder Inbox:&quot; + aProperty + &quot;=&quot; + aOld + &quot;-&gt;&quot; + aNew + &quot;\n&quot;);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      if (aProperty == &quot;FolderSize&quot;)</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+        this.folderSize.push(aNew);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+      else if (aProperty == &quot;TotalMessages&quot;)</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+        this.totalMsgs.push(aNew);</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    }</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  },</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  OnItemBoolPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  OnItemUnicharPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  OnItemPropertyFlagChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  OnItemEvent: function(aFolder, aEvent) {},</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+};</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+</span>
<a href="#l15.60"></a><span id="l15.60"> /**</span>
<a href="#l15.61"></a><span id="l15.61">  * Grow local inbox folder to the wanted size using direct appending</span>
<a href="#l15.62"></a><span id="l15.62">  * to the underlying file. The folder is filled with copies of a dummy</span>
<a href="#l15.63"></a><span id="l15.63">  * message with kSparseBlockSize bytes in size.</span>
<a href="#l15.64"></a><span id="l15.64">  * The file is marked as sparse in the filesystem so that it does not</span>
<a href="#l15.65"></a><span id="l15.65">  * really take 4GiB and working with it is faster.</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+ *</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+ * @return  The number of messages created in the folder file.</span>
<a href="#l15.68"></a><span id="l15.68">  */</span>
<a href="#l15.69"></a><span id="l15.69"> function growInbox(aWantedSize) {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  let msgsAdded = 0;</span>
<a href="#l15.71"></a><span id="l15.71">   // Put a single message in the Inbox.</span>
<a href="#l15.72"></a><span id="l15.72">   let messageGenerator = new MessageGenerator();</span>
<a href="#l15.73"></a><span id="l15.73">   let message = messageGenerator.makeMessage();</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75">   // Refresh 'gInboxFile'.</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-  gInboxFile = localAccountUtils.inboxFolder.filePath;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  gInboxFile = gInbox.filePath;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  let localSize = 0;</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80">   let mboxString = message.toMboxString();</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-  let plugStore = localAccountUtils.inboxFolder.msgStore;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  let plugStore = gInbox.msgStore;</span>
<a href="#l15.83"></a><span id="l15.83">   // Grow local inbox to our wished size that is below the max limit.</span>
<a href="#l15.84"></a><span id="l15.84">   do {</span>
<a href="#l15.85"></a><span id="l15.85">     let nextOffset = gInboxFile.fileSize +</span>
<a href="#l15.86"></a><span id="l15.86">       Math.min(kSparseBlockSize + mboxString.length,</span>
<a href="#l15.87"></a><span id="l15.87">                aWantedSize - gInboxFile.fileSize) - 2;</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">     // Get stream to write a new message.</span>
<a href="#l15.90"></a><span id="l15.90">     let reusable = new Object;</span>
<a href="#l15.91"></a><span id="l15.91">     let newMsgHdr = new Object;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    let outputStream = plugStore.getNewMsgOutputStream(localAccountUtils.inboxFolder,</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-                                                       newMsgHdr, reusable)</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+    let outputStream = plugStore.getNewMsgOutputStream(gInbox, newMsgHdr, reusable)</span>
<a href="#l15.95"></a><span id="l15.95">                                 .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l15.96"></a><span id="l15.96">     // Write message header.</span>
<a href="#l15.97"></a><span id="l15.97">     outputStream.write(mboxString, mboxString.length);</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">     // &quot;Add&quot; a new (empty) sparse block at the end of the file.</span>
<a href="#l15.100"></a><span id="l15.100">     mailTestUtils.mark_file_region_sparse(gInboxFile,</span>
<a href="#l15.101"></a><span id="l15.101">       gInboxFile.fileSize + mboxString.length,</span>
<a href="#l15.102"></a><span id="l15.102">       nextOffset - (gInboxFile.fileSize + mboxString.length));</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">     // Skip to the wished end of the message.</span>
<a href="#l15.105"></a><span id="l15.105">     outputStream.seek(0, nextOffset);</span>
<a href="#l15.106"></a><span id="l15.106">     // Add a CR+LF to terminate the message.</span>
<a href="#l15.107"></a><span id="l15.107">     outputStream.write(&quot;\r\n&quot;, 2);</span>
<a href="#l15.108"></a><span id="l15.108">     outputStream.close();</span>
<a href="#l15.109"></a><span id="l15.109">     plugStore.finishNewMessage(outputStream, newMsgHdr);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+    msgsAdded++;</span>
<a href="#l15.111"></a><span id="l15.111"> </span>
<a href="#l15.112"></a><span id="l15.112">     // Refresh 'gInboxFile'.</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-    gInboxFile = localAccountUtils.inboxFolder.filePath;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+    gInboxFile = gInbox.filePath;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+    localSize = gInboxFile.fileSize;</span>
<a href="#l15.116"></a><span id="l15.116">   }</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-  while (gInboxFile.fileSize &lt; aWantedSize);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  while (localSize &lt; aWantedSize);</span>
<a href="#l15.119"></a><span id="l15.119"> </span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-  do_print(&quot;Local inbox size = &quot; + gInboxFile.fileSize + &quot;bytes = &quot; +</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-           gInboxFile.fileSize / 1024 / 1024 + &quot;MiB&quot;);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  do_print(&quot;Local inbox size = &quot; + localSize + &quot;bytes = &quot; +</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+           mailTestUtils.toMiBString(localSize));</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  do_check_eq(localSize, aWantedSize);</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+  return msgsAdded;</span>
<a href="#l15.126"></a><span id="l15.126"> }</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128"> function run_test()</span>
<a href="#l15.129"></a><span id="l15.129"> {</span>
<a href="#l15.130"></a><span id="l15.130">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l15.131"></a><span id="l15.131"> </span>
<a href="#l15.132"></a><span id="l15.132">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l15.133"></a><span id="l15.133">   // all the operations.</span>
<a href="#l15.134"></a><span id="l15.134">   do_test_pending();</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  gInboxFile = localAccountUtils.inboxFolder.filePath;</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  gInbox = localAccountUtils.inboxFolder;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  gInboxFile = gInbox.filePath;</span>
<a href="#l15.139"></a><span id="l15.139"> </span>
<a href="#l15.140"></a><span id="l15.140">   let neededFreeSpace = kSizeLimit + 0x10000000; // +256MiB</span>
<a href="#l15.141"></a><span id="l15.141">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l15.142"></a><span id="l15.142">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l15.143"></a><span id="l15.143">   // FAT32, which doesn't support file sizes greater than 4 GiB.</span>
<a href="#l15.144"></a><span id="l15.144">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc &amp;&amp;</span>
<a href="#l15.145"></a><span id="l15.145">       mailTestUtils.get_file_system(gInboxFile) != &quot;NTFS&quot;)</span>
<a href="#l15.146"></a><span id="l15.146">   {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineat">@@ -129,26 +171,27 @@ function run_test()</span>
<a href="#l15.148"></a><span id="l15.148">     do_print(&quot;This test needs &quot; + mailTestUtils.toMiBString(neededFreeSpace) +</span>
<a href="#l15.149"></a><span id="l15.149">              &quot; free space to run. Aborting.&quot;);</span>
<a href="#l15.150"></a><span id="l15.150">     todo_check_true(false);</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152">     endTest();</span>
<a href="#l15.153"></a><span id="l15.153">     return;</span>
<a href="#l15.154"></a><span id="l15.154">   }</span>
<a href="#l15.155"></a><span id="l15.155"> </span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-  // Grow inbox to size near the max limit.</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-  growInbox(kNearLimit);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  MailServices.mailSession.AddFolderListener(FListener, Ci.nsIFolderListener.all);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+  // Grow inbox to a size near the max limit.</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+  gExpectedNewMessages = growInbox(kNearLimit);</span>
<a href="#l15.162"></a><span id="l15.162"> </span>
<a href="#l15.163"></a><span id="l15.163">   // Force the db closed, so that getDatabaseWithReparse will notice</span>
<a href="#l15.164"></a><span id="l15.164">   // that it's out of date.</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase.ForceClosed();</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase = null;</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+  gInbox.msgDatabase.ForceClosed();</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+  gInbox.msgDatabase = null;</span>
<a href="#l15.169"></a><span id="l15.169">   try {</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-    localAccountUtils.inboxFolder.getDatabaseWithReparse(ParseListener_run_test,</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-                                                         gDummyMsgWindow);</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+    gInbox.getDatabaseWithReparse(ParseListener_run_test, gDummyMsgWindow);</span>
<a href="#l15.173"></a><span id="l15.173">   } catch (ex) {</span>
<a href="#l15.174"></a><span id="l15.174">     do_check_eq(ex.result, Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.175"></a><span id="l15.175">   }</span>
<a href="#l15.176"></a><span id="l15.176">   // Execution continues in downloadUnder4GiB() when done.</span>
<a href="#l15.177"></a><span id="l15.177"> }</span>
<a href="#l15.178"></a><span id="l15.178"> </span>
<a href="#l15.179"></a><span id="l15.179"> /**</span>
<a href="#l15.180"></a><span id="l15.180">  * Check we can download new mail when we are near 4GiB limit but do not cross it.</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineat">@@ -174,16 +217,17 @@ function downloadUnder4GiB()</span>
<a href="#l15.182"></a><span id="l15.182">  * Bug 640371</span>
<a href="#l15.183"></a><span id="l15.183">  * Check we will not cross the 4GiB limit when downloading new mail.</span>
<a href="#l15.184"></a><span id="l15.184">  */</span>
<a href="#l15.185"></a><span id="l15.185"> function downloadOver4GiB()</span>
<a href="#l15.186"></a><span id="l15.186"> {</span>
<a href="#l15.187"></a><span id="l15.187">   let localInboxSize = gInboxFile.fileSize;</span>
<a href="#l15.188"></a><span id="l15.188">   do_check_true(localInboxSize &gt; kNearLimit);</span>
<a href="#l15.189"></a><span id="l15.189">   do_check_true(localInboxSize &lt; kSizeLimit);</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+  do_check_eq(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l15.191"></a><span id="l15.191">   // The big file is between 1 and 2 MiB. Append it 16 times to attempt to cross the 4GiB limit.</span>
<a href="#l15.192"></a><span id="l15.192">   gPOP3Pump.files = [&quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.193"></a><span id="l15.193">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.194"></a><span id="l15.194">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.195"></a><span id="l15.195">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.196"></a><span id="l15.196">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.197"></a><span id="l15.197">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.198"></a><span id="l15.198">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineat">@@ -198,26 +242,25 @@ function downloadOver4GiB()</span>
<a href="#l15.200"></a><span id="l15.200">  * Bug 608449</span>
<a href="#l15.201"></a><span id="l15.201">  * Check we can parse a folder if it is above 4GiB.</span>
<a href="#l15.202"></a><span id="l15.202">  */</span>
<a href="#l15.203"></a><span id="l15.203"> function growOver4GiB()</span>
<a href="#l15.204"></a><span id="l15.204"> {</span>
<a href="#l15.205"></a><span id="l15.205">   gPOP3Pump = null;</span>
<a href="#l15.206"></a><span id="l15.206"> </span>
<a href="#l15.207"></a><span id="l15.207">   // Grow inbox to size greater than the max limit (+16 MiB).</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-  growInbox(kSizeLimit + 0x1000000);</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+  gExpectedNewMessages = growInbox(kSizeLimit + 0x1000000);</span>
<a href="#l15.210"></a><span id="l15.210">   do_check_true(gInboxFile.fileSize &gt; kSizeLimit);</span>
<a href="#l15.211"></a><span id="l15.211"> </span>
<a href="#l15.212"></a><span id="l15.212">   // Force the db closed, so that getDatabaseWithReparse will notice</span>
<a href="#l15.213"></a><span id="l15.213">   // that it's out of date.</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase.ForceClosed();</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase = null;</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+  gInbox.msgDatabase.ForceClosed();</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+  gInbox.msgDatabase = null;</span>
<a href="#l15.218"></a><span id="l15.218">   try {</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-    localAccountUtils.inboxFolder.getDatabaseWithReparse(ParseListener_growOver4GiB,</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-                                                         gDummyMsgWindow);</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+    gInbox.getDatabaseWithReparse(ParseListener_growOver4GiB, gDummyMsgWindow);</span>
<a href="#l15.222"></a><span id="l15.222">   } catch (ex) {</span>
<a href="#l15.223"></a><span id="l15.223">     do_check_eq(ex.result, Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.224"></a><span id="l15.224">   }</span>
<a href="#l15.225"></a><span id="l15.225">   // Execution continues in copyOver4GiB() when done.</span>
<a href="#l15.226"></a><span id="l15.226"> }</span>
<a href="#l15.227"></a><span id="l15.227"> </span>
<a href="#l15.228"></a><span id="l15.228"> /**</span>
<a href="#l15.229"></a><span id="l15.229">  * Bug 598104</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineat">@@ -235,179 +278,212 @@ function copyIntoOver4GiB()</span>
<a href="#l15.231"></a><span id="l15.231">   let file = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l15.232"></a><span id="l15.232">   copyFileMessageInLocalFolder(file, 0, &quot;&quot;, gDummyMsgWindow,</span>
<a href="#l15.233"></a><span id="l15.233">                                function(aMessageHeadersKeys, aStatus) {</span>
<a href="#l15.234"></a><span id="l15.234">     do_check_false(Components.isSuccessCode(aStatus));</span>
<a href="#l15.235"></a><span id="l15.235">   });</span>
<a href="#l15.236"></a><span id="l15.236">   do_check_true(gGotAlert);</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238">   // Make sure inbox file did not grow (i.e., no data were appended).</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-  let newLocalInboxSize = localAccountUtils.inboxFolder.filePath.fileSize;</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+  let newLocalInboxSize = gInbox.filePath.fileSize;</span>
<a href="#l15.241"></a><span id="l15.241">   do_print(&quot;Local inbox size (after copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l15.242"></a><span id="l15.242">            newLocalInboxSize);</span>
<a href="#l15.243"></a><span id="l15.243">   do_check_eq(newLocalInboxSize, localInboxSize);</span>
<a href="#l15.244"></a><span id="l15.244"> </span>
<a href="#l15.245"></a><span id="l15.245">   // Append a new small message to the folder (+1 MiB).</span>
<a href="#l15.246"></a><span id="l15.246">   growInbox(gInboxFile.fileSize + 0x100000);</span>
<a href="#l15.247"></a><span id="l15.247">   do_check_true(gInboxFile.fileSize &gt; kSizeLimit);</span>
<a href="#l15.248"></a><span id="l15.248"> </span>
<a href="#l15.249"></a><span id="l15.249">   // Force the db closed, so that getDatabaseWithReparse will notice</span>
<a href="#l15.250"></a><span id="l15.250">   // that it's out of date.</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase.ForceClosed();</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-  localAccountUtils.inboxFolder.msgDatabase = null;</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+  gInbox.msgDatabase.ForceClosed();</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineplus">+  gInbox.msgDatabase = null;</span>
<a href="#l15.255"></a><span id="l15.255">   try {</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-    localAccountUtils.inboxFolder.getDatabaseWithReparse(ParseListener_copyIntoOver4GiB,</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-                                                         gDummyMsgWindow);</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+    gInbox.getDatabaseWithReparse(ParseListener_copyIntoOver4GiB, gDummyMsgWindow);</span>
<a href="#l15.259"></a><span id="l15.259">   } catch (ex) {</span>
<a href="#l15.260"></a><span id="l15.260">     do_check_eq(ex.result, Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.261"></a><span id="l15.261">   }</span>
<a href="#l15.262"></a><span id="l15.262">   // Execution continues in compactOver4GiB() when done.</span>
<a href="#l15.263"></a><span id="l15.263"> }</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265"> /**</span>
<a href="#l15.266"></a><span id="l15.266">  * Bug 794303</span>
<a href="#l15.267"></a><span id="l15.267">  * Check we can compact a folder that stays above 4 GiB after compact.</span>
<a href="#l15.268"></a><span id="l15.268">  */</span>
<a href="#l15.269"></a><span id="l15.269"> function compactOver4GiB()</span>
<a href="#l15.270"></a><span id="l15.270"> {</span>
<a href="#l15.271"></a><span id="l15.271">   gInboxSize = gInboxFile.fileSize;</span>
<a href="#l15.272"></a><span id="l15.272">   do_check_true(gInboxSize &gt; kSizeLimit);</span>
<a href="#l15.273"></a><span id="l15.273">   // Delete the last small message at folder end.</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-  let msgDB = localAccountUtils.inboxFolder.msgDatabase;</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+  let msgDB = gInbox.msgDatabase;</span>
<a href="#l15.276"></a><span id="l15.276">   let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l15.277"></a><span id="l15.277">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l15.278"></a><span id="l15.278">   while (enumerator.hasMoreElements()) {</span>
<a href="#l15.279"></a><span id="l15.279">     let header = enumerator.getNext();</span>
<a href="#l15.280"></a><span id="l15.280">     if (!enumerator.hasMoreElements()) {</span>
<a href="#l15.281"></a><span id="l15.281">       do_check_true(header instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l15.282"></a><span id="l15.282">       messages.appendElement(header, false);</span>
<a href="#l15.283"></a><span id="l15.283">     }</span>
<a href="#l15.284"></a><span id="l15.284">   }</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-  localAccountUtils.inboxFolder.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+  gInbox.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l15.287"></a><span id="l15.287"> </span>
<a href="#l15.288"></a><span id="l15.288">   /* Unfortunately, the compaction now would kill the sparse markings in the file</span>
<a href="#l15.289"></a><span id="l15.289">    * so it will really take 4GiB of space in the filesystem and may be slow</span>
<a href="#l15.290"></a><span id="l15.290">    * (e.g. it takes ~450s on TB-try). Therefore we run this part of the test randomly,</span>
<a href="#l15.291"></a><span id="l15.291">    * only in 1 of 100 runs. Considering the number of times all the tests are run</span>
<a href="#l15.292"></a><span id="l15.292">    * per check-in, this still runs this test after several check-ins.*/</span>
<a href="#l15.293"></a><span id="l15.293">   if (Math.random() * 100 &lt; 1) {</span>
<a href="#l15.294"></a><span id="l15.294">     // Note: compact() will also add 'X-Mozilla-Status' and 'X-Mozilla-Status2'</span>
<a href="#l15.295"></a><span id="l15.295">     // lines to message(s).</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-    localAccountUtils.inboxFolder.compact(CompactListener_compactOver4GiB, null);</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+    gInbox.compact(CompactListener_compactOver4GiB, null);</span>
<a href="#l15.298"></a><span id="l15.298">     // Execution continues in compactUnder4GiB() when done.</span>
<a href="#l15.299"></a><span id="l15.299">   } else {</span>
<a href="#l15.300"></a><span id="l15.300">     // Just continue directly without compacting yet.</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-    dump(&quot;compactOver4GiB test skipped deliberately due to long expected run time. It will may be run in other test run with a 1 in 100 chance.&quot;);</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+    dump(&quot;compactOver4GiB test skipped deliberately due to long expected run time. It will be run in other test run with a 1 in 100 chance.&quot;);</span>
<a href="#l15.303"></a><span id="l15.303">     compactUnder4GiB();</span>
<a href="#l15.304"></a><span id="l15.304">   }</span>
<a href="#l15.305"></a><span id="l15.305"> }</span>
<a href="#l15.306"></a><span id="l15.306"> </span>
<a href="#l15.307"></a><span id="l15.307"> /**</span>
<a href="#l15.308"></a><span id="l15.308">  * Bug 608449</span>
<a href="#l15.309"></a><span id="l15.309">  * Check we can compact a folder to get it under 4 GiB.</span>
<a href="#l15.310"></a><span id="l15.310">  */</span>
<a href="#l15.311"></a><span id="l15.311"> function compactUnder4GiB()</span>
<a href="#l15.312"></a><span id="l15.312"> {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+  // The folder is still above 4GB.</span>
<a href="#l15.314"></a><span id="l15.314">   do_check_true(gInboxFile.fileSize &gt; kSizeLimit);</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+  let folderSize = gInbox.sizeOnDisk;</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+  let totalMsgs = gInbox.getTotalMessages(false);</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+  // Let's close the database and re-open the folder (hopefully dumping memory caches)</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+  // and re-reading the values from disk (msg database). That is to test if</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+  // the values were properly serialized to the database.</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+  gInbox.ForceDBClosed();</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+  gInbox.msgDatabase = null;</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+  gInbox.getDatabaseWOReparse();</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+  do_check_eq(gInbox.sizeOnDisk, folderSize);</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineplus">+  do_check_eq(gInbox.getTotalMessages(false), totalMsgs);</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+</span>
<a href="#l15.327"></a><span id="l15.327">   // Very first header in msgDB is retained,</span>
<a href="#l15.328"></a><span id="l15.328">   // then all other headers are marked as deleted.</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-  let msgDB = localAccountUtils.inboxFolder.msgDatabase;</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+  let msgDB = gInbox.msgDatabase;</span>
<a href="#l15.331"></a><span id="l15.331">   let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l15.332"></a><span id="l15.332">   let firstHdr = true;</span>
<a href="#l15.333"></a><span id="l15.333">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l15.334"></a><span id="l15.334">   while (enumerator.hasMoreElements()) {</span>
<a href="#l15.335"></a><span id="l15.335">     let header = enumerator.getNext();</span>
<a href="#l15.336"></a><span id="l15.336">     if (header instanceof Ci.nsIMsgDBHdr &amp;&amp; !firstHdr)</span>
<a href="#l15.337"></a><span id="l15.337">       messages.appendElement(header, false);</span>
<a href="#l15.338"></a><span id="l15.338">     firstHdr = false;</span>
<a href="#l15.339"></a><span id="l15.339">   }</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineminus">-  localAccountUtils.inboxFolder.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineplus">+  gInbox.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l15.342"></a><span id="l15.342"> </span>
<a href="#l15.343"></a><span id="l15.343">   // Note: compact() will also add 'X-Mozilla-Status' and 'X-Mozilla-Status2'</span>
<a href="#l15.344"></a><span id="l15.344">   // lines to message(s).</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-  localAccountUtils.inboxFolder.compact(CompactListener_compactUnder4GiB, null);</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+  gInbox.compact(CompactListener_compactUnder4GiB, null);</span>
<a href="#l15.347"></a><span id="l15.347">   // Test ends after compaction is done.</span>
<a href="#l15.348"></a><span id="l15.348"> }</span>
<a href="#l15.349"></a><span id="l15.349"> </span>
<a href="#l15.350"></a><span id="l15.350"> var ParseListener_run_test =</span>
<a href="#l15.351"></a><span id="l15.351"> {</span>
<a href="#l15.352"></a><span id="l15.352">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l15.353"></a><span id="l15.353">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.354"></a><span id="l15.354">     // Check: reparse successful</span>
<a href="#l15.355"></a><span id="l15.355">     do_check_eq(aExitCode, 0);</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-    do_check_neq(localAccountUtils.inboxFolder.msgDatabase, null);</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-    do_check_true(localAccountUtils.inboxFolder.msgDatabase.summaryValid);</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineplus">+    do_check_neq(gInbox.msgDatabase, null);</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineplus">+    do_check_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineplus">+    // Bug 813459</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+    // Check if the OnItemIntPropertyChanged folder listener hook can return</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+    // values below 2^32 for properties which are not 64 bits long.</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+    do_check_eq(FListener.msgsHistory(0), gExpectedNewMessages);</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+    do_check_eq(FListener.msgsHistory(0), gInbox.getTotalMessages(false));</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineplus">+    do_check_eq(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l15.366"></a><span id="l15.366"> </span>
<a href="#l15.367"></a><span id="l15.367">     downloadUnder4GiB();</span>
<a href="#l15.368"></a><span id="l15.368">   }</span>
<a href="#l15.369"></a><span id="l15.369"> };</span>
<a href="#l15.370"></a><span id="l15.370"> </span>
<a href="#l15.371"></a><span id="l15.371"> var ParseListener_growOver4GiB =</span>
<a href="#l15.372"></a><span id="l15.372"> {</span>
<a href="#l15.373"></a><span id="l15.373">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l15.374"></a><span id="l15.374">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.375"></a><span id="l15.375">     // Check: reparse successful</span>
<a href="#l15.376"></a><span id="l15.376">     do_check_eq(aExitCode, 0);</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-    do_check_neq(localAccountUtils.inboxFolder.msgDatabase, null);</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-    do_check_true(localAccountUtils.inboxFolder.msgDatabase.summaryValid);</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+    do_check_neq(gInbox.msgDatabase, null);</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+    do_check_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+    // Bug 789679</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+    // Check if the public SizeOnDisk method can return sizes above 4GB.</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+    do_check_true(gInbox.sizeOnDisk &gt; kSizeLimit);</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineplus">+    // Bug 813459</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineplus">+    // Check if the OnItemIntPropertyChanged folder listener hook can return</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineplus">+    // values above 2^32 for properties where it is relevant.</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+    do_check_eq(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+    do_check_true(FListener.sizeHistory(1) &lt; FListener.sizeHistory(0));</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    do_check_eq(FListener.msgsHistory(0),</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+                FListener.msgsHistory(1) + gExpectedNewMessages);</span>
<a href="#l15.391"></a><span id="l15.391"> </span>
<a href="#l15.392"></a><span id="l15.392">     copyIntoOver4GiB();</span>
<a href="#l15.393"></a><span id="l15.393">   }</span>
<a href="#l15.394"></a><span id="l15.394"> };</span>
<a href="#l15.395"></a><span id="l15.395"> </span>
<a href="#l15.396"></a><span id="l15.396"> var ParseListener_copyIntoOver4GiB =</span>
<a href="#l15.397"></a><span id="l15.397"> {</span>
<a href="#l15.398"></a><span id="l15.398">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l15.399"></a><span id="l15.399">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.400"></a><span id="l15.400">     // Check: reparse successful</span>
<a href="#l15.401"></a><span id="l15.401">     do_check_eq(aExitCode, 0);</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-    do_check_neq(localAccountUtils.inboxFolder.msgDatabase, null);</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineminus">-    do_check_true(localAccountUtils.inboxFolder.msgDatabase.summaryValid);</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    do_check_neq(gInbox.msgDatabase, null);</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+    do_check_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l15.406"></a><span id="l15.406"> </span>
<a href="#l15.407"></a><span id="l15.407">     compactOver4GiB();</span>
<a href="#l15.408"></a><span id="l15.408">   }</span>
<a href="#l15.409"></a><span id="l15.409"> };</span>
<a href="#l15.410"></a><span id="l15.410"> </span>
<a href="#l15.411"></a><span id="l15.411"> var CompactListener_compactOver4GiB =</span>
<a href="#l15.412"></a><span id="l15.412"> {</span>
<a href="#l15.413"></a><span id="l15.413">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l15.414"></a><span id="l15.414">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.415"></a><span id="l15.415">     // Check: message successfully copied.</span>
<a href="#l15.416"></a><span id="l15.416">     do_check_eq(aExitCode, 0);</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineminus">-    do_check_true(localAccountUtils.inboxFolder.msgDatabase.summaryValid);</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineplus">+    do_check_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l15.419"></a><span id="l15.419">     // Check that folder size is still above max limit ...</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-    let localInboxSize = localAccountUtils.inboxFolder.filePath.fileSize;</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-    do_print(&quot;Local inbox size (after compact()) = &quot; + localInboxSize);</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineplus">+    let localInboxSize = gInbox.filePath.fileSize;</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+    do_print(&quot;Local inbox size (after compact 1) = &quot; + localInboxSize);</span>
<a href="#l15.424"></a><span id="l15.424">     do_check_true(localInboxSize &gt; kSizeLimit);</span>
<a href="#l15.425"></a><span id="l15.425">     // ... but it got smaller by removing 1 message.</span>
<a href="#l15.426"></a><span id="l15.426">     do_check_true(gInboxSize &gt; localInboxSize);</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+    do_check_eq(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l15.428"></a><span id="l15.428"> </span>
<a href="#l15.429"></a><span id="l15.429">     compactUnder4GiB();</span>
<a href="#l15.430"></a><span id="l15.430">   }</span>
<a href="#l15.431"></a><span id="l15.431"> };</span>
<a href="#l15.432"></a><span id="l15.432"> </span>
<a href="#l15.433"></a><span id="l15.433"> var CompactListener_compactUnder4GiB =</span>
<a href="#l15.434"></a><span id="l15.434"> {</span>
<a href="#l15.435"></a><span id="l15.435">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l15.436"></a><span id="l15.436">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.437"></a><span id="l15.437">     // Check: message successfully copied.</span>
<a href="#l15.438"></a><span id="l15.438">     do_check_eq(aExitCode, 0);</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-    do_check_true(localAccountUtils.inboxFolder.msgDatabase.summaryValid);</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+    do_check_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l15.441"></a><span id="l15.441"> </span>
<a href="#l15.442"></a><span id="l15.442">     // Check that folder size isn't much bigger than our sparse block size, ...</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-    let localInboxSize = localAccountUtils.inboxFolder.filePath.fileSize;</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-    do_print(&quot;Local inbox size (after compact()) = &quot; + localInboxSize);</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+    let localInboxSize = gInbox.filePath.fileSize;</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+    do_print(&quot;Local inbox size (after compact 2) = &quot; + localInboxSize);</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+    do_check_eq(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l15.448"></a><span id="l15.448">     do_check_true(localInboxSize &lt; kSparseBlockSize + 1000);</span>
<a href="#l15.449"></a><span id="l15.449">     // ... i.e., that we just have one message.</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-    do_check_eq(localAccountUtils.inboxFolder.getTotalMessages(false), 1);</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+    do_check_eq(gInbox.getTotalMessages(false), 1);</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+    do_check_eq(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+    do_check_eq(FListener.msgsHistory(0), 1);</span>
<a href="#l15.454"></a><span id="l15.454"> </span>
<a href="#l15.455"></a><span id="l15.455">     endTest();</span>
<a href="#l15.456"></a><span id="l15.456">   }</span>
<a href="#l15.457"></a><span id="l15.457"> };</span>
<a href="#l15.458"></a><span id="l15.458"> </span>
<a href="#l15.459"></a><span id="l15.459"> function endTest()</span>
<a href="#l15.460"></a><span id="l15.460"> {</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+   MailServices.mailSession.RemoveFolderListener(FListener);</span>
<a href="#l15.462"></a><span id="l15.462">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l15.463"></a><span id="l15.463">   // this test, comment out this line.</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-  localAccountUtils.inboxFolder.filePath.remove(false);</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineplus">+  gInbox.filePath.remove(false);</span>
<a href="#l15.466"></a><span id="l15.466"> </span>
<a href="#l15.467"></a><span id="l15.467">   do_test_finished();</span>
<a href="#l15.468"></a><span id="l15.468"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -7,16 +7,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;prlog.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nntpCore.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsNewsFolder.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;MailNewsTypes.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;prprf.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;prsystem.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsIArray.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -68,18 +69,16 @@ static NS_DEFINE_CID(kRDFServiceCID, NS_</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23"> // ###tw  This really ought to be the most</span>
<a href="#l16.24"></a><span id="l16.24"> // efficient file reading size for the current</span>
<a href="#l16.25"></a><span id="l16.25"> // operating system.</span>
<a href="#l16.26"></a><span id="l16.26"> #define NEWSRC_FILE_BUFFER_SIZE 1024</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28"> #define kNewsSortOffset 9000</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-#define kSizeUnknown 1</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-</span>
<a href="#l16.32"></a><span id="l16.32"> #define NEWS_SCHEME &quot;news:&quot;</span>
<a href="#l16.33"></a><span id="l16.33"> #define SNEWS_SCHEME &quot;snews:&quot;</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37"> nsMsgNewsFolder::nsMsgNewsFolder(void) :</span>
<a href="#l16.38"></a><span id="l16.38">      mExpungedBytes(0), mGettingNews(false),</span>
<a href="#l16.39"></a><span id="l16.39">      mInitialized(false),</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineat">@@ -753,17 +752,17 @@ NS_IMETHODIMP nsMsgNewsFolder::RefreshSi</span>
<a href="#l16.41"></a><span id="l16.41">   uint64_t oldFolderSize = mFolderSize;</span>
<a href="#l16.42"></a><span id="l16.42">   // We set size to unknown to force it to get recalculated from disk.</span>
<a href="#l16.43"></a><span id="l16.43">   mFolderSize = kSizeUnknown;</span>
<a href="#l16.44"></a><span id="l16.44">   if (NS_SUCCEEDED(GetSizeOnDisk(&amp;mFolderSize)))</span>
<a href="#l16.45"></a><span id="l16.45">     NotifyIntPropertyChanged(kFolderSizeAtom, oldFolderSize, mFolderSize);</span>
<a href="#l16.46"></a><span id="l16.46">   return NS_OK;</span>
<a href="#l16.47"></a><span id="l16.47"> }</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetSizeOnDisk(uint32_t *size)</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetSizeOnDisk(int64_t *size)</span>
<a href="#l16.51"></a><span id="l16.51"> {</span>
<a href="#l16.52"></a><span id="l16.52">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">   // 0 is a valid folder size (meaning empty file with no offline messages),</span>
<a href="#l16.55"></a><span id="l16.55">   // but 1 is not. So use 1 as a special value meaning no file size was fetched</span>
<a href="#l16.56"></a><span id="l16.56">   // from disk yet.</span>
<a href="#l16.57"></a><span id="l16.57">   if (mFolderSize == kSizeUnknown)</span>
<a href="#l16.58"></a><span id="l16.58">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -48,17 +48,17 @@ public:</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">   NS_IMETHOD GetFolderURL(nsACString&amp; url) MOZ_OVERRIDE;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   NS_IMETHOD GetExpungedBytesCount(uint32_t *count);</span>
<a href="#l17.8"></a><span id="l17.8">   NS_IMETHOD GetDeletable(bool *deletable) MOZ_OVERRIDE;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10">   NS_IMETHOD RefreshSizeOnDisk();</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  NS_IMETHOD GetSizeOnDisk(uint32_t *size) MOZ_OVERRIDE;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  NS_IMETHOD GetSizeOnDisk(int64_t *size) MOZ_OVERRIDE;</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15">   NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l17.16"></a><span id="l17.16">                                   nsIMsgDatabase **db) MOZ_OVERRIDE;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">   NS_IMETHOD DeleteMessages(nsIArray *messages,</span>
<a href="#l17.19"></a><span id="l17.19">                             nsIMsgWindow *msgWindow, bool deleteStorage,</span>
<a href="#l17.20"></a><span id="l17.20">                             bool isMove, nsIMsgCopyServiceListener* listener, </span>
<a href="#l17.21"></a><span id="l17.21">                             bool allowUndo) MOZ_OVERRIDE;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

