<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27506:a034a173b805a2b0aebd5dc8a77e96b3e55a5e06</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a034a173b805a2b0aebd5dc8a77e96b3e55a5e06" />
<meta property="og:url" content="/comm-central/rev/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06" />
<meta property="og:description" content="Bug 1507754 - Generate proper sourcestamp.txt for source tar files. r=darktrojan DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a034a173b805a2b0aebd5dc8a77e96b3e55a5e06 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">shortlog</a> |
<a href="/comm-central/log/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">files</a> |
changeset |
<a href="/comm-central/raw-rev/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">raw</a>  | <a href="/comm-central/archive/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">Bug 1507754</a> - Generate proper sourcestamp.txt for source tar files. r=darktrojan DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 28 Aug 2019 14:34:50 -0400</td></tr>

<tr>
 <td>changeset 27506</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">a034a173b805a2b0aebd5dc8a77e96b3e55a5e06</a></td>
</tr>



<tr>
<td>parent 27505</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/10c8b6ffbd1e10c413fd7ecaad40ecaf67f57112">10c8b6ffbd1e10c413fd7ecaad40ecaf67f57112</a>
</td>
</tr>

<tr>
<td>child 27507</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5f3bd0c1707d7ca70a0d78840fc67306d13749ee">5f3bd0c1707d7ca70a0d78840fc67306d13749ee</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">16366</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 04 Sep 2019 22:21:19 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a034a173b805 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&newProject=comm-central&newRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&newProject=comm-central&newRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&newProject=comm-central&newRevision=a034a173b805a2b0aebd5dc8a77e96b3e55a5e06&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">1507754</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1507754">Bug 1507754</a> - Generate proper sourcestamp.txt for source tar files. r=darktrojan DONTBUILD

Build correct sourcestamp.txt in source code tar files.
This builds upon previous commits in this bug using the same urls and revision
hashes that were calculated in the configure process rather than trying to
figure it out again, incorrectly.

This does run as a separate task in Taskcluster, but &quot;mach configure&quot; is one of
the steps that runs before &quot;make source-package&quot; so we can use
&quot;import buildconfig&quot; for this.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">build/source_repos.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">file</a> |
<a href="/comm-central/annotate/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">annotate</a> |
<a href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">diff</a> |
<a href="/comm-central/comparison/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">comparison</a> |
<a href="/comm-central/log/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/build/source_repos.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">mail/installer/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">file</a> |
<a href="/comm-central/annotate/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">annotate</a> |
<a href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">diff</a> |
<a href="/comm-central/comparison/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">comparison</a> |
<a href="/comm-central/log/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mail/installer/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">mozharness/builds/thunderbird_source.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">file</a> |
<a href="/comm-central/annotate/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">annotate</a> |
<a href="/comm-central/diff/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">diff</a> |
<a href="/comm-central/comparison/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">comparison</a> |
<a href="/comm-central/log/a034a173b805a2b0aebd5dc8a77e96b3e55a5e06/mozharness/builds/thunderbird_source.py">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/build/source_repos.py</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/build/source_repos.py</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,16 +4,31 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> from __future__ import print_function, unicode_literals</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> import sys</span>
<a href="#l1.8"></a><span id="l1.8"> import os</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> import buildconfig</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+sourcestamp_tmpl = &quot;&quot;&quot;{buildid}</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+{comm_repo}/rev/{comm_rev}</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+{gecko_repo}/rev/{gecko_rev}</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+&quot;&quot;&quot;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+def gen_sourcestamp(output):</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    data = dict(buildid=os.environ.get('MOZ_BUILD_DATE', 'unknown'),</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        gecko_repo=buildconfig.substs.get('MOZ_GECKO_SOURCE_REPO', None),</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        gecko_rev=buildconfig.substs.get('MOZ_GECKO_SOURCE_CHANGESET', None),</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        comm_repo=buildconfig.substs.get('MOZ_COMM_SOURCE_REPO', None),</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+        comm_rev=buildconfig.substs.get('MOZ_COMM_SOURCE_CHANGESET', None))</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    output.write(sourcestamp_tmpl.format(**data))</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> def source_repo_header(output):</span>
<a href="#l1.29"></a><span id="l1.29">     &quot;&quot;&quot;</span>
<a href="#l1.30"></a><span id="l1.30">     Appends the Gecko source repository information to source-repo.h</span>
<a href="#l1.31"></a><span id="l1.31">     This information should be set in buildconfig.substs by moz.configure</span>
<a href="#l1.32"></a><span id="l1.32">     &quot;&quot;&quot;</span>
<a href="#l1.33"></a><span id="l1.33">     gecko_repo = buildconfig.substs.get('MOZ_GECKO_SOURCE_REPO', None)</span>
<a href="#l1.34"></a><span id="l1.34">     gecko_rev = buildconfig.substs.get('MOZ_GECKO_SOURCE_CHANGESET', None)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/installer/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/installer/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -193,17 +193,15 @@ FINDPATH=bin</span>
<a href="#l2.4"></a><span id="l2.4"> endif</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> package-compare:: $(MOZ_PKG_MANIFEST)</span>
<a href="#l2.7"></a><span id="l2.7"> 	cd $(DIST); find $(PKGCOMP_FIND_OPTS) '$(FINDPATH)' -type f | sort &gt; bin-list.txt</span>
<a href="#l2.8"></a><span id="l2.8"> 	$(call py_action,preprocessor,$(DEFINES) $(ACDEFINES) $(MOZ_PKG_MANIFEST)) | grep '^$(BINPATH)' | sed -e 's/^\///' | sort &gt; $(DIST)/pack-list.txt</span>
<a href="#l2.9"></a><span id="l2.9"> 	-diff -u $(DIST)/pack-list.txt $(DIST)/bin-list.txt</span>
<a href="#l2.10"></a><span id="l2.10"> 	rm -f $(DIST)/pack-list.txt $(DIST)/bin-list.txt</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-# The comm-* source stamp is already there.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-PLATFORM_SOURCE_STAMP = $(firstword $(shell hg -R &quot;$(moztopsrcdir)&quot; parent --template=&quot;{node}\n&quot; 2&gt;/dev/null))</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-PLATFORM_SOURCE_REPO = $(shell hg -R &quot;$(moztopsrcdir)&quot; showconfig paths.default 2&gt;/dev/null | sed -e &quot;s/^ssh:/https:/&quot;)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+# Overwrite the one made by Firefox with our own.</span>
<a href="#l2.16"></a><span id="l2.16"> make-sourcestamp-file::</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-	@echo &quot;$(PLATFORM_SOURCE_REPO)/rev/$(PLATFORM_SOURCE_STAMP)&quot; &gt;&gt; $(MOZ_SOURCESTAMP_FILE)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+	$(PYTHON) $(commtopsrcdir)/build/source_repos.py gen_sourcestamp &gt; $(MOZ_SOURCESTAMP_FILE)</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> ifdef ENABLE_MARIONETTE</span>
<a href="#l2.21"></a><span id="l2.21"> DEFINES += -DENABLE_MARIONETTE=1</span>
<a href="#l2.22"></a><span id="l2.22"> endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mozharness/builds/thunderbird_source.py</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mozharness/builds/thunderbird_source.py</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l3.4"></a><span id="l3.4"> config = {</span>
<a href="#l3.5"></a><span id="l3.5">     'default_actions': ['package-source'],</span>
<a href="#l3.6"></a><span id="l3.6">     'objdir': 'obj-firefox',</span>
<a href="#l3.7"></a><span id="l3.7">     'stage_platform': 'source',  # Not used, but required by the script</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-    'buildbot_json_path': 'buildprops.json',</span>
<a href="#l3.9"></a><span id="l3.9">     'app_ini_path': 'FAKE',  # Not used, but required by the script</span>
<a href="#l3.10"></a><span id="l3.10">     'env': {</span>
<a href="#l3.11"></a><span id="l3.11">         'HG_SHARE_BASE_DIR': '/builds/hg-shared',</span>
<a href="#l3.12"></a><span id="l3.12">         'TINDERBOX_OUTPUT': '1',</span>
<a href="#l3.13"></a><span id="l3.13">         'LC_ALL': 'C',</span>
<a href="#l3.14"></a><span id="l3.14">     },</span>
<a href="#l3.15"></a><span id="l3.15">     'src_mozconfig': 'comm/mail/config/mozconfigs/linux64/source',</span>
<a href="#l3.16"></a><span id="l3.16"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

