<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1598:f71460033b07c277347e0b438a4ef32861f583b7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f71460033b07c277347e0b438a4ef32861f583b7" />
<meta property="og:url" content="/comm-central/rev/f71460033b07c277347e0b438a4ef32861f583b7" />
<meta property="og:description" content="Bug 472314 - Add some documentation to calendar code. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f71460033b07c277347e0b438a4ef32861f583b7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f71460033b07c277347e0b438a4ef32861f583b7">shortlog</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f71460033b07c277347e0b438a4ef32861f583b7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7">files</a> |
changeset |
<a href="/comm-central/raw-rev/f71460033b07c277347e0b438a4ef32861f583b7">raw</a>  | <a href="/comm-central/archive/f71460033b07c277347e0b438a4ef32861f583b7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">Bug 472314</a> - Add some documentation to calendar code. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 10 Jan 2009 23:14:00 +0100</td></tr>

<tr>
 <td>changeset 1598</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f71460033b07c277347e0b438a4ef32861f583b7">f71460033b07c277347e0b438a4ef32861f583b7</a></td>
</tr>



<tr>
<td>parent 1597</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f3eda128cbd33a1bbd04b31bb0eed6f7aa4e8d0b">f3eda128cbd33a1bbd04b31bb0eed6f7aa4e8d0b</a>
</td>
</tr>

<tr>
<td>child 1599</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/092c03b4b309daea028b6481778490a1198eddff">092c03b4b309daea028b6481778490a1198eddff</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f71460033b07c277347e0b438a4ef32861f583b7">1279</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 10 Jan 2009 22:17:25 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f71460033b07 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f71460033b07c277347e0b438a4ef32861f583b7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f71460033b07c277347e0b438a4ef32861f583b7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f71460033b07c277347e0b438a4ef32861f583b7&newProject=comm-central&newRevision=f71460033b07c277347e0b438a4ef32861f583b7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f71460033b07c277347e0b438a4ef32861f583b7&newProject=comm-central&newRevision=f71460033b07c277347e0b438a4ef32861f583b7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f71460033b07c277347e0b438a4ef32861f583b7&newProject=comm-central&newRevision=f71460033b07c277347e0b438a4ef32861f583b7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">472314</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">Bug 472314</a> - Add some documentation to calendar code. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">calendar/base/content/calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">calendar/base/content/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">calendar/base/content/calendar-properties-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-properties-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">calendar/base/content/calendar-publish-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-publish-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">calendar/base/content/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">calendar/base/content/calendar-unifinder-todo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder-todo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/f71460033b07c277347e0b438a4ef32861f583b7/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -43,16 +43,19 @@ function Synthetic(aOpen, aDuration) {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> var agendaListbox = {</span>
<a href="#l1.6"></a><span id="l1.6">     agendaListboxControl: null,</span>
<a href="#l1.7"></a><span id="l1.7">     pendingRefresh: null,</span>
<a href="#l1.8"></a><span id="l1.8">     kDefaultTimezone: null,</span>
<a href="#l1.9"></a><span id="l1.9">     showsToday: false</span>
<a href="#l1.10"></a><span id="l1.10"> };</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * Initialize the agenda listbox, used on window load.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ */</span>
<a href="#l1.15"></a><span id="l1.15"> agendaListbox.init =</span>
<a href="#l1.16"></a><span id="l1.16"> function initAgendaListbox() {</span>
<a href="#l1.17"></a><span id="l1.17">     this.agendaListboxControl = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l1.18"></a><span id="l1.18">     this.agendaListboxControl.removeAttribute(&quot;suppressonselect&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">     var showTodayHeader = (document.getElementById(&quot;today-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l1.20"></a><span id="l1.20">     var showTomorrowHeader = (document.getElementById(&quot;tomorrow-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l1.21"></a><span id="l1.21">     var showSoonHeader = (document.getElementById(&quot;nextweek-header-hidden&quot;).getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l1.22"></a><span id="l1.22">     this.today = new Synthetic(showTodayHeader, 1);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -66,52 +69,73 @@ function initAgendaListbox() {</span>
<a href="#l1.24"></a><span id="l1.24">     var self = this;</span>
<a href="#l1.25"></a><span id="l1.25">     window.addEventListener(&quot;unload&quot;,</span>
<a href="#l1.26"></a><span id="l1.26">                             function unload_agendaListbox() {</span>
<a href="#l1.27"></a><span id="l1.27">                                 self.uninit();</span>
<a href="#l1.28"></a><span id="l1.28">                             },</span>
<a href="#l1.29"></a><span id="l1.29">                             false);</span>
<a href="#l1.30"></a><span id="l1.30"> };</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+/**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+ * Clean up the agenda listbox, used on window unload.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+ */</span>
<a href="#l1.35"></a><span id="l1.35"> agendaListbox.uninit =</span>
<a href="#l1.36"></a><span id="l1.36"> function uninit() {</span>
<a href="#l1.37"></a><span id="l1.37">     if (this.calendar) {</span>
<a href="#l1.38"></a><span id="l1.38">         this.calendar.removeObserver(this.calendarObserver);</span>
<a href="#l1.39"></a><span id="l1.39">     }</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41">     for each (var period in this.periods) {</span>
<a href="#l1.42"></a><span id="l1.42">         if (period.listItem) {</span>
<a href="#l1.43"></a><span id="l1.43">             period.listItem.getCheckbox()</span>
<a href="#l1.44"></a><span id="l1.44">                   .removeEventListener(&quot;CheckboxStateChange&quot;,</span>
<a href="#l1.45"></a><span id="l1.45">                                        this.onCheckboxChange,</span>
<a href="#l1.46"></a><span id="l1.46">                                        true);</span>
<a href="#l1.47"></a><span id="l1.47">         }</span>
<a href="#l1.48"></a><span id="l1.48">     }</span>
<a href="#l1.49"></a><span id="l1.49"> };</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+/**</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+ * Adds a period item to the listbox. This is a section of the today pane like</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+ * &quot;Today&quot;, &quot;Tomorrow&quot;, and is usually a &lt;agenda-checkbox-richlist-item&gt; tag. A</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+ * copy of the template node is made and added to the agenda listbox.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+ *</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+ * @param aPeriod       The period item to add.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+ * @param aItemId       The id of an &lt;agenda-checkbox-richlist-item&gt; to add to,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+ *                        without the &quot;-hidden&quot; suffix.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+ */</span>
<a href="#l1.60"></a><span id="l1.60"> agendaListbox.addPeriodListItem =</span>
<a href="#l1.61"></a><span id="l1.61"> function addPeriodListItem(aPeriod, aItemId) {</span>
<a href="#l1.62"></a><span id="l1.62">     aPeriod.listItem = document.getElementById(aItemId + &quot;-hidden&quot;).cloneNode(true);</span>
<a href="#l1.63"></a><span id="l1.63">     agendaListbox.agendaListboxControl.appendChild(aPeriod.listItem);</span>
<a href="#l1.64"></a><span id="l1.64">     aPeriod.listItem.id = aItemId;</span>
<a href="#l1.65"></a><span id="l1.65">     aPeriod.listItem.getCheckbox().setChecked(aPeriod.open);</span>
<a href="#l1.66"></a><span id="l1.66">     aPeriod.listItem.getCheckbox().addEventListener(&quot;CheckboxStateChange&quot;, this.onCheckboxChange, true);</span>
<a href="#l1.67"></a><span id="l1.67"> }</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+/**</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+ * Remove a period item from the agenda listbox.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+ * @see agendaListbox::addPeriodListItem</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+ */</span>
<a href="#l1.73"></a><span id="l1.73"> agendaListbox.removePeriodListItem =</span>
<a href="#l1.74"></a><span id="l1.74"> function removePeriodListItem(aPeriod) {</span>
<a href="#l1.75"></a><span id="l1.75">     if (aPeriod.listItem) {</span>
<a href="#l1.76"></a><span id="l1.76">         aPeriod.listItem.getCheckbox().removeEventListener(&quot;CheckboxStateChange&quot;, this.onCheckboxChange, true);</span>
<a href="#l1.77"></a><span id="l1.77">         if (aPeriod.listItem) {</span>
<a href="#l1.78"></a><span id="l1.78">             this.agendaListboxControl.removeChild(aPeriod.listItem);</span>
<a href="#l1.79"></a><span id="l1.79">             aPeriod.listItem = null;</span>
<a href="#l1.80"></a><span id="l1.80">         }</span>
<a href="#l1.81"></a><span id="l1.81">     }</span>
<a href="#l1.82"></a><span id="l1.82"> }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+/**</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+ * Handler function called when changing the checkbox state on period items.</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+ *</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+ * @param event     The DOM event that triggered the checkbox state change.</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+ */</span>
<a href="#l1.89"></a><span id="l1.89"> agendaListbox.onCheckboxChange =</span>
<a href="#l1.90"></a><span id="l1.90"> function onCheckboxChange(event) {</span>
<a href="#l1.91"></a><span id="l1.91">     var periodCheckbox = event.target;</span>
<a href="#l1.92"></a><span id="l1.92">     var lopen = (periodCheckbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l1.93"></a><span id="l1.93">     var listItem = getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l1.94"></a><span id="l1.94">     var period = listItem.getItem();</span>
<a href="#l1.95"></a><span id="l1.95">     period.open= lopen;</span>
<a href="#l1.96"></a><span id="l1.96">     // as the agenda-checkboxes are only transient we have to set the &quot;checked&quot;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -132,57 +156,74 @@ function onCheckboxChange(event) {</span>
<a href="#l1.98"></a><span id="l1.98">                     listItem = nextItemSibling;</span>
<a href="#l1.99"></a><span id="l1.99">                 }</span>
<a href="#l1.100"></a><span id="l1.100">             }</span>
<a href="#l1.101"></a><span id="l1.101">         } while (!leaveloop);</span>
<a href="#l1.102"></a><span id="l1.102">     }</span>
<a href="#l1.103"></a><span id="l1.103">     calendarController.onSelectionChanged({detail: []});    </span>
<a href="#l1.104"></a><span id="l1.104"> };</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+/**</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+ * Handler function called when an agenda listbox item is selected</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+ *</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+ * @param aListItem     The agenda-base-richlist-item that was selected.</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+ */</span>
<a href="#l1.111"></a><span id="l1.111"> agendaListbox.onSelect =</span>
<a href="#l1.112"></a><span id="l1.112"> function onSelect(aListItem) {</span>
<a href="#l1.113"></a><span id="l1.113">     var listbox = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l1.114"></a><span id="l1.114">     listbox.focus();</span>
<a href="#l1.115"></a><span id="l1.115">     listbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.116"></a><span id="l1.116">     var item = aListItem || listbox.selectedItem;</span>
<a href="#l1.117"></a><span id="l1.117">     if (aListItem) {</span>
<a href="#l1.118"></a><span id="l1.118">         listbox.selectedItem = item;</span>
<a href="#l1.119"></a><span id="l1.119">     }</span>
<a href="#l1.120"></a><span id="l1.120">     if (item) {</span>
<a href="#l1.121"></a><span id="l1.121">         item.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.122"></a><span id="l1.122">     }</span>
<a href="#l1.123"></a><span id="l1.123">     calendarController.onSelectionChanged({detail: agendaListbox.getSelectedItems()});</span>
<a href="#l1.124"></a><span id="l1.124"> }</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+/**</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+ * Handler function called when the agenda listbox becomes focused</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+ */</span>
<a href="#l1.129"></a><span id="l1.129"> agendaListbox.onFocus =</span>
<a href="#l1.130"></a><span id="l1.130"> function onFocus() {</span>
<a href="#l1.131"></a><span id="l1.131">     var listbox = document.getElementById(&quot;agenda-listbox&quot;);</span>
<a href="#l1.132"></a><span id="l1.132">     listbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.133"></a><span id="l1.133">     this.enableListItems();</span>
<a href="#l1.134"></a><span id="l1.134">     calendarController.onSelectionChanged({detail: agendaListbox.getSelectedItems()});</span>
<a href="#l1.135"></a><span id="l1.135"> }</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+/**</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+ * Handler function called when the agenda listbox loses focus.</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+ */</span>
<a href="#l1.140"></a><span id="l1.140"> agendaListbox.onBlur =</span>
<a href="#l1.141"></a><span id="l1.141"> function onBlur() {</span>
<a href="#l1.142"></a><span id="l1.142">     var item  = document.getElementById(&quot;agenda-listbox&quot;).selectedItem;</span>
<a href="#l1.143"></a><span id="l1.143">     if (item) {</span>
<a href="#l1.144"></a><span id="l1.144">         item.setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l1.145"></a><span id="l1.145">     }</span>
<a href="#l1.146"></a><span id="l1.146">     calendarController.onSelectionChanged({detail: []});</span>
<a href="#l1.147"></a><span id="l1.147"> }</span>
<a href="#l1.148"></a><span id="l1.148"> </span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+/**</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+ * Enables all child nodes of the agenda listbox</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+ */</span>
<a href="#l1.152"></a><span id="l1.152"> agendaListbox.enableListItems =</span>
<a href="#l1.153"></a><span id="l1.153"> function enableListItems() {</span>
<a href="#l1.154"></a><span id="l1.154">     var childNodes = document.getElementById(&quot;agenda-listbox&quot;).childNodes;</span>
<a href="#l1.155"></a><span id="l1.155">     for (var i = 0;i &lt; childNodes.length; i++) {</span>
<a href="#l1.156"></a><span id="l1.156">         var listItem = childNodes[i];</span>
<a href="#l1.157"></a><span id="l1.157">         listItem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.158"></a><span id="l1.158">     }</span>
<a href="#l1.159"></a><span id="l1.159"> }</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+/**</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+ * Handler function called when a key was pressed on the agenda listbox</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+ */</span>
<a href="#l1.164"></a><span id="l1.164"> agendaListbox.onKeyPress =</span>
<a href="#l1.165"></a><span id="l1.165"> function onKeyPress(aEvent) {</span>
<a href="#l1.166"></a><span id="l1.166">     var listItem = aEvent.target;</span>
<a href="#l1.167"></a><span id="l1.167">     if (listItem.localName == &quot;richlistbox&quot;) {</span>
<a href="#l1.168"></a><span id="l1.168">         listItem = listItem.selectedItem;</span>
<a href="#l1.169"></a><span id="l1.169">     }</span>
<a href="#l1.170"></a><span id="l1.170">     switch(aEvent.keyCode) {</span>
<a href="#l1.171"></a><span id="l1.171">         case aEvent.DOM_VK_RETURN:</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineat">@@ -201,61 +242,85 @@ function onKeyPress(aEvent) {</span>
<a href="#l1.173"></a><span id="l1.173">         case aEvent.DOM_VK_RIGHT:</span>
<a href="#l1.174"></a><span id="l1.174">             if (!this.isEventListItem(listItem)) {</span>
<a href="#l1.175"></a><span id="l1.175">                 listItem.getCheckbox().setChecked(true);</span>
<a href="#l1.176"></a><span id="l1.176">             }</span>
<a href="#l1.177"></a><span id="l1.177">             break;</span>
<a href="#l1.178"></a><span id="l1.178">     }</span>
<a href="#l1.179"></a><span id="l1.179"> }</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+/**</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+ * Calls the event dialog to edit the currently selected item</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+ */</span>
<a href="#l1.184"></a><span id="l1.184"> agendaListbox.editSelectedItem =</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-function editSelectedItem(aEvent) {</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+function editSelectedItem() {</span>
<a href="#l1.187"></a><span id="l1.187">     var listItem  = document.getElementById(&quot;agenda-listbox&quot;).selectedItem;</span>
<a href="#l1.188"></a><span id="l1.188">     if (listItem) {</span>
<a href="#l1.189"></a><span id="l1.189">         modifyEventWithDialog(listItem.occurrence, null, true);</span>
<a href="#l1.190"></a><span id="l1.190">     }</span>
<a href="#l1.191"></a><span id="l1.191"> }</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+/**</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+ * Finds the appropriate period for the given item, i.e finds &quot;Tomorrow&quot; if the</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+ * item occurrs tomorrow.</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+ *</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+ * @param aItem     The item to find the period for.</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+ */</span>
<a href="#l1.199"></a><span id="l1.199"> agendaListbox.findPeriodsForItem =</span>
<a href="#l1.200"></a><span id="l1.200"> function findPeriodsForItem(aItem) {</span>
<a href="#l1.201"></a><span id="l1.201">     var retPeriods = [];</span>
<a href="#l1.202"></a><span id="l1.202">     for (var i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l1.203"></a><span id="l1.203">         if (this.periods[i].open) {</span>
<a href="#l1.204"></a><span id="l1.204">             if (checkIfInRange(aItem, this.periods[i].start, this.periods[i].end)) {</span>
<a href="#l1.205"></a><span id="l1.205">                 retPeriods.push(this.periods[i]);</span>
<a href="#l1.206"></a><span id="l1.206">             }</span>
<a href="#l1.207"></a><span id="l1.207">         }</span>
<a href="#l1.208"></a><span id="l1.208">     }</span>
<a href="#l1.209"></a><span id="l1.209">     return retPeriods;</span>
<a href="#l1.210"></a><span id="l1.210"> };</span>
<a href="#l1.211"></a><span id="l1.211"> </span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+/**</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+ * Gets the start of the earliest period shown in the agenda listbox</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+ */</span>
<a href="#l1.215"></a><span id="l1.215"> agendaListbox.getStart =</span>
<a href="#l1.216"></a><span id="l1.216"> function getStart(){</span>
<a href="#l1.217"></a><span id="l1.217">     var retStart = null;</span>
<a href="#l1.218"></a><span id="l1.218">     for (var i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l1.219"></a><span id="l1.219">         if (this.periods[i].open) {</span>
<a href="#l1.220"></a><span id="l1.220">             retStart = this.periods[i].start;</span>
<a href="#l1.221"></a><span id="l1.221">             break;</span>
<a href="#l1.222"></a><span id="l1.222">         }</span>
<a href="#l1.223"></a><span id="l1.223">     }</span>
<a href="#l1.224"></a><span id="l1.224">     return retStart;</span>
<a href="#l1.225"></a><span id="l1.225"> }</span>
<a href="#l1.226"></a><span id="l1.226"> </span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+/**</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+ * Gets the end of the latest period shown in the agenda listbox</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+ */</span>
<a href="#l1.230"></a><span id="l1.230"> agendaListbox.getEnd =</span>
<a href="#l1.231"></a><span id="l1.231"> function getEnd(){</span>
<a href="#l1.232"></a><span id="l1.232">     var retEnd = null;</span>
<a href="#l1.233"></a><span id="l1.233">     for (var i = this.periods.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.234"></a><span id="l1.234">         if (this.periods[i].open) {</span>
<a href="#l1.235"></a><span id="l1.235">             retEnd = this.periods[i].end;</span>
<a href="#l1.236"></a><span id="l1.236">             break;</span>
<a href="#l1.237"></a><span id="l1.237">         }</span>
<a href="#l1.238"></a><span id="l1.238">     }</span>
<a href="#l1.239"></a><span id="l1.239">     return retEnd;</span>
<a href="#l1.240"></a><span id="l1.240"> }</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+/**</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+ * Adds an item to an agenda period before another existing item.</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+ *</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+ * @param aNewItem      The calIItemBase to add.</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+ * @param aAgendaItem   The existing item to insert before.</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+ * @param aPeriod       The period to add the item to.</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+ * @param visible       If true, the item should be visible.</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+ * @return              The newly created XUL element.</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+ */</span>
<a href="#l1.251"></a><span id="l1.251"> agendaListbox.addItemBefore =</span>
<a href="#l1.252"></a><span id="l1.252"> function addItemBefore(aNewItem, aAgendaItem, aPeriod, visible) {</span>
<a href="#l1.253"></a><span id="l1.253">     var newelement = null;</span>
<a href="#l1.254"></a><span id="l1.254">     if (aNewItem.startDate.isDate) {</span>
<a href="#l1.255"></a><span id="l1.255">         newelement = createXULElement(&quot;agenda-allday-richlist-item&quot;);</span>
<a href="#l1.256"></a><span id="l1.256">     } else {</span>
<a href="#l1.257"></a><span id="l1.257">         newelement = createXULElement(&quot;agenda-richlist-item&quot;)</span>
<a href="#l1.258"></a><span id="l1.258">     }</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineat">@@ -267,16 +332,23 @@ function addItemBefore(aNewItem, aAgenda</span>
<a href="#l1.260"></a><span id="l1.260">     } else {</span>
<a href="#l1.261"></a><span id="l1.261">         this.agendaListboxControl.insertBefore(newelement, aAgendaItem);</span>
<a href="#l1.262"></a><span id="l1.262">     }</span>
<a href="#l1.263"></a><span id="l1.263">     newelement.setOccurrence(aNewItem, (aPeriod.duration &gt; 1));</span>
<a href="#l1.264"></a><span id="l1.264">     newelement.removeAttribute(&quot;selected&quot;);</span>
<a href="#l1.265"></a><span id="l1.265">     return newelement;</span>
<a href="#l1.266"></a><span id="l1.266"> }</span>
<a href="#l1.267"></a><span id="l1.267"> </span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+/**</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+ * Adds an item to the agenda listbox. This function finds the correct period</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+ * for the item and inserts it correctly so the period stays sorted.</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+ *</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+ * @param aItem         The calIItemBase to add.</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+ * @return              The newly created XUL element.</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+ */</span>
<a href="#l1.275"></a><span id="l1.275"> agendaListbox.addItem =</span>
<a href="#l1.276"></a><span id="l1.276"> function addItem(aItem) {</span>
<a href="#l1.277"></a><span id="l1.277">     if (!isEvent(aItem)) {</span>
<a href="#l1.278"></a><span id="l1.278">         return null;</span>
<a href="#l1.279"></a><span id="l1.279">     }</span>
<a href="#l1.280"></a><span id="l1.280">     var periods = this.findPeriodsForItem(aItem);</span>
<a href="#l1.281"></a><span id="l1.281">     if (periods.length == 0) {</span>
<a href="#l1.282"></a><span id="l1.282">         return null;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineat">@@ -315,16 +387,23 @@ function addItem(aItem) {</span>
<a href="#l1.284"></a><span id="l1.284">                     }</span>
<a href="#l1.285"></a><span id="l1.285">                 }</span>
<a href="#l1.286"></a><span id="l1.286">             } while (complistItem)</span>
<a href="#l1.287"></a><span id="l1.287">         }</span>
<a href="#l1.288"></a><span id="l1.288">     }</span>
<a href="#l1.289"></a><span id="l1.289">     return newlistItem;</span>
<a href="#l1.290"></a><span id="l1.290"> };</span>
<a href="#l1.291"></a><span id="l1.291"> </span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+/**</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+ * Checks if the given item happens before the comparation item.</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+ *</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+ * @param aItem         The item to compare.</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+ * @param aCompItem     The item to compare with.</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+ * @return              True, if the aItem happens before aCompItem.</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+ */</span>
<a href="#l1.299"></a><span id="l1.299"> agendaListbox.isBefore =</span>
<a href="#l1.300"></a><span id="l1.300"> function isBefore(aItem, aCompItem) {</span>
<a href="#l1.301"></a><span id="l1.301">     if (aCompItem.startDate.day == aItem.startDate.day) {</span>
<a href="#l1.302"></a><span id="l1.302">         if (aItem.startDate.isDate) {</span>
<a href="#l1.303"></a><span id="l1.303">             return true;</span>
<a href="#l1.304"></a><span id="l1.304">         } else if (aCompItem.startDate.isDate) {</span>
<a href="#l1.305"></a><span id="l1.305">             return false;</span>
<a href="#l1.306"></a><span id="l1.306">         }</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineat">@@ -332,16 +411,23 @@ function isBefore(aItem, aCompItem) {</span>
<a href="#l1.308"></a><span id="l1.308">     var comp = aItem.startDate.compare(aCompItem.startDate);</span>
<a href="#l1.309"></a><span id="l1.309">     if (comp == 0) {</span>
<a href="#l1.310"></a><span id="l1.310">         comp = aItem.endDate.compare(aCompItem.endDate);</span>
<a href="#l1.311"></a><span id="l1.311">     }</span>
<a href="#l1.312"></a><span id="l1.312">     return (comp &lt;= 0);</span>
<a href="#l1.313"></a><span id="l1.313"> }</span>
<a href="#l1.314"></a><span id="l1.314"> </span>
<a href="#l1.315"></a><span id="l1.315"> </span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+/**</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+ * Gets the listitems for a given item, possibly in a given period.</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+ *</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+ * @param aItem         The item to get the list items for.</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+ * @param aPeriod       (optional) the period to search in.</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+ * @return              An array of list items for the given item.</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+ */</span>
<a href="#l1.323"></a><span id="l1.323"> agendaListbox.getListItems =</span>
<a href="#l1.324"></a><span id="l1.324"> function getListItems(aItem, aPeriod) {</span>
<a href="#l1.325"></a><span id="l1.325">     var retlistItems = new Array();</span>
<a href="#l1.326"></a><span id="l1.326">     var periods = [aPeriod];</span>
<a href="#l1.327"></a><span id="l1.327">     if (!aPeriod) {</span>
<a href="#l1.328"></a><span id="l1.328">         var periods = this.findPeriodsForItem(aItem);</span>
<a href="#l1.329"></a><span id="l1.329">     }</span>
<a href="#l1.330"></a><span id="l1.330">     if (periods.length &gt; 0) {</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineat">@@ -358,16 +444,24 @@ function getListItems(aItem, aPeriod) {</span>
<a href="#l1.332"></a><span id="l1.332">                     }</span>
<a href="#l1.333"></a><span id="l1.333">                 }</span>
<a href="#l1.334"></a><span id="l1.334">             } while (!leaveloop)</span>
<a href="#l1.335"></a><span id="l1.335">         }</span>
<a href="#l1.336"></a><span id="l1.336">     }</span>
<a href="#l1.337"></a><span id="l1.337">     return retlistItems;</span>
<a href="#l1.338"></a><span id="l1.338"> }</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+/**</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+ * Removes the given item from the agenda listbox</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+ *</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+ * @param aItem             The item to remove.</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+ * @param aMoveSelection    If true, the selection will be moved to the next</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+ *                            sibling that is not an period item.</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+ * @return                  Returns true if the removed item was selected.</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+ */</span>
<a href="#l1.348"></a><span id="l1.348"> agendaListbox.deleteItem =</span>
<a href="#l1.349"></a><span id="l1.349"> function deleteItem(aItem, aMoveSelection) {</span>
<a href="#l1.350"></a><span id="l1.350">     var isSelected = false;</span>
<a href="#l1.351"></a><span id="l1.351">     var listItems = this.getListItems(aItem);</span>
<a href="#l1.352"></a><span id="l1.352">     if (listItems.length &gt; 0) {</span>
<a href="#l1.353"></a><span id="l1.353">         for (var i = listItems.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.354"></a><span id="l1.354">             var listItem = listItems[i];</span>
<a href="#l1.355"></a><span id="l1.355">             var isSelected2 = listItem.selected;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineat">@@ -378,71 +472,109 @@ function deleteItem(aItem, aMoveSelectio</span>
<a href="#l1.357"></a><span id="l1.357">                 }</span>
<a href="#l1.358"></a><span id="l1.358">             }</span>
<a href="#l1.359"></a><span id="l1.359">             this.agendaListboxControl.removeChild(listItem);</span>
<a href="#l1.360"></a><span id="l1.360">         }</span>
<a href="#l1.361"></a><span id="l1.361">     }</span>
<a href="#l1.362"></a><span id="l1.362">     return isSelected;</span>
<a href="#l1.363"></a><span id="l1.363"> }</span>
<a href="#l1.364"></a><span id="l1.364"> </span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+/**</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+ * Compares two items to see if they have the same id and their start date</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+ * matches</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+ *</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+ * @param aItem         The item to compare.</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+ * @param aCompItem     The item to compare with.</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+ * @return              True, if the items match with the above noted criteria.</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+ */</span>
<a href="#l1.373"></a><span id="l1.373"> agendaListbox.isSameEvent =</span>
<a href="#l1.374"></a><span id="l1.374"> function isSameEvent(aItem, aCompItem) {</span>
<a href="#l1.375"></a><span id="l1.375">     return ((aItem.id == aCompItem.id) &amp;&amp;</span>
<a href="#l1.376"></a><span id="l1.376">             (aItem[calGetStartDateProp(aItem)].compare(aCompItem[calGetStartDateProp(aCompItem)]) == 0));</span>
<a href="#l1.377"></a><span id="l1.377"> }</span>
<a href="#l1.378"></a><span id="l1.378"> </span>
<a href="#l1.379"></a><span id="l1.379" class="difflineplus">+/**</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+ * Checks if the currently selected node in the listbox is an Event item (not a</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+ * period item).</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+ *</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+ * @return              True, if the node is not a period item.</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+ */</span>
<a href="#l1.385"></a><span id="l1.385"> agendaListbox.isEventSelected =</span>
<a href="#l1.386"></a><span id="l1.386"> function isEventSelected() {</span>
<a href="#l1.387"></a><span id="l1.387">     var listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l1.388"></a><span id="l1.388">     if (listItem) {</span>
<a href="#l1.389"></a><span id="l1.389">         return (this.isEventListItem(listItem));</span>
<a href="#l1.390"></a><span id="l1.390">     }</span>
<a href="#l1.391"></a><span id="l1.391">     return false;</span>
<a href="#l1.392"></a><span id="l1.392"> }</span>
<a href="#l1.393"></a><span id="l1.393"> </span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+/**</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+ * Delete the selected item from its calendar (if it is an event item)</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+ *</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+ * @param aDoNotConfirm     If true, the user will not be prompted.</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+ */</span>
<a href="#l1.399"></a><span id="l1.399"> agendaListbox.deleteSelectedItem =</span>
<a href="#l1.400"></a><span id="l1.400"> function deleteSelectedItem(aDoNotConfirm) {</span>
<a href="#l1.401"></a><span id="l1.401">     var listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l1.402"></a><span id="l1.402">     if (this.isEventListItem(listItem)) {</span>
<a href="#l1.403"></a><span id="l1.403">         var selectedItems = [listItem.occurrence];</span>
<a href="#l1.404"></a><span id="l1.404">         calendarViewController.deleteOccurrences(selectedItems.length,</span>
<a href="#l1.405"></a><span id="l1.405">                                                  selectedItems,</span>
<a href="#l1.406"></a><span id="l1.406">                                                  false,</span>
<a href="#l1.407"></a><span id="l1.407">                                                  aDoNotConfirm);</span>
<a href="#l1.408"></a><span id="l1.408">     }</span>
<a href="#l1.409"></a><span id="l1.409"> }</span>
<a href="#l1.410"></a><span id="l1.410"> </span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+/**</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+ * If a Period item is targeted by the passed DOM event, opens the event dialog</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+ * with the period's start date prefilled.</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+ *</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+ * @param aEvent            The DOM event that targets the period.</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+ */</span>
<a href="#l1.417"></a><span id="l1.417"> agendaListbox.createNewEvent =</span>
<a href="#l1.418"></a><span id="l1.418"> function createNewEvent(aEvent) {</span>
<a href="#l1.419"></a><span id="l1.419">     if (!this.isEventListItem(aEvent.target)){</span>
<a href="#l1.420"></a><span id="l1.420">         // Create new event for the date currently displayed in the agenda. Setting</span>
<a href="#l1.421"></a><span id="l1.421">         // isDate = true automatically makes the start time be the next full hour.</span>
<a href="#l1.422"></a><span id="l1.422">         var eventStart = agendaListbox.today.start.clone();</span>
<a href="#l1.423"></a><span id="l1.423">         eventStart.isDate = true;</span>
<a href="#l1.424"></a><span id="l1.424">         createEventWithDialog(getSelectedCalendar(), eventStart);</span>
<a href="#l1.425"></a><span id="l1.425">     }</span>
<a href="#l1.426"></a><span id="l1.426"> }</span>
<a href="#l1.427"></a><span id="l1.427"> </span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+/**</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+ * Rebuilds the agenda popup menu from the agenda-menu-box, disabling items if a</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+ * period was selected.</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+ *</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+ * XXX Why is this needed?</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineplus">+ *</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+ */</span>
<a href="#l1.435"></a><span id="l1.435"> agendaListbox.buildAgendaPopupMenu =</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-function enableAgendaPopupMenu(aPopupMenu){</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+function enableAgendaPopupMenu() {</span>
<a href="#l1.438"></a><span id="l1.438">     var listItem = this.agendaListboxControl.selectedItem;</span>
<a href="#l1.439"></a><span id="l1.439">     var enabled = this.isEventListItem(listItem);</span>
<a href="#l1.440"></a><span id="l1.440">     var popup = document.getElementById(&quot;agenda-menu&quot;);</span>
<a href="#l1.441"></a><span id="l1.441">     while (popup.hasChildNodes()) {</span>
<a href="#l1.442"></a><span id="l1.442">         popup.removeChild(popup.firstChild);</span>
<a href="#l1.443"></a><span id="l1.443">     }</span>
<a href="#l1.444"></a><span id="l1.444">     var menuitems = document.getElementById(&quot;agenda-menu-box&quot;).childNodes;</span>
<a href="#l1.445"></a><span id="l1.445">     for (var i= 0; i &lt; menuitems.length; i++) {</span>
<a href="#l1.446"></a><span id="l1.446">         setBooleanAttribute(menuitems[i], &quot;disabled&quot;, !enabled);</span>
<a href="#l1.447"></a><span id="l1.447">         popup.appendChild(menuitems[i].cloneNode(true));</span>
<a href="#l1.448"></a><span id="l1.448">     }</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-    return true;</span>
<a href="#l1.450"></a><span id="l1.450"> }</span>
<a href="#l1.451"></a><span id="l1.451"> </span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+/**</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+ * Refreshes the agenda listbox. If aStart or aEnd is not passed, the agenda</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+ * listbox's limiting dates will be used.</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+ *</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+ * @param aStart        (optional) The start date for the item query.</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+ * @param aEnd          (optional) The end date for the item query.</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+ */</span>
<a href="#l1.460"></a><span id="l1.460"> agendaListbox.refreshCalendarQuery =</span>
<a href="#l1.461"></a><span id="l1.461"> function refreshCalendarQuery(aStart, aEnd) {</span>
<a href="#l1.462"></a><span id="l1.462">     if (this.mBatchCount &gt; 0) {</span>
<a href="#l1.463"></a><span id="l1.463">         return;</span>
<a href="#l1.464"></a><span id="l1.464">     }</span>
<a href="#l1.465"></a><span id="l1.465">     var pendingRefresh = this.pendingRefresh;</span>
<a href="#l1.466"></a><span id="l1.466">     if (pendingRefresh) {</span>
<a href="#l1.467"></a><span id="l1.467">         if (calInstanceOf(pendingRefresh, Components.interfaces.calIOperation)) {</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineat">@@ -468,32 +600,44 @@ function refreshCalendarQuery(aStart, aE</span>
<a href="#l1.469"></a><span id="l1.469">         pendingRefresh = this.calendar.getItems(filter, 0, aStart, aEnd,</span>
<a href="#l1.470"></a><span id="l1.470">                                                 this.calendarOpListener);</span>
<a href="#l1.471"></a><span id="l1.471">         if (pendingRefresh &amp;&amp; pendingRefresh.isPending) { // support for calIOperation</span>
<a href="#l1.472"></a><span id="l1.472">             this.pendingRefresh = pendingRefresh;</span>
<a href="#l1.473"></a><span id="l1.473">         }</span>
<a href="#l1.474"></a><span id="l1.474">     }</span>
<a href="#l1.475"></a><span id="l1.475"> };</span>
<a href="#l1.476"></a><span id="l1.476"> </span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+/**</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+ * Sets up the calendar for the agenda listbox.</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+ */</span>
<a href="#l1.480"></a><span id="l1.480"> agendaListbox.setupCalendar =</span>
<a href="#l1.481"></a><span id="l1.481"> function setupCalendar() {</span>
<a href="#l1.482"></a><span id="l1.482">     this.init();</span>
<a href="#l1.483"></a><span id="l1.483">     if (this.calendar == null) {</span>
<a href="#l1.484"></a><span id="l1.484">         this.calendar = getCompositeCalendar();</span>
<a href="#l1.485"></a><span id="l1.485">     }</span>
<a href="#l1.486"></a><span id="l1.486">     if (this.calendar) {</span>
<a href="#l1.487"></a><span id="l1.487">         // XXX This always gets called, does that happen on purpose?</span>
<a href="#l1.488"></a><span id="l1.488">         this.calendar.removeObserver(this.calendarObserver);</span>
<a href="#l1.489"></a><span id="l1.489">     }</span>
<a href="#l1.490"></a><span id="l1.490">     this.calendar.addObserver(this.calendarObserver);</span>
<a href="#l1.491"></a><span id="l1.491">     if (this.mListener){</span>
<a href="#l1.492"></a><span id="l1.492">         this.mListener.updatePeriod();</span>
<a href="#l1.493"></a><span id="l1.493">     }</span>
<a href="#l1.494"></a><span id="l1.494"> };</span>
<a href="#l1.495"></a><span id="l1.495"> </span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+/**</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+ * Refreshes the period dates, especially when a period is showing &quot;today&quot;.</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+ * Usually called at midnight to update the agenda pane. Also retrieves the</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+ * items from the calendar.</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+ *</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+ * @see #refreshCalendarQuery</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+ * @param newDate       The first date to show if the agenda pane doesn't show</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+ *                        today.</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+ */</span>
<a href="#l1.505"></a><span id="l1.505"> agendaListbox.refreshPeriodDates =</span>
<a href="#l1.506"></a><span id="l1.506"> function refreshPeriodDates(newDate) {</span>
<a href="#l1.507"></a><span id="l1.507">      this.kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l1.508"></a><span id="l1.508">     // Today: now until midnight of tonight</span>
<a href="#l1.509"></a><span id="l1.509">     var oldshowstoday = this.showstoday;</span>
<a href="#l1.510"></a><span id="l1.510">     this.showstoday = this.showsToday(newDate);</span>
<a href="#l1.511"></a><span id="l1.511">     if ((this.showstoday) &amp;&amp; (!oldshowstoday))  {</span>
<a href="#l1.512"></a><span id="l1.512">         this.addPeriodListItem(this.tomorrow, &quot;tomorrow-header&quot;);</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineat">@@ -513,69 +657,101 @@ function refreshPeriodDates(newDate) {</span>
<a href="#l1.514"></a><span id="l1.514">         }</span>
<a href="#l1.515"></a><span id="l1.515">         newDate.day += curPeriod.duration;</span>
<a href="#l1.516"></a><span id="l1.516">         curPeriod.end = newDate.clone();</span>
<a href="#l1.517"></a><span id="l1.517">         curPeriod.listItem.setItem(curPeriod, this.showstoday);</span>
<a href="#l1.518"></a><span id="l1.518">     }</span>
<a href="#l1.519"></a><span id="l1.519">     this.refreshCalendarQuery();</span>
<a href="#l1.520"></a><span id="l1.520"> };</span>
<a href="#l1.521"></a><span id="l1.521"> </span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+/**</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+ * Adds a listener to this agenda listbox.</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+ *</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+ * @param aListener     The listener to add.</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+ */</span>
<a href="#l1.527"></a><span id="l1.527"> agendaListbox.addListener =</span>
<a href="#l1.528"></a><span id="l1.528"> function addListener(aListener) {</span>
<a href="#l1.529"></a><span id="l1.529">     this.mListener = aListener;</span>
<a href="#l1.530"></a><span id="l1.530"> }</span>
<a href="#l1.531"></a><span id="l1.531"> </span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+/**</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+ * Checks if the agenda listbox is showing &quot;today&quot;. Without arguments, this</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+ * function assumes the today attribute of the agenda listbox.</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+ *</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+ * @param aStartDate    (optional) The day to check if its &quot;today&quot;.</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+ * @return              Returns true if today is shown.</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+ */</span>
<a href="#l1.539"></a><span id="l1.539"> agendaListbox.showsToday =</span>
<a href="#l1.540"></a><span id="l1.540"> function showsToday(aStartDate) {</span>
<a href="#l1.541"></a><span id="l1.541">     var lstart = aStartDate;</span>
<a href="#l1.542"></a><span id="l1.542">     if (!lstart) {</span>
<a href="#l1.543"></a><span id="l1.543">         lstart = this.today.start;</span>
<a href="#l1.544"></a><span id="l1.544">     }</span>
<a href="#l1.545"></a><span id="l1.545">     var lshowsToday = (sameDay(now(), lstart));</span>
<a href="#l1.546"></a><span id="l1.546">     if (lshowsToday) {</span>
<a href="#l1.547"></a><span id="l1.547">         this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l1.548"></a><span id="l1.548">     } else {</span>
<a href="#l1.549"></a><span id="l1.549">         this.periods = [this.today];</span>
<a href="#l1.550"></a><span id="l1.550">     }</span>
<a href="#l1.551"></a><span id="l1.551">     return lshowsToday;</span>
<a href="#l1.552"></a><span id="l1.552"> };</span>
<a href="#l1.553"></a><span id="l1.553"> </span>
<a href="#l1.554"></a><span id="l1.554" class="difflineplus">+/**</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+ * Moves the selection. Moves down unless the next item is a period item, in</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+ * which case the selection moves up.</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+ */</span>
<a href="#l1.558"></a><span id="l1.558"> agendaListbox.moveSelection =</span>
<a href="#l1.559"></a><span id="l1.559"> function moveSelection() {</span>
<a href="#l1.560"></a><span id="l1.560">     var selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l1.561"></a><span id="l1.561">     if ( !this.isEventListItem(this.agendaListboxControl.selectedItem.nextSibling)) {</span>
<a href="#l1.562"></a><span id="l1.562">         this.agendaListboxControl.goUp();</span>
<a href="#l1.563"></a><span id="l1.563">     } else {</span>
<a href="#l1.564"></a><span id="l1.564">         this.agendaListboxControl.goDown();</span>
<a href="#l1.565"></a><span id="l1.565">     }</span>
<a href="#l1.566"></a><span id="l1.566"> }</span>
<a href="#l1.567"></a><span id="l1.567"> </span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+/**</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+ * Gets an array of selected items. If a period node is selected, it is not</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+ * included.</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+ *</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+ * @return      An array with all selected items.</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+ */</span>
<a href="#l1.574"></a><span id="l1.574"> agendaListbox.getSelectedItems =</span>
<a href="#l1.575"></a><span id="l1.575"> function getSelectedItems() {</span>
<a href="#l1.576"></a><span id="l1.576">     var selindex = this.agendaListboxControl.selectedIndex;</span>
<a href="#l1.577"></a><span id="l1.577">     var items = [];</span>
<a href="#l1.578"></a><span id="l1.578">     if (this.isEventListItem(this.agendaListboxControl.selectedItem)) {</span>
<a href="#l1.579"></a><span id="l1.579">         // If at some point we support selecting multiple items, this array can</span>
<a href="#l1.580"></a><span id="l1.580">         // be expanded.</span>
<a href="#l1.581"></a><span id="l1.581">         items = [this.agendaListboxControl.selectedItem.occurrence];</span>
<a href="#l1.582"></a><span id="l1.582">     }</span>
<a href="#l1.583"></a><span id="l1.583">     return items;</span>
<a href="#l1.584"></a><span id="l1.584"> }</span>
<a href="#l1.585"></a><span id="l1.585"> </span>
<a href="#l1.586"></a><span id="l1.586" class="difflineplus">+/**</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+ * Checks if the passed node in the listbox is an Event item (not a</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+ * period item).</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+ *</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+ * @param aListItem     The node to check for.</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+ * @return              True, if the node is not a period item.</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+ */</span>
<a href="#l1.593"></a><span id="l1.593"> agendaListbox.isEventListItem =</span>
<a href="#l1.594"></a><span id="l1.594"> function isEventListItem(aListItem) {</span>
<a href="#l1.595"></a><span id="l1.595">     var isEventListItem = (aListItem != null);</span>
<a href="#l1.596"></a><span id="l1.596">     if (isEventListItem) {</span>
<a href="#l1.597"></a><span id="l1.597">         var localName = aListItem.localName;</span>
<a href="#l1.598"></a><span id="l1.598">         isEventListItem = ((localName ==  &quot;agenda-richlist-item&quot;) ||</span>
<a href="#l1.599"></a><span id="l1.599">                           (localName ==  &quot;agenda-allday-richlist-item&quot;));</span>
<a href="#l1.600"></a><span id="l1.600">     }</span>
<a href="#l1.601"></a><span id="l1.601">     return isEventListItem;</span>
<a href="#l1.602"></a><span id="l1.602"> }</span>
<a href="#l1.603"></a><span id="l1.603"> </span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+/**</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+ * Removes all Event items, keeping the period items intact.</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+ */</span>
<a href="#l1.607"></a><span id="l1.607"> agendaListbox.removeListItems =</span>
<a href="#l1.608"></a><span id="l1.608"> function removeListItems() {</span>
<a href="#l1.609"></a><span id="l1.609">     var listItem = this.agendaListboxControl.lastChild;</span>
<a href="#l1.610"></a><span id="l1.610">     if (listItem) {</span>
<a href="#l1.611"></a><span id="l1.611">         var leaveloop = false;</span>
<a href="#l1.612"></a><span id="l1.612">         do {</span>
<a href="#l1.613"></a><span id="l1.613">             var newlistItem = null;</span>
<a href="#l1.614"></a><span id="l1.614">             if (listItem) {</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineat">@@ -590,53 +766,75 @@ function removeListItems() {</span>
<a href="#l1.616"></a><span id="l1.616">                     leaveloop = true;</span>
<a href="#l1.617"></a><span id="l1.617">                 }</span>
<a href="#l1.618"></a><span id="l1.618">             }</span>
<a href="#l1.619"></a><span id="l1.619">             listItem = newlistItem;</span>
<a href="#l1.620"></a><span id="l1.620">         } while (!leaveloop)</span>
<a href="#l1.621"></a><span id="l1.621">     }</span>
<a href="#l1.622"></a><span id="l1.622"> }</span>
<a href="#l1.623"></a><span id="l1.623"> </span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+/**</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+ * Gets the list item node by its associated event's hashId.</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+ *</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineplus">+ * @return The XUL node if successful, otherwise null.</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineplus">+ */</span>
<a href="#l1.629"></a><span id="l1.629"> agendaListbox.getListItemByHashId =</span>
<a href="#l1.630"></a><span id="l1.630"> function getListItemByHashId(ahashId) {</span>
<a href="#l1.631"></a><span id="l1.631">     var listItem = this.agendaListboxControl.firstChild;</span>
<a href="#l1.632"></a><span id="l1.632">     var leaveloop = false;</span>
<a href="#l1.633"></a><span id="l1.633">     do {</span>
<a href="#l1.634"></a><span id="l1.634">         if (this.isEventListItem(listItem)) {</span>
<a href="#l1.635"></a><span id="l1.635">             if (listItem.occurrence.hashId == ahashId) {</span>
<a href="#l1.636"></a><span id="l1.636">                 return listItem;</span>
<a href="#l1.637"></a><span id="l1.637">             }</span>
<a href="#l1.638"></a><span id="l1.638">         }</span>
<a href="#l1.639"></a><span id="l1.639">         listItem = listItem.nextSibling;</span>
<a href="#l1.640"></a><span id="l1.640">         leaveloop = (listItem == null);</span>
<a href="#l1.641"></a><span id="l1.641">     } while (!leaveloop)</span>
<a href="#l1.642"></a><span id="l1.642">     return null;</span>
<a href="#l1.643"></a><span id="l1.643"> }</span>
<a href="#l1.644"></a><span id="l1.644"> </span>
<a href="#l1.645"></a><span id="l1.645" class="difflineplus">+/**</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineplus">+ * The operation listener used for calendar queries.</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+ * Implements calIOperationListener.</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+ */</span>
<a href="#l1.649"></a><span id="l1.649"> agendaListbox.calendarOpListener = {</span>
<a href="#l1.650"></a><span id="l1.650">     agendaListbox : agendaListbox</span>
<a href="#l1.651"></a><span id="l1.651"> };</span>
<a href="#l1.652"></a><span id="l1.652"> </span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+/**</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+ * Called when all items have been retrieved from the calendar.</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+ * @see calIOperationListener</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+ */</span>
<a href="#l1.657"></a><span id="l1.657"> agendaListbox.calendarOpListener.onOperationComplete =</span>
<a href="#l1.658"></a><span id="l1.658"> function listener_onOperationComplete(calendar, status, optype, id,</span>
<a href="#l1.659"></a><span id="l1.659">                                       detail) {</span>
<a href="#l1.660"></a><span id="l1.660">     // signal that the current operation finished.</span>
<a href="#l1.661"></a><span id="l1.661">     this.agendaListbox.pendingRefresh = null;</span>
<a href="#l1.662"></a><span id="l1.662">     setCurrentEvent();</span>
<a href="#l1.663"></a><span id="l1.663"> };</span>
<a href="#l1.664"></a><span id="l1.664"> </span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+/**</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+ * Called when an item has been retrieved, adds all items to the agenda listbox.</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+ * @see calIOperationListener</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+ */</span>
<a href="#l1.669"></a><span id="l1.669"> agendaListbox.calendarOpListener.onGetResult =</span>
<a href="#l1.670"></a><span id="l1.670"> function listener_onGetResult(calendar, status, itemtype, detail, count, items) {</span>
<a href="#l1.671"></a><span id="l1.671">     if (!Components.isSuccessCode(status))</span>
<a href="#l1.672"></a><span id="l1.672">         return;</span>
<a href="#l1.673"></a><span id="l1.673">     items.forEach(this.agendaListbox.addItem, this.agendaListbox);</span>
<a href="#l1.674"></a><span id="l1.674"> };</span>
<a href="#l1.675"></a><span id="l1.675"> </span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+/**</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+ * Calendar and composite observer, used to keep agenda listbox up to date.</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+ * @see calIObserver</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+ * @see calICompositeObserver</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+ */</span>
<a href="#l1.681"></a><span id="l1.681"> agendaListbox.calendarObserver = {</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-    agendaListbox : agendaListbox</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineplus">+    agendaListbox: agendaListbox</span>
<a href="#l1.684"></a><span id="l1.684"> };</span>
<a href="#l1.685"></a><span id="l1.685"> </span>
<a href="#l1.686"></a><span id="l1.686"> agendaListbox.calendarObserver.QueryInterface =</span>
<a href="#l1.687"></a><span id="l1.687"> function agenda_QI(aIID) {</span>
<a href="#l1.688"></a><span id="l1.688">     if (!aIID.equals(Components.interfaces.calIObserver) &amp;&amp;</span>
<a href="#l1.689"></a><span id="l1.689">         !aIID.equals(Components.interfaces.calICompositeObserver) &amp;&amp;</span>
<a href="#l1.690"></a><span id="l1.690">         !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l1.691"></a><span id="l1.691">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineat">@@ -769,16 +967,23 @@ function agenda_calRemove(aCalendar) {</span>
<a href="#l1.693"></a><span id="l1.693"> agendaListbox.calendarObserver.onCalendarAdded =</span>
<a href="#l1.694"></a><span id="l1.694"> function agenda_calAdd(aCalendar) {</span>
<a href="#l1.695"></a><span id="l1.695">     this.agendaListbox.refreshCalendarQuery();</span>
<a href="#l1.696"></a><span id="l1.696"> };</span>
<a href="#l1.697"></a><span id="l1.697"> </span>
<a href="#l1.698"></a><span id="l1.698"> agendaListbox.calendarObserver.onDefaultCalendarChanged = function(aCalendar) {</span>
<a href="#l1.699"></a><span id="l1.699"> };</span>
<a href="#l1.700"></a><span id="l1.700"> </span>
<a href="#l1.701"></a><span id="l1.701" class="difflineplus">+/**</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+ * Updates the event considered &quot;current&quot;. This goes through all &quot;today&quot; items</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+ * and sets the &quot;current&quot; attribute on all list items that are currently</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+ * occurring.</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+ *</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+ * @see scheduleNextCurrentEventUpdate</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+ */</span>
<a href="#l1.708"></a><span id="l1.708"> function setCurrentEvent() {</span>
<a href="#l1.709"></a><span id="l1.709">     if (agendaListbox.showsToday() &amp;&amp; agendaListbox.today.open) {</span>
<a href="#l1.710"></a><span id="l1.710"> </span>
<a href="#l1.711"></a><span id="l1.711">         var msScheduleTime = -1;</span>
<a href="#l1.712"></a><span id="l1.712">         var complistItem = agendaListbox.tomorrow.listItem.previousSibling;</span>
<a href="#l1.713"></a><span id="l1.713">         var removelist = [];</span>
<a href="#l1.714"></a><span id="l1.714">         var anow = now();</span>
<a href="#l1.715"></a><span id="l1.715">         var msuntillend = 0;</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineat">@@ -824,21 +1029,26 @@ function setCurrentEvent() {</span>
<a href="#l1.717"></a><span id="l1.717">               agendaListbox.agendaListboxControl.removeChild(removelist[i]);</span>
<a href="#l1.718"></a><span id="l1.718">           }</span>
<a href="#l1.719"></a><span id="l1.719">       }</span>
<a href="#l1.720"></a><span id="l1.720">     }</span>
<a href="#l1.721"></a><span id="l1.721"> }</span>
<a href="#l1.722"></a><span id="l1.722"> </span>
<a href="#l1.723"></a><span id="l1.723"> var gEventTimer;</span>
<a href="#l1.724"></a><span id="l1.724"> </span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-/** Creates a timer that will fire after the next event is current.</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-    Pass in a function as</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">- * aRefreshCallback that should be called at that time.</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+/**</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+ * Creates a timer that will fire after the next event is current.</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+ *  Pass in a function as aRefreshCallback that should be called at that time.</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineplus">+ *</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+ * @param aRefreshCallback      The function to call when the next event is</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineplus">+ *                                current.</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+ * @param aMsUntil              The number of milliseconds until the next event</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineplus">+ *                                is current.</span>
<a href="#l1.736"></a><span id="l1.736">  */</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-function scheduleNextCurrentEventUpdate(aRefreshCallback, aMsUntill) {</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+function scheduleNextCurrentEventUpdate(aRefreshCallback, aMsUntil) {</span>
<a href="#l1.739"></a><span id="l1.739"> </span>
<a href="#l1.740"></a><span id="l1.740">     // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l1.741"></a><span id="l1.741">     // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l1.742"></a><span id="l1.742">     // stuck in an infinite loop.</span>
<a href="#l1.743"></a><span id="l1.743">     var udCallback = {</span>
<a href="#l1.744"></a><span id="l1.744">         notify: function(timer) {</span>
<a href="#l1.745"></a><span id="l1.745">             aRefreshCallback();</span>
<a href="#l1.746"></a><span id="l1.746">         }</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineat">@@ -864,10 +1074,10 @@ function scheduleNextCurrentEventUpdate(</span>
<a href="#l1.748"></a><span id="l1.748">                                     observerService.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l1.749"></a><span id="l1.749">                                 }, false);</span>
<a href="#l1.750"></a><span id="l1.750"> </span>
<a href="#l1.751"></a><span id="l1.751">         gEventTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l1.752"></a><span id="l1.752">                                    .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l1.753"></a><span id="l1.753">     } else {</span>
<a href="#l1.754"></a><span id="l1.754">         gEventTimer.cancel();</span>
<a href="#l1.755"></a><span id="l1.755">     }</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-    gEventTimer.initWithCallback(udCallback, aMsUntill, gEventTimer.TYPE_ONE_SHOT);</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineplus">+    gEventTimer.initWithCallback(udCallback, aMsUntil, gEventTimer.TYPE_ONE_SHOT);</span>
<a href="#l1.758"></a><span id="l1.758"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-creation.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-creation.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -30,17 +30,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.5"></a><span id="l2.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.6"></a><span id="l2.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.7"></a><span id="l2.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> /**</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * Show the filepicker and create a new calendar with a local file using the ICS</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Shows the filepicker and creates a new calendar with a local file using the ICS</span>
<a href="#l2.14"></a><span id="l2.14">  * provider.</span>
<a href="#l2.15"></a><span id="l2.15">  */</span>
<a href="#l2.16"></a><span id="l2.16"> function openLocalCalendar() {</span>
<a href="#l2.17"></a><span id="l2.17">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l2.18"></a><span id="l2.18">     var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l2.19"></a><span id="l2.19">     fp.init(window, calGetString(&quot;calendar&quot;, &quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l2.20"></a><span id="l2.20">     var wildmat = &quot;*.ics&quot;;</span>
<a href="#l2.21"></a><span id="l2.21">     var description = calGetString(&quot;calendar&quot;, &quot;filterIcs&quot;, [wildmat]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-dialog-utils.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-dialog-utils.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -36,16 +36,22 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.5"></a><span id="l3.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.6"></a><span id="l3.6">  *</span>
<a href="#l3.7"></a><span id="l3.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> /**</span>
<a href="#l3.10"></a><span id="l3.10">  * This function takes the recurrence info passed as argument and creates a</span>
<a href="#l3.11"></a><span id="l3.11">  * literal string representing the repeat pattern in natural language.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * @param startDate         The start date to base rules on.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * @param endDate           The end date to base rules on.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * @param allDay            If true, the pattern should assume an allday item.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * @return                  A human readable string describing the recurrence.</span>
<a href="#l3.18"></a><span id="l3.18">  */</span>
<a href="#l3.19"></a><span id="l3.19"> function recurrenceRule2String(recurrenceInfo, startDate, endDate, allDay) {</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">     // Retrieve a valid recurrence rule from the currently</span>
<a href="#l3.22"></a><span id="l3.22">     // set recurrence info. Bail out if there's more</span>
<a href="#l3.23"></a><span id="l3.23">     // than a single rule or something other than a rule.</span>
<a href="#l3.24"></a><span id="l3.24">     recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l3.25"></a><span id="l3.25">     var rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -423,47 +429,70 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l3.27"></a><span id="l3.27">                 }</span>
<a href="#l3.28"></a><span id="l3.28">             }</span>
<a href="#l3.29"></a><span id="l3.29">             return detailsString;</span>
<a href="#l3.30"></a><span id="l3.30">         }</span>
<a href="#l3.31"></a><span id="l3.31">     }</span>
<a href="#l3.32"></a><span id="l3.32">     return null;</span>
<a href="#l3.33"></a><span id="l3.33"> }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+/**</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * Split rules into negative and positive rules.</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ *</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * @return                  An array with two elements: an array of positive</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *                            rules and an array of negative rules.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ */</span>
<a href="#l3.42"></a><span id="l3.42"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l3.43"></a><span id="l3.43">     var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l3.44"></a><span id="l3.44">     var rules = [];</span>
<a href="#l3.45"></a><span id="l3.45">     var exceptions = [];</span>
<a href="#l3.46"></a><span id="l3.46">     for each (var r in ritems) {</span>
<a href="#l3.47"></a><span id="l3.47">         if (r.isNegative) {</span>
<a href="#l3.48"></a><span id="l3.48">             exceptions.push(r);</span>
<a href="#l3.49"></a><span id="l3.49">         } else {</span>
<a href="#l3.50"></a><span id="l3.50">             rules.push(r);</span>
<a href="#l3.51"></a><span id="l3.51">         }</span>
<a href="#l3.52"></a><span id="l3.52">     }</span>
<a href="#l3.53"></a><span id="l3.53">     return [rules, exceptions];</span>
<a href="#l3.54"></a><span id="l3.54"> }</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+/**</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+ * Check if a recurrence rule's component is valid.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+ *</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+ * @see                     calIRecurrenceRule</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+ * @param aRule             The recurrence rule to check.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+ * @param aArray            An array of component names to check.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * @return                  Returns true if the rule is valid.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ */</span>
<a href="#l3.64"></a><span id="l3.64"> function checkRecurrenceRule(aRule, aArray) {</span>
<a href="#l3.65"></a><span id="l3.65">     for each (var comp in aArray) {</span>
<a href="#l3.66"></a><span id="l3.66">         var ruleComp = aRule.getComponent(comp, {});</span>
<a href="#l3.67"></a><span id="l3.67">         if (ruleComp &amp;&amp; ruleComp.length &gt; 0) {</span>
<a href="#l3.68"></a><span id="l3.68">             return true;</span>
<a href="#l3.69"></a><span id="l3.69">         }</span>
<a href="#l3.70"></a><span id="l3.70">     }</span>
<a href="#l3.71"></a><span id="l3.71">     return false;</span>
<a href="#l3.72"></a><span id="l3.72"> }</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+/**</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+ * Dispose of controlling operations of this event dialog. Uses</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+ * window.arguments[0].job.dispose()</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+ */</span>
<a href="#l3.78"></a><span id="l3.78"> function dispose() {</span>
<a href="#l3.79"></a><span id="l3.79">     var args = window.arguments[0];</span>
<a href="#l3.80"></a><span id="l3.80">     if (args.job &amp;&amp; args.job.dispose) {</span>
<a href="#l3.81"></a><span id="l3.81">         args.job.dispose();</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83"> }</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+/**</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * Opens the edit reminder dialog modally, setting the custom menuitem's</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ * 'reminder' property when done.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+ */</span>
<a href="#l3.89"></a><span id="l3.89"> function editReminder() {</span>
<a href="#l3.90"></a><span id="l3.90">     var customReminder =</span>
<a href="#l3.91"></a><span id="l3.91">         document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l3.92"></a><span id="l3.92">     var args = new Object();</span>
<a href="#l3.93"></a><span id="l3.93">     args.reminder = customReminder.reminder;</span>
<a href="#l3.94"></a><span id="l3.94">     var savedWindow = window;</span>
<a href="#l3.95"></a><span id="l3.95">     args.onOk = function(reminder) {</span>
<a href="#l3.96"></a><span id="l3.96">         customReminder.reminder = reminder;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineat">@@ -474,16 +503,21 @@ function editReminder() {</span>
<a href="#l3.98"></a><span id="l3.98">     // open the dialog modally</span>
<a href="#l3.99"></a><span id="l3.99">     openDialog(</span>
<a href="#l3.100"></a><span id="l3.100">         &quot;chrome://calendar/content/calendar-event-dialog-reminder.xul&quot;,</span>
<a href="#l3.101"></a><span id="l3.101">         &quot;_blank&quot;,</span>
<a href="#l3.102"></a><span id="l3.102">         &quot;chrome,titlebar,modal,resizable&quot;,</span>
<a href="#l3.103"></a><span id="l3.103">         args);</span>
<a href="#l3.104"></a><span id="l3.104"> }</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+/**</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+ * Update the reminder details from the selected alarm. This shows a string</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+ * describing the reminder set, or nothing in case a preselected reminder was</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+ * chosen.</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+ */</span>
<a href="#l3.111"></a><span id="l3.111"> function updateReminderDetails() {</span>
<a href="#l3.112"></a><span id="l3.112">     // find relevant elements in the document</span>
<a href="#l3.113"></a><span id="l3.113">     var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l3.114"></a><span id="l3.114">     var reminderDetails = document.getElementById(&quot;reminder-details&quot;);</span>
<a href="#l3.115"></a><span id="l3.115">     var reminder = document.getElementById(&quot;reminder-custom-menuitem&quot;).reminder;</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">     // first of all collapse the details text. if we fail to</span>
<a href="#l3.118"></a><span id="l3.118">     // create a details string, we simply don't show anything.</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineat">@@ -570,16 +604,21 @@ function updateReminderDetails() {</span>
<a href="#l3.120"></a><span id="l3.120">             var node = reminderDetails.childNodes[i];</span>
<a href="#l3.121"></a><span id="l3.121">             node.setAttribute('value', lines[i]);</span>
<a href="#l3.122"></a><span id="l3.122">         }</span>
<a href="#l3.123"></a><span id="l3.123">     }</span>
<a href="#l3.124"></a><span id="l3.124"> }</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126"> var gLastAlarmSelection = 0;</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+/**</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+ * Load an item's reminders into the dialog</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+ *</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+ * @param item      The item to load.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+ */</span>
<a href="#l3.133"></a><span id="l3.133"> function loadReminder(item) {</span>
<a href="#l3.134"></a><span id="l3.134">     // select 'no reminder' by default</span>
<a href="#l3.135"></a><span id="l3.135">     var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l3.136"></a><span id="l3.136">     reminderPopup.selectedIndex = 0;</span>
<a href="#l3.137"></a><span id="l3.137">     gLastAlarmSelection = 0;</span>
<a href="#l3.138"></a><span id="l3.138">     if (!item.alarmOffset) {</span>
<a href="#l3.139"></a><span id="l3.139">         return;</span>
<a href="#l3.140"></a><span id="l3.140">     }</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineat">@@ -668,16 +707,21 @@ function loadReminder(item) {</span>
<a href="#l3.142"></a><span id="l3.142">         }</span>
<a href="#l3.143"></a><span id="l3.143">         customReminder.reminder = reminder;</span>
<a href="#l3.144"></a><span id="l3.144">     }</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146">     // remember the selected index</span>
<a href="#l3.147"></a><span id="l3.147">     gLastAlarmSelection = reminderPopup.selectedIndex;</span>
<a href="#l3.148"></a><span id="l3.148"> }</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+/**</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+ * Save the selected reminder into the passed item.</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+ *</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+ * @param item      The item save the reminder into.</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+ */</span>
<a href="#l3.155"></a><span id="l3.155"> function saveReminder(item) {</span>
<a href="#l3.156"></a><span id="l3.156">     var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l3.157"></a><span id="l3.157">     if (reminderPopup.value == 'none') {</span>
<a href="#l3.158"></a><span id="l3.158">         item.alarmOffset = null;</span>
<a href="#l3.159"></a><span id="l3.159">         item.alarmLastAck = null;</span>
<a href="#l3.160"></a><span id="l3.160">         item.alarmRelated = null;</span>
<a href="#l3.161"></a><span id="l3.161">     } else {</span>
<a href="#l3.162"></a><span id="l3.162">         var menuitem = reminderPopup.selectedItem;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineat">@@ -707,16 +751,20 @@ function saveReminder(item) {</span>
<a href="#l3.164"></a><span id="l3.164">         if (Number(reminder.origin) &gt;= 0) {</span>
<a href="#l3.165"></a><span id="l3.165">             item.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l3.166"></a><span id="l3.166">         } else {</span>
<a href="#l3.167"></a><span id="l3.167">             item.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l3.168"></a><span id="l3.168">         }</span>
<a href="#l3.169"></a><span id="l3.169">     }</span>
<a href="#l3.170"></a><span id="l3.170"> }</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+/**</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+ * Common update functions for both event dialogs. Called when a reminder has</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+ * been selected from the menulist.</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+ */</span>
<a href="#l3.176"></a><span id="l3.176"> function commonUpdateReminder() {</span>
<a href="#l3.177"></a><span id="l3.177">     // if a custom reminder has been selected, we show the appropriate</span>
<a href="#l3.178"></a><span id="l3.178">     // dialog in order to allow the user to specify the details.</span>
<a href="#l3.179"></a><span id="l3.179">     // the result will be placed in the 'reminder-custom-menuitem' tag.</span>
<a href="#l3.180"></a><span id="l3.180">     var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l3.181"></a><span id="l3.181">     if (reminderPopup.value == 'custom') {</span>
<a href="#l3.182"></a><span id="l3.182">         // show the dialog.</span>
<a href="#l3.183"></a><span id="l3.183">         // don't pop up the dialog if this happens during</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineat">@@ -799,16 +847,19 @@ function commonUpdateReminder() {</span>
<a href="#l3.185"></a><span id="l3.185">                 enableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;reminder-lock&quot;);</span>
<a href="#l3.186"></a><span id="l3.186">             }</span>
<a href="#l3.187"></a><span id="l3.187">         }</span>
<a href="#l3.188"></a><span id="l3.188">     }</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">     updateReminderDetails();</span>
<a href="#l3.191"></a><span id="l3.191"> }</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+/**</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+ * Updates the related link on the dialog</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+ */</span>
<a href="#l3.196"></a><span id="l3.196"> function updateLink() {</span>
<a href="#l3.197"></a><span id="l3.197">     var itemUrlString = (window.calendarItem || window.item).getProperty(&quot;URL&quot;) || &quot;&quot;;</span>
<a href="#l3.198"></a><span id="l3.198">     var linkCommand = document.getElementById(&quot;cmd_toggle_link&quot;);</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200">     function hideOrShow(aBool) {</span>
<a href="#l3.201"></a><span id="l3.201">         setElementValue(&quot;event-grid-link-row&quot;, !aBool &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l3.202"></a><span id="l3.202">         var separator = document.getElementById(&quot;event-grid-link-separator&quot;);</span>
<a href="#l3.203"></a><span id="l3.203">         if (separator) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -34,16 +34,25 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.5"></a><span id="l4.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.6"></a><span id="l4.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.7"></a><span id="l4.7">  *</span>
<a href="#l4.8"></a><span id="l4.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> var itemConversion = {</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    /**</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+     * Converts an email message to a calendar item.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+     *</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+     * XXX Currently, only the title is taken from the passed message. Aside</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+     * from that, the currently visible message in the preview pane is used.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+     *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+     * @param aItem     The target calIItemBase.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+     * @param aMessage  The message  to convert from</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+     */</span>
<a href="#l4.21"></a><span id="l4.21">     calendarItemFromMessage: function iC_calendarItemFromMessage(aItem, aMessage) {</span>
<a href="#l4.22"></a><span id="l4.22">         aItem.calendar = getSelectedCalendar();</span>
<a href="#l4.23"></a><span id="l4.23">         aItem.title = aMessage.mime2DecodedSubject;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">         setDefaultStartEndHour(aItem);</span>
<a href="#l4.26"></a><span id="l4.26">         setDefaultAlarmValues(aItem);</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">         // XXX It would be great if nsPlainTextParser could take care of this.</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -84,16 +93,24 @@ var itemConversion = {</span>
<a href="#l4.30"></a><span id="l4.30">                     aItem.setProperty(</span>
<a href="#l4.31"></a><span id="l4.31">                         &quot;DESCRIPTION&quot;,</span>
<a href="#l4.32"></a><span id="l4.32">                         htmlToPlainText(body.innerHTML));</span>
<a href="#l4.33"></a><span id="l4.33">                 }</span>
<a href="#l4.34"></a><span id="l4.34">             }</span>
<a href="#l4.35"></a><span id="l4.35">         }</span>
<a href="#l4.36"></a><span id="l4.36">     },</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    /**</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+     * Copy base item properties from aItem to aTarget. This includes properties</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+     * like title, location, description, priority, status, transparency,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+     * attendees, categories, calendar, recurrence and possibly more.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+     *</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+     * @param aItem     The item to copy from.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+     * @param aTarget   the item to copy to.</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+     */</span>
<a href="#l4.46"></a><span id="l4.46">     copyItemBase: function iC_copyItemBase(aItem, aTarget) {</span>
<a href="#l4.47"></a><span id="l4.47">         const copyProps = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;, &quot;DESCRIPTION&quot;,</span>
<a href="#l4.48"></a><span id="l4.48">                            &quot;URL&quot;, &quot;CLASS&quot;, &quot;PRIORITY&quot;, &quot;STATUS&quot;];</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">         for each (var prop in copyProps) {</span>
<a href="#l4.51"></a><span id="l4.51">             aTarget.setProperty(prop, aItem.getProperty(prop));</span>
<a href="#l4.52"></a><span id="l4.52">         }</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54" class="difflineat">@@ -115,16 +132,23 @@ var itemConversion = {</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">         // Recurrence</span>
<a href="#l4.57"></a><span id="l4.57">         if (aItem.recurrenceInfo) {</span>
<a href="#l4.58"></a><span id="l4.58">             aTarget.recurrenceInfo = aItem.recurrenceInfo.clone();</span>
<a href="#l4.59"></a><span id="l4.59">             aTarget.recurrenceInfo.item = aTarget;</span>
<a href="#l4.60"></a><span id="l4.60">         }</span>
<a href="#l4.61"></a><span id="l4.61">     },</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+    /**</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+     * Creates a task from the passed event. This function copies the base item</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+     * and a few event specific properties (dates, alarms, ...).</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+     *</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+     * @param aEvent    The event to copy from.</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+     * @return          The resulting task.</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+     */</span>
<a href="#l4.70"></a><span id="l4.70">     taskFromEvent: function iC_taskFromEvent(aEvent) {</span>
<a href="#l4.71"></a><span id="l4.71">         var item = createTodo();</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">         this.copyItemBase(aEvent, item);</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">         // Dates and alarms</span>
<a href="#l4.76"></a><span id="l4.76">         if (!aEvent.startDate.isDate &amp;&amp; !aEvent.endDate.isDate) {</span>
<a href="#l4.77"></a><span id="l4.77">             // Dates</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineat">@@ -138,16 +162,24 @@ var itemConversion = {</span>
<a href="#l4.79"></a><span id="l4.79">             item.alarmRelated = aEvent.alarmRelated;</span>
<a href="#l4.80"></a><span id="l4.80">             item.alarmLastAck = (aEvent.alarmLastAck ?</span>
<a href="#l4.81"></a><span id="l4.81">                                  aEvent.alarmLastAck.clone() :</span>
<a href="#l4.82"></a><span id="l4.82">                                  null);</span>
<a href="#l4.83"></a><span id="l4.83">         }</span>
<a href="#l4.84"></a><span id="l4.84">         return item;</span>
<a href="#l4.85"></a><span id="l4.85">     },</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    /**</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+     * Creates an event from the passed task. This function copies the base item</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+     * and a few task specific properties (dates, alarms, ...). If the task has</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+     * no due date, the default event length is used.</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+     *</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+     * @param aTask     The task to copy from.</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+     * @return          The resulting event.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+     */</span>
<a href="#l4.95"></a><span id="l4.95">     eventFromTask: function iC_eventFromTask(aTask) {</span>
<a href="#l4.96"></a><span id="l4.96">         var item = createEvent();</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">         this.copyItemBase(aTask, item);</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">         // Dates and alarms</span>
<a href="#l4.101"></a><span id="l4.101">         item.startDate = aTask.entryDate;</span>
<a href="#l4.102"></a><span id="l4.102">         if (!item.startDate) {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineat">@@ -169,16 +201,20 @@ var itemConversion = {</span>
<a href="#l4.104"></a><span id="l4.104">         item.alarmRelated = aTask.alarmRelated;</span>
<a href="#l4.105"></a><span id="l4.105">         item.alarmLastAck = (aTask.alarmLastAck ?</span>
<a href="#l4.106"></a><span id="l4.106">                              aTask.alarmLastAck.clone() :</span>
<a href="#l4.107"></a><span id="l4.107">                              null);</span>
<a href="#l4.108"></a><span id="l4.108">         return item;</span>
<a href="#l4.109"></a><span id="l4.109">     }</span>
<a href="#l4.110"></a><span id="l4.110"> };</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+/**</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+ * A base class for drag and drop observers</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+ * @class calDNDBaseObserver</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+ */</span>
<a href="#l4.116"></a><span id="l4.116"> function calDNDBaseObserver() {</span>
<a href="#l4.117"></a><span id="l4.117">     ASSERT(false, &quot;Inheriting objects call calDNDBaseObserver!&quot;);</span>
<a href="#l4.118"></a><span id="l4.118"> }</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120"> calDNDBaseObserver.prototype = {</span>
<a href="#l4.121"></a><span id="l4.121">     // initialize this class's members</span>
<a href="#l4.122"></a><span id="l4.122">     initBase: function calDNDInitBase() {</span>
<a href="#l4.123"></a><span id="l4.123">     },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineat">@@ -188,16 +224,20 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l4.125"></a><span id="l4.125">         flavourSet.appendFlavour(&quot;text/calendar&quot;);</span>
<a href="#l4.126"></a><span id="l4.126">         flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l4.127"></a><span id="l4.127">         flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l4.128"></a><span id="l4.128">         flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l4.129"></a><span id="l4.129">         flavourSet.appendFlavour(&quot;application/x-moz-file&quot;);</span>
<a href="#l4.130"></a><span id="l4.130">         return flavourSet;</span>
<a href="#l4.131"></a><span id="l4.131">     },</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    /**</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+     * Action to take when dropping the event.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+     */</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+</span>
<a href="#l4.137"></a><span id="l4.137">     onDrop: function calDNDDrop(aEvent, aTransferData, aDragSession) {</span>
<a href="#l4.138"></a><span id="l4.138">         var transferable = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l4.139"></a><span id="l4.139">                            .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l4.140"></a><span id="l4.140">         transferable.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l4.141"></a><span id="l4.141">         transferable.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l4.142"></a><span id="l4.142">         transferable.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l4.143"></a><span id="l4.143">         transferable.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l4.144"></a><span id="l4.144">         transferable.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineat">@@ -391,16 +431,18 @@ function calMailButtonDNDObserver() {</span>
<a href="#l4.146"></a><span id="l4.146"> calMailButtonDNDObserver.prototype = {</span>
<a href="#l4.147"></a><span id="l4.147">     __proto__: calDNDBaseObserver.prototype,</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">     /**</span>
<a href="#l4.150"></a><span id="l4.150">      * calMailButtonDNDObserver::onDropItems</span>
<a href="#l4.151"></a><span id="l4.151">      *</span>
<a href="#l4.152"></a><span id="l4.152">      * Gets called in case we're dropping an array of items</span>
<a href="#l4.153"></a><span id="l4.153">      * on the 'mail mode'-button.</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+     *</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+     * @param aItems        An array of items to handle.</span>
<a href="#l4.156"></a><span id="l4.156">      */</span>
<a href="#l4.157"></a><span id="l4.157">     onDropItems: function(aItems) {</span>
<a href="#l4.158"></a><span id="l4.158">         if (aItems &amp;&amp; aItems.length &gt; 0) {</span>
<a href="#l4.159"></a><span id="l4.159">             var item = aItems[0];</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161">             var recipients = &quot;&quot;;</span>
<a href="#l4.162"></a><span id="l4.162">             var attendees = item.getAttendees({});</span>
<a href="#l4.163"></a><span id="l4.163">             for each (var attendee in attendees) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineat">@@ -427,16 +469,18 @@ calMailButtonDNDObserver.prototype = {</span>
<a href="#l4.165"></a><span id="l4.165">         }</span>
<a href="#l4.166"></a><span id="l4.166">     },</span>
<a href="#l4.167"></a><span id="l4.167"> </span>
<a href="#l4.168"></a><span id="l4.168">     /**</span>
<a href="#l4.169"></a><span id="l4.169">      * calMailButtonDNDObserver::onDropMessage</span>
<a href="#l4.170"></a><span id="l4.170">      *</span>
<a href="#l4.171"></a><span id="l4.171">      * Gets called in case we're dropping a message</span>
<a href="#l4.172"></a><span id="l4.172">      * on the 'mail mode'-button.</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+     *</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+     * @param aMessage     The message to handle.</span>
<a href="#l4.175"></a><span id="l4.175">      */</span>
<a href="#l4.176"></a><span id="l4.176">     onDropMessage: function(aMessage) {</span>
<a href="#l4.177"></a><span id="l4.177">     }</span>
<a href="#l4.178"></a><span id="l4.178"> };</span>
<a href="#l4.179"></a><span id="l4.179"> </span>
<a href="#l4.180"></a><span id="l4.180"> /**</span>
<a href="#l4.181"></a><span id="l4.181">  * calCalendarButtonDNDObserver::calCalendarButtonDNDObserver</span>
<a href="#l4.182"></a><span id="l4.182">  *</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineat">@@ -451,16 +495,18 @@ function calCalendarButtonDNDObserver() </span>
<a href="#l4.184"></a><span id="l4.184"> calCalendarButtonDNDObserver.prototype = {</span>
<a href="#l4.185"></a><span id="l4.185">     __proto__: calDNDBaseObserver.prototype,</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187">     /**</span>
<a href="#l4.188"></a><span id="l4.188">      * calCalendarButtonDNDObserver::onDropItems</span>
<a href="#l4.189"></a><span id="l4.189">      *</span>
<a href="#l4.190"></a><span id="l4.190">      * Gets called in case we're dropping an array of items</span>
<a href="#l4.191"></a><span id="l4.191">      * on the 'calendar mode'-button.</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+     *</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+     * @param aItems        An array of items to handle.</span>
<a href="#l4.194"></a><span id="l4.194">      */</span>
<a href="#l4.195"></a><span id="l4.195">     onDropItems: function(aItems) {</span>
<a href="#l4.196"></a><span id="l4.196">         for each (var item in aItems) {</span>
<a href="#l4.197"></a><span id="l4.197">             var newItem = item;</span>
<a href="#l4.198"></a><span id="l4.198">             if (isToDo(item)) {</span>
<a href="#l4.199"></a><span id="l4.199">                 newItem = itemConversion.eventFromTask(item);</span>
<a href="#l4.200"></a><span id="l4.200">             }</span>
<a href="#l4.201"></a><span id="l4.201">             createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineat">@@ -469,16 +515,18 @@ calCalendarButtonDNDObserver.prototype =</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204">     /**</span>
<a href="#l4.205"></a><span id="l4.205">      * calCalendarButtonDNDObserver::onDropMessage</span>
<a href="#l4.206"></a><span id="l4.206">      *</span>
<a href="#l4.207"></a><span id="l4.207">      * Gets called in case we're dropping a message on the</span>
<a href="#l4.208"></a><span id="l4.208">      * 'calendar mode'-button. In this case we create a new</span>
<a href="#l4.209"></a><span id="l4.209">      * event from the mail. We open the default event dialog</span>
<a href="#l4.210"></a><span id="l4.210">      * and just use the subject of the message as the event title.</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+     *</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+     * @param aMessage     The message to handle.</span>
<a href="#l4.213"></a><span id="l4.213">      */</span>
<a href="#l4.214"></a><span id="l4.214">     onDropMessage: function(aMessage) {</span>
<a href="#l4.215"></a><span id="l4.215">         var newItem = createEvent();</span>
<a href="#l4.216"></a><span id="l4.216">         itemConversion.calendarItemFromMessage(newItem, aMessage);</span>
<a href="#l4.217"></a><span id="l4.217">         createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l4.218"></a><span id="l4.218">     }</span>
<a href="#l4.219"></a><span id="l4.219"> };</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineat">@@ -496,40 +544,51 @@ function calTaskButtonDNDObserver() {</span>
<a href="#l4.222"></a><span id="l4.222"> calTaskButtonDNDObserver.prototype = {</span>
<a href="#l4.223"></a><span id="l4.223">     __proto__: calDNDBaseObserver.prototype,</span>
<a href="#l4.224"></a><span id="l4.224"> </span>
<a href="#l4.225"></a><span id="l4.225">     /**</span>
<a href="#l4.226"></a><span id="l4.226">      * calTaskButtonDNDObserver::onDropItems</span>
<a href="#l4.227"></a><span id="l4.227">      *</span>
<a href="#l4.228"></a><span id="l4.228">      * Gets called in case we're dropping an array of items</span>
<a href="#l4.229"></a><span id="l4.229">      * on the 'task mode'-button.</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+     *</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+     * @param aItems        An array of items to handle.</span>
<a href="#l4.232"></a><span id="l4.232">      */</span>
<a href="#l4.233"></a><span id="l4.233">     onDropItems: function(aItems) {</span>
<a href="#l4.234"></a><span id="l4.234">         for each (var item in aItems) {</span>
<a href="#l4.235"></a><span id="l4.235">             var newItem = item;</span>
<a href="#l4.236"></a><span id="l4.236">             if (isEvent(item)) {</span>
<a href="#l4.237"></a><span id="l4.237">                 newItem = itemConversion.taskFromEvent(item);</span>
<a href="#l4.238"></a><span id="l4.238">             }</span>
<a href="#l4.239"></a><span id="l4.239">             createTodoWithDialog(null, null, null, newItem);</span>
<a href="#l4.240"></a><span id="l4.240">         }</span>
<a href="#l4.241"></a><span id="l4.241">     },</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243">     /**</span>
<a href="#l4.244"></a><span id="l4.244">      * calTaskButtonDNDObserver::onDropMessage</span>
<a href="#l4.245"></a><span id="l4.245">      *</span>
<a href="#l4.246"></a><span id="l4.246">      * Gets called in case we're dropping a message</span>
<a href="#l4.247"></a><span id="l4.247">      * on the 'task mode'-button.</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+     *</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+     * @param aMessage     The message to handle.</span>
<a href="#l4.250"></a><span id="l4.250">      */</span>
<a href="#l4.251"></a><span id="l4.251">     onDropMessage: function(aMessage) {</span>
<a href="#l4.252"></a><span id="l4.252">         var todo = createTodo();</span>
<a href="#l4.253"></a><span id="l4.253">         itemConversion.calendarItemFromMessage(todo, aMessage);</span>
<a href="#l4.254"></a><span id="l4.254">         createTodoWithDialog(null, null, null, todo);</span>
<a href="#l4.255"></a><span id="l4.255">     }</span>
<a href="#l4.256"></a><span id="l4.256"> };</span>
<a href="#l4.257"></a><span id="l4.257"> </span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+/**</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+ * Invoke a drag session for the passed item. The passed box will be used as a</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+ * source.</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+ *</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+ * @param aItem     The item to drag.</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+ * @param aXULBox   The XUL box to invoke the drag session from.</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+ */</span>
<a href="#l4.265"></a><span id="l4.265"> function invokeEventDragSession(aItem, aXULBox) {</span>
<a href="#l4.266"></a><span id="l4.266">     let transfer = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l4.267"></a><span id="l4.267">                    .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l4.268"></a><span id="l4.268">     transfer.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l4.269"></a><span id="l4.269"> </span>
<a href="#l4.270"></a><span id="l4.270">     let flavourProvider = {</span>
<a href="#l4.271"></a><span id="l4.271">         QueryInterface: function(aIID) {</span>
<a href="#l4.272"></a><span id="l4.272">             return doQueryInterface(aXULBox, null, aIID, [Components.interfaces.nsIFlavorDataProvider]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -32,26 +32,37 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.5"></a><span id="l5.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.6"></a><span id="l5.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.7"></a><span id="l5.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.8"></a><span id="l5.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/**</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * Get this window's currently selected calendar.</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * @return      The currently selected calendar.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ */</span>
<a href="#l5.18"></a><span id="l5.18"> function getSelectedCalendar() {</span>
<a href="#l5.19"></a><span id="l5.19">     var tree = document.getElementById(&quot;calendar-list-tree-widget&quot;);</span>
<a href="#l5.20"></a><span id="l5.20">     if (tree) {</span>
<a href="#l5.21"></a><span id="l5.21">         return calendarListTreeView.getCalendar(tree.currentIndex);</span>
<a href="#l5.22"></a><span id="l5.22">     } else { // make robust in startup scenarios when calendar list is not yet loaded:</span>
<a href="#l5.23"></a><span id="l5.23">         return getCompositeCalendar().defaultCalendar;</span>
<a href="#l5.24"></a><span id="l5.24">     }</span>
<a href="#l5.25"></a><span id="l5.25"> }</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+/**</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ * Deletes the passed calendar, prompting the user if he really wants to do</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ * this. If there is only one calendar left, no calendar is removed and the user</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * is not prompted.</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ *</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * @param aCalendar     The calendar to delete.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ */</span>
<a href="#l5.34"></a><span id="l5.34"> function promptDeleteCalendar(aCalendar) {</span>
<a href="#l5.35"></a><span id="l5.35">     var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l5.36"></a><span id="l5.36">     if (calendars.length &lt;= 1) {</span>
<a href="#l5.37"></a><span id="l5.37">         // If this is the last calendar, don't delete it.</span>
<a href="#l5.38"></a><span id="l5.38">         return;</span>
<a href="#l5.39"></a><span id="l5.39">     }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">     var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineat">@@ -66,25 +77,28 @@ function promptDeleteCalendar(aCalendar)</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">     if (ok) {</span>
<a href="#l5.45"></a><span id="l5.45">         var calMgr = getCalendarManager();</span>
<a href="#l5.46"></a><span id="l5.46">         calMgr.unregisterCalendar(aCalendar);</span>
<a href="#l5.47"></a><span id="l5.47">         calMgr.deleteCalendar(aCalendar);</span>
<a href="#l5.48"></a><span id="l5.48">     }</span>
<a href="#l5.49"></a><span id="l5.49"> }</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+/**</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+ * Ensure that the passed calendar is visible to the user in the current window.</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+ */</span>
<a href="#l5.54"></a><span id="l5.54"> function ensureCalendarVisible(aCalendar) {</span>
<a href="#l5.55"></a><span id="l5.55">     var composite = getCompositeCalendar();</span>
<a href="#l5.56"></a><span id="l5.56">     if (!composite.getCalendar(aCalendar.uri)) {</span>
<a href="#l5.57"></a><span id="l5.57">         composite.addCalendar(aCalendar);</span>
<a href="#l5.58"></a><span id="l5.58">     }</span>
<a href="#l5.59"></a><span id="l5.59"> }</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61"> /**</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">- * Calendar manager load/unload functions</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+ * Called to initialize the calendar manager for a window.</span>
<a href="#l5.64"></a><span id="l5.64">  */</span>
<a href="#l5.65"></a><span id="l5.65"> function loadCalendarManager() {</span>
<a href="#l5.66"></a><span id="l5.66">     var calMgr = getCalendarManager();</span>
<a href="#l5.67"></a><span id="l5.67">     var composite = getCompositeCalendar();</span>
<a href="#l5.68"></a><span id="l5.68">     var calendars = calMgr.getCalendars({});</span>
<a href="#l5.69"></a><span id="l5.69">     var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.70"></a><span id="l5.70">                       .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l5.71"></a><span id="l5.71">     var branch = prefService.getBranch(&quot;&quot;).QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineat">@@ -126,16 +140,19 @@ function loadCalendarManager() {</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74">     // The calendar manager will not notify for existing calendars. Go through</span>
<a href="#l5.75"></a><span id="l5.75">     // them all and set up manually.</span>
<a href="#l5.76"></a><span id="l5.76">     for each (let calendar in sortCalendarArray(calendars)) {</span>
<a href="#l5.77"></a><span id="l5.77">         calendarManagerObserver.initializeCalendar(calendar);</span>
<a href="#l5.78"></a><span id="l5.78">     }</span>
<a href="#l5.79"></a><span id="l5.79"> }</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+/**</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+ * Called to clean up the calendar manager for a window.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+ */</span>
<a href="#l5.84"></a><span id="l5.84"> function unloadCalendarManager() {</span>
<a href="#l5.85"></a><span id="l5.85">     calendarManagerObserver.unload();</span>
<a href="#l5.86"></a><span id="l5.86">     var calMgr = getCalendarManager();</span>
<a href="#l5.87"></a><span id="l5.87">     var composite = getCompositeCalendar();</span>
<a href="#l5.88"></a><span id="l5.88">     var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.89"></a><span id="l5.89">                       .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l5.90"></a><span id="l5.90">     var branch = prefService.getBranch(&quot;&quot;).QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineat">@@ -143,16 +160,23 @@ function unloadCalendarManager() {</span>
<a href="#l5.93"></a><span id="l5.93">     composite.removeObserver(calendarManagerCompositeObserver);</span>
<a href="#l5.94"></a><span id="l5.94">     composite.setStatusObserver(null, null);</span>
<a href="#l5.95"></a><span id="l5.95">     calMgr.removeObserver(calendarManagerObserver);</span>
<a href="#l5.96"></a><span id="l5.96"> }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98"> /**</span>
<a href="#l5.99"></a><span id="l5.99">  * Color specific functions</span>
<a href="#l5.100"></a><span id="l5.100">  */</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+/**</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+ * Update the calendar-view-bindings.css stylesheet to provide rules for</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+ * category colors.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+ *</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+ * XXX This doesn't really fit into the calendar manager and is here for</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+ * historical reasons.</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+ */</span>
<a href="#l5.108"></a><span id="l5.108"> var gCachedStyleSheet;</span>
<a href="#l5.109"></a><span id="l5.109"> function calendarListInitCategoryColors() {</span>
<a href="#l5.110"></a><span id="l5.110">     var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l5.111"></a><span id="l5.111">     if (!gCachedStyleSheet) {</span>
<a href="#l5.112"></a><span id="l5.112">         var cssUri = &quot;chrome://calendar/content/calendar-view-bindings.css&quot;;</span>
<a href="#l5.113"></a><span id="l5.113">         gCachedStyleSheet = getStyleSheet(cssUri);</span>
<a href="#l5.114"></a><span id="l5.114">     }</span>
<a href="#l5.115"></a><span id="l5.115"> </span>
<a href="#l5.116"></a><span id="l5.116" class="difflineat">@@ -174,20 +198,25 @@ function calendarListInitCategoryColors(</span>
<a href="#l5.117"></a><span id="l5.117">  * Remove illegally formatted category names from the array coloredCategories</span>
<a href="#l5.118"></a><span id="l5.118">  * so they don't cause CSS errors.  For each illegal colored category c, if</span>
<a href="#l5.119"></a><span id="l5.119">  * its color preference has not yet been replaced with a converted preference</span>
<a href="#l5.120"></a><span id="l5.120">  * with key formatStringForCSSRule(c), create the preference with the</span>
<a href="#l5.121"></a><span id="l5.121">  * converted key and with the previous preference value, and clear the old</span>
<a href="#l5.122"></a><span id="l5.122">  * preference.  (For most users who upgrade and do not later add colors with a</span>
<a href="#l5.123"></a><span id="l5.123">  * downgrade version, this should convert any illegal preferences once, so</span>
<a href="#l5.124"></a><span id="l5.124">  * future runs have no illegal preferences.)</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">- * @param categoryPrefBranch prefBranch for &quot;calendar.category.color.&quot;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">- * @param coloredCategories array of preference name suffixes under the prefBranch.</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">- * @return same array with each illegal name replaced with formatted name if</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">- * it doesn't already exist, or simply removed from array if it does.</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+ *</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+ * @param categoryPrefBranch        PrefBranch for &quot;calendar.category.color.&quot;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+ * @param coloredCategories         Array of preference name suffixes under the</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+ *                                    prefBranch.</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+ * @return                          Same array with each illegal name replaced</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+ *                                    with formatted name if it doesn't already</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+ *                                    exist, or simply removed from array if it</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+ *                                    does.</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+ *</span>
<a href="#l5.138"></a><span id="l5.138">  */</span>
<a href="#l5.139"></a><span id="l5.139"> function calendarConvertObsoleteColorPrefs(categoryPrefBranch, coloredCategories) {</span>
<a href="#l5.140"></a><span id="l5.140">     for (var i in coloredCategories) {</span>
<a href="#l5.141"></a><span id="l5.141">         var category = coloredCategories[i];</span>
<a href="#l5.142"></a><span id="l5.142">         if (category.search(/[^_0-9a-z-]/) != -1) {</span>
<a href="#l5.143"></a><span id="l5.143">             var categoryFix = formatStringForCSSRule(category);</span>
<a href="#l5.144"></a><span id="l5.144">             if (!categoryPrefBranch.prefHasUserValue(categoryFix)) {</span>
<a href="#l5.145"></a><span id="l5.145">                 var color = categoryPrefBranch.getCharPref(category);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineat">@@ -197,16 +226,22 @@ function calendarConvertObsoleteColorPre</span>
<a href="#l5.147"></a><span id="l5.147">             } else {</span>
<a href="#l5.148"></a><span id="l5.148">                 coloredCategories.splice(i, 1); // remove illegal name</span>
<a href="#l5.149"></a><span id="l5.149">             }</span>
<a href="#l5.150"></a><span id="l5.150">         }</span>
<a href="#l5.151"></a><span id="l5.151">     }</span>
<a href="#l5.152"></a><span id="l5.152">     return coloredCategories;</span>
<a href="#l5.153"></a><span id="l5.153"> }</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+/**</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+ * Update the cached stylesheet to provide rules for the calendar list's</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+ * calendar colors.</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+ *</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+ * @param aCalendar         The calendar to update rules for.</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+ */</span>
<a href="#l5.161"></a><span id="l5.161"> function calendarListUpdateColor(aCalendar) {</span>
<a href="#l5.162"></a><span id="l5.162">     var selectorPrefix = &quot;treechildren::-moz-tree-cell&quot;;</span>
<a href="#l5.163"></a><span id="l5.163">     var color = aCalendar.getProperty(&quot;color&quot;);</span>
<a href="#l5.164"></a><span id="l5.164">     if (!color) {</span>
<a href="#l5.165"></a><span id="l5.165">         return;</span>
<a href="#l5.166"></a><span id="l5.166">     }</span>
<a href="#l5.167"></a><span id="l5.167">     var selector = selectorPrefix + &quot;color-&quot;  + color.substr(1);</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169" class="difflineat">@@ -240,66 +275,101 @@ var calendarListTreeView = {</span>
<a href="#l5.170"></a><span id="l5.170">                                 [Components.interfaces.nsISupports,</span>
<a href="#l5.171"></a><span id="l5.171">                                  Components.interfaces.nsITreeView]);</span>
<a href="#l5.172"></a><span id="l5.172">     },</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174">     /**</span>
<a href="#l5.175"></a><span id="l5.175">      * High-level calendar tree manipulation</span>
<a href="#l5.176"></a><span id="l5.176">      */</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+    /**</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+     * Find the array index of the passed calendar</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+     *</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+     * @param aCalendar     The calendar to find an index for.</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+     * @return              The array index, or -1 if not found.</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+     */</span>
<a href="#l5.184"></a><span id="l5.184">     findIndex: function cLTV_findIndex(aCalendar) {</span>
<a href="#l5.185"></a><span id="l5.185">         for (var i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l5.186"></a><span id="l5.186">             if (this.mCalendarList[i].id == aCalendar.id) {</span>
<a href="#l5.187"></a><span id="l5.187">                 return i;</span>
<a href="#l5.188"></a><span id="l5.188">             }</span>
<a href="#l5.189"></a><span id="l5.189">         }</span>
<a href="#l5.190"></a><span id="l5.190">         return -1;</span>
<a href="#l5.191"></a><span id="l5.191">     },</span>
<a href="#l5.192"></a><span id="l5.192"> </span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+    /**</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+     * Find the array index of a calendar by its uri.</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+     *</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+     * @param aUri          The uri to find an index for.</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+     * @return              The array index, or -1 if not found.</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+     */</span>
<a href="#l5.199"></a><span id="l5.199">     findIndexByUri: function cLTV_findIndexByUri(aUri) {</span>
<a href="#l5.200"></a><span id="l5.200">         for (var i = 0; i &lt; this.mCalendarList.length; i++) {</span>
<a href="#l5.201"></a><span id="l5.201">             if (this.mCalendarList[i].uri.equals(aUri)) {</span>
<a href="#l5.202"></a><span id="l5.202">                 return i;</span>
<a href="#l5.203"></a><span id="l5.203">             }</span>
<a href="#l5.204"></a><span id="l5.204">         }</span>
<a href="#l5.205"></a><span id="l5.205">         return -1;</span>
<a href="#l5.206"></a><span id="l5.206">     },</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+    /**</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+     * Add a calendar to the calendar list</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+     * </span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+     * @param aCalendar     The calendar to add.</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+     */</span>
<a href="#l5.213"></a><span id="l5.213">     addCalendar: function cLTV_addCalendar(aCalendar) {</span>
<a href="#l5.214"></a><span id="l5.214">         var composite = getCompositeCalendar();</span>
<a href="#l5.215"></a><span id="l5.215">         this.mCalendarList.push(aCalendar);</span>
<a href="#l5.216"></a><span id="l5.216">         calendarListUpdateColor(aCalendar);</span>
<a href="#l5.217"></a><span id="l5.217">         this.treebox.rowCountChanged(this.mCalendarList.length - 1, 1);</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219">         if (!composite.defaultCalendar ||</span>
<a href="#l5.220"></a><span id="l5.220">             aCalendar.id == composite.defaultCalendar.id) {</span>
<a href="#l5.221"></a><span id="l5.221">             this.tree.view.selection.select(this.mCalendarList.length - 1);</span>
<a href="#l5.222"></a><span id="l5.222">         }</span>
<a href="#l5.223"></a><span id="l5.223">     },</span>
<a href="#l5.224"></a><span id="l5.224"> </span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+    /**</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+     * Remove a calendar from the calendar list</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+     * </span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+     * @param aCalendar     The calendar to remove.</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+     */</span>
<a href="#l5.230"></a><span id="l5.230">     removeCalendar: function cLTV_removeCalendar(aCalendar) {</span>
<a href="#l5.231"></a><span id="l5.231">         var index = this.findIndex(aCalendar);</span>
<a href="#l5.232"></a><span id="l5.232">         if (index &lt; 0) {</span>
<a href="#l5.233"></a><span id="l5.233">             return;</span>
<a href="#l5.234"></a><span id="l5.234">         }</span>
<a href="#l5.235"></a><span id="l5.235"> </span>
<a href="#l5.236"></a><span id="l5.236">         this.mCalendarList.splice(index, 1);</span>
<a href="#l5.237"></a><span id="l5.237">         if (index == this.rowCount) {</span>
<a href="#l5.238"></a><span id="l5.238">             index--;</span>
<a href="#l5.239"></a><span id="l5.239">         }</span>
<a href="#l5.240"></a><span id="l5.240"> </span>
<a href="#l5.241"></a><span id="l5.241">         this.tree.view.selection.select(index + 1);</span>
<a href="#l5.242"></a><span id="l5.242">         this.treebox.rowCountChanged(index, -1);</span>
<a href="#l5.243"></a><span id="l5.243">     },</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+    /**</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+     * Update a calendar's tree row (to refresh the color and such)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+     * </span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+     * @param aCalendar     The calendar to update.</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+     */</span>
<a href="#l5.250"></a><span id="l5.250">     updateCalendar: function cLTV_updateCalendar(aCalendar) {</span>
<a href="#l5.251"></a><span id="l5.251">         var index = this.findIndex(aCalendar);</span>
<a href="#l5.252"></a><span id="l5.252">         this.treebox.invalidateRow(index);</span>
<a href="#l5.253"></a><span id="l5.253">     },</span>
<a href="#l5.254"></a><span id="l5.254"> </span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+    /**</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+     * Get the calendar from the given DOM event. This can be a Mouse event or a</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+     * keyboard event.</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+     *</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+     * @param event     The DOM event to check</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+     * @param aCol      An out-object for the column id.</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+     * @param aRow      An out-object for the row index.</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+     */</span>
<a href="#l5.263"></a><span id="l5.263">     getCalendarFromEvent: function cLTV_getCalendarFromEvent(event,</span>
<a href="#l5.264"></a><span id="l5.264">                                                              aCol,</span>
<a href="#l5.265"></a><span id="l5.265">                                                              aRow) {</span>
<a href="#l5.266"></a><span id="l5.266">         if (event.clientX &amp;&amp; event.clientY) {</span>
<a href="#l5.267"></a><span id="l5.267">             // If we have a client point, get the row directly from the client</span>
<a href="#l5.268"></a><span id="l5.268">             // point.</span>
<a href="#l5.269"></a><span id="l5.269">             aRow = aRow || {};</span>
<a href="#l5.270"></a><span id="l5.270">             this.treebox.getCellAt(event.clientX,</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineat">@@ -313,32 +383,38 @@ var calendarListTreeView = {</span>
<a href="#l5.272"></a><span id="l5.272">             // handler. We saved the row and column where the context menu</span>
<a href="#l5.273"></a><span id="l5.273">             // showed up in setupContextMenu().</span>
<a href="#l5.274"></a><span id="l5.274">             aCol = { value: this.mContextElement.column };</span>
<a href="#l5.275"></a><span id="l5.275">             aRow = { value: this.mContextElement.row };</span>
<a href="#l5.276"></a><span id="l5.276">         }</span>
<a href="#l5.277"></a><span id="l5.277">         return aRow &amp;&amp; aRow.value &gt; -1 &amp;&amp; this.mCalendarList[aRow.value];</span>
<a href="#l5.278"></a><span id="l5.278">     },</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+</span>
<a href="#l5.281"></a><span id="l5.281">     /**</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-     * nsITreeView methods and properties</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+     * Get the calendar from a certain index.</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+     * </span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+     * @param index     The index to get the calendar for.</span>
<a href="#l5.286"></a><span id="l5.286">      */</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-    get rowCount() {</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-        return this.mCalendarList.length;</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-    },</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-</span>
<a href="#l5.291"></a><span id="l5.291">     getCalendar: function cLTV_getCalendar(index) {</span>
<a href="#l5.292"></a><span id="l5.292">         if (index &lt; 0) {</span>
<a href="#l5.293"></a><span id="l5.293">             index = 0;</span>
<a href="#l5.294"></a><span id="l5.294">         } else if (index &gt;= this.mCalendarList.length) {</span>
<a href="#l5.295"></a><span id="l5.295">             index = (this.mCalendarList.length - 1);</span>
<a href="#l5.296"></a><span id="l5.296">         }</span>
<a href="#l5.297"></a><span id="l5.297">         return this.mCalendarList[index];</span>
<a href="#l5.298"></a><span id="l5.298">     },</span>
<a href="#l5.299"></a><span id="l5.299"> </span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+    /**</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+     * nsITreeView methods and properties</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+     */</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+    get rowCount() {</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+        return this.mCalendarList.length;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+    },</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+</span>
<a href="#l5.307"></a><span id="l5.307">     getCellProperties: function cLTV_getCellProperties(aRow, aCol, aProps) {</span>
<a href="#l5.308"></a><span id="l5.308">         this.getRowProperties(aRow, aProps);</span>
<a href="#l5.309"></a><span id="l5.309">         this.getColumnProperties(aCol, aProps);</span>
<a href="#l5.310"></a><span id="l5.310">     },</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312">     getRowProperties: function cLTV_getRowProperties(aRow, aProps) {</span>
<a href="#l5.313"></a><span id="l5.313">         var calendar = this.getCalendar(aRow);</span>
<a href="#l5.314"></a><span id="l5.314">         var composite = getCompositeCalendar();</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineat">@@ -562,16 +638,22 @@ var calendarListTreeView = {</span>
<a href="#l5.316"></a><span id="l5.316">                 tooltipText = calGetString(&quot;calendar&quot;, &quot;tooltipCalendarReadOnly&quot;, [calendar.name]);</span>
<a href="#l5.317"></a><span id="l5.317">             }</span>
<a href="#l5.318"></a><span id="l5.318"> </span>
<a href="#l5.319"></a><span id="l5.319">         }</span>
<a href="#l5.320"></a><span id="l5.320">         setElementValue(&quot;calendar-list-tooltip&quot;, tooltipText, &quot;label&quot;);</span>
<a href="#l5.321"></a><span id="l5.321">         return (tooltipText != false);</span>
<a href="#l5.322"></a><span id="l5.322">     },</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+    /**</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+     * A handler called to set up the context menu on the calendar list.</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+     *</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+     * @param event         The DOM event that caused the context menu to open.</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+     * @return              Returns true if the context menu should be shown.</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+     */</span>
<a href="#l5.330"></a><span id="l5.330">     setupContextMenu: function cLTV_setupContextMenu(event) {</span>
<a href="#l5.331"></a><span id="l5.331">         var col = {};</span>
<a href="#l5.332"></a><span id="l5.332">         var row = {};</span>
<a href="#l5.333"></a><span id="l5.333">         var calendar;</span>
<a href="#l5.334"></a><span id="l5.334">         var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l5.335"></a><span id="l5.335"> </span>
<a href="#l5.336"></a><span id="l5.336">         if (document.popupNode.localName == &quot;tree&quot;) {</span>
<a href="#l5.337"></a><span id="l5.337">             // Using VK_APPS to open the context menu will target the tree</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineat">@@ -622,16 +704,20 @@ var calendarListTreeView = {</span>
<a href="#l5.339"></a><span id="l5.339">                     .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l5.340"></a><span id="l5.340">             document.getElementById(&quot;list-calendars-context-delete&quot;)</span>
<a href="#l5.341"></a><span id="l5.341">                     .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l5.342"></a><span id="l5.342">         }</span>
<a href="#l5.343"></a><span id="l5.343">         return true;</span>
<a href="#l5.344"></a><span id="l5.344">     }</span>
<a href="#l5.345"></a><span id="l5.345"> };</span>
<a href="#l5.346"></a><span id="l5.346"> </span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+/**</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+ * An observer of the composite calendar to keep the calendar list in sync.</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+ * Implements calICompositeObserver and calIObserver.</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+ */</span>
<a href="#l5.351"></a><span id="l5.351"> var calendarManagerCompositeObserver = {</span>
<a href="#l5.352"></a><span id="l5.352">     QueryInterface: function cMCO_QueryInterface(aIID) {</span>
<a href="#l5.353"></a><span id="l5.353">         if (!aIID.equals(Components.interfaces.calICompositeObserver) &amp;&amp;</span>
<a href="#l5.354"></a><span id="l5.354">             !aIID.equals(Components.interfaces.calIObserver) &amp;&amp;</span>
<a href="#l5.355"></a><span id="l5.355">             !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l5.356"></a><span id="l5.356">             throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l5.357"></a><span id="l5.357">         }</span>
<a href="#l5.358"></a><span id="l5.358">         return this;</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineat">@@ -680,16 +766,20 @@ var calendarManagerCompositeObserver = {</span>
<a href="#l5.360"></a><span id="l5.360">                                                       aValue,</span>
<a href="#l5.361"></a><span id="l5.361">                                                       aOldValue) {</span>
<a href="#l5.362"></a><span id="l5.362">     },</span>
<a href="#l5.363"></a><span id="l5.363">     </span>
<a href="#l5.364"></a><span id="l5.364">     onPropertyDeleting: function cMO_onPropertyDeleting(aCalendar,</span>
<a href="#l5.365"></a><span id="l5.365">                                                         aName) {}</span>
<a href="#l5.366"></a><span id="l5.366"> }</span>
<a href="#l5.367"></a><span id="l5.367"> </span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+/**</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+ * An observer for the calendar manager xpcom component, to keep the calendar</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+ * list in sync.</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+ */</span>
<a href="#l5.372"></a><span id="l5.372"> var calendarManagerObserver = {</span>
<a href="#l5.373"></a><span id="l5.373">     mDefaultCalendarItem: null,</span>
<a href="#l5.374"></a><span id="l5.374"> </span>
<a href="#l5.375"></a><span id="l5.375">     QueryInterface: function cMO_QueryInterface(aIID) {</span>
<a href="#l5.376"></a><span id="l5.376">         if (!aIID.equals(Components.interfaces.calICalendarManagerObserver) &amp;&amp;</span>
<a href="#l5.377"></a><span id="l5.377">             !aIID.equals(Components.interfaces.calIObserver) &amp;&amp;</span>
<a href="#l5.378"></a><span id="l5.378">             !aIID.equals(Components.interfaces.nsIObserver) &amp;&amp;</span>
<a href="#l5.379"></a><span id="l5.379">             !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineat">@@ -713,23 +803,30 @@ var calendarManagerObserver = {</span>
<a href="#l5.381"></a><span id="l5.381">         // or changing items.</span>
<a href="#l5.382"></a><span id="l5.382">         aCalendar.addObserver(this);</span>
<a href="#l5.383"></a><span id="l5.383"> </span>
<a href="#l5.384"></a><span id="l5.384">         // Update the calendar commands for number of remote calendars and for</span>
<a href="#l5.385"></a><span id="l5.385">         // more than one calendar</span>
<a href="#l5.386"></a><span id="l5.386">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l5.387"></a><span id="l5.387">     },</span>
<a href="#l5.388"></a><span id="l5.388"> </span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+    /**</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+     * Clean up function to remove observers when closing the window</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+     */</span>
<a href="#l5.392"></a><span id="l5.392">     unload: function cMO_unload() {</span>
<a href="#l5.393"></a><span id="l5.393">         var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l5.394"></a><span id="l5.394">         for each (var calendar in calendars) {</span>
<a href="#l5.395"></a><span id="l5.395">             calendar.removeObserver(this);</span>
<a href="#l5.396"></a><span id="l5.396">         }</span>
<a href="#l5.397"></a><span id="l5.397">     },</span>
<a href="#l5.398"></a><span id="l5.398"> </span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+    /**</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+     * Disables all elements with the attribute</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+     * 'disable-when-no-writable-calendars' set to 'true'.</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+     */</span>
<a href="#l5.403"></a><span id="l5.403">     setupWritableCalendars: function cMO_setupWritableCalendars() {</span>
<a href="#l5.404"></a><span id="l5.404">         var nodes = document.getElementsByAttribute(&quot;disable-when-no-writable-calendars&quot;, &quot;true&quot;);</span>
<a href="#l5.405"></a><span id="l5.405">         for (var i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l5.406"></a><span id="l5.406">             if (this.mWritableCalendars &lt; 1) {</span>
<a href="#l5.407"></a><span id="l5.407">                 nodes[i].setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l5.408"></a><span id="l5.408">             } else {</span>
<a href="#l5.409"></a><span id="l5.409">                 nodes[i].removeAttribute(&quot;disabled&quot;);</span>
<a href="#l5.410"></a><span id="l5.410">             }</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineat">@@ -867,16 +964,19 @@ var calendarManagerObserver = {</span>
<a href="#l5.412"></a><span id="l5.412">         // extra.</span>
<a href="#l5.413"></a><span id="l5.413">         if (aPrefName.substring(0, 24) == &quot;calendar.category.color.&quot;) {</span>
<a href="#l5.414"></a><span id="l5.414">             var categoryName = aPrefName.substring(24);</span>
<a href="#l5.415"></a><span id="l5.415">             updateStyleSheetForObject(categoryName, gCachedStyleSheet);</span>
<a href="#l5.416"></a><span id="l5.416">         }</span>
<a href="#l5.417"></a><span id="l5.417">     }</span>
<a href="#l5.418"></a><span id="l5.418"> };</span>
<a href="#l5.419"></a><span id="l5.419"> </span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+/**</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+ * Opens the subscriptions dialog modally.</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+ */</span>
<a href="#l5.423"></a><span id="l5.423"> function openCalendarSubscriptionsDialog() {</span>
<a href="#l5.424"></a><span id="l5.424">     // the dialog will reset this to auto when it is done loading</span>
<a href="#l5.425"></a><span id="l5.425">     window.setCursor(&quot;wait&quot;);</span>
<a href="#l5.426"></a><span id="l5.426"> </span>
<a href="#l5.427"></a><span id="l5.427">     // open the dialog modally</span>
<a href="#l5.428"></a><span id="l5.428">     window.openDialog(&quot;chrome://calendar/content/calendar-subscriptions-dialog.xul&quot;,</span>
<a href="#l5.429"></a><span id="l5.429">                       &quot;_blank&quot;,</span>
<a href="#l5.430"></a><span id="l5.430">                       &quot;chrome,titlebar,modal,resizable&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-properties-dialog.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-properties-dialog.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -37,17 +37,18 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> /**</span>
<a href="#l6.7"></a><span id="l6.7">  * The calendar to modify, is retrieved from window.arguments[0].calendar</span>
<a href="#l6.8"></a><span id="l6.8">  */</span>
<a href="#l6.9"></a><span id="l6.9"> var gCalendar;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> /**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- * To open the window, use an object as argument. The object needs a 'calendar'</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * This function gets called when the calendar properties dialog gets opened. To</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * open the window, use an object as argument. The object needs a 'calendar'</span>
<a href="#l6.15"></a><span id="l6.15">  * attribute that passes the calendar in question.</span>
<a href="#l6.16"></a><span id="l6.16">  */</span>
<a href="#l6.17"></a><span id="l6.17"> function onLoad() {</span>
<a href="#l6.18"></a><span id="l6.18">     gCalendar = window.arguments[0].calendar;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">     document.getElementById(&quot;calendar-name&quot;).value = gCalendar.name;</span>
<a href="#l6.21"></a><span id="l6.21">     var calColor = gCalendar.getProperty('color');</span>
<a href="#l6.22"></a><span id="l6.22">     if (calColor) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -88,17 +89,19 @@ function onLoad() {</span>
<a href="#l6.24"></a><span id="l6.24">     if (!calendarDisabled) {</span>
<a href="#l6.25"></a><span id="l6.25">         document.getElementById(&quot;calendar-name&quot;).focus();</span>
<a href="#l6.26"></a><span id="l6.26">     }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">     sizeToContent();</span>
<a href="#l6.29"></a><span id="l6.29"> }</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31"> /**</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">- * Called when the dialog is accepted, to save settings</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * Called when the dialog is accepted, to save settings.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ *</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * @return      Returns true if the dialog should be closed.</span>
<a href="#l6.36"></a><span id="l6.36">  */</span>
<a href="#l6.37"></a><span id="l6.37"> function onAcceptDialog() {</span>
<a href="#l6.38"></a><span id="l6.38">     // Save calendar name</span>
<a href="#l6.39"></a><span id="l6.39">     gCalendar.name = document.getElementById(&quot;calendar-name&quot;).value;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">     // Save calendar color</span>
<a href="#l6.42"></a><span id="l6.42">     gCalendar.setProperty(&quot;color&quot;, document.getElementById(&quot;calendar-color&quot;).color);</span>
<a href="#l6.43"></a><span id="l6.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-publish-dialog.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-publish-dialog.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,9 +1,8 @@</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineminus">-/* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7">  *</span>
<a href="#l7.8"></a><span id="l7.8">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10">  * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11">  * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12">  *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineat">@@ -34,37 +33,44 @@</span>
<a href="#l7.14"></a><span id="l7.14">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.15"></a><span id="l7.15">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.16"></a><span id="l7.16">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.17"></a><span id="l7.17">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.18"></a><span id="l7.18">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.19"></a><span id="l7.19">  *</span>
<a href="#l7.20"></a><span id="l7.20">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-/* dialog stuff */</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-function loadCalendarPublishDialog()</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-{</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+// TODO This file needs cleaning up, the code is quite stale.</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+/**</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Prepares the publish dialog from the window's arguments.</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ */</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+function loadCalendarPublishDialog() {</span>
<a href="#l7.31"></a><span id="l7.31">     var calendar = window.arguments[0];</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">     window.calendar = calendar;</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">     /* set the path based on what was passed in */</span>
<a href="#l7.36"></a><span id="l7.36">     var pathTextbox = document.getElementById(&quot;publish-remotePath-textbox&quot;);</span>
<a href="#l7.37"></a><span id="l7.37">     pathTextbox.value = calendar.getProperty(&quot;remote-ics-path&quot;);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">     /* check the URL field */</span>
<a href="#l7.40"></a><span id="l7.40">     checkURL();</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">     /* set focus to the path text box*/</span>
<a href="#l7.43"></a><span id="l7.43">     pathTextbox.focus();</span>
<a href="#l7.44"></a><span id="l7.44"> }</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-function onOKCommand()</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-{</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+/**</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ * Publishes the calendar using the progress meter. The dialog should not be</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ * closed when this function returns, so false will always be returned.</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+ *</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+ * @return      Returns false, since the dialog should not be closed.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+ */</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+function onOKCommand() {</span>
<a href="#l7.56"></a><span id="l7.56">     var progressMeter = document.getElementById(&quot;publish-progressmeter&quot;);</span>
<a href="#l7.57"></a><span id="l7.57">     progressMeter.setAttribute(&quot;mode&quot;, &quot;undetermined&quot;);</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">     var pathTextbox = document.getElementById(&quot;publish-remotePath-textbox&quot;);</span>
<a href="#l7.60"></a><span id="l7.60">     var remotePath = pathTextbox.value;</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">     try {</span>
<a href="#l7.63"></a><span id="l7.63">         publishCalendar(window.calendar, remotePath); </span>
<a href="#l7.64"></a><span id="l7.64" class="difflineat">@@ -73,36 +79,46 @@ function onOKCommand()</span>
<a href="#l7.65"></a><span id="l7.65">         dump(ex + &quot;\n&quot;);</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">         progressMeter.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l7.68"></a><span id="l7.68">     }</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">     return false;</span>
<a href="#l7.71"></a><span id="l7.71"> }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-function checkURL()</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-{</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+/**</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+ * Checks if the URL in the publish-remotePath-textbox is valid.</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+ */</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+function checkURL() {</span>
<a href="#l7.79"></a><span id="l7.79">     var pathTextbox = document.getElementById(&quot;publish-remotePath-textbox&quot;);</span>
<a href="#l7.80"></a><span id="l7.80">     var publishWindow = document.getElementById(&quot;calendar-publishwindow&quot;);</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">     if (pathTextbox.value.length &gt; 0)</span>
<a href="#l7.83"></a><span id="l7.83">         publishWindow.getButton(&quot;accept&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l7.84"></a><span id="l7.84">     else</span>
<a href="#l7.85"></a><span id="l7.85">         publishWindow.getButton(&quot;accept&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l7.86"></a><span id="l7.86"> }</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-function closeDialog()</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-{</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+/**</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+ * Close the publish dialog.</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+ *</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+ * XXX This function may be broken</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+ */</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+function closeDialog() {</span>
<a href="#l7.96"></a><span id="l7.96">    self.close();</span>
<a href="#l7.97"></a><span id="l7.97"> }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-function publishCalendar(calendar, remotePath)</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-{</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+/**</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+ * Publish a calendar to a remote path. When this has been done, the accept</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+ * button changes to a close button.</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+ *</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+ * @param calendar      The calendar to publish.</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+ * @param remotePath    The remote url (as a string).</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+ */</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+function publishCalendar(calendar, remotePath) {</span>
<a href="#l7.111"></a><span id="l7.111">     var icsURL = makeURL(remotePath);</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">     var calManager = getCalendarManager();</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">     // create an ICS calendar, but don't register it</span>
<a href="#l7.116"></a><span id="l7.116">     var newCalendar = calManager.createCalendar(&quot;ics&quot;, icsURL);</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118">     var getListener = {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineat">@@ -125,18 +141,24 @@ function publishCalendar(calendar, remot</span>
<a href="#l7.120"></a><span id="l7.120">             publishWindow.getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, closeButtonLabel);</span>
<a href="#l7.121"></a><span id="l7.121">             publishWindow.getButton(&quot;accept&quot;).setAttribute(&quot;oncommand&quot;, &quot;closeDialog()&quot;);</span>
<a href="#l7.122"></a><span id="l7.122">         }</span>
<a href="#l7.123"></a><span id="l7.123">     };</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">     appendCalendars(newCalendar, [calendar], getListener);</span>
<a href="#l7.126"></a><span id="l7.126"> }</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-function appendCalendars(to, froms, listener)</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-{</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+/**</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+ * Appends one or more calendars to a target calendar.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+ *</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+ * @param to        The target calendar to write to.</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+ * @param froms     An array of source calendars.</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+ * @param listener  A calIOperationListener to call when complete.</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+ */ </span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+function appendCalendars(to, froms, listener) {</span>
<a href="#l7.138"></a><span id="l7.138">     var getListener = {</span>
<a href="#l7.139"></a><span id="l7.139">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l7.140"></a><span id="l7.140">         {</span>
<a href="#l7.141"></a><span id="l7.141">             if (listener)</span>
<a href="#l7.142"></a><span id="l7.142">                 listener.onOperationComplete(aCalendar, aStatus, aOperationType,</span>
<a href="#l7.143"></a><span id="l7.143">                                              aId, aDetail);</span>
<a href="#l7.144"></a><span id="l7.144">         },</span>
<a href="#l7.145"></a><span id="l7.145">         onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineat">@@ -151,18 +173,13 @@ function appendCalendars(to, froms, list</span>
<a href="#l7.147"></a><span id="l7.147">                     dump(&quot;adding item.. &quot; + aItems[i] + &quot;\n&quot;);</span>
<a href="#l7.148"></a><span id="l7.148">                     var itemCopy = aItems[i].clone();</span>
<a href="#l7.149"></a><span id="l7.149">                     to.addItem(itemCopy, null);</span>
<a href="#l7.150"></a><span id="l7.150">                 }  </span>
<a href="#l7.151"></a><span id="l7.151">             }</span>
<a href="#l7.152"></a><span id="l7.152">         }</span>
<a href="#l7.153"></a><span id="l7.153">     };</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-</span>
<a href="#l7.156"></a><span id="l7.156">     for each(var from in froms) {</span>
<a href="#l7.157"></a><span id="l7.157">         from.getItems(Components.interfaces.calICalendar.ITEM_FILTER_TYPE_ALL,</span>
<a href="#l7.158"></a><span id="l7.158">                       0, null, null, getListener);</span>
<a href="#l7.159"></a><span id="l7.159">     }</span>
<a href="#l7.160"></a><span id="l7.160"> }</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -34,16 +34,20 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.5"></a><span id="l8.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.6"></a><span id="l8.6">  *</span>
<a href="#l8.7"></a><span id="l8.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/**</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Sets up the summary dialog, setting all needed fields on the dialog from the</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * item received in the window arguments.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ */</span>
<a href="#l8.16"></a><span id="l8.16"> function onLoad() {</span>
<a href="#l8.17"></a><span id="l8.17">     var args = window.arguments[0];</span>
<a href="#l8.18"></a><span id="l8.18">     var item = args.calendarEvent;</span>
<a href="#l8.19"></a><span id="l8.19">     item = item.clone(); // use an own copy of the passed item</span>
<a href="#l8.20"></a><span id="l8.20">     var calendar = item.calendar;</span>
<a href="#l8.21"></a><span id="l8.21">     window.item = item;</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">     // the calling entity provides us with an object that is responsible</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineat">@@ -167,58 +171,78 @@ function onLoad() {</span>
<a href="#l8.25"></a><span id="l8.25">         document.getElementById(&quot;calendar-summary-dialog&quot;)</span>
<a href="#l8.26"></a><span id="l8.26">             .getButton(&quot;cancel&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l8.27"></a><span id="l8.27">     }</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">     window.focus();</span>
<a href="#l8.30"></a><span id="l8.30">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l8.31"></a><span id="l8.31"> }</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+/**</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * Saves any changed information to the item.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * @return      Returns true if the dialog </span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ */</span>
<a href="#l8.38"></a><span id="l8.38"> function onAccept() {</span>
<a href="#l8.39"></a><span id="l8.39">     dispose();</span>
<a href="#l8.40"></a><span id="l8.40">     if (window.readOnly) {</span>
<a href="#l8.41"></a><span id="l8.41">         return true;</span>
<a href="#l8.42"></a><span id="l8.42">     }</span>
<a href="#l8.43"></a><span id="l8.43">     var args = window.arguments[0];</span>
<a href="#l8.44"></a><span id="l8.44">     var oldItem = args.calendarEvent;</span>
<a href="#l8.45"></a><span id="l8.45">     var newItem = window.item;</span>
<a href="#l8.46"></a><span id="l8.46">     var calendar = newItem.calendar;</span>
<a href="#l8.47"></a><span id="l8.47">     saveReminder(newItem);</span>
<a href="#l8.48"></a><span id="l8.48">     args.onOk(newItem, calendar, oldItem);</span>
<a href="#l8.49"></a><span id="l8.49">     window.item = newItem;</span>
<a href="#l8.50"></a><span id="l8.50">     return true;</span>
<a href="#l8.51"></a><span id="l8.51"> }</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+/**</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+ * Called when closing the dialog and any changes should be thrown away.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ */</span>
<a href="#l8.56"></a><span id="l8.56"> function onCancel() {</span>
<a href="#l8.57"></a><span id="l8.57">     dispose();</span>
<a href="#l8.58"></a><span id="l8.58">     return true;</span>
<a href="#l8.59"></a><span id="l8.59"> }</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+/**</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+ * Sets the dialog's invitation status dropdown to the value specified by the</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+ * user's invitation status.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+ */</span>
<a href="#l8.65"></a><span id="l8.65"> function updateInvitationStatus() {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    var item = window.item;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-    var calendar = item.calendar;</span>
<a href="#l8.68"></a><span id="l8.68">     if (!window.readOnly) {</span>
<a href="#l8.69"></a><span id="l8.69">         if (window.attendee) {</span>
<a href="#l8.70"></a><span id="l8.70">             var invitationRow =</span>
<a href="#l8.71"></a><span id="l8.71">                 document.getElementById(&quot;invitation-row&quot;);</span>
<a href="#l8.72"></a><span id="l8.72">             invitationRow.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l8.73"></a><span id="l8.73">             var statusElement =</span>
<a href="#l8.74"></a><span id="l8.74">                 document.getElementById(&quot;item-participation&quot;);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-            statusElement.value = attendee.participationStatus;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+            statusElement.value = window.attendee.participationStatus;</span>
<a href="#l8.77"></a><span id="l8.77">         }</span>
<a href="#l8.78"></a><span id="l8.78">     }</span>
<a href="#l8.79"></a><span id="l8.79"> }</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+/**</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+ * When the summary dialog is showing an invitation, this function updates the</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+ * user's invitation status from the value chosen in the dialog.</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+ *</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+ * XXX rename me!</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+ */</span>
<a href="#l8.87"></a><span id="l8.87"> function updateInvitation() {</span>
<a href="#l8.88"></a><span id="l8.88">   var statusElement = document.getElementById(&quot;item-participation&quot;);</span>
<a href="#l8.89"></a><span id="l8.89">   if (window.attendee) {</span>
<a href="#l8.90"></a><span id="l8.90">       window.attendee.participationStatus = statusElement.value;</span>
<a href="#l8.91"></a><span id="l8.91">   }</span>
<a href="#l8.92"></a><span id="l8.92"> }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+/**</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+ * Updates the dialog w.r.t recurrence, i.e shows a text describing the item's</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+ * recurrence)</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ */</span>
<a href="#l8.98"></a><span id="l8.98"> function updateRepeatDetails() {</span>
<a href="#l8.99"></a><span id="l8.99">     var args = window.arguments[0];</span>
<a href="#l8.100"></a><span id="l8.100">     var item = args.calendarEvent;</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">     // step to the parent (in order to show the</span>
<a href="#l8.103"></a><span id="l8.103">     // recurrence info which is stored at the parent).</span>
<a href="#l8.104"></a><span id="l8.104">     item = item.parentItem;</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106" class="difflineat">@@ -262,16 +286,20 @@ function updateRepeatDetails() {</span>
<a href="#l8.107"></a><span id="l8.107">                                            .cloneNode(true);</span>
<a href="#l8.108"></a><span id="l8.108">                 repeatDetails.appendChild(newNode);</span>
<a href="#l8.109"></a><span id="l8.109">             }</span>
<a href="#l8.110"></a><span id="l8.110">             repeatDetails.childNodes[i].value = lines[i];</span>
<a href="#l8.111"></a><span id="l8.111">         }</span>
<a href="#l8.112"></a><span id="l8.112">     }</span>
<a href="#l8.113"></a><span id="l8.113"> }</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+/**</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+ * Updates the attendee listbox, displaying all attendees invited to the</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+ * window's item.</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+ */</span>
<a href="#l8.119"></a><span id="l8.119"> function updateAttendees() {</span>
<a href="#l8.120"></a><span id="l8.120">     var args = window.arguments[0];</span>
<a href="#l8.121"></a><span id="l8.121">     var item = args.calendarEvent;</span>
<a href="#l8.122"></a><span id="l8.122">     var attendees = item.getAttendees({});</span>
<a href="#l8.123"></a><span id="l8.123">     if (attendees &amp;&amp; attendees.length) {</span>
<a href="#l8.124"></a><span id="l8.124">         document.getElementById(&quot;item-attendees&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l8.125"></a><span id="l8.125">         var listbox = document.getElementById(&quot;item-attendee-listbox&quot;);</span>
<a href="#l8.126"></a><span id="l8.126">         var itemNode = listbox.getElementsByTagName(&quot;listitem&quot;)[0];</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineat">@@ -305,27 +333,40 @@ function updateAttendees() {</span>
<a href="#l8.128"></a><span id="l8.128">             if (page &gt; 1) {</span>
<a href="#l8.129"></a><span id="l8.129">               page = 0;</span>
<a href="#l8.130"></a><span id="l8.130">               line++;</span>
<a href="#l8.131"></a><span id="l8.131">             }</span>
<a href="#l8.132"></a><span id="l8.132">         }</span>
<a href="#l8.133"></a><span id="l8.133">     }</span>
<a href="#l8.134"></a><span id="l8.134"> }</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+/**</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+ * Updates the reminder, called when a reminder has been selected in the</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+ * menulist.</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+ */</span>
<a href="#l8.140"></a><span id="l8.140"> function updateReminder() {</span>
<a href="#l8.141"></a><span id="l8.141">     commonUpdateReminder();</span>
<a href="#l8.142"></a><span id="l8.142"> }</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+/**</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+ * Browse the item's attached URL.</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+ *</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+ * XXX This function is broken, should be fixed in bug 471967</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+ */</span>
<a href="#l8.149"></a><span id="l8.149"> function browseDocument() {</span>
<a href="#l8.150"></a><span id="l8.150">     var args = window.arguments[0];</span>
<a href="#l8.151"></a><span id="l8.151">     var item = args.calendarEvent;</span>
<a href="#l8.152"></a><span id="l8.152">     var url = item.getProperty(&quot;URL&quot;)</span>
<a href="#l8.153"></a><span id="l8.153">     launchBrowser(url);</span>
<a href="#l8.154"></a><span id="l8.154"> }</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+/**</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+ * Extracts the item's organizer and opens a compose window to send the</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+ * organizer an email.</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+ */</span>
<a href="#l8.160"></a><span id="l8.160"> function sendMailToOrganizer() {</span>
<a href="#l8.161"></a><span id="l8.161">     var args = window.arguments[0];</span>
<a href="#l8.162"></a><span id="l8.162">     var item = args.calendarEvent;</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">     var organizer = item.organizer;</span>
<a href="#l8.165"></a><span id="l8.165">     if (organizer) {</span>
<a href="#l8.166"></a><span id="l8.166">         if (organizer.id &amp;&amp; organizer.id.length) {</span>
<a href="#l8.167"></a><span id="l8.167">             var email = organizer.id.replace(/^mailto:/i, &quot;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder-todo.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder-todo.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -39,29 +39,27 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.5"></a><span id="l9.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.6"></a><span id="l9.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.7"></a><span id="l9.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.8"></a><span id="l9.8">  *</span>
<a href="#l9.9"></a><span id="l9.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- *   Called when the calendar is loaded</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * Called when the window is loaded to set up the unifinder-todo.</span>
<a href="#l9.14"></a><span id="l9.14">  */</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-</span>
<a href="#l9.16"></a><span id="l9.16"> function prepareCalendarToDoUnifinder() {</span>
<a href="#l9.17"></a><span id="l9.17">     if (isSunbird()) {</span>
<a href="#l9.18"></a><span id="l9.18">         document.getElementById(&quot;todo-label&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l9.19"></a><span id="l9.19">     }</span>
<a href="#l9.20"></a><span id="l9.20">     toDoUnifinderRefresh();</span>
<a href="#l9.21"></a><span id="l9.21"> }</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> /**</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">- *   Called by event observers to update the display</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ * Called by event observers to update the task display</span>
<a href="#l9.26"></a><span id="l9.26">  */</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-</span>
<a href="#l9.28"></a><span id="l9.28"> function toDoUnifinderRefresh() {</span>
<a href="#l9.29"></a><span id="l9.29">     // Set up hiding completed tasks for the unifinder-todo tree</span>
<a href="#l9.30"></a><span id="l9.30">     var showCompleted = document.getElementById(&quot;show-completed-checkbox&quot;).checked;</span>
<a href="#l9.31"></a><span id="l9.31">     var tree = document.getElementById(&quot;unifinder-todo-tree&quot;);</span>
<a href="#l9.32"></a><span id="l9.32">     tree.showCompleted = showCompleted;</span>
<a href="#l9.33"></a><span id="l9.33">     tree.refresh();</span>
<a href="#l9.34"></a><span id="l9.34"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -47,43 +47,58 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> /**</span>
<a href="#l10.8"></a><span id="l10.8">  * U N I F I N D E R</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * This is a hacked in interface to the unifinder. We will need to</span>
<a href="#l10.11"></a><span id="l10.11">  * improve this to make it usable in general.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * NOTE: Including this file will cause a load handler to be added to the</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * window.</span>
<a href="#l10.15"></a><span id="l10.15">  */</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> // Set this to true when the calendar event tree is clicked to allow for</span>
<a href="#l10.20"></a><span id="l10.20"> // multiple selection</span>
<a href="#l10.21"></a><span id="l10.21"> var gCalendarEventTreeClicked = false;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> // Store the start and enddate, because the providers can't be trusted when</span>
<a href="#l10.24"></a><span id="l10.24"> // dealing with all-day events. So we need to filter later. See bug 306157</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> var kDefaultTimezone;</span>
<a href="#l10.27"></a><span id="l10.27"> var gUnifinderNeedsRefresh = true;</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+/**</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * Checks if the unifinder is hidden</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ *</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * @return      Returns true if the unifinder is hidden.</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ */</span>
<a href="#l10.34"></a><span id="l10.34"> function isUnifinderHidden() {</span>
<a href="#l10.35"></a><span id="l10.35">     return document.getElementById(&quot;bottom-events-box&quot;).hidden;</span>
<a href="#l10.36"></a><span id="l10.36"> }</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+/**</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ * Returns the current filter applied to the unifinder.</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ *</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+ * @return      The string name of the applied filter.</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+ */</span>
<a href="#l10.43"></a><span id="l10.43"> function getCurrentUnifinderFilter() {</span>
<a href="#l10.44"></a><span id="l10.44">     return document.getElementById(&quot;event-filter-menulist&quot;).selectedItem.value;</span>
<a href="#l10.45"></a><span id="l10.45"> }</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47"> /**</span>
<a href="#l10.48"></a><span id="l10.48">  * Observer for the calendar event data source. This keeps the unifinder</span>
<a href="#l10.49"></a><span id="l10.49">  * display up to date when the calendar event data is changed</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ *</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ * @see calIObserver</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ * @see calICompositeObserver</span>
<a href="#l10.53"></a><span id="l10.53">  */</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-</span>
<a href="#l10.55"></a><span id="l10.55"> var unifinderObserver = {</span>
<a href="#l10.56"></a><span id="l10.56">     mInBatch: false,</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58">     QueryInterface: function uO_QueryInterface (aIID) {</span>
<a href="#l10.59"></a><span id="l10.59">         if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l10.60"></a><span id="l10.60">             !aIID.equals(Components.interfaces.calICompositeObserver) &amp;&amp;</span>
<a href="#l10.61"></a><span id="l10.61">             !aIID.equals(Components.interfaces.calIObserver)) {</span>
<a href="#l10.62"></a><span id="l10.62">             throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineat">@@ -132,41 +147,16 @@ var unifinderObserver = {</span>
<a href="#l10.64"></a><span id="l10.64">     },</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66">     onDeleteItem: function uO_onDeleteItem(aDeletedItem) {</span>
<a href="#l10.67"></a><span id="l10.67">         if (isEvent(aDeletedItem) &amp;&amp; !this.mInBatch &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l10.68"></a><span id="l10.68">             this.removeItemFromTree(aDeletedItem);</span>
<a href="#l10.69"></a><span id="l10.69">         }</span>
<a href="#l10.70"></a><span id="l10.70">     },</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    // It is safe to call these for any event.  The functions will determine</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    // whether or not anything actually needs to be done to the tree</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-    addItemToTree: function uO_addItemToTree(aItem) {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-        var items;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-        var filter = unifinderTreeView.mFilter;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-        if (filter.startDate &amp;&amp; filter.endDate) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-            items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-        } else {</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-            items = [aItem];</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-        }</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-        unifinderTreeView.addItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-    },</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-    removeItemFromTree: function uO_removeItemFromTree(aItem) {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-        var items;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-        var filter = unifinderTreeView.mFilter;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-        if (filter.startDate &amp;&amp; filter.endDate &amp;&amp; (aItem.parentItem == aItem)) {</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-            items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-        } else {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-            items = [aItem];</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-        }</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-        // XXX: do we really still need this, we are always checking it in the refreshInternal</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-        unifinderTreeView.removeItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-    },</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-</span>
<a href="#l10.97"></a><span id="l10.97">     onError: function uO_onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99">     onPropertyChanged: function uO_onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l10.100"></a><span id="l10.100">         switch (aName) {</span>
<a href="#l10.101"></a><span id="l10.101">             case &quot;disabled&quot;:</span>
<a href="#l10.102"></a><span id="l10.102">                 refreshEventTree();</span>
<a href="#l10.103"></a><span id="l10.103">                 break;</span>
<a href="#l10.104"></a><span id="l10.104">         }</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineat">@@ -185,21 +175,60 @@ var unifinderObserver = {</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107">     onCalendarRemoved: function uO_onCalendarRemoved(aDeletedCalendar) {</span>
<a href="#l10.108"></a><span id="l10.108">         // TODO only remove such items that belong to the calendar</span>
<a href="#l10.109"></a><span id="l10.109">         if (!this.mInBatch &amp;&amp; !aDeletedCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l10.110"></a><span id="l10.110">             refreshEventTree();</span>
<a href="#l10.111"></a><span id="l10.111">         }</span>
<a href="#l10.112"></a><span id="l10.112">     },</span>
<a href="#l10.113"></a><span id="l10.113"> </span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-    onDefaultCalendarChanged: function uO_onDefaultCalendarChanged(aNewDefaultCalendar) {}</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    onDefaultCalendarChanged: function uO_onDefaultCalendarChanged(aNewDefaultCalendar) {},</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    /**</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+     * Add an unifinder item to the tree. It is safe to call these for any</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+     * event. The functions will determine whether or not anything actually</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+     * needs to be done to the tree.</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+     *</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+     * @return aItem        The item to add to the tree.</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+     */</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+    addItemToTree: function uO_addItemToTree(aItem) {</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        var items;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+        var filter = unifinderTreeView.mFilter;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+        if (filter.startDate &amp;&amp; filter.endDate) {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+            items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+        } else {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+            items = [aItem];</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+        }</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+        unifinderTreeView.addItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+    },</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    /**</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+     * Remove an item from the unifinder tree. It is safe to call these for any</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+     * event. The functions will determine whether or not anything actually</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+     * needs to be done to the tree.</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+     *</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+     * @return aItem        The item to remove from the tree.</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+     */</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    removeItemFromTree: function uO_removeItemFromTree(aItem) {</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+        var items;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+        var filter = unifinderTreeView.mFilter;</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+        if (filter.startDate &amp;&amp; filter.endDate &amp;&amp; (aItem.parentItem == aItem)) {</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+            items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate, {});</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+        } else {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+            items = [aItem];</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+        }</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+        // XXX: do we really still need this, we are always checking it in the refreshInternal</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+        unifinderTreeView.removeItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+    }</span>
<a href="#l10.154"></a><span id="l10.154"> };</span>
<a href="#l10.155"></a><span id="l10.155"> </span>
<a href="#l10.156"></a><span id="l10.156"> /**</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">- * Called when the calendar is loaded</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+ * Called when the window is loaded to prepare the unifinder. This function is</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+ * used to add observers, event listeners, etc.</span>
<a href="#l10.160"></a><span id="l10.160">  */</span>
<a href="#l10.161"></a><span id="l10.161"> function prepareCalendarUnifinder() {</span>
<a href="#l10.162"></a><span id="l10.162">     // Only load once</span>
<a href="#l10.163"></a><span id="l10.163">     window.removeEventListener(&quot;load&quot;, prepareCalendarUnifinder, false);</span>
<a href="#l10.164"></a><span id="l10.164">     var unifinderTree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">     // Check if this is not the hidden window, which has no UI elements</span>
<a href="#l10.167"></a><span id="l10.167">     if (unifinderTree) {</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineat">@@ -242,17 +271,18 @@ function prepareCalendarUnifinder() {</span>
<a href="#l10.169"></a><span id="l10.169">         if (!isUnifinderHidden()) {</span>
<a href="#l10.170"></a><span id="l10.170">             gUnifinderNeedsRefresh = false;</span>
<a href="#l10.171"></a><span id="l10.171">             refreshEventTree();</span>
<a href="#l10.172"></a><span id="l10.172">         }</span>
<a href="#l10.173"></a><span id="l10.173">     }</span>
<a href="#l10.174"></a><span id="l10.174"> }</span>
<a href="#l10.175"></a><span id="l10.175"> </span>
<a href="#l10.176"></a><span id="l10.176"> /**</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">- * Called when the calendar is unloaded</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+ * Called when the window is unloaded to clean up any observers and listeners</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+ * added.</span>
<a href="#l10.180"></a><span id="l10.180">  */</span>
<a href="#l10.181"></a><span id="l10.181"> function finishCalendarUnifinder() {</span>
<a href="#l10.182"></a><span id="l10.182">     var ccalendar = getCompositeCalendar();</span>
<a href="#l10.183"></a><span id="l10.183">     ccalendar.removeObserver(unifinderObserver);</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185">     var viewDeck = getViewDeck();</span>
<a href="#l10.186"></a><span id="l10.186">     if (viewDeck) {</span>
<a href="#l10.187"></a><span id="l10.187">         viewDeck.removeEventListener(&quot;dayselect&quot;, unifinderDaySelect, false);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineat">@@ -267,39 +297,47 @@ function finishCalendarUnifinder() {</span>
<a href="#l10.189"></a><span id="l10.189">         unifinderTree.setAttribute(&quot;sort-direction&quot;,unifinderTree.sortDirection);</span>
<a href="#l10.190"></a><span id="l10.190">     } else {</span>
<a href="#l10.191"></a><span id="l10.191">         unifinderTree.removeAttribute(&quot;sort-active&quot;);</span>
<a href="#l10.192"></a><span id="l10.192">         unifinderTree.removeAttribute(&quot;sort-direction&quot;);</span>
<a href="#l10.193"></a><span id="l10.193">     }</span>
<a href="#l10.194"></a><span id="l10.194"> }</span>
<a href="#l10.195"></a><span id="l10.195"> </span>
<a href="#l10.196"></a><span id="l10.196"> /**</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">- * Event listeners for dayselect and itemselect events</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+ * Event listener for the view deck's dayselect event.</span>
<a href="#l10.199"></a><span id="l10.199">  */</span>
<a href="#l10.200"></a><span id="l10.200"> function unifinderDaySelect() {</span>
<a href="#l10.201"></a><span id="l10.201">     if (getCurrentUnifinderFilter() == &quot;current&quot;) {</span>
<a href="#l10.202"></a><span id="l10.202">         refreshEventTree();</span>
<a href="#l10.203"></a><span id="l10.203">     }</span>
<a href="#l10.204"></a><span id="l10.204"> }</span>
<a href="#l10.205"></a><span id="l10.205"> </span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+/**</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+ * Event listener for the view deck's itemselect event.</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+ */</span>
<a href="#l10.209"></a><span id="l10.209"> function unifinderItemSelect(aEvent) {</span>
<a href="#l10.210"></a><span id="l10.210">     unifinderTreeView.setSelectedItems(aEvent.detail);</span>
<a href="#l10.211"></a><span id="l10.211"> }</span>
<a href="#l10.212"></a><span id="l10.212"> </span>
<a href="#l10.213"></a><span id="l10.213"> /**</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">- * Helper function to display event datetimes in the unifinder</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+ * Helper function to display event datetimes in the unifinder.</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+ *</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+ * @param aDatetime     A calIDateTime object to format.</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+ * @return              The passed date's formatted in the default timezone.</span>
<a href="#l10.219"></a><span id="l10.219">  */</span>
<a href="#l10.220"></a><span id="l10.220"> function formatUnifinderEventDateTime(aDatetime) {</span>
<a href="#l10.221"></a><span id="l10.221">     var dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l10.222"></a><span id="l10.222">                                   .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l10.223"></a><span id="l10.223">     return dateFormatter.formatDateTime(aDatetime.getInTimezone(kDefaultTimezone));</span>
<a href="#l10.224"></a><span id="l10.224"> }</span>
<a href="#l10.225"></a><span id="l10.225"> </span>
<a href="#l10.226"></a><span id="l10.226"> /**</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">- * Unifinder event handlers (click,select,etc)</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+ * Handler function for double clicking the unifinder.</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+ *</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+ * @param event         The DOM doubleclick event.</span>
<a href="#l10.231"></a><span id="l10.231">  */</span>
<a href="#l10.232"></a><span id="l10.232"> function unifinderDoubleClick(event) {</span>
<a href="#l10.233"></a><span id="l10.233">     // We only care about button 0 (left click) events</span>
<a href="#l10.234"></a><span id="l10.234">     if (event.button != 0) {</span>
<a href="#l10.235"></a><span id="l10.235">         return;</span>
<a href="#l10.236"></a><span id="l10.236">     }</span>
<a href="#l10.237"></a><span id="l10.237"> </span>
<a href="#l10.238"></a><span id="l10.238">     // find event by id</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineat">@@ -307,16 +345,21 @@ function unifinderDoubleClick(event) {</span>
<a href="#l10.240"></a><span id="l10.240"> </span>
<a href="#l10.241"></a><span id="l10.241">     if (calendarEvent != null) {</span>
<a href="#l10.242"></a><span id="l10.242">         modifyEventWithDialog(calendarEvent, null, true);</span>
<a href="#l10.243"></a><span id="l10.243">     } else {</span>
<a href="#l10.244"></a><span id="l10.244">         createEventWithDialog();</span>
<a href="#l10.245"></a><span id="l10.245">     }</span>
<a href="#l10.246"></a><span id="l10.246"> }</span>
<a href="#l10.247"></a><span id="l10.247"> </span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+/**</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+ * Handler function for selection in the unifinder.</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+ *</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+ * @param event         The DOM selection event.</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+ */</span>
<a href="#l10.253"></a><span id="l10.253"> function unifinderSelect(event) {</span>
<a href="#l10.254"></a><span id="l10.254">     var tree = unifinderTreeView.treeElement;</span>
<a href="#l10.255"></a><span id="l10.255">     if (!tree.view.selection || tree.view.selection.getRangeCount() == 0) {</span>
<a href="#l10.256"></a><span id="l10.256">         return;</span>
<a href="#l10.257"></a><span id="l10.257">     }</span>
<a href="#l10.258"></a><span id="l10.258"> </span>
<a href="#l10.259"></a><span id="l10.259">     var selectedItems = [];</span>
<a href="#l10.260"></a><span id="l10.260">     gCalendarEventTreeClicked = true;</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineat">@@ -346,16 +389,21 @@ function unifinderSelect(event) {</span>
<a href="#l10.262"></a><span id="l10.262">     // Set up the selected items in the view. Pass in true, so we don't end</span>
<a href="#l10.263"></a><span id="l10.263">     // up in a circular loop</span>
<a href="#l10.264"></a><span id="l10.264">     currentView().setSelectedItems(selectedItems.length, selectedItems, true);</span>
<a href="#l10.265"></a><span id="l10.265">     currentView().centerSelectedItems();</span>
<a href="#l10.266"></a><span id="l10.266">     calendarController.onSelectionChanged({detail: selectedItems});</span>
<a href="#l10.267"></a><span id="l10.267">     document.getElementById(&quot;unifinder-search-results-tree&quot;).focus();</span>
<a href="#l10.268"></a><span id="l10.268"> }</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+/**</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+ * Handler function for keypress in the unifinder.</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+ *</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+ * @param aEvent        The DOM Key event.</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+ */</span>
<a href="#l10.275"></a><span id="l10.275"> function unifinderKeyPress(aEvent) {</span>
<a href="#l10.276"></a><span id="l10.276">     const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l10.277"></a><span id="l10.277">     switch (aEvent.keyCode) {</span>
<a href="#l10.278"></a><span id="l10.278">         case 13:</span>
<a href="#l10.279"></a><span id="l10.279">             // Enter, edit the event</span>
<a href="#l10.280"></a><span id="l10.280">             editSelectedEvents();</span>
<a href="#l10.281"></a><span id="l10.281">             aEvent.stopPropagation();</span>
<a href="#l10.282"></a><span id="l10.282">             aEvent.preventDefault();</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineat">@@ -378,20 +426,26 @@ var unifinderTreeView = {</span>
<a href="#l10.284"></a><span id="l10.284">     treeElement: null,</span>
<a href="#l10.285"></a><span id="l10.285">     doingSelection: false,</span>
<a href="#l10.286"></a><span id="l10.286">     mFilter: null,</span>
<a href="#l10.287"></a><span id="l10.287">     </span>
<a href="#l10.288"></a><span id="l10.288"> </span>
<a href="#l10.289"></a><span id="l10.289">     mSelectedColumn: null,</span>
<a href="#l10.290"></a><span id="l10.290">     sortDirection: null,</span>
<a href="#l10.291"></a><span id="l10.291"> </span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    /**</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+     * Returns the currently selected column in the unifinder (used for sorting).</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+     */</span>
<a href="#l10.295"></a><span id="l10.295">     get selectedColumn uTV_getSelectedColumn() {</span>
<a href="#l10.296"></a><span id="l10.296">         return this.mSelectedColumn;</span>
<a href="#l10.297"></a><span id="l10.297">     },</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+    </span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+    /**</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+     * Sets the currently selected column in the unifinder (used for sorting).</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+     */</span>
<a href="#l10.303"></a><span id="l10.303">     set selectedColumn uTV_setSelectedColumn(aCol) {</span>
<a href="#l10.304"></a><span id="l10.304">         var tree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l10.305"></a><span id="l10.305">         var treecols = tree.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l10.306"></a><span id="l10.306">         for (var i = 0; i &lt; treecols.length; i++) {</span>
<a href="#l10.307"></a><span id="l10.307">             var col = treecols[i];</span>
<a href="#l10.308"></a><span id="l10.308">             if (col.getAttribute(&quot;sortActive&quot;)) {</span>
<a href="#l10.309"></a><span id="l10.309">                   col.removeAttribute(&quot;sortActive&quot;);</span>
<a href="#l10.310"></a><span id="l10.310">                   col.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineat">@@ -406,115 +460,161 @@ var unifinderTreeView = {</span>
<a href="#l10.312"></a><span id="l10.312"> </span>
<a href="#l10.313"></a><span id="l10.313">     /**</span>
<a href="#l10.314"></a><span id="l10.314">      * Event functions</span>
<a href="#l10.315"></a><span id="l10.315">      */</span>
<a href="#l10.316"></a><span id="l10.316"> </span>
<a href="#l10.317"></a><span id="l10.317">     eventArray: [],</span>
<a href="#l10.318"></a><span id="l10.318">     eventIndexMap: {},</span>
<a href="#l10.319"></a><span id="l10.319"> </span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+    /**</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+     * Add an item to the unifinder tree.</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+     *</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+     * @param aItemArray        An array of items to add.</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+     * @param aDontSort         If true, the items will only be appended.</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+     */</span>
<a href="#l10.326"></a><span id="l10.326">     addItems: function uTV_addItems(aItemArray, aDontSort) {</span>
<a href="#l10.327"></a><span id="l10.327">         this.eventArray = this.eventArray.concat(aItemArray);</span>
<a href="#l10.328"></a><span id="l10.328">         if (this.tree) {</span>
<a href="#l10.329"></a><span id="l10.329">             var newCount = this.eventArray.length - aItemArray.length - 1;</span>
<a href="#l10.330"></a><span id="l10.330">             this.tree.rowCountChanged(newCount, aItemArray.length);</span>
<a href="#l10.331"></a><span id="l10.331">         }</span>
<a href="#l10.332"></a><span id="l10.332"> </span>
<a href="#l10.333"></a><span id="l10.333">         if (aDontSort) {</span>
<a href="#l10.334"></a><span id="l10.334">             this.calculateIndexMap();</span>
<a href="#l10.335"></a><span id="l10.335">         } else {</span>
<a href="#l10.336"></a><span id="l10.336">             this.sortItems();</span>
<a href="#l10.337"></a><span id="l10.337">         }</span>
<a href="#l10.338"></a><span id="l10.338">     },</span>
<a href="#l10.339"></a><span id="l10.339"> </span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+    /**</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+     * Remove items from the unifinder tree.</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+     *</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+     * @param aItemArray        An array of items to remove.</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+     */</span>
<a href="#l10.345"></a><span id="l10.345">     removeItems: function uTV_removeItems(aItemArray) {</span>
<a href="#l10.346"></a><span id="l10.346">         for each (var item in aItemArray) {</span>
<a href="#l10.347"></a><span id="l10.347">             var row = this.getItemRow(item);</span>
<a href="#l10.348"></a><span id="l10.348">             if (row &gt; -1) {</span>
<a href="#l10.349"></a><span id="l10.349">                 this.eventArray.splice(row, 1);</span>
<a href="#l10.350"></a><span id="l10.350">                 if (this.tree) {</span>
<a href="#l10.351"></a><span id="l10.351">                     this.tree.rowCountChanged(row, -1);</span>
<a href="#l10.352"></a><span id="l10.352">                 }</span>
<a href="#l10.353"></a><span id="l10.353">             }</span>
<a href="#l10.354"></a><span id="l10.354">         }</span>
<a href="#l10.355"></a><span id="l10.355">         this.calculateIndexMap();</span>
<a href="#l10.356"></a><span id="l10.356">     },</span>
<a href="#l10.357"></a><span id="l10.357"> </span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+    /**</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+     * Clear all items from the unifinder.</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+     */</span>
<a href="#l10.361"></a><span id="l10.361">     clearItems: function uTV_clearItems() {</span>
<a href="#l10.362"></a><span id="l10.362">         var oldCount = this.eventArray.length;</span>
<a href="#l10.363"></a><span id="l10.363">         this.eventArray = [];</span>
<a href="#l10.364"></a><span id="l10.364">         if (this.tree) {</span>
<a href="#l10.365"></a><span id="l10.365">             this.tree.rowCountChanged(0, -oldCount);</span>
<a href="#l10.366"></a><span id="l10.366">         }</span>
<a href="#l10.367"></a><span id="l10.367">         this.calculateIndexMap();</span>
<a href="#l10.368"></a><span id="l10.368">     },</span>
<a href="#l10.369"></a><span id="l10.369"> </span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+    /**</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+     * Sets the items that should be in the unifinder. This removes all items</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+     * that were previously in the unifinder.</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+     */</span>
<a href="#l10.374"></a><span id="l10.374">     setItems: function uTV_setItems(aItemArray, aDontSort) {</span>
<a href="#l10.375"></a><span id="l10.375">         var oldCount = this.eventArray.length;</span>
<a href="#l10.376"></a><span id="l10.376">         this.eventArray = aItemArray.slice(0);</span>
<a href="#l10.377"></a><span id="l10.377">         if (this.tree) {</span>
<a href="#l10.378"></a><span id="l10.378">             this.tree.rowCountChanged(0, (this.eventArray.length - oldCount));</span>
<a href="#l10.379"></a><span id="l10.379">         }</span>
<a href="#l10.380"></a><span id="l10.380">        </span>
<a href="#l10.381"></a><span id="l10.381">         if (aDontSort) {</span>
<a href="#l10.382"></a><span id="l10.382">             this.calculateIndexMap();</span>
<a href="#l10.383"></a><span id="l10.383">         } else {</span>
<a href="#l10.384"></a><span id="l10.384">             this.sortItems();</span>
<a href="#l10.385"></a><span id="l10.385">         }</span>
<a href="#l10.386"></a><span id="l10.386">     },</span>
<a href="#l10.387"></a><span id="l10.387"> </span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+    /**</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+     * Recalculate the index map that improves performance when accessing</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+     * unifinder items. This is usually done automatically when adding/removing</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+     * items.</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+     */</span>
<a href="#l10.393"></a><span id="l10.393">     calculateIndexMap: function uTV_calculateIndexMap() {</span>
<a href="#l10.394"></a><span id="l10.394">         this.eventIndexMap = {};</span>
<a href="#l10.395"></a><span id="l10.395">         for (var i = 0 ; i &lt; this.eventArray.length; i++) {</span>
<a href="#l10.396"></a><span id="l10.396">             this.eventIndexMap[this.eventArray[i].hashId] = i;</span>
<a href="#l10.397"></a><span id="l10.397">         }</span>
<a href="#l10.398"></a><span id="l10.398"> </span>
<a href="#l10.399"></a><span id="l10.399">         if (this.tree) {</span>
<a href="#l10.400"></a><span id="l10.400">             this.tree.invalidate();</span>
<a href="#l10.401"></a><span id="l10.401">         }</span>
<a href="#l10.402"></a><span id="l10.402">     },</span>
<a href="#l10.403"></a><span id="l10.403"> </span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+    /**</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+     * Sort the items in the unifinder by the currently selected column.</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+     */</span>
<a href="#l10.407"></a><span id="l10.407">     sortItems: function uTV_sortItems() {</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-        if( this.selectedColumn) {</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+        if (this.selectedColumn) {</span>
<a href="#l10.410"></a><span id="l10.410">             var modifier = (this.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l10.411"></a><span id="l10.411">             var sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l10.412"></a><span id="l10.412">             var sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l10.413"></a><span id="l10.413">             // sort (key,item) entries</span>
<a href="#l10.414"></a><span id="l10.414">             cal.sortEntry.mSortKey = sortKey;</span>
<a href="#l10.415"></a><span id="l10.415">             cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l10.416"></a><span id="l10.416">             var entries = this.eventArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l10.417"></a><span id="l10.417">             entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l10.418"></a><span id="l10.418">             this.eventArray = entries.map(cal.sortEntryItem);</span>
<a href="#l10.419"></a><span id="l10.419">         }</span>
<a href="#l10.420"></a><span id="l10.420">         this.calculateIndexMap();</span>
<a href="#l10.421"></a><span id="l10.421">     },</span>
<a href="#l10.422"></a><span id="l10.422"> </span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+    /**</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+     * Get the index of the row associated with the passed item.</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+     *</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+     * @param item      The item to search for.</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+     * @return          The row index of the passed item.</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+     */</span>
<a href="#l10.429"></a><span id="l10.429">     getItemRow: function uTV_getItemRow(item) {</span>
<a href="#l10.430"></a><span id="l10.430">         if (this.eventIndexMap[item.hashId] === undefined) {</span>
<a href="#l10.431"></a><span id="l10.431">             return -1;</span>
<a href="#l10.432"></a><span id="l10.432">         }</span>
<a href="#l10.433"></a><span id="l10.433">         return this.eventIndexMap[item.hashId];</span>
<a href="#l10.434"></a><span id="l10.434">     },</span>
<a href="#l10.435"></a><span id="l10.435"> </span>
<a href="#l10.436"></a><span id="l10.436" class="difflineplus">+    /**</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+     * Get the item at the given row index.</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+     *</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+     * @param item      The row index to get the item for.</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+     * @return          The item at the given row.</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+     */</span>
<a href="#l10.442"></a><span id="l10.442">     getItemAt: function uTV_getItemAt(aRow) {</span>
<a href="#l10.443"></a><span id="l10.443">         return this.eventArray[aRow];</span>
<a href="#l10.444"></a><span id="l10.444">     },</span>
<a href="#l10.445"></a><span id="l10.445"> </span>
<a href="#l10.446"></a><span id="l10.446">     /**</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-     * Get the calendar item from the given event</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+     * Get the calendar item from the given DOM event</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+     *</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+     * @param event     The DOM mouse event to get the item for.</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+     * @return          The item under the mouse position.</span>
<a href="#l10.452"></a><span id="l10.452">      */</span>
<a href="#l10.453"></a><span id="l10.453">     getItemFromEvent: function uTV_getItemFromEvent(event) {</span>
<a href="#l10.454"></a><span id="l10.454">         var row = this.tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l10.455"></a><span id="l10.455"> </span>
<a href="#l10.456"></a><span id="l10.456">         if (row &gt; -1) {</span>
<a href="#l10.457"></a><span id="l10.457">             return this.getItemAt(row);</span>
<a href="#l10.458"></a><span id="l10.458">         }</span>
<a href="#l10.459"></a><span id="l10.459">         return null;</span>
<a href="#l10.460"></a><span id="l10.460">     },</span>
<a href="#l10.461"></a><span id="l10.461"> </span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+    /**</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+     * Change the selection in the unifinder.</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+     *</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+     * @param aItemArray        An array of items to select.</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineplus">+     */</span>
<a href="#l10.467"></a><span id="l10.467">     setSelectedItems: function uTV_setSelectedItems(aItemArray) {</span>
<a href="#l10.468"></a><span id="l10.468">         if (this.doingSelection || !this.tree) {</span>
<a href="#l10.469"></a><span id="l10.469">             return;</span>
<a href="#l10.470"></a><span id="l10.470">         }</span>
<a href="#l10.471"></a><span id="l10.471"> </span>
<a href="#l10.472"></a><span id="l10.472">         this.doingSelection = true;</span>
<a href="#l10.473"></a><span id="l10.473"> </span>
<a href="#l10.474"></a><span id="l10.474">         // If no items were passed, get the selected items from the view.</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineat">@@ -546,32 +646,37 @@ var unifinderTreeView = {</span>
<a href="#l10.476"></a><span id="l10.476">                 this.tree.view.selection.rangedSelect(row, row, true);</span>
<a href="#l10.477"></a><span id="l10.477">             }</span>
<a href="#l10.478"></a><span id="l10.478">         }</span>
<a href="#l10.479"></a><span id="l10.479"> </span>
<a href="#l10.480"></a><span id="l10.480">         // This needs to be in a setTimeout</span>
<a href="#l10.481"></a><span id="l10.481">         setTimeout(function() { unifinderTreeView.resetAllowSelection(); }, 1);</span>
<a href="#l10.482"></a><span id="l10.482">     },</span>
<a href="#l10.483"></a><span id="l10.483"> </span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+    /**</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+     * Due to a selection issue described in bug 168211 this method is needed to</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+     * re-add the selection listeners selection listeners.</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+     */</span>
<a href="#l10.488"></a><span id="l10.488">     resetAllowSelection: function uTV_resetAllowSelection() {</span>
<a href="#l10.489"></a><span id="l10.489">         if (!this.tree) {</span>
<a href="#l10.490"></a><span id="l10.490">             return;</span>
<a href="#l10.491"></a><span id="l10.491">         }</span>
<a href="#l10.492"></a><span id="l10.492">         /**</span>
<a href="#l10.493"></a><span id="l10.493">          * Do not change anything in the following lines, they are needed as</span>
<a href="#l10.494"></a><span id="l10.494">          * described in the selection observer above</span>
<a href="#l10.495"></a><span id="l10.495">          */</span>
<a href="#l10.496"></a><span id="l10.496">         this.doingSelection = false;</span>
<a href="#l10.497"></a><span id="l10.497"> </span>
<a href="#l10.498"></a><span id="l10.498">         this.tree.view.selection.selectEventsSuppressed = false;</span>
<a href="#l10.499"></a><span id="l10.499">         this.treeElement.addEventListener(&quot;select&quot;, unifinderSelect, true);</span>
<a href="#l10.500"></a><span id="l10.500">     },</span>
<a href="#l10.501"></a><span id="l10.501"> </span>
<a href="#l10.502"></a><span id="l10.502">     /**</span>
<a href="#l10.503"></a><span id="l10.503">      * Tree View Implementation</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+     * @see nsITreeView</span>
<a href="#l10.505"></a><span id="l10.505">      */</span>
<a href="#l10.506"></a><span id="l10.506">     get rowCount uTV_getRowCount() {</span>
<a href="#l10.507"></a><span id="l10.507">         return this.eventArray.length;</span>
<a href="#l10.508"></a><span id="l10.508">     },</span>
<a href="#l10.509"></a><span id="l10.509"> </span>
<a href="#l10.510"></a><span id="l10.510"> </span>
<a href="#l10.511"></a><span id="l10.511">     // TODO this code is currently identical to the task tree. We should create</span>
<a href="#l10.512"></a><span id="l10.512">     // an itemTreeView that these tree views can inherit, that contains this</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineat">@@ -722,16 +827,20 @@ var unifinderTreeView = {</span>
<a href="#l10.514"></a><span id="l10.514"> </span>
<a href="#l10.515"></a><span id="l10.515">     performActionOnRow: function uTV_performActionOnRow(aAction, aRow) {},</span>
<a href="#l10.516"></a><span id="l10.516"> </span>
<a href="#l10.517"></a><span id="l10.517">     performActionOnCell: function uTV_performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l10.518"></a><span id="l10.518"> </span>
<a href="#l10.519"></a><span id="l10.519">     outParameter: new Object() // used to obtain dates during sort</span>
<a href="#l10.520"></a><span id="l10.520"> };</span>
<a href="#l10.521"></a><span id="l10.521"> </span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+/**</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+ * Refresh the unifinder tree by getting items from the composite calendar and</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+ * applying the current filter.</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+ */</span>
<a href="#l10.526"></a><span id="l10.526"> function refreshEventTree() {</span>
<a href="#l10.527"></a><span id="l10.527">     if (isUnifinderHidden()) {</span>
<a href="#l10.528"></a><span id="l10.528">         // If the unifinder is hidden, don't refresh the events to reduce needed</span>
<a href="#l10.529"></a><span id="l10.529">         // getItems calls.</span>
<a href="#l10.530"></a><span id="l10.530">         return;</span>
<a href="#l10.531"></a><span id="l10.531">     }</span>
<a href="#l10.532"></a><span id="l10.532">     var savedThis = this;</span>
<a href="#l10.533"></a><span id="l10.533">     var refreshListener = {</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineat">@@ -775,39 +884,50 @@ function refreshEventTree() {</span>
<a href="#l10.535"></a><span id="l10.535">     if (unifinderTreeView.mFilter.startDate &amp;&amp; unifinderTreeView.mFilter.endDate) {</span>
<a href="#l10.536"></a><span id="l10.536">         filter |= ccalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l10.537"></a><span id="l10.537">     }</span>
<a href="#l10.538"></a><span id="l10.538"> </span>
<a href="#l10.539"></a><span id="l10.539">     ccalendar.getItems(filter, 0, unifinderTreeView.mFilter.startDate, unifinderTreeView.mFilter.endDate, refreshListener);</span>
<a href="#l10.540"></a><span id="l10.540"> }</span>
<a href="#l10.541"></a><span id="l10.541"> </span>
<a href="#l10.542"></a><span id="l10.542"> /**</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">- * Get the dates for a certain filter. This function makes it easy to extend the</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineminus">- * unifinder. To add a new view, just overwrite this function with your own. Be</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">- * sure to call this function afterwards though.</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+ * EXTENSION_POINTS</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineplus">+ * Filters the passed event array according to the currently applied filter.</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+ * Afterwards, applies the items to the unifinder view.</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineplus">+ *</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+ * If you are implementing a new filter, you can overwrite this function and</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineplus">+ * filter the items accordingly and afterwards call this function with the</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineplus">+ * result.</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+ *</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+ * @param eventArray        The array of items to be set in the unifinder.</span>
<a href="#l10.555"></a><span id="l10.555">  */</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-</span>
<a href="#l10.557"></a><span id="l10.557"> function refreshEventTreeInternal(eventArray) {</span>
<a href="#l10.558"></a><span id="l10.558"> </span>
<a href="#l10.559"></a><span id="l10.559">     unifinderTreeView.setItems(eventArray.filter(unifinderTreeView</span>
<a href="#l10.560"></a><span id="l10.560">                                                 .mFilter</span>
<a href="#l10.561"></a><span id="l10.561">                                                 .isItemInFilters</span>
<a href="#l10.562"></a><span id="l10.562">                                                 , unifinderTreeView</span>
<a href="#l10.563"></a><span id="l10.563">                                                 .mFilter</span>
<a href="#l10.564"></a><span id="l10.564">                                                 ));</span>
<a href="#l10.565"></a><span id="l10.565"> </span>
<a href="#l10.566"></a><span id="l10.566">     // Select selected events in the tree. Not passing the argument gets the</span>
<a href="#l10.567"></a><span id="l10.567">     // items from the view.</span>
<a href="#l10.568"></a><span id="l10.568">     unifinderTreeView.setSelectedItems();</span>
<a href="#l10.569"></a><span id="l10.569"> }</span>
<a href="#l10.570"></a><span id="l10.570"> </span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+/**</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+ * Focuses the unifinder search field</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+ */</span>
<a href="#l10.574"></a><span id="l10.574"> function focusSearch() {</span>
<a href="#l10.575"></a><span id="l10.575">     document.getElementById(&quot;unifinder-search-field&quot;).focus();</span>
<a href="#l10.576"></a><span id="l10.576"> }</span>
<a href="#l10.577"></a><span id="l10.577"> </span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+/**</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+ * Toggles the hidden state of the unifinder.</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineplus">+ */</span>
<a href="#l10.581"></a><span id="l10.581"> function toggleUnifinder() {</span>
<a href="#l10.582"></a><span id="l10.582">     // Toggle the elements</span>
<a href="#l10.583"></a><span id="l10.583">     goToggleToolbar('bottom-events-box', 'calendar_show_unifinder_command');</span>
<a href="#l10.584"></a><span id="l10.584">     goToggleToolbar('calendar-view-splitter');</span>
<a href="#l10.585"></a><span id="l10.585"> </span>
<a href="#l10.586"></a><span id="l10.586">     unifinderTreeView.treeElement.view = unifinderTreeView;</span>
<a href="#l10.587"></a><span id="l10.587"> </span>
<a href="#l10.588"></a><span id="l10.588">     // When the unifinder is hidden, refreshEventTree is not called. Make sure</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -45,16 +45,19 @@ var gEndHour = 24;</span>
<a href="#l11.4"></a><span id="l11.4"> var gIsReadOnly = false;</span>
<a href="#l11.5"></a><span id="l11.5"> var gIsInvitation = false;</span>
<a href="#l11.6"></a><span id="l11.6"> var gIgnoreUpdate = false;</span>
<a href="#l11.7"></a><span id="l11.7"> var gDisplayTimezone = true;</span>
<a href="#l11.8"></a><span id="l11.8"> var gUndoStack = [];</span>
<a href="#l11.9"></a><span id="l11.9"> var gForce24Hours = false;</span>
<a href="#l11.10"></a><span id="l11.10"> var gZoomFactor = 100;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+/**</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Sets up the attendee dialog</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ */</span>
<a href="#l11.15"></a><span id="l11.15"> function onLoad() {</span>
<a href="#l11.16"></a><span id="l11.16">     // first of all, attach all event handlers</span>
<a href="#l11.17"></a><span id="l11.17">     window.addEventListener(&quot;resize&quot;, onResize, true);</span>
<a href="#l11.18"></a><span id="l11.18">     window.addEventListener(&quot;modify&quot;, onModify, true);</span>
<a href="#l11.19"></a><span id="l11.19">     window.addEventListener(&quot;rowchange&quot;, onRowChange, true);</span>
<a href="#l11.20"></a><span id="l11.20">     window.addEventListener(&quot;DOMMouseScroll&quot;, onMouseScroll, true);</span>
<a href="#l11.21"></a><span id="l11.21">     window.addEventListener(&quot;DOMAttrModified&quot;, onAttrModified, true);</span>
<a href="#l11.22"></a><span id="l11.22">     window.addEventListener(&quot;timebar&quot;, onTimebar, true);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -134,45 +137,74 @@ function onLoad() {</span>
<a href="#l11.24"></a><span id="l11.24">             pb2.removeObserver(&quot;calendar.&quot;, prefObserver);</span>
<a href="#l11.25"></a><span id="l11.25">         },</span>
<a href="#l11.26"></a><span id="l11.26">         false);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l11.29"></a><span id="l11.29">     self.focus();</span>
<a href="#l11.30"></a><span id="l11.30"> }</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+/**</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * This function should be called when the accept button was pressed on the</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * attendee dialog. Calls the accept function specified in the window arguments.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ *</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * @return      Returns true, if the dialog should be closed.</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ */</span>
<a href="#l11.38"></a><span id="l11.38"> function onAccept() {</span>
<a href="#l11.39"></a><span id="l11.39">     var attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l11.40"></a><span id="l11.40">     window.arguments[0].onOk(</span>
<a href="#l11.41"></a><span id="l11.41">         attendees.attendees,</span>
<a href="#l11.42"></a><span id="l11.42">         attendees.organizer,</span>
<a href="#l11.43"></a><span id="l11.43">         gStartDate.getInTimezone(gStartTimezone),</span>
<a href="#l11.44"></a><span id="l11.44">         gEndDate.getInTimezone(gEndTimezone));</span>
<a href="#l11.45"></a><span id="l11.45">     return true;</span>
<a href="#l11.46"></a><span id="l11.46"> }</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+/**</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+ * This function should be called when the cancel button was pressed on the</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+ * attendee dialog.</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+ *</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+ * @return      Returns true, if the dialog should be closed.</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+ */</span>
<a href="#l11.54"></a><span id="l11.54"> function onCancel() {</span>
<a href="#l11.55"></a><span id="l11.55">     return true;</span>
<a href="#l11.56"></a><span id="l11.56"> }</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+/**</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+ * Event handler for setting the zoom factor</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+ *</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+ * @param aValue        The zoom factor to set.</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+ *</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+ * XXX setZoomFactor should be called directly.</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+ */</span>
<a href="#l11.65"></a><span id="l11.65"> function onZoomFactor(aValue) {</span>
<a href="#l11.66"></a><span id="l11.66">     setZoomFactor(parseInt(aValue));</span>
<a href="#l11.67"></a><span id="l11.67"> }</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+/**</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+ * Loads the passed start and end dates, fills global variables that give</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+ * information about the state of the dialog.</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+ *</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+ * @param aStartDate        The date/time the grid should start at.</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+ * @param aEndDate          The date/time the grid should end at.</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+ */</span>
<a href="#l11.76"></a><span id="l11.76"> function loadDateTime(aStartDate, aEndDate) {</span>
<a href="#l11.77"></a><span id="l11.77">     gDuration = aEndDate.subtractDate(aStartDate);</span>
<a href="#l11.78"></a><span id="l11.78">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l11.79"></a><span id="l11.79">     gStartTimezone = aStartDate.timezone;</span>
<a href="#l11.80"></a><span id="l11.80">     gEndTimezone = aEndDate.timezone;</span>
<a href="#l11.81"></a><span id="l11.81">     gStartDate = aStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.82"></a><span id="l11.82">     gEndDate = aEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l11.83"></a><span id="l11.83">     gStartDate.makeImmutable();</span>
<a href="#l11.84"></a><span id="l11.84">     gEndDate.makeImmutable();</span>
<a href="#l11.85"></a><span id="l11.85"> }</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+/**</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+ * Sets up the time grid using the global start and end dates.</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ */</span>
<a href="#l11.90"></a><span id="l11.90"> function propagateDateTime() {</span>
<a href="#l11.91"></a><span id="l11.91">     // Fill the controls</span>
<a href="#l11.92"></a><span id="l11.92">     updateDateTime();</span>
<a href="#l11.93"></a><span id="l11.93"> </span>
<a href="#l11.94"></a><span id="l11.94">     // Tell the timebar about the new start/enddate</span>
<a href="#l11.95"></a><span id="l11.95">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.96"></a><span id="l11.96">     timebar.startDate = gStartDate;</span>
<a href="#l11.97"></a><span id="l11.97">     timebar.endDate = gEndDate;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineat">@@ -204,24 +236,19 @@ function propagateDateTime() {</span>
<a href="#l11.99"></a><span id="l11.99">     if ((startTime.hour &lt; gStartHour) ||</span>
<a href="#l11.100"></a><span id="l11.100">         (endTime.hour &gt; gEndHour) ||</span>
<a href="#l11.101"></a><span id="l11.101">         (startTime.isDate)) {</span>
<a href="#l11.102"></a><span id="l11.102">         setForce24Hours(true);</span>
<a href="#l11.103"></a><span id="l11.103">     }</span>
<a href="#l11.104"></a><span id="l11.104"> }</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106"> /**</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">- * assumes that gStartDate and gEndDate have been correctly initialized,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">- * either by having called loadDateTime() or having read the information</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">- * from the controls due to recent user input. gStartDate and gEndDate are</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">- * assumed to always be in the default timezone while the actual timezones</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">- * are expected at gStartTimezone and gEndTimezone. this function attempts</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">- * to copy these state related informations to the dialog controls, which</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">- * makes it read from the variables and write to the controls (i.e. it</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">- * doesn't change the state).</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+ * This function requires gStartDate and gEndDate and the respective timezone</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+ * variables to be initialized. It updates the date/time information displayed in</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+ * the dialog from the above noted variables.</span>
<a href="#l11.118"></a><span id="l11.118">  */</span>
<a href="#l11.119"></a><span id="l11.119"> function updateDateTime() {</span>
<a href="#l11.120"></a><span id="l11.120">     // Convert to default timezone if the timezone option</span>
<a href="#l11.121"></a><span id="l11.121">     // is *not* checked, otherwise keep the specific timezone</span>
<a href="#l11.122"></a><span id="l11.122">     // and display the labels in order to modify the timezone.</span>
<a href="#l11.123"></a><span id="l11.123">     if (gDisplayTimezone) {</span>
<a href="#l11.124"></a><span id="l11.124">         var startTime = gStartDate.getInTimezone(gStartTimezone);</span>
<a href="#l11.125"></a><span id="l11.125">         var endTime = gEndDate.getInTimezone(gEndTimezone);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineat">@@ -271,24 +298,19 @@ function updateDateTime() {</span>
<a href="#l11.127"></a><span id="l11.127">         document.getElementById(&quot;event-endtime&quot;).value = endTime.jsDate;</span>
<a href="#l11.128"></a><span id="l11.128">     }</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130">     updateTimezone();</span>
<a href="#l11.131"></a><span id="l11.131">     updateAllDay();</span>
<a href="#l11.132"></a><span id="l11.132"> }</span>
<a href="#l11.133"></a><span id="l11.133"> </span>
<a href="#l11.134"></a><span id="l11.134"> /**</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">- * assumes that gStartDate and gEndDate have been correctly initialized,</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">- * either by having called loadDateTime() or having read the information</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">- * from the controls due to recent user input. gStartDate and gEndDate are</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">- * assumed to always be in the default timezone while the actual timezones</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">- * are expected at gStartTimezone and gEndTimezone. this function attempts</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">- * to copy these state related informations to the dialog controls, which</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">- * makes it read from the variables and write to the controls (i.e. it</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">- * doesn't change the state).</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+ * This function requires gStartDate and gEndDate and the respective timezone</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+ * variables to be initialized. It updates the timezone information displayed in</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+ * the dialog from the above noted variables.</span>
<a href="#l11.146"></a><span id="l11.146">  */</span>
<a href="#l11.147"></a><span id="l11.147"> function updateTimezone() {</span>
<a href="#l11.148"></a><span id="l11.148">     gIgnoreUpdate = true;</span>
<a href="#l11.149"></a><span id="l11.149"> </span>
<a href="#l11.150"></a><span id="l11.150">     if (gDisplayTimezone) {</span>
<a href="#l11.151"></a><span id="l11.151">         var startTimezone = gStartTimezone;</span>
<a href="#l11.152"></a><span id="l11.152">         var endTimezone = gEndTimezone;</span>
<a href="#l11.153"></a><span id="l11.153">         var equalTimezones = false;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineat">@@ -318,16 +340,19 @@ function updateTimezone() {</span>
<a href="#l11.155"></a><span id="l11.155">             .setAttribute('collapsed', 'true');</span>
<a href="#l11.156"></a><span id="l11.156">         document.getElementById(&quot;timezone-endtime&quot;)</span>
<a href="#l11.157"></a><span id="l11.157">             .setAttribute('collapsed', 'true');</span>
<a href="#l11.158"></a><span id="l11.158">     }</span>
<a href="#l11.159"></a><span id="l11.159"> </span>
<a href="#l11.160"></a><span id="l11.160">     gIgnoreUpdate = false;</span>
<a href="#l11.161"></a><span id="l11.161"> }</span>
<a href="#l11.162"></a><span id="l11.162"> </span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+/**</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+ * Updates gStartDate from the start time picker &quot;event-starttime&quot;</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+ */</span>
<a href="#l11.166"></a><span id="l11.166"> function updateStartTime() {</span>
<a href="#l11.167"></a><span id="l11.167">     if (gIgnoreUpdate) {</span>
<a href="#l11.168"></a><span id="l11.168">         return;</span>
<a href="#l11.169"></a><span id="l11.169">     }</span>
<a href="#l11.170"></a><span id="l11.170"> </span>
<a href="#l11.171"></a><span id="l11.171">     var startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l11.172"></a><span id="l11.172">     var endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174" class="difflineat">@@ -348,16 +373,19 @@ function updateStartTime() {</span>
<a href="#l11.175"></a><span id="l11.175">     if (allDay) {</span>
<a href="#l11.176"></a><span id="l11.176">         gStartDate.isDate = true;</span>
<a href="#l11.177"></a><span id="l11.177">         gEndDate.isDate = true;</span>
<a href="#l11.178"></a><span id="l11.178">     }</span>
<a href="#l11.179"></a><span id="l11.179"> </span>
<a href="#l11.180"></a><span id="l11.180">     propagateDateTime();</span>
<a href="#l11.181"></a><span id="l11.181"> }</span>
<a href="#l11.182"></a><span id="l11.182"> </span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+/**</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+ * Updates gEndDate from the end time picker &quot;event-endtime&quot;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+ */</span>
<a href="#l11.186"></a><span id="l11.186"> function updateEndTime() {</span>
<a href="#l11.187"></a><span id="l11.187">     if (gIgnoreUpdate) {</span>
<a href="#l11.188"></a><span id="l11.188">         return;</span>
<a href="#l11.189"></a><span id="l11.189">     }</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191">     var startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l11.192"></a><span id="l11.192">     var endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l11.193"></a><span id="l11.193"> </span>
<a href="#l11.194"></a><span id="l11.194" class="difflineat">@@ -411,16 +439,20 @@ function updateEndTime() {</span>
<a href="#l11.195"></a><span id="l11.195">                 null,</span>
<a href="#l11.196"></a><span id="l11.196">                 document.title,</span>
<a href="#l11.197"></a><span id="l11.197">                 calGetString(&quot;calendar&quot;, &quot;warningNegativeDuration&quot;));</span>
<a href="#l11.198"></a><span id="l11.198">         }</span>
<a href="#l11.199"></a><span id="l11.199">         setTimeout(callback, 1);</span>
<a href="#l11.200"></a><span id="l11.200">     }</span>
<a href="#l11.201"></a><span id="l11.201"> }</span>
<a href="#l11.202"></a><span id="l11.202"> </span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+/**</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+ * Prompts the user to pick a new timezone for the starttime. The dialog is</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+ * opened modally.</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+ */</span>
<a href="#l11.207"></a><span id="l11.207"> function editStartTimezone() {</span>
<a href="#l11.208"></a><span id="l11.208">     var tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l11.209"></a><span id="l11.209">     if (tzStart.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l11.210"></a><span id="l11.210">         return;</span>
<a href="#l11.211"></a><span id="l11.211">     }</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213">     var self = this;</span>
<a href="#l11.214"></a><span id="l11.214">     var args = new Object();</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineat">@@ -442,16 +474,20 @@ function editStartTimezone() {</span>
<a href="#l11.216"></a><span id="l11.216">     // Open the dialog modally</span>
<a href="#l11.217"></a><span id="l11.217">     openDialog(</span>
<a href="#l11.218"></a><span id="l11.218">         &quot;chrome://calendar/content/calendar-event-dialog-timezone.xul&quot;,</span>
<a href="#l11.219"></a><span id="l11.219">         &quot;_blank&quot;,</span>
<a href="#l11.220"></a><span id="l11.220">         &quot;chrome,titlebar,modal,resizable&quot;,</span>
<a href="#l11.221"></a><span id="l11.221">         args);</span>
<a href="#l11.222"></a><span id="l11.222"> }</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+/**</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+ * Prompts the user to pick a new timezone for the endtime. The dialog is</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+ * opened modally.</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+ */</span>
<a href="#l11.228"></a><span id="l11.228"> function editEndTimezone() {</span>
<a href="#l11.229"></a><span id="l11.229">     var tzStart = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l11.230"></a><span id="l11.230">     if (tzStart.hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l11.231"></a><span id="l11.231">         return;</span>
<a href="#l11.232"></a><span id="l11.232">     }</span>
<a href="#l11.233"></a><span id="l11.233"> </span>
<a href="#l11.234"></a><span id="l11.234">     var self = this;</span>
<a href="#l11.235"></a><span id="l11.235">     var args = new Object();</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineat">@@ -469,16 +505,22 @@ function editEndTimezone() {</span>
<a href="#l11.237"></a><span id="l11.237">     // Open the dialog modally</span>
<a href="#l11.238"></a><span id="l11.238">     openDialog(</span>
<a href="#l11.239"></a><span id="l11.239">         &quot;chrome://calendar/content/calendar-event-dialog-timezone.xul&quot;,</span>
<a href="#l11.240"></a><span id="l11.240">         &quot;_blank&quot;,</span>
<a href="#l11.241"></a><span id="l11.241">         &quot;chrome,titlebar,modal,resizable&quot;,</span>
<a href="#l11.242"></a><span id="l11.242">         args);</span>
<a href="#l11.243"></a><span id="l11.243"> }</span>
<a href="#l11.244"></a><span id="l11.244"> </span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+/**</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+ * Updates the dialog controls in case the window's event is an allday event, or</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+ * was set to one in the attendee dialog.</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+ *</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+ * This for example disables the timepicker since its not needed.</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+ */</span>
<a href="#l11.251"></a><span id="l11.251"> function updateAllDay() {</span>
<a href="#l11.252"></a><span id="l11.252">     if (gIgnoreUpdate) {</span>
<a href="#l11.253"></a><span id="l11.253">         return;</span>
<a href="#l11.254"></a><span id="l11.254">     }</span>
<a href="#l11.255"></a><span id="l11.255"> </span>
<a href="#l11.256"></a><span id="l11.256">     var allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l11.257"></a><span id="l11.257">     var allDay  = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l11.258"></a><span id="l11.258">     var startpicker = document.getElementById(&quot;event-starttime&quot;);</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineat">@@ -504,42 +546,50 @@ function updateAllDay() {</span>
<a href="#l11.260"></a><span id="l11.260"> </span>
<a href="#l11.261"></a><span id="l11.261">         tzStart.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.262"></a><span id="l11.262">         tzEnd.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.263"></a><span id="l11.263">         tzStart.setAttribute(&quot;class&quot;, &quot;text-link&quot;);</span>
<a href="#l11.264"></a><span id="l11.264">         tzEnd.setAttribute(&quot;class&quot;, &quot;text-link&quot;);</span>
<a href="#l11.265"></a><span id="l11.265">     }</span>
<a href="#l11.266"></a><span id="l11.266"> }</span>
<a href="#l11.267"></a><span id="l11.267"> </span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+/**</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+ * Changes the global variables to adapt for the change of the allday checkbox.</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+ *</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+ * XXX Function names are all very similar here. This needs some consistancy!</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+ */</span>
<a href="#l11.273"></a><span id="l11.273"> function changeAllDay() {</span>
<a href="#l11.274"></a><span id="l11.274">     var allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l11.275"></a><span id="l11.275">     var allDay = (allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l11.276"></a><span id="l11.276"> </span>
<a href="#l11.277"></a><span id="l11.277">     gStartDate = gStartDate.clone();</span>
<a href="#l11.278"></a><span id="l11.278">     gEndDate = gEndDate.clone();</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">     gStartDate.isDate = allDay;</span>
<a href="#l11.281"></a><span id="l11.281">     gEndDate.isDate = allDay;</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283">     propagateDateTime();</span>
<a href="#l11.284"></a><span id="l11.284"> </span>
<a href="#l11.285"></a><span id="l11.285">     // After propagating the modified times we enforce some constraints</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-    // on the zoom-factor. in case this events is now said to be all-day,</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+    // on the zoom-factor. In case this events is now said to be all-day,</span>
<a href="#l11.288"></a><span id="l11.288">     // we automatically enforce a 25% zoom-factor and disable the control.</span>
<a href="#l11.289"></a><span id="l11.289">     var zoom = document.getElementById(&quot;zoom-menulist&quot;);</span>
<a href="#l11.290"></a><span id="l11.290">     if (allDay) {</span>
<a href="#l11.291"></a><span id="l11.291">         zoom.value = &quot;400&quot;;</span>
<a href="#l11.292"></a><span id="l11.292">         zoom.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.293"></a><span id="l11.293">         setZoomFactor(zoom.value);</span>
<a href="#l11.294"></a><span id="l11.294">         setForce24Hours(true);</span>
<a href="#l11.295"></a><span id="l11.295">     } else {</span>
<a href="#l11.296"></a><span id="l11.296">         zoom.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.297"></a><span id="l11.297">     }</span>
<a href="#l11.298"></a><span id="l11.298"> }</span>
<a href="#l11.299"></a><span id="l11.299"> </span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+/**</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+ * Handler function used when the window is resized.</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+ */</span>
<a href="#l11.303"></a><span id="l11.303"> function onResize() {</span>
<a href="#l11.304"></a><span id="l11.304">     // Don't do anything if we haven't been initialized.</span>
<a href="#l11.305"></a><span id="l11.305">     if (!gStartDate || !gEndDate) {</span>
<a href="#l11.306"></a><span id="l11.306">         return;</span>
<a href="#l11.307"></a><span id="l11.307">     }</span>
<a href="#l11.308"></a><span id="l11.308"> </span>
<a href="#l11.309"></a><span id="l11.309">     var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l11.310"></a><span id="l11.310">     var gridScrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineat">@@ -559,16 +609,21 @@ function onResize() {</span>
<a href="#l11.312"></a><span id="l11.312">         var maxpos = attendeesScrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l11.313"></a><span id="l11.313">         var inc = maxpos * ratio / (1 - ratio);</span>
<a href="#l11.314"></a><span id="l11.314">         attendeesScrollbar.setAttribute(&quot;pageincrement&quot;, inc);</span>
<a href="#l11.315"></a><span id="l11.315">     } else {</span>
<a href="#l11.316"></a><span id="l11.316">         box.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l11.317"></a><span id="l11.317">     }</span>
<a href="#l11.318"></a><span id="l11.318"> }</span>
<a href="#l11.319"></a><span id="l11.319"> </span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+/**</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+ * Handler function to call when changing the calendar used in this dialog.</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+ *</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+ * @param calendar      The calendar to change to.</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+ */</span>
<a href="#l11.325"></a><span id="l11.325"> function onChangeCalendar(calendar) {</span>
<a href="#l11.326"></a><span id="l11.326">     var args = window.arguments[0];</span>
<a href="#l11.327"></a><span id="l11.327">     var organizer = args.organizer;</span>
<a href="#l11.328"></a><span id="l11.328"> </span>
<a href="#l11.329"></a><span id="l11.329">     // set 'mIsReadOnly' if the calendar is read-only</span>
<a href="#l11.330"></a><span id="l11.330">     if (calendar &amp;&amp; calendar.readOnly) {</span>
<a href="#l11.331"></a><span id="l11.331">         gIsReadOnly = true;</span>
<a href="#l11.332"></a><span id="l11.332">     }</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineat">@@ -586,25 +641,31 @@ function onChangeCalendar(calendar) {</span>
<a href="#l11.334"></a><span id="l11.334">         document.getElementById(&quot;previous-slot&quot;)</span>
<a href="#l11.335"></a><span id="l11.335">             .setAttribute('disabled', 'true');</span>
<a href="#l11.336"></a><span id="l11.336">     }</span>
<a href="#l11.337"></a><span id="l11.337"> </span>
<a href="#l11.338"></a><span id="l11.338">     var freebusy = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l11.339"></a><span id="l11.339">     freebusy.onChangeCalendar(calendar);</span>
<a href="#l11.340"></a><span id="l11.340"> }</span>
<a href="#l11.341"></a><span id="l11.341"> </span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+/**</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+ * Updates the slot buttons.</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+ */</span>
<a href="#l11.345"></a><span id="l11.345"> function updateButtons() {</span>
<a href="#l11.346"></a><span id="l11.346">     var previousButton = document.getElementById(&quot;previous-slot&quot;);</span>
<a href="#l11.347"></a><span id="l11.347">     if (gUndoStack.length &gt; 0) {</span>
<a href="#l11.348"></a><span id="l11.348">         previousButton.removeAttribute('disabled');</span>
<a href="#l11.349"></a><span id="l11.349">     } else {</span>
<a href="#l11.350"></a><span id="l11.350">         previousButton.setAttribute('disabled', 'true');</span>
<a href="#l11.351"></a><span id="l11.351">     }</span>
<a href="#l11.352"></a><span id="l11.352"> }</span>
<a href="#l11.353"></a><span id="l11.353"> </span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+/**</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+ * Handler function called to advance to the next slot.</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+ */</span>
<a href="#l11.357"></a><span id="l11.357"> function onNextSlot() {</span>
<a href="#l11.358"></a><span id="l11.358">     // Store the current setting in the undo-stack.</span>
<a href="#l11.359"></a><span id="l11.359">     var currentSlot = {};</span>
<a href="#l11.360"></a><span id="l11.360">     currentSlot.startTime = gStartDate;</span>
<a href="#l11.361"></a><span id="l11.361">     currentSlot.endTime = gEndDate;</span>
<a href="#l11.362"></a><span id="l11.362">     gUndoStack.push(currentSlot);</span>
<a href="#l11.363"></a><span id="l11.363"> </span>
<a href="#l11.364"></a><span id="l11.364">     // Ask the grid for the next possible timeslot.</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineat">@@ -631,16 +692,19 @@ function onNextSlot() {</span>
<a href="#l11.366"></a><span id="l11.366">     propagateDateTime();</span>
<a href="#l11.367"></a><span id="l11.367"> </span>
<a href="#l11.368"></a><span id="l11.368">     // Scroll the grid/timebar such that the current time is visible</span>
<a href="#l11.369"></a><span id="l11.369">     scrollToCurrentTime();</span>
<a href="#l11.370"></a><span id="l11.370"> </span>
<a href="#l11.371"></a><span id="l11.371">     updateButtons();</span>
<a href="#l11.372"></a><span id="l11.372"> }</span>
<a href="#l11.373"></a><span id="l11.373"> </span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+/**</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+ * Handler function called to advance to the previous slot.</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+ */</span>
<a href="#l11.377"></a><span id="l11.377"> function onPreviousSlot() {</span>
<a href="#l11.378"></a><span id="l11.378">     var previousSlot = gUndoStack.pop();</span>
<a href="#l11.379"></a><span id="l11.379">     if (!previousSlot) {</span>
<a href="#l11.380"></a><span id="l11.380">         return;</span>
<a href="#l11.381"></a><span id="l11.381">     }</span>
<a href="#l11.382"></a><span id="l11.382"> </span>
<a href="#l11.383"></a><span id="l11.383">     // In case the new starttime happens to be scheduled</span>
<a href="#l11.384"></a><span id="l11.384">     // on a different day, we also need to update the</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineat">@@ -660,55 +724,71 @@ function onPreviousSlot() {</span>
<a href="#l11.386"></a><span id="l11.386">     updateButtons();</span>
<a href="#l11.387"></a><span id="l11.387"> </span>
<a href="#l11.388"></a><span id="l11.388">     if (refresh) {</span>
<a href="#l11.389"></a><span id="l11.389">         var grid = document.getElementById(&quot;freebusy-grid&quot;);</span>
<a href="#l11.390"></a><span id="l11.390">         grid.forceRefresh();</span>
<a href="#l11.391"></a><span id="l11.391">     }</span>
<a href="#l11.392"></a><span id="l11.392"> }</span>
<a href="#l11.393"></a><span id="l11.393"> </span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+/**</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+ * Handler function called to zoom out (minus button)</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+ */</span>
<a href="#l11.397"></a><span id="l11.397"> function onMinus() {</span>
<a href="#l11.398"></a><span id="l11.398">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.399"></a><span id="l11.399">     var ratio = timebar.scroll;</span>
<a href="#l11.400"></a><span id="l11.400">     ratio -= timebar.step;</span>
<a href="#l11.401"></a><span id="l11.401">     if (ratio &lt;= 0.0) {</span>
<a href="#l11.402"></a><span id="l11.402">         ratio = 0.0;</span>
<a href="#l11.403"></a><span id="l11.403">     }</span>
<a href="#l11.404"></a><span id="l11.404">     var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l11.405"></a><span id="l11.405">     var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l11.406"></a><span id="l11.406">     scrollbar.setAttribute(&quot;curpos&quot;, ratio * maxpos);</span>
<a href="#l11.407"></a><span id="l11.407"> }</span>
<a href="#l11.408"></a><span id="l11.408"> </span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+/**</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+ * Handler function called to zoom in (plus button)</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+ */</span>
<a href="#l11.412"></a><span id="l11.412"> function onPlus() {</span>
<a href="#l11.413"></a><span id="l11.413">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.414"></a><span id="l11.414">     var ratio = timebar.scroll;</span>
<a href="#l11.415"></a><span id="l11.415">     ratio += timebar.step;</span>
<a href="#l11.416"></a><span id="l11.416">     if (ratio &gt;= 1.0) {</span>
<a href="#l11.417"></a><span id="l11.417">         ratio = 1.0;</span>
<a href="#l11.418"></a><span id="l11.418">     }</span>
<a href="#l11.419"></a><span id="l11.419">     var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l11.420"></a><span id="l11.420">     var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l11.421"></a><span id="l11.421">     scrollbar.setAttribute(&quot;curpos&quot;, ratio * maxpos);</span>
<a href="#l11.422"></a><span id="l11.422"> }</span>
<a href="#l11.423"></a><span id="l11.423"> </span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+/**</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+ * Scrolls the time grid to a position where the time of the item in question is</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+ * visible.</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+ */</span>
<a href="#l11.428"></a><span id="l11.428"> function scrollToCurrentTime() {</span>
<a href="#l11.429"></a><span id="l11.429">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.430"></a><span id="l11.430">     var ratio = (gStartDate.hour - gStartHour) * timebar.step;</span>
<a href="#l11.431"></a><span id="l11.431">     if (ratio &lt;= 0.0) {</span>
<a href="#l11.432"></a><span id="l11.432">         ratio = 0.0;</span>
<a href="#l11.433"></a><span id="l11.433">     }</span>
<a href="#l11.434"></a><span id="l11.434">     if (ratio &gt;= 1.0) {</span>
<a href="#l11.435"></a><span id="l11.435">         ratio = 1.0;</span>
<a href="#l11.436"></a><span id="l11.436">     }</span>
<a href="#l11.437"></a><span id="l11.437">     var scrollbar = document.getElementById(&quot;horizontal-scrollbar&quot;);</span>
<a href="#l11.438"></a><span id="l11.438">     var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l11.439"></a><span id="l11.439">     scrollbar.setAttribute(&quot;curpos&quot;, ratio * maxpos);</span>
<a href="#l11.440"></a><span id="l11.440"> }</span>
<a href="#l11.441"></a><span id="l11.441"> </span>
<a href="#l11.442"></a><span id="l11.442"> </span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+/**</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+ * Sets the zoom factor for the time grid</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+ *</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+ * @param aValue        The zoom factor to set.</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+ * @return              aValue (for chaining)</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+ */</span>
<a href="#l11.449"></a><span id="l11.449"> function setZoomFactor(aValue) {</span>
<a href="#l11.450"></a><span id="l11.450">     if (gZoomFactor == aValue) {</span>
<a href="#l11.451"></a><span id="l11.451">         return aValue;</span>
<a href="#l11.452"></a><span id="l11.452">     }</span>
<a href="#l11.453"></a><span id="l11.453"> </span>
<a href="#l11.454"></a><span id="l11.454">     gZoomFactor = aValue;</span>
<a href="#l11.455"></a><span id="l11.455">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.456"></a><span id="l11.456">     timebar.zoomFactor = gZoomFactor;</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineat">@@ -730,16 +810,22 @@ function setZoomFactor(aValue) {</span>
<a href="#l11.458"></a><span id="l11.458">         timebar.scroll = ratio;</span>
<a href="#l11.459"></a><span id="l11.459">         grid.scroll = ratio;</span>
<a href="#l11.460"></a><span id="l11.460">         selectionbar.ratio = ratio;</span>
<a href="#l11.461"></a><span id="l11.461">     }</span>
<a href="#l11.462"></a><span id="l11.462"> </span>
<a href="#l11.463"></a><span id="l11.463">     return aValue;</span>
<a href="#l11.464"></a><span id="l11.464"> }</span>
<a href="#l11.465"></a><span id="l11.465"> </span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+/**</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+ * Force the time grid to show 24 hours.</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+ *</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+ * @param aValue        If true, the view will be forced to 24 hours.</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+ * @return              aValue (for chaining)</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+ */</span>
<a href="#l11.472"></a><span id="l11.472"> function setForce24Hours(aValue) {</span>
<a href="#l11.473"></a><span id="l11.473">     if (gForce24Hours == aValue) {</span>
<a href="#l11.474"></a><span id="l11.474">       return aValue;</span>
<a href="#l11.475"></a><span id="l11.475">     }</span>
<a href="#l11.476"></a><span id="l11.476"> </span>
<a href="#l11.477"></a><span id="l11.477">     gForce24Hours = aValue;</span>
<a href="#l11.478"></a><span id="l11.478">     initTimeRange();</span>
<a href="#l11.479"></a><span id="l11.479">     var timebar = document.getElementById(&quot;timebar&quot;);</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineat">@@ -763,47 +849,74 @@ function setForce24Hours(aValue) {</span>
<a href="#l11.481"></a><span id="l11.481">     var ratio = curpos / maxpos;</span>
<a href="#l11.482"></a><span id="l11.482">     timebar.scroll = ratio;</span>
<a href="#l11.483"></a><span id="l11.483">     grid.scroll = ratio;</span>
<a href="#l11.484"></a><span id="l11.484">     selectionbar.ratio = ratio;</span>
<a href="#l11.485"></a><span id="l11.485"> </span>
<a href="#l11.486"></a><span id="l11.486">     return aValue;</span>
<a href="#l11.487"></a><span id="l11.487"> }</span>
<a href="#l11.488"></a><span id="l11.488"> </span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+/**</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+ * Initialize the time range, setting the start and end hours from the prefs, or</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+ * to 24 hrs if gForce24Hours is set.</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+ */</span>
<a href="#l11.493"></a><span id="l11.493"> function initTimeRange() {</span>
<a href="#l11.494"></a><span id="l11.494">     if (gForce24Hours) {</span>
<a href="#l11.495"></a><span id="l11.495">         gStartHour = 0;</span>
<a href="#l11.496"></a><span id="l11.496">         gEndHour = 24;</span>
<a href="#l11.497"></a><span id="l11.497">     } else {</span>
<a href="#l11.498"></a><span id="l11.498">         gStartHour = getPrefSafe(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l11.499"></a><span id="l11.499">         gEndHour = getPrefSafe(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l11.500"></a><span id="l11.500">     }</span>
<a href="#l11.501"></a><span id="l11.501"> }</span>
<a href="#l11.502"></a><span id="l11.502"> </span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+/**</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+ * Handler function for the &quot;modify&quot; event, emitted from the attendees-list</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+ * binding. event.details is an array of objects containing the user's email</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+ * (calid) and a flag that tells if the user has entered text before the last</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+ * onModify was called (dirty).</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+ *</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+ * @param event     The DOM event that caused the modification.</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+ */</span>
<a href="#l11.511"></a><span id="l11.511"> function onModify(event) {</span>
<a href="#l11.512"></a><span id="l11.512">     onResize();</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineminus">-    document.getElementById(</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineminus">-        &quot;freebusy-grid&quot;)</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-            .onModify(event);</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+    document.getElementById(&quot;freebusy-grid&quot;).onModify(event);</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+            </span>
<a href="#l11.518"></a><span id="l11.518"> }</span>
<a href="#l11.519"></a><span id="l11.519"> </span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+/**</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+ * Handler function for the &quot;rowchange&quot; event, emitted from the attendees-list</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+ * binding. event.details is the row that was changed to.</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+ *</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+ * @param event     The DOM event caused by the row change.</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineplus">+ */</span>
<a href="#l11.526"></a><span id="l11.526"> function onRowChange(event) {</span>
<a href="#l11.527"></a><span id="l11.527">     var scrollbar = document.getElementById(&quot;vertical-scrollbar&quot;);</span>
<a href="#l11.528"></a><span id="l11.528">     var attendees = document.getElementById(&quot;attendees-list&quot;);</span>
<a href="#l11.529"></a><span id="l11.529">     var maxpos = scrollbar.getAttribute(&quot;maxpos&quot;);</span>
<a href="#l11.530"></a><span id="l11.530">     scrollbar.setAttribute(</span>
<a href="#l11.531"></a><span id="l11.531">         &quot;curpos&quot;,</span>
<a href="#l11.532"></a><span id="l11.532">         event.details / attendees.mMaxAttendees * maxpos);</span>
<a href="#l11.533"></a><span id="l11.533"> }</span>
<a href="#l11.534"></a><span id="l11.534"> </span>
<a href="#l11.535"></a><span id="l11.535" class="difflineplus">+/**</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+ * Handler function to take care of mouse scrolling on the window</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+ *</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+ * @param event     The DOMMouseScroll event caused by scrolling.</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+ */</span>
<a href="#l11.540"></a><span id="l11.540"> function onMouseScroll(event) {</span>
<a href="#l11.541"></a><span id="l11.541">     // ignore mouse scrolling for now...</span>
<a href="#l11.542"></a><span id="l11.542">     event.stopPropagation();</span>
<a href="#l11.543"></a><span id="l11.543"> }</span>
<a href="#l11.544"></a><span id="l11.544"> </span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+/**</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+ * Hanlder function to take care of attribute changes on the window</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineplus">+ *</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+ * @param event     The DOMAttrModified event caused by this change.</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+ */</span>
<a href="#l11.550"></a><span id="l11.550"> function onAttrModified(event) {</span>
<a href="#l11.551"></a><span id="l11.551">     if (event.attrName == &quot;width&quot;) {</span>
<a href="#l11.552"></a><span id="l11.552">         var selectionbar = document.getElementById(&quot;selection-bar&quot;);</span>
<a href="#l11.553"></a><span id="l11.553">         selectionbar.setWidth(selectionbar.boxObject.width);</span>
<a href="#l11.554"></a><span id="l11.554">         return;</span>
<a href="#l11.555"></a><span id="l11.555">     }</span>
<a href="#l11.556"></a><span id="l11.556"> </span>
<a href="#l11.557"></a><span id="l11.557">     // Synchronize grid and attendee list</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineat">@@ -841,22 +954,35 @@ function onAttrModified(event) {</span>
<a href="#l11.559"></a><span id="l11.559">                     grid.scroll = ratio;</span>
<a href="#l11.560"></a><span id="l11.560">                     selectionbar.ratio = ratio;</span>
<a href="#l11.561"></a><span id="l11.561">                 }</span>
<a href="#l11.562"></a><span id="l11.562">             }</span>
<a href="#l11.563"></a><span id="l11.563">         }</span>
<a href="#l11.564"></a><span id="l11.564">     }</span>
<a href="#l11.565"></a><span id="l11.565"> }</span>
<a href="#l11.566"></a><span id="l11.566"> </span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+/**</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+ * Handler function for initializing the selection bar, event usually emitted</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+ * from the freebusy-timebar binding.</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+ *</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+ * @param event     The &quot;timebar&quot; event with details and height property.</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+ */</span>
<a href="#l11.573"></a><span id="l11.573"> function onTimebar(event) {</span>
<a href="#l11.574"></a><span id="l11.574">     document.getElementById(</span>
<a href="#l11.575"></a><span id="l11.575">         &quot;selection-bar&quot;)</span>
<a href="#l11.576"></a><span id="l11.576">             .init(event.details, event.height);</span>
<a href="#l11.577"></a><span id="l11.577"> }</span>
<a href="#l11.578"></a><span id="l11.578"> </span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+/**</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineplus">+ * Handler function to update controls when the time has changed on the</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineplus">+ * selection bar.</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineplus">+ *</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+ * @param event     The &quot;timechange&quot; event with startDate and endDate</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineplus">+ *                    properties.</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+ */</span>
<a href="#l11.586"></a><span id="l11.586"> function onTimeChange(event) {</span>
<a href="#l11.587"></a><span id="l11.587">     var start = event.startDate.getInTimezone(gStartTimezone);</span>
<a href="#l11.588"></a><span id="l11.588">     var end = event.endDate.getInTimezone(gEndTimezone);</span>
<a href="#l11.589"></a><span id="l11.589"> </span>
<a href="#l11.590"></a><span id="l11.590">     loadDateTime(start, end);</span>
<a href="#l11.591"></a><span id="l11.591"> </span>
<a href="#l11.592"></a><span id="l11.592">     // fill the controls</span>
<a href="#l11.593"></a><span id="l11.593">     updateDateTime();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -36,16 +36,20 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.5"></a><span id="l12.5">  *</span>
<a href="#l12.6"></a><span id="l12.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> var gIsReadOnly = false;</span>
<a href="#l12.9"></a><span id="l12.9"> var gStartTime = null;</span>
<a href="#l12.10"></a><span id="l12.10"> var gEndTime = null;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+/**</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Sets up the recurrence dialog from the window arguments. Takes care of filling</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * the dialog controls with the recurrece information for this window.</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ */</span>
<a href="#l12.16"></a><span id="l12.16"> function onLoad() {</span>
<a href="#l12.17"></a><span id="l12.17">     changeWidgetsOrder();</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">     var args = window.arguments[0];</span>
<a href="#l12.20"></a><span id="l12.20">     var item = args.calendarEvent;</span>
<a href="#l12.21"></a><span id="l12.21">     var calendar = item.calendar;</span>
<a href="#l12.22"></a><span id="l12.22">     var recinfo = args.recurrenceInfo;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -90,16 +94,21 @@ function onLoad() {</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">     // Update controls</span>
<a href="#l12.27"></a><span id="l12.27">     updateRecurrenceDeck();</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l12.30"></a><span id="l12.30">     self.focus();</span>
<a href="#l12.31"></a><span id="l12.31"> }</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+/**</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * Initialize the dialog controls according to the passed rule</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ *</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * @param rule    The recurrence rule to parse.</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ */</span>
<a href="#l12.38"></a><span id="l12.38"> function initializeControls(rule) {</span>
<a href="#l12.39"></a><span id="l12.39">     function getOrdinalAndWeekdayOfRule(aByDayRuleComponent) {</span>
<a href="#l12.40"></a><span id="l12.40">         return {</span>
<a href="#l12.41"></a><span id="l12.41">             ordinal: (aByDayRuleComponent - (aByDayRuleComponent % 8)) / 8,</span>
<a href="#l12.42"></a><span id="l12.42">             weekday: Math.abs(aByDayRuleComponent % 8)</span>
<a href="#l12.43"></a><span id="l12.43">         };</span>
<a href="#l12.44"></a><span id="l12.44">     }</span>
<a href="#l12.45"></a><span id="l12.45">     </span>
<a href="#l12.46"></a><span id="l12.46" class="difflineat">@@ -213,16 +222,23 @@ function initializeControls(rule) {</span>
<a href="#l12.47"></a><span id="l12.47">         } else {</span>
<a href="#l12.48"></a><span id="l12.48">             endDate = endDate.getInTimezone(gStartTime.timezone); // calIRecurrenceRule::endDate is always UTC or floating</span>
<a href="#l12.49"></a><span id="l12.49">             setElementValue(&quot;recurrence-duration&quot;, &quot;until&quot;);</span>
<a href="#l12.50"></a><span id="l12.50">             setElementValue(&quot;repeat-until-date&quot;, endDate.getInTimezone(floating()).jsDate);</span>
<a href="#l12.51"></a><span id="l12.51">         }</span>
<a href="#l12.52"></a><span id="l12.52">     }</span>
<a href="#l12.53"></a><span id="l12.53"> }</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+/**</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+ * Save the recurrence information selected in the dialog back to the given</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+ * item.</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+ *</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+ * @param item    The item to save back to.</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+ * @return        The saved recurrence info.</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+ */</span>
<a href="#l12.62"></a><span id="l12.62"> function onSave(item) {</span>
<a href="#l12.63"></a><span id="l12.63">     // Always return 'null' if this item is an occurrence.</span>
<a href="#l12.64"></a><span id="l12.64">     if (!item || item.parentItem != item) {</span>
<a href="#l12.65"></a><span id="l12.65">         return null;</span>
<a href="#l12.66"></a><span id="l12.66">     }</span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68">     // This works, but if we ever support more complex recurrence,</span>
<a href="#l12.69"></a><span id="l12.69">     // e.g. recurrence for Martians, then we're going to want to</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineat">@@ -337,23 +353,37 @@ function onSave(item) {</span>
<a href="#l12.71"></a><span id="l12.71">     if (recRule.interval &lt; 1) {</span>
<a href="#l12.72"></a><span id="l12.72">         return null;</span>
<a href="#l12.73"></a><span id="l12.73">     }</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">     recurrenceInfo.insertRecurrenceItemAt(recRule, 0);</span>
<a href="#l12.76"></a><span id="l12.76">     return recurrenceInfo;</span>
<a href="#l12.77"></a><span id="l12.77"> }</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+/**</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+ * Handler function to be called when the accept button is pressed.</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+ *</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+ * @return      Returns true if the window should be closed</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+ */</span>
<a href="#l12.84"></a><span id="l12.84"> function onAccept() {</span>
<a href="#l12.85"></a><span id="l12.85">     var args = window.arguments[0];</span>
<a href="#l12.86"></a><span id="l12.86">     var item = args.calendarEvent;</span>
<a href="#l12.87"></a><span id="l12.87">     args.onOk(onSave(item));</span>
<a href="#l12.88"></a><span id="l12.88">     return true;</span>
<a href="#l12.89"></a><span id="l12.89"> }</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+/**</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+ * Handler function called when the calendar is changed (also for initial</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+ * setup).</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+ *</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+ * XXX we don't change the calendar in this dialog, this function should be</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+ * consolidated or renamed.</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+ *</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+ * @param calendar    The calendar to use for setup.</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+ */</span>
<a href="#l12.100"></a><span id="l12.100"> function onChangeCalendar(calendar) {</span>
<a href="#l12.101"></a><span id="l12.101">     var args = window.arguments[0];</span>
<a href="#l12.102"></a><span id="l12.102">     var item = args.calendarEvent;</span>
<a href="#l12.103"></a><span id="l12.103"> </span>
<a href="#l12.104"></a><span id="l12.104">     // Set 'gIsReadOnly' if the calendar is read-only</span>
<a href="#l12.105"></a><span id="l12.105">     gIsReadOnly = false;</span>
<a href="#l12.106"></a><span id="l12.106">     if (calendar &amp;&amp; calendar.readOnly) {</span>
<a href="#l12.107"></a><span id="l12.107">         gIsReadOnly = true;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineat">@@ -364,62 +394,103 @@ function onChangeCalendar(calendar) {</span>
<a href="#l12.109"></a><span id="l12.109">     // - whether or not this item is read-only</span>
<a href="#l12.110"></a><span id="l12.110">     // - whether or not the state of the item allows recurrence rules</span>
<a href="#l12.111"></a><span id="l12.111">     //     - tasks without an entrydate are invalid</span>
<a href="#l12.112"></a><span id="l12.112">     disableOrEnable(item);</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">     updateRecurrenceControls();</span>
<a href="#l12.115"></a><span id="l12.115"> }</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+/**</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+ * Disable or enable certain controls based on the given item:</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+ * Uses the following attribute:</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+ *</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+ * - disable-on-occurrence</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+ * - disable-on-readonly</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+ *</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+ * A task without a start time is also considered readonly.</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+ *</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+ * @param item        The item to check.</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+ */</span>
<a href="#l12.128"></a><span id="l12.128"> function disableOrEnable(item) {</span>
<a href="#l12.129"></a><span id="l12.129">     if (item.parentItem != item) {</span>
<a href="#l12.130"></a><span id="l12.130">        disableRecurrenceFields(&quot;disable-on-occurrence&quot;);</span>
<a href="#l12.131"></a><span id="l12.131">     } else if (gIsReadOnly) {</span>
<a href="#l12.132"></a><span id="l12.132">         disableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l12.133"></a><span id="l12.133">     } else if (isToDo(item) &amp;&amp; !gStartTime) {</span>
<a href="#l12.134"></a><span id="l12.134">         disableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l12.135"></a><span id="l12.135">     } else {</span>
<a href="#l12.136"></a><span id="l12.136">         enableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l12.137"></a><span id="l12.137">     }</span>
<a href="#l12.138"></a><span id="l12.138"> }</span>
<a href="#l12.139"></a><span id="l12.139"> </span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+/**</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+ * Disables all fields that have an attribute that matches the argument and is</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+ * set to &quot;true&quot;.</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+ *</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+ * @param aAttributeName    The attribute to search for.</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+ */</span>
<a href="#l12.146"></a><span id="l12.146"> function disableRecurrenceFields(aAttributeName) {</span>
<a href="#l12.147"></a><span id="l12.147">     var disableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l12.148"></a><span id="l12.148">     for (var i = 0; i &lt; disableElements.length; i++) {</span>
<a href="#l12.149"></a><span id="l12.149">         disableElements[i].setAttribute('disabled', 'true');</span>
<a href="#l12.150"></a><span id="l12.150">     }</span>
<a href="#l12.151"></a><span id="l12.151"> }</span>
<a href="#l12.152"></a><span id="l12.152"> </span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+/**</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+ * Enables all fields that have an attribute that matches the argument and is</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+ * set to &quot;true&quot;.</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+ *</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+ * @param aAttributeName    The attribute to search for.</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+ */</span>
<a href="#l12.159"></a><span id="l12.159"> function enableRecurrenceFields(aAttributeName) {</span>
<a href="#l12.160"></a><span id="l12.160">     var enableElements = document.getElementsByAttribute(aAttributeName, &quot;true&quot;);</span>
<a href="#l12.161"></a><span id="l12.161">     for (var i = 0; i &lt; enableElements.length; i++) {</span>
<a href="#l12.162"></a><span id="l12.162">         enableElements[i].removeAttribute('disabled');</span>
<a href="#l12.163"></a><span id="l12.163">     }</span>
<a href="#l12.164"></a><span id="l12.164"> }</span>
<a href="#l12.165"></a><span id="l12.165"> </span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+/**</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+ * Split rules into negative and positive rules.</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+ *</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+ * XXX This function is duplicate from calendar-dialog-utils.js, which we may</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+ * want to include in this dialog.</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+ *</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+ * @param recurrenceInfo    An item's recurrence info to parse.</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+ * @return                  An array with two elements: an array of positive</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+ *                            rules and an array of negative rules.</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+ */</span>
<a href="#l12.176"></a><span id="l12.176"> function splitRecurrenceRules(recurrenceInfo) {</span>
<a href="#l12.177"></a><span id="l12.177">     var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l12.178"></a><span id="l12.178">     var rules = [];</span>
<a href="#l12.179"></a><span id="l12.179">     var exceptions = [];</span>
<a href="#l12.180"></a><span id="l12.180">     for each (var r in ritems) {</span>
<a href="#l12.181"></a><span id="l12.181">         if (r.isNegative) {</span>
<a href="#l12.182"></a><span id="l12.182">             exceptions.push(r);</span>
<a href="#l12.183"></a><span id="l12.183">         } else {</span>
<a href="#l12.184"></a><span id="l12.184">             rules.push(r);</span>
<a href="#l12.185"></a><span id="l12.185">         }</span>
<a href="#l12.186"></a><span id="l12.186">     }</span>
<a href="#l12.187"></a><span id="l12.187">     return [rules, exceptions];</span>
<a href="#l12.188"></a><span id="l12.188"> }</span>
<a href="#l12.189"></a><span id="l12.189"> </span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+/**</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+ * Handler function to update the period-deck when an item from the period-list</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+ * is selected. Also updates the controls on that deck.</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+ */</span>
<a href="#l12.194"></a><span id="l12.194"> function updateRecurrenceDeck() {</span>
<a href="#l12.195"></a><span id="l12.195">     document.getElementById(&quot;period-deck&quot;)</span>
<a href="#l12.196"></a><span id="l12.196">             .selectedIndex = Number(getElementValue(&quot;period-list&quot;));</span>
<a href="#l12.197"></a><span id="l12.197">     updateRecurrenceControls();</span>
<a href="#l12.198"></a><span id="l12.198"> }</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+/**</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+ * Updates the controls regarding ranged controls (i.e repeat forever, repeat</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+ * until, repeat n times...)</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+ */</span>
<a href="#l12.204"></a><span id="l12.204"> function updateRecurrenceRange() {</span>
<a href="#l12.205"></a><span id="l12.205">     var args = window.arguments[0];</span>
<a href="#l12.206"></a><span id="l12.206">     var item = args.calendarEvent;</span>
<a href="#l12.207"></a><span id="l12.207">     if (item.parentItem != item || gIsReadOnly) {</span>
<a href="#l12.208"></a><span id="l12.208">         return;</span>
<a href="#l12.209"></a><span id="l12.209">     }</span>
<a href="#l12.210"></a><span id="l12.210"> </span>
<a href="#l12.211"></a><span id="l12.211">     var radioRangeForever =</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineat">@@ -455,26 +526,29 @@ function updateRecurrenceRange() {</span>
<a href="#l12.213"></a><span id="l12.213"> </span>
<a href="#l12.214"></a><span id="l12.214">     if (durationSelection == &quot;until&quot;) {</span>
<a href="#l12.215"></a><span id="l12.215">         rangeUntilDate.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l12.216"></a><span id="l12.216">     } else {</span>
<a href="#l12.217"></a><span id="l12.217">         rangeUntilDate.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l12.218"></a><span id="l12.218">     }</span>
<a href="#l12.219"></a><span id="l12.219"> }</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+/**</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+ * Updates the recurrence preview calendars using the window's item.</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+ */</span>
<a href="#l12.224"></a><span id="l12.224"> function updatePreview() {</span>
<a href="#l12.225"></a><span id="l12.225">     var args = window.arguments[0];</span>
<a href="#l12.226"></a><span id="l12.226">     var item = args.calendarEvent;</span>
<a href="#l12.227"></a><span id="l12.227">     if (item.parentItem != item) {</span>
<a href="#l12.228"></a><span id="l12.228">         item = item.parentItem;</span>
<a href="#l12.229"></a><span id="l12.229">     }</span>
<a href="#l12.230"></a><span id="l12.230"> </span>
<a href="#l12.231"></a><span id="l12.231">     // TODO: We should better start the whole dialog with a newly cloned item</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-    // and always pump changes immediately into it. this would eliminate the</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-    // need to break the encapsulation, as we do it here. but we need the item</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    // and always pump changes immediately into it. This would eliminate the</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+    // need to break the encapsulation, as we do it here. But we need the item</span>
<a href="#l12.236"></a><span id="l12.236">     // to contain the startdate in order to calculate the recurrence preview.</span>
<a href="#l12.237"></a><span id="l12.237">     item = item.clone();</span>
<a href="#l12.238"></a><span id="l12.238">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l12.239"></a><span id="l12.239">     if (isEvent(item)) {</span>
<a href="#l12.240"></a><span id="l12.240">         var startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.241"></a><span id="l12.241">         var endDate = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l12.242"></a><span id="l12.242">         if (startDate.isDate) {</span>
<a href="#l12.243"></a><span id="l12.243">             endDate.day--;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineat">@@ -498,16 +572,19 @@ function updatePreview() {</span>
<a href="#l12.245"></a><span id="l12.245">         item.dueDate = dueDate;</span>
<a href="#l12.246"></a><span id="l12.246">     }</span>
<a href="#l12.247"></a><span id="l12.247"> </span>
<a href="#l12.248"></a><span id="l12.248">     var recInfo = onSave(item);</span>
<a href="#l12.249"></a><span id="l12.249">     var preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l12.250"></a><span id="l12.250">     preview.updatePreview(recInfo);</span>
<a href="#l12.251"></a><span id="l12.251"> }</span>
<a href="#l12.252"></a><span id="l12.252"> </span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+/**</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+ * Update all recurrence controls on the dialog.</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+ */</span>
<a href="#l12.256"></a><span id="l12.256"> function updateRecurrenceControls() {</span>
<a href="#l12.257"></a><span id="l12.257">     updateRecurrencePattern();</span>
<a href="#l12.258"></a><span id="l12.258">     updateRecurrenceRange();</span>
<a href="#l12.259"></a><span id="l12.259">     updatePreview();</span>
<a href="#l12.260"></a><span id="l12.260"> }</span>
<a href="#l12.261"></a><span id="l12.261"> </span>
<a href="#l12.262"></a><span id="l12.262"> /**</span>
<a href="#l12.263"></a><span id="l12.263">  * Disables/enables controls related to the recurrence pattern.</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineat">@@ -571,16 +648,19 @@ function updateRecurrencePattern() {</span>
<a href="#l12.265"></a><span id="l12.265">                 yearlyDays.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l12.266"></a><span id="l12.266">                 yearlyMonthOrdinal.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l12.267"></a><span id="l12.267">             }</span>
<a href="#l12.268"></a><span id="l12.268">             break;</span>
<a href="#l12.269"></a><span id="l12.269">     }</span>
<a href="#l12.270"></a><span id="l12.270"> }</span>
<a href="#l12.271"></a><span id="l12.271"> </span>
<a href="#l12.272"></a><span id="l12.272"> /**</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+ * This function changes the order for certain elements using a locale string.</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+ * This is needed for some locales that expect a different wording order.</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+ *</span>
<a href="#l12.276"></a><span id="l12.276">  * @param aPropKey      The locale property key to get the order from</span>
<a href="#l12.277"></a><span id="l12.277">  * @param aPropParams   An array of ids to be passed to the locale property.</span>
<a href="#l12.278"></a><span id="l12.278">  *                        These should be the ids of the elements to change</span>
<a href="#l12.279"></a><span id="l12.279">  *                        the order for.</span>
<a href="#l12.280"></a><span id="l12.280">  */</span>
<a href="#l12.281"></a><span id="l12.281"> function changeOrderForElements(aPropKey, aPropParams) {</span>
<a href="#l12.282"></a><span id="l12.282">     var localeOrder;</span>
<a href="#l12.283"></a><span id="l12.283">     var parents = {};</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineat">@@ -610,17 +690,17 @@ function changeOrderForElements(aPropKey</span>
<a href="#l12.285"></a><span id="l12.285">     for (var i = 0; i &lt; aPropParams.length; i++) {</span>
<a href="#l12.286"></a><span id="l12.286">         var newEl = document.getElementById(localeOrder[i]);</span>
<a href="#l12.287"></a><span id="l12.287">         parents[i].appendChild(newEl.parentNode.removeChild(newEl));</span>
<a href="#l12.288"></a><span id="l12.288"> </span>
<a href="#l12.289"></a><span id="l12.289">     }</span>
<a href="#l12.290"></a><span id="l12.290"> }</span>
<a href="#l12.291"></a><span id="l12.291"> </span>
<a href="#l12.292"></a><span id="l12.292"> /**</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">- * Change widget order for Edit Recurrence window</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+ * Change locale-specific widget order for Edit Recurrence window</span>
<a href="#l12.295"></a><span id="l12.295">  */</span>
<a href="#l12.296"></a><span id="l12.296"> function changeWidgetsOrder() {</span>
<a href="#l12.297"></a><span id="l12.297">     changeOrderForElements(&quot;monthlyOrder&quot;,</span>
<a href="#l12.298"></a><span id="l12.298">                            [&quot;monthly-ordinal&quot;,</span>
<a href="#l12.299"></a><span id="l12.299">                             &quot;monthly-weekday&quot;]);</span>
<a href="#l12.300"></a><span id="l12.300">     changeOrderForElements(&quot;yearlyOrder&quot;,</span>
<a href="#l12.301"></a><span id="l12.301">                            [&quot;yearly-days&quot;,</span>
<a href="#l12.302"></a><span id="l12.302">                             &quot;yearly-period-of-month-label&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -54,54 +54,73 @@ var gOrganizerID = null;</span>
<a href="#l13.4"></a><span id="l13.4"> var gPrivacy = null;</span>
<a href="#l13.5"></a><span id="l13.5"> var gAttachMap = {};</span>
<a href="#l13.6"></a><span id="l13.6"> var gPriority = 0;</span>
<a href="#l13.7"></a><span id="l13.7"> var gStatus = &quot;NONE&quot;;</span>
<a href="#l13.8"></a><span id="l13.8"> var gLastRepeatSelection = 0;</span>
<a href="#l13.9"></a><span id="l13.9"> var gIgnoreUpdate = false;</span>
<a href="#l13.10"></a><span id="l13.10"> var gShowTimeAs = null;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+/**</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Checks if the given calendar supports notifying attendees. The item is needed</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * since calendars may support notifications for only some types of items.</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ *</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * @param calendar    The calendar to check</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ * @param item        The item to check support for.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ */</span>
<a href="#l13.19"></a><span id="l13.19"> function canNotifyAttendees(calendar, item) {</span>
<a href="#l13.20"></a><span id="l13.20">     try {</span>
<a href="#l13.21"></a><span id="l13.21">         var cal = calendar.QueryInterface(Components.interfaces.calISchedulingSupport);</span>
<a href="#l13.22"></a><span id="l13.22">         return (cal.canNotify(&quot;REQUEST&quot;, item) &amp;&amp; cal.canNotify(&quot;CANCEL&quot;, item));</span>
<a href="#l13.23"></a><span id="l13.23">     } catch (exc) {</span>
<a href="#l13.24"></a><span id="l13.24">         return false;</span>
<a href="#l13.25"></a><span id="l13.25">     }</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-// update menu items that rely on focus</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+/**</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * Update menu items that rely on focus</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ */</span>
<a href="#l13.32"></a><span id="l13.32"> function goUpdateGlobalEditMenuItems() {</span>
<a href="#l13.33"></a><span id="l13.33">     goUpdateCommand('cmd_undo');</span>
<a href="#l13.34"></a><span id="l13.34">     goUpdateCommand('cmd_redo');</span>
<a href="#l13.35"></a><span id="l13.35">     goUpdateCommand('cmd_cut');</span>
<a href="#l13.36"></a><span id="l13.36">     goUpdateCommand('cmd_copy');</span>
<a href="#l13.37"></a><span id="l13.37">     goUpdateCommand('cmd_paste');</span>
<a href="#l13.38"></a><span id="l13.38">     goUpdateCommand('cmd_selectAll');</span>
<a href="#l13.39"></a><span id="l13.39"> }</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-// update menu items that rely on the current selection</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+/**</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+ * Update menu items that rely on the current selection</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+ */</span>
<a href="#l13.45"></a><span id="l13.45"> function goUpdateSelectEditMenuItems() {</span>
<a href="#l13.46"></a><span id="l13.46">     goUpdateCommand('cmd_cut');</span>
<a href="#l13.47"></a><span id="l13.47">     goUpdateCommand('cmd_copy');</span>
<a href="#l13.48"></a><span id="l13.48">     goUpdateCommand('cmd_delete');</span>
<a href="#l13.49"></a><span id="l13.49">     goUpdateCommand('cmd_selectAll');</span>
<a href="#l13.50"></a><span id="l13.50"> }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-// update menu items that relate to undo/redo</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+/**</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+ * Update menu items that relate to undo/redo</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+ */</span>
<a href="#l13.56"></a><span id="l13.56"> function goUpdateUndoEditMenuItems() {</span>
<a href="#l13.57"></a><span id="l13.57">     goUpdateCommand('cmd_undo');</span>
<a href="#l13.58"></a><span id="l13.58">     goUpdateCommand('cmd_redo');</span>
<a href="#l13.59"></a><span id="l13.59"> }</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-// update menu items that depend on clipboard contents</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+/**</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+ * Update menu items that depend on clipboard contents</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+ */</span>
<a href="#l13.65"></a><span id="l13.65"> function goUpdatePasteMenuItems() {</span>
<a href="#l13.66"></a><span id="l13.66">     goUpdateCommand('cmd_paste');</span>
<a href="#l13.67"></a><span id="l13.67"> }</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+/**</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+ * Sets up the event dialog from the window arguments, also setting up all</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+ * dialog controls from the window's item.</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+ */</span>
<a href="#l13.73"></a><span id="l13.73"> function onLoad() {</span>
<a href="#l13.74"></a><span id="l13.74">     // first of all retrieve the array of</span>
<a href="#l13.75"></a><span id="l13.75">     // arguments this window has been called with.</span>
<a href="#l13.76"></a><span id="l13.76">     var args = window.arguments[0];</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78">     // The calling entity provides us with an object that is responsible</span>
<a href="#l13.79"></a><span id="l13.79">     // for recording details about the initiated modification. the 'finalize'</span>
<a href="#l13.80"></a><span id="l13.80">     // property is our hook in order to receive a notification in case the</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineat">@@ -193,22 +212,35 @@ function onLoad() {</span>
<a href="#l13.82"></a><span id="l13.82">     loadDialog(window.calendarItem);</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86">     document.getElementById(&quot;item-title&quot;).focus();</span>
<a href="#l13.87"></a><span id="l13.87">     document.getElementById(&quot;item-title&quot;).select();</span>
<a href="#l13.88"></a><span id="l13.88"> }</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+/**</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+ * Handler function to be called when the accept button is pressed.</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+ *</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+ * @return      Returns true if the window should be closed</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+ */</span>
<a href="#l13.95"></a><span id="l13.95"> function onAccept() {</span>
<a href="#l13.96"></a><span id="l13.96">     dispose();</span>
<a href="#l13.97"></a><span id="l13.97">     onCommandSave(true);</span>
<a href="#l13.98"></a><span id="l13.98">     return true;</span>
<a href="#l13.99"></a><span id="l13.99"> }</span>
<a href="#l13.100"></a><span id="l13.100"> </span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+/**</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+ * Asks the user if the item should be saved and does so if requested. If the</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+ * user cancels, the window should stay open.</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+ *</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+ * XXX Could possibly be consolidated into onCancel()</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+ *</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+ * @return    Returns true if the window should be closed.</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+ */</span>
<a href="#l13.109"></a><span id="l13.109"> function onCommandCancel() {</span>
<a href="#l13.110"></a><span id="l13.110">     // find out if we should bring up the 'do you want to save?' question...</span>
<a href="#l13.111"></a><span id="l13.111">     var newItem = saveItem();</span>
<a href="#l13.112"></a><span id="l13.112">     var oldItem = window.calendarItem.clone();</span>
<a href="#l13.113"></a><span id="l13.113"> </span>
<a href="#l13.114"></a><span id="l13.114">     // we need to guide the description text through the text-field since</span>
<a href="#l13.115"></a><span id="l13.115">     // newlines are getting converted which would indicate changes to the</span>
<a href="#l13.116"></a><span id="l13.116">     // text.</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineat">@@ -257,24 +289,33 @@ function onCommandCancel() {</span>
<a href="#l13.118"></a><span id="l13.118">             return true;</span>
<a href="#l13.119"></a><span id="l13.119">         case 2: // Don't save</span>
<a href="#l13.120"></a><span id="l13.120">             return true;</span>
<a href="#l13.121"></a><span id="l13.121">         default: // Cancel</span>
<a href="#l13.122"></a><span id="l13.122">             return false;</span>
<a href="#l13.123"></a><span id="l13.123">     }</span>
<a href="#l13.124"></a><span id="l13.124"> }</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+/**</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+ * Handler function to be called when the cancel button is pressed.</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+ *</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+ */</span>
<a href="#l13.130"></a><span id="l13.130"> function onCancel() {</span>
<a href="#l13.131"></a><span id="l13.131">     var result = onCommandCancel();</span>
<a href="#l13.132"></a><span id="l13.132">     if (result == true) {</span>
<a href="#l13.133"></a><span id="l13.133">         dispose();</span>
<a href="#l13.134"></a><span id="l13.134">     }</span>
<a href="#l13.135"></a><span id="l13.135">     return result;</span>
<a href="#l13.136"></a><span id="l13.136"> }</span>
<a href="#l13.137"></a><span id="l13.137"> </span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+/**</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+ * Sets up all dialog controls from the information of the passed item.</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+ *</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+ * @param item      The item to parse information out of.</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+ */</span>
<a href="#l13.143"></a><span id="l13.143"> function loadDialog(item) {</span>
<a href="#l13.144"></a><span id="l13.144">     setElementValue(&quot;item-title&quot;, item.title);</span>
<a href="#l13.145"></a><span id="l13.145">     setElementValue(&quot;item-location&quot;, item.getProperty(&quot;LOCATION&quot;));</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147">     loadDateTime(item);</span>
<a href="#l13.148"></a><span id="l13.148"> </span>
<a href="#l13.149"></a><span id="l13.149">     // add calendars to the calendar menulist</span>
<a href="#l13.150"></a><span id="l13.150">     var calendarList = document.getElementById(&quot;item-calendar&quot;);</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineat">@@ -376,16 +417,21 @@ function loadDialog(item) {</span>
<a href="#l13.152"></a><span id="l13.152">     updateAttendees();</span>
<a href="#l13.153"></a><span id="l13.153">     updateRepeat();</span>
<a href="#l13.154"></a><span id="l13.154">     updateReminder();</span>
<a href="#l13.155"></a><span id="l13.155"> </span>
<a href="#l13.156"></a><span id="l13.156">     gShowTimeAs = item.getProperty(&quot;TRANSP&quot;);</span>
<a href="#l13.157"></a><span id="l13.157">     updateShowTimeAs();</span>
<a href="#l13.158"></a><span id="l13.158"> }</span>
<a href="#l13.159"></a><span id="l13.159"> </span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+/**</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+ * Sets up all date related controls from the passed item</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+ *</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+ * @param item      The item to parse information out of.</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+ */</span>
<a href="#l13.165"></a><span id="l13.165"> function loadDateTime(item) {</span>
<a href="#l13.166"></a><span id="l13.166">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l13.167"></a><span id="l13.167">     if (isEvent(item)) {</span>
<a href="#l13.168"></a><span id="l13.168">         var startTime = item.startDate;</span>
<a href="#l13.169"></a><span id="l13.169">         var endTime = item.endDate;</span>
<a href="#l13.170"></a><span id="l13.170">         var duration = endTime.subtractDate(startTime);</span>
<a href="#l13.171"></a><span id="l13.171"> </span>
<a href="#l13.172"></a><span id="l13.172">         // Check if an all-day event has been passed in (to adapt endDate).</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineat">@@ -434,16 +480,23 @@ function loadDateTime(item) {</span>
<a href="#l13.174"></a><span id="l13.174">         setElementValue(&quot;cmd_attendees&quot;, !(hasEntryDate &amp;&amp; hasDueDate), &quot;disabled&quot;);</span>
<a href="#l13.175"></a><span id="l13.175">         gStartTime = startTime;</span>
<a href="#l13.176"></a><span id="l13.176">         gEndTime = endTime;</span>
<a href="#l13.177"></a><span id="l13.177">         gItemDuration = duration;</span>
<a href="#l13.178"></a><span id="l13.178">     }</span>
<a href="#l13.179"></a><span id="l13.179"> }</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181"> </span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+/**</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+ * Handler function to be used when the start time or end time of the event have</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+ * changed. If aKeepDuration is true then the end time will be modified so that</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+ * the total duration of the item stays the same.</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+ *</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+ * @param aKeepDuration   If true, the duration will be kept constant.</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+ */</span>
<a href="#l13.189"></a><span id="l13.189"> function dateTimeControls2State(aKeepDuration) {</span>
<a href="#l13.190"></a><span id="l13.190">     if (gIgnoreUpdate) {</span>
<a href="#l13.191"></a><span id="l13.191">         return;</span>
<a href="#l13.192"></a><span id="l13.192">     }</span>
<a href="#l13.193"></a><span id="l13.193"> </span>
<a href="#l13.194"></a><span id="l13.194">     var startWidgetId;</span>
<a href="#l13.195"></a><span id="l13.195">     var endWidgetId;</span>
<a href="#l13.196"></a><span id="l13.196">     if (isEvent(window.calendarItem)) {</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineat">@@ -522,44 +575,60 @@ function dateTimeControls2State(aKeepDur</span>
<a href="#l13.198"></a><span id="l13.198">                 null,</span>
<a href="#l13.199"></a><span id="l13.199">                 document.title,</span>
<a href="#l13.200"></a><span id="l13.200">                 calGetString(&quot;calendar&quot;, &quot;warningNegativeDuration&quot;));</span>
<a href="#l13.201"></a><span id="l13.201">         }</span>
<a href="#l13.202"></a><span id="l13.202">         setTimeout(callback, 1);</span>
<a href="#l13.203"></a><span id="l13.203">     }</span>
<a href="#l13.204"></a><span id="l13.204"> }</span>
<a href="#l13.205"></a><span id="l13.205"> </span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+/**</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+ * Updates the entry date checkboxes, used for example when choosing an alarm:</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+ * the entry date needs to be checked in that case.</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+ */</span>
<a href="#l13.210"></a><span id="l13.210"> function updateEntryDate() {</span>
<a href="#l13.211"></a><span id="l13.211">     updateDateCheckboxes(</span>
<a href="#l13.212"></a><span id="l13.212">         &quot;todo-entrydate&quot;,</span>
<a href="#l13.213"></a><span id="l13.213">         &quot;todo-has-entrydate&quot;,</span>
<a href="#l13.214"></a><span id="l13.214">         {</span>
<a href="#l13.215"></a><span id="l13.215">             isValid: function() {</span>
<a href="#l13.216"></a><span id="l13.216">                 return gStartTime != null;</span>
<a href="#l13.217"></a><span id="l13.217">             },</span>
<a href="#l13.218"></a><span id="l13.218">             setDateTime: function(dt) {</span>
<a href="#l13.219"></a><span id="l13.219">                 gStartTime = dt;</span>
<a href="#l13.220"></a><span id="l13.220">             }</span>
<a href="#l13.221"></a><span id="l13.221">         });</span>
<a href="#l13.222"></a><span id="l13.222"> }</span>
<a href="#l13.223"></a><span id="l13.223"> </span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+/**</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+ * Updates the due date checkboxes.</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+ */</span>
<a href="#l13.227"></a><span id="l13.227"> function updateDueDate() {</span>
<a href="#l13.228"></a><span id="l13.228">     updateDateCheckboxes(</span>
<a href="#l13.229"></a><span id="l13.229">         &quot;todo-duedate&quot;,</span>
<a href="#l13.230"></a><span id="l13.230">         &quot;todo-has-duedate&quot;,</span>
<a href="#l13.231"></a><span id="l13.231">         {</span>
<a href="#l13.232"></a><span id="l13.232">             isValid: function() {</span>
<a href="#l13.233"></a><span id="l13.233">                 return gEndTime != null;</span>
<a href="#l13.234"></a><span id="l13.234">             },</span>
<a href="#l13.235"></a><span id="l13.235">             setDateTime: function(dt) {</span>
<a href="#l13.236"></a><span id="l13.236">                 gEndTime = dt;</span>
<a href="#l13.237"></a><span id="l13.237">             }</span>
<a href="#l13.238"></a><span id="l13.238">         });</span>
<a href="#l13.239"></a><span id="l13.239"> }</span>
<a href="#l13.240"></a><span id="l13.240"> </span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+/**</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+ * Common function used by updateEntryDate and updateDueDate to set up the</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+ * checkboxes correctly.</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+ *</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+ * @param aDatePickerId     The XUL id of the datepicker to update.</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+ * @param aCheckboxId       The XUL id of the corresponding checkbox.</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+ * @param aDateTime         An object implementing the isValid and setDateTime</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+ *                            methods. XXX explain.</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+ */</span>
<a href="#l13.250"></a><span id="l13.250"> function updateDateCheckboxes(aDatePickerId, aCheckboxId, aDateTime) {</span>
<a href="#l13.251"></a><span id="l13.251">     if (gIgnoreUpdate) {</span>
<a href="#l13.252"></a><span id="l13.252">         return;</span>
<a href="#l13.253"></a><span id="l13.253">     }</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255">     if (!isToDo(window.calendarItem)) {</span>
<a href="#l13.256"></a><span id="l13.256">         return;</span>
<a href="#l13.257"></a><span id="l13.257">     }</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineat">@@ -589,16 +658,22 @@ function updateDateCheckboxes(aDatePicke</span>
<a href="#l13.259"></a><span id="l13.259">     } else {</span>
<a href="#l13.260"></a><span id="l13.260">         gItemDuration = null;</span>
<a href="#l13.261"></a><span id="l13.261">     }</span>
<a href="#l13.262"></a><span id="l13.262">     setElementValue(&quot;cmd_attendees&quot;, !(hasEntryDate &amp;&amp; hasDueDate), &quot;disabled&quot;);</span>
<a href="#l13.263"></a><span id="l13.263">     updateDateTime();</span>
<a href="#l13.264"></a><span id="l13.264">     updateTimezone();</span>
<a href="#l13.265"></a><span id="l13.265"> }</span>
<a href="#l13.266"></a><span id="l13.266"> </span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+/**</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+ * Update the dialog controls to display the item's recurrence information</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+ * nicely.</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+ *</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+ * @param item    The item to load.</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+ */</span>
<a href="#l13.273"></a><span id="l13.273"> function loadRepeat(item) {</span>
<a href="#l13.274"></a><span id="l13.274">     var recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l13.275"></a><span id="l13.275">     setElementValue(&quot;item-repeat&quot;, &quot;none&quot;);</span>
<a href="#l13.276"></a><span id="l13.276">     if (recurrenceInfo) {</span>
<a href="#l13.277"></a><span id="l13.277">         setElementValue(&quot;item-repeat&quot;, &quot;custom&quot;);</span>
<a href="#l13.278"></a><span id="l13.278">         var ritems = recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l13.279"></a><span id="l13.279">         var rules = [];</span>
<a href="#l13.280"></a><span id="l13.280">         var exceptions = [];</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineat">@@ -698,21 +773,29 @@ function loadRepeat(item) {</span>
<a href="#l13.282"></a><span id="l13.282">     var repeatMenu = document.getElementById(&quot;item-repeat&quot;);</span>
<a href="#l13.283"></a><span id="l13.283">     gLastRepeatSelection = repeatMenu.selectedIndex;</span>
<a href="#l13.284"></a><span id="l13.284"> </span>
<a href="#l13.285"></a><span id="l13.285">     if (item.parentItem != item) {</span>
<a href="#l13.286"></a><span id="l13.286">         disableElement(&quot;item-repeat&quot;);</span>
<a href="#l13.287"></a><span id="l13.287">     }</span>
<a href="#l13.288"></a><span id="l13.288"> }</span>
<a href="#l13.289"></a><span id="l13.289"> </span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+/**</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+ * Update reminder related elements on the dialog.</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+ */</span>
<a href="#l13.293"></a><span id="l13.293"> function updateReminder() {</span>
<a href="#l13.294"></a><span id="l13.294">     commonUpdateReminder();</span>
<a href="#l13.295"></a><span id="l13.295">     updateAccept();</span>
<a href="#l13.296"></a><span id="l13.296"> }</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+/**</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+ * Saves all values the user chose on the dialog to the passed item</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+ *</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+ * @param item    The item to save to.</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+ */</span>
<a href="#l13.303"></a><span id="l13.303"> function saveDialog(item) {</span>
<a href="#l13.304"></a><span id="l13.304">     // Calendar</span>
<a href="#l13.305"></a><span id="l13.305">     item.calendar = document.getElementById(&quot;item-calendar&quot;)</span>
<a href="#l13.306"></a><span id="l13.306">                             .selectedItem.calendar;</span>
<a href="#l13.307"></a><span id="l13.307"> </span>
<a href="#l13.308"></a><span id="l13.308">     setItemProperty(item, &quot;title&quot;, getElementValue(&quot;item-title&quot;));</span>
<a href="#l13.309"></a><span id="l13.309">     setItemProperty(item, &quot;LOCATION&quot;, getElementValue(&quot;item-location&quot;));</span>
<a href="#l13.310"></a><span id="l13.310"> </span>
<a href="#l13.311"></a><span id="l13.311" class="difflineat">@@ -788,16 +871,21 @@ function saveDialog(item) {</span>
<a href="#l13.312"></a><span id="l13.312">     if (item.status == &quot;COMPLETED&quot; &amp;&amp; isToDo(item)) {</span>
<a href="#l13.313"></a><span id="l13.313">         var elementValue = getElementValue(&quot;completed-date-picker&quot;);</span>
<a href="#l13.314"></a><span id="l13.314">         item.completedDate = jsDateToDateTime(elementValue);</span>
<a href="#l13.315"></a><span id="l13.315">     }</span>
<a href="#l13.316"></a><span id="l13.316"> </span>
<a href="#l13.317"></a><span id="l13.317">     saveReminder(item);</span>
<a href="#l13.318"></a><span id="l13.318"> }</span>
<a href="#l13.319"></a><span id="l13.319"> </span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+/**</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+ * Save date and time related values from the dialog to the passed item.</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+ *</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+ * @param item    The item to save to.</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+ */</span>
<a href="#l13.325"></a><span id="l13.325"> function saveDateTime(item) {</span>
<a href="#l13.326"></a><span id="l13.326">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l13.327"></a><span id="l13.327">     if (isEvent(item)) {</span>
<a href="#l13.328"></a><span id="l13.328">         var startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l13.329"></a><span id="l13.329">         var endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l13.330"></a><span id="l13.330">         var isAllDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l13.331"></a><span id="l13.331">         if (isAllDay) {</span>
<a href="#l13.332"></a><span id="l13.332">             startTime = startTime.clone();</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineat">@@ -817,16 +905,20 @@ function saveDateTime(item) {</span>
<a href="#l13.334"></a><span id="l13.334">     if (isToDo(item)) {</span>
<a href="#l13.335"></a><span id="l13.335">         var startTime = gStartTime &amp;&amp; gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l13.336"></a><span id="l13.336">         var endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l13.337"></a><span id="l13.337">         setItemProperty(item, &quot;entryDate&quot;, startTime);</span>
<a href="#l13.338"></a><span id="l13.338">         setItemProperty(item, &quot;dueDate&quot;, endTime);</span>
<a href="#l13.339"></a><span id="l13.339">     }</span>
<a href="#l13.340"></a><span id="l13.340"> }</span>
<a href="#l13.341"></a><span id="l13.341"> </span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+/**</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+ * Updates the dialog title based on item type and if the item is new or to be</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+ * modified.</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+ */</span>
<a href="#l13.346"></a><span id="l13.346"> function updateTitle() {</span>
<a href="#l13.347"></a><span id="l13.347">     var title = &quot;&quot;;</span>
<a href="#l13.348"></a><span id="l13.348">     var isNew = window.calendarItem.isMutable;</span>
<a href="#l13.349"></a><span id="l13.349">     if (isEvent(window.calendarItem)) {</span>
<a href="#l13.350"></a><span id="l13.350">         if (isNew) {</span>
<a href="#l13.351"></a><span id="l13.351">             title = calGetString(&quot;calendar&quot;, &quot;newEventDialog&quot;);</span>
<a href="#l13.352"></a><span id="l13.352">         } else {</span>
<a href="#l13.353"></a><span id="l13.353">             title = calGetString(&quot;calendar&quot;, &quot;editEventDialog&quot;);</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineat">@@ -838,16 +930,27 @@ function updateTitle() {</span>
<a href="#l13.355"></a><span id="l13.355">             title = calGetString(&quot;calendar&quot;, &quot;editTaskDialog&quot;);</span>
<a href="#l13.356"></a><span id="l13.356">         }</span>
<a href="#l13.357"></a><span id="l13.357">     }</span>
<a href="#l13.358"></a><span id="l13.358">     title += ': ';</span>
<a href="#l13.359"></a><span id="l13.359">     title += getElementValue(&quot;item-title&quot;);</span>
<a href="#l13.360"></a><span id="l13.360">     document.title = title;</span>
<a href="#l13.361"></a><span id="l13.361"> }</span>
<a href="#l13.362"></a><span id="l13.362"> </span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+/**</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+ * Updates the stylesheet to add rules to hide certain aspects (i.e task only</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+ * elements when editing an event).</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+ *</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+ * TODO We can use general rules here, i.e </span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+ *      dialog[itemType=&quot;task&quot;] .event-only,</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+ *      dialog[itemType=&quot;event&quot;] .task-only,</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+ *      dialog:not([product=&quot;lightning&quot;]) .lightning-only {</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+ *          display: none;</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+ *      }</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+ */</span>
<a href="#l13.374"></a><span id="l13.374"> function updateStyle() {</span>
<a href="#l13.375"></a><span id="l13.375">     const kDialogStylesheet = &quot;chrome://calendar/content/calendar-event-dialog.css&quot;;</span>
<a href="#l13.376"></a><span id="l13.376"> </span>
<a href="#l13.377"></a><span id="l13.377">     for each (var stylesheet in document.styleSheets) {</span>
<a href="#l13.378"></a><span id="l13.378">         if (stylesheet.href == kDialogStylesheet) {</span>
<a href="#l13.379"></a><span id="l13.379">             if (isSunbird()) {</span>
<a href="#l13.380"></a><span id="l13.380">                 stylesheet.insertRule(&quot;.lightning-only { display: none; }&quot;, 0);</span>
<a href="#l13.381"></a><span id="l13.381">             }</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineat">@@ -856,16 +959,23 @@ function updateStyle() {</span>
<a href="#l13.383"></a><span id="l13.383">             } else if (isToDo(window.calendarItem)) {</span>
<a href="#l13.384"></a><span id="l13.384">                 stylesheet.insertRule(&quot;.event-only { display: none; }&quot;, 0);</span>
<a href="#l13.385"></a><span id="l13.385">             }</span>
<a href="#l13.386"></a><span id="l13.386">             return;</span>
<a href="#l13.387"></a><span id="l13.387">         }</span>
<a href="#l13.388"></a><span id="l13.388">     }</span>
<a href="#l13.389"></a><span id="l13.389"> }</span>
<a href="#l13.390"></a><span id="l13.390"> </span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+/**</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+ * Handler function for showing the options menu</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+ *</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+ * XXX This function could go away with more general CSS rules?</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+ *</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+ * @param menuPopup   The menupopup node targetted by the event.</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+ */</span>
<a href="#l13.398"></a><span id="l13.398"> function onPopupShowing(menuPopup) {</span>
<a href="#l13.399"></a><span id="l13.399">     if (isToDo(window.calendarItem)) {</span>
<a href="#l13.400"></a><span id="l13.400">         var nodes = menuPopup.childNodes;</span>
<a href="#l13.401"></a><span id="l13.401">         for (var i = nodes.length - 1; i &gt;= 0; --i) {</span>
<a href="#l13.402"></a><span id="l13.402">             var node = nodes[i];</span>
<a href="#l13.403"></a><span id="l13.403">             if (node.hasAttribute('class')) {</span>
<a href="#l13.404"></a><span id="l13.404">                 if (node.getAttribute('class').split(' ').some(</span>
<a href="#l13.405"></a><span id="l13.405">                     function (element) {</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineat">@@ -873,16 +983,21 @@ function onPopupShowing(menuPopup) {</span>
<a href="#l13.407"></a><span id="l13.407">                     })) {</span>
<a href="#l13.408"></a><span id="l13.408">                     menuPopup.removeChild(node);</span>
<a href="#l13.409"></a><span id="l13.409">                 }</span>
<a href="#l13.410"></a><span id="l13.410">             }</span>
<a href="#l13.411"></a><span id="l13.411">         }</span>
<a href="#l13.412"></a><span id="l13.412">     }</span>
<a href="#l13.413"></a><span id="l13.413"> }</span>
<a href="#l13.414"></a><span id="l13.414"> </span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+/**</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+ * Update the disabled status of the accept button. The button is enabled if all</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+ * parts of the dialog have options selected that make sense.</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+ * constraining factors like</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+ */</span>
<a href="#l13.420"></a><span id="l13.420"> function updateAccept() {</span>
<a href="#l13.421"></a><span id="l13.421">     var enableAccept = true;</span>
<a href="#l13.422"></a><span id="l13.422"> </span>
<a href="#l13.423"></a><span id="l13.423">     var kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l13.424"></a><span id="l13.424"> </span>
<a href="#l13.425"></a><span id="l13.425">     // don't allow for end dates to be before start dates</span>
<a href="#l13.426"></a><span id="l13.426">     var startDate;</span>
<a href="#l13.427"></a><span id="l13.427">     var endDate;</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineat">@@ -942,37 +1057,41 @@ function updateAccept() {</span>
<a href="#l13.429"></a><span id="l13.429">         accept.removeAttribute('disabled');</span>
<a href="#l13.430"></a><span id="l13.430">     } else {</span>
<a href="#l13.431"></a><span id="l13.431">         accept.setAttribute('disabled', 'true');</span>
<a href="#l13.432"></a><span id="l13.432">     }</span>
<a href="#l13.433"></a><span id="l13.433"> </span>
<a href="#l13.434"></a><span id="l13.434">     return enableAccept;</span>
<a href="#l13.435"></a><span id="l13.435"> }</span>
<a href="#l13.436"></a><span id="l13.436"> </span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+/**</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+ * Handler function to update controls in consequence of the &quot;all day&quot; checkbox</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+ * being clicked.</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+ */</span>
<a href="#l13.441"></a><span id="l13.441"> function onUpdateAllDay() {</span>
<a href="#l13.442"></a><span id="l13.442">     if (!isEvent(window.calendarItem)) {</span>
<a href="#l13.443"></a><span id="l13.443">         return;</span>
<a href="#l13.444"></a><span id="l13.444">     }</span>
<a href="#l13.445"></a><span id="l13.445">     var allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l13.446"></a><span id="l13.446">     gStartTimezone = (allDay ? floating(): calendarDefaultTimezone());</span>
<a href="#l13.447"></a><span id="l13.447">     gEndTimezone = gStartTimezone;</span>
<a href="#l13.448"></a><span id="l13.448">     gStartTime.timezone = gStartTimezone;</span>
<a href="#l13.449"></a><span id="l13.449">     gEndTime.timezone = gEndTimezone;</span>
<a href="#l13.450"></a><span id="l13.450">     updateAllDay();</span>
<a href="#l13.451"></a><span id="l13.451"> }</span>
<a href="#l13.452"></a><span id="l13.452"> </span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-// this function sets the enabled/disabled</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-// state of the following controls:</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-// - 'event-starttime'</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-// - 'event-endtime'</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-// - 'timezone-starttime'</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-// - 'timezone-endtime'</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-// the state depends on whether or not the</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-// event is configured as 'all-day' or not.</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-function updateAllDay() {</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+/**</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+ * This function sets the enabled/disabled state of the following controls:</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+ * - 'event-starttime'</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+ * - 'event-endtime'</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+ * - 'timezone-starttime'</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+ * - 'timezone-endtime'</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+ * the state depends on whether or not the event is configured as 'all-day' or not.</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+ */</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+ function updateAllDay() {</span>
<a href="#l13.471"></a><span id="l13.471">     if (gIgnoreUpdate) {</span>
<a href="#l13.472"></a><span id="l13.472">         return;</span>
<a href="#l13.473"></a><span id="l13.473">     }</span>
<a href="#l13.474"></a><span id="l13.474"> </span>
<a href="#l13.475"></a><span id="l13.475">     if (!isEvent(window.calendarItem)) {</span>
<a href="#l13.476"></a><span id="l13.476">         return;</span>
<a href="#l13.477"></a><span id="l13.477">     }</span>
<a href="#l13.478"></a><span id="l13.478"> </span>
<a href="#l13.479"></a><span id="l13.479" class="difflineat">@@ -988,43 +1107,57 @@ function updateAllDay() {</span>
<a href="#l13.480"></a><span id="l13.480">     gStartTime.isDate = allDay;</span>
<a href="#l13.481"></a><span id="l13.481">     gEndTime.isDate = allDay;</span>
<a href="#l13.482"></a><span id="l13.482"> </span>
<a href="#l13.483"></a><span id="l13.483">     updateDateTime();</span>
<a href="#l13.484"></a><span id="l13.484">     updateRepeatDetails();</span>
<a href="#l13.485"></a><span id="l13.485">     updateAccept();</span>
<a href="#l13.486"></a><span id="l13.486"> }</span>
<a href="#l13.487"></a><span id="l13.487"> </span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+/**</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+ * Use the window arguments to cause the opener to create a new event on the</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+ * item's calendar</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+ */</span>
<a href="#l13.492"></a><span id="l13.492"> function openNewEvent() {</span>
<a href="#l13.493"></a><span id="l13.493">     var item = window.calendarItem;</span>
<a href="#l13.494"></a><span id="l13.494">     var args = window.arguments[0];</span>
<a href="#l13.495"></a><span id="l13.495">     args.onNewEvent(item.calendar);</span>
<a href="#l13.496"></a><span id="l13.496"> }</span>
<a href="#l13.497"></a><span id="l13.497"> </span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+/**</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+ * Open a new Thunderbird compose window.</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+ */</span>
<a href="#l13.501"></a><span id="l13.501"> function openNewMessage() {</span>
<a href="#l13.502"></a><span id="l13.502">     var msgComposeService = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l13.503"></a><span id="l13.503">                             .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l13.504"></a><span id="l13.504">     msgComposeService.OpenComposeWindow(null,</span>
<a href="#l13.505"></a><span id="l13.505">                                         null,</span>
<a href="#l13.506"></a><span id="l13.506">                                         null,</span>
<a href="#l13.507"></a><span id="l13.507">                                         Components.interfaces.nsIMsgCompType.New,</span>
<a href="#l13.508"></a><span id="l13.508">                                         Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l13.509"></a><span id="l13.509">                                         null,</span>
<a href="#l13.510"></a><span id="l13.510">                                         null);</span>
<a href="#l13.511"></a><span id="l13.511"> }</span>
<a href="#l13.512"></a><span id="l13.512"> </span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+/**</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+ * Open a new addressbook window</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+ */</span>
<a href="#l13.516"></a><span id="l13.516"> function openNewCardDialog() {</span>
<a href="#l13.517"></a><span id="l13.517">     window.openDialog(</span>
<a href="#l13.518"></a><span id="l13.518">         &quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l13.519"></a><span id="l13.519">         &quot;&quot;,</span>
<a href="#l13.520"></a><span id="l13.520">         &quot;chrome,resizable=no,titlebar,modal&quot;);</span>
<a href="#l13.521"></a><span id="l13.521"> }</span>
<a href="#l13.522"></a><span id="l13.522"> </span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-// automatically select pref calendar.allday.defaultTransparency if this</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineminus">-// event is said to be all-day.</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+/**</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+ * Update the transparency status of this dialog, depending on if the event</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+ * is all-day or not.</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+ *</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+ * @param allDay    If true, the event is all-day</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+ */</span>
<a href="#l13.531"></a><span id="l13.531"> function setShowTimeAs(allDay) {</span>
<a href="#l13.532"></a><span id="l13.532">     gShowTimeAs = (allDay ? getPrefSafe(&quot;calendar.allday.defaultTransparency&quot;, &quot;TRANSPARENT&quot;) : &quot;OPAQUE&quot;);</span>
<a href="#l13.533"></a><span id="l13.533">     updateShowTimeAs();</span>
<a href="#l13.534"></a><span id="l13.534"> }</span>
<a href="#l13.535"></a><span id="l13.535"> </span>
<a href="#l13.536"></a><span id="l13.536"> function editAttendees() {</span>
<a href="#l13.537"></a><span id="l13.537">     var savedWindow = window;</span>
<a href="#l13.538"></a><span id="l13.538">     var calendar = document.getElementById(&quot;item-calendar&quot;)</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineat">@@ -1221,21 +1354,30 @@ function updatePrivacy() {</span>
<a href="#l13.540"></a><span id="l13.540"> </span>
<a href="#l13.541"></a><span id="l13.541">     } else {</span>
<a href="#l13.542"></a><span id="l13.542">         setElementValue(&quot;button-privacy&quot;, !hasPrivacy &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l13.543"></a><span id="l13.543">         setElementValue(&quot;options-privacy-menu&quot;, !hasPrivacy &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l13.544"></a><span id="l13.544">         setElementValue(&quot;status-privacy&quot;, !hasPrivacy &amp;&amp; &quot;true&quot;, &quot;collapsed&quot;);</span>
<a href="#l13.545"></a><span id="l13.545">     }</span>
<a href="#l13.546"></a><span id="l13.546"> }</span>
<a href="#l13.547"></a><span id="l13.547"> </span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+/**</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+ * Handler function to change the priority from the dialog elements</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+ *</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+ * @param target    A XUL node with a value attribute which should be the new</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+ *                    priority.</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+ */</span>
<a href="#l13.554"></a><span id="l13.554"> function editPriority(target) {</span>
<a href="#l13.555"></a><span id="l13.555">     gPriority = parseInt(target.getAttribute(&quot;value&quot;));</span>
<a href="#l13.556"></a><span id="l13.556">     updatePriority();</span>
<a href="#l13.557"></a><span id="l13.557"> }</span>
<a href="#l13.558"></a><span id="l13.558"> </span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+/**</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+ * Update the dialog controls related related to priority.</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+ */</span>
<a href="#l13.562"></a><span id="l13.562"> function updatePriority() {</span>
<a href="#l13.563"></a><span id="l13.563">     // Set up capabilities</span>
<a href="#l13.564"></a><span id="l13.564">     var hasPriority = capSupported(&quot;priority&quot;);</span>
<a href="#l13.565"></a><span id="l13.565">     setElementValue(&quot;options-priority-menu&quot;, !hasPriority &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l13.566"></a><span id="l13.566">     setElementValue(&quot;status-priority&quot;, !hasPriority &amp;&amp; &quot;true&quot;, &quot;collapsed&quot;);</span>
<a href="#l13.567"></a><span id="l13.567"> </span>
<a href="#l13.568"></a><span id="l13.568">     if (hasPriority) {</span>
<a href="#l13.569"></a><span id="l13.569">         var priorityLevel = &quot;none&quot;;</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineat">@@ -1280,50 +1422,71 @@ function updatePriority() {</span>
<a href="#l13.571"></a><span id="l13.571">                 if (node.getAttribute(&quot;value&quot;) == priorityLevel) {</span>
<a href="#l13.572"></a><span id="l13.572">                     foundPriority = true;</span>
<a href="#l13.573"></a><span id="l13.573">                 }</span>
<a href="#l13.574"></a><span id="l13.574">             }</span>
<a href="#l13.575"></a><span id="l13.575">         }</span>
<a href="#l13.576"></a><span id="l13.576">     }</span>
<a href="#l13.577"></a><span id="l13.577"> }</span>
<a href="#l13.578"></a><span id="l13.578"> </span>
<a href="#l13.579"></a><span id="l13.579" class="difflineplus">+/**</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineplus">+ * Handler function to change the status from the dialog elements</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+ *</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineplus">+ * @param target    A XUL node with a value attribute which should be the new</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+ *                    status.</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+ */</span>
<a href="#l13.585"></a><span id="l13.585"> function editStatus(target) {</span>
<a href="#l13.586"></a><span id="l13.586">     gStatus = target.getAttribute(&quot;value&quot;);</span>
<a href="#l13.587"></a><span id="l13.587">     updateStatus();</span>
<a href="#l13.588"></a><span id="l13.588"> }</span>
<a href="#l13.589"></a><span id="l13.589"> </span>
<a href="#l13.590"></a><span id="l13.590" class="difflineplus">+/**</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineplus">+ * Update the dialog controls related related to status.</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+ */</span>
<a href="#l13.593"></a><span id="l13.593"> function updateStatus() {</span>
<a href="#l13.594"></a><span id="l13.594">     [ &quot;cmd_status_none&quot;,</span>
<a href="#l13.595"></a><span id="l13.595">       &quot;cmd_status_tentative&quot;,</span>
<a href="#l13.596"></a><span id="l13.596">       &quot;cmd_status_confirmed&quot;,</span>
<a href="#l13.597"></a><span id="l13.597">       &quot;cmd_status_cancelled&quot; ].forEach(</span>
<a href="#l13.598"></a><span id="l13.598">           function(element, index, array) {</span>
<a href="#l13.599"></a><span id="l13.599">               var node = document.getElementById(element);</span>
<a href="#l13.600"></a><span id="l13.600">               node.setAttribute(&quot;checked&quot;,</span>
<a href="#l13.601"></a><span id="l13.601">                   node.getAttribute(&quot;value&quot;) == gStatus ?</span>
<a href="#l13.602"></a><span id="l13.602">                       &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l13.603"></a><span id="l13.603">           }</span>
<a href="#l13.604"></a><span id="l13.604">       );</span>
<a href="#l13.605"></a><span id="l13.605"> }</span>
<a href="#l13.606"></a><span id="l13.606"> </span>
<a href="#l13.607"></a><span id="l13.607" class="difflineplus">+/**</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineplus">+ * Handler function to change the transparency from the dialog elements</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineplus">+ *</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineplus">+ * @param target    A XUL node with a value attribute which should be the new</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+ *                    transparency.</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+ */</span>
<a href="#l13.613"></a><span id="l13.613"> function editShowTimeAs(target) {</span>
<a href="#l13.614"></a><span id="l13.614">     gShowTimeAs = target.getAttribute(&quot;value&quot;);</span>
<a href="#l13.615"></a><span id="l13.615">     updateShowTimeAs();</span>
<a href="#l13.616"></a><span id="l13.616"> }</span>
<a href="#l13.617"></a><span id="l13.617"> </span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+/**</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+ * Update the dialog controls related related to transparency.</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+ */</span>
<a href="#l13.621"></a><span id="l13.621"> function updateShowTimeAs() {</span>
<a href="#l13.622"></a><span id="l13.622">     var showAsBusy = document.getElementById(&quot;cmd_showtimeas_busy&quot;);</span>
<a href="#l13.623"></a><span id="l13.623">     var showAsFree = document.getElementById(&quot;cmd_showtimeas_free&quot;);</span>
<a href="#l13.624"></a><span id="l13.624"> </span>
<a href="#l13.625"></a><span id="l13.625">     showAsBusy.setAttribute(&quot;checked&quot;,</span>
<a href="#l13.626"></a><span id="l13.626">                             gShowTimeAs == &quot;OPAQUE&quot; ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l13.627"></a><span id="l13.627">     showAsFree.setAttribute(&quot;checked&quot;,</span>
<a href="#l13.628"></a><span id="l13.628">                             gShowTimeAs == &quot;TRANSPARENT&quot; ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l13.629"></a><span id="l13.629"> }</span>
<a href="#l13.630"></a><span id="l13.630"> </span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+/**</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineplus">+ * Prompts the user to attach an url to this item.</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+ */</span>
<a href="#l13.634"></a><span id="l13.634"> function attachURL() {</span>
<a href="#l13.635"></a><span id="l13.635">     var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l13.636"></a><span id="l13.636">                        .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l13.637"></a><span id="l13.637">     if (promptService) {</span>
<a href="#l13.638"></a><span id="l13.638">         // ghost in an example...</span>
<a href="#l13.639"></a><span id="l13.639">         var result = { value: &quot;http://&quot; };</span>
<a href="#l13.640"></a><span id="l13.640">         if (promptService.prompt(window,</span>
<a href="#l13.641"></a><span id="l13.641">                                  calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineat">@@ -1399,38 +1562,61 @@ function attachFile() {</span>
<a href="#l13.643"></a><span id="l13.643">             attachment.uri = makeURL(uriSpec);</span>
<a href="#l13.644"></a><span id="l13.644">             // TODO: set the formattype, but this isn't urgent as we don't have</span>
<a href="#l13.645"></a><span id="l13.645">             // a type sensitive dialog to start files.</span>
<a href="#l13.646"></a><span id="l13.646">             addAttachment(attachment);</span>
<a href="#l13.647"></a><span id="l13.647">         }</span>
<a href="#l13.648"></a><span id="l13.648">     } </span>
<a href="#l13.649"></a><span id="l13.649"> }</span>
<a href="#l13.650"></a><span id="l13.650"> </span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+/**</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineplus">+ * Helper function to remember the last directory chosen when attaching files.</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+ * XXX This function is currently unused, will be needed when we support</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+ * attaching files.</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineplus">+ *</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineplus">+ * @param aFileUri    (optional) If passed, the last directory will be set and</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+ *                                 returned. If null, the last chosen directory</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+ *                                 will be returned.</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+ * @return            The last directory that was set with this function.</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+ */</span>
<a href="#l13.661"></a><span id="l13.661"> function lastDirectory(aFileUri) {</span>
<a href="#l13.662"></a><span id="l13.662">     if (aFileUri) {</span>
<a href="#l13.663"></a><span id="l13.663">         // Act similar to a setter, save the passed uri.</span>
<a href="#l13.664"></a><span id="l13.664">         var uri = makeURL(aFileUri);</span>
<a href="#l13.665"></a><span id="l13.665">         var file = uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l13.666"></a><span id="l13.666">         lastDirectory.mValue = file.parent.QueryInterface(Components.interfaces.nsILocalFile);</span>
<a href="#l13.667"></a><span id="l13.667">     }</span>
<a href="#l13.668"></a><span id="l13.668">     </span>
<a href="#l13.669"></a><span id="l13.669">     // In any case, return the value</span>
<a href="#l13.670"></a><span id="l13.670">     return (lastDirectory.mValue !== undefined ? lastDirectory.mValue : null);</span>
<a href="#l13.671"></a><span id="l13.671"> }</span>
<a href="#l13.672"></a><span id="l13.672"> </span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+/**</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+ * Turns an url into a string that can be used in UI.</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineplus">+ * - For a file:// url, shows the filename.</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineplus">+ * - For a http:// url, removes protocol and trailing slash</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+ *</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+ * @param aUri    The uri to parse.</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineplus">+ * @return        A string that can be used in UI.</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+ */</span>
<a href="#l13.681"></a><span id="l13.681"> function makePrettyName(aUri){</span>
<a href="#l13.682"></a><span id="l13.682">     var name = aUri.spec;</span>
<a href="#l13.683"></a><span id="l13.683">     if (aUri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l13.684"></a><span id="l13.684">         name = aUri.spec.split(&quot;/&quot;).pop(); </span>
<a href="#l13.685"></a><span id="l13.685">     } else if (aUri.schemeIs(&quot;http&quot;)) {</span>
<a href="#l13.686"></a><span id="l13.686">         name = aUri.spec.replace(/\/$/, &quot;&quot;).replace(/^http:\/\//, &quot;&quot;);</span>
<a href="#l13.687"></a><span id="l13.687">     }</span>
<a href="#l13.688"></a><span id="l13.688">     return name;</span>
<a href="#l13.689"></a><span id="l13.689"> }</span>
<a href="#l13.690"></a><span id="l13.690"> </span>
<a href="#l13.691"></a><span id="l13.691" class="difflineplus">+/**</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineplus">+ * Adds the given attachment to dialog controls.</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+ *</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineplus">+ * @param attachment    The calIAttachment object to add</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+ */</span>
<a href="#l13.696"></a><span id="l13.696"> function addAttachment(attachment) {</span>
<a href="#l13.697"></a><span id="l13.697">     if (!attachment ||</span>
<a href="#l13.698"></a><span id="l13.698">         !attachment.uri ||</span>
<a href="#l13.699"></a><span id="l13.699">         attachment.uri.spec in gAttachMap) {</span>
<a href="#l13.700"></a><span id="l13.700">         return;</span>
<a href="#l13.701"></a><span id="l13.701">     }</span>
<a href="#l13.702"></a><span id="l13.702"> </span>
<a href="#l13.703"></a><span id="l13.703">     var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineat">@@ -1450,23 +1636,31 @@ function addAttachment(attachment) {</span>
<a href="#l13.705"></a><span id="l13.705">     item.attachment = attachment; </span>
<a href="#l13.706"></a><span id="l13.706"> </span>
<a href="#l13.707"></a><span id="l13.707">     // Update the number of rows and save our attachment globally</span>
<a href="#l13.708"></a><span id="l13.708">     documentLink.rows = documentLink.getRowCount();</span>
<a href="#l13.709"></a><span id="l13.709">     gAttachMap[attachment.uri.spec] = attachment;</span>
<a href="#l13.710"></a><span id="l13.710">     updateAttachment();</span>
<a href="#l13.711"></a><span id="l13.711"> }</span>
<a href="#l13.712"></a><span id="l13.712"> </span>
<a href="#l13.713"></a><span id="l13.713" class="difflineplus">+/**</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+ * Removes the currently selected attachment from the dialog controls.</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineplus">+ *</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineplus">+ * XXX This could use a dialog maybe?</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+ */</span>
<a href="#l13.718"></a><span id="l13.718"> function deleteAttachment() {</span>
<a href="#l13.719"></a><span id="l13.719">     var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l13.720"></a><span id="l13.720">     delete gAttachMap[documentLink.selectedItem.attachment.uri.spec];</span>
<a href="#l13.721"></a><span id="l13.721">     documentLink.removeItemAt(documentLink.selectedIndex);</span>
<a href="#l13.722"></a><span id="l13.722">     updateAttachment();</span>
<a href="#l13.723"></a><span id="l13.723"> }</span>
<a href="#l13.724"></a><span id="l13.724"> </span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+/**</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+ * Removes all attachments from the dialog controls.</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+ */</span>
<a href="#l13.728"></a><span id="l13.728"> function deleteAllAttachments() {</span>
<a href="#l13.729"></a><span id="l13.729">     var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l13.730"></a><span id="l13.730">     var itemCount = documentLink.getRowCount();</span>
<a href="#l13.731"></a><span id="l13.731">     var ok = (itemCount &lt; 2);</span>
<a href="#l13.732"></a><span id="l13.732"> </span>
<a href="#l13.733"></a><span id="l13.733">     if (itemCount &gt; 1) {</span>
<a href="#l13.734"></a><span id="l13.734">         var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l13.735"></a><span id="l13.735">                                       .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineat">@@ -1486,55 +1680,72 @@ function deleteAllAttachments() {</span>
<a href="#l13.737"></a><span id="l13.737">             child = documentLink.removeChild(documentLink.lastChild);</span>
<a href="#l13.738"></a><span id="l13.738">             child.attachment = null;</span>
<a href="#l13.739"></a><span id="l13.739">         }</span>
<a href="#l13.740"></a><span id="l13.740">         gAttachMap = {};</span>
<a href="#l13.741"></a><span id="l13.741">     }</span>
<a href="#l13.742"></a><span id="l13.742">     updateAttachment();</span>
<a href="#l13.743"></a><span id="l13.743"> }</span>
<a href="#l13.744"></a><span id="l13.744"> </span>
<a href="#l13.745"></a><span id="l13.745" class="difflineplus">+/**</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineplus">+ * Opens the selected attachment using the external protocol service.</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineplus">+ * @see nsIExternalProtocolService</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineplus">+ */</span>
<a href="#l13.749"></a><span id="l13.749"> function openAttachment() {</span>
<a href="#l13.750"></a><span id="l13.750">     // Only one file has to be selected and we don't handle base64 files at all</span>
<a href="#l13.751"></a><span id="l13.751">     var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l13.752"></a><span id="l13.752">     if (documentLink.selectedItems.length == 1) {</span>
<a href="#l13.753"></a><span id="l13.753">         var attURI = documentLink.getSelectedItem(0).attachment.uri;</span>
<a href="#l13.754"></a><span id="l13.754">         var externalLoader = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l13.755"></a><span id="l13.755">                                        .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l13.756"></a><span id="l13.756">         // TODO There should be a nicer dialog</span>
<a href="#l13.757"></a><span id="l13.757">         externalLoader.loadUrl(attURI);   </span>
<a href="#l13.758"></a><span id="l13.758">     }</span>
<a href="#l13.759"></a><span id="l13.759"> }</span>
<a href="#l13.760"></a><span id="l13.760"> </span>
<a href="#l13.761"></a><span id="l13.761" class="difflineplus">+/**</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineplus">+ * Handler function to handle pressing keys in the attachment listbox.</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineplus">+ *</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineplus">+ * @param event     The DOM event caused by the key press.</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineplus">+ */</span>
<a href="#l13.766"></a><span id="l13.766"> function attachmentLinkKeyPress(event) {</span>
<a href="#l13.767"></a><span id="l13.767">     const kKE = Components.interfaces.nsIDOMKeyEvent;</span>
<a href="#l13.768"></a><span id="l13.768">     switch (event.keyCode) {</span>
<a href="#l13.769"></a><span id="l13.769">         case kKE.DOM_VK_BACK_SPACE:</span>
<a href="#l13.770"></a><span id="l13.770">         case kKE.DOM_VK_DELETE:</span>
<a href="#l13.771"></a><span id="l13.771">             deleteAttachment();</span>
<a href="#l13.772"></a><span id="l13.772">             break;</span>
<a href="#l13.773"></a><span id="l13.773">         case kKE.DOM_VK_ENTER:</span>
<a href="#l13.774"></a><span id="l13.774">             openAttachment();</span>
<a href="#l13.775"></a><span id="l13.775">             break;</span>
<a href="#l13.776"></a><span id="l13.776">     }</span>
<a href="#l13.777"></a><span id="l13.777"> }</span>
<a href="#l13.778"></a><span id="l13.778"> </span>
<a href="#l13.779"></a><span id="l13.779" class="difflineplus">+/**</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineplus">+ * Handler function to take care of clicking on an attachment</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineplus">+ *</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineplus">+ * @param event     The DOM event caused by the clicking.</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineplus">+ */</span>
<a href="#l13.784"></a><span id="l13.784"> function attachmentLinkClicked(event) {</span>
<a href="#l13.785"></a><span id="l13.785">     event.currentTarget.focus();</span>
<a href="#l13.786"></a><span id="l13.786"> </span>
<a href="#l13.787"></a><span id="l13.787">     if (event.button != 0) {</span>
<a href="#l13.788"></a><span id="l13.788">         return;</span>
<a href="#l13.789"></a><span id="l13.789">     }</span>
<a href="#l13.790"></a><span id="l13.790"> </span>
<a href="#l13.791"></a><span id="l13.791">     if (event.originalTarget.localName == &quot;listboxbody&quot;) {</span>
<a href="#l13.792"></a><span id="l13.792">         attachURL();</span>
<a href="#l13.793"></a><span id="l13.793">     } else if (event.originalTarget.localName == &quot;listitem&quot; &amp;&amp; event.detail == 2) {</span>
<a href="#l13.794"></a><span id="l13.794">         openAttachment();</span>
<a href="#l13.795"></a><span id="l13.795">     }</span>
<a href="#l13.796"></a><span id="l13.796"> }</span>
<a href="#l13.797"></a><span id="l13.797"> </span>
<a href="#l13.798"></a><span id="l13.798" class="difflineplus">+/**</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineplus">+ * Update the dialog controls related related to the item's calendar.</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineplus">+ */</span>
<a href="#l13.801"></a><span id="l13.801"> function updateCalendar() {</span>
<a href="#l13.802"></a><span id="l13.802">     var item = window.calendarItem;</span>
<a href="#l13.803"></a><span id="l13.803">     var calendar = document.getElementById(&quot;item-calendar&quot;)</span>
<a href="#l13.804"></a><span id="l13.804">                            .selectedItem.calendar;</span>
<a href="#l13.805"></a><span id="l13.805"> </span>
<a href="#l13.806"></a><span id="l13.806">     gIsReadOnly = calendar.readOnly;</span>
<a href="#l13.807"></a><span id="l13.807"> </span>
<a href="#l13.808"></a><span id="l13.808">     if (!canNotifyAttendees(calendar, item) &amp;&amp; calendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineat">@@ -1624,16 +1835,20 @@ function updateCalendar() {</span>
<a href="#l13.810"></a><span id="l13.810">         updateAllDay();</span>
<a href="#l13.811"></a><span id="l13.811">     }</span>
<a href="#l13.812"></a><span id="l13.812"> </span>
<a href="#l13.813"></a><span id="l13.813">     // Make sure capabilties are reflected correctly</span>
<a href="#l13.814"></a><span id="l13.814">     updateCapabilities();</span>
<a href="#l13.815"></a><span id="l13.815"> </span>
<a href="#l13.816"></a><span id="l13.816"> }</span>
<a href="#l13.817"></a><span id="l13.817"> </span>
<a href="#l13.818"></a><span id="l13.818" class="difflineplus">+/**</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineplus">+ * Opens the recurrence dialog modally to allow the user to edit the recurrence</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineplus">+ * rules.</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineplus">+ */</span>
<a href="#l13.822"></a><span id="l13.822"> function editRepeat() {</span>
<a href="#l13.823"></a><span id="l13.823">     var args = new Object();</span>
<a href="#l13.824"></a><span id="l13.824">     args.calendarEvent = window.calendarItem;</span>
<a href="#l13.825"></a><span id="l13.825">     args.recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l13.826"></a><span id="l13.826">     args.startTime = gStartTime;</span>
<a href="#l13.827"></a><span id="l13.827">     args.endTime = gEndTime;</span>
<a href="#l13.828"></a><span id="l13.828"> </span>
<a href="#l13.829"></a><span id="l13.829">     var savedWindow = window;</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineat">@@ -1787,16 +2002,22 @@ function updateRepeat() {</span>
<a href="#l13.831"></a><span id="l13.831">     repeatMenu.setAttribute(&quot;last-value&quot;, repeatValue);</span>
<a href="#l13.832"></a><span id="l13.832"> </span>
<a href="#l13.833"></a><span id="l13.833">     updateRepeatDetails();</span>
<a href="#l13.834"></a><span id="l13.834">     updateEntryDate();</span>
<a href="#l13.835"></a><span id="l13.835">     updateDueDate();</span>
<a href="#l13.836"></a><span id="l13.836">     updateAccept();</span>
<a href="#l13.837"></a><span id="l13.837"> }</span>
<a href="#l13.838"></a><span id="l13.838"> </span>
<a href="#l13.839"></a><span id="l13.839" class="difflineplus">+/**</span>
<a href="#l13.840"></a><span id="l13.840" class="difflineplus">+ * Updates the UI controls related to a task's completion status.</span>
<a href="#l13.841"></a><span id="l13.841" class="difflineplus">+ *</span>
<a href="#l13.842"></a><span id="l13.842" class="difflineplus">+ * @param status                    The item's completion status.</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineplus">+ * @param passedInCompletedDate     The item's completed date (as a JSDate).</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineplus">+ */</span>
<a href="#l13.845"></a><span id="l13.845"> function updateToDoStatus(status, passedInCompletedDate) {</span>
<a href="#l13.846"></a><span id="l13.846">   // RFC2445 doesn't support completedDates without the todo's status</span>
<a href="#l13.847"></a><span id="l13.847">   // being &quot;COMPLETED&quot;, however twiddling the status menulist shouldn't</span>
<a href="#l13.848"></a><span id="l13.848">   // destroy that information at this point (in case you change status</span>
<a href="#l13.849"></a><span id="l13.849">   // back to COMPLETED). When we go to store this VTODO as .ics the</span>
<a href="#l13.850"></a><span id="l13.850">   // date will get lost.</span>
<a href="#l13.851"></a><span id="l13.851"> </span>
<a href="#l13.852"></a><span id="l13.852">   var completedDate;</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineat">@@ -1854,16 +2075,21 @@ function updateToDoStatus(status, passed</span>
<a href="#l13.854"></a><span id="l13.854">       } else {</span>
<a href="#l13.855"></a><span id="l13.855">           setElementValue(&quot;percent-complete-textbox&quot;, &quot;&quot;);</span>
<a href="#l13.856"></a><span id="l13.856">       }</span>
<a href="#l13.857"></a><span id="l13.857">       setElementValue(&quot;completed-date-picker&quot;, oldCompletedDate);</span>
<a href="#l13.858"></a><span id="l13.858">       disableElement(&quot;completed-date-picker&quot;);</span>
<a href="#l13.859"></a><span id="l13.859">   }</span>
<a href="#l13.860"></a><span id="l13.860"> }</span>
<a href="#l13.861"></a><span id="l13.861"> </span>
<a href="#l13.862"></a><span id="l13.862" class="difflineplus">+/**</span>
<a href="#l13.863"></a><span id="l13.863" class="difflineplus">+ * Saves all dialog controls back to the item.</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineplus">+ *</span>
<a href="#l13.865"></a><span id="l13.865" class="difflineplus">+ * @return      a copy of the original item with changes made.</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineplus">+ */</span>
<a href="#l13.867"></a><span id="l13.867"> function saveItem() {</span>
<a href="#l13.868"></a><span id="l13.868">     // we need to clone the item in order to apply the changes.</span>
<a href="#l13.869"></a><span id="l13.869">     // it is important to not apply the changes to the original item</span>
<a href="#l13.870"></a><span id="l13.870">     // (even if it happens to be mutable) in order to guarantee</span>
<a href="#l13.871"></a><span id="l13.871">     // that providers see a proper oldItem/newItem pair in case</span>
<a href="#l13.872"></a><span id="l13.872">     // they rely on this fact (e.g. WCAP does).</span>
<a href="#l13.873"></a><span id="l13.873">     var originalItem = window.calendarItem;</span>
<a href="#l13.874"></a><span id="l13.874">     var item = originalItem.clone();</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineat">@@ -1890,16 +2116,27 @@ function saveItem() {</span>
<a href="#l13.876"></a><span id="l13.876">         } else {</span>
<a href="#l13.877"></a><span id="l13.877">             item.setProperty(&quot;X-MOZ-SEND-INVITATIONS&quot;, notifyCheckbox.checked ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<a href="#l13.878"></a><span id="l13.878">         }</span>
<a href="#l13.879"></a><span id="l13.879">     }</span>
<a href="#l13.880"></a><span id="l13.880"> </span>
<a href="#l13.881"></a><span id="l13.881">     return item;</span>
<a href="#l13.882"></a><span id="l13.882"> }</span>
<a href="#l13.883"></a><span id="l13.883"> </span>
<a href="#l13.884"></a><span id="l13.884" class="difflineplus">+/**</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineplus">+ * Action to take when the user chooses to save. This can happen either by</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineplus">+ * saving directly or the user selecting to save after being prompted when</span>
<a href="#l13.887"></a><span id="l13.887" class="difflineplus">+ * closing the dialog.</span>
<a href="#l13.888"></a><span id="l13.888" class="difflineplus">+ *</span>
<a href="#l13.889"></a><span id="l13.889" class="difflineplus">+ * This function also takes care of notifying this dialog's caller that the item</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineplus">+ * is saved.</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineplus">+ *</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineplus">+ * @param aIsClosing            If true, the save action originates from the</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineplus">+ *                                save prompt just before the window is closing.</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineplus">+ */</span>
<a href="#l13.895"></a><span id="l13.895"> function onCommandSave(aIsClosing) {</span>
<a href="#l13.896"></a><span id="l13.896">     var originalItem = window.calendarItem;</span>
<a href="#l13.897"></a><span id="l13.897">     var item = saveItem();</span>
<a href="#l13.898"></a><span id="l13.898">     var calendar = document.getElementById(&quot;item-calendar&quot;)</span>
<a href="#l13.899"></a><span id="l13.899">                            .selectedItem.calendar;</span>
<a href="#l13.900"></a><span id="l13.900"> </span>
<a href="#l13.901"></a><span id="l13.901">     item.makeImmutable();</span>
<a href="#l13.902"></a><span id="l13.902">     // Set the item for now, the callback below will set the full item when the</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineat">@@ -1923,16 +2160,22 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l13.904"></a><span id="l13.904"> </span>
<a href="#l13.905"></a><span id="l13.905">     // Let the caller decide how to handle the modified/added item. Only pass</span>
<a href="#l13.906"></a><span id="l13.906">     // the above item if we are not closing, otherwise the listener will be</span>
<a href="#l13.907"></a><span id="l13.907">     // missing its window afterwards.</span>
<a href="#l13.908"></a><span id="l13.908">     window.onAcceptCallback(item, calendar, originalItem, !aIsClosing &amp;&amp; listener);</span>
<a href="#l13.909"></a><span id="l13.909"> </span>
<a href="#l13.910"></a><span id="l13.910"> }</span>
<a href="#l13.911"></a><span id="l13.911"> </span>
<a href="#l13.912"></a><span id="l13.912" class="difflineplus">+/**</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineplus">+ * Handler function to toggle toolbar visibility.</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineplus">+ *</span>
<a href="#l13.915"></a><span id="l13.915" class="difflineplus">+ * @param aToolbarId        The id of the XUL toolbar node to toggle.</span>
<a href="#l13.916"></a><span id="l13.916" class="difflineplus">+ * @param aMenuitemId       The corresponding menuitem in the view menu.</span>
<a href="#l13.917"></a><span id="l13.917" class="difflineplus">+ */</span>
<a href="#l13.918"></a><span id="l13.918"> function onCommandViewToolbar(aToolbarId, aMenuItemId) {</span>
<a href="#l13.919"></a><span id="l13.919">     var toolbar = document.getElementById(aToolbarId);</span>
<a href="#l13.920"></a><span id="l13.920">     var menuItem = document.getElementById(aMenuItemId);</span>
<a href="#l13.921"></a><span id="l13.921"> </span>
<a href="#l13.922"></a><span id="l13.922">     if (!toolbar || !menuItem) {</span>
<a href="#l13.923"></a><span id="l13.923">         return;</span>
<a href="#l13.924"></a><span id="l13.924">     }</span>
<a href="#l13.925"></a><span id="l13.925"> </span>
<a href="#l13.926"></a><span id="l13.926" class="difflineat">@@ -1947,18 +2190,19 @@ function onCommandViewToolbar(aToolbarId</span>
<a href="#l13.927"></a><span id="l13.927">     document.persist(aToolbarId, 'collapsed');</span>
<a href="#l13.928"></a><span id="l13.928">     document.persist(aMenuItemId, 'checked');</span>
<a href="#l13.929"></a><span id="l13.929"> }</span>
<a href="#l13.930"></a><span id="l13.930"> </span>
<a href="#l13.931"></a><span id="l13.931"> /**</span>
<a href="#l13.932"></a><span id="l13.932">  * DialogToolboxCustomizeDone() is called after the customize toolbar dialog</span>
<a href="#l13.933"></a><span id="l13.933">  * has been closed by the user. We need to restore the state of all buttons</span>
<a href="#l13.934"></a><span id="l13.934">  * and commands of all customizable toolbars.</span>
<a href="#l13.935"></a><span id="l13.935" class="difflineplus">+ *</span>
<a href="#l13.936"></a><span id="l13.936" class="difflineplus">+ * @param aToolboxChanged       If true, the toolbox has changed.</span>
<a href="#l13.937"></a><span id="l13.937">  */</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineminus">-</span>
<a href="#l13.939"></a><span id="l13.939"> function DialogToolboxCustomizeDone(aToolboxChanged) {</span>
<a href="#l13.940"></a><span id="l13.940"> </span>
<a href="#l13.941"></a><span id="l13.941">     var menubar = document.getElementById(&quot;event-menubar&quot;);</span>
<a href="#l13.942"></a><span id="l13.942">     for (var i = 0; i &lt; menubar.childNodes.length; ++i) {</span>
<a href="#l13.943"></a><span id="l13.943">         menubar.childNodes[i].removeAttribute(&quot;disabled&quot;);</span>
<a href="#l13.944"></a><span id="l13.944">     }</span>
<a href="#l13.945"></a><span id="l13.945">   </span>
<a href="#l13.946"></a><span id="l13.946">     // make sure our toolbar buttons have the correct enabled state restored to them...</span>
<a href="#l13.947"></a><span id="l13.947" class="difflineat">@@ -1967,16 +2211,20 @@ function DialogToolboxCustomizeDone(aToo</span>
<a href="#l13.948"></a><span id="l13.948">     // Enable the toolbar context menu items</span>
<a href="#l13.949"></a><span id="l13.949">     document.getElementById(&quot;cmd_customize&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l13.950"></a><span id="l13.950"> </span>
<a href="#l13.951"></a><span id="l13.951">     // Update privacy items to make sure the toolbarbutton's menupopup is set</span>
<a href="#l13.952"></a><span id="l13.952">     // correctly</span>
<a href="#l13.953"></a><span id="l13.953">     updatePrivacy();</span>
<a href="#l13.954"></a><span id="l13.954"> }</span>
<a href="#l13.955"></a><span id="l13.955"> </span>
<a href="#l13.956"></a><span id="l13.956" class="difflineplus">+/**</span>
<a href="#l13.957"></a><span id="l13.957" class="difflineplus">+ * Handler function to start the customize toolbar dialog for the event dialog's</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineplus">+ * toolbar.</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineplus">+ */</span>
<a href="#l13.960"></a><span id="l13.960"> function onCommandCustomize() {</span>
<a href="#l13.961"></a><span id="l13.961">     // install the callback that handles what needs to be</span>
<a href="#l13.962"></a><span id="l13.962">     // done after a toolbar has been customized.</span>
<a href="#l13.963"></a><span id="l13.963">     var toolbox = document.getElementById(&quot;event-toolbox&quot;);</span>
<a href="#l13.964"></a><span id="l13.964">     toolbox.customizeDone = DialogToolboxCustomizeDone;</span>
<a href="#l13.965"></a><span id="l13.965"> </span>
<a href="#l13.966"></a><span id="l13.966">     var menubar = document.getElementById(&quot;event-menubar&quot;);</span>
<a href="#l13.967"></a><span id="l13.967">     for (var i = 0; i &lt; menubar.childNodes.length; ++i) {</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineat">@@ -2001,16 +2249,19 @@ function onCommandCustomize() {</span>
<a href="#l13.969"></a><span id="l13.969">                           &quot;chrome,all,dependent&quot;,</span>
<a href="#l13.970"></a><span id="l13.970">                           document.getElementById(id), // toolbar dom node</span>
<a href="#l13.971"></a><span id="l13.971">                           false,                       // is mode toolbar yes/no?</span>
<a href="#l13.972"></a><span id="l13.972">                           null,                        // callback function</span>
<a href="#l13.973"></a><span id="l13.973">                           &quot;dialog&quot;);                   // name of this mode</span>
<a href="#l13.974"></a><span id="l13.974">     }</span>
<a href="#l13.975"></a><span id="l13.975"> }</span>
<a href="#l13.976"></a><span id="l13.976"> </span>
<a href="#l13.977"></a><span id="l13.977" class="difflineplus">+/**</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineplus">+ * Prompts the user to change the start timezone.</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineplus">+ */</span>
<a href="#l13.980"></a><span id="l13.980"> function editStartTimezone() {</span>
<a href="#l13.981"></a><span id="l13.981">     editTimezone(</span>
<a href="#l13.982"></a><span id="l13.982">         &quot;timezone-starttime&quot;,</span>
<a href="#l13.983"></a><span id="l13.983">         gStartTime.getInTimezone(gStartTimezone),</span>
<a href="#l13.984"></a><span id="l13.984">         function(datetime) {</span>
<a href="#l13.985"></a><span id="l13.985">             var equalTimezones = false;</span>
<a href="#l13.986"></a><span id="l13.986">             if (gStartTimezone &amp;&amp; gEndTimezone) {</span>
<a href="#l13.987"></a><span id="l13.987">                 if (gStartTimezone == gEndTimezone) {</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineat">@@ -2020,16 +2271,19 @@ function editStartTimezone() {</span>
<a href="#l13.989"></a><span id="l13.989">             gStartTimezone = datetime.timezone;</span>
<a href="#l13.990"></a><span id="l13.990">             if (equalTimezones) {</span>
<a href="#l13.991"></a><span id="l13.991">               gEndTimezone = datetime.timezone;</span>
<a href="#l13.992"></a><span id="l13.992">             }</span>
<a href="#l13.993"></a><span id="l13.993">             updateDateTime();</span>
<a href="#l13.994"></a><span id="l13.994">         });</span>
<a href="#l13.995"></a><span id="l13.995"> }</span>
<a href="#l13.996"></a><span id="l13.996"> </span>
<a href="#l13.997"></a><span id="l13.997" class="difflineplus">+/**</span>
<a href="#l13.998"></a><span id="l13.998" class="difflineplus">+ * Prompts the user to change the end timezone.</span>
<a href="#l13.999"></a><span id="l13.999" class="difflineplus">+ */</span>
<a href="#l13.1000"></a><span id="l13.1000"> function editEndTimezone() {</span>
<a href="#l13.1001"></a><span id="l13.1001">     editTimezone(</span>
<a href="#l13.1002"></a><span id="l13.1002">         &quot;timezone-endtime&quot;,</span>
<a href="#l13.1003"></a><span id="l13.1003">         gEndTime.getInTimezone(gEndTimezone),</span>
<a href="#l13.1004"></a><span id="l13.1004">         function(datetime) {</span>
<a href="#l13.1005"></a><span id="l13.1005">             var equalTimezones = false;</span>
<a href="#l13.1006"></a><span id="l13.1006">             if (gStartTimezone &amp;&amp; gEndTimezone) {</span>
<a href="#l13.1007"></a><span id="l13.1007">                 if (compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineat">@@ -2039,16 +2293,24 @@ function editEndTimezone() {</span>
<a href="#l13.1009"></a><span id="l13.1009">             if (equalTimezones) {</span>
<a href="#l13.1010"></a><span id="l13.1010">                 gStartTimezone = datetime.timezone;</span>
<a href="#l13.1011"></a><span id="l13.1011">             }</span>
<a href="#l13.1012"></a><span id="l13.1012">             gEndTimezone = datetime.timezone;</span>
<a href="#l13.1013"></a><span id="l13.1013">             updateDateTime();</span>
<a href="#l13.1014"></a><span id="l13.1014">         });</span>
<a href="#l13.1015"></a><span id="l13.1015"> }</span>
<a href="#l13.1016"></a><span id="l13.1016"> </span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineplus">+/**</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineplus">+ * Common function of edit(Start|End)Timezone() to prompt the user for a</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineplus">+ * timezone change.</span>
<a href="#l13.1020"></a><span id="l13.1020" class="difflineplus">+ *</span>
<a href="#l13.1021"></a><span id="l13.1021" class="difflineplus">+ * @param aElementId        The XUL element id of the timezone label.</span>
<a href="#l13.1022"></a><span id="l13.1022" class="difflineplus">+ * @param aDateTime         The Date/Time of the time to change zone on.</span>
<a href="#l13.1023"></a><span id="l13.1023" class="difflineplus">+ * @param aCallback         What to do when the user has chosen a zone.</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineplus">+ */</span>
<a href="#l13.1025"></a><span id="l13.1025"> function editTimezone(aElementId,aDateTime,aCallback) {</span>
<a href="#l13.1026"></a><span id="l13.1026">     if (document.getElementById(aElementId)</span>
<a href="#l13.1027"></a><span id="l13.1027">         .hasAttribute(&quot;disabled&quot;)) {</span>
<a href="#l13.1028"></a><span id="l13.1028">         return;</span>
<a href="#l13.1029"></a><span id="l13.1029">     }</span>
<a href="#l13.1030"></a><span id="l13.1030"> </span>
<a href="#l13.1031"></a><span id="l13.1031">     // prepare the arguments that will be passed to the dialog</span>
<a href="#l13.1032"></a><span id="l13.1032">     var args = new Object();</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineat">@@ -2059,48 +2321,50 @@ function editTimezone(aElementId,aDateTi</span>
<a href="#l13.1034"></a><span id="l13.1034">     // open the dialog modally</span>
<a href="#l13.1035"></a><span id="l13.1035">     openDialog(</span>
<a href="#l13.1036"></a><span id="l13.1036">         &quot;chrome://calendar/content/calendar-event-dialog-timezone.xul&quot;,</span>
<a href="#l13.1037"></a><span id="l13.1037">         &quot;_blank&quot;,</span>
<a href="#l13.1038"></a><span id="l13.1038">         &quot;chrome,titlebar,modal,resizable&quot;,</span>
<a href="#l13.1039"></a><span id="l13.1039">         args);</span>
<a href="#l13.1040"></a><span id="l13.1040"> }</span>
<a href="#l13.1041"></a><span id="l13.1041"> </span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineminus">-// this function initializes the following controls:</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineminus">-// - 'event-starttime'</span>
<a href="#l13.1044"></a><span id="l13.1044" class="difflineminus">-// - 'event-endtime'</span>
<a href="#l13.1045"></a><span id="l13.1045" class="difflineminus">-// - 'event-all-day'</span>
<a href="#l13.1046"></a><span id="l13.1046" class="difflineminus">-// - 'todo-has-entrydate'</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineminus">-// - 'todo-entrydate'</span>
<a href="#l13.1048"></a><span id="l13.1048" class="difflineminus">-// - 'todo-has-duedate'</span>
<a href="#l13.1049"></a><span id="l13.1049" class="difflineminus">-// - 'todo-duedate'</span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineminus">-// the date/time-objects are either displayed in their repective</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineminus">-// timezone or in the default timezone. this decision is based</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineminus">-// on whether or not 'options-timezone-menuitem' is checked.</span>
<a href="#l13.1053"></a><span id="l13.1053" class="difflineminus">-// the necessary information is taken from the following variables:</span>
<a href="#l13.1054"></a><span id="l13.1054" class="difflineminus">-// - 'gStartTime'</span>
<a href="#l13.1055"></a><span id="l13.1055" class="difflineminus">-// - 'gEndTime'</span>
<a href="#l13.1056"></a><span id="l13.1056" class="difflineminus">-// - 'window.calendarItem' (used to decide about event/task)</span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineplus">+/**</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineplus">+ * This function initializes the following controls:</span>
<a href="#l13.1059"></a><span id="l13.1059" class="difflineplus">+ * - 'event-starttime'</span>
<a href="#l13.1060"></a><span id="l13.1060" class="difflineplus">+ * - 'event-endtime'</span>
<a href="#l13.1061"></a><span id="l13.1061" class="difflineplus">+ * - 'event-all-day'</span>
<a href="#l13.1062"></a><span id="l13.1062" class="difflineplus">+ * - 'todo-has-entrydate'</span>
<a href="#l13.1063"></a><span id="l13.1063" class="difflineplus">+ * - 'todo-entrydate'</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineplus">+ * - 'todo-has-duedate'</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineplus">+ * - 'todo-duedate'</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineplus">+ * The date/time-objects are either displayed in their respective</span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineplus">+ * timezone or in the default timezone. This decision is based</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineplus">+ * on whether or not 'options-timezone-menuitem' is checked.</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineplus">+ * the necessary information is taken from the following variables:</span>
<a href="#l13.1070"></a><span id="l13.1070" class="difflineplus">+ * - 'gStartTime'</span>
<a href="#l13.1071"></a><span id="l13.1071" class="difflineplus">+ * - 'gEndTime'</span>
<a href="#l13.1072"></a><span id="l13.1072" class="difflineplus">+ * - 'window.calendarItem' (used to decide about event/task)</span>
<a href="#l13.1073"></a><span id="l13.1073" class="difflineplus">+ */</span>
<a href="#l13.1074"></a><span id="l13.1074"> function updateDateTime() {</span>
<a href="#l13.1075"></a><span id="l13.1075">     gIgnoreUpdate = true;</span>
<a href="#l13.1076"></a><span id="l13.1076"> </span>
<a href="#l13.1077"></a><span id="l13.1077">     var item = window.calendarItem;</span>
<a href="#l13.1078"></a><span id="l13.1078">     var menuItem = document.getElementById('options-timezone-menuitem');</span>
<a href="#l13.1079"></a><span id="l13.1079"> </span>
<a href="#l13.1080"></a><span id="l13.1080" class="difflineminus">-    // convert to default timezone if the timezone option</span>
<a href="#l13.1081"></a><span id="l13.1081" class="difflineplus">+    // Convert to default timezone if the timezone option</span>
<a href="#l13.1082"></a><span id="l13.1082">     // is *not* checked, otherwise keep the specific timezone</span>
<a href="#l13.1083"></a><span id="l13.1083">     // and display the labels in order to modify the timezone.</span>
<a href="#l13.1084"></a><span id="l13.1084">     if (menuItem.getAttribute('checked') == 'true') {</span>
<a href="#l13.1085"></a><span id="l13.1085">         if (isEvent(item)) {</span>
<a href="#l13.1086"></a><span id="l13.1086">           var startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l13.1087"></a><span id="l13.1087">           var endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l13.1088"></a><span id="l13.1088"> </span>
<a href="#l13.1089"></a><span id="l13.1089">           setElementValue(&quot;event-all-day&quot;, startTime.isDate, &quot;checked&quot;);</span>
<a href="#l13.1090"></a><span id="l13.1090"> </span>
<a href="#l13.1091"></a><span id="l13.1091" class="difflineminus">-          // in the case where the timezones are different but</span>
<a href="#l13.1092"></a><span id="l13.1092" class="difflineplus">+          // In the case where the timezones are different but</span>
<a href="#l13.1093"></a><span id="l13.1093">           // the timezone of the endtime is &quot;UTC&quot;, we convert</span>
<a href="#l13.1094"></a><span id="l13.1094">           // the endtime into the timezone of the starttime.</span>
<a href="#l13.1095"></a><span id="l13.1095">           if (startTime &amp;&amp; endTime) {</span>
<a href="#l13.1096"></a><span id="l13.1096">             if (!compareObjects(startTime.timezone, endTime.timezone)) {</span>
<a href="#l13.1097"></a><span id="l13.1097">               if (endTime.timezone.isUTC) {</span>
<a href="#l13.1098"></a><span id="l13.1098">                 endTime = endTime.getInTimezone(startTime.timezone);</span>
<a href="#l13.1099"></a><span id="l13.1099">               }</span>
<a href="#l13.1100"></a><span id="l13.1100">             }</span>
<a href="#l13.1101"></a><span id="l13.1101" class="difflineat">@@ -2211,22 +2475,24 @@ function updateDateTime() {</span>
<a href="#l13.1102"></a><span id="l13.1102">     }</span>
<a href="#l13.1103"></a><span id="l13.1103"> </span>
<a href="#l13.1104"></a><span id="l13.1104">     updateTimezone();</span>
<a href="#l13.1105"></a><span id="l13.1105">     updateAllDay();</span>
<a href="#l13.1106"></a><span id="l13.1106"> </span>
<a href="#l13.1107"></a><span id="l13.1107">     gIgnoreUpdate = false;</span>
<a href="#l13.1108"></a><span id="l13.1108"> }</span>
<a href="#l13.1109"></a><span id="l13.1109"> </span>
<a href="#l13.1110"></a><span id="l13.1110" class="difflineminus">-// this function initializes the following controls:</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-// - 'timezone-starttime'</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineminus">-// - 'timezone-endtime'</span>
<a href="#l13.1113"></a><span id="l13.1113" class="difflineminus">-// the timezone-links show the corrosponding names of the</span>
<a href="#l13.1114"></a><span id="l13.1114" class="difflineminus">-// start/end times. if 'options-timezone-menuitem' is not checked</span>
<a href="#l13.1115"></a><span id="l13.1115" class="difflineminus">-// the links will be collapsed.</span>
<a href="#l13.1116"></a><span id="l13.1116" class="difflineplus">+/**</span>
<a href="#l13.1117"></a><span id="l13.1117" class="difflineplus">+ * This function initializes the following controls:</span>
<a href="#l13.1118"></a><span id="l13.1118" class="difflineplus">+ * - 'timezone-starttime'</span>
<a href="#l13.1119"></a><span id="l13.1119" class="difflineplus">+ * - 'timezone-endtime'</span>
<a href="#l13.1120"></a><span id="l13.1120" class="difflineplus">+ * the timezone-links show the corrosponding names of the</span>
<a href="#l13.1121"></a><span id="l13.1121" class="difflineplus">+ * start/end times. if 'options-timezone-menuitem' is not checked</span>
<a href="#l13.1122"></a><span id="l13.1122" class="difflineplus">+ * the links will be collapsed.</span>
<a href="#l13.1123"></a><span id="l13.1123" class="difflineplus">+ */</span>
<a href="#l13.1124"></a><span id="l13.1124"> function updateTimezone() {</span>
<a href="#l13.1125"></a><span id="l13.1125">     var menuItem = document.getElementById('options-timezone-menuitem');</span>
<a href="#l13.1126"></a><span id="l13.1126"> </span>
<a href="#l13.1127"></a><span id="l13.1127">     // convert to default timezone if the timezone option</span>
<a href="#l13.1128"></a><span id="l13.1128">     // is *not* checked, otherwise keep the specific timezone</span>
<a href="#l13.1129"></a><span id="l13.1129">     // and display the labels in order to modify the timezone.</span>
<a href="#l13.1130"></a><span id="l13.1130">     if (menuItem.getAttribute('checked') == 'true') {</span>
<a href="#l13.1131"></a><span id="l13.1131">         var startTimezone = gStartTimezone;</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineat">@@ -2287,46 +2553,55 @@ function updateTimezone() {</span>
<a href="#l13.1133"></a><span id="l13.1133">     } else {</span>
<a href="#l13.1134"></a><span id="l13.1134">         document.getElementById('timezone-starttime')</span>
<a href="#l13.1135"></a><span id="l13.1135">                 .setAttribute('collapsed', 'true');</span>
<a href="#l13.1136"></a><span id="l13.1136">         document.getElementById('timezone-endtime')</span>
<a href="#l13.1137"></a><span id="l13.1137">                 .setAttribute('collapsed', 'true');</span>
<a href="#l13.1138"></a><span id="l13.1138">     }</span>
<a href="#l13.1139"></a><span id="l13.1139"> }</span>
<a href="#l13.1140"></a><span id="l13.1140"> </span>
<a href="#l13.1141"></a><span id="l13.1141" class="difflineplus">+/**</span>
<a href="#l13.1142"></a><span id="l13.1142" class="difflineplus">+ * This function updates dialog controls related to item attachments</span>
<a href="#l13.1143"></a><span id="l13.1143" class="difflineplus">+ */</span>
<a href="#l13.1144"></a><span id="l13.1144"> function updateAttachment() {</span>
<a href="#l13.1145"></a><span id="l13.1145">     var hasAttachments = capSupported(&quot;attachments&quot;);</span>
<a href="#l13.1146"></a><span id="l13.1146">     setElementValue(&quot;cmd_attach_url&quot;, !hasAttachments &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l13.1147"></a><span id="l13.1147"> </span>
<a href="#l13.1148"></a><span id="l13.1148">     var documentRow = document.getElementById(&quot;event-grid-attachment-row&quot;);</span>
<a href="#l13.1149"></a><span id="l13.1149">     var attSeparator = document.getElementById(&quot;event-grid-attachment-separator&quot;);</span>
<a href="#l13.1150"></a><span id="l13.1150">     if (!hasAttachments) {</span>
<a href="#l13.1151"></a><span id="l13.1151">         documentRow.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l13.1152"></a><span id="l13.1152">         attSeparator.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l13.1153"></a><span id="l13.1153">     } else {</span>
<a href="#l13.1154"></a><span id="l13.1154">         var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l13.1155"></a><span id="l13.1155">         setElementValue(documentRow, documentLink.getRowCount() &lt; 1 &amp;&amp; &quot;true&quot;, &quot;collapsed&quot;);</span>
<a href="#l13.1156"></a><span id="l13.1156">         setElementValue(attSeparator, documentLink.getRowCount() &lt; 1 &amp;&amp; &quot;true&quot;, &quot;collapsed&quot;);</span>
<a href="#l13.1157"></a><span id="l13.1157">     }</span>
<a href="#l13.1158"></a><span id="l13.1158"> }</span>
<a href="#l13.1159"></a><span id="l13.1159"> </span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineplus">+/**</span>
<a href="#l13.1161"></a><span id="l13.1161" class="difflineplus">+ * Toggles the visibility of the related link (rfc2445 URL property)</span>
<a href="#l13.1162"></a><span id="l13.1162" class="difflineplus">+ */</span>
<a href="#l13.1163"></a><span id="l13.1163"> function toggleLink() {</span>
<a href="#l13.1164"></a><span id="l13.1164">     var linkCommand = document.getElementById(&quot;cmd_toggle_link&quot;);</span>
<a href="#l13.1165"></a><span id="l13.1165">     var row = document.getElementById(&quot;event-grid-link-row&quot;);</span>
<a href="#l13.1166"></a><span id="l13.1166">     var separator = document.getElementById(&quot;event-grid-link-separator&quot;);</span>
<a href="#l13.1167"></a><span id="l13.1167"> </span>
<a href="#l13.1168"></a><span id="l13.1168">     var isHidden = row.hidden;</span>
<a href="#l13.1169"></a><span id="l13.1169">     row.hidden = !isHidden;</span>
<a href="#l13.1170"></a><span id="l13.1170">     separator.hidden = !isHidden;</span>
<a href="#l13.1171"></a><span id="l13.1171"> </span>
<a href="#l13.1172"></a><span id="l13.1172">     linkCommand.setAttribute(&quot;checked&quot;, isHidden ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l13.1173"></a><span id="l13.1173"> </span>
<a href="#l13.1174"></a><span id="l13.1174">     updateLink();</span>
<a href="#l13.1175"></a><span id="l13.1175"> }</span>
<a href="#l13.1176"></a><span id="l13.1176"> </span>
<a href="#l13.1177"></a><span id="l13.1177" class="difflineplus">+/**</span>
<a href="#l13.1178"></a><span id="l13.1178" class="difflineplus">+ * This function updates dialog controls related to attendees.</span>
<a href="#l13.1179"></a><span id="l13.1179" class="difflineplus">+ */</span>
<a href="#l13.1180"></a><span id="l13.1180"> function updateAttendees() {</span>
<a href="#l13.1181"></a><span id="l13.1181">     var attendeeRow = document.getElementById(&quot;event-grid-attendee-row&quot;);</span>
<a href="#l13.1182"></a><span id="l13.1182">     var attendeeRow2 = document.getElementById(&quot;event-grid-attendee-row-2&quot;);</span>
<a href="#l13.1183"></a><span id="l13.1183">     if (window.attendees &amp;&amp; window.attendees.length &gt; 0) {</span>
<a href="#l13.1184"></a><span id="l13.1184">         attendeeRow.removeAttribute('collapsed');</span>
<a href="#l13.1185"></a><span id="l13.1185">         if (isEvent(window.calendarItem)) { // sending email invitations currently only supported for events</span>
<a href="#l13.1186"></a><span id="l13.1186">             attendeeRow2.removeAttribute('collapsed');</span>
<a href="#l13.1187"></a><span id="l13.1187">         } else {</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineat">@@ -2360,16 +2635,20 @@ function updateAttendees() {</span>
<a href="#l13.1189"></a><span id="l13.1189">         }</span>
<a href="#l13.1190"></a><span id="l13.1190">         setTimeout(callback, 1);</span>
<a href="#l13.1191"></a><span id="l13.1191">     } else {</span>
<a href="#l13.1192"></a><span id="l13.1192">         attendeeRow.setAttribute('collapsed', 'true');</span>
<a href="#l13.1193"></a><span id="l13.1193">         attendeeRow2.setAttribute('collapsed', 'true');</span>
<a href="#l13.1194"></a><span id="l13.1194">     }</span>
<a href="#l13.1195"></a><span id="l13.1195"> }</span>
<a href="#l13.1196"></a><span id="l13.1196"> </span>
<a href="#l13.1197"></a><span id="l13.1197" class="difflineplus">+/**</span>
<a href="#l13.1198"></a><span id="l13.1198" class="difflineplus">+ * This function updates dialog controls related to recurrence, in this case the</span>
<a href="#l13.1199"></a><span id="l13.1199" class="difflineplus">+ * text describing the recurrence rule.</span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineplus">+ */</span>
<a href="#l13.1201"></a><span id="l13.1201"> function updateRepeatDetails() {</span>
<a href="#l13.1202"></a><span id="l13.1202">     // Don't try to show the details text for</span>
<a href="#l13.1203"></a><span id="l13.1203">     // anything but a custom recurrence rule.</span>
<a href="#l13.1204"></a><span id="l13.1204">     var item = window.calendarItem;</span>
<a href="#l13.1205"></a><span id="l13.1205">     var recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l13.1206"></a><span id="l13.1206">     var itemRepeat = document.getElementById(&quot;item-repeat&quot;);</span>
<a href="#l13.1207"></a><span id="l13.1207">     if (itemRepeat.value == &quot;custom&quot; &amp;&amp; recurrenceInfo) {</span>
<a href="#l13.1208"></a><span id="l13.1208">         </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -32,16 +32,20 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.5"></a><span id="l14.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.6"></a><span id="l14.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.7"></a><span id="l14.7">  *</span>
<a href="#l14.8"></a><span id="l14.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+/**</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Sets up the invitations dialog from the window arguments, retrieves the</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * invitations from the invitations manager.</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ */</span>
<a href="#l14.16"></a><span id="l14.16"> function onLoad() {</span>
<a href="#l14.17"></a><span id="l14.17">     var operationListener = {</span>
<a href="#l14.18"></a><span id="l14.18">         onOperationComplete: function oL_onOperationComplete(aCalendar,</span>
<a href="#l14.19"></a><span id="l14.19">                                                              aStatus,</span>
<a href="#l14.20"></a><span id="l14.20">                                                              aOperationType,</span>
<a href="#l14.21"></a><span id="l14.21">                                                              aId,</span>
<a href="#l14.22"></a><span id="l14.22">                                                              aDetail) {</span>
<a href="#l14.23"></a><span id="l14.23">             var updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -79,35 +83,52 @@ function onLoad() {</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">     var args = window.arguments[0];</span>
<a href="#l14.27"></a><span id="l14.27">     args.invitationsManager.getInvitations(operationListener,</span>
<a href="#l14.28"></a><span id="l14.28">                                            args.onLoadOperationListener);</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l14.31"></a><span id="l14.31"> }</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+/**</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * Cleans up the invitations dialog, cancels pending requests.</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ */</span>
<a href="#l14.36"></a><span id="l14.36"> function onUnload() {</span>
<a href="#l14.37"></a><span id="l14.37">     var args = window.arguments[0];</span>
<a href="#l14.38"></a><span id="l14.38">     args.requestManager.cancelPendingRequests();</span>
<a href="#l14.39"></a><span id="l14.39"> }</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+/**</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ * Handler function to be called when the accept button is pressed.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+ *</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+ * @return      Returns true if the window should be closed</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+ */</span>
<a href="#l14.46"></a><span id="l14.46"> function onAccept() {</span>
<a href="#l14.47"></a><span id="l14.47">     var args = window.arguments[0];</span>
<a href="#l14.48"></a><span id="l14.48">     fillJobQueue(args.queue);</span>
<a href="#l14.49"></a><span id="l14.49">     args.invitationsManager.processJobQueue(args.queue, args.finishedCallBack);</span>
<a href="#l14.50"></a><span id="l14.50">     return true;</span>
<a href="#l14.51"></a><span id="l14.51"> }</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+/**</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ * Handler function to be called when the cancel button is pressed.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ */</span>
<a href="#l14.56"></a><span id="l14.56"> function onCancel() {</span>
<a href="#l14.57"></a><span id="l14.57">     var args = window.arguments[0];</span>
<a href="#l14.58"></a><span id="l14.58">     if (args.finishedCallBack) {</span>
<a href="#l14.59"></a><span id="l14.59">         args.finishedCallBack();</span>
<a href="#l14.60"></a><span id="l14.60">     }</span>
<a href="#l14.61"></a><span id="l14.61"> }</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+/**</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+ * Fills the job queue from the invitations-listbox's items. The job queue</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+ * contains objects for all items that have a modified participation status.</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+ *</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ * @param queue     The queue to fill.</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+ */</span>
<a href="#l14.69"></a><span id="l14.69"> function fillJobQueue(queue) {</span>
<a href="#l14.70"></a><span id="l14.70">     var richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l14.71"></a><span id="l14.71">     var rowCount = richListBox.getRowCount();</span>
<a href="#l14.72"></a><span id="l14.72">     for (var i = 0; i &lt; rowCount; i++) {</span>
<a href="#l14.73"></a><span id="l14.73">         var richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l14.74"></a><span id="l14.74">         var newStatus = richListItem.participationStatus;</span>
<a href="#l14.75"></a><span id="l14.75">         var oldStatus = richListItem.initialParticipationStatus;</span>
<a href="#l14.76"></a><span id="l14.76">         if (newStatus != oldStatus) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -53,18 +53,17 @@ const MODE_EXCL     = 0x80;</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> /**</span>
<a href="#l15.6"></a><span id="l15.6">  * loadEventsFromFile</span>
<a href="#l15.7"></a><span id="l15.7">  * shows a file dialog, reads the selected file(s) and tries to parse events from it.</span>
<a href="#l15.8"></a><span id="l15.8">  *</span>
<a href="#l15.9"></a><span id="l15.9">  * @param aCalendar  (optional) If specified, the items will be imported directly</span>
<a href="#l15.10"></a><span id="l15.10">  *                              into the calendar</span>
<a href="#l15.11"></a><span id="l15.11">  */</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-function loadEventsFromFile(aCalendar)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+function loadEventsFromFile(aCalendar) {</span>
<a href="#l15.15"></a><span id="l15.15">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l15.16"></a><span id="l15.16">   </span>
<a href="#l15.17"></a><span id="l15.17">     var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l15.18"></a><span id="l15.18">                        .createInstance(nsIFilePicker);</span>
<a href="#l15.19"></a><span id="l15.19">     fp.init(window, calGetString(&quot;calendar&quot;, &quot;filepickerTitleImport&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l15.20"></a><span id="l15.20">     fp.defaultExtension = &quot;ics&quot;;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">     // Get a list of exporters</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -137,16 +136,24 @@ function loadEventsFromFile(aCalendar)</span>
<a href="#l15.24"></a><span id="l15.24">             args.calendars = calendars;</span>
<a href="#l15.25"></a><span id="l15.25">             args.promptText = calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l15.26"></a><span id="l15.26">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;, </span>
<a href="#l15.27"></a><span id="l15.27">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l15.28"></a><span id="l15.28">         }</span>
<a href="#l15.29"></a><span id="l15.29">     }</span>
<a href="#l15.30"></a><span id="l15.30"> }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+/**</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * Put items into a certain calendar, catching errors and showing them to the</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * user.</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ *</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * @param destCal       The destination calendar.</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * @param aItems        An array of items to put into the calendar.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * @param aFilePath     The original file path, for error messages.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ */</span>
<a href="#l15.40"></a><span id="l15.40"> function putItemsIntoCal(destCal, aItems, aFilePath) {</span>
<a href="#l15.41"></a><span id="l15.41">     // Set batch for the undo/redo transaction manager</span>
<a href="#l15.42"></a><span id="l15.42">     startBatchTransaction();</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">     // And set batch mode on the calendar, to tell the views to not</span>
<a href="#l15.45"></a><span id="l15.45">     // redraw until all items are imported</span>
<a href="#l15.46"></a><span id="l15.46">     destCal.startBatch();</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48" class="difflineat">@@ -180,17 +187,17 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l15.49"></a><span id="l15.49">                     showError(calGetString(&quot;calendar&quot;, &quot;duplicateError&quot;, [duplicateCount, aFilePath]));</span>
<a href="#l15.50"></a><span id="l15.50">                 } else if (failedCount) {</span>
<a href="#l15.51"></a><span id="l15.51">                     showError(calGetString(&quot;calendar&quot;, &quot;importItemsFailed&quot;, [failedCount, lastError.toString()]));</span>
<a href="#l15.52"></a><span id="l15.52">                 }</span>
<a href="#l15.53"></a><span id="l15.53">             }</span>
<a href="#l15.54"></a><span id="l15.54">         }</span>
<a href="#l15.55"></a><span id="l15.55">     }</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    for each (item in aItems) {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    for each (let item in aItems) {</span>
<a href="#l15.59"></a><span id="l15.59">         // XXX prompt when finding a duplicate.</span>
<a href="#l15.60"></a><span id="l15.60">         try {</span>
<a href="#l15.61"></a><span id="l15.61">             destCal.addItem(item, listener);</span>
<a href="#l15.62"></a><span id="l15.62">         } catch(e) {</span>
<a href="#l15.63"></a><span id="l15.63">             failedCount++;</span>
<a href="#l15.64"></a><span id="l15.64">             lastError = e;</span>
<a href="#l15.65"></a><span id="l15.65">             // Call the listener's operationComplete, to increase the</span>
<a href="#l15.66"></a><span id="l15.66">             // counter and not miss failed items. Otherwise, endBatch might</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineat">@@ -208,19 +215,17 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l15.68"></a><span id="l15.68">  * saveEventsToFile</span>
<a href="#l15.69"></a><span id="l15.69">  *</span>
<a href="#l15.70"></a><span id="l15.70">  * Save data to a file. Create the file or overwrite an existing file.</span>
<a href="#l15.71"></a><span id="l15.71">  *</span>
<a href="#l15.72"></a><span id="l15.72">  * @param calendarEventArray (required) Array of calendar events that should</span>
<a href="#l15.73"></a><span id="l15.73">  *                                      be saved to file.</span>
<a href="#l15.74"></a><span id="l15.74">  * @param aDefaultFileName   (optional) Initial filename shown in SaveAs dialog.</span>
<a href="#l15.75"></a><span id="l15.75">  */</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-function saveEventsToFile(calendarEventArray, aDefaultFileName)</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-{</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+function saveEventsToFile(calendarEventArray, aDefaultFileName) {</span>
<a href="#l15.80"></a><span id="l15.80">    if (!calendarEventArray)</span>
<a href="#l15.81"></a><span id="l15.81">        return;</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83">    // Show the 'Save As' dialog and ask for a filename to save to</span>
<a href="#l15.84"></a><span id="l15.84">    const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86">    var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l15.87"></a><span id="l15.87">                       .createInstance(nsIFilePicker);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineat">@@ -297,18 +302,21 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l15.89"></a><span id="l15.89">       }</span>
<a href="#l15.90"></a><span id="l15.90">       catch(ex)</span>
<a href="#l15.91"></a><span id="l15.91">       {</span>
<a href="#l15.92"></a><span id="l15.92">          showError(calGetString(&quot;calendar&quot;, &quot;unableToWrite&quot;) + filePath);</span>
<a href="#l15.93"></a><span id="l15.93">       }</span>
<a href="#l15.94"></a><span id="l15.94">    }</span>
<a href="#l15.95"></a><span id="l15.95"> }</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-/* Exports all the events and tasks in a calendar.  If aCalendar is not specified,</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+/**</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+ * Exports all the events and tasks in a calendar.  If aCalendar is not specified,</span>
<a href="#l15.100"></a><span id="l15.100">  * the user will be prompted with a list of calendars to choose which one to export.</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+ *</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+ * @param aCalendar     (optional) A specific calendar to export</span>
<a href="#l15.103"></a><span id="l15.103">  */</span>
<a href="#l15.104"></a><span id="l15.104"> function exportEntireCalendar(aCalendar) {</span>
<a href="#l15.105"></a><span id="l15.105">     var itemArray = [];</span>
<a href="#l15.106"></a><span id="l15.106">     var getListener = {</span>
<a href="#l15.107"></a><span id="l15.107">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l15.108"></a><span id="l15.108">         {</span>
<a href="#l15.109"></a><span id="l15.109">             saveEventsToFile(itemArray, aCalendar.name);</span>
<a href="#l15.110"></a><span id="l15.110">         },</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

