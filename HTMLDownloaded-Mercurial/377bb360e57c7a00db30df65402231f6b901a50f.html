<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28291:377bb360e57c7a00db30df65402231f6b901a50f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 377bb360e57c7a00db30df65402231f6b901a50f" />
<meta property="og:url" content="/comm-central/rev/377bb360e57c7a00db30df65402231f6b901a50f" />
<meta property="og:description" content="Bug 1594855 - Import additional files for key handling and composer, subset of the r+*ed patch. r=patrick DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 377bb360e57c7a00db30df65402231f6b901a50f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/377bb360e57c7a00db30df65402231f6b901a50f">shortlog</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/377bb360e57c7a00db30df65402231f6b901a50f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f">files</a> |
changeset |
<a href="/comm-central/raw-rev/377bb360e57c7a00db30df65402231f6b901a50f">raw</a>  | <a href="/comm-central/archive/377bb360e57c7a00db30df65402231f6b901a50f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">Bug 1594855</a> - Import additional files for key handling and composer, subset of the r+*ed patch. r=patrick DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 30 Nov 2019 11:55:11 +0100</td></tr>

<tr>
 <td>changeset 28291</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/377bb360e57c7a00db30df65402231f6b901a50f">377bb360e57c7a00db30df65402231f6b901a50f</a></td>
</tr>



<tr>
<td>parent 28290</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c35cc8809feae83b247ca14d2d6f9e214dbbd476">c35cc8809feae83b247ca14d2d6f9e214dbbd476</a>
</td>
</tr>

<tr>
<td>child 28292</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5f1b51ad26efeabc949db3a3c23564f59d933930">5f1b51ad26efeabc949db3a3c23564f59d933930</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=377bb360e57c7a00db30df65402231f6b901a50f">16745</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Sat, 30 Nov 2019 10:55:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@377bb360e57c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=377bb360e57c7a00db30df65402231f6b901a50f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=377bb360e57c7a00db30df65402231f6b901a50f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=377bb360e57c7a00db30df65402231f6b901a50f&newProject=comm-central&newRevision=c35cc8809feae83b247ca14d2d6f9e214dbbd476&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=377bb360e57c7a00db30df65402231f6b901a50f&newProject=comm-central&newRevision=c35cc8809feae83b247ca14d2d6f9e214dbbd476&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=377bb360e57c7a00db30df65402231f6b901a50f&newProject=comm-central&newRevision=c35cc8809feae83b247ca14d2d6f9e214dbbd476&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28patrick%29&revcount=50">patrick</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">1594855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">Bug 1594855</a> - Import additional files for key handling and composer, subset of the r+*ed patch. r=patrick DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">mail/extensions/openpgp/content/ui/enigmailKeySelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">mail/extensions/openpgp/content/ui/enigmailKeySelection.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/377bb360e57c7a00db30df65402231f6b901a50f/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,217 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+var Cu = Components.utils;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+var EnigmailEvents = ChromeUtils.import(&quot;chrome://openpgp/content/modules/events.jsm&quot;).EnigmailEvents;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+var EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+function onLoad() {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  var dlg = document.getElementById(&quot;enigmailKeyImportInfo&quot;);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  let i, keys;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  dlg.getButton(&quot;help&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  dlg.getButton(&quot;cancel&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  dlg.getButton(&quot;extra1&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  dlg.getButton(&quot;extra2&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  dlg.setAttribute(&quot;title&quot;, EnigmailLocale.getString(&quot;importInfoTitle&quot;));</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  if (window.screen.width &gt; 500) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    dlg.setAttribute(&quot;maxwidth&quot;, window.screen.width - 150);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  }</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  if (window.screen.height &gt; 300) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    dlg.setAttribute(&quot;maxheight&quot;, window.screen.height - 100);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  }</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  var keyList = window.arguments[0].keyList;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  let onClickFunc = function(event) {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    let keyId = event.target.getAttribute(&quot;keyid&quot;);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    EnigmailWindows.openKeyDetails(window, keyId, false);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  };</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  for (i = 0, keys = []; i &lt; keyList.length; i++) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    let keyId = keyList[i];</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    if (keyId.search(/^0x/) === 0) {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+      keyId = keyId.substr(2).toUpperCase();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    }</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    let keyObj = EnigmailKeyRing.getKeyById(keyId);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    if (keyObj &amp;&amp; keyObj.fpr) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      let keyGroupBox = buildKeyGroupBox(keyObj);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      keyGroupBox.getElementsByClassName(&quot;enigmailKeyImportDetails&quot;)[0].addEventListener('click', onClickFunc, true);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+      keys.push(keyGroupBox);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    }</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  dlg.getButton(&quot;accept&quot;).focus();</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  if (keys.length) {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    let keysInfoBox = document.getElementById(&quot;keyInfo&quot;),</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      keysGrid = document.createXULElement(&quot;grid&quot;),</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+      keysRows = document.createXULElement(&quot;rows&quot;),</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+      keysCols = document.createXULElement(&quot;columns&quot;);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    for (i = 0; i &lt; 3; i++) {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+      keysCols.appendChild(document.createXULElement(&quot;column&quot;));</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+    }</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    let keysRow;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    for (i = 0; i &lt; keys.length; i++) {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+      if ((i % 3) === 0) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        keysRow = document.createXULElement(&quot;row&quot;);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        keysRows.appendChild(keysRow);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      }</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      keysRow.appendChild(keys[i]);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    }</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    keysGrid.appendChild(keysRows);</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+    keysGrid.appendChild(keysCols);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    keysInfoBox.appendChild(keysGrid);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  } else {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;importInfoNoKeys&quot;));</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    EnigmailEvents.dispatchEvent(window.close, 0);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    return;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  }</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  EnigmailEvents.dispatchEvent(resizeDlg, 0);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+}</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+function buildKeyGroupBox(keyObj) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+  let i,</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    groupBox = document.createXULElement(&quot;vbox&quot;),</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    vbox = document.createXULElement(&quot;hbox&quot;),</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    caption = document.createXULElement(&quot;image&quot;),</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+    userid = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    infoGrid = document.createXULElement(&quot;grid&quot;),</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+    infoColumns = document.createXULElement(&quot;columns&quot;),</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+    infoColId = document.createXULElement(&quot;column&quot;),</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    infoColDate = document.createXULElement(&quot;column&quot;),</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    infoRows = document.createXULElement(&quot;rows&quot;),</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+    infoRowHead = document.createXULElement(&quot;row&quot;),</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    infoRowBody = document.createXULElement(&quot;row&quot;),</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    infoLabelH1 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    infoLabelH2 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+    infoLabelH3 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    infoLabelB1 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    infoLabelB2 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    infoLabelB3 = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    fprGrid = document.createXULElement(&quot;grid&quot;),</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    fprLabel = document.createXULElement(&quot;label&quot;),</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    fprColumns = document.createXULElement(&quot;columns&quot;),</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    fprRows = document.createXULElement(&quot;rows&quot;),</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+    fprRow1 = document.createXULElement(&quot;row&quot;),</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    fprRow2 = document.createXULElement(&quot;row&quot;);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  groupBox.setAttribute(&quot;class&quot;, &quot;enigmailGroupbox&quot;);</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  userid.setAttribute(&quot;value&quot;, keyObj.userId);</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+  userid.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportUserId&quot;);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  vbox.setAttribute(&quot;align&quot;, &quot;start&quot;);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  caption.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportCaption&quot;);</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  infoLabelH1.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoBits&quot;));</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  infoLabelH2.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoCreated&quot;));</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  infoLabelH3.setAttribute(&quot;value&quot;, &quot;&quot;);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+  infoLabelB1.setAttribute(&quot;value&quot;, keyObj.keySize);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  infoLabelB2.setAttribute(&quot;value&quot;, keyObj.created);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  infoLabelB3.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoDetails&quot;));</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  infoLabelB3.setAttribute(&quot;keyid&quot;, keyObj.keyId);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+  infoLabelB3.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportDetails&quot;);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  infoRowHead.appendChild(infoLabelH1);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  infoRowHead.appendChild(infoLabelH2);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  infoRowHead.appendChild(infoLabelH3);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  infoRowHead.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportHeader&quot;);</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  infoRowBody.appendChild(infoLabelB1);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  infoRowBody.appendChild(infoLabelB2);</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  infoRowBody.appendChild(infoLabelB3);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  infoRows.appendChild(infoRowHead);</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+  infoRows.appendChild(infoRowBody);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  infoColumns.appendChild(infoColId);</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  infoColumns.appendChild(infoColDate);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  infoGrid.appendChild(infoColumns);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+  infoGrid.appendChild(infoRows);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+  fprLabel.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoFpr&quot;));</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  fprLabel.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportHeader&quot;);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+  for (i = 0; i &lt; keyObj.fpr.length; i += 4) {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+    var label = document.createXULElement(&quot;label&quot;);</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+    label.setAttribute(&quot;value&quot;, keyObj.fpr.substr(i, 4));</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+    if (i &lt; keyObj.fpr.length / 2) {</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+      fprColumns.appendChild(document.createXULElement(&quot;column&quot;));</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+      fprRow1.appendChild(label);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    } else {</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+      fprRow2.appendChild(label);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    }</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  }</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  fprRows.appendChild(fprRow1);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+  fprRows.appendChild(fprRow2);</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  fprGrid.appendChild(fprColumns);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+  fprGrid.appendChild(fprRows);</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+  vbox.appendChild(caption);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+  groupBox.appendChild(vbox);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+  groupBox.appendChild(userid);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  groupBox.appendChild(infoGrid);</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+  groupBox.appendChild(fprLabel);</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+  groupBox.appendChild(fprGrid);</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+  return groupBox;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+}</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+function resizeDlg() {</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+  var txt = document.getElementById(&quot;keyInfo&quot;);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+  var box = document.getElementById(&quot;outerbox&quot;);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+  var dlg = document.getElementById(&quot;enigmailKeyImportInfo&quot;);</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+  var deltaWidth = window.outerWidth - box.clientWidth;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+  var newWidth = txt.scrollWidth + deltaWidth + 20;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+  if (newWidth &gt; window.screen.width - 50) {</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+    newWidth = window.screen.width - 50;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  }</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  txt.style[&quot;white-space&quot;] = &quot;pre-wrap&quot;;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+  window.outerWidth = newWidth;</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+  var textHeight = txt.scrollHeight;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  var boxHeight = box.clientHeight;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+  var deltaHeight = window.outerHeight - boxHeight;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+  var newHeight = textHeight + deltaHeight + 25;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+  if (newHeight &gt; window.screen.height - 100) {</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+    newHeight = window.screen.height - 100;</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+  }</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+  window.outerHeight = newHeight;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+}</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+function centerDialog() {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  if (EnigmailOS.getOS() != &quot;Darwin&quot;)</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+    document.getElementById(&quot;enigmailKeyImportInfo&quot;).centerWindowOnScreen();</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+}</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+function dlgClose(buttonNumber) {</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  window.arguments[1].value = buttonNumber;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  window.close();</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+}</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+document.addEventListener(&quot;dialogaccept&quot;, function(event) {</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+  dlgClose(0);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.xul</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,37 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+&lt;!--</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+--&gt;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://openpgp/skin/enigmail.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+%brandDTD;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+&lt;!ENTITY % enigMailDTD SYSTEM &quot;chrome://openpgp/content/strings/enigmail.dtd&quot; &gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+%enigMailDTD;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+]&gt;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+&lt;dialog id=&quot;enigmailKeyImportInfo&quot;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+        title=&quot;&quot;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+        buttons=&quot;accept,help,cancel,extra1,extra2&quot;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+        onload=&quot;onLoad();&quot;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+        flex=&quot;1&quot;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+        minwidth=&quot;100&quot;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+        maxwidth=&quot;750&quot;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+        xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/enigmailKeyImportInfo.js&quot;/&gt;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  &lt;vbox align=&quot;center&quot; flex=&quot;1&quot; style=&quot;overflow:auto&quot; id=&quot;outerbox&quot;&gt;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    &lt;hbox align=&quot;center&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+      &lt;description flex=&quot;1&quot; id=&quot;keyInfo&quot; class=&quot;plain&quot; style=&quot;white-space: pre&quot;/&gt;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeySelection.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,961 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/*</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ */</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+// Uses: chrome://openpgp/content/ui/enigmailCommon.js</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+var Cu = Components.utils;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+var Cc = Components.classes;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+var Ci = Components.interfaces;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+/* global EnigInitCommon: false, EnigmailTrust: false, EnigGetString: false, EnigmailCore: false, EnigmailLog: false */</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+/* global EnigmailKeyRing: false, EnigGetPref: false, EnigGetTrustLabel: false, EnigSetActive: false, EnigAlert: false */</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+/* global EnigSetPref: false, EnigConfirm: false, EnigmailPrefs: false, EnigDownloadKeys: false */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+// Initialize enigmailCommon</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+EnigInitCommon(&quot;enigmailKeySelection&quot;);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+var EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+var EnigmailSearchCallback = ChromeUtils.import(&quot;chrome://openpgp/content/modules/searchCallback.jsm&quot;).EnigmailSearchCallback;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+var EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+var newEnigmailKeyObj = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyObj.jsm&quot;).newEnigmailKeyObj;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+var EnigmailCompat = ChromeUtils.import(&quot;chrome://openpgp/content/modules/compat.jsm&quot;).EnigmailCompat;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+var getCellAt = null;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+const INPUT = 0;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+const RESULT = 1;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+// field ID's of key list (as described in the doc/DETAILS file in the GnuPG distribution)</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+const KEY_TRUST = 1;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+const KEY_ID = 4;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+const CREATED = 5;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+const EXPIRY = 6;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+const USER_ID = 9;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+const KEY_USE_FOR = 11;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+const FPR = 9;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+// key trust values for field 1 (as described in the doc/DETAILS file in the GnuPG distribution)</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+const KEY_EXPIRED = &quot;e&quot;;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+const KEY_REVOKED = &quot;r&quot;;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+const KEY_INVALID = &quot;i&quot;;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+const KEY_DISABLED = &quot;d&quot;;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+const KEY_NOT_VALID = KEY_EXPIRED + KEY_REVOKED + KEY_INVALID + KEY_DISABLED;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+const KEY_IS_GROUP = &quot;g&quot;;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+// HKP related stuff</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+const ENIG_DEFAULT_HKP_PORT = &quot;11371&quot;;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+const TRUSTLEVELS_SORTED = EnigmailTrust.trustLevelsSorted();</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+var gUserList;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+var gResult;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+var gAlwaysTrust = false;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+var gSendEncrypted = true;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+var gSendSigned = true;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+var gAllowExpired = false;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+var gIpcRequest;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+var gTimeoutId = {};</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+var gEnigRemoveListener = false;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+var gKeysNotFound = [];</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+const EMPTY_UID = &quot; -&quot;;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+function onLoad() {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: onLoad\n&quot;);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  gIpcRequest = null;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;private&quot;) &gt;= 0) {</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    document.getElementById(&quot;enigmailKeySelectionDlg&quot;).setAttribute(&quot;title&quot;, EnigGetString(&quot;userSel.secretKeySel.title&quot;));</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  }</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  let tree = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  getCellAt = EnigmailCompat.getTreeCompatibleFuncs(tree, null).getCellAt;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  tree.addEventListener('click', onClickCallback, true);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  EnigmailSearchCallback.setup(document.getElementById(&quot;filterKey&quot;), gTimeoutId, applyFilter, 200);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  let enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  if (!enigmailSvc) {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    return false;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  }</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  buildList(false);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  return true;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+}</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+function refreshKeys() {</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  // delete existing entries:</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  var userTreeList = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  var treeChildren = userTreeList.getElementsByAttribute(&quot;id&quot;, &quot;enigmailUserIdSelectionChildren&quot;)[0];</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  while (treeChildren.firstChild) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    treeChildren.removeChild(treeChildren.firstChild);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  }</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  // rebuild new entries:</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  buildList(true);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+}</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+function getKeyList(secretOnly, refresh) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: getKeyList\n&quot;);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  const cApi = EnigmailCryptoAPI();</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  let userList,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+    keyList;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  try {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    var statusFlagsObj = {};</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+    var errorMsgObj = {};</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    if (refresh) {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+      EnigmailKeyRing.clearCache();</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    }</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    if (secretOnly) {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      userList = EnigmailKeyRing.getAllSecretKeys(window);</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+      if (!userList) return null;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+      keyList = EnigmailFuncs.cloneObj(userList);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+    } else {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+      userList = EnigmailKeyRing.getAllKeys(window);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+      if (!userList) return null;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+      if (userList.trustModel === &quot;t&quot;) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+        gAlwaysTrust = true;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+      }</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      keyList = EnigmailFuncs.cloneObj(userList.keyList);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+      let grpList = cApi.getGroups().map(k =&gt; {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+        return newEnigmailKeyObj(k);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+      });</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+      for (let i in grpList) {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+        keyList.push(grpList[i]);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+      }</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    EnigmailLog.writeException(&quot;enigmailKeySelection.js: getKeyList&quot;, ex);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  }</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  return keyList;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+}</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+/**</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+ * Helper function to sort keys in the order specific for this dialog</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+ */</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+function sortKeys(a, b) {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  // sorting criterion for dialog entries</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  // - note: for active state we have values:</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  //         0: not active</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  //         1: active</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  //         2: not selectable (red because invalid)</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  var r = 0;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  // 1st: sort active keys in front of not active keys</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  if ((a.activeState != b.activeState) &amp;&amp; (a.activeState == 1 || b.activeState == 1)) {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    r = (a.activeState == 1 ? -1 : 1);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  }</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  // 2nd: sort keys matching invalid addresses in front non-matching addresses</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  else if (a.uidMatchInvalid != b.uidMatchInvalid) {</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+    r = (a.uidMatchInvalid == 1 ? -1 : 1);</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  }</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  // 3rd: sort non-activateable keys to the end</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+  else if ((a.activeState != b.activeState) &amp;&amp; (a.activeState == 2 || b.activeState == 2)) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+    r = (a.activeState === 0 ? -1 : 1);</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  }</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+  // 4th: sort according to user IDs</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  else if (a.userId.toLowerCase() &lt; b.userId.toLowerCase()) {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    r = -1;</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  } else if (a.userId.toLowerCase() &gt; b.userId.toLowerCase()) {</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+    r = 1;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  }</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  // 5th: sort according to trust level (higher index value in front)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  else if (TRUSTLEVELS_SORTED.indexOf(a.keyTrust) &gt; TRUSTLEVELS_SORTED.indexOf(b.keyTrust)) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+    r = -1;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  } else {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+    r = 1;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  }</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  return r;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+}</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+/**</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+ * Set up the dialog in terms of visible columns and top-level message(s)</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+ */</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+function prepareDialog(secretOnly) {</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  if (window.arguments[INPUT].dialogHeader) {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+    var dialogHeader = document.getElementById(&quot;dialogHeader&quot;);</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+    if (dialogHeader) {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+      dialogHeader.innerHTML = window.arguments[INPUT].dialogHeader;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+      dialogHeader.style.visibility = &quot;visible&quot;;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    }</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  } else {</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    let box = document.getElementById(&quot;dialogHeaderBox&quot;);</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+    box.setAttribute(&quot;class&quot;, &quot;enigmailCaptionboxNoTitle&quot;);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+    box.removeChild(box.firstChild);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+  }</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  var dialogMsgList = document.getElementById(&quot;dialogMsgList&quot;);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  var dialogMsgListRows = document.getElementById(&quot;dialogMsgListRows&quot;);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  if (dialogMsgListRows) {</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+    // clear the list (otherwise it grows with each loaded missing key)</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    while (dialogMsgListRows.firstChild) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+      dialogMsgListRows.removeChild(dialogMsgListRows.firstChild);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    }</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+    // fill the list according to the error messages</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    if (window.arguments[INPUT].errArray &amp;&amp; window.arguments[INPUT].errArray.length &gt; 0) {</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      var array = window.arguments[INPUT].errArray;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+      for (var detIdx = 0; detIdx &lt; array.length; ++detIdx) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+        var msg = null;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        switch (array[detIdx].msg) {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+          case &quot;ProblemNoKey&quot;:</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+            msg = EnigGetString(&quot;userSel.problemNoKey&quot;);</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+            if (window.arguments[INPUT].options.indexOf(&quot;nosending&quot;) &lt; 0) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+              document.getElementById(&quot;importMissingKeys&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+            }</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+            break;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+          case &quot;ProblemMultipleKeys&quot;:</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+            msg = EnigGetString(&quot;userSel.problemMultipleKeys&quot;);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+            break;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+          default:</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+            EnigmailLog.DEBUG(&quot;missing label for '&quot; + array[detIdx].msg + &quot;'\n&quot;);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+            msg = &quot;???&quot;;</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+            break;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+        }</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+        var row = document.createXULElement('row');</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+        var cell = document.createXULElement('label');</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+        cell.setAttribute('value', array[detIdx].addr + &quot;:&quot;);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+        row.appendChild(cell);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+        cell = document.createXULElement('label');</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+        cell.setAttribute('value', msg);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+        row.appendChild(cell);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+        dialogMsgListRows.appendChild(row);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+      }</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+      dialogMsgList.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+    } else {</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      dialogMsgList.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+    }</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  }</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+  if (secretOnly) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+    // rename expired row to created</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+    document.getElementById(&quot;expCol&quot;).setAttribute(&quot;label&quot;, EnigGetString(&quot;createdHeader&quot;));</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  }</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;unsigned&quot;) &gt;= 0) {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+    gSendSigned = false;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+    var sendSignedCheckbox = document.getElementById(&quot;enigmailUserSelSendSigned&quot;);</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+    sendSignedCheckbox.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  }</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  if ((window.arguments[INPUT].options.indexOf(&quot;rulesOption&quot;) &lt; 0)) {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    var rulesOption = document.getElementById(&quot;enigmailKeySelectionDlg&quot;).getButton(&quot;extra1&quot;);</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+    rulesOption.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  }</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  var dialogHeaderDesc = document.getElementById(&quot;dialogHeaderDesc&quot;);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+  var notFoundCapt = document.getElementById(&quot;usersNotFoundCapt&quot;);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;multisel&quot;) &lt; 0) {</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+    // single key selection -&gt; hide selection col</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+    var selColumn = document.getElementById(&quot;selectionCol&quot;);</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+    selColumn.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    gUserList.setAttribute(&quot;hidecolumnpicker&quot;, &quot;true&quot;);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  }</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;nosending&quot;) &gt;= 0) {</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+    // hide not found recipients, hide &quot;send unencrypted&quot;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    document.getElementById(&quot;dialogHeadline&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+    document.getElementById(&quot;enigmailUserSelSendSigned&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+    document.getElementById(&quot;enigmailUserSelSendEncrypted&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  } else if (window.arguments[INPUT].options.indexOf(&quot;noforcedisp&quot;) &gt;= 0) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    document.getElementById(&quot;displayNoLonger&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  }</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;noplaintext&quot;) &gt;= 0) {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+    // hide &quot;send unencrypted&quot;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+    document.getElementById(&quot;enigmailUserSelSendEncrypted&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+  }</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;forUser&quot;) &gt;= 0) {</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+    // display title message for Per-Recipient Rule</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+    dialogHeaderDesc.firstChild.data = EnigGetString(&quot;keysToUse&quot;, window.arguments[INPUT].forUser);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+    dialogHeaderDesc.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    notFoundCapt.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  }</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;,sendlabel=&quot;) &gt;= 0) {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+    var pos1 = window.arguments[INPUT].options.indexOf(&quot;,sendlabel=&quot;);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+    pos1 = window.arguments[INPUT].options.indexOf(&quot;=&quot;, pos1);</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+    var pos2 = window.arguments[INPUT].options.indexOf(&quot;,&quot;, pos1);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+    var acceptButton = document.getElementById(&quot;enigmailKeySelectionDlg&quot;).getButton(&quot;accept&quot;);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+    acceptButton.setAttribute(&quot;label&quot;, window.arguments[INPUT].options.substring(pos1 + 1, pos2));</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  }</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+}</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+function buildList(refresh) {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildList\n&quot;);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  window.arguments[RESULT].cancelled = true;</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  gAlwaysTrust = (EnigGetPref(&quot;acceptedKeys&quot;) == 1);</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+  var secretOnly = (window.arguments[INPUT].options.indexOf(&quot;private&quot;) &gt;= 0);</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+  var hideExpired = (window.arguments[INPUT].options.indexOf(&quot;hidexpired&quot;) &gt;= 0);</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+  gAllowExpired = (window.arguments[INPUT].options.indexOf(&quot;allowexpired&quot;) &gt;= 0);</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;trustallkeys&quot;) &gt;= 0) {</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+    gAlwaysTrust = true;</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  }</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+  var aUserList = getKeyList(secretOnly, refresh);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+  if (!aUserList) return;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+  var uidNotValid;</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+  if (gAlwaysTrust) {</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+    uidNotValid = &quot;&quot;;</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+  } else {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+    uidNotValid = &quot;o-qn&quot;;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  }</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  gUserList = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+  gUserList.currentItem = null;</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+  try {</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+    prepareDialog(secretOnly);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+    EnigmailLog.DEBUG(&quot;EXCEPTION: &quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+  }</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+  var i;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+  var j;</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+  var toKeys = &quot;&quot;;</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+  try {</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+    if (typeof(window.arguments[INPUT].toKeys) == &quot;string&quot;) {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+      toKeys = window.arguments[INPUT].toKeys;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+    }</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  var invalidAddr = &quot;&quot;;</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+  try {</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+    // the test below had &quot;&amp;&amp; !refresh&quot; probably not to list invalid keys</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+    // anymore after refreshing.</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+    // However, that's confusing because with the after refreshing keys</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+    // with no change in the key set, different items are selected.</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+    // Thus, this is disabled until there is a reprocessing of validity.</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+    if (typeof(window.arguments[INPUT].invalidAddr) == &quot;string&quot;) {</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+      invalidAddr = &quot; &quot; + window.arguments[INPUT].invalidAddr + &quot; &quot;;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+    }</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+  // sort out PGP keys in toAddr</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+  var toAddrList = getToAddrList();</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+  for (i = 0; i &lt; toAddrList.length; i++) {</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+    if (toAddrList[i].search(/^0x([0-9A-Fa-f]{8}|[0-9A-Fa-f]{16})$/) &gt;= 0) {</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+      var newKey = toAddrList.splice(i, 1);</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+      toKeys += &quot; &quot; + newKey;</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+      i--;</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+    }</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+  }</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+  var toAddr = &quot;&lt;&quot; + toAddrList.join(&quot;&gt;&lt;&quot;) + &quot;&gt;&quot;;</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+  var d = new Date();</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+  var now = d.valueOf() / 1000;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+  var aValidUsers = [];</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+  var mailAddr,</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+    escapedMailAddr;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+  var s1;</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+  // Replace any non-text character c with \\c</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+  var escapeRegExp = new RegExp(&quot;([^a-zA-Z0-9])&quot;, &quot;g&quot;);</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+  // delete &quot;empty&quot; entries</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+  for (i = 0; i &lt; aUserList.length; i++) {</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+    if (typeof(aUserList[i].userId) != &quot;string&quot;) {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+      aUserList.splice(i, 1);</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+    }</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+  }</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+  let user;</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+  // find and activate keys</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+  try {</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+    for (i = 0; i &lt; aUserList.length; i++) {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+      // prepare key obj</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+      if (aUserList[i].keyUseFor.indexOf(&quot;D&quot;) &gt;= 0) {</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+        aUserList[i].keyTrust = KEY_DISABLED;</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+      }</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+      aUserList[i].subkeyOK = (aUserList[i].keyUseFor.indexOf(&quot;e&quot;) &gt;= 0 || secretOnly);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+      aUserList[i].valid = false;</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+      aUserList[i].uidValid = true;</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+      aUserList[i].uidMatchInvalid = false; // by default don't match list of invalid emails</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+      if (aUserList[i].type === &quot;grp&quot;) {</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+        // groups</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+        aUserList[i].valid = true;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+        aUserList[i].uidValid = true;</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+        aUserList[i].subkeyOK = true;</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+      }</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+      for (let s in aUserList[i].subKeys) {</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+        if ((aUserList[i].subKeys[s].keyUseFor.indexOf(&quot;e&quot;) &gt;= 0) &amp;&amp;</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+          (KEY_NOT_VALID.indexOf(aUserList[i].subKeys[s].keyTrust) &lt; 0)) {</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+          aUserList[i].subkeyOK = true;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+        }</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+      }</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+      // work on key obj</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+      var toKeyList = toKeys.split(/[, ]+/);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+      aUserList[i].activeState = (gAllowExpired ? 0 : 2); // default: not activated/activateable</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+      if (aUserList[i].keyTrust != KEY_IS_GROUP) {</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+        // handling of &quot;normal&quot; keys</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+        mailAddr = stripEmailFromKey(aUserList[i].userId);</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+        if (mailAddr != EMPTY_UID &amp;&amp; invalidAddr.indexOf(&quot; &quot; + mailAddr + &quot; &quot;) &gt;= 0) {</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+          aUserList[i].uidMatchInvalid = true; // found matching but invalid email</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+        }</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+        if (((!aUserList[i].keyTrust) ||</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+            KEY_NOT_VALID.indexOf(aUserList[i].keyTrust) &lt; 0) &amp;&amp;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+          aUserList[i].subkeyOK &amp;&amp;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+          (aUserList[i].expiryTime &lt;= 0 ||</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+            (aUserList[i].expiryTime &gt;= now))) {</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+          // key still valid</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+          aUserList[i].valid = true;</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+          escapedMailAddr = mailAddr.replace(escapeRegExp, &quot;\\$1&quot;);</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+          s1 = new RegExp(&quot;&lt;&quot; + escapedMailAddr + &quot;&gt;&quot;, &quot;i&quot;);</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+          if (mailAddr != EMPTY_UID) {</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+            if (invalidAddr.indexOf(&quot; &quot; + mailAddr + &quot; &quot;) &lt; 0) {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+              aValidUsers.push(mailAddr);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+              aUserList[i].activeState = (toAddr.search(s1) &gt;= 0 ? 1 : 0);</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+            } else {</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+              // mail address found as invalid address: marks that to sort them to the beginning</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+              aUserList[i].uidMatchInvalid = true;</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+              aUserList[i].uidValid = false;</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+              aUserList[i].activeState = 0;</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+            }</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+          } else {</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+            aUserList[i].uidValid = false;</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+            aUserList[i].activeState = 0;</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+          }</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+          if (aUserList[i].activeState === 0 &amp;&amp; toKeys.length &gt; 0) {</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+            // Now loop through toKeyList and search for matching keyIds</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+            for (j = 0; j &lt; toKeyList.length; j++) {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+              if (toKeyList[j].length &gt; 0) {</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+                if (EnigmailKey.compareKeyIds(aUserList[i].keyId, toKeyList[j])) {</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+                  aUserList[i].activeState = 1;</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+                }</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+              }</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+            }</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+          }</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+        }</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+      } else {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+        // special handling for gpg groups</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+        mailAddr = stripEmailFromKey(aUserList[i].userId);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+        aValidUsers.push(mailAddr);</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+        aUserList[i].valid = true;</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+        aUserList[i].uidValid = true;</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+        if (toKeys.length &gt; 0) {</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+          aUserList[i].activeState = (toKeys.indexOf(&quot;GROUP:&quot; + aUserList[i].keyId + &quot;,&quot;) &gt;= 0 ? 1 : 0);</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+        } else</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+          aUserList[i].activeState = 0;</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+      }</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+      if (!hideExpired || aUserList[i].activeState &lt; 2) {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+        if ((aUserList[i].keyTrust != KEY_IS_GROUP) &amp;&amp; aUserList[i].hasSubUserIds()) {</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+          for (user = 1; user &lt; aUserList[i].userIds.length; user++) {</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+            if (KEY_NOT_VALID.indexOf(aUserList[i].userIds[user].keyTrust) &lt; 0) {</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+              if (aUserList[i].activeState &lt; 2 || gAllowExpired) {</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+                // add uid's for valid keys</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+                mailAddr = stripEmailFromKey(aUserList[i].userIds[user].userId);</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+                if (uidNotValid.indexOf(aUserList[i].userIds[user].keyTrust) &lt; 0) {</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+                  aValidUsers.push(mailAddr);</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+                  aUserList[i].valid = true;</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+                  escapedMailAddr = mailAddr.replace(escapeRegExp, &quot;\\$1&quot;);</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+                  s1 = new RegExp(&quot;&lt;&quot; + escapedMailAddr + &quot;&gt;&quot;, &quot;i&quot;);</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+                  if ((mailAddr != EMPTY_UID) &amp;&amp; (toAddr.search(s1) &gt;= 0)) {</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+                    aUserList[i].activeState = 1;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+                  }</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+                }</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+              }</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+            }</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+          }</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+        }</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+      }</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+    }</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+    EnigmailLog.ERROR(&quot;enigmailKeySelection.js: ERROR in buildList: &quot; + ex.toString() + &quot;\n&quot; + ex.stack + &quot;\n&quot;);</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+  }</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+  // sort items according to sorting criterion</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+  aUserList.sort(sortKeys);</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+  buildTreeView(aUserList, hideExpired, secretOnly);</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+  buildNotFoundKeys(aUserList, aValidUsers, toAddrList, toKeys);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+  EnigmailLog.DEBUG(&quot;  &lt;=== buildList()\n&quot;);</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+}</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+/**</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+ * Build up tree view for displaying keys</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+ */</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+function buildTreeView(aUserList, hideExpired, secretOnly) {</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildTreeView\n&quot;);</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+  let i;</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+  let treeChildren = gUserList.getElementsByAttribute(&quot;id&quot;, &quot;enigmailUserIdSelectionChildren&quot;)[0];</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+  for (i = 0; i &lt; aUserList.length; i++) {</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+    var treeItem = null;</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+    if (!hideExpired || aUserList[i].activeState &lt; 2) {</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+      // do not show if expired keys are hidden</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+      if (secretOnly) {</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+        treeItem = enigUserSelCreateRow(aUserList[i], aUserList[i].activeState, aUserList[i].userId, aUserList[i].keyId, aUserList[i].created, &quot;&quot;, true);</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+      } else {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+        treeItem = enigUserSelCreateRow(aUserList[i], aUserList[i].activeState, aUserList[i].userId, aUserList[i].keyId, aUserList[i].expiry, aUserList[i].keyTrust, aUserList[i].uidValid);</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+      }</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+      if (aUserList[i].hasSubUserIds()) {</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+        var subChildren = document.createXULElement(&quot;treechildren&quot;);</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+        for (let user = 1; user &lt; aUserList[i].userIds.length; user++) {</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+          if (KEY_NOT_VALID.indexOf(aUserList[i].userIds[user].keyTrust) &lt; 0) {</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+            var subItem = enigUserSelCreateRow(aUserList[i], -1, aUserList[i].userIds[user].userId, &quot;&quot;, &quot;&quot;, aUserList[i].userIds[user].keyTrust, true);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+            subChildren.appendChild(subItem);</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+          }</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+        }</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+        if (subChildren.hasChildNodes()) {</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+          treeItem.setAttribute(&quot;container&quot;, &quot;true&quot;);</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+          treeItem.appendChild(subChildren);</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+        }</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+      }</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+    }</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+    if (treeItem) {</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+      treeChildren.appendChild(treeItem);</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+    }</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+  }</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+}</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+/**</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+ * Build up list of not found recipients</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+ */</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+function buildNotFoundKeys(aUserList, aValidUsers, toAddrList, toKeys) {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys\n&quot;);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+  gKeysNotFound = [];</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+  let i,</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+    j;</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+  for (i = 0; i &lt; toAddrList.length; i++) {</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+    if (toAddrList[i].length &gt; 0) {</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+      let found = false;</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+      for (j = 0; j &lt; aValidUsers.length; j++) {</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: comparing aValidUsers member &quot; + aValidUsers[j].toLowerCase() + &quot; and toAddrList member &quot; + toAddrList[i].toLowerCase() + &quot;\n&quot;);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+        if (aValidUsers[j].toLowerCase() == toAddrList[i].toLowerCase()) {</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: aValidUsers member matches toAddrList member...\n&quot;);</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+          found = true;</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+          break; // the inner loop</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+        }</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+      }</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+      if (!found) {</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: not found &quot; + toAddrList[i] + &quot;\n&quot;);</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+        gKeysNotFound.push(toAddrList[i]);</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+      }</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    }</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+  }</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+  var toKeyList = toKeys.split(/[, ]+/);</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+  for (i = 0; i &lt; toKeyList.length; i++) {</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+    if (toKeyList[i].length &gt; 0) {</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+      let found = false;</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+      for (j = 0; j &lt; aUserList.length; j++) {</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: comparing toKeyList member &quot; + toKeyList[i] + &quot; and aUserList member 0x&quot; + aUserList[j].keyId + &quot;\n&quot;);</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+        if (aUserList[j].valid &amp;&amp; EnigmailKey.compareKeyIds(aUserList[j].keyId, toKeyList[i])) {</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: aUserList member is valid and key Id matches...\n&quot;);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+          found = true;</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+          break; // the inner loop</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+        }</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+      }</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+      if (!found) {</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: buildNotFoundKeys: not found &quot; + toKeyList[i] + &quot;\n&quot;);</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+        gKeysNotFound.push(toKeyList[i]);</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+      }</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+    }</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+  }</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+}</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+// create a (sub) row for the user tree</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+function enigUserSelCreateRow(userObj, activeState, userId, keyValue, dateField, uidValidityStatus, uidValid) {</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+  var selectCol = document.createXULElement(&quot;treecell&quot;);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+  selectCol.setAttribute(&quot;id&quot;, &quot;indicator&quot;);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+  var uidValidityCol = document.createXULElement(&quot;treecell&quot;);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+  var expCol = document.createXULElement(&quot;treecell&quot;);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+  var userCol = document.createXULElement(&quot;treecell&quot;);</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+  userCol.setAttribute(&quot;id&quot;, &quot;name&quot;);</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+  expCol.setAttribute(&quot;id&quot;, &quot;expiry&quot;);</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+  uidValidityCol.setAttribute(&quot;id&quot;, &quot;validity&quot;);</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+  userCol.setAttribute(&quot;label&quot;, userId);</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+  expCol.setAttribute(&quot;label&quot;, dateField);</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+  var keyCol = document.createXULElement(&quot;treecell&quot;);</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineplus">+  if (userObj.keyTrust != KEY_IS_GROUP) {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+    keyCol.setAttribute(&quot;label&quot;, &quot;0x&quot; + keyValue);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+  } else {</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+    keyCol.setAttribute(&quot;label&quot;, EnigGetString(&quot;keyTrust.group&quot;));</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+  }</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+  keyCol.setAttribute(&quot;id&quot;, &quot;keyid&quot;);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+  // process validity label</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+  var validity = EnigGetTrustLabel(uidValidityStatus.charAt(0));</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+  if (!uidValid) {</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+    if (validity == &quot;-&quot;) {</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+      validity = &quot;-  (&quot; + EnigGetString(&quot;keyTrust.untrusted&quot;).toUpperCase() + &quot;)&quot;;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+    }</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+  }</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+  if (!userObj.subkeyOK &amp;&amp; KEY_NOT_VALID.indexOf(uidValidityStatus.charAt(0)) &lt; 0) {</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+    validity = EnigGetString(&quot;keyValid.noSubkey&quot;);</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+  }</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+  // process which row elements to make insensitive</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+  if (((userObj.keyTrust.length &gt; 0) &amp;&amp;</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+      (KEY_NOT_VALID.indexOf(userObj.keyTrust.charAt(0)) &gt;= 0)) ||</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+    (!userObj.subkeyOK)) {</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+    // disabled/revoked/expired/invalid (sub)keys inactivate whole row</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+    userCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+    uidValidityCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+    expCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+    keyCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+    if (!gAllowExpired &amp;&amp; activeState &gt;= 0) {</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      activeState = 2;</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+    }</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+  } else if (!gAlwaysTrust) {</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+    if ((&quot;mfu&quot;.indexOf(userObj.keyTrust.charAt(0)) &lt; 0) ||</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+      (uidValidityStatus.length &gt; 0) &amp;&amp;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+      (&quot;o-qn&quot;.indexOf(uidValidityStatus.charAt(0)) &gt;= 0)) {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+      // keys with not enough trust have insensitive elements, but are activateable</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+      userCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+      uidValidityCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+      expCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+      keyCol.setAttribute(&quot;properties&quot;, &quot;enigKeyInactive&quot;);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+    }</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+  }</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+  EnigSetActive(selectCol, activeState);</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+  uidValidityCol.setAttribute(&quot;label&quot;, validity);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+  var userRow = document.createXULElement(&quot;treerow&quot;);</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+  userRow.appendChild(selectCol);</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+  userRow.appendChild(userCol);</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+  userRow.appendChild(uidValidityCol);</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+  userRow.appendChild(expCol);</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+  userRow.appendChild(keyCol);</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+  var treeItem = document.createXULElement(&quot;treeitem&quot;);</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+  if (userObj.keyTrust == KEY_IS_GROUP) {</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+    treeItem.setAttribute(&quot;id&quot;, &quot;GROUP:&quot; + userObj.keyId);</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+  } else {</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+    treeItem.setAttribute(&quot;id&quot;, &quot;0x&quot; + userObj.keyId);</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+    if (userObj.fpr.length &gt; 0) {</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+      treeItem.setAttribute(&quot;fpr&quot;, &quot;0x&quot; + userObj.fpr);</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+    }</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+  }</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+  treeItem.appendChild(userRow);</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+  return treeItem;</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+}</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+function onAccept() {</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+  EnigmailLog.DEBUG(&quot;enigmailKeySelection.js: Accept\n&quot;);</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+  var resultObj = window.arguments[RESULT];</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+  resultObj.userList = [];</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+  resultObj.perRecipientRules = false;</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+  resultObj.repeatEvaluation = false;</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+  var t = &quot;&quot;;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+  gUserList = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+  var treeChildren = gUserList.getElementsByAttribute(&quot;id&quot;, &quot;enigmailUserIdSelectionChildren&quot;)[0];</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+  var item;</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+  if (window.arguments[INPUT].options.indexOf(&quot;multisel&quot;) &lt; 0) {</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+    if (gUserList.currentIndex &gt;= 0) {</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+      item = gUserList.view.getItemAtIndex(gUserList.currentIndex);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+      if (item.getAttribute(&quot;fpr&quot;)) {</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+        resultObj.userList.push(item.getAttribute(&quot;fpr&quot;));</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+      } else {</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+        resultObj.userList.push(item.getAttribute(&quot;id&quot;));</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+      }</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+    }</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+  } else {</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+    item = treeChildren.firstChild;</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+    while (item) {</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+      var aRows = item.getElementsByAttribute(&quot;id&quot;, &quot;indicator&quot;);</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+      if (aRows.length) {</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+        var elem = aRows[0];</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+        if (elem.getAttribute(&quot;active&quot;) == &quot;1&quot;) {</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+          if (item.getAttribute(&quot;fpr&quot;)) {</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+            resultObj.userList.push(item.getAttribute(&quot;fpr&quot;));</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+          } else {</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+            resultObj.userList.push(item.getAttribute(&quot;id&quot;));</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+          }</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+        }</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+      }</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+      item = item.nextSibling;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+    }</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+  }</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+  if (document.getElementById(&quot;displayNoLonger&quot;).checked) {</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+    // no longer force manual disalog even if no keys missing</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+    EnigSetPref(&quot;assignKeysByManuallyAlways&quot;, false);</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+  }</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+  if (resultObj.userList.length === 0 &amp;&amp; gSendEncrypted) {</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+    EnigAlert(EnigGetString(&quot;atLeastOneKey&quot;));</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+    return false;</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+  }</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+  if ((resultObj.userList.length &lt; getToAddrList().length) &amp;&amp; gSendEncrypted) {</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+    if (!EnigConfirm(EnigGetString(&quot;fewerKeysThanRecipients&quot;), EnigGetString(&quot;dlg.button.continue&quot;), EnigGetString(&quot;userSel.button.goBack&quot;)))</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+      return false;</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+  }</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+  resultObj.cancelled = false;</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+  resultObj.encrypt = gSendEncrypted;</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+  resultObj.sign = gSendSigned;</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+  return true;</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+}</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+function getToAddrList() {</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+  var toAddrList;</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+  try {</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+    toAddrList = EnigmailFuncs.stripEmail(window.arguments[INPUT].toAddr).split(/[ ,]+/);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+    toAddrList = [];</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+  }</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+  return toAddrList;</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+}</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+function onClickCallback(event) {</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+  userSelCallback(event);</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+}</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+function userSelCallback(event) {</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+  if (!gSendEncrypted)</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+    return;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+  let Tree;</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+  let row;</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+  let col;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+  if (event.type == &quot;keypress&quot;) {</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+    // key event</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+    if (event.charCode == 32) {</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+      Tree = event.target;</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+      if (Tree.view.selection.count &gt; 0) {</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+        row = Tree.view.selection.currentIndex;</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+      }</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+    } else {</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+      return;</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+    }</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+  } else if (event.type == &quot;click&quot;) {</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+    // Mouse event</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+    Tree = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+    let treeInfo = getCellAt(event.clientX, event.clientY);</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+    row = treeInfo.row;</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+    col = treeInfo.col;</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+    if (!treeInfo.col) // not clicked on a valid column (e.g. scrollbar)</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+      return;</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+    if (event.detail &gt; 2) return;</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+    if ((event.detail == 1) &amp;&amp; (col.id != &quot;selectionCol&quot;))</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+      return; // single clicks are only relevant for the selection column</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+    if ((event.detail == 2) &amp;&amp; (&quot;selectionCol,enigUserNameCol,uidValidityCol,expCol,keyCol&quot;.indexOf(col.id) &lt; 0))</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+      return;</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+  }</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+  if (row == -1)</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+    return;</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+  var treeItem = Tree.view.getItemAtIndex(row);</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+  Tree.currentItem = treeItem;</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+  var aRows = treeItem.getElementsByAttribute(&quot;id&quot;, &quot;indicator&quot;);</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+  if (event.detail == 2) {</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+    if (window.arguments[INPUT].options.indexOf(&quot;multisel&quot;) &lt; 0) {</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+      document.getElementById(&quot;enigmailKeySelectionDlg&quot;).acceptDialog();</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+      return;</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+    }</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+  }</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+  if (aRows.length) {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+    var elem = aRows[0];</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+    if (elem.getAttribute(&quot;active&quot;) == &quot;1&quot;) {</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+      EnigSetActive(elem, 0);</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+    } else if (elem.getAttribute(&quot;active&quot;) == &quot;0&quot;) {</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+      EnigSetActive(elem, 1);</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+    }</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+  }</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+}</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+function switchSendSignedCallback() {</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+  gSendSigned = document.getElementById(&quot;enigmailUserSelSendSigned&quot;).checked;</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+}</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+function switchSendEncryptedCallback() {</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+  gSendEncrypted = document.getElementById(&quot;enigmailUserSelSendEncrypted&quot;).checked;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+  displayNoLonger();</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+  disableList();</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+}</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+function displayNoLonger() {</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+  var dispMsg = document.getElementById(&quot;displayNoLonger&quot;);</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+  if (gSendEncrypted) {</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+    dispMsg.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+  } else {</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+    dispMsg.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+  }</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+}</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+function disableList() {</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+  var Tree = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+  var node = Tree.firstChild.firstChild;</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+  while (node) {</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+    // set the background of all colums to gray</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+    if (node.localName == &quot;treecol&quot;) {</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+      if (gSendEncrypted) {</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+        node.removeAttribute(&quot;properties&quot;);</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+      } else {</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+        node.setAttribute(&quot;properties&quot;, &quot;enigDontEncrypt&quot;);</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+      }</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+    }</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+    node = node.nextSibling;</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+  }</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+}</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+function newRecipientRule() {</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+  // enable rules to ensure that the new rule gets processed</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+  EnigSetPref(&quot;assignKeysByRules&quot;, true);</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+  var resultObj = window.arguments[RESULT];</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+  resultObj.userList = [];</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+  resultObj.repeatEvaluation = true;</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+  resultObj.perRecipientRules = true;</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+  resultObj.cancelled = false;</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  resultObj.encrypt = &quot;&quot;;</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+  window.close();</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+  return true;</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+}</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+function searchMissingKeys() {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+  var inputObj = {</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+    searchList: gKeysNotFound,</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+    autoKeyServer: EnigmailPrefs.getPref(&quot;autoKeyServerSelection&quot;) ? EnigmailPrefs.getPref(&quot;keyserver&quot;).split(/[ ,;]/g)[0] : null</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+  };</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+  var resultObj = {};</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+  EnigDownloadKeys(inputObj, resultObj);</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+  if (resultObj.importedKeys &gt; 0) {</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+    resultObj = window.arguments[RESULT];</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+    resultObj.userList = [];</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+    resultObj.repeatEvaluation = true;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+    resultObj.perRecipientRules = false;</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+    resultObj.cancelled = false;</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+    resultObj.encrypt = &quot;&quot;;</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+    window.close();</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+    return true;</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+  }</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+  return null;</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+}</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+function applyFilter() {</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+  let searchInput = document.getElementById(&quot;filterKey&quot;);</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+  let searchValue = searchInput.value.toLowerCase();</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+  let userTreeList = document.getElementById(&quot;enigmailUserIdSelection&quot;);</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+  let treeChildren = userTreeList.getElementsByAttribute(&quot;id&quot;, &quot;enigmailUserIdSelectionChildren&quot;)[0];</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+  if (searchValue === &quot;&quot;) {</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+    // unhide all items</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+    for (let item = treeChildren.firstChild; item; item = item.nextSibling) {</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+      item.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+    }</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+  } else {</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    // hide items that are</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+    // - not active</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    // - and do not match the search string in all names/emails or key</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+    for (let item = treeChildren.firstChild; item; item = item.nextSibling) {</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+      var showItem = false;</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+      // check active</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+      var aRows = item.getElementsByAttribute(&quot;id&quot;, &quot;indicator&quot;);</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+      if (aRows.length) {</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+        var elem = aRows[0];</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+        if (elem.getAttribute(&quot;active&quot;) == &quot;1&quot;) {</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+          showItem = true;</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+        }</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+      }</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+      if (!showItem) {</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+        // check all names/emails</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+        let str = &quot;&quot;;</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+        aRows = item.getElementsByAttribute(&quot;id&quot;, &quot;name&quot;);</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+        for (let r = 0; r &lt; aRows.length; ++r) {</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+          str += aRows[r].getAttribute(&quot;label&quot;);</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+        }</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+        if (str.toLowerCase().indexOf(searchValue) &gt;= 0) {</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+          showItem = true;</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+        }</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+      }</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+      if (!showItem) {</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+        // check all keys</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+        let str = &quot;&quot;;</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+        aRows = item.getElementsByAttribute(&quot;id&quot;, &quot;keyid&quot;);</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+        for (let r = 0; r &lt; aRows.length; ++r) {</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+          str += aRows[r].getAttribute(&quot;label&quot;);</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+        }</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+        if (str.toLowerCase().indexOf(searchValue) &gt;= 0) {</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+          showItem = true;</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+        }</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+      }</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+      item.setAttribute(&quot;hidden&quot;, !showItem);</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+    }</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+  }</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+}</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+function stripEmailFromKey(uid) {</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+  try {</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+    return EnigmailFuncs.stripEmail(uid).toLowerCase();</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+    // remove quotes</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+    return EnigmailFuncs.stripEmail(uid.replace(/&quot;/g, &quot;&quot;)).toLowerCase();</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+  } finally {</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+    // search for last ocurrence of &lt; &gt;</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+    return uid.replace(/(.*)(&lt;)([^&lt;&gt; ]+)(&gt;[^&lt;&gt;]*)$/, &quot;$3&quot;).toLowerCase(); // eslint-disable-line no-unsafe-finally</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+  }</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+}</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+document.addEventListener(&quot;dialogaccept&quot;, function(event) {</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+  if (!onAccept())</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+    event.preventDefault(); // Prevent the dialog closing.</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+});</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+document.addEventListener(&quot;dialogextra1&quot;, function(event) {</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+  newRecipientRule();</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeySelection.xul</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,129 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+&lt;!--</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+--&gt;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://openpgp/skin/enigmail.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+%brandDTD;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+&lt;!ENTITY % enigMailDTD SYSTEM &quot;chrome://openpgp/content/strings/enigmail.dtd&quot; &gt;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+%enigMailDTD;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+]&gt;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+&lt;dialog id=&quot;enigmailKeySelectionDlg&quot;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        title=&quot;&amp;enigmail.userSelectionList.label;&quot;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+        xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+        onload=&quot;onLoad();&quot;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+        buttons=&quot;accept,cancel,extra1&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        buttonlabelaccept=&quot;&amp;enigmail.send.label;&quot;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+        buttonlabelextra1=&quot;&amp;enigmail.perRecipientsOption.label;&quot;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        minheight=&quot;450&quot;&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/enigmailCommon.js&quot;/&gt;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/enigmailKeySelection.js&quot;/&gt;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  &lt;vbox class=&quot;enigmailCaptionbox&quot; id=&quot;dialogHeadline&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+     &lt;html:h1 id=&quot;usersNotFoundCapt&quot;&gt;&lt;html:span&gt;&amp;enigmail.usersNotFound.label;&lt;/html:span&gt;&lt;/html:h1&gt;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+     &lt;vbox style=&quot;height: 5em; overflow: auto;&quot;&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+       &lt;grid id=&quot;dialogMsgList&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+         &lt;columns&gt;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+          &lt;column/&gt;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+          &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+        &lt;/columns&gt;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+        &lt;rows id=&quot;dialogMsgListRows&quot;/&gt;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+       &lt;/grid&gt;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+     &lt;/vbox&gt;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+     &lt;description id=&quot;dialogHeaderDesc&quot; width=&quot;700px&quot; collapsed=&quot;true&quot;&gt;...&lt;/description&gt;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  &lt;!-- &lt;separator/&gt; --&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    &lt;vbox class=&quot;enigmailCaptionbox&quot; width=&quot;700px&quot; flex=&quot;1&quot; id=&quot;dialogHeaderBox&quot;&gt;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+      &lt;html:h1 &gt;&lt;html:span id=&quot;dialogHeader&quot; style=&quot;visibility: hidden;&quot;&gt;...&lt;/html:span&gt;&lt;/html:h1&gt;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      &lt;hbox flex=&quot;0&quot; align=&quot;center&quot;&gt;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+        &lt;textbox id=&quot;filterKey&quot; size=&quot;35&quot; placeholder=&quot;&amp;enigmail.keyMan.filter.label;&quot;/&gt;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      &lt;tree  id=&quot;enigmailUserIdSelection&quot; flex=&quot;1&quot;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        hidecolumnpicker=&quot;false&quot;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        seltype=&quot;single&quot;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+        style=&quot;height:300px&quot;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+        onkeypress=&quot;userSelCallback(event)&quot;&gt;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+        &lt;!-- onclick=&quot;userSelCallback(event);&quot; --&gt;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+        &lt;treecols&gt;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+          &lt;treecol id=&quot;selectionCol&quot; style=&quot;width:19px&quot;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+                   label=&quot;&amp;enigmail.keySelection.label;&quot;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+                   class=&quot;treecol-image&quot;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+                   src=&quot;chrome://openpgp/content/ui/check1.png&quot;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+                   ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+                   persist=&quot;width&quot;/&gt;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+          &lt;treecol id=&quot;enigUserNameCol&quot; primary=&quot;true&quot;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+                   flex=&quot;1&quot;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+                   ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+                   label=&quot;&amp;enigmail.keyUserId.label;&quot;/&gt;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+          &lt;treecol id=&quot;uidValidityCol&quot; style=&quot;width:85px&quot;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+                   label=&quot;&amp;enigmail.uidValidity.label;&quot;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+                   persist=&quot;width,hidden&quot;/&gt;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+          &lt;treecol id=&quot;expCol&quot; style=&quot;width:70px&quot;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+                   label=&quot;&amp;enigmail.keyExpiry.label;&quot;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+                   persist=&quot;width,hidden&quot;/&gt;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+          &lt;treecol id=&quot;keyCol&quot; style=&quot;width:90px&quot;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+                   label=&quot;&amp;enigmail.keyId.label;&quot;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+                   persist=&quot;width,hidden&quot;/&gt;</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+        &lt;/treecols&gt;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        &lt;treechildren id=&quot;enigmailUserIdSelectionChildren&quot;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+              properties=&quot;sendUnencrypted&quot;/&gt;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+      &lt;/tree&gt;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    &lt;checkbox id=&quot;enigmailUserSelSendEncrypted&quot;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+              label=&quot;&amp;enigmail.userSelSendEncrypted.label;&quot;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+              accesskey=&quot;&amp;enigmail.userSelSendEncrypted.accesskey;&quot;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+              checked=&quot;true&quot;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+              oncommand=&quot;switchSendEncryptedCallback();&quot;/&gt;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    &lt;checkbox id=&quot;enigmailUserSelSendSigned&quot;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+              label=&quot;&amp;enigmail.userSelSendSigned.label;&quot;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+              accesskey=&quot;&amp;enigmail.userSelSendSigned.accesskey;&quot;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+              checked=&quot;true&quot;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+              oncommand=&quot;switchSendSignedCallback();&quot;/&gt;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    &lt;checkbox id=&quot;displayNoLonger&quot;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+              label=&quot;&amp;enigmail.displayNoLonger.label;&quot;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+              checked=&quot;false&quot;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+              disabled=&quot;true&quot;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+              collapsed=&quot;true&quot;/&gt;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  &lt;hbox&gt;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    &lt;button class=&quot;dialog&quot;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+            id=&quot;refreshKeys&quot;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+            label=&quot;&amp;enigmail.refreshKeys.label;&quot;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+            accesskey=&quot;&amp;enigmail.refreshKeys.accesskey;&quot;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+            oncommand=&quot;refreshKeys();&quot;/&gt;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    &lt;button class=&quot;dialog&quot;</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+            halign=&quot;right&quot;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+            id=&quot;importMissingKeys&quot;</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+            collapsed=&quot;true&quot;</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+            label=&quot;&amp;enigmail.importMissingKeys.label;&quot;</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+            accesskey=&quot;&amp;enigmail.importMissingKeys.accesskey;&quot;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+            tooltip=&quot;&amp;enigmail.importMissingKeys.tooltip;&quot;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+            oncommand=&quot;searchMissingKeys();&quot;/&gt;</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,154 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/*</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+/**</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * helper functions for message composition</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ */</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+var EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+var EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+var EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+var EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+var EnigmailTrust = ChromeUtils.import(&quot;chrome://openpgp/content/modules/trust.jsm&quot;).EnigmailTrust;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+if (!Enigmail) var Enigmail = {};</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+Enigmail.hlp = {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  /* try to find valid key to passed email addresses (or keys)</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   * @return: list of all found key (with leading &quot;0x&quot;) or null</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   *          details in details parameter</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   */</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  validKeysForAllRecipients: function(emailsOrKeys, details) {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+    EnigmailLog.DEBUG(&quot;=====&gt; validKeysForAllRecipients()\n&quot;);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: validKeysForAllRecipients(): emailsOrKeys='&quot; + emailsOrKeys + &quot;'\n&quot;);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    // use helper to see when we enter and leave this function</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    let resultingArray = this.doValidKeysForAllRecipients(emailsOrKeys, details);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: validKeysForAllRecipients(): return '&quot; + resultingArray + &quot;'\n&quot;);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    EnigmailLog.DEBUG(&quot;  &lt;=== validKeysForAllRecipients()\n&quot;);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    return resultingArray;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  },</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  // helper for validKeysForAllRecipients()</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  doValidKeysForAllRecipients: function(emailsOrKeys, details) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): emailsOrKeys='&quot; + emailsOrKeys + &quot;'\n&quot;);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    // check which keys are accepted</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    let minTrustLevel;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    let acceptedKeys = EnigmailPrefs.getPref(&quot;acceptedKeys&quot;);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+    switch (acceptedKeys) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      case 0: // accept valid/authenticated keys only</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+        minTrustLevel = &quot;f&quot;; // first value for trusted keys</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        break;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      case 1: // accept all but revoked/disabled/expired keys</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+        minTrustLevel = &quot;?&quot;; // value between invalid and unknown keys</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+        break;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      default:</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: doValidKeysForAllRecipients(): return null (INVALID VALUE for acceptedKeys: \&quot;&quot; + acceptedKeys + &quot;\&quot;)\n&quot;);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+        return null;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+    }</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): find keys with minTrustLevel=\&quot;&quot; + minTrustLevel + &quot;\&quot;\n&quot;);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    let keyMissing;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    let resultingArray = []; // resulting key list (if all valid)</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+    try {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+      // create array of address elements (email or key)</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+      let addresses = [];</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      try {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+        addresses = EnigmailFuncs.stripEmail(emailsOrKeys).split(',');</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      // resolve GnuPG groups</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+      let gpgGroups = EnigmailGpg.getGpgGroups();</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+      for (let i = 0; i &lt; addresses.length; i++) {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+        let addr = addresses[i].toLowerCase();</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        for (let j = 0; j &lt; gpgGroups.length; j++) {</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+          if (addr == gpgGroups[j].alias.toLowerCase() ||</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+            &quot;&lt;&quot; + addr + &quot;&gt;&quot; == gpgGroups[j].alias.toLowerCase()) {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+            // replace address with keylist</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+            let grpList = gpgGroups[j].keylist.split(/;/);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+            addresses[i] = grpList[0];</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+            for (let k = 1; k &lt; grpList.length; k++) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+              addresses.push(grpList[k]);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+            }</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+          }</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+        }</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+      }</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+      // resolve all the email addresses if possible:</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+      keyMissing = EnigmailKeyRing.getValidKeysForAllRecipients(addresses, minTrustLevel, details, resultingArray);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    } catch (ex) {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return null (exception: &quot; + ex.message + &quot;\n&quot; + ex.stack + &quot;)\n&quot;);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      return null;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    }</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    if (keyMissing) {</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return null (key missing)\n&quot;);</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+      return null;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    }</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return \&quot;&quot; + resultingArray + &quot;\&quot;\n&quot;);</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    return resultingArray;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  },</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  /**</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   * processConflicts</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   * - handle sign/encrypt/pgpMime conflicts if any</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   * - NOTE: conflicts result into disabling the feature (0/never)</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+   * Input parameters:</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+   *  @encrypt: email would currently get encrypted</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+   *  @sign:    email would currently get signed</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+   * @return:  false if error occurred or processing was canceled</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+   */</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  processConflicts: function(encrypt, sign) {</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+    // process message about whether we still sign/encrypt</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    let msg = &quot;&quot;;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+    msg += &quot;\n- &quot; + EnigmailLocale.getString(encrypt ? &quot;encryptYes&quot; : &quot;encryptNo&quot;);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    msg += &quot;\n- &quot; + EnigmailLocale.getString(sign ? &quot;signYes&quot; : &quot;signNo&quot;);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;warnOnRulesConflict&quot;) == 2) {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+      EnigmailPrefs.setPref(&quot;warnOnRulesConflict&quot;, 0);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    }</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    if (!EnigmailDialog.confirmPref(window, EnigmailLocale.getString(&quot;rulesConflict&quot;, [msg]), &quot;warnOnRulesConflict&quot;)) {</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+      return false;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+    }</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+    return true;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  },</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  /**</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+   * determine invalid recipients as returned from GnuPG</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+   *</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+   * @gpgMsg: output from GnuPG</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+   *</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+   * @return: space separated list of invalid addresses</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+   */</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+  getInvalidAddress: function(gpgMsg) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeHelper.js: getInvalidAddress(): gpgMsg=\&quot;&quot; + gpgMsg + &quot;\&quot;\n\n&quot;);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    var invalidAddr = [];</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+    var lines = gpgMsg.split(/[\n\r]+/);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+    for (var i = 0; i &lt; lines.length; i++) {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+      var m = lines[i].match(/^(INV_RECP \d+ )(.*)$/);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      if (m &amp;&amp; m.length == 3) {</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+        try {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+          invalidAddr.push(EnigmailFuncs.stripEmail(m[2].toLowerCase()));</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+      }</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+    }</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+    return invalidAddr.join(&quot; &quot;);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  }</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,5372 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/*global EnigmailLocale: false, EnigmailApp: false, Dialog: false, EnigmailTimer: false */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/*</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ */</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+/*globally available Thunderbird variables/object/functions: */</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+/*global gMsgCompose: false, getCurrentIdentity: false, gNotification: false */</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+/*global UpdateAttachmentBucket: false, gContentChanged: true */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+/*global AddAttachments: false, AddAttachment: false, ChangeAttachmentBucketVisibility: false, GetResourceFromUri: false */</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+/*global Recipients2CompFields: false, Attachments2CompFields: false, DetermineConvertibility: false, gWindowLocked: false */</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+/*global CommandUpdate_MsgCompose: false, gSMFields: false, setSecuritySettings: false, getCurrentAccountKey: false */</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+/*global Sendlater3Composing: false, MailServices: false */</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+var EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+var EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+var EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+var EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+var EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+var EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+var EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+var EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+var EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+var EnigmailDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/decryption.jsm&quot;).EnigmailDecryption;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+var EnigmailEncryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/encryption.jsm&quot;).EnigmailEncryption;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+var EnigmailRules = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rules.jsm&quot;).EnigmailRules;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+var EnigmailClipboard = ChromeUtils.import(&quot;chrome://openpgp/content/modules/clipboard.jsm&quot;).EnigmailClipboard;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+var EnigmailWkdLookup = ChromeUtils.import(&quot;chrome://openpgp/content/modules/wkdLookup.jsm&quot;).EnigmailWkdLookup;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+var EnigmailMsgRead = ChromeUtils.import(&quot;chrome://openpgp/content/modules/msgRead.jsm&quot;).EnigmailMsgRead;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+var EnigmailMimeEncrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeEncrypt.jsm&quot;).EnigmailMimeEncrypt;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+var jsmime = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;).jsmime;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+if (!Enigmail) var Enigmail = {};</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+const IOSERVICE_CONTRACTID = &quot;@mozilla.org/network/io-service;1&quot;;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+const LOCAL_FILE_CONTRACTID = &quot;@mozilla.org/file/local;1&quot;;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+Enigmail.msg = {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  editor: null,</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  dirty: null,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  processed: null,</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  timeoutId: null,</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  sendPgpMime: false,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  sendMode: null, // the current default for sending a message (0, SIGN, ENCRYPT, or SIGN|ENCRYPT)</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  sendModeDirty: false, // send mode or final send options changed?</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  // processed reasons for encryption:</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  reasonEncrypted: &quot;&quot;,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  reasonSigned: &quot;&quot;,</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  // encrypt/sign/pgpmime according to rules?</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  // (1:ENIG_UNDEF(undef/maybe), 0:ENIG_NEVER(never/forceNo), 2:ENIG_ALWAYS(always/forceYes),</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  //  22:ENIG_AUTO_ALWAYS, 99:ENIG_CONFLICT(conflict))</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  encryptByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  signByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  pgpmimeByRules: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  // forced to encrypt/sign/pgpmime?</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  // (1:ENIG_UNDEF(undef/maybe), 0:ENIG_NEVER(never/forceNo), 2:ENIG_ALWAYS(always/forceYes))</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  encryptForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  signForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  pgpmimeForced: EnigmailConstants.ENIG_UNDEF,</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  finalSignDependsOnEncrypt: false, // does signing finally depends on encryption mode?</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  // resulting final encrypt/sign/pgpmime mode:</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  //  (-1:ENIG_FINAL_UNDEF, 0:ENIG_FINAL_NO, 1:ENIG_FINAL_YES, 10:ENIG_FINAL_FORCENO, 11:ENIG_FINAL_FORCEYES, 99:ENIG_FINAL_CONFLICT)</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  statusEncrypted: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  statusSigned: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  statusPGPMime: EnigmailConstants.ENIG_FINAL_UNDEF,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  statusEncryptedInStatusBar: null, // last statusEncyrpted when processing status buttons</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  // to find possible broken promise of encryption</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  // is OpenPGP encryption possible without displaying the key selection dialog?</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  autoPgpEncryption: false,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  // processed strings to signal final encrypt/sign/pgpmime state:</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  statusEncryptedStr: &quot;???&quot;,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  statusSignedStr: &quot;???&quot;,</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  statusPGPMimeStr: &quot;???&quot;,</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  statusSMimeStr: &quot;???&quot;,</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  statusInlinePGPStr: &quot;???&quot;,</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  statusAttachOwnKey: &quot;???&quot;,</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  sendProcess: false,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  composeBodyReady: false,</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  identity: null,</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  enableRules: null,</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  modifiedAttach: null,</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  lastFocusedWindow: null,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  determineSendFlagId: null,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  trustAllKeys: false,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  protectHeaders: false,</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  draftSubjectEncrypted: false,</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  attachOwnKeyObj: {</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    appendAttachment: false,</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    attachedObj: null,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    attachedKey: null</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  },</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  keyLookupDone: [],</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  saveDraftError: 0,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  addrOnChangeTimeout: 250,</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  /* timeout when entering something into the address field */</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  composeStartup: function() {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.composeStartup\n&quot;);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+    function loadOverlay(targetWindow, srcUrl) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+      let {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+        Overlays</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+      } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/overlays.jsm&quot;, {});</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+      Overlays.loadOverlays(&quot;Enigmail&quot;, targetWindow, [srcUrl]);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+    }</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    function addSecurityListener(itemId, func) {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+      let s = document.getElementById(itemId);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+      if (s) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+        s.addEventListener(&quot;command&quot;, func.bind(Enigmail.msg), false);</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+      }</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+      else {</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: addSecurityListener - cannot find element &quot; + itemId + &quot;\n&quot;);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+      }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+    }</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+    // manually load overlay for contacts sidebar</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    // wait 2 seconds because loading of the sidebar is slightly delayed</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    let sb = document.getElementById(&quot;sidebar&quot;);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+    if (sb) {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay: contentDocument=&quot; + sb.contentDocument + &quot;\n&quot;);</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+      EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+        loadOverlay(sb.contentDocument.defaultView, &quot;chrome://openpgp/content/ui/enigmailAbContactsPanel.xul&quot;);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+      }, 2000);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    }</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+    let customizeToolbar = document.getElementById(&quot;customizeToolbarSheetIFrame&quot;);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+    customizeToolbar.addEventListener(&quot;pageshow&quot;, function(event) {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+      loadOverlay(event.target.defaultView, &quot;chrome://openpgp/content/ui/enigmailCustToolOverlay.xul&quot;);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+    }, false);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+    gMsgCompose.RegisterStateListener(Enigmail.composeStateListener);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+    Enigmail.msg.composeBodyReady = false;</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    // Relabel SMIME button and menu item</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+    var smimeButton = document.getElementById(&quot;button-security&quot;);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    let toolbar = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+    if (smimeButton) {</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+      smimeButton.setAttribute(&quot;label&quot;, &quot;S/MIME&quot;);</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+      if (toolbar &amp;&amp; toolbar.getAttribute(&quot;currentset&quot;).length === 0) {</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+        // remove S/MIME button if the toolbar is displaying the default set</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+        toolbar.removeChild(smimeButton);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+      }</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+    }</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+    var msgId = document.getElementById(&quot;msgIdentityPopup&quot;);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    if (msgId) {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+      msgId.addEventListener(&quot;command&quot;, Enigmail.msg.setIdentityCallback, false);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    }</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    var subj = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    subj.addEventListener('focus', Enigmail.msg.fireSendFlags, false);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+    // listen to S/MIME changes to potentially display &quot;conflict&quot; message</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+    addSecurityListener(&quot;menu_securitySign1&quot;, this.toggleSMimeSign);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    addSecurityListener(&quot;menu_securitySign2&quot;, this.toggleSmimeToolbar);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+    addSecurityListener(&quot;menu_securityEncryptRequire1&quot;, this.toggleSMimeEncrypt);</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+    addSecurityListener(&quot;menu_securityEncryptRequire2&quot;, this.toggleSmimeToolbar);</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+    let numCerts = EnigmailFuncs.getNumOfX509Certs();</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+    this.addrOnChangeTimeout = Math.max((numCerts - 250) * 2, 250);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+    EnigmailLog.DEBUG(`enigmailMsgComposeOverlay.js: composeStartup: numCerts=${numCerts}; setting timeout to ${this.addrOnChangeTimeout}\n`);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+    this.msgComposeReset(false); // false =&gt; not closing =&gt; call setIdentityDefaults()</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+    this.composeOpen();</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+    this.initialSendFlags();</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  },</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+  delayedProcessFinalState: function() {</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+    EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+        Enigmail.msg.processFinalState();</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+        Enigmail.msg.updateStatusBar();</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+      },</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+      100);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+  },</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  toggleSmimeToolbar: function(event) {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSmimeToolbar\n&quot;);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    /* global toggleSignMessage: false, toggleEncryptMessage: false */</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    switch (event.target.id) {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+      case &quot;menu_securitySign2&quot;:</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+        toggleSignMessage();</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+        this.toggleSMimeSign();</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+        break;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+      case &quot;menu_securityEncryptRequire2&quot;:</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+        toggleEncryptMessage();</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+        this.toggleSMimeEncrypt();</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+    }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+  },</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  toggleSMimeEncrypt: function() {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSMimeEncrypt\n&quot;);</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+    if (gSMFields &amp;&amp; gSMFields.requireEncryptMessage) {</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+      this.encryptForced = EnigmailConstants.ENIG_ALWAYS;</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+      this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+    }</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+    else {</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+      //this.encryptForced = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+      this.setFinalSendMode('final-encryptNo');</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+      if (!gSMFields.signMessage)</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+        this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    }</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    this.delayedProcessFinalState();</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+  },</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+  toggleSMimeSign: function() {</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleSMimeSign\n&quot;);</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+    if (gSMFields &amp;&amp; gSMFields.signMessage) {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+      this.signForced = EnigmailConstants.ENIG_ALWAYS;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+      this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+    }</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+    else {</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+      this.setFinalSendMode('final-signNo');</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+      if (!gSMFields.requireEncryptMessage)</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+        this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+    }</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+    this.delayedProcessFinalState();</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  },</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+  handleClick: function(event, modifyType) {</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.handleClick\n&quot;);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+    switch (event.button) {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+      case 2:</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+        // do not process the event any futher</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+        // needed on Windows to prevent displaying the context menu</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+        event.preventDefault();</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+        this.doPgpButton();</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+        break;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+      case 0:</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+        this.doPgpButton(modifyType);</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+        break;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+    }</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+  },</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+  setIdentityCallback: function(elementId) {</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setIdentityCallback: elementId=&quot; + elementId + &quot;\n&quot;);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+    EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+        Enigmail.msg.setIdentityDefaults();</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+      },</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+      100);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+  },</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+  /* return whether the account specific setting key is enabled or disabled</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+   */</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  getAccDefault: function(key) {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault: identity=&quot;+this.identity.key+&quot;(&quot;+this.identity.email+&quot;) key=&quot;+key+&quot;\n&quot;);</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+    let res = null;</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    let mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    let isSmimeEnabled = this.isSmimeEnabled();</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+    let isEnigmailEnabled = this.isEnigmailEnabled();</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+    let preferSmimeByDefault = false;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+    if (isSmimeEnabled &amp;&amp; isEnigmailEnabled) {</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+      if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+        preferSmimeByDefault = true;</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+      }</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+      else if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_ALWAYS) {</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+        preferSmimeByDefault = true;</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+      }</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+      else {</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+        preferSmimeByDefault = (mimePreferOpenPGP === 0);</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+      }</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+    }</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+    if (isEnigmailEnabled) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+      switch (key) {</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+        case 'sign':</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+          if (preferSmimeByDefault) {</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+            res = (this.identity.getBoolAttribute(&quot;sign_mail&quot;));</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+          }</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+          else {</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+            res = (this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0);</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+          }</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+          break;</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+        case 'encrypt':</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+          if (preferSmimeByDefault) {</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+            res = (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0);</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+          }</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+          else {</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+            res = (this.identity.getIntAttribute(&quot;defaultEncryptionPolicy&quot;) &gt; 0);</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+          }</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+          break;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+        case 'sign-pgp':</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+          res = (this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0);</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+          break;</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+        case 'pgpMimeMode':</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+          res = this.identity.getBoolAttribute(key);</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+          break;</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+        case 'signIfNotEnc':</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+          res = this.identity.getBoolAttribute(&quot;pgpSignPlain&quot;);</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+          break;</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+        case 'signIfEnc':</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+          res = this.identity.getBoolAttribute(&quot;pgpSignEncrypted&quot;);</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+          break;</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+        case 'attachPgpKey':</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+          res = this.identity.getBoolAttribute(key);</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+          break;</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+      }</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+      //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault:   &quot;+key+&quot;=&quot;+res+&quot;\n&quot;);</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+      return res;</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+    }</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+    else if (this.isSmimeEnabled()) {</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+      switch (key) {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+        case 'sign':</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+          res = this.identity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+          break;</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+        case 'encrypt':</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+          res = (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0);</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+          break;</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+        default:</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+          res = false;</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+      }</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+      return res;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+    }</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    else {</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+      // every detail is disabled if OpenPGP in general is disabled:</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+      switch (key) {</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+        case 'sign':</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+        case 'encrypt':</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+        case 'signIfNotEnc':</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+        case 'signIfEnc':</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+        case 'pgpMimeMode':</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+        case 'attachPgpKey':</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+        case 'sign-pgp':</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+          return false;</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+      }</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+    }</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    // should not be reached</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getAccDefault:   internal error: invalid key '&quot; + key + &quot;'\n&quot;);</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+    return null;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+  },</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+  /**</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+   * Determine if any of Enigmail (OpenPGP) or S/MIME encryption is enabled for the account</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+   */</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+  getEncryptionEnabled: function() {</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+    let id = getCurrentIdentity();</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+    return ((id.getUnicharAttribute(&quot;encryption_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+      this.isEnigmailEnabled());</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+  },</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+  isSmimeEnabled: function() {</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+    let id = getCurrentIdentity();</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+    return ((id.getUnicharAttribute(&quot;signing_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+      (id.getUnicharAttribute(&quot;encryption_cert_name&quot;) !== &quot;&quot;));</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+  },</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+  /**</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+   * Determine if any of Enigmail (OpenPGP) or S/MIME signing is enabled for the account</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+   */</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+  getSigningEnabled: function() {</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+    let id = getCurrentIdentity();</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+    return ((id.getUnicharAttribute(&quot;signing_cert_name&quot;) !== &quot;&quot;) ||</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+      this.isEnigmailEnabled());</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+  },</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+  getSmimeSigningEnabled: function() {</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+    let id = getCurrentIdentity();</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+    if (!id.getUnicharAttribute(&quot;signing_cert_name&quot;)) return false;</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+    return id.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+  },</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+  setIdentityDefaults: function() {</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setIdentityDefaults\n&quot;);</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+    this.identity = getCurrentIdentity();</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+    if (!this.isEnigmailEnabled()) {</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+      // reset status strings in menu to useful defaults</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+      this.statusEncryptedStr = EnigmailLocale.getString(&quot;encryptNo&quot;);</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+      this.statusSignedStr = EnigmailLocale.getString(&quot;signNo&quot;, [&quot;&quot;]);</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+      this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+      this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+      this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+      this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyNo&quot;);</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+    }</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+    // reset default send settings, unless we have changed them already</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+    if (!this.sendModeDirty) {</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+      this.mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+      this.processAccountSpecificDefaultOptions();</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+      this.determineSendFlags(); // important to use identity specific settings</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+      this.processFinalState();</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+      this.updateStatusBar();</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+    }</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+  },</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+  // set the current default for sending a message</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+  // depending on the identity</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+  processAccountSpecificDefaultOptions: function() {</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processAccountSpecificDefaultOptions\n&quot;);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+    this.sendMode = 0;</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+    if (this.getSmimeSigningEnabled()) {</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+      this.sendMode |= SIGN;</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+      this.reasonSigned = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+    }</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+    if (!this.isEnigmailEnabled()) {</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+      return;</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+    }</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+    if (this.getAccDefault(&quot;encrypt&quot;)) {</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+      this.sendMode |= ENCRYPT;</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+      this.reasonEncrypted = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+    }</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+    if (this.getAccDefault(&quot;sign&quot;)) {</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+      this.sendMode |= SIGN;</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+      this.reasonSigned = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    }</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+    this.sendPgpMime = this.getAccDefault(&quot;pgpMimeMode&quot;);</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+    this.attachOwnKeyObj.appendAttachment = this.getAccDefault(&quot;attachPgpKey&quot;);</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+    this.setOwnKeyStatus();</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+    this.attachOwnKeyObj.attachedObj = null;</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+    this.attachOwnKeyObj.attachedKey = null;</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+    this.finalSignDependsOnEncrypt = (this.getAccDefault(&quot;signIfEnc&quot;) || this.getAccDefault(&quot;signIfNotEnc&quot;));</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+  },</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+  getOriginalMsgUri: function() {</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+    let draftId = gMsgCompose.compFields.draftId;</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+    let msgUri = null;</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+    if (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0) {</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+      // original message is draft</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+      msgUri = draftId.replace(/\?.*$/, &quot;&quot;);</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+    }</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+    else if (typeof(gMsgCompose.originalMsgURI) == &quot;string&quot; &amp;&amp; gMsgCompose.originalMsgURI.length &gt; 0) {</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+      // original message is a &quot;true&quot; mail</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+      msgUri = gMsgCompose.originalMsgURI;</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+    }</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+    return msgUri;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+  },</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+  getMsgHdr: function(msgUri) {</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+    if (!msgUri) {</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+      msgUri = this.getOriginalMsgUri();</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+    }</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+    if (msgUri) {</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+      let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;].getService(Components.interfaces.nsIMessenger);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+      return messenger.messageServiceFromURI(msgUri).messageURIToMsgHdr(msgUri);</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+    }</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+    else return null;</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+  },</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineplus">+</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineplus">+  getMsgProperties: function(draft) {</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Enigmail.msg.getMsgProperties:\n&quot;);</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+    let msgUri = this.getOriginalMsgUri();</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+    let self = this;</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+    let properties = 0;</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+    try {</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+      let msgHdr = this.getMsgHdr(msgUri);</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineplus">+      if (msgHdr) {</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineplus">+        let msgUrl = EnigmailMsgRead.getUrlFromUriSpec(msgUri);</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineplus">+        properties = msgHdr.getUint32Property(&quot;enigmail&quot;);</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineplus">+        try {</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineplus">+          EnigmailMime.getMimeTreeFromUrl(msgUrl.spec, false, function _cb(mimeMsg) {</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+            if (draft) {</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineplus">+              self.setDraftOptions(mimeMsg);</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineplus">+              if (self.draftSubjectEncrypted) self.setOriginalSubject(msgHdr.subject, false);</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineplus">+            }</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+            else {</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineplus">+              if (EnigmailURIs.isEncryptedUri(msgUri)) self.setOriginalSubject(msgHdr.subject, false);</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineplus">+            }</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineplus">+          });</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineplus">+        }</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+        catch (ex) {</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Enigmail.msg.getMsgProperties: excetion in getMimeTreeFromUrl\n&quot;);</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineplus">+        }</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineplus">+      }</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineplus">+    }</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Enigmail.msg.getMsgProperties: got exception '&quot; + ex.toString() + &quot;'\n&quot;);</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineplus">+    }</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineplus">+</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineplus">+    if (EnigmailURIs.isEncryptedUri(msgUri)) {</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+      properties |= EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+    }</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+    return properties;</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineplus">+  },</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineplus">+</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineplus">+  setDraftOptions: function(mimeMsg) {</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setDraftOptions\n&quot;);</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineplus">+</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+    var stat = &quot;&quot;;</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineplus">+    if (mimeMsg &amp;&amp; mimeMsg.headers.has(&quot;x-enigmail-draft-status&quot;)) {</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+      stat = String(mimeMsg.headers.get(&quot;x-enigmail-draft-status&quot;).join(&quot;&quot;));</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+    }</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+    else {</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineplus">+      return;</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineplus">+    }</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setDraftOptions: draftStatus: &quot; + stat + &quot;\n&quot;);</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineplus">+    if (stat.substr(0, 1) == &quot;N&quot;) {</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineplus">+      // new style drafts (Enigmail 1.7)</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineplus">+</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineplus">+      var enc = &quot;final-encryptDefault&quot;;</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineplus">+      switch (Number(stat.substr(1, 1))) {</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineplus">+        case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineplus">+          enc = &quot;final-encryptNo&quot;;</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineplus">+          break;</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineplus">+        case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineplus">+          enc = &quot;final-encryptYes&quot;;</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineplus">+      }</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineplus">+</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineplus">+      var sig = &quot;final-signDefault&quot;;</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineplus">+      switch (Number(stat.substr(2, 1))) {</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineplus">+        case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineplus">+          sig = &quot;final-signNo&quot;;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineplus">+          break;</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+        case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+          sig = &quot;final-signYes&quot;;</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineplus">+      }</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineplus">+</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineplus">+      var pgpMime = &quot;final-pgpmimeDefault&quot;;</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+      switch (Number(stat.substr(3, 1))) {</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineplus">+        case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineplus">+          pgpMime = &quot;final-pgpmimeNo&quot;;</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineplus">+          break;</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineplus">+        case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineplus">+          pgpMime = &quot;final-pgpmimeYes&quot;;</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineplus">+      }</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineplus">+</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineplus">+      Enigmail.msg.setFinalSendMode(enc);</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineplus">+      Enigmail.msg.setFinalSendMode(sig);</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineplus">+      Enigmail.msg.setFinalSendMode(pgpMime);</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineplus">+</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineplus">+      if (stat.substr(4, 1) == &quot;1&quot;)</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineplus">+        Enigmail.msg.attachOwnKeyObj.appendAttachment = true;</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineplus">+      if (stat.substr(5, 1) == &quot;1&quot;)</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineplus">+        Enigmail.msg.draftSubjectEncrypted = true;</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineplus">+    }</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineplus">+    else {</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineplus">+      // drafts from older versions of Enigmail</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+      var flags = Number(stat);</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineplus">+      if (flags &amp; EnigmailConstants.SEND_SIGNED) Enigmail.msg.setFinalSendMode('final-signYes');</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineplus">+      if (flags &amp; EnigmailConstants.SEND_ENCRYPTED) Enigmail.msg.setFinalSendMode('final-encryptYes');</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineplus">+      if (flags &amp; EnigmailConstants.SEND_ATTACHMENT)</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineplus">+        Enigmail.msg.attachOwnKeyObj.appendAttachment = true;</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineplus">+    }</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineplus">+    Enigmail.msg.setOwnKeyStatus();</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineplus">+  },</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineplus">+  setOriginalSubject: function(subject, forceSetting) {</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineplus">+    const CT = Components.interfaces.nsIMsgCompType;</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineplus">+    let subjElem = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineplus">+    let prefix = &quot;&quot;;</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineplus">+</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineplus">+    if (!subjElem) return;</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineplus">+</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineplus">+    switch (gMsgCompose.type) {</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+      case CT.ForwardInline:</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+      case CT.ForwardAsAttachment:</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineplus">+        prefix = this.getMailPref(&quot;mail.forward_subject_prefix&quot;) + &quot;: &quot;;</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineplus">+        break;</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+      case CT.Reply:</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineplus">+      case CT.ReplyAll:</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineplus">+      case CT.ReplyToSender:</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineplus">+      case CT.ReplyToGroup:</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+      case CT.ReplyToSenderAndGroup:</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+      case CT.ReplyToList:</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+        if (!subject.startsWith(&quot;Re: &quot;))</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+          prefix = &quot;Re: &quot;;</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+    }</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineplus">+</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineplus">+    let doSetSubject = forceSetting;</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineplus">+    switch (gMsgCompose.type) {</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineplus">+      case CT.Draft:</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineplus">+      case CT.Template:</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineplus">+      case CT.EditTemplate:</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineplus">+      case CT.ForwardInline:</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineplus">+      case CT.ForwardAsAttachment:</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineplus">+      case CT.EditAsNew:</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineplus">+        doSetSubject = true;</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineplus">+        break;</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineplus">+    }</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineplus">+</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineplus">+    if (doSetSubject) {</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineplus">+      subject = EnigmailData.convertToUnicode(subject, &quot;UTF-8&quot;);</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+      subject = jsmime.headerparser.decodeRFC2047Words(subject, &quot;utf-8&quot;);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineplus">+</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineplus">+      if (subjElem.value == &quot;Re: &quot; + subject) return;</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineplus">+</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+      gMsgCompose.compFields.subject = prefix + subject;</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+      subjElem.value = prefix + subject;</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+      if (typeof subjElem.oninput === &quot;function&quot;) subjElem.oninput();</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+    }</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+  },</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+  setupMenuAndToolbar: function() {</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setupMenuAndToolbar\n&quot;);</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+    let toolbarTxt = document.getElementById(&quot;enigmail-toolbar-text&quot;);</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+    let encBroadcaster = document.getElementById(&quot;enigmail-bc-encrypt&quot;);</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+    let signBroadcaster = document.getElementById(&quot;enigmail-bc-sign&quot;);</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+    let attachBroadcaster = document.getElementById(&quot;enigmail-bc-attach&quot;);</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineplus">+    let enigmailMenu = document.getElementById(&quot;menu_Enigmail&quot;);</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineplus">+</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineplus">+    encBroadcaster.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineplus">+    signBroadcaster.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineplus">+    attachBroadcaster.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+    if (toolbarTxt) {</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+      toolbarTxt.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+    }</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+    enigmailMenu.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+  },</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+  composeOpen: function() {</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.composeOpen\n&quot;);</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+    var msgFlags;</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+    var msgUri = null;</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineplus">+    var msgIsDraft = false;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineplus">+</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineplus">+    this.setupMenuAndToolbar();</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineplus">+</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineplus">+    this.determineSendFlagId = null;</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineplus">+    this.disableSmime = false;</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineplus">+    this.saveDraftError = 0;</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineplus">+    this.protectHeaders = (EnigmailPrefs.getPref(&quot;protectedHeaders&quot;) === 2);</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineplus">+    this.enableUndoEncryption(false);</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineplus">+</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineplus">+    this.displayProtectHeadersStatus();</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineplus">+</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineplus">+    var toobarElem = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineplus">+    if (toobarElem &amp;&amp; (EnigmailOS.getOS() == &quot;Darwin&quot;)) {</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+      toobarElem.setAttribute(&quot;platform&quot;, &quot;macos&quot;);</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+    }</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+    // remove overlay_source from enigmail-bc-sendprocess, which will be inherited to</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+    // addressCol2 and addressCol1 (those would be removed if Enigmail is uninstalled)</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineplus">+    let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+    bc.removeAttribute(&quot;overlay_source&quot;);</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+    // check rules for status bar icons on each change of the recipients</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineplus">+    // Thunderbird</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineplus">+    var adrCol = document.getElementById(&quot;addressCol2#1&quot;); // recipients field</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineplus">+    if (adrCol) {</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineplus">+      let attr = adrCol.getAttribute(&quot;oninput&quot;);</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineplus">+      adrCol.setAttribute(&quot;oninput&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineplus">+      attr = adrCol.getAttribute(&quot;onchange&quot;);</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineplus">+      adrCol.setAttribute(&quot;onchange&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineplus">+      adrCol.setAttribute(&quot;observes&quot;, &quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineplus">+    }</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+    adrCol = document.getElementById(&quot;addressCol1#1&quot;); // to/cc/bcc/... field</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineplus">+    if (adrCol) {</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+      let attr = adrCol.getAttribute(&quot;oncommand&quot;);</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+      adrCol.setAttribute(&quot;oncommand&quot;, attr + &quot;; Enigmail.msg.addressOnChange();&quot;);</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+      adrCol.setAttribute(&quot;observes&quot;, &quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+    }</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineplus">+</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+    var draftId = gMsgCompose.compFields.draftId;</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineplus">+    let selectedElement = document.activeElement;</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineplus">+</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;) &amp;&amp; (!(this.sendMode &amp; ENCRYPT)) || (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0)) {</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineplus">+</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineplus">+      /* global gEncryptedURIService: false */</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineplus">+      if (gEncryptedURIService &amp;&amp; gEncryptedURIService.isEncrypted(gMsgCompose.originalMsgURI)) {</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineplus">+        // Enable S/MIME encryption if original is known as encrypted.</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineplus">+        this.setFinalSendMode('final-encryptYes');</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineplus">+      }</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineplus">+      msgUri = this.getOriginalMsgUri();</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineplus">+</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+      if (typeof(draftId) == &quot;string&quot; &amp;&amp; draftId.length &gt; 0) {</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineplus">+        // original message is draft</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+        msgIsDraft = true;</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+      }</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+      if (msgUri) {</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+        msgFlags = this.getMsgProperties(msgIsDraft);</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+        if (!msgIsDraft) {</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+          if (msgFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineplus">+            EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.composeOpen: has encrypted originalMsgUri\n&quot;);</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineplus">+            EnigmailLog.DEBUG(&quot;originalMsgURI=&quot; + gMsgCompose.originalMsgURI + &quot;\n&quot;);</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineplus">+            this.setFinalSendMode('final-encryptYes');</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineplus">+</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineplus">+            this.identity = getCurrentIdentity();</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineplus">+            if (this.identity.getBoolAttribute(&quot;pgpSignEncrypted&quot;)) {</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineplus">+              this.setFinalSendMode('final-signYes');</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineplus">+            }</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineplus">+</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineplus">+            this.disableSmime = true;</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineplus">+          }</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineplus">+          else if (msgFlags &amp; (EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineplus">+              EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineplus">+              EnigmailConstants.UNVERIFIED_SIGNATURE)) {</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineplus">+            this.setSendMode('sign');</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineplus">+          }</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineplus">+        }</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineplus">+        this.removeAttachedKey();</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineplus">+      }</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineplus">+    }</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineplus">+</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineplus">+    // check for attached signature files and remove them</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineplus">+    var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineplus">+    if (bucketList.hasChildNodes()) {</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineplus">+      var node = bucketList.firstChild;</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineplus">+      let nodeNumber = 0;</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineplus">+      while (node) {</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineplus">+        if (node.attachment.contentType == &quot;application/pgp-signature&quot;) {</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineplus">+          if (!this.findRelatedAttachment(bucketList, node)) {</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineplus">+            // Let's release the attachment object held by the node else it won't go away until the window is destroyed</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineplus">+            node.attachment = null;</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineplus">+            node = bucketList.removeChild(node);</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineplus">+          }</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+        }</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineplus">+        else {</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineplus">+          ++nodeNumber;</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineplus">+        }</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineplus">+      }</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineplus">+      if (!bucketList.hasChildNodes()) {</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineplus">+        try {</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineplus">+          // TB only</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+          UpdateAttachmentBucket(false);</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineplus">+        }</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineplus">+        catch (ex) {}</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineplus">+      }</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineplus">+    }</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineplus">+</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineplus">+    try {</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineplus">+      // TB only</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineplus">+      UpdateAttachmentBucket(bucketList.hasChildNodes());</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineplus">+    }</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineplus">+</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineplus">+    if (selectedElement) selectedElement.focus();</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineplus">+  },</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineplus">+</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineplus">+  // check if an signature is related to another attachment</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineplus">+  findRelatedAttachment: function(bucketList, node) {</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineplus">+</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineplus">+    // check if filename ends with .sig</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+    if (node.attachment.name.search(/\.sig$/i) &lt; 0) return null;</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineplus">+    var relatedNode = bucketList.firstChild;</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+    var findFile = node.attachment.name.toLowerCase();</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+    var baseAttachment = null;</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineplus">+    while (relatedNode) {</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineplus">+      if (relatedNode.attachment.name.toLowerCase() + &quot;.sig&quot; == findFile)</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineplus">+        baseAttachment = relatedNode.attachment;</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineplus">+      relatedNode = relatedNode.nextSibling;</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineplus">+    }</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineplus">+    return baseAttachment;</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineplus">+  },</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineplus">+</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineplus">+  initialSendFlags: function() {</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.initialSendFlags\n&quot;);</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineplus">+    this.fireSendFlags();</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineplus">+</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineplus">+    EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay: re-determine send flags\n&quot;);</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineplus">+      try {</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineplus">+        this.determineSendFlags();</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineplus">+        this.processFinalState();</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineplus">+        this.updateStatusBar();</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineplus">+      }</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineplus">+      catch (ex) {</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay: re-determine send flags - ERROR: &quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+      }</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+    }.bind(Enigmail.msg), 1500);</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineplus">+  },</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineplus">+</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineplus">+</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineplus">+  msgComposeClose: function() {</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeClose\n&quot;);</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineplus">+</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineplus">+    var ioServ;</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineplus">+    try {</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineplus">+      // we should delete the original temporary files of the encrypted or signed</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineplus">+      // inline PGP attachments (the rest is done automatically)</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineplus">+      if (this.modifiedAttach) {</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineplus">+        ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineplus">+        if (!ioServ)</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineplus">+          return;</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineplus">+</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineplus">+        for (var i in this.modifiedAttach) {</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+          if (this.modifiedAttach[i].origTemp) {</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+            EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeClose: deleting &quot; + this.modifiedAttach[i].origUrl + &quot;\n&quot;);</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineplus">+            var fileUri = ioServ.newURI(this.modifiedAttach[i].origUrl, null, null);</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineplus">+            var fileHandle = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineplus">+            fileHandle.initWithPath(fileUri.path);</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineplus">+            if (fileHandle.exists()) fileHandle.remove(false);</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineplus">+          }</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineplus">+        }</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineplus">+        this.modifiedAttach = null;</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineplus">+      }</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineplus">+    }</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineplus">+      EnigmailLog.ERROR(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeProcessDone: could not delete all files:\n&quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineplus">+    }</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineplus">+</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineplus">+    this.msgComposeReset(true); // true =&gt; closing =&gt; don't call setIdentityDefaults()</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineplus">+  },</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineplus">+</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+  msgComposeReset: function(closing) {</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.msgComposeReset\n&quot;);</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+    this.dirty = 0;</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineplus">+    this.processed = null;</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineplus">+    this.timeoutId = null;</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineplus">+</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineplus">+    this.modifiedAttach = null;</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineplus">+    this.sendMode = 0;</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineplus">+    this.sendModeDirty = false;</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineplus">+    this.reasonEncrypted = &quot;&quot;;</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineplus">+    this.reasonSigned = &quot;&quot;;</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineplus">+    this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineplus">+    this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineplus">+    this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineplus">+    this.signForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineplus">+    this.encryptForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineplus">+    this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineplus">+    this.finalSignDependsOnEncrypt = false;</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineplus">+    this.statusSigned = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineplus">+    this.statusEncrypted = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineplus">+    this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineplus">+    this.statusEncryptedStr = &quot;???&quot;;</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineplus">+    this.statusSignedStr = &quot;???&quot;;</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineplus">+    this.statusPGPMimeStr = &quot;???&quot;;</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineplus">+    this.statusInlinePGPStr = &quot;???&quot;;</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineplus">+    this.statusAttachOwnKey = &quot;???&quot;;</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineplus">+    this.enableRules = true;</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineplus">+    this.identity = null;</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineplus">+    this.sendProcess = false;</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineplus">+    this.trustAllKeys = false;</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineplus">+    this.mimePreferOpenPGP = 0;</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineplus">+    this.keyLookupDone = [];</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineplus">+</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineplus">+    if (!closing) {</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineplus">+      this.setIdentityDefaults();</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineplus">+    }</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineplus">+  },</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineplus">+</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineplus">+</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineplus">+  initRadioMenu: function(prefName, optionIds) {</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Enigmail.msg.initRadioMenu: &quot; + prefName + &quot;\n&quot;);</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineplus">+</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineplus">+    var encryptId;</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineplus">+</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineplus">+    var prefValue = EnigmailPrefs.getPref(prefName);</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineplus">+</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineplus">+    if (prefValue &gt;= optionIds.length)</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineplus">+      return;</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineplus">+</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineplus">+    var menuItem = document.getElementById(&quot;enigmail_&quot; + optionIds[prefValue]);</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineplus">+    if (menuItem)</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineplus">+      menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineplus">+  },</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineplus">+</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineplus">+</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineplus">+  tempTrustAllKeys: function() {</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineplus">+    this.trustAllKeys = !this.trustAllKeys;</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineplus">+  },</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineplus">+</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineplus">+  toggleAttachOwnKey: function() {</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleAttachOwnKey\n&quot;);</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineplus">+    EnigmailCore.getService(window); // make sure Enigmail is loaded and working</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineplus">+</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineplus">+    this.attachOwnKeyObj.appendAttachment = !this.attachOwnKeyObj.appendAttachment;</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineplus">+</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineplus">+    this.setOwnKeyStatus();</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineplus">+  },</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineplus">+</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineplus">+  toggleProtectHeaders: function() {</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleProtectHeaders\n&quot;);</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineplus">+    EnigmailCore.getService(window); // make sure Enigmail is loaded and working</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineplus">+</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineplus">+    this.protectHeaders = !this.protectHeaders;</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineplus">+</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineplus">+    this.displayProtectHeadersStatus();</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineplus">+  },</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineplus">+</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineplus">+  displayProtectHeadersStatus: function() {</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineplus">+    let bc = document.getElementById(&quot;enigmail-bc-protectHdr&quot;);</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineplus">+</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineplus">+    if (this.protectHeaders) {</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineplus">+      bc.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineplus">+      bc.setAttribute(&quot;tooltiptext&quot;, EnigmailLocale.getString(&quot;msgCompose.protectSubject.tooltip&quot;));</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineplus">+    }</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineplus">+    else {</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineplus">+      bc.removeAttribute(&quot;checked&quot;);</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineplus">+      bc.setAttribute(&quot;tooltiptext&quot;, EnigmailLocale.getString(&quot;msgCompose.noSubjectProtection.tooltip&quot;));</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineplus">+    }</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineplus">+  },</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineplus">+</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineplus">+  /***</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineplus">+   * set broadcaster to display whether the own key is attached or not</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineplus">+   */</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineplus">+</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineplus">+  setOwnKeyStatus: function() {</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineplus">+    let bc = document.getElementById(&quot;enigmail-bc-attach&quot;);</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineplus">+    let attachIcon = document.getElementById(&quot;button-enigmail-attach&quot;);</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineplus">+</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineplus">+    if (this.allowAttachOwnKey() === 0) {</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineplus">+      this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyDisabled&quot;);</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineplus">+    }</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineplus">+    else {</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineplus">+      if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineplus">+        bc.setAttribute(&quot;addPubkey&quot;, &quot;true&quot;);</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineplus">+        bc.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineplus">+        this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyYes&quot;);</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineplus">+      }</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineplus">+      else {</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineplus">+        bc.setAttribute(&quot;addPubkey&quot;, &quot;false&quot;);</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineplus">+        bc.removeAttribute(&quot;checked&quot;);</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineplus">+        this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyNo&quot;);</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineplus">+      }</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineplus">+    }</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineplus">+</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineplus">+    if (attachIcon)</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineplus">+      attachIcon.setAttribute(&quot;tooltiptext&quot;, this.statusAttachOwnKey);</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineplus">+</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineplus">+  },</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineplus">+</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineplus">+  attachOwnKey: function() {</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachOwnKey:\n&quot;);</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineplus">+</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineplus">+    var userIdValue;</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineplus">+</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineplus">+    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineplus">+      userIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineplus">+</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineplus">+      if (this.attachOwnKeyObj.attachedKey &amp;&amp; (this.attachOwnKeyObj.attachedKey != userIdValue)) {</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineplus">+        // remove attached key if user ID changed</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineplus">+        this.removeAttachedKey();</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineplus">+      }</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineplus">+</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineplus">+      if (!this.attachOwnKeyObj.attachedKey) {</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineplus">+        var attachedObj = this.extractAndAttachKey([userIdValue], true);</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineplus">+        if (attachedObj) {</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineplus">+          this.attachOwnKeyObj.attachedObj = attachedObj;</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineplus">+          this.attachOwnKeyObj.attachedKey = userIdValue;</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineplus">+        }</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineplus">+      }</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineplus">+    }</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineplus">+    else {</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineplus">+      EnigmailLog.ERROR(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachOwnKey: trying to attach unknown own key!\n&quot;);</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineplus">+    }</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineplus">+  },</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineplus">+</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineplus">+  attachKey: function() {</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.attachKey: \n&quot;);</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineplus">+</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineplus">+    var resultObj = {};</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineplus">+    var inputObj = {};</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineplus">+    inputObj.dialogHeader = EnigmailLocale.getString(&quot;keysToExport&quot;);</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineplus">+    inputObj.options = &quot;multisel,allowexpired,nosending&quot;;</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineplus">+    if (this.trustAllKeys) {</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineplus">+      inputObj.options += &quot;,trustallkeys&quot;;</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineplus">+    }</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineplus">+    var userIdValue = &quot;&quot;;</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineplus">+</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineplus">+    window.openDialog(&quot;chrome://openpgp/content/ui/enigmailKeySelection.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen,resizable&quot;, inputObj, resultObj);</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineplus">+    try {</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineplus">+      if (resultObj.cancelled) return;</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineplus">+      this.extractAndAttachKey(resultObj.userList, true);</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineplus">+    }</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineplus">+      // cancel pressed -&gt; do nothing</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineplus">+      return;</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineplus">+    }</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineplus">+  },</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineplus">+</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineplus">+  extractAndAttachKey: function(uid, warnOnError) {</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.extractAndAttachKey: \n&quot;);</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+    var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineplus">+    if (!enigmailSvc)</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineplus">+      return null;</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineplus">+</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineplus">+    var tmpDir = EnigmailFiles.getTempDir();</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineplus">+    var tmpFile;</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineplus">+    try {</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineplus">+      tmpFile = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineplus">+      tmpFile.initWithPath(tmpDir);</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineplus">+      if (!(tmpFile.isDirectory() &amp;&amp; tmpFile.isWritable())) {</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineplus">+        EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;noTempDir&quot;));</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineplus">+        return null;</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineplus">+      }</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineplus">+    }</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineplus">+      EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.extractAndAttachKey&quot;, ex);</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineplus">+    }</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineplus">+    tmpFile.append(&quot;key.asc&quot;);</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineplus">+    tmpFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineplus">+</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineplus">+    // save file</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineplus">+    var errorMsgObj = {};</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineplus">+</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineplus">+    EnigmailKeyRing.extractKey(false, uid.join(&quot; &quot;), tmpFile, exitCodeObj, errorMsgObj);</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineplus">+    if (exitCodeObj.value !== 0) {</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineplus">+      if (warnOnError) EnigmailDialog.alert(window, errorMsgObj.value);</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineplus">+      return null;</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineplus">+    }</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineplus">+    // create attachment</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineplus">+    var ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineplus">+    var tmpFileURI = ioServ.newFileURI(tmpFile);</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineplus">+    var keyAttachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;].createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineplus">+    keyAttachment.url = tmpFileURI.spec;</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineplus">+    if ((uid.length == 1) &amp;&amp; (uid[0].search(/^(0x)?[a-fA-F0-9]+$/) === 0)) {</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineplus">+      keyAttachment.name = uid[0].substr(-16, 16) + &quot;.asc&quot;;</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineplus">+      if (keyAttachment.name.search(/^0x/) &lt; 0)</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineplus">+        keyAttachment.name = &quot;0x&quot; + keyAttachment.name;</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineplus">+    }</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineplus">+    else {</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineplus">+      keyAttachment.name = &quot;pgpkeys.asc&quot;;</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineplus">+    }</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineplus">+    keyAttachment.temporary = true;</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineplus">+    keyAttachment.contentType = &quot;application/pgp-keys&quot;;</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineplus">+</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineplus">+    // add attachment to msg</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineplus">+    this.addAttachment(keyAttachment);</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineplus">+</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineplus">+    try {</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineplus">+      // TB only</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineplus">+      ChangeAttachmentBucketVisibility(false);</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineplus">+    }</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineplus">+    gContentChanged = true;</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineplus">+    return keyAttachment;</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineplus">+  },</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineplus">+</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineplus">+  addAttachment: function(attachment) {</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineplus">+    AddAttachments([attachment]);</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineplus">+  },</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineplus">+</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineplus">+  enableUndoEncryption: function(newStatus) {</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineplus">+    let eue = document.getElementById(&quot;enigmail_undo_encryption&quot;);</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineplus">+</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineplus">+    if (newStatus) {</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineplus">+      eue.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineplus">+    }</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineplus">+    else</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineplus">+      eue.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineplus">+  },</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineplus">+</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineplus">+</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineplus">+  /**</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineplus">+   *  undo the encryption or signing; get back the original (unsigned/unencrypted) text</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineplus">+   *</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineplus">+   * useEditorUndo |Number|:   &gt; 0  use undo function of editor |n| times</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineplus">+   *                           0: replace text with original text</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineplus">+   */</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineplus">+  undoEncryption: function(useEditorUndo) {</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.undoEncryption:\n&quot;);</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineplus">+    if (this.processed) {</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineplus">+      if (useEditorUndo) {</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineplus">+        EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineplus">+          Enigmail.msg.editor.undo(useEditorUndo);</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineplus">+        }, 10);</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineplus">+      }</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineplus">+      else {</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineplus">+        this.replaceEditorText(this.processed.origText);</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineplus">+        this.enableUndoEncryption(false);</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineplus">+      }</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineplus">+      this.processed = null;</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineplus">+</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineplus">+    }</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineplus">+    else {</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineplus">+      this.decryptQuote(true);</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineplus">+    }</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineplus">+</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineplus">+    var node;</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineplus">+    var nodeNumber;</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineplus">+    var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineplus">+    if (this.modifiedAttach &amp;&amp; bucketList &amp;&amp; bucketList.hasChildNodes()) {</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineplus">+      // undo inline encryption of attachments</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineplus">+      for (var i = 0; i &lt; this.modifiedAttach.length; i++) {</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineplus">+        node = bucketList.firstChild;</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineplus">+        nodeNumber = -1;</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineplus">+        while (node) {</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineplus">+          ++nodeNumber;</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineplus">+          if (node.attachment.url == this.modifiedAttach[i].newUrl) {</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineplus">+            if (this.modifiedAttach[i].encrypted) {</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineplus">+              node.attachment.url = this.modifiedAttach[i].origUrl;</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineplus">+              node.attachment.name = this.modifiedAttach[i].origName;</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineplus">+              node.attachment.temporary = this.modifiedAttach[i].origTemp;</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineplus">+              node.attachment.contentType = this.modifiedAttach[i].origCType;</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineplus">+            }</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineplus">+            else {</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineplus">+              node = bucketList.removeChild(node);</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineplus">+              // Let's release the attachment object held by the node else it won't go away until the window is destroyed</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineplus">+              node.attachment = null;</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineplus">+            }</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineplus">+            // delete encrypted file</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineplus">+            try {</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineplus">+              this.modifiedAttach[i].newFile.remove(false);</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineplus">+            }</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineplus">+            catch (ex) {}</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineplus">+</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineplus">+            node = null; // next attachment please</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineplus">+          }</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineplus">+          else {</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineplus">+            node = node.nextSibling;</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineplus">+          }</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineplus">+        }</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineplus">+      }</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineplus">+    }</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineplus">+</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineplus">+    this.removeAttachedKey();</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineplus">+  },</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineplus">+</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineplus">+</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineplus">+  removeAttachedKey: function() {</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.removeAttachedKey: \n&quot;);</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineplus">+</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineplus">+    var bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineplus">+    var node = bucketList.firstChild;</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineplus">+</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineplus">+    if (bucketList &amp;&amp; bucketList.hasChildNodes() &amp;&amp; this.attachOwnKeyObj.attachedObj) {</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineplus">+      // undo attaching own key</span>
<a href="#l6.1177"></a><span id="l6.1177" class="difflineplus">+      var nodeNumber = -1;</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineplus">+      while (node) {</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineplus">+        ++nodeNumber;</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineplus">+        if (node.attachment.url == this.attachOwnKeyObj.attachedObj.url) {</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineplus">+          node = bucketList.removeChild(node);</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineplus">+          // Let's release the attachment object held by the node else it won't go away until the window is destroyed</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineplus">+          node.attachment = null;</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineplus">+          this.attachOwnKeyObj.attachedObj = null;</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineplus">+          this.attachOwnKeyObj.attachedKey = null;</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineplus">+          node = null; // exit loop</span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineplus">+        }</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineplus">+        else {</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineplus">+          node = node.nextSibling;</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineplus">+        }</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineplus">+      }</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineplus">+      if (!bucketList.hasChildNodes()) {</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineplus">+        try {</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineplus">+          // TB only</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineplus">+          ChangeAttachmentBucketVisibility(true);</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineplus">+        }</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineplus">+        catch (ex) {}</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineplus">+      }</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineplus">+    }</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineplus">+  },</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineplus">+</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineplus">+  getSecurityParams: function(compFields = null, doQueryInterface = false) {</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineplus">+    if (!compFields)</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineplus">+      compFields = gMsgCompose.compFields;</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineplus">+</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineplus">+    if (&quot;securityInfo&quot; in compFields) {</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineplus">+      if (doQueryInterface) {</span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineplus">+        return compFields.securityInfo.QueryInterface(Components.interfaces.nsIMsgSMIMECompFields);</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineplus">+      }</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineplus">+      else {</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineplus">+        return compFields.securityInfo;</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineplus">+      }</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineplus">+    }</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineplus">+    else {</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineplus">+      return compFields.composeSecure;</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineplus">+    }</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineplus">+  },</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineplus">+</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineplus">+  setSecurityParams: function(newSecurityParams) {</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineplus">+    if (&quot;securityInfo&quot; in gMsgCompose.compFields) {</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineplus">+      // TB &lt; 64</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineplus">+      gMsgCompose.compFields.securityInfo = newSecurityParams;</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineplus">+    }</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineplus">+    else {</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineplus">+      gMsgCompose.compFields.composeSecure = newSecurityParams;</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineplus">+    }</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineplus">+  },</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineplus">+</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineplus">+</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineplus">+  resetUpdatedFields: function() {</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineplus">+    this.removeAttachedKey();</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineplus">+</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineplus">+    // reset subject</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineplus">+    if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineplus">+      let si = Enigmail.msg.getSecurityParams().wrappedJSObject;</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineplus">+      if (si.originalSubject) {</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineplus">+        gMsgCompose.compFields.subject = si.originalSubject;</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineplus">+      }</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineplus">+    }</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineplus">+  },</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineplus">+</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineplus">+</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineplus">+  replaceEditorText: function(text) {</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.replaceEditorText:\n&quot;);</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineplus">+</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineplus">+    this.editorSelectAll();</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineplus">+    // Overwrite text in clipboard for security</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineplus">+    // (Otherwise plaintext will be available in the clipbaord)</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineplus">+</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineplus">+    if (this.editor.textLength &gt; 0) {</span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineplus">+      this.editorInsertText(&quot;Enigmail&quot;);</span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineplus">+    }</span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineplus">+    else {</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineplus">+      this.editorInsertText(&quot; &quot;);</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineplus">+    }</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineplus">+</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineplus">+    this.editorSelectAll();</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineplus">+    this.editorInsertText(text);</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineplus">+  },</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineplus">+</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineplus">+  goAccountManager: function() {</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.goAccountManager:\n&quot;);</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineplus">+    EnigmailCore.getService(window);</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineplus">+    let currentId = null;</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineplus">+    let account = null;</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineplus">+    try {</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineplus">+      currentId = getCurrentIdentity();</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineplus">+      account = EnigmailFuncs.getAccountForIdentity(currentId);</span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineplus">+    }</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineplus">+    window.openDialog(&quot;chrome://openpgp/content/ui/editSingleAccount.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, {</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineplus">+      identity: currentId,</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineplus">+      account: account</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineplus">+    });</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineplus">+    this.setIdentityDefaults();</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineplus">+  },</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineplus">+</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineplus">+  /**</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineplus">+   * Determine if Enigmail is enabled for the account</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineplus">+   */</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineplus">+</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineplus">+  isEnigmailEnabled: function() {</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineplus">+    return this.identity.getBoolAttribute(&quot;enablePgp&quot;);</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineplus">+  },</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineplus">+</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineplus">+  /**</span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineplus">+   * Determine if Autocrypt is enabled for the account</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineplus">+   */</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineplus">+  isAutocryptEnabled: function() {</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineplus">+    if (this.isEnigmailEnabled()) {</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineplus">+      let srv = this.getCurrentIncomingServer();</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineplus">+      return (srv ? srv.getBoolValue(&quot;enableAutocrypt&quot;) : false);</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineplus">+    }</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineplus">+</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineplus">+    return false;</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineplus">+  },</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineplus">+</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineplus">+  doPgpButton: function(what) {</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.doPgpButton: what=&quot; + what + &quot;\n&quot;);</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineplus">+</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineplus">+    if (this.isEnigmailEnabled()) {</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineplus">+      EnigmailCore.getService(window); // try to access Enigmail to launch the wizard if needed</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineplus">+    }</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineplus">+</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineplus">+    // ignore settings for this account?</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineplus">+    try {</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineplus">+      if (!this.getEncryptionEnabled() &amp;&amp; !this.getSigningEnabled()) {</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineplus">+        if (EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;configureNow&quot;),</span>
<a href="#l6.1309"></a><span id="l6.1309" class="difflineplus">+            EnigmailLocale.getString(&quot;msgCompose.button.configure&quot;))) {</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineplus">+          // configure account settings for the first time</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineplus">+          this.goAccountManager();</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineplus">+          if (!this.isEnigmailEnabled()) {</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineplus">+            return;</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineplus">+          }</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineplus">+        }</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineplus">+        else {</span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineplus">+          return;</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineplus">+        }</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineplus">+      }</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineplus">+    }</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineplus">+</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineplus">+    switch (what) {</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineplus">+      case 'sign':</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineplus">+      case 'encrypt':</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineplus">+        this.setSendMode(what);</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineplus">+        break;</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineplus">+</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineplus">+        // menu entries:</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineplus">+      case 'final-signDefault':</span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineplus">+      case 'final-signYes':</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineplus">+      case 'final-signNo':</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineplus">+      case 'final-encryptDefault':</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineplus">+      case 'final-encryptYes':</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineplus">+      case 'final-encryptNo':</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineplus">+      case 'final-pgpmimeDefault':</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineplus">+      case 'final-pgpmimeYes':</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineplus">+      case 'final-pgpmimeNo':</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineplus">+      case 'final-useSmime':</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineplus">+      case 'toggle-final-sign':</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineplus">+      case 'toggle-final-encrypt':</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineplus">+      case 'toggle-final-mime':</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineplus">+        this.setFinalSendMode(what);</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineplus">+        break;</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineplus">+</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineplus">+      case 'trustKeys':</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineplus">+        this.tempTrustAllKeys();</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineplus">+        break;</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineplus">+</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineplus">+      case 'nothing':</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineplus">+        break;</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineplus">+</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineplus">+      case 'displaySecuritySettings':</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineplus">+        this.displaySecuritySettings();</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineplus">+        break;</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineplus">+      default:</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineplus">+        this.displaySecuritySettings();</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineplus">+    }</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineplus">+</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineplus">+  },</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineplus">+</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineplus">+</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineplus">+  // changes the DEFAULT sendMode</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineplus">+  // - also called internally for saved emails</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineplus">+  setSendMode: function(sendMode) {</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setSendMode: sendMode=&quot; + sendMode + &quot;\n&quot;);</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineplus">+</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineplus">+    var origSendMode = this.sendMode;</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineplus">+    switch (sendMode) {</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineplus">+      case 'sign':</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineplus">+        this.sendMode |= SIGN;</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineplus">+        break;</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineplus">+      case 'encrypt':</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineplus">+        this.sendMode |= ENCRYPT;</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineplus">+        break;</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineplus">+      default:</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineplus">+        EnigmailDialog.alert(window, &quot;Enigmail.msg.setSendMode - unexpected value: &quot; + sendMode);</span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineplus">+        break;</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineplus">+    }</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineplus">+    // sendMode changed ?</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineplus">+    // - sign and send are internal initializations</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineplus">+    if (!this.sendModeDirty &amp;&amp; (this.sendMode != origSendMode) &amp;&amp; sendMode != 'sign' &amp;&amp; sendMode != 'encrypt') {</span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineplus">+      this.sendModeDirty = true;</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineplus">+    }</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineplus">+  },</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineplus">+</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineplus">+</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineplus">+  // changes the FINAL sendMode</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineplus">+  // - triggered by the user interface</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineplus">+  setFinalSendMode: function(sendMode) {</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setFinalSendMode: sendMode=&quot; + sendMode + &quot;\n&quot;);</span>
<a href="#l6.1396"></a><span id="l6.1396" class="difflineplus">+</span>
<a href="#l6.1397"></a><span id="l6.1397" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineplus">+</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineplus">+    switch (sendMode) {</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineplus">+</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineplus">+      // menu entries for final settings:</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineplus">+</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineplus">+      case 'final-encryptDefault':</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineplus">+        // switch encryption to &quot;use defaults &amp; rules&quot;</span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineplus">+        if (this.encryptForced != EnigmailConstants.ENIG_UNDEF) { // if encrypt/noencrypt forced</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineplus">+          this.encryptForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineplus">+        }</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineplus">+        break;</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineplus">+      case 'final-encryptYes':</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineplus">+        // switch encryption to &quot;force encryption&quot;</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineplus">+        if (this.encryptForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to encrypt</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineplus">+          this.encryptForced = EnigmailConstants.ENIG_ALWAYS; // force to encrypt</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineplus">+        }</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineplus">+        break;</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineplus">+      case 'final-encryptNo':</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineplus">+        // switch encryption to &quot;force no to encrypt&quot;</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineplus">+        if (this.encryptForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to encrypt</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineplus">+          this.encryptForced = EnigmailConstants.ENIG_NEVER; // force not to encrypt</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineplus">+        }</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineplus">+        break;</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineplus">+</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineplus">+      case 'final-signDefault':</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineplus">+        // switch signing to &quot;use defaults &amp; rules&quot;</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineplus">+        if (this.signForced != EnigmailConstants.ENIG_UNDEF) { // if sign/nosign forced</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineplus">+          // re-init if signing depends on encryption if this was broken before</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineplus">+          this.finalSignDependsOnEncrypt = (this.getAccDefault(&quot;signIfEnc&quot;) || this.getAccDefault(&quot;signIfNotEnc&quot;));</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineplus">+          this.signForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineplus">+        }</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineplus">+        break;</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineplus">+      case 'final-signYes':</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineplus">+        if (this.signForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to sign</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineplus">+          this.signingNoLongerDependsOnEnc();</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineplus">+          this.signForced = EnigmailConstants.ENIG_ALWAYS; // force to sign</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineplus">+        }</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineplus">+        break;</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineplus">+      case 'final-signNo':</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineplus">+        if (this.signForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to sign</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineplus">+          this.signingNoLongerDependsOnEnc();</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineplus">+          this.signForced = EnigmailConstants.ENIG_NEVER; // force not to sign</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineplus">+        }</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineplus">+        break;</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineplus">+</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineplus">+      case 'final-pgpmimeDefault':</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineplus">+        if (this.pgpmimeForced != EnigmailConstants.ENIG_UNDEF) { // if any PGP mode forced</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineplus">+          this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF; // back to defaults/rules</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineplus">+        }</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineplus">+        break;</span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineplus">+      case 'final-pgpmimeYes':</span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineplus">+        if (this.pgpmimeForced != EnigmailConstants.ENIG_ALWAYS) { // if not forced to PGP/Mime</span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineplus">+          this.pgpmimeForced = EnigmailConstants.ENIG_ALWAYS; // force to PGP/Mime</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineplus">+        }</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineplus">+        break;</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineplus">+      case 'final-pgpmimeNo':</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineplus">+        if (this.pgpmimeForced != EnigmailConstants.ENIG_NEVER) { // if not forced not to PGP/Mime</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineplus">+          this.pgpmimeForced = EnigmailConstants.ENIG_NEVER; // force not to PGP/Mime</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineplus">+        }</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineplus">+        break;</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineplus">+</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineplus">+      case 'final-useSmime':</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineplus">+        //</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineplus">+        this.pgpmimeForced = EnigmailConstants.ENIG_FORCE_SMIME;</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineplus">+        break;</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineplus">+</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineplus">+        // status bar buttons:</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineplus">+        // - can only switch to force or not to force sign/enc</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineplus">+</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineplus">+      case 'toggle-final-sign':</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineplus">+        this.signingNoLongerDependsOnEnc();</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineplus">+        switch (this.statusSigned) {</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineplus">+            this.signForced = EnigmailConstants.ENIG_ALWAYS; // force to sign</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineplus">+            break;</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineplus">+            this.signForced = EnigmailConstants.ENIG_NEVER; // force not to sign</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineplus">+            break;</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineplus">+            this.signForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineplus">+            break;</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineplus">+        }</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineplus">+        break;</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineplus">+</span>
<a href="#l6.1485"></a><span id="l6.1485" class="difflineplus">+      case 'toggle-final-encrypt':</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineplus">+        switch (this.statusEncrypted) {</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineplus">+            this.encryptForced = EnigmailConstants.ENIG_ALWAYS; // force to encrypt</span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineplus">+            break;</span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineplus">+            this.encryptForced = EnigmailConstants.ENIG_NEVER; // force not to encrypt</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineplus">+            break;</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineplus">+            this.encryptForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineplus">+            break;</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineplus">+        }</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineplus">+        break;</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineplus">+</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineplus">+      case 'toggle-final-mime':</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineplus">+        switch (this.statusPGPMime) {</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineplus">+            this.pgpmimeForced = EnigmailConstants.ENIG_ALWAYS; // force PGP/MIME</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineplus">+            break;</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineplus">+            this.pgpmimeForced = EnigmailConstants.ENIG_NEVER; // force Inline-PGP</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineplus">+            break;</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineplus">+            this.pgpmimeForced = EnigmailConstants.ENIG_NEVER;</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineplus">+            break;</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineplus">+        }</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineplus">+        break;</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineplus">+</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineplus">+      default:</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineplus">+        EnigmailDialog.alert(window, &quot;Enigmail.msg.setFinalSendMode - unexpected value: &quot; + sendMode);</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineplus">+        break;</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineplus">+    }</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineplus">+</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineplus">+    // this is always a send mode change (only toggle effects)</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineplus">+    this.sendModeDirty = true;</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineplus">+</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineplus">+    this.determineSendFlags();</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineplus">+    //this.processFinalState();</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineplus">+    //this.updateStatusBar();</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineplus">+  },</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineplus">+</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineplus">+  /**</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineplus">+    key function to process the final encrypt/sign/pgpmime state from all settings</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineplus">+    @param sendFlags: contains the sendFlags if the message is really processed. Optional, can be null</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineplus">+      - uses as INPUT:</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineplus">+         - this.sendMode</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineplus">+         - this.encryptByRules, this.signByRules, pgpmimeByRules</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineplus">+         - this.encryptForced, this.encryptSigned</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineplus">+      - uses as OUTPUT:</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineplus">+         - this.statusEncrypt, this.statusSign, this.statusPGPMime</span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineplus">+</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineplus">+    no return value</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineplus">+  */</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineplus">+  processFinalState: function(sendFlags) {</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processFinalState()\n&quot;);</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineplus">+</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineplus">+</span>
<a href="#l6.1548"></a><span id="l6.1548" class="difflineplus">+</span>
<a href="#l6.1549"></a><span id="l6.1549" class="difflineplus">+    let encFinally = null;</span>
<a href="#l6.1550"></a><span id="l6.1550" class="difflineplus">+    let encReason = &quot;&quot;;</span>
<a href="#l6.1551"></a><span id="l6.1551" class="difflineplus">+    let signFinally = null;</span>
<a href="#l6.1552"></a><span id="l6.1552" class="difflineplus">+    let signReason = &quot;&quot;;</span>
<a href="#l6.1553"></a><span id="l6.1553" class="difflineplus">+    let pgpmimeFinally = null;</span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineplus">+    let pgpEnabled = this.isEnigmailEnabled();</span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineplus">+    let smimeEnabled = this.isSmimeEnabled();</span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineplus">+</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineplus">+    // ------ 1. process OpenPGP status ------</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineplus">+</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineplus">+    // process resulting encrypt mode</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineplus">+    if (this.encryptForced == EnigmailConstants.ENIG_NEVER) { // force not to encrypt?</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineplus">+      encFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineplus">+      encReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineplus">+    }</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineplus">+    else if (this.encryptForced == EnigmailConstants.ENIG_ALWAYS) { // force to encrypt?</span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineplus">+      encFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineplus">+      encReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineplus">+    }</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineplus">+    else switch (this.encryptByRules) {</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineplus">+      case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineplus">+        encFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineplus">+        encReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineplus">+        break;</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineplus">+      case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l6.1574"></a><span id="l6.1574" class="difflineplus">+        if (this.sendMode &amp; ENCRYPT) {</span>
<a href="#l6.1575"></a><span id="l6.1575" class="difflineplus">+          encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineplus">+          if (pgpEnabled &amp;&amp; this.getAccDefault(&quot;encrypt&quot;)) {</span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineplus">+            encReason = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineplus">+          }</span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineplus">+        }</span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineplus">+        else {</span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineplus">+          encFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineplus">+        }</span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineplus">+        break;</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineplus">+      case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineplus">+        encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineplus">+        encReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineplus">+        break;</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineplus">+      case EnigmailConstants.ENIG_AUTO_ALWAYS:</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineplus">+        encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineplus">+        encReason = EnigmailLocale.getString(&quot;reasonByAutoEncryption&quot;);</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineplus">+        break;</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineplus">+      case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineplus">+        encFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l6.1594"></a><span id="l6.1594" class="difflineplus">+        encReason = EnigmailLocale.getString(&quot;reasonByConflict&quot;);</span>
<a href="#l6.1595"></a><span id="l6.1595" class="difflineplus">+        break;</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineplus">+    }</span>
<a href="#l6.1597"></a><span id="l6.1597" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   encrypt=&quot; + ((this.sendMode &amp; ENCRYPT) !== 0) + &quot; encryptByRules=&quot; + this.encryptByRules + &quot; encFinally=&quot; + encFinally + &quot;\n&quot;);</span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineplus">+    EnigmailLog.DEBUG(&quot;                                encReason=&quot; + encReason + &quot;\n&quot;);</span>
<a href="#l6.1599"></a><span id="l6.1599" class="difflineplus">+</span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineplus">+    // process resulting sign mode</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineplus">+    if (this.signForced == EnigmailConstants.ENIG_NEVER) { // force not to sign?</span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineplus">+      signFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineplus">+      signReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineplus">+    }</span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineplus">+    else if (this.signForced == EnigmailConstants.ENIG_ALWAYS) { // force to sign?</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineplus">+      signFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineplus">+      signReason = EnigmailLocale.getString(&quot;reasonManuallyForced&quot;);</span>
<a href="#l6.1608"></a><span id="l6.1608" class="difflineplus">+    }</span>
<a href="#l6.1609"></a><span id="l6.1609" class="difflineplus">+    else switch (this.signByRules) {</span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineplus">+      case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineplus">+        signFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineplus">+        signReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l6.1613"></a><span id="l6.1613" class="difflineplus">+        break;</span>
<a href="#l6.1614"></a><span id="l6.1614" class="difflineplus">+      case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineplus">+        if (this.sendMode &amp; SIGN) {</span>
<a href="#l6.1616"></a><span id="l6.1616" class="difflineplus">+          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1617"></a><span id="l6.1617" class="difflineplus">+          if (pgpEnabled &amp;&amp; this.getAccDefault(&quot;sign-pgp&quot;)) {</span>
<a href="#l6.1618"></a><span id="l6.1618" class="difflineplus">+            signReason = EnigmailLocale.getString(&quot;reasonEnabledByDefault&quot;);</span>
<a href="#l6.1619"></a><span id="l6.1619" class="difflineplus">+          }</span>
<a href="#l6.1620"></a><span id="l6.1620" class="difflineplus">+        }</span>
<a href="#l6.1621"></a><span id="l6.1621" class="difflineplus">+        else {</span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineplus">+          signFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineplus">+        }</span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineplus">+        break;</span>
<a href="#l6.1625"></a><span id="l6.1625" class="difflineplus">+      case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.1626"></a><span id="l6.1626" class="difflineplus">+        signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1627"></a><span id="l6.1627" class="difflineplus">+        signReason = EnigmailLocale.getString(&quot;reasonByRecipientRules&quot;);</span>
<a href="#l6.1628"></a><span id="l6.1628" class="difflineplus">+        break;</span>
<a href="#l6.1629"></a><span id="l6.1629" class="difflineplus">+      case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l6.1630"></a><span id="l6.1630" class="difflineplus">+        signFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineplus">+        signReason = EnigmailLocale.getString(&quot;reasonByConflict&quot;);</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineplus">+        break;</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineplus">+    }</span>
<a href="#l6.1634"></a><span id="l6.1634" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   signed=&quot; + ((this.sendMode &amp; SIGN) !== 0) + &quot; signByRules=&quot; + this.signByRules + &quot; signFinally=&quot; + signFinally + &quot;\n&quot;);</span>
<a href="#l6.1635"></a><span id="l6.1635" class="difflineplus">+    EnigmailLog.DEBUG(&quot;                                signReason=&quot; + signReason + &quot;\n&quot;);</span>
<a href="#l6.1636"></a><span id="l6.1636" class="difflineplus">+</span>
<a href="#l6.1637"></a><span id="l6.1637" class="difflineplus">+    // process option to finally sign if encrypted/unencrypted</span>
<a href="#l6.1638"></a><span id="l6.1638" class="difflineplus">+    // (unless rules force not to sign)</span>
<a href="#l6.1639"></a><span id="l6.1639" class="difflineplus">+</span>
<a href="#l6.1640"></a><span id="l6.1640" class="difflineplus">+    if (this.finalSignDependsOnEncrypt &amp;&amp; pgpEnabled) {</span>
<a href="#l6.1641"></a><span id="l6.1641" class="difflineplus">+      if (this.signByRules == EnigmailConstants.ENIG_UNDEF) { // if final sign mode not clear yet</span>
<a href="#l6.1642"></a><span id="l6.1642" class="difflineplus">+        //derivedFromEncMode = true;</span>
<a href="#l6.1643"></a><span id="l6.1643" class="difflineplus">+        switch (encFinally) {</span>
<a href="#l6.1644"></a><span id="l6.1644" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1645"></a><span id="l6.1645" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1646"></a><span id="l6.1646" class="difflineplus">+            if (this.getAccDefault(&quot;signIfEnc&quot;)) {</span>
<a href="#l6.1647"></a><span id="l6.1647" class="difflineplus">+              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineplus">+              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineplus">+            }</span>
<a href="#l6.1650"></a><span id="l6.1650" class="difflineplus">+            break;</span>
<a href="#l6.1651"></a><span id="l6.1651" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.1652"></a><span id="l6.1652" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1653"></a><span id="l6.1653" class="difflineplus">+            if (this.getAccDefault(&quot;signIfNotEnc&quot;)) {</span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineplus">+              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1655"></a><span id="l6.1655" class="difflineplus">+              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineplus">+            }</span>
<a href="#l6.1657"></a><span id="l6.1657" class="difflineplus">+            break;</span>
<a href="#l6.1658"></a><span id="l6.1658" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1659"></a><span id="l6.1659" class="difflineplus">+            if (this.getAccDefault(&quot;signIfEnc&quot;) &amp;&amp; this.getAccDefault(&quot;signIfNotEnc&quot;)) {</span>
<a href="#l6.1660"></a><span id="l6.1660" class="difflineplus">+              signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1661"></a><span id="l6.1661" class="difflineplus">+              signReason = EnigmailLocale.getString(&quot;reasonByEncryptionMode&quot;);</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineplus">+            }</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineplus">+            else {</span>
<a href="#l6.1664"></a><span id="l6.1664" class="difflineplus">+              signFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l6.1665"></a><span id="l6.1665" class="difflineplus">+            }</span>
<a href="#l6.1666"></a><span id="l6.1666" class="difflineplus">+            break;</span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineplus">+        }</span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   derived signFinally=&quot; + signFinally + &quot;\n&quot;);</span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineplus">+        EnigmailLog.DEBUG(&quot;                                signReason=&quot; + signReason + &quot;\n&quot;);</span>
<a href="#l6.1670"></a><span id="l6.1670" class="difflineplus">+      }</span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineplus">+    }</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineplus">+</span>
<a href="#l6.1673"></a><span id="l6.1673" class="difflineplus">+    if (pgpEnabled) {</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineplus">+      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineplus">+    }</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineplus">+    else if (smimeEnabled) {</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineplus">+      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l6.1678"></a><span id="l6.1678" class="difflineplus">+    }</span>
<a href="#l6.1679"></a><span id="l6.1679" class="difflineplus">+</span>
<a href="#l6.1680"></a><span id="l6.1680" class="difflineplus">+    // ------ 2. Process S/MIME status  ------</span>
<a href="#l6.1681"></a><span id="l6.1681" class="difflineplus">+    if (gSMFields) {</span>
<a href="#l6.1682"></a><span id="l6.1682" class="difflineplus">+</span>
<a href="#l6.1683"></a><span id="l6.1683" class="difflineplus">+      let r = this.tryEnablingSMime(encFinally, signFinally);</span>
<a href="#l6.1684"></a><span id="l6.1684" class="difflineplus">+      if (this.statusPGPMime === EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l6.1685"></a><span id="l6.1685" class="difflineplus">+        r.encFinally === EnigmailConstants.ENIG_FINAL_NO &amp;&amp;</span>
<a href="#l6.1686"></a><span id="l6.1686" class="difflineplus">+        (this.identity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0)) {</span>
<a href="#l6.1687"></a><span id="l6.1687" class="difflineplus">+</span>
<a href="#l6.1688"></a><span id="l6.1688" class="difflineplus">+        r.encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1689"></a><span id="l6.1689" class="difflineplus">+      }</span>
<a href="#l6.1690"></a><span id="l6.1690" class="difflineplus">+</span>
<a href="#l6.1691"></a><span id="l6.1691" class="difflineplus">+      encFinally = r.encFinally;</span>
<a href="#l6.1692"></a><span id="l6.1692" class="difflineplus">+      signFinally = r.signFinally;</span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineplus">+</span>
<a href="#l6.1694"></a><span id="l6.1694" class="difflineplus">+      // FIXME: check if bug 776 can be fixed here</span>
<a href="#l6.1695"></a><span id="l6.1695" class="difflineplus">+</span>
<a href="#l6.1696"></a><span id="l6.1696" class="difflineplus">+      if (encFinally === EnigmailConstants.ENIG_FINAL_NO &amp;&amp;</span>
<a href="#l6.1697"></a><span id="l6.1697" class="difflineplus">+        this.signByRules === EnigmailConstants.ENIG_UNDEF &amp;&amp;</span>
<a href="#l6.1698"></a><span id="l6.1698" class="difflineplus">+        signFinally !== EnigmailConstants.ENIG_FINAL_FORCEYES &amp;&amp;</span>
<a href="#l6.1699"></a><span id="l6.1699" class="difflineplus">+        signFinally !== EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l6.1700"></a><span id="l6.1700" class="difflineplus">+</span>
<a href="#l6.1701"></a><span id="l6.1701" class="difflineplus">+        if (this.isEnigmailEnabled() &amp;&amp;</span>
<a href="#l6.1702"></a><span id="l6.1702" class="difflineplus">+          !this.identity.getBoolAttribute(&quot;sign_mail&quot;) &amp;&amp;</span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineplus">+          (this.getAccDefault(&quot;signIfNotEnc&quot;) || this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) &gt; 0)) {</span>
<a href="#l6.1704"></a><span id="l6.1704" class="difflineplus">+          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1705"></a><span id="l6.1705" class="difflineplus">+          this.statusPGPMime = EnigmailConstants.ENIG_FINAL_UNDEF;</span>
<a href="#l6.1706"></a><span id="l6.1706" class="difflineplus">+        }</span>
<a href="#l6.1707"></a><span id="l6.1707" class="difflineplus">+        else if (this.isSmimeEnabled() &amp;&amp;</span>
<a href="#l6.1708"></a><span id="l6.1708" class="difflineplus">+          this.identity.getIntAttribute(&quot;defaultSigningPolicy&quot;) === 0 &amp;&amp;</span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineplus">+          this.identity.getBoolAttribute(&quot;sign_mail&quot;)) {</span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineplus">+          signFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineplus">+          this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineplus">+        }</span>
<a href="#l6.1713"></a><span id="l6.1713" class="difflineplus">+      }</span>
<a href="#l6.1714"></a><span id="l6.1714" class="difflineplus">+</span>
<a href="#l6.1715"></a><span id="l6.1715" class="difflineplus">+      // update the S/MIME GUI elements</span>
<a href="#l6.1716"></a><span id="l6.1716" class="difflineplus">+      try {</span>
<a href="#l6.1717"></a><span id="l6.1717" class="difflineplus">+        setSecuritySettings(&quot;1&quot;);</span>
<a href="#l6.1718"></a><span id="l6.1718" class="difflineplus">+      }</span>
<a href="#l6.1719"></a><span id="l6.1719" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.1720"></a><span id="l6.1720" class="difflineplus">+</span>
<a href="#l6.1721"></a><span id="l6.1721" class="difflineplus">+      try {</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineplus">+        setSecuritySettings(&quot;2&quot;);</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineplus">+      }</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineplus">+    }</span>
<a href="#l6.1726"></a><span id="l6.1726" class="difflineplus">+</span>
<a href="#l6.1727"></a><span id="l6.1727" class="difflineplus">+    // ------ 3. process final resulting protocol mode (inline-PGP / PGP/MIME / S/MIME) ------</span>
<a href="#l6.1728"></a><span id="l6.1728" class="difflineplus">+</span>
<a href="#l6.1729"></a><span id="l6.1729" class="difflineplus">+    if (this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l6.1730"></a><span id="l6.1730" class="difflineplus">+      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l6.1731"></a><span id="l6.1731" class="difflineplus">+      // process resulting PGP/MIME mode</span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineplus">+      if (this.pgpmimeForced === EnigmailConstants.ENIG_NEVER) { // force not to PGP/Mime?</span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineplus">+        pgpmimeFinally = EnigmailConstants.ENIG_FINAL_FORCENO;</span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineplus">+      }</span>
<a href="#l6.1735"></a><span id="l6.1735" class="difflineplus">+      else if (this.pgpmimeForced === EnigmailConstants.ENIG_ALWAYS) { // force to PGP/Mime?</span>
<a href="#l6.1736"></a><span id="l6.1736" class="difflineplus">+        pgpmimeFinally = EnigmailConstants.ENIG_FINAL_FORCEYES;</span>
<a href="#l6.1737"></a><span id="l6.1737" class="difflineplus">+      }</span>
<a href="#l6.1738"></a><span id="l6.1738" class="difflineplus">+      else switch (this.pgpmimeByRules) {</span>
<a href="#l6.1739"></a><span id="l6.1739" class="difflineplus">+        case EnigmailConstants.ENIG_NEVER:</span>
<a href="#l6.1740"></a><span id="l6.1740" class="difflineplus">+          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.1741"></a><span id="l6.1741" class="difflineplus">+          break;</span>
<a href="#l6.1742"></a><span id="l6.1742" class="difflineplus">+        case EnigmailConstants.ENIG_UNDEF:</span>
<a href="#l6.1743"></a><span id="l6.1743" class="difflineplus">+          pgpmimeFinally = ((this.sendPgpMime || (this.sendMode &amp; EnigmailConstants.SEND_PGP_MIME)) ? EnigmailConstants.ENIG_FINAL_YES : EnigmailConstants.ENIG_FINAL_NO);</span>
<a href="#l6.1744"></a><span id="l6.1744" class="difflineplus">+          break;</span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineplus">+        case EnigmailConstants.ENIG_ALWAYS:</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineplus">+          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineplus">+          break;</span>
<a href="#l6.1748"></a><span id="l6.1748" class="difflineplus">+        case EnigmailConstants.ENIG_CONFLICT:</span>
<a href="#l6.1749"></a><span id="l6.1749" class="difflineplus">+          pgpmimeFinally = EnigmailConstants.ENIG_FINAL_CONFLICT;</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineplus">+          break;</span>
<a href="#l6.1751"></a><span id="l6.1751" class="difflineplus">+      }</span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineplus">+      this.statusPGPMime = pgpmimeFinally;</span>
<a href="#l6.1753"></a><span id="l6.1753" class="difflineplus">+    }</span>
<a href="#l6.1754"></a><span id="l6.1754" class="difflineplus">+</span>
<a href="#l6.1755"></a><span id="l6.1755" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   pgpmimeByRules=&quot; + this.pgpmimeByRules + &quot; pgpmimeFinally=&quot; + pgpmimeFinally + &quot;\n&quot;);</span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineplus">+</span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineplus">+    this.statusEncrypted = encFinally;</span>
<a href="#l6.1758"></a><span id="l6.1758" class="difflineplus">+    this.statusSigned = signFinally;</span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineplus">+    this.reasonEncrypted = encReason;</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineplus">+    this.reasonSigned = signReason;</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineplus">+</span>
<a href="#l6.1762"></a><span id="l6.1762" class="difflineplus">+    switch (this.statusEncrypted) {</span>
<a href="#l6.1763"></a><span id="l6.1763" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1765"></a><span id="l6.1765" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1766"></a><span id="l6.1766" class="difflineplus">+        return;</span>
<a href="#l6.1767"></a><span id="l6.1767" class="difflineplus">+    }</span>
<a href="#l6.1768"></a><span id="l6.1768" class="difflineplus">+</span>
<a href="#l6.1769"></a><span id="l6.1769" class="difflineplus">+    switch (this.statusPGPMime) {</span>
<a href="#l6.1770"></a><span id="l6.1770" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l6.1771"></a><span id="l6.1771" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineplus">+        return;</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineplus">+    }</span>
<a href="#l6.1774"></a><span id="l6.1774" class="difflineplus">+  },</span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineplus">+</span>
<a href="#l6.1776"></a><span id="l6.1776" class="difflineplus">+  /**</span>
<a href="#l6.1777"></a><span id="l6.1777" class="difflineplus">+   * Try to enable S/MIME, repsecting the various Enigmail rules</span>
<a href="#l6.1778"></a><span id="l6.1778" class="difflineplus">+   *</span>
<a href="#l6.1779"></a><span id="l6.1779" class="difflineplus">+   * @param encFinally:  Number - &quot;final&quot; encryption status before applying S/MIME</span>
<a href="#l6.1780"></a><span id="l6.1780" class="difflineplus">+   * @param signFinally: Number - &quot;final&quot; signing status before applying S/MIME</span>
<a href="#l6.1781"></a><span id="l6.1781" class="difflineplus">+   *</span>
<a href="#l6.1782"></a><span id="l6.1782" class="difflineplus">+   * @return Object:</span>
<a href="#l6.1783"></a><span id="l6.1783" class="difflineplus">+   *   - encFinally:  Number - new encryption status after trying S/MIME</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineplus">+   *   - signFinally: Number - new signing status after trying S/MIME</span>
<a href="#l6.1785"></a><span id="l6.1785" class="difflineplus">+   */</span>
<a href="#l6.1786"></a><span id="l6.1786" class="difflineplus">+</span>
<a href="#l6.1787"></a><span id="l6.1787" class="difflineplus">+  tryEnablingSMime: function(encFinally, signFinally) {</span>
<a href="#l6.1788"></a><span id="l6.1788" class="difflineplus">+    let encryptSmime = false;</span>
<a href="#l6.1789"></a><span id="l6.1789" class="difflineplus">+    let autoSendEncrypted = EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;);</span>
<a href="#l6.1790"></a><span id="l6.1790" class="difflineplus">+</span>
<a href="#l6.1791"></a><span id="l6.1791" class="difflineplus">+    gSMFields.requireEncryptMessage = false;</span>
<a href="#l6.1792"></a><span id="l6.1792" class="difflineplus">+    gSMFields.signMessage = false;</span>
<a href="#l6.1793"></a><span id="l6.1793" class="difflineplus">+</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineplus">+    // do not try S/MIME encryption if one of the following applies:</span>
<a href="#l6.1795"></a><span id="l6.1795" class="difflineplus">+    // - OpenPGP is preferred over S/MIME, and OpenPGP is possible</span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineplus">+    // - OpenPGP is preferred over S/MIME, and OpenPGP is enabled by rules</span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineplus">+    // - encryption is disabled by rules and encryption is not manually enabled</span>
<a href="#l6.1798"></a><span id="l6.1798" class="difflineplus">+    // - encryption is manually disabled</span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineplus">+    if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineplus">+      encryptSmime = true;</span>
<a href="#l6.1801"></a><span id="l6.1801" class="difflineplus">+    }</span>
<a href="#l6.1802"></a><span id="l6.1802" class="difflineplus">+    else if ((this.mimePreferOpenPGP === 1 &amp;&amp; (this.autoPgpEncryption ||</span>
<a href="#l6.1803"></a><span id="l6.1803" class="difflineplus">+        this.encryptByRules === EnigmailConstants.ENIG_ALWAYS)) ||</span>
<a href="#l6.1804"></a><span id="l6.1804" class="difflineplus">+      (this.encryptByRules === EnigmailConstants.ENIG_NEVER &amp;&amp; encFinally !== EnigmailConstants.ENIG_FINAL_FORCEYES) ||</span>
<a href="#l6.1805"></a><span id="l6.1805" class="difflineplus">+      (this.pgpmimeForced === EnigmailConstants.ENIG_NEVER || this.pgpmimeForced === EnigmailConstants.ENIG_ALWAYS) ||</span>
<a href="#l6.1806"></a><span id="l6.1806" class="difflineplus">+      encFinally === EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l6.1807"></a><span id="l6.1807" class="difflineplus">+      return {</span>
<a href="#l6.1808"></a><span id="l6.1808" class="difflineplus">+        encFinally: encFinally,</span>
<a href="#l6.1809"></a><span id="l6.1809" class="difflineplus">+        signFinally: signFinally</span>
<a href="#l6.1810"></a><span id="l6.1810" class="difflineplus">+      };</span>
<a href="#l6.1811"></a><span id="l6.1811" class="difflineplus">+    }</span>
<a href="#l6.1812"></a><span id="l6.1812" class="difflineplus">+</span>
<a href="#l6.1813"></a><span id="l6.1813" class="difflineplus">+    if (!encryptSmime) {</span>
<a href="#l6.1814"></a><span id="l6.1814" class="difflineplus">+      if (autoSendEncrypted === 1) {</span>
<a href="#l6.1815"></a><span id="l6.1815" class="difflineplus">+        if (this.isSmimeEncryptionPossible()) {</span>
<a href="#l6.1816"></a><span id="l6.1816" class="difflineplus">+          if (this.mimePreferOpenPGP === 0) {</span>
<a href="#l6.1817"></a><span id="l6.1817" class="difflineplus">+            // S/MIME is preferred and encryption is possible</span>
<a href="#l6.1818"></a><span id="l6.1818" class="difflineplus">+            encryptSmime = true;</span>
<a href="#l6.1819"></a><span id="l6.1819" class="difflineplus">+            encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1820"></a><span id="l6.1820" class="difflineplus">+          }</span>
<a href="#l6.1821"></a><span id="l6.1821" class="difflineplus">+          else if (encFinally === EnigmailConstants.ENIG_FINAL_NO ||</span>
<a href="#l6.1822"></a><span id="l6.1822" class="difflineplus">+            encFinally === EnigmailConstants.ENIG_FINAL_CONFLICT ||</span>
<a href="#l6.1823"></a><span id="l6.1823" class="difflineplus">+            !this.autoPgpEncryption) {</span>
<a href="#l6.1824"></a><span id="l6.1824" class="difflineplus">+            // Enigmail is preferred but not possible; S/MIME enc. is possible</span>
<a href="#l6.1825"></a><span id="l6.1825" class="difflineplus">+            encryptSmime = true;</span>
<a href="#l6.1826"></a><span id="l6.1826" class="difflineplus">+            encFinally = EnigmailConstants.ENIG_FINAL_YES;</span>
<a href="#l6.1827"></a><span id="l6.1827" class="difflineplus">+          }</span>
<a href="#l6.1828"></a><span id="l6.1828" class="difflineplus">+        }</span>
<a href="#l6.1829"></a><span id="l6.1829" class="difflineplus">+      }</span>
<a href="#l6.1830"></a><span id="l6.1830" class="difflineplus">+      else if (encFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.1831"></a><span id="l6.1831" class="difflineplus">+        if (this.isSmimeEncryptionPossible()) {</span>
<a href="#l6.1832"></a><span id="l6.1832" class="difflineplus">+          if (this.mimePreferOpenPGP === 0 || (!this.autoPgpEncryption)) {</span>
<a href="#l6.1833"></a><span id="l6.1833" class="difflineplus">+            // S/MIME is preferred and encryption is possible</span>
<a href="#l6.1834"></a><span id="l6.1834" class="difflineplus">+            // or PGP/MIME is preferred but impossible</span>
<a href="#l6.1835"></a><span id="l6.1835" class="difflineplus">+            encryptSmime = true;</span>
<a href="#l6.1836"></a><span id="l6.1836" class="difflineplus">+          }</span>
<a href="#l6.1837"></a><span id="l6.1837" class="difflineplus">+        }</span>
<a href="#l6.1838"></a><span id="l6.1838" class="difflineplus">+      }</span>
<a href="#l6.1839"></a><span id="l6.1839" class="difflineplus">+    }</span>
<a href="#l6.1840"></a><span id="l6.1840" class="difflineplus">+</span>
<a href="#l6.1841"></a><span id="l6.1841" class="difflineplus">+    if (encryptSmime) {</span>
<a href="#l6.1842"></a><span id="l6.1842" class="difflineplus">+      if (this.pgpmimeForced === EnigmailConstants.ENIG_FORCE_SMIME) {</span>
<a href="#l6.1843"></a><span id="l6.1843" class="difflineplus">+        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_FORCESMIME;</span>
<a href="#l6.1844"></a><span id="l6.1844" class="difflineplus">+      }</span>
<a href="#l6.1845"></a><span id="l6.1845" class="difflineplus">+      else</span>
<a href="#l6.1846"></a><span id="l6.1846" class="difflineplus">+        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l6.1847"></a><span id="l6.1847" class="difflineplus">+</span>
<a href="#l6.1848"></a><span id="l6.1848" class="difflineplus">+      if (encFinally === EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.1849"></a><span id="l6.1849" class="difflineplus">+        encFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.1850"></a><span id="l6.1850" class="difflineplus">+        gSMFields.requireEncryptMessage = true;</span>
<a href="#l6.1851"></a><span id="l6.1851" class="difflineplus">+      }</span>
<a href="#l6.1852"></a><span id="l6.1852" class="difflineplus">+      if (signFinally === EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.1853"></a><span id="l6.1853" class="difflineplus">+        signFinally === EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.1854"></a><span id="l6.1854" class="difflineplus">+        gSMFields.signMessage = true;</span>
<a href="#l6.1855"></a><span id="l6.1855" class="difflineplus">+      }</span>
<a href="#l6.1856"></a><span id="l6.1856" class="difflineplus">+    }</span>
<a href="#l6.1857"></a><span id="l6.1857" class="difflineplus">+    else {</span>
<a href="#l6.1858"></a><span id="l6.1858" class="difflineplus">+      gSMFields.requireEncryptMessage = false;</span>
<a href="#l6.1859"></a><span id="l6.1859" class="difflineplus">+</span>
<a href="#l6.1860"></a><span id="l6.1860" class="difflineplus">+      if ((encFinally === EnigmailConstants.ENIG_FINAL_NO || encFinally === EnigmailConstants.ENIG_FINAL_FORCENO) &amp;&amp;</span>
<a href="#l6.1861"></a><span id="l6.1861" class="difflineplus">+        this.mimePreferOpenPGP === 0 &amp;&amp;</span>
<a href="#l6.1862"></a><span id="l6.1862" class="difflineplus">+        !(this.autoPgpEncryption &amp;&amp; autoSendEncrypted === 1) &amp;&amp;</span>
<a href="#l6.1863"></a><span id="l6.1863" class="difflineplus">+        (signFinally === EnigmailConstants.ENIG_FINAL_YES || signFinally === EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l6.1864"></a><span id="l6.1864" class="difflineplus">+        // S/MIME is preferred</span>
<a href="#l6.1865"></a><span id="l6.1865" class="difflineplus">+        this.statusPGPMime = EnigmailConstants.ENIG_FINAL_SMIME;</span>
<a href="#l6.1866"></a><span id="l6.1866" class="difflineplus">+        gSMFields.signMessage = true;</span>
<a href="#l6.1867"></a><span id="l6.1867" class="difflineplus">+      }</span>
<a href="#l6.1868"></a><span id="l6.1868" class="difflineplus">+      else {</span>
<a href="#l6.1869"></a><span id="l6.1869" class="difflineplus">+        gSMFields.signMessage = false;</span>
<a href="#l6.1870"></a><span id="l6.1870" class="difflineplus">+      }</span>
<a href="#l6.1871"></a><span id="l6.1871" class="difflineplus">+    }</span>
<a href="#l6.1872"></a><span id="l6.1872" class="difflineplus">+</span>
<a href="#l6.1873"></a><span id="l6.1873" class="difflineplus">+    return {</span>
<a href="#l6.1874"></a><span id="l6.1874" class="difflineplus">+      encFinally: encFinally,</span>
<a href="#l6.1875"></a><span id="l6.1875" class="difflineplus">+      signFinally: signFinally</span>
<a href="#l6.1876"></a><span id="l6.1876" class="difflineplus">+    };</span>
<a href="#l6.1877"></a><span id="l6.1877" class="difflineplus">+</span>
<a href="#l6.1878"></a><span id="l6.1878" class="difflineplus">+  },</span>
<a href="#l6.1879"></a><span id="l6.1879" class="difflineplus">+</span>
<a href="#l6.1880"></a><span id="l6.1880" class="difflineplus">+  // process icon/strings of status bar buttons and menu entries according to final encrypt/sign/pgpmime status</span>
<a href="#l6.1881"></a><span id="l6.1881" class="difflineplus">+  // - uses as INPUT:</span>
<a href="#l6.1882"></a><span id="l6.1882" class="difflineplus">+  //   - this.statusEncrypt, this.statusSign, this.statusPGPMime</span>
<a href="#l6.1883"></a><span id="l6.1883" class="difflineplus">+  // - uses as OUTPUT:</span>
<a href="#l6.1884"></a><span id="l6.1884" class="difflineplus">+  //   - resulting icon symbols</span>
<a href="#l6.1885"></a><span id="l6.1885" class="difflineplus">+  //   - this.statusEncryptStr, this.statusSignStr, this.statusPGPMimeStr, this.statusInlinePGPStr, this.statusAttachOwnKey</span>
<a href="#l6.1886"></a><span id="l6.1886" class="difflineplus">+  //   - this.statusSMimeStr</span>
<a href="#l6.1887"></a><span id="l6.1887" class="difflineplus">+  updateStatusBar: function() {</span>
<a href="#l6.1888"></a><span id="l6.1888" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.updateStatusBar()\n&quot;);</span>
<a href="#l6.1889"></a><span id="l6.1889" class="difflineplus">+    this.statusEncryptedInStatusBar = this.statusEncrypted; // to double check broken promise for encryption</span>
<a href="#l6.1890"></a><span id="l6.1890" class="difflineplus">+</span>
<a href="#l6.1891"></a><span id="l6.1891" class="difflineplus">+    if (!this.identity) {</span>
<a href="#l6.1892"></a><span id="l6.1892" class="difflineplus">+      this.identity = getCurrentIdentity();</span>
<a href="#l6.1893"></a><span id="l6.1893" class="difflineplus">+    }</span>
<a href="#l6.1894"></a><span id="l6.1894" class="difflineplus">+</span>
<a href="#l6.1895"></a><span id="l6.1895" class="difflineplus">+    var toolbarTxt = document.getElementById(&quot;enigmail-toolbar-text&quot;);</span>
<a href="#l6.1896"></a><span id="l6.1896" class="difflineplus">+    var encBroadcaster = document.getElementById(&quot;enigmail-bc-encrypt&quot;);</span>
<a href="#l6.1897"></a><span id="l6.1897" class="difflineplus">+    var signBroadcaster = document.getElementById(&quot;enigmail-bc-sign&quot;);</span>
<a href="#l6.1898"></a><span id="l6.1898" class="difflineplus">+    var attachBroadcaster = document.getElementById(&quot;enigmail-bc-attach&quot;);</span>
<a href="#l6.1899"></a><span id="l6.1899" class="difflineplus">+</span>
<a href="#l6.1900"></a><span id="l6.1900" class="difflineplus">+    let enc = this.getEncryptionEnabled();</span>
<a href="#l6.1901"></a><span id="l6.1901" class="difflineplus">+    let sign = this.getSigningEnabled();</span>
<a href="#l6.1902"></a><span id="l6.1902" class="difflineplus">+    // enigmail disabled for this identity?:</span>
<a href="#l6.1903"></a><span id="l6.1903" class="difflineplus">+    if (!enc) {</span>
<a href="#l6.1904"></a><span id="l6.1904" class="difflineplus">+      // hide icons if enigmail not enabled</span>
<a href="#l6.1905"></a><span id="l6.1905" class="difflineplus">+      encBroadcaster.removeAttribute(&quot;encrypted&quot;);</span>
<a href="#l6.1906"></a><span id="l6.1906" class="difflineplus">+      encBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1907"></a><span id="l6.1907" class="difflineplus">+    }</span>
<a href="#l6.1908"></a><span id="l6.1908" class="difflineplus">+    else {</span>
<a href="#l6.1909"></a><span id="l6.1909" class="difflineplus">+      encBroadcaster.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.1910"></a><span id="l6.1910" class="difflineplus">+    }</span>
<a href="#l6.1911"></a><span id="l6.1911" class="difflineplus">+</span>
<a href="#l6.1912"></a><span id="l6.1912" class="difflineplus">+    if (!sign) {</span>
<a href="#l6.1913"></a><span id="l6.1913" class="difflineplus">+      signBroadcaster.removeAttribute(&quot;signed&quot;);</span>
<a href="#l6.1914"></a><span id="l6.1914" class="difflineplus">+      signBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1915"></a><span id="l6.1915" class="difflineplus">+      attachBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1916"></a><span id="l6.1916" class="difflineplus">+    }</span>
<a href="#l6.1917"></a><span id="l6.1917" class="difflineplus">+    else {</span>
<a href="#l6.1918"></a><span id="l6.1918" class="difflineplus">+      signBroadcaster.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.1919"></a><span id="l6.1919" class="difflineplus">+      attachBroadcaster.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.1920"></a><span id="l6.1920" class="difflineplus">+    }</span>
<a href="#l6.1921"></a><span id="l6.1921" class="difflineplus">+</span>
<a href="#l6.1922"></a><span id="l6.1922" class="difflineplus">+    if (!(enc || sign)) {</span>
<a href="#l6.1923"></a><span id="l6.1923" class="difflineplus">+      if (toolbarTxt) {</span>
<a href="#l6.1924"></a><span id="l6.1924" class="difflineplus">+        toolbarTxt.value = EnigmailLocale.getString(&quot;msgCompose.toolbarTxt.disabled&quot;);</span>
<a href="#l6.1925"></a><span id="l6.1925" class="difflineplus">+        toolbarTxt.removeAttribute(&quot;class&quot;);</span>
<a href="#l6.1926"></a><span id="l6.1926" class="difflineplus">+      }</span>
<a href="#l6.1927"></a><span id="l6.1927" class="difflineplus">+      return;</span>
<a href="#l6.1928"></a><span id="l6.1928" class="difflineplus">+    }</span>
<a href="#l6.1929"></a><span id="l6.1929" class="difflineplus">+</span>
<a href="#l6.1930"></a><span id="l6.1930" class="difflineplus">+    // process resulting icon symbol and status strings for encrypt mode</span>
<a href="#l6.1931"></a><span id="l6.1931" class="difflineplus">+    var encSymbol = null;</span>
<a href="#l6.1932"></a><span id="l6.1932" class="difflineplus">+    var doEncrypt = false;</span>
<a href="#l6.1933"></a><span id="l6.1933" class="difflineplus">+    var encStr = null;</span>
<a href="#l6.1934"></a><span id="l6.1934" class="difflineplus">+    switch (this.statusEncrypted) {</span>
<a href="#l6.1935"></a><span id="l6.1935" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1936"></a><span id="l6.1936" class="difflineplus">+        encSymbol = &quot;forceNo&quot;;</span>
<a href="#l6.1937"></a><span id="l6.1937" class="difflineplus">+        encStr = EnigmailLocale.getString(&quot;encryptMessageNorm&quot;);</span>
<a href="#l6.1938"></a><span id="l6.1938" class="difflineplus">+        break;</span>
<a href="#l6.1939"></a><span id="l6.1939" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1940"></a><span id="l6.1940" class="difflineplus">+        doEncrypt = true;</span>
<a href="#l6.1941"></a><span id="l6.1941" class="difflineplus">+        encSymbol = &quot;forceYes&quot;;</span>
<a href="#l6.1942"></a><span id="l6.1942" class="difflineplus">+        encStr = EnigmailLocale.getString(&quot;encryptMessageNorm&quot;);</span>
<a href="#l6.1943"></a><span id="l6.1943" class="difflineplus">+        break;</span>
<a href="#l6.1944"></a><span id="l6.1944" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.1945"></a><span id="l6.1945" class="difflineplus">+        encSymbol = &quot;inactiveNone&quot;;</span>
<a href="#l6.1946"></a><span id="l6.1946" class="difflineplus">+        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l6.1947"></a><span id="l6.1947" class="difflineplus">+        break;</span>
<a href="#l6.1948"></a><span id="l6.1948" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.1949"></a><span id="l6.1949" class="difflineplus">+        doEncrypt = true;</span>
<a href="#l6.1950"></a><span id="l6.1950" class="difflineplus">+        encSymbol = &quot;forceYes&quot;;</span>
<a href="#l6.1951"></a><span id="l6.1951" class="difflineplus">+        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l6.1952"></a><span id="l6.1952" class="difflineplus">+        break;</span>
<a href="#l6.1953"></a><span id="l6.1953" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.1954"></a><span id="l6.1954" class="difflineplus">+        encSymbol = &quot;inactiveConflict&quot;;</span>
<a href="#l6.1955"></a><span id="l6.1955" class="difflineplus">+        encStr = EnigmailLocale.getString(&quot;encryptMessageAuto&quot;);</span>
<a href="#l6.1956"></a><span id="l6.1956" class="difflineplus">+        break;</span>
<a href="#l6.1957"></a><span id="l6.1957" class="difflineplus">+    }</span>
<a href="#l6.1958"></a><span id="l6.1958" class="difflineplus">+    var encReasonStr = null;</span>
<a href="#l6.1959"></a><span id="l6.1959" class="difflineplus">+    if (doEncrypt) {</span>
<a href="#l6.1960"></a><span id="l6.1960" class="difflineplus">+      if (this.reasonEncrypted &amp;&amp; this.reasonEncrypted !== &quot;&quot;) {</span>
<a href="#l6.1961"></a><span id="l6.1961" class="difflineplus">+        encReasonStr = EnigmailLocale.getString(&quot;encryptOnWithReason&quot;, [this.reasonEncrypted]);</span>
<a href="#l6.1962"></a><span id="l6.1962" class="difflineplus">+      }</span>
<a href="#l6.1963"></a><span id="l6.1963" class="difflineplus">+      else {</span>
<a href="#l6.1964"></a><span id="l6.1964" class="difflineplus">+        encReasonStr = EnigmailLocale.getString(&quot;encryptOn&quot;);</span>
<a href="#l6.1965"></a><span id="l6.1965" class="difflineplus">+      }</span>
<a href="#l6.1966"></a><span id="l6.1966" class="difflineplus">+    }</span>
<a href="#l6.1967"></a><span id="l6.1967" class="difflineplus">+    else {</span>
<a href="#l6.1968"></a><span id="l6.1968" class="difflineplus">+      if (this.reasonEncrypted &amp;&amp; this.reasonEncrypted !== &quot;&quot;) {</span>
<a href="#l6.1969"></a><span id="l6.1969" class="difflineplus">+        encReasonStr = EnigmailLocale.getString(&quot;encryptOffWithReason&quot;, [this.reasonEncrypted]);</span>
<a href="#l6.1970"></a><span id="l6.1970" class="difflineplus">+      }</span>
<a href="#l6.1971"></a><span id="l6.1971" class="difflineplus">+      else {</span>
<a href="#l6.1972"></a><span id="l6.1972" class="difflineplus">+        encReasonStr = EnigmailLocale.getString(&quot;encryptOff&quot;);</span>
<a href="#l6.1973"></a><span id="l6.1973" class="difflineplus">+      }</span>
<a href="#l6.1974"></a><span id="l6.1974" class="difflineplus">+    }</span>
<a href="#l6.1975"></a><span id="l6.1975" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   encSymbol=&quot; + encSymbol + &quot;  encReasonStr=&quot; + encReasonStr + &quot;\n&quot;);</span>
<a href="#l6.1976"></a><span id="l6.1976" class="difflineplus">+</span>
<a href="#l6.1977"></a><span id="l6.1977" class="difflineplus">+    // update encrypt icon and tooltip/menu-text</span>
<a href="#l6.1978"></a><span id="l6.1978" class="difflineplus">+    encBroadcaster.setAttribute(&quot;encrypted&quot;, encSymbol);</span>
<a href="#l6.1979"></a><span id="l6.1979" class="difflineplus">+    var encIcon = document.getElementById(&quot;button-enigmail-encrypt&quot;);</span>
<a href="#l6.1980"></a><span id="l6.1980" class="difflineplus">+    if (encIcon) {</span>
<a href="#l6.1981"></a><span id="l6.1981" class="difflineplus">+      encIcon.setAttribute(&quot;tooltiptext&quot;, encReasonStr);</span>
<a href="#l6.1982"></a><span id="l6.1982" class="difflineplus">+    }</span>
<a href="#l6.1983"></a><span id="l6.1983" class="difflineplus">+    this.statusEncryptedStr = encStr;</span>
<a href="#l6.1984"></a><span id="l6.1984" class="difflineplus">+    this.setChecked(&quot;enigmail-bc-encrypt&quot;, doEncrypt);</span>
<a href="#l6.1985"></a><span id="l6.1985" class="difflineplus">+</span>
<a href="#l6.1986"></a><span id="l6.1986" class="difflineplus">+    // process resulting icon symbol for sign mode</span>
<a href="#l6.1987"></a><span id="l6.1987" class="difflineplus">+    var signSymbol = null;</span>
<a href="#l6.1988"></a><span id="l6.1988" class="difflineplus">+    var doSign = false;</span>
<a href="#l6.1989"></a><span id="l6.1989" class="difflineplus">+    var signStr = &quot;&quot;;</span>
<a href="#l6.1990"></a><span id="l6.1990" class="difflineplus">+    switch (this.statusSigned) {</span>
<a href="#l6.1991"></a><span id="l6.1991" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.1992"></a><span id="l6.1992" class="difflineplus">+        signSymbol = &quot;forceNo&quot;;</span>
<a href="#l6.1993"></a><span id="l6.1993" class="difflineplus">+        signStr = EnigmailLocale.getString(&quot;signMessageNorm&quot;);</span>
<a href="#l6.1994"></a><span id="l6.1994" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.1995"></a><span id="l6.1995" class="difflineplus">+        break;</span>
<a href="#l6.1996"></a><span id="l6.1996" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.1997"></a><span id="l6.1997" class="difflineplus">+        doSign = true;</span>
<a href="#l6.1998"></a><span id="l6.1998" class="difflineplus">+        signSymbol = &quot;forceYes&quot;;</span>
<a href="#l6.1999"></a><span id="l6.1999" class="difflineplus">+        signStr = EnigmailLocale.getString(&quot;signMessageNorm&quot;);</span>
<a href="#l6.2000"></a><span id="l6.2000" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2001"></a><span id="l6.2001" class="difflineplus">+        break;</span>
<a href="#l6.2002"></a><span id="l6.2002" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.2003"></a><span id="l6.2003" class="difflineplus">+        signSymbol = &quot;inactiveNone&quot;;</span>
<a href="#l6.2004"></a><span id="l6.2004" class="difflineplus">+        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l6.2005"></a><span id="l6.2005" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2006"></a><span id="l6.2006" class="difflineplus">+        break;</span>
<a href="#l6.2007"></a><span id="l6.2007" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2008"></a><span id="l6.2008" class="difflineplus">+        doSign = true;</span>
<a href="#l6.2009"></a><span id="l6.2009" class="difflineplus">+        signSymbol = &quot;forceYes&quot;;</span>
<a href="#l6.2010"></a><span id="l6.2010" class="difflineplus">+        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l6.2011"></a><span id="l6.2011" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2012"></a><span id="l6.2012" class="difflineplus">+        break;</span>
<a href="#l6.2013"></a><span id="l6.2013" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.2014"></a><span id="l6.2014" class="difflineplus">+        signSymbol = &quot;inactiveConflict&quot;;</span>
<a href="#l6.2015"></a><span id="l6.2015" class="difflineplus">+        signStr = EnigmailLocale.getString(&quot;signMessageAuto&quot;);</span>
<a href="#l6.2016"></a><span id="l6.2016" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2017"></a><span id="l6.2017" class="difflineplus">+        break;</span>
<a href="#l6.2018"></a><span id="l6.2018" class="difflineplus">+    }</span>
<a href="#l6.2019"></a><span id="l6.2019" class="difflineplus">+    var signReasonStr = null;</span>
<a href="#l6.2020"></a><span id="l6.2020" class="difflineplus">+    if (doSign) {</span>
<a href="#l6.2021"></a><span id="l6.2021" class="difflineplus">+      if (this.reasonSigned &amp;&amp; this.reasonSigned !== &quot;&quot;) {</span>
<a href="#l6.2022"></a><span id="l6.2022" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOnWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2023"></a><span id="l6.2023" class="difflineplus">+      }</span>
<a href="#l6.2024"></a><span id="l6.2024" class="difflineplus">+      else {</span>
<a href="#l6.2025"></a><span id="l6.2025" class="difflineplus">+        signReasonStr = signStr;</span>
<a href="#l6.2026"></a><span id="l6.2026" class="difflineplus">+      }</span>
<a href="#l6.2027"></a><span id="l6.2027" class="difflineplus">+    }</span>
<a href="#l6.2028"></a><span id="l6.2028" class="difflineplus">+    else {</span>
<a href="#l6.2029"></a><span id="l6.2029" class="difflineplus">+      if (this.reasonSigned &amp;&amp; this.reasonSigned !== &quot;&quot;) {</span>
<a href="#l6.2030"></a><span id="l6.2030" class="difflineplus">+        signReasonStr = EnigmailLocale.getString(&quot;signOffWithReason&quot;, [this.reasonSigned]);</span>
<a href="#l6.2031"></a><span id="l6.2031" class="difflineplus">+      }</span>
<a href="#l6.2032"></a><span id="l6.2032" class="difflineplus">+      else {</span>
<a href="#l6.2033"></a><span id="l6.2033" class="difflineplus">+        signReasonStr = signStr;</span>
<a href="#l6.2034"></a><span id="l6.2034" class="difflineplus">+      }</span>
<a href="#l6.2035"></a><span id="l6.2035" class="difflineplus">+    }</span>
<a href="#l6.2036"></a><span id="l6.2036" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js:   signSymbol=&quot; + signSymbol + &quot;  signReasonStr=&quot; + signReasonStr + &quot;\n&quot;);</span>
<a href="#l6.2037"></a><span id="l6.2037" class="difflineplus">+</span>
<a href="#l6.2038"></a><span id="l6.2038" class="difflineplus">+    // update sign icon and tooltip/menu-text</span>
<a href="#l6.2039"></a><span id="l6.2039" class="difflineplus">+    signBroadcaster.setAttribute(&quot;signed&quot;, signSymbol);</span>
<a href="#l6.2040"></a><span id="l6.2040" class="difflineplus">+    var signIcon = document.getElementById(&quot;button-enigmail-sign&quot;);</span>
<a href="#l6.2041"></a><span id="l6.2041" class="difflineplus">+    if (signIcon) {</span>
<a href="#l6.2042"></a><span id="l6.2042" class="difflineplus">+      signIcon.setAttribute(&quot;tooltiptext&quot;, signReasonStr);</span>
<a href="#l6.2043"></a><span id="l6.2043" class="difflineplus">+    }</span>
<a href="#l6.2044"></a><span id="l6.2044" class="difflineplus">+    this.statusSignedStr = signStr;</span>
<a href="#l6.2045"></a><span id="l6.2045" class="difflineplus">+    this.setChecked(&quot;enigmail-bc-sign&quot;, doSign);</span>
<a href="#l6.2046"></a><span id="l6.2046" class="difflineplus">+</span>
<a href="#l6.2047"></a><span id="l6.2047" class="difflineplus">+    // process resulting toolbar message</span>
<a href="#l6.2048"></a><span id="l6.2048" class="difflineplus">+    var toolbarMsg = &quot;&quot;;</span>
<a href="#l6.2049"></a><span id="l6.2049" class="difflineplus">+    if (doSign &amp;&amp; doEncrypt) {</span>
<a href="#l6.2050"></a><span id="l6.2050" class="difflineplus">+      toolbarMsg = EnigmailLocale.getString(&quot;msgCompose.toolbarTxt.signAndEncrypt&quot;);</span>
<a href="#l6.2051"></a><span id="l6.2051" class="difflineplus">+    }</span>
<a href="#l6.2052"></a><span id="l6.2052" class="difflineplus">+    else if (doSign) {</span>
<a href="#l6.2053"></a><span id="l6.2053" class="difflineplus">+      toolbarMsg = EnigmailLocale.getString(&quot;msgCompose.toolbarTxt.signOnly&quot;);</span>
<a href="#l6.2054"></a><span id="l6.2054" class="difflineplus">+    }</span>
<a href="#l6.2055"></a><span id="l6.2055" class="difflineplus">+    else if (doEncrypt) {</span>
<a href="#l6.2056"></a><span id="l6.2056" class="difflineplus">+      toolbarMsg = EnigmailLocale.getString(&quot;msgCompose.toolbarTxt.encryptOnly&quot;);</span>
<a href="#l6.2057"></a><span id="l6.2057" class="difflineplus">+    }</span>
<a href="#l6.2058"></a><span id="l6.2058" class="difflineplus">+    else {</span>
<a href="#l6.2059"></a><span id="l6.2059" class="difflineplus">+      toolbarMsg = EnigmailLocale.getString(&quot;msgCompose.toolbarTxt.noEncryption&quot;);</span>
<a href="#l6.2060"></a><span id="l6.2060" class="difflineplus">+    }</span>
<a href="#l6.2061"></a><span id="l6.2061" class="difflineplus">+</span>
<a href="#l6.2062"></a><span id="l6.2062" class="difflineplus">+    if (toolbarTxt) {</span>
<a href="#l6.2063"></a><span id="l6.2063" class="difflineplus">+      toolbarTxt.value = toolbarMsg;</span>
<a href="#l6.2064"></a><span id="l6.2064" class="difflineplus">+</span>
<a href="#l6.2065"></a><span id="l6.2065" class="difflineplus">+      if (Enigmail.msg.getSecurityParams()) {</span>
<a href="#l6.2066"></a><span id="l6.2066" class="difflineplus">+        let si = Enigmail.msg.getSecurityParams(null, true);</span>
<a href="#l6.2067"></a><span id="l6.2067" class="difflineplus">+        let isSmime = !EnigmailMimeEncrypt.isEnigmailCompField(si);</span>
<a href="#l6.2068"></a><span id="l6.2068" class="difflineplus">+</span>
<a href="#l6.2069"></a><span id="l6.2069" class="difflineplus">+        if (!doSign &amp;&amp; !doEncrypt &amp;&amp;</span>
<a href="#l6.2070"></a><span id="l6.2070" class="difflineplus">+          !(isSmime &amp;&amp;</span>
<a href="#l6.2071"></a><span id="l6.2071" class="difflineplus">+            (si.signMessage || si.requireEncryptMessage))) {</span>
<a href="#l6.2072"></a><span id="l6.2072" class="difflineplus">+          toolbarTxt.setAttribute(&quot;class&quot;, &quot;enigmailStrong&quot;);</span>
<a href="#l6.2073"></a><span id="l6.2073" class="difflineplus">+        }</span>
<a href="#l6.2074"></a><span id="l6.2074" class="difflineplus">+        else {</span>
<a href="#l6.2075"></a><span id="l6.2075" class="difflineplus">+          toolbarTxt.removeAttribute(&quot;class&quot;);</span>
<a href="#l6.2076"></a><span id="l6.2076" class="difflineplus">+        }</span>
<a href="#l6.2077"></a><span id="l6.2077" class="difflineplus">+      }</span>
<a href="#l6.2078"></a><span id="l6.2078" class="difflineplus">+      else {</span>
<a href="#l6.2079"></a><span id="l6.2079" class="difflineplus">+        toolbarTxt.removeAttribute(&quot;class&quot;);</span>
<a href="#l6.2080"></a><span id="l6.2080" class="difflineplus">+      }</span>
<a href="#l6.2081"></a><span id="l6.2081" class="difflineplus">+    }</span>
<a href="#l6.2082"></a><span id="l6.2082" class="difflineplus">+</span>
<a href="#l6.2083"></a><span id="l6.2083" class="difflineplus">+    // update pgp mime/inline PGP menu-text</span>
<a href="#l6.2084"></a><span id="l6.2084" class="difflineplus">+    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_YES) {</span>
<a href="#l6.2085"></a><span id="l6.2085" class="difflineplus">+      this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeAuto&quot;);</span>
<a href="#l6.2086"></a><span id="l6.2086" class="difflineplus">+    }</span>
<a href="#l6.2087"></a><span id="l6.2087" class="difflineplus">+    else {</span>
<a href="#l6.2088"></a><span id="l6.2088" class="difflineplus">+      this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l6.2089"></a><span id="l6.2089" class="difflineplus">+    }</span>
<a href="#l6.2090"></a><span id="l6.2090" class="difflineplus">+</span>
<a href="#l6.2091"></a><span id="l6.2091" class="difflineplus">+    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_NO) {</span>
<a href="#l6.2092"></a><span id="l6.2092" class="difflineplus">+      this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPAuto&quot;);</span>
<a href="#l6.2093"></a><span id="l6.2093" class="difflineplus">+    }</span>
<a href="#l6.2094"></a><span id="l6.2094" class="difflineplus">+    else {</span>
<a href="#l6.2095"></a><span id="l6.2095" class="difflineplus">+      this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l6.2096"></a><span id="l6.2096" class="difflineplus">+    }</span>
<a href="#l6.2097"></a><span id="l6.2097" class="difflineplus">+</span>
<a href="#l6.2098"></a><span id="l6.2098" class="difflineplus">+    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_SMIME) {</span>
<a href="#l6.2099"></a><span id="l6.2099" class="difflineplus">+      this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeAuto&quot;);</span>
<a href="#l6.2100"></a><span id="l6.2100" class="difflineplus">+    }</span>
<a href="#l6.2101"></a><span id="l6.2101" class="difflineplus">+    else {</span>
<a href="#l6.2102"></a><span id="l6.2102" class="difflineplus">+      this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l6.2103"></a><span id="l6.2103" class="difflineplus">+    }</span>
<a href="#l6.2104"></a><span id="l6.2104" class="difflineplus">+</span>
<a href="#l6.2105"></a><span id="l6.2105" class="difflineplus">+    this.displaySMimeToolbar();</span>
<a href="#l6.2106"></a><span id="l6.2106" class="difflineplus">+</span>
<a href="#l6.2107"></a><span id="l6.2107" class="difflineplus">+    if (this.allowAttachOwnKey() === 1) {</span>
<a href="#l6.2108"></a><span id="l6.2108" class="difflineplus">+      attachBroadcaster.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2109"></a><span id="l6.2109" class="difflineplus">+    }</span>
<a href="#l6.2110"></a><span id="l6.2110" class="difflineplus">+    else {</span>
<a href="#l6.2111"></a><span id="l6.2111" class="difflineplus">+      attachBroadcaster.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2112"></a><span id="l6.2112" class="difflineplus">+    }</span>
<a href="#l6.2113"></a><span id="l6.2113" class="difflineplus">+</span>
<a href="#l6.2114"></a><span id="l6.2114" class="difflineplus">+  },</span>
<a href="#l6.2115"></a><span id="l6.2115" class="difflineplus">+</span>
<a href="#l6.2116"></a><span id="l6.2116" class="difflineplus">+</span>
<a href="#l6.2117"></a><span id="l6.2117" class="difflineplus">+  displaySMimeToolbar: function() {</span>
<a href="#l6.2118"></a><span id="l6.2118" class="difflineplus">+    let s = document.getElementById(&quot;signing-status&quot;);</span>
<a href="#l6.2119"></a><span id="l6.2119" class="difflineplus">+    let e = document.getElementById(&quot;encryption-status&quot;);</span>
<a href="#l6.2120"></a><span id="l6.2120" class="difflineplus">+</span>
<a href="#l6.2121"></a><span id="l6.2121" class="difflineplus">+    switch (this.statusPGPMime) {</span>
<a href="#l6.2122"></a><span id="l6.2122" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l6.2123"></a><span id="l6.2123" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l6.2124"></a><span id="l6.2124" class="difflineplus">+        if (s) s.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.2125"></a><span id="l6.2125" class="difflineplus">+        if (e) e.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l6.2126"></a><span id="l6.2126" class="difflineplus">+        break;</span>
<a href="#l6.2127"></a><span id="l6.2127" class="difflineplus">+      default:</span>
<a href="#l6.2128"></a><span id="l6.2128" class="difflineplus">+        if (s) s.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l6.2129"></a><span id="l6.2129" class="difflineplus">+        if (e) e.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l6.2130"></a><span id="l6.2130" class="difflineplus">+    }</span>
<a href="#l6.2131"></a><span id="l6.2131" class="difflineplus">+  },</span>
<a href="#l6.2132"></a><span id="l6.2132" class="difflineplus">+</span>
<a href="#l6.2133"></a><span id="l6.2133" class="difflineplus">+  /**</span>
<a href="#l6.2134"></a><span id="l6.2134" class="difflineplus">+   * determine if own key may be attached.</span>
<a href="#l6.2135"></a><span id="l6.2135" class="difflineplus">+   * @result: Number:</span>
<a href="#l6.2136"></a><span id="l6.2136" class="difflineplus">+   *          -1: account not enabled for Enigmail</span>
<a href="#l6.2137"></a><span id="l6.2137" class="difflineplus">+   *           0: account enabled but key mode set to &quot;by Email address&quot;</span>
<a href="#l6.2138"></a><span id="l6.2138" class="difflineplus">+   *           1: account enabled; key specified</span>
<a href="#l6.2139"></a><span id="l6.2139" class="difflineplus">+   */</span>
<a href="#l6.2140"></a><span id="l6.2140" class="difflineplus">+  allowAttachOwnKey: function() {</span>
<a href="#l6.2141"></a><span id="l6.2141" class="difflineplus">+</span>
<a href="#l6.2142"></a><span id="l6.2142" class="difflineplus">+    let allow = -1;</span>
<a href="#l6.2143"></a><span id="l6.2143" class="difflineplus">+</span>
<a href="#l6.2144"></a><span id="l6.2144" class="difflineplus">+    if (this.isEnigmailEnabled()) {</span>
<a href="#l6.2145"></a><span id="l6.2145" class="difflineplus">+      allow = 0;</span>
<a href="#l6.2146"></a><span id="l6.2146" class="difflineplus">+      if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l6.2147"></a><span id="l6.2147" class="difflineplus">+        let keyIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l6.2148"></a><span id="l6.2148" class="difflineplus">+        if (keyIdValue.search(/^ *(0x)?[0-9a-fA-F]* *$/) === 0) {</span>
<a href="#l6.2149"></a><span id="l6.2149" class="difflineplus">+          allow = 1;</span>
<a href="#l6.2150"></a><span id="l6.2150" class="difflineplus">+        }</span>
<a href="#l6.2151"></a><span id="l6.2151" class="difflineplus">+      }</span>
<a href="#l6.2152"></a><span id="l6.2152" class="difflineplus">+    }</span>
<a href="#l6.2153"></a><span id="l6.2153" class="difflineplus">+</span>
<a href="#l6.2154"></a><span id="l6.2154" class="difflineplus">+    return allow;</span>
<a href="#l6.2155"></a><span id="l6.2155" class="difflineplus">+  },</span>
<a href="#l6.2156"></a><span id="l6.2156" class="difflineplus">+</span>
<a href="#l6.2157"></a><span id="l6.2157" class="difflineplus">+  /* compute whether to sign/encrypt according to current rules and sendMode</span>
<a href="#l6.2158"></a><span id="l6.2158" class="difflineplus">+   * - without any interaction, just to process resulting status bar icons</span>
<a href="#l6.2159"></a><span id="l6.2159" class="difflineplus">+   */</span>
<a href="#l6.2160"></a><span id="l6.2160" class="difflineplus">+  determineSendFlags: function() {</span>
<a href="#l6.2161"></a><span id="l6.2161" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.focusChange: Enigmail.msg.determineSendFlags\n&quot;);</span>
<a href="#l6.2162"></a><span id="l6.2162" class="difflineplus">+</span>
<a href="#l6.2163"></a><span id="l6.2163" class="difflineplus">+    let detailsObj = {};</span>
<a href="#l6.2164"></a><span id="l6.2164" class="difflineplus">+</span>
<a href="#l6.2165"></a><span id="l6.2165" class="difflineplus">+    this.statusEncryptedInStatusBar = null; // to double check broken promise for encryption</span>
<a href="#l6.2166"></a><span id="l6.2166" class="difflineplus">+</span>
<a href="#l6.2167"></a><span id="l6.2167" class="difflineplus">+    if (!this.identity) {</span>
<a href="#l6.2168"></a><span id="l6.2168" class="difflineplus">+      this.identity = getCurrentIdentity();</span>
<a href="#l6.2169"></a><span id="l6.2169" class="difflineplus">+    }</span>
<a href="#l6.2170"></a><span id="l6.2170" class="difflineplus">+</span>
<a href="#l6.2171"></a><span id="l6.2171" class="difflineplus">+    var compFields = gMsgCompose.compFields;</span>
<a href="#l6.2172"></a><span id="l6.2172" class="difflineplus">+</span>
<a href="#l6.2173"></a><span id="l6.2173" class="difflineplus">+    if (!Enigmail.msg.composeBodyReady) {</span>
<a href="#l6.2174"></a><span id="l6.2174" class="difflineplus">+      compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l6.2175"></a><span id="l6.2175" class="difflineplus">+    }</span>
<a href="#l6.2176"></a><span id="l6.2176" class="difflineplus">+    Recipients2CompFields(compFields);</span>
<a href="#l6.2177"></a><span id="l6.2177" class="difflineplus">+    gMsgCompose.expandMailingLists();</span>
<a href="#l6.2178"></a><span id="l6.2178" class="difflineplus">+</span>
<a href="#l6.2179"></a><span id="l6.2179" class="difflineplus">+    if (this.isEnigmailEnabled()) {</span>
<a href="#l6.2180"></a><span id="l6.2180" class="difflineplus">+      // process list of to/cc email addresses</span>
<a href="#l6.2181"></a><span id="l6.2181" class="difflineplus">+      // - bcc email addresses are ignored, when processing whether to sign/encrypt</span>
<a href="#l6.2182"></a><span id="l6.2182" class="difflineplus">+      var toAddrList = [];</span>
<a href="#l6.2183"></a><span id="l6.2183" class="difflineplus">+      var arrLen = {};</span>
<a href="#l6.2184"></a><span id="l6.2184" class="difflineplus">+      var recList;</span>
<a href="#l6.2185"></a><span id="l6.2185" class="difflineplus">+      if (compFields.to.length &gt; 0) {</span>
<a href="#l6.2186"></a><span id="l6.2186" class="difflineplus">+        recList = compFields.splitRecipients(compFields.to, true, arrLen);</span>
<a href="#l6.2187"></a><span id="l6.2187" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l6.2188"></a><span id="l6.2188" class="difflineplus">+      }</span>
<a href="#l6.2189"></a><span id="l6.2189" class="difflineplus">+      if (compFields.cc.length &gt; 0) {</span>
<a href="#l6.2190"></a><span id="l6.2190" class="difflineplus">+        recList = compFields.splitRecipients(compFields.cc, true, arrLen);</span>
<a href="#l6.2191"></a><span id="l6.2191" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l6.2192"></a><span id="l6.2192" class="difflineplus">+      }</span>
<a href="#l6.2193"></a><span id="l6.2193" class="difflineplus">+</span>
<a href="#l6.2194"></a><span id="l6.2194" class="difflineplus">+      this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2195"></a><span id="l6.2195" class="difflineplus">+      this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2196"></a><span id="l6.2196" class="difflineplus">+      this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2197"></a><span id="l6.2197" class="difflineplus">+</span>
<a href="#l6.2198"></a><span id="l6.2198" class="difflineplus">+      // process rules</span>
<a href="#l6.2199"></a><span id="l6.2199" class="difflineplus">+      if (toAddrList.length &gt; 0 &amp;&amp; EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;)) {</span>
<a href="#l6.2200"></a><span id="l6.2200" class="difflineplus">+        var matchedKeysObj = {};</span>
<a href="#l6.2201"></a><span id="l6.2201" class="difflineplus">+        var flagsObj = {};</span>
<a href="#l6.2202"></a><span id="l6.2202" class="difflineplus">+        if (EnigmailRules.mapAddrsToKeys(toAddrList.join(&quot;, &quot;),</span>
<a href="#l6.2203"></a><span id="l6.2203" class="difflineplus">+            false, // no interaction if not all addrs have a key</span>
<a href="#l6.2204"></a><span id="l6.2204" class="difflineplus">+            window,</span>
<a href="#l6.2205"></a><span id="l6.2205" class="difflineplus">+            matchedKeysObj, // resulting matching keys</span>
<a href="#l6.2206"></a><span id="l6.2206" class="difflineplus">+            flagsObj)) { // resulting flags (0/1/2/3 for each type)</span>
<a href="#l6.2207"></a><span id="l6.2207" class="difflineplus">+          this.encryptByRules = flagsObj.encrypt;</span>
<a href="#l6.2208"></a><span id="l6.2208" class="difflineplus">+          this.signByRules = flagsObj.sign;</span>
<a href="#l6.2209"></a><span id="l6.2209" class="difflineplus">+          this.pgpmimeByRules = flagsObj.pgpMime;</span>
<a href="#l6.2210"></a><span id="l6.2210" class="difflineplus">+</span>
<a href="#l6.2211"></a><span id="l6.2211" class="difflineplus">+          if (matchedKeysObj.value &amp;&amp; matchedKeysObj.value.length &gt; 0) {</span>
<a href="#l6.2212"></a><span id="l6.2212" class="difflineplus">+            // replace addresses with results from rules</span>
<a href="#l6.2213"></a><span id="l6.2213" class="difflineplus">+            toAddrList = matchedKeysObj.value.split(&quot;, &quot;);</span>
<a href="#l6.2214"></a><span id="l6.2214" class="difflineplus">+          }</span>
<a href="#l6.2215"></a><span id="l6.2215" class="difflineplus">+        }</span>
<a href="#l6.2216"></a><span id="l6.2216" class="difflineplus">+      }</span>
<a href="#l6.2217"></a><span id="l6.2217" class="difflineplus">+</span>
<a href="#l6.2218"></a><span id="l6.2218" class="difflineplus">+      let validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrList.join(&quot;, &quot;), detailsObj);</span>
<a href="#l6.2219"></a><span id="l6.2219" class="difflineplus">+</span>
<a href="#l6.2220"></a><span id="l6.2220" class="difflineplus">+      this.autoPgpEncryption = (validKeyList !== null);</span>
<a href="#l6.2221"></a><span id="l6.2221" class="difflineplus">+</span>
<a href="#l6.2222"></a><span id="l6.2222" class="difflineplus">+      // if not clear whether to encrypt yet, check whether automatically-send-encrypted applies</span>
<a href="#l6.2223"></a><span id="l6.2223" class="difflineplus">+      if (toAddrList.length &gt; 0 &amp;&amp; this.encryptByRules == EnigmailConstants.ENIG_UNDEF &amp;&amp; EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;) == 1) {</span>
<a href="#l6.2224"></a><span id="l6.2224" class="difflineplus">+        if (validKeyList) {</span>
<a href="#l6.2225"></a><span id="l6.2225" class="difflineplus">+          this.encryptByRules = EnigmailConstants.ENIG_AUTO_ALWAYS;</span>
<a href="#l6.2226"></a><span id="l6.2226" class="difflineplus">+        }</span>
<a href="#l6.2227"></a><span id="l6.2227" class="difflineplus">+      }</span>
<a href="#l6.2228"></a><span id="l6.2228" class="difflineplus">+    }</span>
<a href="#l6.2229"></a><span id="l6.2229" class="difflineplus">+    else {</span>
<a href="#l6.2230"></a><span id="l6.2230" class="difflineplus">+      this.encryptByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2231"></a><span id="l6.2231" class="difflineplus">+      this.signByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2232"></a><span id="l6.2232" class="difflineplus">+      this.pgpmimeByRules = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2233"></a><span id="l6.2233" class="difflineplus">+      this.autoPgpEncryption = false;</span>
<a href="#l6.2234"></a><span id="l6.2234" class="difflineplus">+    }</span>
<a href="#l6.2235"></a><span id="l6.2235" class="difflineplus">+</span>
<a href="#l6.2236"></a><span id="l6.2236" class="difflineplus">+    // process and signal new resulting state</span>
<a href="#l6.2237"></a><span id="l6.2237" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.2238"></a><span id="l6.2238" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.2239"></a><span id="l6.2239" class="difflineplus">+</span>
<a href="#l6.2240"></a><span id="l6.2240" class="difflineplus">+    return detailsObj;</span>
<a href="#l6.2241"></a><span id="l6.2241" class="difflineplus">+  },</span>
<a href="#l6.2242"></a><span id="l6.2242" class="difflineplus">+</span>
<a href="#l6.2243"></a><span id="l6.2243" class="difflineplus">+  setChecked: function(elementId, checked) {</span>
<a href="#l6.2244"></a><span id="l6.2244" class="difflineplus">+    let elem = document.getElementById(elementId);</span>
<a href="#l6.2245"></a><span id="l6.2245" class="difflineplus">+    if (elem) {</span>
<a href="#l6.2246"></a><span id="l6.2246" class="difflineplus">+      if (checked) {</span>
<a href="#l6.2247"></a><span id="l6.2247" class="difflineplus">+        elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2248"></a><span id="l6.2248" class="difflineplus">+      }</span>
<a href="#l6.2249"></a><span id="l6.2249" class="difflineplus">+      else</span>
<a href="#l6.2250"></a><span id="l6.2250" class="difflineplus">+        elem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l6.2251"></a><span id="l6.2251" class="difflineplus">+    }</span>
<a href="#l6.2252"></a><span id="l6.2252" class="difflineplus">+  },</span>
<a href="#l6.2253"></a><span id="l6.2253" class="difflineplus">+</span>
<a href="#l6.2254"></a><span id="l6.2254" class="difflineplus">+  setMenuSettings: function(postfix) {</span>
<a href="#l6.2255"></a><span id="l6.2255" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setMenuSettings: postfix=&quot; + postfix + &quot;\n&quot;);</span>
<a href="#l6.2256"></a><span id="l6.2256" class="difflineplus">+</span>
<a href="#l6.2257"></a><span id="l6.2257" class="difflineplus">+    let enigmailEnabled = this.isEnigmailEnabled();</span>
<a href="#l6.2258"></a><span id="l6.2258" class="difflineplus">+    let smimeEnabled = this.isSmimeEnabled();</span>
<a href="#l6.2259"></a><span id="l6.2259" class="difflineplus">+</span>
<a href="#l6.2260"></a><span id="l6.2260" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.2261"></a><span id="l6.2261" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.2262"></a><span id="l6.2262" class="difflineplus">+</span>
<a href="#l6.2263"></a><span id="l6.2263" class="difflineplus">+    var elem = document.getElementById(&quot;enigmail_compose_sign_item&quot; + postfix);</span>
<a href="#l6.2264"></a><span id="l6.2264" class="difflineplus">+    if (elem) {</span>
<a href="#l6.2265"></a><span id="l6.2265" class="difflineplus">+      elem.setAttribute(&quot;label&quot;, this.statusSignedStr);</span>
<a href="#l6.2266"></a><span id="l6.2266" class="difflineplus">+      switch (this.statusSigned) {</span>
<a href="#l6.2267"></a><span id="l6.2267" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2268"></a><span id="l6.2268" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2269"></a><span id="l6.2269" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2270"></a><span id="l6.2270" class="difflineplus">+          break;</span>
<a href="#l6.2271"></a><span id="l6.2271" class="difflineplus">+        default:</span>
<a href="#l6.2272"></a><span id="l6.2272" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l6.2273"></a><span id="l6.2273" class="difflineplus">+      }</span>
<a href="#l6.2274"></a><span id="l6.2274" class="difflineplus">+    }</span>
<a href="#l6.2275"></a><span id="l6.2275" class="difflineplus">+</span>
<a href="#l6.2276"></a><span id="l6.2276" class="difflineplus">+    elem = document.getElementById(&quot;enigmail_compose_encrypt_item&quot; + postfix);</span>
<a href="#l6.2277"></a><span id="l6.2277" class="difflineplus">+    if (elem) {</span>
<a href="#l6.2278"></a><span id="l6.2278" class="difflineplus">+      elem.setAttribute(&quot;label&quot;, this.statusEncryptedStr);</span>
<a href="#l6.2279"></a><span id="l6.2279" class="difflineplus">+      switch (this.statusEncrypted) {</span>
<a href="#l6.2280"></a><span id="l6.2280" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2281"></a><span id="l6.2281" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2282"></a><span id="l6.2282" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2283"></a><span id="l6.2283" class="difflineplus">+          break;</span>
<a href="#l6.2284"></a><span id="l6.2284" class="difflineplus">+        default:</span>
<a href="#l6.2285"></a><span id="l6.2285" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l6.2286"></a><span id="l6.2286" class="difflineplus">+      }</span>
<a href="#l6.2287"></a><span id="l6.2287" class="difflineplus">+    }</span>
<a href="#l6.2288"></a><span id="l6.2288" class="difflineplus">+</span>
<a href="#l6.2289"></a><span id="l6.2289" class="difflineplus">+    elem = document.getElementById(&quot;enigmail_compose_pgpmime_item&quot; + postfix);</span>
<a href="#l6.2290"></a><span id="l6.2290" class="difflineplus">+    if (elem) {</span>
<a href="#l6.2291"></a><span id="l6.2291" class="difflineplus">+      elem.setAttribute(&quot;label&quot;, this.statusPGPMimeStr);</span>
<a href="#l6.2292"></a><span id="l6.2292" class="difflineplus">+      if (enigmailEnabled) {</span>
<a href="#l6.2293"></a><span id="l6.2293" class="difflineplus">+        elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2294"></a><span id="l6.2294" class="difflineplus">+      }</span>
<a href="#l6.2295"></a><span id="l6.2295" class="difflineplus">+      else {</span>
<a href="#l6.2296"></a><span id="l6.2296" class="difflineplus">+        elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2297"></a><span id="l6.2297" class="difflineplus">+      }</span>
<a href="#l6.2298"></a><span id="l6.2298" class="difflineplus">+</span>
<a href="#l6.2299"></a><span id="l6.2299" class="difflineplus">+      switch (this.statusPGPMime) {</span>
<a href="#l6.2300"></a><span id="l6.2300" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2301"></a><span id="l6.2301" class="difflineplus">+        case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2302"></a><span id="l6.2302" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2303"></a><span id="l6.2303" class="difflineplus">+          break;</span>
<a href="#l6.2304"></a><span id="l6.2304" class="difflineplus">+        default:</span>
<a href="#l6.2305"></a><span id="l6.2305" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l6.2306"></a><span id="l6.2306" class="difflineplus">+      }</span>
<a href="#l6.2307"></a><span id="l6.2307" class="difflineplus">+</span>
<a href="#l6.2308"></a><span id="l6.2308" class="difflineplus">+      elem = document.getElementById(&quot;enigmail_compose_inline_item&quot; + postfix);</span>
<a href="#l6.2309"></a><span id="l6.2309" class="difflineplus">+      if (elem) {</span>
<a href="#l6.2310"></a><span id="l6.2310" class="difflineplus">+        elem.setAttribute(&quot;label&quot;, this.statusInlinePGPStr);</span>
<a href="#l6.2311"></a><span id="l6.2311" class="difflineplus">+        if (enigmailEnabled) {</span>
<a href="#l6.2312"></a><span id="l6.2312" class="difflineplus">+          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2313"></a><span id="l6.2313" class="difflineplus">+        }</span>
<a href="#l6.2314"></a><span id="l6.2314" class="difflineplus">+        else {</span>
<a href="#l6.2315"></a><span id="l6.2315" class="difflineplus">+          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2316"></a><span id="l6.2316" class="difflineplus">+        }</span>
<a href="#l6.2317"></a><span id="l6.2317" class="difflineplus">+</span>
<a href="#l6.2318"></a><span id="l6.2318" class="difflineplus">+        switch (this.statusPGPMime) {</span>
<a href="#l6.2319"></a><span id="l6.2319" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.2320"></a><span id="l6.2320" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.2321"></a><span id="l6.2321" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_CONFLICT:</span>
<a href="#l6.2322"></a><span id="l6.2322" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_UNDEF:</span>
<a href="#l6.2323"></a><span id="l6.2323" class="difflineplus">+            elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2324"></a><span id="l6.2324" class="difflineplus">+            break;</span>
<a href="#l6.2325"></a><span id="l6.2325" class="difflineplus">+          default:</span>
<a href="#l6.2326"></a><span id="l6.2326" class="difflineplus">+            elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l6.2327"></a><span id="l6.2327" class="difflineplus">+        }</span>
<a href="#l6.2328"></a><span id="l6.2328" class="difflineplus">+      }</span>
<a href="#l6.2329"></a><span id="l6.2329" class="difflineplus">+</span>
<a href="#l6.2330"></a><span id="l6.2330" class="difflineplus">+      elem = document.getElementById(&quot;enigmail_compose_smime_item&quot; + postfix);</span>
<a href="#l6.2331"></a><span id="l6.2331" class="difflineplus">+      if (elem) {</span>
<a href="#l6.2332"></a><span id="l6.2332" class="difflineplus">+        elem.setAttribute(&quot;label&quot;, this.statusSMimeStr);</span>
<a href="#l6.2333"></a><span id="l6.2333" class="difflineplus">+        if (smimeEnabled) {</span>
<a href="#l6.2334"></a><span id="l6.2334" class="difflineplus">+          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2335"></a><span id="l6.2335" class="difflineplus">+        }</span>
<a href="#l6.2336"></a><span id="l6.2336" class="difflineplus">+        else {</span>
<a href="#l6.2337"></a><span id="l6.2337" class="difflineplus">+          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2338"></a><span id="l6.2338" class="difflineplus">+        }</span>
<a href="#l6.2339"></a><span id="l6.2339" class="difflineplus">+</span>
<a href="#l6.2340"></a><span id="l6.2340" class="difflineplus">+        switch (this.statusPGPMime) {</span>
<a href="#l6.2341"></a><span id="l6.2341" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_SMIME:</span>
<a href="#l6.2342"></a><span id="l6.2342" class="difflineplus">+          case EnigmailConstants.ENIG_FINAL_FORCESMIME:</span>
<a href="#l6.2343"></a><span id="l6.2343" class="difflineplus">+            elem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l6.2344"></a><span id="l6.2344" class="difflineplus">+            break;</span>
<a href="#l6.2345"></a><span id="l6.2345" class="difflineplus">+          default:</span>
<a href="#l6.2346"></a><span id="l6.2346" class="difflineplus">+            elem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l6.2347"></a><span id="l6.2347" class="difflineplus">+        }</span>
<a href="#l6.2348"></a><span id="l6.2348" class="difflineplus">+      }</span>
<a href="#l6.2349"></a><span id="l6.2349" class="difflineplus">+</span>
<a href="#l6.2350"></a><span id="l6.2350" class="difflineplus">+      elem = document.getElementById(&quot;enigmail_insert_own_key&quot;);</span>
<a href="#l6.2351"></a><span id="l6.2351" class="difflineplus">+      if (elem) {</span>
<a href="#l6.2352"></a><span id="l6.2352" class="difflineplus">+        if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l6.2353"></a><span id="l6.2353" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, this.attachOwnKeyObj.appendAttachment.toString());</span>
<a href="#l6.2354"></a><span id="l6.2354" class="difflineplus">+          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2355"></a><span id="l6.2355" class="difflineplus">+        }</span>
<a href="#l6.2356"></a><span id="l6.2356" class="difflineplus">+        else {</span>
<a href="#l6.2357"></a><span id="l6.2357" class="difflineplus">+          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2358"></a><span id="l6.2358" class="difflineplus">+        }</span>
<a href="#l6.2359"></a><span id="l6.2359" class="difflineplus">+      }</span>
<a href="#l6.2360"></a><span id="l6.2360" class="difflineplus">+</span>
<a href="#l6.2361"></a><span id="l6.2361" class="difflineplus">+      elem = document.getElementById(&quot;enigmail_encrypt_subject&quot;);</span>
<a href="#l6.2362"></a><span id="l6.2362" class="difflineplus">+      if (elem) {</span>
<a href="#l6.2363"></a><span id="l6.2363" class="difflineplus">+        if (enigmailEnabled) {</span>
<a href="#l6.2364"></a><span id="l6.2364" class="difflineplus">+          elem.setAttribute(&quot;checked&quot;, this.protectHeaders ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l6.2365"></a><span id="l6.2365" class="difflineplus">+          elem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.2366"></a><span id="l6.2366" class="difflineplus">+        }</span>
<a href="#l6.2367"></a><span id="l6.2367" class="difflineplus">+        else {</span>
<a href="#l6.2368"></a><span id="l6.2368" class="difflineplus">+          elem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.2369"></a><span id="l6.2369" class="difflineplus">+        }</span>
<a href="#l6.2370"></a><span id="l6.2370" class="difflineplus">+      }</span>
<a href="#l6.2371"></a><span id="l6.2371" class="difflineplus">+    }</span>
<a href="#l6.2372"></a><span id="l6.2372" class="difflineplus">+  },</span>
<a href="#l6.2373"></a><span id="l6.2373" class="difflineplus">+</span>
<a href="#l6.2374"></a><span id="l6.2374" class="difflineplus">+  displaySecuritySettings: function() {</span>
<a href="#l6.2375"></a><span id="l6.2375" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.displaySecuritySettings\n&quot;);</span>
<a href="#l6.2376"></a><span id="l6.2376" class="difflineplus">+</span>
<a href="#l6.2377"></a><span id="l6.2377" class="difflineplus">+    var inputObj = {</span>
<a href="#l6.2378"></a><span id="l6.2378" class="difflineplus">+      statusEncrypted: this.statusEncrypted,</span>
<a href="#l6.2379"></a><span id="l6.2379" class="difflineplus">+      statusSigned: this.statusSigned,</span>
<a href="#l6.2380"></a><span id="l6.2380" class="difflineplus">+      statusPGPMime: this.statusPGPMime,</span>
<a href="#l6.2381"></a><span id="l6.2381" class="difflineplus">+      success: false,</span>
<a href="#l6.2382"></a><span id="l6.2382" class="difflineplus">+      resetDefaults: false</span>
<a href="#l6.2383"></a><span id="l6.2383" class="difflineplus">+    };</span>
<a href="#l6.2384"></a><span id="l6.2384" class="difflineplus">+    window.openDialog(&quot;chrome://openpgp/content/ui/enigmailEncryptionDlg.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj);</span>
<a href="#l6.2385"></a><span id="l6.2385" class="difflineplus">+</span>
<a href="#l6.2386"></a><span id="l6.2386" class="difflineplus">+    if (!inputObj.success) return; // Cancel pressed</span>
<a href="#l6.2387"></a><span id="l6.2387" class="difflineplus">+</span>
<a href="#l6.2388"></a><span id="l6.2388" class="difflineplus">+    if (inputObj.resetDefaults) {</span>
<a href="#l6.2389"></a><span id="l6.2389" class="difflineplus">+      // reset everything to defaults</span>
<a href="#l6.2390"></a><span id="l6.2390" class="difflineplus">+      this.encryptForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2391"></a><span id="l6.2391" class="difflineplus">+      this.signForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2392"></a><span id="l6.2392" class="difflineplus">+      this.pgpmimeForced = EnigmailConstants.ENIG_UNDEF;</span>
<a href="#l6.2393"></a><span id="l6.2393" class="difflineplus">+      this.finalSignDependsOnEncrypt = true;</span>
<a href="#l6.2394"></a><span id="l6.2394" class="difflineplus">+    }</span>
<a href="#l6.2395"></a><span id="l6.2395" class="difflineplus">+    else {</span>
<a href="#l6.2396"></a><span id="l6.2396" class="difflineplus">+      if (this.signForced != inputObj.sign) {</span>
<a href="#l6.2397"></a><span id="l6.2397" class="difflineplus">+        this.dirty = 2;</span>
<a href="#l6.2398"></a><span id="l6.2398" class="difflineplus">+        this.signForced = inputObj.sign;</span>
<a href="#l6.2399"></a><span id="l6.2399" class="difflineplus">+        this.finalSignDependsOnEncrypt = false;</span>
<a href="#l6.2400"></a><span id="l6.2400" class="difflineplus">+      }</span>
<a href="#l6.2401"></a><span id="l6.2401" class="difflineplus">+</span>
<a href="#l6.2402"></a><span id="l6.2402" class="difflineplus">+      if (this.encryptForced != inputObj.encrypt || this.pgpmimeForced != inputObj.pgpmime) {</span>
<a href="#l6.2403"></a><span id="l6.2403" class="difflineplus">+        this.dirty = 2;</span>
<a href="#l6.2404"></a><span id="l6.2404" class="difflineplus">+      }</span>
<a href="#l6.2405"></a><span id="l6.2405" class="difflineplus">+</span>
<a href="#l6.2406"></a><span id="l6.2406" class="difflineplus">+      this.encryptForced = inputObj.encrypt;</span>
<a href="#l6.2407"></a><span id="l6.2407" class="difflineplus">+      this.pgpmimeForced = inputObj.pgpmime;</span>
<a href="#l6.2408"></a><span id="l6.2408" class="difflineplus">+    }</span>
<a href="#l6.2409"></a><span id="l6.2409" class="difflineplus">+</span>
<a href="#l6.2410"></a><span id="l6.2410" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.2411"></a><span id="l6.2411" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.2412"></a><span id="l6.2412" class="difflineplus">+  },</span>
<a href="#l6.2413"></a><span id="l6.2413" class="difflineplus">+</span>
<a href="#l6.2414"></a><span id="l6.2414" class="difflineplus">+</span>
<a href="#l6.2415"></a><span id="l6.2415" class="difflineplus">+  signingNoLongerDependsOnEnc: function() {</span>
<a href="#l6.2416"></a><span id="l6.2416" class="difflineplus">+    if (this.finalSignDependsOnEncrypt) {</span>
<a href="#l6.2417"></a><span id="l6.2417" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.signingNoLongerDependsOnEnc(): unbundle final signing\n&quot;);</span>
<a href="#l6.2418"></a><span id="l6.2418" class="difflineplus">+      this.finalSignDependsOnEncrypt = false;</span>
<a href="#l6.2419"></a><span id="l6.2419" class="difflineplus">+</span>
<a href="#l6.2420"></a><span id="l6.2420" class="difflineplus">+      EnigmailDialog.alertPref(window, EnigmailLocale.getString(&quot;signIconClicked&quot;), &quot;displaySignWarn&quot;);</span>
<a href="#l6.2421"></a><span id="l6.2421" class="difflineplus">+    }</span>
<a href="#l6.2422"></a><span id="l6.2422" class="difflineplus">+  },</span>
<a href="#l6.2423"></a><span id="l6.2423" class="difflineplus">+</span>
<a href="#l6.2424"></a><span id="l6.2424" class="difflineplus">+</span>
<a href="#l6.2425"></a><span id="l6.2425" class="difflineplus">+  confirmBeforeSend: function(toAddrStr, gpgKeys, sendFlags, isOffline) {</span>
<a href="#l6.2426"></a><span id="l6.2426" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.confirmBeforeSend: sendFlags=&quot; + sendFlags + &quot;\n&quot;);</span>
<a href="#l6.2427"></a><span id="l6.2427" class="difflineplus">+    // get confirmation before sending message</span>
<a href="#l6.2428"></a><span id="l6.2428" class="difflineplus">+</span>
<a href="#l6.2429"></a><span id="l6.2429" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.2430"></a><span id="l6.2430" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.2431"></a><span id="l6.2431" class="difflineplus">+</span>
<a href="#l6.2432"></a><span id="l6.2432" class="difflineplus">+    // get wording for message status (e.g. &quot; SIGNED ENCRYPTED&quot;)</span>
<a href="#l6.2433"></a><span id="l6.2433" class="difflineplus">+    var msgStatus = &quot;&quot;;</span>
<a href="#l6.2434"></a><span id="l6.2434" class="difflineplus">+</span>
<a href="#l6.2435"></a><span id="l6.2435" class="difflineplus">+</span>
<a href="#l6.2436"></a><span id="l6.2436" class="difflineplus">+    if (sendFlags &amp; (ENCRYPT | SIGN)) {</span>
<a href="#l6.2437"></a><span id="l6.2437" class="difflineplus">+      if (this.statusPGPMime === EnigmailConstants.ENIG_FINAL_SMIME ||</span>
<a href="#l6.2438"></a><span id="l6.2438" class="difflineplus">+        this.statusPGPMime === EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l6.2439"></a><span id="l6.2439" class="difflineplus">+        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statSMIME&quot;);</span>
<a href="#l6.2440"></a><span id="l6.2440" class="difflineplus">+      }</span>
<a href="#l6.2441"></a><span id="l6.2441" class="difflineplus">+      else if (sendFlags &amp; EnigmailConstants.SEND_PGP_MIME) {</span>
<a href="#l6.2442"></a><span id="l6.2442" class="difflineplus">+        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statPGPMIME&quot;);</span>
<a href="#l6.2443"></a><span id="l6.2443" class="difflineplus">+      }</span>
<a href="#l6.2444"></a><span id="l6.2444" class="difflineplus">+</span>
<a href="#l6.2445"></a><span id="l6.2445" class="difflineplus">+      if (sendFlags &amp; SIGN) {</span>
<a href="#l6.2446"></a><span id="l6.2446" class="difflineplus">+        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statSigned&quot;);</span>
<a href="#l6.2447"></a><span id="l6.2447" class="difflineplus">+      }</span>
<a href="#l6.2448"></a><span id="l6.2448" class="difflineplus">+      if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l6.2449"></a><span id="l6.2449" class="difflineplus">+        msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statEncrypted&quot;);</span>
<a href="#l6.2450"></a><span id="l6.2450" class="difflineplus">+      }</span>
<a href="#l6.2451"></a><span id="l6.2451" class="difflineplus">+    }</span>
<a href="#l6.2452"></a><span id="l6.2452" class="difflineplus">+    else {</span>
<a href="#l6.2453"></a><span id="l6.2453" class="difflineplus">+      msgStatus += &quot; &quot; + EnigmailLocale.getString(&quot;statPlain&quot;);</span>
<a href="#l6.2454"></a><span id="l6.2454" class="difflineplus">+    }</span>
<a href="#l6.2455"></a><span id="l6.2455" class="difflineplus">+</span>
<a href="#l6.2456"></a><span id="l6.2456" class="difflineplus">+    // create message</span>
<a href="#l6.2457"></a><span id="l6.2457" class="difflineplus">+    var msgConfirm = &quot;&quot;;</span>
<a href="#l6.2458"></a><span id="l6.2458" class="difflineplus">+    try {</span>
<a href="#l6.2459"></a><span id="l6.2459" class="difflineplus">+      if (isOffline || sendFlags &amp; EnigmailConstants.SEND_LATER) {</span>
<a href="#l6.2460"></a><span id="l6.2460" class="difflineplus">+        msgConfirm = EnigmailLocale.getString(&quot;offlineSave&quot;, [msgStatus, EnigmailFuncs.stripEmail(toAddrStr).replace(/,/g, &quot;, &quot;)]);</span>
<a href="#l6.2461"></a><span id="l6.2461" class="difflineplus">+      }</span>
<a href="#l6.2462"></a><span id="l6.2462" class="difflineplus">+      else {</span>
<a href="#l6.2463"></a><span id="l6.2463" class="difflineplus">+        msgConfirm = EnigmailLocale.getString(&quot;onlineSend&quot;, [msgStatus, EnigmailFuncs.stripEmail(toAddrStr).replace(/,/g, &quot;, &quot;)]);</span>
<a href="#l6.2464"></a><span id="l6.2464" class="difflineplus">+      }</span>
<a href="#l6.2465"></a><span id="l6.2465" class="difflineplus">+    }</span>
<a href="#l6.2466"></a><span id="l6.2466" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.2467"></a><span id="l6.2467" class="difflineplus">+</span>
<a href="#l6.2468"></a><span id="l6.2468" class="difflineplus">+    // add list of keys</span>
<a href="#l6.2469"></a><span id="l6.2469" class="difflineplus">+    if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l6.2470"></a><span id="l6.2470" class="difflineplus">+      gpgKeys = gpgKeys.replace(/^, /, &quot;&quot;).replace(/, $/, &quot;&quot;);</span>
<a href="#l6.2471"></a><span id="l6.2471" class="difflineplus">+</span>
<a href="#l6.2472"></a><span id="l6.2472" class="difflineplus">+      // make gpg keys unique</span>
<a href="#l6.2473"></a><span id="l6.2473" class="difflineplus">+      let keyList = gpgKeys.split(/[, ]+/).reduce(function _f(p, key) {</span>
<a href="#l6.2474"></a><span id="l6.2474" class="difflineplus">+        if (p.indexOf(key) &lt; 0) p.push(key);</span>
<a href="#l6.2475"></a><span id="l6.2475" class="difflineplus">+        return p;</span>
<a href="#l6.2476"></a><span id="l6.2476" class="difflineplus">+      }, []);</span>
<a href="#l6.2477"></a><span id="l6.2477" class="difflineplus">+</span>
<a href="#l6.2478"></a><span id="l6.2478" class="difflineplus">+      if (this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l6.2479"></a><span id="l6.2479" class="difflineplus">+        this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l6.2480"></a><span id="l6.2480" class="difflineplus">+        msgConfirm += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;encryptKeysNote&quot;, [keyList.join(&quot;, &quot;)]);</span>
<a href="#l6.2481"></a><span id="l6.2481" class="difflineplus">+      }</span>
<a href="#l6.2482"></a><span id="l6.2482" class="difflineplus">+    }</span>
<a href="#l6.2483"></a><span id="l6.2483" class="difflineplus">+</span>
<a href="#l6.2484"></a><span id="l6.2484" class="difflineplus">+    return EnigmailDialog.confirmDlg(window, msgConfirm,</span>
<a href="#l6.2485"></a><span id="l6.2485" class="difflineplus">+      EnigmailLocale.getString((isOffline || sendFlags &amp; EnigmailConstants.SEND_LATER) ?</span>
<a href="#l6.2486"></a><span id="l6.2486" class="difflineplus">+        &quot;msgCompose.button.save&quot; : &quot;msgCompose.button.send&quot;));</span>
<a href="#l6.2487"></a><span id="l6.2487" class="difflineplus">+  },</span>
<a href="#l6.2488"></a><span id="l6.2488" class="difflineplus">+</span>
<a href="#l6.2489"></a><span id="l6.2489" class="difflineplus">+</span>
<a href="#l6.2490"></a><span id="l6.2490" class="difflineplus">+  addRecipients: function(toAddrList, recList) {</span>
<a href="#l6.2491"></a><span id="l6.2491" class="difflineplus">+    for (var i = 0; i &lt; recList.length; i++) {</span>
<a href="#l6.2492"></a><span id="l6.2492" class="difflineplus">+      try {</span>
<a href="#l6.2493"></a><span id="l6.2493" class="difflineplus">+        toAddrList.push(EnigmailFuncs.stripEmail(recList[i].replace(/[&quot;,]/g, &quot;&quot;)));</span>
<a href="#l6.2494"></a><span id="l6.2494" class="difflineplus">+      }</span>
<a href="#l6.2495"></a><span id="l6.2495" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.2496"></a><span id="l6.2496" class="difflineplus">+    }</span>
<a href="#l6.2497"></a><span id="l6.2497" class="difflineplus">+  },</span>
<a href="#l6.2498"></a><span id="l6.2498" class="difflineplus">+</span>
<a href="#l6.2499"></a><span id="l6.2499" class="difflineplus">+  setDraftStatus: function(doEncrypt) {</span>
<a href="#l6.2500"></a><span id="l6.2500" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setDraftStatus - enabling draft mode\n&quot;);</span>
<a href="#l6.2501"></a><span id="l6.2501" class="difflineplus">+</span>
<a href="#l6.2502"></a><span id="l6.2502" class="difflineplus">+    // Draft Status:</span>
<a href="#l6.2503"></a><span id="l6.2503" class="difflineplus">+    // N (for new style) plus String of 4 numbers:</span>
<a href="#l6.2504"></a><span id="l6.2504" class="difflineplus">+    // 1: encryption</span>
<a href="#l6.2505"></a><span id="l6.2505" class="difflineplus">+    // 2: signing</span>
<a href="#l6.2506"></a><span id="l6.2506" class="difflineplus">+    // 3: PGP/MIME</span>
<a href="#l6.2507"></a><span id="l6.2507" class="difflineplus">+    // 4: attach own key</span>
<a href="#l6.2508"></a><span id="l6.2508" class="difflineplus">+    // 5: subject encrypted</span>
<a href="#l6.2509"></a><span id="l6.2509" class="difflineplus">+</span>
<a href="#l6.2510"></a><span id="l6.2510" class="difflineplus">+    var draftStatus = &quot;N&quot; + this.encryptForced + this.signForced + this.pgpmimeForced +</span>
<a href="#l6.2511"></a><span id="l6.2511" class="difflineplus">+      (this.attachOwnKeyObj.appendAttachment ? &quot;1&quot; : &quot;0&quot;) + (doEncrypt &amp;&amp; this.protectHeaders ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l6.2512"></a><span id="l6.2512" class="difflineplus">+</span>
<a href="#l6.2513"></a><span id="l6.2513" class="difflineplus">+    this.setAdditionalHeader(&quot;X-Enigmail-Draft-Status&quot;, draftStatus);</span>
<a href="#l6.2514"></a><span id="l6.2514" class="difflineplus">+  },</span>
<a href="#l6.2515"></a><span id="l6.2515" class="difflineplus">+</span>
<a href="#l6.2516"></a><span id="l6.2516" class="difflineplus">+  getForceRecipientDlg: function() {</span>
<a href="#l6.2517"></a><span id="l6.2517" class="difflineplus">+    // force add-rule dialog for each missing key?:</span>
<a href="#l6.2518"></a><span id="l6.2518" class="difflineplus">+    let forceRecipientSettings = false;</span>
<a href="#l6.2519"></a><span id="l6.2519" class="difflineplus">+    // if keys are ONLY assigned by rules, force add-rule dialog for each missing key</span>
<a href="#l6.2520"></a><span id="l6.2520" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;) &amp;&amp;</span>
<a href="#l6.2521"></a><span id="l6.2521" class="difflineplus">+      !EnigmailPrefs.getPref(&quot;assignKeysByEmailAddr&quot;) &amp;&amp;</span>
<a href="#l6.2522"></a><span id="l6.2522" class="difflineplus">+      !EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;) &amp;&amp;</span>
<a href="#l6.2523"></a><span id="l6.2523" class="difflineplus">+      !EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l6.2524"></a><span id="l6.2524" class="difflineplus">+      forceRecipientSettings = true;</span>
<a href="#l6.2525"></a><span id="l6.2525" class="difflineplus">+    }</span>
<a href="#l6.2526"></a><span id="l6.2526" class="difflineplus">+    return forceRecipientSettings;</span>
<a href="#l6.2527"></a><span id="l6.2527" class="difflineplus">+  },</span>
<a href="#l6.2528"></a><span id="l6.2528" class="difflineplus">+</span>
<a href="#l6.2529"></a><span id="l6.2529" class="difflineplus">+  getSenderUserId: function() {</span>
<a href="#l6.2530"></a><span id="l6.2530" class="difflineplus">+    var userIdValue = null;</span>
<a href="#l6.2531"></a><span id="l6.2531" class="difflineplus">+</span>
<a href="#l6.2532"></a><span id="l6.2532" class="difflineplus">+    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l6.2533"></a><span id="l6.2533" class="difflineplus">+      userIdValue = this.identity.getCharAttribute(&quot;pgpkeyId&quot;);</span>
<a href="#l6.2534"></a><span id="l6.2534" class="difflineplus">+</span>
<a href="#l6.2535"></a><span id="l6.2535" class="difflineplus">+      if (!userIdValue) {</span>
<a href="#l6.2536"></a><span id="l6.2536" class="difflineplus">+</span>
<a href="#l6.2537"></a><span id="l6.2537" class="difflineplus">+        var mesg = EnigmailLocale.getString(&quot;composeSpecifyEmail&quot;);</span>
<a href="#l6.2538"></a><span id="l6.2538" class="difflineplus">+</span>
<a href="#l6.2539"></a><span id="l6.2539" class="difflineplus">+        var valueObj = {</span>
<a href="#l6.2540"></a><span id="l6.2540" class="difflineplus">+          value: userIdValue</span>
<a href="#l6.2541"></a><span id="l6.2541" class="difflineplus">+        };</span>
<a href="#l6.2542"></a><span id="l6.2542" class="difflineplus">+</span>
<a href="#l6.2543"></a><span id="l6.2543" class="difflineplus">+        if (EnigmailDialog.promptValue(window, mesg, valueObj)) {</span>
<a href="#l6.2544"></a><span id="l6.2544" class="difflineplus">+          userIdValue = valueObj.value;</span>
<a href="#l6.2545"></a><span id="l6.2545" class="difflineplus">+        }</span>
<a href="#l6.2546"></a><span id="l6.2546" class="difflineplus">+      }</span>
<a href="#l6.2547"></a><span id="l6.2547" class="difflineplus">+</span>
<a href="#l6.2548"></a><span id="l6.2548" class="difflineplus">+      if (userIdValue) {</span>
<a href="#l6.2549"></a><span id="l6.2549" class="difflineplus">+        this.identity.setCharAttribute(&quot;pgpkeyId&quot;, userIdValue);</span>
<a href="#l6.2550"></a><span id="l6.2550" class="difflineplus">+</span>
<a href="#l6.2551"></a><span id="l6.2551" class="difflineplus">+      }</span>
<a href="#l6.2552"></a><span id="l6.2552" class="difflineplus">+      else {</span>
<a href="#l6.2553"></a><span id="l6.2553" class="difflineplus">+        this.identity.setIntAttribute(&quot;pgpKeyMode&quot;, 0);</span>
<a href="#l6.2554"></a><span id="l6.2554" class="difflineplus">+      }</span>
<a href="#l6.2555"></a><span id="l6.2555" class="difflineplus">+    }</span>
<a href="#l6.2556"></a><span id="l6.2556" class="difflineplus">+</span>
<a href="#l6.2557"></a><span id="l6.2557" class="difflineplus">+    if (typeof(userIdValue) != &quot;string&quot;) {</span>
<a href="#l6.2558"></a><span id="l6.2558" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getSenderUserId: type of userIdValue=&quot; + typeof(userIdValue) + &quot;\n&quot;);</span>
<a href="#l6.2559"></a><span id="l6.2559" class="difflineplus">+      userIdValue = this.identity.email;</span>
<a href="#l6.2560"></a><span id="l6.2560" class="difflineplus">+    }</span>
<a href="#l6.2561"></a><span id="l6.2561" class="difflineplus">+</span>
<a href="#l6.2562"></a><span id="l6.2562" class="difflineplus">+    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) === 0) {</span>
<a href="#l6.2563"></a><span id="l6.2563" class="difflineplus">+      let key = EnigmailKeyRing.getSecretKeyByEmail(userIdValue);</span>
<a href="#l6.2564"></a><span id="l6.2564" class="difflineplus">+      if (key) {</span>
<a href="#l6.2565"></a><span id="l6.2565" class="difflineplus">+        userIdValue = &quot;0x&quot; + key.fpr;</span>
<a href="#l6.2566"></a><span id="l6.2566" class="difflineplus">+      }</span>
<a href="#l6.2567"></a><span id="l6.2567" class="difflineplus">+    }</span>
<a href="#l6.2568"></a><span id="l6.2568" class="difflineplus">+    return userIdValue;</span>
<a href="#l6.2569"></a><span id="l6.2569" class="difflineplus">+  },</span>
<a href="#l6.2570"></a><span id="l6.2570" class="difflineplus">+</span>
<a href="#l6.2571"></a><span id="l6.2571" class="difflineplus">+</span>
<a href="#l6.2572"></a><span id="l6.2572" class="difflineplus">+  /* process rules and find keys for passed email addresses</span>
<a href="#l6.2573"></a><span id="l6.2573" class="difflineplus">+   * This is THE core method to prepare sending encryptes emails.</span>
<a href="#l6.2574"></a><span id="l6.2574" class="difflineplus">+   * - it processes the recipient rules (if not disabled)</span>
<a href="#l6.2575"></a><span id="l6.2575" class="difflineplus">+   * - it</span>
<a href="#l6.2576"></a><span id="l6.2576" class="difflineplus">+   *</span>
<a href="#l6.2577"></a><span id="l6.2577" class="difflineplus">+   * @sendFlags:    Longint - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l6.2578"></a><span id="l6.2578" class="difflineplus">+   * @optSendFlags: Longint - may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l6.2579"></a><span id="l6.2579" class="difflineplus">+   * @gotSendFlags: Longint - initial sendMode of encryptMsg() (0 or SIGN or ENCRYPT or SIGN|ENCRYPT)</span>
<a href="#l6.2580"></a><span id="l6.2580" class="difflineplus">+   * @fromAddr:     String - from email</span>
<a href="#l6.2581"></a><span id="l6.2581" class="difflineplus">+   * @toAddrList:   Array  - both to and cc receivers</span>
<a href="#l6.2582"></a><span id="l6.2582" class="difflineplus">+   * @bccAddrList:  Array  - bcc receivers</span>
<a href="#l6.2583"></a><span id="l6.2583" class="difflineplus">+   * @return:       Object:</span>
<a href="#l6.2584"></a><span id="l6.2584" class="difflineplus">+   *                - sendFlags (Longint)</span>
<a href="#l6.2585"></a><span id="l6.2585" class="difflineplus">+   *                - toAddrStr  comma separated string of unprocessed to/cc emails</span>
<a href="#l6.2586"></a><span id="l6.2586" class="difflineplus">+   *                - bccAddrStr comma separated string of unprocessed to/cc emails</span>
<a href="#l6.2587"></a><span id="l6.2587" class="difflineplus">+   *                or null (cancel sending the email)</span>
<a href="#l6.2588"></a><span id="l6.2588" class="difflineplus">+   */</span>
<a href="#l6.2589"></a><span id="l6.2589" class="difflineplus">+  keySelection: function(enigmailSvc, sendFlags, optSendFlags, gotSendFlags, fromAddr, toAddrList, bccAddrList) {</span>
<a href="#l6.2590"></a><span id="l6.2590" class="difflineplus">+    EnigmailLog.DEBUG(&quot;=====&gt; keySelection()\n&quot;);</span>
<a href="#l6.2591"></a><span id="l6.2591" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection()\n&quot;);</span>
<a href="#l6.2592"></a><span id="l6.2592" class="difflineplus">+</span>
<a href="#l6.2593"></a><span id="l6.2593" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.2594"></a><span id="l6.2594" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.2595"></a><span id="l6.2595" class="difflineplus">+</span>
<a href="#l6.2596"></a><span id="l6.2596" class="difflineplus">+    let toAddrStr = toAddrList.join(&quot;, &quot;);</span>
<a href="#l6.2597"></a><span id="l6.2597" class="difflineplus">+    let bccAddrStr = bccAddrList.join(&quot;, &quot;);</span>
<a href="#l6.2598"></a><span id="l6.2598" class="difflineplus">+    let keyMap = {};</span>
<a href="#l6.2599"></a><span id="l6.2599" class="difflineplus">+</span>
<a href="#l6.2600"></a><span id="l6.2600" class="difflineplus">+    // NOTE: If we only have bcc addresses, we currently do NOT process rules and select keys at all</span>
<a href="#l6.2601"></a><span id="l6.2601" class="difflineplus">+    //       This is GOOD because sending keys for bcc addresses makes bcc addresses visible</span>
<a href="#l6.2602"></a><span id="l6.2602" class="difflineplus">+    //       (thus compromising the concept of bcc)</span>
<a href="#l6.2603"></a><span id="l6.2603" class="difflineplus">+    //       THUS, we disable encryption even though all bcc receivers might want to have it encrypted.</span>
<a href="#l6.2604"></a><span id="l6.2604" class="difflineplus">+    if (toAddrStr.length === 0) {</span>
<a href="#l6.2605"></a><span id="l6.2605" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): skip key selection because we neither have \&quot;to\&quot; nor \&quot;cc\&quot; addresses\n&quot;);</span>
<a href="#l6.2606"></a><span id="l6.2606" class="difflineplus">+</span>
<a href="#l6.2607"></a><span id="l6.2607" class="difflineplus">+      if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.2608"></a><span id="l6.2608" class="difflineplus">+        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.2609"></a><span id="l6.2609" class="difflineplus">+        sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.2610"></a><span id="l6.2610" class="difflineplus">+      }</span>
<a href="#l6.2611"></a><span id="l6.2611" class="difflineplus">+      else if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_NO ||</span>
<a href="#l6.2612"></a><span id="l6.2612" class="difflineplus">+        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCENO ||</span>
<a href="#l6.2613"></a><span id="l6.2613" class="difflineplus">+        this.statusPGPMime == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l6.2614"></a><span id="l6.2614" class="difflineplus">+        sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.2615"></a><span id="l6.2615" class="difflineplus">+      }</span>
<a href="#l6.2616"></a><span id="l6.2616" class="difflineplus">+</span>
<a href="#l6.2617"></a><span id="l6.2617" class="difflineplus">+      return {</span>
<a href="#l6.2618"></a><span id="l6.2618" class="difflineplus">+        sendFlags: sendFlags,</span>
<a href="#l6.2619"></a><span id="l6.2619" class="difflineplus">+        toAddrStr: toAddrStr,</span>
<a href="#l6.2620"></a><span id="l6.2620" class="difflineplus">+        bccAddrStr: bccAddrStr,</span>
<a href="#l6.2621"></a><span id="l6.2621" class="difflineplus">+        keyMap: keyMap</span>
<a href="#l6.2622"></a><span id="l6.2622" class="difflineplus">+      };</span>
<a href="#l6.2623"></a><span id="l6.2623" class="difflineplus">+    }</span>
<a href="#l6.2624"></a><span id="l6.2624" class="difflineplus">+</span>
<a href="#l6.2625"></a><span id="l6.2625" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.2626"></a><span id="l6.2626" class="difflineplus">+</span>
<a href="#l6.2627"></a><span id="l6.2627" class="difflineplus">+    var forceRecipientSettings = this.getForceRecipientDlg();</span>
<a href="#l6.2628"></a><span id="l6.2628" class="difflineplus">+</span>
<a href="#l6.2629"></a><span id="l6.2629" class="difflineplus">+    // REPEAT 1 or 2 times:</span>
<a href="#l6.2630"></a><span id="l6.2630" class="difflineplus">+    // NOTE: The only way to call this loop twice is to come to the &quot;continue;&quot; statement below,</span>
<a href="#l6.2631"></a><span id="l6.2631" class="difflineplus">+    //       which forces a second iteration (with forceRecipientSettings==true)</span>
<a href="#l6.2632"></a><span id="l6.2632" class="difflineplus">+    var doRulesProcessingAgain;</span>
<a href="#l6.2633"></a><span id="l6.2633" class="difflineplus">+    do {</span>
<a href="#l6.2634"></a><span id="l6.2634" class="difflineplus">+      doRulesProcessingAgain = false;</span>
<a href="#l6.2635"></a><span id="l6.2635" class="difflineplus">+</span>
<a href="#l6.2636"></a><span id="l6.2636" class="difflineplus">+      // process rules if not disabled</span>
<a href="#l6.2637"></a><span id="l6.2637" class="difflineplus">+      // - enableRules: rules not temporarily disabled</span>
<a href="#l6.2638"></a><span id="l6.2638" class="difflineplus">+      // REPLACES email addresses by keys in its result !!!</span>
<a href="#l6.2639"></a><span id="l6.2639" class="difflineplus">+      var refreshKeyList = true;</span>
<a href="#l6.2640"></a><span id="l6.2640" class="difflineplus">+      if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;) &amp;&amp; this.enableRules) {</span>
<a href="#l6.2641"></a><span id="l6.2641" class="difflineplus">+        let result = this.processRules(forceRecipientSettings, sendFlags, optSendFlags, toAddrStr, bccAddrStr);</span>
<a href="#l6.2642"></a><span id="l6.2642" class="difflineplus">+        if (!result) {</span>
<a href="#l6.2643"></a><span id="l6.2643" class="difflineplus">+          return null;</span>
<a href="#l6.2644"></a><span id="l6.2644" class="difflineplus">+        }</span>
<a href="#l6.2645"></a><span id="l6.2645" class="difflineplus">+        sendFlags = result.sendFlags;</span>
<a href="#l6.2646"></a><span id="l6.2646" class="difflineplus">+        optSendFlags = result.optSendFlags;</span>
<a href="#l6.2647"></a><span id="l6.2647" class="difflineplus">+        toAddrStr = result.toAddr; // replace email addresses with rules by the corresponding keys</span>
<a href="#l6.2648"></a><span id="l6.2648" class="difflineplus">+        bccAddrStr = result.bccAddr; // replace email addresses with rules by the corresponding keys</span>
<a href="#l6.2649"></a><span id="l6.2649" class="difflineplus">+        refreshKeyList = !result.didRefreshKeyList; // if key list refreshed we don't have to do it again</span>
<a href="#l6.2650"></a><span id="l6.2650" class="difflineplus">+        keyMap = result.keyMap;</span>
<a href="#l6.2651"></a><span id="l6.2651" class="difflineplus">+      }</span>
<a href="#l6.2652"></a><span id="l6.2652" class="difflineplus">+</span>
<a href="#l6.2653"></a><span id="l6.2653" class="difflineplus">+      // if encryption is requested for the email:</span>
<a href="#l6.2654"></a><span id="l6.2654" class="difflineplus">+      // - encrypt test message for default encryption</span>
<a href="#l6.2655"></a><span id="l6.2655" class="difflineplus">+      // - might trigger a second iteration through this loop</span>
<a href="#l6.2656"></a><span id="l6.2656" class="difflineplus">+      //   - if during its dialog for manual key selection &quot;create per-recipient rules&quot; is pressed</span>
<a href="#l6.2657"></a><span id="l6.2657" class="difflineplus">+      //   to force manual settings for missing keys</span>
<a href="#l6.2658"></a><span id="l6.2658" class="difflineplus">+      // LEAVES remaining email addresses not covered by rules as they are</span>
<a href="#l6.2659"></a><span id="l6.2659" class="difflineplus">+      if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l6.2660"></a><span id="l6.2660" class="difflineplus">+        let result = this.encryptTestMessage(enigmailSvc, sendFlags, optSendFlags,</span>
<a href="#l6.2661"></a><span id="l6.2661" class="difflineplus">+          fromAddr, toAddrStr, bccAddrStr, bccAddrList, refreshKeyList);</span>
<a href="#l6.2662"></a><span id="l6.2662" class="difflineplus">+        if (!result) {</span>
<a href="#l6.2663"></a><span id="l6.2663" class="difflineplus">+          return null;</span>
<a href="#l6.2664"></a><span id="l6.2664" class="difflineplus">+        }</span>
<a href="#l6.2665"></a><span id="l6.2665" class="difflineplus">+        sendFlags = result.sendFlags;</span>
<a href="#l6.2666"></a><span id="l6.2666" class="difflineplus">+        toAddrStr = result.toAddrStr;</span>
<a href="#l6.2667"></a><span id="l6.2667" class="difflineplus">+        bccAddrStr = result.bccAddrStr;</span>
<a href="#l6.2668"></a><span id="l6.2668" class="difflineplus">+        if (result.doRulesProcessingAgain) { // start rule processing again ?</span>
<a href="#l6.2669"></a><span id="l6.2669" class="difflineplus">+          doRulesProcessingAgain = true;</span>
<a href="#l6.2670"></a><span id="l6.2670" class="difflineplus">+          if (result.createNewRule) {</span>
<a href="#l6.2671"></a><span id="l6.2671" class="difflineplus">+            forceRecipientSettings = true;</span>
<a href="#l6.2672"></a><span id="l6.2672" class="difflineplus">+          }</span>
<a href="#l6.2673"></a><span id="l6.2673" class="difflineplus">+        }</span>
<a href="#l6.2674"></a><span id="l6.2674" class="difflineplus">+      }</span>
<a href="#l6.2675"></a><span id="l6.2675" class="difflineplus">+    } while (doRulesProcessingAgain);</span>
<a href="#l6.2676"></a><span id="l6.2676" class="difflineplus">+</span>
<a href="#l6.2677"></a><span id="l6.2677" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): return toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.2678"></a><span id="l6.2678" class="difflineplus">+    EnigmailLog.DEBUG(&quot;  &lt;=== keySelection()\n&quot;);</span>
<a href="#l6.2679"></a><span id="l6.2679" class="difflineplus">+    return {</span>
<a href="#l6.2680"></a><span id="l6.2680" class="difflineplus">+      sendFlags: sendFlags,</span>
<a href="#l6.2681"></a><span id="l6.2681" class="difflineplus">+      toAddrStr: toAddrStr,</span>
<a href="#l6.2682"></a><span id="l6.2682" class="difflineplus">+      bccAddrStr: bccAddrStr,</span>
<a href="#l6.2683"></a><span id="l6.2683" class="difflineplus">+      keyMap: keyMap</span>
<a href="#l6.2684"></a><span id="l6.2684" class="difflineplus">+    };</span>
<a href="#l6.2685"></a><span id="l6.2685" class="difflineplus">+  },</span>
<a href="#l6.2686"></a><span id="l6.2686" class="difflineplus">+</span>
<a href="#l6.2687"></a><span id="l6.2687" class="difflineplus">+  /**</span>
<a href="#l6.2688"></a><span id="l6.2688" class="difflineplus">+   * Determine if S/MIME or OpenPGP should be used</span>
<a href="#l6.2689"></a><span id="l6.2689" class="difflineplus">+   *</span>
<a href="#l6.2690"></a><span id="l6.2690" class="difflineplus">+   * @param sendFlags: Number - input send flags.</span>
<a href="#l6.2691"></a><span id="l6.2691" class="difflineplus">+   *</span>
<a href="#l6.2692"></a><span id="l6.2692" class="difflineplus">+   * @return: Boolean:</span>
<a href="#l6.2693"></a><span id="l6.2693" class="difflineplus">+   *   1: use OpenPGP</span>
<a href="#l6.2694"></a><span id="l6.2694" class="difflineplus">+   *   0: use S/MIME</span>
<a href="#l6.2695"></a><span id="l6.2695" class="difflineplus">+   */</span>
<a href="#l6.2696"></a><span id="l6.2696" class="difflineplus">+  preferPgpOverSmime: function(sendFlags) {</span>
<a href="#l6.2697"></a><span id="l6.2697" class="difflineplus">+</span>
<a href="#l6.2698"></a><span id="l6.2698" class="difflineplus">+    let si = Enigmail.msg.getSecurityParams(null, true);</span>
<a href="#l6.2699"></a><span id="l6.2699" class="difflineplus">+    let isSmime = !EnigmailMimeEncrypt.isEnigmailCompField(si);</span>
<a href="#l6.2700"></a><span id="l6.2700" class="difflineplus">+</span>
<a href="#l6.2701"></a><span id="l6.2701" class="difflineplus">+    if (isSmime &amp;&amp;</span>
<a href="#l6.2702"></a><span id="l6.2702" class="difflineplus">+      (sendFlags &amp; (EnigmailConstants.SEND_SIGNED | EnigmailConstants.SEND_ENCRYPTED))) {</span>
<a href="#l6.2703"></a><span id="l6.2703" class="difflineplus">+</span>
<a href="#l6.2704"></a><span id="l6.2704" class="difflineplus">+      if (si.requireEncryptMessage || si.signMessage) {</span>
<a href="#l6.2705"></a><span id="l6.2705" class="difflineplus">+</span>
<a href="#l6.2706"></a><span id="l6.2706" class="difflineplus">+        if (sendFlags &amp; EnigmailConstants.SAVE_MESSAGE) {</span>
<a href="#l6.2707"></a><span id="l6.2707" class="difflineplus">+          // use S/MIME if it's enabled for saving drafts</span>
<a href="#l6.2708"></a><span id="l6.2708" class="difflineplus">+          return 0;</span>
<a href="#l6.2709"></a><span id="l6.2709" class="difflineplus">+        }</span>
<a href="#l6.2710"></a><span id="l6.2710" class="difflineplus">+        else {</span>
<a href="#l6.2711"></a><span id="l6.2711" class="difflineplus">+          return this.mimePreferOpenPGP;</span>
<a href="#l6.2712"></a><span id="l6.2712" class="difflineplus">+        }</span>
<a href="#l6.2713"></a><span id="l6.2713" class="difflineplus">+      }</span>
<a href="#l6.2714"></a><span id="l6.2714" class="difflineplus">+    }</span>
<a href="#l6.2715"></a><span id="l6.2715" class="difflineplus">+</span>
<a href="#l6.2716"></a><span id="l6.2716" class="difflineplus">+    return 1;</span>
<a href="#l6.2717"></a><span id="l6.2717" class="difflineplus">+  },</span>
<a href="#l6.2718"></a><span id="l6.2718" class="difflineplus">+</span>
<a href="#l6.2719"></a><span id="l6.2719" class="difflineplus">+</span>
<a href="#l6.2720"></a><span id="l6.2720" class="difflineplus">+  /**</span>
<a href="#l6.2721"></a><span id="l6.2721" class="difflineplus">+   * check if S/MIME encryption can be enabled</span>
<a href="#l6.2722"></a><span id="l6.2722" class="difflineplus">+   *</span>
<a href="#l6.2723"></a><span id="l6.2723" class="difflineplus">+   * @return: Boolean - true: keys for all recipients are available</span>
<a href="#l6.2724"></a><span id="l6.2724" class="difflineplus">+   */</span>
<a href="#l6.2725"></a><span id="l6.2725" class="difflineplus">+  isSmimeEncryptionPossible: function() {</span>
<a href="#l6.2726"></a><span id="l6.2726" class="difflineplus">+    let id = getCurrentIdentity();</span>
<a href="#l6.2727"></a><span id="l6.2727" class="difflineplus">+</span>
<a href="#l6.2728"></a><span id="l6.2728" class="difflineplus">+    if (id.getUnicharAttribute(&quot;encryption_cert_name&quot;) === &quot;&quot;) return false;</span>
<a href="#l6.2729"></a><span id="l6.2729" class="difflineplus">+</span>
<a href="#l6.2730"></a><span id="l6.2730" class="difflineplus">+    // enable encryption if keys for all recipients are available</span>
<a href="#l6.2731"></a><span id="l6.2731" class="difflineplus">+</span>
<a href="#l6.2732"></a><span id="l6.2732" class="difflineplus">+    let missingCount = {};</span>
<a href="#l6.2733"></a><span id="l6.2733" class="difflineplus">+    let emailAddresses = {};</span>
<a href="#l6.2734"></a><span id="l6.2734" class="difflineplus">+</span>
<a href="#l6.2735"></a><span id="l6.2735" class="difflineplus">+    try {</span>
<a href="#l6.2736"></a><span id="l6.2736" class="difflineplus">+      if (!gMsgCompose.compFields.hasRecipients) return false;</span>
<a href="#l6.2737"></a><span id="l6.2737" class="difflineplus">+      Components.classes[&quot;@mozilla.org/messenger-smime/smimejshelper;1&quot;]</span>
<a href="#l6.2738"></a><span id="l6.2738" class="difflineplus">+        .createInstance(Components.interfaces.nsISMimeJSHelper)</span>
<a href="#l6.2739"></a><span id="l6.2739" class="difflineplus">+        .getNoCertAddresses(gMsgCompose.compFields,</span>
<a href="#l6.2740"></a><span id="l6.2740" class="difflineplus">+          missingCount,</span>
<a href="#l6.2741"></a><span id="l6.2741" class="difflineplus">+          emailAddresses);</span>
<a href="#l6.2742"></a><span id="l6.2742" class="difflineplus">+    }</span>
<a href="#l6.2743"></a><span id="l6.2743" class="difflineplus">+    catch (e) {</span>
<a href="#l6.2744"></a><span id="l6.2744" class="difflineplus">+      return false;</span>
<a href="#l6.2745"></a><span id="l6.2745" class="difflineplus">+    }</span>
<a href="#l6.2746"></a><span id="l6.2746" class="difflineplus">+</span>
<a href="#l6.2747"></a><span id="l6.2747" class="difflineplus">+    if (missingCount.value === 0) {</span>
<a href="#l6.2748"></a><span id="l6.2748" class="difflineplus">+      return true;</span>
<a href="#l6.2749"></a><span id="l6.2749" class="difflineplus">+    }</span>
<a href="#l6.2750"></a><span id="l6.2750" class="difflineplus">+</span>
<a href="#l6.2751"></a><span id="l6.2751" class="difflineplus">+    return false;</span>
<a href="#l6.2752"></a><span id="l6.2752" class="difflineplus">+  },</span>
<a href="#l6.2753"></a><span id="l6.2753" class="difflineplus">+</span>
<a href="#l6.2754"></a><span id="l6.2754" class="difflineplus">+  /**</span>
<a href="#l6.2755"></a><span id="l6.2755" class="difflineplus">+   * try to apply the OpenPGP rules</span>
<a href="#l6.2756"></a><span id="l6.2756" class="difflineplus">+   *</span>
<a href="#l6.2757"></a><span id="l6.2757" class="difflineplus">+   * @forceRecipientSetting: Boolean - force manual selection for each missing key?</span>
<a href="#l6.2758"></a><span id="l6.2758" class="difflineplus">+   * @sendFlags:             Integer - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l6.2759"></a><span id="l6.2759" class="difflineplus">+   * @optSendFlags:          Integer - may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l6.2760"></a><span id="l6.2760" class="difflineplus">+   * @toAddrStr:             String  - comma separated string of keys and unprocessed to/cc emails</span>
<a href="#l6.2761"></a><span id="l6.2761" class="difflineplus">+   * @bccAddrStr:            String  - comma separated string of keys and unprocessed bcc emails</span>
<a href="#l6.2762"></a><span id="l6.2762" class="difflineplus">+   * @return:       { sendFlags, toAddr, bccAddr }</span>
<a href="#l6.2763"></a><span id="l6.2763" class="difflineplus">+   *                or null (cancel sending the email)</span>
<a href="#l6.2764"></a><span id="l6.2764" class="difflineplus">+   */</span>
<a href="#l6.2765"></a><span id="l6.2765" class="difflineplus">+  processRules: function(forceRecipientSettings, sendFlags, optSendFlags, toAddrStr, bccAddrStr) {</span>
<a href="#l6.2766"></a><span id="l6.2766" class="difflineplus">+    EnigmailLog.DEBUG(&quot;=====&gt; processRules()\n&quot;);</span>
<a href="#l6.2767"></a><span id="l6.2767" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot; forceRecipientSettings=&quot; +</span>
<a href="#l6.2768"></a><span id="l6.2768" class="difflineplus">+      forceRecipientSettings + &quot;\n&quot;);</span>
<a href="#l6.2769"></a><span id="l6.2769" class="difflineplus">+</span>
<a href="#l6.2770"></a><span id="l6.2770" class="difflineplus">+    // process defaults</span>
<a href="#l6.2771"></a><span id="l6.2771" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.2772"></a><span id="l6.2772" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.2773"></a><span id="l6.2773" class="difflineplus">+    let didRefreshKeyList = false; // return value to signal whether the key list was refreshed</span>
<a href="#l6.2774"></a><span id="l6.2774" class="difflineplus">+</span>
<a href="#l6.2775"></a><span id="l6.2775" class="difflineplus">+    // get keys for to and cc addresses:</span>
<a href="#l6.2776"></a><span id="l6.2776" class="difflineplus">+    // - matchedKeysObj will contain the keys and the remaining toAddrStr elements</span>
<a href="#l6.2777"></a><span id="l6.2777" class="difflineplus">+    let matchedKeysObj = {}; // returned value for matched keys</span>
<a href="#l6.2778"></a><span id="l6.2778" class="difflineplus">+    let details = {};</span>
<a href="#l6.2779"></a><span id="l6.2779" class="difflineplus">+    let keyMap = {};</span>
<a href="#l6.2780"></a><span id="l6.2780" class="difflineplus">+    let flagsObj = {}; // returned value for flags</span>
<a href="#l6.2781"></a><span id="l6.2781" class="difflineplus">+    if (!EnigmailRules.mapAddrsToKeys(toAddrStr,</span>
<a href="#l6.2782"></a><span id="l6.2782" class="difflineplus">+        forceRecipientSettings, // true =&gt; start dialog for addrs without any key</span>
<a href="#l6.2783"></a><span id="l6.2783" class="difflineplus">+        window,</span>
<a href="#l6.2784"></a><span id="l6.2784" class="difflineplus">+        matchedKeysObj,</span>
<a href="#l6.2785"></a><span id="l6.2785" class="difflineplus">+        flagsObj)) {</span>
<a href="#l6.2786"></a><span id="l6.2786" class="difflineplus">+      return null;</span>
<a href="#l6.2787"></a><span id="l6.2787" class="difflineplus">+    }</span>
<a href="#l6.2788"></a><span id="l6.2788" class="difflineplus">+    if (matchedKeysObj.value) {</span>
<a href="#l6.2789"></a><span id="l6.2789" class="difflineplus">+      toAddrStr = matchedKeysObj.value;</span>
<a href="#l6.2790"></a><span id="l6.2790" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): after mapAddrsToKeys() toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.2791"></a><span id="l6.2791" class="difflineplus">+</span>
<a href="#l6.2792"></a><span id="l6.2792" class="difflineplus">+      if (matchedKeysObj.addrKeysList) {</span>
<a href="#l6.2793"></a><span id="l6.2793" class="difflineplus">+        for (let i = 0; i &lt; matchedKeysObj.addrKeysList.length; i++) {</span>
<a href="#l6.2794"></a><span id="l6.2794" class="difflineplus">+          keyMap[matchedKeysObj.addrKeysList[i].addr] = matchedKeysObj.addrKeysList[i].keys;</span>
<a href="#l6.2795"></a><span id="l6.2795" class="difflineplus">+        }</span>
<a href="#l6.2796"></a><span id="l6.2796" class="difflineplus">+      }</span>
<a href="#l6.2797"></a><span id="l6.2797" class="difflineplus">+    }</span>
<a href="#l6.2798"></a><span id="l6.2798" class="difflineplus">+    this.encryptByRules = flagsObj.encrypt;</span>
<a href="#l6.2799"></a><span id="l6.2799" class="difflineplus">+    this.signByRules = flagsObj.sign;</span>
<a href="#l6.2800"></a><span id="l6.2800" class="difflineplus">+    this.pgpmimeByRules = flagsObj.pgpMime;</span>
<a href="#l6.2801"></a><span id="l6.2801" class="difflineplus">+</span>
<a href="#l6.2802"></a><span id="l6.2802" class="difflineplus">+    // if not clear whether to encrypt yet, check whether automatically-send-encrypted applies</span>
<a href="#l6.2803"></a><span id="l6.2803" class="difflineplus">+    // - check whether bcc is empty here? if (bccAddrStr.length === 0)</span>
<a href="#l6.2804"></a><span id="l6.2804" class="difflineplus">+    let validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrStr, details);</span>
<a href="#l6.2805"></a><span id="l6.2805" class="difflineplus">+    if (validKeyList) {</span>
<a href="#l6.2806"></a><span id="l6.2806" class="difflineplus">+      if (toAddrStr.length &gt; 0 &amp;&amp; this.encryptByRules == EnigmailConstants.ENIG_UNDEF &amp;&amp; EnigmailPrefs.getPref(&quot;autoSendEncrypted&quot;) == 1) {</span>
<a href="#l6.2807"></a><span id="l6.2807" class="difflineplus">+        this.encryptByRules = EnigmailConstants.ENIG_AUTO_ALWAYS;</span>
<a href="#l6.2808"></a><span id="l6.2808" class="difflineplus">+        toAddrStr = validKeyList.join(&quot;, &quot;);</span>
<a href="#l6.2809"></a><span id="l6.2809" class="difflineplus">+      }</span>
<a href="#l6.2810"></a><span id="l6.2810" class="difflineplus">+</span>
<a href="#l6.2811"></a><span id="l6.2811" class="difflineplus">+      for (let i in details.keyMap) {</span>
<a href="#l6.2812"></a><span id="l6.2812" class="difflineplus">+        if (i.search(/^0x[0-9A-F]+$/i) &lt; 0) {</span>
<a href="#l6.2813"></a><span id="l6.2813" class="difflineplus">+          keyMap[i] = details.keyMap[i];</span>
<a href="#l6.2814"></a><span id="l6.2814" class="difflineplus">+        }</span>
<a href="#l6.2815"></a><span id="l6.2815" class="difflineplus">+      }</span>
<a href="#l6.2816"></a><span id="l6.2816" class="difflineplus">+    }</span>
<a href="#l6.2817"></a><span id="l6.2817" class="difflineplus">+</span>
<a href="#l6.2818"></a><span id="l6.2818" class="difflineplus">+    // process final state</span>
<a href="#l6.2819"></a><span id="l6.2819" class="difflineplus">+    this.processFinalState(sendFlags);</span>
<a href="#l6.2820"></a><span id="l6.2820" class="difflineplus">+</span>
<a href="#l6.2821"></a><span id="l6.2821" class="difflineplus">+    // final handling of conflicts:</span>
<a href="#l6.2822"></a><span id="l6.2822" class="difflineplus">+    // - pgpMime conflicts always result into pgpMime = 0/'never'</span>
<a href="#l6.2823"></a><span id="l6.2823" class="difflineplus">+    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l6.2824"></a><span id="l6.2824" class="difflineplus">+      this.statusPGPMime = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.2825"></a><span id="l6.2825" class="difflineplus">+    }</span>
<a href="#l6.2826"></a><span id="l6.2826" class="difflineplus">+    // - encrypt/sign conflicts result into result 0/'never'</span>
<a href="#l6.2827"></a><span id="l6.2827" class="difflineplus">+    //   with possible dialog to give a corresponding feedback</span>
<a href="#l6.2828"></a><span id="l6.2828" class="difflineplus">+    var conflictFound = false;</span>
<a href="#l6.2829"></a><span id="l6.2829" class="difflineplus">+    if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l6.2830"></a><span id="l6.2830" class="difflineplus">+      this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.2831"></a><span id="l6.2831" class="difflineplus">+      conflictFound = true;</span>
<a href="#l6.2832"></a><span id="l6.2832" class="difflineplus">+    }</span>
<a href="#l6.2833"></a><span id="l6.2833" class="difflineplus">+    if (this.statusSigned == EnigmailConstants.ENIG_FINAL_CONFLICT) {</span>
<a href="#l6.2834"></a><span id="l6.2834" class="difflineplus">+      this.statusSigned = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.2835"></a><span id="l6.2835" class="difflineplus">+      conflictFound = true;</span>
<a href="#l6.2836"></a><span id="l6.2836" class="difflineplus">+    }</span>
<a href="#l6.2837"></a><span id="l6.2837" class="difflineplus">+    if (conflictFound) {</span>
<a href="#l6.2838"></a><span id="l6.2838" class="difflineplus">+      if (!Enigmail.hlp.processConflicts(this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES || this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES,</span>
<a href="#l6.2839"></a><span id="l6.2839" class="difflineplus">+          this.statusSigned == EnigmailConstants.ENIG_FINAL_YES || this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l6.2840"></a><span id="l6.2840" class="difflineplus">+        return null;</span>
<a href="#l6.2841"></a><span id="l6.2841" class="difflineplus">+      }</span>
<a href="#l6.2842"></a><span id="l6.2842" class="difflineplus">+    }</span>
<a href="#l6.2843"></a><span id="l6.2843" class="difflineplus">+</span>
<a href="#l6.2844"></a><span id="l6.2844" class="difflineplus">+    // process final sendMode</span>
<a href="#l6.2845"></a><span id="l6.2845" class="difflineplus">+    //  ENIG_FINAL_CONFLICT no longer possible</span>
<a href="#l6.2846"></a><span id="l6.2846" class="difflineplus">+    switch (this.statusEncrypted) {</span>
<a href="#l6.2847"></a><span id="l6.2847" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.2848"></a><span id="l6.2848" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.2849"></a><span id="l6.2849" class="difflineplus">+        sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l6.2850"></a><span id="l6.2850" class="difflineplus">+        break;</span>
<a href="#l6.2851"></a><span id="l6.2851" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2852"></a><span id="l6.2852" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2853"></a><span id="l6.2853" class="difflineplus">+        sendFlags |= ENCRYPT;</span>
<a href="#l6.2854"></a><span id="l6.2854" class="difflineplus">+        break;</span>
<a href="#l6.2855"></a><span id="l6.2855" class="difflineplus">+    }</span>
<a href="#l6.2856"></a><span id="l6.2856" class="difflineplus">+    switch (this.statusSigned) {</span>
<a href="#l6.2857"></a><span id="l6.2857" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.2858"></a><span id="l6.2858" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.2859"></a><span id="l6.2859" class="difflineplus">+        sendFlags &amp;= ~SIGN;</span>
<a href="#l6.2860"></a><span id="l6.2860" class="difflineplus">+        break;</span>
<a href="#l6.2861"></a><span id="l6.2861" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2862"></a><span id="l6.2862" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2863"></a><span id="l6.2863" class="difflineplus">+        sendFlags |= SIGN;</span>
<a href="#l6.2864"></a><span id="l6.2864" class="difflineplus">+        break;</span>
<a href="#l6.2865"></a><span id="l6.2865" class="difflineplus">+    }</span>
<a href="#l6.2866"></a><span id="l6.2866" class="difflineplus">+    switch (this.statusPGPMime) {</span>
<a href="#l6.2867"></a><span id="l6.2867" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_NO:</span>
<a href="#l6.2868"></a><span id="l6.2868" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCENO:</span>
<a href="#l6.2869"></a><span id="l6.2869" class="difflineplus">+        sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.2870"></a><span id="l6.2870" class="difflineplus">+        break;</span>
<a href="#l6.2871"></a><span id="l6.2871" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_YES:</span>
<a href="#l6.2872"></a><span id="l6.2872" class="difflineplus">+      case EnigmailConstants.ENIG_FINAL_FORCEYES:</span>
<a href="#l6.2873"></a><span id="l6.2873" class="difflineplus">+        sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.2874"></a><span id="l6.2874" class="difflineplus">+        break;</span>
<a href="#l6.2875"></a><span id="l6.2875" class="difflineplus">+    }</span>
<a href="#l6.2876"></a><span id="l6.2876" class="difflineplus">+</span>
<a href="#l6.2877"></a><span id="l6.2877" class="difflineplus">+    // get keys according to rules for bcc addresses:</span>
<a href="#l6.2878"></a><span id="l6.2878" class="difflineplus">+    // - matchedKeysObj will contain the keys and the remaining bccAddrStr elements</span>
<a href="#l6.2879"></a><span id="l6.2879" class="difflineplus">+    // - NOTE: bcc recipients are ignored when in general computing whether to sign or encrypt or pgpMime</span>
<a href="#l6.2880"></a><span id="l6.2880" class="difflineplus">+    if (!EnigmailRules.mapAddrsToKeys(bccAddrStr,</span>
<a href="#l6.2881"></a><span id="l6.2881" class="difflineplus">+        forceRecipientSettings, // true =&gt; start dialog for addrs without any key</span>
<a href="#l6.2882"></a><span id="l6.2882" class="difflineplus">+        window,</span>
<a href="#l6.2883"></a><span id="l6.2883" class="difflineplus">+        matchedKeysObj,</span>
<a href="#l6.2884"></a><span id="l6.2884" class="difflineplus">+        flagsObj)) {</span>
<a href="#l6.2885"></a><span id="l6.2885" class="difflineplus">+      return null;</span>
<a href="#l6.2886"></a><span id="l6.2886" class="difflineplus">+    }</span>
<a href="#l6.2887"></a><span id="l6.2887" class="difflineplus">+    if (matchedKeysObj.value) {</span>
<a href="#l6.2888"></a><span id="l6.2888" class="difflineplus">+      bccAddrStr = matchedKeysObj.value;</span>
<a href="#l6.2889"></a><span id="l6.2889" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.processRules(): after mapAddrsToKeys() bccAddrStr=\&quot;&quot; + bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.2890"></a><span id="l6.2890" class="difflineplus">+    }</span>
<a href="#l6.2891"></a><span id="l6.2891" class="difflineplus">+</span>
<a href="#l6.2892"></a><span id="l6.2892" class="difflineplus">+    EnigmailLog.DEBUG(&quot;  &lt;=== processRules()\n&quot;);</span>
<a href="#l6.2893"></a><span id="l6.2893" class="difflineplus">+    return {</span>
<a href="#l6.2894"></a><span id="l6.2894" class="difflineplus">+      sendFlags: sendFlags,</span>
<a href="#l6.2895"></a><span id="l6.2895" class="difflineplus">+      optSendFlags: optSendFlags,</span>
<a href="#l6.2896"></a><span id="l6.2896" class="difflineplus">+      toAddr: toAddrStr,</span>
<a href="#l6.2897"></a><span id="l6.2897" class="difflineplus">+      bccAddr: bccAddrStr,</span>
<a href="#l6.2898"></a><span id="l6.2898" class="difflineplus">+      didRefreshKeyList: didRefreshKeyList,</span>
<a href="#l6.2899"></a><span id="l6.2899" class="difflineplus">+      keyMap: keyMap</span>
<a href="#l6.2900"></a><span id="l6.2900" class="difflineplus">+    };</span>
<a href="#l6.2901"></a><span id="l6.2901" class="difflineplus">+  },</span>
<a href="#l6.2902"></a><span id="l6.2902" class="difflineplus">+</span>
<a href="#l6.2903"></a><span id="l6.2903" class="difflineplus">+</span>
<a href="#l6.2904"></a><span id="l6.2904" class="difflineplus">+  /* encrypt a test message to see whether we have all necessary keys</span>
<a href="#l6.2905"></a><span id="l6.2905" class="difflineplus">+   *</span>
<a href="#l6.2906"></a><span id="l6.2906" class="difflineplus">+   * @sendFlags:    all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l6.2907"></a><span id="l6.2907" class="difflineplus">+   * @optSendFlags: may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l6.2908"></a><span id="l6.2908" class="difflineplus">+   * @fromAddr:     from email</span>
<a href="#l6.2909"></a><span id="l6.2909" class="difflineplus">+   * @toAddrStr:    comma separated string of keys and unprocessed to/cc emails</span>
<a href="#l6.2910"></a><span id="l6.2910" class="difflineplus">+   * @bccAddrStr:   comma separated string of keys and unprocessed bcc emails</span>
<a href="#l6.2911"></a><span id="l6.2911" class="difflineplus">+   * @bccAddrList:  bcc receivers</span>
<a href="#l6.2912"></a><span id="l6.2912" class="difflineplus">+   * @return:       doRulesProcessingAgain: start with rule processing once more</span>
<a href="#l6.2913"></a><span id="l6.2913" class="difflineplus">+   *                or null (cancel sending the email)</span>
<a href="#l6.2914"></a><span id="l6.2914" class="difflineplus">+   */</span>
<a href="#l6.2915"></a><span id="l6.2915" class="difflineplus">+  encryptTestMessage: function(enigmailSvc, sendFlags, optSendFlags, fromAddr, toAddrStr, bccAddrStr, bccAddrList, refresh) {</span>
<a href="#l6.2916"></a><span id="l6.2916" class="difflineplus">+    EnigmailLog.DEBUG(&quot;=====&gt; encryptTestMessage()\n&quot;);</span>
<a href="#l6.2917"></a><span id="l6.2917" class="difflineplus">+</span>
<a href="#l6.2918"></a><span id="l6.2918" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.2919"></a><span id="l6.2919" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.2920"></a><span id="l6.2920" class="difflineplus">+</span>
<a href="#l6.2921"></a><span id="l6.2921" class="difflineplus">+    var testCipher = null;</span>
<a href="#l6.2922"></a><span id="l6.2922" class="difflineplus">+    var testExitCodeObj = {};</span>
<a href="#l6.2923"></a><span id="l6.2923" class="difflineplus">+    var testStatusFlagsObj = {};</span>
<a href="#l6.2924"></a><span id="l6.2924" class="difflineplus">+    var testErrorMsgObj = {};</span>
<a href="#l6.2925"></a><span id="l6.2925" class="difflineplus">+</span>
<a href="#l6.2926"></a><span id="l6.2926" class="difflineplus">+    // get keys for remaining email addresses</span>
<a href="#l6.2927"></a><span id="l6.2927" class="difflineplus">+    // - NOTE: This should not be necessary; however, in GPG there is a problem:</span>
<a href="#l6.2928"></a><span id="l6.2928" class="difflineplus">+    //         Only the first key found for an email is used.</span>
<a href="#l6.2929"></a><span id="l6.2929" class="difflineplus">+    //         If this is invalid, no other keys are tested.</span>
<a href="#l6.2930"></a><span id="l6.2930" class="difflineplus">+    //         Thus, WE make it better here in enigmail until the bug is fixed.</span>
<a href="#l6.2931"></a><span id="l6.2931" class="difflineplus">+    var details = {}; // will contain msgList[] afterwards</span>
<a href="#l6.2932"></a><span id="l6.2932" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;assignKeysByEmailAddr&quot;)) {</span>
<a href="#l6.2933"></a><span id="l6.2933" class="difflineplus">+      var validKeyList = Enigmail.hlp.validKeysForAllRecipients(toAddrStr, details);</span>
<a href="#l6.2934"></a><span id="l6.2934" class="difflineplus">+      if (validKeyList) {</span>
<a href="#l6.2935"></a><span id="l6.2935" class="difflineplus">+        toAddrStr = validKeyList.join(&quot;, &quot;);</span>
<a href="#l6.2936"></a><span id="l6.2936" class="difflineplus">+      }</span>
<a href="#l6.2937"></a><span id="l6.2937" class="difflineplus">+    }</span>
<a href="#l6.2938"></a><span id="l6.2938" class="difflineplus">+</span>
<a href="#l6.2939"></a><span id="l6.2939" class="difflineplus">+    // encrypt test message for test recipients</span>
<a href="#l6.2940"></a><span id="l6.2940" class="difflineplus">+    var testPlain = &quot;Test Message&quot;;</span>
<a href="#l6.2941"></a><span id="l6.2941" class="difflineplus">+    var testUiFlags = EnigmailConstants.UI_TEST;</span>
<a href="#l6.2942"></a><span id="l6.2942" class="difflineplus">+    var testSendFlags = EnigmailConstants.SEND_TEST | ENCRYPT | optSendFlags;</span>
<a href="#l6.2943"></a><span id="l6.2943" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptTestMessage(): call encryptMessage() for fromAddr=\&quot;&quot; + fromAddr + &quot;\&quot; toAddrStr=\&quot;&quot; + toAddrStr + &quot;\&quot; bccAddrStr=\&quot;&quot; +</span>
<a href="#l6.2944"></a><span id="l6.2944" class="difflineplus">+      bccAddrStr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.2945"></a><span id="l6.2945" class="difflineplus">+    testCipher = EnigmailEncryption.encryptMessage(window, testUiFlags, testPlain,</span>
<a href="#l6.2946"></a><span id="l6.2946" class="difflineplus">+      fromAddr, toAddrStr, bccAddrStr,</span>
<a href="#l6.2947"></a><span id="l6.2947" class="difflineplus">+      testSendFlags,</span>
<a href="#l6.2948"></a><span id="l6.2948" class="difflineplus">+      testExitCodeObj,</span>
<a href="#l6.2949"></a><span id="l6.2949" class="difflineplus">+      testStatusFlagsObj,</span>
<a href="#l6.2950"></a><span id="l6.2950" class="difflineplus">+      testErrorMsgObj);</span>
<a href="#l6.2951"></a><span id="l6.2951" class="difflineplus">+</span>
<a href="#l6.2952"></a><span id="l6.2952" class="difflineplus">+    if (testStatusFlagsObj.value &amp; (EnigmailConstants.INVALID_RECIPIENT | EnigmailConstants.NO_SECKEY)) {</span>
<a href="#l6.2953"></a><span id="l6.2953" class="difflineplus">+      // check if own key is invalid</span>
<a href="#l6.2954"></a><span id="l6.2954" class="difflineplus">+      EnigmailDialog.alert(window, testErrorMsgObj.value);</span>
<a href="#l6.2955"></a><span id="l6.2955" class="difflineplus">+      return null;</span>
<a href="#l6.2956"></a><span id="l6.2956" class="difflineplus">+    }</span>
<a href="#l6.2957"></a><span id="l6.2957" class="difflineplus">+</span>
<a href="#l6.2958"></a><span id="l6.2958" class="difflineplus">+    // if</span>
<a href="#l6.2959"></a><span id="l6.2959" class="difflineplus">+    // - &quot;always ask/manually&quot; (even if all keys were found) or</span>
<a href="#l6.2960"></a><span id="l6.2960" class="difflineplus">+    // - unless &quot;ask for missing keys&quot;:</span>
<a href="#l6.2961"></a><span id="l6.2961" class="difflineplus">+    //   - we have an invalid recipient or</span>
<a href="#l6.2962"></a><span id="l6.2962" class="difflineplus">+    //   - we could not resolve any/all keys</span>
<a href="#l6.2963"></a><span id="l6.2963" class="difflineplus">+    //     (due to disabled &quot;assignKeysByEmailAddr&quot;&quot; or multiple keys with same trust for a recipient)</span>
<a href="#l6.2964"></a><span id="l6.2964" class="difflineplus">+    // start the dialog for user selected keys</span>
<a href="#l6.2965"></a><span id="l6.2965" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;) ||</span>
<a href="#l6.2966"></a><span id="l6.2966" class="difflineplus">+      (((testStatusFlagsObj.value &amp; EnigmailConstants.INVALID_RECIPIENT) ||</span>
<a href="#l6.2967"></a><span id="l6.2967" class="difflineplus">+          toAddrStr.indexOf('@') &gt;= 0) &amp;&amp;</span>
<a href="#l6.2968"></a><span id="l6.2968" class="difflineplus">+        EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;)) ||</span>
<a href="#l6.2969"></a><span id="l6.2969" class="difflineplus">+      (details &amp;&amp; details.errArray &amp;&amp; details.errArray.length &gt; 0)</span>
<a href="#l6.2970"></a><span id="l6.2970" class="difflineplus">+    ) {</span>
<a href="#l6.2971"></a><span id="l6.2971" class="difflineplus">+</span>
<a href="#l6.2972"></a><span id="l6.2972" class="difflineplus">+      // check for invalid recipient keys</span>
<a href="#l6.2973"></a><span id="l6.2973" class="difflineplus">+      var resultObj = {</span>
<a href="#l6.2974"></a><span id="l6.2974" class="difflineplus">+        foundKeys: false</span>
<a href="#l6.2975"></a><span id="l6.2975" class="difflineplus">+      };</span>
<a href="#l6.2976"></a><span id="l6.2976" class="difflineplus">+      var inputObj = {};</span>
<a href="#l6.2977"></a><span id="l6.2977" class="difflineplus">+      inputObj.toAddr = toAddrStr;</span>
<a href="#l6.2978"></a><span id="l6.2978" class="difflineplus">+      inputObj.invalidAddr = Enigmail.hlp.getInvalidAddress(testErrorMsgObj.value);</span>
<a href="#l6.2979"></a><span id="l6.2979" class="difflineplus">+      if (details &amp;&amp; details.errArray &amp;&amp; details.errArray.length &gt; 0) {</span>
<a href="#l6.2980"></a><span id="l6.2980" class="difflineplus">+        inputObj.errArray = details.errArray;</span>
<a href="#l6.2981"></a><span id="l6.2981" class="difflineplus">+      }</span>
<a href="#l6.2982"></a><span id="l6.2982" class="difflineplus">+</span>
<a href="#l6.2983"></a><span id="l6.2983" class="difflineplus">+      // prepare dialog options:</span>
<a href="#l6.2984"></a><span id="l6.2984" class="difflineplus">+      inputObj.options = &quot;multisel&quot;;</span>
<a href="#l6.2985"></a><span id="l6.2985" class="difflineplus">+      if (EnigmailPrefs.getPref(&quot;assignKeysByRules&quot;)) {</span>
<a href="#l6.2986"></a><span id="l6.2986" class="difflineplus">+        inputObj.options += &quot;,rulesOption&quot;; // enable button to create per-recipient rule</span>
<a href="#l6.2987"></a><span id="l6.2987" class="difflineplus">+      }</span>
<a href="#l6.2988"></a><span id="l6.2988" class="difflineplus">+      if (EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l6.2989"></a><span id="l6.2989" class="difflineplus">+        inputObj.options += &quot;,noforcedisp&quot;;</span>
<a href="#l6.2990"></a><span id="l6.2990" class="difflineplus">+      }</span>
<a href="#l6.2991"></a><span id="l6.2991" class="difflineplus">+      if (!(sendFlags &amp; SIGN)) {</span>
<a href="#l6.2992"></a><span id="l6.2992" class="difflineplus">+        inputObj.options += &quot;,unsigned&quot;;</span>
<a href="#l6.2993"></a><span id="l6.2993" class="difflineplus">+      }</span>
<a href="#l6.2994"></a><span id="l6.2994" class="difflineplus">+      if (this.trustAllKeys) {</span>
<a href="#l6.2995"></a><span id="l6.2995" class="difflineplus">+        inputObj.options += &quot;,trustallkeys&quot;;</span>
<a href="#l6.2996"></a><span id="l6.2996" class="difflineplus">+      }</span>
<a href="#l6.2997"></a><span id="l6.2997" class="difflineplus">+      if (sendFlags &amp; EnigmailConstants.SEND_LATER) {</span>
<a href="#l6.2998"></a><span id="l6.2998" class="difflineplus">+        let sendLaterLabel = EnigmailLocale.getString(&quot;sendLaterCmd.label&quot;);</span>
<a href="#l6.2999"></a><span id="l6.2999" class="difflineplus">+        inputObj.options += &quot;,sendlabel=&quot; + sendLaterLabel;</span>
<a href="#l6.3000"></a><span id="l6.3000" class="difflineplus">+      }</span>
<a href="#l6.3001"></a><span id="l6.3001" class="difflineplus">+      inputObj.options += &quot;,&quot;;</span>
<a href="#l6.3002"></a><span id="l6.3002" class="difflineplus">+      inputObj.dialogHeader = EnigmailLocale.getString(&quot;recipientsSelectionHdr&quot;);</span>
<a href="#l6.3003"></a><span id="l6.3003" class="difflineplus">+</span>
<a href="#l6.3004"></a><span id="l6.3004" class="difflineplus">+      // perform key selection dialog:</span>
<a href="#l6.3005"></a><span id="l6.3005" class="difflineplus">+      window.openDialog(&quot;chrome://openpgp/content/ui/enigmailKeySelection.xul&quot;, &quot;&quot;,</span>
<a href="#l6.3006"></a><span id="l6.3006" class="difflineplus">+        &quot;dialog,modal,centerscreen,resizable&quot;, inputObj, resultObj);</span>
<a href="#l6.3007"></a><span id="l6.3007" class="difflineplus">+</span>
<a href="#l6.3008"></a><span id="l6.3008" class="difflineplus">+      // process result from key selection dialog:</span>
<a href="#l6.3009"></a><span id="l6.3009" class="difflineplus">+      try {</span>
<a href="#l6.3010"></a><span id="l6.3010" class="difflineplus">+        // CANCEL:</span>
<a href="#l6.3011"></a><span id="l6.3011" class="difflineplus">+        if (resultObj.cancelled) {</span>
<a href="#l6.3012"></a><span id="l6.3012" class="difflineplus">+          return null;</span>
<a href="#l6.3013"></a><span id="l6.3013" class="difflineplus">+        }</span>
<a href="#l6.3014"></a><span id="l6.3014" class="difflineplus">+</span>
<a href="#l6.3015"></a><span id="l6.3015" class="difflineplus">+</span>
<a href="#l6.3016"></a><span id="l6.3016" class="difflineplus">+        // repeat checking of rules etc. (e.g. after importing new key)</span>
<a href="#l6.3017"></a><span id="l6.3017" class="difflineplus">+        if (resultObj.repeatEvaluation) {</span>
<a href="#l6.3018"></a><span id="l6.3018" class="difflineplus">+          // THIS is the place that triggers a second iteration</span>
<a href="#l6.3019"></a><span id="l6.3019" class="difflineplus">+          let returnObj = {</span>
<a href="#l6.3020"></a><span id="l6.3020" class="difflineplus">+            doRulesProcessingAgain: true,</span>
<a href="#l6.3021"></a><span id="l6.3021" class="difflineplus">+            createNewRule: false,</span>
<a href="#l6.3022"></a><span id="l6.3022" class="difflineplus">+            sendFlags: sendFlags,</span>
<a href="#l6.3023"></a><span id="l6.3023" class="difflineplus">+            toAddrStr: toAddrStr,</span>
<a href="#l6.3024"></a><span id="l6.3024" class="difflineplus">+            bccAddrStr: bccAddrStr</span>
<a href="#l6.3025"></a><span id="l6.3025" class="difflineplus">+          };</span>
<a href="#l6.3026"></a><span id="l6.3026" class="difflineplus">+</span>
<a href="#l6.3027"></a><span id="l6.3027" class="difflineplus">+          // &quot;Create per recipient rule(s)&quot;:</span>
<a href="#l6.3028"></a><span id="l6.3028" class="difflineplus">+          if (resultObj.perRecipientRules &amp;&amp; this.enableRules) {</span>
<a href="#l6.3029"></a><span id="l6.3029" class="difflineplus">+            // do an extra round because the user wants to set a PGP rule</span>
<a href="#l6.3030"></a><span id="l6.3030" class="difflineplus">+            returnObj.createNewRule = true;</span>
<a href="#l6.3031"></a><span id="l6.3031" class="difflineplus">+          }</span>
<a href="#l6.3032"></a><span id="l6.3032" class="difflineplus">+</span>
<a href="#l6.3033"></a><span id="l6.3033" class="difflineplus">+          return returnObj;</span>
<a href="#l6.3034"></a><span id="l6.3034" class="difflineplus">+        }</span>
<a href="#l6.3035"></a><span id="l6.3035" class="difflineplus">+</span>
<a href="#l6.3036"></a><span id="l6.3036" class="difflineplus">+        // process OK button:</span>
<a href="#l6.3037"></a><span id="l6.3037" class="difflineplus">+        if (resultObj.encrypt) {</span>
<a href="#l6.3038"></a><span id="l6.3038" class="difflineplus">+          sendFlags |= ENCRYPT; // should anyway be set</span>
<a href="#l6.3039"></a><span id="l6.3039" class="difflineplus">+          if (bccAddrList.length &gt; 0) {</span>
<a href="#l6.3040"></a><span id="l6.3040" class="difflineplus">+            toAddrStr = &quot;&quot;;</span>
<a href="#l6.3041"></a><span id="l6.3041" class="difflineplus">+            bccAddrStr = resultObj.userList.join(&quot;, &quot;);</span>
<a href="#l6.3042"></a><span id="l6.3042" class="difflineplus">+          }</span>
<a href="#l6.3043"></a><span id="l6.3043" class="difflineplus">+          else {</span>
<a href="#l6.3044"></a><span id="l6.3044" class="difflineplus">+            toAddrStr = resultObj.userList.join(&quot;, &quot;);</span>
<a href="#l6.3045"></a><span id="l6.3045" class="difflineplus">+            bccAddrStr = &quot;&quot;;</span>
<a href="#l6.3046"></a><span id="l6.3046" class="difflineplus">+          }</span>
<a href="#l6.3047"></a><span id="l6.3047" class="difflineplus">+        }</span>
<a href="#l6.3048"></a><span id="l6.3048" class="difflineplus">+        else {</span>
<a href="#l6.3049"></a><span id="l6.3049" class="difflineplus">+          // encryption explicitely turned off</span>
<a href="#l6.3050"></a><span id="l6.3050" class="difflineplus">+          sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l6.3051"></a><span id="l6.3051" class="difflineplus">+          // counts as forced non-encryption</span>
<a href="#l6.3052"></a><span id="l6.3052" class="difflineplus">+          // (no internal error if different state was processed before)</span>
<a href="#l6.3053"></a><span id="l6.3053" class="difflineplus">+          this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.3054"></a><span id="l6.3054" class="difflineplus">+          this.statusEncryptedInStatusBar = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.3055"></a><span id="l6.3055" class="difflineplus">+        }</span>
<a href="#l6.3056"></a><span id="l6.3056" class="difflineplus">+        if (resultObj.sign) {</span>
<a href="#l6.3057"></a><span id="l6.3057" class="difflineplus">+          sendFlags |= SIGN;</span>
<a href="#l6.3058"></a><span id="l6.3058" class="difflineplus">+        }</span>
<a href="#l6.3059"></a><span id="l6.3059" class="difflineplus">+        else {</span>
<a href="#l6.3060"></a><span id="l6.3060" class="difflineplus">+          sendFlags &amp;= ~SIGN;</span>
<a href="#l6.3061"></a><span id="l6.3061" class="difflineplus">+        }</span>
<a href="#l6.3062"></a><span id="l6.3062" class="difflineplus">+        testCipher = &quot;ok&quot;;</span>
<a href="#l6.3063"></a><span id="l6.3063" class="difflineplus">+        testExitCodeObj.value = 0;</span>
<a href="#l6.3064"></a><span id="l6.3064" class="difflineplus">+      }</span>
<a href="#l6.3065"></a><span id="l6.3065" class="difflineplus">+      catch (ex) {</span>
<a href="#l6.3066"></a><span id="l6.3066" class="difflineplus">+        // cancel pressed -&gt; don't send mail</span>
<a href="#l6.3067"></a><span id="l6.3067" class="difflineplus">+        return null;</span>
<a href="#l6.3068"></a><span id="l6.3068" class="difflineplus">+      }</span>
<a href="#l6.3069"></a><span id="l6.3069" class="difflineplus">+    }</span>
<a href="#l6.3070"></a><span id="l6.3070" class="difflineplus">+    // If test encryption failed and never ask manually, turn off default encryption</span>
<a href="#l6.3071"></a><span id="l6.3071" class="difflineplus">+    if ((!testCipher || (testExitCodeObj.value !== 0)) &amp;&amp;</span>
<a href="#l6.3072"></a><span id="l6.3072" class="difflineplus">+      !EnigmailPrefs.getPref(&quot;assignKeysManuallyIfMissing&quot;) &amp;&amp;</span>
<a href="#l6.3073"></a><span id="l6.3073" class="difflineplus">+      !EnigmailPrefs.getPref(&quot;assignKeysManuallyAlways&quot;)) {</span>
<a href="#l6.3074"></a><span id="l6.3074" class="difflineplus">+      sendFlags &amp;= ~ENCRYPT;</span>
<a href="#l6.3075"></a><span id="l6.3075" class="difflineplus">+      this.statusEncrypted = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.3076"></a><span id="l6.3076" class="difflineplus">+      this.statusEncryptedInStatusBar = EnigmailConstants.ENIG_FINAL_NO;</span>
<a href="#l6.3077"></a><span id="l6.3077" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptTestMessage: No default encryption because test failed\n&quot;);</span>
<a href="#l6.3078"></a><span id="l6.3078" class="difflineplus">+    }</span>
<a href="#l6.3079"></a><span id="l6.3079" class="difflineplus">+    EnigmailLog.DEBUG(&quot;  &lt;=== encryptTestMessage()\n&quot;);</span>
<a href="#l6.3080"></a><span id="l6.3080" class="difflineplus">+    return {</span>
<a href="#l6.3081"></a><span id="l6.3081" class="difflineplus">+      doRulesProcessingAgain: false,</span>
<a href="#l6.3082"></a><span id="l6.3082" class="difflineplus">+      createNewRule: false,</span>
<a href="#l6.3083"></a><span id="l6.3083" class="difflineplus">+      sendFlags: sendFlags,</span>
<a href="#l6.3084"></a><span id="l6.3084" class="difflineplus">+      toAddrStr: toAddrStr,</span>
<a href="#l6.3085"></a><span id="l6.3085" class="difflineplus">+      bccAddrStr: bccAddrStr</span>
<a href="#l6.3086"></a><span id="l6.3086" class="difflineplus">+    };</span>
<a href="#l6.3087"></a><span id="l6.3087" class="difflineplus">+  },</span>
<a href="#l6.3088"></a><span id="l6.3088" class="difflineplus">+</span>
<a href="#l6.3089"></a><span id="l6.3089" class="difflineplus">+  /* Manage the wrapping of inline signed mails</span>
<a href="#l6.3090"></a><span id="l6.3090" class="difflineplus">+   *</span>
<a href="#l6.3091"></a><span id="l6.3091" class="difflineplus">+   * @wrapresultObj: Result:</span>
<a href="#l6.3092"></a><span id="l6.3092" class="difflineplus">+   * @wrapresultObj.cancelled, true if send operation is to be cancelled, else false</span>
<a href="#l6.3093"></a><span id="l6.3093" class="difflineplus">+   * @wrapresultObj.usePpgMime, true if message send option was changed to PGP/MIME, else false</span>
<a href="#l6.3094"></a><span id="l6.3094" class="difflineplus">+   */</span>
<a href="#l6.3095"></a><span id="l6.3095" class="difflineplus">+</span>
<a href="#l6.3096"></a><span id="l6.3096" class="difflineplus">+  wrapInLine: function(wrapresultObj) {</span>
<a href="#l6.3097"></a><span id="l6.3097" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: WrapInLine\n&quot;);</span>
<a href="#l6.3098"></a><span id="l6.3098" class="difflineplus">+    wrapresultObj.cancelled = false;</span>
<a href="#l6.3099"></a><span id="l6.3099" class="difflineplus">+    wrapresultObj.usePpgMime = false;</span>
<a href="#l6.3100"></a><span id="l6.3100" class="difflineplus">+    try {</span>
<a href="#l6.3101"></a><span id="l6.3101" class="difflineplus">+      const dce = Components.interfaces.nsIDocumentEncoder;</span>
<a href="#l6.3102"></a><span id="l6.3102" class="difflineplus">+      var wrapper = gMsgCompose.editor.QueryInterface(Components.interfaces.nsIEditorMailSupport);</span>
<a href="#l6.3103"></a><span id="l6.3103" class="difflineplus">+      var editor = gMsgCompose.editor.QueryInterface(Components.interfaces.nsIPlaintextEditor);</span>
<a href="#l6.3104"></a><span id="l6.3104" class="difflineplus">+      var encoderFlags = dce.OutputFormatted | dce.OutputLFLineBreak;</span>
<a href="#l6.3105"></a><span id="l6.3105" class="difflineplus">+</span>
<a href="#l6.3106"></a><span id="l6.3106" class="difflineplus">+      var wrapWidth = this.getMailPref(&quot;mailnews.wraplength&quot;);</span>
<a href="#l6.3107"></a><span id="l6.3107" class="difflineplus">+      if (wrapWidth &gt; 0 &amp;&amp; wrapWidth &lt; 68 &amp;&amp; editor.wrapWidth &gt; 0) {</span>
<a href="#l6.3108"></a><span id="l6.3108" class="difflineplus">+        if (EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;minimalLineWrapping&quot;, [wrapWidth]))) {</span>
<a href="#l6.3109"></a><span id="l6.3109" class="difflineplus">+          wrapWidth = 68;</span>
<a href="#l6.3110"></a><span id="l6.3110" class="difflineplus">+          EnigmailPrefs.getPrefRoot().setIntPref(&quot;mailnews.wraplength&quot;, wrapWidth);</span>
<a href="#l6.3111"></a><span id="l6.3111" class="difflineplus">+        }</span>
<a href="#l6.3112"></a><span id="l6.3112" class="difflineplus">+      }</span>
<a href="#l6.3113"></a><span id="l6.3113" class="difflineplus">+</span>
<a href="#l6.3114"></a><span id="l6.3114" class="difflineplus">+      if (wrapWidth &amp;&amp; editor.wrapWidth &gt; 0) {</span>
<a href="#l6.3115"></a><span id="l6.3115" class="difflineplus">+        // First use standard editor wrap mechanism:</span>
<a href="#l6.3116"></a><span id="l6.3116" class="difflineplus">+        editor.wrapWidth = wrapWidth - 2;</span>
<a href="#l6.3117"></a><span id="l6.3117" class="difflineplus">+        wrapper.rewrap(true);</span>
<a href="#l6.3118"></a><span id="l6.3118" class="difflineplus">+        editor.wrapWidth = wrapWidth;</span>
<a href="#l6.3119"></a><span id="l6.3119" class="difflineplus">+</span>
<a href="#l6.3120"></a><span id="l6.3120" class="difflineplus">+        // Now get plaintext from editor</span>
<a href="#l6.3121"></a><span id="l6.3121" class="difflineplus">+        var wrapText = this.editorGetContentAs(&quot;text/plain&quot;, encoderFlags);</span>
<a href="#l6.3122"></a><span id="l6.3122" class="difflineplus">+</span>
<a href="#l6.3123"></a><span id="l6.3123" class="difflineplus">+        // split the lines into an array</span>
<a href="#l6.3124"></a><span id="l6.3124" class="difflineplus">+        wrapText = wrapText.split(/\r\n|\r|\n/g);</span>
<a href="#l6.3125"></a><span id="l6.3125" class="difflineplus">+</span>
<a href="#l6.3126"></a><span id="l6.3126" class="difflineplus">+        var i = 0;</span>
<a href="#l6.3127"></a><span id="l6.3127" class="difflineplus">+        var excess = 0;</span>
<a href="#l6.3128"></a><span id="l6.3128" class="difflineplus">+        // inspect all lines of mail text to detect if we still have excessive lines which the &quot;standard&quot; editor wrapper leaves</span>
<a href="#l6.3129"></a><span id="l6.3129" class="difflineplus">+        for (i = 0; i &lt; wrapText.length; i++) {</span>
<a href="#l6.3130"></a><span id="l6.3130" class="difflineplus">+          if (wrapText[i].length &gt; wrapWidth) {</span>
<a href="#l6.3131"></a><span id="l6.3131" class="difflineplus">+            excess = 1;</span>
<a href="#l6.3132"></a><span id="l6.3132" class="difflineplus">+          }</span>
<a href="#l6.3133"></a><span id="l6.3133" class="difflineplus">+        }</span>
<a href="#l6.3134"></a><span id="l6.3134" class="difflineplus">+</span>
<a href="#l6.3135"></a><span id="l6.3135" class="difflineplus">+        if (excess) {</span>
<a href="#l6.3136"></a><span id="l6.3136" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Excess lines detected\n&quot;);</span>
<a href="#l6.3137"></a><span id="l6.3137" class="difflineplus">+          var resultObj = {};</span>
<a href="#l6.3138"></a><span id="l6.3138" class="difflineplus">+          window.openDialog(&quot;chrome://openpgp/content/ui/enigmailWrapSelection.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, resultObj);</span>
<a href="#l6.3139"></a><span id="l6.3139" class="difflineplus">+          try {</span>
<a href="#l6.3140"></a><span id="l6.3140" class="difflineplus">+            if (resultObj.cancelled) {</span>
<a href="#l6.3141"></a><span id="l6.3141" class="difflineplus">+              // cancel pressed -&gt; do not send, return instead.</span>
<a href="#l6.3142"></a><span id="l6.3142" class="difflineplus">+              wrapresultObj.cancelled = true;</span>
<a href="#l6.3143"></a><span id="l6.3143" class="difflineplus">+              return;</span>
<a href="#l6.3144"></a><span id="l6.3144" class="difflineplus">+            }</span>
<a href="#l6.3145"></a><span id="l6.3145" class="difflineplus">+          }</span>
<a href="#l6.3146"></a><span id="l6.3146" class="difflineplus">+          catch (ex) {</span>
<a href="#l6.3147"></a><span id="l6.3147" class="difflineplus">+            // cancel pressed -&gt; do not send, return instead.</span>
<a href="#l6.3148"></a><span id="l6.3148" class="difflineplus">+            wrapresultObj.cancelled = true;</span>
<a href="#l6.3149"></a><span id="l6.3149" class="difflineplus">+            return;</span>
<a href="#l6.3150"></a><span id="l6.3150" class="difflineplus">+          }</span>
<a href="#l6.3151"></a><span id="l6.3151" class="difflineplus">+</span>
<a href="#l6.3152"></a><span id="l6.3152" class="difflineplus">+          var quote = &quot;&quot;;</span>
<a href="#l6.3153"></a><span id="l6.3153" class="difflineplus">+          var limitedLine = &quot;&quot;;</span>
<a href="#l6.3154"></a><span id="l6.3154" class="difflineplus">+          var restOfLine = &quot;&quot;;</span>
<a href="#l6.3155"></a><span id="l6.3155" class="difflineplus">+</span>
<a href="#l6.3156"></a><span id="l6.3156" class="difflineplus">+          var WrapSelect = resultObj.Select;</span>
<a href="#l6.3157"></a><span id="l6.3157" class="difflineplus">+          switch (WrapSelect) {</span>
<a href="#l6.3158"></a><span id="l6.3158" class="difflineplus">+            case &quot;0&quot;: // Selection: Force rewrap</span>
<a href="#l6.3159"></a><span id="l6.3159" class="difflineplus">+              for (i = 0; i &lt; wrapText.length; i++) {</span>
<a href="#l6.3160"></a><span id="l6.3160" class="difflineplus">+                if (wrapText[i].length &gt; wrapWidth) {</span>
<a href="#l6.3161"></a><span id="l6.3161" class="difflineplus">+</span>
<a href="#l6.3162"></a><span id="l6.3162" class="difflineplus">+                  // If the current line is too long, limit it hard to wrapWidth and insert the rest as the next line into wrapText array</span>
<a href="#l6.3163"></a><span id="l6.3163" class="difflineplus">+                  limitedLine = wrapText[i].slice(0, wrapWidth);</span>
<a href="#l6.3164"></a><span id="l6.3164" class="difflineplus">+                  restOfLine = wrapText[i].slice(wrapWidth);</span>
<a href="#l6.3165"></a><span id="l6.3165" class="difflineplus">+</span>
<a href="#l6.3166"></a><span id="l6.3166" class="difflineplus">+                  // We should add quotes at the beginning of &quot;restOfLine&quot;, if limitedLine is a quoted line</span>
<a href="#l6.3167"></a><span id="l6.3167" class="difflineplus">+                  // However, this would be purely academic, because limitedLine will always be &quot;standard&quot;-wrapped</span>
<a href="#l6.3168"></a><span id="l6.3168" class="difflineplus">+                  // by the editor-rewrapper at the space between quote sign (&gt;) and the quoted text.</span>
<a href="#l6.3169"></a><span id="l6.3169" class="difflineplus">+</span>
<a href="#l6.3170"></a><span id="l6.3170" class="difflineplus">+                  wrapText.splice(i, 1, limitedLine, restOfLine);</span>
<a href="#l6.3171"></a><span id="l6.3171" class="difflineplus">+                }</span>
<a href="#l6.3172"></a><span id="l6.3172" class="difflineplus">+              }</span>
<a href="#l6.3173"></a><span id="l6.3173" class="difflineplus">+              break;</span>
<a href="#l6.3174"></a><span id="l6.3174" class="difflineplus">+            case &quot;1&quot;: // Selection: Send as is</span>
<a href="#l6.3175"></a><span id="l6.3175" class="difflineplus">+              break;</span>
<a href="#l6.3176"></a><span id="l6.3176" class="difflineplus">+            case &quot;2&quot;: // Selection: Use MIME</span>
<a href="#l6.3177"></a><span id="l6.3177" class="difflineplus">+              wrapresultObj.usePpgMime = true;</span>
<a href="#l6.3178"></a><span id="l6.3178" class="difflineplus">+              break;</span>
<a href="#l6.3179"></a><span id="l6.3179" class="difflineplus">+            case &quot;3&quot;: // Selection: Edit manually -&gt; do not send, return instead.</span>
<a href="#l6.3180"></a><span id="l6.3180" class="difflineplus">+              wrapresultObj.cancelled = true;</span>
<a href="#l6.3181"></a><span id="l6.3181" class="difflineplus">+              return;</span>
<a href="#l6.3182"></a><span id="l6.3182" class="difflineplus">+          } //switch</span>
<a href="#l6.3183"></a><span id="l6.3183" class="difflineplus">+        }</span>
<a href="#l6.3184"></a><span id="l6.3184" class="difflineplus">+        // Now join all lines together again and feed it back into the compose editor.</span>
<a href="#l6.3185"></a><span id="l6.3185" class="difflineplus">+        var newtext = wrapText.join(&quot;\n&quot;);</span>
<a href="#l6.3186"></a><span id="l6.3186" class="difflineplus">+        this.replaceEditorText(newtext);</span>
<a href="#l6.3187"></a><span id="l6.3187" class="difflineplus">+      }</span>
<a href="#l6.3188"></a><span id="l6.3188" class="difflineplus">+    }</span>
<a href="#l6.3189"></a><span id="l6.3189" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.3190"></a><span id="l6.3190" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Exception while wrapping=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l6.3191"></a><span id="l6.3191" class="difflineplus">+    }</span>
<a href="#l6.3192"></a><span id="l6.3192" class="difflineplus">+</span>
<a href="#l6.3193"></a><span id="l6.3193" class="difflineplus">+  },</span>
<a href="#l6.3194"></a><span id="l6.3194" class="difflineplus">+</span>
<a href="#l6.3195"></a><span id="l6.3195" class="difflineplus">+  // Save draft message. We do not want most of the other processing for encrypted mails here...</span>
<a href="#l6.3196"></a><span id="l6.3196" class="difflineplus">+  saveDraftMessage: function() {</span>
<a href="#l6.3197"></a><span id="l6.3197" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: saveDraftMessage()\n&quot;);</span>
<a href="#l6.3198"></a><span id="l6.3198" class="difflineplus">+</span>
<a href="#l6.3199"></a><span id="l6.3199" class="difflineplus">+</span>
<a href="#l6.3200"></a><span id="l6.3200" class="difflineplus">+    let doEncrypt = this.isEnigmailEnabled() &amp;&amp; this.identity.getBoolAttribute(&quot;autoEncryptDrafts&quot;);</span>
<a href="#l6.3201"></a><span id="l6.3201" class="difflineplus">+</span>
<a href="#l6.3202"></a><span id="l6.3202" class="difflineplus">+    this.setDraftStatus(doEncrypt);</span>
<a href="#l6.3203"></a><span id="l6.3203" class="difflineplus">+</span>
<a href="#l6.3204"></a><span id="l6.3204" class="difflineplus">+    if (!doEncrypt) {</span>
<a href="#l6.3205"></a><span id="l6.3205" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: drafts disabled\n&quot;);</span>
<a href="#l6.3206"></a><span id="l6.3206" class="difflineplus">+</span>
<a href="#l6.3207"></a><span id="l6.3207" class="difflineplus">+      try {</span>
<a href="#l6.3208"></a><span id="l6.3208" class="difflineplus">+        if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l6.3209"></a><span id="l6.3209" class="difflineplus">+          Enigmail.msg.getSecurityParams().wrappedJSObject.sendFlags = 0;</span>
<a href="#l6.3210"></a><span id="l6.3210" class="difflineplus">+        }</span>
<a href="#l6.3211"></a><span id="l6.3211" class="difflineplus">+      }</span>
<a href="#l6.3212"></a><span id="l6.3212" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.3213"></a><span id="l6.3213" class="difflineplus">+</span>
<a href="#l6.3214"></a><span id="l6.3214" class="difflineplus">+      return true;</span>
<a href="#l6.3215"></a><span id="l6.3215" class="difflineplus">+    }</span>
<a href="#l6.3216"></a><span id="l6.3216" class="difflineplus">+</span>
<a href="#l6.3217"></a><span id="l6.3217" class="difflineplus">+    let sendFlags = EnigmailConstants.SEND_PGP_MIME | EnigmailConstants.SEND_ENCRYPTED | EnigmailConstants.SAVE_MESSAGE | EnigmailConstants.SEND_ALWAYS_TRUST;</span>
<a href="#l6.3218"></a><span id="l6.3218" class="difflineplus">+</span>
<a href="#l6.3219"></a><span id="l6.3219" class="difflineplus">+    if (this.protectHeaders) {</span>
<a href="#l6.3220"></a><span id="l6.3220" class="difflineplus">+      sendFlags |= EnigmailConstants.ENCRYPT_HEADERS;</span>
<a href="#l6.3221"></a><span id="l6.3221" class="difflineplus">+    }</span>
<a href="#l6.3222"></a><span id="l6.3222" class="difflineplus">+</span>
<a href="#l6.3223"></a><span id="l6.3223" class="difflineplus">+    let fromAddr = this.identity.email;</span>
<a href="#l6.3224"></a><span id="l6.3224" class="difflineplus">+    let userIdValue = this.getSenderUserId();</span>
<a href="#l6.3225"></a><span id="l6.3225" class="difflineplus">+    if (userIdValue) {</span>
<a href="#l6.3226"></a><span id="l6.3226" class="difflineplus">+      fromAddr = userIdValue;</span>
<a href="#l6.3227"></a><span id="l6.3227" class="difflineplus">+    }</span>
<a href="#l6.3228"></a><span id="l6.3228" class="difflineplus">+</span>
<a href="#l6.3229"></a><span id="l6.3229" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.3230"></a><span id="l6.3230" class="difflineplus">+    if (!enigmailSvc) return true;</span>
<a href="#l6.3231"></a><span id="l6.3231" class="difflineplus">+</span>
<a href="#l6.3232"></a><span id="l6.3232" class="difflineplus">+    if (this.preferPgpOverSmime(sendFlags) === 0) return true; // use S/MIME</span>
<a href="#l6.3233"></a><span id="l6.3233" class="difflineplus">+</span>
<a href="#l6.3234"></a><span id="l6.3234" class="difflineplus">+    // Try to save draft</span>
<a href="#l6.3235"></a><span id="l6.3235" class="difflineplus">+</span>
<a href="#l6.3236"></a><span id="l6.3236" class="difflineplus">+    var testCipher = null;</span>
<a href="#l6.3237"></a><span id="l6.3237" class="difflineplus">+    var testExitCodeObj = {};</span>
<a href="#l6.3238"></a><span id="l6.3238" class="difflineplus">+    var testStatusFlagsObj = {};</span>
<a href="#l6.3239"></a><span id="l6.3239" class="difflineplus">+    var testErrorMsgObj = {};</span>
<a href="#l6.3240"></a><span id="l6.3240" class="difflineplus">+</span>
<a href="#l6.3241"></a><span id="l6.3241" class="difflineplus">+    // encrypt test message for test recipients</span>
<a href="#l6.3242"></a><span id="l6.3242" class="difflineplus">+    var testPlain = &quot;Test Message&quot;;</span>
<a href="#l6.3243"></a><span id="l6.3243" class="difflineplus">+    var testUiFlags = EnigmailConstants.UI_TEST;</span>
<a href="#l6.3244"></a><span id="l6.3244" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.saveDraft(): call encryptMessage() for fromAddr=\&quot;&quot; + fromAddr + &quot;\&quot;\n&quot;);</span>
<a href="#l6.3245"></a><span id="l6.3245" class="difflineplus">+    testCipher = EnigmailEncryption.encryptMessage(null, testUiFlags, testPlain,</span>
<a href="#l6.3246"></a><span id="l6.3246" class="difflineplus">+      fromAddr, fromAddr, &quot;&quot;,</span>
<a href="#l6.3247"></a><span id="l6.3247" class="difflineplus">+      sendFlags | EnigmailConstants.SEND_TEST,</span>
<a href="#l6.3248"></a><span id="l6.3248" class="difflineplus">+      testExitCodeObj,</span>
<a href="#l6.3249"></a><span id="l6.3249" class="difflineplus">+      testStatusFlagsObj,</span>
<a href="#l6.3250"></a><span id="l6.3250" class="difflineplus">+      testErrorMsgObj);</span>
<a href="#l6.3251"></a><span id="l6.3251" class="difflineplus">+</span>
<a href="#l6.3252"></a><span id="l6.3252" class="difflineplus">+    if (testStatusFlagsObj.value &amp; (EnigmailConstants.INVALID_RECIPIENT | EnigmailConstants.NO_SECKEY)) {</span>
<a href="#l6.3253"></a><span id="l6.3253" class="difflineplus">+      // check if own key is invalid</span>
<a href="#l6.3254"></a><span id="l6.3254" class="difflineplus">+      if (testErrorMsgObj.value &amp;&amp; testErrorMsgObj.value.length &gt; 0) {</span>
<a href="#l6.3255"></a><span id="l6.3255" class="difflineplus">+        ++this.saveDraftError;</span>
<a href="#l6.3256"></a><span id="l6.3256" class="difflineplus">+        if (this.saveDraftError === 1) {</span>
<a href="#l6.3257"></a><span id="l6.3257" class="difflineplus">+          this.notifyUser(3, EnigmailLocale.getString(&quot;msgCompose.cannotSaveDraft&quot;), &quot;saveDraftFailed&quot;,</span>
<a href="#l6.3258"></a><span id="l6.3258" class="difflineplus">+            testErrorMsgObj.value);</span>
<a href="#l6.3259"></a><span id="l6.3259" class="difflineplus">+        }</span>
<a href="#l6.3260"></a><span id="l6.3260" class="difflineplus">+        return false;</span>
<a href="#l6.3261"></a><span id="l6.3261" class="difflineplus">+      }</span>
<a href="#l6.3262"></a><span id="l6.3262" class="difflineplus">+    }</span>
<a href="#l6.3263"></a><span id="l6.3263" class="difflineplus">+</span>
<a href="#l6.3264"></a><span id="l6.3264" class="difflineplus">+    let secInfo;</span>
<a href="#l6.3265"></a><span id="l6.3265" class="difflineplus">+</span>
<a href="#l6.3266"></a><span id="l6.3266" class="difflineplus">+    if (EnigmailMimeEncrypt.isEnigmailCompField(Enigmail.msg.getSecurityParams())) {</span>
<a href="#l6.3267"></a><span id="l6.3267" class="difflineplus">+      secInfo = Enigmail.msg.getSecurityParams().wrappedJSObject;</span>
<a href="#l6.3268"></a><span id="l6.3268" class="difflineplus">+    }</span>
<a href="#l6.3269"></a><span id="l6.3269" class="difflineplus">+    else {</span>
<a href="#l6.3270"></a><span id="l6.3270" class="difflineplus">+      try {</span>
<a href="#l6.3271"></a><span id="l6.3271" class="difflineplus">+        secInfo = EnigmailMimeEncrypt.createMimeEncrypt(Enigmail.msg.getSecurityParams());</span>
<a href="#l6.3272"></a><span id="l6.3272" class="difflineplus">+        if (secInfo) {</span>
<a href="#l6.3273"></a><span id="l6.3273" class="difflineplus">+          Enigmail.msg.setSecurityParams(secInfo);</span>
<a href="#l6.3274"></a><span id="l6.3274" class="difflineplus">+        }</span>
<a href="#l6.3275"></a><span id="l6.3275" class="difflineplus">+      }</span>
<a href="#l6.3276"></a><span id="l6.3276" class="difflineplus">+      catch (ex) {</span>
<a href="#l6.3277"></a><span id="l6.3277" class="difflineplus">+        EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.saveDraftMessage&quot;, ex);</span>
<a href="#l6.3278"></a><span id="l6.3278" class="difflineplus">+        return false;</span>
<a href="#l6.3279"></a><span id="l6.3279" class="difflineplus">+      }</span>
<a href="#l6.3280"></a><span id="l6.3280" class="difflineplus">+    }</span>
<a href="#l6.3281"></a><span id="l6.3281" class="difflineplus">+</span>
<a href="#l6.3282"></a><span id="l6.3282" class="difflineplus">+    secInfo.sendFlags = sendFlags;</span>
<a href="#l6.3283"></a><span id="l6.3283" class="difflineplus">+    secInfo.UIFlags = 0;</span>
<a href="#l6.3284"></a><span id="l6.3284" class="difflineplus">+    secInfo.senderEmailAddr = fromAddr;</span>
<a href="#l6.3285"></a><span id="l6.3285" class="difflineplus">+    secInfo.recipients = fromAddr;</span>
<a href="#l6.3286"></a><span id="l6.3286" class="difflineplus">+    secInfo.bccRecipients = &quot;&quot;;</span>
<a href="#l6.3287"></a><span id="l6.3287" class="difflineplus">+    secInfo.originalSubject = gMsgCompose.compFields.subject;</span>
<a href="#l6.3288"></a><span id="l6.3288" class="difflineplus">+    this.dirty = true;</span>
<a href="#l6.3289"></a><span id="l6.3289" class="difflineplus">+</span>
<a href="#l6.3290"></a><span id="l6.3290" class="difflineplus">+    if (this.protectHeaders) {</span>
<a href="#l6.3291"></a><span id="l6.3291" class="difflineplus">+      gMsgCompose.compFields.subject = &quot;&quot;;</span>
<a href="#l6.3292"></a><span id="l6.3292" class="difflineplus">+    }</span>
<a href="#l6.3293"></a><span id="l6.3293" class="difflineplus">+</span>
<a href="#l6.3294"></a><span id="l6.3294" class="difflineplus">+    return true;</span>
<a href="#l6.3295"></a><span id="l6.3295" class="difflineplus">+  },</span>
<a href="#l6.3296"></a><span id="l6.3296" class="difflineplus">+</span>
<a href="#l6.3297"></a><span id="l6.3297" class="difflineplus">+  createEnigmailSecurityFields: function(oldSecurityInfo) {</span>
<a href="#l6.3298"></a><span id="l6.3298" class="difflineplus">+    let newSecurityInfo = EnigmailMimeEncrypt.createMimeEncrypt(Enigmail.msg.getSecurityParams());</span>
<a href="#l6.3299"></a><span id="l6.3299" class="difflineplus">+</span>
<a href="#l6.3300"></a><span id="l6.3300" class="difflineplus">+    if (!newSecurityInfo)</span>
<a href="#l6.3301"></a><span id="l6.3301" class="difflineplus">+      throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l6.3302"></a><span id="l6.3302" class="difflineplus">+</span>
<a href="#l6.3303"></a><span id="l6.3303" class="difflineplus">+    Enigmail.msg.setSecurityParams(newSecurityInfo);</span>
<a href="#l6.3304"></a><span id="l6.3304" class="difflineplus">+  },</span>
<a href="#l6.3305"></a><span id="l6.3305" class="difflineplus">+</span>
<a href="#l6.3306"></a><span id="l6.3306" class="difflineplus">+  isSendConfirmationRequired: function(sendFlags) {</span>
<a href="#l6.3307"></a><span id="l6.3307" class="difflineplus">+    // process whether final confirmation is necessary</span>
<a href="#l6.3308"></a><span id="l6.3308" class="difflineplus">+</span>
<a href="#l6.3309"></a><span id="l6.3309" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3310"></a><span id="l6.3310" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3311"></a><span id="l6.3311" class="difflineplus">+</span>
<a href="#l6.3312"></a><span id="l6.3312" class="difflineplus">+    let confirm = false;</span>
<a href="#l6.3313"></a><span id="l6.3313" class="difflineplus">+    let confPref = EnigmailPrefs.getPref(&quot;confirmBeforeSending&quot;);</span>
<a href="#l6.3314"></a><span id="l6.3314" class="difflineplus">+    switch (confPref) {</span>
<a href="#l6.3315"></a><span id="l6.3315" class="difflineplus">+      case 0: // never</span>
<a href="#l6.3316"></a><span id="l6.3316" class="difflineplus">+        confirm = false;</span>
<a href="#l6.3317"></a><span id="l6.3317" class="difflineplus">+        break;</span>
<a href="#l6.3318"></a><span id="l6.3318" class="difflineplus">+      case 1: // always</span>
<a href="#l6.3319"></a><span id="l6.3319" class="difflineplus">+        confirm = true;</span>
<a href="#l6.3320"></a><span id="l6.3320" class="difflineplus">+        break;</span>
<a href="#l6.3321"></a><span id="l6.3321" class="difflineplus">+      case 2: // if send encrypted</span>
<a href="#l6.3322"></a><span id="l6.3322" class="difflineplus">+        confirm = ((sendFlags &amp; ENCRYPT) == ENCRYPT);</span>
<a href="#l6.3323"></a><span id="l6.3323" class="difflineplus">+        break;</span>
<a href="#l6.3324"></a><span id="l6.3324" class="difflineplus">+      case 3: // if send unencrypted</span>
<a href="#l6.3325"></a><span id="l6.3325" class="difflineplus">+        confirm = ((sendFlags &amp; ENCRYPT) === 0);</span>
<a href="#l6.3326"></a><span id="l6.3326" class="difflineplus">+        break;</span>
<a href="#l6.3327"></a><span id="l6.3327" class="difflineplus">+      case 4: // if encryption changed due to rules</span>
<a href="#l6.3328"></a><span id="l6.3328" class="difflineplus">+        confirm = ((sendFlags &amp; ENCRYPT) != (this.sendMode &amp; ENCRYPT));</span>
<a href="#l6.3329"></a><span id="l6.3329" class="difflineplus">+        break;</span>
<a href="#l6.3330"></a><span id="l6.3330" class="difflineplus">+    }</span>
<a href="#l6.3331"></a><span id="l6.3331" class="difflineplus">+</span>
<a href="#l6.3332"></a><span id="l6.3332" class="difflineplus">+    // double check that no internal error did result in broken promise of encryption</span>
<a href="#l6.3333"></a><span id="l6.3333" class="difflineplus">+    // - if NOT send encrypted</span>
<a href="#l6.3334"></a><span id="l6.3334" class="difflineplus">+    //   - although encryption was</span>
<a href="#l6.3335"></a><span id="l6.3335" class="difflineplus">+    //     - the recent processed resulting encryption status or</span>
<a href="#l6.3336"></a><span id="l6.3336" class="difflineplus">+    //     - was signaled in the status bar but is not the outcome now</span>
<a href="#l6.3337"></a><span id="l6.3337" class="difflineplus">+    if ((sendFlags &amp; ENCRYPT) === 0 &amp;&amp;</span>
<a href="#l6.3338"></a><span id="l6.3338" class="difflineplus">+      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_SMIME &amp;&amp;</span>
<a href="#l6.3339"></a><span id="l6.3339" class="difflineplus">+      this.statusPGPMime !== EnigmailConstants.ENIG_FINAL_FORCESMIME &amp;&amp;</span>
<a href="#l6.3340"></a><span id="l6.3340" class="difflineplus">+      (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.3341"></a><span id="l6.3341" class="difflineplus">+        this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES ||</span>
<a href="#l6.3342"></a><span id="l6.3342" class="difflineplus">+        this.statusEncryptedInStatusBar == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.3343"></a><span id="l6.3343" class="difflineplus">+        this.statusEncryptedInStatusBar == EnigmailConstants.ENIG_FINAL_FORCEYES)) {</span>
<a href="#l6.3344"></a><span id="l6.3344" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.isSendConfirmationRequired: promised encryption did not succeed\n&quot;);</span>
<a href="#l6.3345"></a><span id="l6.3345" class="difflineplus">+      if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l6.3346"></a><span id="l6.3346" class="difflineplus">+          EnigmailLocale.getString(&quot;msgCompose.internalEncryptionError&quot;),</span>
<a href="#l6.3347"></a><span id="l6.3347" class="difflineplus">+          EnigmailLocale.getString(&quot;msgCompose.button.sendAnyway&quot;))) {</span>
<a href="#l6.3348"></a><span id="l6.3348" class="difflineplus">+        return null; // cancel sending</span>
<a href="#l6.3349"></a><span id="l6.3349" class="difflineplus">+      }</span>
<a href="#l6.3350"></a><span id="l6.3350" class="difflineplus">+      // without canceling sending, force firnal confirmation</span>
<a href="#l6.3351"></a><span id="l6.3351" class="difflineplus">+      confirm = true;</span>
<a href="#l6.3352"></a><span id="l6.3352" class="difflineplus">+    }</span>
<a href="#l6.3353"></a><span id="l6.3353" class="difflineplus">+</span>
<a href="#l6.3354"></a><span id="l6.3354" class="difflineplus">+    return confirm;</span>
<a href="#l6.3355"></a><span id="l6.3355" class="difflineplus">+  },</span>
<a href="#l6.3356"></a><span id="l6.3356" class="difflineplus">+</span>
<a href="#l6.3357"></a><span id="l6.3357" class="difflineplus">+  compileFromAndTo: function() {</span>
<a href="#l6.3358"></a><span id="l6.3358" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.compileFromAndTo\n&quot;);</span>
<a href="#l6.3359"></a><span id="l6.3359" class="difflineplus">+    let compFields = gMsgCompose.compFields;</span>
<a href="#l6.3360"></a><span id="l6.3360" class="difflineplus">+    let toAddrList = [];</span>
<a href="#l6.3361"></a><span id="l6.3361" class="difflineplus">+    let recList;</span>
<a href="#l6.3362"></a><span id="l6.3362" class="difflineplus">+    let arrLen = {};</span>
<a href="#l6.3363"></a><span id="l6.3363" class="difflineplus">+</span>
<a href="#l6.3364"></a><span id="l6.3364" class="difflineplus">+    if (!Enigmail.msg.composeBodyReady) {</span>
<a href="#l6.3365"></a><span id="l6.3365" class="difflineplus">+      compFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l6.3366"></a><span id="l6.3366" class="difflineplus">+    }</span>
<a href="#l6.3367"></a><span id="l6.3367" class="difflineplus">+    Recipients2CompFields(compFields);</span>
<a href="#l6.3368"></a><span id="l6.3368" class="difflineplus">+    gMsgCompose.expandMailingLists();</span>
<a href="#l6.3369"></a><span id="l6.3369" class="difflineplus">+</span>
<a href="#l6.3370"></a><span id="l6.3370" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: to='&quot; + compFields.to + &quot;'\n&quot;);</span>
<a href="#l6.3371"></a><span id="l6.3371" class="difflineplus">+    if (compFields.to.length &gt; 0) {</span>
<a href="#l6.3372"></a><span id="l6.3372" class="difflineplus">+      toAddrList = EnigmailFuncs.parseEmails(compFields.to, false);</span>
<a href="#l6.3373"></a><span id="l6.3373" class="difflineplus">+    }</span>
<a href="#l6.3374"></a><span id="l6.3374" class="difflineplus">+</span>
<a href="#l6.3375"></a><span id="l6.3375" class="difflineplus">+    if (compFields.cc.length &gt; 0) {</span>
<a href="#l6.3376"></a><span id="l6.3376" class="difflineplus">+      toAddrList = toAddrList.concat(EnigmailFuncs.parseEmails(compFields.cc, false));</span>
<a href="#l6.3377"></a><span id="l6.3377" class="difflineplus">+    }</span>
<a href="#l6.3378"></a><span id="l6.3378" class="difflineplus">+</span>
<a href="#l6.3379"></a><span id="l6.3379" class="difflineplus">+    if (compFields.bcc.length &gt; 0) {</span>
<a href="#l6.3380"></a><span id="l6.3380" class="difflineplus">+      toAddrList = toAddrList.concat(EnigmailFuncs.parseEmails(compFields.bcc, false));</span>
<a href="#l6.3381"></a><span id="l6.3381" class="difflineplus">+    }</span>
<a href="#l6.3382"></a><span id="l6.3382" class="difflineplus">+</span>
<a href="#l6.3383"></a><span id="l6.3383" class="difflineplus">+    for (let addr of toAddrList) {</span>
<a href="#l6.3384"></a><span id="l6.3384" class="difflineplus">+      // determine incomplete addresses --&gt; do not attempt pEp encryption</span>
<a href="#l6.3385"></a><span id="l6.3385" class="difflineplus">+      if (addr.email.search(/.@./) &lt; 0) return null;</span>
<a href="#l6.3386"></a><span id="l6.3386" class="difflineplus">+    }</span>
<a href="#l6.3387"></a><span id="l6.3387" class="difflineplus">+</span>
<a href="#l6.3388"></a><span id="l6.3388" class="difflineplus">+    this.identity = getCurrentIdentity();</span>
<a href="#l6.3389"></a><span id="l6.3389" class="difflineplus">+    let from = {</span>
<a href="#l6.3390"></a><span id="l6.3390" class="difflineplus">+      email: this.identity.email,</span>
<a href="#l6.3391"></a><span id="l6.3391" class="difflineplus">+      name: this.identity.fullName</span>
<a href="#l6.3392"></a><span id="l6.3392" class="difflineplus">+    };</span>
<a href="#l6.3393"></a><span id="l6.3393" class="difflineplus">+    return {</span>
<a href="#l6.3394"></a><span id="l6.3394" class="difflineplus">+      from: from,</span>
<a href="#l6.3395"></a><span id="l6.3395" class="difflineplus">+      toAddrList: toAddrList</span>
<a href="#l6.3396"></a><span id="l6.3396" class="difflineplus">+    };</span>
<a href="#l6.3397"></a><span id="l6.3397" class="difflineplus">+  },</span>
<a href="#l6.3398"></a><span id="l6.3398" class="difflineplus">+</span>
<a href="#l6.3399"></a><span id="l6.3399" class="difflineplus">+  sendSmimeEncrypted: function(msgSendType, sendFlags, isOffline) {</span>
<a href="#l6.3400"></a><span id="l6.3400" class="difflineplus">+    let recList;</span>
<a href="#l6.3401"></a><span id="l6.3401" class="difflineplus">+    let toAddrList = [];</span>
<a href="#l6.3402"></a><span id="l6.3402" class="difflineplus">+    let arrLen = {};</span>
<a href="#l6.3403"></a><span id="l6.3403" class="difflineplus">+    const DeliverMode = Ci.nsIMsgCompDeliverMode;</span>
<a href="#l6.3404"></a><span id="l6.3404" class="difflineplus">+</span>
<a href="#l6.3405"></a><span id="l6.3405" class="difflineplus">+    switch (msgSendType) {</span>
<a href="#l6.3406"></a><span id="l6.3406" class="difflineplus">+      case DeliverMode.SaveAsDraft:</span>
<a href="#l6.3407"></a><span id="l6.3407" class="difflineplus">+      case DeliverMode.SaveAsTemplate:</span>
<a href="#l6.3408"></a><span id="l6.3408" class="difflineplus">+      case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l6.3409"></a><span id="l6.3409" class="difflineplus">+        break;</span>
<a href="#l6.3410"></a><span id="l6.3410" class="difflineplus">+      default:</span>
<a href="#l6.3411"></a><span id="l6.3411" class="difflineplus">+        if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l6.3412"></a><span id="l6.3412" class="difflineplus">+          this.attachOwnKey();</span>
<a href="#l6.3413"></a><span id="l6.3413" class="difflineplus">+          Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l6.3414"></a><span id="l6.3414" class="difflineplus">+        }</span>
<a href="#l6.3415"></a><span id="l6.3415" class="difflineplus">+    }</span>
<a href="#l6.3416"></a><span id="l6.3416" class="difflineplus">+</span>
<a href="#l6.3417"></a><span id="l6.3417" class="difflineplus">+    gSMFields.signMessage = (sendFlags &amp; EnigmailConstants.SEND_SIGNED ? true : false);</span>
<a href="#l6.3418"></a><span id="l6.3418" class="difflineplus">+    gSMFields.requireEncryptMessage = (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED ? true : false);</span>
<a href="#l6.3419"></a><span id="l6.3419" class="difflineplus">+</span>
<a href="#l6.3420"></a><span id="l6.3420" class="difflineplus">+    Enigmail.msg.setSecurityParams(gSMFields);</span>
<a href="#l6.3421"></a><span id="l6.3421" class="difflineplus">+</span>
<a href="#l6.3422"></a><span id="l6.3422" class="difflineplus">+    let conf = this.isSendConfirmationRequired(sendFlags);</span>
<a href="#l6.3423"></a><span id="l6.3423" class="difflineplus">+</span>
<a href="#l6.3424"></a><span id="l6.3424" class="difflineplus">+    if (conf === null) return false;</span>
<a href="#l6.3425"></a><span id="l6.3425" class="difflineplus">+    if (conf) {</span>
<a href="#l6.3426"></a><span id="l6.3426" class="difflineplus">+      // confirm before send requested</span>
<a href="#l6.3427"></a><span id="l6.3427" class="difflineplus">+      let msgCompFields = gMsgCompose.compFields;</span>
<a href="#l6.3428"></a><span id="l6.3428" class="difflineplus">+      let splitRecipients = msgCompFields.splitRecipients;</span>
<a href="#l6.3429"></a><span id="l6.3429" class="difflineplus">+</span>
<a href="#l6.3430"></a><span id="l6.3430" class="difflineplus">+      if (msgCompFields.to.length &gt; 0) {</span>
<a href="#l6.3431"></a><span id="l6.3431" class="difflineplus">+        recList = splitRecipients(msgCompFields.to, true, arrLen);</span>
<a href="#l6.3432"></a><span id="l6.3432" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3433"></a><span id="l6.3433" class="difflineplus">+      }</span>
<a href="#l6.3434"></a><span id="l6.3434" class="difflineplus">+</span>
<a href="#l6.3435"></a><span id="l6.3435" class="difflineplus">+      if (msgCompFields.cc.length &gt; 0) {</span>
<a href="#l6.3436"></a><span id="l6.3436" class="difflineplus">+        recList = splitRecipients(msgCompFields.cc, true, arrLen);</span>
<a href="#l6.3437"></a><span id="l6.3437" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3438"></a><span id="l6.3438" class="difflineplus">+      }</span>
<a href="#l6.3439"></a><span id="l6.3439" class="difflineplus">+</span>
<a href="#l6.3440"></a><span id="l6.3440" class="difflineplus">+      switch (msgSendType) {</span>
<a href="#l6.3441"></a><span id="l6.3441" class="difflineplus">+        case DeliverMode.SaveAsDraft:</span>
<a href="#l6.3442"></a><span id="l6.3442" class="difflineplus">+        case DeliverMode.SaveAsTemplate:</span>
<a href="#l6.3443"></a><span id="l6.3443" class="difflineplus">+        case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l6.3444"></a><span id="l6.3444" class="difflineplus">+          break;</span>
<a href="#l6.3445"></a><span id="l6.3445" class="difflineplus">+        default:</span>
<a href="#l6.3446"></a><span id="l6.3446" class="difflineplus">+          if (!this.confirmBeforeSend(toAddrList.join(&quot;, &quot;), &quot;&quot;, sendFlags, isOffline)) {</span>
<a href="#l6.3447"></a><span id="l6.3447" class="difflineplus">+            return false;</span>
<a href="#l6.3448"></a><span id="l6.3448" class="difflineplus">+          }</span>
<a href="#l6.3449"></a><span id="l6.3449" class="difflineplus">+      }</span>
<a href="#l6.3450"></a><span id="l6.3450" class="difflineplus">+    }</span>
<a href="#l6.3451"></a><span id="l6.3451" class="difflineplus">+</span>
<a href="#l6.3452"></a><span id="l6.3452" class="difflineplus">+    return true;</span>
<a href="#l6.3453"></a><span id="l6.3453" class="difflineplus">+  },</span>
<a href="#l6.3454"></a><span id="l6.3454" class="difflineplus">+</span>
<a href="#l6.3455"></a><span id="l6.3455" class="difflineplus">+  getEncryptionFlags: function(msgSendType) {</span>
<a href="#l6.3456"></a><span id="l6.3456" class="difflineplus">+    let gotSendFlags = this.sendMode;</span>
<a href="#l6.3457"></a><span id="l6.3457" class="difflineplus">+    let sendFlags = 0;</span>
<a href="#l6.3458"></a><span id="l6.3458" class="difflineplus">+</span>
<a href="#l6.3459"></a><span id="l6.3459" class="difflineplus">+    // here we process the final state:</span>
<a href="#l6.3460"></a><span id="l6.3460" class="difflineplus">+    if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.3461"></a><span id="l6.3461" class="difflineplus">+      this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.3462"></a><span id="l6.3462" class="difflineplus">+      gotSendFlags |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3463"></a><span id="l6.3463" class="difflineplus">+    }</span>
<a href="#l6.3464"></a><span id="l6.3464" class="difflineplus">+    else if (this.statusEncrypted == EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l6.3465"></a><span id="l6.3465" class="difflineplus">+      gotSendFlags &amp;= ~EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3466"></a><span id="l6.3466" class="difflineplus">+    }</span>
<a href="#l6.3467"></a><span id="l6.3467" class="difflineplus">+</span>
<a href="#l6.3468"></a><span id="l6.3468" class="difflineplus">+    if (this.statusSigned == EnigmailConstants.ENIG_FINAL_YES ||</span>
<a href="#l6.3469"></a><span id="l6.3469" class="difflineplus">+      this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCEYES) {</span>
<a href="#l6.3470"></a><span id="l6.3470" class="difflineplus">+      gotSendFlags |= EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3471"></a><span id="l6.3471" class="difflineplus">+    }</span>
<a href="#l6.3472"></a><span id="l6.3472" class="difflineplus">+    else if (this.statusSigned == EnigmailConstants.ENIG_FINAL_FORCENO) {</span>
<a href="#l6.3473"></a><span id="l6.3473" class="difflineplus">+      gotSendFlags &amp;= ~EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3474"></a><span id="l6.3474" class="difflineplus">+    }</span>
<a href="#l6.3475"></a><span id="l6.3475" class="difflineplus">+</span>
<a href="#l6.3476"></a><span id="l6.3476" class="difflineplus">+    if (gotSendFlags &amp; EnigmailConstants.SEND_SIGNED)</span>
<a href="#l6.3477"></a><span id="l6.3477" class="difflineplus">+      sendFlags |= EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3478"></a><span id="l6.3478" class="difflineplus">+    if (gotSendFlags &amp; EnigmailConstants.SEND_ENCRYPTED)</span>
<a href="#l6.3479"></a><span id="l6.3479" class="difflineplus">+      sendFlags |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3480"></a><span id="l6.3480" class="difflineplus">+</span>
<a href="#l6.3481"></a><span id="l6.3481" class="difflineplus">+    if (msgSendType === Ci.nsIMsgCompDeliverMode.Later) {</span>
<a href="#l6.3482"></a><span id="l6.3482" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getEncryptionFlags: adding SEND_LATER\n&quot;);</span>
<a href="#l6.3483"></a><span id="l6.3483" class="difflineplus">+      sendFlags |= EnigmailConstants.SEND_LATER;</span>
<a href="#l6.3484"></a><span id="l6.3484" class="difflineplus">+    }</span>
<a href="#l6.3485"></a><span id="l6.3485" class="difflineplus">+</span>
<a href="#l6.3486"></a><span id="l6.3486" class="difflineplus">+    return {</span>
<a href="#l6.3487"></a><span id="l6.3487" class="difflineplus">+      sendFlags: sendFlags,</span>
<a href="#l6.3488"></a><span id="l6.3488" class="difflineplus">+      gotSendFlags: gotSendFlags</span>
<a href="#l6.3489"></a><span id="l6.3489" class="difflineplus">+    };</span>
<a href="#l6.3490"></a><span id="l6.3490" class="difflineplus">+  },</span>
<a href="#l6.3491"></a><span id="l6.3491" class="difflineplus">+</span>
<a href="#l6.3492"></a><span id="l6.3492" class="difflineplus">+  resetDirty: function() {</span>
<a href="#l6.3493"></a><span id="l6.3493" class="difflineplus">+    let newSecurityInfo = null;</span>
<a href="#l6.3494"></a><span id="l6.3494" class="difflineplus">+</span>
<a href="#l6.3495"></a><span id="l6.3495" class="difflineplus">+    if (this.dirty) {</span>
<a href="#l6.3496"></a><span id="l6.3496" class="difflineplus">+      // make sure the sendFlags are reset before the message is processed</span>
<a href="#l6.3497"></a><span id="l6.3497" class="difflineplus">+      // (it may have been set by a previously cancelled send operation!)</span>
<a href="#l6.3498"></a><span id="l6.3498" class="difflineplus">+</span>
<a href="#l6.3499"></a><span id="l6.3499" class="difflineplus">+      let si = Enigmail.msg.getSecurityParams();</span>
<a href="#l6.3500"></a><span id="l6.3500" class="difflineplus">+</span>
<a href="#l6.3501"></a><span id="l6.3501" class="difflineplus">+      if (EnigmailMimeEncrypt.isEnigmailCompField(si)) {</span>
<a href="#l6.3502"></a><span id="l6.3502" class="difflineplus">+        si.sendFlags = 0;</span>
<a href="#l6.3503"></a><span id="l6.3503" class="difflineplus">+        si.originalSubject = gMsgCompose.compFields.subject;</span>
<a href="#l6.3504"></a><span id="l6.3504" class="difflineplus">+      }</span>
<a href="#l6.3505"></a><span id="l6.3505" class="difflineplus">+      else {</span>
<a href="#l6.3506"></a><span id="l6.3506" class="difflineplus">+        try {</span>
<a href="#l6.3507"></a><span id="l6.3507" class="difflineplus">+          newSecurityInfo = EnigmailMimeEncrypt.createMimeEncrypt(si);</span>
<a href="#l6.3508"></a><span id="l6.3508" class="difflineplus">+          if (newSecurityInfo) {</span>
<a href="#l6.3509"></a><span id="l6.3509" class="difflineplus">+            newSecurityInfo.sendFlags = 0;</span>
<a href="#l6.3510"></a><span id="l6.3510" class="difflineplus">+            newSecurityInfo.originalSubject = gMsgCompose.compFields.subject;</span>
<a href="#l6.3511"></a><span id="l6.3511" class="difflineplus">+</span>
<a href="#l6.3512"></a><span id="l6.3512" class="difflineplus">+            Enigmail.msg.setSecurityParams(newSecurityInfo);</span>
<a href="#l6.3513"></a><span id="l6.3513" class="difflineplus">+          }</span>
<a href="#l6.3514"></a><span id="l6.3514" class="difflineplus">+        }</span>
<a href="#l6.3515"></a><span id="l6.3515" class="difflineplus">+        catch (ex) {</span>
<a href="#l6.3516"></a><span id="l6.3516" class="difflineplus">+          EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.resetDirty&quot;, ex);</span>
<a href="#l6.3517"></a><span id="l6.3517" class="difflineplus">+        }</span>
<a href="#l6.3518"></a><span id="l6.3518" class="difflineplus">+      }</span>
<a href="#l6.3519"></a><span id="l6.3519" class="difflineplus">+    }</span>
<a href="#l6.3520"></a><span id="l6.3520" class="difflineplus">+</span>
<a href="#l6.3521"></a><span id="l6.3521" class="difflineplus">+    return newSecurityInfo;</span>
<a href="#l6.3522"></a><span id="l6.3522" class="difflineplus">+  },</span>
<a href="#l6.3523"></a><span id="l6.3523" class="difflineplus">+</span>
<a href="#l6.3524"></a><span id="l6.3524" class="difflineplus">+  determineMsgRecipients: function(sendFlags) {</span>
<a href="#l6.3525"></a><span id="l6.3525" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.determineMsgRecipients: currentId=&quot; + this.identity +</span>
<a href="#l6.3526"></a><span id="l6.3526" class="difflineplus">+      &quot;, &quot; + this.identity.email + &quot;\n&quot;);</span>
<a href="#l6.3527"></a><span id="l6.3527" class="difflineplus">+</span>
<a href="#l6.3528"></a><span id="l6.3528" class="difflineplus">+    let promptSvc = EnigmailDialog.getPromptSvc();</span>
<a href="#l6.3529"></a><span id="l6.3529" class="difflineplus">+    let fromAddr = this.identity.email;</span>
<a href="#l6.3530"></a><span id="l6.3530" class="difflineplus">+    let toAddrList = [];</span>
<a href="#l6.3531"></a><span id="l6.3531" class="difflineplus">+    let recList;</span>
<a href="#l6.3532"></a><span id="l6.3532" class="difflineplus">+    let bccAddrList = [];</span>
<a href="#l6.3533"></a><span id="l6.3533" class="difflineplus">+    let arrLen = {};</span>
<a href="#l6.3534"></a><span id="l6.3534" class="difflineplus">+    let splitRecipients;</span>
<a href="#l6.3535"></a><span id="l6.3535" class="difflineplus">+</span>
<a href="#l6.3536"></a><span id="l6.3536" class="difflineplus">+    if (!this.isEnigmailEnabled()) return true;</span>
<a href="#l6.3537"></a><span id="l6.3537" class="difflineplus">+</span>
<a href="#l6.3538"></a><span id="l6.3538" class="difflineplus">+    let optSendFlags = 0;</span>
<a href="#l6.3539"></a><span id="l6.3539" class="difflineplus">+    let msgCompFields = gMsgCompose.compFields;</span>
<a href="#l6.3540"></a><span id="l6.3540" class="difflineplus">+    let newsgroups = msgCompFields.newsgroups;</span>
<a href="#l6.3541"></a><span id="l6.3541" class="difflineplus">+</span>
<a href="#l6.3542"></a><span id="l6.3542" class="difflineplus">+    // request or preference to always accept (even non-authenticated) keys?</span>
<a href="#l6.3543"></a><span id="l6.3543" class="difflineplus">+    if (this.trustAllKeys) {</span>
<a href="#l6.3544"></a><span id="l6.3544" class="difflineplus">+      optSendFlags |= EnigmailConstants.SEND_ALWAYS_TRUST;</span>
<a href="#l6.3545"></a><span id="l6.3545" class="difflineplus">+    }</span>
<a href="#l6.3546"></a><span id="l6.3546" class="difflineplus">+    else {</span>
<a href="#l6.3547"></a><span id="l6.3547" class="difflineplus">+      let acceptedKeys = EnigmailPrefs.getPref(&quot;acceptedKeys&quot;);</span>
<a href="#l6.3548"></a><span id="l6.3548" class="difflineplus">+      switch (acceptedKeys) {</span>
<a href="#l6.3549"></a><span id="l6.3549" class="difflineplus">+        case 0: // accept valid/authenticated keys only</span>
<a href="#l6.3550"></a><span id="l6.3550" class="difflineplus">+          break;</span>
<a href="#l6.3551"></a><span id="l6.3551" class="difflineplus">+        case 1: // accept all but revoked/disabled/expired keys</span>
<a href="#l6.3552"></a><span id="l6.3552" class="difflineplus">+          optSendFlags |= EnigmailConstants.SEND_ALWAYS_TRUST;</span>
<a href="#l6.3553"></a><span id="l6.3553" class="difflineplus">+          break;</span>
<a href="#l6.3554"></a><span id="l6.3554" class="difflineplus">+        default:</span>
<a href="#l6.3555"></a><span id="l6.3555" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.determineMsgRecipients: INVALID VALUE for acceptedKeys: \&quot;&quot; + acceptedKeys + &quot;\&quot;\n&quot;);</span>
<a href="#l6.3556"></a><span id="l6.3556" class="difflineplus">+          break;</span>
<a href="#l6.3557"></a><span id="l6.3557" class="difflineplus">+      }</span>
<a href="#l6.3558"></a><span id="l6.3558" class="difflineplus">+    }</span>
<a href="#l6.3559"></a><span id="l6.3559" class="difflineplus">+</span>
<a href="#l6.3560"></a><span id="l6.3560" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;encryptToSelf&quot;)) {</span>
<a href="#l6.3561"></a><span id="l6.3561" class="difflineplus">+      optSendFlags |= EnigmailConstants.SEND_ENCRYPT_TO_SELF;</span>
<a href="#l6.3562"></a><span id="l6.3562" class="difflineplus">+    }</span>
<a href="#l6.3563"></a><span id="l6.3563" class="difflineplus">+</span>
<a href="#l6.3564"></a><span id="l6.3564" class="difflineplus">+    sendFlags |= optSendFlags;</span>
<a href="#l6.3565"></a><span id="l6.3565" class="difflineplus">+</span>
<a href="#l6.3566"></a><span id="l6.3566" class="difflineplus">+    var userIdValue = this.getSenderUserId();</span>
<a href="#l6.3567"></a><span id="l6.3567" class="difflineplus">+    if (userIdValue) {</span>
<a href="#l6.3568"></a><span id="l6.3568" class="difflineplus">+      fromAddr = userIdValue;</span>
<a href="#l6.3569"></a><span id="l6.3569" class="difflineplus">+    }</span>
<a href="#l6.3570"></a><span id="l6.3570" class="difflineplus">+</span>
<a href="#l6.3571"></a><span id="l6.3571" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.determineMsgRecipients:gMsgCompose=&quot; + gMsgCompose + &quot;\n&quot;);</span>
<a href="#l6.3572"></a><span id="l6.3572" class="difflineplus">+</span>
<a href="#l6.3573"></a><span id="l6.3573" class="difflineplus">+    splitRecipients = msgCompFields.splitRecipients;</span>
<a href="#l6.3574"></a><span id="l6.3574" class="difflineplus">+</span>
<a href="#l6.3575"></a><span id="l6.3575" class="difflineplus">+    if (msgCompFields.to.length &gt; 0) {</span>
<a href="#l6.3576"></a><span id="l6.3576" class="difflineplus">+      recList = splitRecipients(msgCompFields.to, true, arrLen);</span>
<a href="#l6.3577"></a><span id="l6.3577" class="difflineplus">+      this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3578"></a><span id="l6.3578" class="difflineplus">+    }</span>
<a href="#l6.3579"></a><span id="l6.3579" class="difflineplus">+</span>
<a href="#l6.3580"></a><span id="l6.3580" class="difflineplus">+    if (msgCompFields.cc.length &gt; 0) {</span>
<a href="#l6.3581"></a><span id="l6.3581" class="difflineplus">+      recList = splitRecipients(msgCompFields.cc, true, arrLen);</span>
<a href="#l6.3582"></a><span id="l6.3582" class="difflineplus">+      this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3583"></a><span id="l6.3583" class="difflineplus">+    }</span>
<a href="#l6.3584"></a><span id="l6.3584" class="difflineplus">+</span>
<a href="#l6.3585"></a><span id="l6.3585" class="difflineplus">+    // special handling of bcc:</span>
<a href="#l6.3586"></a><span id="l6.3586" class="difflineplus">+    // - note: bcc and encryption is a problem</span>
<a href="#l6.3587"></a><span id="l6.3587" class="difflineplus">+    // - but bcc to the sender is fine</span>
<a href="#l6.3588"></a><span id="l6.3588" class="difflineplus">+    if (msgCompFields.bcc.length &gt; 0) {</span>
<a href="#l6.3589"></a><span id="l6.3589" class="difflineplus">+      recList = splitRecipients(msgCompFields.bcc, true, arrLen);</span>
<a href="#l6.3590"></a><span id="l6.3590" class="difflineplus">+</span>
<a href="#l6.3591"></a><span id="l6.3591" class="difflineplus">+      var bccLC = &quot;&quot;;</span>
<a href="#l6.3592"></a><span id="l6.3592" class="difflineplus">+      try {</span>
<a href="#l6.3593"></a><span id="l6.3593" class="difflineplus">+        bccLC = EnigmailFuncs.stripEmail(msgCompFields.bcc).toLowerCase();</span>
<a href="#l6.3594"></a><span id="l6.3594" class="difflineplus">+      }</span>
<a href="#l6.3595"></a><span id="l6.3595" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.3596"></a><span id="l6.3596" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.determineMsgRecipients: BCC: &quot; + bccLC + &quot;\n&quot;);</span>
<a href="#l6.3597"></a><span id="l6.3597" class="difflineplus">+</span>
<a href="#l6.3598"></a><span id="l6.3598" class="difflineplus">+      var selfBCC = this.identity.email &amp;&amp; (this.identity.email.toLowerCase() == bccLC);</span>
<a href="#l6.3599"></a><span id="l6.3599" class="difflineplus">+</span>
<a href="#l6.3600"></a><span id="l6.3600" class="difflineplus">+      if (selfBCC) {</span>
<a href="#l6.3601"></a><span id="l6.3601" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.determineMsgRecipients: Self BCC\n&quot;);</span>
<a href="#l6.3602"></a><span id="l6.3602" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3603"></a><span id="l6.3603" class="difflineplus">+</span>
<a href="#l6.3604"></a><span id="l6.3604" class="difflineplus">+      }</span>
<a href="#l6.3605"></a><span id="l6.3605" class="difflineplus">+      else if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.3606"></a><span id="l6.3606" class="difflineplus">+        // BCC and encryption</span>
<a href="#l6.3607"></a><span id="l6.3607" class="difflineplus">+</span>
<a href="#l6.3608"></a><span id="l6.3608" class="difflineplus">+        var dummy = {</span>
<a href="#l6.3609"></a><span id="l6.3609" class="difflineplus">+          value: null</span>
<a href="#l6.3610"></a><span id="l6.3610" class="difflineplus">+        };</span>
<a href="#l6.3611"></a><span id="l6.3611" class="difflineplus">+</span>
<a href="#l6.3612"></a><span id="l6.3612" class="difflineplus">+        var hideBccUsers = promptSvc.confirmEx(window,</span>
<a href="#l6.3613"></a><span id="l6.3613" class="difflineplus">+          EnigmailLocale.getString(&quot;enigConfirm&quot;),</span>
<a href="#l6.3614"></a><span id="l6.3614" class="difflineplus">+          EnigmailLocale.getString(&quot;sendingHiddenRcpt&quot;), (promptSvc.BUTTON_TITLE_IS_STRING * promptSvc.BUTTON_POS_0) +</span>
<a href="#l6.3615"></a><span id="l6.3615" class="difflineplus">+          (promptSvc.BUTTON_TITLE_CANCEL * promptSvc.BUTTON_POS_1) +</span>
<a href="#l6.3616"></a><span id="l6.3616" class="difflineplus">+          (promptSvc.BUTTON_TITLE_IS_STRING * promptSvc.BUTTON_POS_2),</span>
<a href="#l6.3617"></a><span id="l6.3617" class="difflineplus">+          EnigmailLocale.getString(&quot;sendWithShownBcc&quot;),</span>
<a href="#l6.3618"></a><span id="l6.3618" class="difflineplus">+          null,</span>
<a href="#l6.3619"></a><span id="l6.3619" class="difflineplus">+          EnigmailLocale.getString(&quot;sendWithHiddenBcc&quot;),</span>
<a href="#l6.3620"></a><span id="l6.3620" class="difflineplus">+          null,</span>
<a href="#l6.3621"></a><span id="l6.3621" class="difflineplus">+          dummy);</span>
<a href="#l6.3622"></a><span id="l6.3622" class="difflineplus">+        switch (hideBccUsers) {</span>
<a href="#l6.3623"></a><span id="l6.3623" class="difflineplus">+          case 2:</span>
<a href="#l6.3624"></a><span id="l6.3624" class="difflineplus">+            this.addRecipients(bccAddrList, recList);</span>
<a href="#l6.3625"></a><span id="l6.3625" class="difflineplus">+            this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3626"></a><span id="l6.3626" class="difflineplus">+            break;</span>
<a href="#l6.3627"></a><span id="l6.3627" class="difflineplus">+          case 0:</span>
<a href="#l6.3628"></a><span id="l6.3628" class="difflineplus">+            this.addRecipients(toAddrList, recList);</span>
<a href="#l6.3629"></a><span id="l6.3629" class="difflineplus">+            break;</span>
<a href="#l6.3630"></a><span id="l6.3630" class="difflineplus">+          case 1:</span>
<a href="#l6.3631"></a><span id="l6.3631" class="difflineplus">+            return false;</span>
<a href="#l6.3632"></a><span id="l6.3632" class="difflineplus">+        }</span>
<a href="#l6.3633"></a><span id="l6.3633" class="difflineplus">+      }</span>
<a href="#l6.3634"></a><span id="l6.3634" class="difflineplus">+    }</span>
<a href="#l6.3635"></a><span id="l6.3635" class="difflineplus">+</span>
<a href="#l6.3636"></a><span id="l6.3636" class="difflineplus">+    if (newsgroups) {</span>
<a href="#l6.3637"></a><span id="l6.3637" class="difflineplus">+      toAddrList.push(newsgroups);</span>
<a href="#l6.3638"></a><span id="l6.3638" class="difflineplus">+</span>
<a href="#l6.3639"></a><span id="l6.3639" class="difflineplus">+      if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.3640"></a><span id="l6.3640" class="difflineplus">+        if (!EnigmailPrefs.getPref(&quot;encryptToNews&quot;)) {</span>
<a href="#l6.3641"></a><span id="l6.3641" class="difflineplus">+          EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;sendingNews&quot;));</span>
<a href="#l6.3642"></a><span id="l6.3642" class="difflineplus">+          return false;</span>
<a href="#l6.3643"></a><span id="l6.3643" class="difflineplus">+        }</span>
<a href="#l6.3644"></a><span id="l6.3644" class="difflineplus">+        else if (!EnigmailDialog.confirmPref(window,</span>
<a href="#l6.3645"></a><span id="l6.3645" class="difflineplus">+            EnigmailLocale.getString(&quot;sendToNewsWarning&quot;),</span>
<a href="#l6.3646"></a><span id="l6.3646" class="difflineplus">+            &quot;warnOnSendingNewsgroups&quot;,</span>
<a href="#l6.3647"></a><span id="l6.3647" class="difflineplus">+            EnigmailLocale.getString(&quot;msgCompose.button.send&quot;))) {</span>
<a href="#l6.3648"></a><span id="l6.3648" class="difflineplus">+          return false;</span>
<a href="#l6.3649"></a><span id="l6.3649" class="difflineplus">+        }</span>
<a href="#l6.3650"></a><span id="l6.3650" class="difflineplus">+      }</span>
<a href="#l6.3651"></a><span id="l6.3651" class="difflineplus">+    }</span>
<a href="#l6.3652"></a><span id="l6.3652" class="difflineplus">+</span>
<a href="#l6.3653"></a><span id="l6.3653" class="difflineplus">+    return {</span>
<a href="#l6.3654"></a><span id="l6.3654" class="difflineplus">+      sendFlags: sendFlags,</span>
<a href="#l6.3655"></a><span id="l6.3655" class="difflineplus">+      optSendFlags: optSendFlags,</span>
<a href="#l6.3656"></a><span id="l6.3656" class="difflineplus">+      fromAddr: fromAddr,</span>
<a href="#l6.3657"></a><span id="l6.3657" class="difflineplus">+      toAddrList: toAddrList,</span>
<a href="#l6.3658"></a><span id="l6.3658" class="difflineplus">+      bccAddrList: bccAddrList</span>
<a href="#l6.3659"></a><span id="l6.3659" class="difflineplus">+    };</span>
<a href="#l6.3660"></a><span id="l6.3660" class="difflineplus">+  },</span>
<a href="#l6.3661"></a><span id="l6.3661" class="difflineplus">+</span>
<a href="#l6.3662"></a><span id="l6.3662" class="difflineplus">+  appendInlineAttachments: function(sendFlags) {</span>
<a href="#l6.3663"></a><span id="l6.3663" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: appendInlineAttachments()\n&quot;);</span>
<a href="#l6.3664"></a><span id="l6.3664" class="difflineplus">+</span>
<a href="#l6.3665"></a><span id="l6.3665" class="difflineplus">+    let bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l6.3666"></a><span id="l6.3666" class="difflineplus">+    let hasAttachments = ((bucketList &amp;&amp; bucketList.hasChildNodes()) || gMsgCompose.compFields.attachVCard);</span>
<a href="#l6.3667"></a><span id="l6.3667" class="difflineplus">+    let inlineEncAttach = false;</span>
<a href="#l6.3668"></a><span id="l6.3668" class="difflineplus">+</span>
<a href="#l6.3669"></a><span id="l6.3669" class="difflineplus">+    if (hasAttachments &amp;&amp;</span>
<a href="#l6.3670"></a><span id="l6.3670" class="difflineplus">+      (sendFlags &amp; (EnigmailConstants.SEND_ENCRYPTED | EnigmailConstants.SEND_SIGNED)) &amp;&amp;</span>
<a href="#l6.3671"></a><span id="l6.3671" class="difflineplus">+      !(sendFlags &amp; EnigmailConstants.SEND_PGP_MIME)) {</span>
<a href="#l6.3672"></a><span id="l6.3672" class="difflineplus">+</span>
<a href="#l6.3673"></a><span id="l6.3673" class="difflineplus">+      let inputObj = {</span>
<a href="#l6.3674"></a><span id="l6.3674" class="difflineplus">+        pgpMimePossible: true,</span>
<a href="#l6.3675"></a><span id="l6.3675" class="difflineplus">+        inlinePossible: true,</span>
<a href="#l6.3676"></a><span id="l6.3676" class="difflineplus">+        restrictedScenario: false,</span>
<a href="#l6.3677"></a><span id="l6.3677" class="difflineplus">+        reasonForCheck: &quot;&quot;</span>
<a href="#l6.3678"></a><span id="l6.3678" class="difflineplus">+      };</span>
<a href="#l6.3679"></a><span id="l6.3679" class="difflineplus">+      // init reason for dialog to be able to use the right labels</span>
<a href="#l6.3680"></a><span id="l6.3680" class="difflineplus">+      if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.3681"></a><span id="l6.3681" class="difflineplus">+        if (sendFlags &amp; EnigmailConstants.SEND_SIGNED) {</span>
<a href="#l6.3682"></a><span id="l6.3682" class="difflineplus">+          inputObj.reasonForCheck = &quot;encryptAndSign&quot;;</span>
<a href="#l6.3683"></a><span id="l6.3683" class="difflineplus">+        }</span>
<a href="#l6.3684"></a><span id="l6.3684" class="difflineplus">+        else {</span>
<a href="#l6.3685"></a><span id="l6.3685" class="difflineplus">+          inputObj.reasonForCheck = &quot;encrypt&quot;;</span>
<a href="#l6.3686"></a><span id="l6.3686" class="difflineplus">+        }</span>
<a href="#l6.3687"></a><span id="l6.3687" class="difflineplus">+      }</span>
<a href="#l6.3688"></a><span id="l6.3688" class="difflineplus">+      else {</span>
<a href="#l6.3689"></a><span id="l6.3689" class="difflineplus">+        if (sendFlags &amp; EnigmailConstants.SEND_SIGNED) {</span>
<a href="#l6.3690"></a><span id="l6.3690" class="difflineplus">+          inputObj.reasonForCheck = &quot;sign&quot;;</span>
<a href="#l6.3691"></a><span id="l6.3691" class="difflineplus">+        }</span>
<a href="#l6.3692"></a><span id="l6.3692" class="difflineplus">+      }</span>
<a href="#l6.3693"></a><span id="l6.3693" class="difflineplus">+</span>
<a href="#l6.3694"></a><span id="l6.3694" class="difflineplus">+      // determine if attachments are all local files (currently the only</span>
<a href="#l6.3695"></a><span id="l6.3695" class="difflineplus">+      // supported kind of attachments)</span>
<a href="#l6.3696"></a><span id="l6.3696" class="difflineplus">+      let node = bucketList.firstChild;</span>
<a href="#l6.3697"></a><span id="l6.3697" class="difflineplus">+      while (node) {</span>
<a href="#l6.3698"></a><span id="l6.3698" class="difflineplus">+        if (node.attachment.url.substring(0, 7) != &quot;file://&quot;) {</span>
<a href="#l6.3699"></a><span id="l6.3699" class="difflineplus">+          inputObj.inlinePossible = false;</span>
<a href="#l6.3700"></a><span id="l6.3700" class="difflineplus">+        }</span>
<a href="#l6.3701"></a><span id="l6.3701" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l6.3702"></a><span id="l6.3702" class="difflineplus">+      }</span>
<a href="#l6.3703"></a><span id="l6.3703" class="difflineplus">+</span>
<a href="#l6.3704"></a><span id="l6.3704" class="difflineplus">+      if (inputObj.pgpMimePossible || inputObj.inlinePossible) {</span>
<a href="#l6.3705"></a><span id="l6.3705" class="difflineplus">+        let resultObj = {</span>
<a href="#l6.3706"></a><span id="l6.3706" class="difflineplus">+          selected: EnigmailPrefs.getPref(&quot;encryptAttachments&quot;)</span>
<a href="#l6.3707"></a><span id="l6.3707" class="difflineplus">+        };</span>
<a href="#l6.3708"></a><span id="l6.3708" class="difflineplus">+</span>
<a href="#l6.3709"></a><span id="l6.3709" class="difflineplus">+        //skip or not</span>
<a href="#l6.3710"></a><span id="l6.3710" class="difflineplus">+        var skipCheck = EnigmailPrefs.getPref(&quot;encryptAttachmentsSkipDlg&quot;);</span>
<a href="#l6.3711"></a><span id="l6.3711" class="difflineplus">+        if (skipCheck == 1) {</span>
<a href="#l6.3712"></a><span id="l6.3712" class="difflineplus">+          if ((resultObj.selected == 2 &amp;&amp; inputObj.pgpMimePossible === false) || (resultObj.selected == 1 &amp;&amp; inputObj.inlinePossible === false)) {</span>
<a href="#l6.3713"></a><span id="l6.3713" class="difflineplus">+            //add var to disable remember box since we're dealing with restricted scenarios...</span>
<a href="#l6.3714"></a><span id="l6.3714" class="difflineplus">+            inputObj.restrictedScenario = true;</span>
<a href="#l6.3715"></a><span id="l6.3715" class="difflineplus">+            resultObj.selected = -1;</span>
<a href="#l6.3716"></a><span id="l6.3716" class="difflineplus">+            window.openDialog(&quot;chrome://openpgp/content/ui/enigmailAttachmentsDialog.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj, resultObj);</span>
<a href="#l6.3717"></a><span id="l6.3717" class="difflineplus">+          }</span>
<a href="#l6.3718"></a><span id="l6.3718" class="difflineplus">+        }</span>
<a href="#l6.3719"></a><span id="l6.3719" class="difflineplus">+        else {</span>
<a href="#l6.3720"></a><span id="l6.3720" class="difflineplus">+          resultObj.selected = -1;</span>
<a href="#l6.3721"></a><span id="l6.3721" class="difflineplus">+          window.openDialog(&quot;chrome://openpgp/content/ui/enigmailAttachmentsDialog.xul&quot;, &quot;&quot;, &quot;dialog,modal,centerscreen&quot;, inputObj, resultObj);</span>
<a href="#l6.3722"></a><span id="l6.3722" class="difflineplus">+        }</span>
<a href="#l6.3723"></a><span id="l6.3723" class="difflineplus">+        if (resultObj.selected &lt; 0) {</span>
<a href="#l6.3724"></a><span id="l6.3724" class="difflineplus">+          // dialog cancelled</span>
<a href="#l6.3725"></a><span id="l6.3725" class="difflineplus">+          return null;</span>
<a href="#l6.3726"></a><span id="l6.3726" class="difflineplus">+        }</span>
<a href="#l6.3727"></a><span id="l6.3727" class="difflineplus">+        else if (resultObj.selected == 1) {</span>
<a href="#l6.3728"></a><span id="l6.3728" class="difflineplus">+          // encrypt attachments</span>
<a href="#l6.3729"></a><span id="l6.3729" class="difflineplus">+          inlineEncAttach = true;</span>
<a href="#l6.3730"></a><span id="l6.3730" class="difflineplus">+        }</span>
<a href="#l6.3731"></a><span id="l6.3731" class="difflineplus">+        else if (resultObj.selected == 2) {</span>
<a href="#l6.3732"></a><span id="l6.3732" class="difflineplus">+          // send as PGP/MIME</span>
<a href="#l6.3733"></a><span id="l6.3733" class="difflineplus">+          sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.3734"></a><span id="l6.3734" class="difflineplus">+        }</span>
<a href="#l6.3735"></a><span id="l6.3735" class="difflineplus">+        else if (resultObj.selected == 3) {</span>
<a href="#l6.3736"></a><span id="l6.3736" class="difflineplus">+          // cancel the encryption/signing for the whole message</span>
<a href="#l6.3737"></a><span id="l6.3737" class="difflineplus">+          sendFlags &amp;= ~EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3738"></a><span id="l6.3738" class="difflineplus">+          sendFlags &amp;= ~EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3739"></a><span id="l6.3739" class="difflineplus">+        }</span>
<a href="#l6.3740"></a><span id="l6.3740" class="difflineplus">+      }</span>
<a href="#l6.3741"></a><span id="l6.3741" class="difflineplus">+      else {</span>
<a href="#l6.3742"></a><span id="l6.3742" class="difflineplus">+        if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.3743"></a><span id="l6.3743" class="difflineplus">+          if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l6.3744"></a><span id="l6.3744" class="difflineplus">+              EnigmailLocale.getString(&quot;attachWarning&quot;),</span>
<a href="#l6.3745"></a><span id="l6.3745" class="difflineplus">+              EnigmailLocale.getString(&quot;msgCompose.button.send&quot;)))</span>
<a href="#l6.3746"></a><span id="l6.3746" class="difflineplus">+            return null;</span>
<a href="#l6.3747"></a><span id="l6.3747" class="difflineplus">+        }</span>
<a href="#l6.3748"></a><span id="l6.3748" class="difflineplus">+      }</span>
<a href="#l6.3749"></a><span id="l6.3749" class="difflineplus">+    }</span>
<a href="#l6.3750"></a><span id="l6.3750" class="difflineplus">+</span>
<a href="#l6.3751"></a><span id="l6.3751" class="difflineplus">+    return {</span>
<a href="#l6.3752"></a><span id="l6.3752" class="difflineplus">+      inlineEncAttach: inlineEncAttach</span>
<a href="#l6.3753"></a><span id="l6.3753" class="difflineplus">+    };</span>
<a href="#l6.3754"></a><span id="l6.3754" class="difflineplus">+  },</span>
<a href="#l6.3755"></a><span id="l6.3755" class="difflineplus">+</span>
<a href="#l6.3756"></a><span id="l6.3756" class="difflineplus">+  prepareSending: function(sendFlags, toAddrStr, gpgKeys, isOffline) {</span>
<a href="#l6.3757"></a><span id="l6.3757" class="difflineplus">+    let confirm = this.isSendConfirmationRequired(sendFlags);</span>
<a href="#l6.3758"></a><span id="l6.3758" class="difflineplus">+    if (confirm === null) return false;</span>
<a href="#l6.3759"></a><span id="l6.3759" class="difflineplus">+    // perform confirmation dialog if necessary/requested</span>
<a href="#l6.3760"></a><span id="l6.3760" class="difflineplus">+    if (confirm) {</span>
<a href="#l6.3761"></a><span id="l6.3761" class="difflineplus">+      if (!this.confirmBeforeSend(toAddrStr, gpgKeys, sendFlags, isOffline)) {</span>
<a href="#l6.3762"></a><span id="l6.3762" class="difflineplus">+        if (this.processed) {</span>
<a href="#l6.3763"></a><span id="l6.3763" class="difflineplus">+          this.undoEncryption(0);</span>
<a href="#l6.3764"></a><span id="l6.3764" class="difflineplus">+        }</span>
<a href="#l6.3765"></a><span id="l6.3765" class="difflineplus">+        else {</span>
<a href="#l6.3766"></a><span id="l6.3766" class="difflineplus">+          this.removeAttachedKey();</span>
<a href="#l6.3767"></a><span id="l6.3767" class="difflineplus">+        }</span>
<a href="#l6.3768"></a><span id="l6.3768" class="difflineplus">+        return false;</span>
<a href="#l6.3769"></a><span id="l6.3769" class="difflineplus">+      }</span>
<a href="#l6.3770"></a><span id="l6.3770" class="difflineplus">+    }</span>
<a href="#l6.3771"></a><span id="l6.3771" class="difflineplus">+    else if ((sendFlags &amp; EnigmailConstants.SEND_WITH_CHECK) &amp;&amp;</span>
<a href="#l6.3772"></a><span id="l6.3772" class="difflineplus">+      !this.messageSendCheck()) {</span>
<a href="#l6.3773"></a><span id="l6.3773" class="difflineplus">+      // Abort send</span>
<a href="#l6.3774"></a><span id="l6.3774" class="difflineplus">+      if (this.processed) {</span>
<a href="#l6.3775"></a><span id="l6.3775" class="difflineplus">+        this.undoEncryption(0);</span>
<a href="#l6.3776"></a><span id="l6.3776" class="difflineplus">+      }</span>
<a href="#l6.3777"></a><span id="l6.3777" class="difflineplus">+      else {</span>
<a href="#l6.3778"></a><span id="l6.3778" class="difflineplus">+        this.removeAttachedKey();</span>
<a href="#l6.3779"></a><span id="l6.3779" class="difflineplus">+      }</span>
<a href="#l6.3780"></a><span id="l6.3780" class="difflineplus">+</span>
<a href="#l6.3781"></a><span id="l6.3781" class="difflineplus">+      return false;</span>
<a href="#l6.3782"></a><span id="l6.3782" class="difflineplus">+    }</span>
<a href="#l6.3783"></a><span id="l6.3783" class="difflineplus">+</span>
<a href="#l6.3784"></a><span id="l6.3784" class="difflineplus">+    return true;</span>
<a href="#l6.3785"></a><span id="l6.3785" class="difflineplus">+  },</span>
<a href="#l6.3786"></a><span id="l6.3786" class="difflineplus">+</span>
<a href="#l6.3787"></a><span id="l6.3787" class="difflineplus">+  prepareSecurityInfo: function(sendFlags, uiFlags, rcpt, newSecurityInfo, keyMap = {}) {</span>
<a href="#l6.3788"></a><span id="l6.3788" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo(): Using PGP/MIME, flags=&quot; + sendFlags + &quot;\n&quot;);</span>
<a href="#l6.3789"></a><span id="l6.3789" class="difflineplus">+</span>
<a href="#l6.3790"></a><span id="l6.3790" class="difflineplus">+    let oldSecurityInfo = Enigmail.msg.getSecurityParams();</span>
<a href="#l6.3791"></a><span id="l6.3791" class="difflineplus">+</span>
<a href="#l6.3792"></a><span id="l6.3792" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo: oldSecurityInfo = &quot; + oldSecurityInfo + &quot;\n&quot;);</span>
<a href="#l6.3793"></a><span id="l6.3793" class="difflineplus">+</span>
<a href="#l6.3794"></a><span id="l6.3794" class="difflineplus">+    if (!newSecurityInfo) {</span>
<a href="#l6.3795"></a><span id="l6.3795" class="difflineplus">+      this.createEnigmailSecurityFields(Enigmail.msg.getSecurityParams());</span>
<a href="#l6.3796"></a><span id="l6.3796" class="difflineplus">+      newSecurityInfo = Enigmail.msg.getSecurityParams().wrappedJSObject;</span>
<a href="#l6.3797"></a><span id="l6.3797" class="difflineplus">+    }</span>
<a href="#l6.3798"></a><span id="l6.3798" class="difflineplus">+</span>
<a href="#l6.3799"></a><span id="l6.3799" class="difflineplus">+    newSecurityInfo.originalSubject = gMsgCompose.compFields.subject;</span>
<a href="#l6.3800"></a><span id="l6.3800" class="difflineplus">+    newSecurityInfo.originalReferences = gMsgCompose.compFields.references;</span>
<a href="#l6.3801"></a><span id="l6.3801" class="difflineplus">+</span>
<a href="#l6.3802"></a><span id="l6.3802" class="difflineplus">+    if (this.protectHeaders) {</span>
<a href="#l6.3803"></a><span id="l6.3803" class="difflineplus">+      sendFlags |= EnigmailConstants.ENCRYPT_HEADERS;</span>
<a href="#l6.3804"></a><span id="l6.3804" class="difflineplus">+</span>
<a href="#l6.3805"></a><span id="l6.3805" class="difflineplus">+      if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.3806"></a><span id="l6.3806" class="difflineplus">+        gMsgCompose.compFields.subject = &quot;&quot;;</span>
<a href="#l6.3807"></a><span id="l6.3807" class="difflineplus">+</span>
<a href="#l6.3808"></a><span id="l6.3808" class="difflineplus">+        if (EnigmailPrefs.getPref(&quot;protectReferencesHdr&quot;)) {</span>
<a href="#l6.3809"></a><span id="l6.3809" class="difflineplus">+          gMsgCompose.compFields.references = &quot;&quot;;</span>
<a href="#l6.3810"></a><span id="l6.3810" class="difflineplus">+        }</span>
<a href="#l6.3811"></a><span id="l6.3811" class="difflineplus">+      }</span>
<a href="#l6.3812"></a><span id="l6.3812" class="difflineplus">+</span>
<a href="#l6.3813"></a><span id="l6.3813" class="difflineplus">+    }</span>
<a href="#l6.3814"></a><span id="l6.3814" class="difflineplus">+</span>
<a href="#l6.3815"></a><span id="l6.3815" class="difflineplus">+    newSecurityInfo.sendFlags = sendFlags;</span>
<a href="#l6.3816"></a><span id="l6.3816" class="difflineplus">+    newSecurityInfo.UIFlags = uiFlags;</span>
<a href="#l6.3817"></a><span id="l6.3817" class="difflineplus">+    newSecurityInfo.senderEmailAddr = rcpt.fromAddr;</span>
<a href="#l6.3818"></a><span id="l6.3818" class="difflineplus">+    newSecurityInfo.bccRecipients = rcpt.bccAddrStr;</span>
<a href="#l6.3819"></a><span id="l6.3819" class="difflineplus">+    newSecurityInfo.keyMap = keyMap;</span>
<a href="#l6.3820"></a><span id="l6.3820" class="difflineplus">+</span>
<a href="#l6.3821"></a><span id="l6.3821" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo: securityInfo = &quot; + newSecurityInfo + &quot;\n&quot;);</span>
<a href="#l6.3822"></a><span id="l6.3822" class="difflineplus">+    return newSecurityInfo;</span>
<a href="#l6.3823"></a><span id="l6.3823" class="difflineplus">+  },</span>
<a href="#l6.3824"></a><span id="l6.3824" class="difflineplus">+</span>
<a href="#l6.3825"></a><span id="l6.3825" class="difflineplus">+  encryptMsg: function(msgSendType) {</span>
<a href="#l6.3826"></a><span id="l6.3826" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: msgSendType=&quot; + msgSendType + &quot;, Enigmail.msg.sendMode=&quot; + this.sendMode + &quot;, Enigmail.msg.statusEncrypted=&quot; +</span>
<a href="#l6.3827"></a><span id="l6.3827" class="difflineplus">+      this.statusEncrypted +</span>
<a href="#l6.3828"></a><span id="l6.3828" class="difflineplus">+      &quot;\n&quot;);</span>
<a href="#l6.3829"></a><span id="l6.3829" class="difflineplus">+</span>
<a href="#l6.3830"></a><span id="l6.3830" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.3831"></a><span id="l6.3831" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.3832"></a><span id="l6.3832" class="difflineplus">+    const DeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l6.3833"></a><span id="l6.3833" class="difflineplus">+    let promptSvc = EnigmailDialog.getPromptSvc();</span>
<a href="#l6.3834"></a><span id="l6.3834" class="difflineplus">+</span>
<a href="#l6.3835"></a><span id="l6.3835" class="difflineplus">+    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l6.3836"></a><span id="l6.3836" class="difflineplus">+    // EnigSend: Handle both plain and encrypted messages below</span>
<a href="#l6.3837"></a><span id="l6.3837" class="difflineplus">+    var isOffline = (ioService &amp;&amp; ioService.offline);</span>
<a href="#l6.3838"></a><span id="l6.3838" class="difflineplus">+</span>
<a href="#l6.3839"></a><span id="l6.3839" class="difflineplus">+    let {</span>
<a href="#l6.3840"></a><span id="l6.3840" class="difflineplus">+      sendFlags,</span>
<a href="#l6.3841"></a><span id="l6.3841" class="difflineplus">+      gotSendFlags</span>
<a href="#l6.3842"></a><span id="l6.3842" class="difflineplus">+    } = this.getEncryptionFlags(msgSendType);</span>
<a href="#l6.3843"></a><span id="l6.3843" class="difflineplus">+</span>
<a href="#l6.3844"></a><span id="l6.3844" class="difflineplus">+    if (this.statusPGPMime == EnigmailConstants.ENIG_FINAL_SMIME ||</span>
<a href="#l6.3845"></a><span id="l6.3845" class="difflineplus">+      this.statusPGPMime == EnigmailConstants.ENIG_FINAL_FORCESMIME) {</span>
<a href="#l6.3846"></a><span id="l6.3846" class="difflineplus">+</span>
<a href="#l6.3847"></a><span id="l6.3847" class="difflineplus">+      return this.sendSmimeEncrypted(msgSendType, sendFlags, isOffline);</span>
<a href="#l6.3848"></a><span id="l6.3848" class="difflineplus">+    }</span>
<a href="#l6.3849"></a><span id="l6.3849" class="difflineplus">+</span>
<a href="#l6.3850"></a><span id="l6.3850" class="difflineplus">+    switch (msgSendType) {</span>
<a href="#l6.3851"></a><span id="l6.3851" class="difflineplus">+      case DeliverMode.SaveAsDraft:</span>
<a href="#l6.3852"></a><span id="l6.3852" class="difflineplus">+      case DeliverMode.SaveAsTemplate:</span>
<a href="#l6.3853"></a><span id="l6.3853" class="difflineplus">+      case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l6.3854"></a><span id="l6.3854" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: detected save draft\n&quot;);</span>
<a href="#l6.3855"></a><span id="l6.3855" class="difflineplus">+</span>
<a href="#l6.3856"></a><span id="l6.3856" class="difflineplus">+        // saving drafts is simpler and works differently than the rest of Enigmail.</span>
<a href="#l6.3857"></a><span id="l6.3857" class="difflineplus">+        // All rules except account-settings are ignored.</span>
<a href="#l6.3858"></a><span id="l6.3858" class="difflineplus">+        return this.saveDraftMessage();</span>
<a href="#l6.3859"></a><span id="l6.3859" class="difflineplus">+    }</span>
<a href="#l6.3860"></a><span id="l6.3860" class="difflineplus">+</span>
<a href="#l6.3861"></a><span id="l6.3861" class="difflineplus">+    this.unsetAdditionalHeader(&quot;x-enigmail-draft-status&quot;);</span>
<a href="#l6.3862"></a><span id="l6.3862" class="difflineplus">+</span>
<a href="#l6.3863"></a><span id="l6.3863" class="difflineplus">+    let msgCompFields = gMsgCompose.compFields;</span>
<a href="#l6.3864"></a><span id="l6.3864" class="difflineplus">+    let newsgroups = msgCompFields.newsgroups; // Check if sending to any newsgroups</span>
<a href="#l6.3865"></a><span id="l6.3865" class="difflineplus">+</span>
<a href="#l6.3866"></a><span id="l6.3866" class="difflineplus">+    if (msgCompFields.to === &quot;&quot; &amp;&amp; msgCompFields.cc === &quot;&quot; &amp;&amp;</span>
<a href="#l6.3867"></a><span id="l6.3867" class="difflineplus">+      msgCompFields.bcc === &quot;&quot; &amp;&amp; newsgroups === &quot;&quot;) {</span>
<a href="#l6.3868"></a><span id="l6.3868" class="difflineplus">+      // don't attempt to send message if no recipient specified</span>
<a href="#l6.3869"></a><span id="l6.3869" class="difflineplus">+      var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l6.3870"></a><span id="l6.3870" class="difflineplus">+      EnigmailDialog.alert(window, bundle.getString(&quot;12511&quot;));</span>
<a href="#l6.3871"></a><span id="l6.3871" class="difflineplus">+      return false;</span>
<a href="#l6.3872"></a><span id="l6.3872" class="difflineplus">+    }</span>
<a href="#l6.3873"></a><span id="l6.3873" class="difflineplus">+</span>
<a href="#l6.3874"></a><span id="l6.3874" class="difflineplus">+    this.identity = getCurrentIdentity();</span>
<a href="#l6.3875"></a><span id="l6.3875" class="difflineplus">+</span>
<a href="#l6.3876"></a><span id="l6.3876" class="difflineplus">+    if (gWindowLocked) {</span>
<a href="#l6.3877"></a><span id="l6.3877" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;windowLocked&quot;));</span>
<a href="#l6.3878"></a><span id="l6.3878" class="difflineplus">+      return false;</span>
<a href="#l6.3879"></a><span id="l6.3879" class="difflineplus">+    }</span>
<a href="#l6.3880"></a><span id="l6.3880" class="difflineplus">+</span>
<a href="#l6.3881"></a><span id="l6.3881" class="difflineplus">+    let newSecurityInfo = this.resetDirty();</span>
<a href="#l6.3882"></a><span id="l6.3882" class="difflineplus">+    this.dirty = 1;</span>
<a href="#l6.3883"></a><span id="l6.3883" class="difflineplus">+</span>
<a href="#l6.3884"></a><span id="l6.3884" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.3885"></a><span id="l6.3885" class="difflineplus">+    if (!enigmailSvc) {</span>
<a href="#l6.3886"></a><span id="l6.3886" class="difflineplus">+      var msg = EnigmailLocale.getString(&quot;sendUnencrypted&quot;);</span>
<a href="#l6.3887"></a><span id="l6.3887" class="difflineplus">+      if (EnigmailCore.getEnigmailService() &amp;&amp; EnigmailCore.getEnigmailService().initializationError) {</span>
<a href="#l6.3888"></a><span id="l6.3888" class="difflineplus">+        msg = EnigmailCore.getEnigmailService().initializationError + &quot;\n\n&quot; + msg;</span>
<a href="#l6.3889"></a><span id="l6.3889" class="difflineplus">+      }</span>
<a href="#l6.3890"></a><span id="l6.3890" class="difflineplus">+</span>
<a href="#l6.3891"></a><span id="l6.3891" class="difflineplus">+      return EnigmailDialog.confirmDlg(window, msg, EnigmailLocale.getString(&quot;msgCompose.button.send&quot;));</span>
<a href="#l6.3892"></a><span id="l6.3892" class="difflineplus">+    }</span>
<a href="#l6.3893"></a><span id="l6.3893" class="difflineplus">+</span>
<a href="#l6.3894"></a><span id="l6.3894" class="difflineplus">+    try {</span>
<a href="#l6.3895"></a><span id="l6.3895" class="difflineplus">+</span>
<a href="#l6.3896"></a><span id="l6.3896" class="difflineplus">+      this.modifiedAttach = null;</span>
<a href="#l6.3897"></a><span id="l6.3897" class="difflineplus">+</span>
<a href="#l6.3898"></a><span id="l6.3898" class="difflineplus">+      // fill fromAddr, toAddrList, bcc etc</span>
<a href="#l6.3899"></a><span id="l6.3899" class="difflineplus">+      let rcpt = this.determineMsgRecipients(sendFlags);</span>
<a href="#l6.3900"></a><span id="l6.3900" class="difflineplus">+      if (typeof(rcpt) === &quot;boolean&quot;) {</span>
<a href="#l6.3901"></a><span id="l6.3901" class="difflineplus">+        return rcpt;</span>
<a href="#l6.3902"></a><span id="l6.3902" class="difflineplus">+      }</span>
<a href="#l6.3903"></a><span id="l6.3903" class="difflineplus">+      sendFlags = rcpt.sendFlags;</span>
<a href="#l6.3904"></a><span id="l6.3904" class="difflineplus">+</span>
<a href="#l6.3905"></a><span id="l6.3905" class="difflineplus">+      if (this.sendPgpMime) {</span>
<a href="#l6.3906"></a><span id="l6.3906" class="difflineplus">+        // Use PGP/MIME</span>
<a href="#l6.3907"></a><span id="l6.3907" class="difflineplus">+        sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.3908"></a><span id="l6.3908" class="difflineplus">+      }</span>
<a href="#l6.3909"></a><span id="l6.3909" class="difflineplus">+</span>
<a href="#l6.3910"></a><span id="l6.3910" class="difflineplus">+      let result = this.keySelection(enigmailSvc,</span>
<a href="#l6.3911"></a><span id="l6.3911" class="difflineplus">+        sendFlags, // all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l6.3912"></a><span id="l6.3912" class="difflineplus">+        rcpt.optSendFlags, // may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l6.3913"></a><span id="l6.3913" class="difflineplus">+        gotSendFlags, // initial sendMode (0 or SIGN or ENCRYPT or SIGN|ENCRYPT)</span>
<a href="#l6.3914"></a><span id="l6.3914" class="difflineplus">+        rcpt.fromAddr, rcpt.toAddrList, rcpt.bccAddrList);</span>
<a href="#l6.3915"></a><span id="l6.3915" class="difflineplus">+      if (!result) {</span>
<a href="#l6.3916"></a><span id="l6.3916" class="difflineplus">+        return false;</span>
<a href="#l6.3917"></a><span id="l6.3917" class="difflineplus">+      }</span>
<a href="#l6.3918"></a><span id="l6.3918" class="difflineplus">+</span>
<a href="#l6.3919"></a><span id="l6.3919" class="difflineplus">+      sendFlags = result.sendFlags;</span>
<a href="#l6.3920"></a><span id="l6.3920" class="difflineplus">+      let toAddrStr = result.toAddrStr;</span>
<a href="#l6.3921"></a><span id="l6.3921" class="difflineplus">+      let bccAddrStr = result.bccAddrStr;</span>
<a href="#l6.3922"></a><span id="l6.3922" class="difflineplus">+      let keyMap = result.keyMap;</span>
<a href="#l6.3923"></a><span id="l6.3923" class="difflineplus">+</span>
<a href="#l6.3924"></a><span id="l6.3924" class="difflineplus">+      if (this.attachOwnKeyObj.appendAttachment) {</span>
<a href="#l6.3925"></a><span id="l6.3925" class="difflineplus">+        this.attachOwnKey();</span>
<a href="#l6.3926"></a><span id="l6.3926" class="difflineplus">+      }</span>
<a href="#l6.3927"></a><span id="l6.3927" class="difflineplus">+</span>
<a href="#l6.3928"></a><span id="l6.3928" class="difflineplus">+      if (this.preferPgpOverSmime(sendFlags) === 0) {</span>
<a href="#l6.3929"></a><span id="l6.3929" class="difflineplus">+        // use S/MIME</span>
<a href="#l6.3930"></a><span id="l6.3930" class="difflineplus">+        Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l6.3931"></a><span id="l6.3931" class="difflineplus">+        sendFlags = 0;</span>
<a href="#l6.3932"></a><span id="l6.3932" class="difflineplus">+        return true;</span>
<a href="#l6.3933"></a><span id="l6.3933" class="difflineplus">+      }</span>
<a href="#l6.3934"></a><span id="l6.3934" class="difflineplus">+</span>
<a href="#l6.3935"></a><span id="l6.3935" class="difflineplus">+      let attach = this.appendInlineAttachments(sendFlags);</span>
<a href="#l6.3936"></a><span id="l6.3936" class="difflineplus">+      if (!attach) return false;</span>
<a href="#l6.3937"></a><span id="l6.3937" class="difflineplus">+      let inlineEncAttach = attach.inlineEncAttach;</span>
<a href="#l6.3938"></a><span id="l6.3938" class="difflineplus">+</span>
<a href="#l6.3939"></a><span id="l6.3939" class="difflineplus">+      var usingPGPMime = (sendFlags &amp; EnigmailConstants.SEND_PGP_MIME) &amp;&amp;</span>
<a href="#l6.3940"></a><span id="l6.3940" class="difflineplus">+        (sendFlags &amp; (ENCRYPT | SIGN));</span>
<a href="#l6.3941"></a><span id="l6.3941" class="difflineplus">+</span>
<a href="#l6.3942"></a><span id="l6.3942" class="difflineplus">+      if (!this.checkProtectHeaders(sendFlags)) return false;</span>
<a href="#l6.3943"></a><span id="l6.3943" class="difflineplus">+</span>
<a href="#l6.3944"></a><span id="l6.3944" class="difflineplus">+      // ----------------------- Rewrapping code, taken from function &quot;encryptInline&quot;</span>
<a href="#l6.3945"></a><span id="l6.3945" class="difflineplus">+</span>
<a href="#l6.3946"></a><span id="l6.3946" class="difflineplus">+      // Check wrapping, if sign only and inline and plaintext</span>
<a href="#l6.3947"></a><span id="l6.3947" class="difflineplus">+      if ((sendFlags &amp; SIGN) &amp;&amp; !(sendFlags &amp; ENCRYPT) &amp;&amp; !(usingPGPMime) &amp;&amp; !(gMsgCompose.composeHTML)) {</span>
<a href="#l6.3948"></a><span id="l6.3948" class="difflineplus">+        var wrapresultObj = {};</span>
<a href="#l6.3949"></a><span id="l6.3949" class="difflineplus">+</span>
<a href="#l6.3950"></a><span id="l6.3950" class="difflineplus">+        this.wrapInLine(wrapresultObj);</span>
<a href="#l6.3951"></a><span id="l6.3951" class="difflineplus">+</span>
<a href="#l6.3952"></a><span id="l6.3952" class="difflineplus">+        if (wrapresultObj.usePpgMime) {</span>
<a href="#l6.3953"></a><span id="l6.3953" class="difflineplus">+          sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.3954"></a><span id="l6.3954" class="difflineplus">+          usingPGPMime = EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l6.3955"></a><span id="l6.3955" class="difflineplus">+        }</span>
<a href="#l6.3956"></a><span id="l6.3956" class="difflineplus">+        if (wrapresultObj.cancelled) {</span>
<a href="#l6.3957"></a><span id="l6.3957" class="difflineplus">+          return false;</span>
<a href="#l6.3958"></a><span id="l6.3958" class="difflineplus">+        }</span>
<a href="#l6.3959"></a><span id="l6.3959" class="difflineplus">+      }</span>
<a href="#l6.3960"></a><span id="l6.3960" class="difflineplus">+</span>
<a href="#l6.3961"></a><span id="l6.3961" class="difflineplus">+      var uiFlags = EnigmailConstants.UI_INTERACTIVE;</span>
<a href="#l6.3962"></a><span id="l6.3962" class="difflineplus">+</span>
<a href="#l6.3963"></a><span id="l6.3963" class="difflineplus">+      if (usingPGPMime)</span>
<a href="#l6.3964"></a><span id="l6.3964" class="difflineplus">+        uiFlags |= EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l6.3965"></a><span id="l6.3965" class="difflineplus">+</span>
<a href="#l6.3966"></a><span id="l6.3966" class="difflineplus">+      if ((sendFlags &amp; (ENCRYPT | SIGN)) &amp;&amp; usingPGPMime) {</span>
<a href="#l6.3967"></a><span id="l6.3967" class="difflineplus">+        // Use PGP/MIME</span>
<a href="#l6.3968"></a><span id="l6.3968" class="difflineplus">+        newSecurityInfo = this.prepareSecurityInfo(sendFlags, uiFlags, rcpt, newSecurityInfo, keyMap);</span>
<a href="#l6.3969"></a><span id="l6.3969" class="difflineplus">+        newSecurityInfo.recipients = toAddrStr;</span>
<a href="#l6.3970"></a><span id="l6.3970" class="difflineplus">+        newSecurityInfo.bccRecipients = bccAddrStr;</span>
<a href="#l6.3971"></a><span id="l6.3971" class="difflineplus">+      }</span>
<a href="#l6.3972"></a><span id="l6.3972" class="difflineplus">+      else if (!this.processed &amp;&amp; (sendFlags &amp; (ENCRYPT | SIGN))) {</span>
<a href="#l6.3973"></a><span id="l6.3973" class="difflineplus">+        // use inline PGP</span>
<a href="#l6.3974"></a><span id="l6.3974" class="difflineplus">+</span>
<a href="#l6.3975"></a><span id="l6.3975" class="difflineplus">+        let sendInfo = {</span>
<a href="#l6.3976"></a><span id="l6.3976" class="difflineplus">+          sendFlags: sendFlags,</span>
<a href="#l6.3977"></a><span id="l6.3977" class="difflineplus">+          inlineEncAttach: inlineEncAttach,</span>
<a href="#l6.3978"></a><span id="l6.3978" class="difflineplus">+          fromAddr: rcpt.fromAddr,</span>
<a href="#l6.3979"></a><span id="l6.3979" class="difflineplus">+          toAddr: toAddrStr,</span>
<a href="#l6.3980"></a><span id="l6.3980" class="difflineplus">+          bccAddr: bccAddrStr,</span>
<a href="#l6.3981"></a><span id="l6.3981" class="difflineplus">+          uiFlags: uiFlags,</span>
<a href="#l6.3982"></a><span id="l6.3982" class="difflineplus">+          bucketList: document.getElementById(&quot;attachmentBucket&quot;)</span>
<a href="#l6.3983"></a><span id="l6.3983" class="difflineplus">+        };</span>
<a href="#l6.3984"></a><span id="l6.3984" class="difflineplus">+</span>
<a href="#l6.3985"></a><span id="l6.3985" class="difflineplus">+        if (!this.encryptInline(sendInfo)) {</span>
<a href="#l6.3986"></a><span id="l6.3986" class="difflineplus">+          return false;</span>
<a href="#l6.3987"></a><span id="l6.3987" class="difflineplus">+        }</span>
<a href="#l6.3988"></a><span id="l6.3988" class="difflineplus">+      }</span>
<a href="#l6.3989"></a><span id="l6.3989" class="difflineplus">+</span>
<a href="#l6.3990"></a><span id="l6.3990" class="difflineplus">+      // update the list of attachments</span>
<a href="#l6.3991"></a><span id="l6.3991" class="difflineplus">+      Attachments2CompFields(msgCompFields);</span>
<a href="#l6.3992"></a><span id="l6.3992" class="difflineplus">+</span>
<a href="#l6.3993"></a><span id="l6.3993" class="difflineplus">+      if (!this.prepareSending(sendFlags,</span>
<a href="#l6.3994"></a><span id="l6.3994" class="difflineplus">+          rcpt.toAddrList.join(&quot;, &quot;),</span>
<a href="#l6.3995"></a><span id="l6.3995" class="difflineplus">+          toAddrStr + &quot;, &quot; + bccAddrStr,</span>
<a href="#l6.3996"></a><span id="l6.3996" class="difflineplus">+          isOffline</span>
<a href="#l6.3997"></a><span id="l6.3997" class="difflineplus">+        )) return false;</span>
<a href="#l6.3998"></a><span id="l6.3998" class="difflineplus">+</span>
<a href="#l6.3999"></a><span id="l6.3999" class="difflineplus">+      if (msgCompFields.characterSet != &quot;ISO-2022-JP&quot;) {</span>
<a href="#l6.4000"></a><span id="l6.4000" class="difflineplus">+        if ((usingPGPMime &amp;&amp;</span>
<a href="#l6.4001"></a><span id="l6.4001" class="difflineplus">+            ((sendFlags &amp; (ENCRYPT | SIGN)))) || ((!usingPGPMime) &amp;&amp; (sendFlags &amp; ENCRYPT))) {</span>
<a href="#l6.4002"></a><span id="l6.4002" class="difflineplus">+          try {</span>
<a href="#l6.4003"></a><span id="l6.4003" class="difflineplus">+            // make sure plaintext is not changed to 7bit</span>
<a href="#l6.4004"></a><span id="l6.4004" class="difflineplus">+            if (typeof(msgCompFields.forceMsgEncoding) == &quot;boolean&quot;) {</span>
<a href="#l6.4005"></a><span id="l6.4005" class="difflineplus">+              msgCompFields.forceMsgEncoding = true;</span>
<a href="#l6.4006"></a><span id="l6.4006" class="difflineplus">+              EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: enabled forceMsgEncoding\n&quot;);</span>
<a href="#l6.4007"></a><span id="l6.4007" class="difflineplus">+            }</span>
<a href="#l6.4008"></a><span id="l6.4008" class="difflineplus">+          }</span>
<a href="#l6.4009"></a><span id="l6.4009" class="difflineplus">+          catch (ex) {}</span>
<a href="#l6.4010"></a><span id="l6.4010" class="difflineplus">+        }</span>
<a href="#l6.4011"></a><span id="l6.4011" class="difflineplus">+      }</span>
<a href="#l6.4012"></a><span id="l6.4012" class="difflineplus">+    }</span>
<a href="#l6.4013"></a><span id="l6.4013" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4014"></a><span id="l6.4014" class="difflineplus">+      EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg&quot;, ex);</span>
<a href="#l6.4015"></a><span id="l6.4015" class="difflineplus">+      let msg = EnigmailLocale.getString(&quot;signFailed&quot;);</span>
<a href="#l6.4016"></a><span id="l6.4016" class="difflineplus">+      if (EnigmailCore.getEnigmailService() &amp;&amp; EnigmailCore.getEnigmailService().initializationError) {</span>
<a href="#l6.4017"></a><span id="l6.4017" class="difflineplus">+        msg += &quot;\n&quot; + EnigmailCore.getEnigmailService().initializationError;</span>
<a href="#l6.4018"></a><span id="l6.4018" class="difflineplus">+      }</span>
<a href="#l6.4019"></a><span id="l6.4019" class="difflineplus">+      return EnigmailDialog.confirmDlg(window, msg, EnigmailLocale.getString(&quot;msgCompose.button.sendUnencrypted&quot;));</span>
<a href="#l6.4020"></a><span id="l6.4020" class="difflineplus">+    }</span>
<a href="#l6.4021"></a><span id="l6.4021" class="difflineplus">+</span>
<a href="#l6.4022"></a><span id="l6.4022" class="difflineplus">+    // The encryption process for PGP/MIME messages follows &quot;here&quot;. It's</span>
<a href="#l6.4023"></a><span id="l6.4023" class="difflineplus">+    // called automatically from nsMsgCompose-&gt;sendMsg().</span>
<a href="#l6.4024"></a><span id="l6.4024" class="difflineplus">+    // registration for this is done in core.jsm: startup()</span>
<a href="#l6.4025"></a><span id="l6.4025" class="difflineplus">+</span>
<a href="#l6.4026"></a><span id="l6.4026" class="difflineplus">+    return true;</span>
<a href="#l6.4027"></a><span id="l6.4027" class="difflineplus">+  },</span>
<a href="#l6.4028"></a><span id="l6.4028" class="difflineplus">+</span>
<a href="#l6.4029"></a><span id="l6.4029" class="difflineplus">+  checkProtectHeaders: function(sendFlags) {</span>
<a href="#l6.4030"></a><span id="l6.4030" class="difflineplus">+    if (!(sendFlags &amp; EnigmailConstants.SEND_PGP_MIME)) return true;</span>
<a href="#l6.4031"></a><span id="l6.4031" class="difflineplus">+    if (sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED) {</span>
<a href="#l6.4032"></a><span id="l6.4032" class="difflineplus">+</span>
<a href="#l6.4033"></a><span id="l6.4033" class="difflineplus">+      if ((!this.protectHeaders) &amp;&amp; EnigmailPrefs.getPref(&quot;protectedHeaders&quot;) === 1) {</span>
<a href="#l6.4034"></a><span id="l6.4034" class="difflineplus">+        let enableProtection = EnigmailDialog.msgBox(window, {</span>
<a href="#l6.4035"></a><span id="l6.4035" class="difflineplus">+          dialogTitle: EnigmailLocale.getString(&quot;msgCompose.protectSubject.dialogTitle&quot;),</span>
<a href="#l6.4036"></a><span id="l6.4036" class="difflineplus">+          msgtext: EnigmailLocale.getString(&quot;msgCompose.protectSubject.question&quot;),</span>
<a href="#l6.4037"></a><span id="l6.4037" class="difflineplus">+          iconType: EnigmailConstants.ICONTYPE_QUESTION,</span>
<a href="#l6.4038"></a><span id="l6.4038" class="difflineplus">+          button1: EnigmailLocale.getString(&quot;msgCompose.protectSubject.yesButton&quot;),</span>
<a href="#l6.4039"></a><span id="l6.4039" class="difflineplus">+          button2: &quot;extra1:&quot; + EnigmailLocale.getString(&quot;msgCompose.protectSubject.noButton&quot;)</span>
<a href="#l6.4040"></a><span id="l6.4040" class="difflineplus">+        });</span>
<a href="#l6.4041"></a><span id="l6.4041" class="difflineplus">+</span>
<a href="#l6.4042"></a><span id="l6.4042" class="difflineplus">+        if (enableProtection === -1) return false;</span>
<a href="#l6.4043"></a><span id="l6.4043" class="difflineplus">+</span>
<a href="#l6.4044"></a><span id="l6.4044" class="difflineplus">+        EnigmailPrefs.setPref(&quot;protectedHeaders&quot;, enableProtection === 0 ? 2 : 0);</span>
<a href="#l6.4045"></a><span id="l6.4045" class="difflineplus">+        this.protectHeaders = (enableProtection === 0);</span>
<a href="#l6.4046"></a><span id="l6.4046" class="difflineplus">+        this.displayProtectHeadersStatus();</span>
<a href="#l6.4047"></a><span id="l6.4047" class="difflineplus">+      }</span>
<a href="#l6.4048"></a><span id="l6.4048" class="difflineplus">+    }</span>
<a href="#l6.4049"></a><span id="l6.4049" class="difflineplus">+</span>
<a href="#l6.4050"></a><span id="l6.4050" class="difflineplus">+    return true;</span>
<a href="#l6.4051"></a><span id="l6.4051" class="difflineplus">+  },</span>
<a href="#l6.4052"></a><span id="l6.4052" class="difflineplus">+</span>
<a href="#l6.4053"></a><span id="l6.4053" class="difflineplus">+  encryptInline: function(sendInfo) {</span>
<a href="#l6.4054"></a><span id="l6.4054" class="difflineplus">+    // sign/encrypt message using inline-PGP</span>
<a href="#l6.4055"></a><span id="l6.4055" class="difflineplus">+</span>
<a href="#l6.4056"></a><span id="l6.4056" class="difflineplus">+    const dce = Components.interfaces.nsIDocumentEncoder;</span>
<a href="#l6.4057"></a><span id="l6.4057" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.4058"></a><span id="l6.4058" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.4059"></a><span id="l6.4059" class="difflineplus">+</span>
<a href="#l6.4060"></a><span id="l6.4060" class="difflineplus">+    var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.4061"></a><span id="l6.4061" class="difflineplus">+    if (!enigmailSvc) return false;</span>
<a href="#l6.4062"></a><span id="l6.4062" class="difflineplus">+</span>
<a href="#l6.4063"></a><span id="l6.4063" class="difflineplus">+    if (gMsgCompose.composeHTML) {</span>
<a href="#l6.4064"></a><span id="l6.4064" class="difflineplus">+      var errMsg = EnigmailLocale.getString(&quot;hasHTML&quot;);</span>
<a href="#l6.4065"></a><span id="l6.4065" class="difflineplus">+      EnigmailDialog.alertCount(window, &quot;composeHtmlAlertCount&quot;, errMsg);</span>
<a href="#l6.4066"></a><span id="l6.4066" class="difflineplus">+    }</span>
<a href="#l6.4067"></a><span id="l6.4067" class="difflineplus">+</span>
<a href="#l6.4068"></a><span id="l6.4068" class="difflineplus">+    try {</span>
<a href="#l6.4069"></a><span id="l6.4069" class="difflineplus">+      var convert = DetermineConvertibility();</span>
<a href="#l6.4070"></a><span id="l6.4070" class="difflineplus">+      if (convert == Components.interfaces.nsIMsgCompConvertible.No) {</span>
<a href="#l6.4071"></a><span id="l6.4071" class="difflineplus">+        if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l6.4072"></a><span id="l6.4072" class="difflineplus">+            EnigmailLocale.getString(&quot;strippingHTML&quot;),</span>
<a href="#l6.4073"></a><span id="l6.4073" class="difflineplus">+            EnigmailLocale.getString(&quot;msgCompose.button.sendAnyway&quot;))) {</span>
<a href="#l6.4074"></a><span id="l6.4074" class="difflineplus">+          return false;</span>
<a href="#l6.4075"></a><span id="l6.4075" class="difflineplus">+        }</span>
<a href="#l6.4076"></a><span id="l6.4076" class="difflineplus">+      }</span>
<a href="#l6.4077"></a><span id="l6.4077" class="difflineplus">+    }</span>
<a href="#l6.4078"></a><span id="l6.4078" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4079"></a><span id="l6.4079" class="difflineplus">+      EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptInline&quot;, ex);</span>
<a href="#l6.4080"></a><span id="l6.4080" class="difflineplus">+    }</span>
<a href="#l6.4081"></a><span id="l6.4081" class="difflineplus">+</span>
<a href="#l6.4082"></a><span id="l6.4082" class="difflineplus">+    try {</span>
<a href="#l6.4083"></a><span id="l6.4083" class="difflineplus">+      if (this.getMailPref(&quot;mail.strictly_mime&quot;)) {</span>
<a href="#l6.4084"></a><span id="l6.4084" class="difflineplus">+        if (EnigmailDialog.confirmPref(window,</span>
<a href="#l6.4085"></a><span id="l6.4085" class="difflineplus">+            EnigmailLocale.getString(&quot;quotedPrintableWarn&quot;), &quot;quotedPrintableWarn&quot;)) {</span>
<a href="#l6.4086"></a><span id="l6.4086" class="difflineplus">+          EnigmailPrefs.getPrefRoot().setBoolPref(&quot;mail.strictly_mime&quot;, false);</span>
<a href="#l6.4087"></a><span id="l6.4087" class="difflineplus">+        }</span>
<a href="#l6.4088"></a><span id="l6.4088" class="difflineplus">+      }</span>
<a href="#l6.4089"></a><span id="l6.4089" class="difflineplus">+    }</span>
<a href="#l6.4090"></a><span id="l6.4090" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.4091"></a><span id="l6.4091" class="difflineplus">+</span>
<a href="#l6.4092"></a><span id="l6.4092" class="difflineplus">+</span>
<a href="#l6.4093"></a><span id="l6.4093" class="difflineplus">+    var sendFlowed;</span>
<a href="#l6.4094"></a><span id="l6.4094" class="difflineplus">+    try {</span>
<a href="#l6.4095"></a><span id="l6.4095" class="difflineplus">+      sendFlowed = this.getMailPref(&quot;mailnews.send_plaintext_flowed&quot;);</span>
<a href="#l6.4096"></a><span id="l6.4096" class="difflineplus">+    }</span>
<a href="#l6.4097"></a><span id="l6.4097" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4098"></a><span id="l6.4098" class="difflineplus">+      sendFlowed = true;</span>
<a href="#l6.4099"></a><span id="l6.4099" class="difflineplus">+    }</span>
<a href="#l6.4100"></a><span id="l6.4100" class="difflineplus">+    var encoderFlags = dce.OutputFormatted | dce.OutputLFLineBreak;</span>
<a href="#l6.4101"></a><span id="l6.4101" class="difflineplus">+</span>
<a href="#l6.4102"></a><span id="l6.4102" class="difflineplus">+    var wrapper = gMsgCompose.editor.QueryInterface(Components.interfaces.nsIEditorMailSupport);</span>
<a href="#l6.4103"></a><span id="l6.4103" class="difflineplus">+    var editor = gMsgCompose.editor.QueryInterface(Components.interfaces.nsIPlaintextEditor);</span>
<a href="#l6.4104"></a><span id="l6.4104" class="difflineplus">+    var wrapWidth = 72;</span>
<a href="#l6.4105"></a><span id="l6.4105" class="difflineplus">+</span>
<a href="#l6.4106"></a><span id="l6.4106" class="difflineplus">+    if (!(sendInfo.sendFlags &amp; ENCRYPT)) {</span>
<a href="#l6.4107"></a><span id="l6.4107" class="difflineplus">+      // signed messages only</span>
<a href="#l6.4108"></a><span id="l6.4108" class="difflineplus">+      if (gMsgCompose.composeHTML) {</span>
<a href="#l6.4109"></a><span id="l6.4109" class="difflineplus">+        // enforce line wrapping here</span>
<a href="#l6.4110"></a><span id="l6.4110" class="difflineplus">+        // otherwise the message isn't signed correctly</span>
<a href="#l6.4111"></a><span id="l6.4111" class="difflineplus">+        try {</span>
<a href="#l6.4112"></a><span id="l6.4112" class="difflineplus">+          wrapWidth = this.getMailPref(&quot;editor.htmlWrapColumn&quot;);</span>
<a href="#l6.4113"></a><span id="l6.4113" class="difflineplus">+</span>
<a href="#l6.4114"></a><span id="l6.4114" class="difflineplus">+          if (wrapWidth &gt; 0 &amp;&amp; wrapWidth &lt; 68 &amp;&amp; gMsgCompose.wrapLength &gt; 0) {</span>
<a href="#l6.4115"></a><span id="l6.4115" class="difflineplus">+            if (EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;minimalLineWrapping&quot;, [wrapWidth]))) {</span>
<a href="#l6.4116"></a><span id="l6.4116" class="difflineplus">+              EnigmailPrefs.getPrefRoot().setIntPref(&quot;editor.htmlWrapColumn&quot;, 68);</span>
<a href="#l6.4117"></a><span id="l6.4117" class="difflineplus">+            }</span>
<a href="#l6.4118"></a><span id="l6.4118" class="difflineplus">+          }</span>
<a href="#l6.4119"></a><span id="l6.4119" class="difflineplus">+          if (EnigmailPrefs.getPref(&quot;wrapHtmlBeforeSend&quot;)) {</span>
<a href="#l6.4120"></a><span id="l6.4120" class="difflineplus">+            if (wrapWidth) {</span>
<a href="#l6.4121"></a><span id="l6.4121" class="difflineplus">+              editor.wrapWidth = wrapWidth - 2; // prepare for the worst case: a 72 char's long line starting with '-'</span>
<a href="#l6.4122"></a><span id="l6.4122" class="difflineplus">+              wrapper.rewrap(false);</span>
<a href="#l6.4123"></a><span id="l6.4123" class="difflineplus">+            }</span>
<a href="#l6.4124"></a><span id="l6.4124" class="difflineplus">+          }</span>
<a href="#l6.4125"></a><span id="l6.4125" class="difflineplus">+        }</span>
<a href="#l6.4126"></a><span id="l6.4126" class="difflineplus">+        catch (ex) {}</span>
<a href="#l6.4127"></a><span id="l6.4127" class="difflineplus">+      }</span>
<a href="#l6.4128"></a><span id="l6.4128" class="difflineplus">+      else {</span>
<a href="#l6.4129"></a><span id="l6.4129" class="difflineplus">+        // plaintext: Wrapping code has been moved to superordinate function encryptMsg to enable interactive format switch</span>
<a href="#l6.4130"></a><span id="l6.4130" class="difflineplus">+      }</span>
<a href="#l6.4131"></a><span id="l6.4131" class="difflineplus">+    }</span>
<a href="#l6.4132"></a><span id="l6.4132" class="difflineplus">+</span>
<a href="#l6.4133"></a><span id="l6.4133" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l6.4134"></a><span id="l6.4134" class="difflineplus">+    var statusFlagsObj = {};</span>
<a href="#l6.4135"></a><span id="l6.4135" class="difflineplus">+    var errorMsgObj = {};</span>
<a href="#l6.4136"></a><span id="l6.4136" class="difflineplus">+    var exitCode;</span>
<a href="#l6.4137"></a><span id="l6.4137" class="difflineplus">+</span>
<a href="#l6.4138"></a><span id="l6.4138" class="difflineplus">+    // Get plain text</span>
<a href="#l6.4139"></a><span id="l6.4139" class="difflineplus">+    // (Do we need to set the nsIDocumentEncoder.* flags?)</span>
<a href="#l6.4140"></a><span id="l6.4140" class="difflineplus">+    var origText = this.editorGetContentAs(&quot;text/plain&quot;,</span>
<a href="#l6.4141"></a><span id="l6.4141" class="difflineplus">+      encoderFlags);</span>
<a href="#l6.4142"></a><span id="l6.4142" class="difflineplus">+    if (!origText)</span>
<a href="#l6.4143"></a><span id="l6.4143" class="difflineplus">+      origText = &quot;&quot;;</span>
<a href="#l6.4144"></a><span id="l6.4144" class="difflineplus">+</span>
<a href="#l6.4145"></a><span id="l6.4145" class="difflineplus">+    if (origText.length &gt; 0) {</span>
<a href="#l6.4146"></a><span id="l6.4146" class="difflineplus">+      // Sign/encrypt body text</span>
<a href="#l6.4147"></a><span id="l6.4147" class="difflineplus">+</span>
<a href="#l6.4148"></a><span id="l6.4148" class="difflineplus">+      var escText = origText; // Copy plain text for possible escaping</span>
<a href="#l6.4149"></a><span id="l6.4149" class="difflineplus">+</span>
<a href="#l6.4150"></a><span id="l6.4150" class="difflineplus">+      if (sendFlowed &amp;&amp; !(sendInfo.sendFlags &amp; ENCRYPT)) {</span>
<a href="#l6.4151"></a><span id="l6.4151" class="difflineplus">+        // Prevent space stuffing a la RFC 2646 (format=flowed).</span>
<a href="#l6.4152"></a><span id="l6.4152" class="difflineplus">+</span>
<a href="#l6.4153"></a><span id="l6.4153" class="difflineplus">+        //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: escText[&quot;+encoderFlags+&quot;] = '&quot;+escText+&quot;'\n&quot;);</span>
<a href="#l6.4154"></a><span id="l6.4154" class="difflineplus">+</span>
<a href="#l6.4155"></a><span id="l6.4155" class="difflineplus">+        escText = escText.replace(/^From /gm, &quot;~From &quot;);</span>
<a href="#l6.4156"></a><span id="l6.4156" class="difflineplus">+        escText = escText.replace(/^&gt;/gm, &quot;|&quot;);</span>
<a href="#l6.4157"></a><span id="l6.4157" class="difflineplus">+        escText = escText.replace(/^[ \t]+$/gm, &quot;&quot;);</span>
<a href="#l6.4158"></a><span id="l6.4158" class="difflineplus">+        escText = escText.replace(/^ /gm, &quot;~ &quot;);</span>
<a href="#l6.4159"></a><span id="l6.4159" class="difflineplus">+</span>
<a href="#l6.4160"></a><span id="l6.4160" class="difflineplus">+        //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: escText = '&quot;+escText+&quot;'\n&quot;);</span>
<a href="#l6.4161"></a><span id="l6.4161" class="difflineplus">+        // Replace plain text and get it again</span>
<a href="#l6.4162"></a><span id="l6.4162" class="difflineplus">+        this.replaceEditorText(escText);</span>
<a href="#l6.4163"></a><span id="l6.4163" class="difflineplus">+</span>
<a href="#l6.4164"></a><span id="l6.4164" class="difflineplus">+        escText = this.editorGetContentAs(&quot;text/plain&quot;, encoderFlags);</span>
<a href="#l6.4165"></a><span id="l6.4165" class="difflineplus">+      }</span>
<a href="#l6.4166"></a><span id="l6.4166" class="difflineplus">+</span>
<a href="#l6.4167"></a><span id="l6.4167" class="difflineplus">+      // Replace plain text and get it again (to avoid linewrapping problems)</span>
<a href="#l6.4168"></a><span id="l6.4168" class="difflineplus">+      this.replaceEditorText(escText);</span>
<a href="#l6.4169"></a><span id="l6.4169" class="difflineplus">+</span>
<a href="#l6.4170"></a><span id="l6.4170" class="difflineplus">+      escText = this.editorGetContentAs(&quot;text/plain&quot;, encoderFlags);</span>
<a href="#l6.4171"></a><span id="l6.4171" class="difflineplus">+</span>
<a href="#l6.4172"></a><span id="l6.4172" class="difflineplus">+      //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: escText[&quot;+encoderFlags+&quot;] = '&quot;+escText+&quot;'\n&quot;);</span>
<a href="#l6.4173"></a><span id="l6.4173" class="difflineplus">+</span>
<a href="#l6.4174"></a><span id="l6.4174" class="difflineplus">+      // Encrypt plaintext</span>
<a href="#l6.4175"></a><span id="l6.4175" class="difflineplus">+      var charset = this.editorGetCharset();</span>
<a href="#l6.4176"></a><span id="l6.4176" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: charset=&quot; + charset + &quot;\n&quot;);</span>
<a href="#l6.4177"></a><span id="l6.4177" class="difflineplus">+</span>
<a href="#l6.4178"></a><span id="l6.4178" class="difflineplus">+      // Encode plaintext to charset from unicode</span>
<a href="#l6.4179"></a><span id="l6.4179" class="difflineplus">+      var plainText = (sendInfo.sendFlags &amp; ENCRYPT) ?</span>
<a href="#l6.4180"></a><span id="l6.4180" class="difflineplus">+        EnigmailData.convertFromUnicode(origText, charset) :</span>
<a href="#l6.4181"></a><span id="l6.4181" class="difflineplus">+        EnigmailData.convertFromUnicode(escText, charset);</span>
<a href="#l6.4182"></a><span id="l6.4182" class="difflineplus">+</span>
<a href="#l6.4183"></a><span id="l6.4183" class="difflineplus">+      var cipherText = EnigmailEncryption.encryptMessage(window, sendInfo.uiFlags, plainText,</span>
<a href="#l6.4184"></a><span id="l6.4184" class="difflineplus">+        sendInfo.fromAddr, sendInfo.toAddr, sendInfo.bccAddr,</span>
<a href="#l6.4185"></a><span id="l6.4185" class="difflineplus">+        sendInfo.sendFlags,</span>
<a href="#l6.4186"></a><span id="l6.4186" class="difflineplus">+        exitCodeObj, statusFlagsObj,</span>
<a href="#l6.4187"></a><span id="l6.4187" class="difflineplus">+        errorMsgObj);</span>
<a href="#l6.4188"></a><span id="l6.4188" class="difflineplus">+</span>
<a href="#l6.4189"></a><span id="l6.4189" class="difflineplus">+      exitCode = exitCodeObj.value;</span>
<a href="#l6.4190"></a><span id="l6.4190" class="difflineplus">+</span>
<a href="#l6.4191"></a><span id="l6.4191" class="difflineplus">+      //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: cipherText = '&quot;+cipherText+&quot;'\n&quot;);</span>
<a href="#l6.4192"></a><span id="l6.4192" class="difflineplus">+      if (cipherText &amp;&amp; (exitCode === 0)) {</span>
<a href="#l6.4193"></a><span id="l6.4193" class="difflineplus">+        // Encryption/signing succeeded; overwrite plaintext</span>
<a href="#l6.4194"></a><span id="l6.4194" class="difflineplus">+</span>
<a href="#l6.4195"></a><span id="l6.4195" class="difflineplus">+        if (gMsgCompose.composeHTML) {</span>
<a href="#l6.4196"></a><span id="l6.4196" class="difflineplus">+          // workaround for Thunderbird bug (TB adds an extra space in front of the text)</span>
<a href="#l6.4197"></a><span id="l6.4197" class="difflineplus">+          cipherText = &quot;\n&quot; + cipherText;</span>
<a href="#l6.4198"></a><span id="l6.4198" class="difflineplus">+        }</span>
<a href="#l6.4199"></a><span id="l6.4199" class="difflineplus">+        else</span>
<a href="#l6.4200"></a><span id="l6.4200" class="difflineplus">+          cipherText = cipherText.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l6.4201"></a><span id="l6.4201" class="difflineplus">+</span>
<a href="#l6.4202"></a><span id="l6.4202" class="difflineplus">+        if ((sendInfo.sendFlags &amp; ENCRYPT) &amp;&amp; charset &amp;&amp;</span>
<a href="#l6.4203"></a><span id="l6.4203" class="difflineplus">+          (charset.search(/^us-ascii$/i) !== 0)) {</span>
<a href="#l6.4204"></a><span id="l6.4204" class="difflineplus">+          // Add Charset armor header for encrypted blocks</span>
<a href="#l6.4205"></a><span id="l6.4205" class="difflineplus">+          cipherText = cipherText.replace(/(-----BEGIN PGP MESSAGE----- *)(\r?\n)/, &quot;$1$2Charset: &quot; + charset + &quot;$2&quot;);</span>
<a href="#l6.4206"></a><span id="l6.4206" class="difflineplus">+        }</span>
<a href="#l6.4207"></a><span id="l6.4207" class="difflineplus">+</span>
<a href="#l6.4208"></a><span id="l6.4208" class="difflineplus">+        // Decode ciphertext from charset to unicode and overwrite</span>
<a href="#l6.4209"></a><span id="l6.4209" class="difflineplus">+        this.replaceEditorText(EnigmailData.convertToUnicode(cipherText, charset));</span>
<a href="#l6.4210"></a><span id="l6.4210" class="difflineplus">+        this.enableUndoEncryption(true);</span>
<a href="#l6.4211"></a><span id="l6.4211" class="difflineplus">+</span>
<a href="#l6.4212"></a><span id="l6.4212" class="difflineplus">+        // Save original text (for undo)</span>
<a href="#l6.4213"></a><span id="l6.4213" class="difflineplus">+        this.processed = {</span>
<a href="#l6.4214"></a><span id="l6.4214" class="difflineplus">+          &quot;origText&quot;: origText,</span>
<a href="#l6.4215"></a><span id="l6.4215" class="difflineplus">+          &quot;charset&quot;: charset</span>
<a href="#l6.4216"></a><span id="l6.4216" class="difflineplus">+        };</span>
<a href="#l6.4217"></a><span id="l6.4217" class="difflineplus">+</span>
<a href="#l6.4218"></a><span id="l6.4218" class="difflineplus">+      }</span>
<a href="#l6.4219"></a><span id="l6.4219" class="difflineplus">+      else {</span>
<a href="#l6.4220"></a><span id="l6.4220" class="difflineplus">+        // Restore original text</span>
<a href="#l6.4221"></a><span id="l6.4221" class="difflineplus">+        this.replaceEditorText(origText);</span>
<a href="#l6.4222"></a><span id="l6.4222" class="difflineplus">+        this.enableUndoEncryption(false);</span>
<a href="#l6.4223"></a><span id="l6.4223" class="difflineplus">+</span>
<a href="#l6.4224"></a><span id="l6.4224" class="difflineplus">+        if (sendInfo.sendFlags &amp; (ENCRYPT | SIGN)) {</span>
<a href="#l6.4225"></a><span id="l6.4225" class="difflineplus">+          // Encryption/signing failed</span>
<a href="#l6.4226"></a><span id="l6.4226" class="difflineplus">+</span>
<a href="#l6.4227"></a><span id="l6.4227" class="difflineplus">+          /*if (statusFlagsObj.statusMsg) {</span>
<a href="#l6.4228"></a><span id="l6.4228" class="difflineplus">+            // check if own key is invalid</span>
<a href="#l6.4229"></a><span id="l6.4229" class="difflineplus">+            let s = new RegExp(&quot;^(\\[GNUPG:\\] )?INV_(RECP|SGNR) [0-9]+ \\&lt;?&quot; + sendInfo.fromAddr + &quot;\\&gt;?&quot;, &quot;m&quot;);</span>
<a href="#l6.4230"></a><span id="l6.4230" class="difflineplus">+            if (statusFlagsObj.statusMsg.search(s) &gt;= 0) {</span>
<a href="#l6.4231"></a><span id="l6.4231" class="difflineplus">+              errorMsgObj.value += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;keyError.resolutionAction&quot;);</span>
<a href="#l6.4232"></a><span id="l6.4232" class="difflineplus">+            }</span>
<a href="#l6.4233"></a><span id="l6.4233" class="difflineplus">+          }*/</span>
<a href="#l6.4234"></a><span id="l6.4234" class="difflineplus">+</span>
<a href="#l6.4235"></a><span id="l6.4235" class="difflineplus">+          this.sendAborted(window, errorMsgObj);</span>
<a href="#l6.4236"></a><span id="l6.4236" class="difflineplus">+          return false;</span>
<a href="#l6.4237"></a><span id="l6.4237" class="difflineplus">+        }</span>
<a href="#l6.4238"></a><span id="l6.4238" class="difflineplus">+      }</span>
<a href="#l6.4239"></a><span id="l6.4239" class="difflineplus">+    }</span>
<a href="#l6.4240"></a><span id="l6.4240" class="difflineplus">+</span>
<a href="#l6.4241"></a><span id="l6.4241" class="difflineplus">+    if (sendInfo.inlineEncAttach) {</span>
<a href="#l6.4242"></a><span id="l6.4242" class="difflineplus">+      // encrypt attachments</span>
<a href="#l6.4243"></a><span id="l6.4243" class="difflineplus">+      this.modifiedAttach = [];</span>
<a href="#l6.4244"></a><span id="l6.4244" class="difflineplus">+      exitCode = this.encryptAttachments(sendInfo.bucketList, this.modifiedAttach,</span>
<a href="#l6.4245"></a><span id="l6.4245" class="difflineplus">+        window, sendInfo.uiFlags, sendInfo.fromAddr, sendInfo.toAddr, sendInfo.bccAddr,</span>
<a href="#l6.4246"></a><span id="l6.4246" class="difflineplus">+        sendInfo.sendFlags, errorMsgObj);</span>
<a href="#l6.4247"></a><span id="l6.4247" class="difflineplus">+      if (exitCode !== 0) {</span>
<a href="#l6.4248"></a><span id="l6.4248" class="difflineplus">+        this.modifiedAttach = null;</span>
<a href="#l6.4249"></a><span id="l6.4249" class="difflineplus">+        this.sendAborted(window, errorMsgObj);</span>
<a href="#l6.4250"></a><span id="l6.4250" class="difflineplus">+        if (this.processed) {</span>
<a href="#l6.4251"></a><span id="l6.4251" class="difflineplus">+          this.undoEncryption(0);</span>
<a href="#l6.4252"></a><span id="l6.4252" class="difflineplus">+        }</span>
<a href="#l6.4253"></a><span id="l6.4253" class="difflineplus">+        else {</span>
<a href="#l6.4254"></a><span id="l6.4254" class="difflineplus">+          this.removeAttachedKey();</span>
<a href="#l6.4255"></a><span id="l6.4255" class="difflineplus">+        }</span>
<a href="#l6.4256"></a><span id="l6.4256" class="difflineplus">+        return false;</span>
<a href="#l6.4257"></a><span id="l6.4257" class="difflineplus">+      }</span>
<a href="#l6.4258"></a><span id="l6.4258" class="difflineplus">+    }</span>
<a href="#l6.4259"></a><span id="l6.4259" class="difflineplus">+    return true;</span>
<a href="#l6.4260"></a><span id="l6.4260" class="difflineplus">+  },</span>
<a href="#l6.4261"></a><span id="l6.4261" class="difflineplus">+</span>
<a href="#l6.4262"></a><span id="l6.4262" class="difflineplus">+</span>
<a href="#l6.4263"></a><span id="l6.4263" class="difflineplus">+  sendAborted: function(window, errorMsgObj) {</span>
<a href="#l6.4264"></a><span id="l6.4264" class="difflineplus">+    if (errorMsgObj &amp;&amp; errorMsgObj.value) {</span>
<a href="#l6.4265"></a><span id="l6.4265" class="difflineplus">+      var txt = errorMsgObj.value;</span>
<a href="#l6.4266"></a><span id="l6.4266" class="difflineplus">+      var txtLines = txt.split(/\r?\n/);</span>
<a href="#l6.4267"></a><span id="l6.4267" class="difflineplus">+      var errorMsg = &quot;&quot;;</span>
<a href="#l6.4268"></a><span id="l6.4268" class="difflineplus">+      for (var i = 0; i &lt; txtLines.length; ++i) {</span>
<a href="#l6.4269"></a><span id="l6.4269" class="difflineplus">+        var line = txtLines[i];</span>
<a href="#l6.4270"></a><span id="l6.4270" class="difflineplus">+        var tokens = line.split(/ /);</span>
<a href="#l6.4271"></a><span id="l6.4271" class="difflineplus">+        // process most important business reasons for invalid recipient (and sender) errors:</span>
<a href="#l6.4272"></a><span id="l6.4272" class="difflineplus">+        if (tokens.length == 3 &amp;&amp; (tokens[0] == &quot;INV_RECP&quot; || tokens[0] == &quot;INV_SGNR&quot;)) {</span>
<a href="#l6.4273"></a><span id="l6.4273" class="difflineplus">+          var reason = tokens[1];</span>
<a href="#l6.4274"></a><span id="l6.4274" class="difflineplus">+          var key = tokens[2];</span>
<a href="#l6.4275"></a><span id="l6.4275" class="difflineplus">+          if (reason == &quot;10&quot;) {</span>
<a href="#l6.4276"></a><span id="l6.4276" class="difflineplus">+            errorMsg += EnigmailLocale.getString(&quot;keyNotTrusted&quot;, [key]) + &quot;\n&quot;;</span>
<a href="#l6.4277"></a><span id="l6.4277" class="difflineplus">+          }</span>
<a href="#l6.4278"></a><span id="l6.4278" class="difflineplus">+          else if (reason == &quot;1&quot;) {</span>
<a href="#l6.4279"></a><span id="l6.4279" class="difflineplus">+            errorMsg += EnigmailLocale.getString(&quot;keyNotFound&quot;, [key]) + &quot;\n&quot;;</span>
<a href="#l6.4280"></a><span id="l6.4280" class="difflineplus">+          }</span>
<a href="#l6.4281"></a><span id="l6.4281" class="difflineplus">+          else if (reason == &quot;4&quot;) {</span>
<a href="#l6.4282"></a><span id="l6.4282" class="difflineplus">+            errorMsg += EnigmailLocale.getString(&quot;keyRevoked&quot;, [key]) + &quot;\n&quot;;</span>
<a href="#l6.4283"></a><span id="l6.4283" class="difflineplus">+          }</span>
<a href="#l6.4284"></a><span id="l6.4284" class="difflineplus">+          else if (reason == &quot;5&quot;) {</span>
<a href="#l6.4285"></a><span id="l6.4285" class="difflineplus">+            errorMsg += EnigmailLocale.getString(&quot;keyExpired&quot;, [key]) + &quot;\n&quot;;</span>
<a href="#l6.4286"></a><span id="l6.4286" class="difflineplus">+          }</span>
<a href="#l6.4287"></a><span id="l6.4287" class="difflineplus">+        }</span>
<a href="#l6.4288"></a><span id="l6.4288" class="difflineplus">+      }</span>
<a href="#l6.4289"></a><span id="l6.4289" class="difflineplus">+      if (errorMsg !== &quot;&quot;) {</span>
<a href="#l6.4290"></a><span id="l6.4290" class="difflineplus">+        txt = errorMsg + &quot;\n&quot; + txt;</span>
<a href="#l6.4291"></a><span id="l6.4291" class="difflineplus">+      }</span>
<a href="#l6.4292"></a><span id="l6.4292" class="difflineplus">+      EnigmailDialog.info(window, EnigmailLocale.getString(&quot;sendAborted&quot;) + txt);</span>
<a href="#l6.4293"></a><span id="l6.4293" class="difflineplus">+    }</span>
<a href="#l6.4294"></a><span id="l6.4294" class="difflineplus">+    else {</span>
<a href="#l6.4295"></a><span id="l6.4295" class="difflineplus">+      EnigmailDialog.info(window, EnigmailLocale.getString(&quot;sendAborted&quot;) + &quot;\n&quot; +</span>
<a href="#l6.4296"></a><span id="l6.4296" class="difflineplus">+        EnigmailLocale.getString(&quot;msgCompose.internalError&quot;));</span>
<a href="#l6.4297"></a><span id="l6.4297" class="difflineplus">+    }</span>
<a href="#l6.4298"></a><span id="l6.4298" class="difflineplus">+  },</span>
<a href="#l6.4299"></a><span id="l6.4299" class="difflineplus">+</span>
<a href="#l6.4300"></a><span id="l6.4300" class="difflineplus">+</span>
<a href="#l6.4301"></a><span id="l6.4301" class="difflineplus">+  getMailPref: function(prefName) {</span>
<a href="#l6.4302"></a><span id="l6.4302" class="difflineplus">+    let prefRoot = EnigmailPrefs.getPrefRoot();</span>
<a href="#l6.4303"></a><span id="l6.4303" class="difflineplus">+</span>
<a href="#l6.4304"></a><span id="l6.4304" class="difflineplus">+    var prefValue = null;</span>
<a href="#l6.4305"></a><span id="l6.4305" class="difflineplus">+    try {</span>
<a href="#l6.4306"></a><span id="l6.4306" class="difflineplus">+      var prefType = prefRoot.getPrefType(prefName);</span>
<a href="#l6.4307"></a><span id="l6.4307" class="difflineplus">+      // Get pref value</span>
<a href="#l6.4308"></a><span id="l6.4308" class="difflineplus">+      switch (prefType) {</span>
<a href="#l6.4309"></a><span id="l6.4309" class="difflineplus">+        case prefRoot.PREF_BOOL:</span>
<a href="#l6.4310"></a><span id="l6.4310" class="difflineplus">+          prefValue = prefRoot.getBoolPref(prefName);</span>
<a href="#l6.4311"></a><span id="l6.4311" class="difflineplus">+          break;</span>
<a href="#l6.4312"></a><span id="l6.4312" class="difflineplus">+</span>
<a href="#l6.4313"></a><span id="l6.4313" class="difflineplus">+        case prefRoot.PREF_INT:</span>
<a href="#l6.4314"></a><span id="l6.4314" class="difflineplus">+          prefValue = prefRoot.getIntPref(prefName);</span>
<a href="#l6.4315"></a><span id="l6.4315" class="difflineplus">+          break;</span>
<a href="#l6.4316"></a><span id="l6.4316" class="difflineplus">+</span>
<a href="#l6.4317"></a><span id="l6.4317" class="difflineplus">+        case prefRoot.PREF_STRING:</span>
<a href="#l6.4318"></a><span id="l6.4318" class="difflineplus">+          prefValue = prefRoot.getCharPref(prefName);</span>
<a href="#l6.4319"></a><span id="l6.4319" class="difflineplus">+          break;</span>
<a href="#l6.4320"></a><span id="l6.4320" class="difflineplus">+</span>
<a href="#l6.4321"></a><span id="l6.4321" class="difflineplus">+        default:</span>
<a href="#l6.4322"></a><span id="l6.4322" class="difflineplus">+          prefValue = undefined;</span>
<a href="#l6.4323"></a><span id="l6.4323" class="difflineplus">+          break;</span>
<a href="#l6.4324"></a><span id="l6.4324" class="difflineplus">+      }</span>
<a href="#l6.4325"></a><span id="l6.4325" class="difflineplus">+    }</span>
<a href="#l6.4326"></a><span id="l6.4326" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4327"></a><span id="l6.4327" class="difflineplus">+      // Failed to get pref value</span>
<a href="#l6.4328"></a><span id="l6.4328" class="difflineplus">+      EnigmailLog.ERROR(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.getMailPref: unknown prefName:&quot; + prefName + &quot; \n&quot;);</span>
<a href="#l6.4329"></a><span id="l6.4329" class="difflineplus">+    }</span>
<a href="#l6.4330"></a><span id="l6.4330" class="difflineplus">+</span>
<a href="#l6.4331"></a><span id="l6.4331" class="difflineplus">+    return prefValue;</span>
<a href="#l6.4332"></a><span id="l6.4332" class="difflineplus">+  },</span>
<a href="#l6.4333"></a><span id="l6.4333" class="difflineplus">+</span>
<a href="#l6.4334"></a><span id="l6.4334" class="difflineplus">+  messageSendCheck: function() {</span>
<a href="#l6.4335"></a><span id="l6.4335" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.messageSendCheck\n&quot;);</span>
<a href="#l6.4336"></a><span id="l6.4336" class="difflineplus">+</span>
<a href="#l6.4337"></a><span id="l6.4337" class="difflineplus">+    try {</span>
<a href="#l6.4338"></a><span id="l6.4338" class="difflineplus">+      var warn = this.getMailPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l6.4339"></a><span id="l6.4339" class="difflineplus">+</span>
<a href="#l6.4340"></a><span id="l6.4340" class="difflineplus">+      if (warn) {</span>
<a href="#l6.4341"></a><span id="l6.4341" class="difflineplus">+        var checkValue = {</span>
<a href="#l6.4342"></a><span id="l6.4342" class="difflineplus">+          value: false</span>
<a href="#l6.4343"></a><span id="l6.4343" class="difflineplus">+        };</span>
<a href="#l6.4344"></a><span id="l6.4344" class="difflineplus">+        var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l6.4345"></a><span id="l6.4345" class="difflineplus">+        var buttonPressed = EnigmailDialog.getPromptSvc().confirmEx(window,</span>
<a href="#l6.4346"></a><span id="l6.4346" class="difflineplus">+          bundle.getString('sendMessageCheckWindowTitle'),</span>
<a href="#l6.4347"></a><span id="l6.4347" class="difflineplus">+          bundle.getString('sendMessageCheckLabel'), (EnigmailDialog.getPromptSvc().BUTTON_TITLE_IS_STRING * EnigmailDialog.getPromptSvc().BUTTON_POS_0) +</span>
<a href="#l6.4348"></a><span id="l6.4348" class="difflineplus">+          (EnigmailDialog.getPromptSvc().BUTTON_TITLE_CANCEL * EnigmailDialog.getPromptSvc().BUTTON_POS_1),</span>
<a href="#l6.4349"></a><span id="l6.4349" class="difflineplus">+          bundle.getString('sendMessageCheckSendButtonLabel'),</span>
<a href="#l6.4350"></a><span id="l6.4350" class="difflineplus">+          null, null,</span>
<a href="#l6.4351"></a><span id="l6.4351" class="difflineplus">+          bundle.getString('CheckMsg'),</span>
<a href="#l6.4352"></a><span id="l6.4352" class="difflineplus">+          checkValue);</span>
<a href="#l6.4353"></a><span id="l6.4353" class="difflineplus">+        if (buttonPressed !== 0) {</span>
<a href="#l6.4354"></a><span id="l6.4354" class="difflineplus">+          return false;</span>
<a href="#l6.4355"></a><span id="l6.4355" class="difflineplus">+        }</span>
<a href="#l6.4356"></a><span id="l6.4356" class="difflineplus">+        if (checkValue.value) {</span>
<a href="#l6.4357"></a><span id="l6.4357" class="difflineplus">+          EnigmailPrefs.getPrefRoot().setBoolPref(&quot;mail.warn_on_send_accel_key&quot;, false);</span>
<a href="#l6.4358"></a><span id="l6.4358" class="difflineplus">+        }</span>
<a href="#l6.4359"></a><span id="l6.4359" class="difflineplus">+      }</span>
<a href="#l6.4360"></a><span id="l6.4360" class="difflineplus">+    }</span>
<a href="#l6.4361"></a><span id="l6.4361" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.4362"></a><span id="l6.4362" class="difflineplus">+</span>
<a href="#l6.4363"></a><span id="l6.4363" class="difflineplus">+    return true;</span>
<a href="#l6.4364"></a><span id="l6.4364" class="difflineplus">+  },</span>
<a href="#l6.4365"></a><span id="l6.4365" class="difflineplus">+</span>
<a href="#l6.4366"></a><span id="l6.4366" class="difflineplus">+</span>
<a href="#l6.4367"></a><span id="l6.4367" class="difflineplus">+  /**</span>
<a href="#l6.4368"></a><span id="l6.4368" class="difflineplus">+   * set non-standard message Header</span>
<a href="#l6.4369"></a><span id="l6.4369" class="difflineplus">+   * (depending on TB version)</span>
<a href="#l6.4370"></a><span id="l6.4370" class="difflineplus">+   *</span>
<a href="#l6.4371"></a><span id="l6.4371" class="difflineplus">+   * hdr: String: header type (e.g. X-Enigmail-Version)</span>
<a href="#l6.4372"></a><span id="l6.4372" class="difflineplus">+   * val: String: header data (e.g. 1.2.3.4)</span>
<a href="#l6.4373"></a><span id="l6.4373" class="difflineplus">+   */</span>
<a href="#l6.4374"></a><span id="l6.4374" class="difflineplus">+  setAdditionalHeader: function(hdr, val) {</span>
<a href="#l6.4375"></a><span id="l6.4375" class="difflineplus">+    if (&quot;otherRandomHeaders&quot; in gMsgCompose.compFields) {</span>
<a href="#l6.4376"></a><span id="l6.4376" class="difflineplus">+      // TB &lt;= 36</span>
<a href="#l6.4377"></a><span id="l6.4377" class="difflineplus">+      gMsgCompose.compFields.otherRandomHeaders += hdr + &quot;: &quot; + val + &quot;\r\n&quot;;</span>
<a href="#l6.4378"></a><span id="l6.4378" class="difflineplus">+    }</span>
<a href="#l6.4379"></a><span id="l6.4379" class="difflineplus">+    else {</span>
<a href="#l6.4380"></a><span id="l6.4380" class="difflineplus">+      gMsgCompose.compFields.setHeader(hdr, val);</span>
<a href="#l6.4381"></a><span id="l6.4381" class="difflineplus">+    }</span>
<a href="#l6.4382"></a><span id="l6.4382" class="difflineplus">+  },</span>
<a href="#l6.4383"></a><span id="l6.4383" class="difflineplus">+</span>
<a href="#l6.4384"></a><span id="l6.4384" class="difflineplus">+  unsetAdditionalHeader: function(hdr) {</span>
<a href="#l6.4385"></a><span id="l6.4385" class="difflineplus">+    if (&quot;otherRandomHeaders&quot; in gMsgCompose.compFields) {</span>
<a href="#l6.4386"></a><span id="l6.4386" class="difflineplus">+      // TB &lt;= 36</span>
<a href="#l6.4387"></a><span id="l6.4387" class="difflineplus">+      let h = gMsgCompose.compFields.otherRandomHeaders;</span>
<a href="#l6.4388"></a><span id="l6.4388" class="difflineplus">+      let r = new RegExp(&quot;^(&quot; + hdr + &quot;:)(.*)$&quot;, &quot;im&quot;);</span>
<a href="#l6.4389"></a><span id="l6.4389" class="difflineplus">+      let m = h.replace(r, &quot;&quot;).replace(/(\r\n)+/, &quot;\r\n&quot;);</span>
<a href="#l6.4390"></a><span id="l6.4390" class="difflineplus">+      gMsgCompose.compFields.otherRandomHeaders = m;</span>
<a href="#l6.4391"></a><span id="l6.4391" class="difflineplus">+    }</span>
<a href="#l6.4392"></a><span id="l6.4392" class="difflineplus">+    else {</span>
<a href="#l6.4393"></a><span id="l6.4393" class="difflineplus">+      gMsgCompose.compFields.deleteHeader(hdr);</span>
<a href="#l6.4394"></a><span id="l6.4394" class="difflineplus">+    }</span>
<a href="#l6.4395"></a><span id="l6.4395" class="difflineplus">+  },</span>
<a href="#l6.4396"></a><span id="l6.4396" class="difflineplus">+</span>
<a href="#l6.4397"></a><span id="l6.4397" class="difflineplus">+  modifyCompFields: function() {</span>
<a href="#l6.4398"></a><span id="l6.4398" class="difflineplus">+</span>
<a href="#l6.4399"></a><span id="l6.4399" class="difflineplus">+    try {</span>
<a href="#l6.4400"></a><span id="l6.4400" class="difflineplus">+</span>
<a href="#l6.4401"></a><span id="l6.4401" class="difflineplus">+      if (!this.identity) {</span>
<a href="#l6.4402"></a><span id="l6.4402" class="difflineplus">+        this.identity = getCurrentIdentity();</span>
<a href="#l6.4403"></a><span id="l6.4403" class="difflineplus">+      }</span>
<a href="#l6.4404"></a><span id="l6.4404" class="difflineplus">+</span>
<a href="#l6.4405"></a><span id="l6.4405" class="difflineplus">+      if (this.isEnigmailEnabled()) {</span>
<a href="#l6.4406"></a><span id="l6.4406" class="difflineplus">+        if (EnigmailPrefs.getPref(&quot;addHeaders&quot;)) {</span>
<a href="#l6.4407"></a><span id="l6.4407" class="difflineplus">+          this.setAdditionalHeader(&quot;X-Enigmail-Version&quot;, EnigmailApp.getVersion());</span>
<a href="#l6.4408"></a><span id="l6.4408" class="difflineplus">+        }</span>
<a href="#l6.4409"></a><span id="l6.4409" class="difflineplus">+</span>
<a href="#l6.4410"></a><span id="l6.4410" class="difflineplus">+        this.setAutocryptHeader();</span>
<a href="#l6.4411"></a><span id="l6.4411" class="difflineplus">+      }</span>
<a href="#l6.4412"></a><span id="l6.4412" class="difflineplus">+    }</span>
<a href="#l6.4413"></a><span id="l6.4413" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4414"></a><span id="l6.4414" class="difflineplus">+      EnigmailLog.writeException(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.modifyCompFields&quot;, ex);</span>
<a href="#l6.4415"></a><span id="l6.4415" class="difflineplus">+    }</span>
<a href="#l6.4416"></a><span id="l6.4416" class="difflineplus">+  },</span>
<a href="#l6.4417"></a><span id="l6.4417" class="difflineplus">+</span>
<a href="#l6.4418"></a><span id="l6.4418" class="difflineplus">+  getCurrentIncomingServer: function() {</span>
<a href="#l6.4419"></a><span id="l6.4419" class="difflineplus">+    let currentAccountKey = getCurrentAccountKey();</span>
<a href="#l6.4420"></a><span id="l6.4420" class="difflineplus">+    let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l6.4421"></a><span id="l6.4421" class="difflineplus">+</span>
<a href="#l6.4422"></a><span id="l6.4422" class="difflineplus">+    return account.incomingServer; /* returns nsIMsgIncomingServer */</span>
<a href="#l6.4423"></a><span id="l6.4423" class="difflineplus">+  },</span>
<a href="#l6.4424"></a><span id="l6.4424" class="difflineplus">+</span>
<a href="#l6.4425"></a><span id="l6.4425" class="difflineplus">+  setAutocryptHeader: function() {</span>
<a href="#l6.4426"></a><span id="l6.4426" class="difflineplus">+    if (!this.isAutocryptEnabled()) return;</span>
<a href="#l6.4427"></a><span id="l6.4427" class="difflineplus">+</span>
<a href="#l6.4428"></a><span id="l6.4428" class="difflineplus">+    this.identity = getCurrentIdentity();</span>
<a href="#l6.4429"></a><span id="l6.4429" class="difflineplus">+    let fromMail = this.identity.email;</span>
<a href="#l6.4430"></a><span id="l6.4430" class="difflineplus">+</span>
<a href="#l6.4431"></a><span id="l6.4431" class="difflineplus">+    try {</span>
<a href="#l6.4432"></a><span id="l6.4432" class="difflineplus">+      fromMail = EnigmailFuncs.stripEmail(gMsgCompose.compFields.from);</span>
<a href="#l6.4433"></a><span id="l6.4433" class="difflineplus">+    }</span>
<a href="#l6.4434"></a><span id="l6.4434" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.4435"></a><span id="l6.4435" class="difflineplus">+</span>
<a href="#l6.4436"></a><span id="l6.4436" class="difflineplus">+    let key;</span>
<a href="#l6.4437"></a><span id="l6.4437" class="difflineplus">+    if (this.identity.getIntAttribute(&quot;pgpKeyMode&quot;) &gt; 0) {</span>
<a href="#l6.4438"></a><span id="l6.4438" class="difflineplus">+      key = EnigmailKeyRing.getKeyById(this.identity.getCharAttribute(&quot;pgpkeyId&quot;));</span>
<a href="#l6.4439"></a><span id="l6.4439" class="difflineplus">+    }</span>
<a href="#l6.4440"></a><span id="l6.4440" class="difflineplus">+    else {</span>
<a href="#l6.4441"></a><span id="l6.4441" class="difflineplus">+      key = EnigmailKeyRing.getSecretKeyByEmail(this.identity.email);</span>
<a href="#l6.4442"></a><span id="l6.4442" class="difflineplus">+    }</span>
<a href="#l6.4443"></a><span id="l6.4443" class="difflineplus">+</span>
<a href="#l6.4444"></a><span id="l6.4444" class="difflineplus">+    if (key) {</span>
<a href="#l6.4445"></a><span id="l6.4445" class="difflineplus">+      let srv = this.getCurrentIncomingServer();</span>
<a href="#l6.4446"></a><span id="l6.4446" class="difflineplus">+      let prefMutual = (srv.getIntValue(&quot;acPreferEncrypt&quot;) &gt; 0 ? &quot;; prefer-encrypt=mutual&quot; : &quot;&quot;);</span>
<a href="#l6.4447"></a><span id="l6.4447" class="difflineplus">+</span>
<a href="#l6.4448"></a><span id="l6.4448" class="difflineplus">+      let k = key.getMinimalPubKey(fromMail);</span>
<a href="#l6.4449"></a><span id="l6.4449" class="difflineplus">+      if (k.exitCode === 0) {</span>
<a href="#l6.4450"></a><span id="l6.4450" class="difflineplus">+        let keyData = &quot; &quot; + k.keyData.replace(/(.{72})/g, &quot;$1\r\n &quot;).replace(/\r\n $/, &quot;&quot;);</span>
<a href="#l6.4451"></a><span id="l6.4451" class="difflineplus">+        this.setAdditionalHeader('Autocrypt', 'addr=' + fromMail + prefMutual + '; keydata=\r\n' + keyData);</span>
<a href="#l6.4452"></a><span id="l6.4452" class="difflineplus">+      }</span>
<a href="#l6.4453"></a><span id="l6.4453" class="difflineplus">+    }</span>
<a href="#l6.4454"></a><span id="l6.4454" class="difflineplus">+  },</span>
<a href="#l6.4455"></a><span id="l6.4455" class="difflineplus">+</span>
<a href="#l6.4456"></a><span id="l6.4456" class="difflineplus">+  /**</span>
<a href="#l6.4457"></a><span id="l6.4457" class="difflineplus">+   * Handle the 'compose-send-message' event from TB</span>
<a href="#l6.4458"></a><span id="l6.4458" class="difflineplus">+   */</span>
<a href="#l6.4459"></a><span id="l6.4459" class="difflineplus">+  sendMessageListener: function(event) {</span>
<a href="#l6.4460"></a><span id="l6.4460" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.sendMessageListener\n&quot;);</span>
<a href="#l6.4461"></a><span id="l6.4461" class="difflineplus">+</span>
<a href="#l6.4462"></a><span id="l6.4462" class="difflineplus">+    // Do nothing if a compatible version of the &quot;SendLater&quot; addon is installed.</span>
<a href="#l6.4463"></a><span id="l6.4463" class="difflineplus">+    // SendLater will call handleSendMessageEvent when needed.</span>
<a href="#l6.4464"></a><span id="l6.4464" class="difflineplus">+</span>
<a href="#l6.4465"></a><span id="l6.4465" class="difflineplus">+    try {</span>
<a href="#l6.4466"></a><span id="l6.4466" class="difflineplus">+      if (typeof(Sendlater3Composing.callEnigmail) === &quot;function&quot;) {</span>
<a href="#l6.4467"></a><span id="l6.4467" class="difflineplus">+        return;</span>
<a href="#l6.4468"></a><span id="l6.4468" class="difflineplus">+      }</span>
<a href="#l6.4469"></a><span id="l6.4469" class="difflineplus">+    }</span>
<a href="#l6.4470"></a><span id="l6.4470" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.4471"></a><span id="l6.4471" class="difflineplus">+</span>
<a href="#l6.4472"></a><span id="l6.4472" class="difflineplus">+    Enigmail.msg.handleSendMessageEvent(event);</span>
<a href="#l6.4473"></a><span id="l6.4473" class="difflineplus">+  },</span>
<a href="#l6.4474"></a><span id="l6.4474" class="difflineplus">+</span>
<a href="#l6.4475"></a><span id="l6.4475" class="difflineplus">+  /**</span>
<a href="#l6.4476"></a><span id="l6.4476" class="difflineplus">+   * Perform handling of the compose-send-message' event from TB (or SendLater)</span>
<a href="#l6.4477"></a><span id="l6.4477" class="difflineplus">+   */</span>
<a href="#l6.4478"></a><span id="l6.4478" class="difflineplus">+  handleSendMessageEvent: function(event) {</span>
<a href="#l6.4479"></a><span id="l6.4479" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.handleSendMessageEvent\n&quot;);</span>
<a href="#l6.4480"></a><span id="l6.4480" class="difflineplus">+    let msgcomposeWindow = document.getElementById(&quot;msgcomposeWindow&quot;);</span>
<a href="#l6.4481"></a><span id="l6.4481" class="difflineplus">+    let sendMsgType = Number(msgcomposeWindow.getAttribute(&quot;msgtype&quot;));</span>
<a href="#l6.4482"></a><span id="l6.4482" class="difflineplus">+</span>
<a href="#l6.4483"></a><span id="l6.4483" class="difflineplus">+    if (!(this.sendProcess &amp;&amp; sendMsgType == Components.interfaces.nsIMsgCompDeliverMode.AutoSaveAsDraft)) {</span>
<a href="#l6.4484"></a><span id="l6.4484" class="difflineplus">+      this.sendProcess = true;</span>
<a href="#l6.4485"></a><span id="l6.4485" class="difflineplus">+      let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l6.4486"></a><span id="l6.4486" class="difflineplus">+</span>
<a href="#l6.4487"></a><span id="l6.4487" class="difflineplus">+      try {</span>
<a href="#l6.4488"></a><span id="l6.4488" class="difflineplus">+        this.modifyCompFields();</span>
<a href="#l6.4489"></a><span id="l6.4489" class="difflineplus">+        bc.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.4490"></a><span id="l6.4490" class="difflineplus">+        if (!this.encryptMsg(sendMsgType)) {</span>
<a href="#l6.4491"></a><span id="l6.4491" class="difflineplus">+          this.resetUpdatedFields();</span>
<a href="#l6.4492"></a><span id="l6.4492" class="difflineplus">+          event.preventDefault();</span>
<a href="#l6.4493"></a><span id="l6.4493" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l6.4494"></a><span id="l6.4494" class="difflineplus">+        }</span>
<a href="#l6.4495"></a><span id="l6.4495" class="difflineplus">+      }</span>
<a href="#l6.4496"></a><span id="l6.4496" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.4497"></a><span id="l6.4497" class="difflineplus">+      bc.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l6.4498"></a><span id="l6.4498" class="difflineplus">+    }</span>
<a href="#l6.4499"></a><span id="l6.4499" class="difflineplus">+    else {</span>
<a href="#l6.4500"></a><span id="l6.4500" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.sendMessageListener: sending in progress - autosave aborted\n&quot;);</span>
<a href="#l6.4501"></a><span id="l6.4501" class="difflineplus">+      event.preventDefault();</span>
<a href="#l6.4502"></a><span id="l6.4502" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l6.4503"></a><span id="l6.4503" class="difflineplus">+    }</span>
<a href="#l6.4504"></a><span id="l6.4504" class="difflineplus">+    this.sendProcess = false;</span>
<a href="#l6.4505"></a><span id="l6.4505" class="difflineplus">+  },</span>
<a href="#l6.4506"></a><span id="l6.4506" class="difflineplus">+</span>
<a href="#l6.4507"></a><span id="l6.4507" class="difflineplus">+</span>
<a href="#l6.4508"></a><span id="l6.4508" class="difflineplus">+  // encrypt attachments when sending inline PGP mails</span>
<a href="#l6.4509"></a><span id="l6.4509" class="difflineplus">+  // It's quite a hack: the attachments are stored locally</span>
<a href="#l6.4510"></a><span id="l6.4510" class="difflineplus">+  // and the attachments list is modified to pick up the</span>
<a href="#l6.4511"></a><span id="l6.4511" class="difflineplus">+  // encrypted file(s) instead of the original ones.</span>
<a href="#l6.4512"></a><span id="l6.4512" class="difflineplus">+  encryptAttachments: function(bucketList, newAttachments, window, uiFlags,</span>
<a href="#l6.4513"></a><span id="l6.4513" class="difflineplus">+    fromAddr, toAddr, bccAddr, sendFlags,</span>
<a href="#l6.4514"></a><span id="l6.4514" class="difflineplus">+    errorMsgObj) {</span>
<a href="#l6.4515"></a><span id="l6.4515" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptAttachments\n&quot;);</span>
<a href="#l6.4516"></a><span id="l6.4516" class="difflineplus">+</span>
<a href="#l6.4517"></a><span id="l6.4517" class="difflineplus">+    const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l6.4518"></a><span id="l6.4518" class="difflineplus">+    const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l6.4519"></a><span id="l6.4519" class="difflineplus">+</span>
<a href="#l6.4520"></a><span id="l6.4520" class="difflineplus">+    var ioServ;</span>
<a href="#l6.4521"></a><span id="l6.4521" class="difflineplus">+    var fileTemplate;</span>
<a href="#l6.4522"></a><span id="l6.4522" class="difflineplus">+    errorMsgObj.value = &quot;&quot;;</span>
<a href="#l6.4523"></a><span id="l6.4523" class="difflineplus">+</span>
<a href="#l6.4524"></a><span id="l6.4524" class="difflineplus">+    try {</span>
<a href="#l6.4525"></a><span id="l6.4525" class="difflineplus">+      ioServ = Components.classes[IOSERVICE_CONTRACTID].getService(Components.interfaces.nsIIOService);</span>
<a href="#l6.4526"></a><span id="l6.4526" class="difflineplus">+      if (!ioServ)</span>
<a href="#l6.4527"></a><span id="l6.4527" class="difflineplus">+        return -1;</span>
<a href="#l6.4528"></a><span id="l6.4528" class="difflineplus">+    }</span>
<a href="#l6.4529"></a><span id="l6.4529" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4530"></a><span id="l6.4530" class="difflineplus">+      return -1;</span>
<a href="#l6.4531"></a><span id="l6.4531" class="difflineplus">+    }</span>
<a href="#l6.4532"></a><span id="l6.4532" class="difflineplus">+</span>
<a href="#l6.4533"></a><span id="l6.4533" class="difflineplus">+    var tmpDir = EnigmailFiles.getTempDir();</span>
<a href="#l6.4534"></a><span id="l6.4534" class="difflineplus">+    var extAppLauncher = Components.classes[&quot;@mozilla.org/mime;1&quot;].getService(Components.interfaces.nsPIExternalAppLauncher);</span>
<a href="#l6.4535"></a><span id="l6.4535" class="difflineplus">+</span>
<a href="#l6.4536"></a><span id="l6.4536" class="difflineplus">+    try {</span>
<a href="#l6.4537"></a><span id="l6.4537" class="difflineplus">+      fileTemplate = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l6.4538"></a><span id="l6.4538" class="difflineplus">+      fileTemplate.initWithPath(tmpDir);</span>
<a href="#l6.4539"></a><span id="l6.4539" class="difflineplus">+      if (!(fileTemplate.isDirectory() &amp;&amp; fileTemplate.isWritable())) {</span>
<a href="#l6.4540"></a><span id="l6.4540" class="difflineplus">+        errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l6.4541"></a><span id="l6.4541" class="difflineplus">+        return -1;</span>
<a href="#l6.4542"></a><span id="l6.4542" class="difflineplus">+      }</span>
<a href="#l6.4543"></a><span id="l6.4543" class="difflineplus">+      fileTemplate.append(&quot;encfile&quot;);</span>
<a href="#l6.4544"></a><span id="l6.4544" class="difflineplus">+    }</span>
<a href="#l6.4545"></a><span id="l6.4545" class="difflineplus">+    catch (ex) {</span>
<a href="#l6.4546"></a><span id="l6.4546" class="difflineplus">+      errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l6.4547"></a><span id="l6.4547" class="difflineplus">+      return -1;</span>
<a href="#l6.4548"></a><span id="l6.4548" class="difflineplus">+    }</span>
<a href="#l6.4549"></a><span id="l6.4549" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptAttachments tmpDir=&quot; + tmpDir + &quot;\n&quot;);</span>
<a href="#l6.4550"></a><span id="l6.4550" class="difflineplus">+    var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.4551"></a><span id="l6.4551" class="difflineplus">+    if (!enigmailSvc)</span>
<a href="#l6.4552"></a><span id="l6.4552" class="difflineplus">+      return null;</span>
<a href="#l6.4553"></a><span id="l6.4553" class="difflineplus">+</span>
<a href="#l6.4554"></a><span id="l6.4554" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l6.4555"></a><span id="l6.4555" class="difflineplus">+    var statusFlagsObj = {};</span>
<a href="#l6.4556"></a><span id="l6.4556" class="difflineplus">+</span>
<a href="#l6.4557"></a><span id="l6.4557" class="difflineplus">+    var node = bucketList.firstChild;</span>
<a href="#l6.4558"></a><span id="l6.4558" class="difflineplus">+    while (node) {</span>
<a href="#l6.4559"></a><span id="l6.4559" class="difflineplus">+      var origUrl = node.attachment.url;</span>
<a href="#l6.4560"></a><span id="l6.4560" class="difflineplus">+      if (origUrl.substring(0, 7) != &quot;file://&quot;) {</span>
<a href="#l6.4561"></a><span id="l6.4561" class="difflineplus">+        // this should actually never happen since it is pre-checked!</span>
<a href="#l6.4562"></a><span id="l6.4562" class="difflineplus">+        errorMsgObj.value = &quot;The attachment '&quot; + node.attachment.name + &quot;' is not a local file&quot;;</span>
<a href="#l6.4563"></a><span id="l6.4563" class="difflineplus">+        return -1;</span>
<a href="#l6.4564"></a><span id="l6.4564" class="difflineplus">+      }</span>
<a href="#l6.4565"></a><span id="l6.4565" class="difflineplus">+</span>
<a href="#l6.4566"></a><span id="l6.4566" class="difflineplus">+      // transform attachment URL to platform-specific file name</span>
<a href="#l6.4567"></a><span id="l6.4567" class="difflineplus">+      var origUri = ioServ.newURI(origUrl, null, null);</span>
<a href="#l6.4568"></a><span id="l6.4568" class="difflineplus">+      var origFile = origUri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l6.4569"></a><span id="l6.4569" class="difflineplus">+      if (node.attachment.temporary) {</span>
<a href="#l6.4570"></a><span id="l6.4570" class="difflineplus">+        try {</span>
<a href="#l6.4571"></a><span id="l6.4571" class="difflineplus">+          var origLocalFile = Components.classes[LOCAL_FILE_CONTRACTID].createInstance(Components.interfaces.nsIFile);</span>
<a href="#l6.4572"></a><span id="l6.4572" class="difflineplus">+          origLocalFile.initWithPath(origFile.file.path);</span>
<a href="#l6.4573"></a><span id="l6.4573" class="difflineplus">+          extAppLauncher.deleteTemporaryFileOnExit(origLocalFile);</span>
<a href="#l6.4574"></a><span id="l6.4574" class="difflineplus">+        }</span>
<a href="#l6.4575"></a><span id="l6.4575" class="difflineplus">+        catch (ex) {}</span>
<a href="#l6.4576"></a><span id="l6.4576" class="difflineplus">+      }</span>
<a href="#l6.4577"></a><span id="l6.4577" class="difflineplus">+</span>
<a href="#l6.4578"></a><span id="l6.4578" class="difflineplus">+      var newFile = fileTemplate.clone();</span>
<a href="#l6.4579"></a><span id="l6.4579" class="difflineplus">+      var txtMessage;</span>
<a href="#l6.4580"></a><span id="l6.4580" class="difflineplus">+      try {</span>
<a href="#l6.4581"></a><span id="l6.4581" class="difflineplus">+        newFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, 0x180);</span>
<a href="#l6.4582"></a><span id="l6.4582" class="difflineplus">+        txtMessage = EnigmailEncryption.encryptAttachment(window, fromAddr, toAddr, bccAddr, sendFlags,</span>
<a href="#l6.4583"></a><span id="l6.4583" class="difflineplus">+          origFile.file, newFile,</span>
<a href="#l6.4584"></a><span id="l6.4584" class="difflineplus">+          exitCodeObj, statusFlagsObj,</span>
<a href="#l6.4585"></a><span id="l6.4585" class="difflineplus">+          errorMsgObj);</span>
<a href="#l6.4586"></a><span id="l6.4586" class="difflineplus">+      }</span>
<a href="#l6.4587"></a><span id="l6.4587" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.4588"></a><span id="l6.4588" class="difflineplus">+</span>
<a href="#l6.4589"></a><span id="l6.4589" class="difflineplus">+      if (exitCodeObj.value !== 0) {</span>
<a href="#l6.4590"></a><span id="l6.4590" class="difflineplus">+        return exitCodeObj.value;</span>
<a href="#l6.4591"></a><span id="l6.4591" class="difflineplus">+      }</span>
<a href="#l6.4592"></a><span id="l6.4592" class="difflineplus">+</span>
<a href="#l6.4593"></a><span id="l6.4593" class="difflineplus">+      var fileInfo = {</span>
<a href="#l6.4594"></a><span id="l6.4594" class="difflineplus">+        origFile: origFile,</span>
<a href="#l6.4595"></a><span id="l6.4595" class="difflineplus">+        origUrl: node.attachment.url,</span>
<a href="#l6.4596"></a><span id="l6.4596" class="difflineplus">+        origName: node.attachment.name,</span>
<a href="#l6.4597"></a><span id="l6.4597" class="difflineplus">+        origTemp: node.attachment.temporary,</span>
<a href="#l6.4598"></a><span id="l6.4598" class="difflineplus">+        origCType: node.attachment.contentType</span>
<a href="#l6.4599"></a><span id="l6.4599" class="difflineplus">+      };</span>
<a href="#l6.4600"></a><span id="l6.4600" class="difflineplus">+</span>
<a href="#l6.4601"></a><span id="l6.4601" class="difflineplus">+      // transform platform specific new file name to file:// URL</span>
<a href="#l6.4602"></a><span id="l6.4602" class="difflineplus">+      var newUri = ioServ.newFileURI(newFile);</span>
<a href="#l6.4603"></a><span id="l6.4603" class="difflineplus">+      fileInfo.newUrl = newUri.asciiSpec;</span>
<a href="#l6.4604"></a><span id="l6.4604" class="difflineplus">+      fileInfo.newFile = newFile;</span>
<a href="#l6.4605"></a><span id="l6.4605" class="difflineplus">+      fileInfo.encrypted = (sendFlags &amp; ENCRYPT);</span>
<a href="#l6.4606"></a><span id="l6.4606" class="difflineplus">+</span>
<a href="#l6.4607"></a><span id="l6.4607" class="difflineplus">+      newAttachments.push(fileInfo);</span>
<a href="#l6.4608"></a><span id="l6.4608" class="difflineplus">+      node = node.nextSibling;</span>
<a href="#l6.4609"></a><span id="l6.4609" class="difflineplus">+    }</span>
<a href="#l6.4610"></a><span id="l6.4610" class="difflineplus">+</span>
<a href="#l6.4611"></a><span id="l6.4611" class="difflineplus">+    var i = 0;</span>
<a href="#l6.4612"></a><span id="l6.4612" class="difflineplus">+    if (sendFlags &amp; ENCRYPT) {</span>
<a href="#l6.4613"></a><span id="l6.4613" class="difflineplus">+      // if we got here, all attachments were encrpted successfully,</span>
<a href="#l6.4614"></a><span id="l6.4614" class="difflineplus">+      // so we replace their names &amp; urls</span>
<a href="#l6.4615"></a><span id="l6.4615" class="difflineplus">+      node = bucketList.firstChild;</span>
<a href="#l6.4616"></a><span id="l6.4616" class="difflineplus">+</span>
<a href="#l6.4617"></a><span id="l6.4617" class="difflineplus">+      while (node) {</span>
<a href="#l6.4618"></a><span id="l6.4618" class="difflineplus">+        node.attachment.url = newAttachments[i].newUrl;</span>
<a href="#l6.4619"></a><span id="l6.4619" class="difflineplus">+        node.attachment.name += EnigmailPrefs.getPref(&quot;inlineAttachExt&quot;);</span>
<a href="#l6.4620"></a><span id="l6.4620" class="difflineplus">+        node.attachment.contentType = &quot;application/octet-stream&quot;;</span>
<a href="#l6.4621"></a><span id="l6.4621" class="difflineplus">+        node.attachment.temporary = true;</span>
<a href="#l6.4622"></a><span id="l6.4622" class="difflineplus">+</span>
<a href="#l6.4623"></a><span id="l6.4623" class="difflineplus">+        ++i;</span>
<a href="#l6.4624"></a><span id="l6.4624" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l6.4625"></a><span id="l6.4625" class="difflineplus">+      }</span>
<a href="#l6.4626"></a><span id="l6.4626" class="difflineplus">+    }</span>
<a href="#l6.4627"></a><span id="l6.4627" class="difflineplus">+    else {</span>
<a href="#l6.4628"></a><span id="l6.4628" class="difflineplus">+      // for inline signing we need to add new attachments for every</span>
<a href="#l6.4629"></a><span id="l6.4629" class="difflineplus">+      // signed file</span>
<a href="#l6.4630"></a><span id="l6.4630" class="difflineplus">+      for (i = 0; i &lt; newAttachments.length; i++) {</span>
<a href="#l6.4631"></a><span id="l6.4631" class="difflineplus">+        // create new attachment</span>
<a href="#l6.4632"></a><span id="l6.4632" class="difflineplus">+        var fileAttachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;].createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l6.4633"></a><span id="l6.4633" class="difflineplus">+        fileAttachment.temporary = true;</span>
<a href="#l6.4634"></a><span id="l6.4634" class="difflineplus">+        fileAttachment.url = newAttachments[i].newUrl;</span>
<a href="#l6.4635"></a><span id="l6.4635" class="difflineplus">+        fileAttachment.name = newAttachments[i].origName + EnigmailPrefs.getPref(&quot;inlineSigAttachExt&quot;);</span>
<a href="#l6.4636"></a><span id="l6.4636" class="difflineplus">+</span>
<a href="#l6.4637"></a><span id="l6.4637" class="difflineplus">+        // add attachment to msg</span>
<a href="#l6.4638"></a><span id="l6.4638" class="difflineplus">+        this.addAttachment(fileAttachment);</span>
<a href="#l6.4639"></a><span id="l6.4639" class="difflineplus">+      }</span>
<a href="#l6.4640"></a><span id="l6.4640" class="difflineplus">+</span>
<a href="#l6.4641"></a><span id="l6.4641" class="difflineplus">+    }</span>
<a href="#l6.4642"></a><span id="l6.4642" class="difflineplus">+    return 0;</span>
<a href="#l6.4643"></a><span id="l6.4643" class="difflineplus">+  },</span>
<a href="#l6.4644"></a><span id="l6.4644" class="difflineplus">+</span>
<a href="#l6.4645"></a><span id="l6.4645" class="difflineplus">+  toggleAttribute: function(attrName) {</span>
<a href="#l6.4646"></a><span id="l6.4646" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleAttribute('&quot; + attrName + &quot;')\n&quot;);</span>
<a href="#l6.4647"></a><span id="l6.4647" class="difflineplus">+</span>
<a href="#l6.4648"></a><span id="l6.4648" class="difflineplus">+    var menuElement = document.getElementById(&quot;enigmail_&quot; + attrName);</span>
<a href="#l6.4649"></a><span id="l6.4649" class="difflineplus">+</span>
<a href="#l6.4650"></a><span id="l6.4650" class="difflineplus">+    var oldValue = EnigmailPrefs.getPref(attrName);</span>
<a href="#l6.4651"></a><span id="l6.4651" class="difflineplus">+    EnigmailPrefs.setPref(attrName, !oldValue);</span>
<a href="#l6.4652"></a><span id="l6.4652" class="difflineplus">+  },</span>
<a href="#l6.4653"></a><span id="l6.4653" class="difflineplus">+</span>
<a href="#l6.4654"></a><span id="l6.4654" class="difflineplus">+  toggleAccountAttr: function(attrName) {</span>
<a href="#l6.4655"></a><span id="l6.4655" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.toggleAccountAttr('&quot; + attrName + &quot;')\n&quot;);</span>
<a href="#l6.4656"></a><span id="l6.4656" class="difflineplus">+</span>
<a href="#l6.4657"></a><span id="l6.4657" class="difflineplus">+    var oldValue = this.identity.getBoolAttribute(attrName);</span>
<a href="#l6.4658"></a><span id="l6.4658" class="difflineplus">+    this.identity.setBoolAttribute(attrName, !oldValue);</span>
<a href="#l6.4659"></a><span id="l6.4659" class="difflineplus">+</span>
<a href="#l6.4660"></a><span id="l6.4660" class="difflineplus">+  },</span>
<a href="#l6.4661"></a><span id="l6.4661" class="difflineplus">+</span>
<a href="#l6.4662"></a><span id="l6.4662" class="difflineplus">+  decryptQuote: function(interactive) {</span>
<a href="#l6.4663"></a><span id="l6.4663" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: &quot; + interactive + &quot;\n&quot;);</span>
<a href="#l6.4664"></a><span id="l6.4664" class="difflineplus">+</span>
<a href="#l6.4665"></a><span id="l6.4665" class="difflineplus">+    if (gWindowLocked || this.processed)</span>
<a href="#l6.4666"></a><span id="l6.4666" class="difflineplus">+      return;</span>
<a href="#l6.4667"></a><span id="l6.4667" class="difflineplus">+</span>
<a href="#l6.4668"></a><span id="l6.4668" class="difflineplus">+    var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l6.4669"></a><span id="l6.4669" class="difflineplus">+    if (!enigmailSvc)</span>
<a href="#l6.4670"></a><span id="l6.4670" class="difflineplus">+      return;</span>
<a href="#l6.4671"></a><span id="l6.4671" class="difflineplus">+</span>
<a href="#l6.4672"></a><span id="l6.4672" class="difflineplus">+    const dce = Components.interfaces.nsIDocumentEncoder;</span>
<a href="#l6.4673"></a><span id="l6.4673" class="difflineplus">+    var encoderFlags = dce.OutputFormatted | dce.OutputLFLineBreak;</span>
<a href="#l6.4674"></a><span id="l6.4674" class="difflineplus">+</span>
<a href="#l6.4675"></a><span id="l6.4675" class="difflineplus">+    var docText = this.editorGetContentAs(&quot;text/plain&quot;, encoderFlags);</span>
<a href="#l6.4676"></a><span id="l6.4676" class="difflineplus">+</span>
<a href="#l6.4677"></a><span id="l6.4677" class="difflineplus">+    var blockBegin = docText.indexOf(&quot;-----BEGIN PGP &quot;);</span>
<a href="#l6.4678"></a><span id="l6.4678" class="difflineplus">+    if (blockBegin &lt; 0)</span>
<a href="#l6.4679"></a><span id="l6.4679" class="difflineplus">+      return;</span>
<a href="#l6.4680"></a><span id="l6.4680" class="difflineplus">+</span>
<a href="#l6.4681"></a><span id="l6.4681" class="difflineplus">+    // Determine indentation string</span>
<a href="#l6.4682"></a><span id="l6.4682" class="difflineplus">+    var indentBegin = docText.substr(0, blockBegin).lastIndexOf(&quot;\n&quot;);</span>
<a href="#l6.4683"></a><span id="l6.4683" class="difflineplus">+    var indentStr = docText.substring(indentBegin + 1, blockBegin);</span>
<a href="#l6.4684"></a><span id="l6.4684" class="difflineplus">+</span>
<a href="#l6.4685"></a><span id="l6.4685" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: indentStr='&quot; + indentStr + &quot;'\n&quot;);</span>
<a href="#l6.4686"></a><span id="l6.4686" class="difflineplus">+</span>
<a href="#l6.4687"></a><span id="l6.4687" class="difflineplus">+    var beginIndexObj = {};</span>
<a href="#l6.4688"></a><span id="l6.4688" class="difflineplus">+    var endIndexObj = {};</span>
<a href="#l6.4689"></a><span id="l6.4689" class="difflineplus">+    var indentStrObj = {};</span>
<a href="#l6.4690"></a><span id="l6.4690" class="difflineplus">+    var blockType = EnigmailArmor.locateArmoredBlock(docText, 0, indentStr, beginIndexObj, endIndexObj, indentStrObj);</span>
<a href="#l6.4691"></a><span id="l6.4691" class="difflineplus">+    if ((blockType != &quot;MESSAGE&quot;) &amp;&amp; (blockType != &quot;SIGNED MESSAGE&quot;))</span>
<a href="#l6.4692"></a><span id="l6.4692" class="difflineplus">+      return;</span>
<a href="#l6.4693"></a><span id="l6.4693" class="difflineplus">+</span>
<a href="#l6.4694"></a><span id="l6.4694" class="difflineplus">+    var beginIndex = beginIndexObj.value;</span>
<a href="#l6.4695"></a><span id="l6.4695" class="difflineplus">+    var endIndex = endIndexObj.value;</span>
<a href="#l6.4696"></a><span id="l6.4696" class="difflineplus">+</span>
<a href="#l6.4697"></a><span id="l6.4697" class="difflineplus">+    var head = docText.substr(0, beginIndex);</span>
<a href="#l6.4698"></a><span id="l6.4698" class="difflineplus">+    var tail = docText.substr(endIndex + 1);</span>
<a href="#l6.4699"></a><span id="l6.4699" class="difflineplus">+</span>
<a href="#l6.4700"></a><span id="l6.4700" class="difflineplus">+    var pgpBlock = docText.substr(beginIndex, endIndex - beginIndex + 1);</span>
<a href="#l6.4701"></a><span id="l6.4701" class="difflineplus">+    var indentRegexp;</span>
<a href="#l6.4702"></a><span id="l6.4702" class="difflineplus">+</span>
<a href="#l6.4703"></a><span id="l6.4703" class="difflineplus">+    if (indentStr) {</span>
<a href="#l6.4704"></a><span id="l6.4704" class="difflineplus">+      if (indentStr == &quot;&gt; &quot;) {</span>
<a href="#l6.4705"></a><span id="l6.4705" class="difflineplus">+        // replace &quot;&gt;&gt; &quot; with &quot;&gt; &gt; &quot; to allow correct quoting</span>
<a href="#l6.4706"></a><span id="l6.4706" class="difflineplus">+        pgpBlock = pgpBlock.replace(/^&gt;&gt;/gm, &quot;&gt; &gt;&quot;);</span>
<a href="#l6.4707"></a><span id="l6.4707" class="difflineplus">+      }</span>
<a href="#l6.4708"></a><span id="l6.4708" class="difflineplus">+</span>
<a href="#l6.4709"></a><span id="l6.4709" class="difflineplus">+      // Delete indentation</span>
<a href="#l6.4710"></a><span id="l6.4710" class="difflineplus">+      indentRegexp = new RegExp(&quot;^&quot; + indentStr, &quot;gm&quot;);</span>
<a href="#l6.4711"></a><span id="l6.4711" class="difflineplus">+</span>
<a href="#l6.4712"></a><span id="l6.4712" class="difflineplus">+      pgpBlock = pgpBlock.replace(indentRegexp, &quot;&quot;);</span>
<a href="#l6.4713"></a><span id="l6.4713" class="difflineplus">+      //tail     =     tail.replace(indentRegexp, &quot;&quot;);</span>
<a href="#l6.4714"></a><span id="l6.4714" class="difflineplus">+</span>
<a href="#l6.4715"></a><span id="l6.4715" class="difflineplus">+      if (indentStr.match(/[ \t]*$/)) {</span>
<a href="#l6.4716"></a><span id="l6.4716" class="difflineplus">+        indentStr = indentStr.replace(/[ \t]*$/gm, &quot;&quot;);</span>
<a href="#l6.4717"></a><span id="l6.4717" class="difflineplus">+        indentRegexp = new RegExp(&quot;^&quot; + indentStr + &quot;$&quot;, &quot;gm&quot;);</span>
<a href="#l6.4718"></a><span id="l6.4718" class="difflineplus">+</span>
<a href="#l6.4719"></a><span id="l6.4719" class="difflineplus">+        pgpBlock = pgpBlock.replace(indentRegexp, &quot;&quot;);</span>
<a href="#l6.4720"></a><span id="l6.4720" class="difflineplus">+      }</span>
<a href="#l6.4721"></a><span id="l6.4721" class="difflineplus">+</span>
<a href="#l6.4722"></a><span id="l6.4722" class="difflineplus">+</span>
<a href="#l6.4723"></a><span id="l6.4723" class="difflineplus">+      // Handle blank indented lines</span>
<a href="#l6.4724"></a><span id="l6.4724" class="difflineplus">+      pgpBlock = pgpBlock.replace(/^[ \t]*&gt;[ \t]*$/gm, &quot;&quot;);</span>
<a href="#l6.4725"></a><span id="l6.4725" class="difflineplus">+      //tail     =     tail.replace(/^[ \t]*&gt;[ \t]*$/g, &quot;&quot;);</span>
<a href="#l6.4726"></a><span id="l6.4726" class="difflineplus">+</span>
<a href="#l6.4727"></a><span id="l6.4727" class="difflineplus">+      // Trim leading space in tail</span>
<a href="#l6.4728"></a><span id="l6.4728" class="difflineplus">+      tail = tail.replace(/^\s*\n/m, &quot;\n&quot;);</span>
<a href="#l6.4729"></a><span id="l6.4729" class="difflineplus">+    }</span>
<a href="#l6.4730"></a><span id="l6.4730" class="difflineplus">+</span>
<a href="#l6.4731"></a><span id="l6.4731" class="difflineplus">+    if (tail.search(/\S/) &lt; 0) {</span>
<a href="#l6.4732"></a><span id="l6.4732" class="difflineplus">+      // No non-space characters in tail; delete it</span>
<a href="#l6.4733"></a><span id="l6.4733" class="difflineplus">+      tail = &quot;&quot;;</span>
<a href="#l6.4734"></a><span id="l6.4734" class="difflineplus">+    }</span>
<a href="#l6.4735"></a><span id="l6.4735" class="difflineplus">+</span>
<a href="#l6.4736"></a><span id="l6.4736" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: pgpBlock='&quot;+pgpBlock+&quot;'\n&quot;);</span>
<a href="#l6.4737"></a><span id="l6.4737" class="difflineplus">+</span>
<a href="#l6.4738"></a><span id="l6.4738" class="difflineplus">+    var charset = this.editorGetCharset();</span>
<a href="#l6.4739"></a><span id="l6.4739" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: charset=&quot; + charset + &quot;\n&quot;);</span>
<a href="#l6.4740"></a><span id="l6.4740" class="difflineplus">+</span>
<a href="#l6.4741"></a><span id="l6.4741" class="difflineplus">+    // Encode ciphertext from unicode to charset</span>
<a href="#l6.4742"></a><span id="l6.4742" class="difflineplus">+    var cipherText = EnigmailData.convertFromUnicode(pgpBlock, charset);</span>
<a href="#l6.4743"></a><span id="l6.4743" class="difflineplus">+</span>
<a href="#l6.4744"></a><span id="l6.4744" class="difflineplus">+    if ((!this.getMailPref(&quot;mailnews.reply_in_default_charset&quot;)) &amp;&amp; (blockType == &quot;MESSAGE&quot;)) {</span>
<a href="#l6.4745"></a><span id="l6.4745" class="difflineplus">+      // set charset according to PGP block, if available (encrypted messages only)</span>
<a href="#l6.4746"></a><span id="l6.4746" class="difflineplus">+      let armorHeaders = EnigmailArmor.getArmorHeaders(cipherText);</span>
<a href="#l6.4747"></a><span id="l6.4747" class="difflineplus">+</span>
<a href="#l6.4748"></a><span id="l6.4748" class="difflineplus">+      if (&quot;charset&quot; in armorHeaders) {</span>
<a href="#l6.4749"></a><span id="l6.4749" class="difflineplus">+        charset = armorHeaders.charset;</span>
<a href="#l6.4750"></a><span id="l6.4750" class="difflineplus">+        gMsgCompose.SetDocumentCharset(charset);</span>
<a href="#l6.4751"></a><span id="l6.4751" class="difflineplus">+      }</span>
<a href="#l6.4752"></a><span id="l6.4752" class="difflineplus">+    }</span>
<a href="#l6.4753"></a><span id="l6.4753" class="difflineplus">+</span>
<a href="#l6.4754"></a><span id="l6.4754" class="difflineplus">+    // Decrypt message</span>
<a href="#l6.4755"></a><span id="l6.4755" class="difflineplus">+    var signatureObj = {};</span>
<a href="#l6.4756"></a><span id="l6.4756" class="difflineplus">+    signatureObj.value = &quot;&quot;;</span>
<a href="#l6.4757"></a><span id="l6.4757" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l6.4758"></a><span id="l6.4758" class="difflineplus">+    var statusFlagsObj = {};</span>
<a href="#l6.4759"></a><span id="l6.4759" class="difflineplus">+    var userIdObj = {};</span>
<a href="#l6.4760"></a><span id="l6.4760" class="difflineplus">+    var keyIdObj = {};</span>
<a href="#l6.4761"></a><span id="l6.4761" class="difflineplus">+    var sigDetailsObj = {};</span>
<a href="#l6.4762"></a><span id="l6.4762" class="difflineplus">+    var errorMsgObj = {};</span>
<a href="#l6.4763"></a><span id="l6.4763" class="difflineplus">+    var blockSeparationObj = {};</span>
<a href="#l6.4764"></a><span id="l6.4764" class="difflineplus">+    var encToDetailsObj = {};</span>
<a href="#l6.4765"></a><span id="l6.4765" class="difflineplus">+</span>
<a href="#l6.4766"></a><span id="l6.4766" class="difflineplus">+    var uiFlags = EnigmailConstants.UI_UNVERIFIED_ENC_OK;</span>
<a href="#l6.4767"></a><span id="l6.4767" class="difflineplus">+</span>
<a href="#l6.4768"></a><span id="l6.4768" class="difflineplus">+    var plainText = &quot;&quot;;</span>
<a href="#l6.4769"></a><span id="l6.4769" class="difflineplus">+</span>
<a href="#l6.4770"></a><span id="l6.4770" class="difflineplus">+    plainText = EnigmailDecryption.decryptMessage(window, uiFlags, cipherText,</span>
<a href="#l6.4771"></a><span id="l6.4771" class="difflineplus">+      signatureObj, exitCodeObj, statusFlagsObj,</span>
<a href="#l6.4772"></a><span id="l6.4772" class="difflineplus">+      keyIdObj, userIdObj, sigDetailsObj,</span>
<a href="#l6.4773"></a><span id="l6.4773" class="difflineplus">+      errorMsgObj, blockSeparationObj, encToDetailsObj);</span>
<a href="#l6.4774"></a><span id="l6.4774" class="difflineplus">+    // Decode plaintext from charset to unicode</span>
<a href="#l6.4775"></a><span id="l6.4775" class="difflineplus">+    plainText = EnigmailData.convertToUnicode(plainText, charset).replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l6.4776"></a><span id="l6.4776" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;keepSettingsForReply&quot;)) {</span>
<a href="#l6.4777"></a><span id="l6.4777" class="difflineplus">+      if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY)</span>
<a href="#l6.4778"></a><span id="l6.4778" class="difflineplus">+        this.setSendMode('encrypt');</span>
<a href="#l6.4779"></a><span id="l6.4779" class="difflineplus">+    }</span>
<a href="#l6.4780"></a><span id="l6.4780" class="difflineplus">+</span>
<a href="#l6.4781"></a><span id="l6.4781" class="difflineplus">+    var exitCode = exitCodeObj.value;</span>
<a href="#l6.4782"></a><span id="l6.4782" class="difflineplus">+</span>
<a href="#l6.4783"></a><span id="l6.4783" class="difflineplus">+    if (exitCode !== 0) {</span>
<a href="#l6.4784"></a><span id="l6.4784" class="difflineplus">+      // Error processing</span>
<a href="#l6.4785"></a><span id="l6.4785" class="difflineplus">+      var errorMsg = errorMsgObj.value;</span>
<a href="#l6.4786"></a><span id="l6.4786" class="difflineplus">+</span>
<a href="#l6.4787"></a><span id="l6.4787" class="difflineplus">+      var statusLines = errorMsg.split(/\r?\n/);</span>
<a href="#l6.4788"></a><span id="l6.4788" class="difflineplus">+</span>
<a href="#l6.4789"></a><span id="l6.4789" class="difflineplus">+      var displayMsg;</span>
<a href="#l6.4790"></a><span id="l6.4790" class="difflineplus">+      if (statusLines &amp;&amp; statusLines.length) {</span>
<a href="#l6.4791"></a><span id="l6.4791" class="difflineplus">+        // Display only first ten lines of error message</span>
<a href="#l6.4792"></a><span id="l6.4792" class="difflineplus">+        while (statusLines.length &gt; 10)</span>
<a href="#l6.4793"></a><span id="l6.4793" class="difflineplus">+          statusLines.pop();</span>
<a href="#l6.4794"></a><span id="l6.4794" class="difflineplus">+</span>
<a href="#l6.4795"></a><span id="l6.4795" class="difflineplus">+        displayMsg = statusLines.join(&quot;\n&quot;);</span>
<a href="#l6.4796"></a><span id="l6.4796" class="difflineplus">+</span>
<a href="#l6.4797"></a><span id="l6.4797" class="difflineplus">+        if (interactive)</span>
<a href="#l6.4798"></a><span id="l6.4798" class="difflineplus">+          EnigmailDialog.info(window, displayMsg);</span>
<a href="#l6.4799"></a><span id="l6.4799" class="difflineplus">+      }</span>
<a href="#l6.4800"></a><span id="l6.4800" class="difflineplus">+    }</span>
<a href="#l6.4801"></a><span id="l6.4801" class="difflineplus">+</span>
<a href="#l6.4802"></a><span id="l6.4802" class="difflineplus">+    if (blockType == &quot;MESSAGE&quot; &amp;&amp; exitCode === 0 &amp;&amp; plainText.length === 0) {</span>
<a href="#l6.4803"></a><span id="l6.4803" class="difflineplus">+      plainText = &quot; &quot;;</span>
<a href="#l6.4804"></a><span id="l6.4804" class="difflineplus">+    }</span>
<a href="#l6.4805"></a><span id="l6.4805" class="difflineplus">+</span>
<a href="#l6.4806"></a><span id="l6.4806" class="difflineplus">+    if (!plainText) {</span>
<a href="#l6.4807"></a><span id="l6.4807" class="difflineplus">+      if (blockType != &quot;SIGNED MESSAGE&quot;)</span>
<a href="#l6.4808"></a><span id="l6.4808" class="difflineplus">+        return;</span>
<a href="#l6.4809"></a><span id="l6.4809" class="difflineplus">+</span>
<a href="#l6.4810"></a><span id="l6.4810" class="difflineplus">+      // Extract text portion of clearsign block</span>
<a href="#l6.4811"></a><span id="l6.4811" class="difflineplus">+      plainText = EnigmailArmor.extractSignaturePart(pgpBlock, EnigmailConstants.SIGNATURE_TEXT);</span>
<a href="#l6.4812"></a><span id="l6.4812" class="difflineplus">+    }</span>
<a href="#l6.4813"></a><span id="l6.4813" class="difflineplus">+</span>
<a href="#l6.4814"></a><span id="l6.4814" class="difflineplus">+    const nsIMsgCompType = Components.interfaces.nsIMsgCompType;</span>
<a href="#l6.4815"></a><span id="l6.4815" class="difflineplus">+    var doubleDashSeparator = EnigmailPrefs.getPref(&quot;doubleDashSeparator&quot;);</span>
<a href="#l6.4816"></a><span id="l6.4816" class="difflineplus">+    if (gMsgCompose.type != nsIMsgCompType.Template &amp;&amp;</span>
<a href="#l6.4817"></a><span id="l6.4817" class="difflineplus">+      gMsgCompose.type != nsIMsgCompType.Draft &amp;&amp;</span>
<a href="#l6.4818"></a><span id="l6.4818" class="difflineplus">+      doubleDashSeparator) {</span>
<a href="#l6.4819"></a><span id="l6.4819" class="difflineplus">+      var signOffset = plainText.search(/[\r\n]-- +[\r\n]/);</span>
<a href="#l6.4820"></a><span id="l6.4820" class="difflineplus">+</span>
<a href="#l6.4821"></a><span id="l6.4821" class="difflineplus">+      if (signOffset &lt; 0 &amp;&amp; blockType == &quot;SIGNED MESSAGE&quot;) {</span>
<a href="#l6.4822"></a><span id="l6.4822" class="difflineplus">+        signOffset = plainText.search(/[\r\n]--[\r\n]/);</span>
<a href="#l6.4823"></a><span id="l6.4823" class="difflineplus">+      }</span>
<a href="#l6.4824"></a><span id="l6.4824" class="difflineplus">+</span>
<a href="#l6.4825"></a><span id="l6.4825" class="difflineplus">+      if (signOffset &gt; 0) {</span>
<a href="#l6.4826"></a><span id="l6.4826" class="difflineplus">+        // Strip signature portion of quoted message</span>
<a href="#l6.4827"></a><span id="l6.4827" class="difflineplus">+        plainText = plainText.substr(0, signOffset + 1);</span>
<a href="#l6.4828"></a><span id="l6.4828" class="difflineplus">+      }</span>
<a href="#l6.4829"></a><span id="l6.4829" class="difflineplus">+    }</span>
<a href="#l6.4830"></a><span id="l6.4830" class="difflineplus">+</span>
<a href="#l6.4831"></a><span id="l6.4831" class="difflineplus">+    var clipBoard = Components.classes[&quot;@mozilla.org/widget/clipboard;1&quot;].getService(Components.interfaces.nsIClipboard);</span>
<a href="#l6.4832"></a><span id="l6.4832" class="difflineplus">+    var data;</span>
<a href="#l6.4833"></a><span id="l6.4833" class="difflineplus">+    if (clipBoard.supportsSelectionClipboard()) {</span>
<a href="#l6.4834"></a><span id="l6.4834" class="difflineplus">+      // get the clipboard contents for selected text (X11)</span>
<a href="#l6.4835"></a><span id="l6.4835" class="difflineplus">+      data = EnigmailClipboard.getClipboardContent(window, Components.interfaces.nsIClipboard.kSelectionClipboard);</span>
<a href="#l6.4836"></a><span id="l6.4836" class="difflineplus">+    }</span>
<a href="#l6.4837"></a><span id="l6.4837" class="difflineplus">+</span>
<a href="#l6.4838"></a><span id="l6.4838" class="difflineplus">+    // Replace encrypted quote with decrypted quote (destroys selection clipboard on X11)</span>
<a href="#l6.4839"></a><span id="l6.4839" class="difflineplus">+    this.editorSelectAll();</span>
<a href="#l6.4840"></a><span id="l6.4840" class="difflineplus">+</span>
<a href="#l6.4841"></a><span id="l6.4841" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: plainText='&quot;+plainText+&quot;'\n&quot;);</span>
<a href="#l6.4842"></a><span id="l6.4842" class="difflineplus">+</span>
<a href="#l6.4843"></a><span id="l6.4843" class="difflineplus">+    if (head)</span>
<a href="#l6.4844"></a><span id="l6.4844" class="difflineplus">+      this.editorInsertText(head);</span>
<a href="#l6.4845"></a><span id="l6.4845" class="difflineplus">+</span>
<a href="#l6.4846"></a><span id="l6.4846" class="difflineplus">+    var quoteElement;</span>
<a href="#l6.4847"></a><span id="l6.4847" class="difflineplus">+</span>
<a href="#l6.4848"></a><span id="l6.4848" class="difflineplus">+    if (indentStr) {</span>
<a href="#l6.4849"></a><span id="l6.4849" class="difflineplus">+      quoteElement = this.editorInsertAsQuotation(plainText);</span>
<a href="#l6.4850"></a><span id="l6.4850" class="difflineplus">+</span>
<a href="#l6.4851"></a><span id="l6.4851" class="difflineplus">+    }</span>
<a href="#l6.4852"></a><span id="l6.4852" class="difflineplus">+    else {</span>
<a href="#l6.4853"></a><span id="l6.4853" class="difflineplus">+      this.editorInsertText(plainText);</span>
<a href="#l6.4854"></a><span id="l6.4854" class="difflineplus">+    }</span>
<a href="#l6.4855"></a><span id="l6.4855" class="difflineplus">+</span>
<a href="#l6.4856"></a><span id="l6.4856" class="difflineplus">+    if (tail)</span>
<a href="#l6.4857"></a><span id="l6.4857" class="difflineplus">+      this.editorInsertText(tail);</span>
<a href="#l6.4858"></a><span id="l6.4858" class="difflineplus">+</span>
<a href="#l6.4859"></a><span id="l6.4859" class="difflineplus">+    if (statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l6.4860"></a><span id="l6.4860" class="difflineplus">+      this.checkInlinePgpReply(head, tail);</span>
<a href="#l6.4861"></a><span id="l6.4861" class="difflineplus">+    }</span>
<a href="#l6.4862"></a><span id="l6.4862" class="difflineplus">+</span>
<a href="#l6.4863"></a><span id="l6.4863" class="difflineplus">+    if (clipBoard.supportsSelectionClipboard()) {</span>
<a href="#l6.4864"></a><span id="l6.4864" class="difflineplus">+      // restore the clipboard contents for selected text (X11)</span>
<a href="#l6.4865"></a><span id="l6.4865" class="difflineplus">+      EnigmailClipboard.setClipboardContent(data, clipBoard.kSelectionClipboard);</span>
<a href="#l6.4866"></a><span id="l6.4866" class="difflineplus">+    }</span>
<a href="#l6.4867"></a><span id="l6.4867" class="difflineplus">+</span>
<a href="#l6.4868"></a><span id="l6.4868" class="difflineplus">+    if (interactive)</span>
<a href="#l6.4869"></a><span id="l6.4869" class="difflineplus">+      return;</span>
<a href="#l6.4870"></a><span id="l6.4870" class="difflineplus">+</span>
<a href="#l6.4871"></a><span id="l6.4871" class="difflineplus">+    // Position cursor</span>
<a href="#l6.4872"></a><span id="l6.4872" class="difflineplus">+    var replyOnTop = 1;</span>
<a href="#l6.4873"></a><span id="l6.4873" class="difflineplus">+    try {</span>
<a href="#l6.4874"></a><span id="l6.4874" class="difflineplus">+      replyOnTop = this.identity.replyOnTop;</span>
<a href="#l6.4875"></a><span id="l6.4875" class="difflineplus">+    }</span>
<a href="#l6.4876"></a><span id="l6.4876" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.4877"></a><span id="l6.4877" class="difflineplus">+</span>
<a href="#l6.4878"></a><span id="l6.4878" class="difflineplus">+    if (!indentStr || !quoteElement)</span>
<a href="#l6.4879"></a><span id="l6.4879" class="difflineplus">+      replyOnTop = 1;</span>
<a href="#l6.4880"></a><span id="l6.4880" class="difflineplus">+</span>
<a href="#l6.4881"></a><span id="l6.4881" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.decryptQuote: replyOnTop=&quot; + replyOnTop + &quot;, quoteElement=&quot; + quoteElement + &quot;\n&quot;);</span>
<a href="#l6.4882"></a><span id="l6.4882" class="difflineplus">+</span>
<a href="#l6.4883"></a><span id="l6.4883" class="difflineplus">+    var nsISelectionController = Components.interfaces.nsISelectionController;</span>
<a href="#l6.4884"></a><span id="l6.4884" class="difflineplus">+</span>
<a href="#l6.4885"></a><span id="l6.4885" class="difflineplus">+    if (this.editor.selectionController) {</span>
<a href="#l6.4886"></a><span id="l6.4886" class="difflineplus">+      var selection = this.editor.selectionController;</span>
<a href="#l6.4887"></a><span id="l6.4887" class="difflineplus">+      selection.completeMove(false, false); // go to start;</span>
<a href="#l6.4888"></a><span id="l6.4888" class="difflineplus">+</span>
<a href="#l6.4889"></a><span id="l6.4889" class="difflineplus">+      switch (replyOnTop) {</span>
<a href="#l6.4890"></a><span id="l6.4890" class="difflineplus">+        case 0:</span>
<a href="#l6.4891"></a><span id="l6.4891" class="difflineplus">+          // Position after quote</span>
<a href="#l6.4892"></a><span id="l6.4892" class="difflineplus">+          this.editor.endOfDocument();</span>
<a href="#l6.4893"></a><span id="l6.4893" class="difflineplus">+          if (tail) {</span>
<a href="#l6.4894"></a><span id="l6.4894" class="difflineplus">+            for (let cPos = 0; cPos &lt; tail.length; cPos++) {</span>
<a href="#l6.4895"></a><span id="l6.4895" class="difflineplus">+              selection.characterMove(false, false); // move backwards</span>
<a href="#l6.4896"></a><span id="l6.4896" class="difflineplus">+            }</span>
<a href="#l6.4897"></a><span id="l6.4897" class="difflineplus">+          }</span>
<a href="#l6.4898"></a><span id="l6.4898" class="difflineplus">+          break;</span>
<a href="#l6.4899"></a><span id="l6.4899" class="difflineplus">+</span>
<a href="#l6.4900"></a><span id="l6.4900" class="difflineplus">+        case 2:</span>
<a href="#l6.4901"></a><span id="l6.4901" class="difflineplus">+          // Select quote</span>
<a href="#l6.4902"></a><span id="l6.4902" class="difflineplus">+</span>
<a href="#l6.4903"></a><span id="l6.4903" class="difflineplus">+          if (head) {</span>
<a href="#l6.4904"></a><span id="l6.4904" class="difflineplus">+            for (let cPos = 0; cPos &lt; head.length; cPos++) {</span>
<a href="#l6.4905"></a><span id="l6.4905" class="difflineplus">+              selection.characterMove(true, false);</span>
<a href="#l6.4906"></a><span id="l6.4906" class="difflineplus">+            }</span>
<a href="#l6.4907"></a><span id="l6.4907" class="difflineplus">+          }</span>
<a href="#l6.4908"></a><span id="l6.4908" class="difflineplus">+          selection.completeMove(true, true);</span>
<a href="#l6.4909"></a><span id="l6.4909" class="difflineplus">+          if (tail) {</span>
<a href="#l6.4910"></a><span id="l6.4910" class="difflineplus">+            for (let cPos = 0; cPos &lt; tail.length; cPos++) {</span>
<a href="#l6.4911"></a><span id="l6.4911" class="difflineplus">+              selection.characterMove(false, true); // move backwards</span>
<a href="#l6.4912"></a><span id="l6.4912" class="difflineplus">+            }</span>
<a href="#l6.4913"></a><span id="l6.4913" class="difflineplus">+          }</span>
<a href="#l6.4914"></a><span id="l6.4914" class="difflineplus">+          break;</span>
<a href="#l6.4915"></a><span id="l6.4915" class="difflineplus">+</span>
<a href="#l6.4916"></a><span id="l6.4916" class="difflineplus">+        default:</span>
<a href="#l6.4917"></a><span id="l6.4917" class="difflineplus">+          // Position at beginning of document</span>
<a href="#l6.4918"></a><span id="l6.4918" class="difflineplus">+</span>
<a href="#l6.4919"></a><span id="l6.4919" class="difflineplus">+          if (this.editor) {</span>
<a href="#l6.4920"></a><span id="l6.4920" class="difflineplus">+            this.editor.beginningOfDocument();</span>
<a href="#l6.4921"></a><span id="l6.4921" class="difflineplus">+          }</span>
<a href="#l6.4922"></a><span id="l6.4922" class="difflineplus">+      }</span>
<a href="#l6.4923"></a><span id="l6.4923" class="difflineplus">+</span>
<a href="#l6.4924"></a><span id="l6.4924" class="difflineplus">+      this.editor.selectionController.scrollSelectionIntoView(nsISelectionController.SELECTION_NORMAL,</span>
<a href="#l6.4925"></a><span id="l6.4925" class="difflineplus">+        nsISelectionController.SELECTION_ANCHOR_REGION,</span>
<a href="#l6.4926"></a><span id="l6.4926" class="difflineplus">+        true);</span>
<a href="#l6.4927"></a><span id="l6.4927" class="difflineplus">+    }</span>
<a href="#l6.4928"></a><span id="l6.4928" class="difflineplus">+</span>
<a href="#l6.4929"></a><span id="l6.4929" class="difflineplus">+    this.processFinalState();</span>
<a href="#l6.4930"></a><span id="l6.4930" class="difflineplus">+    this.updateStatusBar();</span>
<a href="#l6.4931"></a><span id="l6.4931" class="difflineplus">+  },</span>
<a href="#l6.4932"></a><span id="l6.4932" class="difflineplus">+</span>
<a href="#l6.4933"></a><span id="l6.4933" class="difflineplus">+  checkInlinePgpReply: function(head, tail) {</span>
<a href="#l6.4934"></a><span id="l6.4934" class="difflineplus">+    const CT = Components.interfaces.nsIMsgCompType;</span>
<a href="#l6.4935"></a><span id="l6.4935" class="difflineplus">+    if (!this.identity) return;</span>
<a href="#l6.4936"></a><span id="l6.4936" class="difflineplus">+</span>
<a href="#l6.4937"></a><span id="l6.4937" class="difflineplus">+    let hLines = (head.search(/[^\s&gt;]/) &lt; 0 ? 0 : 1);</span>
<a href="#l6.4938"></a><span id="l6.4938" class="difflineplus">+</span>
<a href="#l6.4939"></a><span id="l6.4939" class="difflineplus">+    if (hLines &gt; 0) {</span>
<a href="#l6.4940"></a><span id="l6.4940" class="difflineplus">+      switch (gMsgCompose.type) {</span>
<a href="#l6.4941"></a><span id="l6.4941" class="difflineplus">+        case CT.Reply:</span>
<a href="#l6.4942"></a><span id="l6.4942" class="difflineplus">+        case CT.ReplyAll:</span>
<a href="#l6.4943"></a><span id="l6.4943" class="difflineplus">+        case CT.ReplyToSender:</span>
<a href="#l6.4944"></a><span id="l6.4944" class="difflineplus">+        case CT.ReplyToGroup:</span>
<a href="#l6.4945"></a><span id="l6.4945" class="difflineplus">+        case CT.ReplyToSenderAndGroup:</span>
<a href="#l6.4946"></a><span id="l6.4946" class="difflineplus">+        case CT.ReplyToList: {</span>
<a href="#l6.4947"></a><span id="l6.4947" class="difflineplus">+          // if head contains at only a few line of text, we assume it's the</span>
<a href="#l6.4948"></a><span id="l6.4948" class="difflineplus">+          // header above the quote (e.g. XYZ wrote:) and the user's signature</span>
<a href="#l6.4949"></a><span id="l6.4949" class="difflineplus">+</span>
<a href="#l6.4950"></a><span id="l6.4950" class="difflineplus">+          let h = head.split(/\r?\n/);</span>
<a href="#l6.4951"></a><span id="l6.4951" class="difflineplus">+          hLines = -1;</span>
<a href="#l6.4952"></a><span id="l6.4952" class="difflineplus">+</span>
<a href="#l6.4953"></a><span id="l6.4953" class="difflineplus">+          for (let i = 0; i &lt; h.length; i++) {</span>
<a href="#l6.4954"></a><span id="l6.4954" class="difflineplus">+            if (h[i].search(/[^\s&gt;]/) &gt;= 0) hLines++;</span>
<a href="#l6.4955"></a><span id="l6.4955" class="difflineplus">+          }</span>
<a href="#l6.4956"></a><span id="l6.4956" class="difflineplus">+        }</span>
<a href="#l6.4957"></a><span id="l6.4957" class="difflineplus">+      }</span>
<a href="#l6.4958"></a><span id="l6.4958" class="difflineplus">+    }</span>
<a href="#l6.4959"></a><span id="l6.4959" class="difflineplus">+</span>
<a href="#l6.4960"></a><span id="l6.4960" class="difflineplus">+    if (hLines &gt; 0 &amp;&amp; (!this.identity.sigOnReply || this.identity.sigBottom)) {</span>
<a href="#l6.4961"></a><span id="l6.4961" class="difflineplus">+      // display warning if no signature on top of message</span>
<a href="#l6.4962"></a><span id="l6.4962" class="difflineplus">+      this.displayPartialEncryptedWarning();</span>
<a href="#l6.4963"></a><span id="l6.4963" class="difflineplus">+    }</span>
<a href="#l6.4964"></a><span id="l6.4964" class="difflineplus">+    else if (hLines &gt; 10) {</span>
<a href="#l6.4965"></a><span id="l6.4965" class="difflineplus">+      this.displayPartialEncryptedWarning();</span>
<a href="#l6.4966"></a><span id="l6.4966" class="difflineplus">+    }</span>
<a href="#l6.4967"></a><span id="l6.4967" class="difflineplus">+    else if (tail.search(/[^\s&gt;]/) &gt;= 0 &amp;&amp; !(this.identity.sigOnReply &amp;&amp; this.identity.sigBottom)) {</span>
<a href="#l6.4968"></a><span id="l6.4968" class="difflineplus">+      // display warning if no signature below message</span>
<a href="#l6.4969"></a><span id="l6.4969" class="difflineplus">+      this.displayPartialEncryptedWarning();</span>
<a href="#l6.4970"></a><span id="l6.4970" class="difflineplus">+    }</span>
<a href="#l6.4971"></a><span id="l6.4971" class="difflineplus">+  },</span>
<a href="#l6.4972"></a><span id="l6.4972" class="difflineplus">+</span>
<a href="#l6.4973"></a><span id="l6.4973" class="difflineplus">+  editorInsertText: function(plainText) {</span>
<a href="#l6.4974"></a><span id="l6.4974" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorInsertText\n&quot;);</span>
<a href="#l6.4975"></a><span id="l6.4975" class="difflineplus">+    if (this.editor) {</span>
<a href="#l6.4976"></a><span id="l6.4976" class="difflineplus">+      var mailEditor;</span>
<a href="#l6.4977"></a><span id="l6.4977" class="difflineplus">+      try {</span>
<a href="#l6.4978"></a><span id="l6.4978" class="difflineplus">+        mailEditor = this.editor.QueryInterface(Components.interfaces.nsIEditorMailSupport);</span>
<a href="#l6.4979"></a><span id="l6.4979" class="difflineplus">+        mailEditor.insertTextWithQuotations(plainText);</span>
<a href="#l6.4980"></a><span id="l6.4980" class="difflineplus">+      }</span>
<a href="#l6.4981"></a><span id="l6.4981" class="difflineplus">+      catch (ex) {</span>
<a href="#l6.4982"></a><span id="l6.4982" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorInsertText: no mail editor\n&quot;);</span>
<a href="#l6.4983"></a><span id="l6.4983" class="difflineplus">+        this.editor.insertText(plainText);</span>
<a href="#l6.4984"></a><span id="l6.4984" class="difflineplus">+      }</span>
<a href="#l6.4985"></a><span id="l6.4985" class="difflineplus">+    }</span>
<a href="#l6.4986"></a><span id="l6.4986" class="difflineplus">+  },</span>
<a href="#l6.4987"></a><span id="l6.4987" class="difflineplus">+</span>
<a href="#l6.4988"></a><span id="l6.4988" class="difflineplus">+  editorInsertAsQuotation: function(plainText) {</span>
<a href="#l6.4989"></a><span id="l6.4989" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorInsertAsQuotation\n&quot;);</span>
<a href="#l6.4990"></a><span id="l6.4990" class="difflineplus">+    if (this.editor) {</span>
<a href="#l6.4991"></a><span id="l6.4991" class="difflineplus">+      var mailEditor;</span>
<a href="#l6.4992"></a><span id="l6.4992" class="difflineplus">+      try {</span>
<a href="#l6.4993"></a><span id="l6.4993" class="difflineplus">+        mailEditor = this.editor.QueryInterface(Components.interfaces.nsIEditorMailSupport);</span>
<a href="#l6.4994"></a><span id="l6.4994" class="difflineplus">+      }</span>
<a href="#l6.4995"></a><span id="l6.4995" class="difflineplus">+      catch (ex) {}</span>
<a href="#l6.4996"></a><span id="l6.4996" class="difflineplus">+</span>
<a href="#l6.4997"></a><span id="l6.4997" class="difflineplus">+      if (!mailEditor)</span>
<a href="#l6.4998"></a><span id="l6.4998" class="difflineplus">+        return 0;</span>
<a href="#l6.4999"></a><span id="l6.4999" class="difflineplus">+</span>
<a href="#l6.5000"></a><span id="l6.5000" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorInsertAsQuotation: mailEditor=&quot; + mailEditor + &quot;\n&quot;);</span>
<a href="#l6.5001"></a><span id="l6.5001" class="difflineplus">+</span>
<a href="#l6.5002"></a><span id="l6.5002" class="difflineplus">+      mailEditor.insertAsCitedQuotation(plainText, &quot;&quot;, false);</span>
<a href="#l6.5003"></a><span id="l6.5003" class="difflineplus">+</span>
<a href="#l6.5004"></a><span id="l6.5004" class="difflineplus">+      return 1;</span>
<a href="#l6.5005"></a><span id="l6.5005" class="difflineplus">+    }</span>
<a href="#l6.5006"></a><span id="l6.5006" class="difflineplus">+    return 0;</span>
<a href="#l6.5007"></a><span id="l6.5007" class="difflineplus">+  },</span>
<a href="#l6.5008"></a><span id="l6.5008" class="difflineplus">+</span>
<a href="#l6.5009"></a><span id="l6.5009" class="difflineplus">+  /**</span>
<a href="#l6.5010"></a><span id="l6.5010" class="difflineplus">+   * Display a notification to the user at the bottom of the window</span>
<a href="#l6.5011"></a><span id="l6.5011" class="difflineplus">+   *</span>
<a href="#l6.5012"></a><span id="l6.5012" class="difflineplus">+   * @param priority: Number    - Priority of the message [1 = high (error) ... 3 = low (info)]</span>
<a href="#l6.5013"></a><span id="l6.5013" class="difflineplus">+   * @param msgText: String     - Text to be displayed in notification bar</span>
<a href="#l6.5014"></a><span id="l6.5014" class="difflineplus">+   * @param messageId: String   - Unique message type identification</span>
<a href="#l6.5015"></a><span id="l6.5015" class="difflineplus">+   * @param detailsText: String - optional text to be displayed by clicking on &quot;Details&quot; button.</span>
<a href="#l6.5016"></a><span id="l6.5016" class="difflineplus">+   *                              if null or &quot;&quot;, then the Detail button will no be displayed.</span>
<a href="#l6.5017"></a><span id="l6.5017" class="difflineplus">+   */</span>
<a href="#l6.5018"></a><span id="l6.5018" class="difflineplus">+  notifyUser: function(priority, msgText, messageId, detailsText) {</span>
<a href="#l6.5019"></a><span id="l6.5019" class="difflineplus">+    let notif = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l6.5020"></a><span id="l6.5020" class="difflineplus">+    if (!notif) {</span>
<a href="#l6.5021"></a><span id="l6.5021" class="difflineplus">+      notif = gNotification.notificationbox;</span>
<a href="#l6.5022"></a><span id="l6.5022" class="difflineplus">+    }</span>
<a href="#l6.5023"></a><span id="l6.5023" class="difflineplus">+    let prio;</span>
<a href="#l6.5024"></a><span id="l6.5024" class="difflineplus">+</span>
<a href="#l6.5025"></a><span id="l6.5025" class="difflineplus">+    switch (priority) {</span>
<a href="#l6.5026"></a><span id="l6.5026" class="difflineplus">+      case 1:</span>
<a href="#l6.5027"></a><span id="l6.5027" class="difflineplus">+        prio = notif.PRIORITY_CRITICAL_MEDIUM;</span>
<a href="#l6.5028"></a><span id="l6.5028" class="difflineplus">+        break;</span>
<a href="#l6.5029"></a><span id="l6.5029" class="difflineplus">+      case 3:</span>
<a href="#l6.5030"></a><span id="l6.5030" class="difflineplus">+        prio = notif.PRIORITY_INFO_MEDIUM;</span>
<a href="#l6.5031"></a><span id="l6.5031" class="difflineplus">+        break;</span>
<a href="#l6.5032"></a><span id="l6.5032" class="difflineplus">+      default:</span>
<a href="#l6.5033"></a><span id="l6.5033" class="difflineplus">+        prio = notif.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l6.5034"></a><span id="l6.5034" class="difflineplus">+    }</span>
<a href="#l6.5035"></a><span id="l6.5035" class="difflineplus">+</span>
<a href="#l6.5036"></a><span id="l6.5036" class="difflineplus">+    let buttonArr = [];</span>
<a href="#l6.5037"></a><span id="l6.5037" class="difflineplus">+</span>
<a href="#l6.5038"></a><span id="l6.5038" class="difflineplus">+    if (detailsText &amp;&amp; detailsText.length &gt; 0) {</span>
<a href="#l6.5039"></a><span id="l6.5039" class="difflineplus">+      buttonArr.push({</span>
<a href="#l6.5040"></a><span id="l6.5040" class="difflineplus">+        accessKey: EnigmailLocale.getString(&quot;msgCompose.detailsButton.accessKey&quot;),</span>
<a href="#l6.5041"></a><span id="l6.5041" class="difflineplus">+        label: EnigmailLocale.getString(&quot;msgCompose.detailsButton.label&quot;),</span>
<a href="#l6.5042"></a><span id="l6.5042" class="difflineplus">+        callback: function(aNotificationBar, aButton) {</span>
<a href="#l6.5043"></a><span id="l6.5043" class="difflineplus">+          EnigmailDialog.info(window, detailsText);</span>
<a href="#l6.5044"></a><span id="l6.5044" class="difflineplus">+        }</span>
<a href="#l6.5045"></a><span id="l6.5045" class="difflineplus">+      });</span>
<a href="#l6.5046"></a><span id="l6.5046" class="difflineplus">+    }</span>
<a href="#l6.5047"></a><span id="l6.5047" class="difflineplus">+    notif.appendNotification(msgText, messageId, null, prio, buttonArr);</span>
<a href="#l6.5048"></a><span id="l6.5048" class="difflineplus">+  },</span>
<a href="#l6.5049"></a><span id="l6.5049" class="difflineplus">+</span>
<a href="#l6.5050"></a><span id="l6.5050" class="difflineplus">+  /**</span>
<a href="#l6.5051"></a><span id="l6.5051" class="difflineplus">+   * Display a warning message if we are replying to or forwarding</span>
<a href="#l6.5052"></a><span id="l6.5052" class="difflineplus">+   * a partially decrypted inline-PGP email</span>
<a href="#l6.5053"></a><span id="l6.5053" class="difflineplus">+   */</span>
<a href="#l6.5054"></a><span id="l6.5054" class="difflineplus">+  displayPartialEncryptedWarning: function() {</span>
<a href="#l6.5055"></a><span id="l6.5055" class="difflineplus">+    let msgLong = EnigmailLocale.getString(&quot;msgCompose.partiallyEncrypted.inlinePGP&quot;);</span>
<a href="#l6.5056"></a><span id="l6.5056" class="difflineplus">+</span>
<a href="#l6.5057"></a><span id="l6.5057" class="difflineplus">+    this.notifyUser(1, EnigmailLocale.getString(&quot;msgCompose.partiallyEncrypted.short&quot;), &quot;notifyPartialDecrypt&quot;, msgLong);</span>
<a href="#l6.5058"></a><span id="l6.5058" class="difflineplus">+  },</span>
<a href="#l6.5059"></a><span id="l6.5059" class="difflineplus">+</span>
<a href="#l6.5060"></a><span id="l6.5060" class="difflineplus">+  editorSelectAll: function() {</span>
<a href="#l6.5061"></a><span id="l6.5061" class="difflineplus">+    if (this.editor) {</span>
<a href="#l6.5062"></a><span id="l6.5062" class="difflineplus">+      this.editor.selectAll();</span>
<a href="#l6.5063"></a><span id="l6.5063" class="difflineplus">+    }</span>
<a href="#l6.5064"></a><span id="l6.5064" class="difflineplus">+  },</span>
<a href="#l6.5065"></a><span id="l6.5065" class="difflineplus">+</span>
<a href="#l6.5066"></a><span id="l6.5066" class="difflineplus">+  editorGetCharset: function() {</span>
<a href="#l6.5067"></a><span id="l6.5067" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorGetCharset\n&quot;);</span>
<a href="#l6.5068"></a><span id="l6.5068" class="difflineplus">+    return this.editor.documentCharacterSet;</span>
<a href="#l6.5069"></a><span id="l6.5069" class="difflineplus">+  },</span>
<a href="#l6.5070"></a><span id="l6.5070" class="difflineplus">+</span>
<a href="#l6.5071"></a><span id="l6.5071" class="difflineplus">+  editorGetContentAs: function(mimeType, flags) {</span>
<a href="#l6.5072"></a><span id="l6.5072" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.editorGetContentAs\n&quot;);</span>
<a href="#l6.5073"></a><span id="l6.5073" class="difflineplus">+    if (this.editor) {</span>
<a href="#l6.5074"></a><span id="l6.5074" class="difflineplus">+      return this.editor.outputToString(mimeType, flags);</span>
<a href="#l6.5075"></a><span id="l6.5075" class="difflineplus">+    }</span>
<a href="#l6.5076"></a><span id="l6.5076" class="difflineplus">+</span>
<a href="#l6.5077"></a><span id="l6.5077" class="difflineplus">+    return null;</span>
<a href="#l6.5078"></a><span id="l6.5078" class="difflineplus">+  },</span>
<a href="#l6.5079"></a><span id="l6.5079" class="difflineplus">+</span>
<a href="#l6.5080"></a><span id="l6.5080" class="difflineplus">+  addrOnChangeTimer: null,</span>
<a href="#l6.5081"></a><span id="l6.5081" class="difflineplus">+</span>
<a href="#l6.5082"></a><span id="l6.5082" class="difflineplus">+  addressOnChange: function() {</span>
<a href="#l6.5083"></a><span id="l6.5083" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.addressOnChange\n&quot;);</span>
<a href="#l6.5084"></a><span id="l6.5084" class="difflineplus">+    if (!this.addrOnChangeTimer) {</span>
<a href="#l6.5085"></a><span id="l6.5085" class="difflineplus">+      var self = this;</span>
<a href="#l6.5086"></a><span id="l6.5086" class="difflineplus">+      this.addrOnChangeTimer = EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.5087"></a><span id="l6.5087" class="difflineplus">+        self.fireSendFlags();</span>
<a href="#l6.5088"></a><span id="l6.5088" class="difflineplus">+        self.addrOnChangeTimer = null;</span>
<a href="#l6.5089"></a><span id="l6.5089" class="difflineplus">+      }, Enigmail.msg.addrOnChangeTimeout);</span>
<a href="#l6.5090"></a><span id="l6.5090" class="difflineplus">+    }</span>
<a href="#l6.5091"></a><span id="l6.5091" class="difflineplus">+  },</span>
<a href="#l6.5092"></a><span id="l6.5092" class="difflineplus">+</span>
<a href="#l6.5093"></a><span id="l6.5093" class="difflineplus">+  focusChange: function() {</span>
<a href="#l6.5094"></a><span id="l6.5094" class="difflineplus">+    // call original TB function</span>
<a href="#l6.5095"></a><span id="l6.5095" class="difflineplus">+    CommandUpdate_MsgCompose();</span>
<a href="#l6.5096"></a><span id="l6.5096" class="difflineplus">+</span>
<a href="#l6.5097"></a><span id="l6.5097" class="difflineplus">+    var focusedWindow = top.document.commandDispatcher.focusedWindow;</span>
<a href="#l6.5098"></a><span id="l6.5098" class="difflineplus">+</span>
<a href="#l6.5099"></a><span id="l6.5099" class="difflineplus">+    // we're just setting focus to where it was before</span>
<a href="#l6.5100"></a><span id="l6.5100" class="difflineplus">+    if (focusedWindow == Enigmail.msg.lastFocusedWindow) {</span>
<a href="#l6.5101"></a><span id="l6.5101" class="difflineplus">+      // skip</span>
<a href="#l6.5102"></a><span id="l6.5102" class="difflineplus">+      return;</span>
<a href="#l6.5103"></a><span id="l6.5103" class="difflineplus">+    }</span>
<a href="#l6.5104"></a><span id="l6.5104" class="difflineplus">+</span>
<a href="#l6.5105"></a><span id="l6.5105" class="difflineplus">+    Enigmail.msg.lastFocusedWindow = focusedWindow;</span>
<a href="#l6.5106"></a><span id="l6.5106" class="difflineplus">+</span>
<a href="#l6.5107"></a><span id="l6.5107" class="difflineplus">+    Enigmail.msg.fireSendFlags();</span>
<a href="#l6.5108"></a><span id="l6.5108" class="difflineplus">+  },</span>
<a href="#l6.5109"></a><span id="l6.5109" class="difflineplus">+</span>
<a href="#l6.5110"></a><span id="l6.5110" class="difflineplus">+  fireSendFlags: function() {</span>
<a href="#l6.5111"></a><span id="l6.5111" class="difflineplus">+    try {</span>
<a href="#l6.5112"></a><span id="l6.5112" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fireSendFlags\n&quot;);</span>
<a href="#l6.5113"></a><span id="l6.5113" class="difflineplus">+      if (!this.determineSendFlagId) {</span>
<a href="#l6.5114"></a><span id="l6.5114" class="difflineplus">+        let self = this;</span>
<a href="#l6.5115"></a><span id="l6.5115" class="difflineplus">+        this.determineSendFlagId = EnigmailTimer.setTimeout(</span>
<a href="#l6.5116"></a><span id="l6.5116" class="difflineplus">+          function _sendFlagWrapper() {</span>
<a href="#l6.5117"></a><span id="l6.5117" class="difflineplus">+            try {</span>
<a href="#l6.5118"></a><span id="l6.5118" class="difflineplus">+              self.determineSendFlags();</span>
<a href="#l6.5119"></a><span id="l6.5119" class="difflineplus">+              self.fireSearchKeys();</span>
<a href="#l6.5120"></a><span id="l6.5120" class="difflineplus">+            }</span>
<a href="#l6.5121"></a><span id="l6.5121" class="difflineplus">+            catch (x) {}</span>
<a href="#l6.5122"></a><span id="l6.5122" class="difflineplus">+            self.determineSendFlagId = null;</span>
<a href="#l6.5123"></a><span id="l6.5123" class="difflineplus">+          },</span>
<a href="#l6.5124"></a><span id="l6.5124" class="difflineplus">+          0);</span>
<a href="#l6.5125"></a><span id="l6.5125" class="difflineplus">+      }</span>
<a href="#l6.5126"></a><span id="l6.5126" class="difflineplus">+    }</span>
<a href="#l6.5127"></a><span id="l6.5127" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.5128"></a><span id="l6.5128" class="difflineplus">+  },</span>
<a href="#l6.5129"></a><span id="l6.5129" class="difflineplus">+</span>
<a href="#l6.5130"></a><span id="l6.5130" class="difflineplus">+  /**</span>
<a href="#l6.5131"></a><span id="l6.5131" class="difflineplus">+   * Merge multiple  Re: Re: into one Re: in message subject</span>
<a href="#l6.5132"></a><span id="l6.5132" class="difflineplus">+   */</span>
<a href="#l6.5133"></a><span id="l6.5133" class="difflineplus">+  fixMessageSubject: function() {</span>
<a href="#l6.5134"></a><span id="l6.5134" class="difflineplus">+    let subjElem = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l6.5135"></a><span id="l6.5135" class="difflineplus">+    if (subjElem) {</span>
<a href="#l6.5136"></a><span id="l6.5136" class="difflineplus">+      let r = subjElem.value.replace(/^(Re: )+/, &quot;Re: &quot;);</span>
<a href="#l6.5137"></a><span id="l6.5137" class="difflineplus">+      if (r !== subjElem.value) {</span>
<a href="#l6.5138"></a><span id="l6.5138" class="difflineplus">+        subjElem.value = r;</span>
<a href="#l6.5139"></a><span id="l6.5139" class="difflineplus">+        if (typeof subjElem.oninput === &quot;function&quot;) subjElem.oninput();</span>
<a href="#l6.5140"></a><span id="l6.5140" class="difflineplus">+      }</span>
<a href="#l6.5141"></a><span id="l6.5141" class="difflineplus">+    }</span>
<a href="#l6.5142"></a><span id="l6.5142" class="difflineplus">+  },</span>
<a href="#l6.5143"></a><span id="l6.5143" class="difflineplus">+</span>
<a href="#l6.5144"></a><span id="l6.5144" class="difflineplus">+  fireSearchKeys: function() {</span>
<a href="#l6.5145"></a><span id="l6.5145" class="difflineplus">+    if (this.isEnigmailEnabled()) {</span>
<a href="#l6.5146"></a><span id="l6.5146" class="difflineplus">+</span>
<a href="#l6.5147"></a><span id="l6.5147" class="difflineplus">+      if (this.searchKeysTimeout) return;</span>
<a href="#l6.5148"></a><span id="l6.5148" class="difflineplus">+</span>
<a href="#l6.5149"></a><span id="l6.5149" class="difflineplus">+      let self = this;</span>
<a href="#l6.5150"></a><span id="l6.5150" class="difflineplus">+</span>
<a href="#l6.5151"></a><span id="l6.5151" class="difflineplus">+      this.searchKeysTimeout = EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l6.5152"></a><span id="l6.5152" class="difflineplus">+          self.searchKeysTimeout = null;</span>
<a href="#l6.5153"></a><span id="l6.5153" class="difflineplus">+          Enigmail.msg.findMissingKeys();</span>
<a href="#l6.5154"></a><span id="l6.5154" class="difflineplus">+        },</span>
<a href="#l6.5155"></a><span id="l6.5155" class="difflineplus">+        5000); // 5 Seconds</span>
<a href="#l6.5156"></a><span id="l6.5156" class="difflineplus">+    }</span>
<a href="#l6.5157"></a><span id="l6.5157" class="difflineplus">+  },</span>
<a href="#l6.5158"></a><span id="l6.5158" class="difflineplus">+</span>
<a href="#l6.5159"></a><span id="l6.5159" class="difflineplus">+  /**</span>
<a href="#l6.5160"></a><span id="l6.5160" class="difflineplus">+   * Determine if all addressees have a valid key ID; if not, attempt to</span>
<a href="#l6.5161"></a><span id="l6.5161" class="difflineplus">+   * import them via WKD or Autocrypt.</span>
<a href="#l6.5162"></a><span id="l6.5162" class="difflineplus">+   */</span>
<a href="#l6.5163"></a><span id="l6.5163" class="difflineplus">+  findMissingKeys: async function() {</span>
<a href="#l6.5164"></a><span id="l6.5164" class="difflineplus">+</span>
<a href="#l6.5165"></a><span id="l6.5165" class="difflineplus">+    try {</span>
<a href="#l6.5166"></a><span id="l6.5166" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys()\n&quot;);</span>
<a href="#l6.5167"></a><span id="l6.5167" class="difflineplus">+</span>
<a href="#l6.5168"></a><span id="l6.5168" class="difflineplus">+      let missingKeys = this.determineSendFlags();</span>
<a href="#l6.5169"></a><span id="l6.5169" class="difflineplus">+</span>
<a href="#l6.5170"></a><span id="l6.5170" class="difflineplus">+      if (&quot;errArray&quot; in missingKeys &amp;&amp; missingKeys.errArray.length &gt; 0) {</span>
<a href="#l6.5171"></a><span id="l6.5171" class="difflineplus">+        let missingEmails = missingKeys.errArray.map(function(i) {</span>
<a href="#l6.5172"></a><span id="l6.5172" class="difflineplus">+          return i.addr.toLowerCase().trim();</span>
<a href="#l6.5173"></a><span id="l6.5173" class="difflineplus">+        });</span>
<a href="#l6.5174"></a><span id="l6.5174" class="difflineplus">+</span>
<a href="#l6.5175"></a><span id="l6.5175" class="difflineplus">+        let lookupList = [];</span>
<a href="#l6.5176"></a><span id="l6.5176" class="difflineplus">+</span>
<a href="#l6.5177"></a><span id="l6.5177" class="difflineplus">+        // only search for keys not checked before</span>
<a href="#l6.5178"></a><span id="l6.5178" class="difflineplus">+        for (let k of missingEmails) {</span>
<a href="#l6.5179"></a><span id="l6.5179" class="difflineplus">+          if (this.keyLookupDone.indexOf(k) &lt; 0) {</span>
<a href="#l6.5180"></a><span id="l6.5180" class="difflineplus">+            lookupList.push(k);</span>
<a href="#l6.5181"></a><span id="l6.5181" class="difflineplus">+            this.keyLookupDone.push(k);</span>
<a href="#l6.5182"></a><span id="l6.5182" class="difflineplus">+          }</span>
<a href="#l6.5183"></a><span id="l6.5183" class="difflineplus">+        }</span>
<a href="#l6.5184"></a><span id="l6.5184" class="difflineplus">+</span>
<a href="#l6.5185"></a><span id="l6.5185" class="difflineplus">+        if (lookupList.length &gt; 0) {</span>
<a href="#l6.5186"></a><span id="l6.5186" class="difflineplus">+          try {</span>
<a href="#l6.5187"></a><span id="l6.5187" class="difflineplus">+            let foundKeys;</span>
<a href="#l6.5188"></a><span id="l6.5188" class="difflineplus">+</span>
<a href="#l6.5189"></a><span id="l6.5189" class="difflineplus">+            if (this.isAutocryptEnabled()) {</span>
<a href="#l6.5190"></a><span id="l6.5190" class="difflineplus">+              foundKeys = await EnigmailAutocrypt.importAutocryptKeys(lookupList, this.encryptForced === EnigmailConstants.ENIG_ALWAYS);</span>
<a href="#l6.5191"></a><span id="l6.5191" class="difflineplus">+              EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: got &quot; + foundKeys.length + &quot; autocrypt keys\n&quot;);</span>
<a href="#l6.5192"></a><span id="l6.5192" class="difflineplus">+              if (foundKeys.length &gt; 0) {</span>
<a href="#l6.5193"></a><span id="l6.5193" class="difflineplus">+                this.determineSendFlags();</span>
<a href="#l6.5194"></a><span id="l6.5194" class="difflineplus">+              }</span>
<a href="#l6.5195"></a><span id="l6.5195" class="difflineplus">+            }</span>
<a href="#l6.5196"></a><span id="l6.5196" class="difflineplus">+</span>
<a href="#l6.5197"></a><span id="l6.5197" class="difflineplus">+            if (EnigmailPrefs.getPref(&quot;autoWkdLookup&quot;) === 0) return;</span>
<a href="#l6.5198"></a><span id="l6.5198" class="difflineplus">+            if (foundKeys.length &gt;= lookupList.length) return;</span>
<a href="#l6.5199"></a><span id="l6.5199" class="difflineplus">+</span>
<a href="#l6.5200"></a><span id="l6.5200" class="difflineplus">+            foundKeys = await EnigmailWkdLookup.findKeys(lookupList);</span>
<a href="#l6.5201"></a><span id="l6.5201" class="difflineplus">+            EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: wkd got &quot; + foundKeys + &quot;\n&quot;);</span>
<a href="#l6.5202"></a><span id="l6.5202" class="difflineplus">+            if (foundKeys) {</span>
<a href="#l6.5203"></a><span id="l6.5203" class="difflineplus">+              this.determineSendFlags();</span>
<a href="#l6.5204"></a><span id="l6.5204" class="difflineplus">+            }</span>
<a href="#l6.5205"></a><span id="l6.5205" class="difflineplus">+          }</span>
<a href="#l6.5206"></a><span id="l6.5206" class="difflineplus">+          catch (err) {</span>
<a href="#l6.5207"></a><span id="l6.5207" class="difflineplus">+            EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: error &quot; + err + &quot;\n&quot;);</span>
<a href="#l6.5208"></a><span id="l6.5208" class="difflineplus">+          }</span>
<a href="#l6.5209"></a><span id="l6.5209" class="difflineplus">+        }</span>
<a href="#l6.5210"></a><span id="l6.5210" class="difflineplus">+      }</span>
<a href="#l6.5211"></a><span id="l6.5211" class="difflineplus">+    }</span>
<a href="#l6.5212"></a><span id="l6.5212" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.5213"></a><span id="l6.5213" class="difflineplus">+  }</span>
<a href="#l6.5214"></a><span id="l6.5214" class="difflineplus">+};</span>
<a href="#l6.5215"></a><span id="l6.5215" class="difflineplus">+</span>
<a href="#l6.5216"></a><span id="l6.5216" class="difflineplus">+</span>
<a href="#l6.5217"></a><span id="l6.5217" class="difflineplus">+Enigmail.composeStateListener = {</span>
<a href="#l6.5218"></a><span id="l6.5218" class="difflineplus">+  NotifyComposeFieldsReady: function() {</span>
<a href="#l6.5219"></a><span id="l6.5219" class="difflineplus">+    // Note: NotifyComposeFieldsReady is only called when a new window is created (i.e. not in case a window object is reused).</span>
<a href="#l6.5220"></a><span id="l6.5220" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.NotifyComposeFieldsReady\n&quot;);</span>
<a href="#l6.5221"></a><span id="l6.5221" class="difflineplus">+</span>
<a href="#l6.5222"></a><span id="l6.5222" class="difflineplus">+    try {</span>
<a href="#l6.5223"></a><span id="l6.5223" class="difflineplus">+      Enigmail.msg.editor = gMsgCompose.editor.QueryInterface(Components.interfaces.nsIEditor);</span>
<a href="#l6.5224"></a><span id="l6.5224" class="difflineplus">+    }</span>
<a href="#l6.5225"></a><span id="l6.5225" class="difflineplus">+    catch (ex) {}</span>
<a href="#l6.5226"></a><span id="l6.5226" class="difflineplus">+</span>
<a href="#l6.5227"></a><span id="l6.5227" class="difflineplus">+    if (!Enigmail.msg.editor)</span>
<a href="#l6.5228"></a><span id="l6.5228" class="difflineplus">+      return;</span>
<a href="#l6.5229"></a><span id="l6.5229" class="difflineplus">+</span>
<a href="#l6.5230"></a><span id="l6.5230" class="difflineplus">+    Enigmail.msg.fixMessageSubject();</span>
<a href="#l6.5231"></a><span id="l6.5231" class="difflineplus">+</span>
<a href="#l6.5232"></a><span id="l6.5232" class="difflineplus">+    function enigDocStateListener() {}</span>
<a href="#l6.5233"></a><span id="l6.5233" class="difflineplus">+</span>
<a href="#l6.5234"></a><span id="l6.5234" class="difflineplus">+    enigDocStateListener.prototype = {</span>
<a href="#l6.5235"></a><span id="l6.5235" class="difflineplus">+      QueryInterface: function(iid) {</span>
<a href="#l6.5236"></a><span id="l6.5236" class="difflineplus">+        if (!iid.equals(Components.interfaces.nsIDocumentStateListener) &amp;&amp;</span>
<a href="#l6.5237"></a><span id="l6.5237" class="difflineplus">+          !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l6.5238"></a><span id="l6.5238" class="difflineplus">+          throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l6.5239"></a><span id="l6.5239" class="difflineplus">+</span>
<a href="#l6.5240"></a><span id="l6.5240" class="difflineplus">+        return this;</span>
<a href="#l6.5241"></a><span id="l6.5241" class="difflineplus">+      },</span>
<a href="#l6.5242"></a><span id="l6.5242" class="difflineplus">+</span>
<a href="#l6.5243"></a><span id="l6.5243" class="difflineplus">+      NotifyDocumentCreated: function() {</span>
<a href="#l6.5244"></a><span id="l6.5244" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: EDSL.NotifyDocumentCreated\n&quot;);</span>
<a href="#l6.5245"></a><span id="l6.5245" class="difflineplus">+      },</span>
<a href="#l6.5246"></a><span id="l6.5246" class="difflineplus">+</span>
<a href="#l6.5247"></a><span id="l6.5247" class="difflineplus">+      NotifyDocumentWillBeDestroyed: function() {</span>
<a href="#l6.5248"></a><span id="l6.5248" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: EDSL.enigDocStateListener.NotifyDocumentWillBeDestroyed\n&quot;);</span>
<a href="#l6.5249"></a><span id="l6.5249" class="difflineplus">+      },</span>
<a href="#l6.5250"></a><span id="l6.5250" class="difflineplus">+</span>
<a href="#l6.5251"></a><span id="l6.5251" class="difflineplus">+      NotifyDocumentStateChanged: function(nowDirty) {</span>
<a href="#l6.5252"></a><span id="l6.5252" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: EDSL.enigDocStateListener.NotifyDocumentStateChanged\n&quot;);</span>
<a href="#l6.5253"></a><span id="l6.5253" class="difflineplus">+      }</span>
<a href="#l6.5254"></a><span id="l6.5254" class="difflineplus">+    };</span>
<a href="#l6.5255"></a><span id="l6.5255" class="difflineplus">+</span>
<a href="#l6.5256"></a><span id="l6.5256" class="difflineplus">+    var docStateListener = new enigDocStateListener();</span>
<a href="#l6.5257"></a><span id="l6.5257" class="difflineplus">+</span>
<a href="#l6.5258"></a><span id="l6.5258" class="difflineplus">+    Enigmail.msg.editor.addDocumentStateListener(docStateListener);</span>
<a href="#l6.5259"></a><span id="l6.5259" class="difflineplus">+  },</span>
<a href="#l6.5260"></a><span id="l6.5260" class="difflineplus">+</span>
<a href="#l6.5261"></a><span id="l6.5261" class="difflineplus">+  ComposeProcessDone: function(aResult) {</span>
<a href="#l6.5262"></a><span id="l6.5262" class="difflineplus">+    // Note: called after a mail was sent (or saved)</span>
<a href="#l6.5263"></a><span id="l6.5263" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeProcessDone: &quot; + aResult + &quot;\n&quot;);</span>
<a href="#l6.5264"></a><span id="l6.5264" class="difflineplus">+</span>
<a href="#l6.5265"></a><span id="l6.5265" class="difflineplus">+    if (aResult != Components.results.NS_OK) {</span>
<a href="#l6.5266"></a><span id="l6.5266" class="difflineplus">+      if (Enigmail.msg.processed) {</span>
<a href="#l6.5267"></a><span id="l6.5267" class="difflineplus">+        Enigmail.msg.undoEncryption(4);</span>
<a href="#l6.5268"></a><span id="l6.5268" class="difflineplus">+      }</span>
<a href="#l6.5269"></a><span id="l6.5269" class="difflineplus">+      Enigmail.msg.removeAttachedKey();</span>
<a href="#l6.5270"></a><span id="l6.5270" class="difflineplus">+    }</span>
<a href="#l6.5271"></a><span id="l6.5271" class="difflineplus">+</span>
<a href="#l6.5272"></a><span id="l6.5272" class="difflineplus">+    // ensure that securityInfo is set back to S/MIME flags (especially required if draft was saved)</span>
<a href="#l6.5273"></a><span id="l6.5273" class="difflineplus">+    if (gSMFields) Enigmail.msg.setSecurityParams(gSMFields);</span>
<a href="#l6.5274"></a><span id="l6.5274" class="difflineplus">+  },</span>
<a href="#l6.5275"></a><span id="l6.5275" class="difflineplus">+</span>
<a href="#l6.5276"></a><span id="l6.5276" class="difflineplus">+  NotifyComposeBodyReady: function() {</span>
<a href="#l6.5277"></a><span id="l6.5277" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeBodyReady\n&quot;);</span>
<a href="#l6.5278"></a><span id="l6.5278" class="difflineplus">+</span>
<a href="#l6.5279"></a><span id="l6.5279" class="difflineplus">+    var isEmpty,</span>
<a href="#l6.5280"></a><span id="l6.5280" class="difflineplus">+      isEditable;</span>
<a href="#l6.5281"></a><span id="l6.5281" class="difflineplus">+</span>
<a href="#l6.5282"></a><span id="l6.5282" class="difflineplus">+    isEmpty = Enigmail.msg.editor.documentIsEmpty;</span>
<a href="#l6.5283"></a><span id="l6.5283" class="difflineplus">+    isEditable = Enigmail.msg.editor.isDocumentEditable;</span>
<a href="#l6.5284"></a><span id="l6.5284" class="difflineplus">+    Enigmail.msg.composeBodyReady = true;</span>
<a href="#l6.5285"></a><span id="l6.5285" class="difflineplus">+</span>
<a href="#l6.5286"></a><span id="l6.5286" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeBodyReady: isEmpty=&quot; + isEmpty + &quot;, isEditable=&quot; + isEditable + &quot;\n&quot;);</span>
<a href="#l6.5287"></a><span id="l6.5287" class="difflineplus">+</span>
<a href="#l6.5288"></a><span id="l6.5288" class="difflineplus">+    if (Enigmail.msg.disableSmime) {</span>
<a href="#l6.5289"></a><span id="l6.5289" class="difflineplus">+      if (gMsgCompose &amp;&amp; gMsgCompose.compFields &amp;&amp; Enigmail.msg.getSecurityParams()) {</span>
<a href="#l6.5290"></a><span id="l6.5290" class="difflineplus">+        let si = Enigmail.msg.getSecurityParams(null, true);</span>
<a href="#l6.5291"></a><span id="l6.5291" class="difflineplus">+        si.signMessage = false;</span>
<a href="#l6.5292"></a><span id="l6.5292" class="difflineplus">+        si.requireEncryptMessage = false;</span>
<a href="#l6.5293"></a><span id="l6.5293" class="difflineplus">+      }</span>
<a href="#l6.5294"></a><span id="l6.5294" class="difflineplus">+      else {</span>
<a href="#l6.5295"></a><span id="l6.5295" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.ComposeBodyReady: could not disable S/MIME\n&quot;);</span>
<a href="#l6.5296"></a><span id="l6.5296" class="difflineplus">+      }</span>
<a href="#l6.5297"></a><span id="l6.5297" class="difflineplus">+    }</span>
<a href="#l6.5298"></a><span id="l6.5298" class="difflineplus">+</span>
<a href="#l6.5299"></a><span id="l6.5299" class="difflineplus">+    if (!isEditable || isEmpty)</span>
<a href="#l6.5300"></a><span id="l6.5300" class="difflineplus">+      return;</span>
<a href="#l6.5301"></a><span id="l6.5301" class="difflineplus">+</span>
<a href="#l6.5302"></a><span id="l6.5302" class="difflineplus">+    let msgHdr = Enigmail.msg.getMsgHdr();</span>
<a href="#l6.5303"></a><span id="l6.5303" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l6.5304"></a><span id="l6.5304" class="difflineplus">+      Enigmail.msg.setOriginalSubject(msgHdr.subject, true);</span>
<a href="#l6.5305"></a><span id="l6.5305" class="difflineplus">+    }</span>
<a href="#l6.5306"></a><span id="l6.5306" class="difflineplus">+    Enigmail.msg.fixMessageSubject();</span>
<a href="#l6.5307"></a><span id="l6.5307" class="difflineplus">+</span>
<a href="#l6.5308"></a><span id="l6.5308" class="difflineplus">+    if (!Enigmail.msg.timeoutId &amp;&amp; !Enigmail.msg.dirty) {</span>
<a href="#l6.5309"></a><span id="l6.5309" class="difflineplus">+      Enigmail.msg.timeoutId = EnigmailTimer.setTimeout(function() {</span>
<a href="#l6.5310"></a><span id="l6.5310" class="difflineplus">+          Enigmail.msg.decryptQuote(false);</span>
<a href="#l6.5311"></a><span id="l6.5311" class="difflineplus">+        },</span>
<a href="#l6.5312"></a><span id="l6.5312" class="difflineplus">+        0);</span>
<a href="#l6.5313"></a><span id="l6.5313" class="difflineplus">+    }</span>
<a href="#l6.5314"></a><span id="l6.5314" class="difflineplus">+</span>
<a href="#l6.5315"></a><span id="l6.5315" class="difflineplus">+  },</span>
<a href="#l6.5316"></a><span id="l6.5316" class="difflineplus">+</span>
<a href="#l6.5317"></a><span id="l6.5317" class="difflineplus">+  SaveInFolderDone: function(folderURI) {</span>
<a href="#l6.5318"></a><span id="l6.5318" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: ECSL.SaveInFolderDone\n&quot;);</span>
<a href="#l6.5319"></a><span id="l6.5319" class="difflineplus">+  }</span>
<a href="#l6.5320"></a><span id="l6.5320" class="difflineplus">+};</span>
<a href="#l6.5321"></a><span id="l6.5321" class="difflineplus">+</span>
<a href="#l6.5322"></a><span id="l6.5322" class="difflineplus">+</span>
<a href="#l6.5323"></a><span id="l6.5323" class="difflineplus">+/**</span>
<a href="#l6.5324"></a><span id="l6.5324" class="difflineplus">+ * Unload Enigmail for update or uninstallation</span>
<a href="#l6.5325"></a><span id="l6.5325" class="difflineplus">+ */</span>
<a href="#l6.5326"></a><span id="l6.5326" class="difflineplus">+Enigmail.composeUnload = function _unload_Enigmail() {</span>
<a href="#l6.5327"></a><span id="l6.5327" class="difflineplus">+  window.removeEventListener(&quot;unload-enigmail&quot;, Enigmail.composeUnload, false);</span>
<a href="#l6.5328"></a><span id="l6.5328" class="difflineplus">+  window.removeEventListener(&quot;load-enigmail&quot;, Enigmail.msg.composeStartup, false);</span>
<a href="#l6.5329"></a><span id="l6.5329" class="difflineplus">+  window.removeEventListener(&quot;compose-window-unload&quot;, Enigmail.msg.msgComposeClose, true);</span>
<a href="#l6.5330"></a><span id="l6.5330" class="difflineplus">+  window.removeEventListener('compose-send-message', Enigmail.msg.sendMessageListener, true);</span>
<a href="#l6.5331"></a><span id="l6.5331" class="difflineplus">+</span>
<a href="#l6.5332"></a><span id="l6.5332" class="difflineplus">+  gMsgCompose.UnregisterStateListener(Enigmail.composeStateListener);</span>
<a href="#l6.5333"></a><span id="l6.5333" class="difflineplus">+</span>
<a href="#l6.5334"></a><span id="l6.5334" class="difflineplus">+  let msgId = document.getElementById(&quot;msgIdentityPopup&quot;);</span>
<a href="#l6.5335"></a><span id="l6.5335" class="difflineplus">+  if (msgId) {</span>
<a href="#l6.5336"></a><span id="l6.5336" class="difflineplus">+    msgId.removeEventListener(&quot;command&quot;, Enigmail.msg.setIdentityCallback, false);</span>
<a href="#l6.5337"></a><span id="l6.5337" class="difflineplus">+  }</span>
<a href="#l6.5338"></a><span id="l6.5338" class="difflineplus">+</span>
<a href="#l6.5339"></a><span id="l6.5339" class="difflineplus">+  let subj = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l6.5340"></a><span id="l6.5340" class="difflineplus">+  subj.removeEventListener('focus', Enigmail.msg.fireSendFlags, false);</span>
<a href="#l6.5341"></a><span id="l6.5341" class="difflineplus">+</span>
<a href="#l6.5342"></a><span id="l6.5342" class="difflineplus">+  // check rules for status bar icons on each change of the recipients</span>
<a href="#l6.5343"></a><span id="l6.5343" class="difflineplus">+  let rep = new RegExp(&quot;; Enigmail.msg.addressOnChange\\(this\\);&quot;);</span>
<a href="#l6.5344"></a><span id="l6.5344" class="difflineplus">+  var adrCol = document.getElementById(&quot;addressCol2#1&quot;); // recipients field</span>
<a href="#l6.5345"></a><span id="l6.5345" class="difflineplus">+  if (adrCol) {</span>
<a href="#l6.5346"></a><span id="l6.5346" class="difflineplus">+    let attr = adrCol.getAttribute(&quot;oninput&quot;);</span>
<a href="#l6.5347"></a><span id="l6.5347" class="difflineplus">+    adrCol.setAttribute(&quot;oninput&quot;, attr.replace(rep, &quot;&quot;));</span>
<a href="#l6.5348"></a><span id="l6.5348" class="difflineplus">+    attr = adrCol.getAttribute(&quot;onchange&quot;);</span>
<a href="#l6.5349"></a><span id="l6.5349" class="difflineplus">+    adrCol.setAttribute(&quot;onchange&quot;, attr.replace(rep, &quot;&quot;));</span>
<a href="#l6.5350"></a><span id="l6.5350" class="difflineplus">+  }</span>
<a href="#l6.5351"></a><span id="l6.5351" class="difflineplus">+  adrCol = document.getElementById(&quot;addressCol1#1&quot;); // to/cc/bcc/... field</span>
<a href="#l6.5352"></a><span id="l6.5352" class="difflineplus">+  if (adrCol) {</span>
<a href="#l6.5353"></a><span id="l6.5353" class="difflineplus">+    let attr = adrCol.getAttribute(&quot;oncommand&quot;);</span>
<a href="#l6.5354"></a><span id="l6.5354" class="difflineplus">+    adrCol.setAttribute(&quot;oncommand&quot;, attr.replace(rep, &quot;&quot;));</span>
<a href="#l6.5355"></a><span id="l6.5355" class="difflineplus">+  }</span>
<a href="#l6.5356"></a><span id="l6.5356" class="difflineplus">+</span>
<a href="#l6.5357"></a><span id="l6.5357" class="difflineplus">+  // finally unload Enigmail entirely</span>
<a href="#l6.5358"></a><span id="l6.5358" class="difflineplus">+  Enigmail = undefined;</span>
<a href="#l6.5359"></a><span id="l6.5359" class="difflineplus">+};</span>
<a href="#l6.5360"></a><span id="l6.5360" class="difflineplus">+</span>
<a href="#l6.5361"></a><span id="l6.5361" class="difflineplus">+window.addEventListener(&quot;load-enigmail&quot;,</span>
<a href="#l6.5362"></a><span id="l6.5362" class="difflineplus">+  Enigmail.msg.composeStartup.bind(Enigmail.msg),</span>
<a href="#l6.5363"></a><span id="l6.5363" class="difflineplus">+  false);</span>
<a href="#l6.5364"></a><span id="l6.5364" class="difflineplus">+</span>
<a href="#l6.5365"></a><span id="l6.5365" class="difflineplus">+window.addEventListener(&quot;unload-enigmail&quot;,</span>
<a href="#l6.5366"></a><span id="l6.5366" class="difflineplus">+  Enigmail.composeUnload.bind(Enigmail.msg),</span>
<a href="#l6.5367"></a><span id="l6.5367" class="difflineplus">+  false);</span>
<a href="#l6.5368"></a><span id="l6.5368" class="difflineplus">+</span>
<a href="#l6.5369"></a><span id="l6.5369" class="difflineplus">+window.addEventListener('compose-window-unload',</span>
<a href="#l6.5370"></a><span id="l6.5370" class="difflineplus">+  Enigmail.msg.msgComposeClose.bind(Enigmail.msg),</span>
<a href="#l6.5371"></a><span id="l6.5371" class="difflineplus">+  true);</span>
<a href="#l6.5372"></a><span id="l6.5372" class="difflineplus">+</span>
<a href="#l6.5373"></a><span id="l6.5373" class="difflineplus">+// Listen to message sending event</span>
<a href="#l6.5374"></a><span id="l6.5374" class="difflineplus">+window.addEventListener('compose-send-message',</span>
<a href="#l6.5375"></a><span id="l6.5375" class="difflineplus">+  Enigmail.msg.sendMessageListener.bind(Enigmail.msg),</span>
<a href="#l6.5376"></a><span id="l6.5376" class="difflineplus">+  true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

