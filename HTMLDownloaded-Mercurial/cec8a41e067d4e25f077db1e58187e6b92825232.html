<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17957:cec8a41e067d4e25f077db1e58187e6b92825232</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cec8a41e067d4e25f077db1e58187e6b92825232" />
<meta property="og:url" content="/comm-central/rev/cec8a41e067d4e25f077db1e58187e6b92825232" />
<meta property="og:description" content="Bug 1099592 - Make JS callers of ios.newChannel call ios.newChannel2 in calendar. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cec8a41e067d4e25f077db1e58187e6b92825232 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cec8a41e067d4e25f077db1e58187e6b92825232">shortlog</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cec8a41e067d4e25f077db1e58187e6b92825232">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232">files</a> |
changeset |
<a href="/comm-central/raw-rev/cec8a41e067d4e25f077db1e58187e6b92825232">raw</a>  | <a href="/comm-central/archive/cec8a41e067d4e25f077db1e58187e6b92825232.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1099592">Bug 1099592</a> - Make JS callers of ios.newChannel call ios.newChannel2 in calendar. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#116;&#101;&#102;&#97;&#110;&#32;&#83;&#105;&#116;&#116;&#101;&#114;&#32;&#60;&#115;&#115;&#105;&#116;&#116;&#101;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 May 2015 14:36:16 +0200</td></tr>

<tr>
 <td>changeset 17957</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cec8a41e067d4e25f077db1e58187e6b92825232">cec8a41e067d4e25f077db1e58187e6b92825232</a></td>
</tr>



<tr>
<td>parent 17956</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bf2473395e2b55cf7c1db84b5d406c213f2bd19e">bf2473395e2b55cf7c1db84b5d406c213f2bd19e</a>
</td>
</tr>

<tr>
<td>child 17958</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/277d5337de9351f809cf79d2856a80f30859ef2a">277d5337de9351f809cf79d2856a80f30859ef2a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cec8a41e067d4e25f077db1e58187e6b92825232">11040</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Tue, 19 May 2015 12:38:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@584a41516306 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=584a415163065dc63522052136479c4b772f7979">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=584a415163065dc63522052136479c4b772f7979&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=584a415163065dc63522052136479c4b772f7979&newProject=comm-central&newRevision=bf2473395e2b55cf7c1db84b5d406c213f2bd19e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=584a415163065dc63522052136479c4b772f7979&newProject=comm-central&newRevision=bf2473395e2b55cf7c1db84b5d406c213f2bd19e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=584a415163065dc63522052136479c4b772f7979&newProject=comm-central&newRevision=bf2473395e2b55cf7c1db84b5d406c213f2bd19e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1099592">1099592</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1099592">Bug 1099592</a> - Make JS callers of ios.newChannel call ios.newChannel2 in calendar. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">calendar/test/unit/test_webcal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">file</a> |
<a href="/comm-central/annotate/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">annotate</a> |
<a href="/comm-central/diff/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">diff</a> |
<a href="/comm-central/comparison/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">comparison</a> |
<a href="/comm-central/log/cec8a41e067d4e25f077db1e58187e6b92825232/calendar/test/unit/test_webcal.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -279,17 +279,22 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">                 }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">                 break;</span>
<a href="#l1.7"></a><span id="l1.7">             case &quot;application/x-moz-file-promise&quot;:</span>
<a href="#l1.8"></a><span id="l1.8">             case &quot;text/x-moz-url&quot;:</span>
<a href="#l1.9"></a><span id="l1.9">                 var uri = Services.io.newURI(data.toString(), null, null);</span>
<a href="#l1.10"></a><span id="l1.10">                 var loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l1.11"></a><span id="l1.11">                              .createInstance(Components.interfaces.nsIUnicharStreamLoader);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                var channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                var channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+                                                             null,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                                                             Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                                                             null,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+                                                             Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+                                                             Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l1.19"></a><span id="l1.19">                 channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">                 var self = this;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">                 var listener = {</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">                     // nsIUnicharStreamLoaderObserver:</span>
<a href="#l1.26"></a><span id="l1.26">                     onDetermineCharset: function(loader, context, firstSegment, length) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -25,17 +25,22 @@ this.EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even</span>
<a href="#l2.4"></a><span id="l2.4">  *                                     nsIInputStream or string data. In the</span>
<a href="#l2.5"></a><span id="l2.5">  *                                     latter case the string will be converted</span>
<a href="#l2.6"></a><span id="l2.6">  *                                     to an input stream.</span>
<a href="#l2.7"></a><span id="l2.7">  * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l2.8"></a><span id="l2.8">  * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l2.9"></a><span id="l2.9">  * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l2.10"></a><span id="l2.10">  */</span>
<a href="#l2.11"></a><span id="l2.11"> cal.prepHttpChannel = function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let channel = aExisting || Services.io.newChannelFromURI(aUri);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let channel = aExisting || Services.io.newChannelFromURI2(aUri,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+                                                              null,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                                                              Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                                                              null,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                                                              Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+                                                              Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l2.19"></a><span id="l2.19">     let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">     httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l2.22"></a><span id="l2.22">     httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l2.23"></a><span id="l2.23">     httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l2.24"></a><span id="l2.24">     httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">     if (aUploadData) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -28,33 +28,43 @@ function calProtocolHandler(scheme) {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> calProtocolHandler.prototype = {</span>
<a href="#l3.6"></a><span id="l3.6">     get defaultPort() this.mHttpProtocol.defaultPort,</span>
<a href="#l3.7"></a><span id="l3.7">     get protocolFlags() this.mHttpProtocol.protocolFlags,</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">     newURI: function cph_newURI(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l3.10"></a><span id="l3.10">         var uri = Components.classes[&quot;@mozilla.org/network/standard-url;1&quot;].</span>
<a href="#l3.11"></a><span id="l3.11">                              createInstance(Components.interfaces.nsIStandardURL);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        uri.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD, </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        uri.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l3.14"></a><span id="l3.14">                  this.mHttpProtocol.defaultPort, aSpec, anOriginalCharset, aBaseURI);</span>
<a href="#l3.15"></a><span id="l3.15">         return uri;</span>
<a href="#l3.16"></a><span id="l3.16">     },</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19">     newChannel: function cph_newChannel(aUri) {</span>
<a href="#l3.20"></a><span id="l3.20">       return this.newChannel2(aUri, null);</span>
<a href="#l3.21"></a><span id="l3.21">     },</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">     newChannel2: function cph_newChannel2(aUri, aLoadInfo)</span>
<a href="#l3.24"></a><span id="l3.24">     {</span>
<a href="#l3.25"></a><span id="l3.25">         // make sure to clone the uri, because we are about to change</span>
<a href="#l3.26"></a><span id="l3.26">         // it, and we don't want to change the original uri.</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-        var uri = aUri.clone();</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+        let uri = aUri.clone();</span>
<a href="#l3.29"></a><span id="l3.29">         uri.scheme = this.mHttpProtocol.scheme;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-        var channel = Services.io.newChannelFromURI(uri, null);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        let channel;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+        if (aLoadInfo) {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+            channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        } else {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+            channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+                                                     null,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+                                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                                                     null,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+                                                     Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+        }</span>
<a href="#l3.43"></a><span id="l3.43">         channel.originalURI = aUri;</span>
<a href="#l3.44"></a><span id="l3.44">         return channel;</span>
<a href="#l3.45"></a><span id="l3.45">     },</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">     // We are not overriding any special ports</span>
<a href="#l3.48"></a><span id="l3.48">     allowPort: function cph_allowPort(aPort, aScheme) false</span>
<a href="#l3.49"></a><span id="l3.49"> };</span>
<a href="#l3.50"></a><span id="l3.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -69,17 +69,25 @@ calTimezoneService.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">     register: function() {},</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">     // calIStartupService:</span>
<a href="#l4.7"></a><span id="l4.7">     startup: function startup(aCompleteListener) {</span>
<a href="#l4.8"></a><span id="l4.8">         function fetchJSON(aURL) {</span>
<a href="#l4.9"></a><span id="l4.9">             cal.LOG(&quot;[calTimezoneService] Loading &quot; + aURL);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">             return new Promise((resolve, reject) =&gt; {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                NetUtil.asyncFetch(aURL, (inputStream, status) =&gt; {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                let uri = Services.io.newURI(aURL, null, null);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+                let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                                                             null,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                                                             Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+                                                             null,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+                                                             Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                                                             Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                NetUtil.asyncFetch(channel, (inputStream, status) =&gt; {</span>
<a href="#l4.22"></a><span id="l4.22">                     if (!Components.isSuccessCode(status)) {</span>
<a href="#l4.23"></a><span id="l4.23">                         reject(status);</span>
<a href="#l4.24"></a><span id="l4.24">                         return;</span>
<a href="#l4.25"></a><span id="l4.25">                     }</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">                     try {</span>
<a href="#l4.28"></a><span id="l4.28">                         let jsonData = NetUtil.readInputStreamToString(inputStream, inputStream.available());</span>
<a href="#l4.29"></a><span id="l4.29">                         let tzData = JSON.parse(jsonData);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -192,17 +192,22 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">                 // Using forEach is needed for backwards compatibility</span>
<a href="#l5.6"></a><span id="l5.6">                 this.mQueryParameters.forEach(function(v, k) {</span>
<a href="#l5.7"></a><span id="l5.7">                     params.push(k + &quot;=&quot; + encodeURIComponent(v));</span>
<a href="#l5.8"></a><span id="l5.8">                 });</span>
<a href="#l5.9"></a><span id="l5.9">                 uristring += &quot;?&quot; + params.join(&quot;&amp;&quot;);</span>
<a href="#l5.10"></a><span id="l5.10">             }</span>
<a href="#l5.11"></a><span id="l5.11">             let uri = Services.io.newURI(uristring, null, null);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-            let channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+            let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                                                         null,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                                                         Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+                                                         null,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+                                                         Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                                                         Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l5.19"></a><span id="l5.19">             cal.LOG(&quot;[calGoogleRequest] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l5.20"></a><span id="l5.20">                     channel.URI.spec);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">             this.prepareChannel(channel);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l5.25"></a><span id="l5.25">             channel.redirectionLimit = 3;</span>
<a href="#l5.26"></a><span id="l5.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -111,17 +111,22 @@ calICSCalendar.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">     get uri() { return this.mUri },</span>
<a href="#l6.6"></a><span id="l6.6">     set uri(aUri) {</span>
<a href="#l6.7"></a><span id="l6.7">         this.mUri = aUri;</span>
<a href="#l6.8"></a><span id="l6.8">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">         // Use the ioservice, to create a channel, which makes finding the</span>
<a href="#l6.11"></a><span id="l6.11">         // right hooks to use easier.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                                     null,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                                                     null,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                                                     Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l6.19"></a><span id="l6.19">         let wHttpChannel = cal.wrapInstance(channel, Components.interfaces.nsIHttpChannel);</span>
<a href="#l6.20"></a><span id="l6.20">         let wFileChannel = cal.wrapInstance(channel, Components.interfaces.nsIFileChannel);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">         if (wHttpChannel) {</span>
<a href="#l6.23"></a><span id="l6.23">             this.mHooks = new httpHooks(this);</span>
<a href="#l6.24"></a><span id="l6.24">         } else if (wFileChannel) {</span>
<a href="#l6.25"></a><span id="l6.25">             this.mHooks = new fileHooks(this);</span>
<a href="#l6.26"></a><span id="l6.26">         } else {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -168,17 +173,22 @@ calICSCalendar.prototype = {</span>
<a href="#l6.28"></a><span id="l6.28">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l6.29"></a><span id="l6.29">     },</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">     doRefresh: function calICSCalendar_doRefresh(aForce) {</span>
<a href="#l6.32"></a><span id="l6.32">         let prbForce = Components.classes[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l6.33"></a><span id="l6.33">                                  .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l6.34"></a><span id="l6.34">         prbForce.data = aForce;</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                                                     null,</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+                                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                                                     null,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+                                                     Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l6.43"></a><span id="l6.43">         this.prepareChannel(channel, aForce);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">         var streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l6.46"></a><span id="l6.46">                                      .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">         // Lock other changes to the item list.</span>
<a href="#l6.49"></a><span id="l6.49">         this.lock();</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineat">@@ -312,17 +322,22 @@ calICSCalendar.prototype = {</span>
<a href="#l6.52"></a><span id="l6.52">             serializer: null,</span>
<a href="#l6.53"></a><span id="l6.53">             onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l6.54"></a><span id="l6.54">             {</span>
<a href="#l6.55"></a><span id="l6.55">                 var inLastWindowClosingSurvivalArea = false;</span>
<a href="#l6.56"></a><span id="l6.56">                 try  {</span>
<a href="#l6.57"></a><span id="l6.57">                     // All events are returned. Now set up a channel and a</span>
<a href="#l6.58"></a><span id="l6.58">                     // streamloader to upload.  onStopRequest will be called</span>
<a href="#l6.59"></a><span id="l6.59">                     // once the write has finished</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-                    var channel = Services.io.newChannelFromURI(savedthis.mUri);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+                    var channel = Services.io.newChannelFromURI2(savedthis.mUri,</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                                                                 null,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+                                                                 Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+                                                                 null,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+                                                                 Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+                                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">                     // Allow the hook to add things to the channel, like a</span>
<a href="#l6.69"></a><span id="l6.69">                     // header that checks etags</span>
<a href="#l6.70"></a><span id="l6.70">                     var notChanged = savedthis.mHooks.onBeforePut(channel);</span>
<a href="#l6.71"></a><span id="l6.71">                     if (notChanged) {</span>
<a href="#l6.72"></a><span id="l6.72">                         channel.notificationCallbacks = savedthis;</span>
<a href="#l6.73"></a><span id="l6.73">                         var uploadChannel = channel.QueryInterface(</span>
<a href="#l6.74"></a><span id="l6.74">                             Components.interfaces.nsIUploadChannel);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineat">@@ -446,32 +461,32 @@ calICSCalendar.prototype = {</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">     // Always use the queue, just to reduce the amount of places where</span>
<a href="#l6.78"></a><span id="l6.78">     // this.mMemoryCalendar.addItem() and friends are called. less</span>
<a href="#l6.79"></a><span id="l6.79">     // copied code.</span>
<a href="#l6.80"></a><span id="l6.80">     addItem: function (aItem, aListener) {</span>
<a href="#l6.81"></a><span id="l6.81">         this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l6.82"></a><span id="l6.82">     },</span>
<a href="#l6.83"></a><span id="l6.83">     adoptItem: function (aItem, aListener) {</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-        if (this.readOnly) </span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+        if (this.readOnly)</span>
<a href="#l6.86"></a><span id="l6.86">             throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l6.87"></a><span id="l6.87">         this.queue.push({action:'add', item:aItem, listener:aListener});</span>
<a href="#l6.88"></a><span id="l6.88">         this.processQueue();</span>
<a href="#l6.89"></a><span id="l6.89">     },</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91">     modifyItem: function (aNewItem, aOldItem, aListener) {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-        if (this.readOnly) </span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+        if (this.readOnly)</span>
<a href="#l6.94"></a><span id="l6.94">             throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l6.95"></a><span id="l6.95">         this.queue.push({action:'modify', oldItem: aOldItem,</span>
<a href="#l6.96"></a><span id="l6.96">                          newItem: aNewItem, listener:aListener});</span>
<a href="#l6.97"></a><span id="l6.97">         this.processQueue();</span>
<a href="#l6.98"></a><span id="l6.98">     },</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">     deleteItem: function (aItem, aListener) {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-        if (this.readOnly) </span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+        if (this.readOnly)</span>
<a href="#l6.103"></a><span id="l6.103">             throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l6.104"></a><span id="l6.104">         this.queue.push({action:'delete', item:aItem, listener:aListener});</span>
<a href="#l6.105"></a><span id="l6.105">         this.processQueue();</span>
<a href="#l6.106"></a><span id="l6.106">     },</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108">     getItem: function (aId, aListener) {</span>
<a href="#l6.109"></a><span id="l6.109">         this.queue.push({action:'get_item', id:aId, listener:aListener});</span>
<a href="#l6.110"></a><span id="l6.110">         this.processQueue();</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineat">@@ -762,17 +777,22 @@ calICSCalendar.prototype = {</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113">         var backupFile = backupDir.clone();</span>
<a href="#l6.114"></a><span id="l6.114">         backupFile.append(makeName('edit'));</span>
<a href="#l6.115"></a><span id="l6.115">         backupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0600&quot;, 8));</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117">         purgeOldBackups();</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119">         // Now go download the remote file, and store it somewhere local.</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+        var channel = Services.io.newChannelFromURI2(this.mUri,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+                                                     null,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+                                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+                                                     null,</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+                                                     Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l6.127"></a><span id="l6.127">         channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l6.128"></a><span id="l6.128">         channel.notificationCallbacks = this;</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130">         var downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l6.131"></a><span id="l6.131">                                    .createInstance(CI.nsIDownloader);</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133">         var savedthis = this;</span>
<a href="#l6.134"></a><span id="l6.134">         var listener = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -402,17 +402,22 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> function issueNetworkRequest(parentRequest, respFunc, url, bLogging) {</span>
<a href="#l7.6"></a><span id="l7.6">     var netRequest = new calWcapNetworkRequest(url, respFunc, bLogging);</span>
<a href="#l7.7"></a><span id="l7.7">     if (parentRequest) {</span>
<a href="#l7.8"></a><span id="l7.8">         parentRequest.attachSubRequest(netRequest);</span>
<a href="#l7.9"></a><span id="l7.9">     }</span>
<a href="#l7.10"></a><span id="l7.10">     try {</span>
<a href="#l7.11"></a><span id="l7.11">         var uri = Services.io.newURI(url, null, null);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        var channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        var channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+                                                     null,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+                                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+                                                     null,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+                                                     Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+                                                     Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l7.19"></a><span id="l7.19">         netRequest.prepareChannel(channel);</span>
<a href="#l7.20"></a><span id="l7.20">         channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l7.21"></a><span id="l7.21">         channel.redirectionLimit = 3;</span>
<a href="#l7.22"></a><span id="l7.22">         channel.notificationCallbacks = netRequest;</span>
<a href="#l7.23"></a><span id="l7.23">         var loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l7.24"></a><span id="l7.24">                                .createInstance(Components.interfaces.nsIUnicharStreamLoader);</span>
<a href="#l7.25"></a><span id="l7.25">         netRequest.m_loader = loader;</span>
<a href="#l7.26"></a><span id="l7.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,31 +7,31 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> /**</span>
<a href="#l8.6"></a><span id="l8.6">  * publishCalendarData</span>
<a href="#l8.7"></a><span id="l8.7">  * Show publish dialog, ask for URL and publish all selected items.</span>
<a href="#l8.8"></a><span id="l8.8">  */</span>
<a href="#l8.9"></a><span id="l8.9"> function publishCalendarData()</span>
<a href="#l8.10"></a><span id="l8.10"> {</span>
<a href="#l8.11"></a><span id="l8.11">    var args = new Object();</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-   </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14">    args.onOk =  self.publishCalendarDataDialogResponse;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-   </span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-   openDialog(&quot;chrome://calendar/content/publishDialog.xul&quot;, &quot;caPublishEvents&quot;, </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+   openDialog(&quot;chrome://calendar/content/publishDialog.xul&quot;, &quot;caPublishEvents&quot;,</span>
<a href="#l8.19"></a><span id="l8.19">               &quot;chrome,titlebar,modal,resizable&quot;, args );</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> /**</span>
<a href="#l8.23"></a><span id="l8.23">  * publishCalendarDataDialogResponse</span>
<a href="#l8.24"></a><span id="l8.24">  * Callback method for publishCalendarData() that is called when the user</span>
<a href="#l8.25"></a><span id="l8.25">  * presses the OK button in the publish dialog.</span>
<a href="#l8.26"></a><span id="l8.26">  */</span>
<a href="#l8.27"></a><span id="l8.27"> function publishCalendarDataDialogResponse(CalendarPublishObject, aProgressDialog)</span>
<a href="#l8.28"></a><span id="l8.28"> {</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-    publishItemArray(currentView().getSelectedItems({}), </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    publishItemArray(currentView().getSelectedItems({}),</span>
<a href="#l8.31"></a><span id="l8.31">                      CalendarPublishObject.remotePath, aProgressDialog);</span>
<a href="#l8.32"></a><span id="l8.32"> }</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34"> /**</span>
<a href="#l8.35"></a><span id="l8.35">  * publishEntireCalendar</span>
<a href="#l8.36"></a><span id="l8.36">  * Show publish dialog, ask for URL and publish all items from the calendar.</span>
<a href="#l8.37"></a><span id="l8.37">  *</span>
<a href="#l8.38"></a><span id="l8.38">  * @param aCalendar   (optional) The calendar that will be published. If ommitted</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -44,22 +44,22 @@ function publishEntireCalendar(aCalendar</span>
<a href="#l8.40"></a><span id="l8.40">         var calendars = getCalendarManager().getCalendars(count);</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42">         if (count.value == 1) {</span>
<a href="#l8.43"></a><span id="l8.43">             // Do not ask user for calendar if only one calendar exists</span>
<a href="#l8.44"></a><span id="l8.44">             aCalendar = calendars[0];</span>
<a href="#l8.45"></a><span id="l8.45">         } else {</span>
<a href="#l8.46"></a><span id="l8.46">             // Ask user to select the calendar that should be published.</span>
<a href="#l8.47"></a><span id="l8.47">             // publishEntireCalendar() will be called again if OK is pressed</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-            // in the dialog and the selected calendar will be passed in. </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+            // in the dialog and the selected calendar will be passed in.</span>
<a href="#l8.50"></a><span id="l8.50">             // Therefore return after openDialog().</span>
<a href="#l8.51"></a><span id="l8.51">             var args = new Object();</span>
<a href="#l8.52"></a><span id="l8.52">             args.onOk = publishEntireCalendar;</span>
<a href="#l8.53"></a><span id="l8.53">             args.promptText = calGetString(&quot;calendar&quot;, &quot;publishPrompt&quot;);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-            openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;, </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+            openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l8.56"></a><span id="l8.56">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l8.57"></a><span id="l8.57">             return;</span>
<a href="#l8.58"></a><span id="l8.58">         }</span>
<a href="#l8.59"></a><span id="l8.59">     }</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">     var args = new Object();</span>
<a href="#l8.62"></a><span id="l8.62">     var publishObject = new Object( );</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64" class="difflineat">@@ -69,31 +69,31 @@ function publishEntireCalendar(aCalendar</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">     // restore the remote ics path preference from the calendar passed in</span>
<a href="#l8.67"></a><span id="l8.67">     var remotePath = aCalendar.getProperty(&quot;remote-ics-path&quot;);</span>
<a href="#l8.68"></a><span id="l8.68">     if (remotePath &amp;&amp; remotePath.length &amp;&amp; remotePath.length &gt; 0) {</span>
<a href="#l8.69"></a><span id="l8.69">         publishObject.remotePath = remotePath;</span>
<a href="#l8.70"></a><span id="l8.70">     }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">     args.publishObject = publishObject;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-    openDialog(&quot;chrome://calendar/content/publishDialog.xul&quot;, &quot;caPublishEvents&quot;, </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+    openDialog(&quot;chrome://calendar/content/publishDialog.xul&quot;, &quot;caPublishEvents&quot;,</span>
<a href="#l8.75"></a><span id="l8.75">                &quot;chrome,titlebar,modal,resizable&quot;, args );</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">     return;</span>
<a href="#l8.78"></a><span id="l8.78"> }</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80"> /**</span>
<a href="#l8.81"></a><span id="l8.81">  * publishEntireCalendarDialogResponse</span>
<a href="#l8.82"></a><span id="l8.82">  * Callback method for publishEntireCalendar() that is called when the user</span>
<a href="#l8.83"></a><span id="l8.83">  * presses the OK button in the publish dialog.</span>
<a href="#l8.84"></a><span id="l8.84">  */</span>
<a href="#l8.85"></a><span id="l8.85"> function publishEntireCalendarDialogResponse(CalendarPublishObject, aProgressDialog)</span>
<a href="#l8.86"></a><span id="l8.86"> {</span>
<a href="#l8.87"></a><span id="l8.87">     // store the selected remote ics path as a calendar preference</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    CalendarPublishObject.calendar.setProperty(&quot;remote-ics-path&quot;, </span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    CalendarPublishObject.calendar.setProperty(&quot;remote-ics-path&quot;,</span>
<a href="#l8.90"></a><span id="l8.90">                                            CalendarPublishObject.remotePath);</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">     var itemArray = [];</span>
<a href="#l8.93"></a><span id="l8.93">     var getListener = {</span>
<a href="#l8.94"></a><span id="l8.94">         onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l8.95"></a><span id="l8.95">         {</span>
<a href="#l8.96"></a><span id="l8.96">             publishItemArray(itemArray, CalendarPublishObject.remotePath, aProgressDialog);</span>
<a href="#l8.97"></a><span id="l8.97">         },</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -103,17 +103,17 @@ function publishEntireCalendarDialogResp</span>
<a href="#l8.99"></a><span id="l8.99">                 aborted = true;</span>
<a href="#l8.100"></a><span id="l8.100">                 return;</span>
<a href="#l8.101"></a><span id="l8.101">             }</span>
<a href="#l8.102"></a><span id="l8.102">             if (aCount) {</span>
<a href="#l8.103"></a><span id="l8.103">                 for (var i=0; i&lt;aCount; ++i) {</span>
<a href="#l8.104"></a><span id="l8.104">                     // Store a (short living) reference to the item.</span>
<a href="#l8.105"></a><span id="l8.105">                     var itemCopy = aItems[i].clone();</span>
<a href="#l8.106"></a><span id="l8.106">                     itemArray.push(itemCopy);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-                }  </span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+                }</span>
<a href="#l8.109"></a><span id="l8.109">             }</span>
<a href="#l8.110"></a><span id="l8.110">         }</span>
<a href="#l8.111"></a><span id="l8.111">     };</span>
<a href="#l8.112"></a><span id="l8.112">     aProgressDialog.onStartUpload();</span>
<a href="#l8.113"></a><span id="l8.113">     var oldCalendar = CalendarPublishObject.calendar;</span>
<a href="#l8.114"></a><span id="l8.114">     oldCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l8.115"></a><span id="l8.115">                          0, null, null, getListener);</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117" class="difflineat">@@ -121,17 +121,22 @@ function publishEntireCalendarDialogResp</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119"> function publishItemArray(aItemArray, aPath, aProgressDialog) {</span>
<a href="#l8.120"></a><span id="l8.120">     var outputStream;</span>
<a href="#l8.121"></a><span id="l8.121">     var inputStream;</span>
<a href="#l8.122"></a><span id="l8.122">     var storageStream;</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124">     var icsURL = makeURL(aPath);</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-    var channel = Services.io.newChannelFromURI(icsURL);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    var channel = Services.io.newChannelFromURI2(icsURL,</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+                                                 null,</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+                                                 Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+                                                 null,</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+                                                 Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l8.133"></a><span id="l8.133">     if (icsURL.schemeIs('webcal'))</span>
<a href="#l8.134"></a><span id="l8.134">         icsURL.scheme = 'http';</span>
<a href="#l8.135"></a><span id="l8.135">     if (icsURL.schemeIs('webcals'))</span>
<a href="#l8.136"></a><span id="l8.136">         icsURL.scheme = 'https';</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138">     switch(icsURL.scheme) {</span>
<a href="#l8.139"></a><span id="l8.139">         case 'http':</span>
<a href="#l8.140"></a><span id="l8.140">         case 'https':</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/test/unit/test_webcal.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/test/unit/test_webcal.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -21,15 +21,23 @@ function run_test() {</span>
<a href="#l9.4"></a><span id="l9.4">     // TODO webcals needs bug 466524 to be fixed</span>
<a href="#l9.5"></a><span id="l9.5">     // add_test(check_webcal_uri.bind(null, &quot;webcals&quot; + baseUri));</span>
<a href="#l9.6"></a><span id="l9.6">     add_test(() =&gt;  httpserv.stop(run_next_test));</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">     // Now lets go...</span>
<a href="#l9.9"></a><span id="l9.9">     run_next_test();</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-function check_webcal_uri(uri) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    let chan = Services.io.newChannel(uri, null, null);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    NetUtil.asyncFetch(chan, function(data, status, request) {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+function check_webcal_uri(aUri) {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    let uri = Services.io.newURI(aUri, null, null);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+                                                 null,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+                                                 Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+                                                 null,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                                                 Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+                                                 Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+    NetUtil.asyncFetch(channel, function(data, status, request) {</span>
<a href="#l9.26"></a><span id="l9.26">         ok(Components.isSuccessCode(status));</span>
<a href="#l9.27"></a><span id="l9.27">         run_next_test();</span>
<a href="#l9.28"></a><span id="l9.28">     });</span>
<a href="#l9.29"></a><span id="l9.29"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

