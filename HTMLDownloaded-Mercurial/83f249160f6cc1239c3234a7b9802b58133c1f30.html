<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22431:83f249160f6cc1239c3234a7b9802b58133c1f30</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 83f249160f6cc1239c3234a7b9802b58133c1f30" />
<meta property="og:url" content="/comm-central/rev/83f249160f6cc1239c3234a7b9802b58133c1f30" />
<meta property="og:description" content="Bug 1408610 - Resend auth string when imap server requests it. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 83f249160f6cc1239c3234a7b9802b58133c1f30 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/83f249160f6cc1239c3234a7b9802b58133c1f30">shortlog</a> |
<a href="/comm-central/log/83f249160f6cc1239c3234a7b9802b58133c1f30">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/83f249160f6cc1239c3234a7b9802b58133c1f30">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/83f249160f6cc1239c3234a7b9802b58133c1f30">files</a> |
changeset |
<a href="/comm-central/raw-rev/83f249160f6cc1239c3234a7b9802b58133c1f30">raw</a>  | <a href="/comm-central/archive/83f249160f6cc1239c3234a7b9802b58133c1f30.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408610">Bug 1408610</a> - Resend auth string when imap server requests it. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#110;&#101;&#32;&#83;&#109;&#105;&#116;&#104;&#32;&#60;&#103;&#100;&#115;&#64;&#99;&#104;&#97;&#114;&#116;&#101;&#114;&#116;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Oct 2017 01:43:34 -0400</td></tr>

<tr>
 <td>changeset 22431</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/83f249160f6cc1239c3234a7b9802b58133c1f30">83f249160f6cc1239c3234a7b9802b58133c1f30</a></td>
</tr>



<tr>
<td>parent 22430</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c468a23c5c045056e9db8d18182d2d342e324b68">c468a23c5c045056e9db8d18182d2d342e324b68</a>
</td>
</tr>

<tr>
<td>child 22432</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2dc8f2e4802db4d61212b928e6d38628dc300baa">2dc8f2e4802db4d61212b928e6d38628dc300baa</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=83f249160f6cc1239c3234a7b9802b58133c1f30">13675</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 26 Oct 2017 22:09:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@83f249160f6c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=83f249160f6cc1239c3234a7b9802b58133c1f30">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=83f249160f6cc1239c3234a7b9802b58133c1f30&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=83f249160f6cc1239c3234a7b9802b58133c1f30&newProject=comm-central&newRevision=427b418a19b39c29da079e92079811991d7b5d13&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=83f249160f6cc1239c3234a7b9802b58133c1f30&newProject=comm-central&newRevision=427b418a19b39c29da079e92079811991d7b5d13&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=83f249160f6cc1239c3234a7b9802b58133c1f30&newProject=comm-central&newRevision=427b418a19b39c29da079e92079811991d7b5d13&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408610">1408610</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408610">Bug 1408610</a> - Resend auth string when imap server requests it. r=jorgk
Yahoo responds to &quot;authenticate PLAIN&quot; with + and TB sends the
base64 encode uid/password string. If bad, Yahoo responds again
with + and expects TB to send the string again. Instead, TB was just
continuing on as though authentication was good and sent imap
commands to Yahoo that were rejected causing folders and emails
to disappear in TB and TB to not request a new password.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/83f249160f6cc1239c3234a7b9802b58133c1f30/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5902,19 +5902,40 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l1.4"></a><span id="l1.4">       PR_snprintf(&amp;plainstr[1], 510, &quot;%s&quot;, userName);</span>
<a href="#l1.5"></a><span id="l1.5">       len += PL_strlen(userName);</span>
<a href="#l1.6"></a><span id="l1.6">       len++;  // count for second &lt;NUL&gt; char</span>
<a href="#l1.7"></a><span id="l1.7">       PR_snprintf(&amp;plainstr[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l1.8"></a><span id="l1.8">       len += password.Length();</span>
<a href="#l1.9"></a><span id="l1.9">       char *base64Str = PL_Base64Encode(plainstr, len, nullptr);</span>
<a href="#l1.10"></a><span id="l1.10">       PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l1.11"></a><span id="l1.11">       PR_Free(base64Str);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      rv = SendData(m_dataOutputBuf, true /* suppress logging */);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      bool isResend = false;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+      while (true)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+      {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        // Send authentication string (true: suppress logging the string).</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        rv = SendData(m_dataOutputBuf, true);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+          break;</span>
<a href="#l1.22"></a><span id="l1.22">         ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+        if (!GetServerStateParser().WaitingForMoreClientInput())</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+          break;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+        // Server is asking for authentication string again. So we send the</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+        // same string again although we already know that it will be</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+        // rejected again. We do that to get a firm authentication failure</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+        // instead of a resend request. That keeps things in order before</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+        // failing &quot;authenticate PLAIN&quot; and trying another method if capable.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+        if (isResend)</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+          rv = NS_ERROR_FAILURE;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+          break;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        }</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+        isResend = true;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      }</span>
<a href="#l1.38"></a><span id="l1.38">     } // if the last command succeeded</span>
<a href="#l1.39"></a><span id="l1.39">   } // if auth plain capability</span>
<a href="#l1.40"></a><span id="l1.40">   else if (flag &amp; kHasAuthLoginCapability)</span>
<a href="#l1.41"></a><span id="l1.41">   {</span>
<a href="#l1.42"></a><span id="l1.42">     MOZ_LOG(IMAP, LogLevel::Debug, (&quot;LOGIN auth&quot;));</span>
<a href="#l1.43"></a><span id="l1.43">     PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s authenticate LOGIN&quot; CRLF, GetServerCommandTag());</span>
<a href="#l1.44"></a><span id="l1.44">     rv = SendData(m_dataOutputBuf);</span>
<a href="#l1.45"></a><span id="l1.45">     NS_ENSURE_SUCCESS(rv, rv);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

