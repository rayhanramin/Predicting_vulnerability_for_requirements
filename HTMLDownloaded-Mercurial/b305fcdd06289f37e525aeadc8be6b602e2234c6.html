<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5128:b305fcdd06289f37e525aeadc8be6b602e2234c6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b305fcdd06289f37e525aeadc8be6b602e2234c6" />
<meta property="og:url" content="/comm-central/rev/b305fcdd06289f37e525aeadc8be6b602e2234c6" />
<meta property="og:description" content="bug 545625 - &quot;back-fork ifdef'd mozStorage of bug 507414 into comm-central or mozilla-1.9.2 for TB 3.1 release&quot;. transplant bug 507414 patch v5 to comm-central/storage-backport.  that patch is under review by sdwilsh for mozilla-central landing but is believed good per mozilla-central try builds and local tests.  comm-central landing: rs=Standard8." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b305fcdd06289f37e525aeadc8be6b602e2234c6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b305fcdd06289f37e525aeadc8be6b602e2234c6">shortlog</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b305fcdd06289f37e525aeadc8be6b602e2234c6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6">files</a> |
changeset |
<a href="/comm-central/raw-rev/b305fcdd06289f37e525aeadc8be6b602e2234c6">raw</a>  | <a href="/comm-central/archive/b305fcdd06289f37e525aeadc8be6b602e2234c6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">bug 545625</a> - &quot;back-fork ifdef'd mozStorage of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> into comm-central or mozilla-1.9.2 for TB 3.1 release&quot;. transplant <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> patch v5 to comm-central/storage-backport.  that patch is under review by sdwilsh for mozilla-central landing but is believed good per mozilla-central try builds and local tests.  comm-central landing: rs=Standard8.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 10 Mar 2010 09:11:42 -0800</td></tr>

<tr>
 <td>changeset 5128</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b305fcdd06289f37e525aeadc8be6b602e2234c6">b305fcdd06289f37e525aeadc8be6b602e2234c6</a></td>
</tr>



<tr>
<td>parent 5127</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/715859e3dc66d59393dc5902334910fe19696047">715859e3dc66d59393dc5902334910fe19696047</a>
</td>
</tr>

<tr>
<td>child 5129</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4be99c0f603648378fa0ebd618433cb41a7690af">4be99c0f603648378fa0ebd618433cb41a7690af</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b305fcdd06289f37e525aeadc8be6b602e2234c6">3972</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 10 Mar 2010 17:12:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@700a775e14da [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=700a775e14da26aec2541add350ea6cf1e692580">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=700a775e14da26aec2541add350ea6cf1e692580&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=700a775e14da26aec2541add350ea6cf1e692580&newProject=comm-central&newRevision=b305fcdd06289f37e525aeadc8be6b602e2234c6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=700a775e14da26aec2541add350ea6cf1e692580&newProject=comm-central&newRevision=b305fcdd06289f37e525aeadc8be6b602e2234c6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=700a775e14da26aec2541add350ea6cf1e692580&newProject=comm-central&newRevision=b305fcdd06289f37e525aeadc8be6b602e2234c6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">545625</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">507414</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">bug 545625</a> - &quot;back-fork ifdef'd mozStorage of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> into comm-central or mozilla-1.9.2 for TB 3.1 release&quot;. transplant <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=507414">bug 507414</a> patch v5 to comm-central/storage-backport.  that patch is under review by sdwilsh for mozilla-central landing but is believed good per mozilla-central try builds and local tests.  comm-central landing: rs=Standard8.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">storage-backport/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">storage-backport/build/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">storage-backport/build/mozStorageCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">storage-backport/build/mozStorageModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/build/mozStorageModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">storage-backport/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">storage-backport/public/mozIStorageAggregateFunction.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAggregateFunction.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">storage-backport/public/mozIStorageAsyncStatement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageAsyncStatement.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">storage-backport/public/mozIStorageBaseStatement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBaseStatement.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">storage-backport/public/mozIStorageBindingParams.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParams.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">storage-backport/public/mozIStorageBindingParamsArray.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageBindingParamsArray.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">storage-backport/public/mozIStorageCompletionCallback.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageCompletionCallback.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">storage-backport/public/mozIStorageConnection.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageConnection.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">storage-backport/public/mozIStorageError.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageError.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">storage-backport/public/mozIStorageFunction.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageFunction.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">storage-backport/public/mozIStoragePendingStatement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStoragePendingStatement.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">storage-backport/public/mozIStorageProgressHandler.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageProgressHandler.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">storage-backport/public/mozIStorageResultSet.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageResultSet.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">storage-backport/public/mozIStorageRow.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageRow.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">storage-backport/public/mozIStorageService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">storage-backport/public/mozIStorageStatement.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatement.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">storage-backport/public/mozIStorageStatementCallback.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementCallback.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">storage-backport/public/mozIStorageStatementWrapper.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageStatementWrapper.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">storage-backport/public/mozIStorageValueArray.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozIStorageValueArray.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">storage-backport/public/mozStorage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">storage-backport/public/mozStorageHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/mozStorageHelper.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">storage-backport/public/storage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/public/storage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">storage-backport/src/IStorageBindingParamsInternal.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/IStorageBindingParamsInternal.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">storage-backport/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">storage-backport/src/SQLCollations.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">storage-backport/src/SQLCollations.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLCollations.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">storage-backport/src/SQLiteMutex.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/SQLiteMutex.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">storage-backport/src/StorageBaseStatementInternal.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">storage-backport/src/StorageBaseStatementInternal.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/StorageBaseStatementInternal.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">storage-backport/src/Variant.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">storage-backport/src/Variant_inl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/Variant_inl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">storage-backport/src/mozStorageArgValueArray.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">storage-backport/src/mozStorageArgValueArray.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageArgValueArray.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">storage-backport/src/mozStorageAsyncStatement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">storage-backport/src/mozStorageAsyncStatement.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatement.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">storage-backport/src/mozStorageAsyncStatementExecution.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">storage-backport/src/mozStorageAsyncStatementExecution.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementExecution.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">storage-backport/src/mozStorageAsyncStatementJSHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">storage-backport/src/mozStorageAsyncStatementJSHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementJSHelper.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">storage-backport/src/mozStorageAsyncStatementParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">storage-backport/src/mozStorageAsyncStatementParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageAsyncStatementParams.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">storage-backport/src/mozStorageBindingParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">storage-backport/src/mozStorageBindingParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParams.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">storage-backport/src/mozStorageBindingParamsArray.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">storage-backport/src/mozStorageBindingParamsArray.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageBindingParamsArray.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">storage-backport/src/mozStorageConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">storage-backport/src/mozStorageConnection.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageConnection.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">storage-backport/src/mozStorageError.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">storage-backport/src/mozStorageError.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageError.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">storage-backport/src/mozStoragePrivateHelpers.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">storage-backport/src/mozStoragePrivateHelpers.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStoragePrivateHelpers.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">storage-backport/src/mozStorageResultSet.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">storage-backport/src/mozStorageResultSet.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageResultSet.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">storage-backport/src/mozStorageRow.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">storage-backport/src/mozStorageRow.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageRow.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">storage-backport/src/mozStorageSQLFunctions.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">storage-backport/src/mozStorageSQLFunctions.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageSQLFunctions.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">storage-backport/src/mozStorageService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">storage-backport/src/mozStorageService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">storage-backport/src/mozStorageStatement.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">storage-backport/src/mozStorageStatement.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatement.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">storage-backport/src/mozStorageStatementData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementData.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">storage-backport/src/mozStorageStatementJSHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">storage-backport/src/mozStorageStatementJSHelper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementJSHelper.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">storage-backport/src/mozStorageStatementParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">storage-backport/src/mozStorageStatementParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">storage-backport/src/mozStorageStatementRow.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">storage-backport/src/mozStorageStatementRow.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementRow.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">storage-backport/src/mozStorageStatementWrapper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">storage-backport/src/mozStorageStatementWrapper.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/mozStorageStatementWrapper.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">storage-backport/src/variantToSQLiteT_impl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/src/variantToSQLiteT_impl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">storage-backport/style.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/style.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">storage-backport/test/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">storage-backport/test/storage_test_harness.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">storage-backport/test/storage_test_harness_tail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/storage_test_harness_tail.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">storage-backport/test/test_binding_params.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_binding_params.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">storage-backport/test/test_deadlock_detector.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_deadlock_detector.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">storage-backport/test/test_mutex.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_mutex.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">storage-backport/test/test_statement_scoper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_statement_scoper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">storage-backport/test/test_transaction_helper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_transaction_helper.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">storage-backport/test/test_true_async.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/test_true_async.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">storage-backport/test/unit/corruptDB.sqlite</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/corruptDB.sqlite">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">storage-backport/test/unit/head_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/head_storage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">storage-backport/test/unit/locale_collation.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/locale_collation.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">storage-backport/test/unit/test_bug-365166.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-365166.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">storage-backport/test/unit/test_bug-393952.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-393952.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">storage-backport/test/unit/test_bug-429521.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-429521.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">storage-backport/test/unit/test_bug-444233.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_bug-444233.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">storage-backport/test/unit/test_connection_executeAsync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_connection_executeAsync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">storage-backport/test/unit/test_js_helpers_enumerate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_enumerate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">storage-backport/test/unit/test_levenshtein.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_levenshtein.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">storage-backport/test/unit/test_like.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">storage-backport/test/unit/test_like_escape.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_like_escape.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">storage-backport/test/unit/test_locale_collation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_locale_collation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">storage-backport/test/unit/test_sqlite_secure_delete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_sqlite_secure_delete.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">storage-backport/test/unit/test_statement_executeAsync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_executeAsync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">storage-backport/test/unit/test_statement_wrapper_automatically.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_statement_wrapper_automatically.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">storage-backport/test/unit/test_storage_aggregates.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_aggregates.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">storage-backport/test/unit/test_storage_connection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_connection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">storage-backport/test/unit/test_storage_fulltextindex.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_fulltextindex.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">storage-backport/test/unit/test_storage_function.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_function.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">storage-backport/test/unit/test_storage_progresshandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_progresshandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">storage-backport/test/unit/test_storage_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">storage-backport/test/unit/test_storage_service_unshared.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_service_unshared.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">storage-backport/test/unit/test_storage_statement.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">storage-backport/test/unit/test_storage_statement_wrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_statement_wrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">storage-backport/test/unit/test_storage_value_array.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_storage_value_array.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">storage-backport/test/unit/test_unicode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">file</a> |
<a href="/comm-central/annotate/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">annotate</a> |
<a href="/comm-central/diff/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">diff</a> |
<a href="/comm-central/comparison/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">comparison</a> |
<a href="/comm-central/log/b305fcdd06289f37e525aeadc8be6b602e2234c6/storage-backport/test/unit/test_unicode.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/storage-backport/Makefile.in</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,62 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+#</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+#</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+# License.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+#</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+# The Original Code is Oracle Corporation code.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+#</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+#   Oracle Corporation</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+#</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+#   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+#</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+#</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+DEPTH		= ..</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+MODULE		= storage</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+ifndef MOZ_NATIVE_SQLITE</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+DIRS		= ../db/sqlite3/src</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+endif</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+DIRS		+= public \</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+		   src \</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+		   build \</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+		   $(NULL)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+ifdef ENABLE_TESTS</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+TOOL_DIRS += test</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+endif</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/storage-backport/build/Makefile.in</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,77 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+#</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+#</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+# License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+#</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+# The Original Code is Oracle Corporation code.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+#</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+#   Oracle Corporation</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+#</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+#   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+#   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+#</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+#</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+DEPTH=../..</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+topsrcdir=@top_srcdir@</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+srcdir=@srcdir@</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+VPATH=@srcdir@</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+MODULE		= storage</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+LIBRARY_NAME = storagecomps</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+SHORT_LIBNAME = strgcmps</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+EXPORT_LIBRARY = 1</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+IS_COMPONENT = 1</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+MODULE_NAME = mozStorageModule</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+LIBXUL_LIBRARY = 1</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+EXPORTS = mozStorageCID.h</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+CPPSRCS = mozStorageModule.cpp</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+LOCAL_INCLUDES = \</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+	$(SQLITE_CFLAGS) \</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+	-I$(srcdir)/../src</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+SHARED_LIBRARY_LIBS = \</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+	../src/$(LIB_PREFIX)storage_s.$(LIB_SUFFIX) \</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+	$(NULL)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+EXTRA_DSO_LDOPTS += \</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+	$(LIBS_DIR) \</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+	$(SQLITE_LIBS) \</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+	$(MOZ_UNICHARUTIL_LIBS) \</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+	$(MOZ_COMPONENT_LIBS) \</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+	$(MOZ_JS_LIBS) \</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+	$(NULL)</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/storage-backport/build/mozStorageCID.h</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ *</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * License.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+#ifndef _MOZSTORAGECID_H_</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+#define _MOZSTORAGECID_H_</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+#define MOZ_STORAGE_CONTRACTID_PREFIX &quot;@mozilla.org/storage&quot;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+/* b71a1f84-3a70-4d37-a348-f1ba0e27eead */</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+#define MOZ_STORAGE_CONNECTION_CID \</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+{ 0xb71a1f84, 0x3a70, 0x4d37, {0xa3, 0x48, 0xf1, 0xba, 0x0e, 0x27, 0xee, 0xad} }</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+#define MOZ_STORAGE_CONNECTION_CONTRACTID MOZ_STORAGE_CONTRACTID_PREFIX &quot;/connection;1&quot;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+/* bbbb1d61-438f-4436-92ed-8308e5830fb0 */</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+#define MOZ_STORAGE_SERVICE_CID \</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+{ 0xbbbb1d61, 0x438f, 0x4436, {0x92, 0xed, 0x83, 0x08, 0xe5, 0x83, 0x0f, 0xb0} }</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+#define MOZ_STORAGE_SERVICE_CONTRACTID MOZ_STORAGE_CONTRACTID_PREFIX &quot;/service;1&quot;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+/* dab3a846-3a59-4fc2-9745-c6ff48776f00 */</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+#define MOZ_STORAGE_STATEMENT_WRAPPER_CID \</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+{ 0xdab3a846, 0x3a59, 0x4fc2, {0x97, 0x45, 0xc6, 0xff, 0x48, 0x77, 0x6f, 0x00} }</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+#define MOZ_STORAGE_STATEMENT_WRAPPER_CONTRACTID MOZ_STORAGE_CONTRACTID_PREFIX &quot;/statement-wrapper;1&quot;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+#endif /* _MOZSTORAGECID_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/storage-backport/build/mozStorageModule.cpp</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,76 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ *</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * License.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ *</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ *</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ *</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ *</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ *</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+#include &quot;nsIGenericFactory.h&quot;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+#include &quot;nsIModule.h&quot;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+#include &quot;mozStorageStatementWrapper.h&quot;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+#include &quot;mozStorageCID.h&quot;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+namespace mozilla {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+namespace storage {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(Service,</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+                                         Service::getSingleton)</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(StatementWrapper)</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+} // namespace storage</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+} // namespace mozilla</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+static const nsModuleComponentInfo components[] =</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+{</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    { &quot;Unified Data Store Service&quot;,</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      MOZ_STORAGE_SERVICE_CID,</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      MOZ_STORAGE_SERVICE_CONTRACTID,</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+      mozilla::storage::ServiceConstructor</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    },</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    { &quot;Unified Data Store Scriptable Statement Wrapper&quot;,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+      MOZ_STORAGE_STATEMENT_WRAPPER_CID,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+      MOZ_STORAGE_STATEMENT_WRAPPER_CONTRACTID,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      mozilla::storage::StatementWrapperConstructor</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+    }</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+};</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+NS_IMPL_NSGETMODULE(mozStorageModule, components)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/storage-backport/public/Makefile.in</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+#</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+#</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+# License.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+# The Original Code is Oracle Corporation code.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+#</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+#   Oracle Corporation</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+#</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+#   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+#   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+#</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+#</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+DEPTH   = ../..</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+VPATH   = @srcdir@</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+MODULE       = storage</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+XPIDL_MODULE = storage</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+GRE_MODULE   = 1</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+XPIDLSRCS = \</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+	mozIStorageService.idl \</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+	mozIStorageConnection.idl \</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+	mozIStorageAggregateFunction.idl \</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+	mozIStorageFunction.idl \</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+	mozIStorageProgressHandler.idl \</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+	mozIStorageStatement.idl \</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+	mozIStorageStatementWrapper.idl \</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+	mozIStorageValueArray.idl \</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+	mozIStorageResultSet.idl \</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+	mozIStorageRow.idl \</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  mozIStorageError.idl \</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  mozIStorageStatementCallback.idl \</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  mozIStoragePendingStatement.idl \</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  mozIStorageBindingParamsArray.idl \</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  mozIStorageBindingParams.idl \</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  mozIStorageCompletionCallback.idl \</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  mozIStorageBaseStatement.idl \</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  mozIStorageAsyncStatement.idl \</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+	$(NULL)</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+EXPORTS_NAMESPACES = mozilla</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+EXPORTS = \</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+	mozStorageHelper.h \</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+	mozStorage.h \</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+	$(NULL)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+EXPORTS_mozilla = storage.h</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageAggregateFunction.idl</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,70 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ *</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ *</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * License.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * The Original Code is Storage Code.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ *</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ *</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+interface mozIStorageConnection;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+interface mozIStorageValueArray;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+interface nsIArray;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+interface nsIVariant;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+/**</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+ * mozIStorageAggregateFunction represents aggregate SQL function.</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+ * Common examples of aggregate functions are SUM() and COUNT().</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+ *</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+ * An aggregate function calculates one result for a given set of data, where</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+ * a set of data is a group of tuples. There can be one group</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+ * per request or many of them, if GROUP BY clause is used or not.</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+ */</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+[scriptable, uuid(763217b7-3123-11da-918d-000347412e16)]</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+interface mozIStorageAggregateFunction : nsISupports {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  /**</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+   * onStep is called when next value should be passed to</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+   * a custom function.</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+   * </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+   * @param aFunctionArguments    The arguments passed in to the function</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+   */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  void onStep(in mozIStorageValueArray aFunctionArguments);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  /**</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+   * Called when all tuples in a group have been processed and the engine</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+   * needs the aggregate function's value.</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+   *</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+   * @returns aggregate result as Variant.</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+   */</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  nsIVariant onFinal();</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageAsyncStatement.idl</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,69 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ *</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ *</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * License.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ *</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ *</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ *</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ *</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+#include &quot;mozIStorageBaseStatement.idl&quot;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+/**</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ * An asynchronous SQL statement.  This differs from mozIStorageStatement by</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ * only being usable for asynchronous execution.  (mozIStorageStatement can</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ * be used for both synchronous and asynchronous purposes.)  This specialization</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ * for asynchronous operation allows us to avoid needing to acquire</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ * synchronization primitives also used by the asynchronous execution thread.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ * In contrast, mozIStorageStatement may need to acquire the primitives and</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+ * consequently can cause the main thread to lock for extended intervals while</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+ * the asynchronous thread performs some long-running operation.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+ */</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+[scriptable, uuid(2400f64d-2cb3-49a9-b01e-f03cacb8aa6e)]</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+interface mozIStorageAsyncStatement : mozIStorageBaseStatement {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  /*</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+   * 'params' provides a magic JS helper that lets you assign parameters by</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+   * name.  Unlike the helper on mozIStorageStatement, you cannot enumerate</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+   * in order to find out what parameters are legal.</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+   *</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+   * This does not work for BLOBs.  You must use an explicit binding API for</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+   * that.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+   *</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+   * example:</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+   *  stmt.params.foo = 1;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+   *  stmt.params[&quot;bar&quot;] = 2;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+   *  let argName = &quot;baz&quot;;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+   *  stmt.params[argName] = 3;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+   *</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+   * readonly attribute nsIMagic params;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+   */</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageBaseStatement.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,179 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ *</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ *</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * License.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Original Code is mozStorage.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ *</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ *</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+ *</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+#include &quot;mozIStorageBindingParams.idl&quot;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+interface mozIStorageConnection;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+interface mozIStorageStatementCallback;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+interface mozIStoragePendingStatement;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+interface mozIStorageBindingParams;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+interface mozIStorageBindingParamsArray;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+/**</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ * The base interface for both pure asynchronous storage statements </span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ * (mozIStorageAsyncStatement) and 'classic' storage statements</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+ * (mozIStorageStatement) that can be used for both synchronous and asynchronous</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+ * purposes.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+ */</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+[scriptable, uuid(da2ec336-fbbb-4ba1-9778-8c9825980d01)]</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+interface mozIStorageBaseStatement : mozIStorageBindingParams {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  /**</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+   * Finalizes a statement so you can successfully close a database connection.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+   * Once a statement has been finalized it can no longer be used for any</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+   * purpose.</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+   * </span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+   * Statements are implicitly finalized when their reference counts hits zero.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   * If you are a native (C++) caller this is accomplished by setting all of</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+   * your nsCOMPtr instances to be NULL.  If you are operating from JavaScript</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+   * code then you cannot rely on this behavior because of the involvement of</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+   * garbage collection.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+   *</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+   * When finalizing an asynchronous statement you do not need to worry about</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+   * whether the statement has actually been executed by the asynchronous</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+   * thread; you just need to call finalize after your last call to executeAsync</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+   * involving the statement.  However, you do need to use asyncClose instead of</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+   * close on the connection if any statements have been used asynchronously.</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+   */</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  void finalize();</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  /**</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+   * Bind the given value at the given numeric index.</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+   *</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+   * @param aParamIndex</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+   *        0-based index, 0 corresponding to the first numbered argument or</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+   *        &quot;?1&quot;.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+   * @param aValue Argument value.</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+   * @{</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+   */</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  [deprecated] void bindUTF8StringParameter(in unsigned long aParamIndex,</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                                            in AUTF8String aValue);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  [deprecated] void bindStringParameter(in unsigned long aParamIndex,</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+                                        in AString aValue);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  [deprecated] void bindDoubleParameter(in unsigned long aParamIndex,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+                                        in double aValue);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  [deprecated] void bindInt32Parameter(in unsigned long aParamIndex,</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+                                       in long aValue);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  [deprecated] void bindInt64Parameter(in unsigned long aParamIndex,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+                                       in long long aValue);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  [deprecated] void bindNullParameter(in unsigned long aParamIndex);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  [deprecated] void bindBlobParameter(</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    in unsigned long aParamIndex,</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    [array,const,size_is(aValueSize)] in octet aValue,</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+    in unsigned long aValueSize);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  /**@}*/</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  /**</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+   * Binds the array of parameters to the statement.  When executeAsync is</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+   * called, all the parameters in aParameters are bound and then executed.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+   *</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+   * @param aParameters</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+   *        The array of parameters to bind to the statement upon execution.</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+   *</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+   * @note This is only works on statements being used asynchronously.</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+   */</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  void bindParameters(in mozIStorageBindingParamsArray aParameters);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  /**</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+   * Creates a new mozIStorageBindingParamsArray that can be used to bind</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+   * multiple sets of data to a statement with bindParameters.</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+   *</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+   * @return a mozIStorageBindingParamsArray that multiple sets of parameters</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+   *         can be bound to.</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+   *</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+   * @note This is only useful for statements being used asynchronously.</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+   */</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  mozIStorageBindingParamsArray newBindingParamsArray();</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  /**</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+   * Execute a query asynchronously using any currently bound parameters.  This</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+   * statement can be reused immediately, and reset does not need to be called.</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+   *</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+   * @note If you have any custom defined functions, they must be re-entrant</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+   *       since they can be called on multiple threads.</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+   *</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+   * @param aCallback [optional]</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+   *        The callback object that will be notified of progress, errors, and</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+   *        completion.</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+   * @return an object that can be used to cancel the statements execution.</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+   */</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  mozIStoragePendingStatement executeAsync(</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    [optional] in mozIStorageStatementCallback aCallback</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  );</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+  /**</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+   * The statement is not usable, either because it failed to initialize or</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+   * was explicitly finalized.</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+   */</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  const long MOZ_STORAGE_STATEMENT_INVALID = 0;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  /**</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+   * The statement is usable.</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+   */</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  const long MOZ_STORAGE_STATEMENT_READY = 1;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  /**</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+   * Indicates that the statement is executing and the row getters may be used.</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+   *</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+   * @note This is only relevant for mozIStorageStatement instances being used</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+   *       in a synchronous fashion.</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+   */</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  const long MOZ_STORAGE_STATEMENT_EXECUTING = 2;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  /**</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+   * Find out whether the statement is usable (has not been finalized).</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+   */</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  readonly attribute long state;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  /**</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+   * Escape a string for SQL LIKE search.</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+   *</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+   * @note Consumers will have to use same escape char when doing statements</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+   *       such as:   ...LIKE '?1' ESCAPE '/'...</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+   *</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+   * @param aValue</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+   *        The string to escape for SQL LIKE.</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+   * @param aEscapeChar</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+   *        The escape character.</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+   * @return an AString of an escaped version of aValue</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+   *         (%, _ and the escape char are escaped with the escape char)</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+   *         For example, we will convert &quot;foo/bar_baz%20cheese&quot; </span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+   *         into &quot;foo//bar/_baz/%20cheese&quot; (if the escape char is '/').</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+   */</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  AString escapeStringForLIKE(in AString aValue, in wchar aEscapeChar);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageBindingParams.idl</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,95 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ *</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ *</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ * License.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+ *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ *</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ *</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ *</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+ *</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+interface nsIVariant;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+[scriptable, uuid(a8d4827c-641c-45e3-a9ea-493570b4106b)]</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+interface mozIStorageBindingParams : nsISupports {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  /**</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+   * Binds aValue to the parameter with the name aName.</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+   *</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+   * @param aName</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+   *        The name of the parameter to bind aValue to.</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+   * @param aValue</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+   *        The value to bind.</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+   */</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+   void bindByName(in AUTF8String aName,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+                   in nsIVariant aValue);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+   [noscript] void bindUTF8StringByName(in AUTF8String aName,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+                                        in AUTF8String aValue);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+   [noscript] void bindStringByName(in AUTF8String aName,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+                                    in AString aValue);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+   [noscript] void bindDoubleByName(in AUTF8String aName,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+                                    in double aValue);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+   [noscript] void bindInt32ByName(in AUTF8String aName,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+                                   in long aValue);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+   [noscript] void bindInt64ByName(in AUTF8String aName,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+                                   in long long aValue);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+   [noscript] void bindNullByName(in AUTF8String aName);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+   void bindBlobByName(in AUTF8String aName,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+                       [array, const, size_is(aValueSize)] in octet aValue,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+                       in unsigned long aValueSize);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+   /**</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+    * Binds aValue to the parameter with the index aIndex.</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+    *</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+    * @param aIndex</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    *        The zero-based index of the parameter to bind aValue to.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+    * @param aValue</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    *        The value to bind.</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+    */</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+   void bindByIndex(in unsigned long aIndex,</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+                    in nsIVariant aValue);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+   [noscript] void bindUTF8StringByIndex(in unsigned long aIndex,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+                                         in AUTF8String aValue);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+   [noscript] void bindStringByIndex(in unsigned long aIndex,</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+                                     in AString aValue);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+   [noscript] void bindDoubleByIndex(in unsigned long aIndex,</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+                                     in double aValue);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+   [noscript] void bindInt32ByIndex(in unsigned long aIndex,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                                    in long aValue);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+   [noscript] void bindInt64ByIndex(in unsigned long aIndex,</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+                                    in long long aValue);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+   [noscript] void bindNullByIndex(in unsigned long aIndex);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+   void bindBlobByIndex(in unsigned long aIndex,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+                        [array, const, size_is(aValueSize)] in octet aValue,</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+                        in unsigned long aValueSize);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageBindingParamsArray.idl</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,62 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ *</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ *</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * License.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ *</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ *</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+ *</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+interface mozIStorageBindingParams;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+[scriptable, uuid(e676e1a3-1dc6-4802-ac03-291fa9de7f93)]</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+interface mozIStorageBindingParamsArray : nsISupports {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  /**</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+   * Creates a new mozIStorageBindingParams object that can be added to this</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+   * array.</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+   *</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+   * @returns a mozIStorageBindingParams object that can be used to specify</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+   *          parameters that need to be bound.</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+   */</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  mozIStorageBindingParams newBindingParams();</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  /**</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+   * Adds the parameters to the end of this array.</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+   *</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+   * @param aParameters</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+   *        The parameters to add to this array.</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+   */</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  void addParams(in mozIStorageBindingParams aParameters);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageCompletionCallback.idl</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,48 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+  vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ *</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ *</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * License.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ *</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ *</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ *</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ *</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+ *</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+[scriptable,function, uuid(0bfee0c4-2c24-400e-b18e-b5bb41a032c8)]</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+interface mozIStorageCompletionCallback : nsISupports {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  /**</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+   * Indicates that the event this callback was passed in for has completed.</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+   */</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  void complete();</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageConnection.idl</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,334 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* -*- Mode: idl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ *   Brett Wilson &lt;brettw@gmail.com&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ *</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+ *</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+interface mozIStorageAggregateFunction;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+interface mozIStorageCompletionCallback;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+interface mozIStorageFunction;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+interface mozIStorageProgressHandler;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+interface mozIStorageBaseStatement;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+interface mozIStorageStatement;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+interface mozIStorageAsyncStatement;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+interface mozIStorageStatementCallback;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+interface mozIStoragePendingStatement;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+interface nsIFile;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+/**</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+ * mozIStorageConnection represents a database connection attached to</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+ * a specific file or to the in-memory data storage.  It is the</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+ * primary interface for interacting with a database, including</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+ * creating prepared statements, executing SQL, and examining database</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+ * errors.</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+ *</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+ * @threadsafe</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+ */</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+[scriptable, uuid(32b43ec6-e905-4070-9cfe-370c45f7c1bf)]</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+interface mozIStorageConnection : nsISupports {</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  //// Initialization and status</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  /**</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+   * Closes a database connection.  Callers must finalize all statements created</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+   * for this connection prior to calling this method.  It is illegal to use</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+   * call this method if any asynchronous statements have been executed on this</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+   * connection.</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+   *</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+   * @throws NS_ERROR_UNEXPECTED</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+   *         If any statement has been executed asynchronously on this object.</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+   * @throws NS_ERROR_UNEXPECTED</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+   *         If is called on a thread other than the one that opened it.</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+   */</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  void close();</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  /**</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+   * Asynchronously closes a database connection, allowing all pending</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+   * asynchronous statements to complete first.</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+   *</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+   * @param aCallback [optional]</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+   *        A callback that will be notified when the close is completed.</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+   *</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+   * @throws NS_ERROR_UNEXPECTED</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+   *         If is called on a thread other than the one that opened it.</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+   */</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  void asyncClose([optional] in mozIStorageCompletionCallback aCallback);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  /**</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+   * Indicates if the connection is open and ready to use.  This will be false</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+   * if the connection failed to open, or it has been closed.</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+   */</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  readonly attribute boolean connectionReady;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  /**</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+   * The current database nsIFile.  Null if the database</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+   * connection refers to an in-memory database.</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+   */</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+  readonly attribute nsIFile databaseFile;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  /**</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+   * lastInsertRowID returns the row ID from the last INSERT</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+   * operation.</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+   */</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  readonly attribute long long lastInsertRowID;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  /**</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+   * The last error SQLite error code.</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+   */</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  readonly attribute long lastError;</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  /**</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+   * The last SQLite error as a string (in english, straight from the</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+   * sqlite library).</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+   */</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  readonly attribute AUTF8String lastErrorString;</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  /**</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+   * The schema version of the database.  This should not be used until the </span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+   * database is ready.  The schema will be reported as zero if it is not set.</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+   */</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  attribute long schemaVersion;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  //// Statement creation</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+  /**</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+   * Create a mozIStorageStatement for the given SQL expression.  The</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+   * expression may use ? to indicate sequential numbered arguments,</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+   * ?1, ?2 etc. to indicate specific numbered arguments or :name and </span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+   * $var to indicate named arguments.</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+   *</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+   * @param aSQLStatement</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+   *        The SQL statement to execute.</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+   * @return a new mozIStorageStatement</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+   */</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+  mozIStorageStatement createStatement(in AUTF8String aSQLStatement);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  /**</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+   * Create an asynchronous statement (mozIStorageAsyncStatement) for the given</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+   * SQL expression.  An asynchronous statement can only be used to dispatch</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+   * asynchronous requests to the asynchronous execution thread and cannot be</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+   * used to take any synchronous actions on the database.</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+   *</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+   * The expression may use ? to indicate sequential numbered arguments,</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+   * ?1, ?2 etc. to indicate specific numbered arguments or :name and</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+   * $var to indicate named arguments.</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+   *</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+   * @param aSQLStatement</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+   *        The SQL statement to execute.</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+   * @return a new mozIStorageAsyncStatement</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+   */</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  mozIStorageAsyncStatement createAsyncStatement(in AUTF8String aSQLStatement);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+  /**</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+   * Execute a SQL expression, expecting no arguments.</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+   *</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+   * @param aSQLStatement  The SQL statement to execute</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+   */</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  void executeSimpleSQL(in AUTF8String aSQLStatement);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+  /**</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+   * Execute an array of queries created with this connection asynchronously</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+   * using any currently bound parameters.  The statements are ran wrapped in a</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+   * transaction.  These statements can be reused immediately, and reset does</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+   * not need to be called.</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+   *</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+   * Note:  If you have any custom defined functions, they must be re-entrant</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+   *        since they can be called on multiple threads.</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+   *</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+   * @param aStatements</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+   *        The array of statements to execute asynchronously, in the order they</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+   *        are given in the array.</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+   * @param aNumStatements</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+   *        The number of statements in aStatements.</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+   * @param aCallback [optional]</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+   *        The callback object that will be notified of progress, errors, and</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+   *        completion.</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+   * @return an object that can be used to cancel the statements execution.</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+   */</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+  mozIStoragePendingStatement executeAsync(</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    [array, size_is(aNumStatements)] in mozIStorageBaseStatement aStatements,</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    in unsigned long aNumStatements,</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    [optional] in mozIStorageStatementCallback aCallback</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+  );</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+  /**</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+   * Check if the given table exists.</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+   *</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+   * @param aTableName</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+   *        The table to check</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+   * @return TRUE if table exists, FALSE otherwise.</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+   */</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+  boolean tableExists(in AUTF8String aTableName);</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+  /**</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+   * Check if the given index exists.</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+   *</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+   * @param aIndexName   The index to check</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+   * @return TRUE if the index exists, FALSE otherwise.</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+   */</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+  boolean indexExists(in AUTF8String aIndexName);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+  //// Transactions</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  /**</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+   * Returns true if a transaction is active on this connection.</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+   */</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+  readonly attribute boolean transactionInProgress;</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+  /**</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+   * Begin a new transaction.  sqlite default transactions are deferred.</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+   * If a transaction is active, throws an error.</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+   */</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+  void beginTransaction();</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+  /**</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+   * Begins a new transaction with the given type.</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+   */</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+  const PRInt32 TRANSACTION_DEFERRED = 0;</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  const PRInt32 TRANSACTION_IMMEDIATE = 1;</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+  const PRInt32 TRANSACTION_EXCLUSIVE = 2;</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+  void beginTransactionAs(in PRInt32 transactionType);</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+  /**</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+   * Commits the current transaction.  If no transaction is active,</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+   * @throws NS_ERROR_STORAGE_NO_TRANSACTION.</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+   */</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+  void commitTransaction();</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+  /**</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+   * Rolls back the current transaction.  If no transaction is active,</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+   * @throws NS_ERROR_STORAGE_NO_TRANSACTION.</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+   */</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+  void rollbackTransaction();</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+  //// Tables</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+  /**</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+   * Create the table with the given name and schema.</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+   *</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+   * If the table already exists, NS_ERROR_FAILURE is thrown.</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+   * (XXX at some point in the future it will check if the schema is</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+   * the same as what is specified, but that doesn't happen currently.)</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+   *</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+   * @param aTableName</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+   *        The table name to be created, consisting of [A-Za-z0-9_], and</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+   *        beginning with a letter.</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+   * @param aTableSchema</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+   *        The schema of the table; what would normally go between the parens</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+   *        in a CREATE TABLE statement: e.g., &quot;foo  INTEGER, bar STRING&quot;.</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+   *</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+   * @throws NS_ERROR_FAILURE if the table already exists or could not be</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+   *         created for any other reason.</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+   */</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+  void createTable(in string aTableName,</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+                   in string aTableSchema);</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+  //// Functions</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+  /**</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+   * Create a new SQL function.  If you use your connection on multiple threads,</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+   * your function needs to be threadsafe, or it should only be called on one</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+   * thread.</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+   *</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+   * @param aFunctionName</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+   *        The name of function to create, as seen in SQL.</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+   * @param aNumArguments</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+   *        The number of arguments the function takes. Pass -1 for</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+   *        variable-argument functions.</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+   * @param aFunction</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+   *        The instance of mozIStorageFunction, which implements the function</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+   *        in question.</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+   */</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+  void createFunction(in AUTF8String aFunctionName,</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+                      in long aNumArguments,</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+                      in mozIStorageFunction aFunction);</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+  /**</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+   * Create a new SQL aggregate function.  If you use your connection on</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+   * multiple threads, your function needs to be threadsafe, or it should only</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+   * be called on one thread.</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+   *</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+   * @param aFunctionName</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+   *        The name of aggregate function to create, as seen in SQL.</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+   * @param aNumArguments</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+   *        The number of arguments the function takes. Pass -1 for</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+   *        variable-argument functions.</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+   * @param aFunction</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+   *        The instance of mozIStorageAggreagteFunction, which implements the</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+   *        function in question.</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+   */</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+  void createAggregateFunction(in AUTF8String aFunctionName,</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+                               in long aNumArguments,</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+                               in mozIStorageAggregateFunction aFunction);</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+  /**</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+   * Delete custom SQL function (simple or aggregate one).</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+   *</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+   * @param aFunctionName</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+   *        The name of function to remove.</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+   */</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+  void removeFunction(in AUTF8String aFunctionName);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+  /**</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+   * Sets a progress handler. Only one handler can be registered at a time.</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+   * If you need more than one, you need to chain them yourself.  This progress</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+   * handler should be threadsafe if you use this connection object on more than</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+   * one thread.</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+   *</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+   * @param aGranularity</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+   *        The number of SQL virtual machine steps between progress handler</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+   *        callbacks.</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+   * @param aHandler</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+   *        The instance of mozIStorageProgressHandler.</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+   * @return previous registered handler.</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+   */</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+  mozIStorageProgressHandler setProgressHandler(in PRInt32 aGranularity,</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+                                                in mozIStorageProgressHandler aHandler);</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+  /**</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+   * Remove a progress handler.</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+   *</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+   * @return previous registered handler.</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+   */</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+  mozIStorageProgressHandler removeProgressHandler();</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageError.idl</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,182 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab </span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ *</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ *</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * License.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ *</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ *</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+ *</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+%{C++</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+#ifdef ERROR</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+#undef ERROR</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+#endif</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+%}</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+[scriptable, uuid(1f350f96-7023-434a-8864-40a1c493aac1)]</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+interface mozIStorageError : nsISupports {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  /**</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+   * General SQL error or missing database.</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+   */</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  const long ERROR = 1;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+  /**</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+   * Internal logic error.</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+   */</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  const long INTERNAL = 2;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  /**</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+   * Access permission denied.</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+   */</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  const long PERM = 3;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  /**</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+   * A callback routine requested an abort.</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+   */</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  const long ABORT = 4;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  /**</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+   * The database file is locked.</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+   */</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+  const long BUSY = 5;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  /**</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+   * A table in the database is locked.</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+   */</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  const long LOCKED = 6;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  /**</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+   * An allocation failed.</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+   */</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+  const long NOMEM = 7;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+  /**</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+   * Attempt to write to a readonly database.</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+   */</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+  const long READONLY = 8;</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+  /**</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+   * Operation was terminated by an interrupt.</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+   */</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+  const long INTERRUPT = 9;</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  /**</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+   * Some kind of disk I/O error occurred.</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+   */</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  const long IOERR = 10;</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  /**</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+   * The database disk image is malformed.</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+   */</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+  const long CORRUPT = 11;</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+  /**</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+   * An insertion failed because the database is full.</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+   */</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+  const long FULL = 13;</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+  /**</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+   * Unable to open the database file.</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+   */</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  const long CANTOPEN = 14;</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  /**</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+   * The database is empty.</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+   */</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+  const long EMPTY = 16;</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+  /**</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+   * The database scheme changed.</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+   */</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  const long SCHEMA = 17;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+  /**</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+   * A string or blob exceeds the size limit.</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+   */</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+  const long TOOBIG = 18;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+  /**</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+   * Abort due to a constraint violation.</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+   */</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  const long CONSTRAINT = 19;</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  /**</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+   * Data type mismatch.</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+   */</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+  const long MISMATCH = 20;</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+  /**</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+   * Library used incorrectly.</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+   */</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  const long MISUSE = 21;</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+  /**</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+   * Uses OS features not supported on the host system.</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+   */</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+  const long NOLFS = 22;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+  /**</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+   * Authorization denied.</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+   */</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  const long AUTH = 23;</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  /**</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+   * Auxiliary database format error.</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+   */</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+  const long FORMAT = 24;</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+  /**</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+   * Attempt to bind a parameter using an out-of-range index or nonexistent</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+   * named parameter name.</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+   */</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+  const long RANGE = 25;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  /**</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+   * File opened that is not a database file.</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+   */</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+  const long NOTADB = 26;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+  /**</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+   * Indicates what type of error occurred.</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+   */</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+  readonly attribute long result;</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  /**</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+   * An error string the gives more details, if available.</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+   */</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  readonly attribute AUTF8String message;</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageFunction.idl</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ *</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ *</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ * License.</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ *</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ *</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ *</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ *</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+ *</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+#include &quot;mozIStorageValueArray.idl&quot;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+interface mozIStorageConnection;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+interface nsIArray;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+interface nsIVariant;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+/**</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ * mozIStorageFunction is to be implemented by storage consumers that</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ * wish to receive callbacks during the request execution.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ *</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+ * SQL can apply functions to values from tables. Examples of</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+ * such functions are MIN(a1,a2) or SQRT(num). Many functions are</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+ * implemented in SQL engine.</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+ *</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+ * This interface allows consumers to implement their own,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+ * problem-specific functions.</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+ * These functions can be called from triggers, too.</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+ *</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+ */</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+[scriptable, function, uuid(9ff02465-21cb-49f3-b975-7d5b38ceec73)]</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+interface mozIStorageFunction : nsISupports {</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  /**</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+   * onFunctionCall is called when execution of a custom</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+   * function should occur.</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+   * </span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+   * @param aNumArguments         The number of arguments</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+   * @param aFunctionArguments    The arguments passed in to the function</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+   *</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+   * @returns any value as Variant type.</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+   */</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  nsIVariant onFunctionCall(in mozIStorageValueArray aFunctionArguments);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/storage-backport/public/mozIStoragePendingStatement.idl</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,53 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab </span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ *</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ *</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * License.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ *</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ *</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+ *</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+[scriptable, uuid(00da7d20-3768-4398-bedc-e310c324b3f0)]</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+interface mozIStoragePendingStatement : nsISupports {</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  /**</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+   * Cancels a pending statement, if possible.  This will only fail if you try</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+   * cancel more than once.</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+   *</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+   * @note For read statements (such as SELECT), you will no longer receive any</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+   *       notifications about results once cancel is called.</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+   */</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+   void cancel();</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageProgressHandler.idl</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,58 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ *</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ *</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ * License.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ *</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ * The Original Code is Storage Code.</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ *</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ *</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+ *</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ *</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+interface mozIStorageConnection;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+/**</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+ * mozIProgressHandler is to be implemented by storage consumers that</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+ * wish to receive callbacks during the request execution.</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+ */</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+[scriptable, uuid(a3a6fcd4-bf89-4208-a837-bf2a73afd30c)]</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+interface mozIStorageProgressHandler : nsISupports {</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  /**</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+   * onProgress is invoked periodically during long running calls.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+   * </span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+   * @param aConnection    connection, for which progress handler is</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+   *                       invoked.</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+   *</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+   * @return true to abort request, false to continue work.</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+   */</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  boolean onProgress(in mozIStorageConnection aConnection);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageResultSet.idl</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab </span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ *</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ *</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * License.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ *</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ *</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ *</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+ *</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+interface mozIStorageRow;</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+[scriptable, uuid(18dd7953-076d-4598-8105-3e32ad26ab24)]</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+interface mozIStorageResultSet : nsISupports {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  /**</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+   * Obtains the next row from the result set from the statement that was</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+   * executed.</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+   *</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+   * @returns the next row from the result set.  This will be null when there</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+   *          are no more results.</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+   */</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+  mozIStorageRow getNextRow();</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageRow.idl</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab </span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ *</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ *</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ * License.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ *</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ *</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ *</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+ *</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+#include &quot;mozIStorageValueArray.idl&quot;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+interface nsIVariant;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+[scriptable, uuid(62d1b6bd-cbfe-4f9b-aee1-0ead4af4e6dc)]</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+interface mozIStorageRow : mozIStorageValueArray {</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  /**</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+   * Obtains the result of a given column specified by aIndex.</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+   *</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+   * @param aIndex</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+   *        Zero-based index of the result to get from the tuple.</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+   * @returns the result of the specified column.</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+   */</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  nsIVariant getResultByIndex(in unsigned long aIndex);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  /**</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+   * Obtains the result of a given column specified by aIndex.</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+   *</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+   * @param aName</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+   *        Name of the result to get from the tuple.</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+   * @returns the result of the specified column.</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+   */</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  nsIVariant getResultByName(in AUTF8String aName);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageService.idl</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,172 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* -*- Mode: idl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+ *</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+ *</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+ * License.</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+ *</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+ *</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+ *</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+ *</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+ *</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+interface mozIStorageConnection;</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+interface nsIFile;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+/**</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+ * The mozIStorageService interface is intended to be implemented by</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+ * a service that can create storage connections (mozIStorageConnection)</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+ * to either a well-known profile database or to a specific database file.</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+ *</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+ * This is the only way to open a database connection.</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+ */</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+[scriptable, uuid(fe8e95cb-b377-4c8d-bccb-d9198c67542b)]</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+interface mozIStorageService : nsISupports {</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+  /**</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+   * Get a connection to a named special database storage.</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+   *</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+   * @param aStorageKey a string key identifying the type of storage</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+   * requested.  Valid values include: &quot;profile&quot;, &quot;memory&quot;.</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+   *</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+   * @see openDatabase for restrictions on how database connections may be</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+   * used. For the profile database, you should only access it from the main</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+   * thread since other callers may also have connections.</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+   *</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+   * @returns a new mozIStorageConnection for the requested</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+   * storage database.</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+   *</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+   * @throws NS_ERROR_INVALID_ARG if aStorageKey is invalid.</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+   */</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  mozIStorageConnection openSpecialDatabase(in string aStorageKey);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  /**</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+   * Open a connection to the specified file.</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+   *</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+   * Consumers should check mozIStorageConnection::connectionReady to ensure</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+   * that they can use the database.  If this value is false, it is strongly</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+   * recommended that the database be backed up with</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+   * mozIStorageConnection::backupDB so user data is not lost.</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+   *</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+   * ==========</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+   *   DANGER</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+   * ==========</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+   *</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+   * If you have more than one connection to a file, you MUST use the EXACT</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+   * SAME NAME for the file each time, including case. The sqlite code uses</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+   * a simple string compare to see if there is already a connection. Opening</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+   * a connection to &quot;Foo.sqlite&quot; and &quot;foo.sqlite&quot; will CORRUPT YOUR DATABASE.</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+   *</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+   * The connection object returned by this function is not threadsafe. You must</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+   * use it only from the thread you created it from.</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+   *</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+   * If your database contains virtual tables (f.e. for full-text indexes), you</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+   * must open it with openUnsharedDatabase, as those tables are incompatible</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+   * with a shared cache.  If you attempt to use this method to open a database</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+   * containing virtual tables, it will think the database is corrupted and</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+   * throw NS_ERROR_FILE_CORRUPTED.</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+   *</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+   * @param aDatabaseFile</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+   *        A nsIFile that represents the database that is to be opened..</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+   *</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+   * @returns a mozIStorageConnection for the requested database file.</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+   *</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+   * @throws NS_ERROR_OUT_OF_MEMORY</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+   *         If allocating a new storage object fails.</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+   * @throws NS_ERROR_FILE_CORRUPTED</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+   *         If the database file is corrupted.</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+   */</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  mozIStorageConnection openDatabase(in nsIFile aDatabaseFile);</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+  /**</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+   * Open a connection to the specified file that doesn't share a sqlite cache.</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+   *</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+   * Each connection uses its own sqlite cache, which is inefficient, so you</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+   * should use openDatabase instead of this method unless you need a feature</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+   * of SQLite that is incompatible with a shared cache, like virtual table</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+   * and full text indexing support.</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+   *</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+   * Consumers should check mozIStorageConnection::connectionReady to ensure</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+   * that they can use the database.  If this value is false, it is strongly</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+   * recommended that the database be backed up with</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+   * mozIStorageConnection::backupDB so user data is not lost.</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+   *</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+   * ==========</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+   *   DANGER</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+   * ==========</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+   *</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+   * If you have more than one connection to a file, you MUST use the EXACT</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+   * SAME NAME for the file each time, including case. The sqlite code uses</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+   * a simple string compare to see if there is already a connection. Opening</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+   * a connection to &quot;Foo.sqlite&quot; and &quot;foo.sqlite&quot; will CORRUPT YOUR DATABASE.</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+   *</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+   * The connection object returned by this function is not threadsafe. You must</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+   * use it only from the thread you created it from.</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+   *</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+   * @param aDatabaseFile</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+   *        A nsIFile that represents the database that is to be opened..</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+   *</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+   * @returns a mozIStorageConnection for the requested database file.</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+   *</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+   * @throws NS_ERROR_OUT_OF_MEMORY</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+   *         If allocating a new storage object fails.</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+   * @throws NS_ERROR_FILE_CORRUPTED</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+   *         If the database file is corrupted.</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+   */</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+  mozIStorageConnection openUnsharedDatabase(in nsIFile aDatabaseFile);</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+  /*</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+   * Utilities</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+   */</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+  /**</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+   * Copies the specified database file to the specified parent directory with</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+   * the specified file name.  If the parent directory is not specified, it</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+   * places the backup in the same directory as the current file.  This function</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+   * ensures that the file being created is unique.</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+   *</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+   * @param aDBFile</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+   *        The database file that will be backed up.</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+   * @param aBackupFileName</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+   *        The name of the new backup file to create.</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+   * @param [optional] aBackupParentDirectory</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+   *        The directory you'd like the backup file to be placed.</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+   * @return The nsIFile representing the backup file.</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+   */</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+  nsIFile backupDatabaseFile(in nsIFile aDBFile, in AString aBackupFileName,</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+                             [optional] in nsIFile aBackupParentDirectory);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+};</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+%{C++</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+#define MOZ_STORAGE_MEMORY_STORAGE_KEY    &quot;memory&quot;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+#define MOZ_STORAGE_PROFILE_STORAGE_KEY   &quot;profile&quot;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageStatement.idl</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,309 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+ *</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+ *</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+ * License.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+ *</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+ *</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ *</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+ *</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+ *</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+#include &quot;mozIStorageBaseStatement.idl&quot;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+[ptr] native octetPtr(PRUint8);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+/**</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+ * A SQL statement that can be used for both synchronous and asynchronous</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+ * purposes.</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+ */</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+[scriptable, uuid(57ec7be1-36cf-4510-b938-7d1c9ee8cec5)]</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+interface mozIStorageStatement : mozIStorageBaseStatement {</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  /**</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+   * Create a clone of this statement, by initializing a new statement</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+   * with the same connection and same SQL statement as this one.  It</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+   * does not preserve statement state; that is, if a statement is</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+   * being executed when it is cloned, the new statement will not be</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+   * executing.</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+   */</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  mozIStorageStatement clone();</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  /*</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+   * Number of parameters</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+   */</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  readonly attribute unsigned long parameterCount;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  /**</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+   * Name of nth parameter, if given</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+   */</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  AUTF8String getParameterName(in unsigned long aParamIndex);</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  /**</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+   * Returns the index of the named parameter.</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+   *</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+   * @param aName</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+   *        The name of the parameter you want the index for.  This does not</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+   *        include the leading ':'.</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+   * @return the index of the named parameter.</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+   */</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+  unsigned long getParameterIndex(in AUTF8String aName);</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  /**</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+   * Number of columns returned</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+   */</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+  readonly attribute unsigned long columnCount;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  /**</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+   * Name of nth column</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+   */</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+  AUTF8String getColumnName(in unsigned long aColumnIndex);</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+  /**</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+   * Obtains the index of the column with the specified name.</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+   *</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+   * @param aName</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+   *        The name of the column.</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+   * @return The index of the column with the specified name.</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+   */</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+  unsigned long getColumnIndex(in AUTF8String aName);</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  /**</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+   * Obtains the declared column type of a prepared statement.</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+   *</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+   * @param aParamIndex</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+   *        The zero-based index of the column who's declared type we are</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+   *        interested in.</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+   * @return the declared index type.</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+   */</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+  AUTF8String getColumnDecltype(in unsigned long aParamIndex);</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+  /**</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+   * Reset parameters/statement execution</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+   */</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+  void reset();</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+  /**</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+   * Execute the query, ignoring any results.  This is accomplished by</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+   * calling executeStep() once, and then calling reset().</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+   *</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+   * Error and last insert info, etc. are available from</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+   * the mozStorageConnection.</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+   */</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  void execute();</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  /**</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+   * Execute a query, using any currently-bound parameters.  Reset</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+   * must be called on the statement after the last call of</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+   * executeStep.</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+   *</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+   * @return a boolean indicating whether there are more rows or not;</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+   *         row data may be accessed using mozIStorageValueArray methods on</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+   *         the statement.</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+   */</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+  boolean executeStep();</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+  /**</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+   * Execute a query, using any currently-bound parameters.  Reset is called</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+   * when no more data is returned.  This method is only available to JavaScript</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+   * consumers.</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+   *</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+   * @deprecated As of Mozilla 1.9.2 in favor of executeStep().</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+   *</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+   * @return a boolean indicating whether there are more rows or not.</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+   *</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+   * [deprecated] boolean step();</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+   */</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+  /**</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+   * Obtains the current list of named parameters, which are settable.  This</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+   * property is only available to JavaScript consumers.</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+   *</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+   * readonly attribute mozIStorageStatementParams params;</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+   */</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+  /**</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+   * Obtains the current row, with access to all the data members by name.  This</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+   * property is only available to JavaScript consumers.</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+   *</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+   * readonly attribute mozIStorageStatementRow row;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+   */</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+  //// Copied contents of mozIStorageValueArray</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+  /**</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+   * These type values are returned by getTypeOfIndex</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+   * to indicate what type of value is present at</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+   * a given column.</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+   */</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+  const long VALUE_TYPE_NULL = 0;</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+  const long VALUE_TYPE_INTEGER = 1;</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+  const long VALUE_TYPE_FLOAT = 2;</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+  const long VALUE_TYPE_TEXT = 3;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+  const long VALUE_TYPE_BLOB = 4;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+  /**</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+   * The number of entries in the array (each corresponding to a column in the</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+   * database row)</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+   */</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+  readonly attribute unsigned long numEntries;</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+  /**</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+   * Indicate the data type of the current result row for the the given column.</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+   * SQLite will perform type conversion if you ask for a value as a different</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+   * type than it is stored as.</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+   *</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+   *        0-based column index.</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+   * @return The type of the value at the given column index; one of</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+   *         VALUE_TYPE_NULL, VALUE_TYPE_INTEGER, VALUE_TYPE_FLOAT,</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+   *         VALUE_TYPE_TEXT, VALUE_TYPE_BLOB.</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+   */</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+  long getTypeOfIndex(in unsigned long aIndex);</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+  /**</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+   * Retrieve the contents of a column from the current result row as an</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+   * integer.</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+   *</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineplus">+   *        0-based colummn index.</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+   * @return Column value interpreted as an integer per type conversion rules.</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+   * @{</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineplus">+   */</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+  long getInt32(in unsigned long aIndex);</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+  long long getInt64(in unsigned long aIndex);</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+  /** @} */</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+  /**</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+   * Retrieve the contents of a column from the current result row as a</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineplus">+   * floating point double.</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+   *</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineplus">+   *        0-based colummn index.</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineplus">+   * @return Column value interpreted as a double per type conversion rules.</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+   */</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+  double getDouble(in unsigned long aIndex);</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineplus">+  /**</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+   * Retrieve the contents of a column from the current result row as a</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+   * string.</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+   *</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+   *        0-based colummn index.</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+   * @return The value for the result column interpreted as a string.  If the</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+   *         stored value was NULL, you will get an empty string with IsVoid set</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+   *         to distinguish it from an explicitly set empty string.</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+   * @{</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+   */</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+  AUTF8String getUTF8String(in unsigned long aIndex);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+  AString getString(in unsigned long aIndex);</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+  /** @} */</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+  /**</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+   * Retrieve the contents of a column from the current result row as a</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+   * blob.</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+   *</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+   *        0-based colummn index.</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+   * @param[out] aDataSize</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+   *             The number of bytes in the blob.</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+   * @param[out] aData</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+   *             The contents of the BLOB.  This will be NULL if aDataSize == 0.</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+   */</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+  void getBlob(in unsigned long aIndex, out unsigned long aDataSize, [array,size_is(aDataSize)] out octet aData);</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+  /**</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+   * Check whether the given column in the current result row is NULL.</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+   *</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineplus">+   * @param aIndex</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+   *        0-based colummn index.</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+   * @return true if the value for the result column is null.</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+   */</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+  boolean getIsNull(in unsigned long aIndex);</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+  /**</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+   * Returns a shared string pointer</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+   */</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+  [noscript] void getSharedUTF8String(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out string aResult);</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+  [noscript] void getSharedString(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out wstring aResult);</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+  [noscript] void getSharedBlob(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out octetPtr aResult);</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+%{C++</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+  /**</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+   * Getters for native code that return their values as</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+   * the return type, for convenience and sanity.</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+   *</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineplus">+   * Not virtual; no vtable bloat.</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+   */</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+  inline PRInt32 AsInt32(PRUint32 idx) {</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+    PRInt32 v;</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+    GetInt32(idx, &amp;v);</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineplus">+    return v;</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+  }</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineplus">+  inline PRInt64 AsInt64(PRUint32 idx) {</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineplus">+    PRInt64 v;</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+    GetInt64(idx, &amp;v);</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+    return v;</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+  }</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+  inline double AsDouble(PRUint32 idx) {</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+    double v;</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+    GetDouble(idx, &amp;v);</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+    return v;</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+  }</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+  inline const char* AsSharedUTF8String(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineplus">+    const char *str = nsnull;</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineplus">+    GetSharedUTF8String(idx, len, &amp;str);</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineplus">+    return str;</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineplus">+  }</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineplus">+</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+  inline const PRUnichar* AsSharedWString(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+    const PRUnichar *str = nsnull;</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+    GetSharedString(idx, len, &amp;str);</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+    return str;</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+  }</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+  inline const PRUint8* AsSharedBlob(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+    const PRUint8 *blob = nsnull;</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineplus">+    GetSharedBlob(idx, len, &amp;blob);</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineplus">+    return blob;</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+  }</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineplus">+  inline PRBool IsNull(PRUint32 idx) {</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+    PRBool b = PR_FALSE;</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+    GetIsNull(idx, &amp;b);</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineplus">+    return b;</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+  }</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineplus">+%}</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageStatementCallback.idl</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab </span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+ *</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+ *</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+ * License.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+ *</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+ *</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+ *</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+ *</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+ *</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+interface mozIStorageResultSet;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+interface mozIStorageError;</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+[scriptable, uuid(29383d00-d8c4-4ddd-9f8b-c2feb0f2fcfa)]</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+interface mozIStorageStatementCallback : nsISupports {</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+  /**</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+   * Called when some result is obtained from the database.  This function can</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+   * be called more than once with a different storageIResultSet each time for</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+   * any given asynchronous statement.</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+   *</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+   * @param aResultSet</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+   *        The result set containing the data from the database.</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+   */</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  void handleResult(in mozIStorageResultSet aResultSet);</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+  /**</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+   * Called when some error occurs while executing the statement.  This function</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+   * may be called more than once with a different storageIError each time for</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+   * any given asynchronous statement.</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+   *</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+   * @param aError</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+   *        An object containing information about the error.</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+   */</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+  void handleError(in mozIStorageError aError);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  /**</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+   * Called when the statement has finished executing.  This function will only</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+   * be called once for any given asynchronous statement.</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+   *</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+   * @param aReason</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+   *        Indicates if the statement is no longer executing because it either</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+   *        finished (REASON_FINISHED), was canceled (REASON_CANCELED), or</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+   *        a fatal error occurred (REASON_ERROR).</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+   */</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+  const unsigned short REASON_FINISHED = 0;</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+  const unsigned short REASON_CANCELED = 1;</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+  const unsigned short REASON_ERROR = 2;</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+  void handleCompletion(in unsigned short aReason);</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageStatementWrapper.idl</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,88 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+ *</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+ *</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+ * License.</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ *</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+ *</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+ *</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ *</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+ *</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+#include &quot;mozIStorageStatement.idl&quot;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+[scriptable, uuid(02eeaf95-c3db-4182-9340-222c29f68f02)]</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+interface mozIStorageStatementRow : nsISupports {</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+  // magic interface we return that implements nsIXPCScriptable, to allow</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  // for by-name access to rows</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+};</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+[scriptable, uuid(e65fe6e2-2643-463c-97e2-27665efe2386)]</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+interface mozIStorageStatementParams : nsISupports {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  // magic interface for parameter setting that implements nsIXPCScriptable.</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+};</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+/**</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+ * @deprecated As of Mozilla 1.9.2.  Methods are already provided on</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+ *             mozIStorageStatement.</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+ */</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+[scriptable, deprecated, uuid(eee6f7c9-5586-4eaf-b35c-dca987c4ffd1)]</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+interface mozIStorageStatementWrapper : nsISupports {</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  /**</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+   * Initialize this wrapper with aStatement.</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+   */</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+  void initialize(in mozIStorageStatement aStatement);</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+  /**</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+   * The statement that is wrapped.</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+   */</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+  readonly attribute mozIStorageStatement statement;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+  /**</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+   * Step, reset, and execute the wrapped statement.</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+   */</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+  void reset();</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+  [deprecated] boolean step();</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  void execute();</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+  /**</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+   * The current row.  Throws an exception if no row is currently</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+   * available.  Useful only from script.  The value of this is only</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+   * valid while the statement is still executing, and is still on the</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+   * appropriate row.</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+   */</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+  readonly attribute mozIStorageStatementRow row;</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+  /**</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+   * The parameters; these can be set in lieu of using the call</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+   * notation on this.</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+   */</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+  readonly attribute mozIStorageStatementParams params;</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/storage-backport/public/mozIStorageValueArray.idl</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,156 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+ *</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+ *</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+ * License.</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+ *</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+ *</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+ *</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+ *</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+ *</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+[ptr] native octetPtr(PRUint8);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+/**</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+ * mozIStorageValueArray wraps an array of SQL values, such as a single database</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+ * row.</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+ */</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+[scriptable, uuid(07b5b93e-113c-4150-863c-d247b003a55d)]</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+interface mozIStorageValueArray : nsISupports {</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  /**</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+   * These type values are returned by getTypeOfIndex</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+   * to indicate what type of value is present at</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+   * a given column.</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+   */</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+  const long VALUE_TYPE_NULL = 0;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  const long VALUE_TYPE_INTEGER = 1;</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  const long VALUE_TYPE_FLOAT = 2;</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  const long VALUE_TYPE_TEXT = 3;</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+  const long VALUE_TYPE_BLOB = 4;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+  /**</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+   * numEntries</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+   *</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+   * number of entries in the array (each corresponding to a column</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+   * in the database row)</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+   */</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+  readonly attribute unsigned long numEntries;</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+  /**</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+   * Returns the type of the value at the given column index;</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+   * one of VALUE_TYPE_NULL, VALUE_TYPE_INTEGER, VALUE_TYPE_FLOAT,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+   * VALUE_TYPE_TEXT, VALUE_TYPE_BLOB.</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+   */</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+  long getTypeOfIndex(in unsigned long aIndex);</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+  /**</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+   * Obtain a value for the given entry (column) index.</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+   * Due to SQLite's type conversion rules, any of these are valid</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+   * for any column regardless of the column's data type.  However,</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+   * if the specific type matters, getTypeOfIndex should be used</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+   * first to identify the column type, and then the appropriate</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+   * get method should be called.</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+   *</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+   * If you ask for a string value for a NULL column, you will get an empty</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+   * string with IsVoid set to distinguish it from an explicitly set empty</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+   * string.</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+   */</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+  long getInt32(in unsigned long aIndex);</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+  long long getInt64(in unsigned long aIndex);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  double getDouble(in unsigned long aIndex);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+  AUTF8String getUTF8String(in unsigned long aIndex);</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+  AString getString(in unsigned long aIndex);</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  // data will be NULL if dataSize = 0</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+  void getBlob(in unsigned long aIndex, out unsigned long aDataSize, [array,size_is(aDataSize)] out octet aData);</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+  boolean getIsNull(in unsigned long aIndex);</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+  /**</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+   * Returns a shared string pointer</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+   */</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+  [noscript] void getSharedUTF8String(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out string aResult);</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+  [noscript] void getSharedString(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out wstring aResult);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+  [noscript] void getSharedBlob(in unsigned long aIndex, out unsigned long aLength, [shared,retval] out octetPtr aResult);</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+%{C++</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+  /**</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+   * Getters for native code that return their values as</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+   * the return type, for convenience and sanity.</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+   *</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+   * Not virtual; no vtable bloat.</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+   */</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+  inline PRInt32 AsInt32(PRUint32 idx) {</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+    PRInt32 v;</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+    GetInt32(idx, &amp;v);</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+    return v;</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+  }</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+  inline PRInt64 AsInt64(PRUint32 idx) {</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+    PRInt64 v;</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    GetInt64(idx, &amp;v);</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+    return v;</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+  }</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+  inline double AsDouble(PRUint32 idx) {</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+    double v;</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineplus">+    GetDouble(idx, &amp;v);</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+    return v;</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+  }</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+  inline const char* AsSharedUTF8String(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+    const char *str = nsnull;</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+    GetSharedUTF8String(idx, len, &amp;str);</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+    return str;</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+  }</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+  inline const PRUnichar* AsSharedWString(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+    const PRUnichar *str = nsnull;</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+    GetSharedString(idx, len, &amp;str);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+    return str;</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+  }</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+  inline const PRUint8* AsSharedBlob(PRUint32 idx, PRUint32 *len) {</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineplus">+    const PRUint8 *blob = nsnull;</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+    GetSharedBlob(idx, len, &amp;blob);</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+    return blob;</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+  }</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineplus">+  inline PRBool IsNull(PRUint32 idx) {</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+    PRBool b = PR_FALSE;</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+    GetIsNull(idx, &amp;b);</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+    return b;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+  }</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+%}</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/storage-backport/public/mozStorage.h</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,48 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+ *</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+ *</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+ * License.</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+ *</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+ *</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+ *</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+ *</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+ *</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+#ifndef _MOZSTORAGE_H_</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+#define _MOZSTORAGE_H_</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+#define NS_ERROR_STORAGE_BUSY \</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+  NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_STORAGE, 1)</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+#define NS_ERROR_STORAGE_IOERR \</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+  NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODULE_STORAGE, 2)</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+#endif /* _MOZSTORAGE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/storage-backport/public/mozStorageHelper.h</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,195 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+ *</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+ *</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+ * License.</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+ *</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+ * The Original Code is Storage code</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+ *</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+ * Google Inc.</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+ *</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+ *   Brett Wilson &lt;brettw@gmail.com&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+ *</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+ *</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+#ifndef _MOZSTORAGEHELPER_H_</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+#define _MOZSTORAGEHELPER_H_</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+#include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+#include &quot;mozStorage.h&quot;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+/**</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+ * This class wraps a transaction inside a given C++ scope, guaranteeing that</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+ * the transaction will be completed even if you have an exception or</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+ * return early.</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+ *</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+ * aCommitOnComplete controls whether the transaction is committed or rolled</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+ * back when it goes out of scope. A common use is to create an instance with</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+ * commitOnComplete = FALSE (rollback), then call Commit on this object manually</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+ * when your function completes successfully.</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+ *</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+ * Note that nested transactions are not supported by sqlite, so if a transaction</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+ * is already in progress, this object does nothing. Note that in this case,</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+ * you may not get the transaction type you ask for, and you won't be able</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+ * to rollback.</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+ */</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+class mozStorageTransaction</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+{</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+public:</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+  mozStorageTransaction(mozIStorageConnection* aConnection,</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+                        PRBool aCommitOnComplete,</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+                        PRInt32 aType = mozIStorageConnection::TRANSACTION_DEFERRED)</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+    : mConnection(aConnection),</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+      mHasTransaction(PR_FALSE),</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+      mCommitOnComplete(aCommitOnComplete),</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+      mCompleted(PR_FALSE)</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+  {</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+    // We won't try to get a transaction if one is already in progress.</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+    if (mConnection)</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+      mHasTransaction = NS_SUCCEEDED(mConnection-&gt;BeginTransactionAs(aType));</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+  }</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+  ~mozStorageTransaction()</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+  {</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+    if (mConnection &amp;&amp; mHasTransaction &amp;&amp; ! mCompleted) {</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+      if (mCommitOnComplete)</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+        mConnection-&gt;CommitTransaction();</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+      else</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+        mConnection-&gt;RollbackTransaction();</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+    }</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+  }</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  /**</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+   * Commits the transaction if one is in progress. If one is not in progress,</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+   * this is a NOP since the actual owner of the transaction outside of our</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+   * scope is in charge of finally comitting or rolling back the transaction.</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+   */</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+  nsresult Commit()</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+  {</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+    if (!mConnection || mCompleted)</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+      return NS_OK; // no connection, or already done</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+    mCompleted = PR_TRUE;</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+    if (! mHasTransaction)</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+      return NS_OK; // transaction not ours, ignore</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+    nsresult rv = mConnection-&gt;CommitTransaction();</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+      mHasTransaction = PR_FALSE;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+    return rv;</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  }</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+  /**</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+   * Rolls back the transaction in progress. You should only call this function</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+   * if this object has a real transaction (HasTransaction() = true) because</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+   * otherwise, there is no transaction to roll back.</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+   */</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+  nsresult Rollback()</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+  {</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+    if (!mConnection || mCompleted)</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+      return NS_OK; // no connection, or already done</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+    mCompleted = PR_TRUE;</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+    if (! mHasTransaction)</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+    // It is possible that a rollback will return busy, so we busy wait...</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+    do {</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+      rv = mConnection-&gt;RollbackTransaction();</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+      if (rv == NS_ERROR_STORAGE_BUSY)</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+        (void)PR_Sleep(PR_INTERVAL_NO_WAIT);</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+    } while (rv == NS_ERROR_STORAGE_BUSY);</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+      mHasTransaction = PR_FALSE;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+    return rv;</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+  }</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+  /**</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+   * Returns whether this object wraps a real transaction. False means that</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+   * this object doesn't do anything because there was already a transaction in</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+   * progress when it was created.</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+   */</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+  PRBool HasTransaction()</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+  {</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+    return mHasTransaction;</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+  }</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+  /**</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+   * This sets the default action (commit or rollback) when this object goes</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineplus">+   * out of scope.</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+   */</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+  void SetDefaultAction(PRBool aCommitOnComplete)</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+  {</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+    mCommitOnComplete = aCommitOnComplete;</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+  }</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+protected:</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; mConnection;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+  PRBool mHasTransaction;</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+  PRBool mCommitOnComplete;</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+  PRBool mCompleted;</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+};</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+/**</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+ * This class wraps a statement so that it is guaraneed to be reset when</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+ * this object goes out of scope.</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+ *</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+ * Note that this always just resets the statement. If the statement doesn't</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+ * need resetting, the reset operation is inexpensive.</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+ */</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineplus">+class NS_STACK_CLASS mozStorageStatementScoper</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+{</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+public:</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineplus">+  mozStorageStatementScoper(mozIStorageStatement* aStatement)</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+      : mStatement(aStatement)</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+  {</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+  }</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+  ~mozStorageStatementScoper()</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+  {</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+    if (mStatement)</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+      mStatement-&gt;Reset();</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+  }</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineplus">+  /**</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineplus">+   * Call this to make the statement not reset. You might do this if you know</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineplus">+   * that the statement has been reset.</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+   */</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+  void Abandon()</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+  {</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+    mStatement = nsnull;</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+  }</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineplus">+protected:</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; mStatement;</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineplus">+};</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineplus">+</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+#endif /* _MOZSTORAGEHELPER_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/storage-backport/public/storage.h</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+ *</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+ *</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+ * License.</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+ *</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+ * The Original Code is Mozilla Storage code.</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+ *</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+ *</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+ *</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+ *</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+#ifndef mozilla_storage_h_</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+#define mozilla_storage_h_</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+//// Public Interfaces</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+#include &quot;mozIStorageAggregateFunction.h&quot;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+#include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+#include &quot;mozIStorageError.h&quot;</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+#include &quot;mozIStorageFunction.h&quot;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+#include &quot;mozIStoragePendingStatement.h&quot;</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+#include &quot;mozIStorageProgressHandler.h&quot;</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+#include &quot;mozIStorageResultSet.h&quot;</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+#include &quot;mozIStorageRow.h&quot;</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+#include &quot;mozIStorageService.h&quot;</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+#include &quot;mozIStorageStatementCallback.h&quot;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+//// Native Language Helpers</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+#include &quot;mozStorageHelper.h&quot;</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+#include &quot;mozStorageCID.h&quot;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+#include &quot;mozilla/storage/Variant.h&quot;</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+#endif // mozilla_storage_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/storage-backport/src/IStorageBindingParamsInternal.h</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,83 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+ *</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+ *</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+ * License.</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+ *</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+ *</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+ *</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+ *</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+ *</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+#ifndef mozilla_storage_IStorageBindingParamsInternal_h_</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+#define mozilla_storage_IStorageBindingParamsInternal_h_</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+class mozIStorageError;</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+namespace storage {</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+#define ISTORAGEBINDINGPARAMSINTERNAL_IID \</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+  {0x4c43d33a, 0xc620, 0x41b8, {0xba, 0x1d, 0x50, 0xc5, 0xb1, 0xe9, 0x1a, 0x04}}</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+/**</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+ * Implementation-only interface for mozIStorageBindingParams.  This defines the</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+ * set of methods required by the asynchronous execution code in order to</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+ * consume the contents stored in mozIStorageBindingParams instances.</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+ */</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+class IStorageBindingParamsInternal : public nsISupports</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+{</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+public:</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+  NS_DECLARE_STATIC_IID_ACCESSOR(ISTORAGEBINDINGPARAMSINTERNAL_IID)</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+  /**</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+   * Binds our stored data to the statement.</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineplus">+   *</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineplus">+   * @param aStatement</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+   *        The statement to bind our data to.</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+   * @return nsnull on success, or a mozIStorageError object if an error</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+   *         occurred.</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+   */</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+  virtual already_AddRefed&lt;mozIStorageError&gt; bind(sqlite3_stmt *aStatement) = 0;</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+};</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+NS_DEFINE_STATIC_IID_ACCESSOR(IStorageBindingParamsInternal,</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+                              ISTORAGEBINDINGPARAMSINTERNAL_IID)</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+#define NS_DECL_ISTORAGEBINDINGPARAMSINTERNAL \</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+  already_AddRefed&lt;mozIStorageError&gt; bind(sqlite3_stmt *aStatement);</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+} // storage</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+} // mozilla</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+#endif // mozilla_storage_IStorageBindingParamsInternal_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/storage-backport/src/Makefile.in</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+#</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+#</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+#</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+# License.</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+#</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+# The Original Code is Oracle Corporation code.</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+#</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+#   Oracle Corporation</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+#</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+#   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+#</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+#</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+DEPTH   = ../..</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+topsrcdir = @top_srcdir@</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+srcdir    = @srcdir@</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+VPATH   = @srcdir@</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+MODULE           = storage</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+LIBRARY_NAME     = storage_s</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+MODULE_NAME      = mozStorageModule</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+FORCE_STATIC_LIB = 1</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+GRE_MODULE       = 1</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+LIBXUL_LIBRARY = 1</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+EXPORTS_NAMESPACES = mozilla/storage</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+EXPORTS_mozilla/storage = \</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+  Variant.h \</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+  Variant_inl.h \</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+  $(NULL)</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+CPPSRCS = \</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+  mozStorageService.cpp \</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+  mozStorageConnection.cpp \</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+  mozStorageStatement.cpp \</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+  mozStorageStatementWrapper.cpp \</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  mozStorageStatementParams.cpp \</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+  mozStorageStatementRow.cpp \</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+  mozStorageArgValueArray.cpp \</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+  mozStorageSQLFunctions.cpp \</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+  mozStorageRow.cpp \</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+  mozStorageResultSet.cpp \</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+  mozStorageError.cpp \</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+  mozStorageAsyncStatementExecution.cpp \</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+  mozStorageStatementJSHelper.cpp \</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+  mozStoragePrivateHelpers.cpp \</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+  mozStorageBindingParamsArray.cpp \</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+  mozStorageBindingParams.cpp \</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+  mozStorageAsyncStatement.cpp \</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+  mozStorageAsyncStatementJSHelper.cpp \</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+  mozStorageAsyncStatementParams.cpp \</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+  StorageBaseStatementInternal.cpp \</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+  SQLCollations.cpp \</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+  $(NULL)</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+LOCAL_INCLUDES = \</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+	$(SQLITE_CFLAGS)</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+# This is the default value.  If we ever change it when compiling sqlite, we</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+# will need to change it here as well.</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+DEFINES += -DSQLITE_MAX_LIKE_PATTERN_LENGTH=50000</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/storage-backport/src/SQLCollations.cpp</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,269 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+ *</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+ *</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+ * License.</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+ *</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+ * The Original Code is Mozilla Storage code.</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+ *</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ *</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+ *</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+ *</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+#include &quot;SQLCollations.h&quot;</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+namespace mozilla {</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+namespace storage {</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+//// Local Helper Functions</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+namespace {</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+/**</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+ * Helper function for the UTF-8 locale collations.</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+ *</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+ * @param  aService</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+ * @param  aLen1</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+ *         The number of bytes in aStr1.</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+ * @param  aStr1</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+ *         The string to be compared against aStr2 as provided by SQLite.  It</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+ *         must be a non-null-terminated char* buffer.</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+ * @param  aLen2</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+ *         The number of bytes in aStr2.</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+ * @param  aStr2</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+ *         The string to be compared against aStr1 as provided by SQLite.  It</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+ *         must be a non-null-terminated char* buffer.</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+ * @param  aComparisonStrength</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+ *         The sorting strength, one of the nsICollation constants.</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+ *         returns 0.</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+ */</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+int</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+localeCollationHelper8(void *aService,</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+                       int aLen1,</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+                       const void *aStr1,</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+                       int aLen2,</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+                       const void *aStr2,</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+                       PRInt32 aComparisonStrength)</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+{</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+  NS_ConvertUTF8toUTF16 str1(static_cast&lt;const char *&gt;(aStr1), aLen1);</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+  NS_ConvertUTF8toUTF16 str2(static_cast&lt;const char *&gt;(aStr2), aLen2);</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+  Service *serv = static_cast&lt;Service *&gt;(aService);</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+  return serv-&gt;localeCompareStrings(str1, str2, aComparisonStrength);</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+}</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+/**</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+ * Helper function for the UTF-16 locale collations.</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+ *</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+ * @param  aService</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+ * @param  aLen1</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+ *         The number of bytes (not characters) in aStr1.</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+ * @param  aStr1</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+ *         The string to be compared against aStr2 as provided by SQLite.  It</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+ *         must be a non-null-terminated PRUnichar* buffer.</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+ * @param  aLen2</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+ *         The number of bytes (not characters) in aStr2.</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+ * @param  aStr2</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+ *         The string to be compared against aStr1 as provided by SQLite.  It</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+ *         must be a non-null-terminated PRUnichar* buffer.</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+ * @param  aComparisonStrength</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+ *         The sorting strength, one of the nsICollation constants.</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+ *         returns 0.</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+ */</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+int</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+localeCollationHelper16(void *aService,</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+                        int aLen1,</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+                        const void *aStr1,</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+                        int aLen2,</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+                        const void *aStr2,</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+                        PRInt32 aComparisonStrength)</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+{</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+  const PRUnichar *buf1 = static_cast&lt;const PRUnichar *&gt;(aStr1);</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+  const PRUnichar *buf2 = static_cast&lt;const PRUnichar *&gt;(aStr2);</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+  // The second argument to the nsDependentSubstring constructor is exclusive:</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+  // It points to the PRUnichar immediately following the last one in the target</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+  // substring.  Since aLen1 and aLen2 are in bytes, divide by sizeof(PRUnichar)</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+  // so that the pointer arithmetic is correct.</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+  nsDependentSubstring str1(buf1, buf1 + (aLen1 / sizeof(PRUnichar)));</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+  nsDependentSubstring str2(buf2, buf2 + (aLen2 / sizeof(PRUnichar)));</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+  Service *serv = static_cast&lt;Service *&gt;(aService);</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+  return serv-&gt;localeCompareStrings(str1, str2, aComparisonStrength);</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+}</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+} // anonymous namespace</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineplus">+//// Exposed Functions</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineplus">+</span>
<a href="#l29.136"></a><span id="l29.136" class="difflineplus">+int</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineplus">+registerCollations(sqlite3 *aDB,</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineplus">+                   Service *aService)</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineplus">+{</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+  struct Collations {</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+    const char *zName;</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+    int enc;</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineplus">+    int(*xCompare)(void*, int, const void*, int, const void*);</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+  } collations[] = {</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+    {&quot;locale&quot;,</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineplus">+     SQLITE_UTF8,</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineplus">+     localeCollation8},</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineplus">+    {&quot;locale_case_sensitive&quot;,</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+     SQLITE_UTF8,</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineplus">+     localeCollationCaseSensitive8},</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineplus">+    {&quot;locale_accent_sensitive&quot;,</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineplus">+     SQLITE_UTF8,</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineplus">+     localeCollationAccentSensitive8},</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineplus">+    {&quot;locale_case_accent_sensitive&quot;,</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+     SQLITE_UTF8,</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineplus">+     localeCollationCaseAccentSensitive8},</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+    {&quot;locale&quot;,</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+     SQLITE_UTF16,</span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+     localeCollation16},</span>
<a href="#l29.160"></a><span id="l29.160" class="difflineplus">+    {&quot;locale_case_sensitive&quot;,</span>
<a href="#l29.161"></a><span id="l29.161" class="difflineplus">+     SQLITE_UTF16,</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineplus">+     localeCollationCaseSensitive16},</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+    {&quot;locale_accent_sensitive&quot;,</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+     SQLITE_UTF16,</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineplus">+     localeCollationAccentSensitive16},</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineplus">+    {&quot;locale_case_accent_sensitive&quot;,</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+     SQLITE_UTF16,</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+     localeCollationCaseAccentSensitive16},</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineplus">+  };</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineplus">+</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineplus">+  int rv = SQLITE_OK;</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineplus">+  for (size_t i = 0; SQLITE_OK == rv &amp;&amp; i &lt; NS_ARRAY_LENGTH(collations); ++i) {</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineplus">+    struct Collations *p = &amp;collations[i];</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineplus">+    rv = ::sqlite3_create_collation(aDB, p-&gt;zName, p-&gt;enc, aService,</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineplus">+                                    p-&gt;xCompare);</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineplus">+  }</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineplus">+</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineplus">+  return rv;</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineplus">+}</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineplus">+//// SQL Collations</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineplus">+</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+int</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+localeCollation8(void *aService,</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineplus">+                 int aLen1,</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+                 const void *aStr1,</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineplus">+                 int aLen2,</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+                 const void *aStr2)</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineplus">+{</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineplus">+  return localeCollationHelper8(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+                                nsICollation::kCollationCaseInSensitive);</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineplus">+}</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineplus">+</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineplus">+int</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+localeCollationCaseSensitive8(void *aService,</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineplus">+                              int aLen1,</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineplus">+                              const void *aStr1,</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineplus">+                              int aLen2,</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+                              const void *aStr2)</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineplus">+{</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineplus">+  return localeCollationHelper8(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+                                nsICollation::kCollationAccentInsenstive);</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineplus">+}</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineplus">+</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+int</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+localeCollationAccentSensitive8(void *aService,</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+                                int aLen1,</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+                                const void *aStr1,</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineplus">+                                int aLen2,</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+                                const void *aStr2)</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+{</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineplus">+  return localeCollationHelper8(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineplus">+                                nsICollation::kCollationCaseInsensitiveAscii);</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineplus">+}</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineplus">+</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineplus">+int</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+localeCollationCaseAccentSensitive8(void *aService,</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineplus">+                                    int aLen1,</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineplus">+                                    const void *aStr1,</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineplus">+                                    int aLen2,</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineplus">+                                    const void *aStr2)</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineplus">+{</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+  return localeCollationHelper8(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineplus">+                                nsICollation::kCollationCaseSensitive);</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineplus">+}</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineplus">+</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineplus">+int</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineplus">+localeCollation16(void *aService,</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineplus">+                  int aLen1,</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+                  const void *aStr1,</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineplus">+                  int aLen2,</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+                  const void *aStr2)</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+{</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+  return localeCollationHelper16(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+                                 nsICollation::kCollationCaseInSensitive);</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+}</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+int</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineplus">+localeCollationCaseSensitive16(void *aService,</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+                               int aLen1,</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+                               const void *aStr1,</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+                               int aLen2,</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineplus">+                               const void *aStr2)</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+{</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineplus">+  return localeCollationHelper16(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+                                 nsICollation::kCollationAccentInsenstive);</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+}</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+int</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineplus">+localeCollationAccentSensitive16(void *aService,</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineplus">+                                 int aLen1,</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineplus">+                                 const void *aStr1,</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineplus">+                                 int aLen2,</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+                                 const void *aStr2)</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+{</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineplus">+  return localeCollationHelper16(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineplus">+                                 nsICollation::kCollationCaseInsensitiveAscii);</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineplus">+}</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineplus">+</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineplus">+int</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineplus">+localeCollationCaseAccentSensitive16(void *aService,</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineplus">+                                     int aLen1,</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineplus">+                                     const void *aStr1,</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineplus">+                                     int aLen2,</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineplus">+                                     const void *aStr2)</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineplus">+{</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineplus">+  return localeCollationHelper16(aService, aLen1, aStr1, aLen2, aStr2,</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineplus">+                                 nsICollation::kCollationCaseSensitive);</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineplus">+}</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineplus">+</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineplus">+} // namespace storage</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/storage-backport/src/SQLCollations.h</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,282 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+ *</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+ *</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+ * License.</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+ *</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+ * The Original Code is Mozilla Storage code.</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+ *</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+ *</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+ *</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+ *</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+#ifndef _mozilla_storage_SQLCollations_h_</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+#define _mozilla_storage_SQLCollations_h_</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+namespace mozilla {</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+namespace storage {</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+/**</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+ * Registers the collating sequences declared here with the specified</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+ * database and Service.</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+ *</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+ * @param  aDB</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+ *         The database we'll be registering the collations with.</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+ * @param  aService</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+ *         The Service that owns the nsICollation used by our collations.</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+ * @return the SQLite status code indicating success or failure.</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+ */</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+NS_HIDDEN_(int) registerCollations(sqlite3 *aDB, Service *aService);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+//// Predefined Functions</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+/**</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+ * Custom UTF-8 collating sequence that respects the application's locale.</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+ * Comparison is case- and accent-insensitive.  This is called by SQLite.</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+ *</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+ * @param  aService</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+ *         The number of bytes in aStr1.</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+ *         The number of bytes in aStr2.</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+ */</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+NS_HIDDEN_(int) localeCollation8(void *aService,</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+                                 int aLen1,</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+                                 const void *aStr1,</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+                                 int aLen2,</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+                                 const void *aStr2);</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+/**</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+ * Custom UTF-8 collating sequence that respects the application's locale.</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+ * Comparison is case-sensitive and accent-insensitive.  This is called by</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+ * SQLite.</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+ *</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+ * @param  aService</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+ *         The number of bytes in aStr1.</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+ *         The number of bytes in aStr2.</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+ */</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+NS_HIDDEN_(int) localeCollationCaseSensitive8(void *aService,</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+                                              int aLen1,</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+                                              const void *aStr1,</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+                                              int aLen2,</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+                                              const void *aStr2);</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+/**</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+ * Custom UTF-8 collating sequence that respects the application's locale.</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+ * Comparison is case-insensitive and accent-sensitive.  This is called by</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+ * SQLite.</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+ *</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+ * @param  aService</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+ *         The number of bytes in aStr1.</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+ *         The number of bytes in aStr2.</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+ */</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+NS_HIDDEN_(int) localeCollationAccentSensitive8(void *aService,</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+                                                int aLen1,</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+                                                const void *aStr1,</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+                                                int aLen2,</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+                                                const void *aStr2);</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+/**</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+ * Custom UTF-8 collating sequence that respects the application's locale.</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+ * Comparison is case- and accent-sensitive.  This is called by SQLite.</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+ *</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+ * @param  aService</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+ *         The number of bytes in aStr1.</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+ *         The number of bytes in aStr2.</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+ *         SQLite as a non-null-terminated char* buffer.</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+ */</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+NS_HIDDEN_(int) localeCollationCaseAccentSensitive8(void *aService,</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+                                                    int aLen1,</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+                                                    const void *aStr1,</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+                                                    int aLen2,</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+                                                    const void *aStr2);</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+/**</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+ * Custom UTF-16 collating sequence that respects the application's locale.</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+ * Comparison is case- and accent-insensitive.  This is called by SQLite.</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+ *</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+ * @param  aService</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+ *         The number of bytes (not characters) in aStr1.</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+ *         The number of bytes (not characters) in aStr2.</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+ */</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+NS_HIDDEN_(int) localeCollation16(void *aService,</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+                                  int aLen1,</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+                                  const void *aStr1,</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+                                  int aLen2,</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+                                  const void *aStr2);</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+/**</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+ * Custom UTF-16 collating sequence that respects the application's locale.</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+ * Comparison is case-sensitive and accent-insensitive.  This is called by</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+ * SQLite.</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+ *</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+ * @param  aService</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+ *         The number of bytes (not characters) in aStr1.</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+ *         The number of bytes (not characters) in aStr2.</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineplus">+ */</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+NS_HIDDEN_(int) localeCollationCaseSensitive16(void *aService,</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+                                               int aLen1,</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+                                               const void *aStr1,</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+                                               int aLen2,</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+                                               const void *aStr2);</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+/**</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+ * Custom UTF-16 collating sequence that respects the application's locale.</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+ * Comparison is case-insensitive and accent-sensitive.  This is called by</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+ * SQLite.</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+ *</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+ * @param  aService</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+ *         The number of bytes (not characters) in aStr1.</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+ *         The number of bytes (not characters) in aStr2.</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+ */</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+NS_HIDDEN_(int) localeCollationAccentSensitive16(void *aService,</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+                                                 int aLen1,</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+                                                 const void *aStr1,</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+                                                 int aLen2,</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+                                                 const void *aStr2);</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+/**</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+ * Custom UTF-16 collating sequence that respects the application's locale.</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+ * Comparison is case- and accent-sensitive.  This is called by SQLite.</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+ *</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+ * @param  aService</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+ *         The Service that owns the nsICollation used by this collation.</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+ * @param  aLen1</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+ *         The number of bytes (not characters) in aStr1.</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+ * @param  aStr1</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineplus">+ *         The string to be compared against aStr2.  It will be passed in by</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+ * @param  aLen2</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+ *         The number of bytes (not characters) in aStr2.</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineplus">+ * @param  aStr2</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineplus">+ *         The string to be compared against aStr1.  It will be passed in by</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+ *         SQLite as a non-null-terminated PRUnichar* buffer.</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+ * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative number.</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+ *         If aStr1 &gt; aStr2, returns a positive number.  If aStr1 == aStr2,</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+ *         returns 0.</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+ */</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+NS_HIDDEN_(int) localeCollationCaseAccentSensitive16(void *aService,</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+                                                     int aLen1,</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+                                                     const void *aStr1,</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+                                                     int aLen2,</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+                                                     const void *aStr2);</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineplus">+</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+} // namespace storage</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+} // namespace mozilla</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+#endif // _mozilla_storage_SQLCollations_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/storage-backport/src/SQLiteMutex.h</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,207 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+ *</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+ *</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+ * License.</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+ *</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+ *</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+ *</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+ *</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+ *</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+#ifndef mozilla_storage_SQLiteMutex_h_</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+#define mozilla_storage_SQLiteMutex_h_</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+#include &quot;mozilla/BlockingResourceBase.h&quot;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+namespace storage {</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+/**</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+ * Wrapper class for sqlite3_mutexes.  To be used whenever we want to use a</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+ * sqlite3_mutex.</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+ *</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+ * @warning Never EVER wrap the same sqlite3_mutex with a different SQLiteMutex.</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+ *          If you do this, you void the deadlock detector's warranty!</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+ */</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+class SQLiteMutex : private BlockingResourceBase</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+{</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+public:</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+  /**</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+   * Constructs a wrapper for a sqlite3_mutex that has deadlock detecting.</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+   *</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+   * @param aName</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+   *        A name which can be used to reference this mutex.</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+   */</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+  SQLiteMutex(const char *aName)</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+  : BlockingResourceBase(aName, eMutex)</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+  , mMutex(NULL)</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+  {</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+  }</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+  /**</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+   * Sets the mutex that we are wrapping.  We generally do not have access to</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+   * our mutex at class construction, so we have to set it once we get access to</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+   * it.</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+   *</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+   * @param aMutex</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+   *        The sqlite3_mutex that we are going to wrap.</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+   */</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+  void initWithMutex(sqlite3_mutex *aMutex)</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+  {</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+    NS_ASSERTION(aMutex, &quot;You must pass in a valid mutex!&quot;);</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+    NS_ASSERTION(!mMutex, &quot;A mutex has already been set for this!&quot;);</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+    mMutex = aMutex;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+  }</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+#ifndef DEBUG</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+  /**</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+   * Acquires the mutex.</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+   */</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+  void lock()</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+  {</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+    sqlite3_mutex_enter(mMutex);</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+  }</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+  /**</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+   * Releases the mutex.</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+   */</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+  void unlock()</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+  {</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+    sqlite3_mutex_leave(mMutex);</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+  }</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+  /**</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+   * Asserts that the current thread owns the mutex.</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+   */</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+  void assertCurrentThreadOwns()</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+  {</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+  }</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+  /**</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+   * Asserts that the current thread does not own the mutex.</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+   */</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+  void assertNotCurrentThreadOwns()</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+  {</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+  }</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+#else</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+  void lock()</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+  {</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+    NS_ASSERTION(mMutex, &quot;No mutex associated with this wrapper!&quot;);</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+    // While SQLite Mutexes may be recursive, in our own code we do not want to</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+    // treat them as such.</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+    CallStack callContext = CallStack();</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+    CheckAcquire(callContext);</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+    sqlite3_mutex_enter(mMutex);</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+    Acquire(callContext); // Call is protected by us holding the mutex.</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+  }</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+  void unlock()</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+  {</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+    NS_ASSERTION(mMutex, &quot;No mutex associated with this wrapper!&quot;);</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+    // While SQLite Mutexes may be recursive, in our own code we do not want to</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+    // treat them as such.</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+    Release(); // Call is protected by us holding the mutex.</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+    sqlite3_mutex_leave(mMutex);</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+  }</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+  void assertCurrentThreadOwns()</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+  {</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+    NS_ASSERTION(mMutex, &quot;No mutex associated with this wrapper!&quot;);</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+    NS_ASSERTION(sqlite3_mutex_held(mMutex),</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+                 &quot;Mutex is not held, but we expect it to be!&quot;);</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+  }</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+  void assertNotCurrentThreadOwns()</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+  {</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineplus">+    NS_ASSERTION(mMutex, &quot;No mutex associated with this wrapper!&quot;);</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+    NS_ASSERTION(sqlite3_mutex_notheld(mMutex),</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+                 &quot;Mutex is held, but we expect it to not be!&quot;);</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+  }</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+#endif // ifndef DEBUG</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+private:</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+  sqlite3_mutex *mMutex;</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+};</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+/**</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+ * Automatically acquires the mutex when it enters scope, and releases it when</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+ * it leaves scope.</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineplus">+ */</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+class NS_STACK_CLASS SQLiteMutexAutoLock</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+{</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+public:</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+  SQLiteMutexAutoLock(SQLiteMutex &amp;aMutex)</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+  : mMutex(aMutex)</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+  {</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineplus">+    mMutex.lock();</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+  }</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineplus">+  ~SQLiteMutexAutoLock()</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineplus">+  {</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+    mMutex.unlock();</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+  }</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineplus">+</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineplus">+private:</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+  SQLiteMutex &amp;mMutex;</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineplus">+};</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+/**</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+ * Automatically releases the mutex when it enters scope, and acquires it when</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+ * it leaves scope.</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+ */</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+class NS_STACK_CLASS SQLiteMutexAutoUnlock</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+{</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+public:</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+  SQLiteMutexAutoUnlock(SQLiteMutex &amp;aMutex)</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+  : mMutex(aMutex)</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+  {</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+    mMutex.unlock();</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+  }</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineplus">+  ~SQLiteMutexAutoUnlock()</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineplus">+  {</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+    mMutex.lock();</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineplus">+  }</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineplus">+</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+private:</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+  SQLiteMutex &amp;mMutex;</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineplus">+};</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineplus">+</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineplus">+} // namespace storage</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineplus">+} // namespace mozilla</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineplus">+#endif // mozilla_storage_SQLiteMutex_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/storage-backport/src/StorageBaseStatementInternal.cpp</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,185 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+ *</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+ *</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+ * License.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+ *</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+ *</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+ *</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+ *</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+ *</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+#include &quot;nsProxyRelease.h&quot;</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+#include &quot;mozStorageStatementData.h&quot;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+#include &quot;mozStorageAsyncStatementExecution.h&quot;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+namespace storage {</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+//// Local Classes</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+/**</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+ * Used to finalize an asynchronous statement on the background thread.</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+ */</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+class AsyncStatementFinalizer : public nsRunnable</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+{</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+public:</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+  /**</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+   * Constructor for the event.</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+   *</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+   * @param aStatement</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+   *        We need the AsyncStatement to be able to get at the sqlite3_stmt;</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+   *        we only access/create it on the async thread.</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+   * @param aConnection</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+   *        We need the connection to know what thread to release the statement</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+   *        on.  We release the statement on that thread since releasing the</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+   *        statement might end up releasing the connection too.</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+   */</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+  AsyncStatementFinalizer(StorageBaseStatementInternal *aStatement,</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+                          Connection *aConnection)</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+  : mStatement(aStatement)</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  , mConnection(aConnection)</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  {</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+  }</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+  {</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+    mStatement-&gt;internalAsyncFinalize();</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+    (void)::NS_ProxyRelease(mConnection-&gt;threadOpenedOn, mStatement);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+  }</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+private:</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+  // It is vital that this remain an nsCOMPtr for NS_ProxyRelease's benefit.</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  nsCOMPtr&lt;StorageBaseStatementInternal&gt; mStatement;</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+  nsRefPtr&lt;Connection&gt; mConnection;</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+};</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+//// StorageBaseStatementInternal</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+StorageBaseStatementInternal::StorageBaseStatementInternal()</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+: mAsyncStatement(NULL)</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+{</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+}</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+void</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+StorageBaseStatementInternal::asyncFinalize()</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+{</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+  nsIEventTarget *target = mDBConnection-&gt;getAsyncExecutionTarget();</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+  if (!target) {</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+    // If we cannot get the background thread, we have to assume it has been</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+    // shutdown (or is in the process of doing so).  As a result, we should</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+    // just finalize it here and now.</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+    internalAsyncFinalize();</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+  }</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+  else {</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+    nsCOMPtr&lt;nsIRunnable&gt; event =</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+      new AsyncStatementFinalizer(this, mDBConnection);</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+    // If the dispatching did not go as planned, finalize now.</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+    if (!event ||</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+        NS_FAILED(target-&gt;Dispatch(event, NS_DISPATCH_NORMAL))) {</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+      internalAsyncFinalize();</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+    }</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+  }</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+}</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+void</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+StorageBaseStatementInternal::internalAsyncFinalize()</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+{</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+  if (mAsyncStatement) {</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+    (void)::sqlite3_finalize(mAsyncStatement);</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+    mAsyncStatement = nsnull;</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+  }</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+}</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+StorageBaseStatementInternal::NewBindingParamsArray(</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+  mozIStorageBindingParamsArray **_array</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+)</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+{</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; array = new BindingParamsArray(this);</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+  NS_ENSURE_TRUE(array, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+  array.forget(_array);</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+}</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+StorageBaseStatementInternal::ExecuteAsync(</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+  mozIStorageStatementCallback *aCallback,</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+  mozIStoragePendingStatement **_stmt</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+)</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+{</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+  // We used to call Connection::ExecuteAsync but it takes a</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+  // mozIStorageBaseStatement signature because it is also a public API.  Since</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+  // our 'this' has no static concept of mozIStorageBaseStatement and Connection</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+  // would just QI it back across to a StorageBaseStatementInternal and the</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+  // actual logic is very simple, we now roll our own.</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+  nsTArray&lt;StatementData&gt; stmts(1);</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+  StatementData data;</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+  nsresult rv = getAsynchronousStatementData(data);</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+  NS_ENSURE_TRUE(stmts.AppendElement(data), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+  // Dispatch to the background</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+  return AsyncExecuteStatements::execute(stmts, mDBConnection, aCallback,</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineplus">+                                         _stmt);</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineplus">+}</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineplus">+StorageBaseStatementInternal::EscapeStringForLIKE(</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+  const nsAString &amp;aValue,</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+  const PRUnichar aEscapeChar,</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+  nsAString &amp;_escapedString</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+)</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+{</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+  const PRUnichar MATCH_ALL('%');</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+  const PRUnichar MATCH_ONE('_');</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+  _escapedString.Truncate(0);</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineplus">+</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+  for (PRUint32 i = 0; i &lt; aValue.Length(); i++) {</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+    if (aValue[i] == aEscapeChar || aValue[i] == MATCH_ALL ||</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+        aValue[i] == MATCH_ONE) {</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+      _escapedString += aEscapeChar;</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+    }</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+    _escapedString += aValue[i];</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+  }</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+}</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+} // namespace storage</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/storage-backport/src/StorageBaseStatementInternal.h</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,354 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 expandtab</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+ *</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+ *</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+ * License.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+ *</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ *</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+ *</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+ *</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+ *</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+#ifndef mozilla_storage_StorageBaseStatementInternal_h_</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+#define mozilla_storage_StorageBaseStatementInternal_h_</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+class mozIStorageError;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+class mozIStorageBindingParamsArray;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+class mozIStorageBindingParams;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+class mozIStorageStatementCallback;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+class mozIStoragePendingStatement;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+namespace mozilla {</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+namespace storage {</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+#define STORAGEBASESTATEMENTINTERNAL_IID \</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+  {0xd18856c9, 0xbf07, 0x4ae2, {0x94, 0x5b, 0x1a, 0xdd, 0x49, 0x19, 0x55, 0x2a}}</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+class Connection;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+struct StatementData;</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+class AsyncStatementFinalizer;</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+/**</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+ * Implementation-only interface and shared logix mix-in corresponding to</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+ * mozIStorageBaseStatement.  Both Statement and AsyncStatement inherit from</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+ * this. The interface aspect makes them look the same to implementation innards</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+ * that aren't publicly accessible.  The mix-in avoids code duplication in</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+ * common implementations of mozIStorageBaseStatement, albeit with some minor</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+ * performance/space overhead because we have to use defines to officially</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+ * implement the methods on Statement/AsyncStatement (and proxy to this base</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+ * class.)</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+ */</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+class StorageBaseStatementInternal : public nsISupports</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+{</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+public:</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+  NS_DECLARE_STATIC_IID_ACCESSOR(STORAGEBASESTATEMENTINTERNAL_IID)</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  /**</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+   * @return the connection that this statement belongs to.</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+   */</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+  Connection *getOwner()</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+  {</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+    return mDBConnection;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+  }</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  /**</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+   * Return the asynchronous statement, creating it if required.</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+   *</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+   * This is for use by the asynchronous execution code for StatementData</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+   * created by AsyncStatements.  Statement internally uses this method to</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+   * prepopulate StatementData with the sqlite3_stmt.</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+   *</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+   * @param[out] stmt</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+   *             The sqlite3_stmt for asynchronous use.</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+   * @return The SQLite result code for creating the statement if created,</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+   *         SQLITE_OK if creation was not required.</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+   */</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+  virtual int getAsyncStatement(sqlite3_stmt **_stmt) = 0;</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+  /**</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+   * Obtains the StatementData needed for asynchronous execution.</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+   *</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+   * This is for use by Connection to retrieve StatementData from statements</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+   * when executeAsync is invoked.</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+   *</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+   * @param[out] _data</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+   *             A reference to a StatementData object that will be populated</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+   *             upon successful execution of this method.</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+   * @return NS_OK if we were able to assemble the data, failure otherwise.</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+   */</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+  virtual nsresult getAsynchronousStatementData(StatementData &amp;_data) = 0;</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+  /**</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+   * Construct a new BindingParams to be owned by the provided binding params</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+   * array.  This method exists so that BindingParamsArray does not need</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+   * factory logic to determine what type of BindingParams to instantiate.</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+   *</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+   * @param aOwner</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+   *        The binding params array to own the newly created binding params.</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+   * @return The new mozIStorageBindingParams instance appropriate to the</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+   *         underlying statement type.</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+   */</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+  virtual already_AddRefed&lt;mozIStorageBindingParams&gt; newBindingParams(</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+    mozIStorageBindingParamsArray *aOwner</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+  ) = 0;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+protected: // mix-in bits are protected</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+  StorageBaseStatementInternal();</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+  nsRefPtr&lt;Connection&gt; mDBConnection;</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+  /**</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+   * Our asynchronous statement.</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+   *</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+   * For Statement this is populated by the first invocation to</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+   * getAsyncStatement.</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+   *</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+   * For AsyncStatement, this is null at creation time and initialized by the</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+   * async thread when it calls getAsyncStatement the first time the statement</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+   * is executed.  (Or in the event of badly formed SQL, every time.)</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+   */</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+  sqlite3_stmt *mAsyncStatement;</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+  /**</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+   * Initiate asynchronous finalization by dispatching an event to the</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+   * asynchronous thread to finalize mAsyncStatement.  This acquires a reference</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+   * to this statement and proxies it back to the connection's owning thread</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+   * for release purposes.</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+   *</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+   * In the event the asynchronous thread is already gone or we otherwise fail</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+   * to dispatch an event to it we failover to invoking internalAsyncFinalize</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+   * directly.  (That's what the asynchronous finalizer would have called.)</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+   *</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+   * @note You must not call this method from your destructor because its</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+   *       operation assumes we are still alive.  Call internalAsyncFinalize</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+   *       directly in that case.</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+   */</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+  void asyncFinalize();</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+  /**</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+   * Cleanup the async sqlite3_stmt stored in mAsyncStatement if it exists.</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+   *</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+   * @note Call this from your destructor, call asyncFinalize otherwise.</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+   */</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+  void internalAsyncFinalize();</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+  NS_IMETHOD NewBindingParamsArray(mozIStorageBindingParamsArray **_array);</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+  NS_IMETHOD ExecuteAsync(mozIStorageStatementCallback *aCallback,</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+                          mozIStoragePendingStatement **_stmt);</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+  NS_IMETHOD EscapeStringForLIKE(const nsAString &amp;aValue,</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+                                 const PRUnichar aEscapeChar,</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+                                 nsAString &amp;_escapedString);</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+  // Needs access to internalAsyncFinalize</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+  friend class AsyncStatementFinalizer;</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+};</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+NS_DEFINE_STATIC_IID_ACCESSOR(StorageBaseStatementInternal,</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+                              STORAGEBASESTATEMENTINTERNAL_IID)</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+#define NS_DECL_STORAGEBASESTATEMENTINTERNAL \</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineplus">+  virtual Connection *getOwner(); \</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+  virtual int getAsyncStatement(sqlite3_stmt **_stmt); \</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+  virtual nsresult getAsynchronousStatementData(StatementData &amp;_data); \</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+  virtual already_AddRefed&lt;mozIStorageBindingParams&gt; newBindingParams( \</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+    mozIStorageBindingParamsArray *aOwner);</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineplus">+</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+/**</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineplus">+ * Helper macro to implement the proxying implementations.  Because we are</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+ * implementing methods that are part of mozIStorageBaseStatement and the</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+ * implementation classes already use NS_DECL_MOZISTORAGEBASESTATEMENT we don't</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineplus">+ * need to provide declaration support.</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineplus">+ */</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineplus">+#define MIX_IMPL(_class, _optionalGuard, _method, _declArgs, _invokeArgs) \</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+  NS_IMETHODIMP _class::_method _declArgs                                 \</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+  {                                                                       \</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+    _optionalGuard                                                        \</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineplus">+    return StorageBaseStatementInternal::_method _invokeArgs;             \</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineplus">+  }</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineplus">+</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineplus">+</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineplus">+/**</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineplus">+ * Define proxying implementation for the given _class.  If a state invariant</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+ * needs to be checked and an early return possibly performed, pass the clause</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+ * to use as _optionalGuard.</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineplus">+ */</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+#define MIXIN_IMPL_STORAGEBASESTATEMENTINTERNAL(_class, _optionalGuard) \</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineplus">+  MIX_IMPL(_class, _optionalGuard,                                      \</span>
<a href="#l33.214"></a><span id="l33.214" class="difflineplus">+           NewBindingParamsArray,                                       \</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineplus">+           (mozIStorageBindingParamsArray **_array),                    \</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineplus">+           (_array))                                                    \</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineplus">+  MIX_IMPL(_class, _optionalGuard,                                      \</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineplus">+           ExecuteAsync,                                                \</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineplus">+           (mozIStorageStatementCallback *aCallback,                    \</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineplus">+            mozIStoragePendingStatement **_stmt),                       \</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineplus">+           (aCallback, _stmt))                                          \</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+  MIX_IMPL(_class, _optionalGuard,                                      \</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+           EscapeStringForLIKE,                                         \</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineplus">+           (const nsAString &amp;aValue, const PRUnichar aEscapeChar,       \</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineplus">+            nsAString &amp;_escapedString),                                 \</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineplus">+           (aValue, aEscapeChar, _escapedString))</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineplus">+/**</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineplus">+ * Name-building helper for BIND_GEN_IMPL.</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineplus">+ */</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineplus">+#define BIND_NAME_CONCAT(_nameBit, _concatBit) \</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+  Bind##_nameBit##_concatBit</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineplus">+</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+/**</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+ * We have type-specific convenience methods for C++ implementations in</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineplus">+ * 3 different forms; 2 by index, 1 by name.  The following macro allows</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineplus">+ * us to avoid having to define repetitive things by hand.</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineplus">+ *</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineplus">+ * Because of limitations of macros and our desire to avoid requiring special</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineplus">+ * permutations for the null and blob cases (whose argument count varies),</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineplus">+ * we require that the argument declarations and corresponding invocation</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineplus">+ * usages are passed in.</span>
<a href="#l33.243"></a><span id="l33.243" class="difflineplus">+ *</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineplus">+ * @param _class The class name.</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineplus">+ * @param _guard The guard clause to inject.</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineplus">+ * @param _declName The argument list (with parens) for the ByName variants.</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineplus">+ * @param _declIndex The argument list (with parens) for the index variants.</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineplus">+ * @param _invArgs The invocation argumment list.</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineplus">+ */</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineplus">+#define BIND_GEN_IMPL(_class, _guard, _name, _declName, _declIndex, _invArgs) \</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineplus">+  NS_IMETHODIMP _class::BIND_NAME_CONCAT(_name, ByName) _declName             \</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineplus">+  {                                                                           \</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineplus">+    _guard                                                                    \</span>
<a href="#l33.254"></a><span id="l33.254" class="difflineplus">+    mozIStorageBindingParams *params = getParams();                           \</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);                           \</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineplus">+    return params-&gt;BIND_NAME_CONCAT(_name, ByName) _invArgs;                  \</span>
<a href="#l33.257"></a><span id="l33.257" class="difflineplus">+  }                                                                           \</span>
<a href="#l33.258"></a><span id="l33.258" class="difflineplus">+  NS_IMETHODIMP _class::BIND_NAME_CONCAT(_name, ByIndex) _declIndex           \</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineplus">+  {                                                                           \</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineplus">+    _guard                                                                    \</span>
<a href="#l33.261"></a><span id="l33.261" class="difflineplus">+    mozIStorageBindingParams *params = getParams();                           \</span>
<a href="#l33.262"></a><span id="l33.262" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);                           \</span>
<a href="#l33.263"></a><span id="l33.263" class="difflineplus">+    return params-&gt;BIND_NAME_CONCAT(_name, ByIndex) _invArgs;                 \</span>
<a href="#l33.264"></a><span id="l33.264" class="difflineplus">+  }                                                                           \</span>
<a href="#l33.265"></a><span id="l33.265" class="difflineplus">+  NS_IMETHODIMP _class::BIND_NAME_CONCAT(_name, Parameter) _declIndex         \</span>
<a href="#l33.266"></a><span id="l33.266" class="difflineplus">+  {                                                                           \</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineplus">+    _guard                                                                    \</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineplus">+    mozIStorageBindingParams *params = getParams();                           \</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);                           \</span>
<a href="#l33.270"></a><span id="l33.270" class="difflineplus">+    return params-&gt;BIND_NAME_CONCAT(_name, ByIndex) _invArgs;                 \</span>
<a href="#l33.271"></a><span id="l33.271" class="difflineplus">+  }</span>
<a href="#l33.272"></a><span id="l33.272" class="difflineplus">+</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineplus">+/**</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineplus">+ * Implement BindByName/BindByIndex for the given class.</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineplus">+ *</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineplus">+ * @param _class The class name.</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineplus">+ * @param _optionalGuard The guard clause to inject.</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineplus">+ */</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineplus">+#define BIND_BASE_IMPLS(_class, _optionalGuard)             \</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineplus">+  NS_IMETHODIMP _class::BindByName(const nsACString &amp;aName, \</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineplus">+                                   nsIVariant *aValue)      \</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+  {                                                         \</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineplus">+    _optionalGuard                                          \</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineplus">+    mozIStorageBindingParams *params = getParams();         \</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);         \</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineplus">+    return params-&gt;BindByName(aName, aValue);               \</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineplus">+  }                                                         \</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineplus">+  NS_IMETHODIMP _class::BindByIndex(PRUint32 aIndex,        \</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineplus">+                                    nsIVariant *aValue)     \</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineplus">+  {                                                         \</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineplus">+    _optionalGuard                                          \</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineplus">+    mozIStorageBindingParams *params = getParams();         \</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);         \</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineplus">+    return params-&gt;BindByIndex(aIndex, aValue);             \</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineplus">+  }</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineplus">+</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+/**</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineplus">+ * Define the various Bind*Parameter, Bind*ByIndex, Bind*ByName stubs that just</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineplus">+ * end up proxying to the params object.</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineplus">+ */</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+#define BOILERPLATE_BIND_PROXIES(_class, _optionalGuard) \</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineplus">+  BIND_BASE_IMPLS(_class, _optionalGuard)                \</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineplus">+                UTF8String,                              \</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineplus">+                 const nsACString &amp;aValue),              \</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineplus">+                 const nsACString &amp;aValue),              \</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineplus">+                (aWhere, aValue))                        \</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineplus">+                String,                                  \</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineplus">+                 const nsAString  &amp;aValue),              \</span>
<a href="#l33.314"></a><span id="l33.314" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.315"></a><span id="l33.315" class="difflineplus">+                 const nsAString  &amp;aValue),              \</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineplus">+                (aWhere, aValue))                        \</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineplus">+                Double,                                  \</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineplus">+                 double aValue),                         \</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineplus">+                 double aValue),                         \</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineplus">+                (aWhere, aValue))                        \</span>
<a href="#l33.324"></a><span id="l33.324" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineplus">+                Int32,                                   \</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineplus">+                 PRInt32 aValue),                        \</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineplus">+                 PRInt32 aValue),                        \</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+                (aWhere, aValue))                        \</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineplus">+                Int64,                                   \</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineplus">+                 PRInt64 aValue),                        \</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineplus">+                 PRInt64 aValue),                        \</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineplus">+                (aWhere, aValue))                        \</span>
<a href="#l33.338"></a><span id="l33.338" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineplus">+                Null,                                    \</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineplus">+                (const nsACString &amp;aWhere),              \</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineplus">+                (PRUint32 aWhere),                       \</span>
<a href="#l33.342"></a><span id="l33.342" class="difflineplus">+                (aWhere))                                \</span>
<a href="#l33.343"></a><span id="l33.343" class="difflineplus">+  BIND_GEN_IMPL(_class, _optionalGuard,                  \</span>
<a href="#l33.344"></a><span id="l33.344" class="difflineplus">+                Blob,                                    \</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineplus">+                (const nsACString &amp;aWhere,               \</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineplus">+                 const PRUint8 *aValue,                  \</span>
<a href="#l33.347"></a><span id="l33.347" class="difflineplus">+                 PRUint32 aValueSize),                   \</span>
<a href="#l33.348"></a><span id="l33.348" class="difflineplus">+                (PRUint32 aWhere,                        \</span>
<a href="#l33.349"></a><span id="l33.349" class="difflineplus">+                 const PRUint8 *aValue,                  \</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineplus">+                 PRUint32 aValueSize),                   \</span>
<a href="#l33.351"></a><span id="l33.351" class="difflineplus">+                (aWhere, aValue, aValueSize))</span>
<a href="#l33.352"></a><span id="l33.352" class="difflineplus">+</span>
<a href="#l33.353"></a><span id="l33.353" class="difflineplus">+  </span>
<a href="#l33.354"></a><span id="l33.354" class="difflineplus">+</span>
<a href="#l33.355"></a><span id="l33.355" class="difflineplus">+} // storage</span>
<a href="#l33.356"></a><span id="l33.356" class="difflineplus">+} // mozilla</span>
<a href="#l33.357"></a><span id="l33.357" class="difflineplus">+</span>
<a href="#l33.358"></a><span id="l33.358" class="difflineplus">+#endif // mozilla_storage_StorageBaseStatementInternal_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/storage-backport/src/Variant.h</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,410 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ *</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+ *</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+ * License.</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+ *</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+ *</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+ *</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ *</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+ *</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+#ifndef mozilla_storage_Variant_h__</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+#define mozilla_storage_Variant_h__</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+#include &lt;utility&gt;</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+#include &quot;nsIVariant.h&quot;</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+/**</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+ * This class is used by the storage module whenever an nsIVariant needs to be</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+ * returned.  We provide traits for the basic sqlite types to make use easier.</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+ * The following types map to the indicated sqlite type:</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+ * PRInt64   -&gt; INTEGER (use IntegerVariant)</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+ * double    -&gt; FLOAT (use FloatVariant)</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+ * nsString  -&gt; TEXT (use TextVariant)</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+ * nsCString -&gt; TEXT (use UTF8TextVariant)</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+ * PRUint8[] -&gt; BLOB (use BlobVariant)</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+ * nsnull    -&gt; NULL (use NullVariant)</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+ */</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+namespace mozilla {</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+namespace storage {</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+//// Base Class</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+class Variant_base : public nsIVariant</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+{</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+public:</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+  NS_DECL_NSIVARIANT</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+protected:</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+  virtual ~Variant_base() { }</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+};</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+//// Traits</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+/**</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+ * Generics</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+ */</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+struct variant_traits</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineplus">+{</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_EMPTY; }</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+};</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+struct variant_storage_traits</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+{</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+  typedef DataType ConstructorType;</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+  typedef DataType StorageType;</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+  static inline StorageType storage_conversion(ConstructorType aData) { return aData; }</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+};</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+#define NO_CONVERSION return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+struct variant_integer_traits</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+{</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+  typedef typename variant_storage_traits&lt;DataType&gt;::StorageType StorageType;</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+  static inline nsresult asInt32(StorageType, PRInt32 *) { NO_CONVERSION }</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+  static inline nsresult asInt64(StorageType, PRInt64 *) { NO_CONVERSION }</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+};</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+struct variant_float_traits</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+{</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+  typedef typename variant_storage_traits&lt;DataType&gt;::StorageType StorageType;</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+  static inline nsresult asDouble(StorageType, double *) { NO_CONVERSION }</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+};</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+struct variant_text_traits</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+{</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+  typedef typename variant_storage_traits&lt;DataType&gt;::StorageType StorageType;</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  static inline nsresult asUTF8String(StorageType, nsACString &amp;) { NO_CONVERSION }</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+  static inline nsresult asString(StorageType, nsAString &amp;) { NO_CONVERSION }</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineplus">+};</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineplus">+struct variant_blob_traits</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineplus">+{</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineplus">+  typedef typename variant_storage_traits&lt;DataType&gt;::StorageType StorageType;</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineplus">+  static inline nsresult asArray(StorageType, PRUint16 *, PRUint32 *, void **)</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineplus">+  { NO_CONVERSION }</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineplus">+};</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineplus">+</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineplus">+#undef NO_CONVERSION</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+/**</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+ * INTEGER types</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineplus">+ */</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineplus">+</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineplus">+struct variant_traits&lt;PRInt64&gt;</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineplus">+{</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_INT64; }</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineplus">+};</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineplus">+struct variant_integer_traits&lt;PRInt64&gt;</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineplus">+{</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineplus">+  static inline nsresult asInt32(PRInt64 aValue,</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineplus">+                                 PRInt32 *_result)</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineplus">+  {</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineplus">+    if (aValue &gt; PR_INT32_MAX || aValue &lt; PR_INT32_MIN)</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineplus">+      return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineplus">+</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+    *_result = static_cast&lt;PRInt32&gt;(aValue);</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+  }</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineplus">+  static inline nsresult asInt64(PRInt64 aValue,</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+                                 PRInt64 *_result)</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineplus">+  {</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineplus">+    *_result = aValue;</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineplus">+  }</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineplus">+};</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineplus">+// xpcvariant just calls get double for integers...</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineplus">+struct variant_float_traits&lt;PRInt64&gt;</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+{</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+  static inline nsresult asDouble(PRInt64 aValue,</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineplus">+                                  double *_result)</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineplus">+  {</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineplus">+    *_result = double(aValue);</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineplus">+  }</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineplus">+};</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineplus">+</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineplus">+/**</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineplus">+ * FLOAT types</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineplus">+ */</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineplus">+</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineplus">+struct variant_traits&lt;double&gt;</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineplus">+{</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_DOUBLE; }</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+};</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineplus">+struct variant_float_traits&lt;double&gt;</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineplus">+{</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineplus">+  static inline nsresult asDouble(double aValue,</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineplus">+                                  double *_result)</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineplus">+  {</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineplus">+    *_result = aValue;</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineplus">+  }</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineplus">+};</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineplus">+</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineplus">+/**</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineplus">+ * TEXT types</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineplus">+ */</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+struct variant_traits&lt;nsString&gt;</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineplus">+{</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_ASTRING; }</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineplus">+};</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineplus">+struct variant_storage_traits&lt;nsString&gt;</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineplus">+{</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineplus">+  typedef const nsAString &amp; ConstructorType;</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineplus">+  typedef nsString StorageType;</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineplus">+  static inline StorageType storage_conversion(ConstructorType aText)</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineplus">+  {</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineplus">+    return StorageType(aText);</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineplus">+  }</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineplus">+};</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+struct variant_text_traits&lt;nsString&gt;</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+{</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineplus">+  static inline nsresult asUTF8String(const nsString &amp;aValue,</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineplus">+                                      nsACString &amp;_result)</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineplus">+  {</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineplus">+    CopyUTF16toUTF8(aValue, _result);</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineplus">+  }</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineplus">+  static inline nsresult asString(const nsString &amp;aValue,</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+                                  nsAString &amp;_result)</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineplus">+  {</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineplus">+    _result = aValue;</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineplus">+  }</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineplus">+};</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineplus">+</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+struct variant_traits&lt;nsCString&gt;</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineplus">+{</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_UTF8STRING; }</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineplus">+};</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineplus">+struct variant_storage_traits&lt;nsCString&gt;</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineplus">+{</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineplus">+  typedef const nsACString &amp; ConstructorType;</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+  typedef nsCString StorageType;</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineplus">+  static inline StorageType storage_conversion(ConstructorType aText)</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineplus">+  {</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineplus">+    return StorageType(aText);</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineplus">+  }</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineplus">+};</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineplus">+struct variant_text_traits&lt;nsCString&gt;</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+{</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineplus">+  static inline nsresult asUTF8String(const nsCString &amp;aValue,</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineplus">+                                      nsACString &amp;_result)</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineplus">+  {</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineplus">+    _result = aValue;</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineplus">+  }</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineplus">+  static inline nsresult asString(const nsCString &amp;aValue,</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineplus">+                                  nsAString &amp;_result)</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineplus">+  {</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineplus">+    CopyUTF8toUTF16(aValue, _result);</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineplus">+  }</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineplus">+};</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineplus">+</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineplus">+/**</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineplus">+ * BLOB types</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineplus">+ */</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineplus">+</span>
<a href="#l34.270"></a><span id="l34.270" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineplus">+struct variant_traits&lt;PRUint8[]&gt;</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineplus">+{</span>
<a href="#l34.273"></a><span id="l34.273" class="difflineplus">+  static inline PRUint16 type() { return nsIDataType::VTYPE_ARRAY; }</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineplus">+};</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineplus">+struct variant_storage_traits&lt;PRUint8[]&gt;</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineplus">+{</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineplus">+  typedef std::pair&lt;const void *, int&gt; ConstructorType;</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineplus">+  typedef nsTArray&lt;PRUint8&gt; StorageType;</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineplus">+  static inline StorageType storage_conversion(ConstructorType aBlob)</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineplus">+  {</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineplus">+    nsTArray&lt;PRUint8&gt; data(aBlob.second);</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineplus">+    (void)data.AppendElements(static_cast&lt;const PRUint8 *&gt;(aBlob.first),</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineplus">+                              aBlob.second);</span>
<a href="#l34.285"></a><span id="l34.285" class="difflineplus">+    return data;</span>
<a href="#l34.286"></a><span id="l34.286" class="difflineplus">+  }</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineplus">+};</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineplus">+template &lt; &gt;</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineplus">+struct variant_blob_traits&lt;PRUint8[]&gt;</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineplus">+{</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineplus">+  static inline nsresult asArray(nsTArray&lt;PRUint8&gt; &amp;aData,</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineplus">+                                 PRUint16 *_type,</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineplus">+                                 PRUint32 *_size,</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineplus">+                                 void **_result)</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineplus">+  {</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineplus">+    // For empty blobs, we return nsnull.</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineplus">+    if (aData.Length() == 0) {</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineplus">+      *_result = nsnull;</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineplus">+      *_type = nsIDataType::VTYPE_UINT8;</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineplus">+      *_size = 0;</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineplus">+      return NS_OK;</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineplus">+    }</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineplus">+</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineplus">+    // Otherwise, we copy the array.</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineplus">+    *_result = nsMemory::Clone(aData.Elements(), aData.Length() * sizeof(PRUint8));</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineplus">+    NS_ENSURE_TRUE(*_result, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineplus">+</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineplus">+    // Set type and size</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineplus">+    *_type = nsIDataType::VTYPE_UINT8;</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineplus">+    *_size = aData.Length();</span>
<a href="#l34.311"></a><span id="l34.311" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineplus">+  }</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineplus">+};</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineplus">+</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineplus">+/**</span>
<a href="#l34.316"></a><span id="l34.316" class="difflineplus">+ * NULL type</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineplus">+ */</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineplus">+</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineplus">+class NullVariant : public Variant_base</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineplus">+{</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+public:</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineplus">+  NS_IMETHOD GetDataType(PRUint16 *_type)</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineplus">+  {</span>
<a href="#l34.324"></a><span id="l34.324" class="difflineplus">+    NS_ENSURE_ARG_POINTER(_type);</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineplus">+    *_type = nsIDataType::VTYPE_EMPTY;</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineplus">+  }</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineplus">+</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineplus">+  NS_IMETHOD GetAsAUTF8String(nsACString &amp;_str)</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineplus">+  {</span>
<a href="#l34.331"></a><span id="l34.331" class="difflineplus">+    // Return a void string.</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineplus">+    _str.Truncate(0);</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineplus">+    _str.SetIsVoid(PR_TRUE);</span>
<a href="#l34.334"></a><span id="l34.334" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.335"></a><span id="l34.335" class="difflineplus">+  }</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineplus">+</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineplus">+  NS_IMETHOD GetAsAString(nsAString &amp;_str)</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineplus">+  {</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+    // Return a void string.</span>
<a href="#l34.340"></a><span id="l34.340" class="difflineplus">+    _str.Truncate(0);</span>
<a href="#l34.341"></a><span id="l34.341" class="difflineplus">+    _str.SetIsVoid(PR_TRUE);</span>
<a href="#l34.342"></a><span id="l34.342" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.343"></a><span id="l34.343" class="difflineplus">+  }</span>
<a href="#l34.344"></a><span id="l34.344" class="difflineplus">+};</span>
<a href="#l34.345"></a><span id="l34.345" class="difflineplus">+</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineplus">+//// Template Implementation</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineplus">+</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineplus">+template &lt;typename DataType&gt;</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineplus">+class Variant : public Variant_base</span>
<a href="#l34.351"></a><span id="l34.351" class="difflineplus">+{</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineplus">+public:</span>
<a href="#l34.353"></a><span id="l34.353" class="difflineplus">+  Variant(typename variant_storage_traits&lt;DataType&gt;::ConstructorType aData)</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineplus">+    : mData(variant_storage_traits&lt;DataType&gt;::storage_conversion(aData))</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineplus">+  {</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineplus">+  }</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineplus">+</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineplus">+  NS_IMETHOD GetDataType(PRUint16 *_type)</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineplus">+  {</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineplus">+    *_type = variant_traits&lt;DataType&gt;::type();</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineplus">+    return NS_OK;</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineplus">+  }</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+  NS_IMETHOD GetAsInt32(PRInt32 *_integer)</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+  {</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+    return variant_integer_traits&lt;DataType&gt;::asInt32(mData, _integer);</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+  }</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineplus">+</span>
<a href="#l34.368"></a><span id="l34.368" class="difflineplus">+  NS_IMETHOD GetAsInt64(PRInt64 *_integer)</span>
<a href="#l34.369"></a><span id="l34.369" class="difflineplus">+  {</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineplus">+    return variant_integer_traits&lt;DataType&gt;::asInt64(mData, _integer);</span>
<a href="#l34.371"></a><span id="l34.371" class="difflineplus">+  }</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineplus">+</span>
<a href="#l34.373"></a><span id="l34.373" class="difflineplus">+  NS_IMETHOD GetAsDouble(double *_double)</span>
<a href="#l34.374"></a><span id="l34.374" class="difflineplus">+  {</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineplus">+    return variant_float_traits&lt;DataType&gt;::asDouble(mData, _double);</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineplus">+  }</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineplus">+</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineplus">+  NS_IMETHOD GetAsAUTF8String(nsACString &amp;_str)</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineplus">+  {</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineplus">+    return variant_text_traits&lt;DataType&gt;::asUTF8String(mData, _str);</span>
<a href="#l34.381"></a><span id="l34.381" class="difflineplus">+  }</span>
<a href="#l34.382"></a><span id="l34.382" class="difflineplus">+</span>
<a href="#l34.383"></a><span id="l34.383" class="difflineplus">+  NS_IMETHOD GetAsAString(nsAString &amp;_str)</span>
<a href="#l34.384"></a><span id="l34.384" class="difflineplus">+  {</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineplus">+    return variant_text_traits&lt;DataType&gt;::asString(mData, _str);</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineplus">+  }</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineplus">+</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineplus">+  NS_IMETHOD GetAsArray(PRUint16 *_type,</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineplus">+                        nsIID *,</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineplus">+                        PRUint32 *_size,</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineplus">+                        void **_data)</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineplus">+  {</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineplus">+    return variant_blob_traits&lt;DataType&gt;::asArray(mData, _type, _size, _data);</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineplus">+  }</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineplus">+</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineplus">+private:</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+  typename variant_storage_traits&lt;DataType&gt;::StorageType mData;</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+};</span>
<a href="#l34.399"></a><span id="l34.399" class="difflineplus">+</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineplus">+//// Handy typedefs!  Use these for the right mapping.</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineplus">+</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineplus">+typedef Variant&lt;PRInt64&gt; IntegerVariant;</span>
<a href="#l34.404"></a><span id="l34.404" class="difflineplus">+typedef Variant&lt;double&gt; FloatVariant;</span>
<a href="#l34.405"></a><span id="l34.405" class="difflineplus">+typedef Variant&lt;nsString&gt; TextVariant;</span>
<a href="#l34.406"></a><span id="l34.406" class="difflineplus">+typedef Variant&lt;nsCString&gt; UTF8TextVariant;</span>
<a href="#l34.407"></a><span id="l34.407" class="difflineplus">+typedef Variant&lt;PRUint8[]&gt; BlobVariant;</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineplus">+</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineplus">+} // namespace storage</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineplus">+} // namespace mozilla</span>
<a href="#l34.411"></a><span id="l34.411" class="difflineplus">+</span>
<a href="#l34.412"></a><span id="l34.412" class="difflineplus">+#include &quot;Variant_inl.h&quot;</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineplus">+</span>
<a href="#l34.414"></a><span id="l34.414" class="difflineplus">+#endif // mozilla_storage_Variant_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/storage-backport/src/Variant_inl.h</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,262 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ *</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ *</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * License.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ *</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ *</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ *</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+ *</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+/**</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+ * Note: This file is included by Variant.h.</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+ */</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+#ifndef mozilla_storage_Variant_h__</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+#error &quot;Do not include this file directly!&quot;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+#endif</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+namespace mozilla {</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+namespace storage {</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+//// Variant_base</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+inline NS_IMPL_THREADSAFE_ADDREF(Variant_base)</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+inline NS_IMPL_THREADSAFE_RELEASE(Variant_base)</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+inline NS_IMPL_THREADSAFE_QUERY_INTERFACE1(</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+  Variant_base,</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+  nsIVariant</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+)</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+//// nsIVariant</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+inline</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+Variant_base::GetDataType(PRUint16 *_type)</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+{</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_type);</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+  *_type = nsIDataType::VTYPE_VOID;</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  return NS_OK;</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+}</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+inline</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+Variant_base::GetAsInt32(PRInt32 *)</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+{</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+}</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+inline</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+Variant_base::GetAsInt64(PRInt64 *)</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+{</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+}</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+inline</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+Variant_base::GetAsDouble(double *)</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+{</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+}</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+inline</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+Variant_base::GetAsAUTF8String(nsACString &amp;)</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+{</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+}</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+inline</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+Variant_base::GetAsAString(nsAString &amp;)</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+{</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+}</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+inline</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+Variant_base::GetAsArray(PRUint16 *,</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+                         nsIID *,</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+                         PRUint32 *,</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+                         void **)</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+{</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+}</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+inline</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+Variant_base::GetAsInt8(PRUint8 *)</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+{</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+}</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+inline</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+Variant_base::GetAsInt16(PRInt16 *)</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+{</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+}</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+inline</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+Variant_base::GetAsUint8(PRUint8 *)</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+{</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+}</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+inline</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+Variant_base::GetAsUint16(PRUint16 *)</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+{</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+}</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+inline</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+Variant_base::GetAsUint32(PRUint32 *)</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+{</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+}</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+inline</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+Variant_base::GetAsUint64(PRUint64 *)</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+{</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+}</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+inline</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+Variant_base::GetAsFloat(float *)</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+{</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+}</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+inline</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+Variant_base::GetAsBool(PRBool *)</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+{</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+}</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+inline</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+Variant_base::GetAsChar(char *)</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+{</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+}</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+inline</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+Variant_base::GetAsWChar(PRUnichar *)</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+{</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+}</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+inline</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+Variant_base::GetAsID(nsID *)</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+{</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+}</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+inline</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+Variant_base::GetAsDOMString(nsAString &amp;)</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+{</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+}</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+inline</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+Variant_base::GetAsString(char **)</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+{</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+}</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+inline</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+Variant_base::GetAsWString(PRUnichar **)</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+{</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+}</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+inline</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+Variant_base::GetAsISupports(nsISupports **)</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+{</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+}</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+inline</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+Variant_base::GetAsInterface(nsIID **,</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+                             void **)</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+{</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+}</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+inline</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+Variant_base::GetAsACString(nsACString &amp;)</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+{</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+}</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+inline</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+Variant_base::GetAsStringWithSize(PRUint32 *,</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+                                  char **)</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+{</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+}</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+inline</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+Variant_base::GetAsWStringWithSize(PRUint32 *,</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+                                   PRUnichar **)</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+{</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+}</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+inline</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+Variant_base::GetAsJSVal(jsval *)</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+{</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+  return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+}</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+} // namespace storage</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/storage-backport/src/mozStorageArgValueArray.cpp</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,236 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+ *</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+ *</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+ * License.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+ *</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+ *</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+ *</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+ *</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+ *</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+#include &quot;mozStorageArgValueArray.h&quot;</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+namespace storage {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+//// ArgValueArray</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+ArgValueArray::ArgValueArray(PRInt32 aArgc,</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+                             sqlite3_value **aArgv)</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+: mArgc(aArgc)</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+, mArgv(aArgv)</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+{</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+}</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+NS_IMPL_ISUPPORTS1(</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+  ArgValueArray,</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+  mozIStorageValueArray</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+)</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+//// mozIStorageValueArray</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+ArgValueArray::GetNumEntries(PRUint32 *_size)</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+{</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+  *_size = mArgc;</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+}</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+ArgValueArray::GetTypeOfIndex(PRUint32 aIndex,</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+                              PRInt32 *_type)</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+{</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+  int t = ::sqlite3_value_type(mArgv[aIndex]);</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+  switch (t) {</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+    case SQLITE_INTEGER:</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+      *_type = VALUE_TYPE_INTEGER;</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+      break;</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+    case SQLITE_FLOAT:</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+      *_type = VALUE_TYPE_FLOAT;</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+      break;</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+    case SQLITE_TEXT:</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+      *_type = VALUE_TYPE_TEXT;</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+      break;</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+    case SQLITE_BLOB:</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+      *_type = VALUE_TYPE_BLOB;</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+      break;</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+    case SQLITE_NULL:</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+      *_type = VALUE_TYPE_NULL;</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+      break;</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+    default:</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+  }</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+}</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+ArgValueArray::GetInt32(PRUint32 aIndex,</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+                        PRInt32 *_value)</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+{</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+  *_value = ::sqlite3_value_int(mArgv[aIndex]);</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+}</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+ArgValueArray::GetInt64(PRUint32 aIndex,</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+                        PRInt64 *_value)</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+{</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+  *_value = ::sqlite3_value_int64(mArgv[aIndex]);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+}</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+ArgValueArray::GetDouble(PRUint32 aIndex,</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+                         double *_value)</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+{</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+  *_value = ::sqlite3_value_double(mArgv[aIndex]);</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+}</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+ArgValueArray::GetUTF8String(PRUint32 aIndex,</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+                             nsACString &amp;_value)</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+{</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+  if (::sqlite3_value_type(mArgv[aIndex]) == SQLITE_NULL) {</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+    // NULL columns should have IsVoid set to distinguish them from an empty</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+    // string.</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+    _value.Truncate(0);</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+    _value.SetIsVoid(PR_TRUE);</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+  }</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+  else {</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+    _value.Assign(reinterpret_cast&lt;const char *&gt;(::sqlite3_value_text(mArgv[aIndex])),</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+                  ::sqlite3_value_bytes(mArgv[aIndex]));</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+  }</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+}</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+ArgValueArray::GetString(PRUint32 aIndex,</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+                         nsAString &amp;_value)</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+{</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+  if (::sqlite3_value_type(mArgv[aIndex]) == SQLITE_NULL) {</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+    // NULL columns should have IsVoid set to distinguish them from an empty</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+    // string.</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+    _value.Truncate(0);</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+    _value.SetIsVoid(PR_TRUE);</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+  } else {</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+    _value.Assign(static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(mArgv[aIndex])),</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineplus">+                  ::sqlite3_value_bytes16(mArgv[aIndex]) / 2);</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+  }</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+}</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+ArgValueArray::GetBlob(PRUint32 aIndex,</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+                       PRUint32 *_size,</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+                       PRUint8 **_blob)</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+{</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mArgc);</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+  int size = ::sqlite3_value_bytes(mArgv[aIndex]);</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+  void *blob = nsMemory::Clone(::sqlite3_value_blob(mArgv[aIndex]), size);</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+  NS_ENSURE_TRUE(blob, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+  *_blob = static_cast&lt;PRUint8 *&gt;(blob);</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineplus">+  *_size = size;</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineplus">+}</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineplus">+</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+ArgValueArray::GetIsNull(PRUint32 aIndex,</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+                         PRBool *_isNull)</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+{</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+  // GetTypeOfIndex will check aIndex for us, so we don't have to.</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+  PRInt32 type;</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+  nsresult rv = GetTypeOfIndex(aIndex, &amp;type);</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineplus">+  *_isNull = (type == VALUE_TYPE_NULL);</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+}</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineplus">+</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineplus">+ArgValueArray::GetSharedUTF8String(PRUint32 aIndex,</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+                                   PRUint32 *_length,</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+                                   const char **_string)</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineplus">+{</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+  if (_length)</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+    *_length = ::sqlite3_value_bytes(mArgv[aIndex]);</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineplus">+</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+  *_string = reinterpret_cast&lt;const char *&gt;(::sqlite3_value_text(mArgv[aIndex]));</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+}</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+ArgValueArray::GetSharedString(PRUint32 aIndex,</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineplus">+                               PRUint32 *_length,</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+                               const PRUnichar **_string)</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+{</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineplus">+  if (_length)</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineplus">+    *_length = ::sqlite3_value_bytes(mArgv[aIndex]);</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineplus">+</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineplus">+  *_string = static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(mArgv[aIndex]));</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+}</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+ArgValueArray::GetSharedBlob(PRUint32 aIndex,</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+                             PRUint32 *_size,</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+                             const PRUint8 **_blob)</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+{</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineplus">+  *_size = ::sqlite3_value_bytes(mArgv[aIndex]);</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineplus">+  *_blob = static_cast&lt;const PRUint8 *&gt;(::sqlite3_value_blob(mArgv[aIndex]));</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+}</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineplus">+</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineplus">+} // namespace storage</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/storage-backport/src/mozStorageArgValueArray.h</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+ *</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ *</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ * License.</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ *</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ *</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ *</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+ *</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+ *</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+#ifndef _mozStorageArgValueArray_h_</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+#define _mozStorageArgValueArray_h_</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+#include &quot;mozIStorageValueArray.h&quot;</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+namespace storage {</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+class ArgValueArray : public mozIStorageValueArray</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+{</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+public:</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+  ArgValueArray(PRInt32 aArgc, sqlite3_value **aArgv);</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+  NS_DECL_MOZISTORAGEVALUEARRAY</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+private:</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+  PRUint32 mArgc;</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+  sqlite3_value **mArgv;</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+};</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+} // namespace storage</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+} // namespace mozilla</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+#endif // _mozStorageArgValueArray_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatement.cpp</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,452 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+ *</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+ *</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+ * License.</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+ *</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+ * The Original Code is mozStorage.</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+ *</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+ *</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+ *   John Zhang &lt;jzhang@aptana.com&gt;</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+ *</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+ *</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+#include &lt;limits.h&gt;</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+#include &quot;nsProxyRelease.h&quot;</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+#include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+#include &quot;nsIProgrammingLanguage.h&quot;</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+#include &quot;Variant.h&quot;</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+#include &quot;mozIStorageError.h&quot;</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+#include &quot;mozStorageBindingParams.h&quot;</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+#include &quot;mozStorageAsyncStatementJSHelper.h&quot;</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+#include &quot;mozStorageAsyncStatementParams.h&quot;</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+#include &quot;mozStorageStatementRow.h&quot;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+extern PRLogModuleInfo *gStorageLog;</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+#endif</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+namespace mozilla {</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+namespace storage {</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+//// nsIClassInfo</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+NS_IMPL_CI_INTERFACE_GETTER4(</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  AsyncStatement</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+, mozIStorageAsyncStatement</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+, mozIStorageBaseStatement</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+, mozIStorageBindingParams</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+, mozilla::storage::StorageBaseStatementInternal</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+)</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+class AsyncStatementClassInfo : public nsIClassInfo</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+{</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+public:</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+  GetInterfaces(PRUint32 *_count, nsIID ***_array)</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+  {</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    return NS_CI_INTERFACE_GETTER_NAME(AsyncStatement)(_count, _array);</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  }</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+  GetHelperForLanguage(PRUint32 aLanguage, nsISupports **_helper)</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+  {</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+    if (aLanguage == nsIProgrammingLanguage::JAVASCRIPT) {</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+      static AsyncStatementJSHelper sJSHelper;</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+      *_helper = &amp;sJSHelper;</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+      return NS_OK;</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    }</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+    *_helper = nsnull;</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+  }</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+  GetContractID(char **_contractID)</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+  {</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+    *_contractID = nsnull;</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+  }</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+  GetClassDescription(char **_desc)</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+  {</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+    *_desc = nsnull;</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+  }</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+  GetClassID(nsCID **_id)</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+  {</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+    *_id = nsnull;</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+  }</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+  GetImplementationLanguage(PRUint32 *_language)</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+  {</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+    *_language = nsIProgrammingLanguage::CPLUSPLUS;</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+  }</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+  GetFlags(PRUint32 *_flags)</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+  {</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+    *_flags = nsnull;</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+  }</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+  GetClassIDNoAlloc(nsCID *_cid)</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+  {</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineplus">+  }</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineplus">+};</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineplus">+</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) AsyncStatementClassInfo::AddRef() { return 2; }</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) AsyncStatementClassInfo::Release() { return 1; }</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineplus">+NS_IMPL_QUERY_INTERFACE1(AsyncStatementClassInfo, nsIClassInfo)</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineplus">+</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineplus">+static AsyncStatementClassInfo sAsyncStatementClassInfo;</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineplus">+</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+//// AsyncStatement</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineplus">+</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineplus">+AsyncStatement::AsyncStatement()</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+: StorageBaseStatementInternal()</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+, mFinalized(false)</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineplus">+{</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+}</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineplus">+</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+nsresult</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+AsyncStatement::initialize(Connection *aDBConnection,</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+                           const nsACString &amp;aSQLStatement)</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+{</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineplus">+  NS_ASSERTION(aDBConnection, &quot;No database connection given!&quot;);</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineplus">+  NS_ASSERTION(aDBConnection-&gt;GetNativeConnection(),</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineplus">+               &quot;We should never be called with a null sqlite3 database!&quot;);</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineplus">+</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineplus">+  mDBConnection = aDBConnection;</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineplus">+  mSQLString = aSQLStatement;</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineplus">+</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Inited async statement '%s' (0x%p)&quot;,</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineplus">+                                      mSQLString.get()));</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+#endif</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineplus">+</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineplus">+  // We want to try and test for LIKE and that consumers are using</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineplus">+  // escapeStringForLIKE instead of just trusting user input.  The idea to</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineplus">+  // check to see if they are binding a parameter after like instead of just</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineplus">+  // using a string.  We only do this in debug builds because it's expensive!</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineplus">+  const nsCaseInsensitiveCStringComparator c;</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineplus">+  nsACString::const_iterator start, end, e;</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineplus">+  aSQLStatement.BeginReading(start);</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineplus">+  aSQLStatement.EndReading(end);</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineplus">+  e = end;</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineplus">+  while (::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE&quot;), start, e, c)) {</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineplus">+    // We have a LIKE in here, so we perform our tests</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineplus">+    // FindInReadable moves the iterator, so we have to get a new one for</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineplus">+    // each test we perform.</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineplus">+    nsACString::const_iterator s1, s2, s3;</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineplus">+    s1 = s2 = s3 = start;</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineplus">+</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineplus">+    if (!(::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE ?&quot;), s1, end, c) ||</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineplus">+          ::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE :&quot;), s2, end, c) ||</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineplus">+          ::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE @&quot;), s3, end, c))) {</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineplus">+      // At this point, we didn't find a LIKE statement followed by ?, :,</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineplus">+      // or @, all of which are valid characters for binding a parameter.</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineplus">+      // We will warn the consumer that they may not be safely using LIKE.</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineplus">+      NS_WARNING(&quot;Unsafe use of LIKE detected!  Please ensure that you &quot;</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineplus">+                 &quot;are using mozIStorageAsyncStatement::escapeStringForLIKE &quot;</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineplus">+                 &quot;and that you are binding that result to the statement &quot;</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineplus">+                 &quot;to prevent SQL injection attacks.&quot;);</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineplus">+    }</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineplus">+</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineplus">+    // resetting start and e</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineplus">+    start = e;</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineplus">+    e = end;</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineplus">+  }</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineplus">+#endif</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineplus">+</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineplus">+}</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineplus">+mozIStorageBindingParams *</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineplus">+AsyncStatement::getParams()</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineplus">+{</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineplus">+  nsresult rv;</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineplus">+</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineplus">+  // If we do not have an array object yet, make it.</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineplus">+  if (!mParamsArray) {</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineplus">+    nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; array;</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineplus">+    rv = NewBindingParamsArray(getter_AddRefs(array));</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineplus">+</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineplus">+    mParamsArray = static_cast&lt;BindingParamsArray *&gt;(array.get());</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineplus">+  }</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineplus">+</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineplus">+  // If there isn't already any rows added, we'll have to add one to use.</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineplus">+  if (mParamsArray-&gt;length() == 0) {</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineplus">+    nsRefPtr&lt;AsyncBindingParams&gt; params(new AsyncBindingParams(mParamsArray));</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineplus">+    NS_ENSURE_TRUE(params, nsnull);</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineplus">+    rv = mParamsArray-&gt;AddParams(params);</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineplus">+</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineplus">+    // We have to unlock our params because AddParams locks them.  This is safe</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineplus">+    // because no reference to the params object was, or ever will be given out.</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineplus">+    params-&gt;unlock(nsnull);</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineplus">+</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineplus">+    // We also want to lock our array at this point - we don't want anything to</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineplus">+    // be added to it.</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineplus">+    mParamsArray-&gt;lock();</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineplus">+  }</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineplus">+  return *mParamsArray-&gt;begin();</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineplus">+}</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineplus">+</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineplus">+/**</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineplus">+ * If we are here then we know there are no pending async executions relying on</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineplus">+ * us (StatementData holds a reference to us; this also goes for our own</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineplus">+ * AsyncStatementFinalizer which proxies its release to the calling thread) and</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineplus">+ * so it is always safe to destroy our sqlite3_stmt if one exists.  We can be</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineplus">+ * destroyed on the caller thread by garbage-collection/reference counting or on</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineplus">+ * the async thread by the last execution of a statement that already lost its</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+ * main-thread refs.</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+ */</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineplus">+AsyncStatement::~AsyncStatement()</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+{</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineplus">+  internalAsyncFinalize();</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineplus">+  cleanupJSHelpers();</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineplus">+</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineplus">+  // If we are getting destroyed on the wrong thread, proxy the connection</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+  // release to the right thread.  I'm not sure why we do this.</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineplus">+  PRBool onCallingThread = PR_FALSE;</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineplus">+  (void)mDBConnection-&gt;threadOpenedOn-&gt;IsOnCurrentThread(&amp;onCallingThread);</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineplus">+  if (!onCallingThread) {</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineplus">+    // NS_ProxyRelase only magic forgets for us if mDBConnection is an</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineplus">+    // nsCOMPtr.  Which it is not; it's an nsRefPtr.</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineplus">+    Connection *forgottenConn = nsnull;</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineplus">+    mDBConnection.swap(forgottenConn);</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineplus">+    (void)::NS_ProxyRelease(mDBConnection-&gt;threadOpenedOn, forgottenConn);</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineplus">+  }</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineplus">+}</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineplus">+</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineplus">+void</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineplus">+AsyncStatement::cleanupJSHelpers()</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineplus">+{</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineplus">+  // We are considered dead at this point, so any wrappers for row or params</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+  // need to lose their reference to us.</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineplus">+  if (mStatementParamsHolder) {</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnectWrappedNative&gt; wrapper =</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineplus">+      do_QueryInterface(mStatementParamsHolder);</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementParams&gt; iParams =</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineplus">+      do_QueryWrappedNative(wrapper);</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineplus">+    AsyncStatementParams *params =</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineplus">+      static_cast&lt;AsyncStatementParams *&gt;(iParams.get());</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineplus">+    params-&gt;mStatement = nsnull;</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineplus">+    mStatementParamsHolder = nsnull;</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineplus">+  }</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineplus">+}</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineplus">+</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineplus">+//// nsISupports</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineplus">+</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineplus">+NS_IMPL_THREADSAFE_ADDREF(AsyncStatement)</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+NS_IMPL_THREADSAFE_RELEASE(AsyncStatement)</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineplus">+</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineplus">+NS_INTERFACE_MAP_BEGIN(AsyncStatement)</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageAsyncStatement)</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageBaseStatement)</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageBindingParams)</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozilla::storage::StorageBaseStatementInternal)</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineplus">+  if (aIID.Equals(NS_GET_IID(nsIClassInfo))) {</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineplus">+    foundInterface = static_cast&lt;nsIClassInfo *&gt;(&amp;sAsyncStatementClassInfo);</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineplus">+  }</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineplus">+  else</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, mozIStorageAsyncStatement)</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l38.316"></a><span id="l38.316" class="difflineplus">+</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineplus">+</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineplus">+//// StorageBaseStatementInternal</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineplus">+</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineplus">+Connection *</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+AsyncStatement::getOwner()</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+{</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+  return mDBConnection;</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+}</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+int</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+AsyncStatement::getAsyncStatement(sqlite3_stmt **_stmt)</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+{</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineplus">+  // Make sure we are never called on the connection's owning thread.</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineplus">+  PRBool onOpenedThread = PR_FALSE;</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineplus">+  (void)mDBConnection-&gt;threadOpenedOn-&gt;IsOnCurrentThread(&amp;onOpenedThread);</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineplus">+  NS_ASSERTION(!onOpenedThread,</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineplus">+               &quot;We should only be called on the async thread!&quot;);</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+#endif</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineplus">+  if (!mAsyncStatement) {</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineplus">+    int rc = ::sqlite3_prepare_v2(mDBConnection-&gt;GetNativeConnection(),</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineplus">+                                  mSQLString.get(), -1,</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineplus">+                                  &amp;mAsyncStatement, NULL);</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineplus">+    if (rc != SQLITE_OK) {</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineplus">+      PR_LOG(gStorageLog, PR_LOG_ERROR,</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineplus">+             (&quot;Sqlite statement prepare error: %d '%s'&quot;, rc,</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineplus">+              ::sqlite3_errmsg(mDBConnection-&gt;GetNativeConnection())));</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineplus">+      PR_LOG(gStorageLog, PR_LOG_ERROR,</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineplus">+             (&quot;Statement was: '%s'&quot;, mSQLString.get()));</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineplus">+#endif</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineplus">+      *_stmt = nsnull;</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineplus">+      return rc;</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+    }</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineplus">+</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineplus">+    PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Initialized statement '%s' (0x%p)&quot;,</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineplus">+                                        mSQLString.get(),</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineplus">+                                        mAsyncStatement));</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineplus">+#endif</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineplus">+  }</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineplus">+</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineplus">+  *_stmt = mAsyncStatement;</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineplus">+}</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineplus">+</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineplus">+nsresult</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineplus">+AsyncStatement::getAsynchronousStatementData(StatementData &amp;_data)</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineplus">+{</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+  if (mFinalized)</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineplus">+</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineplus">+  // Pass null for the sqlite3_stmt; it will be requested on demand from the</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineplus">+  // async thread.</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineplus">+  _data = StatementData(nsnull, bindingParamsArray(), this);</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineplus">+</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineplus">+}</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineplus">+</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineplus">+already_AddRefed&lt;mozIStorageBindingParams&gt;</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineplus">+AsyncStatement::newBindingParams(mozIStorageBindingParamsArray *aOwner)</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineplus">+{</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineplus">+  if (mFinalized)</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineplus">+    return nsnull;</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineplus">+</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParams&gt; params(new AsyncBindingParams(aOwner));</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineplus">+  return params.forget();</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineplus">+}</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineplus">+</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineplus">+//// mozIStorageAsyncStatement</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineplus">+</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineplus">+// (nothing is specific to mozIStorageAsyncStatement)</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineplus">+//// StorageBaseStatementInternal</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineplus">+</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineplus">+// proxy to StorageBaseStatementInternal using its define helper.</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineplus">+MIXIN_IMPL_STORAGEBASESTATEMENTINTERNAL(</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineplus">+  AsyncStatement,</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+  if (mFinalized) return NS_ERROR_UNEXPECTED;)</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineplus">+</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineplus">+AsyncStatement::Finalize()</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineplus">+{</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+  if (mFinalized)</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineplus">+</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineplus">+  mFinalized = true;</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Finalizing statement '%s'&quot;,</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineplus">+                                      mSQLString.get()));</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineplus">+#endif</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineplus">+</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineplus">+  asyncFinalize();</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineplus">+  cleanupJSHelpers();</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineplus">+</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineplus">+}</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineplus">+AsyncStatement::BindParameters(mozIStorageBindingParamsArray *aParameters)</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineplus">+{</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineplus">+  if (mFinalized)</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineplus">+</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineplus">+  BindingParamsArray *array = static_cast&lt;BindingParamsArray *&gt;(aParameters);</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineplus">+  if (array-&gt;getOwner() != this)</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineplus">+</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineplus">+  mParamsArray = array;</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineplus">+  mParamsArray-&gt;lock();</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineplus">+</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineplus">+}</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineplus">+</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineplus">+AsyncStatement::GetState(PRInt32 *_state)</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineplus">+{</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineplus">+  if (mFinalized)</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineplus">+    *_state = MOZ_STORAGE_STATEMENT_INVALID;</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineplus">+  else</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineplus">+    *_state = MOZ_STORAGE_STATEMENT_READY;</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineplus">+</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineplus">+}</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineplus">+//// mozIStorageBindingParams</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineplus">+</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineplus">+BOILERPLATE_BIND_PROXIES(</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineplus">+  AsyncStatement, </span>
<a href="#l38.453"></a><span id="l38.453" class="difflineplus">+  if (mFinalized) return NS_ERROR_UNEXPECTED;)</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineplus">+</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineplus">+} // namespace storage</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatement.h</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,145 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+ *</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+ *</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+ * License.</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+ *</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+ *</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+ *</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+ *</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+ *</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+#ifndef mozilla_storage_mozStorageAsyncStatement_h_</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+#define mozilla_storage_mozStorageAsyncStatement_h_</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+#include &quot;mozStorageStatementData.h&quot;</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+#include &quot;mozIStorageAsyncStatement.h&quot;</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+class nsIXPConnectJSObjectHolder;</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+namespace mozilla {</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+namespace storage {</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+class AsyncStatementJSHelper;</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+class Connection;</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+class AsyncStatement : public mozIStorageAsyncStatement</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+                     , public StorageBaseStatementInternal</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+{</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+public:</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+  NS_DECL_MOZISTORAGEASYNCSTATEMENT</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+  NS_DECL_MOZISTORAGEBASESTATEMENT</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+  NS_DECL_MOZISTORAGEBINDINGPARAMS</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+  NS_DECL_STORAGEBASESTATEMENTINTERNAL</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+  AsyncStatement();</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+  /**</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+   * Initializes the object on aDBConnection by preparing the SQL statement</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+   * given by aSQLStatement.</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+   *</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+   * @param aDBConnection</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+   *        The Connection object this statement is associated with.</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+   * @param aSQLStatement</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+   *        The SQL statement to prepare that this object will represent.</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+   */</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  nsresult initialize(Connection *aDBConnection,</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+                      const nsACString &amp;aSQLStatement);</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+  /**</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+   * Obtains and transfers ownership of the array of parameters that are bound</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+   * to this statment.  This can be null.</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+   */</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+  inline already_AddRefed&lt;BindingParamsArray&gt; bindingParamsArray()</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+  {</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+    return mParamsArray.forget();</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+  }</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+private:</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+  ~AsyncStatement();</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+  /**</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+   * Clean up the references JS helpers hold to us.  For cycle-avoidance reasons</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+   * they do not hold reference-counted references to us, so it is important</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+   * we do this.</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+   */</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+  void cleanupJSHelpers();</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+  /**</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+   * @return a pointer to the BindingParams object to use with our Bind*</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+   *         method.</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+   */</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+  mozIStorageBindingParams *getParams();</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+  /**</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+   * The SQL string as passed by the user.  We store it because we create the</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+   * async statement on-demand on the async thread.</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+   */</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+  nsCString mSQLString;</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+  /**</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+   * Holds the array of parameters to bind to this statement when we execute</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+   * it asynchronously.</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+   */</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+  nsRefPtr&lt;BindingParamsArray&gt; mParamsArray;</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+  /**</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+   * Caches the JS 'params' helper for this statement.</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+   */</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+  nsCOMPtr&lt;nsIXPConnectJSObjectHolder&gt; mStatementParamsHolder;</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+  /**</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+   * Have we been explicitly finalized by the user?</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+   */</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+  bool mFinalized;</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+  /**</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+   * Required for access to private mStatementParamsHolder field by</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+   * AsyncStatementJSHelper::getParams.</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+   */</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+  friend class AsyncStatementJSHelper;</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+};</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+} // storage</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+} // mozilla</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+#endif // mozilla_storage_mozStorageAsyncStatement_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementExecution.cpp</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,615 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+ *</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+ *</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+ * License.</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+ *</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+ *</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ * Mozilla Corporation. </span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+ *</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+ *</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+ *</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+#include &quot;prtime.h&quot;</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+#include &quot;mozIStorageStatementCallback.h&quot;</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+#include &quot;mozStorageBindingParams.h&quot;</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+#include &quot;mozStorageHelper.h&quot;</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+#include &quot;mozStorageResultSet.h&quot;</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+#include &quot;mozStorageRow.h&quot;</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+#include &quot;mozStorageError.h&quot;</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+#include &quot;mozStorageStatementData.h&quot;</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+#include &quot;mozStorageAsyncStatementExecution.h&quot;</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+namespace mozilla {</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+namespace storage {</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+/**</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+ * The following constants help batch rows into result sets.</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+ * MAX_MILLISECONDS_BETWEEN_RESULTS was chosen because any user-based task that</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+ * takes less than 200 milliseconds is considered to feel instantaneous to end</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+ * users.  MAX_ROWS_PER_RESULT was arbitrarily chosen to reduce the number of</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+ * dispatches to calling thread, while also providing reasonably-sized sets of</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+ * data for consumers.  Both of these constants are used because we assume that</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+ * consumers are trying to avoid blocking their execution thread for long</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+ * periods of time, and dispatching many small events to the calling thread will</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+ * end up blocking it.</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+ */</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+#define MAX_MILLISECONDS_BETWEEN_RESULTS 75</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+#define MAX_ROWS_PER_RESULT 15</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+//// Local Classes</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+namespace {</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+typedef AsyncExecuteStatements::ExecutionState ExecutionState;</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+/**</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+ * Notifies a callback with a result set.</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+ */</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+class CallbackResultNotifier : public nsRunnable</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+{</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineplus">+public:</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+  CallbackResultNotifier(mozIStorageStatementCallback *aCallback,</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+                         mozIStorageResultSet *aResults,</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+                         AsyncExecuteStatements *aEventStatus) :</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineplus">+      mCallback(aCallback)</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+    , mResults(aResults)</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+    , mEventStatus(aEventStatus)</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+  {</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+  }</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+  {</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+    NS_ASSERTION(mCallback, &quot;Trying to notify about results without a callback!&quot;);</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+    if (mEventStatus-&gt;shouldNotify())</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+      (void)mCallback-&gt;HandleResult(mResults);</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+  }</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+private:</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+  mozIStorageStatementCallback *mCallback;</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+  nsCOMPtr&lt;mozIStorageResultSet&gt; mResults;</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+  nsRefPtr&lt;AsyncExecuteStatements&gt; mEventStatus;</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+};</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+/**</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+ * Notifies the calling thread that an error has occurred.</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+ */</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+class ErrorNotifier : public nsRunnable</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+{</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+public:</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+  ErrorNotifier(mozIStorageStatementCallback *aCallback,</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineplus">+                mozIStorageError *aErrorObj,</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+                AsyncExecuteStatements *aEventStatus) :</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineplus">+      mCallback(aCallback)</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineplus">+    , mErrorObj(aErrorObj)</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineplus">+    , mEventStatus(aEventStatus)</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineplus">+  {</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+  }</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+  {</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+    if (mEventStatus-&gt;shouldNotify() &amp;&amp; mCallback)</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineplus">+      (void)mCallback-&gt;HandleError(mErrorObj);</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineplus">+</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+  }</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineplus">+</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+private:</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+  mozIStorageStatementCallback *mCallback;</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineplus">+  nsCOMPtr&lt;mozIStorageError&gt; mErrorObj;</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineplus">+  nsRefPtr&lt;AsyncExecuteStatements&gt; mEventStatus;</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineplus">+};</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineplus">+</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineplus">+/**</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+ * Notifies the calling thread that the statement has finished executing.  Keeps</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineplus">+ * the AsyncExecuteStatements instance alive long enough so that it does not</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+ * get destroyed on the async thread if there are no other references alive.</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+ */</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+class CompletionNotifier : public nsRunnable</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+{</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+public:</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+  /**</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+   * This takes ownership of the callback.  It is released on the thread this is</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+   * dispatched to (which should always be the calling thread).</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+   */</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineplus">+  CompletionNotifier(mozIStorageStatementCallback *aCallback,</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+                     ExecutionState aReason,</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+                     AsyncExecuteStatements *aKeepAsyncAlive)</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+    : mKeepAsyncAlive(aKeepAsyncAlive)</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+    , mCallback(aCallback)</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+    , mReason(aReason)</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+  {</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+  }</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+  {</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineplus">+    if (mCallback) {</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineplus">+      (void)mCallback-&gt;HandleCompletion(mReason);</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineplus">+      NS_RELEASE(mCallback);</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineplus">+    }</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+  }</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineplus">+</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineplus">+private:</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+  nsRefPtr&lt;AsyncExecuteStatements&gt; mKeepAsyncAlive;</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+  mozIStorageStatementCallback *mCallback;</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineplus">+  ExecutionState mReason;</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+};</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+} // anonymous namespace</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineplus">+//// AsyncExecuteStatements</span>
<a href="#l40.185"></a><span id="l40.185" class="difflineplus">+</span>
<a href="#l40.186"></a><span id="l40.186" class="difflineplus">+/* static */</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineplus">+nsresult</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineplus">+AsyncExecuteStatements::execute(StatementDataArray &amp;aStatements,</span>
<a href="#l40.189"></a><span id="l40.189" class="difflineplus">+                                Connection *aConnection,</span>
<a href="#l40.190"></a><span id="l40.190" class="difflineplus">+                                mozIStorageStatementCallback *aCallback,</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineplus">+                                mozIStoragePendingStatement **_stmt)</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+{</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineplus">+  // Create our event to run in the background</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineplus">+  nsRefPtr&lt;AsyncExecuteStatements&gt; event =</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineplus">+    new AsyncExecuteStatements(aStatements, aConnection, aCallback);</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineplus">+  NS_ENSURE_TRUE(event, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineplus">+</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+  // Dispatch it to the background</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineplus">+  nsIEventTarget *target = aConnection-&gt;getAsyncExecutionTarget();</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineplus">+  NS_ENSURE_TRUE(target, NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineplus">+  nsresult rv = target-&gt;Dispatch(event, NS_DISPATCH_NORMAL);</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineplus">+</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineplus">+  // Return it as the pending statement object and track it.</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineplus">+  NS_ADDREF(*_stmt = event);</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.207"></a><span id="l40.207" class="difflineplus">+}</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineplus">+</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineplus">+AsyncExecuteStatements::AsyncExecuteStatements(StatementDataArray &amp;aStatements,</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineplus">+                                               Connection *aConnection,</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineplus">+                                               mozIStorageStatementCallback *aCallback)</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineplus">+: mConnection(aConnection)</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineplus">+, mTransactionManager(nsnull)</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineplus">+, mCallback(aCallback)</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineplus">+, mCallingThread(::do_GetCurrentThread())</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineplus">+, mMaxWait(TimeDuration::FromMilliseconds(MAX_MILLISECONDS_BETWEEN_RESULTS))</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineplus">+, mIntervalStart(TimeStamp::Now())</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineplus">+, mState(PENDING)</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineplus">+, mCancelRequested(false)</span>
<a href="#l40.220"></a><span id="l40.220" class="difflineplus">+, mMutex(aConnection-&gt;sharedAsyncExecutionMutex)</span>
<a href="#l40.221"></a><span id="l40.221" class="difflineplus">+, mDBMutex(aConnection-&gt;sharedDBMutex)</span>
<a href="#l40.222"></a><span id="l40.222" class="difflineplus">+{</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineplus">+  (void)mStatements.SwapElements(aStatements);</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineplus">+  NS_ASSERTION(mStatements.Length(), &quot;We weren't given any statements!&quot;);</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineplus">+  NS_IF_ADDREF(mCallback);</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineplus">+}</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineplus">+</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineplus">+bool</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+AsyncExecuteStatements::shouldNotify()</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineplus">+{</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineplus">+</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineplus">+  PRBool onCallingThread = PR_FALSE;</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+  (void)mCallingThread-&gt;IsOnCurrentThread(&amp;onCallingThread);</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineplus">+  NS_ASSERTION(onCallingThread, &quot;runEvent not running on the calling thread!&quot;);</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineplus">+#endif</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineplus">+</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineplus">+  // We do not need to acquire mMutex here because it can only ever be written</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineplus">+  // to on the calling thread, and the only thread that can call us is the</span>
<a href="#l40.241"></a><span id="l40.241" class="difflineplus">+  // calling thread, so we know that our access is serialized.</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineplus">+  return !mCancelRequested;</span>
<a href="#l40.243"></a><span id="l40.243" class="difflineplus">+}</span>
<a href="#l40.244"></a><span id="l40.244" class="difflineplus">+</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineplus">+bool</span>
<a href="#l40.246"></a><span id="l40.246" class="difflineplus">+AsyncExecuteStatements::bindExecuteAndProcessStatement(StatementData &amp;aData,</span>
<a href="#l40.247"></a><span id="l40.247" class="difflineplus">+                                                       bool aLastStatement)</span>
<a href="#l40.248"></a><span id="l40.248" class="difflineplus">+{</span>
<a href="#l40.249"></a><span id="l40.249" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.250"></a><span id="l40.250" class="difflineplus">+</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineplus">+  sqlite3_stmt *aStatement;</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+  // This cannot fail; we are only called if it's available.</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineplus">+  (void)aData.getSqliteStatement(&amp;aStatement);</span>
<a href="#l40.254"></a><span id="l40.254" class="difflineplus">+  BindingParamsArray *paramsArray(aData);</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineplus">+</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineplus">+  // Iterate through all of our parameters, bind them, and execute.</span>
<a href="#l40.257"></a><span id="l40.257" class="difflineplus">+  bool continueProcessing = true;</span>
<a href="#l40.258"></a><span id="l40.258" class="difflineplus">+  BindingParamsArray::iterator itr = paramsArray-&gt;begin();</span>
<a href="#l40.259"></a><span id="l40.259" class="difflineplus">+  BindingParamsArray::iterator end = paramsArray-&gt;end();</span>
<a href="#l40.260"></a><span id="l40.260" class="difflineplus">+  while (itr != end &amp;&amp; continueProcessing) {</span>
<a href="#l40.261"></a><span id="l40.261" class="difflineplus">+    // Bind the data to our statement.</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineplus">+    nsCOMPtr&lt;IStorageBindingParamsInternal&gt; bindingInternal = </span>
<a href="#l40.263"></a><span id="l40.263" class="difflineplus">+      do_QueryInterface(*itr);</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineplus">+    nsCOMPtr&lt;mozIStorageError&gt; error = bindingInternal-&gt;bind(aStatement);</span>
<a href="#l40.265"></a><span id="l40.265" class="difflineplus">+    if (error) {</span>
<a href="#l40.266"></a><span id="l40.266" class="difflineplus">+      // Set our error state.</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineplus">+      mState = ERROR;</span>
<a href="#l40.268"></a><span id="l40.268" class="difflineplus">+</span>
<a href="#l40.269"></a><span id="l40.269" class="difflineplus">+      // And notify.</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineplus">+      (void)notifyError(error);</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineplus">+      return false;</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineplus">+    }</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineplus">+</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineplus">+    // Advance our iterator, execute, and then process the statement.</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineplus">+    itr++;</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineplus">+    bool lastStatement = aLastStatement &amp;&amp; itr == end;</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineplus">+    continueProcessing = executeAndProcessStatement(aStatement, lastStatement);</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineplus">+</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineplus">+    // Always reset our statement.</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineplus">+    (void)::sqlite3_reset(aStatement);</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineplus">+  }</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineplus">+</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+  return continueProcessing;</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineplus">+}</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineplus">+</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineplus">+bool</span>
<a href="#l40.287"></a><span id="l40.287" class="difflineplus">+AsyncExecuteStatements::executeAndProcessStatement(sqlite3_stmt *aStatement,</span>
<a href="#l40.288"></a><span id="l40.288" class="difflineplus">+                                                   bool aLastStatement)</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineplus">+{</span>
<a href="#l40.290"></a><span id="l40.290" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.291"></a><span id="l40.291" class="difflineplus">+</span>
<a href="#l40.292"></a><span id="l40.292" class="difflineplus">+  // Execute our statement</span>
<a href="#l40.293"></a><span id="l40.293" class="difflineplus">+  bool hasResults;</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineplus">+  do {</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineplus">+    hasResults = executeStatement(aStatement);</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineplus">+</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineplus">+    // If we had an error, bail.</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+    if (mState == ERROR)</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+      return false;</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineplus">+</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineplus">+    // If we have been canceled, there is no point in going on...</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+    {</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineplus">+      MutexAutoLock lockedScope(mMutex);</span>
<a href="#l40.304"></a><span id="l40.304" class="difflineplus">+      if (mCancelRequested) {</span>
<a href="#l40.305"></a><span id="l40.305" class="difflineplus">+        mState = CANCELED;</span>
<a href="#l40.306"></a><span id="l40.306" class="difflineplus">+        return false;</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineplus">+      }</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineplus">+    }</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineplus">+</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+    // Build our result set and notify if we got anything back and have a</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+    // callback to notify.</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+    if (mCallback &amp;&amp; hasResults &amp;&amp;</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineplus">+        NS_FAILED(buildAndNotifyResults(aStatement))) {</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineplus">+      // We had an error notifying, so we notify on error and stop processing.</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineplus">+      mState = ERROR;</span>
<a href="#l40.316"></a><span id="l40.316" class="difflineplus">+</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineplus">+      // Notify, and stop processing statements.</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineplus">+      (void)notifyError(mozIStorageError::ERROR,</span>
<a href="#l40.319"></a><span id="l40.319" class="difflineplus">+                        &quot;An error occurred while notifying about results&quot;);</span>
<a href="#l40.320"></a><span id="l40.320" class="difflineplus">+</span>
<a href="#l40.321"></a><span id="l40.321" class="difflineplus">+      return false;</span>
<a href="#l40.322"></a><span id="l40.322" class="difflineplus">+    }</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineplus">+  } while (hasResults);</span>
<a href="#l40.324"></a><span id="l40.324" class="difflineplus">+</span>
<a href="#l40.325"></a><span id="l40.325" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l40.326"></a><span id="l40.326" class="difflineplus">+  // Check to make sure that this statement was smart about what it did.</span>
<a href="#l40.327"></a><span id="l40.327" class="difflineplus">+  checkAndLogStatementPerformance(aStatement);</span>
<a href="#l40.328"></a><span id="l40.328" class="difflineplus">+#endif</span>
<a href="#l40.329"></a><span id="l40.329" class="difflineplus">+</span>
<a href="#l40.330"></a><span id="l40.330" class="difflineplus">+  // If we are done, we need to set our state accordingly while we still hold</span>
<a href="#l40.331"></a><span id="l40.331" class="difflineplus">+  // our mutex.  We would have already returned if we were canceled or had</span>
<a href="#l40.332"></a><span id="l40.332" class="difflineplus">+  // an error at this point.</span>
<a href="#l40.333"></a><span id="l40.333" class="difflineplus">+  if (aLastStatement)</span>
<a href="#l40.334"></a><span id="l40.334" class="difflineplus">+    mState = COMPLETED;</span>
<a href="#l40.335"></a><span id="l40.335" class="difflineplus">+</span>
<a href="#l40.336"></a><span id="l40.336" class="difflineplus">+  return true;</span>
<a href="#l40.337"></a><span id="l40.337" class="difflineplus">+}</span>
<a href="#l40.338"></a><span id="l40.338" class="difflineplus">+</span>
<a href="#l40.339"></a><span id="l40.339" class="difflineplus">+bool</span>
<a href="#l40.340"></a><span id="l40.340" class="difflineplus">+AsyncExecuteStatements::executeStatement(sqlite3_stmt *aStatement)</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineplus">+{</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineplus">+</span>
<a href="#l40.344"></a><span id="l40.344" class="difflineplus">+  while (true) {</span>
<a href="#l40.345"></a><span id="l40.345" class="difflineplus">+    // lock the sqlite mutex so sqlite3_errmsg cannot change</span>
<a href="#l40.346"></a><span id="l40.346" class="difflineplus">+    SQLiteMutexAutoLock lockedScope(mDBMutex);</span>
<a href="#l40.347"></a><span id="l40.347" class="difflineplus">+</span>
<a href="#l40.348"></a><span id="l40.348" class="difflineplus">+    int rc = ::sqlite3_step(aStatement);</span>
<a href="#l40.349"></a><span id="l40.349" class="difflineplus">+    // Stop if we have no more results.</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineplus">+    if (rc == SQLITE_DONE)</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineplus">+      return false;</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineplus">+</span>
<a href="#l40.353"></a><span id="l40.353" class="difflineplus">+    // If we got results, we can return now.</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineplus">+    if (rc == SQLITE_ROW)</span>
<a href="#l40.355"></a><span id="l40.355" class="difflineplus">+      return true;</span>
<a href="#l40.356"></a><span id="l40.356" class="difflineplus">+</span>
<a href="#l40.357"></a><span id="l40.357" class="difflineplus">+    // Some errors are not fatal, and we can handle them and continue.</span>
<a href="#l40.358"></a><span id="l40.358" class="difflineplus">+    if (rc == SQLITE_BUSY) {</span>
<a href="#l40.359"></a><span id="l40.359" class="difflineplus">+      // Don't hold the lock while we call outside our module.</span>
<a href="#l40.360"></a><span id="l40.360" class="difflineplus">+      SQLiteMutexAutoUnlock unlockedScope(mDBMutex);</span>
<a href="#l40.361"></a><span id="l40.361" class="difflineplus">+</span>
<a href="#l40.362"></a><span id="l40.362" class="difflineplus">+      // Yield, and try again</span>
<a href="#l40.363"></a><span id="l40.363" class="difflineplus">+      (void)::PR_Sleep(PR_INTERVAL_NO_WAIT);</span>
<a href="#l40.364"></a><span id="l40.364" class="difflineplus">+      continue;</span>
<a href="#l40.365"></a><span id="l40.365" class="difflineplus">+    }</span>
<a href="#l40.366"></a><span id="l40.366" class="difflineplus">+</span>
<a href="#l40.367"></a><span id="l40.367" class="difflineplus">+    // Set an error state.</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineplus">+    mState = ERROR;</span>
<a href="#l40.369"></a><span id="l40.369" class="difflineplus">+</span>
<a href="#l40.370"></a><span id="l40.370" class="difflineplus">+    // Construct the error message before giving up the mutex (which we cannot</span>
<a href="#l40.371"></a><span id="l40.371" class="difflineplus">+    // hold during the call to notifyError).</span>
<a href="#l40.372"></a><span id="l40.372" class="difflineplus">+    sqlite3 *db = mConnection-&gt;GetNativeConnection();</span>
<a href="#l40.373"></a><span id="l40.373" class="difflineplus">+    nsCOMPtr&lt;mozIStorageError&gt; errorObj(new Error(rc, ::sqlite3_errmsg(db)));</span>
<a href="#l40.374"></a><span id="l40.374" class="difflineplus">+    // We cannot hold the DB mutex while calling notifyError.</span>
<a href="#l40.375"></a><span id="l40.375" class="difflineplus">+    SQLiteMutexAutoUnlock unlockedScope(mDBMutex);</span>
<a href="#l40.376"></a><span id="l40.376" class="difflineplus">+    (void)notifyError(errorObj);</span>
<a href="#l40.377"></a><span id="l40.377" class="difflineplus">+</span>
<a href="#l40.378"></a><span id="l40.378" class="difflineplus">+    // Finally, indicate that we should stop processing.</span>
<a href="#l40.379"></a><span id="l40.379" class="difflineplus">+    return false;</span>
<a href="#l40.380"></a><span id="l40.380" class="difflineplus">+  }</span>
<a href="#l40.381"></a><span id="l40.381" class="difflineplus">+}</span>
<a href="#l40.382"></a><span id="l40.382" class="difflineplus">+</span>
<a href="#l40.383"></a><span id="l40.383" class="difflineplus">+nsresult</span>
<a href="#l40.384"></a><span id="l40.384" class="difflineplus">+AsyncExecuteStatements::buildAndNotifyResults(sqlite3_stmt *aStatement)</span>
<a href="#l40.385"></a><span id="l40.385" class="difflineplus">+{</span>
<a href="#l40.386"></a><span id="l40.386" class="difflineplus">+  NS_ASSERTION(mCallback, &quot;Trying to dispatch results without a callback!&quot;);</span>
<a href="#l40.387"></a><span id="l40.387" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.388"></a><span id="l40.388" class="difflineplus">+</span>
<a href="#l40.389"></a><span id="l40.389" class="difflineplus">+  // Build result object if we need it.</span>
<a href="#l40.390"></a><span id="l40.390" class="difflineplus">+  if (!mResultSet)</span>
<a href="#l40.391"></a><span id="l40.391" class="difflineplus">+    mResultSet = new ResultSet();</span>
<a href="#l40.392"></a><span id="l40.392" class="difflineplus">+  NS_ENSURE_TRUE(mResultSet, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.393"></a><span id="l40.393" class="difflineplus">+</span>
<a href="#l40.394"></a><span id="l40.394" class="difflineplus">+  nsRefPtr&lt;Row&gt; row(new Row());</span>
<a href="#l40.395"></a><span id="l40.395" class="difflineplus">+  NS_ENSURE_TRUE(row, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.396"></a><span id="l40.396" class="difflineplus">+</span>
<a href="#l40.397"></a><span id="l40.397" class="difflineplus">+  nsresult rv = row-&gt;initialize(aStatement);</span>
<a href="#l40.398"></a><span id="l40.398" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.399"></a><span id="l40.399" class="difflineplus">+</span>
<a href="#l40.400"></a><span id="l40.400" class="difflineplus">+  rv = mResultSet-&gt;add(row);</span>
<a href="#l40.401"></a><span id="l40.401" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.402"></a><span id="l40.402" class="difflineplus">+</span>
<a href="#l40.403"></a><span id="l40.403" class="difflineplus">+  // If we have hit our maximum number of allowed results, or if we have hit</span>
<a href="#l40.404"></a><span id="l40.404" class="difflineplus">+  // the maximum amount of time we want to wait for results, notify the</span>
<a href="#l40.405"></a><span id="l40.405" class="difflineplus">+  // calling thread about it.</span>
<a href="#l40.406"></a><span id="l40.406" class="difflineplus">+  TimeStamp now = TimeStamp::Now();</span>
<a href="#l40.407"></a><span id="l40.407" class="difflineplus">+  TimeDuration delta = now - mIntervalStart;</span>
<a href="#l40.408"></a><span id="l40.408" class="difflineplus">+  if (mResultSet-&gt;rows() &gt;= MAX_ROWS_PER_RESULT || delta &gt; mMaxWait) {</span>
<a href="#l40.409"></a><span id="l40.409" class="difflineplus">+    // Notify the caller</span>
<a href="#l40.410"></a><span id="l40.410" class="difflineplus">+    rv = notifyResults();</span>
<a href="#l40.411"></a><span id="l40.411" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l40.412"></a><span id="l40.412" class="difflineplus">+      return NS_OK; // we'll try again with the next result</span>
<a href="#l40.413"></a><span id="l40.413" class="difflineplus">+</span>
<a href="#l40.414"></a><span id="l40.414" class="difflineplus">+    // Reset our start time</span>
<a href="#l40.415"></a><span id="l40.415" class="difflineplus">+    mIntervalStart = now;</span>
<a href="#l40.416"></a><span id="l40.416" class="difflineplus">+  }</span>
<a href="#l40.417"></a><span id="l40.417" class="difflineplus">+</span>
<a href="#l40.418"></a><span id="l40.418" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.419"></a><span id="l40.419" class="difflineplus">+}</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineplus">+</span>
<a href="#l40.421"></a><span id="l40.421" class="difflineplus">+nsresult</span>
<a href="#l40.422"></a><span id="l40.422" class="difflineplus">+AsyncExecuteStatements::notifyComplete()</span>
<a href="#l40.423"></a><span id="l40.423" class="difflineplus">+{</span>
<a href="#l40.424"></a><span id="l40.424" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.425"></a><span id="l40.425" class="difflineplus">+  NS_ASSERTION(mState != PENDING,</span>
<a href="#l40.426"></a><span id="l40.426" class="difflineplus">+               &quot;Still in a pending state when calling Complete!&quot;);</span>
<a href="#l40.427"></a><span id="l40.427" class="difflineplus">+</span>
<a href="#l40.428"></a><span id="l40.428" class="difflineplus">+  // Finalize our statements before we try to commit or rollback.  If we are</span>
<a href="#l40.429"></a><span id="l40.429" class="difflineplus">+  // canceling and have statements that think they have pending work, the</span>
<a href="#l40.430"></a><span id="l40.430" class="difflineplus">+  // rollback will fail.</span>
<a href="#l40.431"></a><span id="l40.431" class="difflineplus">+  for (PRUint32 i = 0; i &lt; mStatements.Length(); i++)</span>
<a href="#l40.432"></a><span id="l40.432" class="difflineplus">+    mStatements[i].finalize();</span>
<a href="#l40.433"></a><span id="l40.433" class="difflineplus">+</span>
<a href="#l40.434"></a><span id="l40.434" class="difflineplus">+  // Handle our transaction, if we have one</span>
<a href="#l40.435"></a><span id="l40.435" class="difflineplus">+  if (mTransactionManager) {</span>
<a href="#l40.436"></a><span id="l40.436" class="difflineplus">+    if (mState == COMPLETED) {</span>
<a href="#l40.437"></a><span id="l40.437" class="difflineplus">+      nsresult rv = mTransactionManager-&gt;Commit();</span>
<a href="#l40.438"></a><span id="l40.438" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l40.439"></a><span id="l40.439" class="difflineplus">+        mState = ERROR;</span>
<a href="#l40.440"></a><span id="l40.440" class="difflineplus">+        (void)notifyError(mozIStorageError::ERROR,</span>
<a href="#l40.441"></a><span id="l40.441" class="difflineplus">+                          &quot;Transaction failed to commit&quot;);</span>
<a href="#l40.442"></a><span id="l40.442" class="difflineplus">+      }</span>
<a href="#l40.443"></a><span id="l40.443" class="difflineplus">+    }</span>
<a href="#l40.444"></a><span id="l40.444" class="difflineplus">+    else {</span>
<a href="#l40.445"></a><span id="l40.445" class="difflineplus">+      (void)mTransactionManager-&gt;Rollback();</span>
<a href="#l40.446"></a><span id="l40.446" class="difflineplus">+    }</span>
<a href="#l40.447"></a><span id="l40.447" class="difflineplus">+    delete mTransactionManager;</span>
<a href="#l40.448"></a><span id="l40.448" class="difflineplus">+    mTransactionManager = nsnull;</span>
<a href="#l40.449"></a><span id="l40.449" class="difflineplus">+  }</span>
<a href="#l40.450"></a><span id="l40.450" class="difflineplus">+</span>
<a href="#l40.451"></a><span id="l40.451" class="difflineplus">+  // Always generate a completion notification; it is what guarantees that our</span>
<a href="#l40.452"></a><span id="l40.452" class="difflineplus">+  // destruction does not happen here on the async thread.</span>
<a href="#l40.453"></a><span id="l40.453" class="difflineplus">+  nsRefPtr&lt;CompletionNotifier&gt; completionEvent =</span>
<a href="#l40.454"></a><span id="l40.454" class="difflineplus">+    new CompletionNotifier(mCallback, mState, this);</span>
<a href="#l40.455"></a><span id="l40.455" class="difflineplus">+  NS_ENSURE_TRUE(completionEvent, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.456"></a><span id="l40.456" class="difflineplus">+</span>
<a href="#l40.457"></a><span id="l40.457" class="difflineplus">+  // We no longer own mCallback (the CompletionNotifier takes ownership).</span>
<a href="#l40.458"></a><span id="l40.458" class="difflineplus">+  mCallback = nsnull;</span>
<a href="#l40.459"></a><span id="l40.459" class="difflineplus">+</span>
<a href="#l40.460"></a><span id="l40.460" class="difflineplus">+  (void)mCallingThread-&gt;Dispatch(completionEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l40.461"></a><span id="l40.461" class="difflineplus">+</span>
<a href="#l40.462"></a><span id="l40.462" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.463"></a><span id="l40.463" class="difflineplus">+}</span>
<a href="#l40.464"></a><span id="l40.464" class="difflineplus">+</span>
<a href="#l40.465"></a><span id="l40.465" class="difflineplus">+nsresult</span>
<a href="#l40.466"></a><span id="l40.466" class="difflineplus">+AsyncExecuteStatements::notifyError(PRInt32 aErrorCode,</span>
<a href="#l40.467"></a><span id="l40.467" class="difflineplus">+                                    const char *aMessage)</span>
<a href="#l40.468"></a><span id="l40.468" class="difflineplus">+{</span>
<a href="#l40.469"></a><span id="l40.469" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.470"></a><span id="l40.470" class="difflineplus">+  mDBMutex.assertNotCurrentThreadOwns();</span>
<a href="#l40.471"></a><span id="l40.471" class="difflineplus">+</span>
<a href="#l40.472"></a><span id="l40.472" class="difflineplus">+  if (!mCallback)</span>
<a href="#l40.473"></a><span id="l40.473" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.474"></a><span id="l40.474" class="difflineplus">+</span>
<a href="#l40.475"></a><span id="l40.475" class="difflineplus">+  nsCOMPtr&lt;mozIStorageError&gt; errorObj(new Error(aErrorCode, aMessage));</span>
<a href="#l40.476"></a><span id="l40.476" class="difflineplus">+  NS_ENSURE_TRUE(errorObj, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.477"></a><span id="l40.477" class="difflineplus">+</span>
<a href="#l40.478"></a><span id="l40.478" class="difflineplus">+  return notifyError(errorObj);</span>
<a href="#l40.479"></a><span id="l40.479" class="difflineplus">+}</span>
<a href="#l40.480"></a><span id="l40.480" class="difflineplus">+</span>
<a href="#l40.481"></a><span id="l40.481" class="difflineplus">+nsresult</span>
<a href="#l40.482"></a><span id="l40.482" class="difflineplus">+AsyncExecuteStatements::notifyError(mozIStorageError *aError)</span>
<a href="#l40.483"></a><span id="l40.483" class="difflineplus">+{</span>
<a href="#l40.484"></a><span id="l40.484" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.485"></a><span id="l40.485" class="difflineplus">+  mDBMutex.assertNotCurrentThreadOwns();</span>
<a href="#l40.486"></a><span id="l40.486" class="difflineplus">+</span>
<a href="#l40.487"></a><span id="l40.487" class="difflineplus">+  if (!mCallback)</span>
<a href="#l40.488"></a><span id="l40.488" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.489"></a><span id="l40.489" class="difflineplus">+</span>
<a href="#l40.490"></a><span id="l40.490" class="difflineplus">+  nsRefPtr&lt;ErrorNotifier&gt; notifier =</span>
<a href="#l40.491"></a><span id="l40.491" class="difflineplus">+    new ErrorNotifier(mCallback, aError, this);</span>
<a href="#l40.492"></a><span id="l40.492" class="difflineplus">+  NS_ENSURE_TRUE(notifier, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.493"></a><span id="l40.493" class="difflineplus">+</span>
<a href="#l40.494"></a><span id="l40.494" class="difflineplus">+  return mCallingThread-&gt;Dispatch(notifier, NS_DISPATCH_NORMAL);</span>
<a href="#l40.495"></a><span id="l40.495" class="difflineplus">+}</span>
<a href="#l40.496"></a><span id="l40.496" class="difflineplus">+</span>
<a href="#l40.497"></a><span id="l40.497" class="difflineplus">+nsresult</span>
<a href="#l40.498"></a><span id="l40.498" class="difflineplus">+AsyncExecuteStatements::notifyResults()</span>
<a href="#l40.499"></a><span id="l40.499" class="difflineplus">+{</span>
<a href="#l40.500"></a><span id="l40.500" class="difflineplus">+  mMutex.AssertNotCurrentThreadOwns();</span>
<a href="#l40.501"></a><span id="l40.501" class="difflineplus">+  NS_ASSERTION(mCallback, &quot;notifyResults called without a callback!&quot;);</span>
<a href="#l40.502"></a><span id="l40.502" class="difflineplus">+</span>
<a href="#l40.503"></a><span id="l40.503" class="difflineplus">+  nsRefPtr&lt;CallbackResultNotifier&gt; notifier =</span>
<a href="#l40.504"></a><span id="l40.504" class="difflineplus">+    new CallbackResultNotifier(mCallback, mResultSet, this);</span>
<a href="#l40.505"></a><span id="l40.505" class="difflineplus">+  NS_ENSURE_TRUE(notifier, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l40.506"></a><span id="l40.506" class="difflineplus">+</span>
<a href="#l40.507"></a><span id="l40.507" class="difflineplus">+  nsresult rv = mCallingThread-&gt;Dispatch(notifier, NS_DISPATCH_NORMAL);</span>
<a href="#l40.508"></a><span id="l40.508" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l40.509"></a><span id="l40.509" class="difflineplus">+    mResultSet = nsnull; // we no longer own it on success</span>
<a href="#l40.510"></a><span id="l40.510" class="difflineplus">+  return rv;</span>
<a href="#l40.511"></a><span id="l40.511" class="difflineplus">+}</span>
<a href="#l40.512"></a><span id="l40.512" class="difflineplus">+</span>
<a href="#l40.513"></a><span id="l40.513" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l40.514"></a><span id="l40.514" class="difflineplus">+  AsyncExecuteStatements,</span>
<a href="#l40.515"></a><span id="l40.515" class="difflineplus">+  nsIRunnable,</span>
<a href="#l40.516"></a><span id="l40.516" class="difflineplus">+  mozIStoragePendingStatement</span>
<a href="#l40.517"></a><span id="l40.517" class="difflineplus">+)</span>
<a href="#l40.518"></a><span id="l40.518" class="difflineplus">+</span>
<a href="#l40.519"></a><span id="l40.519" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.520"></a><span id="l40.520" class="difflineplus">+//// mozIStoragePendingStatement</span>
<a href="#l40.521"></a><span id="l40.521" class="difflineplus">+</span>
<a href="#l40.522"></a><span id="l40.522" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l40.523"></a><span id="l40.523" class="difflineplus">+AsyncExecuteStatements::Cancel()</span>
<a href="#l40.524"></a><span id="l40.524" class="difflineplus">+{</span>
<a href="#l40.525"></a><span id="l40.525" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l40.526"></a><span id="l40.526" class="difflineplus">+  PRBool onCallingThread = PR_FALSE;</span>
<a href="#l40.527"></a><span id="l40.527" class="difflineplus">+  (void)mCallingThread-&gt;IsOnCurrentThread(&amp;onCallingThread);</span>
<a href="#l40.528"></a><span id="l40.528" class="difflineplus">+  NS_ASSERTION(onCallingThread, &quot;Not canceling from the calling thread!&quot;);</span>
<a href="#l40.529"></a><span id="l40.529" class="difflineplus">+#endif</span>
<a href="#l40.530"></a><span id="l40.530" class="difflineplus">+</span>
<a href="#l40.531"></a><span id="l40.531" class="difflineplus">+  // If we have already canceled, we have an error, but always indicate that</span>
<a href="#l40.532"></a><span id="l40.532" class="difflineplus">+  // we are trying to cancel.</span>
<a href="#l40.533"></a><span id="l40.533" class="difflineplus">+  NS_ENSURE_FALSE(mCancelRequested, NS_ERROR_UNEXPECTED);</span>
<a href="#l40.534"></a><span id="l40.534" class="difflineplus">+</span>
<a href="#l40.535"></a><span id="l40.535" class="difflineplus">+  {</span>
<a href="#l40.536"></a><span id="l40.536" class="difflineplus">+    MutexAutoLock lockedScope(mMutex);</span>
<a href="#l40.537"></a><span id="l40.537" class="difflineplus">+</span>
<a href="#l40.538"></a><span id="l40.538" class="difflineplus">+    // We need to indicate that we want to try and cancel now.</span>
<a href="#l40.539"></a><span id="l40.539" class="difflineplus">+    mCancelRequested = true;</span>
<a href="#l40.540"></a><span id="l40.540" class="difflineplus">+  }</span>
<a href="#l40.541"></a><span id="l40.541" class="difflineplus">+</span>
<a href="#l40.542"></a><span id="l40.542" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.543"></a><span id="l40.543" class="difflineplus">+}</span>
<a href="#l40.544"></a><span id="l40.544" class="difflineplus">+</span>
<a href="#l40.545"></a><span id="l40.545" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.546"></a><span id="l40.546" class="difflineplus">+//// nsIRunnable</span>
<a href="#l40.547"></a><span id="l40.547" class="difflineplus">+</span>
<a href="#l40.548"></a><span id="l40.548" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l40.549"></a><span id="l40.549" class="difflineplus">+AsyncExecuteStatements::Run()</span>
<a href="#l40.550"></a><span id="l40.550" class="difflineplus">+{</span>
<a href="#l40.551"></a><span id="l40.551" class="difflineplus">+  // Do not run if we have been canceled.</span>
<a href="#l40.552"></a><span id="l40.552" class="difflineplus">+  {</span>
<a href="#l40.553"></a><span id="l40.553" class="difflineplus">+    MutexAutoLock lockedScope(mMutex);</span>
<a href="#l40.554"></a><span id="l40.554" class="difflineplus">+    if (mCancelRequested)</span>
<a href="#l40.555"></a><span id="l40.555" class="difflineplus">+      mState = CANCELED;</span>
<a href="#l40.556"></a><span id="l40.556" class="difflineplus">+  }</span>
<a href="#l40.557"></a><span id="l40.557" class="difflineplus">+  if (mState == CANCELED)</span>
<a href="#l40.558"></a><span id="l40.558" class="difflineplus">+    return notifyComplete();</span>
<a href="#l40.559"></a><span id="l40.559" class="difflineplus">+</span>
<a href="#l40.560"></a><span id="l40.560" class="difflineplus">+  // If there is more than one statement, run it in a transaction.  We assume</span>
<a href="#l40.561"></a><span id="l40.561" class="difflineplus">+  // that we have been given write statements since getting a batch of read</span>
<a href="#l40.562"></a><span id="l40.562" class="difflineplus">+  // statements doesn't make a whole lot of sense.</span>
<a href="#l40.563"></a><span id="l40.563" class="difflineplus">+  // Additionally, if we have only one statement and it needs a transaction, we</span>
<a href="#l40.564"></a><span id="l40.564" class="difflineplus">+  // will wrap it in one.</span>
<a href="#l40.565"></a><span id="l40.565" class="difflineplus">+  if (mStatements.Length() &gt; 1 || mStatements[0].needsTransaction()) {</span>
<a href="#l40.566"></a><span id="l40.566" class="difflineplus">+    // We don't error if this failed because it's not terrible if it does.</span>
<a href="#l40.567"></a><span id="l40.567" class="difflineplus">+    mTransactionManager = new mozStorageTransaction(mConnection, PR_FALSE,</span>
<a href="#l40.568"></a><span id="l40.568" class="difflineplus">+                                                    mozIStorageConnection::TRANSACTION_IMMEDIATE);</span>
<a href="#l40.569"></a><span id="l40.569" class="difflineplus">+  }</span>
<a href="#l40.570"></a><span id="l40.570" class="difflineplus">+</span>
<a href="#l40.571"></a><span id="l40.571" class="difflineplus">+  // Execute each statement, giving the callback results if it returns any.</span>
<a href="#l40.572"></a><span id="l40.572" class="difflineplus">+  for (PRUint32 i = 0; i &lt; mStatements.Length(); i++) {</span>
<a href="#l40.573"></a><span id="l40.573" class="difflineplus">+    bool finished = (i == (mStatements.Length() - 1));</span>
<a href="#l40.574"></a><span id="l40.574" class="difflineplus">+</span>
<a href="#l40.575"></a><span id="l40.575" class="difflineplus">+    sqlite3_stmt *stmt;</span>
<a href="#l40.576"></a><span id="l40.576" class="difflineplus">+    { // lock the sqlite mutex so sqlite3_errmsg cannot change</span>
<a href="#l40.577"></a><span id="l40.577" class="difflineplus">+      SQLiteMutexAutoLock lockedScope(mDBMutex);</span>
<a href="#l40.578"></a><span id="l40.578" class="difflineplus">+</span>
<a href="#l40.579"></a><span id="l40.579" class="difflineplus">+      int rc = mStatements[i].getSqliteStatement(&amp;stmt);</span>
<a href="#l40.580"></a><span id="l40.580" class="difflineplus">+      if (rc != SQLITE_OK) {</span>
<a href="#l40.581"></a><span id="l40.581" class="difflineplus">+        // Set our error state.</span>
<a href="#l40.582"></a><span id="l40.582" class="difflineplus">+        mState = ERROR;</span>
<a href="#l40.583"></a><span id="l40.583" class="difflineplus">+</span>
<a href="#l40.584"></a><span id="l40.584" class="difflineplus">+        // Build the error object; can't call notifyError with the lock held</span>
<a href="#l40.585"></a><span id="l40.585" class="difflineplus">+        sqlite3 *db = mConnection-&gt;GetNativeConnection();</span>
<a href="#l40.586"></a><span id="l40.586" class="difflineplus">+        nsCOMPtr&lt;mozIStorageError&gt; errorObj(</span>
<a href="#l40.587"></a><span id="l40.587" class="difflineplus">+          new Error(rc, ::sqlite3_errmsg(db))</span>
<a href="#l40.588"></a><span id="l40.588" class="difflineplus">+        );</span>
<a href="#l40.589"></a><span id="l40.589" class="difflineplus">+        {</span>
<a href="#l40.590"></a><span id="l40.590" class="difflineplus">+          // We cannot hold the DB mutex and call notifyError.</span>
<a href="#l40.591"></a><span id="l40.591" class="difflineplus">+          SQLiteMutexAutoUnlock unlockedScope(mDBMutex);</span>
<a href="#l40.592"></a><span id="l40.592" class="difflineplus">+          (void)notifyError(errorObj);</span>
<a href="#l40.593"></a><span id="l40.593" class="difflineplus">+        }</span>
<a href="#l40.594"></a><span id="l40.594" class="difflineplus">+        break;</span>
<a href="#l40.595"></a><span id="l40.595" class="difflineplus">+      }</span>
<a href="#l40.596"></a><span id="l40.596" class="difflineplus">+    }</span>
<a href="#l40.597"></a><span id="l40.597" class="difflineplus">+</span>
<a href="#l40.598"></a><span id="l40.598" class="difflineplus">+    // If we have parameters to bind, bind them, execute, and process.</span>
<a href="#l40.599"></a><span id="l40.599" class="difflineplus">+    if (mStatements[i].hasParametersToBeBound()) {</span>
<a href="#l40.600"></a><span id="l40.600" class="difflineplus">+      if (!bindExecuteAndProcessStatement(mStatements[i], finished))</span>
<a href="#l40.601"></a><span id="l40.601" class="difflineplus">+        break;</span>
<a href="#l40.602"></a><span id="l40.602" class="difflineplus">+    }</span>
<a href="#l40.603"></a><span id="l40.603" class="difflineplus">+    // Otherwise, just execute and process the statement.</span>
<a href="#l40.604"></a><span id="l40.604" class="difflineplus">+    else if (!executeAndProcessStatement(stmt, finished)) {</span>
<a href="#l40.605"></a><span id="l40.605" class="difflineplus">+      break;</span>
<a href="#l40.606"></a><span id="l40.606" class="difflineplus">+    }</span>
<a href="#l40.607"></a><span id="l40.607" class="difflineplus">+  }</span>
<a href="#l40.608"></a><span id="l40.608" class="difflineplus">+</span>
<a href="#l40.609"></a><span id="l40.609" class="difflineplus">+  // If we still have results that we haven't notified about, take care of</span>
<a href="#l40.610"></a><span id="l40.610" class="difflineplus">+  // them now.</span>
<a href="#l40.611"></a><span id="l40.611" class="difflineplus">+  if (mResultSet)</span>
<a href="#l40.612"></a><span id="l40.612" class="difflineplus">+    (void)notifyResults();</span>
<a href="#l40.613"></a><span id="l40.613" class="difflineplus">+</span>
<a href="#l40.614"></a><span id="l40.614" class="difflineplus">+  // Notify about completion</span>
<a href="#l40.615"></a><span id="l40.615" class="difflineplus">+  return notifyComplete();</span>
<a href="#l40.616"></a><span id="l40.616" class="difflineplus">+}</span>
<a href="#l40.617"></a><span id="l40.617" class="difflineplus">+</span>
<a href="#l40.618"></a><span id="l40.618" class="difflineplus">+} // namespace storage</span>
<a href="#l40.619"></a><span id="l40.619" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementExecution.h</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,254 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+ *</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+ *</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+ * License.</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+ *</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+ *</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+ *</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+ *</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+ *</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+#ifndef _mozStorageAsyncStatementExecution_h_</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+#define _mozStorageAsyncStatementExecution_h_</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+#include &quot;mozilla/TimeStamp.h&quot;</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+#include &quot;SQLiteMutex.h&quot;</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+#include &quot;mozIStoragePendingStatement.h&quot;</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+#include &quot;mozIStorageStatementCallback.h&quot;</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+class mozStorageTransaction;</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+namespace mozilla {</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+namespace storage {</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+class Connection;</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+class ResultSet;</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+class StatementData;</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+class AsyncExecuteStatements : public nsIRunnable</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+                             , public mozIStoragePendingStatement</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+{</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+public:</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+  NS_DECL_NSIRUNNABLE</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+  NS_DECL_MOZISTORAGEPENDINGSTATEMENT</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+  /**</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+   * Describes the state of execution.</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+   */</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+  enum ExecutionState {</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+    PENDING = -1,</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+    COMPLETED = mozIStorageStatementCallback::REASON_FINISHED,</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+    CANCELED = mozIStorageStatementCallback::REASON_CANCELED,</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+    ERROR = mozIStorageStatementCallback::REASON_ERROR</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+  };</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+  typedef nsTArray&lt;StatementData&gt; StatementDataArray;</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+  /**</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+   * Executes a statement in the background, and passes results back to the</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+   * caller.</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+   *</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+   * @param aStatements</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+   *        The statements to execute and possibly bind in the background.</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+   *        Ownership is transfered from the caller.</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+   * @param aConnection</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+   *        The connection that created the statements to execute.</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+   * @param aCallback</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineplus">+   *        The callback that is notified of results, completion, and errors.</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+   * @param _stmt</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineplus">+   *        The handle to control the execution of the statements.</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+   */</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+  static nsresult execute(StatementDataArray &amp;aStatements,</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+                          Connection *aConnection,</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+                          mozIStorageStatementCallback *aCallback,</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+                          mozIStoragePendingStatement **_stmt);</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+  /**</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+   * Indicates when events on the calling thread should run or not.  Certain</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+   * events posted back to the calling thread should call this see if they</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+   * should run or not.</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+   *</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+   *</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+   * @returns true if the event should notify still, false otherwise.</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+   */</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+  bool shouldNotify();</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+private:</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+  AsyncExecuteStatements(StatementDataArray &amp;aStatements,</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+                         Connection *aConnection,</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+                         mozIStorageStatementCallback *aCallback);</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+  /**</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+   * Binds and then executes a given statement until completion, an error</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+   * occurs, or we are canceled.  If aLastStatement is true, we should set</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+   * mState accordingly.</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+   *</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+   *</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+   * @param aData</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+   *        The StatementData to bind, execute, and then process.</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+   * @param aLastStatement</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+   *        Indicates if this is the last statement or not.  If it is, we have</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+   *        to set the proper state.</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+   * @returns true if we should continue to process statements, false otherwise.</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+   */</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+  bool bindExecuteAndProcessStatement(StatementData &amp;aData,</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+                                      bool aLastStatement);</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+  /**</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+   * Executes a given statement until completion, an error occurs, or we are</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineplus">+   * canceled.  If aLastStatement is true, we should set mState accordingly.</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineplus">+   *</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineplus">+   *</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+   * @param aStatement</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+   *        The statement to execute and then process.</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+   * @param aLastStatement</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+   *        Indicates if this is the last statement or not.  If it is, we have</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+   *        to set the proper state.</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+   * @returns true if we should continue to process statements, false otherwise.</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+   */</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+  bool executeAndProcessStatement(sqlite3_stmt *aStatement,</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+                                  bool aLastStatement);</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+  /**</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+   * Executes a statement to completion, properly handling any error conditions.</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+   *</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+   *</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+   * @param aStatement</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+   *        The statement to execute to completion.</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+   * @returns true if results were obtained, false otherwise.</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+   */</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineplus">+  bool executeStatement(sqlite3_stmt *aStatement);</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineplus">+</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+  /**</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineplus">+   * Builds a result set up with a row from a given statement.  If we meet the</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineplus">+   * right criteria, go ahead and notify about this results too.</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineplus">+   *</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+   *</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+   * @param aStatement</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+   *        The statement to get the row data from.</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineplus">+   */</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+  nsresult buildAndNotifyResults(sqlite3_stmt *aStatement);</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+  /**</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+   * Notifies callback about completion, and does any necessary cleanup.</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+   *</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+   */</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineplus">+  nsresult notifyComplete();</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineplus">+</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineplus">+  /**</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineplus">+   * Notifies callback about an error.</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineplus">+   *</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineplus">+   * @pre mDBMutex is not held</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineplus">+   *</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineplus">+   * @param aErrorCode</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineplus">+   *        The error code defined in mozIStorageError for the error.</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+   * @param aMessage</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineplus">+   *        The error string, if any.</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineplus">+   * @param aError</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineplus">+   *        The error object to notify the caller with.</span>
<a href="#l41.197"></a><span id="l41.197" class="difflineplus">+   */</span>
<a href="#l41.198"></a><span id="l41.198" class="difflineplus">+  nsresult notifyError(PRInt32 aErrorCode, const char *aMessage);</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineplus">+  nsresult notifyError(mozIStorageError *aError);</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineplus">+</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineplus">+  /**</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineplus">+   * Notifies the callback about a result set.</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineplus">+   *</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+   * @pre mMutex is not held</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineplus">+   */</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineplus">+  nsresult notifyResults();</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineplus">+</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineplus">+  StatementDataArray mStatements;</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineplus">+  nsRefPtr&lt;Connection&gt; mConnection;</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineplus">+  mozStorageTransaction *mTransactionManager;</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineplus">+  mozIStorageStatementCallback *mCallback;</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; mCallingThread;</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineplus">+  nsRefPtr&lt;ResultSet&gt; mResultSet;</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineplus">+</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineplus">+  /**</span>
<a href="#l41.216"></a><span id="l41.216" class="difflineplus">+   * The maximum amount of time we want to wait between results.  Defined by</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineplus">+   * MAX_MILLISECONDS_BETWEEN_RESULTS and set at construction.</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineplus">+   */</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineplus">+  const TimeDuration mMaxWait;</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineplus">+</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineplus">+  /**</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+   * The start time since our last set of results.</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineplus">+   */</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineplus">+  TimeStamp mIntervalStart;</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineplus">+</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineplus">+  /**</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineplus">+   * Indicates our state of execution.</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineplus">+   */</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineplus">+  ExecutionState mState;</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineplus">+</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineplus">+  /**</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineplus">+   * Indicates if we should try to cancel at a cancelation point.</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineplus">+   */</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineplus">+  bool mCancelRequested;</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineplus">+  /**</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineplus">+   * This is the mutex that protects our state from changing between threads.</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineplus">+   * This includes the following variables:</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineplus">+   *   - mCancelRequested is only set on the calling thread while the lock is</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineplus">+   *     held.  It is always read from within the lock on the background thread,</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineplus">+   *     but not on the calling thread (see shouldNotify for why).</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+   */</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineplus">+  Mutex &amp;mMutex;</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineplus">+</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineplus">+  /**</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineplus">+   * The wrapped SQLite recursive connection mutex used by sqlite3_step.  We use</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineplus">+   * it whenever we call sqlite3_step and care about having reliable error</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineplus">+   * messages.  By taking it prior to the call and holding it until the point</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineplus">+   * where we no longer care about the error message, the user gets reliable</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineplus">+   * error messages.</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineplus">+   */</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineplus">+  SQLiteMutex &amp;mDBMutex;</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineplus">+};</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineplus">+</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineplus">+} // namespace storage</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineplus">+} // namespace mozilla</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineplus">+</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineplus">+#endif // _mozStorageAsyncStatementExecution_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementJSHelper.cpp</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,148 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+ *</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+ *</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+ * License.</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+ *</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+ * The Original Code is mozStorage code.</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+ *</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+ *</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+ *</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+ *</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+#include &quot;nsIXPConnect.h&quot;</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+#include &quot;mozStorageAsyncStatement.h&quot;</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+#include &quot;mozStorageAsyncStatementJSHelper.h&quot;</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+#include &quot;mozStorageAsyncStatementParams.h&quot;</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+#include &quot;jsapi.h&quot;</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+namespace mozilla {</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+namespace storage {</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+//// AsyncStatementJSHelper</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+nsresult</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+AsyncStatementJSHelper::getParams(AsyncStatement *aStatement,</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+                                  JSContext *aCtx,</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+                                  JSObject *aScopeObj,</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+                                  jsval *_params)</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+{</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  nsresult rv;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+  PRInt32 state;</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+  (void)aStatement-&gt;GetState(&amp;state);</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+  NS_ASSERTION(state == mozIStorageAsyncStatement::MOZ_STORAGE_STATEMENT_READY,</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+               &quot;Invalid state to get the params object - all calls will fail!&quot;);</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+#endif</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+  if (!aStatement-&gt;mStatementParamsHolder) {</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementParams&gt; params =</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+      new AsyncStatementParams(aStatement);</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnect&gt; xpc(Service::getXPConnect());</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+    rv = xpc-&gt;WrapNative(</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+      aCtx,</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+      ::JS_GetGlobalForObject(aCtx, aScopeObj),</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+      params,</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+      NS_GET_IID(mozIStorageStatementParams),</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+      getter_AddRefs(aStatement-&gt;mStatementParamsHolder)</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+    );</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+  }</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+  JSObject *obj = nsnull;</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+  rv = aStatement-&gt;mStatementParamsHolder-&gt;GetJSObject(&amp;obj);</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+  *_params = OBJECT_TO_JSVAL(obj);</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+}</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) AsyncStatementJSHelper::AddRef() { return 2; }</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) AsyncStatementJSHelper::Release() { return 1; }</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+NS_INTERFACE_MAP_BEGIN(AsyncStatementJSHelper)</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIXPCScriptable)</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+#define XPC_MAP_CLASSNAME AsyncStatementJSHelper</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;AsyncStatementJSHelper&quot;</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+#define XPC_MAP_WANT_GETPROPERTY</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+AsyncStatementJSHelper::GetProperty(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+                                    JSContext *aCtx,</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+                                    JSObject *aScopeObj,</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+                                    jsval aId,</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+                                    jsval *_result,</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+                                    PRBool *_retval)</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+{</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+  if (!JSVAL_IS_STRING(aId))</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+  // Cast to async via mozI* since direct from nsISupports is ambiguous.</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+  mozIStorageAsyncStatement *iAsyncStmt =</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineplus">+    static_cast&lt;mozIStorageAsyncStatement *&gt;(aWrapper-&gt;Native());</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+  AsyncStatement *stmt = static_cast&lt;AsyncStatement *&gt;(iAsyncStmt);</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineplus">+  {</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+    nsISupports *supp = aWrapper-&gt;Native();</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+    nsCOMPtr&lt;mozIStorageAsyncStatement&gt; isStatement(do_QueryInterface(supp));</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+    NS_ASSERTION(isStatement, &quot;How is this not an async statement?!&quot;);</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+  }</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+#endif</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineplus">+  const char *propName = ::JS_GetStringBytes(JSVAL_TO_STRING(aId));</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineplus">+  if (::strcmp(propName, &quot;params&quot;) == 0)</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineplus">+    return getParams(stmt, aCtx, aScopeObj, _result);</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+}</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineplus">+</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+} // namespace storage</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementJSHelper.h</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,67 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ *</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ *</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+ * License.</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+ *</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+ * The Original Code is mozStorage code.</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+ *</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+ *</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+ *</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+ *</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+#ifndef mozilla_storage_mozStorageAsyncStatementJSHelper_h_</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+#define mozilla_storage_mozStorageAsyncStatementJSHelper_h_</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+class AsyncStatement;</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+namespace storage {</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+/**</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+ * A modified version of StatementJSHelper that only exposes the async-specific</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+ * 'params' helper.  We do not expose 'row' or 'step' as they do not apply to</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+ * us.</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+ */</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+class AsyncStatementJSHelper : public nsIXPCScriptable</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+{</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+public:</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+  NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineplus">+private:</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+  nsresult getParams(AsyncStatement *, JSContext *, JSObject *, jsval *);</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+};</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+} // namespace storage</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+} // namespace mozilla</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+#endif // mozilla_storage_mozStorageAsyncStatementJSHelper_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementParams.cpp</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,165 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+ *</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+ *</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+ * License.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+ *</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+ *</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+ *</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+ *</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+ *</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+#include &quot;mozStorageAsyncStatement.h&quot;</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+#include &quot;mozStorageAsyncStatementParams.h&quot;</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+namespace mozilla {</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+namespace storage {</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+//// AsyncStatementParams</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+AsyncStatementParams::AsyncStatementParams(AsyncStatement *aStatement)</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+: mStatement(aStatement)</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+{</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+  NS_ASSERTION(mStatement != nsnull, &quot;mStatement is null&quot;);</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+}</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+NS_IMPL_ISUPPORTS2(</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+  AsyncStatementParams</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+, mozIStorageStatementParams</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+, nsIXPCScriptable</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+)</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+#define XPC_MAP_CLASSNAME AsyncStatementParams</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;AsyncStatementParams&quot;</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+#define XPC_MAP_WANT_SETPROPERTY</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+#define XPC_MAP_WANT_NEWRESOLVE</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+AsyncStatementParams::SetProperty(</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+  nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+  JSContext *aCtx,</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+  JSObject *aScopeObj,</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+  jsval aId,</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+  jsval *_vp,</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+  PRBool *_retval</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+)</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+{</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineplus">+</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+  if (JSVAL_IS_INT(aId)) {</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+    int idx = JSVAL_TO_INT(aId);</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; variant(convertJSValToVariant(aCtx, *_vp));</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+    NS_ENSURE_TRUE(variant, NS_ERROR_UNEXPECTED);</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+    nsresult rv = mStatement-&gt;BindByIndex(idx, variant);</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+  }</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+  else if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aId);</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+    NS_ConvertUTF16toUTF8 name(reinterpret_cast&lt;const PRUnichar *&gt;</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+                                   (::JS_GetStringChars(str)),</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+                               ::JS_GetStringLength(str));</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; variant(convertJSValToVariant(aCtx, *_vp));</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+    NS_ENSURE_TRUE(variant, NS_ERROR_UNEXPECTED);</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+    nsresult rv = mStatement-&gt;BindByName(name, variant);</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+  }</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+  else {</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+  }</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+  *_retval = PR_TRUE;</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+}</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+AsyncStatementParams::NewResolve(</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+  nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+  JSContext *aCtx,</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+  JSObject *aScopeObj,</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+  jsval aId,</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+  PRUint32 aFlags,</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+  JSObject **_objp,</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+  PRBool *_retval</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+)</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+{</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+  // We do not throw at any point after this unless our index is out of range</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+  // because we want to allow the prototype chain to be checked for the</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineplus">+  // property.</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineplus">+</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineplus">+  PRUint32 idx;</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineplus">+</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineplus">+  if (JSVAL_IS_INT(aId)) {</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+    idx = JSVAL_TO_INT(aId);</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+    // All indexes are good because we don't know how many parameters there</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+    // really are.</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+  }</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+  else if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aId);</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+    jschar *nameChars = ::JS_GetStringChars(str);</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+    size_t nameLength = ::JS_GetStringLength(str);</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+    // We are unable to tell if there's a parameter with this name and so</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+    // we must assume that there is.  This screws the rest of the prototype</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineplus">+    // chain, but people really shouldn't be depending on this anyways.</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+    *_retval = ::JS_DefineUCProperty(aCtx, aScopeObj, nameChars, nameLength,</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+                                     JSVAL_VOID, nsnull, nsnull, 0);</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+    NS_ENSURE_TRUE(*_retval, NS_OK);</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+  }</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+  else {</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+    // We do not handle other types.</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+    return NS_OK;</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+  }</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+  *_retval = ::JS_DefineElement(aCtx, aScopeObj, idx, JSVAL_VOID, nsnull,</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+                                nsnull, 0);</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+  if (*_retval)</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+    *_objp = aScopeObj;</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+}</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+} // namespace storage</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- /dev/null</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ b/storage-backport/src/mozStorageAsyncStatementParams.h</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -0,0 +1,77 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineplus">+ *</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+ *</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+ * License.</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+ *</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+ *</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+ *</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+ *</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+ *</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+#ifndef mozilla_storage_mozStorageAsyncStatementParams_h_</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+#define mozilla_storage_mozStorageAsyncStatementParams_h_</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+#include &quot;mozIStorageStatementWrapper.h&quot;</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+class mozIStorageAsyncStatement;</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+namespace mozilla {</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+namespace storage {</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+class AsyncStatement;</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+/*</span>
<a href="#l45.58"></a><span id="l45.58" class="difflineplus">+ * Since mozIStorageStatementParams is just a tagging interface we do not have</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineplus">+ * an async variant.</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+ */</span>
<a href="#l45.61"></a><span id="l45.61" class="difflineplus">+class AsyncStatementParams : public mozIStorageStatementParams</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineplus">+                           , public nsIXPCScriptable</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineplus">+{</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+public:</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+  AsyncStatementParams(AsyncStatement *aStatement);</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineplus">+</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineplus">+  // interfaces</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+  NS_DECL_MOZISTORAGESTATEMENTPARAMS</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+  NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+protected:</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+  AsyncStatement *mStatement;</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+  friend class AsyncStatement;</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+};</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineplus">+</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+} // namespace storage</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineplus">+} // namespace mozilla</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineplus">+</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+#endif // mozilla_storage_mozStorageAsyncStatementParams_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParams.cpp</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,497 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+ *</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+ *</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+ * License.</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+ *</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+ *</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineplus">+ *</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineplus">+ *</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+ *</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineplus">+#include &lt;limits.h&gt;</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+#include &quot;mozStorageError.h&quot;</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineplus">+#include &quot;mozStorageBindingParams.h&quot;</span>
<a href="#l46.52"></a><span id="l46.52" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineplus">+#include &quot;Variant.h&quot;</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineplus">+</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineplus">+namespace mozilla {</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+namespace storage {</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineplus">+//// Local Helper Objects</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineplus">+</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineplus">+namespace {</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineplus">+</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineplus">+struct BindingColumnData</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+{</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+  BindingColumnData(sqlite3_stmt *aStmt,</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+                    int aColumn)</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineplus">+  : stmt(aStmt)</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+  , column(aColumn)</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+  {</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineplus">+  }</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineplus">+  sqlite3_stmt *stmt;</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineplus">+  int column;</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+};</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineplus">+</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineplus">+} // anonymous namespace</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+//// Variant Specialization Functions (variantToSQLiteT)</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineplus">+</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineplus">+static int</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineplus">+sqlite3_T_int(BindingColumnData aData,</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineplus">+              int aValue)</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+{</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineplus">+  return ::sqlite3_bind_int(aData.stmt, aData.column + 1, aValue);</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineplus">+}</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineplus">+</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineplus">+static int</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+sqlite3_T_int64(BindingColumnData aData,</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+                sqlite3_int64 aValue)</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+{</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+  return ::sqlite3_bind_int64(aData.stmt, aData.column + 1, aValue);</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+}</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+static int</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+sqlite3_T_double(BindingColumnData aData,</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineplus">+                 double aValue)</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+{</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineplus">+  return ::sqlite3_bind_double(aData.stmt, aData.column + 1, aValue);</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+}</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineplus">+</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineplus">+static int</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineplus">+sqlite3_T_text(BindingColumnData aData,</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineplus">+               const nsCString&amp; aValue)</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineplus">+{</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineplus">+  return ::sqlite3_bind_text(aData.stmt,</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineplus">+                             aData.column + 1,</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+                             aValue.get(),</span>
<a href="#l46.108"></a><span id="l46.108" class="difflineplus">+                             aValue.Length(),</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineplus">+                             SQLITE_TRANSIENT);</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineplus">+}</span>
<a href="#l46.111"></a><span id="l46.111" class="difflineplus">+</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineplus">+static int</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineplus">+sqlite3_T_text16(BindingColumnData aData,</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineplus">+                 const nsString&amp; aValue)</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineplus">+{</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineplus">+  return ::sqlite3_bind_text16(aData.stmt,</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineplus">+                               aData.column + 1,</span>
<a href="#l46.118"></a><span id="l46.118" class="difflineplus">+                               aValue.get(),</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineplus">+                               aValue.Length() * 2, // Length in bytes!</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineplus">+                               SQLITE_TRANSIENT);</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineplus">+}</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineplus">+</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+static int</span>
<a href="#l46.124"></a><span id="l46.124" class="difflineplus">+sqlite3_T_null(BindingColumnData aData)</span>
<a href="#l46.125"></a><span id="l46.125" class="difflineplus">+{</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineplus">+  return ::sqlite3_bind_null(aData.stmt, aData.column + 1);</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+}</span>
<a href="#l46.128"></a><span id="l46.128" class="difflineplus">+</span>
<a href="#l46.129"></a><span id="l46.129" class="difflineplus">+static int</span>
<a href="#l46.130"></a><span id="l46.130" class="difflineplus">+sqlite3_T_blob(BindingColumnData aData,</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineplus">+               const void *aBlob,</span>
<a href="#l46.132"></a><span id="l46.132" class="difflineplus">+               int aSize)</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineplus">+{</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineplus">+  return ::sqlite3_bind_blob(aData.stmt, aData.column + 1, aBlob, aSize,</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineplus">+                             NS_Free);</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+</span>
<a href="#l46.137"></a><span id="l46.137" class="difflineplus">+}</span>
<a href="#l46.138"></a><span id="l46.138" class="difflineplus">+</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineplus">+#include &quot;variantToSQLiteT_impl.h&quot;</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineplus">+</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.142"></a><span id="l46.142" class="difflineplus">+//// BindingParams</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineplus">+</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineplus">+BindingParams::BindingParams(mozIStorageBindingParamsArray *aOwningArray,</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineplus">+                             Statement *aOwningStatement)</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+: mLocked(false)</span>
<a href="#l46.147"></a><span id="l46.147" class="difflineplus">+, mOwningArray(aOwningArray)</span>
<a href="#l46.148"></a><span id="l46.148" class="difflineplus">+, mOwningStatement(aOwningStatement)</span>
<a href="#l46.149"></a><span id="l46.149" class="difflineplus">+{</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineplus">+  (void)mOwningStatement-&gt;GetParameterCount(&amp;mParamCount);</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+  (void)mParameters.SetCapacity(mParamCount);</span>
<a href="#l46.152"></a><span id="l46.152" class="difflineplus">+}</span>
<a href="#l46.153"></a><span id="l46.153" class="difflineplus">+</span>
<a href="#l46.154"></a><span id="l46.154" class="difflineplus">+BindingParams::BindingParams(mozIStorageBindingParamsArray *aOwningArray)</span>
<a href="#l46.155"></a><span id="l46.155" class="difflineplus">+: mLocked(false)</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineplus">+, mOwningArray(aOwningArray)</span>
<a href="#l46.157"></a><span id="l46.157" class="difflineplus">+, mOwningStatement(nsnull)</span>
<a href="#l46.158"></a><span id="l46.158" class="difflineplus">+, mParamCount(0)</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineplus">+{</span>
<a href="#l46.160"></a><span id="l46.160" class="difflineplus">+}</span>
<a href="#l46.161"></a><span id="l46.161" class="difflineplus">+</span>
<a href="#l46.162"></a><span id="l46.162" class="difflineplus">+AsyncBindingParams::AsyncBindingParams(</span>
<a href="#l46.163"></a><span id="l46.163" class="difflineplus">+  mozIStorageBindingParamsArray *aOwningArray</span>
<a href="#l46.164"></a><span id="l46.164" class="difflineplus">+)</span>
<a href="#l46.165"></a><span id="l46.165" class="difflineplus">+: BindingParams(aOwningArray)</span>
<a href="#l46.166"></a><span id="l46.166" class="difflineplus">+{</span>
<a href="#l46.167"></a><span id="l46.167" class="difflineplus">+  mNamedParameters.Init();</span>
<a href="#l46.168"></a><span id="l46.168" class="difflineplus">+}</span>
<a href="#l46.169"></a><span id="l46.169" class="difflineplus">+</span>
<a href="#l46.170"></a><span id="l46.170" class="difflineplus">+void</span>
<a href="#l46.171"></a><span id="l46.171" class="difflineplus">+BindingParams::lock()</span>
<a href="#l46.172"></a><span id="l46.172" class="difflineplus">+{</span>
<a href="#l46.173"></a><span id="l46.173" class="difflineplus">+  NS_ASSERTION(mLocked == false, &quot;Parameters have already been locked!&quot;);</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineplus">+  mLocked = true;</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+</span>
<a href="#l46.176"></a><span id="l46.176" class="difflineplus">+  // We no longer need to hold a reference to our statement or our owning array.</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineplus">+  // The array owns us at this point, and it will own a reference to the</span>
<a href="#l46.178"></a><span id="l46.178" class="difflineplus">+  // statement.</span>
<a href="#l46.179"></a><span id="l46.179" class="difflineplus">+  mOwningStatement = nsnull;</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineplus">+  mOwningArray = nsnull;</span>
<a href="#l46.181"></a><span id="l46.181" class="difflineplus">+}</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineplus">+</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+void</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+BindingParams::unlock(Statement *aOwningStatement)</span>
<a href="#l46.185"></a><span id="l46.185" class="difflineplus">+{</span>
<a href="#l46.186"></a><span id="l46.186" class="difflineplus">+  NS_ASSERTION(mLocked == true, &quot;Parameters were not yet locked!&quot;);</span>
<a href="#l46.187"></a><span id="l46.187" class="difflineplus">+  mLocked = false;</span>
<a href="#l46.188"></a><span id="l46.188" class="difflineplus">+  mOwningStatement = aOwningStatement;</span>
<a href="#l46.189"></a><span id="l46.189" class="difflineplus">+}</span>
<a href="#l46.190"></a><span id="l46.190" class="difflineplus">+</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineplus">+const mozIStorageBindingParamsArray *</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineplus">+BindingParams::getOwner() const</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+{</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineplus">+  return mOwningArray;</span>
<a href="#l46.195"></a><span id="l46.195" class="difflineplus">+}</span>
<a href="#l46.196"></a><span id="l46.196" class="difflineplus">+</span>
<a href="#l46.197"></a><span id="l46.197" class="difflineplus">+PLDHashOperator</span>
<a href="#l46.198"></a><span id="l46.198" class="difflineplus">+AsyncBindingParams::iterateOverNamedParameters(const nsACString &amp;aName,</span>
<a href="#l46.199"></a><span id="l46.199" class="difflineplus">+                                               nsIVariant *aValue,</span>
<a href="#l46.200"></a><span id="l46.200" class="difflineplus">+                                               void *voidClosureThunk)</span>
<a href="#l46.201"></a><span id="l46.201" class="difflineplus">+{</span>
<a href="#l46.202"></a><span id="l46.202" class="difflineplus">+  NamedParameterIterationClosureThunk *closureThunk =</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineplus">+    static_cast&lt;NamedParameterIterationClosureThunk *&gt;(voidClosureThunk);</span>
<a href="#l46.204"></a><span id="l46.204" class="difflineplus">+</span>
<a href="#l46.205"></a><span id="l46.205" class="difflineplus">+  // We do not accept any forms of names other than &quot;:name&quot;, but we need to add</span>
<a href="#l46.206"></a><span id="l46.206" class="difflineplus">+  // the colon for SQLite.</span>
<a href="#l46.207"></a><span id="l46.207" class="difflineplus">+  nsCAutoString name(&quot;:&quot;);</span>
<a href="#l46.208"></a><span id="l46.208" class="difflineplus">+  name.Append(aName);</span>
<a href="#l46.209"></a><span id="l46.209" class="difflineplus">+  int oneIdx = ::sqlite3_bind_parameter_index(closureThunk-&gt;statement,</span>
<a href="#l46.210"></a><span id="l46.210" class="difflineplus">+                                              PromiseFlatCString(name).get());</span>
<a href="#l46.211"></a><span id="l46.211" class="difflineplus">+</span>
<a href="#l46.212"></a><span id="l46.212" class="difflineplus">+  if (oneIdx == 0) {</span>
<a href="#l46.213"></a><span id="l46.213" class="difflineplus">+    nsCAutoString errMsg(aName);</span>
<a href="#l46.214"></a><span id="l46.214" class="difflineplus">+    errMsg.Append(NS_LITERAL_CSTRING(&quot; is not a valid named parameter.&quot;));</span>
<a href="#l46.215"></a><span id="l46.215" class="difflineplus">+    closureThunk-&gt;err = new Error(SQLITE_RANGE,</span>
<a href="#l46.216"></a><span id="l46.216" class="difflineplus">+                                  PromiseFlatCString(errMsg).get());</span>
<a href="#l46.217"></a><span id="l46.217" class="difflineplus">+    return PL_DHASH_STOP;</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineplus">+  }</span>
<a href="#l46.219"></a><span id="l46.219" class="difflineplus">+</span>
<a href="#l46.220"></a><span id="l46.220" class="difflineplus">+  // XPCVariant's AddRef and Release are not thread-safe and so we must not do</span>
<a href="#l46.221"></a><span id="l46.221" class="difflineplus">+  // anything that would invoke them here on the async thread.  As such we can't</span>
<a href="#l46.222"></a><span id="l46.222" class="difflineplus">+  // cram aValue into self-&gt;mParameters using ReplaceObjectAt so that we can</span>
<a href="#l46.223"></a><span id="l46.223" class="difflineplus">+  // freeload off of the BindingParams::Bind implementation.</span>
<a href="#l46.224"></a><span id="l46.224" class="difflineplus">+  int rc = variantToSQLiteT(BindingColumnData(closureThunk-&gt;statement,</span>
<a href="#l46.225"></a><span id="l46.225" class="difflineplus">+                                              oneIdx - 1),</span>
<a href="#l46.226"></a><span id="l46.226" class="difflineplus">+                            aValue);</span>
<a href="#l46.227"></a><span id="l46.227" class="difflineplus">+  if (rc != SQLITE_OK) {</span>
<a href="#l46.228"></a><span id="l46.228" class="difflineplus">+    // We had an error while trying to bind.  Now we need to create an error</span>
<a href="#l46.229"></a><span id="l46.229" class="difflineplus">+    // object with the right message.  Note that we special case</span>
<a href="#l46.230"></a><span id="l46.230" class="difflineplus">+    // SQLITE_MISMATCH, but otherwise get the message from SQLite.</span>
<a href="#l46.231"></a><span id="l46.231" class="difflineplus">+    const char *msg = &quot;Could not covert nsIVariant to SQLite type.&quot;;</span>
<a href="#l46.232"></a><span id="l46.232" class="difflineplus">+    if (rc != SQLITE_MISMATCH)</span>
<a href="#l46.233"></a><span id="l46.233" class="difflineplus">+      msg = ::sqlite3_errmsg(::sqlite3_db_handle(closureThunk-&gt;statement));</span>
<a href="#l46.234"></a><span id="l46.234" class="difflineplus">+</span>
<a href="#l46.235"></a><span id="l46.235" class="difflineplus">+    closureThunk-&gt;err = new Error(rc, msg);</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineplus">+    return PL_DHASH_STOP;</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineplus">+  }</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineplus">+  return PL_DHASH_NEXT;</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+}</span>
<a href="#l46.240"></a><span id="l46.240" class="difflineplus">+</span>
<a href="#l46.241"></a><span id="l46.241" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.242"></a><span id="l46.242" class="difflineplus">+//// nsISupports</span>
<a href="#l46.243"></a><span id="l46.243" class="difflineplus">+</span>
<a href="#l46.244"></a><span id="l46.244" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l46.245"></a><span id="l46.245" class="difflineplus">+  BindingParams</span>
<a href="#l46.246"></a><span id="l46.246" class="difflineplus">+, mozIStorageBindingParams</span>
<a href="#l46.247"></a><span id="l46.247" class="difflineplus">+, IStorageBindingParamsInternal</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineplus">+)</span>
<a href="#l46.249"></a><span id="l46.249" class="difflineplus">+</span>
<a href="#l46.250"></a><span id="l46.250" class="difflineplus">+</span>
<a href="#l46.251"></a><span id="l46.251" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.252"></a><span id="l46.252" class="difflineplus">+//// IStorageBindingParamsInternal</span>
<a href="#l46.253"></a><span id="l46.253" class="difflineplus">+</span>
<a href="#l46.254"></a><span id="l46.254" class="difflineplus">+already_AddRefed&lt;mozIStorageError&gt;</span>
<a href="#l46.255"></a><span id="l46.255" class="difflineplus">+BindingParams::bind(sqlite3_stmt *aStatement)</span>
<a href="#l46.256"></a><span id="l46.256" class="difflineplus">+{</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineplus">+  // Iterate through all of our stored data, and bind it.</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+  for (PRInt32 i = 0; i &lt; mParameters.Count(); i++) {</span>
<a href="#l46.259"></a><span id="l46.259" class="difflineplus">+    int rc = variantToSQLiteT(BindingColumnData(aStatement, i), mParameters[i]);</span>
<a href="#l46.260"></a><span id="l46.260" class="difflineplus">+    if (rc != SQLITE_OK) {</span>
<a href="#l46.261"></a><span id="l46.261" class="difflineplus">+      // We had an error while trying to bind.  Now we need to create an error</span>
<a href="#l46.262"></a><span id="l46.262" class="difflineplus">+      // object with the right message.  Note that we special case</span>
<a href="#l46.263"></a><span id="l46.263" class="difflineplus">+      // SQLITE_MISMATCH, but otherwise get the message from SQLite.</span>
<a href="#l46.264"></a><span id="l46.264" class="difflineplus">+      const char *msg = &quot;Could not covert nsIVariant to SQLite type.&quot;;</span>
<a href="#l46.265"></a><span id="l46.265" class="difflineplus">+      if (rc != SQLITE_MISMATCH)</span>
<a href="#l46.266"></a><span id="l46.266" class="difflineplus">+        msg = ::sqlite3_errmsg(::sqlite3_db_handle(aStatement));</span>
<a href="#l46.267"></a><span id="l46.267" class="difflineplus">+</span>
<a href="#l46.268"></a><span id="l46.268" class="difflineplus">+      nsCOMPtr&lt;mozIStorageError&gt; err(new Error(rc, msg));</span>
<a href="#l46.269"></a><span id="l46.269" class="difflineplus">+      return err.forget();</span>
<a href="#l46.270"></a><span id="l46.270" class="difflineplus">+    }</span>
<a href="#l46.271"></a><span id="l46.271" class="difflineplus">+  }</span>
<a href="#l46.272"></a><span id="l46.272" class="difflineplus">+</span>
<a href="#l46.273"></a><span id="l46.273" class="difflineplus">+  return nsnull;</span>
<a href="#l46.274"></a><span id="l46.274" class="difflineplus">+}</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineplus">+</span>
<a href="#l46.276"></a><span id="l46.276" class="difflineplus">+already_AddRefed&lt;mozIStorageError&gt;</span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+AsyncBindingParams::bind(sqlite3_stmt * aStatement)</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+{</span>
<a href="#l46.279"></a><span id="l46.279" class="difflineplus">+  // We should bind by index using the super-class if there is nothing in our</span>
<a href="#l46.280"></a><span id="l46.280" class="difflineplus">+  // hashtable.</span>
<a href="#l46.281"></a><span id="l46.281" class="difflineplus">+  if (!mNamedParameters.Count())</span>
<a href="#l46.282"></a><span id="l46.282" class="difflineplus">+    return BindingParams::bind(aStatement);</span>
<a href="#l46.283"></a><span id="l46.283" class="difflineplus">+</span>
<a href="#l46.284"></a><span id="l46.284" class="difflineplus">+  // Enumerate over everyone in the map, propagating them into mParameters if</span>
<a href="#l46.285"></a><span id="l46.285" class="difflineplus">+  // we can and creating an error immediately when we cannot.</span>
<a href="#l46.286"></a><span id="l46.286" class="difflineplus">+  NamedParameterIterationClosureThunk closureThunk = {this, aStatement, nsnull};</span>
<a href="#l46.287"></a><span id="l46.287" class="difflineplus">+  (void)mNamedParameters.EnumerateRead(iterateOverNamedParameters,</span>
<a href="#l46.288"></a><span id="l46.288" class="difflineplus">+                                       (void *)&amp;closureThunk);</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineplus">+</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineplus">+  return closureThunk.err.forget();</span>
<a href="#l46.291"></a><span id="l46.291" class="difflineplus">+}</span>
<a href="#l46.292"></a><span id="l46.292" class="difflineplus">+</span>
<a href="#l46.293"></a><span id="l46.293" class="difflineplus">+</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l46.295"></a><span id="l46.295" class="difflineplus">+//// mozIStorageBindingParams</span>
<a href="#l46.296"></a><span id="l46.296" class="difflineplus">+</span>
<a href="#l46.297"></a><span id="l46.297" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.298"></a><span id="l46.298" class="difflineplus">+BindingParams::BindByName(const nsACString &amp;aName,</span>
<a href="#l46.299"></a><span id="l46.299" class="difflineplus">+                          nsIVariant *aValue)</span>
<a href="#l46.300"></a><span id="l46.300" class="difflineplus">+{</span>
<a href="#l46.301"></a><span id="l46.301" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l46.302"></a><span id="l46.302" class="difflineplus">+</span>
<a href="#l46.303"></a><span id="l46.303" class="difflineplus">+  // Get the column index that we need to store this at.</span>
<a href="#l46.304"></a><span id="l46.304" class="difflineplus">+  PRUint32 index;</span>
<a href="#l46.305"></a><span id="l46.305" class="difflineplus">+  nsresult rv = mOwningStatement-&gt;GetParameterIndex(aName, &amp;index);</span>
<a href="#l46.306"></a><span id="l46.306" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l46.307"></a><span id="l46.307" class="difflineplus">+</span>
<a href="#l46.308"></a><span id="l46.308" class="difflineplus">+  return BindByIndex(index, aValue);</span>
<a href="#l46.309"></a><span id="l46.309" class="difflineplus">+}</span>
<a href="#l46.310"></a><span id="l46.310" class="difflineplus">+</span>
<a href="#l46.311"></a><span id="l46.311" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.312"></a><span id="l46.312" class="difflineplus">+AsyncBindingParams::BindByName(const nsACString &amp;aName,</span>
<a href="#l46.313"></a><span id="l46.313" class="difflineplus">+                               nsIVariant *aValue)</span>
<a href="#l46.314"></a><span id="l46.314" class="difflineplus">+{</span>
<a href="#l46.315"></a><span id="l46.315" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l46.316"></a><span id="l46.316" class="difflineplus">+</span>
<a href="#l46.317"></a><span id="l46.317" class="difflineplus">+  if (!mNamedParameters.Put(aName, aValue))</span>
<a href="#l46.318"></a><span id="l46.318" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l46.319"></a><span id="l46.319" class="difflineplus">+  return NS_OK;</span>
<a href="#l46.320"></a><span id="l46.320" class="difflineplus">+}</span>
<a href="#l46.321"></a><span id="l46.321" class="difflineplus">+</span>
<a href="#l46.322"></a><span id="l46.322" class="difflineplus">+</span>
<a href="#l46.323"></a><span id="l46.323" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.324"></a><span id="l46.324" class="difflineplus">+BindingParams::BindUTF8StringByName(const nsACString &amp;aName,</span>
<a href="#l46.325"></a><span id="l46.325" class="difflineplus">+                                    const nsACString &amp;aValue)</span>
<a href="#l46.326"></a><span id="l46.326" class="difflineplus">+{</span>
<a href="#l46.327"></a><span id="l46.327" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new UTF8TextVariant(aValue));</span>
<a href="#l46.328"></a><span id="l46.328" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.329"></a><span id="l46.329" class="difflineplus">+</span>
<a href="#l46.330"></a><span id="l46.330" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.331"></a><span id="l46.331" class="difflineplus">+}</span>
<a href="#l46.332"></a><span id="l46.332" class="difflineplus">+</span>
<a href="#l46.333"></a><span id="l46.333" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.334"></a><span id="l46.334" class="difflineplus">+BindingParams::BindStringByName(const nsACString &amp;aName,</span>
<a href="#l46.335"></a><span id="l46.335" class="difflineplus">+                                const nsAString &amp;aValue)</span>
<a href="#l46.336"></a><span id="l46.336" class="difflineplus">+{</span>
<a href="#l46.337"></a><span id="l46.337" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new TextVariant(aValue));</span>
<a href="#l46.338"></a><span id="l46.338" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.339"></a><span id="l46.339" class="difflineplus">+</span>
<a href="#l46.340"></a><span id="l46.340" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.341"></a><span id="l46.341" class="difflineplus">+}</span>
<a href="#l46.342"></a><span id="l46.342" class="difflineplus">+</span>
<a href="#l46.343"></a><span id="l46.343" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.344"></a><span id="l46.344" class="difflineplus">+BindingParams::BindDoubleByName(const nsACString &amp;aName,</span>
<a href="#l46.345"></a><span id="l46.345" class="difflineplus">+                                double aValue)</span>
<a href="#l46.346"></a><span id="l46.346" class="difflineplus">+{</span>
<a href="#l46.347"></a><span id="l46.347" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new FloatVariant(aValue));</span>
<a href="#l46.348"></a><span id="l46.348" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.349"></a><span id="l46.349" class="difflineplus">+</span>
<a href="#l46.350"></a><span id="l46.350" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.351"></a><span id="l46.351" class="difflineplus">+}</span>
<a href="#l46.352"></a><span id="l46.352" class="difflineplus">+</span>
<a href="#l46.353"></a><span id="l46.353" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.354"></a><span id="l46.354" class="difflineplus">+BindingParams::BindInt32ByName(const nsACString &amp;aName,</span>
<a href="#l46.355"></a><span id="l46.355" class="difflineplus">+                               PRInt32 aValue)</span>
<a href="#l46.356"></a><span id="l46.356" class="difflineplus">+{</span>
<a href="#l46.357"></a><span id="l46.357" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new IntegerVariant(aValue));</span>
<a href="#l46.358"></a><span id="l46.358" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.359"></a><span id="l46.359" class="difflineplus">+</span>
<a href="#l46.360"></a><span id="l46.360" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.361"></a><span id="l46.361" class="difflineplus">+}</span>
<a href="#l46.362"></a><span id="l46.362" class="difflineplus">+</span>
<a href="#l46.363"></a><span id="l46.363" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineplus">+BindingParams::BindInt64ByName(const nsACString &amp;aName,</span>
<a href="#l46.365"></a><span id="l46.365" class="difflineplus">+                               PRInt64 aValue)</span>
<a href="#l46.366"></a><span id="l46.366" class="difflineplus">+{</span>
<a href="#l46.367"></a><span id="l46.367" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new IntegerVariant(aValue));</span>
<a href="#l46.368"></a><span id="l46.368" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.369"></a><span id="l46.369" class="difflineplus">+</span>
<a href="#l46.370"></a><span id="l46.370" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.371"></a><span id="l46.371" class="difflineplus">+}</span>
<a href="#l46.372"></a><span id="l46.372" class="difflineplus">+</span>
<a href="#l46.373"></a><span id="l46.373" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.374"></a><span id="l46.374" class="difflineplus">+BindingParams::BindNullByName(const nsACString &amp;aName)</span>
<a href="#l46.375"></a><span id="l46.375" class="difflineplus">+{</span>
<a href="#l46.376"></a><span id="l46.376" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new NullVariant());</span>
<a href="#l46.377"></a><span id="l46.377" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.378"></a><span id="l46.378" class="difflineplus">+</span>
<a href="#l46.379"></a><span id="l46.379" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.380"></a><span id="l46.380" class="difflineplus">+}</span>
<a href="#l46.381"></a><span id="l46.381" class="difflineplus">+</span>
<a href="#l46.382"></a><span id="l46.382" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.383"></a><span id="l46.383" class="difflineplus">+BindingParams::BindBlobByName(const nsACString &amp;aName,</span>
<a href="#l46.384"></a><span id="l46.384" class="difflineplus">+                              const PRUint8 *aValue,</span>
<a href="#l46.385"></a><span id="l46.385" class="difflineplus">+                              PRUint32 aValueSize)</span>
<a href="#l46.386"></a><span id="l46.386" class="difflineplus">+{</span>
<a href="#l46.387"></a><span id="l46.387" class="difflineplus">+  NS_ENSURE_ARG_MAX(aValueSize, INT_MAX);</span>
<a href="#l46.388"></a><span id="l46.388" class="difflineplus">+  std::pair&lt;const void *, int&gt; data(</span>
<a href="#l46.389"></a><span id="l46.389" class="difflineplus">+    static_cast&lt;const void *&gt;(aValue),</span>
<a href="#l46.390"></a><span id="l46.390" class="difflineplus">+    int(aValueSize)</span>
<a href="#l46.391"></a><span id="l46.391" class="difflineplus">+  );</span>
<a href="#l46.392"></a><span id="l46.392" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new BlobVariant(data));</span>
<a href="#l46.393"></a><span id="l46.393" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.394"></a><span id="l46.394" class="difflineplus">+</span>
<a href="#l46.395"></a><span id="l46.395" class="difflineplus">+  return BindByName(aName, value);</span>
<a href="#l46.396"></a><span id="l46.396" class="difflineplus">+}</span>
<a href="#l46.397"></a><span id="l46.397" class="difflineplus">+</span>
<a href="#l46.398"></a><span id="l46.398" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.399"></a><span id="l46.399" class="difflineplus">+BindingParams::BindByIndex(PRUint32 aIndex,</span>
<a href="#l46.400"></a><span id="l46.400" class="difflineplus">+                           nsIVariant *aValue)</span>
<a href="#l46.401"></a><span id="l46.401" class="difflineplus">+{</span>
<a href="#l46.402"></a><span id="l46.402" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l46.403"></a><span id="l46.403" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mParamCount);</span>
<a href="#l46.404"></a><span id="l46.404" class="difflineplus">+</span>
<a href="#l46.405"></a><span id="l46.405" class="difflineplus">+  // Store the variant for later use.</span>
<a href="#l46.406"></a><span id="l46.406" class="difflineplus">+  NS_ENSURE_TRUE(mParameters.ReplaceObjectAt(aValue, aIndex),</span>
<a href="#l46.407"></a><span id="l46.407" class="difflineplus">+                 NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.408"></a><span id="l46.408" class="difflineplus">+  return NS_OK;</span>
<a href="#l46.409"></a><span id="l46.409" class="difflineplus">+}</span>
<a href="#l46.410"></a><span id="l46.410" class="difflineplus">+</span>
<a href="#l46.411"></a><span id="l46.411" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.412"></a><span id="l46.412" class="difflineplus">+AsyncBindingParams::BindByIndex(PRUint32 aIndex,</span>
<a href="#l46.413"></a><span id="l46.413" class="difflineplus">+                                nsIVariant *aValue)</span>
<a href="#l46.414"></a><span id="l46.414" class="difflineplus">+{</span>
<a href="#l46.415"></a><span id="l46.415" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l46.416"></a><span id="l46.416" class="difflineplus">+  // In the asynchronous case we do not know how many parameters there are to</span>
<a href="#l46.417"></a><span id="l46.417" class="difflineplus">+  // bind to, so we cannot check the validity of aIndex.</span>
<a href="#l46.418"></a><span id="l46.418" class="difflineplus">+</span>
<a href="#l46.419"></a><span id="l46.419" class="difflineplus">+  // Store the variant for later use.</span>
<a href="#l46.420"></a><span id="l46.420" class="difflineplus">+  NS_ENSURE_TRUE(mParameters.ReplaceObjectAt(aValue, aIndex),</span>
<a href="#l46.421"></a><span id="l46.421" class="difflineplus">+                 NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.422"></a><span id="l46.422" class="difflineplus">+  return NS_OK;</span>
<a href="#l46.423"></a><span id="l46.423" class="difflineplus">+}</span>
<a href="#l46.424"></a><span id="l46.424" class="difflineplus">+</span>
<a href="#l46.425"></a><span id="l46.425" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.426"></a><span id="l46.426" class="difflineplus">+BindingParams::BindUTF8StringByIndex(PRUint32 aIndex,</span>
<a href="#l46.427"></a><span id="l46.427" class="difflineplus">+                                     const nsACString &amp;aValue)</span>
<a href="#l46.428"></a><span id="l46.428" class="difflineplus">+{</span>
<a href="#l46.429"></a><span id="l46.429" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new UTF8TextVariant(aValue));</span>
<a href="#l46.430"></a><span id="l46.430" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.431"></a><span id="l46.431" class="difflineplus">+</span>
<a href="#l46.432"></a><span id="l46.432" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.433"></a><span id="l46.433" class="difflineplus">+}</span>
<a href="#l46.434"></a><span id="l46.434" class="difflineplus">+</span>
<a href="#l46.435"></a><span id="l46.435" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.436"></a><span id="l46.436" class="difflineplus">+BindingParams::BindStringByIndex(PRUint32 aIndex,</span>
<a href="#l46.437"></a><span id="l46.437" class="difflineplus">+                                 const nsAString &amp;aValue)</span>
<a href="#l46.438"></a><span id="l46.438" class="difflineplus">+{</span>
<a href="#l46.439"></a><span id="l46.439" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new TextVariant(aValue));</span>
<a href="#l46.440"></a><span id="l46.440" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.441"></a><span id="l46.441" class="difflineplus">+</span>
<a href="#l46.442"></a><span id="l46.442" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.443"></a><span id="l46.443" class="difflineplus">+}</span>
<a href="#l46.444"></a><span id="l46.444" class="difflineplus">+</span>
<a href="#l46.445"></a><span id="l46.445" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.446"></a><span id="l46.446" class="difflineplus">+BindingParams::BindDoubleByIndex(PRUint32 aIndex,</span>
<a href="#l46.447"></a><span id="l46.447" class="difflineplus">+                                 double aValue)</span>
<a href="#l46.448"></a><span id="l46.448" class="difflineplus">+{</span>
<a href="#l46.449"></a><span id="l46.449" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new FloatVariant(aValue));</span>
<a href="#l46.450"></a><span id="l46.450" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.451"></a><span id="l46.451" class="difflineplus">+</span>
<a href="#l46.452"></a><span id="l46.452" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.453"></a><span id="l46.453" class="difflineplus">+}</span>
<a href="#l46.454"></a><span id="l46.454" class="difflineplus">+</span>
<a href="#l46.455"></a><span id="l46.455" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.456"></a><span id="l46.456" class="difflineplus">+BindingParams::BindInt32ByIndex(PRUint32 aIndex,</span>
<a href="#l46.457"></a><span id="l46.457" class="difflineplus">+                                PRInt32 aValue)</span>
<a href="#l46.458"></a><span id="l46.458" class="difflineplus">+{</span>
<a href="#l46.459"></a><span id="l46.459" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new IntegerVariant(aValue));</span>
<a href="#l46.460"></a><span id="l46.460" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.461"></a><span id="l46.461" class="difflineplus">+</span>
<a href="#l46.462"></a><span id="l46.462" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.463"></a><span id="l46.463" class="difflineplus">+}</span>
<a href="#l46.464"></a><span id="l46.464" class="difflineplus">+</span>
<a href="#l46.465"></a><span id="l46.465" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.466"></a><span id="l46.466" class="difflineplus">+BindingParams::BindInt64ByIndex(PRUint32 aIndex,</span>
<a href="#l46.467"></a><span id="l46.467" class="difflineplus">+                                PRInt64 aValue)</span>
<a href="#l46.468"></a><span id="l46.468" class="difflineplus">+{</span>
<a href="#l46.469"></a><span id="l46.469" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new IntegerVariant(aValue));</span>
<a href="#l46.470"></a><span id="l46.470" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.471"></a><span id="l46.471" class="difflineplus">+</span>
<a href="#l46.472"></a><span id="l46.472" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.473"></a><span id="l46.473" class="difflineplus">+}</span>
<a href="#l46.474"></a><span id="l46.474" class="difflineplus">+</span>
<a href="#l46.475"></a><span id="l46.475" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.476"></a><span id="l46.476" class="difflineplus">+BindingParams::BindNullByIndex(PRUint32 aIndex)</span>
<a href="#l46.477"></a><span id="l46.477" class="difflineplus">+{</span>
<a href="#l46.478"></a><span id="l46.478" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new NullVariant());</span>
<a href="#l46.479"></a><span id="l46.479" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.480"></a><span id="l46.480" class="difflineplus">+</span>
<a href="#l46.481"></a><span id="l46.481" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.482"></a><span id="l46.482" class="difflineplus">+}</span>
<a href="#l46.483"></a><span id="l46.483" class="difflineplus">+</span>
<a href="#l46.484"></a><span id="l46.484" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l46.485"></a><span id="l46.485" class="difflineplus">+BindingParams::BindBlobByIndex(PRUint32 aIndex,</span>
<a href="#l46.486"></a><span id="l46.486" class="difflineplus">+                               const PRUint8 *aValue,</span>
<a href="#l46.487"></a><span id="l46.487" class="difflineplus">+                               PRUint32 aValueSize)</span>
<a href="#l46.488"></a><span id="l46.488" class="difflineplus">+{</span>
<a href="#l46.489"></a><span id="l46.489" class="difflineplus">+  NS_ENSURE_ARG_MAX(aValueSize, INT_MAX);</span>
<a href="#l46.490"></a><span id="l46.490" class="difflineplus">+  std::pair&lt;const void *, int&gt; data(</span>
<a href="#l46.491"></a><span id="l46.491" class="difflineplus">+    static_cast&lt;const void *&gt;(aValue),</span>
<a href="#l46.492"></a><span id="l46.492" class="difflineplus">+    int(aValueSize)</span>
<a href="#l46.493"></a><span id="l46.493" class="difflineplus">+  );</span>
<a href="#l46.494"></a><span id="l46.494" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; value(new BlobVariant(data));</span>
<a href="#l46.495"></a><span id="l46.495" class="difflineplus">+  NS_ENSURE_TRUE(value, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l46.496"></a><span id="l46.496" class="difflineplus">+</span>
<a href="#l46.497"></a><span id="l46.497" class="difflineplus">+  return BindByIndex(aIndex, value);</span>
<a href="#l46.498"></a><span id="l46.498" class="difflineplus">+}</span>
<a href="#l46.499"></a><span id="l46.499" class="difflineplus">+</span>
<a href="#l46.500"></a><span id="l46.500" class="difflineplus">+} // namespace storage</span>
<a href="#l46.501"></a><span id="l46.501" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParams.h</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,154 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+ *</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+ *</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+ * License.</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+ *</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+ *</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+ *</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+ *</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineplus">+ *</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineplus">+</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+#ifndef _mozStorageBindingParams_h_</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineplus">+#define _mozStorageBindingParams_h_</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+#include &quot;nsIVariant.h&quot;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+#include &quot;nsTHashtable.h&quot;</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineplus">+#include &quot;mozStorageAsyncStatement.h&quot;</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+#include &quot;mozIStorageBindingParams.h&quot;</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+#include &quot;IStorageBindingParamsInternal.h&quot;</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineplus">+</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+namespace mozilla {</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+namespace storage {</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+class BindingParams : public mozIStorageBindingParams</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+                    , public IStorageBindingParamsInternal</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+{</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+public:</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+  NS_DECL_MOZISTORAGEBINDINGPARAMS</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+  NS_DECL_ISTORAGEBINDINGPARAMSINTERNAL</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+  /**</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+   * Locks the parameters and prevents further modification to it (such as</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+   * binding more elements to it).</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+   */</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineplus">+  void lock();</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+  /**</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+   * Unlocks the parameters and allows modification to it again.</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+   *</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+   * @param aOwningStatement The statement that owns us.  We cleared this when</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+   *        we were locked, and our invariant requires us to have this, so you</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+   *        need to tell us again.</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+   */</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+  void unlock(Statement *aOwningStatement);</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+  /**</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+   * @returns the pointer to the owning BindingParamsArray.  Used by a</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+   *          BindingParamsArray to verify that we belong to it when added.</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+   */</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+  const mozIStorageBindingParamsArray *getOwner() const;</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineplus">+  BindingParams(mozIStorageBindingParamsArray *aOwningArray,</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineplus">+                Statement *aOwningStatement);</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineplus">+  virtual ~BindingParams() {}</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineplus">+</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineplus">+protected:</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineplus">+  BindingParams(mozIStorageBindingParamsArray *aOwningArray);</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+  nsCOMArray&lt;nsIVariant&gt; mParameters;</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineplus">+  bool mLocked;</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineplus">+</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineplus">+private:</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineplus">+</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineplus">+  /**</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+   * Track the BindingParamsArray that created us until we are added to it.</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+   * (Once we are added we are locked and no one needs to look up our owner.)</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+   * Ref-counted since there is no invariant that guarantees it stays alive</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineplus">+   * otherwise.  This keeps mOwningStatement alive for us too since the array</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineplus">+   * also holds a reference.</span>
<a href="#l47.108"></a><span id="l47.108" class="difflineplus">+   */</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; mOwningArray;</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+  /**</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineplus">+   * Used in the synchronous binding case to map parameter names to indices.</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineplus">+   * Not reference-counted because this is only non-null as long as mOwningArray</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineplus">+   * is non-null and mOwningArray also holds a statement reference.</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineplus">+   */</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineplus">+  Statement *mOwningStatement;</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+  PRUint32 mParamCount;</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineplus">+};</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineplus">+</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineplus">+/**</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineplus">+ * Adds late resolution of named parameters so they don't get resolved until we</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineplus">+ * try and bind the parameters on the async thread.  We also stop checking</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineplus">+ * parameter indices for being too big since we just just don't know how many</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineplus">+ * there are.</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+ *</span>
<a href="#l47.125"></a><span id="l47.125" class="difflineplus">+ * We support *either* binding by name or binding by index.  Trying to do both</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineplus">+ * results in only binding by name at sqlite3_stmt bind time.</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineplus">+ */</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineplus">+class AsyncBindingParams : public BindingParams</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineplus">+{</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineplus">+public:</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineplus">+  NS_SCRIPTABLE NS_IMETHOD BindByName(const nsACString &amp; aName,</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineplus">+                                      nsIVariant *aValue);</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineplus">+  NS_SCRIPTABLE NS_IMETHOD BindByIndex(PRUint32 aIndex, nsIVariant *aValue);</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineplus">+</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineplus">+  virtual already_AddRefed&lt;mozIStorageError&gt; bind(sqlite3_stmt * aStatement);</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineplus">+</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineplus">+  AsyncBindingParams(mozIStorageBindingParamsArray *aOwningArray);</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineplus">+  virtual ~AsyncBindingParams() {}</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineplus">+</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineplus">+private:</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIVariant&gt; mNamedParameters;</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineplus">+</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+  struct NamedParameterIterationClosureThunk</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineplus">+  {</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineplus">+    AsyncBindingParams *self;</span>
<a href="#l47.146"></a><span id="l47.146" class="difflineplus">+    sqlite3_stmt *statement;</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineplus">+    nsCOMPtr&lt;mozIStorageError&gt; err;</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineplus">+  };</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineplus">+</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+  static PLDHashOperator iterateOverNamedParameters(const nsACString &amp;aName,</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineplus">+                                                    nsIVariant *aValue,</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineplus">+                                                    void *voidClosureThunk);</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineplus">+};</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineplus">+</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineplus">+} // namespace storage</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+} // namespace mozilla</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineplus">+</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineplus">+#endif // _mozStorageBindingParams_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParamsArray.cpp</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,116 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+ *</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+ *</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+ * License.</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+ *</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+ *</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+ *</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+ *</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineplus">+ *</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineplus">+#include &quot;mozStorageBindingParams.h&quot;</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineplus">+</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineplus">+namespace mozilla {</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+namespace storage {</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+//// BindingParamsArray</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+BindingParamsArray::BindingParamsArray(</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+  StorageBaseStatementInternal *aOwningStatement</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+)</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+: mOwningStatement(aOwningStatement)</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+, mLocked(false)</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+{</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+}</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+void</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+BindingParamsArray::lock()</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+{</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+  NS_ASSERTION(mLocked == false, &quot;Array has already been locked!&quot;);</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+  mLocked = true;</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+  // We also no longer need to hold a reference to our statement since it owns</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+  // us.</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+  mOwningStatement = nsnull;</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+}</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+const StorageBaseStatementInternal *</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+BindingParamsArray::getOwner() const</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+{</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+  return mOwningStatement;</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+}</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+  BindingParamsArray,</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+  mozIStorageBindingParamsArray</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+)</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+//// mozIStorageBindingParamsArray</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+BindingParamsArray::NewBindingParams(mozIStorageBindingParams **_params)</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+{</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParams&gt; params(</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+    mOwningStatement-&gt;newBindingParams(this));</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+  NS_ENSURE_TRUE(params, NS_ERROR_UNEXPECTED);</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineplus">+</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineplus">+  params.forget(_params);</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+  return NS_OK;</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+}</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+BindingParamsArray::AddParams(mozIStorageBindingParams *aParameters)</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+{</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineplus">+  NS_ENSURE_FALSE(mLocked, NS_ERROR_UNEXPECTED);</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+  BindingParams *params = static_cast&lt;BindingParams *&gt;(aParameters);</span>
<a href="#l48.106"></a><span id="l48.106" class="difflineplus">+</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineplus">+  // Check to make sure that this set of parameters was created with us.</span>
<a href="#l48.108"></a><span id="l48.108" class="difflineplus">+  if (params-&gt;getOwner() != this)</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineplus">+</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+  NS_ENSURE_TRUE(mArray.AppendElement(params), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineplus">+</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineplus">+  // Lock the parameters only after we've successfully added them.</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+  params-&gt;lock();</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineplus">+  return NS_OK;</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineplus">+}</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineplus">+</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineplus">+} // namespace storage</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/storage-backport/src/mozStorageBindingParamsArray.h</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,144 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+ *</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+ *</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+ * License.</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+ *</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+ *</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+ *</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+ *</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+ *</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineplus">+</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineplus">+#ifndef _mozStorageBindingParamsArray_h_</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+#define _mozStorageBindingParamsArray_h_</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineplus">+</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+#include &quot;mozIStorageBindingParamsArray.h&quot;</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+namespace mozilla {</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+namespace storage {</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+class StorageBaseStatementInternal;</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+class BindingParamsArray : public mozIStorageBindingParamsArray</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+{</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+public:</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+  NS_DECL_MOZISTORAGEBINDINGPARAMSARRAY</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineplus">+  BindingParamsArray(StorageBaseStatementInternal *aOwningStatement);</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+  typedef nsTArray_base::size_type size_type;</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+  /**</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineplus">+   * Locks the array and prevents further modification to it (such as adding</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+   * more elements to it).</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineplus">+   */</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+  void lock();</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineplus">+</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+  /**</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+   * @return the pointer to the owning BindingParamsArray.</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+   */</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+  const StorageBaseStatementInternal *getOwner() const;</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+  /**</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineplus">+   * @return the number of elemets the array contains.</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+   */</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+  const size_type length() const { return mArray.Length(); }</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+  class iterator {</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+  public:</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+    iterator(BindingParamsArray *aArray,</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+             PRUint32 aIndex)</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineplus">+    : mArray(aArray)</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+    , mIndex(aIndex)</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+    {</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+    }</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+    iterator &amp;operator++(int)</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineplus">+    {</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+      mIndex++;</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineplus">+      return *this;</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineplus">+    }</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineplus">+</span>
<a href="#l49.98"></a><span id="l49.98" class="difflineplus">+    bool operator==(const iterator &amp;aOther) const</span>
<a href="#l49.99"></a><span id="l49.99" class="difflineplus">+    {</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineplus">+      return mIndex == aOther.mIndex;</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineplus">+    }</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+    bool operator!=(const iterator &amp;aOther) const</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+    {</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineplus">+      return !(*this == aOther);</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+    }</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineplus">+    mozIStorageBindingParams *operator*()</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineplus">+    {</span>
<a href="#l49.108"></a><span id="l49.108" class="difflineplus">+      NS_ASSERTION(mIndex &lt; mArray-&gt;length(),</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+                   &quot;Dereferenceing an invalid value!&quot;);</span>
<a href="#l49.110"></a><span id="l49.110" class="difflineplus">+      return mArray-&gt;mArray[mIndex].get();</span>
<a href="#l49.111"></a><span id="l49.111" class="difflineplus">+    }</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineplus">+  private:</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineplus">+    void operator--() { }</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineplus">+    BindingParamsArray *mArray;</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+    PRUint32 mIndex;</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+  };</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+</span>
<a href="#l49.118"></a><span id="l49.118" class="difflineplus">+  /**</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineplus">+   * Obtains an iterator pointing to the beginning of the array.</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineplus">+   */</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+  inline iterator begin()</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+  {</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+    NS_ASSERTION(length() != 0,</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+                 &quot;Obtaining an iterator to the beginning with no elements!&quot;);</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineplus">+    return iterator(this, 0);</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineplus">+  }</span>
<a href="#l49.127"></a><span id="l49.127" class="difflineplus">+</span>
<a href="#l49.128"></a><span id="l49.128" class="difflineplus">+  /**</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineplus">+   * Obtains an iterator pointing to the end of the array.</span>
<a href="#l49.130"></a><span id="l49.130" class="difflineplus">+   */</span>
<a href="#l49.131"></a><span id="l49.131" class="difflineplus">+  inline iterator end()</span>
<a href="#l49.132"></a><span id="l49.132" class="difflineplus">+  {</span>
<a href="#l49.133"></a><span id="l49.133" class="difflineplus">+    NS_ASSERTION(mLocked,</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineplus">+                 &quot;Obtaining an iterator to the end when we are not locked!&quot;);</span>
<a href="#l49.135"></a><span id="l49.135" class="difflineplus">+    return iterator(this, length());</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineplus">+  }</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineplus">+private:</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineplus">+  nsCOMPtr&lt;StorageBaseStatementInternal&gt; mOwningStatement;</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineplus">+  nsTArray&lt; nsCOMPtr&lt;mozIStorageBindingParams&gt; &gt; mArray;</span>
<a href="#l49.140"></a><span id="l49.140" class="difflineplus">+  bool mLocked;</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineplus">+</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineplus">+  friend class iterator;</span>
<a href="#l49.143"></a><span id="l49.143" class="difflineplus">+};</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineplus">+</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineplus">+} // namespace storage</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineplus">+} // namespace mozilla</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineplus">+</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineplus">+#endif // _mozStorageBindingParamsArray_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/storage-backport/src/mozStorageConnection.cpp</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,1043 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+ *</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+ *</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+ * License.</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+ *</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+ *</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+ *</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+ *   Brett Wilson &lt;brettw@gmail.com&gt;</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+ *</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+ *</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+#include &quot;nsHashSets.h&quot;</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+#include &quot;nsIPrefService.h&quot;</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineplus">+#include &quot;nsAutoLock.h&quot;</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+#include &quot;mozIStorageAggregateFunction.h&quot;</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineplus">+#include &quot;mozIStorageCompletionCallback.h&quot;</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+#include &quot;mozIStorageFunction.h&quot;</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+#include &quot;mozStorageAsyncStatementExecution.h&quot;</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+#include &quot;mozStorageSQLFunctions.h&quot;</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+#include &quot;mozStorageAsyncStatement.h&quot;</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+#include &quot;mozStorageArgValueArray.h&quot;</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineplus">+#include &quot;mozStorageStatementData.h&quot;</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineplus">+#include &quot;SQLCollations.h&quot;</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineplus">+PRLogModuleInfo* gStorageLog = nsnull;</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineplus">+#endif</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+</span>
<a href="#l50.83"></a><span id="l50.83" class="difflineplus">+namespace mozilla {</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineplus">+namespace storage {</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineplus">+</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineplus">+#define PREF_TS_SYNCHRONOUS &quot;toolkit.storage.synchronous&quot;</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineplus">+</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineplus">+//// Variant Specialization Functions (variantToSQLiteT)</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineplus">+</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineplus">+static int</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineplus">+sqlite3_T_int(sqlite3_context *aCtx,</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineplus">+              int aValue)</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+{</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineplus">+  ::sqlite3_result_int(aCtx, aValue);</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineplus">+}</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineplus">+</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineplus">+static int</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+sqlite3_T_int64(sqlite3_context *aCtx,</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineplus">+                sqlite3_int64 aValue)</span>
<a href="#l50.102"></a><span id="l50.102" class="difflineplus">+{</span>
<a href="#l50.103"></a><span id="l50.103" class="difflineplus">+  ::sqlite3_result_int64(aCtx, aValue);</span>
<a href="#l50.104"></a><span id="l50.104" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineplus">+}</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineplus">+</span>
<a href="#l50.107"></a><span id="l50.107" class="difflineplus">+static int</span>
<a href="#l50.108"></a><span id="l50.108" class="difflineplus">+sqlite3_T_double(sqlite3_context *aCtx,</span>
<a href="#l50.109"></a><span id="l50.109" class="difflineplus">+                 double aValue)</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineplus">+{</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineplus">+  ::sqlite3_result_double(aCtx, aValue);</span>
<a href="#l50.112"></a><span id="l50.112" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.113"></a><span id="l50.113" class="difflineplus">+}</span>
<a href="#l50.114"></a><span id="l50.114" class="difflineplus">+</span>
<a href="#l50.115"></a><span id="l50.115" class="difflineplus">+static int</span>
<a href="#l50.116"></a><span id="l50.116" class="difflineplus">+sqlite3_T_text(sqlite3_context *aCtx,</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineplus">+               const nsCString &amp;aValue)</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineplus">+{</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineplus">+  ::sqlite3_result_text(aCtx,</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineplus">+                        aValue.get(),</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineplus">+                        aValue.Length(),</span>
<a href="#l50.122"></a><span id="l50.122" class="difflineplus">+                        SQLITE_TRANSIENT);</span>
<a href="#l50.123"></a><span id="l50.123" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.124"></a><span id="l50.124" class="difflineplus">+}</span>
<a href="#l50.125"></a><span id="l50.125" class="difflineplus">+</span>
<a href="#l50.126"></a><span id="l50.126" class="difflineplus">+static int</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineplus">+sqlite3_T_text16(sqlite3_context *aCtx,</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineplus">+                 const nsString &amp;aValue)</span>
<a href="#l50.129"></a><span id="l50.129" class="difflineplus">+{</span>
<a href="#l50.130"></a><span id="l50.130" class="difflineplus">+  ::sqlite3_result_text16(aCtx,</span>
<a href="#l50.131"></a><span id="l50.131" class="difflineplus">+                          aValue.get(),</span>
<a href="#l50.132"></a><span id="l50.132" class="difflineplus">+                          aValue.Length() * 2, // Number of bytes.</span>
<a href="#l50.133"></a><span id="l50.133" class="difflineplus">+                          SQLITE_TRANSIENT);</span>
<a href="#l50.134"></a><span id="l50.134" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.135"></a><span id="l50.135" class="difflineplus">+}</span>
<a href="#l50.136"></a><span id="l50.136" class="difflineplus">+</span>
<a href="#l50.137"></a><span id="l50.137" class="difflineplus">+static int</span>
<a href="#l50.138"></a><span id="l50.138" class="difflineplus">+sqlite3_T_null(sqlite3_context *aCtx)</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineplus">+{</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineplus">+  ::sqlite3_result_null(aCtx);</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineplus">+}</span>
<a href="#l50.143"></a><span id="l50.143" class="difflineplus">+</span>
<a href="#l50.144"></a><span id="l50.144" class="difflineplus">+static int</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineplus">+sqlite3_T_blob(sqlite3_context *aCtx,</span>
<a href="#l50.146"></a><span id="l50.146" class="difflineplus">+               const void *aData,</span>
<a href="#l50.147"></a><span id="l50.147" class="difflineplus">+               int aSize)</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineplus">+{</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineplus">+  ::sqlite3_result_blob(aCtx, aData, aSize, NS_Free);</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l50.151"></a><span id="l50.151" class="difflineplus">+}</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineplus">+</span>
<a href="#l50.153"></a><span id="l50.153" class="difflineplus">+#include &quot;variantToSQLiteT_impl.h&quot;</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineplus">+</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.156"></a><span id="l50.156" class="difflineplus">+//// Local Functions</span>
<a href="#l50.157"></a><span id="l50.157" class="difflineplus">+</span>
<a href="#l50.158"></a><span id="l50.158" class="difflineplus">+namespace {</span>
<a href="#l50.159"></a><span id="l50.159" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l50.160"></a><span id="l50.160" class="difflineplus">+void tracefunc (void *aClosure, const char *aStmt)</span>
<a href="#l50.161"></a><span id="l50.161" class="difflineplus">+{</span>
<a href="#l50.162"></a><span id="l50.162" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_DEBUG, (&quot;sqlite3_trace on %p for '%s'&quot;, aClosure,</span>
<a href="#l50.163"></a><span id="l50.163" class="difflineplus">+                                     aStmt));</span>
<a href="#l50.164"></a><span id="l50.164" class="difflineplus">+}</span>
<a href="#l50.165"></a><span id="l50.165" class="difflineplus">+#endif</span>
<a href="#l50.166"></a><span id="l50.166" class="difflineplus">+</span>
<a href="#l50.167"></a><span id="l50.167" class="difflineplus">+struct FFEArguments</span>
<a href="#l50.168"></a><span id="l50.168" class="difflineplus">+{</span>
<a href="#l50.169"></a><span id="l50.169" class="difflineplus">+    nsISupports *target;</span>
<a href="#l50.170"></a><span id="l50.170" class="difflineplus">+    bool found;</span>
<a href="#l50.171"></a><span id="l50.171" class="difflineplus">+};</span>
<a href="#l50.172"></a><span id="l50.172" class="difflineplus">+PLDHashOperator</span>
<a href="#l50.173"></a><span id="l50.173" class="difflineplus">+findFunctionEnumerator(const nsACString &amp;aKey,</span>
<a href="#l50.174"></a><span id="l50.174" class="difflineplus">+                       nsISupports *aData,</span>
<a href="#l50.175"></a><span id="l50.175" class="difflineplus">+                       void *aUserArg)</span>
<a href="#l50.176"></a><span id="l50.176" class="difflineplus">+{</span>
<a href="#l50.177"></a><span id="l50.177" class="difflineplus">+  FFEArguments *args = static_cast&lt;FFEArguments *&gt;(aUserArg);</span>
<a href="#l50.178"></a><span id="l50.178" class="difflineplus">+  if (aData == args-&gt;target) {</span>
<a href="#l50.179"></a><span id="l50.179" class="difflineplus">+    args-&gt;found = PR_TRUE;</span>
<a href="#l50.180"></a><span id="l50.180" class="difflineplus">+    return PL_DHASH_STOP;</span>
<a href="#l50.181"></a><span id="l50.181" class="difflineplus">+  }</span>
<a href="#l50.182"></a><span id="l50.182" class="difflineplus">+  return PL_DHASH_NEXT;</span>
<a href="#l50.183"></a><span id="l50.183" class="difflineplus">+}</span>
<a href="#l50.184"></a><span id="l50.184" class="difflineplus">+</span>
<a href="#l50.185"></a><span id="l50.185" class="difflineplus">+void</span>
<a href="#l50.186"></a><span id="l50.186" class="difflineplus">+basicFunctionHelper(sqlite3_context *aCtx,</span>
<a href="#l50.187"></a><span id="l50.187" class="difflineplus">+                    int aArgc,</span>
<a href="#l50.188"></a><span id="l50.188" class="difflineplus">+                    sqlite3_value **aArgv)</span>
<a href="#l50.189"></a><span id="l50.189" class="difflineplus">+{</span>
<a href="#l50.190"></a><span id="l50.190" class="difflineplus">+  void *userData = ::sqlite3_user_data(aCtx);</span>
<a href="#l50.191"></a><span id="l50.191" class="difflineplus">+</span>
<a href="#l50.192"></a><span id="l50.192" class="difflineplus">+  mozIStorageFunction *func = static_cast&lt;mozIStorageFunction *&gt;(userData);</span>
<a href="#l50.193"></a><span id="l50.193" class="difflineplus">+</span>
<a href="#l50.194"></a><span id="l50.194" class="difflineplus">+  nsRefPtr&lt;ArgValueArray&gt; arguments(new ArgValueArray(aArgc, aArgv));</span>
<a href="#l50.195"></a><span id="l50.195" class="difflineplus">+  if (!arguments)</span>
<a href="#l50.196"></a><span id="l50.196" class="difflineplus">+      return;</span>
<a href="#l50.197"></a><span id="l50.197" class="difflineplus">+</span>
<a href="#l50.198"></a><span id="l50.198" class="difflineplus">+  nsCOMPtr&lt;nsIVariant&gt; result;</span>
<a href="#l50.199"></a><span id="l50.199" class="difflineplus">+  if (NS_FAILED(func-&gt;OnFunctionCall(arguments, getter_AddRefs(result)))) {</span>
<a href="#l50.200"></a><span id="l50.200" class="difflineplus">+    NS_WARNING(&quot;User function returned error code!&quot;);</span>
<a href="#l50.201"></a><span id="l50.201" class="difflineplus">+    ::sqlite3_result_error(aCtx,</span>
<a href="#l50.202"></a><span id="l50.202" class="difflineplus">+                           &quot;User function returned error code&quot;,</span>
<a href="#l50.203"></a><span id="l50.203" class="difflineplus">+                           -1);</span>
<a href="#l50.204"></a><span id="l50.204" class="difflineplus">+    return;</span>
<a href="#l50.205"></a><span id="l50.205" class="difflineplus">+  }</span>
<a href="#l50.206"></a><span id="l50.206" class="difflineplus">+  if (variantToSQLiteT(aCtx, result) != SQLITE_OK) {</span>
<a href="#l50.207"></a><span id="l50.207" class="difflineplus">+    NS_WARNING(&quot;User function returned invalid data type!&quot;);</span>
<a href="#l50.208"></a><span id="l50.208" class="difflineplus">+    ::sqlite3_result_error(aCtx,</span>
<a href="#l50.209"></a><span id="l50.209" class="difflineplus">+                           &quot;User function returned invalid data type&quot;,</span>
<a href="#l50.210"></a><span id="l50.210" class="difflineplus">+                           -1);</span>
<a href="#l50.211"></a><span id="l50.211" class="difflineplus">+  }</span>
<a href="#l50.212"></a><span id="l50.212" class="difflineplus">+}</span>
<a href="#l50.213"></a><span id="l50.213" class="difflineplus">+</span>
<a href="#l50.214"></a><span id="l50.214" class="difflineplus">+void</span>
<a href="#l50.215"></a><span id="l50.215" class="difflineplus">+aggregateFunctionStepHelper(sqlite3_context *aCtx,</span>
<a href="#l50.216"></a><span id="l50.216" class="difflineplus">+                            int aArgc,</span>
<a href="#l50.217"></a><span id="l50.217" class="difflineplus">+                            sqlite3_value **aArgv)</span>
<a href="#l50.218"></a><span id="l50.218" class="difflineplus">+{</span>
<a href="#l50.219"></a><span id="l50.219" class="difflineplus">+  void *userData = ::sqlite3_user_data(aCtx);</span>
<a href="#l50.220"></a><span id="l50.220" class="difflineplus">+  mozIStorageAggregateFunction *func =</span>
<a href="#l50.221"></a><span id="l50.221" class="difflineplus">+    static_cast&lt;mozIStorageAggregateFunction *&gt;(userData);</span>
<a href="#l50.222"></a><span id="l50.222" class="difflineplus">+</span>
<a href="#l50.223"></a><span id="l50.223" class="difflineplus">+  nsRefPtr&lt;ArgValueArray&gt; arguments(new ArgValueArray(aArgc, aArgv));</span>
<a href="#l50.224"></a><span id="l50.224" class="difflineplus">+  if (!arguments)</span>
<a href="#l50.225"></a><span id="l50.225" class="difflineplus">+    return;</span>
<a href="#l50.226"></a><span id="l50.226" class="difflineplus">+</span>
<a href="#l50.227"></a><span id="l50.227" class="difflineplus">+  if (NS_FAILED(func-&gt;OnStep(arguments)))</span>
<a href="#l50.228"></a><span id="l50.228" class="difflineplus">+    NS_WARNING(&quot;User aggregate step function returned error code!&quot;);</span>
<a href="#l50.229"></a><span id="l50.229" class="difflineplus">+}</span>
<a href="#l50.230"></a><span id="l50.230" class="difflineplus">+</span>
<a href="#l50.231"></a><span id="l50.231" class="difflineplus">+void</span>
<a href="#l50.232"></a><span id="l50.232" class="difflineplus">+aggregateFunctionFinalHelper(sqlite3_context *aCtx)</span>
<a href="#l50.233"></a><span id="l50.233" class="difflineplus">+{</span>
<a href="#l50.234"></a><span id="l50.234" class="difflineplus">+  void *userData = ::sqlite3_user_data(aCtx);</span>
<a href="#l50.235"></a><span id="l50.235" class="difflineplus">+  mozIStorageAggregateFunction *func =</span>
<a href="#l50.236"></a><span id="l50.236" class="difflineplus">+    static_cast&lt;mozIStorageAggregateFunction *&gt;(userData);</span>
<a href="#l50.237"></a><span id="l50.237" class="difflineplus">+</span>
<a href="#l50.238"></a><span id="l50.238" class="difflineplus">+  nsRefPtr&lt;nsIVariant&gt; result;</span>
<a href="#l50.239"></a><span id="l50.239" class="difflineplus">+  if (NS_FAILED(func-&gt;OnFinal(getter_AddRefs(result)))) {</span>
<a href="#l50.240"></a><span id="l50.240" class="difflineplus">+    NS_WARNING(&quot;User aggregate final function returned error code!&quot;);</span>
<a href="#l50.241"></a><span id="l50.241" class="difflineplus">+    ::sqlite3_result_error(aCtx,</span>
<a href="#l50.242"></a><span id="l50.242" class="difflineplus">+                           &quot;User aggregate final function returned error code&quot;,</span>
<a href="#l50.243"></a><span id="l50.243" class="difflineplus">+                           -1);</span>
<a href="#l50.244"></a><span id="l50.244" class="difflineplus">+    return;</span>
<a href="#l50.245"></a><span id="l50.245" class="difflineplus">+  }</span>
<a href="#l50.246"></a><span id="l50.246" class="difflineplus">+</span>
<a href="#l50.247"></a><span id="l50.247" class="difflineplus">+  if (variantToSQLiteT(aCtx, result) != SQLITE_OK) {</span>
<a href="#l50.248"></a><span id="l50.248" class="difflineplus">+    NS_WARNING(&quot;User aggregate final function returned invalid data type!&quot;);</span>
<a href="#l50.249"></a><span id="l50.249" class="difflineplus">+    ::sqlite3_result_error(aCtx,</span>
<a href="#l50.250"></a><span id="l50.250" class="difflineplus">+                           &quot;User aggregate final function returned invalid data type&quot;,</span>
<a href="#l50.251"></a><span id="l50.251" class="difflineplus">+                           -1);</span>
<a href="#l50.252"></a><span id="l50.252" class="difflineplus">+  }</span>
<a href="#l50.253"></a><span id="l50.253" class="difflineplus">+}</span>
<a href="#l50.254"></a><span id="l50.254" class="difflineplus">+</span>
<a href="#l50.255"></a><span id="l50.255" class="difflineplus">+} // anonymous namespace</span>
<a href="#l50.256"></a><span id="l50.256" class="difflineplus">+</span>
<a href="#l50.257"></a><span id="l50.257" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.258"></a><span id="l50.258" class="difflineplus">+//// Local Classes</span>
<a href="#l50.259"></a><span id="l50.259" class="difflineplus">+</span>
<a href="#l50.260"></a><span id="l50.260" class="difflineplus">+namespace {</span>
<a href="#l50.261"></a><span id="l50.261" class="difflineplus">+</span>
<a href="#l50.262"></a><span id="l50.262" class="difflineplus">+class AsyncCloseConnection : public nsRunnable</span>
<a href="#l50.263"></a><span id="l50.263" class="difflineplus">+{</span>
<a href="#l50.264"></a><span id="l50.264" class="difflineplus">+public:</span>
<a href="#l50.265"></a><span id="l50.265" class="difflineplus">+  AsyncCloseConnection(Connection *aConnection,</span>
<a href="#l50.266"></a><span id="l50.266" class="difflineplus">+                       nsIEventTarget *aCallingThread,</span>
<a href="#l50.267"></a><span id="l50.267" class="difflineplus">+                       nsIRunnable *aCallbackEvent,</span>
<a href="#l50.268"></a><span id="l50.268" class="difflineplus">+                       nsIThread *aAsyncThread)</span>
<a href="#l50.269"></a><span id="l50.269" class="difflineplus">+  : mConnection(aConnection)</span>
<a href="#l50.270"></a><span id="l50.270" class="difflineplus">+  , mCallingThread(aCallingThread)</span>
<a href="#l50.271"></a><span id="l50.271" class="difflineplus">+  , mCallbackEvent(aCallbackEvent)</span>
<a href="#l50.272"></a><span id="l50.272" class="difflineplus">+  , mAsyncThread(aAsyncThread)</span>
<a href="#l50.273"></a><span id="l50.273" class="difflineplus">+  {</span>
<a href="#l50.274"></a><span id="l50.274" class="difflineplus">+  }</span>
<a href="#l50.275"></a><span id="l50.275" class="difflineplus">+</span>
<a href="#l50.276"></a><span id="l50.276" class="difflineplus">+  NS_METHOD Run()</span>
<a href="#l50.277"></a><span id="l50.277" class="difflineplus">+  {</span>
<a href="#l50.278"></a><span id="l50.278" class="difflineplus">+    // This event is first dispatched to the background thread to ensure that</span>
<a href="#l50.279"></a><span id="l50.279" class="difflineplus">+    // all pending asynchronous events are completed, and then back to the</span>
<a href="#l50.280"></a><span id="l50.280" class="difflineplus">+    // calling thread to actually close and notify.</span>
<a href="#l50.281"></a><span id="l50.281" class="difflineplus">+    PRBool onCallingThread = PR_FALSE;</span>
<a href="#l50.282"></a><span id="l50.282" class="difflineplus">+    (void)mCallingThread-&gt;IsOnCurrentThread(&amp;onCallingThread);</span>
<a href="#l50.283"></a><span id="l50.283" class="difflineplus">+    if (!onCallingThread) {</span>
<a href="#l50.284"></a><span id="l50.284" class="difflineplus">+      (void)mCallingThread-&gt;Dispatch(this, NS_DISPATCH_NORMAL);</span>
<a href="#l50.285"></a><span id="l50.285" class="difflineplus">+      return NS_OK;</span>
<a href="#l50.286"></a><span id="l50.286" class="difflineplus">+    }</span>
<a href="#l50.287"></a><span id="l50.287" class="difflineplus">+</span>
<a href="#l50.288"></a><span id="l50.288" class="difflineplus">+    if (mConnection)</span>
<a href="#l50.289"></a><span id="l50.289" class="difflineplus">+      (void)mConnection-&gt;internalClose();</span>
<a href="#l50.290"></a><span id="l50.290" class="difflineplus">+    if (mCallbackEvent)</span>
<a href="#l50.291"></a><span id="l50.291" class="difflineplus">+      (void)mCallingThread-&gt;Dispatch(mCallbackEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l50.292"></a><span id="l50.292" class="difflineplus">+    mAsyncThread-&gt;Shutdown();</span>
<a href="#l50.293"></a><span id="l50.293" class="difflineplus">+</span>
<a href="#l50.294"></a><span id="l50.294" class="difflineplus">+    return NS_OK;</span>
<a href="#l50.295"></a><span id="l50.295" class="difflineplus">+  }</span>
<a href="#l50.296"></a><span id="l50.296" class="difflineplus">+private:</span>
<a href="#l50.297"></a><span id="l50.297" class="difflineplus">+  nsCOMPtr&lt;Connection&gt; mConnection;</span>
<a href="#l50.298"></a><span id="l50.298" class="difflineplus">+  nsCOMPtr&lt;nsIEventTarget&gt; mCallingThread;</span>
<a href="#l50.299"></a><span id="l50.299" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; mCallbackEvent;</span>
<a href="#l50.300"></a><span id="l50.300" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; mAsyncThread;</span>
<a href="#l50.301"></a><span id="l50.301" class="difflineplus">+};</span>
<a href="#l50.302"></a><span id="l50.302" class="difflineplus">+</span>
<a href="#l50.303"></a><span id="l50.303" class="difflineplus">+} // anonymous namespace</span>
<a href="#l50.304"></a><span id="l50.304" class="difflineplus">+</span>
<a href="#l50.305"></a><span id="l50.305" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.306"></a><span id="l50.306" class="difflineplus">+//// Connection</span>
<a href="#l50.307"></a><span id="l50.307" class="difflineplus">+</span>
<a href="#l50.308"></a><span id="l50.308" class="difflineplus">+Connection::Connection(Service *aService)</span>
<a href="#l50.309"></a><span id="l50.309" class="difflineplus">+: sharedAsyncExecutionMutex(&quot;Connection::sharedAsyncExecutionMutex&quot;)</span>
<a href="#l50.310"></a><span id="l50.310" class="difflineplus">+, sharedDBMutex(&quot;Connection::sharedDBMutex&quot;)</span>
<a href="#l50.311"></a><span id="l50.311" class="difflineplus">+, threadOpenedOn(do_GetCurrentThread())</span>
<a href="#l50.312"></a><span id="l50.312" class="difflineplus">+, mDBConn(nsnull)</span>
<a href="#l50.313"></a><span id="l50.313" class="difflineplus">+, mAsyncExecutionThreadShuttingDown(false)</span>
<a href="#l50.314"></a><span id="l50.314" class="difflineplus">+, mTransactionInProgress(PR_FALSE)</span>
<a href="#l50.315"></a><span id="l50.315" class="difflineplus">+, mProgressHandler(nsnull)</span>
<a href="#l50.316"></a><span id="l50.316" class="difflineplus">+, mStorageService(aService)</span>
<a href="#l50.317"></a><span id="l50.317" class="difflineplus">+{</span>
<a href="#l50.318"></a><span id="l50.318" class="difflineplus">+  mFunctions.Init();</span>
<a href="#l50.319"></a><span id="l50.319" class="difflineplus">+}</span>
<a href="#l50.320"></a><span id="l50.320" class="difflineplus">+</span>
<a href="#l50.321"></a><span id="l50.321" class="difflineplus">+Connection::~Connection()</span>
<a href="#l50.322"></a><span id="l50.322" class="difflineplus">+{</span>
<a href="#l50.323"></a><span id="l50.323" class="difflineplus">+  (void)Close();</span>
<a href="#l50.324"></a><span id="l50.324" class="difflineplus">+</span>
<a href="#l50.325"></a><span id="l50.325" class="difflineplus">+  // If we know about an async execution thread then we need to take steps to</span>
<a href="#l50.326"></a><span id="l50.326" class="difflineplus">+  // trigger its shutdown.  (AsyncClose is the only other code to trigger</span>
<a href="#l50.327"></a><span id="l50.327" class="difflineplus">+  // something like this and it nulls out our reference so there is no risk of</span>
<a href="#l50.328"></a><span id="l50.328" class="difflineplus">+  // double triggering.)</span>
<a href="#l50.329"></a><span id="l50.329" class="difflineplus">+  if (mAsyncExecutionThread) {</span>
<a href="#l50.330"></a><span id="l50.330" class="difflineplus">+    // Note: Obviously, we can't tell it about us since we are dying.  We also</span>
<a href="#l50.331"></a><span id="l50.331" class="difflineplus">+    // skimp on using a mutex since there's no point.</span>
<a href="#l50.332"></a><span id="l50.332" class="difflineplus">+    nsCOMPtr&lt;nsIRunnable&gt; closeEvent =</span>
<a href="#l50.333"></a><span id="l50.333" class="difflineplus">+      new AsyncCloseConnection(nsnull, NS_GetCurrentThread(), nsnull,</span>
<a href="#l50.334"></a><span id="l50.334" class="difflineplus">+                               mAsyncExecutionThread);</span>
<a href="#l50.335"></a><span id="l50.335" class="difflineplus">+    if (!closeEvent)</span>
<a href="#l50.336"></a><span id="l50.336" class="difflineplus">+      return;</span>
<a href="#l50.337"></a><span id="l50.337" class="difflineplus">+</span>
<a href="#l50.338"></a><span id="l50.338" class="difflineplus">+    (void)mAsyncExecutionThread-&gt;Dispatch(closeEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l50.339"></a><span id="l50.339" class="difflineplus">+  }</span>
<a href="#l50.340"></a><span id="l50.340" class="difflineplus">+}</span>
<a href="#l50.341"></a><span id="l50.341" class="difflineplus">+</span>
<a href="#l50.342"></a><span id="l50.342" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(</span>
<a href="#l50.343"></a><span id="l50.343" class="difflineplus">+  Connection,</span>
<a href="#l50.344"></a><span id="l50.344" class="difflineplus">+  mozIStorageConnection</span>
<a href="#l50.345"></a><span id="l50.345" class="difflineplus">+)</span>
<a href="#l50.346"></a><span id="l50.346" class="difflineplus">+</span>
<a href="#l50.347"></a><span id="l50.347" class="difflineplus">+nsIEventTarget *</span>
<a href="#l50.348"></a><span id="l50.348" class="difflineplus">+Connection::getAsyncExecutionTarget()</span>
<a href="#l50.349"></a><span id="l50.349" class="difflineplus">+{</span>
<a href="#l50.350"></a><span id="l50.350" class="difflineplus">+  MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l50.351"></a><span id="l50.351" class="difflineplus">+</span>
<a href="#l50.352"></a><span id="l50.352" class="difflineplus">+  // If we are shutting down the asynchronous thread, don't hand out any more</span>
<a href="#l50.353"></a><span id="l50.353" class="difflineplus">+  // references to the thread.</span>
<a href="#l50.354"></a><span id="l50.354" class="difflineplus">+  if (mAsyncExecutionThreadShuttingDown)</span>
<a href="#l50.355"></a><span id="l50.355" class="difflineplus">+    return nsnull;</span>
<a href="#l50.356"></a><span id="l50.356" class="difflineplus">+</span>
<a href="#l50.357"></a><span id="l50.357" class="difflineplus">+  if (!mAsyncExecutionThread) {</span>
<a href="#l50.358"></a><span id="l50.358" class="difflineplus">+    nsresult rv = ::NS_NewThread(getter_AddRefs(mAsyncExecutionThread));</span>
<a href="#l50.359"></a><span id="l50.359" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l50.360"></a><span id="l50.360" class="difflineplus">+      NS_WARNING(&quot;Failed to create async thread.&quot;);</span>
<a href="#l50.361"></a><span id="l50.361" class="difflineplus">+      return nsnull;</span>
<a href="#l50.362"></a><span id="l50.362" class="difflineplus">+    }</span>
<a href="#l50.363"></a><span id="l50.363" class="difflineplus">+  }</span>
<a href="#l50.364"></a><span id="l50.364" class="difflineplus">+</span>
<a href="#l50.365"></a><span id="l50.365" class="difflineplus">+  return mAsyncExecutionThread;</span>
<a href="#l50.366"></a><span id="l50.366" class="difflineplus">+}</span>
<a href="#l50.367"></a><span id="l50.367" class="difflineplus">+</span>
<a href="#l50.368"></a><span id="l50.368" class="difflineplus">+nsresult</span>
<a href="#l50.369"></a><span id="l50.369" class="difflineplus">+Connection::initialize(nsIFile *aDatabaseFile)</span>
<a href="#l50.370"></a><span id="l50.370" class="difflineplus">+{</span>
<a href="#l50.371"></a><span id="l50.371" class="difflineplus">+  NS_ASSERTION (!mDBConn, &quot;Initialize called on already opened database!&quot;);</span>
<a href="#l50.372"></a><span id="l50.372" class="difflineplus">+</span>
<a href="#l50.373"></a><span id="l50.373" class="difflineplus">+  int srv;</span>
<a href="#l50.374"></a><span id="l50.374" class="difflineplus">+  nsresult rv;</span>
<a href="#l50.375"></a><span id="l50.375" class="difflineplus">+</span>
<a href="#l50.376"></a><span id="l50.376" class="difflineplus">+  mDatabaseFile = aDatabaseFile;</span>
<a href="#l50.377"></a><span id="l50.377" class="difflineplus">+</span>
<a href="#l50.378"></a><span id="l50.378" class="difflineplus">+  if (aDatabaseFile) {</span>
<a href="#l50.379"></a><span id="l50.379" class="difflineplus">+    nsAutoString path;</span>
<a href="#l50.380"></a><span id="l50.380" class="difflineplus">+    rv = aDatabaseFile-&gt;GetPath(path);</span>
<a href="#l50.381"></a><span id="l50.381" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.382"></a><span id="l50.382" class="difflineplus">+</span>
<a href="#l50.383"></a><span id="l50.383" class="difflineplus">+    srv = ::sqlite3_open(NS_ConvertUTF16toUTF8(path).get(), &amp;mDBConn);</span>
<a href="#l50.384"></a><span id="l50.384" class="difflineplus">+  }</span>
<a href="#l50.385"></a><span id="l50.385" class="difflineplus">+  else {</span>
<a href="#l50.386"></a><span id="l50.386" class="difflineplus">+    // in memory database requested, sqlite uses a magic file name</span>
<a href="#l50.387"></a><span id="l50.387" class="difflineplus">+    srv = ::sqlite3_open(&quot;:memory:&quot;, &amp;mDBConn);</span>
<a href="#l50.388"></a><span id="l50.388" class="difflineplus">+  }</span>
<a href="#l50.389"></a><span id="l50.389" class="difflineplus">+  if (srv != SQLITE_OK) {</span>
<a href="#l50.390"></a><span id="l50.390" class="difflineplus">+    mDBConn = nsnull;</span>
<a href="#l50.391"></a><span id="l50.391" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.392"></a><span id="l50.392" class="difflineplus">+  }</span>
<a href="#l50.393"></a><span id="l50.393" class="difflineplus">+</span>
<a href="#l50.394"></a><span id="l50.394" class="difflineplus">+  // Properly wrap the database handle's mutex.</span>
<a href="#l50.395"></a><span id="l50.395" class="difflineplus">+  sharedDBMutex.initWithMutex(sqlite3_db_mutex(mDBConn));</span>
<a href="#l50.396"></a><span id="l50.396" class="difflineplus">+</span>
<a href="#l50.397"></a><span id="l50.397" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l50.398"></a><span id="l50.398" class="difflineplus">+  if (!gStorageLog)</span>
<a href="#l50.399"></a><span id="l50.399" class="difflineplus">+    gStorageLog = ::PR_NewLogModule(&quot;mozStorage&quot;);</span>
<a href="#l50.400"></a><span id="l50.400" class="difflineplus">+</span>
<a href="#l50.401"></a><span id="l50.401" class="difflineplus">+  ::sqlite3_trace(mDBConn, tracefunc, this);</span>
<a href="#l50.402"></a><span id="l50.402" class="difflineplus">+</span>
<a href="#l50.403"></a><span id="l50.403" class="difflineplus">+  nsCAutoString leafName(&quot;:memory&quot;);</span>
<a href="#l50.404"></a><span id="l50.404" class="difflineplus">+  if (aDatabaseFile)</span>
<a href="#l50.405"></a><span id="l50.405" class="difflineplus">+    (void)aDatabaseFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l50.406"></a><span id="l50.406" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Opening connection to '%s' (%p)&quot;,</span>
<a href="#l50.407"></a><span id="l50.407" class="difflineplus">+                                      leafName.get(), this));</span>
<a href="#l50.408"></a><span id="l50.408" class="difflineplus">+#endif</span>
<a href="#l50.409"></a><span id="l50.409" class="difflineplus">+</span>
<a href="#l50.410"></a><span id="l50.410" class="difflineplus">+  // Register our built-in SQL functions.</span>
<a href="#l50.411"></a><span id="l50.411" class="difflineplus">+  srv = registerFunctions(mDBConn);</span>
<a href="#l50.412"></a><span id="l50.412" class="difflineplus">+  if (srv != SQLITE_OK) {</span>
<a href="#l50.413"></a><span id="l50.413" class="difflineplus">+    ::sqlite3_close(mDBConn);</span>
<a href="#l50.414"></a><span id="l50.414" class="difflineplus">+    mDBConn = nsnull;</span>
<a href="#l50.415"></a><span id="l50.415" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.416"></a><span id="l50.416" class="difflineplus">+  }</span>
<a href="#l50.417"></a><span id="l50.417" class="difflineplus">+</span>
<a href="#l50.418"></a><span id="l50.418" class="difflineplus">+  // Register our built-in SQL collating sequences.</span>
<a href="#l50.419"></a><span id="l50.419" class="difflineplus">+  srv = registerCollations(mDBConn, mStorageService);</span>
<a href="#l50.420"></a><span id="l50.420" class="difflineplus">+  if (srv != SQLITE_OK) {</span>
<a href="#l50.421"></a><span id="l50.421" class="difflineplus">+    ::sqlite3_close(mDBConn);</span>
<a href="#l50.422"></a><span id="l50.422" class="difflineplus">+    mDBConn = nsnull;</span>
<a href="#l50.423"></a><span id="l50.423" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.424"></a><span id="l50.424" class="difflineplus">+  }</span>
<a href="#l50.425"></a><span id="l50.425" class="difflineplus">+</span>
<a href="#l50.426"></a><span id="l50.426" class="difflineplus">+  // Execute a dummy statement to force the db open, and to verify if it is</span>
<a href="#l50.427"></a><span id="l50.427" class="difflineplus">+  // valid or not.</span>
<a href="#l50.428"></a><span id="l50.428" class="difflineplus">+  sqlite3_stmt *stmt;</span>
<a href="#l50.429"></a><span id="l50.429" class="difflineplus">+  srv = ::sqlite3_prepare_v2(mDBConn, &quot;SELECT * FROM sqlite_master&quot;, -1, &amp;stmt,</span>
<a href="#l50.430"></a><span id="l50.430" class="difflineplus">+                             NULL);</span>
<a href="#l50.431"></a><span id="l50.431" class="difflineplus">+  if (srv == SQLITE_OK) {</span>
<a href="#l50.432"></a><span id="l50.432" class="difflineplus">+    srv = ::sqlite3_step(stmt);</span>
<a href="#l50.433"></a><span id="l50.433" class="difflineplus">+</span>
<a href="#l50.434"></a><span id="l50.434" class="difflineplus">+    if (srv == SQLITE_DONE || srv == SQLITE_ROW)</span>
<a href="#l50.435"></a><span id="l50.435" class="difflineplus">+        srv = SQLITE_OK;</span>
<a href="#l50.436"></a><span id="l50.436" class="difflineplus">+    ::sqlite3_finalize(stmt);</span>
<a href="#l50.437"></a><span id="l50.437" class="difflineplus">+  }</span>
<a href="#l50.438"></a><span id="l50.438" class="difflineplus">+</span>
<a href="#l50.439"></a><span id="l50.439" class="difflineplus">+  if (srv != SQLITE_OK) {</span>
<a href="#l50.440"></a><span id="l50.440" class="difflineplus">+    ::sqlite3_close(mDBConn);</span>
<a href="#l50.441"></a><span id="l50.441" class="difflineplus">+    mDBConn = nsnull;</span>
<a href="#l50.442"></a><span id="l50.442" class="difflineplus">+</span>
<a href="#l50.443"></a><span id="l50.443" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.444"></a><span id="l50.444" class="difflineplus">+  }</span>
<a href="#l50.445"></a><span id="l50.445" class="difflineplus">+</span>
<a href="#l50.446"></a><span id="l50.446" class="difflineplus">+  // Set the synchronous PRAGMA, according to the pref</span>
<a href="#l50.447"></a><span id="l50.447" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l50.448"></a><span id="l50.448" class="difflineplus">+  PRInt32 synchronous = 1; // Default to NORMAL if pref not set</span>
<a href="#l50.449"></a><span id="l50.449" class="difflineplus">+  if (pref)</span>
<a href="#l50.450"></a><span id="l50.450" class="difflineplus">+    (void)pref-&gt;GetIntPref(PREF_TS_SYNCHRONOUS, &amp;synchronous);</span>
<a href="#l50.451"></a><span id="l50.451" class="difflineplus">+</span>
<a href="#l50.452"></a><span id="l50.452" class="difflineplus">+  switch (synchronous) {</span>
<a href="#l50.453"></a><span id="l50.453" class="difflineplus">+    case 2:</span>
<a href="#l50.454"></a><span id="l50.454" class="difflineplus">+      (void)ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l50.455"></a><span id="l50.455" class="difflineplus">+          &quot;PRAGMA synchronous = FULL;&quot;));</span>
<a href="#l50.456"></a><span id="l50.456" class="difflineplus">+      break;</span>
<a href="#l50.457"></a><span id="l50.457" class="difflineplus">+    case 0:</span>
<a href="#l50.458"></a><span id="l50.458" class="difflineplus">+      (void)ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l50.459"></a><span id="l50.459" class="difflineplus">+          &quot;PRAGMA synchronous = OFF;&quot;));</span>
<a href="#l50.460"></a><span id="l50.460" class="difflineplus">+      break;</span>
<a href="#l50.461"></a><span id="l50.461" class="difflineplus">+    case 1:</span>
<a href="#l50.462"></a><span id="l50.462" class="difflineplus">+    default:</span>
<a href="#l50.463"></a><span id="l50.463" class="difflineplus">+      (void)ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l50.464"></a><span id="l50.464" class="difflineplus">+          &quot;PRAGMA synchronous = NORMAL;&quot;));</span>
<a href="#l50.465"></a><span id="l50.465" class="difflineplus">+      break;</span>
<a href="#l50.466"></a><span id="l50.466" class="difflineplus">+  }</span>
<a href="#l50.467"></a><span id="l50.467" class="difflineplus">+</span>
<a href="#l50.468"></a><span id="l50.468" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.469"></a><span id="l50.469" class="difflineplus">+}</span>
<a href="#l50.470"></a><span id="l50.470" class="difflineplus">+</span>
<a href="#l50.471"></a><span id="l50.471" class="difflineplus">+nsresult</span>
<a href="#l50.472"></a><span id="l50.472" class="difflineplus">+Connection::databaseElementExists(enum DatabaseElementType aElementType,</span>
<a href="#l50.473"></a><span id="l50.473" class="difflineplus">+                                  const nsACString &amp;aElementName,</span>
<a href="#l50.474"></a><span id="l50.474" class="difflineplus">+                                  PRBool *_exists)</span>
<a href="#l50.475"></a><span id="l50.475" class="difflineplus">+{</span>
<a href="#l50.476"></a><span id="l50.476" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.477"></a><span id="l50.477" class="difflineplus">+</span>
<a href="#l50.478"></a><span id="l50.478" class="difflineplus">+  nsCAutoString query(&quot;SELECT name FROM sqlite_master WHERE type = '&quot;);</span>
<a href="#l50.479"></a><span id="l50.479" class="difflineplus">+  switch (aElementType) {</span>
<a href="#l50.480"></a><span id="l50.480" class="difflineplus">+    case INDEX:</span>
<a href="#l50.481"></a><span id="l50.481" class="difflineplus">+      query.Append(&quot;index&quot;);</span>
<a href="#l50.482"></a><span id="l50.482" class="difflineplus">+      break;</span>
<a href="#l50.483"></a><span id="l50.483" class="difflineplus">+    case TABLE:</span>
<a href="#l50.484"></a><span id="l50.484" class="difflineplus">+      query.Append(&quot;table&quot;);</span>
<a href="#l50.485"></a><span id="l50.485" class="difflineplus">+      break;</span>
<a href="#l50.486"></a><span id="l50.486" class="difflineplus">+  }</span>
<a href="#l50.487"></a><span id="l50.487" class="difflineplus">+  query.Append(&quot;' AND name ='&quot;);</span>
<a href="#l50.488"></a><span id="l50.488" class="difflineplus">+  query.Append(aElementName);</span>
<a href="#l50.489"></a><span id="l50.489" class="difflineplus">+  query.Append(&quot;'&quot;);</span>
<a href="#l50.490"></a><span id="l50.490" class="difflineplus">+</span>
<a href="#l50.491"></a><span id="l50.491" class="difflineplus">+  sqlite3_stmt *stmt;</span>
<a href="#l50.492"></a><span id="l50.492" class="difflineplus">+  int srv = ::sqlite3_prepare_v2(mDBConn, query.get(), -1, &amp;stmt, NULL);</span>
<a href="#l50.493"></a><span id="l50.493" class="difflineplus">+  if (srv != SQLITE_OK)</span>
<a href="#l50.494"></a><span id="l50.494" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.495"></a><span id="l50.495" class="difflineplus">+</span>
<a href="#l50.496"></a><span id="l50.496" class="difflineplus">+  srv = ::sqlite3_step(stmt);</span>
<a href="#l50.497"></a><span id="l50.497" class="difflineplus">+  // we just care about the return value from step</span>
<a href="#l50.498"></a><span id="l50.498" class="difflineplus">+  (void)::sqlite3_finalize(stmt);</span>
<a href="#l50.499"></a><span id="l50.499" class="difflineplus">+</span>
<a href="#l50.500"></a><span id="l50.500" class="difflineplus">+  if (srv == SQLITE_ROW) {</span>
<a href="#l50.501"></a><span id="l50.501" class="difflineplus">+    *_exists = PR_TRUE;</span>
<a href="#l50.502"></a><span id="l50.502" class="difflineplus">+    return NS_OK;</span>
<a href="#l50.503"></a><span id="l50.503" class="difflineplus">+  }</span>
<a href="#l50.504"></a><span id="l50.504" class="difflineplus">+  if (srv == SQLITE_DONE) {</span>
<a href="#l50.505"></a><span id="l50.505" class="difflineplus">+    *_exists = PR_FALSE;</span>
<a href="#l50.506"></a><span id="l50.506" class="difflineplus">+    return NS_OK;</span>
<a href="#l50.507"></a><span id="l50.507" class="difflineplus">+  }</span>
<a href="#l50.508"></a><span id="l50.508" class="difflineplus">+</span>
<a href="#l50.509"></a><span id="l50.509" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l50.510"></a><span id="l50.510" class="difflineplus">+}</span>
<a href="#l50.511"></a><span id="l50.511" class="difflineplus">+</span>
<a href="#l50.512"></a><span id="l50.512" class="difflineplus">+bool</span>
<a href="#l50.513"></a><span id="l50.513" class="difflineplus">+Connection::findFunctionByInstance(nsISupports *aInstance)</span>
<a href="#l50.514"></a><span id="l50.514" class="difflineplus">+{</span>
<a href="#l50.515"></a><span id="l50.515" class="difflineplus">+  sharedDBMutex.assertCurrentThreadOwns();</span>
<a href="#l50.516"></a><span id="l50.516" class="difflineplus">+  FFEArguments args = { aInstance, false };</span>
<a href="#l50.517"></a><span id="l50.517" class="difflineplus">+  mFunctions.EnumerateRead(findFunctionEnumerator, &amp;args);</span>
<a href="#l50.518"></a><span id="l50.518" class="difflineplus">+  return args.found;</span>
<a href="#l50.519"></a><span id="l50.519" class="difflineplus">+}</span>
<a href="#l50.520"></a><span id="l50.520" class="difflineplus">+</span>
<a href="#l50.521"></a><span id="l50.521" class="difflineplus">+/* static */ int</span>
<a href="#l50.522"></a><span id="l50.522" class="difflineplus">+Connection::sProgressHelper(void *aArg)</span>
<a href="#l50.523"></a><span id="l50.523" class="difflineplus">+{</span>
<a href="#l50.524"></a><span id="l50.524" class="difflineplus">+  Connection *_this = static_cast&lt;Connection *&gt;(aArg);</span>
<a href="#l50.525"></a><span id="l50.525" class="difflineplus">+  return _this-&gt;progressHandler();</span>
<a href="#l50.526"></a><span id="l50.526" class="difflineplus">+}</span>
<a href="#l50.527"></a><span id="l50.527" class="difflineplus">+</span>
<a href="#l50.528"></a><span id="l50.528" class="difflineplus">+int</span>
<a href="#l50.529"></a><span id="l50.529" class="difflineplus">+Connection::progressHandler()</span>
<a href="#l50.530"></a><span id="l50.530" class="difflineplus">+{</span>
<a href="#l50.531"></a><span id="l50.531" class="difflineplus">+  sharedDBMutex.assertCurrentThreadOwns();</span>
<a href="#l50.532"></a><span id="l50.532" class="difflineplus">+  if (mProgressHandler) {</span>
<a href="#l50.533"></a><span id="l50.533" class="difflineplus">+    PRBool result;</span>
<a href="#l50.534"></a><span id="l50.534" class="difflineplus">+    nsresult rv = mProgressHandler-&gt;OnProgress(this, &amp;result);</span>
<a href="#l50.535"></a><span id="l50.535" class="difflineplus">+    if (NS_FAILED(rv)) return 0; // Don't break request</span>
<a href="#l50.536"></a><span id="l50.536" class="difflineplus">+    return result ? 1 : 0;</span>
<a href="#l50.537"></a><span id="l50.537" class="difflineplus">+  }</span>
<a href="#l50.538"></a><span id="l50.538" class="difflineplus">+  return 0;</span>
<a href="#l50.539"></a><span id="l50.539" class="difflineplus">+}</span>
<a href="#l50.540"></a><span id="l50.540" class="difflineplus">+</span>
<a href="#l50.541"></a><span id="l50.541" class="difflineplus">+nsresult</span>
<a href="#l50.542"></a><span id="l50.542" class="difflineplus">+Connection::setClosedState()</span>
<a href="#l50.543"></a><span id="l50.543" class="difflineplus">+{</span>
<a href="#l50.544"></a><span id="l50.544" class="difflineplus">+  // Ensure that we are on the correct thread to close the database.</span>
<a href="#l50.545"></a><span id="l50.545" class="difflineplus">+  PRBool onOpenedThread;</span>
<a href="#l50.546"></a><span id="l50.546" class="difflineplus">+  nsresult rv = threadOpenedOn-&gt;IsOnCurrentThread(&amp;onOpenedThread);</span>
<a href="#l50.547"></a><span id="l50.547" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.548"></a><span id="l50.548" class="difflineplus">+  if (!onOpenedThread) {</span>
<a href="#l50.549"></a><span id="l50.549" class="difflineplus">+    NS_ERROR(&quot;Must close the database on the thread that you opened it with!&quot;);</span>
<a href="#l50.550"></a><span id="l50.550" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l50.551"></a><span id="l50.551" class="difflineplus">+  }</span>
<a href="#l50.552"></a><span id="l50.552" class="difflineplus">+</span>
<a href="#l50.553"></a><span id="l50.553" class="difflineplus">+  // Flag that we are shutting down the async thread, so that</span>
<a href="#l50.554"></a><span id="l50.554" class="difflineplus">+  // getAsyncExecutionTarget knows not to expose/create the async thread.</span>
<a href="#l50.555"></a><span id="l50.555" class="difflineplus">+  {</span>
<a href="#l50.556"></a><span id="l50.556" class="difflineplus">+    MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l50.557"></a><span id="l50.557" class="difflineplus">+    NS_ENSURE_FALSE(mAsyncExecutionThreadShuttingDown, NS_ERROR_UNEXPECTED);</span>
<a href="#l50.558"></a><span id="l50.558" class="difflineplus">+    mAsyncExecutionThreadShuttingDown = true;</span>
<a href="#l50.559"></a><span id="l50.559" class="difflineplus">+  }</span>
<a href="#l50.560"></a><span id="l50.560" class="difflineplus">+</span>
<a href="#l50.561"></a><span id="l50.561" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.562"></a><span id="l50.562" class="difflineplus">+}</span>
<a href="#l50.563"></a><span id="l50.563" class="difflineplus">+</span>
<a href="#l50.564"></a><span id="l50.564" class="difflineplus">+nsresult</span>
<a href="#l50.565"></a><span id="l50.565" class="difflineplus">+Connection::internalClose()</span>
<a href="#l50.566"></a><span id="l50.566" class="difflineplus">+{</span>
<a href="#l50.567"></a><span id="l50.567" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l50.568"></a><span id="l50.568" class="difflineplus">+  // Sanity checks to make sure we are in the proper state before calling this.</span>
<a href="#l50.569"></a><span id="l50.569" class="difflineplus">+  NS_ASSERTION(mDBConn, &quot;Database connection is already null!&quot;);</span>
<a href="#l50.570"></a><span id="l50.570" class="difflineplus">+</span>
<a href="#l50.571"></a><span id="l50.571" class="difflineplus">+  { // Make sure we have marked our async thread as shutting down.</span>
<a href="#l50.572"></a><span id="l50.572" class="difflineplus">+    MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l50.573"></a><span id="l50.573" class="difflineplus">+    NS_ASSERTION(mAsyncExecutionThreadShuttingDown,</span>
<a href="#l50.574"></a><span id="l50.574" class="difflineplus">+                 &quot;Did not call setClosedState!&quot;);</span>
<a href="#l50.575"></a><span id="l50.575" class="difflineplus">+  }</span>
<a href="#l50.576"></a><span id="l50.576" class="difflineplus">+</span>
<a href="#l50.577"></a><span id="l50.577" class="difflineplus">+  { // Ensure that we are being called on the thread we were opened with.</span>
<a href="#l50.578"></a><span id="l50.578" class="difflineplus">+    PRBool onOpenedThread = PR_FALSE;</span>
<a href="#l50.579"></a><span id="l50.579" class="difflineplus">+    (void)threadOpenedOn-&gt;IsOnCurrentThread(&amp;onOpenedThread);</span>
<a href="#l50.580"></a><span id="l50.580" class="difflineplus">+    NS_ASSERTION(onOpenedThread,</span>
<a href="#l50.581"></a><span id="l50.581" class="difflineplus">+                 &quot;Not called on the thread the database was opened on!&quot;);</span>
<a href="#l50.582"></a><span id="l50.582" class="difflineplus">+  }</span>
<a href="#l50.583"></a><span id="l50.583" class="difflineplus">+#endif</span>
<a href="#l50.584"></a><span id="l50.584" class="difflineplus">+</span>
<a href="#l50.585"></a><span id="l50.585" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l50.586"></a><span id="l50.586" class="difflineplus">+  nsCAutoString leafName(&quot;:memory&quot;);</span>
<a href="#l50.587"></a><span id="l50.587" class="difflineplus">+  if (mDatabaseFile)</span>
<a href="#l50.588"></a><span id="l50.588" class="difflineplus">+      (void)mDatabaseFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l50.589"></a><span id="l50.589" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Closing connection to '%s'&quot;,</span>
<a href="#l50.590"></a><span id="l50.590" class="difflineplus">+                                      leafName.get()));</span>
<a href="#l50.591"></a><span id="l50.591" class="difflineplus">+#endif</span>
<a href="#l50.592"></a><span id="l50.592" class="difflineplus">+</span>
<a href="#l50.593"></a><span id="l50.593" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l50.594"></a><span id="l50.594" class="difflineplus">+  // Notify about any non-finalized statements.</span>
<a href="#l50.595"></a><span id="l50.595" class="difflineplus">+  sqlite3_stmt *stmt = NULL;</span>
<a href="#l50.596"></a><span id="l50.596" class="difflineplus">+  while ((stmt = ::sqlite3_next_stmt(mDBConn, stmt))) {</span>
<a href="#l50.597"></a><span id="l50.597" class="difflineplus">+    char *msg = ::PR_smprintf(&quot;SQL statement '%s' was not finalized&quot;,</span>
<a href="#l50.598"></a><span id="l50.598" class="difflineplus">+                              ::sqlite3_sql(stmt));</span>
<a href="#l50.599"></a><span id="l50.599" class="difflineplus">+    NS_WARNING(msg);</span>
<a href="#l50.600"></a><span id="l50.600" class="difflineplus">+    ::PR_smprintf_free(msg);</span>
<a href="#l50.601"></a><span id="l50.601" class="difflineplus">+  }</span>
<a href="#l50.602"></a><span id="l50.602" class="difflineplus">+#endif</span>
<a href="#l50.603"></a><span id="l50.603" class="difflineplus">+</span>
<a href="#l50.604"></a><span id="l50.604" class="difflineplus">+  int srv = ::sqlite3_close(mDBConn);</span>
<a href="#l50.605"></a><span id="l50.605" class="difflineplus">+  NS_ASSERTION(srv == SQLITE_OK,</span>
<a href="#l50.606"></a><span id="l50.606" class="difflineplus">+               &quot;sqlite3_close failed. There are probably outstanding statements that are listed above!&quot;);</span>
<a href="#l50.607"></a><span id="l50.607" class="difflineplus">+</span>
<a href="#l50.608"></a><span id="l50.608" class="difflineplus">+  mDBConn = NULL;</span>
<a href="#l50.609"></a><span id="l50.609" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l50.610"></a><span id="l50.610" class="difflineplus">+}</span>
<a href="#l50.611"></a><span id="l50.611" class="difflineplus">+</span>
<a href="#l50.612"></a><span id="l50.612" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.613"></a><span id="l50.613" class="difflineplus">+//// mozIStorageConnection</span>
<a href="#l50.614"></a><span id="l50.614" class="difflineplus">+</span>
<a href="#l50.615"></a><span id="l50.615" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.616"></a><span id="l50.616" class="difflineplus">+Connection::Close()</span>
<a href="#l50.617"></a><span id="l50.617" class="difflineplus">+{</span>
<a href="#l50.618"></a><span id="l50.618" class="difflineplus">+  if (!mDBConn)</span>
<a href="#l50.619"></a><span id="l50.619" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.620"></a><span id="l50.620" class="difflineplus">+</span>
<a href="#l50.621"></a><span id="l50.621" class="difflineplus">+  { // Make sure we have not executed any asynchronous statements.</span>
<a href="#l50.622"></a><span id="l50.622" class="difflineplus">+    MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l50.623"></a><span id="l50.623" class="difflineplus">+    NS_ENSURE_FALSE(mAsyncExecutionThread, NS_ERROR_UNEXPECTED);</span>
<a href="#l50.624"></a><span id="l50.624" class="difflineplus">+  }</span>
<a href="#l50.625"></a><span id="l50.625" class="difflineplus">+</span>
<a href="#l50.626"></a><span id="l50.626" class="difflineplus">+  nsresult rv = setClosedState();</span>
<a href="#l50.627"></a><span id="l50.627" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.628"></a><span id="l50.628" class="difflineplus">+</span>
<a href="#l50.629"></a><span id="l50.629" class="difflineplus">+  return internalClose();</span>
<a href="#l50.630"></a><span id="l50.630" class="difflineplus">+}</span>
<a href="#l50.631"></a><span id="l50.631" class="difflineplus">+</span>
<a href="#l50.632"></a><span id="l50.632" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.633"></a><span id="l50.633" class="difflineplus">+Connection::AsyncClose(mozIStorageCompletionCallback *aCallback)</span>
<a href="#l50.634"></a><span id="l50.634" class="difflineplus">+{</span>
<a href="#l50.635"></a><span id="l50.635" class="difflineplus">+  if (!mDBConn)</span>
<a href="#l50.636"></a><span id="l50.636" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.637"></a><span id="l50.637" class="difflineplus">+</span>
<a href="#l50.638"></a><span id="l50.638" class="difflineplus">+  nsIEventTarget *asyncThread = getAsyncExecutionTarget();</span>
<a href="#l50.639"></a><span id="l50.639" class="difflineplus">+  NS_ENSURE_TRUE(asyncThread, NS_ERROR_UNEXPECTED);</span>
<a href="#l50.640"></a><span id="l50.640" class="difflineplus">+</span>
<a href="#l50.641"></a><span id="l50.641" class="difflineplus">+  nsresult rv = setClosedState();</span>
<a href="#l50.642"></a><span id="l50.642" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.643"></a><span id="l50.643" class="difflineplus">+</span>
<a href="#l50.644"></a><span id="l50.644" class="difflineplus">+  // Create our callback event if we were given a callback.</span>
<a href="#l50.645"></a><span id="l50.645" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; completeEvent;</span>
<a href="#l50.646"></a><span id="l50.646" class="difflineplus">+  if (aCallback) {</span>
<a href="#l50.647"></a><span id="l50.647" class="difflineplus">+    completeEvent = newCompletionEvent(aCallback);</span>
<a href="#l50.648"></a><span id="l50.648" class="difflineplus">+    NS_ENSURE_TRUE(completeEvent, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.649"></a><span id="l50.649" class="difflineplus">+  }</span>
<a href="#l50.650"></a><span id="l50.650" class="difflineplus">+</span>
<a href="#l50.651"></a><span id="l50.651" class="difflineplus">+  // Create and dispatch our close event to the background thread.</span>
<a href="#l50.652"></a><span id="l50.652" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; closeEvent;</span>
<a href="#l50.653"></a><span id="l50.653" class="difflineplus">+  {</span>
<a href="#l50.654"></a><span id="l50.654" class="difflineplus">+    MutexAutoLock lockedScope(sharedAsyncExecutionMutex);</span>
<a href="#l50.655"></a><span id="l50.655" class="difflineplus">+    closeEvent = new AsyncCloseConnection(this, NS_GetCurrentThread(),</span>
<a href="#l50.656"></a><span id="l50.656" class="difflineplus">+                                          completeEvent,</span>
<a href="#l50.657"></a><span id="l50.657" class="difflineplus">+                                          mAsyncExecutionThread);</span>
<a href="#l50.658"></a><span id="l50.658" class="difflineplus">+    // forget about the async thread (this is why we're holding the mutex)</span>
<a href="#l50.659"></a><span id="l50.659" class="difflineplus">+    mAsyncExecutionThread = nsnull;</span>
<a href="#l50.660"></a><span id="l50.660" class="difflineplus">+  }</span>
<a href="#l50.661"></a><span id="l50.661" class="difflineplus">+  NS_ENSURE_TRUE(closeEvent, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.662"></a><span id="l50.662" class="difflineplus">+</span>
<a href="#l50.663"></a><span id="l50.663" class="difflineplus">+  rv = asyncThread-&gt;Dispatch(closeEvent, NS_DISPATCH_NORMAL);</span>
<a href="#l50.664"></a><span id="l50.664" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.665"></a><span id="l50.665" class="difflineplus">+</span>
<a href="#l50.666"></a><span id="l50.666" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.667"></a><span id="l50.667" class="difflineplus">+}</span>
<a href="#l50.668"></a><span id="l50.668" class="difflineplus">+</span>
<a href="#l50.669"></a><span id="l50.669" class="difflineplus">+</span>
<a href="#l50.670"></a><span id="l50.670" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.671"></a><span id="l50.671" class="difflineplus">+Connection::GetConnectionReady(PRBool *_ready)</span>
<a href="#l50.672"></a><span id="l50.672" class="difflineplus">+{</span>
<a href="#l50.673"></a><span id="l50.673" class="difflineplus">+  *_ready = (mDBConn != nsnull);</span>
<a href="#l50.674"></a><span id="l50.674" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.675"></a><span id="l50.675" class="difflineplus">+}</span>
<a href="#l50.676"></a><span id="l50.676" class="difflineplus">+</span>
<a href="#l50.677"></a><span id="l50.677" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.678"></a><span id="l50.678" class="difflineplus">+Connection::GetDatabaseFile(nsIFile **_dbFile)</span>
<a href="#l50.679"></a><span id="l50.679" class="difflineplus">+{</span>
<a href="#l50.680"></a><span id="l50.680" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.681"></a><span id="l50.681" class="difflineplus">+</span>
<a href="#l50.682"></a><span id="l50.682" class="difflineplus">+  NS_IF_ADDREF(*_dbFile = mDatabaseFile);</span>
<a href="#l50.683"></a><span id="l50.683" class="difflineplus">+</span>
<a href="#l50.684"></a><span id="l50.684" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.685"></a><span id="l50.685" class="difflineplus">+}</span>
<a href="#l50.686"></a><span id="l50.686" class="difflineplus">+</span>
<a href="#l50.687"></a><span id="l50.687" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.688"></a><span id="l50.688" class="difflineplus">+Connection::GetLastInsertRowID(PRInt64 *_id)</span>
<a href="#l50.689"></a><span id="l50.689" class="difflineplus">+{</span>
<a href="#l50.690"></a><span id="l50.690" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.691"></a><span id="l50.691" class="difflineplus">+</span>
<a href="#l50.692"></a><span id="l50.692" class="difflineplus">+  sqlite_int64 id = ::sqlite3_last_insert_rowid(mDBConn);</span>
<a href="#l50.693"></a><span id="l50.693" class="difflineplus">+  *_id = id;</span>
<a href="#l50.694"></a><span id="l50.694" class="difflineplus">+</span>
<a href="#l50.695"></a><span id="l50.695" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.696"></a><span id="l50.696" class="difflineplus">+}</span>
<a href="#l50.697"></a><span id="l50.697" class="difflineplus">+</span>
<a href="#l50.698"></a><span id="l50.698" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.699"></a><span id="l50.699" class="difflineplus">+Connection::GetLastError(PRInt32 *_error)</span>
<a href="#l50.700"></a><span id="l50.700" class="difflineplus">+{</span>
<a href="#l50.701"></a><span id="l50.701" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.702"></a><span id="l50.702" class="difflineplus">+</span>
<a href="#l50.703"></a><span id="l50.703" class="difflineplus">+  *_error = ::sqlite3_errcode(mDBConn);</span>
<a href="#l50.704"></a><span id="l50.704" class="difflineplus">+</span>
<a href="#l50.705"></a><span id="l50.705" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.706"></a><span id="l50.706" class="difflineplus">+}</span>
<a href="#l50.707"></a><span id="l50.707" class="difflineplus">+</span>
<a href="#l50.708"></a><span id="l50.708" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.709"></a><span id="l50.709" class="difflineplus">+Connection::GetLastErrorString(nsACString &amp;_errorString)</span>
<a href="#l50.710"></a><span id="l50.710" class="difflineplus">+{</span>
<a href="#l50.711"></a><span id="l50.711" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.712"></a><span id="l50.712" class="difflineplus">+</span>
<a href="#l50.713"></a><span id="l50.713" class="difflineplus">+  const char *serr = ::sqlite3_errmsg(mDBConn);</span>
<a href="#l50.714"></a><span id="l50.714" class="difflineplus">+  _errorString.Assign(serr);</span>
<a href="#l50.715"></a><span id="l50.715" class="difflineplus">+</span>
<a href="#l50.716"></a><span id="l50.716" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.717"></a><span id="l50.717" class="difflineplus">+}</span>
<a href="#l50.718"></a><span id="l50.718" class="difflineplus">+</span>
<a href="#l50.719"></a><span id="l50.719" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.720"></a><span id="l50.720" class="difflineplus">+Connection::GetSchemaVersion(PRInt32 *_version)</span>
<a href="#l50.721"></a><span id="l50.721" class="difflineplus">+{</span>
<a href="#l50.722"></a><span id="l50.722" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.723"></a><span id="l50.723" class="difflineplus">+</span>
<a href="#l50.724"></a><span id="l50.724" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; stmt;</span>
<a href="#l50.725"></a><span id="l50.725" class="difflineplus">+  (void)CreateStatement(NS_LITERAL_CSTRING(&quot;PRAGMA user_version&quot;),</span>
<a href="#l50.726"></a><span id="l50.726" class="difflineplus">+                        getter_AddRefs(stmt));</span>
<a href="#l50.727"></a><span id="l50.727" class="difflineplus">+  NS_ENSURE_TRUE(stmt, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.728"></a><span id="l50.728" class="difflineplus">+</span>
<a href="#l50.729"></a><span id="l50.729" class="difflineplus">+  *_version = 0;</span>
<a href="#l50.730"></a><span id="l50.730" class="difflineplus">+  PRBool hasResult;</span>
<a href="#l50.731"></a><span id="l50.731" class="difflineplus">+  if (NS_SUCCEEDED(stmt-&gt;ExecuteStep(&amp;hasResult)) &amp;&amp; hasResult)</span>
<a href="#l50.732"></a><span id="l50.732" class="difflineplus">+    *_version = stmt-&gt;AsInt32(0);</span>
<a href="#l50.733"></a><span id="l50.733" class="difflineplus">+</span>
<a href="#l50.734"></a><span id="l50.734" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.735"></a><span id="l50.735" class="difflineplus">+}</span>
<a href="#l50.736"></a><span id="l50.736" class="difflineplus">+</span>
<a href="#l50.737"></a><span id="l50.737" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.738"></a><span id="l50.738" class="difflineplus">+Connection::SetSchemaVersion(PRInt32 aVersion)</span>
<a href="#l50.739"></a><span id="l50.739" class="difflineplus">+{</span>
<a href="#l50.740"></a><span id="l50.740" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.741"></a><span id="l50.741" class="difflineplus">+</span>
<a href="#l50.742"></a><span id="l50.742" class="difflineplus">+  nsCAutoString stmt(NS_LITERAL_CSTRING(&quot;PRAGMA user_version = &quot;));</span>
<a href="#l50.743"></a><span id="l50.743" class="difflineplus">+  stmt.AppendInt(aVersion);</span>
<a href="#l50.744"></a><span id="l50.744" class="difflineplus">+</span>
<a href="#l50.745"></a><span id="l50.745" class="difflineplus">+  return ExecuteSimpleSQL(stmt);</span>
<a href="#l50.746"></a><span id="l50.746" class="difflineplus">+}</span>
<a href="#l50.747"></a><span id="l50.747" class="difflineplus">+</span>
<a href="#l50.748"></a><span id="l50.748" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.749"></a><span id="l50.749" class="difflineplus">+Connection::CreateStatement(const nsACString &amp;aSQLStatement,</span>
<a href="#l50.750"></a><span id="l50.750" class="difflineplus">+                            mozIStorageStatement **_stmt)</span>
<a href="#l50.751"></a><span id="l50.751" class="difflineplus">+{</span>
<a href="#l50.752"></a><span id="l50.752" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_stmt);</span>
<a href="#l50.753"></a><span id="l50.753" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.754"></a><span id="l50.754" class="difflineplus">+</span>
<a href="#l50.755"></a><span id="l50.755" class="difflineplus">+  nsRefPtr&lt;Statement&gt; statement(new Statement());</span>
<a href="#l50.756"></a><span id="l50.756" class="difflineplus">+  NS_ENSURE_TRUE(statement, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.757"></a><span id="l50.757" class="difflineplus">+</span>
<a href="#l50.758"></a><span id="l50.758" class="difflineplus">+  nsresult rv = statement-&gt;initialize(this, aSQLStatement);</span>
<a href="#l50.759"></a><span id="l50.759" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.760"></a><span id="l50.760" class="difflineplus">+</span>
<a href="#l50.761"></a><span id="l50.761" class="difflineplus">+  Statement *rawPtr;</span>
<a href="#l50.762"></a><span id="l50.762" class="difflineplus">+  statement.forget(&amp;rawPtr);</span>
<a href="#l50.763"></a><span id="l50.763" class="difflineplus">+  *_stmt = rawPtr;</span>
<a href="#l50.764"></a><span id="l50.764" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.765"></a><span id="l50.765" class="difflineplus">+}</span>
<a href="#l50.766"></a><span id="l50.766" class="difflineplus">+</span>
<a href="#l50.767"></a><span id="l50.767" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.768"></a><span id="l50.768" class="difflineplus">+Connection::CreateAsyncStatement(const nsACString &amp;aSQLStatement,</span>
<a href="#l50.769"></a><span id="l50.769" class="difflineplus">+                                 mozIStorageAsyncStatement **_stmt)</span>
<a href="#l50.770"></a><span id="l50.770" class="difflineplus">+{</span>
<a href="#l50.771"></a><span id="l50.771" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_stmt);</span>
<a href="#l50.772"></a><span id="l50.772" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.773"></a><span id="l50.773" class="difflineplus">+</span>
<a href="#l50.774"></a><span id="l50.774" class="difflineplus">+  nsRefPtr&lt;AsyncStatement&gt; statement(new AsyncStatement());</span>
<a href="#l50.775"></a><span id="l50.775" class="difflineplus">+  NS_ENSURE_TRUE(statement, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.776"></a><span id="l50.776" class="difflineplus">+</span>
<a href="#l50.777"></a><span id="l50.777" class="difflineplus">+  nsresult rv = statement-&gt;initialize(this, aSQLStatement);</span>
<a href="#l50.778"></a><span id="l50.778" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.779"></a><span id="l50.779" class="difflineplus">+</span>
<a href="#l50.780"></a><span id="l50.780" class="difflineplus">+  AsyncStatement *rawPtr;</span>
<a href="#l50.781"></a><span id="l50.781" class="difflineplus">+  statement.forget(&amp;rawPtr);</span>
<a href="#l50.782"></a><span id="l50.782" class="difflineplus">+  *_stmt = rawPtr;</span>
<a href="#l50.783"></a><span id="l50.783" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.784"></a><span id="l50.784" class="difflineplus">+}</span>
<a href="#l50.785"></a><span id="l50.785" class="difflineplus">+</span>
<a href="#l50.786"></a><span id="l50.786" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.787"></a><span id="l50.787" class="difflineplus">+Connection::ExecuteSimpleSQL(const nsACString &amp;aSQLStatement)</span>
<a href="#l50.788"></a><span id="l50.788" class="difflineplus">+{</span>
<a href="#l50.789"></a><span id="l50.789" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.790"></a><span id="l50.790" class="difflineplus">+</span>
<a href="#l50.791"></a><span id="l50.791" class="difflineplus">+  int srv = ::sqlite3_exec(mDBConn, PromiseFlatCString(aSQLStatement).get(),</span>
<a href="#l50.792"></a><span id="l50.792" class="difflineplus">+                           NULL, NULL, NULL);</span>
<a href="#l50.793"></a><span id="l50.793" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l50.794"></a><span id="l50.794" class="difflineplus">+}</span>
<a href="#l50.795"></a><span id="l50.795" class="difflineplus">+</span>
<a href="#l50.796"></a><span id="l50.796" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.797"></a><span id="l50.797" class="difflineplus">+Connection::ExecuteAsync(mozIStorageBaseStatement **aStatements,</span>
<a href="#l50.798"></a><span id="l50.798" class="difflineplus">+                         PRUint32 aNumStatements,</span>
<a href="#l50.799"></a><span id="l50.799" class="difflineplus">+                         mozIStorageStatementCallback *aCallback,</span>
<a href="#l50.800"></a><span id="l50.800" class="difflineplus">+                         mozIStoragePendingStatement **_handle)</span>
<a href="#l50.801"></a><span id="l50.801" class="difflineplus">+{</span>
<a href="#l50.802"></a><span id="l50.802" class="difflineplus">+  nsTArray&lt;StatementData&gt; stmts(aNumStatements);</span>
<a href="#l50.803"></a><span id="l50.803" class="difflineplus">+  for (PRUint32 i = 0; i &lt; aNumStatements; i++) {</span>
<a href="#l50.804"></a><span id="l50.804" class="difflineplus">+    nsCOMPtr&lt;StorageBaseStatementInternal&gt; stmt = </span>
<a href="#l50.805"></a><span id="l50.805" class="difflineplus">+      do_QueryInterface(aStatements[i]);</span>
<a href="#l50.806"></a><span id="l50.806" class="difflineplus">+</span>
<a href="#l50.807"></a><span id="l50.807" class="difflineplus">+    // Obtain our StatementData.</span>
<a href="#l50.808"></a><span id="l50.808" class="difflineplus">+    StatementData data;</span>
<a href="#l50.809"></a><span id="l50.809" class="difflineplus">+    nsresult rv = stmt-&gt;getAsynchronousStatementData(data);</span>
<a href="#l50.810"></a><span id="l50.810" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l50.811"></a><span id="l50.811" class="difflineplus">+</span>
<a href="#l50.812"></a><span id="l50.812" class="difflineplus">+    NS_ASSERTION(stmt-&gt;getOwner() == this,</span>
<a href="#l50.813"></a><span id="l50.813" class="difflineplus">+                 &quot;Statement must be from this database connection!&quot;);</span>
<a href="#l50.814"></a><span id="l50.814" class="difflineplus">+</span>
<a href="#l50.815"></a><span id="l50.815" class="difflineplus">+    // Now append it to our array.</span>
<a href="#l50.816"></a><span id="l50.816" class="difflineplus">+    NS_ENSURE_TRUE(stmts.AppendElement(data), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.817"></a><span id="l50.817" class="difflineplus">+  }</span>
<a href="#l50.818"></a><span id="l50.818" class="difflineplus">+</span>
<a href="#l50.819"></a><span id="l50.819" class="difflineplus">+  // Dispatch to the background</span>
<a href="#l50.820"></a><span id="l50.820" class="difflineplus">+  return AsyncExecuteStatements::execute(stmts, this, aCallback, _handle);</span>
<a href="#l50.821"></a><span id="l50.821" class="difflineplus">+}</span>
<a href="#l50.822"></a><span id="l50.822" class="difflineplus">+</span>
<a href="#l50.823"></a><span id="l50.823" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.824"></a><span id="l50.824" class="difflineplus">+Connection::TableExists(const nsACString &amp;aTableName,</span>
<a href="#l50.825"></a><span id="l50.825" class="difflineplus">+                        PRBool *_exists)</span>
<a href="#l50.826"></a><span id="l50.826" class="difflineplus">+{</span>
<a href="#l50.827"></a><span id="l50.827" class="difflineplus">+    return databaseElementExists(TABLE, aTableName, _exists);</span>
<a href="#l50.828"></a><span id="l50.828" class="difflineplus">+}</span>
<a href="#l50.829"></a><span id="l50.829" class="difflineplus">+</span>
<a href="#l50.830"></a><span id="l50.830" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.831"></a><span id="l50.831" class="difflineplus">+Connection::IndexExists(const nsACString &amp;aIndexName,</span>
<a href="#l50.832"></a><span id="l50.832" class="difflineplus">+                        PRBool* _exists)</span>
<a href="#l50.833"></a><span id="l50.833" class="difflineplus">+{</span>
<a href="#l50.834"></a><span id="l50.834" class="difflineplus">+    return databaseElementExists(INDEX, aIndexName, _exists);</span>
<a href="#l50.835"></a><span id="l50.835" class="difflineplus">+}</span>
<a href="#l50.836"></a><span id="l50.836" class="difflineplus">+</span>
<a href="#l50.837"></a><span id="l50.837" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.838"></a><span id="l50.838" class="difflineplus">+Connection::GetTransactionInProgress(PRBool *_inProgress)</span>
<a href="#l50.839"></a><span id="l50.839" class="difflineplus">+{</span>
<a href="#l50.840"></a><span id="l50.840" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.841"></a><span id="l50.841" class="difflineplus">+</span>
<a href="#l50.842"></a><span id="l50.842" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.843"></a><span id="l50.843" class="difflineplus">+  *_inProgress = mTransactionInProgress;</span>
<a href="#l50.844"></a><span id="l50.844" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.845"></a><span id="l50.845" class="difflineplus">+}</span>
<a href="#l50.846"></a><span id="l50.846" class="difflineplus">+</span>
<a href="#l50.847"></a><span id="l50.847" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.848"></a><span id="l50.848" class="difflineplus">+Connection::BeginTransaction()</span>
<a href="#l50.849"></a><span id="l50.849" class="difflineplus">+{</span>
<a href="#l50.850"></a><span id="l50.850" class="difflineplus">+  return BeginTransactionAs(mozIStorageConnection::TRANSACTION_DEFERRED);</span>
<a href="#l50.851"></a><span id="l50.851" class="difflineplus">+}</span>
<a href="#l50.852"></a><span id="l50.852" class="difflineplus">+</span>
<a href="#l50.853"></a><span id="l50.853" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.854"></a><span id="l50.854" class="difflineplus">+Connection::BeginTransactionAs(PRInt32 aTransactionType)</span>
<a href="#l50.855"></a><span id="l50.855" class="difflineplus">+{</span>
<a href="#l50.856"></a><span id="l50.856" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.857"></a><span id="l50.857" class="difflineplus">+</span>
<a href="#l50.858"></a><span id="l50.858" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.859"></a><span id="l50.859" class="difflineplus">+  if (mTransactionInProgress)</span>
<a href="#l50.860"></a><span id="l50.860" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l50.861"></a><span id="l50.861" class="difflineplus">+  nsresult rv;</span>
<a href="#l50.862"></a><span id="l50.862" class="difflineplus">+  switch(aTransactionType) {</span>
<a href="#l50.863"></a><span id="l50.863" class="difflineplus">+    case TRANSACTION_DEFERRED:</span>
<a href="#l50.864"></a><span id="l50.864" class="difflineplus">+      rv = ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;BEGIN DEFERRED&quot;));</span>
<a href="#l50.865"></a><span id="l50.865" class="difflineplus">+      break;</span>
<a href="#l50.866"></a><span id="l50.866" class="difflineplus">+    case TRANSACTION_IMMEDIATE:</span>
<a href="#l50.867"></a><span id="l50.867" class="difflineplus">+      rv = ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;BEGIN IMMEDIATE&quot;));</span>
<a href="#l50.868"></a><span id="l50.868" class="difflineplus">+      break;</span>
<a href="#l50.869"></a><span id="l50.869" class="difflineplus">+    case TRANSACTION_EXCLUSIVE:</span>
<a href="#l50.870"></a><span id="l50.870" class="difflineplus">+      rv = ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;BEGIN EXCLUSIVE&quot;));</span>
<a href="#l50.871"></a><span id="l50.871" class="difflineplus">+      break;</span>
<a href="#l50.872"></a><span id="l50.872" class="difflineplus">+    default:</span>
<a href="#l50.873"></a><span id="l50.873" class="difflineplus">+      return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l50.874"></a><span id="l50.874" class="difflineplus">+  }</span>
<a href="#l50.875"></a><span id="l50.875" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l50.876"></a><span id="l50.876" class="difflineplus">+    mTransactionInProgress = PR_TRUE;</span>
<a href="#l50.877"></a><span id="l50.877" class="difflineplus">+  return rv;</span>
<a href="#l50.878"></a><span id="l50.878" class="difflineplus">+}</span>
<a href="#l50.879"></a><span id="l50.879" class="difflineplus">+</span>
<a href="#l50.880"></a><span id="l50.880" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.881"></a><span id="l50.881" class="difflineplus">+Connection::CommitTransaction()</span>
<a href="#l50.882"></a><span id="l50.882" class="difflineplus">+{</span>
<a href="#l50.883"></a><span id="l50.883" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.884"></a><span id="l50.884" class="difflineplus">+</span>
<a href="#l50.885"></a><span id="l50.885" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.886"></a><span id="l50.886" class="difflineplus">+  if (!mTransactionInProgress)</span>
<a href="#l50.887"></a><span id="l50.887" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l50.888"></a><span id="l50.888" class="difflineplus">+  nsresult rv = ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;COMMIT TRANSACTION&quot;));</span>
<a href="#l50.889"></a><span id="l50.889" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l50.890"></a><span id="l50.890" class="difflineplus">+    mTransactionInProgress = PR_FALSE;</span>
<a href="#l50.891"></a><span id="l50.891" class="difflineplus">+  return rv;</span>
<a href="#l50.892"></a><span id="l50.892" class="difflineplus">+}</span>
<a href="#l50.893"></a><span id="l50.893" class="difflineplus">+</span>
<a href="#l50.894"></a><span id="l50.894" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.895"></a><span id="l50.895" class="difflineplus">+Connection::RollbackTransaction()</span>
<a href="#l50.896"></a><span id="l50.896" class="difflineplus">+{</span>
<a href="#l50.897"></a><span id="l50.897" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.898"></a><span id="l50.898" class="difflineplus">+</span>
<a href="#l50.899"></a><span id="l50.899" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.900"></a><span id="l50.900" class="difflineplus">+  if (!mTransactionInProgress)</span>
<a href="#l50.901"></a><span id="l50.901" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l50.902"></a><span id="l50.902" class="difflineplus">+  nsresult rv = ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;ROLLBACK TRANSACTION&quot;));</span>
<a href="#l50.903"></a><span id="l50.903" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l50.904"></a><span id="l50.904" class="difflineplus">+    mTransactionInProgress = PR_FALSE;</span>
<a href="#l50.905"></a><span id="l50.905" class="difflineplus">+  return rv;</span>
<a href="#l50.906"></a><span id="l50.906" class="difflineplus">+}</span>
<a href="#l50.907"></a><span id="l50.907" class="difflineplus">+</span>
<a href="#l50.908"></a><span id="l50.908" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.909"></a><span id="l50.909" class="difflineplus">+Connection::CreateTable(const char *aTableName,</span>
<a href="#l50.910"></a><span id="l50.910" class="difflineplus">+                        const char *aTableSchema)</span>
<a href="#l50.911"></a><span id="l50.911" class="difflineplus">+{</span>
<a href="#l50.912"></a><span id="l50.912" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.913"></a><span id="l50.913" class="difflineplus">+</span>
<a href="#l50.914"></a><span id="l50.914" class="difflineplus">+  char *buf = ::PR_smprintf(&quot;CREATE TABLE %s (%s)&quot;, aTableName, aTableSchema);</span>
<a href="#l50.915"></a><span id="l50.915" class="difflineplus">+  if (!buf)</span>
<a href="#l50.916"></a><span id="l50.916" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l50.917"></a><span id="l50.917" class="difflineplus">+</span>
<a href="#l50.918"></a><span id="l50.918" class="difflineplus">+  int srv = ::sqlite3_exec(mDBConn, buf, NULL, NULL, NULL);</span>
<a href="#l50.919"></a><span id="l50.919" class="difflineplus">+  ::PR_smprintf_free(buf);</span>
<a href="#l50.920"></a><span id="l50.920" class="difflineplus">+</span>
<a href="#l50.921"></a><span id="l50.921" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l50.922"></a><span id="l50.922" class="difflineplus">+}</span>
<a href="#l50.923"></a><span id="l50.923" class="difflineplus">+</span>
<a href="#l50.924"></a><span id="l50.924" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.925"></a><span id="l50.925" class="difflineplus">+Connection::CreateFunction(const nsACString &amp;aFunctionName,</span>
<a href="#l50.926"></a><span id="l50.926" class="difflineplus">+                           PRInt32 aNumArguments,</span>
<a href="#l50.927"></a><span id="l50.927" class="difflineplus">+                           mozIStorageFunction *aFunction)</span>
<a href="#l50.928"></a><span id="l50.928" class="difflineplus">+{</span>
<a href="#l50.929"></a><span id="l50.929" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.930"></a><span id="l50.930" class="difflineplus">+</span>
<a href="#l50.931"></a><span id="l50.931" class="difflineplus">+  // Check to see if this function is already defined.  We only check the name</span>
<a href="#l50.932"></a><span id="l50.932" class="difflineplus">+  // because a function can be defined with the same body but different names.</span>
<a href="#l50.933"></a><span id="l50.933" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.934"></a><span id="l50.934" class="difflineplus">+  NS_ENSURE_FALSE(mFunctions.Get(aFunctionName, NULL), NS_ERROR_FAILURE);</span>
<a href="#l50.935"></a><span id="l50.935" class="difflineplus">+</span>
<a href="#l50.936"></a><span id="l50.936" class="difflineplus">+  int srv = ::sqlite3_create_function(mDBConn,</span>
<a href="#l50.937"></a><span id="l50.937" class="difflineplus">+                                      nsPromiseFlatCString(aFunctionName).get(),</span>
<a href="#l50.938"></a><span id="l50.938" class="difflineplus">+                                      aNumArguments,</span>
<a href="#l50.939"></a><span id="l50.939" class="difflineplus">+                                      SQLITE_ANY,</span>
<a href="#l50.940"></a><span id="l50.940" class="difflineplus">+                                      aFunction,</span>
<a href="#l50.941"></a><span id="l50.941" class="difflineplus">+                                      basicFunctionHelper,</span>
<a href="#l50.942"></a><span id="l50.942" class="difflineplus">+                                      NULL,</span>
<a href="#l50.943"></a><span id="l50.943" class="difflineplus">+                                      NULL);</span>
<a href="#l50.944"></a><span id="l50.944" class="difflineplus">+  if (srv != SQLITE_OK)</span>
<a href="#l50.945"></a><span id="l50.945" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.946"></a><span id="l50.946" class="difflineplus">+</span>
<a href="#l50.947"></a><span id="l50.947" class="difflineplus">+  NS_ENSURE_TRUE(mFunctions.Put(aFunctionName, aFunction),</span>
<a href="#l50.948"></a><span id="l50.948" class="difflineplus">+                 NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.949"></a><span id="l50.949" class="difflineplus">+</span>
<a href="#l50.950"></a><span id="l50.950" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.951"></a><span id="l50.951" class="difflineplus">+}</span>
<a href="#l50.952"></a><span id="l50.952" class="difflineplus">+</span>
<a href="#l50.953"></a><span id="l50.953" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.954"></a><span id="l50.954" class="difflineplus">+Connection::CreateAggregateFunction(const nsACString &amp;aFunctionName,</span>
<a href="#l50.955"></a><span id="l50.955" class="difflineplus">+                                    PRInt32 aNumArguments,</span>
<a href="#l50.956"></a><span id="l50.956" class="difflineplus">+                                    mozIStorageAggregateFunction *aFunction)</span>
<a href="#l50.957"></a><span id="l50.957" class="difflineplus">+{</span>
<a href="#l50.958"></a><span id="l50.958" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.959"></a><span id="l50.959" class="difflineplus">+</span>
<a href="#l50.960"></a><span id="l50.960" class="difflineplus">+  // Check to see if this function name is already defined.</span>
<a href="#l50.961"></a><span id="l50.961" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.962"></a><span id="l50.962" class="difflineplus">+  NS_ENSURE_FALSE(mFunctions.Get(aFunctionName, NULL), NS_ERROR_FAILURE);</span>
<a href="#l50.963"></a><span id="l50.963" class="difflineplus">+</span>
<a href="#l50.964"></a><span id="l50.964" class="difflineplus">+  // Because aggregate functions depend on state across calls, you cannot have</span>
<a href="#l50.965"></a><span id="l50.965" class="difflineplus">+  // the same instance use the same name.  We want to enumerate all functions</span>
<a href="#l50.966"></a><span id="l50.966" class="difflineplus">+  // and make sure this instance is not already registered.</span>
<a href="#l50.967"></a><span id="l50.967" class="difflineplus">+  NS_ENSURE_FALSE(findFunctionByInstance(aFunction), NS_ERROR_FAILURE);</span>
<a href="#l50.968"></a><span id="l50.968" class="difflineplus">+</span>
<a href="#l50.969"></a><span id="l50.969" class="difflineplus">+  int srv = ::sqlite3_create_function(mDBConn,</span>
<a href="#l50.970"></a><span id="l50.970" class="difflineplus">+                                      nsPromiseFlatCString(aFunctionName).get(),</span>
<a href="#l50.971"></a><span id="l50.971" class="difflineplus">+                                      aNumArguments,</span>
<a href="#l50.972"></a><span id="l50.972" class="difflineplus">+                                      SQLITE_ANY,</span>
<a href="#l50.973"></a><span id="l50.973" class="difflineplus">+                                      aFunction,</span>
<a href="#l50.974"></a><span id="l50.974" class="difflineplus">+                                      NULL,</span>
<a href="#l50.975"></a><span id="l50.975" class="difflineplus">+                                      aggregateFunctionStepHelper,</span>
<a href="#l50.976"></a><span id="l50.976" class="difflineplus">+                                      aggregateFunctionFinalHelper);</span>
<a href="#l50.977"></a><span id="l50.977" class="difflineplus">+  if (srv != SQLITE_OK)</span>
<a href="#l50.978"></a><span id="l50.978" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.979"></a><span id="l50.979" class="difflineplus">+</span>
<a href="#l50.980"></a><span id="l50.980" class="difflineplus">+  NS_ENSURE_TRUE(mFunctions.Put(aFunctionName, aFunction),</span>
<a href="#l50.981"></a><span id="l50.981" class="difflineplus">+                 NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l50.982"></a><span id="l50.982" class="difflineplus">+</span>
<a href="#l50.983"></a><span id="l50.983" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.984"></a><span id="l50.984" class="difflineplus">+}</span>
<a href="#l50.985"></a><span id="l50.985" class="difflineplus">+</span>
<a href="#l50.986"></a><span id="l50.986" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.987"></a><span id="l50.987" class="difflineplus">+Connection::RemoveFunction(const nsACString &amp;aFunctionName)</span>
<a href="#l50.988"></a><span id="l50.988" class="difflineplus">+{</span>
<a href="#l50.989"></a><span id="l50.989" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.990"></a><span id="l50.990" class="difflineplus">+</span>
<a href="#l50.991"></a><span id="l50.991" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.992"></a><span id="l50.992" class="difflineplus">+  NS_ENSURE_TRUE(mFunctions.Get(aFunctionName, NULL), NS_ERROR_FAILURE);</span>
<a href="#l50.993"></a><span id="l50.993" class="difflineplus">+</span>
<a href="#l50.994"></a><span id="l50.994" class="difflineplus">+  int srv = ::sqlite3_create_function(mDBConn,</span>
<a href="#l50.995"></a><span id="l50.995" class="difflineplus">+                                      nsPromiseFlatCString(aFunctionName).get(),</span>
<a href="#l50.996"></a><span id="l50.996" class="difflineplus">+                                      0,</span>
<a href="#l50.997"></a><span id="l50.997" class="difflineplus">+                                      SQLITE_ANY,</span>
<a href="#l50.998"></a><span id="l50.998" class="difflineplus">+                                      NULL,</span>
<a href="#l50.999"></a><span id="l50.999" class="difflineplus">+                                      NULL,</span>
<a href="#l50.1000"></a><span id="l50.1000" class="difflineplus">+                                      NULL,</span>
<a href="#l50.1001"></a><span id="l50.1001" class="difflineplus">+                                      NULL);</span>
<a href="#l50.1002"></a><span id="l50.1002" class="difflineplus">+  if (srv != SQLITE_OK)</span>
<a href="#l50.1003"></a><span id="l50.1003" class="difflineplus">+    return convertResultCode(srv);</span>
<a href="#l50.1004"></a><span id="l50.1004" class="difflineplus">+</span>
<a href="#l50.1005"></a><span id="l50.1005" class="difflineplus">+  mFunctions.Remove(aFunctionName);</span>
<a href="#l50.1006"></a><span id="l50.1006" class="difflineplus">+</span>
<a href="#l50.1007"></a><span id="l50.1007" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.1008"></a><span id="l50.1008" class="difflineplus">+}</span>
<a href="#l50.1009"></a><span id="l50.1009" class="difflineplus">+</span>
<a href="#l50.1010"></a><span id="l50.1010" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.1011"></a><span id="l50.1011" class="difflineplus">+Connection::SetProgressHandler(PRInt32 aGranularity,</span>
<a href="#l50.1012"></a><span id="l50.1012" class="difflineplus">+                               mozIStorageProgressHandler *aHandler,</span>
<a href="#l50.1013"></a><span id="l50.1013" class="difflineplus">+                               mozIStorageProgressHandler **_oldHandler)</span>
<a href="#l50.1014"></a><span id="l50.1014" class="difflineplus">+{</span>
<a href="#l50.1015"></a><span id="l50.1015" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.1016"></a><span id="l50.1016" class="difflineplus">+</span>
<a href="#l50.1017"></a><span id="l50.1017" class="difflineplus">+  // Return previous one</span>
<a href="#l50.1018"></a><span id="l50.1018" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.1019"></a><span id="l50.1019" class="difflineplus">+  NS_IF_ADDREF(*_oldHandler = mProgressHandler);</span>
<a href="#l50.1020"></a><span id="l50.1020" class="difflineplus">+</span>
<a href="#l50.1021"></a><span id="l50.1021" class="difflineplus">+  if (!aHandler || aGranularity &lt;= 0) {</span>
<a href="#l50.1022"></a><span id="l50.1022" class="difflineplus">+    aHandler = nsnull;</span>
<a href="#l50.1023"></a><span id="l50.1023" class="difflineplus">+    aGranularity = 0;</span>
<a href="#l50.1024"></a><span id="l50.1024" class="difflineplus">+  }</span>
<a href="#l50.1025"></a><span id="l50.1025" class="difflineplus">+  mProgressHandler = aHandler;</span>
<a href="#l50.1026"></a><span id="l50.1026" class="difflineplus">+  ::sqlite3_progress_handler(mDBConn, aGranularity, sProgressHelper, this);</span>
<a href="#l50.1027"></a><span id="l50.1027" class="difflineplus">+</span>
<a href="#l50.1028"></a><span id="l50.1028" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.1029"></a><span id="l50.1029" class="difflineplus">+}</span>
<a href="#l50.1030"></a><span id="l50.1030" class="difflineplus">+</span>
<a href="#l50.1031"></a><span id="l50.1031" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l50.1032"></a><span id="l50.1032" class="difflineplus">+Connection::RemoveProgressHandler(mozIStorageProgressHandler **_oldHandler)</span>
<a href="#l50.1033"></a><span id="l50.1033" class="difflineplus">+{</span>
<a href="#l50.1034"></a><span id="l50.1034" class="difflineplus">+  if (!mDBConn) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l50.1035"></a><span id="l50.1035" class="difflineplus">+</span>
<a href="#l50.1036"></a><span id="l50.1036" class="difflineplus">+  // Return previous one</span>
<a href="#l50.1037"></a><span id="l50.1037" class="difflineplus">+  SQLiteMutexAutoLock lockedScope(sharedDBMutex);</span>
<a href="#l50.1038"></a><span id="l50.1038" class="difflineplus">+  NS_IF_ADDREF(*_oldHandler = mProgressHandler);</span>
<a href="#l50.1039"></a><span id="l50.1039" class="difflineplus">+</span>
<a href="#l50.1040"></a><span id="l50.1040" class="difflineplus">+  mProgressHandler = nsnull;</span>
<a href="#l50.1041"></a><span id="l50.1041" class="difflineplus">+  ::sqlite3_progress_handler(mDBConn, 0, NULL, NULL);</span>
<a href="#l50.1042"></a><span id="l50.1042" class="difflineplus">+</span>
<a href="#l50.1043"></a><span id="l50.1043" class="difflineplus">+  return NS_OK;</span>
<a href="#l50.1044"></a><span id="l50.1044" class="difflineplus">+}</span>
<a href="#l50.1045"></a><span id="l50.1045" class="difflineplus">+</span>
<a href="#l50.1046"></a><span id="l50.1046" class="difflineplus">+} // namespace storage</span>
<a href="#l50.1047"></a><span id="l50.1047" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- /dev/null</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ b/storage-backport/src/mozStorageConnection.h</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -0,0 +1,212 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+ *</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+ *</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+ * License.</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+ *</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineplus">+ *</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+ *</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineplus">+ *</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+ *</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+</span>
<a href="#l51.45"></a><span id="l51.45" class="difflineplus">+#ifndef _MOZSTORAGECONNECTION_H_</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineplus">+#define _MOZSTORAGECONNECTION_H_</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l51.51"></a><span id="l51.51" class="difflineplus">+</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l51.54"></a><span id="l51.54" class="difflineplus">+#include &quot;mozIStorageProgressHandler.h&quot;</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineplus">+#include &quot;SQLiteMutex.h&quot;</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineplus">+#include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l51.57"></a><span id="l51.57" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l51.58"></a><span id="l51.58" class="difflineplus">+</span>
<a href="#l51.59"></a><span id="l51.59" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l51.60"></a><span id="l51.60" class="difflineplus">+</span>
<a href="#l51.61"></a><span id="l51.61" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l51.62"></a><span id="l51.62" class="difflineplus">+</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineplus">+struct PRLock;</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineplus">+class nsIFile;</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineplus">+class nsIEventTarget;</span>
<a href="#l51.66"></a><span id="l51.66" class="difflineplus">+class nsIThread;</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineplus">+</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineplus">+namespace mozilla {</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineplus">+namespace storage {</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineplus">+</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineplus">+class Connection : public mozIStorageConnection</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineplus">+{</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineplus">+public:</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineplus">+  NS_DECL_MOZISTORAGECONNECTION</span>
<a href="#l51.76"></a><span id="l51.76" class="difflineplus">+</span>
<a href="#l51.77"></a><span id="l51.77" class="difflineplus">+  Connection(Service *aService);</span>
<a href="#l51.78"></a><span id="l51.78" class="difflineplus">+</span>
<a href="#l51.79"></a><span id="l51.79" class="difflineplus">+  /**</span>
<a href="#l51.80"></a><span id="l51.80" class="difflineplus">+   * Creates the connection to the database.</span>
<a href="#l51.81"></a><span id="l51.81" class="difflineplus">+   *</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineplus">+   * @param aDatabaseFile</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+   *        The nsIFile of the location of the database to open, or create if it</span>
<a href="#l51.84"></a><span id="l51.84" class="difflineplus">+   *        does not exist.  Passing in nsnull here creates an in-memory</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineplus">+   *        database.</span>
<a href="#l51.86"></a><span id="l51.86" class="difflineplus">+   */</span>
<a href="#l51.87"></a><span id="l51.87" class="difflineplus">+  nsresult initialize(nsIFile *aDatabaseFile);</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineplus">+</span>
<a href="#l51.89"></a><span id="l51.89" class="difflineplus">+  // fetch the native handle</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineplus">+  sqlite3 *GetNativeConnection() { return mDBConn; }</span>
<a href="#l51.91"></a><span id="l51.91" class="difflineplus">+</span>
<a href="#l51.92"></a><span id="l51.92" class="difflineplus">+  /**</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineplus">+   * Lazily creates and returns a background execution thread.  In the future,</span>
<a href="#l51.94"></a><span id="l51.94" class="difflineplus">+   * the thread may be re-claimed if left idle, so you should call this</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineplus">+   * method just before you dispatch and not save the reference.</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineplus">+   *</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+   * @returns an event target suitable for asynchronous statement execution.</span>
<a href="#l51.98"></a><span id="l51.98" class="difflineplus">+   */</span>
<a href="#l51.99"></a><span id="l51.99" class="difflineplus">+  nsIEventTarget *getAsyncExecutionTarget();</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineplus">+</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineplus">+  /**</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineplus">+   * Mutex used by asynchronous statements to protect state.  The mutex is</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineplus">+   * declared on the connection object because there is no contention between</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineplus">+   * asynchronous statements (they are serialized on mAsyncExecutionThread).  It</span>
<a href="#l51.105"></a><span id="l51.105" class="difflineplus">+   * also protects mPendingStatements.</span>
<a href="#l51.106"></a><span id="l51.106" class="difflineplus">+   */</span>
<a href="#l51.107"></a><span id="l51.107" class="difflineplus">+  Mutex sharedAsyncExecutionMutex;</span>
<a href="#l51.108"></a><span id="l51.108" class="difflineplus">+</span>
<a href="#l51.109"></a><span id="l51.109" class="difflineplus">+  /**</span>
<a href="#l51.110"></a><span id="l51.110" class="difflineplus">+   * Wraps the mutex that SQLite gives us from sqlite3_db_mutex.  This is public</span>
<a href="#l51.111"></a><span id="l51.111" class="difflineplus">+   * because we already expose the sqlite3* native connection and proper</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineplus">+   * operation of the deadlock detector requires everyone to use the same single</span>
<a href="#l51.113"></a><span id="l51.113" class="difflineplus">+   * SQLiteMutex instance for correctness.</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineplus">+   */</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineplus">+  SQLiteMutex sharedDBMutex;</span>
<a href="#l51.116"></a><span id="l51.116" class="difflineplus">+</span>
<a href="#l51.117"></a><span id="l51.117" class="difflineplus">+  /**</span>
<a href="#l51.118"></a><span id="l51.118" class="difflineplus">+   * References the thread this database was opened on.  This MUST be thread it is</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineplus">+   * closed on.</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineplus">+   */</span>
<a href="#l51.121"></a><span id="l51.121" class="difflineplus">+  const nsCOMPtr&lt;nsIThread&gt; threadOpenedOn;</span>
<a href="#l51.122"></a><span id="l51.122" class="difflineplus">+</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineplus">+  /**</span>
<a href="#l51.124"></a><span id="l51.124" class="difflineplus">+   * Closes the SQLite database, and warns about any non-finalized statements.</span>
<a href="#l51.125"></a><span id="l51.125" class="difflineplus">+   */</span>
<a href="#l51.126"></a><span id="l51.126" class="difflineplus">+  nsresult internalClose();</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineplus">+</span>
<a href="#l51.128"></a><span id="l51.128" class="difflineplus">+private:</span>
<a href="#l51.129"></a><span id="l51.129" class="difflineplus">+  ~Connection();</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineplus">+</span>
<a href="#l51.131"></a><span id="l51.131" class="difflineplus">+  /**</span>
<a href="#l51.132"></a><span id="l51.132" class="difflineplus">+   * Sets the database into a closed state so no further actions can be</span>
<a href="#l51.133"></a><span id="l51.133" class="difflineplus">+   * performed.</span>
<a href="#l51.134"></a><span id="l51.134" class="difflineplus">+   *</span>
<a href="#l51.135"></a><span id="l51.135" class="difflineplus">+   * @note mDBConn is set to NULL in this method.</span>
<a href="#l51.136"></a><span id="l51.136" class="difflineplus">+   */</span>
<a href="#l51.137"></a><span id="l51.137" class="difflineplus">+  nsresult setClosedState();</span>
<a href="#l51.138"></a><span id="l51.138" class="difflineplus">+</span>
<a href="#l51.139"></a><span id="l51.139" class="difflineplus">+  /**</span>
<a href="#l51.140"></a><span id="l51.140" class="difflineplus">+   * Describes a certain primitive type in the database.</span>
<a href="#l51.141"></a><span id="l51.141" class="difflineplus">+   *</span>
<a href="#l51.142"></a><span id="l51.142" class="difflineplus">+   * Possible Values Are:</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineplus">+   *  INDEX - To check for the existence of an index</span>
<a href="#l51.144"></a><span id="l51.144" class="difflineplus">+   *  TABLE - To check for the existence of a table</span>
<a href="#l51.145"></a><span id="l51.145" class="difflineplus">+   */</span>
<a href="#l51.146"></a><span id="l51.146" class="difflineplus">+  enum DatabaseElementType {</span>
<a href="#l51.147"></a><span id="l51.147" class="difflineplus">+    INDEX,</span>
<a href="#l51.148"></a><span id="l51.148" class="difflineplus">+    TABLE</span>
<a href="#l51.149"></a><span id="l51.149" class="difflineplus">+  };</span>
<a href="#l51.150"></a><span id="l51.150" class="difflineplus">+</span>
<a href="#l51.151"></a><span id="l51.151" class="difflineplus">+  /**</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineplus">+   * Determines if the specified primitive exists.</span>
<a href="#l51.153"></a><span id="l51.153" class="difflineplus">+   *</span>
<a href="#l51.154"></a><span id="l51.154" class="difflineplus">+   * @param aElementType</span>
<a href="#l51.155"></a><span id="l51.155" class="difflineplus">+   *        The type of element to check the existence of</span>
<a href="#l51.156"></a><span id="l51.156" class="difflineplus">+   * @param aElementName</span>
<a href="#l51.157"></a><span id="l51.157" class="difflineplus">+   *        The name of the element to check for</span>
<a href="#l51.158"></a><span id="l51.158" class="difflineplus">+   * @returns true if element exists, false otherwise</span>
<a href="#l51.159"></a><span id="l51.159" class="difflineplus">+   */</span>
<a href="#l51.160"></a><span id="l51.160" class="difflineplus">+  nsresult databaseElementExists(enum DatabaseElementType aElementType,</span>
<a href="#l51.161"></a><span id="l51.161" class="difflineplus">+                                 const nsACString&amp; aElementName,</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineplus">+                                 PRBool *_exists);</span>
<a href="#l51.163"></a><span id="l51.163" class="difflineplus">+</span>
<a href="#l51.164"></a><span id="l51.164" class="difflineplus">+  bool findFunctionByInstance(nsISupports *aInstance);</span>
<a href="#l51.165"></a><span id="l51.165" class="difflineplus">+</span>
<a href="#l51.166"></a><span id="l51.166" class="difflineplus">+  static int sProgressHelper(void *aArg);</span>
<a href="#l51.167"></a><span id="l51.167" class="difflineplus">+  // Generic progress handler</span>
<a href="#l51.168"></a><span id="l51.168" class="difflineplus">+  // Dispatch call to registered progress handler,</span>
<a href="#l51.169"></a><span id="l51.169" class="difflineplus">+  // if there is one. Do nothing in other cases.</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineplus">+  int progressHandler();</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineplus">+  sqlite3 *mDBConn;</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mDatabaseFile;</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineplus">+</span>
<a href="#l51.175"></a><span id="l51.175" class="difflineplus">+  /**</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineplus">+   * Lazily created thread for asynchronous statement execution.  Consumers</span>
<a href="#l51.177"></a><span id="l51.177" class="difflineplus">+   * should use getAsyncExecutionTarget rather than directly accessing this</span>
<a href="#l51.178"></a><span id="l51.178" class="difflineplus">+   * field.</span>
<a href="#l51.179"></a><span id="l51.179" class="difflineplus">+   */</span>
<a href="#l51.180"></a><span id="l51.180" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; mAsyncExecutionThread;</span>
<a href="#l51.181"></a><span id="l51.181" class="difflineplus">+  /**</span>
<a href="#l51.182"></a><span id="l51.182" class="difflineplus">+   * Set to true by Close() prior to actually shutting down the thread.  This</span>
<a href="#l51.183"></a><span id="l51.183" class="difflineplus">+   * lets getAsyncExecutionTarget() know not to hand out any more thread</span>
<a href="#l51.184"></a><span id="l51.184" class="difflineplus">+   * references (or to create the thread in the first place).  This variable</span>
<a href="#l51.185"></a><span id="l51.185" class="difflineplus">+   * should be accessed while holding the mAsyncExecutionMutex.</span>
<a href="#l51.186"></a><span id="l51.186" class="difflineplus">+   */</span>
<a href="#l51.187"></a><span id="l51.187" class="difflineplus">+  bool mAsyncExecutionThreadShuttingDown;</span>
<a href="#l51.188"></a><span id="l51.188" class="difflineplus">+</span>
<a href="#l51.189"></a><span id="l51.189" class="difflineplus">+  /**</span>
<a href="#l51.190"></a><span id="l51.190" class="difflineplus">+   * Tracks if we have a transaction in progress or not.  Access protected by</span>
<a href="#l51.191"></a><span id="l51.191" class="difflineplus">+   * mDBMutex.</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineplus">+   */</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineplus">+  PRBool mTransactionInProgress;</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineplus">+</span>
<a href="#l51.195"></a><span id="l51.195" class="difflineplus">+  /**</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineplus">+   * Stores the mapping of a given function by name to its instance.  Access is</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+   * protected by mDBMutex.</span>
<a href="#l51.198"></a><span id="l51.198" class="difflineplus">+   */</span>
<a href="#l51.199"></a><span id="l51.199" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsISupports&gt; mFunctions;</span>
<a href="#l51.200"></a><span id="l51.200" class="difflineplus">+</span>
<a href="#l51.201"></a><span id="l51.201" class="difflineplus">+  /**</span>
<a href="#l51.202"></a><span id="l51.202" class="difflineplus">+   * Stores the registered progress handler for the database connection.  Access</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineplus">+   * is protected by mDBMutex.</span>
<a href="#l51.204"></a><span id="l51.204" class="difflineplus">+   */</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineplus">+  nsCOMPtr&lt;mozIStorageProgressHandler&gt; mProgressHandler;</span>
<a href="#l51.206"></a><span id="l51.206" class="difflineplus">+</span>
<a href="#l51.207"></a><span id="l51.207" class="difflineplus">+  // This is here for two reasons: 1) It's used to make sure that the</span>
<a href="#l51.208"></a><span id="l51.208" class="difflineplus">+  // connections do not outlive the service.  2) Our custom collating functions</span>
<a href="#l51.209"></a><span id="l51.209" class="difflineplus">+  // call its localeCompareStrings() method.</span>
<a href="#l51.210"></a><span id="l51.210" class="difflineplus">+  nsRefPtr&lt;Service&gt; mStorageService;</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineplus">+};</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineplus">+</span>
<a href="#l51.213"></a><span id="l51.213" class="difflineplus">+} // namespace storage</span>
<a href="#l51.214"></a><span id="l51.214" class="difflineplus">+} // namespace mozilla</span>
<a href="#l51.215"></a><span id="l51.215" class="difflineplus">+</span>
<a href="#l51.216"></a><span id="l51.216" class="difflineplus">+#endif /* _MOZSTORAGECONNECTION_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">new file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- /dev/null</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ b/storage-backport/src/mozStorageError.cpp</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineplus">+ *</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l52.11"></a><span id="l52.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+ *</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+ * License.</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+ *</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineplus">+ *</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+ *</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+ *</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l52.39"></a><span id="l52.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l52.40"></a><span id="l52.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l52.41"></a><span id="l52.41" class="difflineplus">+ *</span>
<a href="#l52.42"></a><span id="l52.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineplus">+</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineplus">+#include &quot;mozStorageError.h&quot;</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineplus">+namespace mozilla {</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineplus">+namespace storage {</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineplus">+</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineplus">+//// Error</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineplus">+</span>
<a href="#l52.52"></a><span id="l52.52" class="difflineplus">+Error::Error(int aResult,</span>
<a href="#l52.53"></a><span id="l52.53" class="difflineplus">+             const char *aMessage)</span>
<a href="#l52.54"></a><span id="l52.54" class="difflineplus">+: mResult(aResult)</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineplus">+, mMessage(aMessage)</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineplus">+{</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineplus">+}</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineplus">+</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineplus">+/**</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineplus">+ * Note:  This object is only ever accessed on one thread at a time.  It it not</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineplus">+ *        threadsafe, but it does need threadsafe AddRef and Release.</span>
<a href="#l52.62"></a><span id="l52.62" class="difflineplus">+ */</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineplus">+  Error,</span>
<a href="#l52.65"></a><span id="l52.65" class="difflineplus">+  mozIStorageError</span>
<a href="#l52.66"></a><span id="l52.66" class="difflineplus">+)</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineplus">+</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l52.69"></a><span id="l52.69" class="difflineplus">+//// mozIStorageError</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineplus">+</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+Error::GetResult(PRInt32 *_result)</span>
<a href="#l52.73"></a><span id="l52.73" class="difflineplus">+{</span>
<a href="#l52.74"></a><span id="l52.74" class="difflineplus">+  *_result = mResult;</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineplus">+  return NS_OK;</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineplus">+}</span>
<a href="#l52.77"></a><span id="l52.77" class="difflineplus">+</span>
<a href="#l52.78"></a><span id="l52.78" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineplus">+Error::GetMessage(nsACString &amp;_message)</span>
<a href="#l52.80"></a><span id="l52.80" class="difflineplus">+{</span>
<a href="#l52.81"></a><span id="l52.81" class="difflineplus">+  _message = mMessage;</span>
<a href="#l52.82"></a><span id="l52.82" class="difflineplus">+  return NS_OK;</span>
<a href="#l52.83"></a><span id="l52.83" class="difflineplus">+}</span>
<a href="#l52.84"></a><span id="l52.84" class="difflineplus">+</span>
<a href="#l52.85"></a><span id="l52.85" class="difflineplus">+} // namespace storage</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/storage-backport/src/mozStorageError.h</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+ *</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+ *</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+ * License.</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+ *</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+ *</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+ *</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+ *</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+ *</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+#ifndef __mozStorageError_h__</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+#define __mozStorageError_h__</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineplus">+</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+#include &quot;mozIStorageError.h&quot;</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+namespace storage {</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineplus">+class Error : public mozIStorageError</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+{</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+public:</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+  NS_DECL_MOZISTORAGEERROR</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineplus">+  Error(int aResult, const char *aMessage);</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+private:</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+  int mResult;</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+  nsCString mMessage;</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+};</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineplus">+} // namespace stoarge</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+} // namespace mozilla</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+#endif // __mozStorageError_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">new file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- /dev/null</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ b/storage-backport/src/mozStoragePrivateHelpers.cpp</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -0,0 +1,198 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+ *</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+ *</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+ * License.</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+ *</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+ *</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineplus">+ *</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineplus">+ *</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineplus">+ *</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l54.44"></a><span id="l54.44" class="difflineplus">+</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineplus">+</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineplus">+#include &quot;jsapi.h&quot;</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineplus">+#include &quot;jsdate.h&quot;</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineplus">+</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineplus">+#include &quot;nsPrintfCString.h&quot;</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineplus">+</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+#include &quot;Variant.h&quot;</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+#include &quot;mozIStorageCompletionCallback.h&quot;</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineplus">+#include &quot;mozIStorageBindingParams.h&quot;</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineplus">+</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineplus">+namespace mozilla {</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineplus">+namespace storage {</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineplus">+</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineplus">+nsresult</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineplus">+convertResultCode(int aSQLiteResultCode)</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineplus">+{</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineplus">+  switch (aSQLiteResultCode) {</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineplus">+    case SQLITE_OK:</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+    case SQLITE_ROW:</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+    case SQLITE_DONE:</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+      return NS_OK;</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+    case SQLITE_CORRUPT:</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineplus">+    case SQLITE_NOTADB:</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineplus">+      return NS_ERROR_FILE_CORRUPTED;</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineplus">+    case SQLITE_PERM:</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineplus">+    case SQLITE_CANTOPEN:</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineplus">+      return NS_ERROR_FILE_ACCESS_DENIED;</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+    case SQLITE_BUSY:</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineplus">+      return NS_ERROR_STORAGE_BUSY;</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+    case SQLITE_LOCKED:</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineplus">+      return NS_ERROR_FILE_IS_LOCKED;</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineplus">+    case SQLITE_READONLY:</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+      return NS_ERROR_FILE_READ_ONLY;</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+    case SQLITE_IOERR:</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineplus">+      return NS_ERROR_STORAGE_IOERR;</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineplus">+    case SQLITE_FULL:</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineplus">+    case SQLITE_TOOBIG:</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineplus">+      return NS_ERROR_FILE_NO_DEVICE_SPACE;</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineplus">+    case SQLITE_NOMEM:</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+    case SQLITE_MISUSE:</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineplus">+      return NS_ERROR_UNEXPECTED;</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineplus">+    case SQLITE_ABORT:</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineplus">+    case SQLITE_INTERRUPT:</span>
<a href="#l54.95"></a><span id="l54.95" class="difflineplus">+      return NS_ERROR_ABORT;</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineplus">+  }</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+  // generic error</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+}</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineplus">+</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineplus">+void</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineplus">+checkAndLogStatementPerformance(sqlite3_stmt *aStatement)</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineplus">+{</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineplus">+  // Check to see if the query performed sorting operations or not.  If it</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineplus">+  // did, it may need to be optimized!</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineplus">+  int count = ::sqlite3_stmt_status(aStatement, SQLITE_STMTSTATUS_SORT, 1);</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineplus">+  if (count &lt;= 0)</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+    return;</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineplus">+</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineplus">+  const char *sql = ::sqlite3_sql(aStatement);</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineplus">+</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineplus">+  // Check to see if this is marked to not warn</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+  if (::strstr(sql, &quot;/* do not warn (bug &quot;))</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineplus">+    return;</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineplus">+</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+  nsCAutoString message;</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+  message.AppendInt(count);</span>
<a href="#l54.119"></a><span id="l54.119" class="difflineplus">+  if (count == 1)</span>
<a href="#l54.120"></a><span id="l54.120" class="difflineplus">+    message.Append(&quot; sort operation has &quot;);</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineplus">+  else</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineplus">+    message.Append(&quot; sort operations have &quot;);</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineplus">+  message.Append(&quot;occurred for the SQL statement '&quot;);</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineplus">+  nsPrintfCString address(&quot;0x%p&quot;, aStatement);</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineplus">+  message.Append(address);</span>
<a href="#l54.126"></a><span id="l54.126" class="difflineplus">+  message.Append(&quot;'.  See https://developer.mozilla.org/En/Storage/Warnings &quot;</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineplus">+                 &quot;details.&quot;);</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineplus">+  NS_WARNING(message.get());</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineplus">+}</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+nsIVariant *</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineplus">+convertJSValToVariant(</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineplus">+  JSContext *aCtx,</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineplus">+  jsval aValue)</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineplus">+{</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineplus">+  if (JSVAL_IS_INT(aValue))</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineplus">+    return new IntegerVariant(JSVAL_TO_INT(aValue));</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineplus">+</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineplus">+  if (JSVAL_IS_DOUBLE(aValue))</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineplus">+    return new FloatVariant(*JSVAL_TO_DOUBLE(aValue));</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineplus">+</span>
<a href="#l54.142"></a><span id="l54.142" class="difflineplus">+  if (JSVAL_IS_STRING(aValue)) {</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aValue);</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineplus">+    nsDependentString value(</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineplus">+      reinterpret_cast&lt;PRUnichar *&gt;(::JS_GetStringChars(str)),</span>
<a href="#l54.146"></a><span id="l54.146" class="difflineplus">+      ::JS_GetStringLength(str)</span>
<a href="#l54.147"></a><span id="l54.147" class="difflineplus">+    );</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineplus">+    return new TextVariant(value);</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineplus">+  }</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineplus">+</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineplus">+  if (JSVAL_IS_BOOLEAN(aValue))</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineplus">+    return new IntegerVariant((aValue == JSVAL_TRUE) ? 1 : 0);</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineplus">+</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineplus">+  if (JSVAL_IS_NULL(aValue))</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineplus">+    return new NullVariant();</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineplus">+</span>
<a href="#l54.157"></a><span id="l54.157" class="difflineplus">+  if (JSVAL_IS_OBJECT(aValue)) {</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineplus">+    JSObject *obj = JSVAL_TO_OBJECT(aValue);</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+    // We only support Date instances, all others fail.</span>
<a href="#l54.160"></a><span id="l54.160" class="difflineplus">+    if (!::js_DateIsValid(aCtx, obj))</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineplus">+      return nsnull;</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineplus">+</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+    double msecd = ::js_DateGetMsecSinceEpoch(aCtx, obj);</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineplus">+    msecd *= 1000.0;</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineplus">+    PRInt64 msec;</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineplus">+    LL_D2L(msec, msecd);</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineplus">+</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineplus">+    return new IntegerVariant(msec);</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineplus">+  }</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+  return nsnull;</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineplus">+}</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineplus">+</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineplus">+</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineplus">+namespace {</span>
<a href="#l54.176"></a><span id="l54.176" class="difflineplus">+class CallbackEvent : public nsRunnable</span>
<a href="#l54.177"></a><span id="l54.177" class="difflineplus">+{</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineplus">+public:</span>
<a href="#l54.179"></a><span id="l54.179" class="difflineplus">+  CallbackEvent(mozIStorageCompletionCallback *aCallback)</span>
<a href="#l54.180"></a><span id="l54.180" class="difflineplus">+  : mCallback(aCallback)</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineplus">+  {</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineplus">+  }</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineplus">+</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineplus">+  {</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineplus">+    (void)mCallback-&gt;Complete();</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineplus">+    return NS_OK;</span>
<a href="#l54.188"></a><span id="l54.188" class="difflineplus">+  }</span>
<a href="#l54.189"></a><span id="l54.189" class="difflineplus">+private:</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineplus">+  nsCOMPtr&lt;mozIStorageCompletionCallback&gt; mCallback;</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineplus">+};</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineplus">+} // anonymous namespace</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineplus">+already_AddRefed&lt;nsIRunnable&gt;</span>
<a href="#l54.194"></a><span id="l54.194" class="difflineplus">+newCompletionEvent(mozIStorageCompletionCallback *aCallback)</span>
<a href="#l54.195"></a><span id="l54.195" class="difflineplus">+{</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineplus">+  NS_ASSERTION(aCallback, &quot;Passing a null callback is a no-no!&quot;);</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; event = new CallbackEvent(aCallback);</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineplus">+  return event.forget();</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineplus">+}</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineplus">+</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineplus">+} // namespace storage</span>
<a href="#l54.202"></a><span id="l54.202" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- /dev/null</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ b/storage-backport/src/mozStoragePrivateHelpers.h</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -0,0 +1,119 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineplus">+ *</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+ *</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+ * License.</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+ *</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+ *</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+ *</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineplus">+ *</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+ *</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+#ifndef _mozStoragePrivateHelpers_h_</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+#define _mozStoragePrivateHelpers_h_</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+/**</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+ * This file contains convenience methods for mozStorage.</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+ */</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+#include &quot;nsIVariant.h&quot;</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+#include &quot;mozStorage.h&quot;</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+#include &quot;jsapi.h&quot;</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineplus">+class mozIStorageCompletionCallback;</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineplus">+class mozIStorageBaseStatement;</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineplus">+class mozIStorageBindingParams;</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineplus">+class nsIRunnable;</span>
<a href="#l55.62"></a><span id="l55.62" class="difflineplus">+</span>
<a href="#l55.63"></a><span id="l55.63" class="difflineplus">+namespace mozilla {</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineplus">+namespace storage {</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineplus">+</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l55.67"></a><span id="l55.67" class="difflineplus">+//// Macros</span>
<a href="#l55.68"></a><span id="l55.68" class="difflineplus">+</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineplus">+#define ENSURE_INDEX_VALUE(aIndex, aCount) \</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+  NS_ENSURE_TRUE(aIndex &lt; aCount, NS_ERROR_INVALID_ARG)</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineplus">+</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+//// Functions</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+/**</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+ * Converts a SQLite return code to an nsresult return code.</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineplus">+ *</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineplus">+ * @param aSQLiteResultCode</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineplus">+ *        The SQLite return code to convert.</span>
<a href="#l55.80"></a><span id="l55.80" class="difflineplus">+ * @returns the corresponding nsresult code for aSQLiteResultCode.</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineplus">+ */</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineplus">+nsresult convertResultCode(int aSQLiteResultCode);</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineplus">+</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineplus">+/**</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+ * Checks the performance of a SQLite statement and logs a warning with</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineplus">+ * NS_WARNING.  Currently this only checks the number of sort operations done</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+ * on a statement, and if more than zero have been done, the statement can be</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+ * made faster with the careful use of an index.</span>
<a href="#l55.89"></a><span id="l55.89" class="difflineplus">+ *</span>
<a href="#l55.90"></a><span id="l55.90" class="difflineplus">+ * @param aStatement</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineplus">+ *        The sqlite3_stmt object to check.</span>
<a href="#l55.92"></a><span id="l55.92" class="difflineplus">+ */</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+void checkAndLogStatementPerformance(sqlite3_stmt *aStatement);</span>
<a href="#l55.94"></a><span id="l55.94" class="difflineplus">+</span>
<a href="#l55.95"></a><span id="l55.95" class="difflineplus">+/**</span>
<a href="#l55.96"></a><span id="l55.96" class="difflineplus">+ * Convert the provided jsval into a variant representation if possible.</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineplus">+ *</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineplus">+ * @param aCtx</span>
<a href="#l55.99"></a><span id="l55.99" class="difflineplus">+ *        The JSContext the value is from.</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineplus">+ * @param aValue</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+ *        The JavaScript value to convert.  All primitive types are supported,</span>
<a href="#l55.102"></a><span id="l55.102" class="difflineplus">+ *        but only Date objects are supported from the Date family.  Date</span>
<a href="#l55.103"></a><span id="l55.103" class="difflineplus">+ *        objects are coerced to PRTime (nanoseconds since epoch) values.</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineplus">+ * @return the variant if conversion was successful, nsnull if conversion</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineplus">+ *         failed.  The caller is responsible for addref'ing if non-null.</span>
<a href="#l55.106"></a><span id="l55.106" class="difflineplus">+ */</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineplus">+nsIVariant *convertJSValToVariant(JSContext *aCtx, jsval aValue);</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+/**</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+ * Obtains an event that will notify a completion callback about completion.</span>
<a href="#l55.111"></a><span id="l55.111" class="difflineplus">+ *</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineplus">+ * @param aCallback</span>
<a href="#l55.113"></a><span id="l55.113" class="difflineplus">+ *        The callback to be notified.</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineplus">+ * @return an nsIRunnable that can be dispatched to the calling thread.</span>
<a href="#l55.115"></a><span id="l55.115" class="difflineplus">+ */</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineplus">+already_AddRefed&lt;nsIRunnable&gt; newCompletionEvent(</span>
<a href="#l55.117"></a><span id="l55.117" class="difflineplus">+  mozIStorageCompletionCallback *aCallback</span>
<a href="#l55.118"></a><span id="l55.118" class="difflineplus">+);</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineplus">+</span>
<a href="#l55.120"></a><span id="l55.120" class="difflineplus">+} // namespace storage</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineplus">+} // namespace mozilla</span>
<a href="#l55.122"></a><span id="l55.122" class="difflineplus">+</span>
<a href="#l55.123"></a><span id="l55.123" class="difflineplus">+#endif // _mozStoragePrivateHelpers_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- /dev/null</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ b/storage-backport/src/mozStorageResultSet.cpp</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l56.8"></a><span id="l56.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineplus">+ *</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+ *</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineplus">+ * License.</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineplus">+ *</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineplus">+ *</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineplus">+ *</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineplus">+ *</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l56.37"></a><span id="l56.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineplus">+ *</span>
<a href="#l56.42"></a><span id="l56.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineplus">+</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineplus">+#include &quot;mozStorageRow.h&quot;</span>
<a href="#l56.45"></a><span id="l56.45" class="difflineplus">+#include &quot;mozStorageResultSet.h&quot;</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineplus">+</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineplus">+namespace mozilla {</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineplus">+namespace storage {</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineplus">+//// ResultSet</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineplus">+</span>
<a href="#l56.53"></a><span id="l56.53" class="difflineplus">+ResultSet::ResultSet()</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineplus">+: mCurrentIndex(0)</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineplus">+{</span>
<a href="#l56.56"></a><span id="l56.56" class="difflineplus">+}</span>
<a href="#l56.57"></a><span id="l56.57" class="difflineplus">+</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineplus">+ResultSet::~ResultSet()</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineplus">+{</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineplus">+  mData.Clear();</span>
<a href="#l56.61"></a><span id="l56.61" class="difflineplus">+}</span>
<a href="#l56.62"></a><span id="l56.62" class="difflineplus">+</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineplus">+nsresult</span>
<a href="#l56.64"></a><span id="l56.64" class="difflineplus">+ResultSet::add(mozIStorageRow *aRow)</span>
<a href="#l56.65"></a><span id="l56.65" class="difflineplus">+{</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineplus">+  return mData.AppendObject(aRow) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineplus">+}</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineplus">+</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineplus">+/**</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineplus">+ * Note:  This object is only ever accessed on one thread at a time.  It it not</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineplus">+ *        threadsafe, but it does need threadsafe AddRef and Release.</span>
<a href="#l56.72"></a><span id="l56.72" class="difflineplus">+ */</span>
<a href="#l56.73"></a><span id="l56.73" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS1(</span>
<a href="#l56.74"></a><span id="l56.74" class="difflineplus">+  ResultSet,</span>
<a href="#l56.75"></a><span id="l56.75" class="difflineplus">+  mozIStorageResultSet</span>
<a href="#l56.76"></a><span id="l56.76" class="difflineplus">+)</span>
<a href="#l56.77"></a><span id="l56.77" class="difflineplus">+</span>
<a href="#l56.78"></a><span id="l56.78" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineplus">+//// mozIStorageResultSet</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineplus">+</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineplus">+ResultSet::GetNextRow(mozIStorageRow **_row)</span>
<a href="#l56.83"></a><span id="l56.83" class="difflineplus">+{</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_row);</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineplus">+</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineplus">+  if (mCurrentIndex &gt;= mData.Count()) {</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+    // Just return null here</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+    return NS_OK;</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineplus">+  }</span>
<a href="#l56.90"></a><span id="l56.90" class="difflineplus">+</span>
<a href="#l56.91"></a><span id="l56.91" class="difflineplus">+  NS_ADDREF(*_row = mData.ObjectAt(mCurrentIndex++));</span>
<a href="#l56.92"></a><span id="l56.92" class="difflineplus">+  return NS_OK;</span>
<a href="#l56.93"></a><span id="l56.93" class="difflineplus">+}</span>
<a href="#l56.94"></a><span id="l56.94" class="difflineplus">+</span>
<a href="#l56.95"></a><span id="l56.95" class="difflineplus">+} // namespace storage</span>
<a href="#l56.96"></a><span id="l56.96" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1">new file mode 100644</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineminus">--- /dev/null</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineplus">+++ b/storage-backport/src/mozStorageResultSet.h</span>
<a href="#l57.4"></a><span id="l57.4" class="difflineat">@@ -0,0 +1,84 @@</span>
<a href="#l57.5"></a><span id="l57.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l57.6"></a><span id="l57.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l57.7"></a><span id="l57.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l57.8"></a><span id="l57.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l57.9"></a><span id="l57.9" class="difflineplus">+ *</span>
<a href="#l57.10"></a><span id="l57.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l57.11"></a><span id="l57.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+ *</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l57.16"></a><span id="l57.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineplus">+ * License.</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineplus">+ *</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+ *</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l57.26"></a><span id="l57.26" class="difflineplus">+ *</span>
<a href="#l57.27"></a><span id="l57.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l57.28"></a><span id="l57.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineplus">+ *</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineplus">+ *</span>
<a href="#l57.42"></a><span id="l57.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l57.43"></a><span id="l57.43" class="difflineplus">+</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineplus">+#ifndef __mozStorageResultSet_h__</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineplus">+#define __mozStorageResultSet_h__</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineplus">+</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineplus">+#include &quot;mozIStorageResultSet.h&quot;</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineplus">+class mozIStorageRow;</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineplus">+</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+namespace storage {</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineplus">+class ResultSet : public mozIStorageResultSet</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineplus">+{</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineplus">+public:</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineplus">+  NS_DECL_MOZISTORAGERESULTSET</span>
<a href="#l57.59"></a><span id="l57.59" class="difflineplus">+</span>
<a href="#l57.60"></a><span id="l57.60" class="difflineplus">+  ResultSet();</span>
<a href="#l57.61"></a><span id="l57.61" class="difflineplus">+  ~ResultSet();</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineplus">+</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineplus">+  /**</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineplus">+   * Adds a tuple to this result set.</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineplus">+   */</span>
<a href="#l57.66"></a><span id="l57.66" class="difflineplus">+  nsresult add(mozIStorageRow *aTuple);</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineplus">+</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineplus">+  /**</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineplus">+   * @returns the number of rows this result set holds.</span>
<a href="#l57.70"></a><span id="l57.70" class="difflineplus">+   */</span>
<a href="#l57.71"></a><span id="l57.71" class="difflineplus">+  PRInt32 rows() const { return mData.Count(); }</span>
<a href="#l57.72"></a><span id="l57.72" class="difflineplus">+</span>
<a href="#l57.73"></a><span id="l57.73" class="difflineplus">+private:</span>
<a href="#l57.74"></a><span id="l57.74" class="difflineplus">+  /**</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineplus">+   * Stores the current index of the active result set.</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineplus">+   */</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineplus">+  PRInt32 mCurrentIndex;</span>
<a href="#l57.78"></a><span id="l57.78" class="difflineplus">+</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineplus">+  /**</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineplus">+   * Stores the tuples.</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineplus">+   */</span>
<a href="#l57.82"></a><span id="l57.82" class="difflineplus">+  nsCOMArray&lt;mozIStorageRow&gt; mData;</span>
<a href="#l57.83"></a><span id="l57.83" class="difflineplus">+};</span>
<a href="#l57.84"></a><span id="l57.84" class="difflineplus">+</span>
<a href="#l57.85"></a><span id="l57.85" class="difflineplus">+} // namespace storage</span>
<a href="#l57.86"></a><span id="l57.86" class="difflineplus">+} // namespace mozilla</span>
<a href="#l57.87"></a><span id="l57.87" class="difflineplus">+</span>
<a href="#l57.88"></a><span id="l57.88" class="difflineplus">+#endif // __mozStorageResultSet_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1">new file mode 100644</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineminus">--- /dev/null</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineplus">+++ b/storage-backport/src/mozStorageRow.cpp</span>
<a href="#l58.4"></a><span id="l58.4" class="difflineat">@@ -0,0 +1,271 @@</span>
<a href="#l58.5"></a><span id="l58.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l58.6"></a><span id="l58.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l58.7"></a><span id="l58.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l58.8"></a><span id="l58.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineplus">+ *</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+ *</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineplus">+ * License.</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineplus">+ *</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineplus">+ *</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+ *</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineplus">+ *</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineplus">+ *</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineplus">+</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineplus">+</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineplus">+#include &quot;Variant.h&quot;</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineplus">+#include &quot;mozStorageRow.h&quot;</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineplus">+</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+namespace storage {</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineplus">+</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineplus">+//// Row</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineplus">+</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineplus">+nsresult</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineplus">+Row::initialize(sqlite3_stmt *aStatement)</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineplus">+{</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineplus">+  // Initialize the hash table</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineplus">+  NS_ENSURE_TRUE(mNameHashtable.Init(), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineplus">+</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineplus">+  // Get the number of results</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+  mNumCols = ::sqlite3_column_count(aStatement);</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineplus">+</span>
<a href="#l58.66"></a><span id="l58.66" class="difflineplus">+  // Start copying over values</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineplus">+  for (PRUint32 i = 0; i &lt; mNumCols; i++) {</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineplus">+    // Store the value</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineplus">+    nsIVariant *variant = nsnull;</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineplus">+    int type = ::sqlite3_column_type(aStatement, i);</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+    switch (type) {</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+      case SQLITE_INTEGER:</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+        variant = new IntegerVariant(::sqlite3_column_int64(aStatement, i));</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineplus">+        break;</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineplus">+      case SQLITE_FLOAT:</span>
<a href="#l58.76"></a><span id="l58.76" class="difflineplus">+        variant = new FloatVariant(::sqlite3_column_double(aStatement, i));</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineplus">+        break;</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineplus">+      case SQLITE_TEXT:</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineplus">+      {</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineplus">+        nsDependentString str(</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+          static_cast&lt;const PRUnichar *&gt;(::sqlite3_column_text16(aStatement, i))</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineplus">+        );</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineplus">+        variant = new TextVariant(str);</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+        break;</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineplus">+      }</span>
<a href="#l58.86"></a><span id="l58.86" class="difflineplus">+      case SQLITE_NULL:</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineplus">+        variant = new NullVariant();</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineplus">+        break;</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineplus">+      case SQLITE_BLOB:</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineplus">+      {</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineplus">+        int size = ::sqlite3_column_bytes(aStatement, i);</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineplus">+        const void *data = ::sqlite3_column_blob(aStatement, i);</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineplus">+        variant = new BlobVariant(std::pair&lt;const void *, int&gt;(data, size));</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineplus">+        break;</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineplus">+      }</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineplus">+      default:</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineplus">+    }</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineplus">+    NS_ENSURE_TRUE(variant, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineplus">+</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineplus">+    // Insert into our storage array</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+    NS_ENSURE_TRUE(mData.InsertObjectAt(variant, i), NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineplus">+    // Associate the name (if any) with the index</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineplus">+    const char *name = ::sqlite3_column_name(aStatement, i);</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineplus">+    if (!name) break;</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+    nsCAutoString colName(name);</span>
<a href="#l58.108"></a><span id="l58.108" class="difflineplus">+    mNameHashtable.Put(colName, i);</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineplus">+  }</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineplus">+</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+  return NS_OK;</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+}</span>
<a href="#l58.113"></a><span id="l58.113" class="difflineplus">+</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineplus">+/**</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineplus">+ * Note:  This object is only ever accessed on one thread at a time.  It it not</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineplus">+ *        threadsafe, but it does need threadsafe AddRef and Release.</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineplus">+ */</span>
<a href="#l58.118"></a><span id="l58.118" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineplus">+  Row,</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineplus">+  mozIStorageRow,</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+  mozIStorageValueArray</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineplus">+)</span>
<a href="#l58.123"></a><span id="l58.123" class="difflineplus">+</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineplus">+//// mozIStorageRow</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineplus">+</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.128"></a><span id="l58.128" class="difflineplus">+Row::GetResultByIndex(PRUint32 aIndex,</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineplus">+                      nsIVariant **_result)</span>
<a href="#l58.130"></a><span id="l58.130" class="difflineplus">+{</span>
<a href="#l58.131"></a><span id="l58.131" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.132"></a><span id="l58.132" class="difflineplus">+  NS_ADDREF(*_result = mData.ObjectAt(aIndex));</span>
<a href="#l58.133"></a><span id="l58.133" class="difflineplus">+  return NS_OK;</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineplus">+}</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineplus">+</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.137"></a><span id="l58.137" class="difflineplus">+Row::GetResultByName(const nsACString &amp;aName,</span>
<a href="#l58.138"></a><span id="l58.138" class="difflineplus">+                     nsIVariant **_result)</span>
<a href="#l58.139"></a><span id="l58.139" class="difflineplus">+{</span>
<a href="#l58.140"></a><span id="l58.140" class="difflineplus">+  PRUint32 index;</span>
<a href="#l58.141"></a><span id="l58.141" class="difflineplus">+  NS_ENSURE_TRUE(mNameHashtable.Get(aName, &amp;index), NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineplus">+  return GetResultByIndex(index, _result);</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineplus">+}</span>
<a href="#l58.144"></a><span id="l58.144" class="difflineplus">+</span>
<a href="#l58.145"></a><span id="l58.145" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l58.146"></a><span id="l58.146" class="difflineplus">+//// mozIStorageValueArray</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineplus">+</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineplus">+Row::GetNumEntries(PRUint32 *_entries)</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineplus">+{</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineplus">+  *_entries = mNumCols;</span>
<a href="#l58.152"></a><span id="l58.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineplus">+}</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineplus">+</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.156"></a><span id="l58.156" class="difflineplus">+Row::GetTypeOfIndex(PRUint32 aIndex,</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineplus">+                    PRInt32 *_type)</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineplus">+{</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.160"></a><span id="l58.160" class="difflineplus">+</span>
<a href="#l58.161"></a><span id="l58.161" class="difflineplus">+  PRUint16 type;</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineplus">+  (void)mData.ObjectAt(aIndex)-&gt;GetDataType(&amp;type);</span>
<a href="#l58.163"></a><span id="l58.163" class="difflineplus">+  switch (type) {</span>
<a href="#l58.164"></a><span id="l58.164" class="difflineplus">+    case nsIDataType::VTYPE_INT32:</span>
<a href="#l58.165"></a><span id="l58.165" class="difflineplus">+    case nsIDataType::VTYPE_INT64:</span>
<a href="#l58.166"></a><span id="l58.166" class="difflineplus">+      *_type = mozIStorageValueArray::VALUE_TYPE_INTEGER;</span>
<a href="#l58.167"></a><span id="l58.167" class="difflineplus">+      break;</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineplus">+    case nsIDataType::VTYPE_DOUBLE:</span>
<a href="#l58.169"></a><span id="l58.169" class="difflineplus">+      *_type = mozIStorageValueArray::VALUE_TYPE_FLOAT;</span>
<a href="#l58.170"></a><span id="l58.170" class="difflineplus">+      break;</span>
<a href="#l58.171"></a><span id="l58.171" class="difflineplus">+    case nsIDataType::VTYPE_ASTRING:</span>
<a href="#l58.172"></a><span id="l58.172" class="difflineplus">+      *_type = mozIStorageValueArray::VALUE_TYPE_TEXT;</span>
<a href="#l58.173"></a><span id="l58.173" class="difflineplus">+      break;</span>
<a href="#l58.174"></a><span id="l58.174" class="difflineplus">+    case nsIDataType::VTYPE_ARRAY:</span>
<a href="#l58.175"></a><span id="l58.175" class="difflineplus">+      *_type = mozIStorageValueArray::VALUE_TYPE_BLOB;</span>
<a href="#l58.176"></a><span id="l58.176" class="difflineplus">+      break;</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineplus">+    default:</span>
<a href="#l58.178"></a><span id="l58.178" class="difflineplus">+      *_type = mozIStorageValueArray::VALUE_TYPE_NULL;</span>
<a href="#l58.179"></a><span id="l58.179" class="difflineplus">+      break;</span>
<a href="#l58.180"></a><span id="l58.180" class="difflineplus">+  }</span>
<a href="#l58.181"></a><span id="l58.181" class="difflineplus">+  return NS_OK;</span>
<a href="#l58.182"></a><span id="l58.182" class="difflineplus">+}</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineplus">+</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineplus">+Row::GetInt32(PRUint32 aIndex,</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineplus">+              PRInt32 *_value)</span>
<a href="#l58.187"></a><span id="l58.187" class="difflineplus">+{</span>
<a href="#l58.188"></a><span id="l58.188" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.189"></a><span id="l58.189" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsInt32(_value);</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineplus">+}</span>
<a href="#l58.191"></a><span id="l58.191" class="difflineplus">+</span>
<a href="#l58.192"></a><span id="l58.192" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineplus">+Row::GetInt64(PRUint32 aIndex,</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineplus">+              PRInt64 *_value)</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+{</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.197"></a><span id="l58.197" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsInt64(_value);</span>
<a href="#l58.198"></a><span id="l58.198" class="difflineplus">+}</span>
<a href="#l58.199"></a><span id="l58.199" class="difflineplus">+</span>
<a href="#l58.200"></a><span id="l58.200" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.201"></a><span id="l58.201" class="difflineplus">+Row::GetDouble(PRUint32 aIndex,</span>
<a href="#l58.202"></a><span id="l58.202" class="difflineplus">+               double *_value)</span>
<a href="#l58.203"></a><span id="l58.203" class="difflineplus">+{</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.205"></a><span id="l58.205" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsDouble(_value);</span>
<a href="#l58.206"></a><span id="l58.206" class="difflineplus">+}</span>
<a href="#l58.207"></a><span id="l58.207" class="difflineplus">+</span>
<a href="#l58.208"></a><span id="l58.208" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineplus">+Row::GetUTF8String(PRUint32 aIndex,</span>
<a href="#l58.210"></a><span id="l58.210" class="difflineplus">+                   nsACString &amp;_value)</span>
<a href="#l58.211"></a><span id="l58.211" class="difflineplus">+{</span>
<a href="#l58.212"></a><span id="l58.212" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.213"></a><span id="l58.213" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsAUTF8String(_value);</span>
<a href="#l58.214"></a><span id="l58.214" class="difflineplus">+}</span>
<a href="#l58.215"></a><span id="l58.215" class="difflineplus">+</span>
<a href="#l58.216"></a><span id="l58.216" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.217"></a><span id="l58.217" class="difflineplus">+Row::GetString(PRUint32 aIndex,</span>
<a href="#l58.218"></a><span id="l58.218" class="difflineplus">+               nsAString &amp;_value)</span>
<a href="#l58.219"></a><span id="l58.219" class="difflineplus">+{</span>
<a href="#l58.220"></a><span id="l58.220" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.221"></a><span id="l58.221" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsAString(_value);</span>
<a href="#l58.222"></a><span id="l58.222" class="difflineplus">+}</span>
<a href="#l58.223"></a><span id="l58.223" class="difflineplus">+</span>
<a href="#l58.224"></a><span id="l58.224" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.225"></a><span id="l58.225" class="difflineplus">+Row::GetBlob(PRUint32 aIndex,</span>
<a href="#l58.226"></a><span id="l58.226" class="difflineplus">+             PRUint32 *_size,</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineplus">+             PRUint8 **_blob)</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineplus">+{</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.230"></a><span id="l58.230" class="difflineplus">+</span>
<a href="#l58.231"></a><span id="l58.231" class="difflineplus">+  PRUint16 type;</span>
<a href="#l58.232"></a><span id="l58.232" class="difflineplus">+  nsIID interfaceIID;</span>
<a href="#l58.233"></a><span id="l58.233" class="difflineplus">+  return mData.ObjectAt(aIndex)-&gt;GetAsArray(&amp;type, &amp;interfaceIID, _size,</span>
<a href="#l58.234"></a><span id="l58.234" class="difflineplus">+                                            reinterpret_cast&lt;void **&gt;(_blob));</span>
<a href="#l58.235"></a><span id="l58.235" class="difflineplus">+}</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineplus">+</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.238"></a><span id="l58.238" class="difflineplus">+Row::GetIsNull(PRUint32 aIndex,</span>
<a href="#l58.239"></a><span id="l58.239" class="difflineplus">+               PRBool *_isNull)</span>
<a href="#l58.240"></a><span id="l58.240" class="difflineplus">+{</span>
<a href="#l58.241"></a><span id="l58.241" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mNumCols);</span>
<a href="#l58.242"></a><span id="l58.242" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_isNull);</span>
<a href="#l58.243"></a><span id="l58.243" class="difflineplus">+</span>
<a href="#l58.244"></a><span id="l58.244" class="difflineplus">+  PRUint16 type;</span>
<a href="#l58.245"></a><span id="l58.245" class="difflineplus">+  (void)mData.ObjectAt(aIndex)-&gt;GetDataType(&amp;type);</span>
<a href="#l58.246"></a><span id="l58.246" class="difflineplus">+  *_isNull = type == nsIDataType::VTYPE_EMPTY;</span>
<a href="#l58.247"></a><span id="l58.247" class="difflineplus">+  return NS_OK;</span>
<a href="#l58.248"></a><span id="l58.248" class="difflineplus">+}</span>
<a href="#l58.249"></a><span id="l58.249" class="difflineplus">+</span>
<a href="#l58.250"></a><span id="l58.250" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.251"></a><span id="l58.251" class="difflineplus">+Row::GetSharedUTF8String(PRUint32,</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineplus">+                         PRUint32 *,</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineplus">+                         char const **)</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineplus">+{</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.256"></a><span id="l58.256" class="difflineplus">+}</span>
<a href="#l58.257"></a><span id="l58.257" class="difflineplus">+</span>
<a href="#l58.258"></a><span id="l58.258" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.259"></a><span id="l58.259" class="difflineplus">+Row::GetSharedString(PRUint32,</span>
<a href="#l58.260"></a><span id="l58.260" class="difflineplus">+                     PRUint32 *,</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineplus">+                     const PRUnichar **)</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineplus">+{</span>
<a href="#l58.263"></a><span id="l58.263" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.264"></a><span id="l58.264" class="difflineplus">+}</span>
<a href="#l58.265"></a><span id="l58.265" class="difflineplus">+</span>
<a href="#l58.266"></a><span id="l58.266" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.267"></a><span id="l58.267" class="difflineplus">+Row::GetSharedBlob(PRUint32,</span>
<a href="#l58.268"></a><span id="l58.268" class="difflineplus">+                   PRUint32 *,</span>
<a href="#l58.269"></a><span id="l58.269" class="difflineplus">+                   const PRUint8 **)</span>
<a href="#l58.270"></a><span id="l58.270" class="difflineplus">+{</span>
<a href="#l58.271"></a><span id="l58.271" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.272"></a><span id="l58.272" class="difflineplus">+}</span>
<a href="#l58.273"></a><span id="l58.273" class="difflineplus">+</span>
<a href="#l58.274"></a><span id="l58.274" class="difflineplus">+} // namespace storage</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1">new file mode 100644</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineminus">--- /dev/null</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineplus">+++ b/storage-backport/src/mozStorageRow.h</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineat">@@ -0,0 +1,88 @@</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l59.6"></a><span id="l59.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l59.7"></a><span id="l59.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l59.8"></a><span id="l59.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l59.9"></a><span id="l59.9" class="difflineplus">+ *</span>
<a href="#l59.10"></a><span id="l59.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l59.11"></a><span id="l59.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+ *</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+ * License.</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+ *</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineplus">+ *</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineplus">+ *</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l59.29"></a><span id="l59.29" class="difflineplus">+ *</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+ *</span>
<a href="#l59.42"></a><span id="l59.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineplus">+</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+#ifndef __mozStorageRow_h__</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineplus">+#define __mozStorageRow_h__</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineplus">+#include &quot;mozIStorageRow.h&quot;</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l59.49"></a><span id="l59.49" class="difflineplus">+#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineplus">+class nsIVariant;</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineplus">+</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineplus">+namespace mozilla {</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+namespace storage {</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+class Row : public mozIStorageRow</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+{</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+public:</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineplus">+  NS_DECL_MOZISTORAGEROW</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineplus">+  NS_DECL_MOZISTORAGEVALUEARRAY</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineplus">+  /**</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+   * Initializes the object with the given statement.  Copies the values from</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+   * the statement.</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+   *</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+   * @param aStatement</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineplus">+   *        The sqlite statement to pull results from.</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+   */</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+  nsresult initialize(sqlite3_stmt *aStatement);</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+private:</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+  /**</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+   * The number of columns in this tuple.</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+   */</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+  PRUint32 mNumCols;</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineplus">+</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+  /**</span>
<a href="#l59.79"></a><span id="l59.79" class="difflineplus">+   * Stores the data in the tuple.</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineplus">+   */</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+  nsCOMArray&lt;nsIVariant&gt; mData;</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineplus">+  /**</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+   * Maps a given name to a column index.</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+   */</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineplus">+  nsDataHashtable&lt;nsCStringHashKey, PRUint32&gt; mNameHashtable;</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+};</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineplus">+</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineplus">+} // namespace storage</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineplus">+} // namespace mozilla</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+#endif // __mozStorageRow_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1">new file mode 100644</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineminus">--- /dev/null</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineplus">+++ b/storage-backport/src/mozStorageSQLFunctions.cpp</span>
<a href="#l60.4"></a><span id="l60.4" class="difflineat">@@ -0,0 +1,483 @@</span>
<a href="#l60.5"></a><span id="l60.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l60.6"></a><span id="l60.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l60.7"></a><span id="l60.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l60.8"></a><span id="l60.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l60.9"></a><span id="l60.9" class="difflineplus">+ *</span>
<a href="#l60.10"></a><span id="l60.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l60.11"></a><span id="l60.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+ *</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+ * License.</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+ *</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+ * The Original Code is unicode functions code.</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+ *</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+ *</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+ * This code is based off of icu.c from the sqlite code</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+ * whose original author is danielk1977</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+ *</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+ * Contributor(s):</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+ *</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+ *</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+#include &quot;mozStorageSQLFunctions.h&quot;</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+namespace storage {</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+//// Local Helper Functions</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+namespace {</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+/**</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+ * Performs the LIKE comparison of a string against a pattern.  For more detail</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+ * see http://www.sqlite.org/lang_expr.html#like.</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineplus">+ *</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineplus">+ * @param aPatternItr</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+ *        An iterator at the start of the pattern to check for.</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+ * @param aPatternEnd</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+ *        An iterator at the end of the pattern to check for.</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+ * @param aStringItr</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+ *        An iterator at the start of the string to check for the pattern.</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineplus">+ * @param aStringEnd</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineplus">+ *        An iterator at the end of the string to check for the pattern.</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+ * @param aEscapeChar</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+ *        The character to use for escaping symbols in the pattern.</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+ * @return 1 if the pattern is found, 0 otherwise.</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+ */</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+int</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+likeCompare(nsAString::const_iterator aPatternItr,</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+            nsAString::const_iterator aPatternEnd,</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+            nsAString::const_iterator aStringItr,</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+            nsAString::const_iterator aStringEnd,</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+            PRUnichar aEscapeChar)</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+{</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+  const PRUnichar MATCH_ALL('%');</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+  const PRUnichar MATCH_ONE('_');</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+  PRBool lastWasEscape = PR_FALSE;</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+  while (aPatternItr != aPatternEnd) {</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+    /**</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+     * What we do in here is take a look at each character from the input</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineplus">+     * pattern, and do something with it.  There are 4 possibilities:</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+     * 1) character is an un-escaped match-all character</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+     * 2) character is an un-escaped match-one character</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+     * 3) character is an un-escaped escape character</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+     * 4) character is not any of the above</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+     */</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+    if (!lastWasEscape &amp;&amp; *aPatternItr == MATCH_ALL) {</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+      // CASE 1</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+      /**</span>
<a href="#l60.97"></a><span id="l60.97" class="difflineplus">+       * Now we need to skip any MATCH_ALL or MATCH_ONE characters that follow a</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineplus">+       * MATCH_ALL character.  For each MATCH_ONE character, skip one character</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+       * in the pattern string.</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineplus">+       */</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineplus">+      while (*aPatternItr == MATCH_ALL || *aPatternItr == MATCH_ONE) {</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+        if (*aPatternItr == MATCH_ONE) {</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineplus">+          // If we've hit the end of the string we are testing, no match</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+          if (aStringItr == aStringEnd)</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+            return 0;</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+          aStringItr++;</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineplus">+        }</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineplus">+        aPatternItr++;</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+      }</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineplus">+</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineplus">+      // If we've hit the end of the pattern string, match</span>
<a href="#l60.112"></a><span id="l60.112" class="difflineplus">+      if (aPatternItr == aPatternEnd)</span>
<a href="#l60.113"></a><span id="l60.113" class="difflineplus">+        return 1;</span>
<a href="#l60.114"></a><span id="l60.114" class="difflineplus">+</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+      while (aStringItr != aStringEnd) {</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineplus">+        if (likeCompare(aPatternItr, aPatternEnd, aStringItr, aStringEnd,</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineplus">+                        aEscapeChar)) {</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+          // we've hit a match, so indicate this</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineplus">+          return 1;</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+        }</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineplus">+        aStringItr++;</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineplus">+      }</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineplus">+</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineplus">+      // No match</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+      return 0;</span>
<a href="#l60.126"></a><span id="l60.126" class="difflineplus">+    }</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineplus">+    else if (!lastWasEscape &amp;&amp; *aPatternItr == MATCH_ONE) {</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineplus">+      // CASE 2</span>
<a href="#l60.129"></a><span id="l60.129" class="difflineplus">+      if (aStringItr == aStringEnd) {</span>
<a href="#l60.130"></a><span id="l60.130" class="difflineplus">+        // If we've hit the end of the string we are testing, no match</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineplus">+        return 0;</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineplus">+      }</span>
<a href="#l60.133"></a><span id="l60.133" class="difflineplus">+      aStringItr++;</span>
<a href="#l60.134"></a><span id="l60.134" class="difflineplus">+      lastWasEscape = PR_FALSE;</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineplus">+    }</span>
<a href="#l60.136"></a><span id="l60.136" class="difflineplus">+    else if (!lastWasEscape &amp;&amp; *aPatternItr == aEscapeChar) {</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineplus">+      // CASE 3</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineplus">+      lastWasEscape = PR_TRUE;</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineplus">+    }</span>
<a href="#l60.140"></a><span id="l60.140" class="difflineplus">+    else {</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineplus">+      // CASE 4</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineplus">+      if (::ToUpperCase(*aStringItr) != ::ToUpperCase(*aPatternItr)) {</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+        // If we've hit a point where the strings don't match, there is no match</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineplus">+        return 0;</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineplus">+      }</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+      aStringItr++;</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineplus">+      lastWasEscape = PR_FALSE;</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineplus">+    }</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+    aPatternItr++;</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+  }</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+  return aStringItr == aStringEnd;</span>
<a href="#l60.154"></a><span id="l60.154" class="difflineplus">+}</span>
<a href="#l60.155"></a><span id="l60.155" class="difflineplus">+</span>
<a href="#l60.156"></a><span id="l60.156" class="difflineplus">+/**</span>
<a href="#l60.157"></a><span id="l60.157" class="difflineplus">+ * This class manages a dynamic array.  It can represent an array of any </span>
<a href="#l60.158"></a><span id="l60.158" class="difflineplus">+ * reasonable size, but if the array is &quot;N&quot; elements or smaller, it will be</span>
<a href="#l60.159"></a><span id="l60.159" class="difflineplus">+ * stored using fixed space inside the auto array itself.  If the auto array</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineplus">+ * is a local variable, this internal storage will be allocated cheaply on the</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineplus">+ * stack, similar to nsAutoString.  If a larger size is requested, the memory</span>
<a href="#l60.162"></a><span id="l60.162" class="difflineplus">+ * will be dynamically allocated from the heap.  Since the destructor will</span>
<a href="#l60.163"></a><span id="l60.163" class="difflineplus">+ * free any heap-allocated memory, client code doesn't need to care where the</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineplus">+ * memory came from.</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineplus">+ */</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineplus">+template &lt;class T, size_t N&gt; class AutoArray</span>
<a href="#l60.167"></a><span id="l60.167" class="difflineplus">+{</span>
<a href="#l60.168"></a><span id="l60.168" class="difflineplus">+</span>
<a href="#l60.169"></a><span id="l60.169" class="difflineplus">+public:</span>
<a href="#l60.170"></a><span id="l60.170" class="difflineplus">+</span>
<a href="#l60.171"></a><span id="l60.171" class="difflineplus">+  AutoArray(size_t size)</span>
<a href="#l60.172"></a><span id="l60.172" class="difflineplus">+  : mBuffer(size &lt;= N ? mAutoBuffer : new T[size])</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineplus">+  {</span>
<a href="#l60.174"></a><span id="l60.174" class="difflineplus">+  }</span>
<a href="#l60.175"></a><span id="l60.175" class="difflineplus">+</span>
<a href="#l60.176"></a><span id="l60.176" class="difflineplus">+  ~AutoArray()</span>
<a href="#l60.177"></a><span id="l60.177" class="difflineplus">+  { </span>
<a href="#l60.178"></a><span id="l60.178" class="difflineplus">+    if (mBuffer != mAutoBuffer)</span>
<a href="#l60.179"></a><span id="l60.179" class="difflineplus">+      delete[] mBuffer; </span>
<a href="#l60.180"></a><span id="l60.180" class="difflineplus">+  }</span>
<a href="#l60.181"></a><span id="l60.181" class="difflineplus">+</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineplus">+  /**</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineplus">+   * Return the pointer to the allocated array.</span>
<a href="#l60.184"></a><span id="l60.184" class="difflineplus">+   * @note If the array allocation failed, get() will return NULL!</span>
<a href="#l60.185"></a><span id="l60.185" class="difflineplus">+   *</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+   * @return the pointer to the allocated array</span>
<a href="#l60.187"></a><span id="l60.187" class="difflineplus">+   */</span>
<a href="#l60.188"></a><span id="l60.188" class="difflineplus">+  T *get() </span>
<a href="#l60.189"></a><span id="l60.189" class="difflineplus">+  {</span>
<a href="#l60.190"></a><span id="l60.190" class="difflineplus">+    return mBuffer; </span>
<a href="#l60.191"></a><span id="l60.191" class="difflineplus">+  }</span>
<a href="#l60.192"></a><span id="l60.192" class="difflineplus">+</span>
<a href="#l60.193"></a><span id="l60.193" class="difflineplus">+private:</span>
<a href="#l60.194"></a><span id="l60.194" class="difflineplus">+  T *mBuffer;           // Points to mAutoBuffer if we can use it, heap otherwise.</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineplus">+  T mAutoBuffer[N];     // The internal memory buffer that we use if we can.</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineplus">+};</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+</span>
<a href="#l60.198"></a><span id="l60.198" class="difflineplus">+/**</span>
<a href="#l60.199"></a><span id="l60.199" class="difflineplus">+ * Compute the Levenshtein Edit Distance between two strings.</span>
<a href="#l60.200"></a><span id="l60.200" class="difflineplus">+ * </span>
<a href="#l60.201"></a><span id="l60.201" class="difflineplus">+ * @param aStringS</span>
<a href="#l60.202"></a><span id="l60.202" class="difflineplus">+ *        a string</span>
<a href="#l60.203"></a><span id="l60.203" class="difflineplus">+ * @param aStringT</span>
<a href="#l60.204"></a><span id="l60.204" class="difflineplus">+ *        another string</span>
<a href="#l60.205"></a><span id="l60.205" class="difflineplus">+ * @param _result</span>
<a href="#l60.206"></a><span id="l60.206" class="difflineplus">+ *        an outparam that will receive the edit distance between the arguments</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineplus">+ * @return a Sqlite result code, e.g. SQLITE_OK, SQLITE_NOMEM, etc.</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineplus">+ */</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineplus">+int</span>
<a href="#l60.210"></a><span id="l60.210" class="difflineplus">+levenshteinDistance(const nsAString &amp;aStringS,</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineplus">+                    const nsAString &amp;aStringT,</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+                    int *_result)</span>
<a href="#l60.213"></a><span id="l60.213" class="difflineplus">+{</span>
<a href="#l60.214"></a><span id="l60.214" class="difflineplus">+    // Set the result to a non-sensical value in case we encounter an error.</span>
<a href="#l60.215"></a><span id="l60.215" class="difflineplus">+    *_result = -1;</span>
<a href="#l60.216"></a><span id="l60.216" class="difflineplus">+</span>
<a href="#l60.217"></a><span id="l60.217" class="difflineplus">+    const PRUint32 sLen = aStringS.Length();</span>
<a href="#l60.218"></a><span id="l60.218" class="difflineplus">+    const PRUint32 tLen = aStringT.Length();</span>
<a href="#l60.219"></a><span id="l60.219" class="difflineplus">+</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineplus">+    if (sLen == 0) {</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineplus">+      *_result = tLen;</span>
<a href="#l60.222"></a><span id="l60.222" class="difflineplus">+      return SQLITE_OK;</span>
<a href="#l60.223"></a><span id="l60.223" class="difflineplus">+    }</span>
<a href="#l60.224"></a><span id="l60.224" class="difflineplus">+    if (tLen == 0) {</span>
<a href="#l60.225"></a><span id="l60.225" class="difflineplus">+      *_result = sLen;</span>
<a href="#l60.226"></a><span id="l60.226" class="difflineplus">+      return SQLITE_OK;</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+    }</span>
<a href="#l60.228"></a><span id="l60.228" class="difflineplus">+</span>
<a href="#l60.229"></a><span id="l60.229" class="difflineplus">+    // Notionally, Levenshtein Distance is computed in a matrix.  If we </span>
<a href="#l60.230"></a><span id="l60.230" class="difflineplus">+    // assume s = &quot;span&quot; and t = &quot;spam&quot;, the matrix would look like this:</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+    //    s --&gt;</span>
<a href="#l60.232"></a><span id="l60.232" class="difflineplus">+    //  t          s   p   a   n</span>
<a href="#l60.233"></a><span id="l60.233" class="difflineplus">+    //  |      0   1   2   3   4</span>
<a href="#l60.234"></a><span id="l60.234" class="difflineplus">+    //  V  s   1   *   *   *   *</span>
<a href="#l60.235"></a><span id="l60.235" class="difflineplus">+    //     p   2   *   *   *   *</span>
<a href="#l60.236"></a><span id="l60.236" class="difflineplus">+    //     a   3   *   *   *   *</span>
<a href="#l60.237"></a><span id="l60.237" class="difflineplus">+    //     m   4   *   *   *   *</span>
<a href="#l60.238"></a><span id="l60.238" class="difflineplus">+    //</span>
<a href="#l60.239"></a><span id="l60.239" class="difflineplus">+    // Note that the row width is sLen + 1 and the column height is tLen + 1,</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineplus">+    // where sLen is the length of the string &quot;s&quot; and tLen is the length of &quot;t&quot;.</span>
<a href="#l60.241"></a><span id="l60.241" class="difflineplus">+    // The first row and the first column are initialized as shown, and</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineplus">+    // the algorithm computes the remaining cells row-by-row, and</span>
<a href="#l60.243"></a><span id="l60.243" class="difflineplus">+    // left-to-right within each row.  The computation only requires that</span>
<a href="#l60.244"></a><span id="l60.244" class="difflineplus">+    // we be able to see the current row and the previous one.</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineplus">+</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineplus">+    // Allocate memory for two rows.  Use AutoArray's to manage the memory</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineplus">+    // so we don't have to explicitly free it, and so we can avoid the expense</span>
<a href="#l60.248"></a><span id="l60.248" class="difflineplus">+    // of memory allocations for relatively small strings.</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineplus">+    AutoArray&lt;int, nsAutoString::kDefaultStorageSize&gt; row1(sLen + 1);</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+    AutoArray&lt;int, nsAutoString::kDefaultStorageSize&gt; row2(sLen + 1);</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+</span>
<a href="#l60.252"></a><span id="l60.252" class="difflineplus">+    // Declare the raw pointers that will actually be used to access the memory.</span>
<a href="#l60.253"></a><span id="l60.253" class="difflineplus">+    int *prevRow = row1.get();</span>
<a href="#l60.254"></a><span id="l60.254" class="difflineplus">+    NS_ENSURE_TRUE(prevRow, SQLITE_NOMEM);</span>
<a href="#l60.255"></a><span id="l60.255" class="difflineplus">+    int *currRow = row2.get();</span>
<a href="#l60.256"></a><span id="l60.256" class="difflineplus">+    NS_ENSURE_TRUE(currRow, SQLITE_NOMEM);</span>
<a href="#l60.257"></a><span id="l60.257" class="difflineplus">+</span>
<a href="#l60.258"></a><span id="l60.258" class="difflineplus">+    // Initialize the first row.</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineplus">+    for (PRUint32 i = 0; i &lt;= sLen; i++)</span>
<a href="#l60.260"></a><span id="l60.260" class="difflineplus">+        prevRow[i] = i;</span>
<a href="#l60.261"></a><span id="l60.261" class="difflineplus">+</span>
<a href="#l60.262"></a><span id="l60.262" class="difflineplus">+    const PRUnichar *s = aStringS.BeginReading();</span>
<a href="#l60.263"></a><span id="l60.263" class="difflineplus">+    const PRUnichar *t = aStringT.BeginReading();</span>
<a href="#l60.264"></a><span id="l60.264" class="difflineplus">+</span>
<a href="#l60.265"></a><span id="l60.265" class="difflineplus">+    // Compute the empty cells in the &quot;matrix&quot; row-by-row, starting with</span>
<a href="#l60.266"></a><span id="l60.266" class="difflineplus">+    // the second row.</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineplus">+    for (PRUint32 ti = 1; ti &lt;= tLen; ti++) {</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineplus">+</span>
<a href="#l60.269"></a><span id="l60.269" class="difflineplus">+        // Initialize the first cell in this row.</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineplus">+        currRow[0] = ti;</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineplus">+</span>
<a href="#l60.272"></a><span id="l60.272" class="difflineplus">+        // Get the character from &quot;t&quot; that corresponds to this row.</span>
<a href="#l60.273"></a><span id="l60.273" class="difflineplus">+        const PRUnichar tch = t[ti - 1];</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineplus">+</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+        // Compute the remaining cells in this row, left-to-right,</span>
<a href="#l60.276"></a><span id="l60.276" class="difflineplus">+        // starting at the second column (and first character of &quot;s&quot;).</span>
<a href="#l60.277"></a><span id="l60.277" class="difflineplus">+        for (PRUint32 si = 1; si &lt;= sLen; si++) {</span>
<a href="#l60.278"></a><span id="l60.278" class="difflineplus">+            </span>
<a href="#l60.279"></a><span id="l60.279" class="difflineplus">+            // Get the character from &quot;s&quot; that corresponds to this column,</span>
<a href="#l60.280"></a><span id="l60.280" class="difflineplus">+            // compare it to the t-character, and compute the &quot;cost&quot;.</span>
<a href="#l60.281"></a><span id="l60.281" class="difflineplus">+            const PRUnichar sch = s[si - 1];</span>
<a href="#l60.282"></a><span id="l60.282" class="difflineplus">+            int cost = (sch == tch) ? 0 : 1;</span>
<a href="#l60.283"></a><span id="l60.283" class="difflineplus">+</span>
<a href="#l60.284"></a><span id="l60.284" class="difflineplus">+            // ............ We want to calculate the value of cell &quot;d&quot; from</span>
<a href="#l60.285"></a><span id="l60.285" class="difflineplus">+            // ...ab....... the previously calculated (or initialized) cells</span>
<a href="#l60.286"></a><span id="l60.286" class="difflineplus">+            // ...cd....... &quot;a&quot;, &quot;b&quot;, and &quot;c&quot;, where d = min(a', b', c').</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineplus">+            // ............ </span>
<a href="#l60.288"></a><span id="l60.288" class="difflineplus">+            int aPrime = prevRow[si - 1] + cost;</span>
<a href="#l60.289"></a><span id="l60.289" class="difflineplus">+            int bPrime = prevRow[si] + 1;</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineplus">+            int cPrime = currRow[si - 1] + 1;</span>
<a href="#l60.291"></a><span id="l60.291" class="difflineplus">+            currRow[si] = NS_MIN(aPrime, NS_MIN(bPrime, cPrime));</span>
<a href="#l60.292"></a><span id="l60.292" class="difflineplus">+        }</span>
<a href="#l60.293"></a><span id="l60.293" class="difflineplus">+</span>
<a href="#l60.294"></a><span id="l60.294" class="difflineplus">+        // Advance to the next row.  The current row becomes the previous</span>
<a href="#l60.295"></a><span id="l60.295" class="difflineplus">+        // row and we recycle the old previous row as the new current row.</span>
<a href="#l60.296"></a><span id="l60.296" class="difflineplus">+        // We don't need to re-initialize the new current row since we will</span>
<a href="#l60.297"></a><span id="l60.297" class="difflineplus">+        // rewrite all of its cells anyway.</span>
<a href="#l60.298"></a><span id="l60.298" class="difflineplus">+        int *oldPrevRow = prevRow;</span>
<a href="#l60.299"></a><span id="l60.299" class="difflineplus">+        prevRow = currRow;</span>
<a href="#l60.300"></a><span id="l60.300" class="difflineplus">+        currRow = oldPrevRow;</span>
<a href="#l60.301"></a><span id="l60.301" class="difflineplus">+    }</span>
<a href="#l60.302"></a><span id="l60.302" class="difflineplus">+</span>
<a href="#l60.303"></a><span id="l60.303" class="difflineplus">+    // The final result is the value of the last cell in the last row.</span>
<a href="#l60.304"></a><span id="l60.304" class="difflineplus">+    // Note that that's now in the &quot;previous&quot; row, since we just swapped them.</span>
<a href="#l60.305"></a><span id="l60.305" class="difflineplus">+    *_result = prevRow[sLen];</span>
<a href="#l60.306"></a><span id="l60.306" class="difflineplus">+    return SQLITE_OK;</span>
<a href="#l60.307"></a><span id="l60.307" class="difflineplus">+}</span>
<a href="#l60.308"></a><span id="l60.308" class="difflineplus">+</span>
<a href="#l60.309"></a><span id="l60.309" class="difflineplus">+} // anonymous namespace</span>
<a href="#l60.310"></a><span id="l60.310" class="difflineplus">+</span>
<a href="#l60.311"></a><span id="l60.311" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l60.312"></a><span id="l60.312" class="difflineplus">+//// Exposed Functions</span>
<a href="#l60.313"></a><span id="l60.313" class="difflineplus">+</span>
<a href="#l60.314"></a><span id="l60.314" class="difflineplus">+int</span>
<a href="#l60.315"></a><span id="l60.315" class="difflineplus">+registerFunctions(sqlite3 *aDB)</span>
<a href="#l60.316"></a><span id="l60.316" class="difflineplus">+{</span>
<a href="#l60.317"></a><span id="l60.317" class="difflineplus">+  struct Functions {</span>
<a href="#l60.318"></a><span id="l60.318" class="difflineplus">+    const char *zName;</span>
<a href="#l60.319"></a><span id="l60.319" class="difflineplus">+    int nArg;</span>
<a href="#l60.320"></a><span id="l60.320" class="difflineplus">+    int enc;</span>
<a href="#l60.321"></a><span id="l60.321" class="difflineplus">+    void *pContext;</span>
<a href="#l60.322"></a><span id="l60.322" class="difflineplus">+    void (*xFunc)(::sqlite3_context*, int, sqlite3_value**);</span>
<a href="#l60.323"></a><span id="l60.323" class="difflineplus">+  };</span>
<a href="#l60.324"></a><span id="l60.324" class="difflineplus">+  </span>
<a href="#l60.325"></a><span id="l60.325" class="difflineplus">+  Functions functions[] = {</span>
<a href="#l60.326"></a><span id="l60.326" class="difflineplus">+    {&quot;lower&quot;,               </span>
<a href="#l60.327"></a><span id="l60.327" class="difflineplus">+      1, </span>
<a href="#l60.328"></a><span id="l60.328" class="difflineplus">+      SQLITE_UTF16, </span>
<a href="#l60.329"></a><span id="l60.329" class="difflineplus">+      0,        </span>
<a href="#l60.330"></a><span id="l60.330" class="difflineplus">+      caseFunction},</span>
<a href="#l60.331"></a><span id="l60.331" class="difflineplus">+    {&quot;lower&quot;,               </span>
<a href="#l60.332"></a><span id="l60.332" class="difflineplus">+      1, </span>
<a href="#l60.333"></a><span id="l60.333" class="difflineplus">+      SQLITE_UTF8,  </span>
<a href="#l60.334"></a><span id="l60.334" class="difflineplus">+      0,        </span>
<a href="#l60.335"></a><span id="l60.335" class="difflineplus">+      caseFunction},</span>
<a href="#l60.336"></a><span id="l60.336" class="difflineplus">+    {&quot;upper&quot;,               </span>
<a href="#l60.337"></a><span id="l60.337" class="difflineplus">+      1, </span>
<a href="#l60.338"></a><span id="l60.338" class="difflineplus">+      SQLITE_UTF16, </span>
<a href="#l60.339"></a><span id="l60.339" class="difflineplus">+      (void*)1, </span>
<a href="#l60.340"></a><span id="l60.340" class="difflineplus">+      caseFunction},</span>
<a href="#l60.341"></a><span id="l60.341" class="difflineplus">+    {&quot;upper&quot;,               </span>
<a href="#l60.342"></a><span id="l60.342" class="difflineplus">+      1, </span>
<a href="#l60.343"></a><span id="l60.343" class="difflineplus">+      SQLITE_UTF8,  </span>
<a href="#l60.344"></a><span id="l60.344" class="difflineplus">+      (void*)1, </span>
<a href="#l60.345"></a><span id="l60.345" class="difflineplus">+      caseFunction},</span>
<a href="#l60.346"></a><span id="l60.346" class="difflineplus">+</span>
<a href="#l60.347"></a><span id="l60.347" class="difflineplus">+    {&quot;like&quot;,                </span>
<a href="#l60.348"></a><span id="l60.348" class="difflineplus">+      2, </span>
<a href="#l60.349"></a><span id="l60.349" class="difflineplus">+      SQLITE_UTF16, </span>
<a href="#l60.350"></a><span id="l60.350" class="difflineplus">+      0,        </span>
<a href="#l60.351"></a><span id="l60.351" class="difflineplus">+      likeFunction},</span>
<a href="#l60.352"></a><span id="l60.352" class="difflineplus">+    {&quot;like&quot;,                </span>
<a href="#l60.353"></a><span id="l60.353" class="difflineplus">+      2, </span>
<a href="#l60.354"></a><span id="l60.354" class="difflineplus">+      SQLITE_UTF8,  </span>
<a href="#l60.355"></a><span id="l60.355" class="difflineplus">+      0,        </span>
<a href="#l60.356"></a><span id="l60.356" class="difflineplus">+      likeFunction},</span>
<a href="#l60.357"></a><span id="l60.357" class="difflineplus">+    {&quot;like&quot;,                </span>
<a href="#l60.358"></a><span id="l60.358" class="difflineplus">+      3, </span>
<a href="#l60.359"></a><span id="l60.359" class="difflineplus">+      SQLITE_UTF16, </span>
<a href="#l60.360"></a><span id="l60.360" class="difflineplus">+      0,        </span>
<a href="#l60.361"></a><span id="l60.361" class="difflineplus">+      likeFunction},</span>
<a href="#l60.362"></a><span id="l60.362" class="difflineplus">+    {&quot;like&quot;,                </span>
<a href="#l60.363"></a><span id="l60.363" class="difflineplus">+      3, </span>
<a href="#l60.364"></a><span id="l60.364" class="difflineplus">+      SQLITE_UTF8,  </span>
<a href="#l60.365"></a><span id="l60.365" class="difflineplus">+      0,        </span>
<a href="#l60.366"></a><span id="l60.366" class="difflineplus">+      likeFunction},</span>
<a href="#l60.367"></a><span id="l60.367" class="difflineplus">+</span>
<a href="#l60.368"></a><span id="l60.368" class="difflineplus">+    {&quot;levenshteinDistance&quot;, </span>
<a href="#l60.369"></a><span id="l60.369" class="difflineplus">+      2, </span>
<a href="#l60.370"></a><span id="l60.370" class="difflineplus">+      SQLITE_UTF16, </span>
<a href="#l60.371"></a><span id="l60.371" class="difflineplus">+      0,        </span>
<a href="#l60.372"></a><span id="l60.372" class="difflineplus">+      levenshteinDistanceFunction},</span>
<a href="#l60.373"></a><span id="l60.373" class="difflineplus">+    {&quot;levenshteinDistance&quot;, </span>
<a href="#l60.374"></a><span id="l60.374" class="difflineplus">+      2, </span>
<a href="#l60.375"></a><span id="l60.375" class="difflineplus">+      SQLITE_UTF8,  </span>
<a href="#l60.376"></a><span id="l60.376" class="difflineplus">+      0,        </span>
<a href="#l60.377"></a><span id="l60.377" class="difflineplus">+      levenshteinDistanceFunction},</span>
<a href="#l60.378"></a><span id="l60.378" class="difflineplus">+  };</span>
<a href="#l60.379"></a><span id="l60.379" class="difflineplus">+</span>
<a href="#l60.380"></a><span id="l60.380" class="difflineplus">+  int rv = SQLITE_OK;</span>
<a href="#l60.381"></a><span id="l60.381" class="difflineplus">+  for (size_t i = 0; SQLITE_OK == rv &amp;&amp; i &lt; NS_ARRAY_LENGTH(functions); ++i) {</span>
<a href="#l60.382"></a><span id="l60.382" class="difflineplus">+    struct Functions *p = &amp;functions[i];</span>
<a href="#l60.383"></a><span id="l60.383" class="difflineplus">+    rv = ::sqlite3_create_function(aDB, p-&gt;zName, p-&gt;nArg, p-&gt;enc, p-&gt;pContext,</span>
<a href="#l60.384"></a><span id="l60.384" class="difflineplus">+                                   p-&gt;xFunc, NULL, NULL);</span>
<a href="#l60.385"></a><span id="l60.385" class="difflineplus">+  }</span>
<a href="#l60.386"></a><span id="l60.386" class="difflineplus">+</span>
<a href="#l60.387"></a><span id="l60.387" class="difflineplus">+  return rv;</span>
<a href="#l60.388"></a><span id="l60.388" class="difflineplus">+}</span>
<a href="#l60.389"></a><span id="l60.389" class="difflineplus">+</span>
<a href="#l60.390"></a><span id="l60.390" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l60.391"></a><span id="l60.391" class="difflineplus">+//// SQL Functions</span>
<a href="#l60.392"></a><span id="l60.392" class="difflineplus">+</span>
<a href="#l60.393"></a><span id="l60.393" class="difflineplus">+void</span>
<a href="#l60.394"></a><span id="l60.394" class="difflineplus">+caseFunction(sqlite3_context *aCtx,</span>
<a href="#l60.395"></a><span id="l60.395" class="difflineplus">+             int aArgc,</span>
<a href="#l60.396"></a><span id="l60.396" class="difflineplus">+             sqlite3_value **aArgv)</span>
<a href="#l60.397"></a><span id="l60.397" class="difflineplus">+{</span>
<a href="#l60.398"></a><span id="l60.398" class="difflineplus">+  NS_ASSERTION(1 == aArgc, &quot;Invalid number of arguments!&quot;);</span>
<a href="#l60.399"></a><span id="l60.399" class="difflineplus">+</span>
<a href="#l60.400"></a><span id="l60.400" class="difflineplus">+  nsAutoString data(static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[0])));</span>
<a href="#l60.401"></a><span id="l60.401" class="difflineplus">+  PRBool toUpper = ::sqlite3_user_data(aCtx) ? PR_TRUE : PR_FALSE;</span>
<a href="#l60.402"></a><span id="l60.402" class="difflineplus">+</span>
<a href="#l60.403"></a><span id="l60.403" class="difflineplus">+  if (toUpper)</span>
<a href="#l60.404"></a><span id="l60.404" class="difflineplus">+    ::ToUpperCase(data);</span>
<a href="#l60.405"></a><span id="l60.405" class="difflineplus">+  else</span>
<a href="#l60.406"></a><span id="l60.406" class="difflineplus">+    ::ToLowerCase(data);</span>
<a href="#l60.407"></a><span id="l60.407" class="difflineplus">+</span>
<a href="#l60.408"></a><span id="l60.408" class="difflineplus">+  // Set the result.</span>
<a href="#l60.409"></a><span id="l60.409" class="difflineplus">+  ::sqlite3_result_text16(aCtx, data.get(), -1, SQLITE_TRANSIENT);</span>
<a href="#l60.410"></a><span id="l60.410" class="difflineplus">+}</span>
<a href="#l60.411"></a><span id="l60.411" class="difflineplus">+</span>
<a href="#l60.412"></a><span id="l60.412" class="difflineplus">+/**</span>
<a href="#l60.413"></a><span id="l60.413" class="difflineplus">+ * This implements the like() SQL function.  This is used by the LIKE operator.</span>
<a href="#l60.414"></a><span id="l60.414" class="difflineplus">+ * The SQL statement 'A LIKE B' is implemented as 'like(B, A)', and if there is</span>
<a href="#l60.415"></a><span id="l60.415" class="difflineplus">+ * an escape character, say E, it is implemented as 'like(B, A, E)'.</span>
<a href="#l60.416"></a><span id="l60.416" class="difflineplus">+ */</span>
<a href="#l60.417"></a><span id="l60.417" class="difflineplus">+void</span>
<a href="#l60.418"></a><span id="l60.418" class="difflineplus">+likeFunction(sqlite3_context *aCtx,</span>
<a href="#l60.419"></a><span id="l60.419" class="difflineplus">+             int aArgc,</span>
<a href="#l60.420"></a><span id="l60.420" class="difflineplus">+             sqlite3_value **aArgv)</span>
<a href="#l60.421"></a><span id="l60.421" class="difflineplus">+{</span>
<a href="#l60.422"></a><span id="l60.422" class="difflineplus">+  NS_ASSERTION(2 == aArgc || 3 == aArgc, &quot;Invalid number of arguments!&quot;);</span>
<a href="#l60.423"></a><span id="l60.423" class="difflineplus">+</span>
<a href="#l60.424"></a><span id="l60.424" class="difflineplus">+  if (::sqlite3_value_bytes(aArgv[0]) &gt; SQLITE_MAX_LIKE_PATTERN_LENGTH) {</span>
<a href="#l60.425"></a><span id="l60.425" class="difflineplus">+    ::sqlite3_result_error(aCtx, &quot;LIKE or GLOB pattern too complex&quot;,</span>
<a href="#l60.426"></a><span id="l60.426" class="difflineplus">+                           SQLITE_TOOBIG);</span>
<a href="#l60.427"></a><span id="l60.427" class="difflineplus">+    return;</span>
<a href="#l60.428"></a><span id="l60.428" class="difflineplus">+  }</span>
<a href="#l60.429"></a><span id="l60.429" class="difflineplus">+</span>
<a href="#l60.430"></a><span id="l60.430" class="difflineplus">+  if (!::sqlite3_value_text16(aArgv[0]) || !::sqlite3_value_text16(aArgv[1]))</span>
<a href="#l60.431"></a><span id="l60.431" class="difflineplus">+    return;</span>
<a href="#l60.432"></a><span id="l60.432" class="difflineplus">+</span>
<a href="#l60.433"></a><span id="l60.433" class="difflineplus">+  nsDependentString A(static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[1])));</span>
<a href="#l60.434"></a><span id="l60.434" class="difflineplus">+  nsDependentString B(static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[0])));</span>
<a href="#l60.435"></a><span id="l60.435" class="difflineplus">+  NS_ASSERTION(!B.IsEmpty(), &quot;LIKE string must not be null!&quot;);</span>
<a href="#l60.436"></a><span id="l60.436" class="difflineplus">+</span>
<a href="#l60.437"></a><span id="l60.437" class="difflineplus">+  PRUnichar E = 0;</span>
<a href="#l60.438"></a><span id="l60.438" class="difflineplus">+  if (3 == aArgc)</span>
<a href="#l60.439"></a><span id="l60.439" class="difflineplus">+    E = static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[2]))[0];</span>
<a href="#l60.440"></a><span id="l60.440" class="difflineplus">+</span>
<a href="#l60.441"></a><span id="l60.441" class="difflineplus">+  nsAString::const_iterator itrString, endString;</span>
<a href="#l60.442"></a><span id="l60.442" class="difflineplus">+  A.BeginReading(itrString);</span>
<a href="#l60.443"></a><span id="l60.443" class="difflineplus">+  A.EndReading(endString);</span>
<a href="#l60.444"></a><span id="l60.444" class="difflineplus">+  nsAString::const_iterator itrPattern, endPattern;</span>
<a href="#l60.445"></a><span id="l60.445" class="difflineplus">+  B.BeginReading(itrPattern);</span>
<a href="#l60.446"></a><span id="l60.446" class="difflineplus">+  B.EndReading(endPattern);</span>
<a href="#l60.447"></a><span id="l60.447" class="difflineplus">+  ::sqlite3_result_int(aCtx, likeCompare(itrPattern, endPattern, itrString,</span>
<a href="#l60.448"></a><span id="l60.448" class="difflineplus">+                                         endString, E));</span>
<a href="#l60.449"></a><span id="l60.449" class="difflineplus">+}</span>
<a href="#l60.450"></a><span id="l60.450" class="difflineplus">+</span>
<a href="#l60.451"></a><span id="l60.451" class="difflineplus">+void levenshteinDistanceFunction(sqlite3_context *aCtx,</span>
<a href="#l60.452"></a><span id="l60.452" class="difflineplus">+                                 int aArgc,</span>
<a href="#l60.453"></a><span id="l60.453" class="difflineplus">+                                 sqlite3_value **aArgv)</span>
<a href="#l60.454"></a><span id="l60.454" class="difflineplus">+{</span>
<a href="#l60.455"></a><span id="l60.455" class="difflineplus">+  NS_ASSERTION(2 == aArgc, &quot;Invalid number of arguments!&quot;);</span>
<a href="#l60.456"></a><span id="l60.456" class="difflineplus">+</span>
<a href="#l60.457"></a><span id="l60.457" class="difflineplus">+  // If either argument is a SQL NULL, then return SQL NULL.</span>
<a href="#l60.458"></a><span id="l60.458" class="difflineplus">+  if (::sqlite3_value_type(aArgv[0]) == SQLITE_NULL ||</span>
<a href="#l60.459"></a><span id="l60.459" class="difflineplus">+      ::sqlite3_value_type(aArgv[1]) == SQLITE_NULL) {</span>
<a href="#l60.460"></a><span id="l60.460" class="difflineplus">+    ::sqlite3_result_null(aCtx);</span>
<a href="#l60.461"></a><span id="l60.461" class="difflineplus">+    return;</span>
<a href="#l60.462"></a><span id="l60.462" class="difflineplus">+  }</span>
<a href="#l60.463"></a><span id="l60.463" class="difflineplus">+</span>
<a href="#l60.464"></a><span id="l60.464" class="difflineplus">+  int aLen = ::sqlite3_value_bytes16(aArgv[0]) / sizeof(PRUnichar);</span>
<a href="#l60.465"></a><span id="l60.465" class="difflineplus">+  const PRUnichar *a = static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[0]));</span>
<a href="#l60.466"></a><span id="l60.466" class="difflineplus">+</span>
<a href="#l60.467"></a><span id="l60.467" class="difflineplus">+  int bLen = ::sqlite3_value_bytes16(aArgv[1]) / sizeof(PRUnichar);</span>
<a href="#l60.468"></a><span id="l60.468" class="difflineplus">+  const PRUnichar *b = static_cast&lt;const PRUnichar *&gt;(::sqlite3_value_text16(aArgv[1]));</span>
<a href="#l60.469"></a><span id="l60.469" class="difflineplus">+</span>
<a href="#l60.470"></a><span id="l60.470" class="difflineplus">+  // Compute the Levenshtein Distance, and return the result (or error).</span>
<a href="#l60.471"></a><span id="l60.471" class="difflineplus">+  int distance = -1;</span>
<a href="#l60.472"></a><span id="l60.472" class="difflineplus">+  const nsDependentString A(a, aLen);</span>
<a href="#l60.473"></a><span id="l60.473" class="difflineplus">+  const nsDependentString B(b, bLen);</span>
<a href="#l60.474"></a><span id="l60.474" class="difflineplus">+  int status = levenshteinDistance(A, B, &amp;distance);</span>
<a href="#l60.475"></a><span id="l60.475" class="difflineplus">+  if (status == SQLITE_OK) {</span>
<a href="#l60.476"></a><span id="l60.476" class="difflineplus">+    ::sqlite3_result_int(aCtx, distance);    </span>
<a href="#l60.477"></a><span id="l60.477" class="difflineplus">+  }</span>
<a href="#l60.478"></a><span id="l60.478" class="difflineplus">+  else if (status == SQLITE_NOMEM) {</span>
<a href="#l60.479"></a><span id="l60.479" class="difflineplus">+    ::sqlite3_result_error_nomem(aCtx);</span>
<a href="#l60.480"></a><span id="l60.480" class="difflineplus">+  }</span>
<a href="#l60.481"></a><span id="l60.481" class="difflineplus">+  else {</span>
<a href="#l60.482"></a><span id="l60.482" class="difflineplus">+    ::sqlite3_result_error(aCtx, &quot;User function returned error code&quot;, -1);</span>
<a href="#l60.483"></a><span id="l60.483" class="difflineplus">+  }</span>
<a href="#l60.484"></a><span id="l60.484" class="difflineplus">+}</span>
<a href="#l60.485"></a><span id="l60.485" class="difflineplus">+</span>
<a href="#l60.486"></a><span id="l60.486" class="difflineplus">+} // namespace storage</span>
<a href="#l60.487"></a><span id="l60.487" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">new file mode 100644</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineminus">--- /dev/null</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineplus">+++ b/storage-backport/src/mozStorageSQLFunctions.h</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineat">@@ -0,0 +1,109 @@</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l61.7"></a><span id="l61.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l61.9"></a><span id="l61.9" class="difflineplus">+ *</span>
<a href="#l61.10"></a><span id="l61.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l61.11"></a><span id="l61.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+ *</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+ * License.</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+ *</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+ * The Original Code is unicode functions code.</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+ *</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+ *</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineplus">+ *</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+ *</span>
<a href="#l61.42"></a><span id="l61.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineplus">+</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+#ifndef _mozStorageSQLFunctions_h_</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineplus">+#define _mozStorageSQLFunctions_h_</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineplus">+</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineplus">+</span>
<a href="#l61.50"></a><span id="l61.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l61.51"></a><span id="l61.51" class="difflineplus">+namespace storage {</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineplus">+</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+/**</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+ * Registers the functions declared here with the specified database.</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+ *</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+ * @param aDB</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+ *        The database we'll be registering the functions with.</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+ * @return the SQLite status code indicating success or failure.</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+ */</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineplus">+NS_HIDDEN_(int) registerFunctions(sqlite3 *aDB);</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineplus">+</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+//// Predefined Functions</span>
<a href="#l61.64"></a><span id="l61.64" class="difflineplus">+</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+/**</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineplus">+ * Overridden function to perform the SQL functions UPPER and LOWER.  These</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineplus">+ * support unicode, which the default implementations do not do.</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineplus">+ *</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineplus">+ * @param aCtx</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineplus">+ *        The sqlite_context that this function is being called on.</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineplus">+ * @param aArgc</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+ *        The number of arguments the function is being called with.</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+ * @param aArgv</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineplus">+ *        An array of the arguments the functions is being called with.</span>
<a href="#l61.75"></a><span id="l61.75" class="difflineplus">+ */</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineplus">+NS_HIDDEN_(void) caseFunction(sqlite3_context *aCtx,</span>
<a href="#l61.77"></a><span id="l61.77" class="difflineplus">+                              int aArgc,</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineplus">+                              sqlite3_value **aArgv);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+/**</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+ * Overridden function to perform the SQL function LIKE.  This supports unicode,</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineplus">+ * which the default implementation does not do.</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineplus">+ *</span>
<a href="#l61.84"></a><span id="l61.84" class="difflineplus">+ * @param aCtx</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineplus">+ *        The sqlite_context that this function is being called on.</span>
<a href="#l61.86"></a><span id="l61.86" class="difflineplus">+ * @param aArgc</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineplus">+ *        The number of arguments the function is being called with.</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineplus">+ * @param aArgv</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineplus">+ *        An array of the arguments the functions is being called with.</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+ */</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineplus">+NS_HIDDEN_(void) likeFunction(sqlite3_context *aCtx,</span>
<a href="#l61.92"></a><span id="l61.92" class="difflineplus">+                              int aArgc,</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineplus">+                              sqlite3_value **aArgv);</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineplus">+</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineplus">+/**</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineplus">+ * An implementation of the Levenshtein Edit Distance algorithm for use in</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineplus">+ * Sqlite queries.</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineplus">+ * </span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+ * @param aCtx</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineplus">+ *        The sqlite_context that this function is being called on.</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+ * @param aArgc</span>
<a href="#l61.102"></a><span id="l61.102" class="difflineplus">+ *        The number of arguments the function is being called with.</span>
<a href="#l61.103"></a><span id="l61.103" class="difflineplus">+ * @param aArgv</span>
<a href="#l61.104"></a><span id="l61.104" class="difflineplus">+ *        An array of the arguments the functions is being called with.</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineplus">+ */</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+NS_HIDDEN_(void) levenshteinDistanceFunction(sqlite3_context *aCtx,</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineplus">+                                             int aArgc,</span>
<a href="#l61.108"></a><span id="l61.108" class="difflineplus">+                                             sqlite3_value **aArgv);</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineplus">+</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineplus">+} // namespace storage</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+} // namespace mozilla</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineplus">+</span>
<a href="#l61.113"></a><span id="l61.113" class="difflineplus">+#endif // _mozStorageSQLFunctions_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">new file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- /dev/null</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ b/storage-backport/src/mozStorageService.cpp</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -0,0 +1,388 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineplus">+ *</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+ *</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+ * License.</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+ *</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+ *</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineplus">+ *</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+ *   Brett Wilson &lt;brettw@gmail.com&gt;</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+ *</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+ *</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineplus">+#include &quot;prinit.h&quot;</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+#include &quot;nsCollationCID.h&quot;</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+#include &quot;nsEmbedCID.h&quot;</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+#include &quot;nsILocale.h&quot;</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+#include &quot;nsILocaleService.h&quot;</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+#include &quot;nsIXPConnect.h&quot;</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+#include &quot;nsIObserverService.h&quot;</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+#include &quot;nsIPromptService.h&quot;</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+namespace mozilla {</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+namespace storage {</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+//// Service</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+  Service,</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+  mozIStorageService,</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+  nsIObserver</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+)</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+Service *Service::gService = nsnull;</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+Service *</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+Service::getSingleton()</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+{</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+  if (gService) {</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+    NS_ADDREF(gService);</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+    return gService;</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+  }</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+  // Ensure that we are using the same version of SQLite that we compiled with</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+  // or newer.  Our configure check ensures we are using a new enough version</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+  // at compile time.</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+  if (SQLITE_VERSION_NUMBER &gt; ::sqlite3_libversion_number()) {</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+    nsCOMPtr&lt;nsIPromptService&gt; ps(do_GetService(NS_PROMPTSERVICE_CONTRACTID));</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+    if (ps) {</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+      nsAutoString title, message;</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+      title.AppendASCII(&quot;SQLite Version Error&quot;);</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+      message.AppendASCII(&quot;The application has been updated, but your version &quot;</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+                          &quot;of SQLite is too old and the application cannot &quot;</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+                          &quot;run.&quot;);</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+      (void)ps-&gt;Alert(nsnull, title.get(), message.get());</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+    }</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+    ::PR_Abort();</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+  }</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+  gService = new Service();</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+  if (gService) {</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+    NS_ADDREF(gService);</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+    if (NS_FAILED(gService-&gt;initialize()))</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+      NS_RELEASE(gService);</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+  }</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+  return gService;</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+}</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+nsIXPConnect *Service::sXPConnect = nsnull;</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+already_AddRefed&lt;nsIXPConnect&gt;</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+Service::getXPConnect()</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+{</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+  NS_ASSERTION(gService,</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+               &quot;Can not get XPConnect without an instance of our service!&quot;);</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+  // If we've been shutdown, sXPConnect will be null.  To prevent leaks, we do</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+  // not cache the service after this point.</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+  nsCOMPtr&lt;nsIXPConnect&gt; xpc(sXPConnect);</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+  if (!xpc)</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+    xpc = do_GetService(nsIXPConnect::GetCID());</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+  NS_ASSERTION(xpc, &quot;Could not get XPConnect!&quot;);</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineplus">+  return xpc.forget();</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+}</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineplus">+</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+Service::Service()</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+: mMutex(&quot;Service::mMutex&quot;)</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+{</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+}</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+Service::~Service()</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+{</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineplus">+  // Shutdown the sqlite3 API.  Warn if shutdown did not turn out okay, but</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+  // there is nothing actionable we can do in that case.</span>
<a href="#l62.137"></a><span id="l62.137" class="difflineplus">+  int rc = ::sqlite3_shutdown();</span>
<a href="#l62.138"></a><span id="l62.138" class="difflineplus">+  if (rc != SQLITE_OK)</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineplus">+    NS_WARNING(&quot;sqlite3 did not shutdown cleanly.&quot;);</span>
<a href="#l62.140"></a><span id="l62.140" class="difflineplus">+</span>
<a href="#l62.141"></a><span id="l62.141" class="difflineplus">+  gService = nsnull;</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineplus">+}</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+</span>
<a href="#l62.144"></a><span id="l62.144" class="difflineplus">+void</span>
<a href="#l62.145"></a><span id="l62.145" class="difflineplus">+Service::shutdown()</span>
<a href="#l62.146"></a><span id="l62.146" class="difflineplus">+{</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineplus">+  NS_IF_RELEASE(sXPConnect);</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineplus">+}</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+</span>
<a href="#l62.150"></a><span id="l62.150" class="difflineplus">+nsresult</span>
<a href="#l62.151"></a><span id="l62.151" class="difflineplus">+Service::initialize()</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineplus">+{</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+  // Disable memory allocation statistic collection, improving performance.</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+  // This must be done prior to a call to sqlite3_initialize to have any</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+  // effect.</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+  int rc = ::sqlite3_config(SQLITE_CONFIG_MEMSTATUS, 0);</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+  if (rc != SQLITE_OK)</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+    return convertResultCode(rc);</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+  // Explicitly initialize sqlite3.  Although this is implicitly called by</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+  // various sqlite3 functions (and the sqlite3_open calls in our case),</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+  // the documentation suggests calling this directly.  So we do.</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+  rc = ::sqlite3_initialize();</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+  if (rc != SQLITE_OK)</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+    return convertResultCode(rc);</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+  // This makes multiple connections to the same database share the same pager</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+  // cache.  We do not need to lock here with mMutex because this function is</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+  // only ever called from Service::GetSingleton, which will only</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+  // call this function once, and will not return until this function returns.</span>
<a href="#l62.171"></a><span id="l62.171" class="difflineplus">+  // (It does not matter where this is called relative to sqlite3_initialize.)</span>
<a href="#l62.172"></a><span id="l62.172" class="difflineplus">+  rc = ::sqlite3_enable_shared_cache(1);</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineplus">+  if (rc != SQLITE_OK)</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineplus">+    return convertResultCode(rc);</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+</span>
<a href="#l62.176"></a><span id="l62.176" class="difflineplus">+  nsCOMPtr&lt;nsIObserverService&gt; os =</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineplus">+    do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineplus">+  NS_ENSURE_TRUE(os, NS_ERROR_FAILURE);</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineplus">+</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineplus">+  nsresult rv = os-&gt;AddObserver(this, &quot;xpcom-shutdown&quot;, PR_FALSE);</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.182"></a><span id="l62.182" class="difflineplus">+</span>
<a href="#l62.183"></a><span id="l62.183" class="difflineplus">+  // We cache XPConnect for our language helpers.</span>
<a href="#l62.184"></a><span id="l62.184" class="difflineplus">+  (void)CallGetService(nsIXPConnect::GetCID(), &amp;sXPConnect);</span>
<a href="#l62.185"></a><span id="l62.185" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineplus">+}</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+</span>
<a href="#l62.188"></a><span id="l62.188" class="difflineplus">+int</span>
<a href="#l62.189"></a><span id="l62.189" class="difflineplus">+Service::localeCompareStrings(const nsAString &amp;aStr1,</span>
<a href="#l62.190"></a><span id="l62.190" class="difflineplus">+                              const nsAString &amp;aStr2,</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineplus">+                              PRInt32 aComparisonStrength)</span>
<a href="#l62.192"></a><span id="l62.192" class="difflineplus">+{</span>
<a href="#l62.193"></a><span id="l62.193" class="difflineplus">+  // The implementation of nsICollation.CompareString() is platform-dependent.</span>
<a href="#l62.194"></a><span id="l62.194" class="difflineplus">+  // On Linux it's not thread-safe.  It may not be on Windows and OS X either,</span>
<a href="#l62.195"></a><span id="l62.195" class="difflineplus">+  // but it's more difficult to tell.  We therefore synchronize this method.</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineplus">+  MutexAutoLock mutex(mMutex);</span>
<a href="#l62.197"></a><span id="l62.197" class="difflineplus">+</span>
<a href="#l62.198"></a><span id="l62.198" class="difflineplus">+  nsICollation *coll = getLocaleCollation();</span>
<a href="#l62.199"></a><span id="l62.199" class="difflineplus">+  if (!coll) {</span>
<a href="#l62.200"></a><span id="l62.200" class="difflineplus">+    NS_ERROR(&quot;Storage service has no collation&quot;);</span>
<a href="#l62.201"></a><span id="l62.201" class="difflineplus">+    return 0;</span>
<a href="#l62.202"></a><span id="l62.202" class="difflineplus">+  }</span>
<a href="#l62.203"></a><span id="l62.203" class="difflineplus">+</span>
<a href="#l62.204"></a><span id="l62.204" class="difflineplus">+  PRInt32 res;</span>
<a href="#l62.205"></a><span id="l62.205" class="difflineplus">+  nsresult rv = coll-&gt;CompareString(aComparisonStrength, aStr1, aStr2, &amp;res);</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineplus">+    NS_ERROR(&quot;Collation compare string failed&quot;);</span>
<a href="#l62.208"></a><span id="l62.208" class="difflineplus">+    return 0;</span>
<a href="#l62.209"></a><span id="l62.209" class="difflineplus">+  }</span>
<a href="#l62.210"></a><span id="l62.210" class="difflineplus">+</span>
<a href="#l62.211"></a><span id="l62.211" class="difflineplus">+  return res;</span>
<a href="#l62.212"></a><span id="l62.212" class="difflineplus">+}</span>
<a href="#l62.213"></a><span id="l62.213" class="difflineplus">+</span>
<a href="#l62.214"></a><span id="l62.214" class="difflineplus">+nsICollation *</span>
<a href="#l62.215"></a><span id="l62.215" class="difflineplus">+Service::getLocaleCollation()</span>
<a href="#l62.216"></a><span id="l62.216" class="difflineplus">+{</span>
<a href="#l62.217"></a><span id="l62.217" class="difflineplus">+  mMutex.AssertCurrentThreadOwns();</span>
<a href="#l62.218"></a><span id="l62.218" class="difflineplus">+</span>
<a href="#l62.219"></a><span id="l62.219" class="difflineplus">+  if (mLocaleCollation)</span>
<a href="#l62.220"></a><span id="l62.220" class="difflineplus">+    return mLocaleCollation;</span>
<a href="#l62.221"></a><span id="l62.221" class="difflineplus">+</span>
<a href="#l62.222"></a><span id="l62.222" class="difflineplus">+  nsCOMPtr&lt;nsILocaleService&gt; svc(do_GetService(NS_LOCALESERVICE_CONTRACTID));</span>
<a href="#l62.223"></a><span id="l62.223" class="difflineplus">+  if (!svc) {</span>
<a href="#l62.224"></a><span id="l62.224" class="difflineplus">+    NS_WARNING(&quot;Could not get locale service&quot;);</span>
<a href="#l62.225"></a><span id="l62.225" class="difflineplus">+    return nsnull;</span>
<a href="#l62.226"></a><span id="l62.226" class="difflineplus">+  }</span>
<a href="#l62.227"></a><span id="l62.227" class="difflineplus">+</span>
<a href="#l62.228"></a><span id="l62.228" class="difflineplus">+  nsCOMPtr&lt;nsILocale&gt; appLocale;</span>
<a href="#l62.229"></a><span id="l62.229" class="difflineplus">+  nsresult rv = svc-&gt;GetApplicationLocale(getter_AddRefs(appLocale));</span>
<a href="#l62.230"></a><span id="l62.230" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l62.231"></a><span id="l62.231" class="difflineplus">+    NS_WARNING(&quot;Could not get application locale&quot;);</span>
<a href="#l62.232"></a><span id="l62.232" class="difflineplus">+    return nsnull;</span>
<a href="#l62.233"></a><span id="l62.233" class="difflineplus">+  }</span>
<a href="#l62.234"></a><span id="l62.234" class="difflineplus">+</span>
<a href="#l62.235"></a><span id="l62.235" class="difflineplus">+  nsCOMPtr&lt;nsICollationFactory&gt; collFact =</span>
<a href="#l62.236"></a><span id="l62.236" class="difflineplus">+    do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID);</span>
<a href="#l62.237"></a><span id="l62.237" class="difflineplus">+  if (!collFact) {</span>
<a href="#l62.238"></a><span id="l62.238" class="difflineplus">+    NS_WARNING(&quot;Could not create collation factory&quot;);</span>
<a href="#l62.239"></a><span id="l62.239" class="difflineplus">+    return nsnull;</span>
<a href="#l62.240"></a><span id="l62.240" class="difflineplus">+  }</span>
<a href="#l62.241"></a><span id="l62.241" class="difflineplus">+</span>
<a href="#l62.242"></a><span id="l62.242" class="difflineplus">+  rv = collFact-&gt;CreateCollation(appLocale, getter_AddRefs(mLocaleCollation));</span>
<a href="#l62.243"></a><span id="l62.243" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l62.244"></a><span id="l62.244" class="difflineplus">+    NS_WARNING(&quot;Could not create collation&quot;);</span>
<a href="#l62.245"></a><span id="l62.245" class="difflineplus">+    return nsnull;</span>
<a href="#l62.246"></a><span id="l62.246" class="difflineplus">+  }</span>
<a href="#l62.247"></a><span id="l62.247" class="difflineplus">+</span>
<a href="#l62.248"></a><span id="l62.248" class="difflineplus">+  return mLocaleCollation;</span>
<a href="#l62.249"></a><span id="l62.249" class="difflineplus">+}</span>
<a href="#l62.250"></a><span id="l62.250" class="difflineplus">+</span>
<a href="#l62.251"></a><span id="l62.251" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l62.252"></a><span id="l62.252" class="difflineplus">+//// mozIStorageService</span>
<a href="#l62.253"></a><span id="l62.253" class="difflineplus">+</span>
<a href="#l62.254"></a><span id="l62.254" class="difflineplus">+#ifndef NS_APP_STORAGE_50_FILE</span>
<a href="#l62.255"></a><span id="l62.255" class="difflineplus">+#define NS_APP_STORAGE_50_FILE &quot;UStor&quot;</span>
<a href="#l62.256"></a><span id="l62.256" class="difflineplus">+#endif</span>
<a href="#l62.257"></a><span id="l62.257" class="difflineplus">+</span>
<a href="#l62.258"></a><span id="l62.258" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.259"></a><span id="l62.259" class="difflineplus">+Service::OpenSpecialDatabase(const char *aStorageKey,</span>
<a href="#l62.260"></a><span id="l62.260" class="difflineplus">+                             mozIStorageConnection **_connection)</span>
<a href="#l62.261"></a><span id="l62.261" class="difflineplus">+{</span>
<a href="#l62.262"></a><span id="l62.262" class="difflineplus">+  nsresult rv;</span>
<a href="#l62.263"></a><span id="l62.263" class="difflineplus">+</span>
<a href="#l62.264"></a><span id="l62.264" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; storageFile;</span>
<a href="#l62.265"></a><span id="l62.265" class="difflineplus">+  if (::strcmp(aStorageKey, &quot;memory&quot;) == 0) {</span>
<a href="#l62.266"></a><span id="l62.266" class="difflineplus">+    // just fall through with NULL storageFile, this will cause the storage</span>
<a href="#l62.267"></a><span id="l62.267" class="difflineplus">+    // connection to use a memory DB.</span>
<a href="#l62.268"></a><span id="l62.268" class="difflineplus">+  }</span>
<a href="#l62.269"></a><span id="l62.269" class="difflineplus">+  else if (::strcmp(aStorageKey, &quot;profile&quot;) == 0) {</span>
<a href="#l62.270"></a><span id="l62.270" class="difflineplus">+</span>
<a href="#l62.271"></a><span id="l62.271" class="difflineplus">+    rv = NS_GetSpecialDirectory(NS_APP_STORAGE_50_FILE,</span>
<a href="#l62.272"></a><span id="l62.272" class="difflineplus">+                                getter_AddRefs(storageFile));</span>
<a href="#l62.273"></a><span id="l62.273" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.274"></a><span id="l62.274" class="difflineplus">+</span>
<a href="#l62.275"></a><span id="l62.275" class="difflineplus">+    nsString filename;</span>
<a href="#l62.276"></a><span id="l62.276" class="difflineplus">+    storageFile-&gt;GetPath(filename);</span>
<a href="#l62.277"></a><span id="l62.277" class="difflineplus">+    nsCString filename8 = NS_ConvertUTF16toUTF8(filename.get());</span>
<a href="#l62.278"></a><span id="l62.278" class="difflineplus">+    // fall through to DB initialization</span>
<a href="#l62.279"></a><span id="l62.279" class="difflineplus">+  }</span>
<a href="#l62.280"></a><span id="l62.280" class="difflineplus">+  else {</span>
<a href="#l62.281"></a><span id="l62.281" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l62.282"></a><span id="l62.282" class="difflineplus">+  }</span>
<a href="#l62.283"></a><span id="l62.283" class="difflineplus">+</span>
<a href="#l62.284"></a><span id="l62.284" class="difflineplus">+  Connection *msc = new Connection(this);</span>
<a href="#l62.285"></a><span id="l62.285" class="difflineplus">+  NS_ENSURE_TRUE(msc, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l62.286"></a><span id="l62.286" class="difflineplus">+</span>
<a href="#l62.287"></a><span id="l62.287" class="difflineplus">+  rv = msc-&gt;initialize(storageFile);</span>
<a href="#l62.288"></a><span id="l62.288" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.289"></a><span id="l62.289" class="difflineplus">+</span>
<a href="#l62.290"></a><span id="l62.290" class="difflineplus">+  NS_ADDREF(*_connection = msc);</span>
<a href="#l62.291"></a><span id="l62.291" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.292"></a><span id="l62.292" class="difflineplus">+}</span>
<a href="#l62.293"></a><span id="l62.293" class="difflineplus">+</span>
<a href="#l62.294"></a><span id="l62.294" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.295"></a><span id="l62.295" class="difflineplus">+Service::OpenDatabase(nsIFile *aDatabaseFile,</span>
<a href="#l62.296"></a><span id="l62.296" class="difflineplus">+                      mozIStorageConnection **_connection)</span>
<a href="#l62.297"></a><span id="l62.297" class="difflineplus">+{</span>
<a href="#l62.298"></a><span id="l62.298" class="difflineplus">+  nsRefPtr&lt;Connection&gt; msc = new Connection(this);</span>
<a href="#l62.299"></a><span id="l62.299" class="difflineplus">+  NS_ENSURE_TRUE(msc, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l62.300"></a><span id="l62.300" class="difflineplus">+</span>
<a href="#l62.301"></a><span id="l62.301" class="difflineplus">+  {</span>
<a href="#l62.302"></a><span id="l62.302" class="difflineplus">+    MutexAutoLock mutex(mMutex);</span>
<a href="#l62.303"></a><span id="l62.303" class="difflineplus">+    nsresult rv = msc-&gt;initialize(aDatabaseFile);</span>
<a href="#l62.304"></a><span id="l62.304" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.305"></a><span id="l62.305" class="difflineplus">+  }</span>
<a href="#l62.306"></a><span id="l62.306" class="difflineplus">+</span>
<a href="#l62.307"></a><span id="l62.307" class="difflineplus">+  NS_ADDREF(*_connection = msc);</span>
<a href="#l62.308"></a><span id="l62.308" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.309"></a><span id="l62.309" class="difflineplus">+}</span>
<a href="#l62.310"></a><span id="l62.310" class="difflineplus">+</span>
<a href="#l62.311"></a><span id="l62.311" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.312"></a><span id="l62.312" class="difflineplus">+Service::OpenUnsharedDatabase(nsIFile *aDatabaseFile,</span>
<a href="#l62.313"></a><span id="l62.313" class="difflineplus">+                              mozIStorageConnection **_connection)</span>
<a href="#l62.314"></a><span id="l62.314" class="difflineplus">+{</span>
<a href="#l62.315"></a><span id="l62.315" class="difflineplus">+  nsRefPtr&lt;Connection&gt; msc = new Connection(this);</span>
<a href="#l62.316"></a><span id="l62.316" class="difflineplus">+  NS_ENSURE_TRUE(msc, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l62.317"></a><span id="l62.317" class="difflineplus">+</span>
<a href="#l62.318"></a><span id="l62.318" class="difflineplus">+  // Initialize the connection, temporarily turning off shared caches so the</span>
<a href="#l62.319"></a><span id="l62.319" class="difflineplus">+  // new connection gets its own cache.  Database connections are assigned</span>
<a href="#l62.320"></a><span id="l62.320" class="difflineplus">+  // caches when they are opened, and they retain those caches for their</span>
<a href="#l62.321"></a><span id="l62.321" class="difflineplus">+  // lifetimes, unaffected by changes to the shared caches setting, so we can</span>
<a href="#l62.322"></a><span id="l62.322" class="difflineplus">+  // disable shared caches temporarily while we initialize the new connection</span>
<a href="#l62.323"></a><span id="l62.323" class="difflineplus">+  // without affecting the caches currently in use by other connections.</span>
<a href="#l62.324"></a><span id="l62.324" class="difflineplus">+  nsresult rv;</span>
<a href="#l62.325"></a><span id="l62.325" class="difflineplus">+  {</span>
<a href="#l62.326"></a><span id="l62.326" class="difflineplus">+    MutexAutoLock mutex(mMutex);</span>
<a href="#l62.327"></a><span id="l62.327" class="difflineplus">+    int rc = ::sqlite3_enable_shared_cache(0);</span>
<a href="#l62.328"></a><span id="l62.328" class="difflineplus">+    if (rc != SQLITE_OK)</span>
<a href="#l62.329"></a><span id="l62.329" class="difflineplus">+      return convertResultCode(rc);</span>
<a href="#l62.330"></a><span id="l62.330" class="difflineplus">+</span>
<a href="#l62.331"></a><span id="l62.331" class="difflineplus">+    rv = msc-&gt;initialize(aDatabaseFile);</span>
<a href="#l62.332"></a><span id="l62.332" class="difflineplus">+</span>
<a href="#l62.333"></a><span id="l62.333" class="difflineplus">+    rc = ::sqlite3_enable_shared_cache(1);</span>
<a href="#l62.334"></a><span id="l62.334" class="difflineplus">+    if (rc != SQLITE_OK)</span>
<a href="#l62.335"></a><span id="l62.335" class="difflineplus">+      return convertResultCode(rc);</span>
<a href="#l62.336"></a><span id="l62.336" class="difflineplus">+  }</span>
<a href="#l62.337"></a><span id="l62.337" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.338"></a><span id="l62.338" class="difflineplus">+</span>
<a href="#l62.339"></a><span id="l62.339" class="difflineplus">+  NS_ADDREF(*_connection = msc);</span>
<a href="#l62.340"></a><span id="l62.340" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.341"></a><span id="l62.341" class="difflineplus">+}</span>
<a href="#l62.342"></a><span id="l62.342" class="difflineplus">+</span>
<a href="#l62.343"></a><span id="l62.343" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.344"></a><span id="l62.344" class="difflineplus">+Service::BackupDatabaseFile(nsIFile *aDBFile,</span>
<a href="#l62.345"></a><span id="l62.345" class="difflineplus">+                            const nsAString &amp;aBackupFileName,</span>
<a href="#l62.346"></a><span id="l62.346" class="difflineplus">+                            nsIFile *aBackupParentDirectory,</span>
<a href="#l62.347"></a><span id="l62.347" class="difflineplus">+                            nsIFile **backup)</span>
<a href="#l62.348"></a><span id="l62.348" class="difflineplus">+{</span>
<a href="#l62.349"></a><span id="l62.349" class="difflineplus">+  nsresult rv;</span>
<a href="#l62.350"></a><span id="l62.350" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; parentDir = aBackupParentDirectory;</span>
<a href="#l62.351"></a><span id="l62.351" class="difflineplus">+  if (!parentDir) {</span>
<a href="#l62.352"></a><span id="l62.352" class="difflineplus">+    // This argument is optional, and defaults to the same parent directory</span>
<a href="#l62.353"></a><span id="l62.353" class="difflineplus">+    // as the current file.</span>
<a href="#l62.354"></a><span id="l62.354" class="difflineplus">+    rv = aDBFile-&gt;GetParent(getter_AddRefs(parentDir));</span>
<a href="#l62.355"></a><span id="l62.355" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.356"></a><span id="l62.356" class="difflineplus">+  }</span>
<a href="#l62.357"></a><span id="l62.357" class="difflineplus">+</span>
<a href="#l62.358"></a><span id="l62.358" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; backupDB;</span>
<a href="#l62.359"></a><span id="l62.359" class="difflineplus">+  rv = parentDir-&gt;Clone(getter_AddRefs(backupDB));</span>
<a href="#l62.360"></a><span id="l62.360" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.361"></a><span id="l62.361" class="difflineplus">+</span>
<a href="#l62.362"></a><span id="l62.362" class="difflineplus">+  rv = backupDB-&gt;Append(aBackupFileName);</span>
<a href="#l62.363"></a><span id="l62.363" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.364"></a><span id="l62.364" class="difflineplus">+</span>
<a href="#l62.365"></a><span id="l62.365" class="difflineplus">+  rv = backupDB-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l62.366"></a><span id="l62.366" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.367"></a><span id="l62.367" class="difflineplus">+</span>
<a href="#l62.368"></a><span id="l62.368" class="difflineplus">+  nsAutoString fileName;</span>
<a href="#l62.369"></a><span id="l62.369" class="difflineplus">+  rv = backupDB-&gt;GetLeafName(fileName);</span>
<a href="#l62.370"></a><span id="l62.370" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.371"></a><span id="l62.371" class="difflineplus">+</span>
<a href="#l62.372"></a><span id="l62.372" class="difflineplus">+  rv = backupDB-&gt;Remove(PR_FALSE);</span>
<a href="#l62.373"></a><span id="l62.373" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.374"></a><span id="l62.374" class="difflineplus">+</span>
<a href="#l62.375"></a><span id="l62.375" class="difflineplus">+  backupDB.forget(backup);</span>
<a href="#l62.376"></a><span id="l62.376" class="difflineplus">+</span>
<a href="#l62.377"></a><span id="l62.377" class="difflineplus">+  return aDBFile-&gt;CopyTo(parentDir, fileName);</span>
<a href="#l62.378"></a><span id="l62.378" class="difflineplus">+}</span>
<a href="#l62.379"></a><span id="l62.379" class="difflineplus">+</span>
<a href="#l62.380"></a><span id="l62.380" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l62.381"></a><span id="l62.381" class="difflineplus">+//// nsIObserver</span>
<a href="#l62.382"></a><span id="l62.382" class="difflineplus">+</span>
<a href="#l62.383"></a><span id="l62.383" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.384"></a><span id="l62.384" class="difflineplus">+Service::Observe(nsISupports *, const char *aTopic, const PRUnichar *)</span>
<a href="#l62.385"></a><span id="l62.385" class="difflineplus">+{</span>
<a href="#l62.386"></a><span id="l62.386" class="difflineplus">+  if (strcmp(aTopic, &quot;xpcom-shutdown&quot;) == 0)</span>
<a href="#l62.387"></a><span id="l62.387" class="difflineplus">+    shutdown();</span>
<a href="#l62.388"></a><span id="l62.388" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.389"></a><span id="l62.389" class="difflineplus">+}</span>
<a href="#l62.390"></a><span id="l62.390" class="difflineplus">+</span>
<a href="#l62.391"></a><span id="l62.391" class="difflineplus">+} // namespace storage</span>
<a href="#l62.392"></a><span id="l62.392" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">new file mode 100644</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineminus">--- /dev/null</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineplus">+++ b/storage-backport/src/mozStorageService.h</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineat">@@ -0,0 +1,141 @@</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l63.6"></a><span id="l63.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l63.7"></a><span id="l63.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l63.9"></a><span id="l63.9" class="difflineplus">+ *</span>
<a href="#l63.10"></a><span id="l63.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+ *</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineplus">+ * License.</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+ *</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+ *</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+ *</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineplus">+ *   Brett Wilson &lt;brettw@gmail.com&gt;</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+ *</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+ *</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineplus">+</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineplus">+#ifndef _MOZSTORAGESERVICE_H_</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineplus">+#define _MOZSTORAGESERVICE_H_</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineplus">+</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+#include &quot;nsICollation.h&quot;</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineplus">+#include &quot;nsIObserver.h&quot;</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineplus">+#include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineplus">+</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+#include &quot;mozIStorageService.h&quot;</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineplus">+</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineplus">+class nsIXPConnect;</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineplus">+</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineplus">+namespace mozilla {</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineplus">+namespace storage {</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineplus">+</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineplus">+class Service : public mozIStorageService</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineplus">+              , public nsIObserver</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineplus">+{</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineplus">+public:</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineplus">+  /**</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineplus">+   * Initializes the service.  This must be called before any other function!</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineplus">+   */</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+  nsresult initialize();</span>
<a href="#l63.71"></a><span id="l63.71" class="difflineplus">+</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineplus">+  /**</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineplus">+   * Compares two strings using the Service's locale-aware collation.</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineplus">+   *</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineplus">+   * @param  aStr1</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineplus">+   *         The string to be compared against aStr2.</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineplus">+   * @param  aStr2</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineplus">+   *         The string to be compared against aStr1.</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineplus">+   * @param  aComparisonStrength</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineplus">+   *         The sorting strength, one of the nsICollation constants.</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineplus">+   * @return aStr1 - aStr2.  That is, if aStr1 &lt; aStr2, returns a negative</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineplus">+   *         number.  If aStr1 &gt; aStr2, returns a positive number.  If</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineplus">+   *         aStr1 == aStr2, returns 0.</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineplus">+   */</span>
<a href="#l63.85"></a><span id="l63.85" class="difflineplus">+  int localeCompareStrings(const nsAString &amp;aStr1,</span>
<a href="#l63.86"></a><span id="l63.86" class="difflineplus">+                           const nsAString &amp;aStr2,</span>
<a href="#l63.87"></a><span id="l63.87" class="difflineplus">+                           PRInt32 aComparisonStrength);</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineplus">+</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineplus">+  static Service *getSingleton();</span>
<a href="#l63.90"></a><span id="l63.90" class="difflineplus">+</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineplus">+  NS_DECL_MOZISTORAGESERVICE</span>
<a href="#l63.93"></a><span id="l63.93" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l63.94"></a><span id="l63.94" class="difflineplus">+</span>
<a href="#l63.95"></a><span id="l63.95" class="difflineplus">+  /**</span>
<a href="#l63.96"></a><span id="l63.96" class="difflineplus">+   * Obtains an already AddRefed pointer to XPConnect.  This is used by</span>
<a href="#l63.97"></a><span id="l63.97" class="difflineplus">+   * language helpers.</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineplus">+   */</span>
<a href="#l63.99"></a><span id="l63.99" class="difflineplus">+  static already_AddRefed&lt;nsIXPConnect&gt; getXPConnect();</span>
<a href="#l63.100"></a><span id="l63.100" class="difflineplus">+</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineplus">+private:</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineplus">+  Service();</span>
<a href="#l63.103"></a><span id="l63.103" class="difflineplus">+  virtual ~Service();</span>
<a href="#l63.104"></a><span id="l63.104" class="difflineplus">+</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineplus">+  /**</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineplus">+   * Used for 1) locking around calls when initializing connections so that we</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineplus">+   * can ensure that the state of sqlite3_enable_shared_cache is sane and 2)</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineplus">+   * synchronizing access to mLocaleCollation.</span>
<a href="#l63.109"></a><span id="l63.109" class="difflineplus">+   */</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineplus">+  Mutex mMutex;</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineplus">+</span>
<a href="#l63.112"></a><span id="l63.112" class="difflineplus">+  /**</span>
<a href="#l63.113"></a><span id="l63.113" class="difflineplus">+   * Shuts down the storage service, freeing all of the acquired resources.</span>
<a href="#l63.114"></a><span id="l63.114" class="difflineplus">+   */</span>
<a href="#l63.115"></a><span id="l63.115" class="difflineplus">+  void shutdown();</span>
<a href="#l63.116"></a><span id="l63.116" class="difflineplus">+</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineplus">+  /**</span>
<a href="#l63.118"></a><span id="l63.118" class="difflineplus">+   * Lazily creates and returns a collation created from the application's</span>
<a href="#l63.119"></a><span id="l63.119" class="difflineplus">+   * locale that all statements of all Connections of this Service may use.</span>
<a href="#l63.120"></a><span id="l63.120" class="difflineplus">+   * Since the collation's lifetime is that of the Service and no statement may</span>
<a href="#l63.121"></a><span id="l63.121" class="difflineplus">+   * execute outside the lifetime of the Service, this method returns a raw</span>
<a href="#l63.122"></a><span id="l63.122" class="difflineplus">+   * pointer.</span>
<a href="#l63.123"></a><span id="l63.123" class="difflineplus">+   */</span>
<a href="#l63.124"></a><span id="l63.124" class="difflineplus">+  nsICollation *getLocaleCollation();</span>
<a href="#l63.125"></a><span id="l63.125" class="difflineplus">+</span>
<a href="#l63.126"></a><span id="l63.126" class="difflineplus">+  /**</span>
<a href="#l63.127"></a><span id="l63.127" class="difflineplus">+   * Lazily created collation that all statements of all Connections of this</span>
<a href="#l63.128"></a><span id="l63.128" class="difflineplus">+   * Service may use.  The collation is created from the application's locale.</span>
<a href="#l63.129"></a><span id="l63.129" class="difflineplus">+   *</span>
<a href="#l63.130"></a><span id="l63.130" class="difflineplus">+   * @note Collation implementations are platform-dependent and in general not</span>
<a href="#l63.131"></a><span id="l63.131" class="difflineplus">+   *       thread-safe.  Access to this collation should be synchronized.</span>
<a href="#l63.132"></a><span id="l63.132" class="difflineplus">+   */</span>
<a href="#l63.133"></a><span id="l63.133" class="difflineplus">+  nsCOMPtr&lt;nsICollation&gt; mLocaleCollation;</span>
<a href="#l63.134"></a><span id="l63.134" class="difflineplus">+</span>
<a href="#l63.135"></a><span id="l63.135" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mProfileStorageFile;</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineplus">+</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineplus">+  static Service *gService;</span>
<a href="#l63.138"></a><span id="l63.138" class="difflineplus">+</span>
<a href="#l63.139"></a><span id="l63.139" class="difflineplus">+  static nsIXPConnect *sXPConnect;</span>
<a href="#l63.140"></a><span id="l63.140" class="difflineplus">+};</span>
<a href="#l63.141"></a><span id="l63.141" class="difflineplus">+</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineplus">+} // namespace storage</span>
<a href="#l63.143"></a><span id="l63.143" class="difflineplus">+} // namespace mozilla</span>
<a href="#l63.144"></a><span id="l63.144" class="difflineplus">+</span>
<a href="#l63.145"></a><span id="l63.145" class="difflineplus">+#endif /* _MOZSTORAGESERVICE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1">new file mode 100644</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineminus">--- /dev/null</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatement.cpp</span>
<a href="#l64.4"></a><span id="l64.4" class="difflineat">@@ -0,0 +1,897 @@</span>
<a href="#l64.5"></a><span id="l64.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l64.6"></a><span id="l64.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l64.7"></a><span id="l64.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineplus">+ *</span>
<a href="#l64.10"></a><span id="l64.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l64.11"></a><span id="l64.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+ *</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+ * License.</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+ *</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+ *</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+ *</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+ *   John Zhang &lt;jzhang@aptana.com&gt;</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+ *</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+ *</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineplus">+#include &lt;limits.h&gt;</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+#include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+#include &quot;nsIProgrammingLanguage.h&quot;</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineplus">+#include &quot;Variant.h&quot;</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineplus">+</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+#include &quot;mozIStorageError.h&quot;</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineplus">+</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineplus">+#include &quot;mozStorageBindingParams.h&quot;</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+#include &quot;mozStorageStatementJSHelper.h&quot;</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineplus">+#include &quot;mozStorageStatementParams.h&quot;</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+#include &quot;mozStorageStatementRow.h&quot;</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineplus">+</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineplus">+extern PRLogModuleInfo* gStorageLog;</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineplus">+#endif</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+namespace mozilla {</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+namespace storage {</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineplus">+//// nsIClassInfo</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineplus">+NS_IMPL_CI_INTERFACE_GETTER5(</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+  Statement,</span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+  mozIStorageStatement,</span>
<a href="#l64.81"></a><span id="l64.81" class="difflineplus">+  mozIStorageBaseStatement,</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+  mozIStorageBindingParams,</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineplus">+  mozIStorageValueArray,</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineplus">+  mozilla::storage::StorageBaseStatementInternal</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+)</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+class StatementClassInfo : public nsIClassInfo</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineplus">+{</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineplus">+public:</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineplus">+</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+  GetInterfaces(PRUint32 *_count, nsIID ***_array)</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+  {</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineplus">+    return NS_CI_INTERFACE_GETTER_NAME(Statement)(_count, _array);</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+  }</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineplus">+</span>
<a href="#l64.98"></a><span id="l64.98" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.99"></a><span id="l64.99" class="difflineplus">+  GetHelperForLanguage(PRUint32 aLanguage, nsISupports **_helper)</span>
<a href="#l64.100"></a><span id="l64.100" class="difflineplus">+  {</span>
<a href="#l64.101"></a><span id="l64.101" class="difflineplus">+    if (aLanguage == nsIProgrammingLanguage::JAVASCRIPT) {</span>
<a href="#l64.102"></a><span id="l64.102" class="difflineplus">+      static StatementJSHelper sJSHelper;</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineplus">+      *_helper = &amp;sJSHelper;</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineplus">+      return NS_OK;</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineplus">+    }</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineplus">+</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineplus">+    *_helper = nsnull;</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.109"></a><span id="l64.109" class="difflineplus">+  }</span>
<a href="#l64.110"></a><span id="l64.110" class="difflineplus">+</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineplus">+  GetContractID(char **_contractID)</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineplus">+  {</span>
<a href="#l64.114"></a><span id="l64.114" class="difflineplus">+    *_contractID = nsnull;</span>
<a href="#l64.115"></a><span id="l64.115" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.116"></a><span id="l64.116" class="difflineplus">+  }</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+</span>
<a href="#l64.118"></a><span id="l64.118" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineplus">+  GetClassDescription(char **_desc)</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineplus">+  {</span>
<a href="#l64.121"></a><span id="l64.121" class="difflineplus">+    *_desc = nsnull;</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineplus">+  }</span>
<a href="#l64.124"></a><span id="l64.124" class="difflineplus">+</span>
<a href="#l64.125"></a><span id="l64.125" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineplus">+  GetClassID(nsCID **_id)</span>
<a href="#l64.127"></a><span id="l64.127" class="difflineplus">+  {</span>
<a href="#l64.128"></a><span id="l64.128" class="difflineplus">+    *_id = nsnull;</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.130"></a><span id="l64.130" class="difflineplus">+  }</span>
<a href="#l64.131"></a><span id="l64.131" class="difflineplus">+</span>
<a href="#l64.132"></a><span id="l64.132" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.133"></a><span id="l64.133" class="difflineplus">+  GetImplementationLanguage(PRUint32 *_language)</span>
<a href="#l64.134"></a><span id="l64.134" class="difflineplus">+  {</span>
<a href="#l64.135"></a><span id="l64.135" class="difflineplus">+    *_language = nsIProgrammingLanguage::CPLUSPLUS;</span>
<a href="#l64.136"></a><span id="l64.136" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.137"></a><span id="l64.137" class="difflineplus">+  }</span>
<a href="#l64.138"></a><span id="l64.138" class="difflineplus">+</span>
<a href="#l64.139"></a><span id="l64.139" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.140"></a><span id="l64.140" class="difflineplus">+  GetFlags(PRUint32 *_flags)</span>
<a href="#l64.141"></a><span id="l64.141" class="difflineplus">+  {</span>
<a href="#l64.142"></a><span id="l64.142" class="difflineplus">+    *_flags = nsnull;</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineplus">+  }</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineplus">+</span>
<a href="#l64.146"></a><span id="l64.146" class="difflineplus">+  NS_IMETHODIMP</span>
<a href="#l64.147"></a><span id="l64.147" class="difflineplus">+  GetClassIDNoAlloc(nsCID *_cid)</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineplus">+  {</span>
<a href="#l64.149"></a><span id="l64.149" class="difflineplus">+    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l64.150"></a><span id="l64.150" class="difflineplus">+  }</span>
<a href="#l64.151"></a><span id="l64.151" class="difflineplus">+};</span>
<a href="#l64.152"></a><span id="l64.152" class="difflineplus">+</span>
<a href="#l64.153"></a><span id="l64.153" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) StatementClassInfo::AddRef() { return 2; }</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) StatementClassInfo::Release() { return 1; }</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineplus">+NS_IMPL_QUERY_INTERFACE1(StatementClassInfo, nsIClassInfo)</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineplus">+</span>
<a href="#l64.157"></a><span id="l64.157" class="difflineplus">+static StatementClassInfo sStatementClassInfo;</span>
<a href="#l64.158"></a><span id="l64.158" class="difflineplus">+</span>
<a href="#l64.159"></a><span id="l64.159" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.160"></a><span id="l64.160" class="difflineplus">+//// Statement</span>
<a href="#l64.161"></a><span id="l64.161" class="difflineplus">+</span>
<a href="#l64.162"></a><span id="l64.162" class="difflineplus">+Statement::Statement()</span>
<a href="#l64.163"></a><span id="l64.163" class="difflineplus">+: StorageBaseStatementInternal()</span>
<a href="#l64.164"></a><span id="l64.164" class="difflineplus">+, mDBStatement(NULL)</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineplus">+, mColumnNames()</span>
<a href="#l64.166"></a><span id="l64.166" class="difflineplus">+, mExecuting(false)</span>
<a href="#l64.167"></a><span id="l64.167" class="difflineplus">+{</span>
<a href="#l64.168"></a><span id="l64.168" class="difflineplus">+}</span>
<a href="#l64.169"></a><span id="l64.169" class="difflineplus">+</span>
<a href="#l64.170"></a><span id="l64.170" class="difflineplus">+nsresult</span>
<a href="#l64.171"></a><span id="l64.171" class="difflineplus">+Statement::initialize(Connection *aDBConnection,</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineplus">+                      const nsACString &amp;aSQLStatement)</span>
<a href="#l64.173"></a><span id="l64.173" class="difflineplus">+{</span>
<a href="#l64.174"></a><span id="l64.174" class="difflineplus">+  NS_ASSERTION(aDBConnection, &quot;No database connection given!&quot;);</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+  NS_ASSERTION(!mDBStatement, &quot;Statement already initialized!&quot;);</span>
<a href="#l64.176"></a><span id="l64.176" class="difflineplus">+</span>
<a href="#l64.177"></a><span id="l64.177" class="difflineplus">+  sqlite3 *db = aDBConnection-&gt;GetNativeConnection();</span>
<a href="#l64.178"></a><span id="l64.178" class="difflineplus">+  NS_ASSERTION(db, &quot;We should never be called with a null sqlite3 database!&quot;);</span>
<a href="#l64.179"></a><span id="l64.179" class="difflineplus">+</span>
<a href="#l64.180"></a><span id="l64.180" class="difflineplus">+  int srv = ::sqlite3_prepare_v2(db, PromiseFlatCString(aSQLStatement).get(),</span>
<a href="#l64.181"></a><span id="l64.181" class="difflineplus">+                                 -1, &amp;mDBStatement, NULL);</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineplus">+  if (srv != SQLITE_OK) {</span>
<a href="#l64.183"></a><span id="l64.183" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.184"></a><span id="l64.184" class="difflineplus">+      PR_LOG(gStorageLog, PR_LOG_ERROR,</span>
<a href="#l64.185"></a><span id="l64.185" class="difflineplus">+             (&quot;Sqlite statement prepare error: %d '%s'&quot;, srv,</span>
<a href="#l64.186"></a><span id="l64.186" class="difflineplus">+              ::sqlite3_errmsg(db)));</span>
<a href="#l64.187"></a><span id="l64.187" class="difflineplus">+      PR_LOG(gStorageLog, PR_LOG_ERROR,</span>
<a href="#l64.188"></a><span id="l64.188" class="difflineplus">+             (&quot;Statement was: '%s'&quot;, PromiseFlatCString(aSQLStatement).get()));</span>
<a href="#l64.189"></a><span id="l64.189" class="difflineplus">+#endif</span>
<a href="#l64.190"></a><span id="l64.190" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l64.191"></a><span id="l64.191" class="difflineplus">+    }</span>
<a href="#l64.192"></a><span id="l64.192" class="difflineplus">+</span>
<a href="#l64.193"></a><span id="l64.193" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.194"></a><span id="l64.194" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Initialized statement '%s' (0x%p)&quot;,</span>
<a href="#l64.195"></a><span id="l64.195" class="difflineplus">+                                      PromiseFlatCString(aSQLStatement).get(),</span>
<a href="#l64.196"></a><span id="l64.196" class="difflineplus">+                                      mDBStatement));</span>
<a href="#l64.197"></a><span id="l64.197" class="difflineplus">+#endif</span>
<a href="#l64.198"></a><span id="l64.198" class="difflineplus">+</span>
<a href="#l64.199"></a><span id="l64.199" class="difflineplus">+  mDBConnection = aDBConnection;</span>
<a href="#l64.200"></a><span id="l64.200" class="difflineplus">+  mParamCount = ::sqlite3_bind_parameter_count(mDBStatement);</span>
<a href="#l64.201"></a><span id="l64.201" class="difflineplus">+  mResultColumnCount = ::sqlite3_column_count(mDBStatement);</span>
<a href="#l64.202"></a><span id="l64.202" class="difflineplus">+  mColumnNames.Clear();</span>
<a href="#l64.203"></a><span id="l64.203" class="difflineplus">+</span>
<a href="#l64.204"></a><span id="l64.204" class="difflineplus">+  for (PRUint32 i = 0; i &lt; mResultColumnCount; i++) {</span>
<a href="#l64.205"></a><span id="l64.205" class="difflineplus">+      const char *name = ::sqlite3_column_name(mDBStatement, i);</span>
<a href="#l64.206"></a><span id="l64.206" class="difflineplus">+      (void)mColumnNames.AppendElement(nsDependentCString(name));</span>
<a href="#l64.207"></a><span id="l64.207" class="difflineplus">+  }</span>
<a href="#l64.208"></a><span id="l64.208" class="difflineplus">+</span>
<a href="#l64.209"></a><span id="l64.209" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l64.210"></a><span id="l64.210" class="difflineplus">+  // We want to try and test for LIKE and that consumers are using</span>
<a href="#l64.211"></a><span id="l64.211" class="difflineplus">+  // escapeStringForLIKE instead of just trusting user input.  The idea to</span>
<a href="#l64.212"></a><span id="l64.212" class="difflineplus">+  // check to see if they are binding a parameter after like instead of just</span>
<a href="#l64.213"></a><span id="l64.213" class="difflineplus">+  // using a string.  We only do this in debug builds because it's expensive!</span>
<a href="#l64.214"></a><span id="l64.214" class="difflineplus">+  const nsCaseInsensitiveCStringComparator c;</span>
<a href="#l64.215"></a><span id="l64.215" class="difflineplus">+  nsACString::const_iterator start, end, e;</span>
<a href="#l64.216"></a><span id="l64.216" class="difflineplus">+  aSQLStatement.BeginReading(start);</span>
<a href="#l64.217"></a><span id="l64.217" class="difflineplus">+  aSQLStatement.EndReading(end);</span>
<a href="#l64.218"></a><span id="l64.218" class="difflineplus">+  e = end;</span>
<a href="#l64.219"></a><span id="l64.219" class="difflineplus">+  while (::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE&quot;), start, e, c)) {</span>
<a href="#l64.220"></a><span id="l64.220" class="difflineplus">+    // We have a LIKE in here, so we perform our tests</span>
<a href="#l64.221"></a><span id="l64.221" class="difflineplus">+    // FindInReadable moves the iterator, so we have to get a new one for</span>
<a href="#l64.222"></a><span id="l64.222" class="difflineplus">+    // each test we perform.</span>
<a href="#l64.223"></a><span id="l64.223" class="difflineplus">+    nsACString::const_iterator s1, s2, s3;</span>
<a href="#l64.224"></a><span id="l64.224" class="difflineplus">+    s1 = s2 = s3 = start;</span>
<a href="#l64.225"></a><span id="l64.225" class="difflineplus">+</span>
<a href="#l64.226"></a><span id="l64.226" class="difflineplus">+    if (!(::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE ?&quot;), s1, end, c) ||</span>
<a href="#l64.227"></a><span id="l64.227" class="difflineplus">+          ::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE :&quot;), s2, end, c) ||</span>
<a href="#l64.228"></a><span id="l64.228" class="difflineplus">+          ::FindInReadable(NS_LITERAL_CSTRING(&quot; LIKE @&quot;), s3, end, c))) {</span>
<a href="#l64.229"></a><span id="l64.229" class="difflineplus">+      // At this point, we didn't find a LIKE statement followed by ?, :,</span>
<a href="#l64.230"></a><span id="l64.230" class="difflineplus">+      // or @, all of which are valid characters for binding a parameter.</span>
<a href="#l64.231"></a><span id="l64.231" class="difflineplus">+      // We will warn the consumer that they may not be safely using LIKE.</span>
<a href="#l64.232"></a><span id="l64.232" class="difflineplus">+      NS_WARNING(&quot;Unsafe use of LIKE detected!  Please ensure that you &quot;</span>
<a href="#l64.233"></a><span id="l64.233" class="difflineplus">+                 &quot;are using mozIStorageStatement::escapeStringForLIKE &quot;</span>
<a href="#l64.234"></a><span id="l64.234" class="difflineplus">+                 &quot;and that you are binding that result to the statement &quot;</span>
<a href="#l64.235"></a><span id="l64.235" class="difflineplus">+                 &quot;to prevent SQL injection attacks.&quot;);</span>
<a href="#l64.236"></a><span id="l64.236" class="difflineplus">+    }</span>
<a href="#l64.237"></a><span id="l64.237" class="difflineplus">+</span>
<a href="#l64.238"></a><span id="l64.238" class="difflineplus">+    // resetting start and e</span>
<a href="#l64.239"></a><span id="l64.239" class="difflineplus">+    start = e;</span>
<a href="#l64.240"></a><span id="l64.240" class="difflineplus">+    e = end;</span>
<a href="#l64.241"></a><span id="l64.241" class="difflineplus">+  }</span>
<a href="#l64.242"></a><span id="l64.242" class="difflineplus">+#endif</span>
<a href="#l64.243"></a><span id="l64.243" class="difflineplus">+</span>
<a href="#l64.244"></a><span id="l64.244" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.245"></a><span id="l64.245" class="difflineplus">+}</span>
<a href="#l64.246"></a><span id="l64.246" class="difflineplus">+</span>
<a href="#l64.247"></a><span id="l64.247" class="difflineplus">+mozIStorageBindingParams *</span>
<a href="#l64.248"></a><span id="l64.248" class="difflineplus">+Statement::getParams()</span>
<a href="#l64.249"></a><span id="l64.249" class="difflineplus">+{</span>
<a href="#l64.250"></a><span id="l64.250" class="difflineplus">+  nsresult rv;</span>
<a href="#l64.251"></a><span id="l64.251" class="difflineplus">+</span>
<a href="#l64.252"></a><span id="l64.252" class="difflineplus">+  // If we do not have an array object yet, make it.</span>
<a href="#l64.253"></a><span id="l64.253" class="difflineplus">+  if (!mParamsArray) {</span>
<a href="#l64.254"></a><span id="l64.254" class="difflineplus">+    nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; array;</span>
<a href="#l64.255"></a><span id="l64.255" class="difflineplus">+    rv = NewBindingParamsArray(getter_AddRefs(array));</span>
<a href="#l64.256"></a><span id="l64.256" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l64.257"></a><span id="l64.257" class="difflineplus">+</span>
<a href="#l64.258"></a><span id="l64.258" class="difflineplus">+    mParamsArray = static_cast&lt;BindingParamsArray *&gt;(array.get());</span>
<a href="#l64.259"></a><span id="l64.259" class="difflineplus">+  }</span>
<a href="#l64.260"></a><span id="l64.260" class="difflineplus">+</span>
<a href="#l64.261"></a><span id="l64.261" class="difflineplus">+  // If there isn't already any rows added, we'll have to add one to use.</span>
<a href="#l64.262"></a><span id="l64.262" class="difflineplus">+  if (mParamsArray-&gt;length() == 0) {</span>
<a href="#l64.263"></a><span id="l64.263" class="difflineplus">+    nsRefPtr&lt;BindingParams&gt; params(new BindingParams(mParamsArray, this));</span>
<a href="#l64.264"></a><span id="l64.264" class="difflineplus">+    NS_ENSURE_TRUE(params, nsnull);</span>
<a href="#l64.265"></a><span id="l64.265" class="difflineplus">+</span>
<a href="#l64.266"></a><span id="l64.266" class="difflineplus">+    rv = mParamsArray-&gt;AddParams(params);</span>
<a href="#l64.267"></a><span id="l64.267" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l64.268"></a><span id="l64.268" class="difflineplus">+</span>
<a href="#l64.269"></a><span id="l64.269" class="difflineplus">+    // We have to unlock our params because AddParams locks them.  This is safe</span>
<a href="#l64.270"></a><span id="l64.270" class="difflineplus">+    // because no reference to the params object was, or ever will be given out.</span>
<a href="#l64.271"></a><span id="l64.271" class="difflineplus">+    params-&gt;unlock(this);</span>
<a href="#l64.272"></a><span id="l64.272" class="difflineplus">+</span>
<a href="#l64.273"></a><span id="l64.273" class="difflineplus">+    // We also want to lock our array at this point - we don't want anything to</span>
<a href="#l64.274"></a><span id="l64.274" class="difflineplus">+    // be added to it.  Nothing has, or will ever get a reference to it, but we</span>
<a href="#l64.275"></a><span id="l64.275" class="difflineplus">+    // will get additional safety checks via assertions by doing this.</span>
<a href="#l64.276"></a><span id="l64.276" class="difflineplus">+    mParamsArray-&gt;lock();</span>
<a href="#l64.277"></a><span id="l64.277" class="difflineplus">+  }</span>
<a href="#l64.278"></a><span id="l64.278" class="difflineplus">+</span>
<a href="#l64.279"></a><span id="l64.279" class="difflineplus">+  return *mParamsArray-&gt;begin();</span>
<a href="#l64.280"></a><span id="l64.280" class="difflineplus">+}</span>
<a href="#l64.281"></a><span id="l64.281" class="difflineplus">+</span>
<a href="#l64.282"></a><span id="l64.282" class="difflineplus">+Statement::~Statement()</span>
<a href="#l64.283"></a><span id="l64.283" class="difflineplus">+{</span>
<a href="#l64.284"></a><span id="l64.284" class="difflineplus">+  (void)internalFinalize(true);</span>
<a href="#l64.285"></a><span id="l64.285" class="difflineplus">+}</span>
<a href="#l64.286"></a><span id="l64.286" class="difflineplus">+</span>
<a href="#l64.287"></a><span id="l64.287" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.288"></a><span id="l64.288" class="difflineplus">+//// nsISupports</span>
<a href="#l64.289"></a><span id="l64.289" class="difflineplus">+</span>
<a href="#l64.290"></a><span id="l64.290" class="difflineplus">+NS_IMPL_THREADSAFE_ADDREF(Statement)</span>
<a href="#l64.291"></a><span id="l64.291" class="difflineplus">+NS_IMPL_THREADSAFE_RELEASE(Statement)</span>
<a href="#l64.292"></a><span id="l64.292" class="difflineplus">+</span>
<a href="#l64.293"></a><span id="l64.293" class="difflineplus">+NS_INTERFACE_MAP_BEGIN(Statement)</span>
<a href="#l64.294"></a><span id="l64.294" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageStatement)</span>
<a href="#l64.295"></a><span id="l64.295" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageBaseStatement)</span>
<a href="#l64.296"></a><span id="l64.296" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageBindingParams)</span>
<a href="#l64.297"></a><span id="l64.297" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozIStorageValueArray)</span>
<a href="#l64.298"></a><span id="l64.298" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(mozilla::storage::StorageBaseStatementInternal)</span>
<a href="#l64.299"></a><span id="l64.299" class="difflineplus">+  if (aIID.Equals(NS_GET_IID(nsIClassInfo))) {</span>
<a href="#l64.300"></a><span id="l64.300" class="difflineplus">+    foundInterface = static_cast&lt;nsIClassInfo *&gt;(&amp;sStatementClassInfo);</span>
<a href="#l64.301"></a><span id="l64.301" class="difflineplus">+  }</span>
<a href="#l64.302"></a><span id="l64.302" class="difflineplus">+  else</span>
<a href="#l64.303"></a><span id="l64.303" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, mozIStorageStatement)</span>
<a href="#l64.304"></a><span id="l64.304" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l64.305"></a><span id="l64.305" class="difflineplus">+</span>
<a href="#l64.306"></a><span id="l64.306" class="difflineplus">+</span>
<a href="#l64.307"></a><span id="l64.307" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.308"></a><span id="l64.308" class="difflineplus">+//// StorageBaseStatementInternal</span>
<a href="#l64.309"></a><span id="l64.309" class="difflineplus">+</span>
<a href="#l64.310"></a><span id="l64.310" class="difflineplus">+Connection *</span>
<a href="#l64.311"></a><span id="l64.311" class="difflineplus">+Statement::getOwner()</span>
<a href="#l64.312"></a><span id="l64.312" class="difflineplus">+{</span>
<a href="#l64.313"></a><span id="l64.313" class="difflineplus">+  return mDBConnection;</span>
<a href="#l64.314"></a><span id="l64.314" class="difflineplus">+}</span>
<a href="#l64.315"></a><span id="l64.315" class="difflineplus">+</span>
<a href="#l64.316"></a><span id="l64.316" class="difflineplus">+int</span>
<a href="#l64.317"></a><span id="l64.317" class="difflineplus">+Statement::getAsyncStatement(sqlite3_stmt **_stmt)</span>
<a href="#l64.318"></a><span id="l64.318" class="difflineplus">+{</span>
<a href="#l64.319"></a><span id="l64.319" class="difflineplus">+  // If we have no statement, we shouldn't be calling this method!</span>
<a href="#l64.320"></a><span id="l64.320" class="difflineplus">+  NS_ASSERTION(mDBStatement != NULL, &quot;We have no statement to clone!&quot;);</span>
<a href="#l64.321"></a><span id="l64.321" class="difflineplus">+</span>
<a href="#l64.322"></a><span id="l64.322" class="difflineplus">+  // If we do not yet have a cached async statement, clone our statement now.</span>
<a href="#l64.323"></a><span id="l64.323" class="difflineplus">+  if (!mAsyncStatement) {</span>
<a href="#l64.324"></a><span id="l64.324" class="difflineplus">+    int rc = ::sqlite3_prepare_v2(mDBConnection-&gt;GetNativeConnection(),</span>
<a href="#l64.325"></a><span id="l64.325" class="difflineplus">+                                  ::sqlite3_sql(mDBStatement), -1,</span>
<a href="#l64.326"></a><span id="l64.326" class="difflineplus">+                                  &amp;mAsyncStatement, NULL);</span>
<a href="#l64.327"></a><span id="l64.327" class="difflineplus">+    if (rc != SQLITE_OK) {</span>
<a href="#l64.328"></a><span id="l64.328" class="difflineplus">+      *_stmt = nsnull;</span>
<a href="#l64.329"></a><span id="l64.329" class="difflineplus">+      return rc;</span>
<a href="#l64.330"></a><span id="l64.330" class="difflineplus">+    }</span>
<a href="#l64.331"></a><span id="l64.331" class="difflineplus">+</span>
<a href="#l64.332"></a><span id="l64.332" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.333"></a><span id="l64.333" class="difflineplus">+    PR_LOG(gStorageLog, PR_LOG_NOTICE,</span>
<a href="#l64.334"></a><span id="l64.334" class="difflineplus">+           (&quot;Cloned statement 0x%p to 0x%p&quot;, mDBStatement, mAsyncStatement));</span>
<a href="#l64.335"></a><span id="l64.335" class="difflineplus">+#endif</span>
<a href="#l64.336"></a><span id="l64.336" class="difflineplus">+  }</span>
<a href="#l64.337"></a><span id="l64.337" class="difflineplus">+</span>
<a href="#l64.338"></a><span id="l64.338" class="difflineplus">+  *_stmt = mAsyncStatement;</span>
<a href="#l64.339"></a><span id="l64.339" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l64.340"></a><span id="l64.340" class="difflineplus">+}</span>
<a href="#l64.341"></a><span id="l64.341" class="difflineplus">+</span>
<a href="#l64.342"></a><span id="l64.342" class="difflineplus">+nsresult</span>
<a href="#l64.343"></a><span id="l64.343" class="difflineplus">+Statement::getAsynchronousStatementData(StatementData &amp;_data)</span>
<a href="#l64.344"></a><span id="l64.344" class="difflineplus">+{</span>
<a href="#l64.345"></a><span id="l64.345" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.346"></a><span id="l64.346" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.347"></a><span id="l64.347" class="difflineplus">+</span>
<a href="#l64.348"></a><span id="l64.348" class="difflineplus">+  sqlite3_stmt *stmt;</span>
<a href="#l64.349"></a><span id="l64.349" class="difflineplus">+  int rc = getAsyncStatement(&amp;stmt);</span>
<a href="#l64.350"></a><span id="l64.350" class="difflineplus">+  if (rc != SQLITE_OK)</span>
<a href="#l64.351"></a><span id="l64.351" class="difflineplus">+    return convertResultCode(rc);</span>
<a href="#l64.352"></a><span id="l64.352" class="difflineplus">+</span>
<a href="#l64.353"></a><span id="l64.353" class="difflineplus">+  _data = StatementData(stmt, bindingParamsArray(), this);</span>
<a href="#l64.354"></a><span id="l64.354" class="difflineplus">+</span>
<a href="#l64.355"></a><span id="l64.355" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.356"></a><span id="l64.356" class="difflineplus">+}</span>
<a href="#l64.357"></a><span id="l64.357" class="difflineplus">+</span>
<a href="#l64.358"></a><span id="l64.358" class="difflineplus">+already_AddRefed&lt;mozIStorageBindingParams&gt;</span>
<a href="#l64.359"></a><span id="l64.359" class="difflineplus">+Statement::newBindingParams(mozIStorageBindingParamsArray *aOwner)</span>
<a href="#l64.360"></a><span id="l64.360" class="difflineplus">+{</span>
<a href="#l64.361"></a><span id="l64.361" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParams&gt; params = new BindingParams(aOwner, this);</span>
<a href="#l64.362"></a><span id="l64.362" class="difflineplus">+  return params.forget();</span>
<a href="#l64.363"></a><span id="l64.363" class="difflineplus">+}</span>
<a href="#l64.364"></a><span id="l64.364" class="difflineplus">+</span>
<a href="#l64.365"></a><span id="l64.365" class="difflineplus">+</span>
<a href="#l64.366"></a><span id="l64.366" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.367"></a><span id="l64.367" class="difflineplus">+//// mozIStorageStatement</span>
<a href="#l64.368"></a><span id="l64.368" class="difflineplus">+</span>
<a href="#l64.369"></a><span id="l64.369" class="difflineplus">+// proxy to StorageBaseStatementInternal using its define helper.</span>
<a href="#l64.370"></a><span id="l64.370" class="difflineplus">+MIXIN_IMPL_STORAGEBASESTATEMENTINTERNAL(Statement, (void)0;)</span>
<a href="#l64.371"></a><span id="l64.371" class="difflineplus">+</span>
<a href="#l64.372"></a><span id="l64.372" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.373"></a><span id="l64.373" class="difflineplus">+Statement::Clone(mozIStorageStatement **_statement)</span>
<a href="#l64.374"></a><span id="l64.374" class="difflineplus">+{</span>
<a href="#l64.375"></a><span id="l64.375" class="difflineplus">+  nsRefPtr&lt;Statement&gt; statement(new Statement());</span>
<a href="#l64.376"></a><span id="l64.376" class="difflineplus">+  NS_ENSURE_TRUE(statement, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l64.377"></a><span id="l64.377" class="difflineplus">+</span>
<a href="#l64.378"></a><span id="l64.378" class="difflineplus">+  nsCAutoString sql(::sqlite3_sql(mDBStatement));</span>
<a href="#l64.379"></a><span id="l64.379" class="difflineplus">+  nsresult rv = statement-&gt;initialize(mDBConnection, sql);</span>
<a href="#l64.380"></a><span id="l64.380" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.381"></a><span id="l64.381" class="difflineplus">+</span>
<a href="#l64.382"></a><span id="l64.382" class="difflineplus">+  statement.forget(_statement);</span>
<a href="#l64.383"></a><span id="l64.383" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.384"></a><span id="l64.384" class="difflineplus">+}</span>
<a href="#l64.385"></a><span id="l64.385" class="difflineplus">+</span>
<a href="#l64.386"></a><span id="l64.386" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.387"></a><span id="l64.387" class="difflineplus">+Statement::Finalize()</span>
<a href="#l64.388"></a><span id="l64.388" class="difflineplus">+{</span>
<a href="#l64.389"></a><span id="l64.389" class="difflineplus">+  return internalFinalize(false);</span>
<a href="#l64.390"></a><span id="l64.390" class="difflineplus">+}</span>
<a href="#l64.391"></a><span id="l64.391" class="difflineplus">+</span>
<a href="#l64.392"></a><span id="l64.392" class="difflineplus">+nsresult</span>
<a href="#l64.393"></a><span id="l64.393" class="difflineplus">+Statement::internalFinalize(bool destructing)</span>
<a href="#l64.394"></a><span id="l64.394" class="difflineplus">+{</span>
<a href="#l64.395"></a><span id="l64.395" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.396"></a><span id="l64.396" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.397"></a><span id="l64.397" class="difflineplus">+</span>
<a href="#l64.398"></a><span id="l64.398" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.399"></a><span id="l64.399" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_NOTICE, (&quot;Finalizing statement '%s'&quot;,</span>
<a href="#l64.400"></a><span id="l64.400" class="difflineplus">+                                      ::sqlite3_sql(mDBStatement)));</span>
<a href="#l64.401"></a><span id="l64.401" class="difflineplus">+#endif</span>
<a href="#l64.402"></a><span id="l64.402" class="difflineplus">+</span>
<a href="#l64.403"></a><span id="l64.403" class="difflineplus">+  int srv = ::sqlite3_finalize(mDBStatement);</span>
<a href="#l64.404"></a><span id="l64.404" class="difflineplus">+  mDBStatement = NULL;</span>
<a href="#l64.405"></a><span id="l64.405" class="difflineplus">+</span>
<a href="#l64.406"></a><span id="l64.406" class="difflineplus">+  if (mAsyncStatement) {</span>
<a href="#l64.407"></a><span id="l64.407" class="difflineplus">+    // If the destructor called us, there are no pending async statements (they</span>
<a href="#l64.408"></a><span id="l64.408" class="difflineplus">+    // hold a reference to us) and we can/must just kill the statement directly.</span>
<a href="#l64.409"></a><span id="l64.409" class="difflineplus">+    if (destructing)</span>
<a href="#l64.410"></a><span id="l64.410" class="difflineplus">+      internalAsyncFinalize();</span>
<a href="#l64.411"></a><span id="l64.411" class="difflineplus">+    else</span>
<a href="#l64.412"></a><span id="l64.412" class="difflineplus">+      asyncFinalize();</span>
<a href="#l64.413"></a><span id="l64.413" class="difflineplus">+  }</span>
<a href="#l64.414"></a><span id="l64.414" class="difflineplus">+</span>
<a href="#l64.415"></a><span id="l64.415" class="difflineplus">+  // We are considered dead at this point, so any wrappers for row or params</span>
<a href="#l64.416"></a><span id="l64.416" class="difflineplus">+  // need to lose their reference to us.</span>
<a href="#l64.417"></a><span id="l64.417" class="difflineplus">+  if (mStatementParamsHolder) {</span>
<a href="#l64.418"></a><span id="l64.418" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnectWrappedNative&gt; wrapper =</span>
<a href="#l64.419"></a><span id="l64.419" class="difflineplus">+        do_QueryInterface(mStatementParamsHolder);</span>
<a href="#l64.420"></a><span id="l64.420" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementParams&gt; iParams =</span>
<a href="#l64.421"></a><span id="l64.421" class="difflineplus">+        do_QueryWrappedNative(wrapper);</span>
<a href="#l64.422"></a><span id="l64.422" class="difflineplus">+    StatementParams *params = static_cast&lt;StatementParams *&gt;(iParams.get());</span>
<a href="#l64.423"></a><span id="l64.423" class="difflineplus">+    params-&gt;mStatement = nsnull;</span>
<a href="#l64.424"></a><span id="l64.424" class="difflineplus">+    mStatementParamsHolder = nsnull;</span>
<a href="#l64.425"></a><span id="l64.425" class="difflineplus">+  }</span>
<a href="#l64.426"></a><span id="l64.426" class="difflineplus">+</span>
<a href="#l64.427"></a><span id="l64.427" class="difflineplus">+  if (mStatementRowHolder) {</span>
<a href="#l64.428"></a><span id="l64.428" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnectWrappedNative&gt; wrapper =</span>
<a href="#l64.429"></a><span id="l64.429" class="difflineplus">+        do_QueryInterface(mStatementRowHolder);</span>
<a href="#l64.430"></a><span id="l64.430" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementRow&gt; iRow =</span>
<a href="#l64.431"></a><span id="l64.431" class="difflineplus">+        do_QueryWrappedNative(wrapper);</span>
<a href="#l64.432"></a><span id="l64.432" class="difflineplus">+    StatementRow *row = static_cast&lt;StatementRow *&gt;(iRow.get());</span>
<a href="#l64.433"></a><span id="l64.433" class="difflineplus">+    row-&gt;mStatement = nsnull;</span>
<a href="#l64.434"></a><span id="l64.434" class="difflineplus">+    mStatementRowHolder = nsnull;</span>
<a href="#l64.435"></a><span id="l64.435" class="difflineplus">+  }</span>
<a href="#l64.436"></a><span id="l64.436" class="difflineplus">+</span>
<a href="#l64.437"></a><span id="l64.437" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l64.438"></a><span id="l64.438" class="difflineplus">+}</span>
<a href="#l64.439"></a><span id="l64.439" class="difflineplus">+</span>
<a href="#l64.440"></a><span id="l64.440" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.441"></a><span id="l64.441" class="difflineplus">+Statement::GetParameterCount(PRUint32 *_parameterCount)</span>
<a href="#l64.442"></a><span id="l64.442" class="difflineplus">+{</span>
<a href="#l64.443"></a><span id="l64.443" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.444"></a><span id="l64.444" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.445"></a><span id="l64.445" class="difflineplus">+</span>
<a href="#l64.446"></a><span id="l64.446" class="difflineplus">+  *_parameterCount = mParamCount;</span>
<a href="#l64.447"></a><span id="l64.447" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.448"></a><span id="l64.448" class="difflineplus">+}</span>
<a href="#l64.449"></a><span id="l64.449" class="difflineplus">+</span>
<a href="#l64.450"></a><span id="l64.450" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.451"></a><span id="l64.451" class="difflineplus">+Statement::GetParameterName(PRUint32 aParamIndex,</span>
<a href="#l64.452"></a><span id="l64.452" class="difflineplus">+                            nsACString &amp;_name)</span>
<a href="#l64.453"></a><span id="l64.453" class="difflineplus">+{</span>
<a href="#l64.454"></a><span id="l64.454" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.455"></a><span id="l64.455" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.456"></a><span id="l64.456" class="difflineplus">+  ENSURE_INDEX_VALUE(aParamIndex, mParamCount);</span>
<a href="#l64.457"></a><span id="l64.457" class="difflineplus">+</span>
<a href="#l64.458"></a><span id="l64.458" class="difflineplus">+  const char *name = ::sqlite3_bind_parameter_name(mDBStatement,</span>
<a href="#l64.459"></a><span id="l64.459" class="difflineplus">+                                                   aParamIndex + 1);</span>
<a href="#l64.460"></a><span id="l64.460" class="difflineplus">+  if (name == NULL) {</span>
<a href="#l64.461"></a><span id="l64.461" class="difflineplus">+    // this thing had no name, so fake one</span>
<a href="#l64.462"></a><span id="l64.462" class="difflineplus">+    nsCAutoString name(&quot;:&quot;);</span>
<a href="#l64.463"></a><span id="l64.463" class="difflineplus">+    name.AppendInt(aParamIndex);</span>
<a href="#l64.464"></a><span id="l64.464" class="difflineplus">+    _name.Assign(name);</span>
<a href="#l64.465"></a><span id="l64.465" class="difflineplus">+  }</span>
<a href="#l64.466"></a><span id="l64.466" class="difflineplus">+  else {</span>
<a href="#l64.467"></a><span id="l64.467" class="difflineplus">+    _name.Assign(nsDependentCString(name));</span>
<a href="#l64.468"></a><span id="l64.468" class="difflineplus">+  }</span>
<a href="#l64.469"></a><span id="l64.469" class="difflineplus">+</span>
<a href="#l64.470"></a><span id="l64.470" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.471"></a><span id="l64.471" class="difflineplus">+}</span>
<a href="#l64.472"></a><span id="l64.472" class="difflineplus">+</span>
<a href="#l64.473"></a><span id="l64.473" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.474"></a><span id="l64.474" class="difflineplus">+Statement::GetParameterIndex(const nsACString &amp;aName,</span>
<a href="#l64.475"></a><span id="l64.475" class="difflineplus">+                             PRUint32 *_index)</span>
<a href="#l64.476"></a><span id="l64.476" class="difflineplus">+{</span>
<a href="#l64.477"></a><span id="l64.477" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.478"></a><span id="l64.478" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.479"></a><span id="l64.479" class="difflineplus">+</span>
<a href="#l64.480"></a><span id="l64.480" class="difflineplus">+  // We do not accept any forms of names other than &quot;:name&quot;, but we need to add</span>
<a href="#l64.481"></a><span id="l64.481" class="difflineplus">+  // the colon for SQLite.</span>
<a href="#l64.482"></a><span id="l64.482" class="difflineplus">+  nsCAutoString name(&quot;:&quot;);</span>
<a href="#l64.483"></a><span id="l64.483" class="difflineplus">+  name.Append(aName);</span>
<a href="#l64.484"></a><span id="l64.484" class="difflineplus">+  int ind = ::sqlite3_bind_parameter_index(mDBStatement,</span>
<a href="#l64.485"></a><span id="l64.485" class="difflineplus">+                                           PromiseFlatCString(name).get());</span>
<a href="#l64.486"></a><span id="l64.486" class="difflineplus">+  if (ind  == 0) // Named parameter not found.</span>
<a href="#l64.487"></a><span id="l64.487" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l64.488"></a><span id="l64.488" class="difflineplus">+</span>
<a href="#l64.489"></a><span id="l64.489" class="difflineplus">+  *_index = ind - 1; // SQLite indexes are 1-based, we are 0-based.</span>
<a href="#l64.490"></a><span id="l64.490" class="difflineplus">+</span>
<a href="#l64.491"></a><span id="l64.491" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.492"></a><span id="l64.492" class="difflineplus">+}</span>
<a href="#l64.493"></a><span id="l64.493" class="difflineplus">+</span>
<a href="#l64.494"></a><span id="l64.494" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.495"></a><span id="l64.495" class="difflineplus">+Statement::GetColumnCount(PRUint32 *_columnCount)</span>
<a href="#l64.496"></a><span id="l64.496" class="difflineplus">+{</span>
<a href="#l64.497"></a><span id="l64.497" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.498"></a><span id="l64.498" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.499"></a><span id="l64.499" class="difflineplus">+</span>
<a href="#l64.500"></a><span id="l64.500" class="difflineplus">+  *_columnCount = mResultColumnCount;</span>
<a href="#l64.501"></a><span id="l64.501" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.502"></a><span id="l64.502" class="difflineplus">+}</span>
<a href="#l64.503"></a><span id="l64.503" class="difflineplus">+</span>
<a href="#l64.504"></a><span id="l64.504" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.505"></a><span id="l64.505" class="difflineplus">+Statement::GetColumnName(PRUint32 aColumnIndex,</span>
<a href="#l64.506"></a><span id="l64.506" class="difflineplus">+                         nsACString &amp;_name)</span>
<a href="#l64.507"></a><span id="l64.507" class="difflineplus">+{</span>
<a href="#l64.508"></a><span id="l64.508" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.509"></a><span id="l64.509" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.510"></a><span id="l64.510" class="difflineplus">+  ENSURE_INDEX_VALUE(aColumnIndex, mResultColumnCount);</span>
<a href="#l64.511"></a><span id="l64.511" class="difflineplus">+</span>
<a href="#l64.512"></a><span id="l64.512" class="difflineplus">+  const char *cname = ::sqlite3_column_name(mDBStatement, aColumnIndex);</span>
<a href="#l64.513"></a><span id="l64.513" class="difflineplus">+  _name.Assign(nsDependentCString(cname));</span>
<a href="#l64.514"></a><span id="l64.514" class="difflineplus">+</span>
<a href="#l64.515"></a><span id="l64.515" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.516"></a><span id="l64.516" class="difflineplus">+}</span>
<a href="#l64.517"></a><span id="l64.517" class="difflineplus">+</span>
<a href="#l64.518"></a><span id="l64.518" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.519"></a><span id="l64.519" class="difflineplus">+Statement::GetColumnIndex(const nsACString &amp;aName,</span>
<a href="#l64.520"></a><span id="l64.520" class="difflineplus">+                          PRUint32 *_index)</span>
<a href="#l64.521"></a><span id="l64.521" class="difflineplus">+{</span>
<a href="#l64.522"></a><span id="l64.522" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.523"></a><span id="l64.523" class="difflineplus">+      return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.524"></a><span id="l64.524" class="difflineplus">+</span>
<a href="#l64.525"></a><span id="l64.525" class="difflineplus">+  // Surprisingly enough, SQLite doesn't provide an API for this.  We have to</span>
<a href="#l64.526"></a><span id="l64.526" class="difflineplus">+  // determine it ourselves sadly.</span>
<a href="#l64.527"></a><span id="l64.527" class="difflineplus">+  for (PRUint32 i = 0; i &lt; mResultColumnCount; i++) {</span>
<a href="#l64.528"></a><span id="l64.528" class="difflineplus">+    if (mColumnNames[i].Equals(aName)) {</span>
<a href="#l64.529"></a><span id="l64.529" class="difflineplus">+      *_index = i;</span>
<a href="#l64.530"></a><span id="l64.530" class="difflineplus">+      return NS_OK;</span>
<a href="#l64.531"></a><span id="l64.531" class="difflineplus">+    }</span>
<a href="#l64.532"></a><span id="l64.532" class="difflineplus">+  }</span>
<a href="#l64.533"></a><span id="l64.533" class="difflineplus">+</span>
<a href="#l64.534"></a><span id="l64.534" class="difflineplus">+  return NS_ERROR_INVALID_ARG;</span>
<a href="#l64.535"></a><span id="l64.535" class="difflineplus">+}</span>
<a href="#l64.536"></a><span id="l64.536" class="difflineplus">+</span>
<a href="#l64.537"></a><span id="l64.537" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.538"></a><span id="l64.538" class="difflineplus">+Statement::Reset()</span>
<a href="#l64.539"></a><span id="l64.539" class="difflineplus">+{</span>
<a href="#l64.540"></a><span id="l64.540" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.541"></a><span id="l64.541" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.542"></a><span id="l64.542" class="difflineplus">+</span>
<a href="#l64.543"></a><span id="l64.543" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l64.544"></a><span id="l64.544" class="difflineplus">+  PR_LOG(gStorageLog, PR_LOG_DEBUG, (&quot;Resetting statement: '%s'&quot;,</span>
<a href="#l64.545"></a><span id="l64.545" class="difflineplus">+                                     ::sqlite3_sql(mDBStatement)));</span>
<a href="#l64.546"></a><span id="l64.546" class="difflineplus">+</span>
<a href="#l64.547"></a><span id="l64.547" class="difflineplus">+  checkAndLogStatementPerformance(mDBStatement);</span>
<a href="#l64.548"></a><span id="l64.548" class="difflineplus">+#endif</span>
<a href="#l64.549"></a><span id="l64.549" class="difflineplus">+</span>
<a href="#l64.550"></a><span id="l64.550" class="difflineplus">+  mParamsArray = nsnull;</span>
<a href="#l64.551"></a><span id="l64.551" class="difflineplus">+  (void)sqlite3_reset(mDBStatement);</span>
<a href="#l64.552"></a><span id="l64.552" class="difflineplus">+  (void)sqlite3_clear_bindings(mDBStatement);</span>
<a href="#l64.553"></a><span id="l64.553" class="difflineplus">+</span>
<a href="#l64.554"></a><span id="l64.554" class="difflineplus">+  mExecuting = false;</span>
<a href="#l64.555"></a><span id="l64.555" class="difflineplus">+</span>
<a href="#l64.556"></a><span id="l64.556" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.557"></a><span id="l64.557" class="difflineplus">+}</span>
<a href="#l64.558"></a><span id="l64.558" class="difflineplus">+</span>
<a href="#l64.559"></a><span id="l64.559" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.560"></a><span id="l64.560" class="difflineplus">+Statement::BindParameters(mozIStorageBindingParamsArray *aParameters)</span>
<a href="#l64.561"></a><span id="l64.561" class="difflineplus">+{</span>
<a href="#l64.562"></a><span id="l64.562" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.563"></a><span id="l64.563" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.564"></a><span id="l64.564" class="difflineplus">+</span>
<a href="#l64.565"></a><span id="l64.565" class="difflineplus">+  BindingParamsArray *array = static_cast&lt;BindingParamsArray *&gt;(aParameters);</span>
<a href="#l64.566"></a><span id="l64.566" class="difflineplus">+  if (array-&gt;getOwner() != this)</span>
<a href="#l64.567"></a><span id="l64.567" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.568"></a><span id="l64.568" class="difflineplus">+</span>
<a href="#l64.569"></a><span id="l64.569" class="difflineplus">+  mParamsArray = array;</span>
<a href="#l64.570"></a><span id="l64.570" class="difflineplus">+  mParamsArray-&gt;lock();</span>
<a href="#l64.571"></a><span id="l64.571" class="difflineplus">+</span>
<a href="#l64.572"></a><span id="l64.572" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.573"></a><span id="l64.573" class="difflineplus">+}</span>
<a href="#l64.574"></a><span id="l64.574" class="difflineplus">+</span>
<a href="#l64.575"></a><span id="l64.575" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.576"></a><span id="l64.576" class="difflineplus">+Statement::Execute()</span>
<a href="#l64.577"></a><span id="l64.577" class="difflineplus">+{</span>
<a href="#l64.578"></a><span id="l64.578" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.579"></a><span id="l64.579" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.580"></a><span id="l64.580" class="difflineplus">+</span>
<a href="#l64.581"></a><span id="l64.581" class="difflineplus">+  PRBool ret;</span>
<a href="#l64.582"></a><span id="l64.582" class="difflineplus">+  nsresult rv = ExecuteStep(&amp;ret);</span>
<a href="#l64.583"></a><span id="l64.583" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.584"></a><span id="l64.584" class="difflineplus">+</span>
<a href="#l64.585"></a><span id="l64.585" class="difflineplus">+  return Reset();</span>
<a href="#l64.586"></a><span id="l64.586" class="difflineplus">+}</span>
<a href="#l64.587"></a><span id="l64.587" class="difflineplus">+</span>
<a href="#l64.588"></a><span id="l64.588" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.589"></a><span id="l64.589" class="difflineplus">+Statement::ExecuteStep(PRBool *_moreResults)</span>
<a href="#l64.590"></a><span id="l64.590" class="difflineplus">+{</span>
<a href="#l64.591"></a><span id="l64.591" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.592"></a><span id="l64.592" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.593"></a><span id="l64.593" class="difflineplus">+</span>
<a href="#l64.594"></a><span id="l64.594" class="difflineplus">+  // Bind any parameters first before executing.</span>
<a href="#l64.595"></a><span id="l64.595" class="difflineplus">+  if (mParamsArray) {</span>
<a href="#l64.596"></a><span id="l64.596" class="difflineplus">+    // If we have more than one row of parameters to bind, they shouldn't be</span>
<a href="#l64.597"></a><span id="l64.597" class="difflineplus">+    // calling this method (and instead use executeAsync).</span>
<a href="#l64.598"></a><span id="l64.598" class="difflineplus">+    if (mParamsArray-&gt;length() != 1)</span>
<a href="#l64.599"></a><span id="l64.599" class="difflineplus">+      return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.600"></a><span id="l64.600" class="difflineplus">+</span>
<a href="#l64.601"></a><span id="l64.601" class="difflineplus">+    BindingParamsArray::iterator row = mParamsArray-&gt;begin();</span>
<a href="#l64.602"></a><span id="l64.602" class="difflineplus">+    nsCOMPtr&lt;IStorageBindingParamsInternal&gt; bindingInternal = </span>
<a href="#l64.603"></a><span id="l64.603" class="difflineplus">+      do_QueryInterface(*row);</span>
<a href="#l64.604"></a><span id="l64.604" class="difflineplus">+    nsCOMPtr&lt;mozIStorageError&gt; error = bindingInternal-&gt;bind(mDBStatement);</span>
<a href="#l64.605"></a><span id="l64.605" class="difflineplus">+    if (error) {</span>
<a href="#l64.606"></a><span id="l64.606" class="difflineplus">+      PRInt32 srv;</span>
<a href="#l64.607"></a><span id="l64.607" class="difflineplus">+      (void)error-&gt;GetResult(&amp;srv);</span>
<a href="#l64.608"></a><span id="l64.608" class="difflineplus">+      return convertResultCode(srv);</span>
<a href="#l64.609"></a><span id="l64.609" class="difflineplus">+    }</span>
<a href="#l64.610"></a><span id="l64.610" class="difflineplus">+</span>
<a href="#l64.611"></a><span id="l64.611" class="difflineplus">+    // We have bound, so now we can clear our array.</span>
<a href="#l64.612"></a><span id="l64.612" class="difflineplus">+    mParamsArray = nsnull;</span>
<a href="#l64.613"></a><span id="l64.613" class="difflineplus">+  }</span>
<a href="#l64.614"></a><span id="l64.614" class="difflineplus">+  int srv = ::sqlite3_step(mDBStatement);</span>
<a href="#l64.615"></a><span id="l64.615" class="difflineplus">+</span>
<a href="#l64.616"></a><span id="l64.616" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.617"></a><span id="l64.617" class="difflineplus">+  if (srv != SQLITE_ROW &amp;&amp; srv != SQLITE_DONE) {</span>
<a href="#l64.618"></a><span id="l64.618" class="difflineplus">+      nsCAutoString errStr;</span>
<a href="#l64.619"></a><span id="l64.619" class="difflineplus">+      (void)mDBConnection-&gt;GetLastErrorString(errStr);</span>
<a href="#l64.620"></a><span id="l64.620" class="difflineplus">+      PR_LOG(gStorageLog, PR_LOG_DEBUG,</span>
<a href="#l64.621"></a><span id="l64.621" class="difflineplus">+             (&quot;Statement::ExecuteStep error: %s&quot;, errStr.get()));</span>
<a href="#l64.622"></a><span id="l64.622" class="difflineplus">+  }</span>
<a href="#l64.623"></a><span id="l64.623" class="difflineplus">+#endif</span>
<a href="#l64.624"></a><span id="l64.624" class="difflineplus">+</span>
<a href="#l64.625"></a><span id="l64.625" class="difflineplus">+  // SQLITE_ROW and SQLITE_DONE are non-errors</span>
<a href="#l64.626"></a><span id="l64.626" class="difflineplus">+  if (srv == SQLITE_ROW) {</span>
<a href="#l64.627"></a><span id="l64.627" class="difflineplus">+    // we got a row back</span>
<a href="#l64.628"></a><span id="l64.628" class="difflineplus">+    mExecuting = true;</span>
<a href="#l64.629"></a><span id="l64.629" class="difflineplus">+    *_moreResults = PR_TRUE;</span>
<a href="#l64.630"></a><span id="l64.630" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.631"></a><span id="l64.631" class="difflineplus">+  }</span>
<a href="#l64.632"></a><span id="l64.632" class="difflineplus">+  else if (srv == SQLITE_DONE) {</span>
<a href="#l64.633"></a><span id="l64.633" class="difflineplus">+    // statement is done (no row returned)</span>
<a href="#l64.634"></a><span id="l64.634" class="difflineplus">+    mExecuting = false;</span>
<a href="#l64.635"></a><span id="l64.635" class="difflineplus">+    *_moreResults = PR_FALSE;</span>
<a href="#l64.636"></a><span id="l64.636" class="difflineplus">+    return NS_OK;</span>
<a href="#l64.637"></a><span id="l64.637" class="difflineplus">+  }</span>
<a href="#l64.638"></a><span id="l64.638" class="difflineplus">+  else if (srv == SQLITE_BUSY || srv == SQLITE_MISUSE) {</span>
<a href="#l64.639"></a><span id="l64.639" class="difflineplus">+    mExecuting = PR_FALSE;</span>
<a href="#l64.640"></a><span id="l64.640" class="difflineplus">+  }</span>
<a href="#l64.641"></a><span id="l64.641" class="difflineplus">+  else if (mExecuting) {</span>
<a href="#l64.642"></a><span id="l64.642" class="difflineplus">+#ifdef PR_LOGGING</span>
<a href="#l64.643"></a><span id="l64.643" class="difflineplus">+    PR_LOG(gStorageLog, PR_LOG_ERROR,</span>
<a href="#l64.644"></a><span id="l64.644" class="difflineplus">+           (&quot;SQLite error after mExecuting was true!&quot;));</span>
<a href="#l64.645"></a><span id="l64.645" class="difflineplus">+#endif</span>
<a href="#l64.646"></a><span id="l64.646" class="difflineplus">+    mExecuting = PR_FALSE;</span>
<a href="#l64.647"></a><span id="l64.647" class="difflineplus">+  }</span>
<a href="#l64.648"></a><span id="l64.648" class="difflineplus">+</span>
<a href="#l64.649"></a><span id="l64.649" class="difflineplus">+  return convertResultCode(srv);</span>
<a href="#l64.650"></a><span id="l64.650" class="difflineplus">+}</span>
<a href="#l64.651"></a><span id="l64.651" class="difflineplus">+</span>
<a href="#l64.652"></a><span id="l64.652" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.653"></a><span id="l64.653" class="difflineplus">+Statement::GetState(PRInt32 *_state)</span>
<a href="#l64.654"></a><span id="l64.654" class="difflineplus">+{</span>
<a href="#l64.655"></a><span id="l64.655" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.656"></a><span id="l64.656" class="difflineplus">+    *_state = MOZ_STORAGE_STATEMENT_INVALID;</span>
<a href="#l64.657"></a><span id="l64.657" class="difflineplus">+  else if (mExecuting)</span>
<a href="#l64.658"></a><span id="l64.658" class="difflineplus">+    *_state = MOZ_STORAGE_STATEMENT_EXECUTING;</span>
<a href="#l64.659"></a><span id="l64.659" class="difflineplus">+  else</span>
<a href="#l64.660"></a><span id="l64.660" class="difflineplus">+    *_state = MOZ_STORAGE_STATEMENT_READY;</span>
<a href="#l64.661"></a><span id="l64.661" class="difflineplus">+</span>
<a href="#l64.662"></a><span id="l64.662" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.663"></a><span id="l64.663" class="difflineplus">+}</span>
<a href="#l64.664"></a><span id="l64.664" class="difflineplus">+</span>
<a href="#l64.665"></a><span id="l64.665" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.666"></a><span id="l64.666" class="difflineplus">+Statement::GetColumnDecltype(PRUint32 aParamIndex,</span>
<a href="#l64.667"></a><span id="l64.667" class="difflineplus">+                             nsACString &amp;_declType)</span>
<a href="#l64.668"></a><span id="l64.668" class="difflineplus">+{</span>
<a href="#l64.669"></a><span id="l64.669" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.670"></a><span id="l64.670" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.671"></a><span id="l64.671" class="difflineplus">+</span>
<a href="#l64.672"></a><span id="l64.672" class="difflineplus">+  ENSURE_INDEX_VALUE(aParamIndex, mResultColumnCount);</span>
<a href="#l64.673"></a><span id="l64.673" class="difflineplus">+</span>
<a href="#l64.674"></a><span id="l64.674" class="difflineplus">+  _declType.Assign(::sqlite3_column_decltype(mDBStatement, aParamIndex));</span>
<a href="#l64.675"></a><span id="l64.675" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.676"></a><span id="l64.676" class="difflineplus">+}</span>
<a href="#l64.677"></a><span id="l64.677" class="difflineplus">+</span>
<a href="#l64.678"></a><span id="l64.678" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.679"></a><span id="l64.679" class="difflineplus">+//// mozIStorageValueArray (now part of mozIStorageStatement too)</span>
<a href="#l64.680"></a><span id="l64.680" class="difflineplus">+</span>
<a href="#l64.681"></a><span id="l64.681" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.682"></a><span id="l64.682" class="difflineplus">+Statement::GetNumEntries(PRUint32 *_length)</span>
<a href="#l64.683"></a><span id="l64.683" class="difflineplus">+{</span>
<a href="#l64.684"></a><span id="l64.684" class="difflineplus">+  *_length = mResultColumnCount;</span>
<a href="#l64.685"></a><span id="l64.685" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.686"></a><span id="l64.686" class="difflineplus">+}</span>
<a href="#l64.687"></a><span id="l64.687" class="difflineplus">+</span>
<a href="#l64.688"></a><span id="l64.688" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.689"></a><span id="l64.689" class="difflineplus">+Statement::GetTypeOfIndex(PRUint32 aIndex,</span>
<a href="#l64.690"></a><span id="l64.690" class="difflineplus">+                          PRInt32 *_type)</span>
<a href="#l64.691"></a><span id="l64.691" class="difflineplus">+{</span>
<a href="#l64.692"></a><span id="l64.692" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.693"></a><span id="l64.693" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.694"></a><span id="l64.694" class="difflineplus">+</span>
<a href="#l64.695"></a><span id="l64.695" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mResultColumnCount);</span>
<a href="#l64.696"></a><span id="l64.696" class="difflineplus">+</span>
<a href="#l64.697"></a><span id="l64.697" class="difflineplus">+  if (!mExecuting)</span>
<a href="#l64.698"></a><span id="l64.698" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.699"></a><span id="l64.699" class="difflineplus">+</span>
<a href="#l64.700"></a><span id="l64.700" class="difflineplus">+  int t = ::sqlite3_column_type(mDBStatement, aIndex);</span>
<a href="#l64.701"></a><span id="l64.701" class="difflineplus">+  switch (t) {</span>
<a href="#l64.702"></a><span id="l64.702" class="difflineplus">+    case SQLITE_INTEGER:</span>
<a href="#l64.703"></a><span id="l64.703" class="difflineplus">+      *_type = mozIStorageStatement::VALUE_TYPE_INTEGER;</span>
<a href="#l64.704"></a><span id="l64.704" class="difflineplus">+      break;</span>
<a href="#l64.705"></a><span id="l64.705" class="difflineplus">+    case SQLITE_FLOAT:</span>
<a href="#l64.706"></a><span id="l64.706" class="difflineplus">+      *_type = mozIStorageStatement::VALUE_TYPE_FLOAT;</span>
<a href="#l64.707"></a><span id="l64.707" class="difflineplus">+      break;</span>
<a href="#l64.708"></a><span id="l64.708" class="difflineplus">+    case SQLITE_TEXT:</span>
<a href="#l64.709"></a><span id="l64.709" class="difflineplus">+      *_type = mozIStorageStatement::VALUE_TYPE_TEXT;</span>
<a href="#l64.710"></a><span id="l64.710" class="difflineplus">+      break;</span>
<a href="#l64.711"></a><span id="l64.711" class="difflineplus">+    case SQLITE_BLOB:</span>
<a href="#l64.712"></a><span id="l64.712" class="difflineplus">+      *_type = mozIStorageStatement::VALUE_TYPE_BLOB;</span>
<a href="#l64.713"></a><span id="l64.713" class="difflineplus">+      break;</span>
<a href="#l64.714"></a><span id="l64.714" class="difflineplus">+    case SQLITE_NULL:</span>
<a href="#l64.715"></a><span id="l64.715" class="difflineplus">+      *_type = mozIStorageStatement::VALUE_TYPE_NULL;</span>
<a href="#l64.716"></a><span id="l64.716" class="difflineplus">+      break;</span>
<a href="#l64.717"></a><span id="l64.717" class="difflineplus">+    default:</span>
<a href="#l64.718"></a><span id="l64.718" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l64.719"></a><span id="l64.719" class="difflineplus">+  }</span>
<a href="#l64.720"></a><span id="l64.720" class="difflineplus">+</span>
<a href="#l64.721"></a><span id="l64.721" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.722"></a><span id="l64.722" class="difflineplus">+}</span>
<a href="#l64.723"></a><span id="l64.723" class="difflineplus">+</span>
<a href="#l64.724"></a><span id="l64.724" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.725"></a><span id="l64.725" class="difflineplus">+Statement::GetInt32(PRUint32 aIndex,</span>
<a href="#l64.726"></a><span id="l64.726" class="difflineplus">+                    PRInt32 *_value)</span>
<a href="#l64.727"></a><span id="l64.727" class="difflineplus">+{</span>
<a href="#l64.728"></a><span id="l64.728" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.729"></a><span id="l64.729" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.730"></a><span id="l64.730" class="difflineplus">+</span>
<a href="#l64.731"></a><span id="l64.731" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mResultColumnCount);</span>
<a href="#l64.732"></a><span id="l64.732" class="difflineplus">+</span>
<a href="#l64.733"></a><span id="l64.733" class="difflineplus">+  if (!mExecuting)</span>
<a href="#l64.734"></a><span id="l64.734" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.735"></a><span id="l64.735" class="difflineplus">+</span>
<a href="#l64.736"></a><span id="l64.736" class="difflineplus">+  *_value = ::sqlite3_column_int(mDBStatement, aIndex);</span>
<a href="#l64.737"></a><span id="l64.737" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.738"></a><span id="l64.738" class="difflineplus">+}</span>
<a href="#l64.739"></a><span id="l64.739" class="difflineplus">+</span>
<a href="#l64.740"></a><span id="l64.740" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.741"></a><span id="l64.741" class="difflineplus">+Statement::GetInt64(PRUint32 aIndex,</span>
<a href="#l64.742"></a><span id="l64.742" class="difflineplus">+                    PRInt64 *_value)</span>
<a href="#l64.743"></a><span id="l64.743" class="difflineplus">+{</span>
<a href="#l64.744"></a><span id="l64.744" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.745"></a><span id="l64.745" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.746"></a><span id="l64.746" class="difflineplus">+</span>
<a href="#l64.747"></a><span id="l64.747" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mResultColumnCount);</span>
<a href="#l64.748"></a><span id="l64.748" class="difflineplus">+</span>
<a href="#l64.749"></a><span id="l64.749" class="difflineplus">+  if (!mExecuting)</span>
<a href="#l64.750"></a><span id="l64.750" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.751"></a><span id="l64.751" class="difflineplus">+</span>
<a href="#l64.752"></a><span id="l64.752" class="difflineplus">+  *_value = ::sqlite3_column_int64(mDBStatement, aIndex);</span>
<a href="#l64.753"></a><span id="l64.753" class="difflineplus">+</span>
<a href="#l64.754"></a><span id="l64.754" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.755"></a><span id="l64.755" class="difflineplus">+}</span>
<a href="#l64.756"></a><span id="l64.756" class="difflineplus">+</span>
<a href="#l64.757"></a><span id="l64.757" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.758"></a><span id="l64.758" class="difflineplus">+Statement::GetDouble(PRUint32 aIndex,</span>
<a href="#l64.759"></a><span id="l64.759" class="difflineplus">+                     double *_value)</span>
<a href="#l64.760"></a><span id="l64.760" class="difflineplus">+{</span>
<a href="#l64.761"></a><span id="l64.761" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.762"></a><span id="l64.762" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.763"></a><span id="l64.763" class="difflineplus">+</span>
<a href="#l64.764"></a><span id="l64.764" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mResultColumnCount);</span>
<a href="#l64.765"></a><span id="l64.765" class="difflineplus">+</span>
<a href="#l64.766"></a><span id="l64.766" class="difflineplus">+  if (!mExecuting)</span>
<a href="#l64.767"></a><span id="l64.767" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.768"></a><span id="l64.768" class="difflineplus">+</span>
<a href="#l64.769"></a><span id="l64.769" class="difflineplus">+  *_value = ::sqlite3_column_double(mDBStatement, aIndex);</span>
<a href="#l64.770"></a><span id="l64.770" class="difflineplus">+</span>
<a href="#l64.771"></a><span id="l64.771" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.772"></a><span id="l64.772" class="difflineplus">+}</span>
<a href="#l64.773"></a><span id="l64.773" class="difflineplus">+</span>
<a href="#l64.774"></a><span id="l64.774" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.775"></a><span id="l64.775" class="difflineplus">+Statement::GetUTF8String(PRUint32 aIndex,</span>
<a href="#l64.776"></a><span id="l64.776" class="difflineplus">+                         nsACString &amp;_value)</span>
<a href="#l64.777"></a><span id="l64.777" class="difflineplus">+{</span>
<a href="#l64.778"></a><span id="l64.778" class="difflineplus">+  // Get type of Index will check aIndex for us, so we don't have to.</span>
<a href="#l64.779"></a><span id="l64.779" class="difflineplus">+  PRInt32 type;</span>
<a href="#l64.780"></a><span id="l64.780" class="difflineplus">+  nsresult rv = GetTypeOfIndex(aIndex, &amp;type);</span>
<a href="#l64.781"></a><span id="l64.781" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.782"></a><span id="l64.782" class="difflineplus">+  if (type == mozIStorageStatement::VALUE_TYPE_NULL) {</span>
<a href="#l64.783"></a><span id="l64.783" class="difflineplus">+    // NULL columns should have IsVod set to distinguis them from an empty</span>
<a href="#l64.784"></a><span id="l64.784" class="difflineplus">+    // string.</span>
<a href="#l64.785"></a><span id="l64.785" class="difflineplus">+    _value.Truncate(0);</span>
<a href="#l64.786"></a><span id="l64.786" class="difflineplus">+    _value.SetIsVoid(PR_TRUE);</span>
<a href="#l64.787"></a><span id="l64.787" class="difflineplus">+  }</span>
<a href="#l64.788"></a><span id="l64.788" class="difflineplus">+  else {</span>
<a href="#l64.789"></a><span id="l64.789" class="difflineplus">+    const char *value =</span>
<a href="#l64.790"></a><span id="l64.790" class="difflineplus">+      reinterpret_cast&lt;const char *&gt;(::sqlite3_column_text(mDBStatement,</span>
<a href="#l64.791"></a><span id="l64.791" class="difflineplus">+                                                           aIndex));</span>
<a href="#l64.792"></a><span id="l64.792" class="difflineplus">+    _value.Assign(value, ::sqlite3_column_bytes(mDBStatement, aIndex));</span>
<a href="#l64.793"></a><span id="l64.793" class="difflineplus">+  }</span>
<a href="#l64.794"></a><span id="l64.794" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.795"></a><span id="l64.795" class="difflineplus">+}</span>
<a href="#l64.796"></a><span id="l64.796" class="difflineplus">+</span>
<a href="#l64.797"></a><span id="l64.797" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.798"></a><span id="l64.798" class="difflineplus">+Statement::GetString(PRUint32 aIndex,</span>
<a href="#l64.799"></a><span id="l64.799" class="difflineplus">+                     nsAString &amp;_value)</span>
<a href="#l64.800"></a><span id="l64.800" class="difflineplus">+{</span>
<a href="#l64.801"></a><span id="l64.801" class="difflineplus">+  // Get type of Index will check aIndex for us, so we don't have to.</span>
<a href="#l64.802"></a><span id="l64.802" class="difflineplus">+  PRInt32 type;</span>
<a href="#l64.803"></a><span id="l64.803" class="difflineplus">+  nsresult rv = GetTypeOfIndex(aIndex, &amp;type);</span>
<a href="#l64.804"></a><span id="l64.804" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.805"></a><span id="l64.805" class="difflineplus">+  if (type == mozIStorageStatement::VALUE_TYPE_NULL) {</span>
<a href="#l64.806"></a><span id="l64.806" class="difflineplus">+    // NULL columns should have IsVod set to distinguis them from an empty</span>
<a href="#l64.807"></a><span id="l64.807" class="difflineplus">+    // string.</span>
<a href="#l64.808"></a><span id="l64.808" class="difflineplus">+    _value.Truncate(0);</span>
<a href="#l64.809"></a><span id="l64.809" class="difflineplus">+    _value.SetIsVoid(PR_TRUE);</span>
<a href="#l64.810"></a><span id="l64.810" class="difflineplus">+  } else {</span>
<a href="#l64.811"></a><span id="l64.811" class="difflineplus">+    const PRUnichar *value =</span>
<a href="#l64.812"></a><span id="l64.812" class="difflineplus">+      static_cast&lt;const PRUnichar *&gt;(::sqlite3_column_text16(mDBStatement,</span>
<a href="#l64.813"></a><span id="l64.813" class="difflineplus">+                                                             aIndex));</span>
<a href="#l64.814"></a><span id="l64.814" class="difflineplus">+    _value.Assign(value, ::sqlite3_column_bytes16(mDBStatement, aIndex) / 2);</span>
<a href="#l64.815"></a><span id="l64.815" class="difflineplus">+  }</span>
<a href="#l64.816"></a><span id="l64.816" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.817"></a><span id="l64.817" class="difflineplus">+}</span>
<a href="#l64.818"></a><span id="l64.818" class="difflineplus">+</span>
<a href="#l64.819"></a><span id="l64.819" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.820"></a><span id="l64.820" class="difflineplus">+Statement::GetBlob(PRUint32 aIndex,</span>
<a href="#l64.821"></a><span id="l64.821" class="difflineplus">+                   PRUint32 *_size,</span>
<a href="#l64.822"></a><span id="l64.822" class="difflineplus">+                   PRUint8 **_blob)</span>
<a href="#l64.823"></a><span id="l64.823" class="difflineplus">+{</span>
<a href="#l64.824"></a><span id="l64.824" class="difflineplus">+  if (!mDBStatement)</span>
<a href="#l64.825"></a><span id="l64.825" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l64.826"></a><span id="l64.826" class="difflineplus">+</span>
<a href="#l64.827"></a><span id="l64.827" class="difflineplus">+  ENSURE_INDEX_VALUE(aIndex, mResultColumnCount);</span>
<a href="#l64.828"></a><span id="l64.828" class="difflineplus">+</span>
<a href="#l64.829"></a><span id="l64.829" class="difflineplus">+  if (!mExecuting)</span>
<a href="#l64.830"></a><span id="l64.830" class="difflineplus">+     return NS_ERROR_UNEXPECTED;</span>
<a href="#l64.831"></a><span id="l64.831" class="difflineplus">+</span>
<a href="#l64.832"></a><span id="l64.832" class="difflineplus">+  int size = ::sqlite3_column_bytes(mDBStatement, aIndex);</span>
<a href="#l64.833"></a><span id="l64.833" class="difflineplus">+  void *blob = nsnull;</span>
<a href="#l64.834"></a><span id="l64.834" class="difflineplus">+  if (size) {</span>
<a href="#l64.835"></a><span id="l64.835" class="difflineplus">+    blob = nsMemory::Clone(::sqlite3_column_blob(mDBStatement, aIndex), size);</span>
<a href="#l64.836"></a><span id="l64.836" class="difflineplus">+    NS_ENSURE_TRUE(blob, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l64.837"></a><span id="l64.837" class="difflineplus">+  }</span>
<a href="#l64.838"></a><span id="l64.838" class="difflineplus">+</span>
<a href="#l64.839"></a><span id="l64.839" class="difflineplus">+  *_blob = static_cast&lt;PRUint8 *&gt;(blob);</span>
<a href="#l64.840"></a><span id="l64.840" class="difflineplus">+  *_size = size;</span>
<a href="#l64.841"></a><span id="l64.841" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.842"></a><span id="l64.842" class="difflineplus">+}</span>
<a href="#l64.843"></a><span id="l64.843" class="difflineplus">+</span>
<a href="#l64.844"></a><span id="l64.844" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.845"></a><span id="l64.845" class="difflineplus">+Statement::GetSharedUTF8String(PRUint32 aIndex,</span>
<a href="#l64.846"></a><span id="l64.846" class="difflineplus">+                               PRUint32 *_length,</span>
<a href="#l64.847"></a><span id="l64.847" class="difflineplus">+                               const char **_value)</span>
<a href="#l64.848"></a><span id="l64.848" class="difflineplus">+{</span>
<a href="#l64.849"></a><span id="l64.849" class="difflineplus">+  if (_length)</span>
<a href="#l64.850"></a><span id="l64.850" class="difflineplus">+    *_length = ::sqlite3_column_bytes(mDBStatement, aIndex);</span>
<a href="#l64.851"></a><span id="l64.851" class="difflineplus">+</span>
<a href="#l64.852"></a><span id="l64.852" class="difflineplus">+  *_value = reinterpret_cast&lt;const char *&gt;(::sqlite3_column_text(mDBStatement,</span>
<a href="#l64.853"></a><span id="l64.853" class="difflineplus">+                                                                 aIndex));</span>
<a href="#l64.854"></a><span id="l64.854" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.855"></a><span id="l64.855" class="difflineplus">+}</span>
<a href="#l64.856"></a><span id="l64.856" class="difflineplus">+</span>
<a href="#l64.857"></a><span id="l64.857" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.858"></a><span id="l64.858" class="difflineplus">+Statement::GetSharedString(PRUint32 aIndex,</span>
<a href="#l64.859"></a><span id="l64.859" class="difflineplus">+                           PRUint32 *_length,</span>
<a href="#l64.860"></a><span id="l64.860" class="difflineplus">+                           const PRUnichar **_value)</span>
<a href="#l64.861"></a><span id="l64.861" class="difflineplus">+{</span>
<a href="#l64.862"></a><span id="l64.862" class="difflineplus">+  if (_length)</span>
<a href="#l64.863"></a><span id="l64.863" class="difflineplus">+    *_length = ::sqlite3_column_bytes16(mDBStatement, aIndex);</span>
<a href="#l64.864"></a><span id="l64.864" class="difflineplus">+</span>
<a href="#l64.865"></a><span id="l64.865" class="difflineplus">+  *_value = static_cast&lt;const PRUnichar *&gt;(::sqlite3_column_text16(mDBStatement,</span>
<a href="#l64.866"></a><span id="l64.866" class="difflineplus">+                                                                   aIndex));</span>
<a href="#l64.867"></a><span id="l64.867" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.868"></a><span id="l64.868" class="difflineplus">+}</span>
<a href="#l64.869"></a><span id="l64.869" class="difflineplus">+</span>
<a href="#l64.870"></a><span id="l64.870" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.871"></a><span id="l64.871" class="difflineplus">+Statement::GetSharedBlob(PRUint32 aIndex,</span>
<a href="#l64.872"></a><span id="l64.872" class="difflineplus">+                         PRUint32 *_size,</span>
<a href="#l64.873"></a><span id="l64.873" class="difflineplus">+                         const PRUint8 **_blob)</span>
<a href="#l64.874"></a><span id="l64.874" class="difflineplus">+{</span>
<a href="#l64.875"></a><span id="l64.875" class="difflineplus">+  *_size = ::sqlite3_column_bytes(mDBStatement, aIndex);</span>
<a href="#l64.876"></a><span id="l64.876" class="difflineplus">+  *_blob = static_cast&lt;const PRUint8 *&gt;(::sqlite3_column_blob(mDBStatement,</span>
<a href="#l64.877"></a><span id="l64.877" class="difflineplus">+                                                              aIndex));</span>
<a href="#l64.878"></a><span id="l64.878" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.879"></a><span id="l64.879" class="difflineplus">+}</span>
<a href="#l64.880"></a><span id="l64.880" class="difflineplus">+</span>
<a href="#l64.881"></a><span id="l64.881" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l64.882"></a><span id="l64.882" class="difflineplus">+Statement::GetIsNull(PRUint32 aIndex,</span>
<a href="#l64.883"></a><span id="l64.883" class="difflineplus">+                     PRBool *_isNull)</span>
<a href="#l64.884"></a><span id="l64.884" class="difflineplus">+{</span>
<a href="#l64.885"></a><span id="l64.885" class="difflineplus">+  // Get type of Index will check aIndex for us, so we don't have to.</span>
<a href="#l64.886"></a><span id="l64.886" class="difflineplus">+  PRInt32 type;</span>
<a href="#l64.887"></a><span id="l64.887" class="difflineplus">+  nsresult rv = GetTypeOfIndex(aIndex, &amp;type);</span>
<a href="#l64.888"></a><span id="l64.888" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.889"></a><span id="l64.889" class="difflineplus">+  *_isNull = (type == mozIStorageStatement::VALUE_TYPE_NULL);</span>
<a href="#l64.890"></a><span id="l64.890" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.891"></a><span id="l64.891" class="difflineplus">+}</span>
<a href="#l64.892"></a><span id="l64.892" class="difflineplus">+</span>
<a href="#l64.893"></a><span id="l64.893" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.894"></a><span id="l64.894" class="difflineplus">+//// mozIStorageBindingParams</span>
<a href="#l64.895"></a><span id="l64.895" class="difflineplus">+</span>
<a href="#l64.896"></a><span id="l64.896" class="difflineplus">+BOILERPLATE_BIND_PROXIES(</span>
<a href="#l64.897"></a><span id="l64.897" class="difflineplus">+  Statement, </span>
<a href="#l64.898"></a><span id="l64.898" class="difflineplus">+  if (!mDBStatement) return NS_ERROR_NOT_INITIALIZED;)</span>
<a href="#l64.899"></a><span id="l64.899" class="difflineplus">+</span>
<a href="#l64.900"></a><span id="l64.900" class="difflineplus">+} // namespace storage</span>
<a href="#l64.901"></a><span id="l64.901" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1">new file mode 100644</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineminus">--- /dev/null</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatement.h</span>
<a href="#l65.4"></a><span id="l65.4" class="difflineat">@@ -0,0 +1,146 @@</span>
<a href="#l65.5"></a><span id="l65.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l65.6"></a><span id="l65.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l65.7"></a><span id="l65.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l65.8"></a><span id="l65.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineplus">+ *</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l65.11"></a><span id="l65.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+ *</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+ * License.</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+ *</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+ *</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineplus">+ *</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l65.29"></a><span id="l65.29" class="difflineplus">+ *</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineplus">+ *</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineplus">+</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineplus">+#ifndef _mozStorageStatement_h_</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineplus">+#define _mozStorageStatement_h_</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineplus">+</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+#include &quot;mozStorageStatementData.h&quot;</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+#include &quot;mozIStorageValueArray.h&quot;</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineplus">+</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+class nsIXPConnectJSObjectHolder;</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l65.60"></a><span id="l65.60" class="difflineplus">+</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineplus">+namespace mozilla {</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineplus">+namespace storage {</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineplus">+class StatementJSHelper;</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+class Connection;</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineplus">+class Statement : public mozIStorageStatement</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+                , public mozIStorageValueArray</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineplus">+                , public StorageBaseStatementInternal</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineplus">+{</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineplus">+public:</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+  NS_DECL_MOZISTORAGESTATEMENT</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineplus">+  NS_DECL_MOZISTORAGEBASESTATEMENT</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+  NS_DECL_MOZISTORAGEBINDINGPARAMS</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+  // NS_DECL_MOZISTORAGEVALUEARRAY (methods in mozIStorageStatement)</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineplus">+  NS_DECL_STORAGEBASESTATEMENTINTERNAL</span>
<a href="#l65.77"></a><span id="l65.77" class="difflineplus">+</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineplus">+  Statement();</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineplus">+</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+  /**</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+   * Initializes the object on aDBConnection by preparing the SQL statement</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+   * given by aSQLStatement.</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+   *</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineplus">+   * @param aDBConnection</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+   *        The Connection object this statement is associated with.</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineplus">+   * @param aSQLStatement</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineplus">+   *        The SQL statement to prepare that this object will represent.</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+   */</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineplus">+  nsresult initialize(Connection *aDBConnection,</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+                      const nsACString &amp;aSQLStatement);</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineplus">+  /**</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+   * Obtains the native statement pointer.</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineplus">+   */</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+  inline sqlite3_stmt *nativeStatement() { return mDBStatement; }</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineplus">+  /**</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+   * Obtains and transfers ownership of the array of parameters that are bound</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineplus">+   * to this statment.  This can be null.</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+   */</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineplus">+  inline already_AddRefed&lt;BindingParamsArray&gt; bindingParamsArray()</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineplus">+  {</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineplus">+    return mParamsArray.forget();</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+  }</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineplus">+</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineplus">+private:</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+    ~Statement();</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineplus">+</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineplus">+    sqlite3_stmt *mDBStatement;</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+    PRUint32 mParamCount;</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+    PRUint32 mResultColumnCount;</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineplus">+    nsTArray&lt;nsCString&gt; mColumnNames;</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineplus">+    bool mExecuting;</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineplus">+</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+    /**</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineplus">+     * @return a pointer to the BindingParams object to use with our Bind*</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+     *         method.</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+     */</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+    mozIStorageBindingParams *getParams();</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineplus">+</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineplus">+    /**</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineplus">+     * Holds the array of parameters to bind to this statement when we execute</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineplus">+     * it asynchronously.</span>
<a href="#l65.125"></a><span id="l65.125" class="difflineplus">+     */</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineplus">+    nsRefPtr&lt;BindingParamsArray&gt; mParamsArray;</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineplus">+</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineplus">+    /**</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineplus">+     * The following two members are only used with the JS helper.  They cache</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+     * the row and params objects.</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineplus">+     */</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnectJSObjectHolder&gt; mStatementParamsHolder;</span>
<a href="#l65.133"></a><span id="l65.133" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnectJSObjectHolder&gt; mStatementRowHolder;</span>
<a href="#l65.134"></a><span id="l65.134" class="difflineplus">+</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineplus">+  /**</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineplus">+   * Internal version of finalize that allows us to tell it if it is being</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+   * called from the destructor so it can know not to dispatch events that</span>
<a href="#l65.138"></a><span id="l65.138" class="difflineplus">+   * require a reference to us.</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineplus">+   *</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineplus">+   * @param destructing Is the destructor calling?</span>
<a href="#l65.141"></a><span id="l65.141" class="difflineplus">+   */</span>
<a href="#l65.142"></a><span id="l65.142" class="difflineplus">+  nsresult internalFinalize(bool destructing);</span>
<a href="#l65.143"></a><span id="l65.143" class="difflineplus">+</span>
<a href="#l65.144"></a><span id="l65.144" class="difflineplus">+    friend class StatementJSHelper;</span>
<a href="#l65.145"></a><span id="l65.145" class="difflineplus">+};</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineplus">+</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineplus">+} // storage</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineplus">+} // mozilla</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineplus">+</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+#endif // _mozStorageStatement_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1">new file mode 100644</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineminus">--- /dev/null</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementData.h</span>
<a href="#l66.4"></a><span id="l66.4" class="difflineat">@@ -0,0 +1,158 @@</span>
<a href="#l66.5"></a><span id="l66.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l66.6"></a><span id="l66.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l66.7"></a><span id="l66.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l66.8"></a><span id="l66.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l66.9"></a><span id="l66.9" class="difflineplus">+ *</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+ *</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+ * License.</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+ *</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineplus">+ *</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+ *</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+ *</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+ *</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+#ifndef _mozStorageStatementData_h_</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineplus">+#define _mozStorageStatementData_h_</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineplus">+</span>
<a href="#l66.47"></a><span id="l66.47" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineplus">+</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+#include &quot;mozStorageBindingParamsArray.h&quot;</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+#include &quot;mozIStorageBaseStatement.h&quot;</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+#include &quot;mozStorageConnection.h&quot;</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+#include &quot;StorageBaseStatementInternal.h&quot;</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineplus">+struct sqlite3_stmt;</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineplus">+</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineplus">+namespace mozilla {</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineplus">+namespace storage {</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+class StatementData</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+{</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+public:</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+  StatementData(sqlite3_stmt *aStatement,</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineplus">+                already_AddRefed&lt;BindingParamsArray&gt; aParamsArray,</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineplus">+                StorageBaseStatementInternal *aStatementOwner)</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineplus">+  : mStatement(aStatement)</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineplus">+  , mParamsArray(aParamsArray)</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineplus">+  , mStatementOwner(aStatementOwner)</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineplus">+  {</span>
<a href="#l66.72"></a><span id="l66.72" class="difflineplus">+  }</span>
<a href="#l66.73"></a><span id="l66.73" class="difflineplus">+  StatementData(const StatementData &amp;aSource)</span>
<a href="#l66.74"></a><span id="l66.74" class="difflineplus">+  : mStatement(aSource.mStatement)</span>
<a href="#l66.75"></a><span id="l66.75" class="difflineplus">+  , mParamsArray(aSource.mParamsArray)</span>
<a href="#l66.76"></a><span id="l66.76" class="difflineplus">+  , mStatementOwner(aSource.mStatementOwner)</span>
<a href="#l66.77"></a><span id="l66.77" class="difflineplus">+  {</span>
<a href="#l66.78"></a><span id="l66.78" class="difflineplus">+  }</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineplus">+  StatementData()</span>
<a href="#l66.80"></a><span id="l66.80" class="difflineplus">+  {</span>
<a href="#l66.81"></a><span id="l66.81" class="difflineplus">+  }</span>
<a href="#l66.82"></a><span id="l66.82" class="difflineplus">+</span>
<a href="#l66.83"></a><span id="l66.83" class="difflineplus">+  /**</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineplus">+   * Return the sqlite statement, fetching it from the storage statement.  In</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+   * the case of AsyncStatements this may actually create the statement </span>
<a href="#l66.86"></a><span id="l66.86" class="difflineplus">+   */</span>
<a href="#l66.87"></a><span id="l66.87" class="difflineplus">+  inline int getSqliteStatement(sqlite3_stmt **_stmt)</span>
<a href="#l66.88"></a><span id="l66.88" class="difflineplus">+  {</span>
<a href="#l66.89"></a><span id="l66.89" class="difflineplus">+    if (!mStatement) {</span>
<a href="#l66.90"></a><span id="l66.90" class="difflineplus">+      int rc = mStatementOwner-&gt;getAsyncStatement(&amp;mStatement);</span>
<a href="#l66.91"></a><span id="l66.91" class="difflineplus">+      if (rc != SQLITE_OK)</span>
<a href="#l66.92"></a><span id="l66.92" class="difflineplus">+        return rc;</span>
<a href="#l66.93"></a><span id="l66.93" class="difflineplus">+    }</span>
<a href="#l66.94"></a><span id="l66.94" class="difflineplus">+    *_stmt = mStatement;</span>
<a href="#l66.95"></a><span id="l66.95" class="difflineplus">+    return SQLITE_OK;</span>
<a href="#l66.96"></a><span id="l66.96" class="difflineplus">+  }</span>
<a href="#l66.97"></a><span id="l66.97" class="difflineplus">+</span>
<a href="#l66.98"></a><span id="l66.98" class="difflineplus">+  operator BindingParamsArray *() const { return mParamsArray; }</span>
<a href="#l66.99"></a><span id="l66.99" class="difflineplus">+</span>
<a href="#l66.100"></a><span id="l66.100" class="difflineplus">+  /**</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineplus">+   * Provide the ability to coerce back to a sqlite3 * connection for purposes </span>
<a href="#l66.102"></a><span id="l66.102" class="difflineplus">+   * of getting an error message out of it.</span>
<a href="#l66.103"></a><span id="l66.103" class="difflineplus">+   */</span>
<a href="#l66.104"></a><span id="l66.104" class="difflineplus">+  operator sqlite3 *() const</span>
<a href="#l66.105"></a><span id="l66.105" class="difflineplus">+  {</span>
<a href="#l66.106"></a><span id="l66.106" class="difflineplus">+    return mStatementOwner-&gt;getOwner()-&gt;GetNativeConnection();</span>
<a href="#l66.107"></a><span id="l66.107" class="difflineplus">+  }</span>
<a href="#l66.108"></a><span id="l66.108" class="difflineplus">+</span>
<a href="#l66.109"></a><span id="l66.109" class="difflineplus">+  /**</span>
<a href="#l66.110"></a><span id="l66.110" class="difflineplus">+   * NULLs out our sqlite3_stmt (it is held by the owner) after reseting it and</span>
<a href="#l66.111"></a><span id="l66.111" class="difflineplus">+   * clear all bindings to it.  This is expected to occur on the async thread.</span>
<a href="#l66.112"></a><span id="l66.112" class="difflineplus">+   *</span>
<a href="#l66.113"></a><span id="l66.113" class="difflineplus">+   * We do not clear mParamsArray out because we only want to release</span>
<a href="#l66.114"></a><span id="l66.114" class="difflineplus">+   * mParamsArray on the calling thread because of XPCVariant addref/release</span>
<a href="#l66.115"></a><span id="l66.115" class="difflineplus">+   * thread-safety issues.  The same holds for mStatementOwner which can be</span>
<a href="#l66.116"></a><span id="l66.116" class="difflineplus">+   * holding such a reference chain as well.</span>
<a href="#l66.117"></a><span id="l66.117" class="difflineplus">+   */</span>
<a href="#l66.118"></a><span id="l66.118" class="difflineplus">+  inline void finalize()</span>
<a href="#l66.119"></a><span id="l66.119" class="difflineplus">+  {</span>
<a href="#l66.120"></a><span id="l66.120" class="difflineplus">+    // In the AsyncStatement case we may never have populated mStatement if the</span>
<a href="#l66.121"></a><span id="l66.121" class="difflineplus">+    // AsyncExecuteStatements got canceled or a failure occurred in constructing</span>
<a href="#l66.122"></a><span id="l66.122" class="difflineplus">+    // the statement.</span>
<a href="#l66.123"></a><span id="l66.123" class="difflineplus">+    if (mStatement) {</span>
<a href="#l66.124"></a><span id="l66.124" class="difflineplus">+      (void)::sqlite3_reset(mStatement);</span>
<a href="#l66.125"></a><span id="l66.125" class="difflineplus">+      (void)::sqlite3_clear_bindings(mStatement);</span>
<a href="#l66.126"></a><span id="l66.126" class="difflineplus">+      mStatement = NULL;</span>
<a href="#l66.127"></a><span id="l66.127" class="difflineplus">+    }</span>
<a href="#l66.128"></a><span id="l66.128" class="difflineplus">+  }</span>
<a href="#l66.129"></a><span id="l66.129" class="difflineplus">+</span>
<a href="#l66.130"></a><span id="l66.130" class="difflineplus">+  /**</span>
<a href="#l66.131"></a><span id="l66.131" class="difflineplus">+   * Indicates if this statement has parameters to be bound before it is</span>
<a href="#l66.132"></a><span id="l66.132" class="difflineplus">+   * executed.</span>
<a href="#l66.133"></a><span id="l66.133" class="difflineplus">+   *</span>
<a href="#l66.134"></a><span id="l66.134" class="difflineplus">+   * @return true if the statement has parameters to bind against, false</span>
<a href="#l66.135"></a><span id="l66.135" class="difflineplus">+   *         otherwise.</span>
<a href="#l66.136"></a><span id="l66.136" class="difflineplus">+   */</span>
<a href="#l66.137"></a><span id="l66.137" class="difflineplus">+  inline bool hasParametersToBeBound() const { return mParamsArray != nsnull; }</span>
<a href="#l66.138"></a><span id="l66.138" class="difflineplus">+  /**</span>
<a href="#l66.139"></a><span id="l66.139" class="difflineplus">+   * Indicates if this statement needs a transaction for execution.</span>
<a href="#l66.140"></a><span id="l66.140" class="difflineplus">+   *</span>
<a href="#l66.141"></a><span id="l66.141" class="difflineplus">+   * @return true if the statement needs a transaction, false otherwise.</span>
<a href="#l66.142"></a><span id="l66.142" class="difflineplus">+   */</span>
<a href="#l66.143"></a><span id="l66.143" class="difflineplus">+  inline bool needsTransaction() const</span>
<a href="#l66.144"></a><span id="l66.144" class="difflineplus">+  {</span>
<a href="#l66.145"></a><span id="l66.145" class="difflineplus">+    return mParamsArray != nsnull &amp;&amp; mParamsArray-&gt;length() &gt; 1;</span>
<a href="#l66.146"></a><span id="l66.146" class="difflineplus">+  }</span>
<a href="#l66.147"></a><span id="l66.147" class="difflineplus">+</span>
<a href="#l66.148"></a><span id="l66.148" class="difflineplus">+private:</span>
<a href="#l66.149"></a><span id="l66.149" class="difflineplus">+  sqlite3_stmt *mStatement;</span>
<a href="#l66.150"></a><span id="l66.150" class="difflineplus">+  nsRefPtr&lt;BindingParamsArray&gt; mParamsArray;</span>
<a href="#l66.151"></a><span id="l66.151" class="difflineplus">+</span>
<a href="#l66.152"></a><span id="l66.152" class="difflineplus">+  /**</span>
<a href="#l66.153"></a><span id="l66.153" class="difflineplus">+   * We hold onto a reference of the statement's owner so it doesn't get</span>
<a href="#l66.154"></a><span id="l66.154" class="difflineplus">+   * destroyed out from under us.</span>
<a href="#l66.155"></a><span id="l66.155" class="difflineplus">+   */</span>
<a href="#l66.156"></a><span id="l66.156" class="difflineplus">+  nsCOMPtr&lt;StorageBaseStatementInternal&gt; mStatementOwner;</span>
<a href="#l66.157"></a><span id="l66.157" class="difflineplus">+};</span>
<a href="#l66.158"></a><span id="l66.158" class="difflineplus">+</span>
<a href="#l66.159"></a><span id="l66.159" class="difflineplus">+} // namespace storage</span>
<a href="#l66.160"></a><span id="l66.160" class="difflineplus">+} // namespace mozilla</span>
<a href="#l66.161"></a><span id="l66.161" class="difflineplus">+</span>
<a href="#l66.162"></a><span id="l66.162" class="difflineplus">+#endif // _mozStorageStatementData_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1">new file mode 100644</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineminus">--- /dev/null</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementJSHelper.cpp</span>
<a href="#l67.4"></a><span id="l67.4" class="difflineat">@@ -0,0 +1,261 @@</span>
<a href="#l67.5"></a><span id="l67.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l67.6"></a><span id="l67.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l67.7"></a><span id="l67.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l67.8"></a><span id="l67.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l67.9"></a><span id="l67.9" class="difflineplus">+ *</span>
<a href="#l67.10"></a><span id="l67.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l67.11"></a><span id="l67.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+ *</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l67.17"></a><span id="l67.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineplus">+ * License.</span>
<a href="#l67.19"></a><span id="l67.19" class="difflineplus">+ *</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineplus">+ * The Original Code is mozStorage code.</span>
<a href="#l67.21"></a><span id="l67.21" class="difflineplus">+ *</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l67.24"></a><span id="l67.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l67.26"></a><span id="l67.26" class="difflineplus">+ *</span>
<a href="#l67.27"></a><span id="l67.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l67.28"></a><span id="l67.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l67.29"></a><span id="l67.29" class="difflineplus">+ *</span>
<a href="#l67.30"></a><span id="l67.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l67.33"></a><span id="l67.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l67.41"></a><span id="l67.41" class="difflineplus">+ *</span>
<a href="#l67.42"></a><span id="l67.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l67.43"></a><span id="l67.43" class="difflineplus">+</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineplus">+#include &quot;nsIXPConnect.h&quot;</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineplus">+#include &quot;mozStorageService.h&quot;</span>
<a href="#l67.47"></a><span id="l67.47" class="difflineplus">+</span>
<a href="#l67.48"></a><span id="l67.48" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineplus">+</span>
<a href="#l67.52"></a><span id="l67.52" class="difflineplus">+#include &quot;mozStorageStatementJSHelper.h&quot;</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineplus">+</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineplus">+#include &quot;mozStorageStatementRow.h&quot;</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineplus">+#include &quot;mozStorageStatementParams.h&quot;</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineplus">+</span>
<a href="#l67.57"></a><span id="l67.57" class="difflineplus">+#include &quot;jsapi.h&quot;</span>
<a href="#l67.58"></a><span id="l67.58" class="difflineplus">+</span>
<a href="#l67.59"></a><span id="l67.59" class="difflineplus">+namespace mozilla {</span>
<a href="#l67.60"></a><span id="l67.60" class="difflineplus">+namespace storage {</span>
<a href="#l67.61"></a><span id="l67.61" class="difflineplus">+</span>
<a href="#l67.62"></a><span id="l67.62" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l67.63"></a><span id="l67.63" class="difflineplus">+//// Global Functions</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineplus">+</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineplus">+static</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineplus">+JSBool</span>
<a href="#l67.67"></a><span id="l67.67" class="difflineplus">+stepFunc(JSContext *aCtx,</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineplus">+         PRUint32,</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+         jsval *_vp)</span>
<a href="#l67.70"></a><span id="l67.70" class="difflineplus">+{</span>
<a href="#l67.71"></a><span id="l67.71" class="difflineplus">+  nsCOMPtr&lt;nsIXPConnect&gt; xpc(Service::getXPConnect());</span>
<a href="#l67.72"></a><span id="l67.72" class="difflineplus">+  nsCOMPtr&lt;nsIXPConnectWrappedNative&gt; wrapper;</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineplus">+  nsresult rv = xpc-&gt;GetWrappedNativeOfJSObject(</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineplus">+    aCtx, JS_THIS_OBJECT(aCtx, _vp), getter_AddRefs(wrapper)</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineplus">+  );</span>
<a href="#l67.76"></a><span id="l67.76" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l67.77"></a><span id="l67.77" class="difflineplus">+    ::JS_ReportError(aCtx, &quot;mozIStorageStatement::step() could not obtain native statement&quot;);</span>
<a href="#l67.78"></a><span id="l67.78" class="difflineplus">+    return JS_FALSE;</span>
<a href="#l67.79"></a><span id="l67.79" class="difflineplus">+  }</span>
<a href="#l67.80"></a><span id="l67.80" class="difflineplus">+</span>
<a href="#l67.81"></a><span id="l67.81" class="difflineplus">+  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l67.82"></a><span id="l67.82" class="difflineplus">+    static_cast&lt;mozIStorageStatement *&gt;(wrapper-&gt;Native())</span>
<a href="#l67.83"></a><span id="l67.83" class="difflineplus">+  );</span>
<a href="#l67.84"></a><span id="l67.84" class="difflineplus">+</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l67.86"></a><span id="l67.86" class="difflineplus">+  {</span>
<a href="#l67.87"></a><span id="l67.87" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatement&gt; isStatement(</span>
<a href="#l67.88"></a><span id="l67.88" class="difflineplus">+      do_QueryInterface(wrapper-&gt;Native())</span>
<a href="#l67.89"></a><span id="l67.89" class="difflineplus">+    );</span>
<a href="#l67.90"></a><span id="l67.90" class="difflineplus">+    NS_ASSERTION(isStatement, &quot;How is this not a statement?!&quot;);</span>
<a href="#l67.91"></a><span id="l67.91" class="difflineplus">+  }</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineplus">+#endif</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineplus">+</span>
<a href="#l67.94"></a><span id="l67.94" class="difflineplus">+  PRBool hasMore = PR_FALSE;</span>
<a href="#l67.95"></a><span id="l67.95" class="difflineplus">+  rv = stmt-&gt;ExecuteStep(&amp;hasMore);</span>
<a href="#l67.96"></a><span id="l67.96" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !hasMore) {</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineplus">+    *_vp = JSVAL_FALSE;</span>
<a href="#l67.98"></a><span id="l67.98" class="difflineplus">+    (void)stmt-&gt;Reset();</span>
<a href="#l67.99"></a><span id="l67.99" class="difflineplus">+    return JS_TRUE;</span>
<a href="#l67.100"></a><span id="l67.100" class="difflineplus">+  }</span>
<a href="#l67.101"></a><span id="l67.101" class="difflineplus">+</span>
<a href="#l67.102"></a><span id="l67.102" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineplus">+    ::JS_ReportError(aCtx, &quot;mozIStorageStatement::step() returned an error&quot;);</span>
<a href="#l67.104"></a><span id="l67.104" class="difflineplus">+    return JS_FALSE;</span>
<a href="#l67.105"></a><span id="l67.105" class="difflineplus">+  }</span>
<a href="#l67.106"></a><span id="l67.106" class="difflineplus">+</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineplus">+  *_vp = BOOLEAN_TO_JSVAL(hasMore);</span>
<a href="#l67.108"></a><span id="l67.108" class="difflineplus">+  return JS_TRUE;</span>
<a href="#l67.109"></a><span id="l67.109" class="difflineplus">+}</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineplus">+</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineplus">+//// StatementJSHelper</span>
<a href="#l67.113"></a><span id="l67.113" class="difflineplus">+</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineplus">+nsresult</span>
<a href="#l67.115"></a><span id="l67.115" class="difflineplus">+StatementJSHelper::getRow(Statement *aStatement,</span>
<a href="#l67.116"></a><span id="l67.116" class="difflineplus">+                          JSContext *aCtx,</span>
<a href="#l67.117"></a><span id="l67.117" class="difflineplus">+                          JSObject *aScopeObj,</span>
<a href="#l67.118"></a><span id="l67.118" class="difflineplus">+                          jsval *_row)</span>
<a href="#l67.119"></a><span id="l67.119" class="difflineplus">+{</span>
<a href="#l67.120"></a><span id="l67.120" class="difflineplus">+  nsresult rv;</span>
<a href="#l67.121"></a><span id="l67.121" class="difflineplus">+</span>
<a href="#l67.122"></a><span id="l67.122" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l67.123"></a><span id="l67.123" class="difflineplus">+  PRInt32 state;</span>
<a href="#l67.124"></a><span id="l67.124" class="difflineplus">+  (void)aStatement-&gt;GetState(&amp;state);</span>
<a href="#l67.125"></a><span id="l67.125" class="difflineplus">+  NS_ASSERTION(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_EXECUTING,</span>
<a href="#l67.126"></a><span id="l67.126" class="difflineplus">+               &quot;Invalid state to get the row object - all calls will fail!&quot;);</span>
<a href="#l67.127"></a><span id="l67.127" class="difflineplus">+#endif</span>
<a href="#l67.128"></a><span id="l67.128" class="difflineplus">+</span>
<a href="#l67.129"></a><span id="l67.129" class="difflineplus">+  if (!aStatement-&gt;mStatementRowHolder) {</span>
<a href="#l67.130"></a><span id="l67.130" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementRow&gt; row(new StatementRow(aStatement));</span>
<a href="#l67.131"></a><span id="l67.131" class="difflineplus">+    NS_ENSURE_TRUE(row, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l67.132"></a><span id="l67.132" class="difflineplus">+</span>
<a href="#l67.133"></a><span id="l67.133" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnect&gt; xpc(Service::getXPConnect());</span>
<a href="#l67.134"></a><span id="l67.134" class="difflineplus">+    rv = xpc-&gt;WrapNative(</span>
<a href="#l67.135"></a><span id="l67.135" class="difflineplus">+      aCtx,</span>
<a href="#l67.136"></a><span id="l67.136" class="difflineplus">+      ::JS_GetGlobalForObject(aCtx, aScopeObj),</span>
<a href="#l67.137"></a><span id="l67.137" class="difflineplus">+      row,</span>
<a href="#l67.138"></a><span id="l67.138" class="difflineplus">+      NS_GET_IID(mozIStorageStatementRow),</span>
<a href="#l67.139"></a><span id="l67.139" class="difflineplus">+      getter_AddRefs(aStatement-&gt;mStatementRowHolder)</span>
<a href="#l67.140"></a><span id="l67.140" class="difflineplus">+    );</span>
<a href="#l67.141"></a><span id="l67.141" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.142"></a><span id="l67.142" class="difflineplus">+  }</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineplus">+</span>
<a href="#l67.144"></a><span id="l67.144" class="difflineplus">+  JSObject *obj = nsnull;</span>
<a href="#l67.145"></a><span id="l67.145" class="difflineplus">+  rv = aStatement-&gt;mStatementRowHolder-&gt;GetJSObject(&amp;obj);</span>
<a href="#l67.146"></a><span id="l67.146" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.147"></a><span id="l67.147" class="difflineplus">+</span>
<a href="#l67.148"></a><span id="l67.148" class="difflineplus">+  *_row = OBJECT_TO_JSVAL(obj);</span>
<a href="#l67.149"></a><span id="l67.149" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.150"></a><span id="l67.150" class="difflineplus">+}</span>
<a href="#l67.151"></a><span id="l67.151" class="difflineplus">+</span>
<a href="#l67.152"></a><span id="l67.152" class="difflineplus">+nsresult</span>
<a href="#l67.153"></a><span id="l67.153" class="difflineplus">+StatementJSHelper::getParams(Statement *aStatement,</span>
<a href="#l67.154"></a><span id="l67.154" class="difflineplus">+                             JSContext *aCtx,</span>
<a href="#l67.155"></a><span id="l67.155" class="difflineplus">+                             JSObject *aScopeObj,</span>
<a href="#l67.156"></a><span id="l67.156" class="difflineplus">+                             jsval *_params)</span>
<a href="#l67.157"></a><span id="l67.157" class="difflineplus">+{</span>
<a href="#l67.158"></a><span id="l67.158" class="difflineplus">+  nsresult rv;</span>
<a href="#l67.159"></a><span id="l67.159" class="difflineplus">+</span>
<a href="#l67.160"></a><span id="l67.160" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l67.161"></a><span id="l67.161" class="difflineplus">+  PRInt32 state;</span>
<a href="#l67.162"></a><span id="l67.162" class="difflineplus">+  (void)aStatement-&gt;GetState(&amp;state);</span>
<a href="#l67.163"></a><span id="l67.163" class="difflineplus">+  NS_ASSERTION(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_READY,</span>
<a href="#l67.164"></a><span id="l67.164" class="difflineplus">+               &quot;Invalid state to get the params object - all calls will fail!&quot;);</span>
<a href="#l67.165"></a><span id="l67.165" class="difflineplus">+#endif</span>
<a href="#l67.166"></a><span id="l67.166" class="difflineplus">+</span>
<a href="#l67.167"></a><span id="l67.167" class="difflineplus">+  if (!aStatement-&gt;mStatementParamsHolder) {</span>
<a href="#l67.168"></a><span id="l67.168" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementParams&gt; params =</span>
<a href="#l67.169"></a><span id="l67.169" class="difflineplus">+      new StatementParams(aStatement);</span>
<a href="#l67.170"></a><span id="l67.170" class="difflineplus">+    NS_ENSURE_TRUE(params, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l67.171"></a><span id="l67.171" class="difflineplus">+</span>
<a href="#l67.172"></a><span id="l67.172" class="difflineplus">+    nsCOMPtr&lt;nsIXPConnect&gt; xpc(Service::getXPConnect());</span>
<a href="#l67.173"></a><span id="l67.173" class="difflineplus">+    rv = xpc-&gt;WrapNative(</span>
<a href="#l67.174"></a><span id="l67.174" class="difflineplus">+      aCtx,</span>
<a href="#l67.175"></a><span id="l67.175" class="difflineplus">+      ::JS_GetGlobalForObject(aCtx, aScopeObj),</span>
<a href="#l67.176"></a><span id="l67.176" class="difflineplus">+      params,</span>
<a href="#l67.177"></a><span id="l67.177" class="difflineplus">+      NS_GET_IID(mozIStorageStatementParams),</span>
<a href="#l67.178"></a><span id="l67.178" class="difflineplus">+      getter_AddRefs(aStatement-&gt;mStatementParamsHolder)</span>
<a href="#l67.179"></a><span id="l67.179" class="difflineplus">+    );</span>
<a href="#l67.180"></a><span id="l67.180" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.181"></a><span id="l67.181" class="difflineplus">+  }</span>
<a href="#l67.182"></a><span id="l67.182" class="difflineplus">+</span>
<a href="#l67.183"></a><span id="l67.183" class="difflineplus">+  JSObject *obj = nsnull;</span>
<a href="#l67.184"></a><span id="l67.184" class="difflineplus">+  rv = aStatement-&gt;mStatementParamsHolder-&gt;GetJSObject(&amp;obj);</span>
<a href="#l67.185"></a><span id="l67.185" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.186"></a><span id="l67.186" class="difflineplus">+</span>
<a href="#l67.187"></a><span id="l67.187" class="difflineplus">+  *_params = OBJECT_TO_JSVAL(obj);</span>
<a href="#l67.188"></a><span id="l67.188" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.189"></a><span id="l67.189" class="difflineplus">+}</span>
<a href="#l67.190"></a><span id="l67.190" class="difflineplus">+</span>
<a href="#l67.191"></a><span id="l67.191" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) StatementJSHelper::AddRef() { return 2; }</span>
<a href="#l67.192"></a><span id="l67.192" class="difflineplus">+NS_IMETHODIMP_(nsrefcnt) StatementJSHelper::Release() { return 1; }</span>
<a href="#l67.193"></a><span id="l67.193" class="difflineplus">+NS_INTERFACE_MAP_BEGIN(StatementJSHelper)</span>
<a href="#l67.194"></a><span id="l67.194" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIXPCScriptable)</span>
<a href="#l67.195"></a><span id="l67.195" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<a href="#l67.196"></a><span id="l67.196" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l67.197"></a><span id="l67.197" class="difflineplus">+</span>
<a href="#l67.198"></a><span id="l67.198" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l67.199"></a><span id="l67.199" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l67.200"></a><span id="l67.200" class="difflineplus">+</span>
<a href="#l67.201"></a><span id="l67.201" class="difflineplus">+#define XPC_MAP_CLASSNAME StatementJSHelper</span>
<a href="#l67.202"></a><span id="l67.202" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;StatementJSHelper&quot;</span>
<a href="#l67.203"></a><span id="l67.203" class="difflineplus">+#define XPC_MAP_WANT_GETPROPERTY</span>
<a href="#l67.204"></a><span id="l67.204" class="difflineplus">+#define XPC_MAP_WANT_NEWRESOLVE</span>
<a href="#l67.205"></a><span id="l67.205" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE</span>
<a href="#l67.206"></a><span id="l67.206" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l67.207"></a><span id="l67.207" class="difflineplus">+</span>
<a href="#l67.208"></a><span id="l67.208" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l67.209"></a><span id="l67.209" class="difflineplus">+StatementJSHelper::GetProperty(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l67.210"></a><span id="l67.210" class="difflineplus">+                               JSContext *aCtx,</span>
<a href="#l67.211"></a><span id="l67.211" class="difflineplus">+                               JSObject *aScopeObj,</span>
<a href="#l67.212"></a><span id="l67.212" class="difflineplus">+                               jsval aId,</span>
<a href="#l67.213"></a><span id="l67.213" class="difflineplus">+                               jsval *_result,</span>
<a href="#l67.214"></a><span id="l67.214" class="difflineplus">+                               PRBool *_retval)</span>
<a href="#l67.215"></a><span id="l67.215" class="difflineplus">+{</span>
<a href="#l67.216"></a><span id="l67.216" class="difflineplus">+  if (!JSVAL_IS_STRING(aId))</span>
<a href="#l67.217"></a><span id="l67.217" class="difflineplus">+    return NS_OK;</span>
<a href="#l67.218"></a><span id="l67.218" class="difflineplus">+</span>
<a href="#l67.219"></a><span id="l67.219" class="difflineplus">+  Statement *stmt = static_cast&lt;Statement *&gt;(</span>
<a href="#l67.220"></a><span id="l67.220" class="difflineplus">+    static_cast&lt;mozIStorageStatement *&gt;(aWrapper-&gt;Native())</span>
<a href="#l67.221"></a><span id="l67.221" class="difflineplus">+  );</span>
<a href="#l67.222"></a><span id="l67.222" class="difflineplus">+</span>
<a href="#l67.223"></a><span id="l67.223" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l67.224"></a><span id="l67.224" class="difflineplus">+  {</span>
<a href="#l67.225"></a><span id="l67.225" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatement&gt; isStatement(</span>
<a href="#l67.226"></a><span id="l67.226" class="difflineplus">+                                     do_QueryInterface(aWrapper-&gt;Native()));</span>
<a href="#l67.227"></a><span id="l67.227" class="difflineplus">+    NS_ASSERTION(isStatement, &quot;How is this not a statement?!&quot;);</span>
<a href="#l67.228"></a><span id="l67.228" class="difflineplus">+  }</span>
<a href="#l67.229"></a><span id="l67.229" class="difflineplus">+#endif</span>
<a href="#l67.230"></a><span id="l67.230" class="difflineplus">+</span>
<a href="#l67.231"></a><span id="l67.231" class="difflineplus">+  const char *propName = ::JS_GetStringBytes(JSVAL_TO_STRING(aId));</span>
<a href="#l67.232"></a><span id="l67.232" class="difflineplus">+  if (::strcmp(propName, &quot;row&quot;) == 0)</span>
<a href="#l67.233"></a><span id="l67.233" class="difflineplus">+    return getRow(stmt, aCtx, aScopeObj, _result);</span>
<a href="#l67.234"></a><span id="l67.234" class="difflineplus">+</span>
<a href="#l67.235"></a><span id="l67.235" class="difflineplus">+  if (::strcmp(propName, &quot;params&quot;) == 0)</span>
<a href="#l67.236"></a><span id="l67.236" class="difflineplus">+    return getParams(stmt, aCtx, aScopeObj, _result);</span>
<a href="#l67.237"></a><span id="l67.237" class="difflineplus">+</span>
<a href="#l67.238"></a><span id="l67.238" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.239"></a><span id="l67.239" class="difflineplus">+}</span>
<a href="#l67.240"></a><span id="l67.240" class="difflineplus">+</span>
<a href="#l67.241"></a><span id="l67.241" class="difflineplus">+</span>
<a href="#l67.242"></a><span id="l67.242" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l67.243"></a><span id="l67.243" class="difflineplus">+StatementJSHelper::NewResolve(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l67.244"></a><span id="l67.244" class="difflineplus">+                              JSContext *aCtx,</span>
<a href="#l67.245"></a><span id="l67.245" class="difflineplus">+                              JSObject *aScopeObj,</span>
<a href="#l67.246"></a><span id="l67.246" class="difflineplus">+                              jsval aId,</span>
<a href="#l67.247"></a><span id="l67.247" class="difflineplus">+                              PRUint32 aFlags,</span>
<a href="#l67.248"></a><span id="l67.248" class="difflineplus">+                              JSObject **_objp,</span>
<a href="#l67.249"></a><span id="l67.249" class="difflineplus">+                              PRBool *_retval)</span>
<a href="#l67.250"></a><span id="l67.250" class="difflineplus">+{</span>
<a href="#l67.251"></a><span id="l67.251" class="difflineplus">+  if (!JSVAL_IS_STRING(aId))</span>
<a href="#l67.252"></a><span id="l67.252" class="difflineplus">+    return NS_OK;</span>
<a href="#l67.253"></a><span id="l67.253" class="difflineplus">+</span>
<a href="#l67.254"></a><span id="l67.254" class="difflineplus">+  const char *name = ::JS_GetStringBytes(JSVAL_TO_STRING(aId));</span>
<a href="#l67.255"></a><span id="l67.255" class="difflineplus">+  if (::strcmp(name, &quot;step&quot;) == 0) {</span>
<a href="#l67.256"></a><span id="l67.256" class="difflineplus">+    *_retval = ::JS_DefineFunction(aCtx, aScopeObj, &quot;step&quot;, (JSNative)stepFunc,</span>
<a href="#l67.257"></a><span id="l67.257" class="difflineplus">+                                   0, JSFUN_FAST_NATIVE) != nsnull;</span>
<a href="#l67.258"></a><span id="l67.258" class="difflineplus">+    *_objp = aScopeObj;</span>
<a href="#l67.259"></a><span id="l67.259" class="difflineplus">+    return NS_OK;</span>
<a href="#l67.260"></a><span id="l67.260" class="difflineplus">+  }</span>
<a href="#l67.261"></a><span id="l67.261" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.262"></a><span id="l67.262" class="difflineplus">+}</span>
<a href="#l67.263"></a><span id="l67.263" class="difflineplus">+</span>
<a href="#l67.264"></a><span id="l67.264" class="difflineplus">+} // namespace storage</span>
<a href="#l67.265"></a><span id="l67.265" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1">new file mode 100644</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineminus">--- /dev/null</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementJSHelper.h</span>
<a href="#l68.4"></a><span id="l68.4" class="difflineat">@@ -0,0 +1,64 @@</span>
<a href="#l68.5"></a><span id="l68.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l68.6"></a><span id="l68.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l68.7"></a><span id="l68.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l68.8"></a><span id="l68.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l68.9"></a><span id="l68.9" class="difflineplus">+ *</span>
<a href="#l68.10"></a><span id="l68.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l68.11"></a><span id="l68.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+ *</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+ * License.</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+ *</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineplus">+ * The Original Code is mozStorage code.</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineplus">+ *</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineplus">+ *</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineplus">+ *  Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineplus">+ *</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+ *</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineplus">+</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+#ifndef __MOZSTORAGESTATEMENTJSHELPER_H__</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineplus">+#define __MOZSTORAGESTATEMENTJSHELPER_H__</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineplus">+</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineplus">+</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+class Statement;</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineplus">+</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineplus">+namespace mozilla {</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineplus">+namespace storage {</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+class StatementJSHelper : public nsIXPCScriptable</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+{</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineplus">+public:</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+  NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineplus">+</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+private:</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+  nsresult getRow(Statement *, JSContext *, JSObject *, jsval *);</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineplus">+  nsresult getParams(Statement *, JSContext *, JSObject *, jsval *);</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineplus">+};</span>
<a href="#l68.64"></a><span id="l68.64" class="difflineplus">+</span>
<a href="#l68.65"></a><span id="l68.65" class="difflineplus">+} // namespace storage</span>
<a href="#l68.66"></a><span id="l68.66" class="difflineplus">+} // namespace mozilla</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineplus">+</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+#endif // __MOZSTORAGESTATEMENTJSHELPER_H__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1">new file mode 100644</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineminus">--- /dev/null</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementParams.cpp</span>
<a href="#l69.4"></a><span id="l69.4" class="difflineat">@@ -0,0 +1,239 @@</span>
<a href="#l69.5"></a><span id="l69.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l69.6"></a><span id="l69.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l69.7"></a><span id="l69.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l69.8"></a><span id="l69.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l69.9"></a><span id="l69.9" class="difflineplus">+ *</span>
<a href="#l69.10"></a><span id="l69.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l69.11"></a><span id="l69.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+ *</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+ * License.</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+ *</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineplus">+ *</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l69.24"></a><span id="l69.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineplus">+ *</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineplus">+ *</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+ *</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+#include &quot;mozStorageStatementParams.h&quot;</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineplus">+namespace mozilla {</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineplus">+namespace storage {</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineplus">+</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineplus">+//// StatementParams</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineplus">+</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineplus">+StatementParams::StatementParams(mozIStorageStatement *aStatement) :</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+    mStatement(aStatement)</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+{</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+  NS_ASSERTION(mStatement != nsnull, &quot;mStatement is null&quot;);</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+  (void)mStatement-&gt;GetParameterCount(&amp;mParamCount);</span>
<a href="#l69.63"></a><span id="l69.63" class="difflineplus">+}</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineplus">+</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineplus">+NS_IMPL_ISUPPORTS2(</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineplus">+  StatementParams,</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineplus">+  mozIStorageStatementParams,</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineplus">+  nsIXPCScriptable</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineplus">+)</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineplus">+</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineplus">+#define XPC_MAP_CLASSNAME StatementParams</span>
<a href="#l69.75"></a><span id="l69.75" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;StatementParams&quot;</span>
<a href="#l69.76"></a><span id="l69.76" class="difflineplus">+#define XPC_MAP_WANT_SETPROPERTY</span>
<a href="#l69.77"></a><span id="l69.77" class="difflineplus">+#define XPC_MAP_WANT_NEWENUMERATE</span>
<a href="#l69.78"></a><span id="l69.78" class="difflineplus">+#define XPC_MAP_WANT_NEWRESOLVE</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l69.81"></a><span id="l69.81" class="difflineplus">+</span>
<a href="#l69.82"></a><span id="l69.82" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l69.83"></a><span id="l69.83" class="difflineplus">+StatementParams::SetProperty(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l69.84"></a><span id="l69.84" class="difflineplus">+                             JSContext *aCtx,</span>
<a href="#l69.85"></a><span id="l69.85" class="difflineplus">+                             JSObject *aScopeObj,</span>
<a href="#l69.86"></a><span id="l69.86" class="difflineplus">+                             jsval aId,</span>
<a href="#l69.87"></a><span id="l69.87" class="difflineplus">+                             jsval *_vp,</span>
<a href="#l69.88"></a><span id="l69.88" class="difflineplus">+                             PRBool *_retval)</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineplus">+{</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l69.91"></a><span id="l69.91" class="difflineplus">+</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineplus">+  if (JSVAL_IS_INT(aId)) {</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineplus">+    int idx = JSVAL_TO_INT(aId);</span>
<a href="#l69.94"></a><span id="l69.94" class="difflineplus">+</span>
<a href="#l69.95"></a><span id="l69.95" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; variant(convertJSValToVariant(aCtx, *_vp));</span>
<a href="#l69.96"></a><span id="l69.96" class="difflineplus">+    NS_ENSURE_TRUE(variant, NS_ERROR_UNEXPECTED);</span>
<a href="#l69.97"></a><span id="l69.97" class="difflineplus">+    nsresult rv = mStatement-&gt;BindByIndex(idx, variant);</span>
<a href="#l69.98"></a><span id="l69.98" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.99"></a><span id="l69.99" class="difflineplus">+  }</span>
<a href="#l69.100"></a><span id="l69.100" class="difflineplus">+  else if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l69.101"></a><span id="l69.101" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aId);</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineplus">+    NS_ConvertUTF16toUTF8 name(reinterpret_cast&lt;const PRUnichar *&gt;</span>
<a href="#l69.103"></a><span id="l69.103" class="difflineplus">+                                   (::JS_GetStringChars(str)),</span>
<a href="#l69.104"></a><span id="l69.104" class="difflineplus">+                               ::JS_GetStringLength(str));</span>
<a href="#l69.105"></a><span id="l69.105" class="difflineplus">+</span>
<a href="#l69.106"></a><span id="l69.106" class="difflineplus">+    // check to see if there's a parameter with this name</span>
<a href="#l69.107"></a><span id="l69.107" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; variant(convertJSValToVariant(aCtx, *_vp));</span>
<a href="#l69.108"></a><span id="l69.108" class="difflineplus">+    NS_ENSURE_TRUE(variant, NS_ERROR_UNEXPECTED);</span>
<a href="#l69.109"></a><span id="l69.109" class="difflineplus">+    nsresult rv = mStatement-&gt;BindByName(name, variant);</span>
<a href="#l69.110"></a><span id="l69.110" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.111"></a><span id="l69.111" class="difflineplus">+  }</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineplus">+  else {</span>
<a href="#l69.113"></a><span id="l69.113" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l69.114"></a><span id="l69.114" class="difflineplus">+  }</span>
<a href="#l69.115"></a><span id="l69.115" class="difflineplus">+</span>
<a href="#l69.116"></a><span id="l69.116" class="difflineplus">+  *_retval = PR_TRUE;</span>
<a href="#l69.117"></a><span id="l69.117" class="difflineplus">+  return NS_OK;</span>
<a href="#l69.118"></a><span id="l69.118" class="difflineplus">+}</span>
<a href="#l69.119"></a><span id="l69.119" class="difflineplus">+</span>
<a href="#l69.120"></a><span id="l69.120" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineplus">+StatementParams::NewEnumerate(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l69.122"></a><span id="l69.122" class="difflineplus">+                              JSContext *aCtx,</span>
<a href="#l69.123"></a><span id="l69.123" class="difflineplus">+                              JSObject *aScopeObj,</span>
<a href="#l69.124"></a><span id="l69.124" class="difflineplus">+                              PRUint32 aEnumOp,</span>
<a href="#l69.125"></a><span id="l69.125" class="difflineplus">+                              jsval *_statep,</span>
<a href="#l69.126"></a><span id="l69.126" class="difflineplus">+                              jsid *_idp,</span>
<a href="#l69.127"></a><span id="l69.127" class="difflineplus">+                              PRBool *_retval)</span>
<a href="#l69.128"></a><span id="l69.128" class="difflineplus">+{</span>
<a href="#l69.129"></a><span id="l69.129" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineplus">+</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineplus">+  switch (aEnumOp) {</span>
<a href="#l69.132"></a><span id="l69.132" class="difflineplus">+    case JSENUMERATE_INIT:</span>
<a href="#l69.133"></a><span id="l69.133" class="difflineplus">+    {</span>
<a href="#l69.134"></a><span id="l69.134" class="difflineplus">+      // Start our internal index at zero.</span>
<a href="#l69.135"></a><span id="l69.135" class="difflineplus">+      *_statep = JSVAL_ZERO;</span>
<a href="#l69.136"></a><span id="l69.136" class="difflineplus">+</span>
<a href="#l69.137"></a><span id="l69.137" class="difflineplus">+      // And set our length, if needed.</span>
<a href="#l69.138"></a><span id="l69.138" class="difflineplus">+      if (_idp)</span>
<a href="#l69.139"></a><span id="l69.139" class="difflineplus">+        *_idp = INT_TO_JSVAL(mParamCount);</span>
<a href="#l69.140"></a><span id="l69.140" class="difflineplus">+</span>
<a href="#l69.141"></a><span id="l69.141" class="difflineplus">+      break;</span>
<a href="#l69.142"></a><span id="l69.142" class="difflineplus">+    }</span>
<a href="#l69.143"></a><span id="l69.143" class="difflineplus">+    case JSENUMERATE_NEXT:</span>
<a href="#l69.144"></a><span id="l69.144" class="difflineplus">+    {</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineplus">+      NS_ASSERTION(*_statep != JSVAL_NULL, &quot;Internal state is null!&quot;);</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineplus">+</span>
<a href="#l69.147"></a><span id="l69.147" class="difflineplus">+      // Make sure we are in range first.</span>
<a href="#l69.148"></a><span id="l69.148" class="difflineplus">+      PRUint32 index = static_cast&lt;PRUint32&gt;(JSVAL_TO_INT(*_statep));</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineplus">+      if (index &gt;= mParamCount) {</span>
<a href="#l69.150"></a><span id="l69.150" class="difflineplus">+        *_statep = JSVAL_NULL;</span>
<a href="#l69.151"></a><span id="l69.151" class="difflineplus">+        return NS_OK;</span>
<a href="#l69.152"></a><span id="l69.152" class="difflineplus">+      }</span>
<a href="#l69.153"></a><span id="l69.153" class="difflineplus">+</span>
<a href="#l69.154"></a><span id="l69.154" class="difflineplus">+      // Get the name of our parameter.</span>
<a href="#l69.155"></a><span id="l69.155" class="difflineplus">+      nsCAutoString name;</span>
<a href="#l69.156"></a><span id="l69.156" class="difflineplus">+      nsresult rv = mStatement-&gt;GetParameterName(index, name);</span>
<a href="#l69.157"></a><span id="l69.157" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.158"></a><span id="l69.158" class="difflineplus">+</span>
<a href="#l69.159"></a><span id="l69.159" class="difflineplus">+      // But drop the first character, which is going to be a ':'.</span>
<a href="#l69.160"></a><span id="l69.160" class="difflineplus">+      JSString *jsname = ::JS_NewStringCopyN(aCtx, &amp;(name.get()[1]),</span>
<a href="#l69.161"></a><span id="l69.161" class="difflineplus">+                                             name.Length() - 1);</span>
<a href="#l69.162"></a><span id="l69.162" class="difflineplus">+      NS_ENSURE_TRUE(jsname, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l69.163"></a><span id="l69.163" class="difflineplus">+</span>
<a href="#l69.164"></a><span id="l69.164" class="difflineplus">+      // Set our name.</span>
<a href="#l69.165"></a><span id="l69.165" class="difflineplus">+      if (!::JS_ValueToId(aCtx, STRING_TO_JSVAL(jsname), _idp)) {</span>
<a href="#l69.166"></a><span id="l69.166" class="difflineplus">+        *_retval = PR_FALSE;</span>
<a href="#l69.167"></a><span id="l69.167" class="difflineplus">+        return NS_OK;</span>
<a href="#l69.168"></a><span id="l69.168" class="difflineplus">+      }</span>
<a href="#l69.169"></a><span id="l69.169" class="difflineplus">+</span>
<a href="#l69.170"></a><span id="l69.170" class="difflineplus">+      // And increment our index.</span>
<a href="#l69.171"></a><span id="l69.171" class="difflineplus">+      *_statep = INT_TO_JSVAL(++index);</span>
<a href="#l69.172"></a><span id="l69.172" class="difflineplus">+</span>
<a href="#l69.173"></a><span id="l69.173" class="difflineplus">+      break;</span>
<a href="#l69.174"></a><span id="l69.174" class="difflineplus">+    }</span>
<a href="#l69.175"></a><span id="l69.175" class="difflineplus">+    case JSENUMERATE_DESTROY:</span>
<a href="#l69.176"></a><span id="l69.176" class="difflineplus">+    {</span>
<a href="#l69.177"></a><span id="l69.177" class="difflineplus">+      // Clear our state.</span>
<a href="#l69.178"></a><span id="l69.178" class="difflineplus">+      *_statep = JSVAL_NULL;</span>
<a href="#l69.179"></a><span id="l69.179" class="difflineplus">+</span>
<a href="#l69.180"></a><span id="l69.180" class="difflineplus">+      break;</span>
<a href="#l69.181"></a><span id="l69.181" class="difflineplus">+    }</span>
<a href="#l69.182"></a><span id="l69.182" class="difflineplus">+  }</span>
<a href="#l69.183"></a><span id="l69.183" class="difflineplus">+</span>
<a href="#l69.184"></a><span id="l69.184" class="difflineplus">+  return NS_OK;</span>
<a href="#l69.185"></a><span id="l69.185" class="difflineplus">+}</span>
<a href="#l69.186"></a><span id="l69.186" class="difflineplus">+</span>
<a href="#l69.187"></a><span id="l69.187" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l69.188"></a><span id="l69.188" class="difflineplus">+StatementParams::NewResolve(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l69.189"></a><span id="l69.189" class="difflineplus">+                            JSContext *aCtx,</span>
<a href="#l69.190"></a><span id="l69.190" class="difflineplus">+                            JSObject *aScopeObj,</span>
<a href="#l69.191"></a><span id="l69.191" class="difflineplus">+                            jsval aId,</span>
<a href="#l69.192"></a><span id="l69.192" class="difflineplus">+                            PRUint32 aFlags,</span>
<a href="#l69.193"></a><span id="l69.193" class="difflineplus">+                            JSObject **_objp,</span>
<a href="#l69.194"></a><span id="l69.194" class="difflineplus">+                            PRBool *_retval)</span>
<a href="#l69.195"></a><span id="l69.195" class="difflineplus">+{</span>
<a href="#l69.196"></a><span id="l69.196" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l69.197"></a><span id="l69.197" class="difflineplus">+  // We do not throw at any point after this unless our index is out of range</span>
<a href="#l69.198"></a><span id="l69.198" class="difflineplus">+  // because we want to allow the prototype chain to be checked for the</span>
<a href="#l69.199"></a><span id="l69.199" class="difflineplus">+  // property.</span>
<a href="#l69.200"></a><span id="l69.200" class="difflineplus">+</span>
<a href="#l69.201"></a><span id="l69.201" class="difflineplus">+  PRUint32 idx;</span>
<a href="#l69.202"></a><span id="l69.202" class="difflineplus">+</span>
<a href="#l69.203"></a><span id="l69.203" class="difflineplus">+  if (JSVAL_IS_INT(aId)) {</span>
<a href="#l69.204"></a><span id="l69.204" class="difflineplus">+    idx = JSVAL_TO_INT(aId);</span>
<a href="#l69.205"></a><span id="l69.205" class="difflineplus">+</span>
<a href="#l69.206"></a><span id="l69.206" class="difflineplus">+    // Ensure that our index is within range.  We do not care about the</span>
<a href="#l69.207"></a><span id="l69.207" class="difflineplus">+    // prototype chain being checked here.</span>
<a href="#l69.208"></a><span id="l69.208" class="difflineplus">+    if (idx &gt;= mParamCount)</span>
<a href="#l69.209"></a><span id="l69.209" class="difflineplus">+      return NS_ERROR_INVALID_ARG;</span>
<a href="#l69.210"></a><span id="l69.210" class="difflineplus">+  }</span>
<a href="#l69.211"></a><span id="l69.211" class="difflineplus">+  else if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l69.212"></a><span id="l69.212" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aId);</span>
<a href="#l69.213"></a><span id="l69.213" class="difflineplus">+    jschar *nameChars = ::JS_GetStringChars(str);</span>
<a href="#l69.214"></a><span id="l69.214" class="difflineplus">+    size_t nameLength = ::JS_GetStringLength(str);</span>
<a href="#l69.215"></a><span id="l69.215" class="difflineplus">+</span>
<a href="#l69.216"></a><span id="l69.216" class="difflineplus">+    // Check to see if there's a parameter with this name, and if not, let</span>
<a href="#l69.217"></a><span id="l69.217" class="difflineplus">+    // the rest of the prototype chain be checked.</span>
<a href="#l69.218"></a><span id="l69.218" class="difflineplus">+    NS_ConvertUTF16toUTF8 name(reinterpret_cast&lt;const PRUnichar *&gt;(nameChars),</span>
<a href="#l69.219"></a><span id="l69.219" class="difflineplus">+                               nameLength);</span>
<a href="#l69.220"></a><span id="l69.220" class="difflineplus">+    nsresult rv = mStatement-&gt;GetParameterIndex(name, &amp;idx);</span>
<a href="#l69.221"></a><span id="l69.221" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l69.222"></a><span id="l69.222" class="difflineplus">+      *_objp = NULL;</span>
<a href="#l69.223"></a><span id="l69.223" class="difflineplus">+      return NS_OK;</span>
<a href="#l69.224"></a><span id="l69.224" class="difflineplus">+    }</span>
<a href="#l69.225"></a><span id="l69.225" class="difflineplus">+</span>
<a href="#l69.226"></a><span id="l69.226" class="difflineplus">+    *_retval = ::JS_DefineUCProperty(aCtx, aScopeObj, nameChars, nameLength,</span>
<a href="#l69.227"></a><span id="l69.227" class="difflineplus">+                                     JSVAL_VOID, nsnull, nsnull, 0);</span>
<a href="#l69.228"></a><span id="l69.228" class="difflineplus">+    NS_ENSURE_TRUE(*_retval, NS_OK);</span>
<a href="#l69.229"></a><span id="l69.229" class="difflineplus">+  }</span>
<a href="#l69.230"></a><span id="l69.230" class="difflineplus">+  else {</span>
<a href="#l69.231"></a><span id="l69.231" class="difflineplus">+    // We do not handle other types.</span>
<a href="#l69.232"></a><span id="l69.232" class="difflineplus">+    return NS_OK;</span>
<a href="#l69.233"></a><span id="l69.233" class="difflineplus">+  }</span>
<a href="#l69.234"></a><span id="l69.234" class="difflineplus">+</span>
<a href="#l69.235"></a><span id="l69.235" class="difflineplus">+  *_retval = ::JS_DefineElement(aCtx, aScopeObj, idx, JSVAL_VOID, nsnull,</span>
<a href="#l69.236"></a><span id="l69.236" class="difflineplus">+                                nsnull, 0);</span>
<a href="#l69.237"></a><span id="l69.237" class="difflineplus">+  if (*_retval)</span>
<a href="#l69.238"></a><span id="l69.238" class="difflineplus">+    *_objp = aScopeObj;</span>
<a href="#l69.239"></a><span id="l69.239" class="difflineplus">+  return NS_OK;</span>
<a href="#l69.240"></a><span id="l69.240" class="difflineplus">+}</span>
<a href="#l69.241"></a><span id="l69.241" class="difflineplus">+</span>
<a href="#l69.242"></a><span id="l69.242" class="difflineplus">+} // namespace storage</span>
<a href="#l69.243"></a><span id="l69.243" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1">new file mode 100644</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineminus">--- /dev/null</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementParams.h</span>
<a href="#l70.4"></a><span id="l70.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l70.5"></a><span id="l70.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l70.6"></a><span id="l70.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l70.7"></a><span id="l70.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l70.8"></a><span id="l70.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l70.9"></a><span id="l70.9" class="difflineplus">+ *</span>
<a href="#l70.10"></a><span id="l70.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l70.11"></a><span id="l70.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+ *</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+ * License.</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineplus">+ *</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+ *</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineplus">+ *</span>
<a href="#l70.27"></a><span id="l70.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineplus">+ *</span>
<a href="#l70.30"></a><span id="l70.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l70.40"></a><span id="l70.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineplus">+ *</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineplus">+</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineplus">+#ifndef _MOZSTORAGESTATEMENTPARAMS_H_</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineplus">+#define _MOZSTORAGESTATEMENTPARAMS_H_</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineplus">+</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+#include &quot;mozIStorageStatementWrapper.h&quot;</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineplus">+</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+class mozIStorageStatement;</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineplus">+namespace mozilla {</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineplus">+namespace storage {</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineplus">+</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineplus">+class Statement;</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineplus">+</span>
<a href="#l70.57"></a><span id="l70.57" class="difflineplus">+class StatementParams : public mozIStorageStatementParams</span>
<a href="#l70.58"></a><span id="l70.58" class="difflineplus">+                      , public nsIXPCScriptable</span>
<a href="#l70.59"></a><span id="l70.59" class="difflineplus">+{</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineplus">+public:</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineplus">+  StatementParams(mozIStorageStatement *aStatement);</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineplus">+</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineplus">+  // interfaces</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+  NS_DECL_MOZISTORAGESTATEMENTPARAMS</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineplus">+  NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineplus">+</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+protected:</span>
<a href="#l70.69"></a><span id="l70.69" class="difflineplus">+  mozIStorageStatement *mStatement;</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineplus">+  PRUint32 mParamCount;</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineplus">+</span>
<a href="#l70.72"></a><span id="l70.72" class="difflineplus">+  friend class Statement;</span>
<a href="#l70.73"></a><span id="l70.73" class="difflineplus">+};</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineplus">+</span>
<a href="#l70.75"></a><span id="l70.75" class="difflineplus">+} // namespace storage</span>
<a href="#l70.76"></a><span id="l70.76" class="difflineplus">+} // namespace mozilla</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+</span>
<a href="#l70.78"></a><span id="l70.78" class="difflineplus">+#endif /* _MOZSTORAGESTATEMENTPARAMS_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">new file mode 100644</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineminus">--- /dev/null</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementRow.cpp</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineat">@@ -0,0 +1,190 @@</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l71.6"></a><span id="l71.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l71.9"></a><span id="l71.9" class="difflineplus">+ *</span>
<a href="#l71.10"></a><span id="l71.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l71.11"></a><span id="l71.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+ *</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l71.18"></a><span id="l71.18" class="difflineplus">+ * License.</span>
<a href="#l71.19"></a><span id="l71.19" class="difflineplus">+ *</span>
<a href="#l71.20"></a><span id="l71.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineplus">+ *</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineplus">+ *</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+ *</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineplus">+ *</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineplus">+</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineplus">+</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+#include &quot;mozStorageStatementRow.h&quot;</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineplus">+</span>
<a href="#l71.51"></a><span id="l71.51" class="difflineplus">+#include &quot;jsapi.h&quot;</span>
<a href="#l71.52"></a><span id="l71.52" class="difflineplus">+#include &quot;jsdate.h&quot;</span>
<a href="#l71.53"></a><span id="l71.53" class="difflineplus">+</span>
<a href="#l71.54"></a><span id="l71.54" class="difflineplus">+namespace mozilla {</span>
<a href="#l71.55"></a><span id="l71.55" class="difflineplus">+namespace storage {</span>
<a href="#l71.56"></a><span id="l71.56" class="difflineplus">+</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l71.58"></a><span id="l71.58" class="difflineplus">+//// StatementRow</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineplus">+</span>
<a href="#l71.60"></a><span id="l71.60" class="difflineplus">+StatementRow::StatementRow(Statement *aStatement)</span>
<a href="#l71.61"></a><span id="l71.61" class="difflineplus">+: mStatement(aStatement)</span>
<a href="#l71.62"></a><span id="l71.62" class="difflineplus">+{</span>
<a href="#l71.63"></a><span id="l71.63" class="difflineplus">+}</span>
<a href="#l71.64"></a><span id="l71.64" class="difflineplus">+</span>
<a href="#l71.65"></a><span id="l71.65" class="difflineplus">+NS_IMPL_ISUPPORTS2(</span>
<a href="#l71.66"></a><span id="l71.66" class="difflineplus">+  StatementRow,</span>
<a href="#l71.67"></a><span id="l71.67" class="difflineplus">+  mozIStorageStatementRow,</span>
<a href="#l71.68"></a><span id="l71.68" class="difflineplus">+  nsIXPCScriptable</span>
<a href="#l71.69"></a><span id="l71.69" class="difflineplus">+)</span>
<a href="#l71.70"></a><span id="l71.70" class="difflineplus">+</span>
<a href="#l71.71"></a><span id="l71.71" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineplus">+</span>
<a href="#l71.74"></a><span id="l71.74" class="difflineplus">+#define XPC_MAP_CLASSNAME StatementRow</span>
<a href="#l71.75"></a><span id="l71.75" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;StatementRow&quot;</span>
<a href="#l71.76"></a><span id="l71.76" class="difflineplus">+#define XPC_MAP_WANT_GETPROPERTY</span>
<a href="#l71.77"></a><span id="l71.77" class="difflineplus">+#define XPC_MAP_WANT_NEWRESOLVE</span>
<a href="#l71.78"></a><span id="l71.78" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE</span>
<a href="#l71.79"></a><span id="l71.79" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l71.80"></a><span id="l71.80" class="difflineplus">+</span>
<a href="#l71.81"></a><span id="l71.81" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l71.82"></a><span id="l71.82" class="difflineplus">+StatementRow::GetProperty(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l71.83"></a><span id="l71.83" class="difflineplus">+                          JSContext *aCtx,</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineplus">+                          JSObject *aScopeObj,</span>
<a href="#l71.85"></a><span id="l71.85" class="difflineplus">+                          jsval aId,</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineplus">+                          jsval *_vp,</span>
<a href="#l71.87"></a><span id="l71.87" class="difflineplus">+                          PRBool *_retval)</span>
<a href="#l71.88"></a><span id="l71.88" class="difflineplus">+{</span>
<a href="#l71.89"></a><span id="l71.89" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l71.90"></a><span id="l71.90" class="difflineplus">+</span>
<a href="#l71.91"></a><span id="l71.91" class="difflineplus">+  if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l71.92"></a><span id="l71.92" class="difflineplus">+    nsDependentCString jsid(::JS_GetStringBytes(JSVAL_TO_STRING(aId)));</span>
<a href="#l71.93"></a><span id="l71.93" class="difflineplus">+</span>
<a href="#l71.94"></a><span id="l71.94" class="difflineplus">+    PRUint32 idx;</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineplus">+    nsresult rv = mStatement-&gt;GetColumnIndex(jsid, &amp;idx);</span>
<a href="#l71.96"></a><span id="l71.96" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.97"></a><span id="l71.97" class="difflineplus">+    PRInt32 type;</span>
<a href="#l71.98"></a><span id="l71.98" class="difflineplus">+    rv = mStatement-&gt;GetTypeOfIndex(idx, &amp;type);</span>
<a href="#l71.99"></a><span id="l71.99" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.100"></a><span id="l71.100" class="difflineplus">+</span>
<a href="#l71.101"></a><span id="l71.101" class="difflineplus">+    if (type == mozIStorageValueArray::VALUE_TYPE_INTEGER ||</span>
<a href="#l71.102"></a><span id="l71.102" class="difflineplus">+        type == mozIStorageValueArray::VALUE_TYPE_FLOAT) {</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineplus">+      double dval;</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineplus">+      rv = mStatement-&gt;GetDouble(idx, &amp;dval);</span>
<a href="#l71.105"></a><span id="l71.105" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l71.106"></a><span id="l71.106" class="difflineplus">+      if (!::JS_NewNumberValue(aCtx, dval, _vp)) {</span>
<a href="#l71.107"></a><span id="l71.107" class="difflineplus">+        *_retval = PR_FALSE;</span>
<a href="#l71.108"></a><span id="l71.108" class="difflineplus">+        return NS_OK;</span>
<a href="#l71.109"></a><span id="l71.109" class="difflineplus">+      }</span>
<a href="#l71.110"></a><span id="l71.110" class="difflineplus">+    }</span>
<a href="#l71.111"></a><span id="l71.111" class="difflineplus">+    else if (type == mozIStorageValueArray::VALUE_TYPE_TEXT) {</span>
<a href="#l71.112"></a><span id="l71.112" class="difflineplus">+      PRUint32 bytes;</span>
<a href="#l71.113"></a><span id="l71.113" class="difflineplus">+      const jschar *sval = reinterpret_cast&lt;const jschar *&gt;(</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineplus">+        static_cast&lt;mozIStorageStatement *&gt;(mStatement)-&gt;</span>
<a href="#l71.115"></a><span id="l71.115" class="difflineplus">+          AsSharedWString(idx, &amp;bytes)</span>
<a href="#l71.116"></a><span id="l71.116" class="difflineplus">+      );</span>
<a href="#l71.117"></a><span id="l71.117" class="difflineplus">+      JSString *str = ::JS_NewUCStringCopyN(aCtx, sval, bytes / 2);</span>
<a href="#l71.118"></a><span id="l71.118" class="difflineplus">+      if (!str) {</span>
<a href="#l71.119"></a><span id="l71.119" class="difflineplus">+        *_retval = PR_FALSE;</span>
<a href="#l71.120"></a><span id="l71.120" class="difflineplus">+        return NS_OK;</span>
<a href="#l71.121"></a><span id="l71.121" class="difflineplus">+      }</span>
<a href="#l71.122"></a><span id="l71.122" class="difflineplus">+      *_vp = STRING_TO_JSVAL(str);</span>
<a href="#l71.123"></a><span id="l71.123" class="difflineplus">+    }</span>
<a href="#l71.124"></a><span id="l71.124" class="difflineplus">+    else if (type == mozIStorageValueArray::VALUE_TYPE_BLOB) {</span>
<a href="#l71.125"></a><span id="l71.125" class="difflineplus">+      PRUint32 length;</span>
<a href="#l71.126"></a><span id="l71.126" class="difflineplus">+      const PRUint8 *blob = static_cast&lt;mozIStorageStatement *&gt;(mStatement)-&gt;</span>
<a href="#l71.127"></a><span id="l71.127" class="difflineplus">+        AsSharedBlob(idx, &amp;length);</span>
<a href="#l71.128"></a><span id="l71.128" class="difflineplus">+      JSObject *obj = ::JS_NewArrayObject(aCtx, length, nsnull);</span>
<a href="#l71.129"></a><span id="l71.129" class="difflineplus">+      if (!obj) {</span>
<a href="#l71.130"></a><span id="l71.130" class="difflineplus">+        *_retval = PR_FALSE;</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineplus">+        return NS_OK;</span>
<a href="#l71.132"></a><span id="l71.132" class="difflineplus">+      }</span>
<a href="#l71.133"></a><span id="l71.133" class="difflineplus">+      *_vp = OBJECT_TO_JSVAL(obj);</span>
<a href="#l71.134"></a><span id="l71.134" class="difflineplus">+</span>
<a href="#l71.135"></a><span id="l71.135" class="difflineplus">+      // Copy the blob over to the JS array.</span>
<a href="#l71.136"></a><span id="l71.136" class="difflineplus">+      for (PRUint32 i = 0; i &lt; length; i++) {</span>
<a href="#l71.137"></a><span id="l71.137" class="difflineplus">+        jsval val = INT_TO_JSVAL(blob[i]);</span>
<a href="#l71.138"></a><span id="l71.138" class="difflineplus">+        if (!::JS_SetElement(aCtx, aScopeObj, i, &amp;val)) {</span>
<a href="#l71.139"></a><span id="l71.139" class="difflineplus">+          *_retval = PR_FALSE;</span>
<a href="#l71.140"></a><span id="l71.140" class="difflineplus">+          return NS_OK;</span>
<a href="#l71.141"></a><span id="l71.141" class="difflineplus">+        }</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineplus">+      }</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineplus">+    }</span>
<a href="#l71.144"></a><span id="l71.144" class="difflineplus">+    else if (type == mozIStorageValueArray::VALUE_TYPE_NULL) {</span>
<a href="#l71.145"></a><span id="l71.145" class="difflineplus">+      *_vp = JSVAL_NULL;</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineplus">+    }</span>
<a href="#l71.147"></a><span id="l71.147" class="difflineplus">+    else {</span>
<a href="#l71.148"></a><span id="l71.148" class="difflineplus">+      NS_ERROR(&quot;unknown column type returned, what's going on?&quot;);</span>
<a href="#l71.149"></a><span id="l71.149" class="difflineplus">+    }</span>
<a href="#l71.150"></a><span id="l71.150" class="difflineplus">+  }</span>
<a href="#l71.151"></a><span id="l71.151" class="difflineplus">+</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l71.153"></a><span id="l71.153" class="difflineplus">+}</span>
<a href="#l71.154"></a><span id="l71.154" class="difflineplus">+</span>
<a href="#l71.155"></a><span id="l71.155" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l71.156"></a><span id="l71.156" class="difflineplus">+StatementRow::NewResolve(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l71.157"></a><span id="l71.157" class="difflineplus">+                         JSContext *aCtx,</span>
<a href="#l71.158"></a><span id="l71.158" class="difflineplus">+                         JSObject *aScopeObj,</span>
<a href="#l71.159"></a><span id="l71.159" class="difflineplus">+                         jsval aId,</span>
<a href="#l71.160"></a><span id="l71.160" class="difflineplus">+                         PRUint32 aFlags,</span>
<a href="#l71.161"></a><span id="l71.161" class="difflineplus">+                         JSObject **_objp,</span>
<a href="#l71.162"></a><span id="l71.162" class="difflineplus">+                         PRBool *_retval)</span>
<a href="#l71.163"></a><span id="l71.163" class="difflineplus">+{</span>
<a href="#l71.164"></a><span id="l71.164" class="difflineplus">+  NS_ENSURE_TRUE(mStatement, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l71.165"></a><span id="l71.165" class="difflineplus">+  // We do not throw at any point after this because we want to allow the</span>
<a href="#l71.166"></a><span id="l71.166" class="difflineplus">+  // prototype chain to be checked for the property.</span>
<a href="#l71.167"></a><span id="l71.167" class="difflineplus">+</span>
<a href="#l71.168"></a><span id="l71.168" class="difflineplus">+  if (JSVAL_IS_STRING(aId)) {</span>
<a href="#l71.169"></a><span id="l71.169" class="difflineplus">+    JSString *str = JSVAL_TO_STRING(aId);</span>
<a href="#l71.170"></a><span id="l71.170" class="difflineplus">+    nsDependentCString name(::JS_GetStringBytes(str));</span>
<a href="#l71.171"></a><span id="l71.171" class="difflineplus">+</span>
<a href="#l71.172"></a><span id="l71.172" class="difflineplus">+    PRUint32 idx;</span>
<a href="#l71.173"></a><span id="l71.173" class="difflineplus">+    nsresult rv = mStatement-&gt;GetColumnIndex(name, &amp;idx);</span>
<a href="#l71.174"></a><span id="l71.174" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l71.175"></a><span id="l71.175" class="difflineplus">+      // It's highly likely that the name doesn't exist, so let the JS engine</span>
<a href="#l71.176"></a><span id="l71.176" class="difflineplus">+      // check the prototype chain and throw if that doesn't have the property</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineplus">+      // either.</span>
<a href="#l71.178"></a><span id="l71.178" class="difflineplus">+      *_objp = NULL;</span>
<a href="#l71.179"></a><span id="l71.179" class="difflineplus">+      return NS_OK;</span>
<a href="#l71.180"></a><span id="l71.180" class="difflineplus">+    }</span>
<a href="#l71.181"></a><span id="l71.181" class="difflineplus">+</span>
<a href="#l71.182"></a><span id="l71.182" class="difflineplus">+    *_retval = ::JS_DefineUCProperty(aCtx, aScopeObj, ::JS_GetStringChars(str),</span>
<a href="#l71.183"></a><span id="l71.183" class="difflineplus">+                                     ::JS_GetStringLength(str),</span>
<a href="#l71.184"></a><span id="l71.184" class="difflineplus">+                                     JSVAL_VOID,</span>
<a href="#l71.185"></a><span id="l71.185" class="difflineplus">+                                     nsnull, nsnull, 0);</span>
<a href="#l71.186"></a><span id="l71.186" class="difflineplus">+    *_objp = aScopeObj;</span>
<a href="#l71.187"></a><span id="l71.187" class="difflineplus">+    return NS_OK;</span>
<a href="#l71.188"></a><span id="l71.188" class="difflineplus">+  }</span>
<a href="#l71.189"></a><span id="l71.189" class="difflineplus">+</span>
<a href="#l71.190"></a><span id="l71.190" class="difflineplus">+  return NS_OK;</span>
<a href="#l71.191"></a><span id="l71.191" class="difflineplus">+}</span>
<a href="#l71.192"></a><span id="l71.192" class="difflineplus">+</span>
<a href="#l71.193"></a><span id="l71.193" class="difflineplus">+} // namespace storage</span>
<a href="#l71.194"></a><span id="l71.194" class="difflineplus">+} // namescape mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1">new file mode 100644</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineminus">--- /dev/null</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementRow.h</span>
<a href="#l72.4"></a><span id="l72.4" class="difflineat">@@ -0,0 +1,70 @@</span>
<a href="#l72.5"></a><span id="l72.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l72.6"></a><span id="l72.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l72.7"></a><span id="l72.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l72.8"></a><span id="l72.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l72.9"></a><span id="l72.9" class="difflineplus">+ *</span>
<a href="#l72.10"></a><span id="l72.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l72.11"></a><span id="l72.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+ *</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l72.16"></a><span id="l72.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+ * License.</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineplus">+ *</span>
<a href="#l72.20"></a><span id="l72.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l72.21"></a><span id="l72.21" class="difflineplus">+ *</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l72.23"></a><span id="l72.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineplus">+ *</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l72.29"></a><span id="l72.29" class="difflineplus">+ *</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l72.33"></a><span id="l72.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l72.36"></a><span id="l72.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l72.37"></a><span id="l72.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineplus">+ *</span>
<a href="#l72.42"></a><span id="l72.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l72.43"></a><span id="l72.43" class="difflineplus">+</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+#ifndef _MOZSTORAGESTATEMENTROW_H_</span>
<a href="#l72.45"></a><span id="l72.45" class="difflineplus">+#define _MOZSTORAGESTATEMENTROW_H_</span>
<a href="#l72.46"></a><span id="l72.46" class="difflineplus">+</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineplus">+#include &quot;mozIStorageStatementWrapper.h&quot;</span>
<a href="#l72.48"></a><span id="l72.48" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineplus">+</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineplus">+namespace mozilla {</span>
<a href="#l72.51"></a><span id="l72.51" class="difflineplus">+namespace storage {</span>
<a href="#l72.52"></a><span id="l72.52" class="difflineplus">+</span>
<a href="#l72.53"></a><span id="l72.53" class="difflineplus">+class Statement;</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineplus">+class StatementRow : public mozIStorageStatementRow</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineplus">+                   , public nsIXPCScriptable</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+{</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineplus">+public:</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+  NS_DECL_MOZISTORAGESTATEMENTROW</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+  NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineplus">+</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+  StatementRow(Statement *aStatement);</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineplus">+protected:</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineplus">+</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineplus">+  Statement *mStatement;</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineplus">+</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineplus">+  friend class Statement;</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineplus">+};</span>
<a href="#l72.70"></a><span id="l72.70" class="difflineplus">+</span>
<a href="#l72.71"></a><span id="l72.71" class="difflineplus">+} // namespace storage</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineplus">+} // namespace mozilla</span>
<a href="#l72.73"></a><span id="l72.73" class="difflineplus">+</span>
<a href="#l72.74"></a><span id="l72.74" class="difflineplus">+#endif /* _MOZSTORAGESTATEMENTROW_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">new file mode 100644</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineminus">--- /dev/null</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementWrapper.cpp</span>
<a href="#l73.4"></a><span id="l73.4" class="difflineat">@@ -0,0 +1,224 @@</span>
<a href="#l73.5"></a><span id="l73.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l73.6"></a><span id="l73.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l73.7"></a><span id="l73.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l73.8"></a><span id="l73.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l73.9"></a><span id="l73.9" class="difflineplus">+ *</span>
<a href="#l73.10"></a><span id="l73.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l73.11"></a><span id="l73.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+ *</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+ * License.</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+ *</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+ *</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineplus">+ *</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+ *</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineplus">+ *</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineplus">+</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineplus">+#include &quot;mozStoragePrivateHelpers.h&quot;</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+#include &quot;mozStorageStatementWrapper.h&quot;</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+#include &quot;mozStorageStatementParams.h&quot;</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+#include &quot;mozStorageStatementRow.h&quot;</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+namespace mozilla {</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+namespace storage {</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineplus">+</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineplus">+//// StatementWrapper</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineplus">+StatementWrapper::StatementWrapper()</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineplus">+: mStatement(nsnull)</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineplus">+{</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+}</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineplus">+</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineplus">+StatementWrapper::~StatementWrapper()</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineplus">+{</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+  mStatement = nsnull;</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineplus">+}</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+NS_IMPL_ISUPPORTS2(</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+  StatementWrapper,</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+  mozIStorageStatementWrapper,</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+  nsIXPCScriptable</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+)</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+//// mozIStorageStatementWrapper</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineplus">+StatementWrapper::Initialize(mozIStorageStatement *aStatement)</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineplus">+{</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineplus">+  NS_ASSERTION(mStatement == nsnull, &quot;StatementWrapper is already initialized&quot;);</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStatement);</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+  mStatement = static_cast&lt;Statement *&gt;(aStatement);</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineplus">+</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineplus">+  // fetch various things we care about</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+  (void)mStatement-&gt;GetParameterCount(&amp;mParamCount);</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+  (void)mStatement-&gt;GetColumnCount(&amp;mResultColumnCount);</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+  for (unsigned int i = 0; i &lt; mResultColumnCount; i++) {</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+    const void *name = ::sqlite3_column_name16(nativeStatement(), i);</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+    (void)mColumnNames.AppendElement(nsDependentString(static_cast&lt;const PRUnichar*&gt;(name)));</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+  }</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+</span>
<a href="#l73.96"></a><span id="l73.96" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.97"></a><span id="l73.97" class="difflineplus">+}</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+</span>
<a href="#l73.99"></a><span id="l73.99" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineplus">+StatementWrapper::GetStatement(mozIStorageStatement **_statement)</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineplus">+{</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+  NS_IF_ADDREF(*_statement = mStatement);</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineplus">+}</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineplus">+</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineplus">+StatementWrapper::Reset()</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+{</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineplus">+  if (!mStatement)</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineplus">+</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineplus">+  return mStatement-&gt;Reset();</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineplus">+}</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineplus">+</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+StatementWrapper::Step(PRBool *_hasMoreResults)</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+{</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+  if (!mStatement)</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineplus">+</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineplus">+  PRBool hasMore = PR_FALSE;</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineplus">+  nsresult rv = mStatement-&gt;ExecuteStep(&amp;hasMore);</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !hasMore) {</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineplus">+    *_hasMoreResults = PR_FALSE;</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+    (void)mStatement-&gt;Reset();</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+    return NS_OK;</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+  }</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+  *_hasMoreResults = hasMore;</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineplus">+  return rv;</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+}</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+StatementWrapper::Execute()</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+{</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+  if (!mStatement)</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineplus">+</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineplus">+  return mStatement-&gt;Execute();</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineplus">+}</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineplus">+</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineplus">+StatementWrapper::GetRow(mozIStorageStatementRow **_row)</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+{</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_row);</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+  if (!mStatement)</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+  PRInt32 state;</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+  mStatement-&gt;GetState(&amp;state);</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+  if (state != mozIStorageStatement::MOZ_STORAGE_STATEMENT_EXECUTING)</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+  if (!mStatementRow) {</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineplus">+    mStatementRow = new StatementRow(mStatement);</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+    NS_ENSURE_TRUE(mStatementRow, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineplus">+  }</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineplus">+</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+  NS_ADDREF(*_row = mStatementRow);</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+}</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+StatementWrapper::GetParams(mozIStorageStatementParams **_params)</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineplus">+{</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_params);</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineplus">+</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+  if (!mStatementParams) {</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+    mStatementParams = new StatementParams(mStatement);</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineplus">+    NS_ENSURE_TRUE(mStatementParams, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l73.172"></a><span id="l73.172" class="difflineplus">+  }</span>
<a href="#l73.173"></a><span id="l73.173" class="difflineplus">+</span>
<a href="#l73.174"></a><span id="l73.174" class="difflineplus">+  NS_ADDREF(*_params = mStatementParams);</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+}</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineplus">+</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+//// nsIXPCScriptable</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineplus">+</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineplus">+#define XPC_MAP_CLASSNAME StatementWrapper</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+#define XPC_MAP_QUOTED_CLASSNAME &quot;StatementWrapper&quot;</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+#define XPC_MAP_WANT_CALL</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+#define XPC_MAP_FLAGS nsIXPCScriptable::ALLOW_PROP_MODS_DURING_RESOLVE | \</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+                      nsIXPCScriptable::USE_JSSTUB_FOR_SETPROPERTY</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineplus">+#include &quot;xpc_map_end.h&quot;</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+StatementWrapper::Call(nsIXPConnectWrappedNative *aWrapper,</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+                       JSContext *aCtx,</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+                       JSObject *aScopeObj,</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineplus">+                       PRUint32 aArgc,</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineplus">+                       jsval *aArgv,</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineplus">+                       jsval *_vp,</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+                       PRBool *_retval)</span>
<a href="#l73.196"></a><span id="l73.196" class="difflineplus">+{</span>
<a href="#l73.197"></a><span id="l73.197" class="difflineplus">+  if (!mStatement)</span>
<a href="#l73.198"></a><span id="l73.198" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineplus">+</span>
<a href="#l73.200"></a><span id="l73.200" class="difflineplus">+  if (aArgc != mParamCount) {</span>
<a href="#l73.201"></a><span id="l73.201" class="difflineplus">+    *_retval = PR_FALSE;</span>
<a href="#l73.202"></a><span id="l73.202" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineplus">+  }</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineplus">+</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineplus">+  // reset</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineplus">+  (void)mStatement-&gt;Reset();</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineplus">+</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineplus">+  // bind parameters</span>
<a href="#l73.209"></a><span id="l73.209" class="difflineplus">+  for (int i = 0; i &lt; (int)aArgc; i++) {</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineplus">+    nsCOMPtr&lt;nsIVariant&gt; variant(convertJSValToVariant(aCtx, aArgv[i]));</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+    if (!variant ||</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+        NS_FAILED(mStatement-&gt;BindByIndex(i, variant))) {</span>
<a href="#l73.213"></a><span id="l73.213" class="difflineplus">+      *_retval = PR_FALSE;</span>
<a href="#l73.214"></a><span id="l73.214" class="difflineplus">+      return NS_ERROR_INVALID_ARG;</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineplus">+    }</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineplus">+  }</span>
<a href="#l73.217"></a><span id="l73.217" class="difflineplus">+</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineplus">+  // if there are no results, we just execute</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineplus">+  if (mResultColumnCount == 0)</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineplus">+    (void)mStatement-&gt;Execute();</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineplus">+</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineplus">+  *_vp = JSVAL_TRUE;</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineplus">+  *_retval = PR_TRUE;</span>
<a href="#l73.224"></a><span id="l73.224" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.225"></a><span id="l73.225" class="difflineplus">+}</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineplus">+</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineplus">+} // namespace storage</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">new file mode 100644</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineminus">--- /dev/null</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineplus">+++ b/storage-backport/src/mozStorageStatementWrapper.h</span>
<a href="#l74.4"></a><span id="l74.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l74.5"></a><span id="l74.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l74.6"></a><span id="l74.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l74.7"></a><span id="l74.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l74.8"></a><span id="l74.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l74.9"></a><span id="l74.9" class="difflineplus">+ *</span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+ *</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+ * License.</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+ *</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+ * The Original Code is Oracle Corporation code.</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+ *</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+ *  Oracle Corporation</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l74.26"></a><span id="l74.26" class="difflineplus">+ *</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineplus">+ *</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l74.37"></a><span id="l74.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l74.38"></a><span id="l74.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l74.39"></a><span id="l74.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineplus">+ *</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineplus">+</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+#ifndef _mozStorageStatementWrapper_h_</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineplus">+#define _mozStorageStatementWrapper_h_</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineplus">+</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l74.48"></a><span id="l74.48" class="difflineplus">+#include &quot;nsIXPCScriptable.h&quot;</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineplus">+</span>
<a href="#l74.50"></a><span id="l74.50" class="difflineplus">+#include &quot;mozStorageStatement.h&quot;</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineplus">+#include &quot;mozIStorageStatementWrapper.h&quot;</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineplus">+namespace mozilla {</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+namespace storage {</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineplus">+class StatementWrapper : public mozIStorageStatementWrapper</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineplus">+                       , public nsIXPCScriptable</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineplus">+{</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineplus">+public:</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineplus">+    StatementWrapper();</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineplus">+</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineplus">+    // interfaces</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineplus">+    NS_DECL_MOZISTORAGESTATEMENTWRAPPER</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+    NS_DECL_NSIXPCSCRIPTABLE</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineplus">+</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineplus">+private:</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineplus">+    ~StatementWrapper();</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineplus">+    sqlite3_stmt *nativeStatement() {</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineplus">+      return mStatement-&gt;nativeStatement();</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineplus">+    }</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineplus">+</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineplus">+    nsRefPtr&lt;Statement&gt; mStatement;</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineplus">+    PRUint32 mParamCount;</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineplus">+    PRUint32 mResultColumnCount;</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineplus">+    nsTArray&lt;nsString&gt; mColumnNames;</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineplus">+</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementRow&gt; mStatementRow;</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineplus">+    nsCOMPtr&lt;mozIStorageStatementParams&gt; mStatementParams;</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineplus">+};</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineplus">+</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineplus">+} // namespace storage</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineplus">+} // namespace mozilla</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineplus">+</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineplus">+#endif // _mozStorageStatementWrapper_h_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">new file mode 100644</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineminus">--- /dev/null</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineplus">+++ b/storage-backport/src/variantToSQLiteT_impl.h</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineat">@@ -0,0 +1,161 @@</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l75.6"></a><span id="l75.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l75.7"></a><span id="l75.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l75.8"></a><span id="l75.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineplus">+ *</span>
<a href="#l75.10"></a><span id="l75.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l75.11"></a><span id="l75.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+ *</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+ * License.</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+ *</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+ *</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineplus">+ * Mozilla Corporation</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineplus">+ *</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+ *   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+ *</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+ *</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineplus">+</span>
<a href="#l75.45"></a><span id="l75.45" class="difflineplus">+// Note: we are already in the namepace mozilla::storage</span>
<a href="#l75.46"></a><span id="l75.46" class="difflineplus">+</span>
<a href="#l75.47"></a><span id="l75.47" class="difflineplus">+// Note 2: whoever #includes this file must provide implementations of</span>
<a href="#l75.48"></a><span id="l75.48" class="difflineplus">+// sqlite3_T_* prior.</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineplus">+</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineplus">+//// variantToSQLiteT Implementation</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineplus">+</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+template &lt;typename T&gt;</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineplus">+int</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+variantToSQLiteT(T aObj,</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+                 nsIVariant *aValue)</span>
<a href="#l75.57"></a><span id="l75.57" class="difflineplus">+{</span>
<a href="#l75.58"></a><span id="l75.58" class="difflineplus">+  // Allow to return NULL not wrapped to nsIVariant for speed.</span>
<a href="#l75.59"></a><span id="l75.59" class="difflineplus">+  if (!aValue)</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineplus">+    return sqlite3_T_null(aObj);</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineplus">+</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineplus">+  PRUint16 type;</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+  (void)aValue-&gt;GetDataType(&amp;type);</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineplus">+  switch (type) {</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+    case nsIDataType::VTYPE_INT8:</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineplus">+    case nsIDataType::VTYPE_INT16:</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineplus">+    case nsIDataType::VTYPE_INT32:</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineplus">+    case nsIDataType::VTYPE_UINT8:</span>
<a href="#l75.69"></a><span id="l75.69" class="difflineplus">+    case nsIDataType::VTYPE_UINT16:</span>
<a href="#l75.70"></a><span id="l75.70" class="difflineplus">+    {</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineplus">+      PRInt32 value;</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsInt32(&amp;value);</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineplus">+      return sqlite3_T_int(aObj, value);</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineplus">+    }</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineplus">+    case nsIDataType::VTYPE_UINT32: // Try to preserve full range</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineplus">+    case nsIDataType::VTYPE_INT64:</span>
<a href="#l75.78"></a><span id="l75.78" class="difflineplus">+    // Data loss possible, but there is no unsigned types in SQLite</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineplus">+    case nsIDataType::VTYPE_UINT64:</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineplus">+    {</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineplus">+      PRInt64 value;</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsInt64(&amp;value);</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+      return sqlite3_T_int64(aObj, value);</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+    }</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+    case nsIDataType::VTYPE_FLOAT:</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineplus">+    case nsIDataType::VTYPE_DOUBLE:</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+    {</span>
<a href="#l75.89"></a><span id="l75.89" class="difflineplus">+      double value;</span>
<a href="#l75.90"></a><span id="l75.90" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsDouble(&amp;value);</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineplus">+      return sqlite3_T_double(aObj, value);</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineplus">+    }</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineplus">+    case nsIDataType::VTYPE_BOOL:</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineplus">+    {</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineplus">+      PRBool value;</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsBool(&amp;value);</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineplus">+      return sqlite3_T_int(aObj, value ? 1 : 0);</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineplus">+    }</span>
<a href="#l75.101"></a><span id="l75.101" class="difflineplus">+    case nsIDataType::VTYPE_CHAR:</span>
<a href="#l75.102"></a><span id="l75.102" class="difflineplus">+    case nsIDataType::VTYPE_CHAR_STR:</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineplus">+    case nsIDataType::VTYPE_STRING_SIZE_IS:</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineplus">+    case nsIDataType::VTYPE_UTF8STRING:</span>
<a href="#l75.105"></a><span id="l75.105" class="difflineplus">+    case nsIDataType::VTYPE_CSTRING:</span>
<a href="#l75.106"></a><span id="l75.106" class="difflineplus">+    {</span>
<a href="#l75.107"></a><span id="l75.107" class="difflineplus">+      nsCAutoString value;</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineplus">+      // GetAsAUTF8String should never perform conversion when coming from</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineplus">+      // 8-bit string types, and thus can accept strings with arbitrary encoding</span>
<a href="#l75.110"></a><span id="l75.110" class="difflineplus">+      // (including UTF8 and ASCII).</span>
<a href="#l75.111"></a><span id="l75.111" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsAUTF8String(value);</span>
<a href="#l75.112"></a><span id="l75.112" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.113"></a><span id="l75.113" class="difflineplus">+      return sqlite3_T_text(aObj, value);</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineplus">+    }</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineplus">+    case nsIDataType::VTYPE_WCHAR:</span>
<a href="#l75.116"></a><span id="l75.116" class="difflineplus">+    case nsIDataType::VTYPE_DOMSTRING:</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineplus">+    case nsIDataType::VTYPE_WCHAR_STR:</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineplus">+    case nsIDataType::VTYPE_WSTRING_SIZE_IS:</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineplus">+    case nsIDataType::VTYPE_ASTRING:</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineplus">+    {</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineplus">+      nsAutoString value;</span>
<a href="#l75.122"></a><span id="l75.122" class="difflineplus">+      // GetAsAString does proper conversion to UCS2 from all string-like types.</span>
<a href="#l75.123"></a><span id="l75.123" class="difflineplus">+      // It can be used universally without problems (unless someone implements</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineplus">+      // their own variant, but that's their problem).</span>
<a href="#l75.125"></a><span id="l75.125" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsAString(value);</span>
<a href="#l75.126"></a><span id="l75.126" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.127"></a><span id="l75.127" class="difflineplus">+      return sqlite3_T_text16(aObj, value);</span>
<a href="#l75.128"></a><span id="l75.128" class="difflineplus">+    }</span>
<a href="#l75.129"></a><span id="l75.129" class="difflineplus">+    case nsIDataType::VTYPE_VOID:</span>
<a href="#l75.130"></a><span id="l75.130" class="difflineplus">+    case nsIDataType::VTYPE_EMPTY:</span>
<a href="#l75.131"></a><span id="l75.131" class="difflineplus">+    case nsIDataType::VTYPE_EMPTY_ARRAY:</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineplus">+      return sqlite3_T_null(aObj);</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineplus">+    case nsIDataType::VTYPE_ARRAY:</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineplus">+    {</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineplus">+      PRUint16 type;</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineplus">+      nsIID iid;</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineplus">+      PRUint32 count;</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineplus">+      void *data;</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineplus">+      nsresult rv = aValue-&gt;GetAsArray(&amp;type, &amp;iid, &amp;count, &amp;data);</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, SQLITE_MISMATCH);</span>
<a href="#l75.141"></a><span id="l75.141" class="difflineplus">+</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineplus">+      // Check to make sure it's a supported type.</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineplus">+      NS_ASSERTION(type == nsIDataType::VTYPE_UINT8,</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineplus">+                   &quot;Invalid type passed!  You may leak!&quot;);</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineplus">+      if (type != nsIDataType::VTYPE_UINT8) {</span>
<a href="#l75.146"></a><span id="l75.146" class="difflineplus">+        // Technically this could leak with certain data types, but somebody was</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineplus">+        // being stupid passing us this anyway.</span>
<a href="#l75.148"></a><span id="l75.148" class="difflineplus">+        NS_Free(data);</span>
<a href="#l75.149"></a><span id="l75.149" class="difflineplus">+        return SQLITE_MISMATCH;</span>
<a href="#l75.150"></a><span id="l75.150" class="difflineplus">+      }</span>
<a href="#l75.151"></a><span id="l75.151" class="difflineplus">+</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineplus">+      // Finally do our thing.  The function should free the array accordingly!</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineplus">+      int rc = sqlite3_T_blob(aObj, data, count);</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineplus">+      return rc;</span>
<a href="#l75.155"></a><span id="l75.155" class="difflineplus">+    }</span>
<a href="#l75.156"></a><span id="l75.156" class="difflineplus">+    // Maybe, it'll be possible to convert these</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineplus">+    // in future too.</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineplus">+    case nsIDataType::VTYPE_ID:</span>
<a href="#l75.159"></a><span id="l75.159" class="difflineplus">+    case nsIDataType::VTYPE_INTERFACE:</span>
<a href="#l75.160"></a><span id="l75.160" class="difflineplus">+    case nsIDataType::VTYPE_INTERFACE_IS:</span>
<a href="#l75.161"></a><span id="l75.161" class="difflineplus">+    default:</span>
<a href="#l75.162"></a><span id="l75.162" class="difflineplus">+      return SQLITE_MISMATCH;</span>
<a href="#l75.163"></a><span id="l75.163" class="difflineplus">+  }</span>
<a href="#l75.164"></a><span id="l75.164" class="difflineplus">+  return SQLITE_OK;</span>
<a href="#l75.165"></a><span id="l75.165" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">new file mode 100644</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineminus">--- /dev/null</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineplus">+++ b/storage-backport/style.txt</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineat">@@ -0,0 +1,128 @@</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineplus">+Storage Module Style Guidelines</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineplus">+</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineplus">+These guidelines should be followed for all new code in this module.  Reviewers</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineplus">+will be enforcing them, so please obey them!</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineplus">+</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineplus">+* All code should be contained within the namespace mozilla::storage at a</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineplus">+  minimum.  The use of namespaces is strongly encouraged.</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+* All functions being called in the global namespace should be prefixed with</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+  &quot;::&quot; to indicate that they are in the global namespace.</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+* The indentation level to use in source code is two spaces.  No tabs, please!</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+* All files should have the following emacs and vim mode lines:</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+  -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineplus">+  vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineplus">+</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineplus">+* All functions that are not XPCOM should start with a lowercase letter.</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineplus">+</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+* Function arguments that are not out parameters should be prefixed with a (for</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+  pArameter), and use CamelCase.</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+* Function arguments that are out parameters should be prefixed with an</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+  underscore and have a descriptive name.</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineplus">+</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+* Function declarations should include javadoc style comments.</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+* Javadoc @param tags should have the parameter description start on a new line</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+  aligned with the variable name.  See the example below.</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+* Javadoc @return (note: non-plural) continuation lines should be lined up with</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+  the initial comment.  See the example below.</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+* For function implementations, each argument should be on its own line.</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineplus">+</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+* All variables should use camelCase.</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineplus">+* The use of bool is encouraged whenever the variable does not have the</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineplus">+  potential to go through xpconnect.</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineplus">+</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+* For pointer variable types, include a space after the type before the asterisk</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+  and no space between the asterisk and variable name.</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+* If any part of an if-else block requires braces, all blocks need braces.</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+* Every else should be on a newline after a brace.</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+</span>
<a href="#l76.52"></a><span id="l76.52" class="difflineplus">+* Bracing should start on the line after a function and class definition.  This</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineplus">+  goes for JavaScript code as well as C++ code.</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineplus">+</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+* If a return value is not going to be checked, the return value should be</span>
<a href="#l76.56"></a><span id="l76.56" class="difflineplus">+  explicitly casted to void (C style cast).</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineplus">+</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineplus">+</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+BIG EXAMPLE:</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+*** Header ***</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineplus">+</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l76.64"></a><span id="l76.64" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineplus">+...</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+#ifndef mozilla_storage_FILENAME_h_</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+#define mozilla_storage_FILENAME_h_</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+namespace mozilla {</span>
<a href="#l76.73"></a><span id="l76.73" class="difflineplus">+namespace storage {</span>
<a href="#l76.74"></a><span id="l76.74" class="difflineplus">+</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+class Foo : Bar</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineplus">+          , Baz</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineplus">+{</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineplus">+public:</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+  /**</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+   * Brief function summary.</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+   *</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+   * @param aArg1</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+   *        Description description description description description etc etc</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineplus">+   *        next line of description.</span>
<a href="#l76.85"></a><span id="l76.85" class="difflineplus">+   * @param aArg2</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineplus">+   *        Description description description.</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineplus">+   * @return Description description description description description etc etc</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineplus">+   *         next line of description.</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+   */</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+  int chew(int aArg1, int aArg2);</span>
<a href="#l76.91"></a><span id="l76.91" class="difflineplus">+};</span>
<a href="#l76.92"></a><span id="l76.92" class="difflineplus">+</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+} // storage</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineplus">+} // mozilla</span>
<a href="#l76.95"></a><span id="l76.95" class="difflineplus">+</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineplus">+#endif // mozilla_storage_FILENAME_h_</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+</span>
<a href="#l76.98"></a><span id="l76.98" class="difflineplus">+</span>
<a href="#l76.99"></a><span id="l76.99" class="difflineplus">+*** Implementation ***</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l76.103"></a><span id="l76.103" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l76.104"></a><span id="l76.104" class="difflineplus">+...</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l76.106"></a><span id="l76.106" class="difflineplus">+</span>
<a href="#l76.107"></a><span id="l76.107" class="difflineplus">+NS_IMPL_THREADSAFE_ISUPPORTS2(</span>
<a href="#l76.108"></a><span id="l76.108" class="difflineplus">+  Foo</span>
<a href="#l76.109"></a><span id="l76.109" class="difflineplus">+, IBar</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineplus">+, IBaz</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineplus">+)</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineplus">+</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineplus">+Foo::Foo(</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineplus">+  LongArgumentLineThatWouldOtherwiseOverflow *aArgument1</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineplus">+)</span>
<a href="#l76.116"></a><span id="l76.116" class="difflineplus">+: mField1(0)</span>
<a href="#l76.117"></a><span id="l76.117" class="difflineplus">+, mField2(0)</span>
<a href="#l76.118"></a><span id="l76.118" class="difflineplus">+{</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineplus">+}</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineplus">+</span>
<a href="#l76.121"></a><span id="l76.121" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.122"></a><span id="l76.122" class="difflineplus">+//// Separate sections of the file like this</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineplus">+</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineplus">+int</span>
<a href="#l76.125"></a><span id="l76.125" class="difflineplus">+Foo::chew(int aArg1, int aArg2)</span>
<a href="#l76.126"></a><span id="l76.126" class="difflineplus">+{</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineplus">+  (void)functionReturningAnIgnoredValue();</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineplus">+</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineplus">+  ::functionFromGlobalNamespaceWithVoidReturnValue();</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineplus">+</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineplus">+  return 0;</span>
<a href="#l76.132"></a><span id="l76.132" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1">new file mode 100644</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineminus">--- /dev/null</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineplus">+++ b/storage-backport/test/Makefile.in</span>
<a href="#l77.4"></a><span id="l77.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l77.5"></a><span id="l77.5" class="difflineplus">+#</span>
<a href="#l77.6"></a><span id="l77.6" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l77.7"></a><span id="l77.7" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l77.8"></a><span id="l77.8" class="difflineplus">+#</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+#</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineplus">+# License.</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+#</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+# The Original Code is Oracle Corporation code.</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineplus">+#</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineplus">+#   Oracle Corporation</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineplus">+#</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+# Contributor(s):</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineplus">+#   Vladimir Vukicevic &lt;vladimir.vukicevic@oracle.com&gt;</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineplus">+#   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineplus">+#</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineplus">+#</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+DEPTH		= ../..</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineplus">+</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineplus">+</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+MODULE = test_storage</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineplus">+</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineplus">+XPCSHELL_TESTS = unit</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineplus">+</span>
<a href="#l77.55"></a><span id="l77.55" class="difflineplus">+CPP_UNIT_TESTS = \</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineplus">+  test_transaction_helper.cpp \</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+  test_statement_scoper.cpp \</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineplus">+  test_mutex.cpp \</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineplus">+  test_binding_params.cpp \</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineplus">+  test_true_async.cpp \</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineplus">+  $(NULL)</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineplus">+</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineplus">+ifdef MOZ_DEBUG</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineplus">+# FIXME bug 523392: test_deadlock_detector doesn't like Windows</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineplus">+# FIXME bug 523378: also fails on OS X</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineplus">+ifneq (,$(filter-out WINNT WINCE Darwin,$(OS_ARCH)))</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineplus">+CPP_UNIT_TESTS += \</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+  test_deadlock_detector.cpp \</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineplus">+  $(NULL)</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineplus">+endif</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineplus">+endif</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineplus">+</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineplus">+</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+LOCAL_INCLUDES = \</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+  -I$(srcdir)/../src \</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+  $(NULL)</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineplus">+LIBS = \</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+	$(LIBS_DIR) \</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+	$(LIBXUL_DIST)/lib/$(LIB_PREFIX)xpcomglue_s.$(LIB_SUFFIX) \</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+	$(MOZ_COMPONENT_LIBS) \</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineplus">+	$(SQLITE_LIBS) \</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+	$(NULL)</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">new file mode 100644</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineminus">--- /dev/null</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineplus">+++ b/storage-backport/test/storage_test_harness.h</span>
<a href="#l78.4"></a><span id="l78.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l78.5"></a><span id="l78.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l78.6"></a><span id="l78.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l78.7"></a><span id="l78.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l78.8"></a><span id="l78.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l78.9"></a><span id="l78.9" class="difflineplus">+ *</span>
<a href="#l78.10"></a><span id="l78.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l78.11"></a><span id="l78.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+ *</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+ * License.</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+ *</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+ *</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+ *</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineplus">+ *</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l78.39"></a><span id="l78.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l78.41"></a><span id="l78.41" class="difflineplus">+ *</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+#include &quot;TestHarness.h&quot;</span>
<a href="#l78.45"></a><span id="l78.45" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l78.46"></a><span id="l78.46" class="difflineplus">+#include &quot;mozIStorageService.h&quot;</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineplus">+#include &quot;mozIStorageConnection.h&quot;</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineplus">+static int gTotalTests = 0;</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+static int gPassedTests = 0;</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineplus">+</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+#define do_check_true(aCondition) \</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineplus">+  PR_BEGIN_MACRO \</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+    gTotalTests++; \</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+    if (aCondition) \</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+      gPassedTests++; \</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineplus">+    else \</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+      fail(&quot;Expected true, got false on line %d!&quot;, __LINE__); \</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineplus">+  PR_END_MACRO</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineplus">+</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+#define do_check_false(aCondition) \</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+  PR_BEGIN_MACRO \</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineplus">+    gTotalTests++; \</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+    if (!aCondition) \</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+      gPassedTests++; \</span>
<a href="#l78.66"></a><span id="l78.66" class="difflineplus">+    else \</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineplus">+      fail(&quot;Expected false, got true on line %d!&quot;, __LINE__); \</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+  PR_END_MACRO</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineplus">+</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineplus">+already_AddRefed&lt;mozIStorageConnection&gt;</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineplus">+getMemoryDatabase()</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineplus">+{</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+  nsCOMPtr&lt;mozIStorageService&gt; ss =</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+    do_GetService(&quot;@mozilla.org/storage/service;1&quot;);</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; conn;</span>
<a href="#l78.76"></a><span id="l78.76" class="difflineplus">+  (void)ss-&gt;OpenSpecialDatabase(&quot;memory&quot;, getter_AddRefs(conn));</span>
<a href="#l78.77"></a><span id="l78.77" class="difflineplus">+  return conn.forget();</span>
<a href="#l78.78"></a><span id="l78.78" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1">new file mode 100644</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineminus">--- /dev/null</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineplus">+++ b/storage-backport/test/storage_test_harness_tail.h</span>
<a href="#l79.4"></a><span id="l79.4" class="difflineat">@@ -0,0 +1,61 @@</span>
<a href="#l79.5"></a><span id="l79.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l79.6"></a><span id="l79.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l79.7"></a><span id="l79.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l79.8"></a><span id="l79.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l79.9"></a><span id="l79.9" class="difflineplus">+ *</span>
<a href="#l79.10"></a><span id="l79.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l79.11"></a><span id="l79.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+ *</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l79.17"></a><span id="l79.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l79.18"></a><span id="l79.18" class="difflineplus">+ * License.</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineplus">+ *</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l79.21"></a><span id="l79.21" class="difflineplus">+ *</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l79.23"></a><span id="l79.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l79.26"></a><span id="l79.26" class="difflineplus">+ *</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+ *</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l79.34"></a><span id="l79.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l79.35"></a><span id="l79.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l79.36"></a><span id="l79.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l79.37"></a><span id="l79.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l79.39"></a><span id="l79.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l79.40"></a><span id="l79.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineplus">+ *</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l79.43"></a><span id="l79.43" class="difflineplus">+</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineplus">+#ifndef TEST_NAME</span>
<a href="#l79.45"></a><span id="l79.45" class="difflineplus">+#error &quot;Must #define TEST_NAME before including storage_test_harness_tail.h&quot;</span>
<a href="#l79.46"></a><span id="l79.46" class="difflineplus">+#endif</span>
<a href="#l79.47"></a><span id="l79.47" class="difflineplus">+</span>
<a href="#l79.48"></a><span id="l79.48" class="difflineplus">+#ifndef TEST_FILE</span>
<a href="#l79.49"></a><span id="l79.49" class="difflineplus">+#error &quot;Must #define TEST_FILE before include storage_test_harness_tail.h&quot;</span>
<a href="#l79.50"></a><span id="l79.50" class="difflineplus">+#endif</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineplus">+</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineplus">+int</span>
<a href="#l79.53"></a><span id="l79.53" class="difflineplus">+main(int aArgc,</span>
<a href="#l79.54"></a><span id="l79.54" class="difflineplus">+     char **aArgv)</span>
<a href="#l79.55"></a><span id="l79.55" class="difflineplus">+{</span>
<a href="#l79.56"></a><span id="l79.56" class="difflineplus">+  ScopedXPCOM xpcom(TEST_NAME);</span>
<a href="#l79.57"></a><span id="l79.57" class="difflineplus">+</span>
<a href="#l79.58"></a><span id="l79.58" class="difflineplus">+  for (size_t i = 0; i &lt; NS_ARRAY_LENGTH(gTests); i++)</span>
<a href="#l79.59"></a><span id="l79.59" class="difflineplus">+    gTests[i]();</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineplus">+</span>
<a href="#l79.61"></a><span id="l79.61" class="difflineplus">+  if (gPassedTests == gTotalTests)</span>
<a href="#l79.62"></a><span id="l79.62" class="difflineplus">+    passed(TEST_FILE);</span>
<a href="#l79.63"></a><span id="l79.63" class="difflineplus">+</span>
<a href="#l79.64"></a><span id="l79.64" class="difflineplus">+  (void)printf(&quot;%i of %i tests passed\n&quot;, gPassedTests, gTotalTests);</span>
<a href="#l79.65"></a><span id="l79.65" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1">new file mode 100644</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineminus">--- /dev/null</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineplus">+++ b/storage-backport/test/test_binding_params.cpp</span>
<a href="#l80.4"></a><span id="l80.4" class="difflineat">@@ -0,0 +1,246 @@</span>
<a href="#l80.5"></a><span id="l80.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l80.6"></a><span id="l80.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l80.7"></a><span id="l80.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l80.8"></a><span id="l80.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l80.9"></a><span id="l80.9" class="difflineplus">+ *</span>
<a href="#l80.10"></a><span id="l80.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l80.11"></a><span id="l80.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+ *</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineplus">+ * License.</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineplus">+ *</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineplus">+ *</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l80.23"></a><span id="l80.23" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l80.24"></a><span id="l80.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l80.26"></a><span id="l80.26" class="difflineplus">+ *</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineplus">+ *   Daniel Witte &lt;dwitte@mozilla.com&gt; (Original Author)</span>
<a href="#l80.29"></a><span id="l80.29" class="difflineplus">+ *</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l80.33"></a><span id="l80.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l80.36"></a><span id="l80.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l80.38"></a><span id="l80.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l80.39"></a><span id="l80.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineplus">+ *</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineplus">+</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineplus">+#include &quot;storage_test_harness.h&quot;</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineplus">+</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineplus">+#include &quot;mozStorageHelper.h&quot;</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineplus">+  </span>
<a href="#l80.48"></a><span id="l80.48" class="difflineplus">+/**</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineplus">+ * This file tests binding and reading out string parameters through the</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineplus">+ * mozIStorageStatement API.</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+ */</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineplus">+</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineplus">+void</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineplus">+test_ASCIIString()</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineplus">+{</span>
<a href="#l80.56"></a><span id="l80.56" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineplus">+</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineplus">+  // Create table with a single string column.</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineplus">+    &quot;CREATE TABLE test (str STRING)&quot;</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineplus">+  ));</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineplus">+</span>
<a href="#l80.63"></a><span id="l80.63" class="difflineplus">+  // Create statements to INSERT and SELECT the string.</span>
<a href="#l80.64"></a><span id="l80.64" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; insert, select;</span>
<a href="#l80.65"></a><span id="l80.65" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.66"></a><span id="l80.66" class="difflineplus">+    &quot;INSERT INTO test (str) VALUES (?1)&quot;</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineplus">+  ), getter_AddRefs(insert));</span>
<a href="#l80.68"></a><span id="l80.68" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineplus">+    &quot;SELECT str FROM test&quot;</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineplus">+  ), getter_AddRefs(select));</span>
<a href="#l80.71"></a><span id="l80.71" class="difflineplus">+</span>
<a href="#l80.72"></a><span id="l80.72" class="difflineplus">+  // Roundtrip a string through the table, and ensure it comes out as expected.</span>
<a href="#l80.73"></a><span id="l80.73" class="difflineplus">+  nsCAutoString inserted(&quot;I'm an ASCII string&quot;);</span>
<a href="#l80.74"></a><span id="l80.74" class="difflineplus">+  {</span>
<a href="#l80.75"></a><span id="l80.75" class="difflineplus">+    mozStorageStatementScoper scoper(insert);</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;BindUTF8StringParameter(0, inserted)));</span>
<a href="#l80.78"></a><span id="l80.78" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineplus">+    do_check_false(hasResult);</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineplus">+  }</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineplus">+</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineplus">+  nsCAutoString result;</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineplus">+  {</span>
<a href="#l80.84"></a><span id="l80.84" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.85"></a><span id="l80.85" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetUTF8String(0, result)));</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineplus">+  }</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineplus">+</span>
<a href="#l80.91"></a><span id="l80.91" class="difflineplus">+  do_check_true(result == inserted);</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineplus">+</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;DELETE FROM test&quot;));</span>
<a href="#l80.94"></a><span id="l80.94" class="difflineplus">+}</span>
<a href="#l80.95"></a><span id="l80.95" class="difflineplus">+</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineplus">+void</span>
<a href="#l80.97"></a><span id="l80.97" class="difflineplus">+test_CString()</span>
<a href="#l80.98"></a><span id="l80.98" class="difflineplus">+{</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineplus">+</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineplus">+  // Create table with a single string column.</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l80.103"></a><span id="l80.103" class="difflineplus">+    &quot;CREATE TABLE test (str STRING)&quot;</span>
<a href="#l80.104"></a><span id="l80.104" class="difflineplus">+  ));</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineplus">+</span>
<a href="#l80.106"></a><span id="l80.106" class="difflineplus">+  // Create statements to INSERT and SELECT the string.</span>
<a href="#l80.107"></a><span id="l80.107" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; insert, select;</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.109"></a><span id="l80.109" class="difflineplus">+    &quot;INSERT INTO test (str) VALUES (?1)&quot;</span>
<a href="#l80.110"></a><span id="l80.110" class="difflineplus">+  ), getter_AddRefs(insert));</span>
<a href="#l80.111"></a><span id="l80.111" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.112"></a><span id="l80.112" class="difflineplus">+    &quot;SELECT str FROM test&quot;</span>
<a href="#l80.113"></a><span id="l80.113" class="difflineplus">+  ), getter_AddRefs(select));</span>
<a href="#l80.114"></a><span id="l80.114" class="difflineplus">+</span>
<a href="#l80.115"></a><span id="l80.115" class="difflineplus">+  // Roundtrip a string through the table, and ensure it comes out as expected.</span>
<a href="#l80.116"></a><span id="l80.116" class="difflineplus">+  static const char sCharArray[] =</span>
<a href="#l80.117"></a><span id="l80.117" class="difflineplus">+    &quot;I'm not a \xff\x00\xac\xde\xbb ASCII string!&quot;;</span>
<a href="#l80.118"></a><span id="l80.118" class="difflineplus">+  nsCAutoString inserted(sCharArray, NS_ARRAY_LENGTH(sCharArray) - 1);</span>
<a href="#l80.119"></a><span id="l80.119" class="difflineplus">+  do_check_true(inserted.Length() == NS_ARRAY_LENGTH(sCharArray) - 1);</span>
<a href="#l80.120"></a><span id="l80.120" class="difflineplus">+  {</span>
<a href="#l80.121"></a><span id="l80.121" class="difflineplus">+    mozStorageStatementScoper scoper(insert);</span>
<a href="#l80.122"></a><span id="l80.122" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;BindUTF8StringParameter(0, inserted)));</span>
<a href="#l80.124"></a><span id="l80.124" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.125"></a><span id="l80.125" class="difflineplus">+    do_check_false(hasResult);</span>
<a href="#l80.126"></a><span id="l80.126" class="difflineplus">+  }</span>
<a href="#l80.127"></a><span id="l80.127" class="difflineplus">+</span>
<a href="#l80.128"></a><span id="l80.128" class="difflineplus">+  {</span>
<a href="#l80.129"></a><span id="l80.129" class="difflineplus">+    nsCAutoString result;</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineplus">+</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.132"></a><span id="l80.132" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.133"></a><span id="l80.133" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.134"></a><span id="l80.134" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.135"></a><span id="l80.135" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetUTF8String(0, result)));</span>
<a href="#l80.136"></a><span id="l80.136" class="difflineplus">+</span>
<a href="#l80.137"></a><span id="l80.137" class="difflineplus">+    do_check_true(result == inserted);</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineplus">+  }</span>
<a href="#l80.139"></a><span id="l80.139" class="difflineplus">+</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;DELETE FROM test&quot;));</span>
<a href="#l80.141"></a><span id="l80.141" class="difflineplus">+}</span>
<a href="#l80.142"></a><span id="l80.142" class="difflineplus">+</span>
<a href="#l80.143"></a><span id="l80.143" class="difflineplus">+void</span>
<a href="#l80.144"></a><span id="l80.144" class="difflineplus">+test_UTFStrings()</span>
<a href="#l80.145"></a><span id="l80.145" class="difflineplus">+{</span>
<a href="#l80.146"></a><span id="l80.146" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l80.147"></a><span id="l80.147" class="difflineplus">+</span>
<a href="#l80.148"></a><span id="l80.148" class="difflineplus">+  // Create table with a single string column.</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineplus">+    &quot;CREATE TABLE test (str STRING)&quot;</span>
<a href="#l80.151"></a><span id="l80.151" class="difflineplus">+  ));</span>
<a href="#l80.152"></a><span id="l80.152" class="difflineplus">+</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineplus">+  // Create statements to INSERT and SELECT the string.</span>
<a href="#l80.154"></a><span id="l80.154" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; insert, select;</span>
<a href="#l80.155"></a><span id="l80.155" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineplus">+    &quot;INSERT INTO test (str) VALUES (?1)&quot;</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineplus">+  ), getter_AddRefs(insert));</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineplus">+    &quot;SELECT str FROM test&quot;</span>
<a href="#l80.160"></a><span id="l80.160" class="difflineplus">+  ), getter_AddRefs(select));</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineplus">+</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineplus">+  // Roundtrip a UTF8 string through the table, using UTF8 input and output.</span>
<a href="#l80.163"></a><span id="l80.163" class="difflineplus">+  static const char sCharArray[] =</span>
<a href="#l80.164"></a><span id="l80.164" class="difflineplus">+    &quot;I'm a \xc3\xbb\xc3\xbc\xc3\xa2\xc3\xa4\xc3\xa7 UTF8 string!&quot;;</span>
<a href="#l80.165"></a><span id="l80.165" class="difflineplus">+  nsCAutoString insertedUTF8(sCharArray, NS_ARRAY_LENGTH(sCharArray) - 1);</span>
<a href="#l80.166"></a><span id="l80.166" class="difflineplus">+  do_check_true(insertedUTF8.Length() == NS_ARRAY_LENGTH(sCharArray) - 1);</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineplus">+  NS_ConvertUTF8toUTF16 insertedUTF16(insertedUTF8);</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineplus">+  do_check_true(insertedUTF8 == NS_ConvertUTF16toUTF8(insertedUTF16));</span>
<a href="#l80.169"></a><span id="l80.169" class="difflineplus">+  {</span>
<a href="#l80.170"></a><span id="l80.170" class="difflineplus">+    mozStorageStatementScoper scoper(insert);</span>
<a href="#l80.171"></a><span id="l80.171" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;BindUTF8StringParameter(0, insertedUTF8)));</span>
<a href="#l80.173"></a><span id="l80.173" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.174"></a><span id="l80.174" class="difflineplus">+    do_check_false(hasResult);</span>
<a href="#l80.175"></a><span id="l80.175" class="difflineplus">+  }</span>
<a href="#l80.176"></a><span id="l80.176" class="difflineplus">+</span>
<a href="#l80.177"></a><span id="l80.177" class="difflineplus">+  {</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineplus">+    nsCAutoString result;</span>
<a href="#l80.179"></a><span id="l80.179" class="difflineplus">+</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.181"></a><span id="l80.181" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.183"></a><span id="l80.183" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.184"></a><span id="l80.184" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetUTF8String(0, result)));</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineplus">+</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineplus">+    do_check_true(result == insertedUTF8);</span>
<a href="#l80.187"></a><span id="l80.187" class="difflineplus">+  }</span>
<a href="#l80.188"></a><span id="l80.188" class="difflineplus">+</span>
<a href="#l80.189"></a><span id="l80.189" class="difflineplus">+  // Use UTF8 input and UTF16 output.</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineplus">+  {</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineplus">+    nsAutoString result;</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineplus">+</span>
<a href="#l80.193"></a><span id="l80.193" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.194"></a><span id="l80.194" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetString(0, result)));</span>
<a href="#l80.198"></a><span id="l80.198" class="difflineplus">+</span>
<a href="#l80.199"></a><span id="l80.199" class="difflineplus">+    do_check_true(result == insertedUTF16);</span>
<a href="#l80.200"></a><span id="l80.200" class="difflineplus">+  }</span>
<a href="#l80.201"></a><span id="l80.201" class="difflineplus">+</span>
<a href="#l80.202"></a><span id="l80.202" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;DELETE FROM test&quot;));</span>
<a href="#l80.203"></a><span id="l80.203" class="difflineplus">+</span>
<a href="#l80.204"></a><span id="l80.204" class="difflineplus">+  // Roundtrip the same string using UTF16 input and UTF8 output.</span>
<a href="#l80.205"></a><span id="l80.205" class="difflineplus">+  {</span>
<a href="#l80.206"></a><span id="l80.206" class="difflineplus">+    mozStorageStatementScoper scoper(insert);</span>
<a href="#l80.207"></a><span id="l80.207" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.208"></a><span id="l80.208" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;BindStringParameter(0, insertedUTF16)));</span>
<a href="#l80.209"></a><span id="l80.209" class="difflineplus">+    do_check_true(NS_SUCCEEDED(insert-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.210"></a><span id="l80.210" class="difflineplus">+    do_check_false(hasResult);</span>
<a href="#l80.211"></a><span id="l80.211" class="difflineplus">+  }</span>
<a href="#l80.212"></a><span id="l80.212" class="difflineplus">+</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineplus">+  {</span>
<a href="#l80.214"></a><span id="l80.214" class="difflineplus">+    nsCAutoString result;</span>
<a href="#l80.215"></a><span id="l80.215" class="difflineplus">+</span>
<a href="#l80.216"></a><span id="l80.216" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.217"></a><span id="l80.217" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.218"></a><span id="l80.218" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.219"></a><span id="l80.219" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.220"></a><span id="l80.220" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetUTF8String(0, result)));</span>
<a href="#l80.221"></a><span id="l80.221" class="difflineplus">+</span>
<a href="#l80.222"></a><span id="l80.222" class="difflineplus">+    do_check_true(result == insertedUTF8);</span>
<a href="#l80.223"></a><span id="l80.223" class="difflineplus">+  }</span>
<a href="#l80.224"></a><span id="l80.224" class="difflineplus">+</span>
<a href="#l80.225"></a><span id="l80.225" class="difflineplus">+  // Use UTF16 input and UTF16 output.</span>
<a href="#l80.226"></a><span id="l80.226" class="difflineplus">+  {</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineplus">+    nsAutoString result;</span>
<a href="#l80.228"></a><span id="l80.228" class="difflineplus">+</span>
<a href="#l80.229"></a><span id="l80.229" class="difflineplus">+    mozStorageStatementScoper scoper(select);</span>
<a href="#l80.230"></a><span id="l80.230" class="difflineplus">+    PRBool hasResult;</span>
<a href="#l80.231"></a><span id="l80.231" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;ExecuteStep(&amp;hasResult)));</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineplus">+    do_check_true(hasResult);</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+    do_check_true(NS_SUCCEEDED(select-&gt;GetString(0, result)));</span>
<a href="#l80.234"></a><span id="l80.234" class="difflineplus">+</span>
<a href="#l80.235"></a><span id="l80.235" class="difflineplus">+    do_check_true(result == insertedUTF16);</span>
<a href="#l80.236"></a><span id="l80.236" class="difflineplus">+  }</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineplus">+</span>
<a href="#l80.238"></a><span id="l80.238" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(&quot;DELETE FROM test&quot;));</span>
<a href="#l80.239"></a><span id="l80.239" class="difflineplus">+}</span>
<a href="#l80.240"></a><span id="l80.240" class="difflineplus">+</span>
<a href="#l80.241"></a><span id="l80.241" class="difflineplus">+void (*gTests[])(void) = {</span>
<a href="#l80.242"></a><span id="l80.242" class="difflineplus">+  test_ASCIIString,</span>
<a href="#l80.243"></a><span id="l80.243" class="difflineplus">+  test_CString,</span>
<a href="#l80.244"></a><span id="l80.244" class="difflineplus">+  test_UTFStrings,</span>
<a href="#l80.245"></a><span id="l80.245" class="difflineplus">+};</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineplus">+</span>
<a href="#l80.247"></a><span id="l80.247" class="difflineplus">+const char *file = __FILE__;</span>
<a href="#l80.248"></a><span id="l80.248" class="difflineplus">+#define TEST_NAME &quot;binding string params&quot;</span>
<a href="#l80.249"></a><span id="l80.249" class="difflineplus">+#define TEST_FILE file</span>
<a href="#l80.250"></a><span id="l80.250" class="difflineplus">+#include &quot;storage_test_harness_tail.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1">new file mode 100644</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineminus">--- /dev/null</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineplus">+++ b/storage-backport/test/test_deadlock_detector.cpp</span>
<a href="#l81.4"></a><span id="l81.4" class="difflineat">@@ -0,0 +1,633 @@</span>
<a href="#l81.5"></a><span id="l81.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l81.6"></a><span id="l81.6" class="difflineplus">+ * vim: sw=4 ts=4 et :</span>
<a href="#l81.7"></a><span id="l81.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l81.8"></a><span id="l81.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l81.9"></a><span id="l81.9" class="difflineplus">+ *</span>
<a href="#l81.10"></a><span id="l81.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l81.11"></a><span id="l81.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+ *</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l81.18"></a><span id="l81.18" class="difflineplus">+ * License.</span>
<a href="#l81.19"></a><span id="l81.19" class="difflineplus">+ *</span>
<a href="#l81.20"></a><span id="l81.20" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineplus">+ *</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l81.23"></a><span id="l81.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l81.24"></a><span id="l81.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l81.25"></a><span id="l81.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l81.26"></a><span id="l81.26" class="difflineplus">+ *</span>
<a href="#l81.27"></a><span id="l81.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l81.28"></a><span id="l81.28" class="difflineplus">+ *   Chris Jones &lt;jones.chris.g@gmail.com&gt;</span>
<a href="#l81.29"></a><span id="l81.29" class="difflineplus">+ *</span>
<a href="#l81.30"></a><span id="l81.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l81.34"></a><span id="l81.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l81.37"></a><span id="l81.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineplus">+ *</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l81.43"></a><span id="l81.43" class="difflineplus">+</span>
<a href="#l81.44"></a><span id="l81.44" class="difflineplus">+/**</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+ * Note: This file is a copy of xpcom/tests/TestDeadlockDetector.cpp, but all</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineplus">+ *       mutexes were turned into SQLiteMutexes.</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineplus">+ */</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineplus">+</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+#include &quot;prenv.h&quot;</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineplus">+#include &quot;prerror.h&quot;</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+#include &quot;prio.h&quot;</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+#include &quot;prproces.h&quot;</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+</span>
<a href="#l81.54"></a><span id="l81.54" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineplus">+</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+#include &quot;mozilla/CondVar.h&quot;</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+#include &quot;mozilla/Monitor.h&quot;</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineplus">+#include &quot;SQLiteMutex.h&quot;</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineplus">+</span>
<a href="#l81.60"></a><span id="l81.60" class="difflineplus">+#include &quot;TestHarness.h&quot;</span>
<a href="#l81.61"></a><span id="l81.61" class="difflineplus">+</span>
<a href="#l81.62"></a><span id="l81.62" class="difflineplus">+using namespace mozilla;</span>
<a href="#l81.63"></a><span id="l81.63" class="difflineplus">+</span>
<a href="#l81.64"></a><span id="l81.64" class="difflineplus">+/**</span>
<a href="#l81.65"></a><span id="l81.65" class="difflineplus">+ * Helper class to allocate a sqlite3_mutex for our SQLiteMutex.  Also makes</span>
<a href="#l81.66"></a><span id="l81.66" class="difflineplus">+ * keeping the test files in sync easier.</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineplus">+ */</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineplus">+class TestMutex : public mozilla::storage::SQLiteMutex</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+{</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineplus">+public:</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineplus">+    TestMutex(const char* aName)</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineplus">+    : mozilla::storage::SQLiteMutex(aName)</span>
<a href="#l81.73"></a><span id="l81.73" class="difflineplus">+    , mInner(sqlite3_mutex_alloc(SQLITE_MUTEX_FAST))</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+    {</span>
<a href="#l81.75"></a><span id="l81.75" class="difflineplus">+        NS_ASSERTION(mInner, &quot;could not allocate a sqlite3_mutex&quot;);</span>
<a href="#l81.76"></a><span id="l81.76" class="difflineplus">+        initWithMutex(mInner);</span>
<a href="#l81.77"></a><span id="l81.77" class="difflineplus">+    }</span>
<a href="#l81.78"></a><span id="l81.78" class="difflineplus">+</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineplus">+    ~TestMutex()</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineplus">+    {</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+        sqlite3_mutex_free(mInner);</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+    }</span>
<a href="#l81.83"></a><span id="l81.83" class="difflineplus">+</span>
<a href="#l81.84"></a><span id="l81.84" class="difflineplus">+    void Lock()</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineplus">+    {</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineplus">+        lock();</span>
<a href="#l81.87"></a><span id="l81.87" class="difflineplus">+    }</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineplus">+</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineplus">+    void Unlock()</span>
<a href="#l81.90"></a><span id="l81.90" class="difflineplus">+    {</span>
<a href="#l81.91"></a><span id="l81.91" class="difflineplus">+        unlock();</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineplus">+    }</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+private:</span>
<a href="#l81.94"></a><span id="l81.94" class="difflineplus">+  sqlite3_mutex *mInner;</span>
<a href="#l81.95"></a><span id="l81.95" class="difflineplus">+};</span>
<a href="#l81.96"></a><span id="l81.96" class="difflineplus">+</span>
<a href="#l81.97"></a><span id="l81.97" class="difflineplus">+static PRThread*</span>
<a href="#l81.98"></a><span id="l81.98" class="difflineplus">+spawn(void (*run)(void*), void* arg)</span>
<a href="#l81.99"></a><span id="l81.99" class="difflineplus">+{</span>
<a href="#l81.100"></a><span id="l81.100" class="difflineplus">+    return PR_CreateThread(PR_SYSTEM_THREAD,</span>
<a href="#l81.101"></a><span id="l81.101" class="difflineplus">+                           run,</span>
<a href="#l81.102"></a><span id="l81.102" class="difflineplus">+                           arg,</span>
<a href="#l81.103"></a><span id="l81.103" class="difflineplus">+                           PR_PRIORITY_NORMAL,</span>
<a href="#l81.104"></a><span id="l81.104" class="difflineplus">+                           PR_GLOBAL_THREAD,</span>
<a href="#l81.105"></a><span id="l81.105" class="difflineplus">+                           PR_JOINABLE_THREAD,</span>
<a href="#l81.106"></a><span id="l81.106" class="difflineplus">+                           0);</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineplus">+}</span>
<a href="#l81.108"></a><span id="l81.108" class="difflineplus">+</span>
<a href="#l81.109"></a><span id="l81.109" class="difflineplus">+#define PASS()                                  \</span>
<a href="#l81.110"></a><span id="l81.110" class="difflineplus">+    do {                                        \</span>
<a href="#l81.111"></a><span id="l81.111" class="difflineplus">+        passed(__FUNCTION__);                   \</span>
<a href="#l81.112"></a><span id="l81.112" class="difflineplus">+        return NS_OK;                           \</span>
<a href="#l81.113"></a><span id="l81.113" class="difflineplus">+    } while (0);</span>
<a href="#l81.114"></a><span id="l81.114" class="difflineplus">+</span>
<a href="#l81.115"></a><span id="l81.115" class="difflineplus">+</span>
<a href="#l81.116"></a><span id="l81.116" class="difflineplus">+#define FAIL(why)                               \</span>
<a href="#l81.117"></a><span id="l81.117" class="difflineplus">+    do {                                        \</span>
<a href="#l81.118"></a><span id="l81.118" class="difflineplus">+        fail(why);                              \</span>
<a href="#l81.119"></a><span id="l81.119" class="difflineplus">+        return NS_ERROR_FAILURE;                \</span>
<a href="#l81.120"></a><span id="l81.120" class="difflineplus">+    } while (0);</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineplus">+</span>
<a href="#l81.122"></a><span id="l81.122" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l81.123"></a><span id="l81.123" class="difflineplus">+</span>
<a href="#l81.124"></a><span id="l81.124" class="difflineplus">+static const char* sPathToThisBinary;</span>
<a href="#l81.125"></a><span id="l81.125" class="difflineplus">+static const char* sAssertBehaviorEnv = &quot;XPCOM_DEBUG_BREAK=abort&quot;;</span>
<a href="#l81.126"></a><span id="l81.126" class="difflineplus">+</span>
<a href="#l81.127"></a><span id="l81.127" class="difflineplus">+class Subprocess</span>
<a href="#l81.128"></a><span id="l81.128" class="difflineplus">+{</span>
<a href="#l81.129"></a><span id="l81.129" class="difflineplus">+public:</span>
<a href="#l81.130"></a><span id="l81.130" class="difflineplus">+    // not available until process finishes</span>
<a href="#l81.131"></a><span id="l81.131" class="difflineplus">+    PRInt32 mExitCode;</span>
<a href="#l81.132"></a><span id="l81.132" class="difflineplus">+    nsCString mStdout;</span>
<a href="#l81.133"></a><span id="l81.133" class="difflineplus">+    nsCString mStderr;</span>
<a href="#l81.134"></a><span id="l81.134" class="difflineplus">+</span>
<a href="#l81.135"></a><span id="l81.135" class="difflineplus">+    Subprocess(const char* aTestName) {</span>
<a href="#l81.136"></a><span id="l81.136" class="difflineplus">+        // set up stdio redirection</span>
<a href="#l81.137"></a><span id="l81.137" class="difflineplus">+        PRFileDesc* readStdin;  PRFileDesc* writeStdin;</span>
<a href="#l81.138"></a><span id="l81.138" class="difflineplus">+        PRFileDesc* readStdout; PRFileDesc* writeStdout;</span>
<a href="#l81.139"></a><span id="l81.139" class="difflineplus">+        PRFileDesc* readStderr; PRFileDesc* writeStderr;</span>
<a href="#l81.140"></a><span id="l81.140" class="difflineplus">+        PRProcessAttr* pattr = PR_NewProcessAttr();</span>
<a href="#l81.141"></a><span id="l81.141" class="difflineplus">+</span>
<a href="#l81.142"></a><span id="l81.142" class="difflineplus">+        NS_ASSERTION(pattr, &quot;couldn't allocate process attrs&quot;);</span>
<a href="#l81.143"></a><span id="l81.143" class="difflineplus">+</span>
<a href="#l81.144"></a><span id="l81.144" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_CreatePipe(&amp;readStdin, &amp;writeStdin),</span>
<a href="#l81.145"></a><span id="l81.145" class="difflineplus">+                     &quot;couldn't create child stdin pipe&quot;);</span>
<a href="#l81.146"></a><span id="l81.146" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_SetFDInheritable(readStdin, PR_TRUE),</span>
<a href="#l81.147"></a><span id="l81.147" class="difflineplus">+                     &quot;couldn't set child stdin inheritable&quot;);</span>
<a href="#l81.148"></a><span id="l81.148" class="difflineplus">+        PR_ProcessAttrSetStdioRedirect(pattr, PR_StandardInput, readStdin);</span>
<a href="#l81.149"></a><span id="l81.149" class="difflineplus">+</span>
<a href="#l81.150"></a><span id="l81.150" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_CreatePipe(&amp;readStdout, &amp;writeStdout),</span>
<a href="#l81.151"></a><span id="l81.151" class="difflineplus">+                     &quot;couldn't create child stdout pipe&quot;);</span>
<a href="#l81.152"></a><span id="l81.152" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_SetFDInheritable(writeStdout, PR_TRUE),</span>
<a href="#l81.153"></a><span id="l81.153" class="difflineplus">+                     &quot;couldn't set child stdout inheritable&quot;);</span>
<a href="#l81.154"></a><span id="l81.154" class="difflineplus">+        PR_ProcessAttrSetStdioRedirect(pattr, PR_StandardOutput, writeStdout);</span>
<a href="#l81.155"></a><span id="l81.155" class="difflineplus">+</span>
<a href="#l81.156"></a><span id="l81.156" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_CreatePipe(&amp;readStderr, &amp;writeStderr),</span>
<a href="#l81.157"></a><span id="l81.157" class="difflineplus">+                     &quot;couldn't create child stderr pipe&quot;);</span>
<a href="#l81.158"></a><span id="l81.158" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_SetFDInheritable(writeStderr, PR_TRUE),</span>
<a href="#l81.159"></a><span id="l81.159" class="difflineplus">+                     &quot;couldn't set child stderr inheritable&quot;);</span>
<a href="#l81.160"></a><span id="l81.160" class="difflineplus">+        PR_ProcessAttrSetStdioRedirect(pattr, PR_StandardError, writeStderr);</span>
<a href="#l81.161"></a><span id="l81.161" class="difflineplus">+</span>
<a href="#l81.162"></a><span id="l81.162" class="difflineplus">+        // set up argv with test name to run</span>
<a href="#l81.163"></a><span id="l81.163" class="difflineplus">+        char* const newArgv[3] = {</span>
<a href="#l81.164"></a><span id="l81.164" class="difflineplus">+            strdup(sPathToThisBinary),</span>
<a href="#l81.165"></a><span id="l81.165" class="difflineplus">+            strdup(aTestName),</span>
<a href="#l81.166"></a><span id="l81.166" class="difflineplus">+            0</span>
<a href="#l81.167"></a><span id="l81.167" class="difflineplus">+        };</span>
<a href="#l81.168"></a><span id="l81.168" class="difflineplus">+</span>
<a href="#l81.169"></a><span id="l81.169" class="difflineplus">+        // make sure the child will abort if an assertion fails</span>
<a href="#l81.170"></a><span id="l81.170" class="difflineplus">+        NS_ASSERTION(PR_SUCCESS == PR_SetEnv(sAssertBehaviorEnv),</span>
<a href="#l81.171"></a><span id="l81.171" class="difflineplus">+                     &quot;couldn't set XPCOM_DEBUG_BREAK env var&quot;);</span>
<a href="#l81.172"></a><span id="l81.172" class="difflineplus">+</span>
<a href="#l81.173"></a><span id="l81.173" class="difflineplus">+        PRProcess* proc;</span>
<a href="#l81.174"></a><span id="l81.174" class="difflineplus">+        NS_ASSERTION(proc = PR_CreateProcess(sPathToThisBinary,</span>
<a href="#l81.175"></a><span id="l81.175" class="difflineplus">+                                             newArgv,</span>
<a href="#l81.176"></a><span id="l81.176" class="difflineplus">+                                             0, // inherit environment</span>
<a href="#l81.177"></a><span id="l81.177" class="difflineplus">+                                             pattr),</span>
<a href="#l81.178"></a><span id="l81.178" class="difflineplus">+                     &quot;couldn't create process&quot;);</span>
<a href="#l81.179"></a><span id="l81.179" class="difflineplus">+        PR_Close(readStdin);</span>
<a href="#l81.180"></a><span id="l81.180" class="difflineplus">+        PR_Close(writeStdout);</span>
<a href="#l81.181"></a><span id="l81.181" class="difflineplus">+        PR_Close(writeStderr);</span>
<a href="#l81.182"></a><span id="l81.182" class="difflineplus">+</span>
<a href="#l81.183"></a><span id="l81.183" class="difflineplus">+        mProc = proc;</span>
<a href="#l81.184"></a><span id="l81.184" class="difflineplus">+        mStdinfd = writeStdin;</span>
<a href="#l81.185"></a><span id="l81.185" class="difflineplus">+        mStdoutfd = readStdout;</span>
<a href="#l81.186"></a><span id="l81.186" class="difflineplus">+        mStderrfd = readStderr;</span>
<a href="#l81.187"></a><span id="l81.187" class="difflineplus">+</span>
<a href="#l81.188"></a><span id="l81.188" class="difflineplus">+        free(newArgv[0]);</span>
<a href="#l81.189"></a><span id="l81.189" class="difflineplus">+        free(newArgv[1]);</span>
<a href="#l81.190"></a><span id="l81.190" class="difflineplus">+        PR_DestroyProcessAttr(pattr);</span>
<a href="#l81.191"></a><span id="l81.191" class="difflineplus">+    }</span>
<a href="#l81.192"></a><span id="l81.192" class="difflineplus">+</span>
<a href="#l81.193"></a><span id="l81.193" class="difflineplus">+    void RunToCompletion(PRUint32 aWaitMs)</span>
<a href="#l81.194"></a><span id="l81.194" class="difflineplus">+    {</span>
<a href="#l81.195"></a><span id="l81.195" class="difflineplus">+        PR_Close(mStdinfd);</span>
<a href="#l81.196"></a><span id="l81.196" class="difflineplus">+</span>
<a href="#l81.197"></a><span id="l81.197" class="difflineplus">+        PRPollDesc pollfds[2];</span>
<a href="#l81.198"></a><span id="l81.198" class="difflineplus">+        PRInt32 nfds;</span>
<a href="#l81.199"></a><span id="l81.199" class="difflineplus">+        PRBool stdoutOpen = PR_TRUE, stderrOpen = PR_TRUE;</span>
<a href="#l81.200"></a><span id="l81.200" class="difflineplus">+        char buf[4096];</span>
<a href="#l81.201"></a><span id="l81.201" class="difflineplus">+        PRInt32 len;</span>
<a href="#l81.202"></a><span id="l81.202" class="difflineplus">+</span>
<a href="#l81.203"></a><span id="l81.203" class="difflineplus">+        PRIntervalTime now = PR_IntervalNow();</span>
<a href="#l81.204"></a><span id="l81.204" class="difflineplus">+        PRIntervalTime deadline = now + PR_MillisecondsToInterval(aWaitMs);</span>
<a href="#l81.205"></a><span id="l81.205" class="difflineplus">+</span>
<a href="#l81.206"></a><span id="l81.206" class="difflineplus">+        while ((stdoutOpen || stderrOpen) &amp;&amp; now &lt; deadline) {</span>
<a href="#l81.207"></a><span id="l81.207" class="difflineplus">+            nfds = 0;</span>
<a href="#l81.208"></a><span id="l81.208" class="difflineplus">+            if (stdoutOpen) {</span>
<a href="#l81.209"></a><span id="l81.209" class="difflineplus">+                pollfds[nfds].fd = mStdoutfd;</span>
<a href="#l81.210"></a><span id="l81.210" class="difflineplus">+                pollfds[nfds].in_flags = PR_POLL_READ;</span>
<a href="#l81.211"></a><span id="l81.211" class="difflineplus">+                pollfds[nfds].out_flags = 0;</span>
<a href="#l81.212"></a><span id="l81.212" class="difflineplus">+                ++nfds;</span>
<a href="#l81.213"></a><span id="l81.213" class="difflineplus">+            }</span>
<a href="#l81.214"></a><span id="l81.214" class="difflineplus">+            if (stderrOpen) {</span>
<a href="#l81.215"></a><span id="l81.215" class="difflineplus">+                pollfds[nfds].fd = mStderrfd;</span>
<a href="#l81.216"></a><span id="l81.216" class="difflineplus">+                pollfds[nfds].in_flags = PR_POLL_READ;</span>
<a href="#l81.217"></a><span id="l81.217" class="difflineplus">+                pollfds[nfds].out_flags = 0;</span>
<a href="#l81.218"></a><span id="l81.218" class="difflineplus">+                ++nfds;</span>
<a href="#l81.219"></a><span id="l81.219" class="difflineplus">+            }</span>
<a href="#l81.220"></a><span id="l81.220" class="difflineplus">+</span>
<a href="#l81.221"></a><span id="l81.221" class="difflineplus">+            PRInt32 rv = PR_Poll(pollfds, nfds, deadline - now);</span>
<a href="#l81.222"></a><span id="l81.222" class="difflineplus">+            NS_ASSERTION(0 &lt;= rv, PR_ErrorToName(PR_GetError()));</span>
<a href="#l81.223"></a><span id="l81.223" class="difflineplus">+</span>
<a href="#l81.224"></a><span id="l81.224" class="difflineplus">+            if (0 == rv) {      // timeout</span>
<a href="#l81.225"></a><span id="l81.225" class="difflineplus">+                Finish(PR_FALSE); // abnormal</span>
<a href="#l81.226"></a><span id="l81.226" class="difflineplus">+                return;</span>
<a href="#l81.227"></a><span id="l81.227" class="difflineplus">+            }</span>
<a href="#l81.228"></a><span id="l81.228" class="difflineplus">+</span>
<a href="#l81.229"></a><span id="l81.229" class="difflineplus">+            for (PRInt32 i = 0; i &lt; nfds; ++i) {</span>
<a href="#l81.230"></a><span id="l81.230" class="difflineplus">+                if (!pollfds[i].out_flags)</span>
<a href="#l81.231"></a><span id="l81.231" class="difflineplus">+                    continue;</span>
<a href="#l81.232"></a><span id="l81.232" class="difflineplus">+</span>
<a href="#l81.233"></a><span id="l81.233" class="difflineplus">+                PRBool isStdout = mStdoutfd == pollfds[i].fd;</span>
<a href="#l81.234"></a><span id="l81.234" class="difflineplus">+                </span>
<a href="#l81.235"></a><span id="l81.235" class="difflineplus">+                if (PR_POLL_READ &amp; pollfds[i].out_flags) {</span>
<a href="#l81.236"></a><span id="l81.236" class="difflineplus">+                    len = PR_Read(pollfds[i].fd, buf, sizeof(buf) - 1);</span>
<a href="#l81.237"></a><span id="l81.237" class="difflineplus">+                    NS_ASSERTION(0 &lt;= len, PR_ErrorToName(PR_GetError()));</span>
<a href="#l81.238"></a><span id="l81.238" class="difflineplus">+                }</span>
<a href="#l81.239"></a><span id="l81.239" class="difflineplus">+                else if (PR_POLL_HUP &amp; pollfds[i].out_flags) {</span>
<a href="#l81.240"></a><span id="l81.240" class="difflineplus">+                    len = 0;</span>
<a href="#l81.241"></a><span id="l81.241" class="difflineplus">+                }</span>
<a href="#l81.242"></a><span id="l81.242" class="difflineplus">+                else {</span>
<a href="#l81.243"></a><span id="l81.243" class="difflineplus">+                    NS_ERROR(PR_ErrorToName(PR_GetError()));</span>
<a href="#l81.244"></a><span id="l81.244" class="difflineplus">+                }</span>
<a href="#l81.245"></a><span id="l81.245" class="difflineplus">+</span>
<a href="#l81.246"></a><span id="l81.246" class="difflineplus">+                if (0 &lt; len) {</span>
<a href="#l81.247"></a><span id="l81.247" class="difflineplus">+                    buf[len] = '\0';</span>
<a href="#l81.248"></a><span id="l81.248" class="difflineplus">+                    if (isStdout)</span>
<a href="#l81.249"></a><span id="l81.249" class="difflineplus">+                        mStdout += buf;</span>
<a href="#l81.250"></a><span id="l81.250" class="difflineplus">+                    else</span>
<a href="#l81.251"></a><span id="l81.251" class="difflineplus">+                        mStderr += buf;</span>
<a href="#l81.252"></a><span id="l81.252" class="difflineplus">+                }</span>
<a href="#l81.253"></a><span id="l81.253" class="difflineplus">+                else {</span>
<a href="#l81.254"></a><span id="l81.254" class="difflineplus">+                    if (isStdout) {</span>
<a href="#l81.255"></a><span id="l81.255" class="difflineplus">+                        stdoutOpen = PR_FALSE;</span>
<a href="#l81.256"></a><span id="l81.256" class="difflineplus">+                        PR_Close(mStdoutfd);</span>
<a href="#l81.257"></a><span id="l81.257" class="difflineplus">+                    }</span>
<a href="#l81.258"></a><span id="l81.258" class="difflineplus">+                    else {</span>
<a href="#l81.259"></a><span id="l81.259" class="difflineplus">+                        stderrOpen = PR_FALSE;</span>
<a href="#l81.260"></a><span id="l81.260" class="difflineplus">+                        PR_Close(mStderrfd);</span>
<a href="#l81.261"></a><span id="l81.261" class="difflineplus">+                    }</span>
<a href="#l81.262"></a><span id="l81.262" class="difflineplus">+                }</span>
<a href="#l81.263"></a><span id="l81.263" class="difflineplus">+            }</span>
<a href="#l81.264"></a><span id="l81.264" class="difflineplus">+</span>
<a href="#l81.265"></a><span id="l81.265" class="difflineplus">+            now = PR_IntervalNow();</span>
<a href="#l81.266"></a><span id="l81.266" class="difflineplus">+        }</span>
<a href="#l81.267"></a><span id="l81.267" class="difflineplus">+</span>
<a href="#l81.268"></a><span id="l81.268" class="difflineplus">+        Finish(!stdoutOpen &amp;&amp; !stderrOpen &amp;&amp; now &lt;= deadline);</span>
<a href="#l81.269"></a><span id="l81.269" class="difflineplus">+    }</span>
<a href="#l81.270"></a><span id="l81.270" class="difflineplus">+</span>
<a href="#l81.271"></a><span id="l81.271" class="difflineplus">+private:</span>
<a href="#l81.272"></a><span id="l81.272" class="difflineplus">+    void Finish(PRBool normalExit) {</span>
<a href="#l81.273"></a><span id="l81.273" class="difflineplus">+        if (!normalExit) {</span>
<a href="#l81.274"></a><span id="l81.274" class="difflineplus">+            PR_KillProcess(mProc);</span>
<a href="#l81.275"></a><span id="l81.275" class="difflineplus">+            PR_Close(mStdoutfd);</span>
<a href="#l81.276"></a><span id="l81.276" class="difflineplus">+            PR_Close(mStderrfd);</span>
<a href="#l81.277"></a><span id="l81.277" class="difflineplus">+            mExitCode = -1;</span>
<a href="#l81.278"></a><span id="l81.278" class="difflineplus">+            PRInt32 dummy;</span>
<a href="#l81.279"></a><span id="l81.279" class="difflineplus">+            PR_WaitProcess(mProc, &amp;dummy);</span>
<a href="#l81.280"></a><span id="l81.280" class="difflineplus">+        }</span>
<a href="#l81.281"></a><span id="l81.281" class="difflineplus">+        else {</span>
<a href="#l81.282"></a><span id="l81.282" class="difflineplus">+            PR_WaitProcess(mProc, &amp;mExitCode); // this had better not block ...</span>
<a href="#l81.283"></a><span id="l81.283" class="difflineplus">+        }</span>
<a href="#l81.284"></a><span id="l81.284" class="difflineplus">+    }</span>
<a href="#l81.285"></a><span id="l81.285" class="difflineplus">+</span>
<a href="#l81.286"></a><span id="l81.286" class="difflineplus">+    PRProcess* mProc;</span>
<a href="#l81.287"></a><span id="l81.287" class="difflineplus">+    PRFileDesc* mStdinfd;         // writeable</span>
<a href="#l81.288"></a><span id="l81.288" class="difflineplus">+    PRFileDesc* mStdoutfd;        // readable</span>
<a href="#l81.289"></a><span id="l81.289" class="difflineplus">+    PRFileDesc* mStderrfd;        // readable</span>
<a href="#l81.290"></a><span id="l81.290" class="difflineplus">+};</span>
<a href="#l81.291"></a><span id="l81.291" class="difflineplus">+</span>
<a href="#l81.292"></a><span id="l81.292" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l81.293"></a><span id="l81.293" class="difflineplus">+// Harness for checking detector errors</span>
<a href="#l81.294"></a><span id="l81.294" class="difflineplus">+bool</span>
<a href="#l81.295"></a><span id="l81.295" class="difflineplus">+CheckForDeadlock(const char* test, const char* const* findTokens)</span>
<a href="#l81.296"></a><span id="l81.296" class="difflineplus">+{</span>
<a href="#l81.297"></a><span id="l81.297" class="difflineplus">+    Subprocess proc(test);</span>
<a href="#l81.298"></a><span id="l81.298" class="difflineplus">+    proc.RunToCompletion(1000);</span>
<a href="#l81.299"></a><span id="l81.299" class="difflineplus">+</span>
<a href="#l81.300"></a><span id="l81.300" class="difflineplus">+    if (0 == proc.mExitCode)</span>
<a href="#l81.301"></a><span id="l81.301" class="difflineplus">+        return false;</span>
<a href="#l81.302"></a><span id="l81.302" class="difflineplus">+</span>
<a href="#l81.303"></a><span id="l81.303" class="difflineplus">+    PRInt32 idx = 0;</span>
<a href="#l81.304"></a><span id="l81.304" class="difflineplus">+    for (const char* const* tp = findTokens; *tp; ++tp) {</span>
<a href="#l81.305"></a><span id="l81.305" class="difflineplus">+        const char* const token = *tp;</span>
<a href="#l81.306"></a><span id="l81.306" class="difflineplus">+#ifdef MOZILLA_INTERNAL_API</span>
<a href="#l81.307"></a><span id="l81.307" class="difflineplus">+        idx = proc.mStderr.Find(token, PR_FALSE, idx);</span>
<a href="#l81.308"></a><span id="l81.308" class="difflineplus">+#else</span>
<a href="#l81.309"></a><span id="l81.309" class="difflineplus">+        nsCString tokenCString(token);</span>
<a href="#l81.310"></a><span id="l81.310" class="difflineplus">+        idx = proc.mStderr.Find(tokenCString, idx);</span>
<a href="#l81.311"></a><span id="l81.311" class="difflineplus">+#endif</span>
<a href="#l81.312"></a><span id="l81.312" class="difflineplus">+        if (-1 == idx) {</span>
<a href="#l81.313"></a><span id="l81.313" class="difflineplus">+            printf(&quot;(missed token '%s' in output)\n&quot;, token);</span>
<a href="#l81.314"></a><span id="l81.314" class="difflineplus">+            puts(&quot;----------------------------------\n&quot;);</span>
<a href="#l81.315"></a><span id="l81.315" class="difflineplus">+            puts(proc.mStderr.get());</span>
<a href="#l81.316"></a><span id="l81.316" class="difflineplus">+            puts(&quot;----------------------------------\n&quot;);</span>
<a href="#l81.317"></a><span id="l81.317" class="difflineplus">+            return false;</span>
<a href="#l81.318"></a><span id="l81.318" class="difflineplus">+        }</span>
<a href="#l81.319"></a><span id="l81.319" class="difflineplus">+        idx += strlen(token);</span>
<a href="#l81.320"></a><span id="l81.320" class="difflineplus">+    }</span>
<a href="#l81.321"></a><span id="l81.321" class="difflineplus">+</span>
<a href="#l81.322"></a><span id="l81.322" class="difflineplus">+    return true;</span>
<a href="#l81.323"></a><span id="l81.323" class="difflineplus">+}</span>
<a href="#l81.324"></a><span id="l81.324" class="difflineplus">+</span>
<a href="#l81.325"></a><span id="l81.325" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l81.326"></a><span id="l81.326" class="difflineplus">+// Single-threaded sanity tests</span>
<a href="#l81.327"></a><span id="l81.327" class="difflineplus">+</span>
<a href="#l81.328"></a><span id="l81.328" class="difflineplus">+// Stupidest possible deadlock.</span>
<a href="#l81.329"></a><span id="l81.329" class="difflineplus">+nsresult</span>
<a href="#l81.330"></a><span id="l81.330" class="difflineplus">+Sanity_Child()</span>
<a href="#l81.331"></a><span id="l81.331" class="difflineplus">+{</span>
<a href="#l81.332"></a><span id="l81.332" class="difflineplus">+    TestMutex m1(&quot;dd.sanity.m1&quot;);</span>
<a href="#l81.333"></a><span id="l81.333" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.334"></a><span id="l81.334" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.335"></a><span id="l81.335" class="difflineplus">+    return 0;                  // not reached</span>
<a href="#l81.336"></a><span id="l81.336" class="difflineplus">+}</span>
<a href="#l81.337"></a><span id="l81.337" class="difflineplus">+</span>
<a href="#l81.338"></a><span id="l81.338" class="difflineplus">+nsresult</span>
<a href="#l81.339"></a><span id="l81.339" class="difflineplus">+Sanity()</span>
<a href="#l81.340"></a><span id="l81.340" class="difflineplus">+{</span>
<a href="#l81.341"></a><span id="l81.341" class="difflineplus">+    const char* const tokens[] = {</span>
<a href="#l81.342"></a><span id="l81.342" class="difflineplus">+        &quot;###!!! ERROR: Potential deadlock detected&quot;,</span>
<a href="#l81.343"></a><span id="l81.343" class="difflineplus">+        &quot;=== Cyclical dependency starts at\n--- Mutex : dd.sanity.m1&quot;,</span>
<a href="#l81.344"></a><span id="l81.344" class="difflineplus">+        &quot;=== Cycle completed at\n--- Mutex : dd.sanity.m1&quot;,</span>
<a href="#l81.345"></a><span id="l81.345" class="difflineplus">+        &quot;###!!! Deadlock may happen NOW!&quot;, // better catch these easy cases...</span>
<a href="#l81.346"></a><span id="l81.346" class="difflineplus">+        &quot;###!!! ASSERTION: Potential deadlock detected&quot;,</span>
<a href="#l81.347"></a><span id="l81.347" class="difflineplus">+        0</span>
<a href="#l81.348"></a><span id="l81.348" class="difflineplus">+    };</span>
<a href="#l81.349"></a><span id="l81.349" class="difflineplus">+    if (CheckForDeadlock(&quot;Sanity&quot;, tokens)) {</span>
<a href="#l81.350"></a><span id="l81.350" class="difflineplus">+        PASS();</span>
<a href="#l81.351"></a><span id="l81.351" class="difflineplus">+    } else {</span>
<a href="#l81.352"></a><span id="l81.352" class="difflineplus">+        FAIL(&quot;deadlock not detected&quot;);</span>
<a href="#l81.353"></a><span id="l81.353" class="difflineplus">+    }</span>
<a href="#l81.354"></a><span id="l81.354" class="difflineplus">+}</span>
<a href="#l81.355"></a><span id="l81.355" class="difflineplus">+</span>
<a href="#l81.356"></a><span id="l81.356" class="difflineplus">+// Slightly less stupid deadlock.</span>
<a href="#l81.357"></a><span id="l81.357" class="difflineplus">+nsresult</span>
<a href="#l81.358"></a><span id="l81.358" class="difflineplus">+Sanity2_Child()</span>
<a href="#l81.359"></a><span id="l81.359" class="difflineplus">+{</span>
<a href="#l81.360"></a><span id="l81.360" class="difflineplus">+    TestMutex m1(&quot;dd.sanity2.m1&quot;);</span>
<a href="#l81.361"></a><span id="l81.361" class="difflineplus">+    TestMutex m2(&quot;dd.sanity2.m2&quot;);</span>
<a href="#l81.362"></a><span id="l81.362" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.363"></a><span id="l81.363" class="difflineplus">+    m2.Lock();</span>
<a href="#l81.364"></a><span id="l81.364" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.365"></a><span id="l81.365" class="difflineplus">+    return 0;                  // not reached</span>
<a href="#l81.366"></a><span id="l81.366" class="difflineplus">+}</span>
<a href="#l81.367"></a><span id="l81.367" class="difflineplus">+</span>
<a href="#l81.368"></a><span id="l81.368" class="difflineplus">+nsresult</span>
<a href="#l81.369"></a><span id="l81.369" class="difflineplus">+Sanity2()</span>
<a href="#l81.370"></a><span id="l81.370" class="difflineplus">+{</span>
<a href="#l81.371"></a><span id="l81.371" class="difflineplus">+    const char* const tokens[] = {</span>
<a href="#l81.372"></a><span id="l81.372" class="difflineplus">+        &quot;###!!! ERROR: Potential deadlock detected&quot;,</span>
<a href="#l81.373"></a><span id="l81.373" class="difflineplus">+        &quot;=== Cyclical dependency starts at\n--- Mutex : dd.sanity2.m1&quot;,</span>
<a href="#l81.374"></a><span id="l81.374" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.sanity2.m2&quot;,</span>
<a href="#l81.375"></a><span id="l81.375" class="difflineplus">+        &quot;=== Cycle completed at\n--- Mutex : dd.sanity2.m1&quot;,</span>
<a href="#l81.376"></a><span id="l81.376" class="difflineplus">+        &quot;###!!! Deadlock may happen NOW!&quot;, // better catch these easy cases...</span>
<a href="#l81.377"></a><span id="l81.377" class="difflineplus">+        &quot;###!!! ASSERTION: Potential deadlock detected&quot;,</span>
<a href="#l81.378"></a><span id="l81.378" class="difflineplus">+        0</span>
<a href="#l81.379"></a><span id="l81.379" class="difflineplus">+    };</span>
<a href="#l81.380"></a><span id="l81.380" class="difflineplus">+    if (CheckForDeadlock(&quot;Sanity2&quot;, tokens)) {</span>
<a href="#l81.381"></a><span id="l81.381" class="difflineplus">+        PASS();</span>
<a href="#l81.382"></a><span id="l81.382" class="difflineplus">+    } else {</span>
<a href="#l81.383"></a><span id="l81.383" class="difflineplus">+        FAIL(&quot;deadlock not detected&quot;);</span>
<a href="#l81.384"></a><span id="l81.384" class="difflineplus">+    }</span>
<a href="#l81.385"></a><span id="l81.385" class="difflineplus">+}</span>
<a href="#l81.386"></a><span id="l81.386" class="difflineplus">+</span>
<a href="#l81.387"></a><span id="l81.387" class="difflineplus">+</span>
<a href="#l81.388"></a><span id="l81.388" class="difflineplus">+nsresult</span>
<a href="#l81.389"></a><span id="l81.389" class="difflineplus">+Sanity3_Child()</span>
<a href="#l81.390"></a><span id="l81.390" class="difflineplus">+{</span>
<a href="#l81.391"></a><span id="l81.391" class="difflineplus">+    TestMutex m1(&quot;dd.sanity3.m1&quot;);</span>
<a href="#l81.392"></a><span id="l81.392" class="difflineplus">+    TestMutex m2(&quot;dd.sanity3.m2&quot;);</span>
<a href="#l81.393"></a><span id="l81.393" class="difflineplus">+    TestMutex m3(&quot;dd.sanity3.m3&quot;);</span>
<a href="#l81.394"></a><span id="l81.394" class="difflineplus">+    TestMutex m4(&quot;dd.sanity3.m4&quot;);</span>
<a href="#l81.395"></a><span id="l81.395" class="difflineplus">+</span>
<a href="#l81.396"></a><span id="l81.396" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.397"></a><span id="l81.397" class="difflineplus">+    m2.Lock();</span>
<a href="#l81.398"></a><span id="l81.398" class="difflineplus">+    m3.Lock();</span>
<a href="#l81.399"></a><span id="l81.399" class="difflineplus">+    m4.Lock();</span>
<a href="#l81.400"></a><span id="l81.400" class="difflineplus">+    m4.Unlock();</span>
<a href="#l81.401"></a><span id="l81.401" class="difflineplus">+    m3.Unlock();</span>
<a href="#l81.402"></a><span id="l81.402" class="difflineplus">+    m2.Unlock();</span>
<a href="#l81.403"></a><span id="l81.403" class="difflineplus">+    m1.Unlock();</span>
<a href="#l81.404"></a><span id="l81.404" class="difflineplus">+</span>
<a href="#l81.405"></a><span id="l81.405" class="difflineplus">+    m4.Lock();</span>
<a href="#l81.406"></a><span id="l81.406" class="difflineplus">+    m1.Lock();</span>
<a href="#l81.407"></a><span id="l81.407" class="difflineplus">+    return 0;</span>
<a href="#l81.408"></a><span id="l81.408" class="difflineplus">+}</span>
<a href="#l81.409"></a><span id="l81.409" class="difflineplus">+</span>
<a href="#l81.410"></a><span id="l81.410" class="difflineplus">+nsresult</span>
<a href="#l81.411"></a><span id="l81.411" class="difflineplus">+Sanity3()</span>
<a href="#l81.412"></a><span id="l81.412" class="difflineplus">+{</span>
<a href="#l81.413"></a><span id="l81.413" class="difflineplus">+    const char* const tokens[] = {</span>
<a href="#l81.414"></a><span id="l81.414" class="difflineplus">+        &quot;###!!! ERROR: Potential deadlock detected&quot;,</span>
<a href="#l81.415"></a><span id="l81.415" class="difflineplus">+        &quot;=== Cyclical dependency starts at\n--- Mutex : dd.sanity3.m1&quot;,</span>
<a href="#l81.416"></a><span id="l81.416" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.sanity3.m2&quot;,</span>
<a href="#l81.417"></a><span id="l81.417" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.sanity3.m3&quot;,</span>
<a href="#l81.418"></a><span id="l81.418" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.sanity3.m4&quot;,</span>
<a href="#l81.419"></a><span id="l81.419" class="difflineplus">+        &quot;=== Cycle completed at\n--- Mutex : dd.sanity3.m1&quot;,</span>
<a href="#l81.420"></a><span id="l81.420" class="difflineplus">+        &quot;###!!! ASSERTION: Potential deadlock detected&quot;,</span>
<a href="#l81.421"></a><span id="l81.421" class="difflineplus">+        0</span>
<a href="#l81.422"></a><span id="l81.422" class="difflineplus">+    };</span>
<a href="#l81.423"></a><span id="l81.423" class="difflineplus">+    if (CheckForDeadlock(&quot;Sanity3&quot;, tokens)) {</span>
<a href="#l81.424"></a><span id="l81.424" class="difflineplus">+        PASS();</span>
<a href="#l81.425"></a><span id="l81.425" class="difflineplus">+    } else {</span>
<a href="#l81.426"></a><span id="l81.426" class="difflineplus">+        FAIL(&quot;deadlock not detected&quot;);</span>
<a href="#l81.427"></a><span id="l81.427" class="difflineplus">+    }</span>
<a href="#l81.428"></a><span id="l81.428" class="difflineplus">+}</span>
<a href="#l81.429"></a><span id="l81.429" class="difflineplus">+</span>
<a href="#l81.430"></a><span id="l81.430" class="difflineplus">+</span>
<a href="#l81.431"></a><span id="l81.431" class="difflineplus">+nsresult</span>
<a href="#l81.432"></a><span id="l81.432" class="difflineplus">+Sanity4_Child()</span>
<a href="#l81.433"></a><span id="l81.433" class="difflineplus">+{</span>
<a href="#l81.434"></a><span id="l81.434" class="difflineplus">+    mozilla::Monitor m1(&quot;dd.sanity4.m1&quot;);</span>
<a href="#l81.435"></a><span id="l81.435" class="difflineplus">+    TestMutex m2(&quot;dd.sanity4.m2&quot;);</span>
<a href="#l81.436"></a><span id="l81.436" class="difflineplus">+    m1.Enter();</span>
<a href="#l81.437"></a><span id="l81.437" class="difflineplus">+    m2.Lock();</span>
<a href="#l81.438"></a><span id="l81.438" class="difflineplus">+    m1.Enter();</span>
<a href="#l81.439"></a><span id="l81.439" class="difflineplus">+    return 0;</span>
<a href="#l81.440"></a><span id="l81.440" class="difflineplus">+}</span>
<a href="#l81.441"></a><span id="l81.441" class="difflineplus">+</span>
<a href="#l81.442"></a><span id="l81.442" class="difflineplus">+nsresult</span>
<a href="#l81.443"></a><span id="l81.443" class="difflineplus">+Sanity4()</span>
<a href="#l81.444"></a><span id="l81.444" class="difflineplus">+{</span>
<a href="#l81.445"></a><span id="l81.445" class="difflineplus">+    const char* const tokens[] = {</span>
<a href="#l81.446"></a><span id="l81.446" class="difflineplus">+        &quot;Re-entering Monitor after acquiring other resources&quot;,</span>
<a href="#l81.447"></a><span id="l81.447" class="difflineplus">+        &quot;###!!! ERROR: Potential deadlock detected&quot;,</span>
<a href="#l81.448"></a><span id="l81.448" class="difflineplus">+        &quot;=== Cyclical dependency starts at\n--- Monitor : dd.sanity4.m1&quot;,</span>
<a href="#l81.449"></a><span id="l81.449" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.sanity4.m2&quot;,</span>
<a href="#l81.450"></a><span id="l81.450" class="difflineplus">+        &quot;=== Cycle completed at\n--- Monitor : dd.sanity4.m1&quot;,</span>
<a href="#l81.451"></a><span id="l81.451" class="difflineplus">+        &quot;###!!! ASSERTION: Potential deadlock detected&quot;,</span>
<a href="#l81.452"></a><span id="l81.452" class="difflineplus">+        0</span>
<a href="#l81.453"></a><span id="l81.453" class="difflineplus">+    };</span>
<a href="#l81.454"></a><span id="l81.454" class="difflineplus">+    if (CheckForDeadlock(&quot;Sanity4&quot;, tokens)) {</span>
<a href="#l81.455"></a><span id="l81.455" class="difflineplus">+        PASS();</span>
<a href="#l81.456"></a><span id="l81.456" class="difflineplus">+    } else {</span>
<a href="#l81.457"></a><span id="l81.457" class="difflineplus">+        FAIL(&quot;deadlock not detected&quot;);</span>
<a href="#l81.458"></a><span id="l81.458" class="difflineplus">+    }</span>
<a href="#l81.459"></a><span id="l81.459" class="difflineplus">+}</span>
<a href="#l81.460"></a><span id="l81.460" class="difflineplus">+</span>
<a href="#l81.461"></a><span id="l81.461" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l81.462"></a><span id="l81.462" class="difflineplus">+// Multithreaded tests</span>
<a href="#l81.463"></a><span id="l81.463" class="difflineplus">+</span>
<a href="#l81.464"></a><span id="l81.464" class="difflineplus">+TestMutex* ttM1;</span>
<a href="#l81.465"></a><span id="l81.465" class="difflineplus">+TestMutex* ttM2;</span>
<a href="#l81.466"></a><span id="l81.466" class="difflineplus">+</span>
<a href="#l81.467"></a><span id="l81.467" class="difflineplus">+static void</span>
<a href="#l81.468"></a><span id="l81.468" class="difflineplus">+TwoThreads_thread(void* arg)</span>
<a href="#l81.469"></a><span id="l81.469" class="difflineplus">+{</span>
<a href="#l81.470"></a><span id="l81.470" class="difflineplus">+    PRInt32 m1First = NS_PTR_TO_INT32(arg);</span>
<a href="#l81.471"></a><span id="l81.471" class="difflineplus">+    if (m1First) {</span>
<a href="#l81.472"></a><span id="l81.472" class="difflineplus">+        ttM1-&gt;Lock();</span>
<a href="#l81.473"></a><span id="l81.473" class="difflineplus">+        ttM2-&gt;Lock();</span>
<a href="#l81.474"></a><span id="l81.474" class="difflineplus">+        ttM2-&gt;Unlock();</span>
<a href="#l81.475"></a><span id="l81.475" class="difflineplus">+        ttM1-&gt;Unlock();</span>
<a href="#l81.476"></a><span id="l81.476" class="difflineplus">+    }</span>
<a href="#l81.477"></a><span id="l81.477" class="difflineplus">+    else {</span>
<a href="#l81.478"></a><span id="l81.478" class="difflineplus">+        ttM2-&gt;Lock();</span>
<a href="#l81.479"></a><span id="l81.479" class="difflineplus">+        ttM1-&gt;Lock();</span>
<a href="#l81.480"></a><span id="l81.480" class="difflineplus">+        ttM1-&gt;Unlock();</span>
<a href="#l81.481"></a><span id="l81.481" class="difflineplus">+        ttM2-&gt;Unlock();</span>
<a href="#l81.482"></a><span id="l81.482" class="difflineplus">+    }</span>
<a href="#l81.483"></a><span id="l81.483" class="difflineplus">+}</span>
<a href="#l81.484"></a><span id="l81.484" class="difflineplus">+</span>
<a href="#l81.485"></a><span id="l81.485" class="difflineplus">+nsresult</span>
<a href="#l81.486"></a><span id="l81.486" class="difflineplus">+TwoThreads_Child()</span>
<a href="#l81.487"></a><span id="l81.487" class="difflineplus">+{</span>
<a href="#l81.488"></a><span id="l81.488" class="difflineplus">+    ttM1 = new TestMutex(&quot;dd.twothreads.m1&quot;);</span>
<a href="#l81.489"></a><span id="l81.489" class="difflineplus">+    ttM2 = new TestMutex(&quot;dd.twothreads.m2&quot;);</span>
<a href="#l81.490"></a><span id="l81.490" class="difflineplus">+    if (!ttM1 || !ttM2)</span>
<a href="#l81.491"></a><span id="l81.491" class="difflineplus">+        NS_RUNTIMEABORT(&quot;couldn't allocate mutexes&quot;);</span>
<a href="#l81.492"></a><span id="l81.492" class="difflineplus">+</span>
<a href="#l81.493"></a><span id="l81.493" class="difflineplus">+    PRThread* t1 = spawn(TwoThreads_thread, (void*) 0);</span>
<a href="#l81.494"></a><span id="l81.494" class="difflineplus">+    PR_JoinThread(t1);</span>
<a href="#l81.495"></a><span id="l81.495" class="difflineplus">+</span>
<a href="#l81.496"></a><span id="l81.496" class="difflineplus">+    PRThread* t2 = spawn(TwoThreads_thread, (void*) 1);</span>
<a href="#l81.497"></a><span id="l81.497" class="difflineplus">+    PR_JoinThread(t2);</span>
<a href="#l81.498"></a><span id="l81.498" class="difflineplus">+</span>
<a href="#l81.499"></a><span id="l81.499" class="difflineplus">+    return 0;</span>
<a href="#l81.500"></a><span id="l81.500" class="difflineplus">+}</span>
<a href="#l81.501"></a><span id="l81.501" class="difflineplus">+</span>
<a href="#l81.502"></a><span id="l81.502" class="difflineplus">+nsresult</span>
<a href="#l81.503"></a><span id="l81.503" class="difflineplus">+TwoThreads()</span>
<a href="#l81.504"></a><span id="l81.504" class="difflineplus">+{</span>
<a href="#l81.505"></a><span id="l81.505" class="difflineplus">+    const char* const tokens[] = {</span>
<a href="#l81.506"></a><span id="l81.506" class="difflineplus">+        &quot;###!!! ERROR: Potential deadlock detected&quot;,</span>
<a href="#l81.507"></a><span id="l81.507" class="difflineplus">+        &quot;=== Cyclical dependency starts at\n--- Mutex : dd.twothreads.m2&quot;,</span>
<a href="#l81.508"></a><span id="l81.508" class="difflineplus">+        &quot;--- Next dependency:\n--- Mutex : dd.twothreads.m1&quot;,</span>
<a href="#l81.509"></a><span id="l81.509" class="difflineplus">+        &quot;=== Cycle completed at\n--- Mutex : dd.twothreads.m2&quot;,</span>
<a href="#l81.510"></a><span id="l81.510" class="difflineplus">+        &quot;###!!! ASSERTION: Potential deadlock detected&quot;,</span>
<a href="#l81.511"></a><span id="l81.511" class="difflineplus">+        0</span>
<a href="#l81.512"></a><span id="l81.512" class="difflineplus">+    };</span>
<a href="#l81.513"></a><span id="l81.513" class="difflineplus">+</span>
<a href="#l81.514"></a><span id="l81.514" class="difflineplus">+    if (CheckForDeadlock(&quot;TwoThreads&quot;, tokens)) {</span>
<a href="#l81.515"></a><span id="l81.515" class="difflineplus">+        PASS();</span>
<a href="#l81.516"></a><span id="l81.516" class="difflineplus">+    } else {</span>
<a href="#l81.517"></a><span id="l81.517" class="difflineplus">+        FAIL(&quot;deadlock not detected&quot;);</span>
<a href="#l81.518"></a><span id="l81.518" class="difflineplus">+    }</span>
<a href="#l81.519"></a><span id="l81.519" class="difflineplus">+}</span>
<a href="#l81.520"></a><span id="l81.520" class="difflineplus">+</span>
<a href="#l81.521"></a><span id="l81.521" class="difflineplus">+</span>
<a href="#l81.522"></a><span id="l81.522" class="difflineplus">+TestMutex* cndMs[4];</span>
<a href="#l81.523"></a><span id="l81.523" class="difflineplus">+const PRUint32 K = 100000;</span>
<a href="#l81.524"></a><span id="l81.524" class="difflineplus">+</span>
<a href="#l81.525"></a><span id="l81.525" class="difflineplus">+static void</span>
<a href="#l81.526"></a><span id="l81.526" class="difflineplus">+ContentionNoDeadlock_thread(void* arg)</span>
<a href="#l81.527"></a><span id="l81.527" class="difflineplus">+{</span>
<a href="#l81.528"></a><span id="l81.528" class="difflineplus">+    PRInt32 starti = NS_PTR_TO_INT32(arg);</span>
<a href="#l81.529"></a><span id="l81.529" class="difflineplus">+</span>
<a href="#l81.530"></a><span id="l81.530" class="difflineplus">+    for (PRUint32 k = 0; k &lt; K; ++k) {</span>
<a href="#l81.531"></a><span id="l81.531" class="difflineplus">+        for (PRInt32 i = starti; i &lt; (PRInt32) NS_ARRAY_LENGTH(cndMs); ++i)</span>
<a href="#l81.532"></a><span id="l81.532" class="difflineplus">+            cndMs[i]-&gt;Lock();</span>
<a href="#l81.533"></a><span id="l81.533" class="difflineplus">+        // comment out the next two lines for deadlocking fun!</span>
<a href="#l81.534"></a><span id="l81.534" class="difflineplus">+        for (PRInt32 i = NS_ARRAY_LENGTH(cndMs) - 1; i &gt;= starti; --i)</span>
<a href="#l81.535"></a><span id="l81.535" class="difflineplus">+            cndMs[i]-&gt;Unlock();</span>
<a href="#l81.536"></a><span id="l81.536" class="difflineplus">+</span>
<a href="#l81.537"></a><span id="l81.537" class="difflineplus">+        starti = (starti + 1) % 3;</span>
<a href="#l81.538"></a><span id="l81.538" class="difflineplus">+    }</span>
<a href="#l81.539"></a><span id="l81.539" class="difflineplus">+}</span>
<a href="#l81.540"></a><span id="l81.540" class="difflineplus">+</span>
<a href="#l81.541"></a><span id="l81.541" class="difflineplus">+nsresult</span>
<a href="#l81.542"></a><span id="l81.542" class="difflineplus">+ContentionNoDeadlock_Child()</span>
<a href="#l81.543"></a><span id="l81.543" class="difflineplus">+{</span>
<a href="#l81.544"></a><span id="l81.544" class="difflineplus">+    PRThread* threads[3];</span>
<a href="#l81.545"></a><span id="l81.545" class="difflineplus">+</span>
<a href="#l81.546"></a><span id="l81.546" class="difflineplus">+    for (PRUint32 i = 0; i &lt; NS_ARRAY_LENGTH(cndMs); ++i)</span>
<a href="#l81.547"></a><span id="l81.547" class="difflineplus">+        cndMs[i] = new TestMutex(&quot;dd.cnd.ms&quot;);</span>
<a href="#l81.548"></a><span id="l81.548" class="difflineplus">+</span>
<a href="#l81.549"></a><span id="l81.549" class="difflineplus">+    for (PRInt32 i = 0; i &lt; (PRInt32) NS_ARRAY_LENGTH(threads); ++i)</span>
<a href="#l81.550"></a><span id="l81.550" class="difflineplus">+        threads[i] = spawn(ContentionNoDeadlock_thread, NS_INT32_TO_PTR(i));</span>
<a href="#l81.551"></a><span id="l81.551" class="difflineplus">+</span>
<a href="#l81.552"></a><span id="l81.552" class="difflineplus">+    for (PRUint32 i = 0; i &lt; NS_ARRAY_LENGTH(threads); ++i)</span>
<a href="#l81.553"></a><span id="l81.553" class="difflineplus">+        PR_JoinThread(threads[i]);</span>
<a href="#l81.554"></a><span id="l81.554" class="difflineplus">+</span>
<a href="#l81.555"></a><span id="l81.555" class="difflineplus">+    for (PRUint32 i = 0; i &lt; NS_ARRAY_LENGTH(cndMs); ++i)</span>
<a href="#l81.556"></a><span id="l81.556" class="difflineplus">+        delete cndMs[i];</span>
<a href="#l81.557"></a><span id="l81.557" class="difflineplus">+</span>
<a href="#l81.558"></a><span id="l81.558" class="difflineplus">+    return 0;</span>
<a href="#l81.559"></a><span id="l81.559" class="difflineplus">+}</span>
<a href="#l81.560"></a><span id="l81.560" class="difflineplus">+</span>
<a href="#l81.561"></a><span id="l81.561" class="difflineplus">+nsresult</span>
<a href="#l81.562"></a><span id="l81.562" class="difflineplus">+ContentionNoDeadlock()</span>
<a href="#l81.563"></a><span id="l81.563" class="difflineplus">+{</span>
<a href="#l81.564"></a><span id="l81.564" class="difflineplus">+    const char * func = __func__;</span>
<a href="#l81.565"></a><span id="l81.565" class="difflineplus">+    Subprocess proc(func);</span>
<a href="#l81.566"></a><span id="l81.566" class="difflineplus">+    proc.RunToCompletion(10000);</span>
<a href="#l81.567"></a><span id="l81.567" class="difflineplus">+    if (0 != proc.mExitCode) {</span>
<a href="#l81.568"></a><span id="l81.568" class="difflineplus">+        printf(&quot;(expected 0 == return code, got %d)\n&quot;, proc.mExitCode);</span>
<a href="#l81.569"></a><span id="l81.569" class="difflineplus">+        puts(&quot;(output)\n----------------------------------\n&quot;);</span>
<a href="#l81.570"></a><span id="l81.570" class="difflineplus">+        puts(proc.mStdout.get());</span>
<a href="#l81.571"></a><span id="l81.571" class="difflineplus">+        puts(&quot;----------------------------------\n&quot;);</span>
<a href="#l81.572"></a><span id="l81.572" class="difflineplus">+        puts(&quot;(error output)\n----------------------------------\n&quot;);</span>
<a href="#l81.573"></a><span id="l81.573" class="difflineplus">+        puts(proc.mStderr.get());</span>
<a href="#l81.574"></a><span id="l81.574" class="difflineplus">+        puts(&quot;----------------------------------\n&quot;);</span>
<a href="#l81.575"></a><span id="l81.575" class="difflineplus">+</span>
<a href="#l81.576"></a><span id="l81.576" class="difflineplus">+        FAIL(&quot;deadlock&quot;);</span>
<a href="#l81.577"></a><span id="l81.577" class="difflineplus">+    }</span>
<a href="#l81.578"></a><span id="l81.578" class="difflineplus">+    PASS();</span>
<a href="#l81.579"></a><span id="l81.579" class="difflineplus">+}</span>
<a href="#l81.580"></a><span id="l81.580" class="difflineplus">+</span>
<a href="#l81.581"></a><span id="l81.581" class="difflineplus">+</span>
<a href="#l81.582"></a><span id="l81.582" class="difflineplus">+</span>
<a href="#l81.583"></a><span id="l81.583" class="difflineplus">+//-----------------------------------------------------------------------------</span>
<a href="#l81.584"></a><span id="l81.584" class="difflineplus">+</span>
<a href="#l81.585"></a><span id="l81.585" class="difflineplus">+int</span>
<a href="#l81.586"></a><span id="l81.586" class="difflineplus">+main(int argc, char** argv)</span>
<a href="#l81.587"></a><span id="l81.587" class="difflineplus">+{</span>
<a href="#l81.588"></a><span id="l81.588" class="difflineplus">+    if (1 &lt; argc) {</span>
<a href="#l81.589"></a><span id="l81.589" class="difflineplus">+        // XXX can we run w/o scoped XPCOM?</span>
<a href="#l81.590"></a><span id="l81.590" class="difflineplus">+        const char* test = argv[1];</span>
<a href="#l81.591"></a><span id="l81.591" class="difflineplus">+        ScopedXPCOM xpcom(test);</span>
<a href="#l81.592"></a><span id="l81.592" class="difflineplus">+        if (xpcom.failed())</span>
<a href="#l81.593"></a><span id="l81.593" class="difflineplus">+            return 1;</span>
<a href="#l81.594"></a><span id="l81.594" class="difflineplus">+</span>
<a href="#l81.595"></a><span id="l81.595" class="difflineplus">+        // running in a spawned process.  call the specificed child function.</span>
<a href="#l81.596"></a><span id="l81.596" class="difflineplus">+        if (!strcmp(&quot;Sanity&quot;, test))</span>
<a href="#l81.597"></a><span id="l81.597" class="difflineplus">+            return Sanity_Child();</span>
<a href="#l81.598"></a><span id="l81.598" class="difflineplus">+        if (!strcmp(&quot;Sanity2&quot;, test))</span>
<a href="#l81.599"></a><span id="l81.599" class="difflineplus">+            return Sanity2_Child();</span>
<a href="#l81.600"></a><span id="l81.600" class="difflineplus">+        if (!strcmp(&quot;Sanity3&quot;, test))</span>
<a href="#l81.601"></a><span id="l81.601" class="difflineplus">+            return Sanity3_Child();</span>
<a href="#l81.602"></a><span id="l81.602" class="difflineplus">+        if (!strcmp(&quot;Sanity4&quot;, test))</span>
<a href="#l81.603"></a><span id="l81.603" class="difflineplus">+            return Sanity4_Child();</span>
<a href="#l81.604"></a><span id="l81.604" class="difflineplus">+</span>
<a href="#l81.605"></a><span id="l81.605" class="difflineplus">+        if (!strcmp(&quot;TwoThreads&quot;, test))</span>
<a href="#l81.606"></a><span id="l81.606" class="difflineplus">+            return TwoThreads_Child();</span>
<a href="#l81.607"></a><span id="l81.607" class="difflineplus">+        if (!strcmp(&quot;ContentionNoDeadlock&quot;, test))</span>
<a href="#l81.608"></a><span id="l81.608" class="difflineplus">+            return ContentionNoDeadlock_Child();</span>
<a href="#l81.609"></a><span id="l81.609" class="difflineplus">+</span>
<a href="#l81.610"></a><span id="l81.610" class="difflineplus">+        FAIL(&quot;unknown child test&quot;);</span>
<a href="#l81.611"></a><span id="l81.611" class="difflineplus">+    }</span>
<a href="#l81.612"></a><span id="l81.612" class="difflineplus">+</span>
<a href="#l81.613"></a><span id="l81.613" class="difflineplus">+    ScopedXPCOM xpcom(&quot;Deadlock detector correctness&quot;);</span>
<a href="#l81.614"></a><span id="l81.614" class="difflineplus">+    if (xpcom.failed())</span>
<a href="#l81.615"></a><span id="l81.615" class="difflineplus">+        return 1;</span>
<a href="#l81.616"></a><span id="l81.616" class="difflineplus">+</span>
<a href="#l81.617"></a><span id="l81.617" class="difflineplus">+    // in the first invocation of this process.  we will be the &quot;driver&quot;.</span>
<a href="#l81.618"></a><span id="l81.618" class="difflineplus">+    int rv = 0;</span>
<a href="#l81.619"></a><span id="l81.619" class="difflineplus">+</span>
<a href="#l81.620"></a><span id="l81.620" class="difflineplus">+    sPathToThisBinary = argv[0];</span>
<a href="#l81.621"></a><span id="l81.621" class="difflineplus">+</span>
<a href="#l81.622"></a><span id="l81.622" class="difflineplus">+    if (NS_FAILED(Sanity()))</span>
<a href="#l81.623"></a><span id="l81.623" class="difflineplus">+        rv = 1;</span>
<a href="#l81.624"></a><span id="l81.624" class="difflineplus">+    if (NS_FAILED(Sanity2()))</span>
<a href="#l81.625"></a><span id="l81.625" class="difflineplus">+        rv = 1;</span>
<a href="#l81.626"></a><span id="l81.626" class="difflineplus">+    if (NS_FAILED(Sanity3()))</span>
<a href="#l81.627"></a><span id="l81.627" class="difflineplus">+        rv = 1;</span>
<a href="#l81.628"></a><span id="l81.628" class="difflineplus">+    if (NS_FAILED(Sanity4()))</span>
<a href="#l81.629"></a><span id="l81.629" class="difflineplus">+        rv = 1;</span>
<a href="#l81.630"></a><span id="l81.630" class="difflineplus">+</span>
<a href="#l81.631"></a><span id="l81.631" class="difflineplus">+    if (NS_FAILED(TwoThreads()))</span>
<a href="#l81.632"></a><span id="l81.632" class="difflineplus">+        rv = 1;</span>
<a href="#l81.633"></a><span id="l81.633" class="difflineplus">+    if (NS_FAILED(ContentionNoDeadlock()))</span>
<a href="#l81.634"></a><span id="l81.634" class="difflineplus">+        rv = 1;</span>
<a href="#l81.635"></a><span id="l81.635" class="difflineplus">+</span>
<a href="#l81.636"></a><span id="l81.636" class="difflineplus">+    return rv;</span>
<a href="#l81.637"></a><span id="l81.637" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1">new file mode 100644</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineminus">--- /dev/null</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineplus">+++ b/storage-backport/test/test_mutex.cpp</span>
<a href="#l82.4"></a><span id="l82.4" class="difflineat">@@ -0,0 +1,117 @@</span>
<a href="#l82.5"></a><span id="l82.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l82.6"></a><span id="l82.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l82.7"></a><span id="l82.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l82.8"></a><span id="l82.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l82.9"></a><span id="l82.9" class="difflineplus">+ *</span>
<a href="#l82.10"></a><span id="l82.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l82.11"></a><span id="l82.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+ *</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l82.16"></a><span id="l82.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineplus">+ * License.</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+ *</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l82.21"></a><span id="l82.21" class="difflineplus">+ *</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l82.23"></a><span id="l82.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l82.24"></a><span id="l82.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineplus">+ *</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineplus">+ *</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineplus">+ *</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l82.43"></a><span id="l82.43" class="difflineplus">+</span>
<a href="#l82.44"></a><span id="l82.44" class="difflineplus">+#include &quot;storage_test_harness.h&quot;</span>
<a href="#l82.45"></a><span id="l82.45" class="difflineplus">+</span>
<a href="#l82.46"></a><span id="l82.46" class="difflineplus">+#include &quot;SQLiteMutex.h&quot;</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineplus">+</span>
<a href="#l82.48"></a><span id="l82.48" class="difflineplus">+using namespace mozilla::storage;</span>
<a href="#l82.49"></a><span id="l82.49" class="difflineplus">+</span>
<a href="#l82.50"></a><span id="l82.50" class="difflineplus">+/**</span>
<a href="#l82.51"></a><span id="l82.51" class="difflineplus">+ * This file test our sqlite3_mutex wrapper in SQLiteMutex.h.</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineplus">+ */</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+</span>
<a href="#l82.54"></a><span id="l82.54" class="difflineplus">+void</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineplus">+test_AutoLock()</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineplus">+{</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineplus">+  int lockTypes[] = {</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineplus">+    SQLITE_MUTEX_FAST,</span>
<a href="#l82.59"></a><span id="l82.59" class="difflineplus">+    SQLITE_MUTEX_RECURSIVE,</span>
<a href="#l82.60"></a><span id="l82.60" class="difflineplus">+  };</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineplus">+  for (size_t i = 0; i &lt; NS_ARRAY_LENGTH(lockTypes); i++) {</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineplus">+    // Get our test mutex (we have to allocate a SQLite mutex of the right type</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineplus">+    // too!).</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineplus">+    SQLiteMutex mutex(&quot;TestMutex&quot;);</span>
<a href="#l82.65"></a><span id="l82.65" class="difflineplus">+    sqlite3_mutex *inner = sqlite3_mutex_alloc(lockTypes[i]);</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineplus">+    do_check_true(inner);</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+    mutex.initWithMutex(inner);</span>
<a href="#l82.68"></a><span id="l82.68" class="difflineplus">+</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineplus">+    // And test that our automatic locking wrapper works as expected.</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineplus">+    mutex.assertNotCurrentThreadOwns();</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineplus">+    {</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineplus">+      SQLiteMutexAutoLock lockedScope(mutex);</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineplus">+      mutex.assertCurrentThreadOwns();</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineplus">+    }</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+    mutex.assertNotCurrentThreadOwns();</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineplus">+</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineplus">+    // Free the wrapped mutex - we don't need it anymore.</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+    sqlite3_mutex_free(inner);</span>
<a href="#l82.79"></a><span id="l82.79" class="difflineplus">+  }</span>
<a href="#l82.80"></a><span id="l82.80" class="difflineplus">+}</span>
<a href="#l82.81"></a><span id="l82.81" class="difflineplus">+</span>
<a href="#l82.82"></a><span id="l82.82" class="difflineplus">+void</span>
<a href="#l82.83"></a><span id="l82.83" class="difflineplus">+test_AutoUnlock()</span>
<a href="#l82.84"></a><span id="l82.84" class="difflineplus">+{</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineplus">+  int lockTypes[] = {</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineplus">+    SQLITE_MUTEX_FAST,</span>
<a href="#l82.87"></a><span id="l82.87" class="difflineplus">+    SQLITE_MUTEX_RECURSIVE,</span>
<a href="#l82.88"></a><span id="l82.88" class="difflineplus">+  };</span>
<a href="#l82.89"></a><span id="l82.89" class="difflineplus">+  for (size_t i = 0; i &lt; NS_ARRAY_LENGTH(lockTypes); i++) {</span>
<a href="#l82.90"></a><span id="l82.90" class="difflineplus">+    // Get our test mutex (we have to allocate a SQLite mutex of the right type</span>
<a href="#l82.91"></a><span id="l82.91" class="difflineplus">+    // too!).</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineplus">+    SQLiteMutex mutex(&quot;TestMutex&quot;);</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineplus">+    sqlite3_mutex *inner = sqlite3_mutex_alloc(lockTypes[i]);</span>
<a href="#l82.94"></a><span id="l82.94" class="difflineplus">+    do_check_true(inner);</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineplus">+    mutex.initWithMutex(inner);</span>
<a href="#l82.96"></a><span id="l82.96" class="difflineplus">+</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineplus">+    // And test that our automatic unlocking wrapper works as expected.</span>
<a href="#l82.98"></a><span id="l82.98" class="difflineplus">+    {</span>
<a href="#l82.99"></a><span id="l82.99" class="difflineplus">+      SQLiteMutexAutoLock lockedScope(mutex);</span>
<a href="#l82.100"></a><span id="l82.100" class="difflineplus">+</span>
<a href="#l82.101"></a><span id="l82.101" class="difflineplus">+      {</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineplus">+        SQLiteMutexAutoUnlock unlockedScope(mutex);</span>
<a href="#l82.103"></a><span id="l82.103" class="difflineplus">+        mutex.assertNotCurrentThreadOwns();</span>
<a href="#l82.104"></a><span id="l82.104" class="difflineplus">+      }</span>
<a href="#l82.105"></a><span id="l82.105" class="difflineplus">+      mutex.assertCurrentThreadOwns();</span>
<a href="#l82.106"></a><span id="l82.106" class="difflineplus">+    }</span>
<a href="#l82.107"></a><span id="l82.107" class="difflineplus">+</span>
<a href="#l82.108"></a><span id="l82.108" class="difflineplus">+    // Free the wrapped mutex - we don't need it anymore.</span>
<a href="#l82.109"></a><span id="l82.109" class="difflineplus">+    sqlite3_mutex_free(inner);</span>
<a href="#l82.110"></a><span id="l82.110" class="difflineplus">+  }</span>
<a href="#l82.111"></a><span id="l82.111" class="difflineplus">+}</span>
<a href="#l82.112"></a><span id="l82.112" class="difflineplus">+</span>
<a href="#l82.113"></a><span id="l82.113" class="difflineplus">+void (*gTests[])(void) = {</span>
<a href="#l82.114"></a><span id="l82.114" class="difflineplus">+  test_AutoLock,</span>
<a href="#l82.115"></a><span id="l82.115" class="difflineplus">+  test_AutoUnlock,</span>
<a href="#l82.116"></a><span id="l82.116" class="difflineplus">+};</span>
<a href="#l82.117"></a><span id="l82.117" class="difflineplus">+</span>
<a href="#l82.118"></a><span id="l82.118" class="difflineplus">+const char *file = __FILE__;</span>
<a href="#l82.119"></a><span id="l82.119" class="difflineplus">+#define TEST_NAME &quot;SQLiteMutex&quot;</span>
<a href="#l82.120"></a><span id="l82.120" class="difflineplus">+#define TEST_FILE file</span>
<a href="#l82.121"></a><span id="l82.121" class="difflineplus">+#include &quot;storage_test_harness_tail.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1">new file mode 100644</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineminus">--- /dev/null</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineplus">+++ b/storage-backport/test/test_statement_scoper.cpp</span>
<a href="#l83.4"></a><span id="l83.4" class="difflineat">@@ -0,0 +1,137 @@</span>
<a href="#l83.5"></a><span id="l83.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l83.6"></a><span id="l83.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l83.7"></a><span id="l83.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l83.8"></a><span id="l83.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l83.9"></a><span id="l83.9" class="difflineplus">+ *</span>
<a href="#l83.10"></a><span id="l83.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l83.11"></a><span id="l83.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+ *</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l83.16"></a><span id="l83.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l83.17"></a><span id="l83.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineplus">+ * License.</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineplus">+ *</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+ *</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l83.23"></a><span id="l83.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineplus">+ *</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l83.28"></a><span id="l83.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l83.29"></a><span id="l83.29" class="difflineplus">+ *</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l83.33"></a><span id="l83.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l83.38"></a><span id="l83.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineplus">+ *</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineplus">+</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+#include &quot;storage_test_harness.h&quot;</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineplus">+</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineplus">+#include &quot;mozStorageHelper.h&quot;</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+/**</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineplus">+ * This file test our statement scoper in mozStorageHelper.h.</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineplus">+ */</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineplus">+void</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineplus">+test_automatic_reset()</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineplus">+{</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineplus">+  // Need to create a table to populate sqlite_master with an entry.</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineplus">+    &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineplus">+  ));</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineplus">+</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; stmt;</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+    &quot;SELECT * FROM sqlite_master&quot;</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineplus">+  ), getter_AddRefs(stmt));</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineplus">+</span>
<a href="#l83.67"></a><span id="l83.67" class="difflineplus">+  // Reality check - make sure we start off in the right state.</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineplus">+  PRInt32 state = -1;</span>
<a href="#l83.69"></a><span id="l83.69" class="difflineplus">+  (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineplus">+  do_check_true(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_READY);</span>
<a href="#l83.71"></a><span id="l83.71" class="difflineplus">+</span>
<a href="#l83.72"></a><span id="l83.72" class="difflineplus">+  // Start executing the statement, which will put it into an executing state.</span>
<a href="#l83.73"></a><span id="l83.73" class="difflineplus">+  {</span>
<a href="#l83.74"></a><span id="l83.74" class="difflineplus">+    mozStorageStatementScoper scoper(stmt);</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineplus">+    PRBool hasMore;</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineplus">+    do_check_true(NS_SUCCEEDED(stmt-&gt;ExecuteStep(&amp;hasMore)));</span>
<a href="#l83.77"></a><span id="l83.77" class="difflineplus">+</span>
<a href="#l83.78"></a><span id="l83.78" class="difflineplus">+    // Reality check that we are executing.</span>
<a href="#l83.79"></a><span id="l83.79" class="difflineplus">+    state = -1;</span>
<a href="#l83.80"></a><span id="l83.80" class="difflineplus">+    (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.81"></a><span id="l83.81" class="difflineplus">+    do_check_true(state ==</span>
<a href="#l83.82"></a><span id="l83.82" class="difflineplus">+                  mozIStorageStatement::MOZ_STORAGE_STATEMENT_EXECUTING);</span>
<a href="#l83.83"></a><span id="l83.83" class="difflineplus">+  }</span>
<a href="#l83.84"></a><span id="l83.84" class="difflineplus">+</span>
<a href="#l83.85"></a><span id="l83.85" class="difflineplus">+  // And we should be ready again.</span>
<a href="#l83.86"></a><span id="l83.86" class="difflineplus">+  state = -1;</span>
<a href="#l83.87"></a><span id="l83.87" class="difflineplus">+  (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.88"></a><span id="l83.88" class="difflineplus">+  do_check_true(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_READY);</span>
<a href="#l83.89"></a><span id="l83.89" class="difflineplus">+}</span>
<a href="#l83.90"></a><span id="l83.90" class="difflineplus">+</span>
<a href="#l83.91"></a><span id="l83.91" class="difflineplus">+void</span>
<a href="#l83.92"></a><span id="l83.92" class="difflineplus">+test_Abandon()</span>
<a href="#l83.93"></a><span id="l83.93" class="difflineplus">+{</span>
<a href="#l83.94"></a><span id="l83.94" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l83.95"></a><span id="l83.95" class="difflineplus">+</span>
<a href="#l83.96"></a><span id="l83.96" class="difflineplus">+  // Need to create a table to populate sqlite_master with an entry.</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineplus">+  (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+    &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l83.99"></a><span id="l83.99" class="difflineplus">+  ));</span>
<a href="#l83.100"></a><span id="l83.100" class="difflineplus">+</span>
<a href="#l83.101"></a><span id="l83.101" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; stmt;</span>
<a href="#l83.102"></a><span id="l83.102" class="difflineplus">+  (void)db-&gt;CreateStatement(NS_LITERAL_CSTRING(</span>
<a href="#l83.103"></a><span id="l83.103" class="difflineplus">+    &quot;SELECT * FROM sqlite_master&quot;</span>
<a href="#l83.104"></a><span id="l83.104" class="difflineplus">+  ), getter_AddRefs(stmt));</span>
<a href="#l83.105"></a><span id="l83.105" class="difflineplus">+</span>
<a href="#l83.106"></a><span id="l83.106" class="difflineplus">+  // Reality check - make sure we start off in the right state.</span>
<a href="#l83.107"></a><span id="l83.107" class="difflineplus">+  PRInt32 state = -1;</span>
<a href="#l83.108"></a><span id="l83.108" class="difflineplus">+  (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.109"></a><span id="l83.109" class="difflineplus">+  do_check_true(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_READY);</span>
<a href="#l83.110"></a><span id="l83.110" class="difflineplus">+</span>
<a href="#l83.111"></a><span id="l83.111" class="difflineplus">+  // Start executing the statement, which will put it into an executing state.</span>
<a href="#l83.112"></a><span id="l83.112" class="difflineplus">+  {</span>
<a href="#l83.113"></a><span id="l83.113" class="difflineplus">+    mozStorageStatementScoper scoper(stmt);</span>
<a href="#l83.114"></a><span id="l83.114" class="difflineplus">+    PRBool hasMore;</span>
<a href="#l83.115"></a><span id="l83.115" class="difflineplus">+    do_check_true(NS_SUCCEEDED(stmt-&gt;ExecuteStep(&amp;hasMore)));</span>
<a href="#l83.116"></a><span id="l83.116" class="difflineplus">+</span>
<a href="#l83.117"></a><span id="l83.117" class="difflineplus">+    // Reality check that we are executing.</span>
<a href="#l83.118"></a><span id="l83.118" class="difflineplus">+    state = -1;</span>
<a href="#l83.119"></a><span id="l83.119" class="difflineplus">+    (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.120"></a><span id="l83.120" class="difflineplus">+    do_check_true(state ==</span>
<a href="#l83.121"></a><span id="l83.121" class="difflineplus">+                  mozIStorageStatement::MOZ_STORAGE_STATEMENT_EXECUTING);</span>
<a href="#l83.122"></a><span id="l83.122" class="difflineplus">+</span>
<a href="#l83.123"></a><span id="l83.123" class="difflineplus">+    // And call Abandon.  We should not reset now when we fall out of scope.</span>
<a href="#l83.124"></a><span id="l83.124" class="difflineplus">+    scoper.Abandon();</span>
<a href="#l83.125"></a><span id="l83.125" class="difflineplus">+  }</span>
<a href="#l83.126"></a><span id="l83.126" class="difflineplus">+</span>
<a href="#l83.127"></a><span id="l83.127" class="difflineplus">+  // And we should still be executing.</span>
<a href="#l83.128"></a><span id="l83.128" class="difflineplus">+  state = -1;</span>
<a href="#l83.129"></a><span id="l83.129" class="difflineplus">+  (void)stmt-&gt;GetState(&amp;state);</span>
<a href="#l83.130"></a><span id="l83.130" class="difflineplus">+  do_check_true(state == mozIStorageStatement::MOZ_STORAGE_STATEMENT_EXECUTING);</span>
<a href="#l83.131"></a><span id="l83.131" class="difflineplus">+}</span>
<a href="#l83.132"></a><span id="l83.132" class="difflineplus">+</span>
<a href="#l83.133"></a><span id="l83.133" class="difflineplus">+void (*gTests[])(void) = {</span>
<a href="#l83.134"></a><span id="l83.134" class="difflineplus">+  test_automatic_reset,</span>
<a href="#l83.135"></a><span id="l83.135" class="difflineplus">+  test_Abandon,</span>
<a href="#l83.136"></a><span id="l83.136" class="difflineplus">+};</span>
<a href="#l83.137"></a><span id="l83.137" class="difflineplus">+</span>
<a href="#l83.138"></a><span id="l83.138" class="difflineplus">+const char *file = __FILE__;</span>
<a href="#l83.139"></a><span id="l83.139" class="difflineplus">+#define TEST_NAME &quot;statement scoper&quot;</span>
<a href="#l83.140"></a><span id="l83.140" class="difflineplus">+#define TEST_FILE file</span>
<a href="#l83.141"></a><span id="l83.141" class="difflineplus">+#include &quot;storage_test_harness_tail.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1">new file mode 100644</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineminus">--- /dev/null</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineplus">+++ b/storage-backport/test/test_transaction_helper.cpp</span>
<a href="#l84.4"></a><span id="l84.4" class="difflineat">@@ -0,0 +1,215 @@</span>
<a href="#l84.5"></a><span id="l84.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l84.6"></a><span id="l84.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l84.7"></a><span id="l84.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l84.8"></a><span id="l84.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l84.9"></a><span id="l84.9" class="difflineplus">+ *</span>
<a href="#l84.10"></a><span id="l84.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l84.11"></a><span id="l84.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+ *</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineplus">+ * License.</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+ *</span>
<a href="#l84.20"></a><span id="l84.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l84.21"></a><span id="l84.21" class="difflineplus">+ *</span>
<a href="#l84.22"></a><span id="l84.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l84.24"></a><span id="l84.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l84.25"></a><span id="l84.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l84.26"></a><span id="l84.26" class="difflineplus">+ *</span>
<a href="#l84.27"></a><span id="l84.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l84.28"></a><span id="l84.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l84.29"></a><span id="l84.29" class="difflineplus">+ *</span>
<a href="#l84.30"></a><span id="l84.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l84.31"></a><span id="l84.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l84.35"></a><span id="l84.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l84.36"></a><span id="l84.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l84.37"></a><span id="l84.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l84.39"></a><span id="l84.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l84.40"></a><span id="l84.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineplus">+ *</span>
<a href="#l84.42"></a><span id="l84.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineplus">+</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineplus">+#include &quot;storage_test_harness.h&quot;</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineplus">+</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineplus">+#include &quot;mozStorageHelper.h&quot;</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineplus">+</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineplus">+/**</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineplus">+ * This file test our Transaction helper in mozStorageHelper.h.</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineplus">+ */</span>
<a href="#l84.51"></a><span id="l84.51" class="difflineplus">+</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineplus">+void</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineplus">+test_HasTransaction()</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineplus">+{</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.56"></a><span id="l84.56" class="difflineplus">+</span>
<a href="#l84.57"></a><span id="l84.57" class="difflineplus">+  // First test that it holds the transaction after it should have gotten one.</span>
<a href="#l84.58"></a><span id="l84.58" class="difflineplus">+  {</span>
<a href="#l84.59"></a><span id="l84.59" class="difflineplus">+    mozStorageTransaction transaction(db, PR_FALSE);</span>
<a href="#l84.60"></a><span id="l84.60" class="difflineplus">+    do_check_true(transaction.HasTransaction());</span>
<a href="#l84.61"></a><span id="l84.61" class="difflineplus">+    (void)transaction.Commit();</span>
<a href="#l84.62"></a><span id="l84.62" class="difflineplus">+    // And that it does not have a transaction after we have committed.</span>
<a href="#l84.63"></a><span id="l84.63" class="difflineplus">+    do_check_false(transaction.HasTransaction());</span>
<a href="#l84.64"></a><span id="l84.64" class="difflineplus">+  }</span>
<a href="#l84.65"></a><span id="l84.65" class="difflineplus">+</span>
<a href="#l84.66"></a><span id="l84.66" class="difflineplus">+  // Check that no transaction is had after a rollback.</span>
<a href="#l84.67"></a><span id="l84.67" class="difflineplus">+  {</span>
<a href="#l84.68"></a><span id="l84.68" class="difflineplus">+    mozStorageTransaction transaction(db, PR_FALSE);</span>
<a href="#l84.69"></a><span id="l84.69" class="difflineplus">+    do_check_true(transaction.HasTransaction());</span>
<a href="#l84.70"></a><span id="l84.70" class="difflineplus">+    (void)transaction.Rollback();</span>
<a href="#l84.71"></a><span id="l84.71" class="difflineplus">+    do_check_false(transaction.HasTransaction());</span>
<a href="#l84.72"></a><span id="l84.72" class="difflineplus">+  }</span>
<a href="#l84.73"></a><span id="l84.73" class="difflineplus">+</span>
<a href="#l84.74"></a><span id="l84.74" class="difflineplus">+  // Check that we do not have a transaction if one is already obtained.</span>
<a href="#l84.75"></a><span id="l84.75" class="difflineplus">+  mozStorageTransaction outerTransaction(db, PR_FALSE);</span>
<a href="#l84.76"></a><span id="l84.76" class="difflineplus">+  do_check_true(outerTransaction.HasTransaction());</span>
<a href="#l84.77"></a><span id="l84.77" class="difflineplus">+  {</span>
<a href="#l84.78"></a><span id="l84.78" class="difflineplus">+    mozStorageTransaction innerTransaction(db, PR_FALSE);</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineplus">+    do_check_false(innerTransaction.HasTransaction());</span>
<a href="#l84.80"></a><span id="l84.80" class="difflineplus">+  }</span>
<a href="#l84.81"></a><span id="l84.81" class="difflineplus">+}</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineplus">+</span>
<a href="#l84.83"></a><span id="l84.83" class="difflineplus">+void</span>
<a href="#l84.84"></a><span id="l84.84" class="difflineplus">+test_Commit()</span>
<a href="#l84.85"></a><span id="l84.85" class="difflineplus">+{</span>
<a href="#l84.86"></a><span id="l84.86" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.87"></a><span id="l84.87" class="difflineplus">+</span>
<a href="#l84.88"></a><span id="l84.88" class="difflineplus">+  // Create a table in a transaction, call Commit, and make sure that it does</span>
<a href="#l84.89"></a><span id="l84.89" class="difflineplus">+  // exists after the transaction falls out of scope.</span>
<a href="#l84.90"></a><span id="l84.90" class="difflineplus">+  {</span>
<a href="#l84.91"></a><span id="l84.91" class="difflineplus">+    mozStorageTransaction transaction(db, PR_FALSE);</span>
<a href="#l84.92"></a><span id="l84.92" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.93"></a><span id="l84.93" class="difflineplus">+      &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.94"></a><span id="l84.94" class="difflineplus">+    ));</span>
<a href="#l84.95"></a><span id="l84.95" class="difflineplus">+    (void)transaction.Commit();</span>
<a href="#l84.96"></a><span id="l84.96" class="difflineplus">+  }</span>
<a href="#l84.97"></a><span id="l84.97" class="difflineplus">+</span>
<a href="#l84.98"></a><span id="l84.98" class="difflineplus">+  PRBool exists = PR_FALSE;</span>
<a href="#l84.99"></a><span id="l84.99" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test&quot;), &amp;exists);</span>
<a href="#l84.100"></a><span id="l84.100" class="difflineplus">+  do_check_true(exists);</span>
<a href="#l84.101"></a><span id="l84.101" class="difflineplus">+}</span>
<a href="#l84.102"></a><span id="l84.102" class="difflineplus">+</span>
<a href="#l84.103"></a><span id="l84.103" class="difflineplus">+void</span>
<a href="#l84.104"></a><span id="l84.104" class="difflineplus">+test_Rollback()</span>
<a href="#l84.105"></a><span id="l84.105" class="difflineplus">+{</span>
<a href="#l84.106"></a><span id="l84.106" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.107"></a><span id="l84.107" class="difflineplus">+</span>
<a href="#l84.108"></a><span id="l84.108" class="difflineplus">+  // Create a table in a transaction, call Rollback, and make sure that it does</span>
<a href="#l84.109"></a><span id="l84.109" class="difflineplus">+  // not exists after the transaction falls out of scope.</span>
<a href="#l84.110"></a><span id="l84.110" class="difflineplus">+  {</span>
<a href="#l84.111"></a><span id="l84.111" class="difflineplus">+    mozStorageTransaction transaction(db, PR_TRUE);</span>
<a href="#l84.112"></a><span id="l84.112" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.113"></a><span id="l84.113" class="difflineplus">+      &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.114"></a><span id="l84.114" class="difflineplus">+    ));</span>
<a href="#l84.115"></a><span id="l84.115" class="difflineplus">+    (void)transaction.Rollback();</span>
<a href="#l84.116"></a><span id="l84.116" class="difflineplus">+  }</span>
<a href="#l84.117"></a><span id="l84.117" class="difflineplus">+</span>
<a href="#l84.118"></a><span id="l84.118" class="difflineplus">+  PRBool exists = PR_TRUE;</span>
<a href="#l84.119"></a><span id="l84.119" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test&quot;), &amp;exists);</span>
<a href="#l84.120"></a><span id="l84.120" class="difflineplus">+  do_check_false(exists);</span>
<a href="#l84.121"></a><span id="l84.121" class="difflineplus">+}</span>
<a href="#l84.122"></a><span id="l84.122" class="difflineplus">+</span>
<a href="#l84.123"></a><span id="l84.123" class="difflineplus">+void</span>
<a href="#l84.124"></a><span id="l84.124" class="difflineplus">+test_AutoCommit()</span>
<a href="#l84.125"></a><span id="l84.125" class="difflineplus">+{</span>
<a href="#l84.126"></a><span id="l84.126" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.127"></a><span id="l84.127" class="difflineplus">+</span>
<a href="#l84.128"></a><span id="l84.128" class="difflineplus">+  // Create a table in a transaction, and make sure that it exists after the</span>
<a href="#l84.129"></a><span id="l84.129" class="difflineplus">+  // transaction falls out of scope.  This means the Commit was successful.</span>
<a href="#l84.130"></a><span id="l84.130" class="difflineplus">+  {</span>
<a href="#l84.131"></a><span id="l84.131" class="difflineplus">+    mozStorageTransaction transaction(db, PR_TRUE);</span>
<a href="#l84.132"></a><span id="l84.132" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.133"></a><span id="l84.133" class="difflineplus">+      &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.134"></a><span id="l84.134" class="difflineplus">+    ));</span>
<a href="#l84.135"></a><span id="l84.135" class="difflineplus">+  }</span>
<a href="#l84.136"></a><span id="l84.136" class="difflineplus">+</span>
<a href="#l84.137"></a><span id="l84.137" class="difflineplus">+  PRBool exists = PR_FALSE;</span>
<a href="#l84.138"></a><span id="l84.138" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test&quot;), &amp;exists);</span>
<a href="#l84.139"></a><span id="l84.139" class="difflineplus">+  do_check_true(exists);</span>
<a href="#l84.140"></a><span id="l84.140" class="difflineplus">+}</span>
<a href="#l84.141"></a><span id="l84.141" class="difflineplus">+</span>
<a href="#l84.142"></a><span id="l84.142" class="difflineplus">+void</span>
<a href="#l84.143"></a><span id="l84.143" class="difflineplus">+test_AutoRollback()</span>
<a href="#l84.144"></a><span id="l84.144" class="difflineplus">+{</span>
<a href="#l84.145"></a><span id="l84.145" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.146"></a><span id="l84.146" class="difflineplus">+</span>
<a href="#l84.147"></a><span id="l84.147" class="difflineplus">+  // Create a table in a transaction, and make sure that it does not exists</span>
<a href="#l84.148"></a><span id="l84.148" class="difflineplus">+  // after the transaction falls out of scope.  This means the Rollback was</span>
<a href="#l84.149"></a><span id="l84.149" class="difflineplus">+  // successful.</span>
<a href="#l84.150"></a><span id="l84.150" class="difflineplus">+  {</span>
<a href="#l84.151"></a><span id="l84.151" class="difflineplus">+    mozStorageTransaction transaction(db, PR_FALSE);</span>
<a href="#l84.152"></a><span id="l84.152" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.153"></a><span id="l84.153" class="difflineplus">+      &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.154"></a><span id="l84.154" class="difflineplus">+    ));</span>
<a href="#l84.155"></a><span id="l84.155" class="difflineplus">+  }</span>
<a href="#l84.156"></a><span id="l84.156" class="difflineplus">+</span>
<a href="#l84.157"></a><span id="l84.157" class="difflineplus">+  PRBool exists = PR_TRUE;</span>
<a href="#l84.158"></a><span id="l84.158" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test&quot;), &amp;exists);</span>
<a href="#l84.159"></a><span id="l84.159" class="difflineplus">+  do_check_false(exists);</span>
<a href="#l84.160"></a><span id="l84.160" class="difflineplus">+}</span>
<a href="#l84.161"></a><span id="l84.161" class="difflineplus">+</span>
<a href="#l84.162"></a><span id="l84.162" class="difflineplus">+void</span>
<a href="#l84.163"></a><span id="l84.163" class="difflineplus">+test_SetDefaultAction()</span>
<a href="#l84.164"></a><span id="l84.164" class="difflineplus">+{</span>
<a href="#l84.165"></a><span id="l84.165" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l84.166"></a><span id="l84.166" class="difflineplus">+</span>
<a href="#l84.167"></a><span id="l84.167" class="difflineplus">+  // First we test that rollback happens when we first set it to automatically</span>
<a href="#l84.168"></a><span id="l84.168" class="difflineplus">+  // commit.</span>
<a href="#l84.169"></a><span id="l84.169" class="difflineplus">+  {</span>
<a href="#l84.170"></a><span id="l84.170" class="difflineplus">+    mozStorageTransaction transaction(db, PR_TRUE);</span>
<a href="#l84.171"></a><span id="l84.171" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.172"></a><span id="l84.172" class="difflineplus">+      &quot;CREATE TABLE test1 (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.173"></a><span id="l84.173" class="difflineplus">+    ));</span>
<a href="#l84.174"></a><span id="l84.174" class="difflineplus">+    transaction.SetDefaultAction(PR_FALSE);</span>
<a href="#l84.175"></a><span id="l84.175" class="difflineplus">+  }</span>
<a href="#l84.176"></a><span id="l84.176" class="difflineplus">+  PRBool exists = PR_TRUE;</span>
<a href="#l84.177"></a><span id="l84.177" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test1&quot;), &amp;exists);</span>
<a href="#l84.178"></a><span id="l84.178" class="difflineplus">+  do_check_false(exists);</span>
<a href="#l84.179"></a><span id="l84.179" class="difflineplus">+</span>
<a href="#l84.180"></a><span id="l84.180" class="difflineplus">+  // Now we do the opposite and test that a commit happens when we first set it</span>
<a href="#l84.181"></a><span id="l84.181" class="difflineplus">+  // to automatically rollback.</span>
<a href="#l84.182"></a><span id="l84.182" class="difflineplus">+  {</span>
<a href="#l84.183"></a><span id="l84.183" class="difflineplus">+    mozStorageTransaction transaction(db, PR_FALSE);</span>
<a href="#l84.184"></a><span id="l84.184" class="difflineplus">+    (void)db-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<a href="#l84.185"></a><span id="l84.185" class="difflineplus">+      &quot;CREATE TABLE test2 (id INTEGER PRIMARY KEY)&quot;</span>
<a href="#l84.186"></a><span id="l84.186" class="difflineplus">+    ));</span>
<a href="#l84.187"></a><span id="l84.187" class="difflineplus">+    transaction.SetDefaultAction(PR_TRUE);</span>
<a href="#l84.188"></a><span id="l84.188" class="difflineplus">+  }</span>
<a href="#l84.189"></a><span id="l84.189" class="difflineplus">+  exists = PR_FALSE;</span>
<a href="#l84.190"></a><span id="l84.190" class="difflineplus">+  (void)db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;test2&quot;), &amp;exists);</span>
<a href="#l84.191"></a><span id="l84.191" class="difflineplus">+  do_check_true(exists);</span>
<a href="#l84.192"></a><span id="l84.192" class="difflineplus">+}</span>
<a href="#l84.193"></a><span id="l84.193" class="difflineplus">+</span>
<a href="#l84.194"></a><span id="l84.194" class="difflineplus">+void</span>
<a href="#l84.195"></a><span id="l84.195" class="difflineplus">+test_null_database_connection()</span>
<a href="#l84.196"></a><span id="l84.196" class="difflineplus">+{</span>
<a href="#l84.197"></a><span id="l84.197" class="difflineplus">+  // We permit the use of the Transaction helper when passing a null database</span>
<a href="#l84.198"></a><span id="l84.198" class="difflineplus">+  // in, so we need to make sure this still works without crashing.</span>
<a href="#l84.199"></a><span id="l84.199" class="difflineplus">+  mozStorageTransaction transaction(nsnull, PR_FALSE);</span>
<a href="#l84.200"></a><span id="l84.200" class="difflineplus">+</span>
<a href="#l84.201"></a><span id="l84.201" class="difflineplus">+  do_check_false(transaction.HasTransaction());</span>
<a href="#l84.202"></a><span id="l84.202" class="difflineplus">+  do_check_true(NS_SUCCEEDED(transaction.Commit()));</span>
<a href="#l84.203"></a><span id="l84.203" class="difflineplus">+  do_check_true(NS_SUCCEEDED(transaction.Rollback()));</span>
<a href="#l84.204"></a><span id="l84.204" class="difflineplus">+}</span>
<a href="#l84.205"></a><span id="l84.205" class="difflineplus">+</span>
<a href="#l84.206"></a><span id="l84.206" class="difflineplus">+void (*gTests[])(void) = {</span>
<a href="#l84.207"></a><span id="l84.207" class="difflineplus">+  test_HasTransaction,</span>
<a href="#l84.208"></a><span id="l84.208" class="difflineplus">+  test_Commit,</span>
<a href="#l84.209"></a><span id="l84.209" class="difflineplus">+  test_Rollback,</span>
<a href="#l84.210"></a><span id="l84.210" class="difflineplus">+  test_AutoCommit,</span>
<a href="#l84.211"></a><span id="l84.211" class="difflineplus">+  test_AutoRollback,</span>
<a href="#l84.212"></a><span id="l84.212" class="difflineplus">+  test_SetDefaultAction,</span>
<a href="#l84.213"></a><span id="l84.213" class="difflineplus">+  test_null_database_connection,</span>
<a href="#l84.214"></a><span id="l84.214" class="difflineplus">+};</span>
<a href="#l84.215"></a><span id="l84.215" class="difflineplus">+</span>
<a href="#l84.216"></a><span id="l84.216" class="difflineplus">+const char *file = __FILE__;</span>
<a href="#l84.217"></a><span id="l84.217" class="difflineplus">+#define TEST_NAME &quot;transaction helper&quot;</span>
<a href="#l84.218"></a><span id="l84.218" class="difflineplus">+#define TEST_FILE file</span>
<a href="#l84.219"></a><span id="l84.219" class="difflineplus">+#include &quot;storage_test_harness_tail.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1">new file mode 100644</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineminus">--- /dev/null</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineplus">+++ b/storage-backport/test/test_true_async.cpp</span>
<a href="#l85.4"></a><span id="l85.4" class="difflineat">@@ -0,0 +1,439 @@</span>
<a href="#l85.5"></a><span id="l85.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l85.6"></a><span id="l85.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l85.7"></a><span id="l85.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l85.8"></a><span id="l85.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l85.9"></a><span id="l85.9" class="difflineplus">+ *</span>
<a href="#l85.10"></a><span id="l85.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l85.11"></a><span id="l85.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+ *</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineplus">+ * License.</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineplus">+ *</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineplus">+ * The Original Code is storage test code.</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineplus">+ *</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l85.25"></a><span id="l85.25" class="difflineplus">+ *</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt; (Original Author)</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineplus">+ *</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l85.37"></a><span id="l85.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineplus">+ *</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l85.42"></a><span id="l85.42" class="difflineplus">+</span>
<a href="#l85.43"></a><span id="l85.43" class="difflineplus">+#include &quot;storage_test_harness.h&quot;</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineplus">+#include &quot;prthread.h&quot;</span>
<a href="#l85.45"></a><span id="l85.45" class="difflineplus">+#include &quot;nsIThread.h&quot;</span>
<a href="#l85.46"></a><span id="l85.46" class="difflineplus">+#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l85.47"></a><span id="l85.47" class="difflineplus">+#include &quot;nsIEventTarget.h&quot;</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineplus">+</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineplus">+#include &quot;sqlite3.h&quot;</span>
<a href="#l85.50"></a><span id="l85.50" class="difflineplus">+</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineplus">+#include &quot;mozilla/Monitor.h&quot;</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineplus">+</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineplus">+#include &quot;mozIStorageStatementCallback.h&quot;</span>
<a href="#l85.54"></a><span id="l85.54" class="difflineplus">+#include &quot;mozIStorageCompletionCallback.h&quot;</span>
<a href="#l85.55"></a><span id="l85.55" class="difflineplus">+#include &quot;mozIStorageBindingParamsArray.h&quot;</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineplus">+#include &quot;mozIStorageBindingParams.h&quot;</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineplus">+#include &quot;mozIStorageAsyncStatement.h&quot;</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineplus">+#include &quot;mozIStorageStatement.h&quot;</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineplus">+#include &quot;mozIStoragePendingStatement.h&quot;</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineplus">+</span>
<a href="#l85.61"></a><span id="l85.61" class="difflineplus">+using mozilla::Monitor;</span>
<a href="#l85.62"></a><span id="l85.62" class="difflineplus">+using mozilla::MonitorAutoEnter;</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineplus">+</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineplus">+/**</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineplus">+ * Verify that mozIStorageAsyncStatement's life-cycle never triggers a mutex on</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineplus">+ * the caller (generally main) thread.  We do this by decorating the sqlite</span>
<a href="#l85.67"></a><span id="l85.67" class="difflineplus">+ * mutex logic with our own code that checks what thread it is being invoked on</span>
<a href="#l85.68"></a><span id="l85.68" class="difflineplus">+ * and sets a flag if it is invoked on the main thread.  We are able to easily</span>
<a href="#l85.69"></a><span id="l85.69" class="difflineplus">+ * decorate the SQLite mutex logic because SQLite allows us to retrieve the</span>
<a href="#l85.70"></a><span id="l85.70" class="difflineplus">+ * current function pointers being used and then provide a new set.</span>
<a href="#l85.71"></a><span id="l85.71" class="difflineplus">+ */</span>
<a href="#l85.72"></a><span id="l85.72" class="difflineplus">+</span>
<a href="#l85.73"></a><span id="l85.73" class="difflineplus">+/* ===== Mutex Watching ===== */</span>
<a href="#l85.74"></a><span id="l85.74" class="difflineplus">+</span>
<a href="#l85.75"></a><span id="l85.75" class="difflineplus">+sqlite3_mutex_methods orig_mutex_methods;</span>
<a href="#l85.76"></a><span id="l85.76" class="difflineplus">+sqlite3_mutex_methods wrapped_mutex_methods;</span>
<a href="#l85.77"></a><span id="l85.77" class="difflineplus">+</span>
<a href="#l85.78"></a><span id="l85.78" class="difflineplus">+bool mutex_used_on_watched_thread = false;</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineplus">+PRThread *watched_thread = NULL;</span>
<a href="#l85.80"></a><span id="l85.80" class="difflineplus">+/**</span>
<a href="#l85.81"></a><span id="l85.81" class="difflineplus">+ * Ugly hack to let us figure out what a connection's async thread is.  If we</span>
<a href="#l85.82"></a><span id="l85.82" class="difflineplus">+ * were MOZILLA_INTERNAL_API and linked as such we could just include</span>
<a href="#l85.83"></a><span id="l85.83" class="difflineplus">+ * mozStorageConnection.h and just ask Connection directly.  But that turns out</span>
<a href="#l85.84"></a><span id="l85.84" class="difflineplus">+ * poorly.</span>
<a href="#l85.85"></a><span id="l85.85" class="difflineplus">+ *</span>
<a href="#l85.86"></a><span id="l85.86" class="difflineplus">+ * When the thread a mutex is invoked on isn't watched_thread we save it to this</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineplus">+ * variable.</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+ */</span>
<a href="#l85.89"></a><span id="l85.89" class="difflineplus">+PRThread *last_non_watched_thread = NULL;</span>
<a href="#l85.90"></a><span id="l85.90" class="difflineplus">+</span>
<a href="#l85.91"></a><span id="l85.91" class="difflineplus">+/**</span>
<a href="#l85.92"></a><span id="l85.92" class="difflineplus">+ * Set a flag if the mutex is used on the thread we are watching, but always</span>
<a href="#l85.93"></a><span id="l85.93" class="difflineplus">+ * call the real mutex function.</span>
<a href="#l85.94"></a><span id="l85.94" class="difflineplus">+ */</span>
<a href="#l85.95"></a><span id="l85.95" class="difflineplus">+extern &quot;C&quot; void wrapped_MutexEnter(sqlite3_mutex *mutex)</span>
<a href="#l85.96"></a><span id="l85.96" class="difflineplus">+{</span>
<a href="#l85.97"></a><span id="l85.97" class="difflineplus">+  PRThread *curThread = ::PR_GetCurrentThread();</span>
<a href="#l85.98"></a><span id="l85.98" class="difflineplus">+  if (curThread == watched_thread)</span>
<a href="#l85.99"></a><span id="l85.99" class="difflineplus">+    mutex_used_on_watched_thread = true;</span>
<a href="#l85.100"></a><span id="l85.100" class="difflineplus">+  else</span>
<a href="#l85.101"></a><span id="l85.101" class="difflineplus">+    last_non_watched_thread = curThread;</span>
<a href="#l85.102"></a><span id="l85.102" class="difflineplus">+  orig_mutex_methods.xMutexEnter(mutex);</span>
<a href="#l85.103"></a><span id="l85.103" class="difflineplus">+}</span>
<a href="#l85.104"></a><span id="l85.104" class="difflineplus">+</span>
<a href="#l85.105"></a><span id="l85.105" class="difflineplus">+extern &quot;C&quot; int wrapped_MutexTry(sqlite3_mutex *mutex)</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineplus">+{</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineplus">+  if (::PR_GetCurrentThread() == watched_thread)</span>
<a href="#l85.108"></a><span id="l85.108" class="difflineplus">+    mutex_used_on_watched_thread = true;</span>
<a href="#l85.109"></a><span id="l85.109" class="difflineplus">+  return orig_mutex_methods.xMutexTry(mutex);</span>
<a href="#l85.110"></a><span id="l85.110" class="difflineplus">+}</span>
<a href="#l85.111"></a><span id="l85.111" class="difflineplus">+</span>
<a href="#l85.112"></a><span id="l85.112" class="difflineplus">+</span>
<a href="#l85.113"></a><span id="l85.113" class="difflineplus">+#define do_check_ok(aInvoc) do_check_true((aInvoc) == SQLITE_OK)</span>
<a href="#l85.114"></a><span id="l85.114" class="difflineplus">+</span>
<a href="#l85.115"></a><span id="l85.115" class="difflineplus">+void hook_sqlite_mutex()</span>
<a href="#l85.116"></a><span id="l85.116" class="difflineplus">+{</span>
<a href="#l85.117"></a><span id="l85.117" class="difflineplus">+  // We need to initialize and teardown SQLite to get it to set up the</span>
<a href="#l85.118"></a><span id="l85.118" class="difflineplus">+  // default mutex handlers for us so we can steal them and wrap them.</span>
<a href="#l85.119"></a><span id="l85.119" class="difflineplus">+  sqlite3_initialize();</span>
<a href="#l85.120"></a><span id="l85.120" class="difflineplus">+  sqlite3_shutdown();</span>
<a href="#l85.121"></a><span id="l85.121" class="difflineplus">+  do_check_ok(::sqlite3_config(SQLITE_CONFIG_GETMUTEX, &amp;orig_mutex_methods));</span>
<a href="#l85.122"></a><span id="l85.122" class="difflineplus">+  do_check_ok(::sqlite3_config(SQLITE_CONFIG_GETMUTEX, &amp;wrapped_mutex_methods));</span>
<a href="#l85.123"></a><span id="l85.123" class="difflineplus">+  wrapped_mutex_methods.xMutexEnter = wrapped_MutexEnter;</span>
<a href="#l85.124"></a><span id="l85.124" class="difflineplus">+  wrapped_mutex_methods.xMutexTry = wrapped_MutexTry;</span>
<a href="#l85.125"></a><span id="l85.125" class="difflineplus">+  do_check_ok(::sqlite3_config(SQLITE_CONFIG_MUTEX, &amp;wrapped_mutex_methods));</span>
<a href="#l85.126"></a><span id="l85.126" class="difflineplus">+}</span>
<a href="#l85.127"></a><span id="l85.127" class="difflineplus">+</span>
<a href="#l85.128"></a><span id="l85.128" class="difflineplus">+/**</span>
<a href="#l85.129"></a><span id="l85.129" class="difflineplus">+ * Call to clear the watch state and to set the watching against this thread.</span>
<a href="#l85.130"></a><span id="l85.130" class="difflineplus">+ *</span>
<a href="#l85.131"></a><span id="l85.131" class="difflineplus">+ * Check |mutex_used_on_watched_thread| to see if the mutex has fired since</span>
<a href="#l85.132"></a><span id="l85.132" class="difflineplus">+ * this method was last called.  Since we're talking about the current thread,</span>
<a href="#l85.133"></a><span id="l85.133" class="difflineplus">+ * there are no race issues to be concerned about</span>
<a href="#l85.134"></a><span id="l85.134" class="difflineplus">+ */</span>
<a href="#l85.135"></a><span id="l85.135" class="difflineplus">+void watch_for_mutex_use_on_this_thread()</span>
<a href="#l85.136"></a><span id="l85.136" class="difflineplus">+{</span>
<a href="#l85.137"></a><span id="l85.137" class="difflineplus">+  watched_thread = ::PR_GetCurrentThread();</span>
<a href="#l85.138"></a><span id="l85.138" class="difflineplus">+  mutex_used_on_watched_thread = false;</span>
<a href="#l85.139"></a><span id="l85.139" class="difflineplus">+}</span>
<a href="#l85.140"></a><span id="l85.140" class="difflineplus">+</span>
<a href="#l85.141"></a><span id="l85.141" class="difflineplus">+</span>
<a href="#l85.142"></a><span id="l85.142" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l85.143"></a><span id="l85.143" class="difflineplus">+//// Event Loop Spinning</span>
<a href="#l85.144"></a><span id="l85.144" class="difflineplus">+</span>
<a href="#l85.145"></a><span id="l85.145" class="difflineplus">+class AsyncStatementSpinner : public mozIStorageStatementCallback,</span>
<a href="#l85.146"></a><span id="l85.146" class="difflineplus">+                              public mozIStorageCompletionCallback</span>
<a href="#l85.147"></a><span id="l85.147" class="difflineplus">+{</span>
<a href="#l85.148"></a><span id="l85.148" class="difflineplus">+public:</span>
<a href="#l85.149"></a><span id="l85.149" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l85.150"></a><span id="l85.150" class="difflineplus">+  NS_DECL_MOZISTORAGESTATEMENTCALLBACK</span>
<a href="#l85.151"></a><span id="l85.151" class="difflineplus">+  NS_DECL_MOZISTORAGECOMPLETIONCALLBACK</span>
<a href="#l85.152"></a><span id="l85.152" class="difflineplus">+</span>
<a href="#l85.153"></a><span id="l85.153" class="difflineplus">+  AsyncStatementSpinner();</span>
<a href="#l85.154"></a><span id="l85.154" class="difflineplus">+</span>
<a href="#l85.155"></a><span id="l85.155" class="difflineplus">+  void SpinUntilCompleted();</span>
<a href="#l85.156"></a><span id="l85.156" class="difflineplus">+</span>
<a href="#l85.157"></a><span id="l85.157" class="difflineplus">+  PRUint16 completionReason;</span>
<a href="#l85.158"></a><span id="l85.158" class="difflineplus">+</span>
<a href="#l85.159"></a><span id="l85.159" class="difflineplus">+private:</span>
<a href="#l85.160"></a><span id="l85.160" class="difflineplus">+  ~AsyncStatementSpinner() {}</span>
<a href="#l85.161"></a><span id="l85.161" class="difflineplus">+  volatile bool mCompleted;</span>
<a href="#l85.162"></a><span id="l85.162" class="difflineplus">+};</span>
<a href="#l85.163"></a><span id="l85.163" class="difflineplus">+</span>
<a href="#l85.164"></a><span id="l85.164" class="difflineplus">+NS_IMPL_ISUPPORTS2(AsyncStatementSpinner,</span>
<a href="#l85.165"></a><span id="l85.165" class="difflineplus">+                   mozIStorageStatementCallback,</span>
<a href="#l85.166"></a><span id="l85.166" class="difflineplus">+                   mozIStorageCompletionCallback)</span>
<a href="#l85.167"></a><span id="l85.167" class="difflineplus">+</span>
<a href="#l85.168"></a><span id="l85.168" class="difflineplus">+AsyncStatementSpinner::AsyncStatementSpinner()</span>
<a href="#l85.169"></a><span id="l85.169" class="difflineplus">+: completionReason(0)</span>
<a href="#l85.170"></a><span id="l85.170" class="difflineplus">+, mCompleted(false)</span>
<a href="#l85.171"></a><span id="l85.171" class="difflineplus">+{</span>
<a href="#l85.172"></a><span id="l85.172" class="difflineplus">+}</span>
<a href="#l85.173"></a><span id="l85.173" class="difflineplus">+</span>
<a href="#l85.174"></a><span id="l85.174" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l85.175"></a><span id="l85.175" class="difflineplus">+AsyncStatementSpinner::HandleResult(mozIStorageResultSet *aResultSet)</span>
<a href="#l85.176"></a><span id="l85.176" class="difflineplus">+{</span>
<a href="#l85.177"></a><span id="l85.177" class="difflineplus">+  return NS_OK;</span>
<a href="#l85.178"></a><span id="l85.178" class="difflineplus">+}</span>
<a href="#l85.179"></a><span id="l85.179" class="difflineplus">+</span>
<a href="#l85.180"></a><span id="l85.180" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l85.181"></a><span id="l85.181" class="difflineplus">+AsyncStatementSpinner::HandleError(mozIStorageError *aError)</span>
<a href="#l85.182"></a><span id="l85.182" class="difflineplus">+{</span>
<a href="#l85.183"></a><span id="l85.183" class="difflineplus">+  return NS_OK;</span>
<a href="#l85.184"></a><span id="l85.184" class="difflineplus">+}</span>
<a href="#l85.185"></a><span id="l85.185" class="difflineplus">+</span>
<a href="#l85.186"></a><span id="l85.186" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l85.187"></a><span id="l85.187" class="difflineplus">+AsyncStatementSpinner::HandleCompletion(PRUint16 aReason)</span>
<a href="#l85.188"></a><span id="l85.188" class="difflineplus">+{</span>
<a href="#l85.189"></a><span id="l85.189" class="difflineplus">+  completionReason = aReason;</span>
<a href="#l85.190"></a><span id="l85.190" class="difflineplus">+  mCompleted = true;</span>
<a href="#l85.191"></a><span id="l85.191" class="difflineplus">+  return NS_OK;</span>
<a href="#l85.192"></a><span id="l85.192" class="difflineplus">+}</span>
<a href="#l85.193"></a><span id="l85.193" class="difflineplus">+</span>
<a href="#l85.194"></a><span id="l85.194" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l85.195"></a><span id="l85.195" class="difflineplus">+AsyncStatementSpinner::Complete()</span>
<a href="#l85.196"></a><span id="l85.196" class="difflineplus">+{</span>
<a href="#l85.197"></a><span id="l85.197" class="difflineplus">+  mCompleted = true;</span>
<a href="#l85.198"></a><span id="l85.198" class="difflineplus">+  return NS_OK;</span>
<a href="#l85.199"></a><span id="l85.199" class="difflineplus">+}</span>
<a href="#l85.200"></a><span id="l85.200" class="difflineplus">+</span>
<a href="#l85.201"></a><span id="l85.201" class="difflineplus">+void AsyncStatementSpinner::SpinUntilCompleted()</span>
<a href="#l85.202"></a><span id="l85.202" class="difflineplus">+{</span>
<a href="#l85.203"></a><span id="l85.203" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(::do_GetCurrentThread());</span>
<a href="#l85.204"></a><span id="l85.204" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l85.205"></a><span id="l85.205" class="difflineplus">+  PRBool processed = PR_TRUE;</span>
<a href="#l85.206"></a><span id="l85.206" class="difflineplus">+  while (!mCompleted &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l85.207"></a><span id="l85.207" class="difflineplus">+    rv = thread-&gt;ProcessNextEvent(true, &amp;processed);</span>
<a href="#l85.208"></a><span id="l85.208" class="difflineplus">+  }</span>
<a href="#l85.209"></a><span id="l85.209" class="difflineplus">+}</span>
<a href="#l85.210"></a><span id="l85.210" class="difflineplus">+</span>
<a href="#l85.211"></a><span id="l85.211" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l85.212"></a><span id="l85.212" class="difflineplus">+//// Thread Wedgers</span>
<a href="#l85.213"></a><span id="l85.213" class="difflineplus">+</span>
<a href="#l85.214"></a><span id="l85.214" class="difflineplus">+/**</span>
<a href="#l85.215"></a><span id="l85.215" class="difflineplus">+ * A runnable that blocks until code on another thread invokes its unwedge</span>
<a href="#l85.216"></a><span id="l85.216" class="difflineplus">+ * method.  By dispatching this to a thread you can ensure that no subsequent</span>
<a href="#l85.217"></a><span id="l85.217" class="difflineplus">+ * runnables dispatched to the thread will execute until you invoke unwedge.</span>
<a href="#l85.218"></a><span id="l85.218" class="difflineplus">+ *</span>
<a href="#l85.219"></a><span id="l85.219" class="difflineplus">+ * The wedger is self-dispatching, just construct it with its target.</span>
<a href="#l85.220"></a><span id="l85.220" class="difflineplus">+ */</span>
<a href="#l85.221"></a><span id="l85.221" class="difflineplus">+class ThreadWedger : public nsRunnable</span>
<a href="#l85.222"></a><span id="l85.222" class="difflineplus">+{</span>
<a href="#l85.223"></a><span id="l85.223" class="difflineplus">+public:</span>
<a href="#l85.224"></a><span id="l85.224" class="difflineplus">+  ThreadWedger(nsIEventTarget *aTarget)</span>
<a href="#l85.225"></a><span id="l85.225" class="difflineplus">+  : mMonitor(&quot;thread wedger&quot;)</span>
<a href="#l85.226"></a><span id="l85.226" class="difflineplus">+  , unwedged(false)</span>
<a href="#l85.227"></a><span id="l85.227" class="difflineplus">+  {</span>
<a href="#l85.228"></a><span id="l85.228" class="difflineplus">+    aTarget-&gt;Dispatch(this, aTarget-&gt;NS_DISPATCH_NORMAL);</span>
<a href="#l85.229"></a><span id="l85.229" class="difflineplus">+  }</span>
<a href="#l85.230"></a><span id="l85.230" class="difflineplus">+</span>
<a href="#l85.231"></a><span id="l85.231" class="difflineplus">+  NS_IMETHOD Run()</span>
<a href="#l85.232"></a><span id="l85.232" class="difflineplus">+  {</span>
<a href="#l85.233"></a><span id="l85.233" class="difflineplus">+    MonitorAutoEnter automon(mMonitor);</span>
<a href="#l85.234"></a><span id="l85.234" class="difflineplus">+</span>
<a href="#l85.235"></a><span id="l85.235" class="difflineplus">+    if (!unwedged)</span>
<a href="#l85.236"></a><span id="l85.236" class="difflineplus">+      automon.Wait();</span>
<a href="#l85.237"></a><span id="l85.237" class="difflineplus">+</span>
<a href="#l85.238"></a><span id="l85.238" class="difflineplus">+    return NS_OK;</span>
<a href="#l85.239"></a><span id="l85.239" class="difflineplus">+  }</span>
<a href="#l85.240"></a><span id="l85.240" class="difflineplus">+</span>
<a href="#l85.241"></a><span id="l85.241" class="difflineplus">+  void unwedge()</span>
<a href="#l85.242"></a><span id="l85.242" class="difflineplus">+  {</span>
<a href="#l85.243"></a><span id="l85.243" class="difflineplus">+    MonitorAutoEnter automon(mMonitor);</span>
<a href="#l85.244"></a><span id="l85.244" class="difflineplus">+    unwedged = true;</span>
<a href="#l85.245"></a><span id="l85.245" class="difflineplus">+    automon.Notify();</span>
<a href="#l85.246"></a><span id="l85.246" class="difflineplus">+  }</span>
<a href="#l85.247"></a><span id="l85.247" class="difflineplus">+</span>
<a href="#l85.248"></a><span id="l85.248" class="difflineplus">+private:</span>
<a href="#l85.249"></a><span id="l85.249" class="difflineplus">+  Monitor mMonitor;</span>
<a href="#l85.250"></a><span id="l85.250" class="difflineplus">+  bool unwedged;</span>
<a href="#l85.251"></a><span id="l85.251" class="difflineplus">+};</span>
<a href="#l85.252"></a><span id="l85.252" class="difflineplus">+</span>
<a href="#l85.253"></a><span id="l85.253" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l85.254"></a><span id="l85.254" class="difflineplus">+//// Async Helpers</span>
<a href="#l85.255"></a><span id="l85.255" class="difflineplus">+</span>
<a href="#l85.256"></a><span id="l85.256" class="difflineplus">+/**</span>
<a href="#l85.257"></a><span id="l85.257" class="difflineplus">+ * Execute an async statement, blocking the main thread until we get the</span>
<a href="#l85.258"></a><span id="l85.258" class="difflineplus">+ * callback completion notification.</span>
<a href="#l85.259"></a><span id="l85.259" class="difflineplus">+ */</span>
<a href="#l85.260"></a><span id="l85.260" class="difflineplus">+void blocking_async_execute(mozIStorageBaseStatement *stmt)</span>
<a href="#l85.261"></a><span id="l85.261" class="difflineplus">+{</span>
<a href="#l85.262"></a><span id="l85.262" class="difflineplus">+  nsRefPtr&lt;AsyncStatementSpinner&gt; spinner(new AsyncStatementSpinner());</span>
<a href="#l85.263"></a><span id="l85.263" class="difflineplus">+</span>
<a href="#l85.264"></a><span id="l85.264" class="difflineplus">+  nsCOMPtr&lt;mozIStoragePendingStatement&gt; pendy;</span>
<a href="#l85.265"></a><span id="l85.265" class="difflineplus">+  (void)stmt-&gt;ExecuteAsync(spinner, getter_AddRefs(pendy));</span>
<a href="#l85.266"></a><span id="l85.266" class="difflineplus">+  spinner-&gt;SpinUntilCompleted();</span>
<a href="#l85.267"></a><span id="l85.267" class="difflineplus">+}</span>
<a href="#l85.268"></a><span id="l85.268" class="difflineplus">+</span>
<a href="#l85.269"></a><span id="l85.269" class="difflineplus">+/**</span>
<a href="#l85.270"></a><span id="l85.270" class="difflineplus">+ * Invoke AsyncClose on the given connection, blocking the main thread until we</span>
<a href="#l85.271"></a><span id="l85.271" class="difflineplus">+ * get the completion notification.</span>
<a href="#l85.272"></a><span id="l85.272" class="difflineplus">+ */</span>
<a href="#l85.273"></a><span id="l85.273" class="difflineplus">+void blocking_async_close(mozIStorageConnection *db)</span>
<a href="#l85.274"></a><span id="l85.274" class="difflineplus">+{</span>
<a href="#l85.275"></a><span id="l85.275" class="difflineplus">+  nsRefPtr&lt;AsyncStatementSpinner&gt; spinner(new AsyncStatementSpinner());</span>
<a href="#l85.276"></a><span id="l85.276" class="difflineplus">+</span>
<a href="#l85.277"></a><span id="l85.277" class="difflineplus">+  db-&gt;AsyncClose(spinner);</span>
<a href="#l85.278"></a><span id="l85.278" class="difflineplus">+  spinner-&gt;SpinUntilCompleted();</span>
<a href="#l85.279"></a><span id="l85.279" class="difflineplus">+}</span>
<a href="#l85.280"></a><span id="l85.280" class="difflineplus">+</span>
<a href="#l85.281"></a><span id="l85.281" class="difflineplus">+/**</span>
<a href="#l85.282"></a><span id="l85.282" class="difflineplus">+ * A horrible hack to figure out what the connection's async thread is.  By</span>
<a href="#l85.283"></a><span id="l85.283" class="difflineplus">+ * creating a statement and async dispatching we can tell from the mutex who</span>
<a href="#l85.284"></a><span id="l85.284" class="difflineplus">+ * is the async thread, PRThread style.  Then we map that to an nsIThread.</span>
<a href="#l85.285"></a><span id="l85.285" class="difflineplus">+ */</span>
<a href="#l85.286"></a><span id="l85.286" class="difflineplus">+already_AddRefed&lt;nsIThread&gt; get_conn_async_thread(mozIStorageConnection *db)</span>
<a href="#l85.287"></a><span id="l85.287" class="difflineplus">+{</span>
<a href="#l85.288"></a><span id="l85.288" class="difflineplus">+  // Make sure we are tracking the current thread as the watched thread</span>
<a href="#l85.289"></a><span id="l85.289" class="difflineplus">+  watch_for_mutex_use_on_this_thread();</span>
<a href="#l85.290"></a><span id="l85.290" class="difflineplus">+</span>
<a href="#l85.291"></a><span id="l85.291" class="difflineplus">+  // - statement with nothing to bind</span>
<a href="#l85.292"></a><span id="l85.292" class="difflineplus">+  nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt;</span>
<a href="#l85.293"></a><span id="l85.293" class="difflineplus">+  db-&gt;CreateAsyncStatement(</span>
<a href="#l85.294"></a><span id="l85.294" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;SELECT 1&quot;),</span>
<a href="#l85.295"></a><span id="l85.295" class="difflineplus">+    getter_AddRefs(stmt));</span>
<a href="#l85.296"></a><span id="l85.296" class="difflineplus">+  blocking_async_execute(stmt);</span>
<a href="#l85.297"></a><span id="l85.297" class="difflineplus">+  stmt-&gt;Finalize();</span>
<a href="#l85.298"></a><span id="l85.298" class="difflineplus">+</span>
<a href="#l85.299"></a><span id="l85.299" class="difflineplus">+  nsCOMPtr&lt;nsIThreadManager&gt; threadMan =</span>
<a href="#l85.300"></a><span id="l85.300" class="difflineplus">+    do_GetService(&quot;@mozilla.org/thread-manager;1&quot;);</span>
<a href="#l85.301"></a><span id="l85.301" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; asyncThread;</span>
<a href="#l85.302"></a><span id="l85.302" class="difflineplus">+  threadMan-&gt;GetThreadFromPRThread(last_non_watched_thread,</span>
<a href="#l85.303"></a><span id="l85.303" class="difflineplus">+                                   getter_AddRefs(asyncThread));</span>
<a href="#l85.304"></a><span id="l85.304" class="difflineplus">+  return asyncThread.forget();</span>
<a href="#l85.305"></a><span id="l85.305" class="difflineplus">+}</span>
<a href="#l85.306"></a><span id="l85.306" class="difflineplus">+</span>
<a href="#l85.307"></a><span id="l85.307" class="difflineplus">+</span>
<a href="#l85.308"></a><span id="l85.308" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l85.309"></a><span id="l85.309" class="difflineplus">+//// Tests</span>
<a href="#l85.310"></a><span id="l85.310" class="difflineplus">+</span>
<a href="#l85.311"></a><span id="l85.311" class="difflineplus">+void</span>
<a href="#l85.312"></a><span id="l85.312" class="difflineplus">+test_TrueAsyncStatement()</span>
<a href="#l85.313"></a><span id="l85.313" class="difflineplus">+{</span>
<a href="#l85.314"></a><span id="l85.314" class="difflineplus">+  hook_sqlite_mutex();</span>
<a href="#l85.315"></a><span id="l85.315" class="difflineplus">+</span>
<a href="#l85.316"></a><span id="l85.316" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l85.317"></a><span id="l85.317" class="difflineplus">+</span>
<a href="#l85.318"></a><span id="l85.318" class="difflineplus">+  // Start watching for forbidden mutex usage.</span>
<a href="#l85.319"></a><span id="l85.319" class="difflineplus">+  watch_for_mutex_use_on_this_thread();</span>
<a href="#l85.320"></a><span id="l85.320" class="difflineplus">+</span>
<a href="#l85.321"></a><span id="l85.321" class="difflineplus">+  // - statement with nothing to bind</span>
<a href="#l85.322"></a><span id="l85.322" class="difflineplus">+  nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt;</span>
<a href="#l85.323"></a><span id="l85.323" class="difflineplus">+  db-&gt;CreateAsyncStatement(</span>
<a href="#l85.324"></a><span id="l85.324" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l85.325"></a><span id="l85.325" class="difflineplus">+    getter_AddRefs(stmt));</span>
<a href="#l85.326"></a><span id="l85.326" class="difflineplus">+  blocking_async_execute(stmt);</span>
<a href="#l85.327"></a><span id="l85.327" class="difflineplus">+  stmt-&gt;Finalize();</span>
<a href="#l85.328"></a><span id="l85.328" class="difflineplus">+  do_check_false(mutex_used_on_watched_thread);</span>
<a href="#l85.329"></a><span id="l85.329" class="difflineplus">+</span>
<a href="#l85.330"></a><span id="l85.330" class="difflineplus">+  // - statement with something to bind ordinally</span>
<a href="#l85.331"></a><span id="l85.331" class="difflineplus">+  db-&gt;CreateAsyncStatement(</span>
<a href="#l85.332"></a><span id="l85.332" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;INSERT INTO test (id) VALUES (?)&quot;),</span>
<a href="#l85.333"></a><span id="l85.333" class="difflineplus">+    getter_AddRefs(stmt));</span>
<a href="#l85.334"></a><span id="l85.334" class="difflineplus">+  stmt-&gt;BindInt32Parameter(0, 1);</span>
<a href="#l85.335"></a><span id="l85.335" class="difflineplus">+  blocking_async_execute(stmt);</span>
<a href="#l85.336"></a><span id="l85.336" class="difflineplus">+  stmt-&gt;Finalize();</span>
<a href="#l85.337"></a><span id="l85.337" class="difflineplus">+  do_check_false(mutex_used_on_watched_thread);</span>
<a href="#l85.338"></a><span id="l85.338" class="difflineplus">+  </span>
<a href="#l85.339"></a><span id="l85.339" class="difflineplus">+  // - statement with something to bind by name</span>
<a href="#l85.340"></a><span id="l85.340" class="difflineplus">+  db-&gt;CreateAsyncStatement(</span>
<a href="#l85.341"></a><span id="l85.341" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;INSERT INTO test (id) VALUES (:id)&quot;),</span>
<a href="#l85.342"></a><span id="l85.342" class="difflineplus">+    getter_AddRefs(stmt));</span>
<a href="#l85.343"></a><span id="l85.343" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParamsArray&gt; paramsArray;</span>
<a href="#l85.344"></a><span id="l85.344" class="difflineplus">+  stmt-&gt;NewBindingParamsArray(getter_AddRefs(paramsArray));</span>
<a href="#l85.345"></a><span id="l85.345" class="difflineplus">+  nsCOMPtr&lt;mozIStorageBindingParams&gt; params;</span>
<a href="#l85.346"></a><span id="l85.346" class="difflineplus">+  paramsArray-&gt;NewBindingParams(getter_AddRefs(params));</span>
<a href="#l85.347"></a><span id="l85.347" class="difflineplus">+  params-&gt;BindInt32ByName(NS_LITERAL_CSTRING(&quot;id&quot;), 2);</span>
<a href="#l85.348"></a><span id="l85.348" class="difflineplus">+  paramsArray-&gt;AddParams(params);</span>
<a href="#l85.349"></a><span id="l85.349" class="difflineplus">+  params = nsnull;</span>
<a href="#l85.350"></a><span id="l85.350" class="difflineplus">+  stmt-&gt;BindParameters(paramsArray);</span>
<a href="#l85.351"></a><span id="l85.351" class="difflineplus">+  paramsArray = nsnull;</span>
<a href="#l85.352"></a><span id="l85.352" class="difflineplus">+  blocking_async_execute(stmt);</span>
<a href="#l85.353"></a><span id="l85.353" class="difflineplus">+  stmt-&gt;Finalize();</span>
<a href="#l85.354"></a><span id="l85.354" class="difflineplus">+  do_check_false(mutex_used_on_watched_thread);</span>
<a href="#l85.355"></a><span id="l85.355" class="difflineplus">+</span>
<a href="#l85.356"></a><span id="l85.356" class="difflineplus">+  // - now, make sure creating a sync statement does trigger our guard.</span>
<a href="#l85.357"></a><span id="l85.357" class="difflineplus">+  // (If this doesn't happen, our test is bunk and it's important to know that.)</span>
<a href="#l85.358"></a><span id="l85.358" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; syncStmt;</span>
<a href="#l85.359"></a><span id="l85.359" class="difflineplus">+  db-&gt;CreateStatement(NS_LITERAL_CSTRING(&quot;SELECT * FROM test&quot;),</span>
<a href="#l85.360"></a><span id="l85.360" class="difflineplus">+                      getter_AddRefs(syncStmt));</span>
<a href="#l85.361"></a><span id="l85.361" class="difflineplus">+  syncStmt-&gt;Finalize();</span>
<a href="#l85.362"></a><span id="l85.362" class="difflineplus">+  do_check_true(mutex_used_on_watched_thread);</span>
<a href="#l85.363"></a><span id="l85.363" class="difflineplus">+</span>
<a href="#l85.364"></a><span id="l85.364" class="difflineplus">+  blocking_async_close(db);</span>
<a href="#l85.365"></a><span id="l85.365" class="difflineplus">+}</span>
<a href="#l85.366"></a><span id="l85.366" class="difflineplus">+</span>
<a href="#l85.367"></a><span id="l85.367" class="difflineplus">+/**</span>
<a href="#l85.368"></a><span id="l85.368" class="difflineplus">+ * Test that cancellation before a statement is run successfully stops the</span>
<a href="#l85.369"></a><span id="l85.369" class="difflineplus">+ * statement from executing.</span>
<a href="#l85.370"></a><span id="l85.370" class="difflineplus">+ */</span>
<a href="#l85.371"></a><span id="l85.371" class="difflineplus">+void</span>
<a href="#l85.372"></a><span id="l85.372" class="difflineplus">+test_AsyncCancellation()</span>
<a href="#l85.373"></a><span id="l85.373" class="difflineplus">+{</span>
<a href="#l85.374"></a><span id="l85.374" class="difflineplus">+  nsCOMPtr&lt;mozIStorageConnection&gt; db(getMemoryDatabase());</span>
<a href="#l85.375"></a><span id="l85.375" class="difflineplus">+</span>
<a href="#l85.376"></a><span id="l85.376" class="difflineplus">+  // -- wedge the thread</span>
<a href="#l85.377"></a><span id="l85.377" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; target(get_conn_async_thread(db));</span>
<a href="#l85.378"></a><span id="l85.378" class="difflineplus">+  do_check_true(target);</span>
<a href="#l85.379"></a><span id="l85.379" class="difflineplus">+  nsRefPtr&lt;ThreadWedger&gt; wedger (new ThreadWedger(target));</span>
<a href="#l85.380"></a><span id="l85.380" class="difflineplus">+</span>
<a href="#l85.381"></a><span id="l85.381" class="difflineplus">+  // -- create statements and cancel them</span>
<a href="#l85.382"></a><span id="l85.382" class="difflineplus">+  // - async</span>
<a href="#l85.383"></a><span id="l85.383" class="difflineplus">+  nsCOMPtr&lt;mozIStorageAsyncStatement&gt; asyncStmt;</span>
<a href="#l85.384"></a><span id="l85.384" class="difflineplus">+  db-&gt;CreateAsyncStatement(</span>
<a href="#l85.385"></a><span id="l85.385" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;CREATE TABLE asyncTable (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l85.386"></a><span id="l85.386" class="difflineplus">+    getter_AddRefs(asyncStmt));</span>
<a href="#l85.387"></a><span id="l85.387" class="difflineplus">+</span>
<a href="#l85.388"></a><span id="l85.388" class="difflineplus">+  nsRefPtr&lt;AsyncStatementSpinner&gt; asyncSpin(new AsyncStatementSpinner());</span>
<a href="#l85.389"></a><span id="l85.389" class="difflineplus">+  nsCOMPtr&lt;mozIStoragePendingStatement&gt; asyncPend;</span>
<a href="#l85.390"></a><span id="l85.390" class="difflineplus">+  (void)asyncStmt-&gt;ExecuteAsync(asyncSpin, getter_AddRefs(asyncPend));</span>
<a href="#l85.391"></a><span id="l85.391" class="difflineplus">+  do_check_true(asyncPend);</span>
<a href="#l85.392"></a><span id="l85.392" class="difflineplus">+  asyncPend-&gt;Cancel();</span>
<a href="#l85.393"></a><span id="l85.393" class="difflineplus">+</span>
<a href="#l85.394"></a><span id="l85.394" class="difflineplus">+  // - sync</span>
<a href="#l85.395"></a><span id="l85.395" class="difflineplus">+  nsCOMPtr&lt;mozIStorageStatement&gt; syncStmt;</span>
<a href="#l85.396"></a><span id="l85.396" class="difflineplus">+  db-&gt;CreateStatement(</span>
<a href="#l85.397"></a><span id="l85.397" class="difflineplus">+    NS_LITERAL_CSTRING(&quot;CREATE TABLE syncTable (id INTEGER PRIMARY KEY)&quot;),</span>
<a href="#l85.398"></a><span id="l85.398" class="difflineplus">+    getter_AddRefs(syncStmt));</span>
<a href="#l85.399"></a><span id="l85.399" class="difflineplus">+</span>
<a href="#l85.400"></a><span id="l85.400" class="difflineplus">+  nsRefPtr&lt;AsyncStatementSpinner&gt; syncSpin(new AsyncStatementSpinner());</span>
<a href="#l85.401"></a><span id="l85.401" class="difflineplus">+  nsCOMPtr&lt;mozIStoragePendingStatement&gt; syncPend;</span>
<a href="#l85.402"></a><span id="l85.402" class="difflineplus">+  (void)syncStmt-&gt;ExecuteAsync(syncSpin, getter_AddRefs(syncPend));</span>
<a href="#l85.403"></a><span id="l85.403" class="difflineplus">+  do_check_true(syncPend);</span>
<a href="#l85.404"></a><span id="l85.404" class="difflineplus">+  syncPend-&gt;Cancel();</span>
<a href="#l85.405"></a><span id="l85.405" class="difflineplus">+</span>
<a href="#l85.406"></a><span id="l85.406" class="difflineplus">+  // -- unwedge the async thread</span>
<a href="#l85.407"></a><span id="l85.407" class="difflineplus">+  wedger-&gt;unwedge();</span>
<a href="#l85.408"></a><span id="l85.408" class="difflineplus">+</span>
<a href="#l85.409"></a><span id="l85.409" class="difflineplus">+  // -- verify that both statements report they were canceled</span>
<a href="#l85.410"></a><span id="l85.410" class="difflineplus">+  asyncSpin-&gt;SpinUntilCompleted();</span>
<a href="#l85.411"></a><span id="l85.411" class="difflineplus">+  do_check_true(asyncSpin-&gt;completionReason ==</span>
<a href="#l85.412"></a><span id="l85.412" class="difflineplus">+                mozIStorageStatementCallback::REASON_CANCELED);</span>
<a href="#l85.413"></a><span id="l85.413" class="difflineplus">+</span>
<a href="#l85.414"></a><span id="l85.414" class="difflineplus">+  syncSpin-&gt;SpinUntilCompleted();</span>
<a href="#l85.415"></a><span id="l85.415" class="difflineplus">+  do_check_true(syncSpin-&gt;completionReason ==</span>
<a href="#l85.416"></a><span id="l85.416" class="difflineplus">+                mozIStorageStatementCallback::REASON_CANCELED);</span>
<a href="#l85.417"></a><span id="l85.417" class="difflineplus">+</span>
<a href="#l85.418"></a><span id="l85.418" class="difflineplus">+  // -- verify that neither statement constructed their tables</span>
<a href="#l85.419"></a><span id="l85.419" class="difflineplus">+  nsresult rv;</span>
<a href="#l85.420"></a><span id="l85.420" class="difflineplus">+  PRBool exists;</span>
<a href="#l85.421"></a><span id="l85.421" class="difflineplus">+  rv = db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;asyncTable&quot;), &amp;exists);</span>
<a href="#l85.422"></a><span id="l85.422" class="difflineplus">+  do_check_true(rv == NS_OK);</span>
<a href="#l85.423"></a><span id="l85.423" class="difflineplus">+  do_check_false(exists);</span>
<a href="#l85.424"></a><span id="l85.424" class="difflineplus">+  rv = db-&gt;TableExists(NS_LITERAL_CSTRING(&quot;syncTable&quot;), &amp;exists);</span>
<a href="#l85.425"></a><span id="l85.425" class="difflineplus">+  do_check_true(rv == NS_OK);</span>
<a href="#l85.426"></a><span id="l85.426" class="difflineplus">+  do_check_false(exists);</span>
<a href="#l85.427"></a><span id="l85.427" class="difflineplus">+</span>
<a href="#l85.428"></a><span id="l85.428" class="difflineplus">+  // -- cleanup</span>
<a href="#l85.429"></a><span id="l85.429" class="difflineplus">+  asyncStmt-&gt;Finalize();</span>
<a href="#l85.430"></a><span id="l85.430" class="difflineplus">+  syncStmt-&gt;Finalize();</span>
<a href="#l85.431"></a><span id="l85.431" class="difflineplus">+  blocking_async_close(db);</span>
<a href="#l85.432"></a><span id="l85.432" class="difflineplus">+}</span>
<a href="#l85.433"></a><span id="l85.433" class="difflineplus">+</span>
<a href="#l85.434"></a><span id="l85.434" class="difflineplus">+void (*gTests[])(void) = {</span>
<a href="#l85.435"></a><span id="l85.435" class="difflineplus">+  // this test must be first because it hooks the mutex mechanics</span>
<a href="#l85.436"></a><span id="l85.436" class="difflineplus">+  test_TrueAsyncStatement,</span>
<a href="#l85.437"></a><span id="l85.437" class="difflineplus">+  test_AsyncCancellation,</span>
<a href="#l85.438"></a><span id="l85.438" class="difflineplus">+};</span>
<a href="#l85.439"></a><span id="l85.439" class="difflineplus">+</span>
<a href="#l85.440"></a><span id="l85.440" class="difflineplus">+const char *file = __FILE__;</span>
<a href="#l85.441"></a><span id="l85.441" class="difflineplus">+#define TEST_NAME &quot;true async statement&quot;</span>
<a href="#l85.442"></a><span id="l85.442" class="difflineplus">+#define TEST_FILE file</span>
<a href="#l85.443"></a><span id="l85.443" class="difflineplus">+#include &quot;storage_test_harness_tail.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">new file mode 100644</span>
<a href="#l86.2"></a><span id="l86.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..b234246cac90b17d43d3955156d94276b7e3b503</span>
<a href="#l86.3"></a><span id="l86.3">GIT binary patch
literal 32772
zc%1Fm+i%)d90zdYq?C4JZF&lt;Y@J1&lt;k0312Y85TvRl#fh?#EMtz=R*|X``v8_Ow(Nr-
z+g_qc`$x97N&amp;92^x~D!(+CQ+@{RlX1wkfTmX;Q22NBKg|g&gt;x}F2EP8P9Z12tQ4(^=
zDx7m=QOV_$dyFXxvy_=d$|scK{QpdjQczw&amp;aXyN=_bR&gt;N4Uqd~`S$JHk5?o=7&gt;F?X
z_K6&gt;jhl7aw&gt;8XNxzvDDrhq=x5w!=;}vCjgZZSA&lt;urqf}&amp;ovrO==Mj70JSwpv4+V3b
zhi-|b(J1k&lt;g5*h0$gG7*(haERe2fwkL;rLI^^q?W6VVk(B9i$CVkiT7xYf!=7h$~1
zWq)4uMoF@MC`Ed*#+@%+wzJo6vzD{b+-tkcEU}PJUeZY`Q!iSTdl+Z?i02FOn{hk{
zJT8N1_&gt;U&amp;&lt;xc02M`A9|`k&amp;d44_+PrMOwXp8`(9C3=mE~*k8{8B==1!Nvf|y%=P#wj
zqN)~)g#w*{U@+iX+1BG&gt;uP&lt;esHVorn)H|-$=goSQ^o-M8yTL$EPh+F;w+3bL-qY`X
zd;0kJ`PmXXbIi0Kjh|49?)8GZfq$oJ+SRqH+EQCTxEF3HTSsA&lt;&amp;*zSokBZ*H!kz6x
z;hSJcM&gt;c)9t36m&gt;vrN0bs!i&amp;)=Ire0Vj`w&lt;(Nx)?*2BO{qBQDC-HXDLYQr`v1~+W_
z0IJn}Pb+unp~^)?&lt;NkrInO3d4+U@#fuWT7-&amp;zD^Ur(v|R8_7#vLYIaA^k@0^&gt;GRK&lt;
zSAV@YU-Ni8)~72S^F+j4di~=ir-BYX-4={VJf01!jp9_qrmba7dS8ZvPc5rftyF5f
z&gt;iO2%s%MuQb+b~VYNK2+t$Nio-2SM&lt;EQ@_H8Zyf?ZD!URW~E`)+2*$EH1&lt;z6uz&amp;Uj
zu0N~OAAf$YFd|P1siiUzJiOo7-%X-k!b7$}7bo4{p1s&gt;tqI*d+`40~Q0KA?)rhG)X
zLb*&lt;PoAQn_`|5s;@)qSX&lt;pSjr&lt;*G9K?thVTgL0E{i?U34m+~IveaZ)v4=GC&amp;rp$gv
zOy|l|7AWffur~kz00000000000000000000000000000000000000000000000000
W000000000000000004k&lt;yZje$IAS{h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1">new file mode 100644</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineminus">--- /dev/null</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineplus">+++ b/storage-backport/test/unit/head_storage.js</span>
<a href="#l87.4"></a><span id="l87.4" class="difflineat">@@ -0,0 +1,263 @@</span>
<a href="#l87.5"></a><span id="l87.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l87.6"></a><span id="l87.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l87.7"></a><span id="l87.7" class="difflineplus">+ *</span>
<a href="#l87.8"></a><span id="l87.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l87.9"></a><span id="l87.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l87.10"></a><span id="l87.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l87.11"></a><span id="l87.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineplus">+ *</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l87.16"></a><span id="l87.16" class="difflineplus">+ * License.</span>
<a href="#l87.17"></a><span id="l87.17" class="difflineplus">+ *</span>
<a href="#l87.18"></a><span id="l87.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineplus">+ *</span>
<a href="#l87.20"></a><span id="l87.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l87.21"></a><span id="l87.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l87.22"></a><span id="l87.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l87.23"></a><span id="l87.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l87.24"></a><span id="l87.24" class="difflineplus">+ *</span>
<a href="#l87.25"></a><span id="l87.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l87.26"></a><span id="l87.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l87.27"></a><span id="l87.27" class="difflineplus">+ *</span>
<a href="#l87.28"></a><span id="l87.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l87.29"></a><span id="l87.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l87.30"></a><span id="l87.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l87.33"></a><span id="l87.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l87.34"></a><span id="l87.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l87.35"></a><span id="l87.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l87.36"></a><span id="l87.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l87.37"></a><span id="l87.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l87.38"></a><span id="l87.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineplus">+ *</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineplus">+</span>
<a href="#l87.42"></a><span id="l87.42" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineplus">+</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineplus">+do_get_profile();</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineplus">+var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;].</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineplus">+             getService(Ci.nsIProperties);</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineplus">+</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineplus">+function getTestDB()</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineplus">+{</span>
<a href="#l87.52"></a><span id="l87.52" class="difflineplus">+  var db = dirSvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l87.53"></a><span id="l87.53" class="difflineplus">+  db.append(&quot;test_storage.sqlite&quot;);</span>
<a href="#l87.54"></a><span id="l87.54" class="difflineplus">+  return db;</span>
<a href="#l87.55"></a><span id="l87.55" class="difflineplus">+}</span>
<a href="#l87.56"></a><span id="l87.56" class="difflineplus">+</span>
<a href="#l87.57"></a><span id="l87.57" class="difflineplus">+/**</span>
<a href="#l87.58"></a><span id="l87.58" class="difflineplus">+ * Obtains a corrupt database to test against.</span>
<a href="#l87.59"></a><span id="l87.59" class="difflineplus">+ */</span>
<a href="#l87.60"></a><span id="l87.60" class="difflineplus">+function getCorruptDB()</span>
<a href="#l87.61"></a><span id="l87.61" class="difflineplus">+{</span>
<a href="#l87.62"></a><span id="l87.62" class="difflineplus">+  return do_get_file(&quot;corruptDB.sqlite&quot;);</span>
<a href="#l87.63"></a><span id="l87.63" class="difflineplus">+}</span>
<a href="#l87.64"></a><span id="l87.64" class="difflineplus">+</span>
<a href="#l87.65"></a><span id="l87.65" class="difflineplus">+function cleanup()</span>
<a href="#l87.66"></a><span id="l87.66" class="difflineplus">+{</span>
<a href="#l87.67"></a><span id="l87.67" class="difflineplus">+  // close the connection</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineplus">+  print(&quot;*** Storage Tests: Trying to close!&quot;);</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineplus">+  getOpenedDatabase().close();</span>
<a href="#l87.70"></a><span id="l87.70" class="difflineplus">+</span>
<a href="#l87.71"></a><span id="l87.71" class="difflineplus">+  // we need to null out the database variable to get a new connection the next</span>
<a href="#l87.72"></a><span id="l87.72" class="difflineplus">+  // time getOpenedDatabase is called</span>
<a href="#l87.73"></a><span id="l87.73" class="difflineplus">+  gDBConn = null;</span>
<a href="#l87.74"></a><span id="l87.74" class="difflineplus">+</span>
<a href="#l87.75"></a><span id="l87.75" class="difflineplus">+  // removing test db</span>
<a href="#l87.76"></a><span id="l87.76" class="difflineplus">+  print(&quot;*** Storage Tests: Trying to remove file!&quot;);</span>
<a href="#l87.77"></a><span id="l87.77" class="difflineplus">+  var dbFile = getTestDB();</span>
<a href="#l87.78"></a><span id="l87.78" class="difflineplus">+  if (dbFile.exists())</span>
<a href="#l87.79"></a><span id="l87.79" class="difflineplus">+    try { dbFile.remove(false); } catch(e) { /* stupid windows box */ }</span>
<a href="#l87.80"></a><span id="l87.80" class="difflineplus">+}</span>
<a href="#l87.81"></a><span id="l87.81" class="difflineplus">+</span>
<a href="#l87.82"></a><span id="l87.82" class="difflineplus">+/**</span>
<a href="#l87.83"></a><span id="l87.83" class="difflineplus">+ * Use asyncClose to cleanup a connection.  Synchronous by means of internally</span>
<a href="#l87.84"></a><span id="l87.84" class="difflineplus">+ * spinning an event loop.</span>
<a href="#l87.85"></a><span id="l87.85" class="difflineplus">+ */</span>
<a href="#l87.86"></a><span id="l87.86" class="difflineplus">+function asyncCleanup()</span>
<a href="#l87.87"></a><span id="l87.87" class="difflineplus">+{</span>
<a href="#l87.88"></a><span id="l87.88" class="difflineplus">+  let closed = false;</span>
<a href="#l87.89"></a><span id="l87.89" class="difflineplus">+</span>
<a href="#l87.90"></a><span id="l87.90" class="difflineplus">+  // close the connection</span>
<a href="#l87.91"></a><span id="l87.91" class="difflineplus">+  print(&quot;*** Storage Tests: Trying to asyncClose!&quot;);</span>
<a href="#l87.92"></a><span id="l87.92" class="difflineplus">+  getOpenedDatabase().asyncClose(function() { closed = true; });</span>
<a href="#l87.93"></a><span id="l87.93" class="difflineplus">+</span>
<a href="#l87.94"></a><span id="l87.94" class="difflineplus">+  let curThread = Components.classes[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l87.95"></a><span id="l87.95" class="difflineplus">+                            .getService().currentThread;</span>
<a href="#l87.96"></a><span id="l87.96" class="difflineplus">+  while (!closed)</span>
<a href="#l87.97"></a><span id="l87.97" class="difflineplus">+    curThread.processNextEvent(true);</span>
<a href="#l87.98"></a><span id="l87.98" class="difflineplus">+</span>
<a href="#l87.99"></a><span id="l87.99" class="difflineplus">+  // we need to null out the database variable to get a new connection the next</span>
<a href="#l87.100"></a><span id="l87.100" class="difflineplus">+  // time getOpenedDatabase is called</span>
<a href="#l87.101"></a><span id="l87.101" class="difflineplus">+  gDBConn = null;</span>
<a href="#l87.102"></a><span id="l87.102" class="difflineplus">+</span>
<a href="#l87.103"></a><span id="l87.103" class="difflineplus">+  // removing test db</span>
<a href="#l87.104"></a><span id="l87.104" class="difflineplus">+  print(&quot;*** Storage Tests: Trying to remove file!&quot;);</span>
<a href="#l87.105"></a><span id="l87.105" class="difflineplus">+  var dbFile = getTestDB();</span>
<a href="#l87.106"></a><span id="l87.106" class="difflineplus">+  if (dbFile.exists())</span>
<a href="#l87.107"></a><span id="l87.107" class="difflineplus">+    try { dbFile.remove(false); } catch(e) { /* stupid windows box */ }</span>
<a href="#l87.108"></a><span id="l87.108" class="difflineplus">+}</span>
<a href="#l87.109"></a><span id="l87.109" class="difflineplus">+</span>
<a href="#l87.110"></a><span id="l87.110" class="difflineplus">+function getService()</span>
<a href="#l87.111"></a><span id="l87.111" class="difflineplus">+{</span>
<a href="#l87.112"></a><span id="l87.112" class="difflineplus">+  return Cc[&quot;@mozilla.org/storage/service;1&quot;].getService(Ci.mozIStorageService);</span>
<a href="#l87.113"></a><span id="l87.113" class="difflineplus">+}</span>
<a href="#l87.114"></a><span id="l87.114" class="difflineplus">+</span>
<a href="#l87.115"></a><span id="l87.115" class="difflineplus">+var gDBConn = null;</span>
<a href="#l87.116"></a><span id="l87.116" class="difflineplus">+</span>
<a href="#l87.117"></a><span id="l87.117" class="difflineplus">+/**</span>
<a href="#l87.118"></a><span id="l87.118" class="difflineplus">+ * Get a connection to the test database.  Creates and caches the connection</span>
<a href="#l87.119"></a><span id="l87.119" class="difflineplus">+ * if necessary, otherwise reuses the existing cached connection.</span>
<a href="#l87.120"></a><span id="l87.120" class="difflineplus">+ *</span>
<a href="#l87.121"></a><span id="l87.121" class="difflineplus">+ * @param unshared {boolean}</span>
<a href="#l87.122"></a><span id="l87.122" class="difflineplus">+ *        whether or not to open a connection to the database that doesn't share</span>
<a href="#l87.123"></a><span id="l87.123" class="difflineplus">+ *        its cache; if true, we use mozIStorageService::openUnsharedDatabase</span>
<a href="#l87.124"></a><span id="l87.124" class="difflineplus">+ *        to create the connection; otherwise we use openDatabase.</span>
<a href="#l87.125"></a><span id="l87.125" class="difflineplus">+ * @returns the mozIStorageConnection for the file.</span>
<a href="#l87.126"></a><span id="l87.126" class="difflineplus">+ */</span>
<a href="#l87.127"></a><span id="l87.127" class="difflineplus">+function getOpenedDatabase(unshared)</span>
<a href="#l87.128"></a><span id="l87.128" class="difflineplus">+{</span>
<a href="#l87.129"></a><span id="l87.129" class="difflineplus">+  if (!gDBConn) {</span>
<a href="#l87.130"></a><span id="l87.130" class="difflineplus">+    gDBConn = getService()</span>
<a href="#l87.131"></a><span id="l87.131" class="difflineplus">+              [unshared ? &quot;openUnsharedDatabase&quot; : &quot;openDatabase&quot;]</span>
<a href="#l87.132"></a><span id="l87.132" class="difflineplus">+              (getTestDB());</span>
<a href="#l87.133"></a><span id="l87.133" class="difflineplus">+  }</span>
<a href="#l87.134"></a><span id="l87.134" class="difflineplus">+  return gDBConn;</span>
<a href="#l87.135"></a><span id="l87.135" class="difflineplus">+}</span>
<a href="#l87.136"></a><span id="l87.136" class="difflineplus">+</span>
<a href="#l87.137"></a><span id="l87.137" class="difflineplus">+/**</span>
<a href="#l87.138"></a><span id="l87.138" class="difflineplus">+ * Obtains a specific database to use.</span>
<a href="#l87.139"></a><span id="l87.139" class="difflineplus">+ *</span>
<a href="#l87.140"></a><span id="l87.140" class="difflineplus">+ * @param aFile</span>
<a href="#l87.141"></a><span id="l87.141" class="difflineplus">+ *        The nsIFile representing the db file to open.</span>
<a href="#l87.142"></a><span id="l87.142" class="difflineplus">+ * @returns the mozIStorageConnection for the file.</span>
<a href="#l87.143"></a><span id="l87.143" class="difflineplus">+ */</span>
<a href="#l87.144"></a><span id="l87.144" class="difflineplus">+function getDatabase(aFile)</span>
<a href="#l87.145"></a><span id="l87.145" class="difflineplus">+{</span>
<a href="#l87.146"></a><span id="l87.146" class="difflineplus">+  return getService().openDatabase(aFile);</span>
<a href="#l87.147"></a><span id="l87.147" class="difflineplus">+}</span>
<a href="#l87.148"></a><span id="l87.148" class="difflineplus">+</span>
<a href="#l87.149"></a><span id="l87.149" class="difflineplus">+function createStatement(aSQL)</span>
<a href="#l87.150"></a><span id="l87.150" class="difflineplus">+{</span>
<a href="#l87.151"></a><span id="l87.151" class="difflineplus">+  return getOpenedDatabase().createStatement(aSQL);</span>
<a href="#l87.152"></a><span id="l87.152" class="difflineplus">+}</span>
<a href="#l87.153"></a><span id="l87.153" class="difflineplus">+</span>
<a href="#l87.154"></a><span id="l87.154" class="difflineplus">+/**</span>
<a href="#l87.155"></a><span id="l87.155" class="difflineplus">+ * Invoke the given function and assert that it throws an exception expressing</span>
<a href="#l87.156"></a><span id="l87.156" class="difflineplus">+ * the provided error code in its 'result' attribute.  JS function expressions</span>
<a href="#l87.157"></a><span id="l87.157" class="difflineplus">+ * can be used to do this concisely.</span>
<a href="#l87.158"></a><span id="l87.158" class="difflineplus">+ *</span>
<a href="#l87.159"></a><span id="l87.159" class="difflineplus">+ * Example:</span>
<a href="#l87.160"></a><span id="l87.160" class="difflineplus">+ *  expectError(Cr.NS_ERROR_INVALID_ARG, function() explodingFunction());</span>
<a href="#l87.161"></a><span id="l87.161" class="difflineplus">+ *</span>
<a href="#l87.162"></a><span id="l87.162" class="difflineplus">+ * @param aErrorCode</span>
<a href="#l87.163"></a><span id="l87.163" class="difflineplus">+ *        The error code to expect from invocation of aFunction.</span>
<a href="#l87.164"></a><span id="l87.164" class="difflineplus">+ * @param aFunction</span>
<a href="#l87.165"></a><span id="l87.165" class="difflineplus">+ *        The function to invoke and expect an XPCOM-style error from.</span>
<a href="#l87.166"></a><span id="l87.166" class="difflineplus">+ */</span>
<a href="#l87.167"></a><span id="l87.167" class="difflineplus">+function expectError(aErrorCode, aFunction)</span>
<a href="#l87.168"></a><span id="l87.168" class="difflineplus">+{</span>
<a href="#l87.169"></a><span id="l87.169" class="difflineplus">+  let exceptionCaught = false;</span>
<a href="#l87.170"></a><span id="l87.170" class="difflineplus">+  try {</span>
<a href="#l87.171"></a><span id="l87.171" class="difflineplus">+    aFunction();</span>
<a href="#l87.172"></a><span id="l87.172" class="difflineplus">+  }</span>
<a href="#l87.173"></a><span id="l87.173" class="difflineplus">+  catch(e) {</span>
<a href="#l87.174"></a><span id="l87.174" class="difflineplus">+    if (e.result != aErrorCode) {</span>
<a href="#l87.175"></a><span id="l87.175" class="difflineplus">+      do_throw(&quot;Got an exception, but the result code was not the expected &quot; +</span>
<a href="#l87.176"></a><span id="l87.176" class="difflineplus">+               &quot;one.  Expected &quot; + aErrorCode + &quot;, got &quot; + e.result);</span>
<a href="#l87.177"></a><span id="l87.177" class="difflineplus">+    }</span>
<a href="#l87.178"></a><span id="l87.178" class="difflineplus">+    exceptionCaught = true;</span>
<a href="#l87.179"></a><span id="l87.179" class="difflineplus">+  }</span>
<a href="#l87.180"></a><span id="l87.180" class="difflineplus">+  if (!exceptionCaught)</span>
<a href="#l87.181"></a><span id="l87.181" class="difflineplus">+    do_throw(aFunction + &quot; should have thrown an exception but did not!&quot;);</span>
<a href="#l87.182"></a><span id="l87.182" class="difflineplus">+}</span>
<a href="#l87.183"></a><span id="l87.183" class="difflineplus">+</span>
<a href="#l87.184"></a><span id="l87.184" class="difflineplus">+/**</span>
<a href="#l87.185"></a><span id="l87.185" class="difflineplus">+ * Run a query synchronously and verify that we get back the expected results.</span>
<a href="#l87.186"></a><span id="l87.186" class="difflineplus">+ *</span>
<a href="#l87.187"></a><span id="l87.187" class="difflineplus">+ * @param aSQLString</span>
<a href="#l87.188"></a><span id="l87.188" class="difflineplus">+ *        The SQL string for the query.</span>
<a href="#l87.189"></a><span id="l87.189" class="difflineplus">+ * @param aBind</span>
<a href="#l87.190"></a><span id="l87.190" class="difflineplus">+ *        The value to bind at index 0.</span>
<a href="#l87.191"></a><span id="l87.191" class="difflineplus">+ * @param aResults</span>
<a href="#l87.192"></a><span id="l87.192" class="difflineplus">+ *        A list of the expected values returned in the sole result row.</span>
<a href="#l87.193"></a><span id="l87.193" class="difflineplus">+ *        Express blobs as lists.</span>
<a href="#l87.194"></a><span id="l87.194" class="difflineplus">+ */</span>
<a href="#l87.195"></a><span id="l87.195" class="difflineplus">+function verifyQuery(aSQLString, aBind, aResults)</span>
<a href="#l87.196"></a><span id="l87.196" class="difflineplus">+{</span>
<a href="#l87.197"></a><span id="l87.197" class="difflineplus">+  let stmt = getOpenedDatabase().createStatement(aSQLString);</span>
<a href="#l87.198"></a><span id="l87.198" class="difflineplus">+  stmt.bindByIndex(0, aBind);</span>
<a href="#l87.199"></a><span id="l87.199" class="difflineplus">+  try {</span>
<a href="#l87.200"></a><span id="l87.200" class="difflineplus">+    do_check_true(stmt.executeStep());</span>
<a href="#l87.201"></a><span id="l87.201" class="difflineplus">+    let nCols = stmt.numEntries;</span>
<a href="#l87.202"></a><span id="l87.202" class="difflineplus">+    if (aResults.length != nCols)</span>
<a href="#l87.203"></a><span id="l87.203" class="difflineplus">+      do_throw(&quot;Expected &quot; + aResults.length + &quot; columns in result but &quot; +</span>
<a href="#l87.204"></a><span id="l87.204" class="difflineplus">+               &quot;there are only &quot; + aResults.length + &quot;!&quot;);</span>
<a href="#l87.205"></a><span id="l87.205" class="difflineplus">+    for (let iCol = 0; iCol &lt; nCols; iCol++) {</span>
<a href="#l87.206"></a><span id="l87.206" class="difflineplus">+      let expectedVal = aResults[iCol];</span>
<a href="#l87.207"></a><span id="l87.207" class="difflineplus">+      let valType = stmt.getTypeOfIndex(iCol);</span>
<a href="#l87.208"></a><span id="l87.208" class="difflineplus">+      if (expectedVal === null) {</span>
<a href="#l87.209"></a><span id="l87.209" class="difflineplus">+        do_check_eq(stmt.VALUE_TYPE_NULL, valType);</span>
<a href="#l87.210"></a><span id="l87.210" class="difflineplus">+        do_check_true(stmt.getIsNull(iCol));</span>
<a href="#l87.211"></a><span id="l87.211" class="difflineplus">+      }</span>
<a href="#l87.212"></a><span id="l87.212" class="difflineplus">+      else if (typeof(expectedVal) == &quot;number&quot;) {</span>
<a href="#l87.213"></a><span id="l87.213" class="difflineplus">+        if (Math.floor(expectedVal) == expectedVal) {</span>
<a href="#l87.214"></a><span id="l87.214" class="difflineplus">+          do_check_eq(stmt.VALUE_TYPE_INTEGER, valType);</span>
<a href="#l87.215"></a><span id="l87.215" class="difflineplus">+          do_check_eq(expectedVal, stmt.getInt32(iCol));</span>
<a href="#l87.216"></a><span id="l87.216" class="difflineplus">+        }</span>
<a href="#l87.217"></a><span id="l87.217" class="difflineplus">+        else {</span>
<a href="#l87.218"></a><span id="l87.218" class="difflineplus">+          do_check_eq(stmt.VALUE_TYPE_FLOAT, valType);</span>
<a href="#l87.219"></a><span id="l87.219" class="difflineplus">+          do_check_eq(expectedVal, stmt.getDouble(iCol));</span>
<a href="#l87.220"></a><span id="l87.220" class="difflineplus">+        }</span>
<a href="#l87.221"></a><span id="l87.221" class="difflineplus">+      }</span>
<a href="#l87.222"></a><span id="l87.222" class="difflineplus">+      else if (typeof(expectedVal) == &quot;string&quot;) {</span>
<a href="#l87.223"></a><span id="l87.223" class="difflineplus">+        do_check_eq(stmt.VALUE_TYPE_TEXT, valType);</span>
<a href="#l87.224"></a><span id="l87.224" class="difflineplus">+        do_check_eq(expectedVal, stmt.getUTF8String(iCol));</span>
<a href="#l87.225"></a><span id="l87.225" class="difflineplus">+      }</span>
<a href="#l87.226"></a><span id="l87.226" class="difflineplus">+      else { // blob</span>
<a href="#l87.227"></a><span id="l87.227" class="difflineplus">+        do_check_eq(stmt.VALUE_TYPE_BLOB, valType);</span>
<a href="#l87.228"></a><span id="l87.228" class="difflineplus">+        let count = { value: 0 }, blob = { value: null };</span>
<a href="#l87.229"></a><span id="l87.229" class="difflineplus">+        stmt.getBlob(iCol, count, blob);</span>
<a href="#l87.230"></a><span id="l87.230" class="difflineplus">+        do_check_eq(count.value, expectedVal.length);</span>
<a href="#l87.231"></a><span id="l87.231" class="difflineplus">+        for (let i = 0; i &lt; count.value; i++) {</span>
<a href="#l87.232"></a><span id="l87.232" class="difflineplus">+          do_check_eq(expectedVal[i], blob.value[i]);</span>
<a href="#l87.233"></a><span id="l87.233" class="difflineplus">+        }</span>
<a href="#l87.234"></a><span id="l87.234" class="difflineplus">+      }</span>
<a href="#l87.235"></a><span id="l87.235" class="difflineplus">+    }</span>
<a href="#l87.236"></a><span id="l87.236" class="difflineplus">+  }</span>
<a href="#l87.237"></a><span id="l87.237" class="difflineplus">+  finally {</span>
<a href="#l87.238"></a><span id="l87.238" class="difflineplus">+    stmt.finalize();</span>
<a href="#l87.239"></a><span id="l87.239" class="difflineplus">+  }</span>
<a href="#l87.240"></a><span id="l87.240" class="difflineplus">+}</span>
<a href="#l87.241"></a><span id="l87.241" class="difflineplus">+</span>
<a href="#l87.242"></a><span id="l87.242" class="difflineplus">+/**</span>
<a href="#l87.243"></a><span id="l87.243" class="difflineplus">+ * Return the number of rows in the able with the given name using a synchronous</span>
<a href="#l87.244"></a><span id="l87.244" class="difflineplus">+ * query.</span>
<a href="#l87.245"></a><span id="l87.245" class="difflineplus">+ *</span>
<a href="#l87.246"></a><span id="l87.246" class="difflineplus">+ * @param aTableName</span>
<a href="#l87.247"></a><span id="l87.247" class="difflineplus">+ *        The name of the table.</span>
<a href="#l87.248"></a><span id="l87.248" class="difflineplus">+ * @return The number of rows.</span>
<a href="#l87.249"></a><span id="l87.249" class="difflineplus">+ */</span>
<a href="#l87.250"></a><span id="l87.250" class="difflineplus">+function getTableRowCount(aTableName)</span>
<a href="#l87.251"></a><span id="l87.251" class="difflineplus">+{</span>
<a href="#l87.252"></a><span id="l87.252" class="difflineplus">+  var currentRows = 0;</span>
<a href="#l87.253"></a><span id="l87.253" class="difflineplus">+  var countStmt = getOpenedDatabase().createStatement(</span>
<a href="#l87.254"></a><span id="l87.254" class="difflineplus">+    &quot;SELECT COUNT(1) AS count FROM &quot; + aTableName</span>
<a href="#l87.255"></a><span id="l87.255" class="difflineplus">+  );</span>
<a href="#l87.256"></a><span id="l87.256" class="difflineplus">+  try {</span>
<a href="#l87.257"></a><span id="l87.257" class="difflineplus">+    do_check_true(countStmt.executeStep());</span>
<a href="#l87.258"></a><span id="l87.258" class="difflineplus">+    currentRows = countStmt.row.count;</span>
<a href="#l87.259"></a><span id="l87.259" class="difflineplus">+  }</span>
<a href="#l87.260"></a><span id="l87.260" class="difflineplus">+  finally {</span>
<a href="#l87.261"></a><span id="l87.261" class="difflineplus">+    countStmt.finalize();</span>
<a href="#l87.262"></a><span id="l87.262" class="difflineplus">+  }</span>
<a href="#l87.263"></a><span id="l87.263" class="difflineplus">+  return currentRows;</span>
<a href="#l87.264"></a><span id="l87.264" class="difflineplus">+}</span>
<a href="#l87.265"></a><span id="l87.265" class="difflineplus">+</span>
<a href="#l87.266"></a><span id="l87.266" class="difflineplus">+cleanup();</span>
<a href="#l87.267"></a><span id="l87.267" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1">new file mode 100644</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineminus">--- /dev/null</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineplus">+++ b/storage-backport/test/unit/locale_collation.txt</span>
<a href="#l88.4"></a><span id="l88.4" class="difflineat">@@ -0,0 +1,174 @@</span>
<a href="#l88.5"></a><span id="l88.5" class="difflineplus">+ </span>
<a href="#l88.6"></a><span id="l88.6" class="difflineplus">+!</span>
<a href="#l88.7"></a><span id="l88.7" class="difflineplus">+&quot;</span>
<a href="#l88.8"></a><span id="l88.8" class="difflineplus">+#</span>
<a href="#l88.9"></a><span id="l88.9" class="difflineplus">+$</span>
<a href="#l88.10"></a><span id="l88.10" class="difflineplus">+%</span>
<a href="#l88.11"></a><span id="l88.11" class="difflineplus">+&amp;</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineplus">+'</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+(</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineplus">+)</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineplus">+*</span>
<a href="#l88.16"></a><span id="l88.16" class="difflineplus">++</span>
<a href="#l88.17"></a><span id="l88.17" class="difflineplus">+,</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineplus">+-</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineplus">+.</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineplus">+/</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineplus">+0</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineplus">+1</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineplus">+2</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineplus">+3</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineplus">+4</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineplus">+5</span>
<a href="#l88.27"></a><span id="l88.27" class="difflineplus">+6</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineplus">+7</span>
<a href="#l88.29"></a><span id="l88.29" class="difflineplus">+8</span>
<a href="#l88.30"></a><span id="l88.30" class="difflineplus">+9</span>
<a href="#l88.31"></a><span id="l88.31" class="difflineplus">+:</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineplus">+;</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineplus">+&lt;</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineplus">+=</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineplus">+&gt;</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineplus">+?</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+@</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineplus">+A</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineplus">+B</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineplus">+C</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineplus">+D</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineplus">+E</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineplus">+F</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineplus">+G</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+H</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+I</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineplus">+J</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineplus">+K</span>
<a href="#l88.49"></a><span id="l88.49" class="difflineplus">+L</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineplus">+M</span>
<a href="#l88.51"></a><span id="l88.51" class="difflineplus">+N</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineplus">+O</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineplus">+P</span>
<a href="#l88.54"></a><span id="l88.54" class="difflineplus">+Q</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineplus">+R</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineplus">+S</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineplus">+T</span>
<a href="#l88.58"></a><span id="l88.58" class="difflineplus">+U</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineplus">+V</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineplus">+W</span>
<a href="#l88.61"></a><span id="l88.61" class="difflineplus">+X</span>
<a href="#l88.62"></a><span id="l88.62" class="difflineplus">+Y</span>
<a href="#l88.63"></a><span id="l88.63" class="difflineplus">+Z</span>
<a href="#l88.64"></a><span id="l88.64" class="difflineplus">+[</span>
<a href="#l88.65"></a><span id="l88.65" class="difflineplus">+\</span>
<a href="#l88.66"></a><span id="l88.66" class="difflineplus">+]</span>
<a href="#l88.67"></a><span id="l88.67" class="difflineplus">+^</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineplus">+_</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineplus">+`</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineplus">+a</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineplus">+b</span>
<a href="#l88.72"></a><span id="l88.72" class="difflineplus">+c</span>
<a href="#l88.73"></a><span id="l88.73" class="difflineplus">+d</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineplus">+e</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineplus">+f</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineplus">+g</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineplus">+h</span>
<a href="#l88.78"></a><span id="l88.78" class="difflineplus">+i</span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+j</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+k</span>
<a href="#l88.81"></a><span id="l88.81" class="difflineplus">+l</span>
<a href="#l88.82"></a><span id="l88.82" class="difflineplus">+m</span>
<a href="#l88.83"></a><span id="l88.83" class="difflineplus">+n</span>
<a href="#l88.84"></a><span id="l88.84" class="difflineplus">+o</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineplus">+p</span>
<a href="#l88.86"></a><span id="l88.86" class="difflineplus">+q</span>
<a href="#l88.87"></a><span id="l88.87" class="difflineplus">+r</span>
<a href="#l88.88"></a><span id="l88.88" class="difflineplus">+s</span>
<a href="#l88.89"></a><span id="l88.89" class="difflineplus">+t</span>
<a href="#l88.90"></a><span id="l88.90" class="difflineplus">+u</span>
<a href="#l88.91"></a><span id="l88.91" class="difflineplus">+v</span>
<a href="#l88.92"></a><span id="l88.92" class="difflineplus">+w</span>
<a href="#l88.93"></a><span id="l88.93" class="difflineplus">+x</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineplus">+y</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineplus">+z</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+{</span>
<a href="#l88.97"></a><span id="l88.97" class="difflineplus">+|</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineplus">+}</span>
<a href="#l88.99"></a><span id="l88.99" class="difflineplus">+~</span>
<a href="#l88.100"></a><span id="l88.100" class="difflineplus">+ludwig van beethoven</span>
<a href="#l88.101"></a><span id="l88.101" class="difflineplus">+Ludwig van Beethoven</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineplus">+Ludwig van beethoven</span>
<a href="#l88.103"></a><span id="l88.103" class="difflineplus">+Jane</span>
<a href="#l88.104"></a><span id="l88.104" class="difflineplus">+jane</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineplus">+JANE</span>
<a href="#l88.106"></a><span id="l88.106" class="difflineplus">+jAne</span>
<a href="#l88.107"></a><span id="l88.107" class="difflineplus">+jaNe</span>
<a href="#l88.108"></a><span id="l88.108" class="difflineplus">+janE</span>
<a href="#l88.109"></a><span id="l88.109" class="difflineplus">+JAne</span>
<a href="#l88.110"></a><span id="l88.110" class="difflineplus">+JaNe</span>
<a href="#l88.111"></a><span id="l88.111" class="difflineplus">+JanE</span>
<a href="#l88.112"></a><span id="l88.112" class="difflineplus">+JANe</span>
<a href="#l88.113"></a><span id="l88.113" class="difflineplus">+JaNE</span>
<a href="#l88.114"></a><span id="l88.114" class="difflineplus">+JAnE</span>
<a href="#l88.115"></a><span id="l88.115" class="difflineplus">+jANE</span>
<a href="#l88.116"></a><span id="l88.116" class="difflineplus">+Umberto Eco</span>
<a href="#l88.117"></a><span id="l88.117" class="difflineplus">+Umberto eco</span>
<a href="#l88.118"></a><span id="l88.118" class="difflineplus">+umberto eco</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineplus">+umberto Eco</span>
<a href="#l88.120"></a><span id="l88.120" class="difflineplus">+UMBERTO ECO</span>
<a href="#l88.121"></a><span id="l88.121" class="difflineplus">+ace</span>
<a href="#l88.122"></a><span id="l88.122" class="difflineplus">+bash</span>
<a href="#l88.123"></a><span id="l88.123" class="difflineplus">+*ace</span>
<a href="#l88.124"></a><span id="l88.124" class="difflineplus">+!ace</span>
<a href="#l88.125"></a><span id="l88.125" class="difflineplus">+%ace</span>
<a href="#l88.126"></a><span id="l88.126" class="difflineplus">+~ace</span>
<a href="#l88.127"></a><span id="l88.127" class="difflineplus">+#ace</span>
<a href="#l88.128"></a><span id="l88.128" class="difflineplus">+cork</span>
<a href="#l88.129"></a><span id="l88.129" class="difflineplus">+denizen</span>
<a href="#l88.130"></a><span id="l88.130" class="difflineplus">+[denizen]</span>
<a href="#l88.131"></a><span id="l88.131" class="difflineplus">+(denizen)</span>
<a href="#l88.132"></a><span id="l88.132" class="difflineplus">+{denizen}</span>
<a href="#l88.133"></a><span id="l88.133" class="difflineplus">+/denizen/</span>
<a href="#l88.134"></a><span id="l88.134" class="difflineplus">+#denizen#</span>
<a href="#l88.135"></a><span id="l88.135" class="difflineplus">+$denizen$</span>
<a href="#l88.136"></a><span id="l88.136" class="difflineplus">+@denizen</span>
<a href="#l88.137"></a><span id="l88.137" class="difflineplus">+elf</span>
<a href="#l88.138"></a><span id="l88.138" class="difflineplus">+full</span>
<a href="#l88.139"></a><span id="l88.139" class="difflineplus">+gnome</span>
<a href="#l88.140"></a><span id="l88.140" class="difflineplus">+gnomic investigation of typological factors in the grammaticalization process of Malayo-Polynesian substaratum in the protoAltaic vocabulary core in the proto-layers of pre-historic Japanese</span>
<a href="#l88.141"></a><span id="l88.141" class="difflineplus">+gnomic investigation of typological factors in the grammaticalization process of Malayo-Polynesian substaratum in the protoAltaic vocabulary core in the proto-layers of pre-historic Javanese</span>
<a href="#l88.142"></a><span id="l88.142" class="difflineplus">+hint</span>
<a href="#l88.143"></a><span id="l88.143" class="difflineplus">+Internationalization</span>
<a href="#l88.144"></a><span id="l88.144" class="difflineplus">+Zinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalization</span>
<a href="#l88.145"></a><span id="l88.145" class="difflineplus">+Zinternationalization internationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizatio</span>
<a href="#l88.146"></a><span id="l88.146" class="difflineplus">+n</span>
<a href="#l88.147"></a><span id="l88.147" class="difflineplus">+Zinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalization internationalizationinternationalizationinternationalizationinternationalizationinternationalization</span>
<a href="#l88.148"></a><span id="l88.148" class="difflineplus">+ZinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizaTioninternationalizationinternationalizationinternationalizationinternationalization</span>
<a href="#l88.149"></a><span id="l88.149" class="difflineplus">+ZinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizationinternationalizaTion</span>
<a href="#l88.150"></a><span id="l88.150" class="difflineplus">+jostle</span>
<a href="#l88.151"></a><span id="l88.151" class="difflineplus">+kin</span>
<a href="#l88.152"></a><span id="l88.152" class="difflineplus">+Laymen</span>
<a href="#l88.153"></a><span id="l88.153" class="difflineplus">+lumens</span>
<a href="#l88.154"></a><span id="l88.154" class="difflineplus">+Lumens</span>
<a href="#l88.155"></a><span id="l88.155" class="difflineplus">+motleycrew</span>
<a href="#l88.156"></a><span id="l88.156" class="difflineplus">+motley crew</span>
<a href="#l88.157"></a><span id="l88.157" class="difflineplus">+niven's creative talents</span>
<a href="#l88.158"></a><span id="l88.158" class="difflineplus">+nivens creative talents</span>
<a href="#l88.159"></a><span id="l88.159" class="difflineplus">+opie</span>
<a href="#l88.160"></a><span id="l88.160" class="difflineplus">+posh restaurants in surbanized and still urban incorporated subsection of this beautifl city in the Rockies</span>
<a href="#l88.161"></a><span id="l88.161" class="difflineplus">+posh restaurants in surbanized and still urban incorporated subsection of this beautifl city in the Rokkies</span>
<a href="#l88.162"></a><span id="l88.162" class="difflineplus">+posh restaurants in surbanized and still urban incorporated subsection of this beautifl city in the rockies</span>
<a href="#l88.163"></a><span id="l88.163" class="difflineplus">+quilt's</span>
<a href="#l88.164"></a><span id="l88.164" class="difflineplus">+quilts</span>
<a href="#l88.165"></a><span id="l88.165" class="difflineplus">+quilt</span>
<a href="#l88.166"></a><span id="l88.166" class="difflineplus">+Rondo</span>
<a href="#l88.167"></a><span id="l88.167" class="difflineplus">+street</span>
<a href="#l88.168"></a><span id="l88.168" class="difflineplus">+tamale oxidization and iodization in rapid progress</span>
<a href="#l88.169"></a><span id="l88.169" class="difflineplus">+tamale oxidization and iodization in rapid Progress</span>
<a href="#l88.170"></a><span id="l88.170" class="difflineplus">+until</span>
<a href="#l88.171"></a><span id="l88.171" class="difflineplus">+vera</span>
<a href="#l88.172"></a><span id="l88.172" class="difflineplus">+Wobble</span>
<a href="#l88.173"></a><span id="l88.173" class="difflineplus">+Xanadu's legenary imaginary floccinaucinihilipilification in localization of theoretical portions of glottochronological understanding of the phoneme</span>
<a href="#l88.174"></a><span id="l88.174" class="difflineplus">+Xanadu's legenary imaginary floccinaucinihilipilification in localization of theoretical portions of glottochronological understanding of the phoname</span>
<a href="#l88.175"></a><span id="l88.175" class="difflineplus">+yearn</span>
<a href="#l88.176"></a><span id="l88.176" class="difflineplus">+zodiac</span>
<a href="#l88.177"></a><span id="l88.177" class="difflineplus">+a</span>
<a href="#l88.178"></a><span id="l88.178" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1">new file mode 100644</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineminus">--- /dev/null</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineplus">+++ b/storage-backport/test/unit/test_bug-365166.js</span>
<a href="#l89.4"></a><span id="l89.4" class="difflineat">@@ -0,0 +1,35 @@</span>
<a href="#l89.5"></a><span id="l89.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l89.6"></a><span id="l89.6" class="difflineplus">+ * http://creativecommons.org/licenses/publicdomain/  */ </span>
<a href="#l89.7"></a><span id="l89.7" class="difflineplus">+</span>
<a href="#l89.8"></a><span id="l89.8" class="difflineplus">+// Testcase for bug 365166 - crash [@ strlen] calling</span>
<a href="#l89.9"></a><span id="l89.9" class="difflineplus">+// mozIStorageStatement::getColumnName of a statement created with</span>
<a href="#l89.10"></a><span id="l89.10" class="difflineplus">+// &quot;PRAGMA user_version&quot; or &quot;PRAGMA schema_version&quot;</span>
<a href="#l89.11"></a><span id="l89.11" class="difflineplus">+function run_test() {</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineplus">+  test('user');</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+  test('schema');</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+  function test(param)</span>
<a href="#l89.16"></a><span id="l89.16" class="difflineplus">+  {</span>
<a href="#l89.17"></a><span id="l89.17" class="difflineplus">+    var colName = param + &quot;_version&quot;;</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineplus">+    var sql = &quot;PRAGMA &quot; + colName;</span>
<a href="#l89.19"></a><span id="l89.19" class="difflineplus">+</span>
<a href="#l89.20"></a><span id="l89.20" class="difflineplus">+    var file = getTestDB();</span>
<a href="#l89.21"></a><span id="l89.21" class="difflineplus">+    var storageService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;].</span>
<a href="#l89.22"></a><span id="l89.22" class="difflineplus">+                         getService(Components.interfaces.mozIStorageService);</span>
<a href="#l89.23"></a><span id="l89.23" class="difflineplus">+    var conn = storageService.openDatabase(file); </span>
<a href="#l89.24"></a><span id="l89.24" class="difflineplus">+    var statement = conn.createStatement(sql);</span>
<a href="#l89.25"></a><span id="l89.25" class="difflineplus">+    try {</span>
<a href="#l89.26"></a><span id="l89.26" class="difflineplus">+      // This shouldn't crash:</span>
<a href="#l89.27"></a><span id="l89.27" class="difflineplus">+      do_check_eq(statement.getColumnName(0), colName);</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineplus">+</span>
<a href="#l89.29"></a><span id="l89.29" class="difflineplus">+      // OK, if the above statement didn't crash, check that initializing a</span>
<a href="#l89.30"></a><span id="l89.30" class="difflineplus">+      // wrapper doesn't crash either:</span>
<a href="#l89.31"></a><span id="l89.31" class="difflineplus">+      var wrapper = Components.classes[&quot;@mozilla.org/storage/statement-wrapper;1&quot;]</span>
<a href="#l89.32"></a><span id="l89.32" class="difflineplus">+                              .createInstance(Components.interfaces.mozIStorageStatementWrapper);</span>
<a href="#l89.33"></a><span id="l89.33" class="difflineplus">+      wrapper.initialize(statement);</span>
<a href="#l89.34"></a><span id="l89.34" class="difflineplus">+    } finally {</span>
<a href="#l89.35"></a><span id="l89.35" class="difflineplus">+      statement.reset();</span>
<a href="#l89.36"></a><span id="l89.36" class="difflineplus">+      statement.finalize();</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineplus">+    }</span>
<a href="#l89.38"></a><span id="l89.38" class="difflineplus">+  }</span>
<a href="#l89.39"></a><span id="l89.39" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1">new file mode 100644</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineminus">--- /dev/null</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineplus">+++ b/storage-backport/test/unit/test_bug-393952.js</span>
<a href="#l90.4"></a><span id="l90.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l90.5"></a><span id="l90.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l90.6"></a><span id="l90.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l90.7"></a><span id="l90.7" class="difflineplus">+ *</span>
<a href="#l90.8"></a><span id="l90.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l90.9"></a><span id="l90.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l90.10"></a><span id="l90.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l90.11"></a><span id="l90.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineplus">+ *</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineplus">+ * License.</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineplus">+ *</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+ *</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l90.23"></a><span id="l90.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l90.24"></a><span id="l90.24" class="difflineplus">+ *</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineplus">+ * This code is based off of like.test from the sqlite code</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+ *</span>
<a href="#l90.27"></a><span id="l90.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@mozilla.org&gt; (Original Author)</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineplus">+ *</span>
<a href="#l90.30"></a><span id="l90.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l90.34"></a><span id="l90.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l90.35"></a><span id="l90.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l90.36"></a><span id="l90.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l90.37"></a><span id="l90.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l90.38"></a><span id="l90.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l90.39"></a><span id="l90.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l90.40"></a><span id="l90.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l90.41"></a><span id="l90.41" class="difflineplus">+ *</span>
<a href="#l90.42"></a><span id="l90.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l90.43"></a><span id="l90.43" class="difflineplus">+</span>
<a href="#l90.44"></a><span id="l90.44" class="difflineplus">+// Testcase for bug 393952:  crash when I try to VACUUM and one of the tables</span>
<a href="#l90.45"></a><span id="l90.45" class="difflineplus">+// has a UNIQUE text column.   StorageUnicodeFunctions::likeFunction() </span>
<a href="#l90.46"></a><span id="l90.46" class="difflineplus">+// needs to handle null aArgv[0] and aArgv[1]</span>
<a href="#l90.47"></a><span id="l90.47" class="difflineplus">+</span>
<a href="#l90.48"></a><span id="l90.48" class="difflineplus">+function setup()</span>
<a href="#l90.49"></a><span id="l90.49" class="difflineplus">+{</span>
<a href="#l90.50"></a><span id="l90.50" class="difflineplus">+  getOpenedDatabase().createTable(&quot;t1&quot;, &quot;x TEXT UNIQUE&quot;);</span>
<a href="#l90.51"></a><span id="l90.51" class="difflineplus">+</span>
<a href="#l90.52"></a><span id="l90.52" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('a')&quot;);</span>
<a href="#l90.53"></a><span id="l90.53" class="difflineplus">+  stmt.execute();</span>
<a href="#l90.54"></a><span id="l90.54" class="difflineplus">+  stmt.reset();</span>
<a href="#l90.55"></a><span id="l90.55" class="difflineplus">+  stmt.finalize();</span>
<a href="#l90.56"></a><span id="l90.56" class="difflineplus">+}</span>
<a href="#l90.57"></a><span id="l90.57" class="difflineplus">+</span>
<a href="#l90.58"></a><span id="l90.58" class="difflineplus">+function test_vacuum()</span>
<a href="#l90.59"></a><span id="l90.59" class="difflineplus">+{</span>
<a href="#l90.60"></a><span id="l90.60" class="difflineplus">+  var stmt = createStatement(&quot;VACUUM;&quot;);</span>
<a href="#l90.61"></a><span id="l90.61" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l90.62"></a><span id="l90.62" class="difflineplus">+  stmt.reset();</span>
<a href="#l90.63"></a><span id="l90.63" class="difflineplus">+  stmt.finalize();</span>
<a href="#l90.64"></a><span id="l90.64" class="difflineplus">+}</span>
<a href="#l90.65"></a><span id="l90.65" class="difflineplus">+</span>
<a href="#l90.66"></a><span id="l90.66" class="difflineplus">+var tests = [test_vacuum];</span>
<a href="#l90.67"></a><span id="l90.67" class="difflineplus">+</span>
<a href="#l90.68"></a><span id="l90.68" class="difflineplus">+function run_test()</span>
<a href="#l90.69"></a><span id="l90.69" class="difflineplus">+{</span>
<a href="#l90.70"></a><span id="l90.70" class="difflineplus">+  setup();</span>
<a href="#l90.71"></a><span id="l90.71" class="difflineplus">+</span>
<a href="#l90.72"></a><span id="l90.72" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l90.73"></a><span id="l90.73" class="difflineplus">+    tests[i]();</span>
<a href="#l90.74"></a><span id="l90.74" class="difflineplus">+    </span>
<a href="#l90.75"></a><span id="l90.75" class="difflineplus">+  cleanup();</span>
<a href="#l90.76"></a><span id="l90.76" class="difflineplus">+}</span>
<a href="#l90.77"></a><span id="l90.77" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1">new file mode 100644</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineminus">--- /dev/null</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineplus">+++ b/storage-backport/test/unit/test_bug-429521.js</span>
<a href="#l91.4"></a><span id="l91.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l91.5"></a><span id="l91.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l91.6"></a><span id="l91.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l91.7"></a><span id="l91.7" class="difflineplus">+ *</span>
<a href="#l91.8"></a><span id="l91.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l91.9"></a><span id="l91.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l91.10"></a><span id="l91.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l91.11"></a><span id="l91.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineplus">+ *</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l91.16"></a><span id="l91.16" class="difflineplus">+ * License.</span>
<a href="#l91.17"></a><span id="l91.17" class="difflineplus">+ *</span>
<a href="#l91.18"></a><span id="l91.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l91.19"></a><span id="l91.19" class="difflineplus">+ *</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineplus">+ *   Stefan Sitter.</span>
<a href="#l91.22"></a><span id="l91.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l91.23"></a><span id="l91.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l91.24"></a><span id="l91.24" class="difflineplus">+ *</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineplus">+ * This code is based off of like.test from the sqlite code</span>
<a href="#l91.26"></a><span id="l91.26" class="difflineplus">+ *</span>
<a href="#l91.27"></a><span id="l91.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineplus">+ *   Stefan Sitter &lt;ssitter@gmail.com&gt; (Original Author)</span>
<a href="#l91.29"></a><span id="l91.29" class="difflineplus">+ *</span>
<a href="#l91.30"></a><span id="l91.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l91.31"></a><span id="l91.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineplus">+ *</span>
<a href="#l91.42"></a><span id="l91.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l91.43"></a><span id="l91.43" class="difflineplus">+</span>
<a href="#l91.44"></a><span id="l91.44" class="difflineplus">+function createStatementWrapper(aSQL) </span>
<a href="#l91.45"></a><span id="l91.45" class="difflineplus">+{</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineplus">+    var stmt = getOpenedDatabase().createStatement(aSQL);</span>
<a href="#l91.47"></a><span id="l91.47" class="difflineplus">+    var wrapper = Components.Constructor(&quot;@mozilla.org/storage/statement-wrapper;1&quot;, Ci.mozIStorageStatementWrapper)();</span>
<a href="#l91.48"></a><span id="l91.48" class="difflineplus">+    wrapper.initialize(stmt);</span>
<a href="#l91.49"></a><span id="l91.49" class="difflineplus">+    return wrapper;</span>
<a href="#l91.50"></a><span id="l91.50" class="difflineplus">+}</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineplus">+</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineplus">+function setup() </span>
<a href="#l91.53"></a><span id="l91.53" class="difflineplus">+{</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineplus">+    getOpenedDatabase().createTable(&quot;t1&quot;, &quot;x TEXT&quot;);</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+    var stmt = getOpenedDatabase().createStatement(&quot;INSERT INTO t1 (x) VALUES ('/mozilla.org/20070129_1/Europe/Berlin')&quot;);</span>
<a href="#l91.57"></a><span id="l91.57" class="difflineplus">+    stmt.execute();</span>
<a href="#l91.58"></a><span id="l91.58" class="difflineplus">+    stmt.finalize();</span>
<a href="#l91.59"></a><span id="l91.59" class="difflineplus">+}</span>
<a href="#l91.60"></a><span id="l91.60" class="difflineplus">+</span>
<a href="#l91.61"></a><span id="l91.61" class="difflineplus">+function test_bug429521() </span>
<a href="#l91.62"></a><span id="l91.62" class="difflineplus">+{</span>
<a href="#l91.63"></a><span id="l91.63" class="difflineplus">+    var wrapper = createStatementWrapper(</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineplus">+        &quot;SELECT DISTINCT(zone) FROM (&quot;+</span>
<a href="#l91.65"></a><span id="l91.65" class="difflineplus">+            &quot;SELECT x AS zone FROM t1 WHERE x LIKE '/mozilla.org%'&quot; +</span>
<a href="#l91.66"></a><span id="l91.66" class="difflineplus">+        &quot;);&quot;);</span>
<a href="#l91.67"></a><span id="l91.67" class="difflineplus">+</span>
<a href="#l91.68"></a><span id="l91.68" class="difflineplus">+    print(&quot;*** test_bug429521: started&quot;);</span>
<a href="#l91.69"></a><span id="l91.69" class="difflineplus">+</span>
<a href="#l91.70"></a><span id="l91.70" class="difflineplus">+    try {</span>
<a href="#l91.71"></a><span id="l91.71" class="difflineplus">+        while (wrapper.step()) {</span>
<a href="#l91.72"></a><span id="l91.72" class="difflineplus">+            print(&quot;*** test_bug429521: step() Read wrapper.row.zone&quot;);</span>
<a href="#l91.73"></a><span id="l91.73" class="difflineplus">+</span>
<a href="#l91.74"></a><span id="l91.74" class="difflineplus">+            // BUG: the print commands after the following statement</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineplus">+            // are never executed. Script stops immediately.</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineplus">+            var tzId = wrapper.row.zone;</span>
<a href="#l91.77"></a><span id="l91.77" class="difflineplus">+</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineplus">+            print(&quot;*** test_bug429521: step() Read wrapper.row.zone finished&quot;);</span>
<a href="#l91.79"></a><span id="l91.79" class="difflineplus">+        }</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineplus">+    } catch (e) {</span>
<a href="#l91.81"></a><span id="l91.81" class="difflineplus">+        print(&quot;*** test_bug429521: &quot; + e);</span>
<a href="#l91.82"></a><span id="l91.82" class="difflineplus">+    }</span>
<a href="#l91.83"></a><span id="l91.83" class="difflineplus">+</span>
<a href="#l91.84"></a><span id="l91.84" class="difflineplus">+    print(&quot;*** test_bug429521: finished&quot;);</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineplus">+</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineplus">+    wrapper.statement.finalize();</span>
<a href="#l91.87"></a><span id="l91.87" class="difflineplus">+}</span>
<a href="#l91.88"></a><span id="l91.88" class="difflineplus">+</span>
<a href="#l91.89"></a><span id="l91.89" class="difflineplus">+function run_test()</span>
<a href="#l91.90"></a><span id="l91.90" class="difflineplus">+{</span>
<a href="#l91.91"></a><span id="l91.91" class="difflineplus">+  setup();</span>
<a href="#l91.92"></a><span id="l91.92" class="difflineplus">+</span>
<a href="#l91.93"></a><span id="l91.93" class="difflineplus">+  test_bug429521();</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineplus">+    </span>
<a href="#l91.95"></a><span id="l91.95" class="difflineplus">+  cleanup();</span>
<a href="#l91.96"></a><span id="l91.96" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1">new file mode 100644</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineminus">--- /dev/null</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineplus">+++ b/storage-backport/test/unit/test_bug-444233.js</span>
<a href="#l92.4"></a><span id="l92.4" class="difflineat">@@ -0,0 +1,95 @@</span>
<a href="#l92.5"></a><span id="l92.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l92.6"></a><span id="l92.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l92.7"></a><span id="l92.7" class="difflineplus">+ *</span>
<a href="#l92.8"></a><span id="l92.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l92.9"></a><span id="l92.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l92.10"></a><span id="l92.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l92.11"></a><span id="l92.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineplus">+ *</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l92.15"></a><span id="l92.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l92.16"></a><span id="l92.16" class="difflineplus">+ * License.</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineplus">+ *</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineplus">+ *</span>
<a href="#l92.20"></a><span id="l92.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l92.21"></a><span id="l92.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l92.22"></a><span id="l92.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineplus">+ *</span>
<a href="#l92.25"></a><span id="l92.25" class="difflineplus">+ * This code is based off of like.test from the sqlite code</span>
<a href="#l92.26"></a><span id="l92.26" class="difflineplus">+ *</span>
<a href="#l92.27"></a><span id="l92.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l92.28"></a><span id="l92.28" class="difflineplus">+ *   Paul O'Shannessy &lt;poshannessy@mozilla.com&gt;</span>
<a href="#l92.29"></a><span id="l92.29" class="difflineplus">+ *</span>
<a href="#l92.30"></a><span id="l92.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l92.31"></a><span id="l92.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l92.33"></a><span id="l92.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l92.34"></a><span id="l92.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l92.35"></a><span id="l92.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l92.36"></a><span id="l92.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l92.39"></a><span id="l92.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l92.40"></a><span id="l92.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l92.41"></a><span id="l92.41" class="difflineplus">+ *</span>
<a href="#l92.42"></a><span id="l92.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l92.43"></a><span id="l92.43" class="difflineplus">+</span>
<a href="#l92.44"></a><span id="l92.44" class="difflineplus">+// copy from test_storage_statement_wrapper.js</span>
<a href="#l92.45"></a><span id="l92.45" class="difflineplus">+var wrapper = new Components.Constructor(&quot;@mozilla.org/storage/statement-wrapper;1&quot;,</span>
<a href="#l92.46"></a><span id="l92.46" class="difflineplus">+                                         Ci.mozIStorageStatementWrapper,</span>
<a href="#l92.47"></a><span id="l92.47" class="difflineplus">+                                         &quot;initialize&quot;);</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineplus">+// we want to override the default function for this file</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineplus">+createStatement = function(aSQL) {</span>
<a href="#l92.50"></a><span id="l92.50" class="difflineplus">+    return new wrapper(getOpenedDatabase().createStatement(aSQL));</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineplus">+}</span>
<a href="#l92.52"></a><span id="l92.52" class="difflineplus">+</span>
<a href="#l92.53"></a><span id="l92.53" class="difflineplus">+function setup() {</span>
<a href="#l92.54"></a><span id="l92.54" class="difflineplus">+    // Create the table</span>
<a href="#l92.55"></a><span id="l92.55" class="difflineplus">+    getOpenedDatabase().createTable(&quot;test_bug444233&quot;,</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineplus">+                                    &quot;id INTEGER PRIMARY KEY, value TEXT&quot;);</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineplus">+</span>
<a href="#l92.58"></a><span id="l92.58" class="difflineplus">+    // Insert dummy data, using wrapper methods</span>
<a href="#l92.59"></a><span id="l92.59" class="difflineplus">+    var stmt = createStatement(&quot;INSERT INTO test_bug444233 (value) VALUES (:value)&quot;);</span>
<a href="#l92.60"></a><span id="l92.60" class="difflineplus">+    stmt.params.value = &quot;value1&quot;</span>
<a href="#l92.61"></a><span id="l92.61" class="difflineplus">+    stmt.execute();</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineplus">+    stmt.statement.finalize();</span>
<a href="#l92.63"></a><span id="l92.63" class="difflineplus">+    </span>
<a href="#l92.64"></a><span id="l92.64" class="difflineplus">+    stmt = createStatement(&quot;INSERT INTO test_bug444233 (value) VALUES (:value)&quot;);</span>
<a href="#l92.65"></a><span id="l92.65" class="difflineplus">+    stmt.params.value = &quot;value2&quot;</span>
<a href="#l92.66"></a><span id="l92.66" class="difflineplus">+    stmt.execute();</span>
<a href="#l92.67"></a><span id="l92.67" class="difflineplus">+    stmt.statement.finalize();</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineplus">+}</span>
<a href="#l92.69"></a><span id="l92.69" class="difflineplus">+</span>
<a href="#l92.70"></a><span id="l92.70" class="difflineplus">+function test_bug444233() {</span>
<a href="#l92.71"></a><span id="l92.71" class="difflineplus">+    print(&quot;*** test_bug444233: started&quot;);</span>
<a href="#l92.72"></a><span id="l92.72" class="difflineplus">+    </span>
<a href="#l92.73"></a><span id="l92.73" class="difflineplus">+    // Check that there are 2 results</span>
<a href="#l92.74"></a><span id="l92.74" class="difflineplus">+    var stmt = createStatement(&quot;SELECT COUNT(*) AS number FROM test_bug444233&quot;);</span>
<a href="#l92.75"></a><span id="l92.75" class="difflineplus">+    do_check_true(stmt.step());</span>
<a href="#l92.76"></a><span id="l92.76" class="difflineplus">+    do_check_eq(2, stmt.row.number);</span>
<a href="#l92.77"></a><span id="l92.77" class="difflineplus">+    stmt.reset();</span>
<a href="#l92.78"></a><span id="l92.78" class="difflineplus">+    stmt.statement.finalize();</span>
<a href="#l92.79"></a><span id="l92.79" class="difflineplus">+</span>
<a href="#l92.80"></a><span id="l92.80" class="difflineplus">+    print(&quot;*** test_bug444233: doing delete&quot;);</span>
<a href="#l92.81"></a><span id="l92.81" class="difflineplus">+    </span>
<a href="#l92.82"></a><span id="l92.82" class="difflineplus">+    // Now try to delete using IN</span>
<a href="#l92.83"></a><span id="l92.83" class="difflineplus">+    // Cheating since we know ids are 1,2</span>
<a href="#l92.84"></a><span id="l92.84" class="difflineplus">+    try {</span>
<a href="#l92.85"></a><span id="l92.85" class="difflineplus">+        var ids = [1, 2];</span>
<a href="#l92.86"></a><span id="l92.86" class="difflineplus">+        stmt = createStatement(&quot;DELETE FROM test_bug444233 WHERE id IN (:ids)&quot;);</span>
<a href="#l92.87"></a><span id="l92.87" class="difflineplus">+        stmt.params.ids = ids;</span>
<a href="#l92.88"></a><span id="l92.88" class="difflineplus">+    } catch (e) {</span>
<a href="#l92.89"></a><span id="l92.89" class="difflineplus">+        print(&quot;*** test_bug444233: successfully caught exception&quot;);</span>
<a href="#l92.90"></a><span id="l92.90" class="difflineplus">+    }</span>
<a href="#l92.91"></a><span id="l92.91" class="difflineplus">+    stmt.statement.finalize();</span>
<a href="#l92.92"></a><span id="l92.92" class="difflineplus">+}</span>
<a href="#l92.93"></a><span id="l92.93" class="difflineplus">+</span>
<a href="#l92.94"></a><span id="l92.94" class="difflineplus">+function run_test() {</span>
<a href="#l92.95"></a><span id="l92.95" class="difflineplus">+    setup();</span>
<a href="#l92.96"></a><span id="l92.96" class="difflineplus">+    test_bug444233();</span>
<a href="#l92.97"></a><span id="l92.97" class="difflineplus">+    cleanup();</span>
<a href="#l92.98"></a><span id="l92.98" class="difflineplus">+}</span>
<a href="#l92.99"></a><span id="l92.99" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1">new file mode 100644</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineminus">--- /dev/null</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineplus">+++ b/storage-backport/test/unit/test_connection_executeAsync.js</span>
<a href="#l93.4"></a><span id="l93.4" class="difflineat">@@ -0,0 +1,350 @@</span>
<a href="#l93.5"></a><span id="l93.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l93.6"></a><span id="l93.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l93.7"></a><span id="l93.7" class="difflineplus">+ *</span>
<a href="#l93.8"></a><span id="l93.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l93.9"></a><span id="l93.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l93.10"></a><span id="l93.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l93.11"></a><span id="l93.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineplus">+ *</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l93.15"></a><span id="l93.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l93.16"></a><span id="l93.16" class="difflineplus">+ * License.</span>
<a href="#l93.17"></a><span id="l93.17" class="difflineplus">+ *</span>
<a href="#l93.18"></a><span id="l93.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l93.19"></a><span id="l93.19" class="difflineplus">+ *</span>
<a href="#l93.20"></a><span id="l93.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineplus">+ *</span>
<a href="#l93.25"></a><span id="l93.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l93.26"></a><span id="l93.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l93.27"></a><span id="l93.27" class="difflineplus">+ *</span>
<a href="#l93.28"></a><span id="l93.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l93.29"></a><span id="l93.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l93.30"></a><span id="l93.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l93.31"></a><span id="l93.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l93.33"></a><span id="l93.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l93.34"></a><span id="l93.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l93.35"></a><span id="l93.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l93.36"></a><span id="l93.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l93.37"></a><span id="l93.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l93.38"></a><span id="l93.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l93.39"></a><span id="l93.39" class="difflineplus">+ *</span>
<a href="#l93.40"></a><span id="l93.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l93.41"></a><span id="l93.41" class="difflineplus">+</span>
<a href="#l93.42"></a><span id="l93.42" class="difflineplus">+/*</span>
<a href="#l93.43"></a><span id="l93.43" class="difflineplus">+ * This file tests the functionality of mozIStorageConnection::executeAsync for</span>
<a href="#l93.44"></a><span id="l93.44" class="difflineplus">+ * both mozIStorageStatement and mozIStorageAsyncStatement.</span>
<a href="#l93.45"></a><span id="l93.45" class="difflineplus">+ */</span>
<a href="#l93.46"></a><span id="l93.46" class="difflineplus">+</span>
<a href="#l93.47"></a><span id="l93.47" class="difflineplus">+const INTEGER = 1;</span>
<a href="#l93.48"></a><span id="l93.48" class="difflineplus">+const TEXT = &quot;this is test text&quot;;</span>
<a href="#l93.49"></a><span id="l93.49" class="difflineplus">+const REAL = 3.23;</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineplus">+const BLOB = [1, 2];</span>
<a href="#l93.51"></a><span id="l93.51" class="difflineplus">+</span>
<a href="#l93.52"></a><span id="l93.52" class="difflineplus">+function test_create_and_add()</span>
<a href="#l93.53"></a><span id="l93.53" class="difflineplus">+{</span>
<a href="#l93.54"></a><span id="l93.54" class="difflineplus">+  getOpenedDatabase().executeSimpleSQL(</span>
<a href="#l93.55"></a><span id="l93.55" class="difflineplus">+    &quot;CREATE TABLE test (&quot; +</span>
<a href="#l93.56"></a><span id="l93.56" class="difflineplus">+      &quot;id INTEGER, &quot; +</span>
<a href="#l93.57"></a><span id="l93.57" class="difflineplus">+      &quot;string TEXT, &quot; +</span>
<a href="#l93.58"></a><span id="l93.58" class="difflineplus">+      &quot;number REAL, &quot; +</span>
<a href="#l93.59"></a><span id="l93.59" class="difflineplus">+      &quot;nuller NULL, &quot; +</span>
<a href="#l93.60"></a><span id="l93.60" class="difflineplus">+      &quot;blober BLOB&quot; +</span>
<a href="#l93.61"></a><span id="l93.61" class="difflineplus">+    &quot;)&quot;</span>
<a href="#l93.62"></a><span id="l93.62" class="difflineplus">+  );</span>
<a href="#l93.63"></a><span id="l93.63" class="difflineplus">+</span>
<a href="#l93.64"></a><span id="l93.64" class="difflineplus">+  let stmts = [];</span>
<a href="#l93.65"></a><span id="l93.65" class="difflineplus">+  stmts[0] = getOpenedDatabase().createStatement(</span>
<a href="#l93.66"></a><span id="l93.66" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) VALUES (?, ?, ?, ?, ?)&quot;</span>
<a href="#l93.67"></a><span id="l93.67" class="difflineplus">+  );</span>
<a href="#l93.68"></a><span id="l93.68" class="difflineplus">+  stmts[0].bindInt32Parameter(0, INTEGER);</span>
<a href="#l93.69"></a><span id="l93.69" class="difflineplus">+  stmts[0].bindStringParameter(1, TEXT);</span>
<a href="#l93.70"></a><span id="l93.70" class="difflineplus">+  stmts[0].bindDoubleParameter(2, REAL);</span>
<a href="#l93.71"></a><span id="l93.71" class="difflineplus">+  stmts[0].bindNullParameter(3);</span>
<a href="#l93.72"></a><span id="l93.72" class="difflineplus">+  stmts[0].bindBlobParameter(4, BLOB, BLOB.length);</span>
<a href="#l93.73"></a><span id="l93.73" class="difflineplus">+  stmts[1] = getOpenedDatabase().createAsyncStatement(</span>
<a href="#l93.74"></a><span id="l93.74" class="difflineplus">+    &quot;INSERT INTO test (string, number, nuller, blober) VALUES (?, ?, ?, ?)&quot;</span>
<a href="#l93.75"></a><span id="l93.75" class="difflineplus">+  );</span>
<a href="#l93.76"></a><span id="l93.76" class="difflineplus">+  stmts[1].bindStringParameter(0, TEXT);</span>
<a href="#l93.77"></a><span id="l93.77" class="difflineplus">+  stmts[1].bindDoubleParameter(1, REAL);</span>
<a href="#l93.78"></a><span id="l93.78" class="difflineplus">+  stmts[1].bindNullParameter(2);</span>
<a href="#l93.79"></a><span id="l93.79" class="difflineplus">+  stmts[1].bindBlobParameter(3, BLOB, BLOB.length);</span>
<a href="#l93.80"></a><span id="l93.80" class="difflineplus">+</span>
<a href="#l93.81"></a><span id="l93.81" class="difflineplus">+  getOpenedDatabase().executeAsync(stmts, stmts.length, {</span>
<a href="#l93.82"></a><span id="l93.82" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l93.83"></a><span id="l93.83" class="difflineplus">+    {</span>
<a href="#l93.84"></a><span id="l93.84" class="difflineplus">+      dump(&quot;handleResult(&quot;+aResultSet+&quot;)\n&quot;);</span>
<a href="#l93.85"></a><span id="l93.85" class="difflineplus">+      do_throw(&quot;unexpected results obtained!&quot;);</span>
<a href="#l93.86"></a><span id="l93.86" class="difflineplus">+    },</span>
<a href="#l93.87"></a><span id="l93.87" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l93.88"></a><span id="l93.88" class="difflineplus">+    {</span>
<a href="#l93.89"></a><span id="l93.89" class="difflineplus">+      dump(&quot;handleError(&quot;+aError.result+&quot;)\n&quot;);</span>
<a href="#l93.90"></a><span id="l93.90" class="difflineplus">+      do_throw(&quot;unexpected error!&quot;);</span>
<a href="#l93.91"></a><span id="l93.91" class="difflineplus">+    },</span>
<a href="#l93.92"></a><span id="l93.92" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l93.93"></a><span id="l93.93" class="difflineplus">+    {</span>
<a href="#l93.94"></a><span id="l93.94" class="difflineplus">+      dump(&quot;handleCompletion(&quot;+aReason+&quot;)\n&quot;);</span>
<a href="#l93.95"></a><span id="l93.95" class="difflineplus">+      do_check_eq(Ci.mozIStorageStatementCallback.REASON_FINISHED, aReason);</span>
<a href="#l93.96"></a><span id="l93.96" class="difflineplus">+</span>
<a href="#l93.97"></a><span id="l93.97" class="difflineplus">+      // Check that the result is in the table</span>
<a href="#l93.98"></a><span id="l93.98" class="difflineplus">+      let stmt = getOpenedDatabase().createStatement(</span>
<a href="#l93.99"></a><span id="l93.99" class="difflineplus">+        &quot;SELECT string, number, nuller, blober FROM test WHERE id = ?&quot;</span>
<a href="#l93.100"></a><span id="l93.100" class="difflineplus">+      );</span>
<a href="#l93.101"></a><span id="l93.101" class="difflineplus">+      stmt.bindInt32Parameter(0, INTEGER);</span>
<a href="#l93.102"></a><span id="l93.102" class="difflineplus">+      try {</span>
<a href="#l93.103"></a><span id="l93.103" class="difflineplus">+        do_check_true(stmt.executeStep());</span>
<a href="#l93.104"></a><span id="l93.104" class="difflineplus">+        do_check_eq(TEXT, stmt.getString(0));</span>
<a href="#l93.105"></a><span id="l93.105" class="difflineplus">+        do_check_eq(REAL, stmt.getDouble(1));</span>
<a href="#l93.106"></a><span id="l93.106" class="difflineplus">+        do_check_true(stmt.getIsNull(2));</span>
<a href="#l93.107"></a><span id="l93.107" class="difflineplus">+        let count = { value: 0 };</span>
<a href="#l93.108"></a><span id="l93.108" class="difflineplus">+        let blob = { value: null };</span>
<a href="#l93.109"></a><span id="l93.109" class="difflineplus">+        stmt.getBlob(3, count, blob);</span>
<a href="#l93.110"></a><span id="l93.110" class="difflineplus">+        do_check_eq(BLOB.length, count.value);</span>
<a href="#l93.111"></a><span id="l93.111" class="difflineplus">+        for (let i = 0; i &lt; BLOB.length; i++)</span>
<a href="#l93.112"></a><span id="l93.112" class="difflineplus">+          do_check_eq(BLOB[i], blob.value[i]);</span>
<a href="#l93.113"></a><span id="l93.113" class="difflineplus">+      }</span>
<a href="#l93.114"></a><span id="l93.114" class="difflineplus">+      finally {</span>
<a href="#l93.115"></a><span id="l93.115" class="difflineplus">+        stmt.finalize();</span>
<a href="#l93.116"></a><span id="l93.116" class="difflineplus">+      }</span>
<a href="#l93.117"></a><span id="l93.117" class="difflineplus">+</span>
<a href="#l93.118"></a><span id="l93.118" class="difflineplus">+      // Make sure we have two rows in the table</span>
<a href="#l93.119"></a><span id="l93.119" class="difflineplus">+      stmt = getOpenedDatabase().createStatement(</span>
<a href="#l93.120"></a><span id="l93.120" class="difflineplus">+        &quot;SELECT COUNT(1) FROM test&quot;</span>
<a href="#l93.121"></a><span id="l93.121" class="difflineplus">+      );</span>
<a href="#l93.122"></a><span id="l93.122" class="difflineplus">+      try {</span>
<a href="#l93.123"></a><span id="l93.123" class="difflineplus">+        do_check_true(stmt.executeStep());</span>
<a href="#l93.124"></a><span id="l93.124" class="difflineplus">+        do_check_eq(2, stmt.getInt32(0));</span>
<a href="#l93.125"></a><span id="l93.125" class="difflineplus">+      }</span>
<a href="#l93.126"></a><span id="l93.126" class="difflineplus">+      finally {</span>
<a href="#l93.127"></a><span id="l93.127" class="difflineplus">+        stmt.finalize();</span>
<a href="#l93.128"></a><span id="l93.128" class="difflineplus">+      }</span>
<a href="#l93.129"></a><span id="l93.129" class="difflineplus">+</span>
<a href="#l93.130"></a><span id="l93.130" class="difflineplus">+      // Run the next test.</span>
<a href="#l93.131"></a><span id="l93.131" class="difflineplus">+      run_next_test();</span>
<a href="#l93.132"></a><span id="l93.132" class="difflineplus">+    }</span>
<a href="#l93.133"></a><span id="l93.133" class="difflineplus">+  });</span>
<a href="#l93.134"></a><span id="l93.134" class="difflineplus">+  stmts[0].finalize();</span>
<a href="#l93.135"></a><span id="l93.135" class="difflineplus">+  stmts[1].finalize();</span>
<a href="#l93.136"></a><span id="l93.136" class="difflineplus">+}</span>
<a href="#l93.137"></a><span id="l93.137" class="difflineplus">+</span>
<a href="#l93.138"></a><span id="l93.138" class="difflineplus">+function test_transaction_created()</span>
<a href="#l93.139"></a><span id="l93.139" class="difflineplus">+{</span>
<a href="#l93.140"></a><span id="l93.140" class="difflineplus">+  let stmts = [];</span>
<a href="#l93.141"></a><span id="l93.141" class="difflineplus">+  stmts[0] = getOpenedDatabase().createAsyncStatement(</span>
<a href="#l93.142"></a><span id="l93.142" class="difflineplus">+    &quot;BEGIN&quot;</span>
<a href="#l93.143"></a><span id="l93.143" class="difflineplus">+  );</span>
<a href="#l93.144"></a><span id="l93.144" class="difflineplus">+  stmts[1] = getOpenedDatabase().createStatement(</span>
<a href="#l93.145"></a><span id="l93.145" class="difflineplus">+    &quot;SELECT * FROM test&quot;</span>
<a href="#l93.146"></a><span id="l93.146" class="difflineplus">+  );</span>
<a href="#l93.147"></a><span id="l93.147" class="difflineplus">+</span>
<a href="#l93.148"></a><span id="l93.148" class="difflineplus">+  getOpenedDatabase().executeAsync(stmts, stmts.length, {</span>
<a href="#l93.149"></a><span id="l93.149" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l93.150"></a><span id="l93.150" class="difflineplus">+    {</span>
<a href="#l93.151"></a><span id="l93.151" class="difflineplus">+      dump(&quot;handleResults(&quot;+aResultSet+&quot;)\n&quot;);</span>
<a href="#l93.152"></a><span id="l93.152" class="difflineplus">+      do_throw(&quot;unexpected results obtained!&quot;);</span>
<a href="#l93.153"></a><span id="l93.153" class="difflineplus">+    },</span>
<a href="#l93.154"></a><span id="l93.154" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l93.155"></a><span id="l93.155" class="difflineplus">+    {</span>
<a href="#l93.156"></a><span id="l93.156" class="difflineplus">+      dump(&quot;handleError(&quot;+aError.result+&quot;)\n&quot;);</span>
<a href="#l93.157"></a><span id="l93.157" class="difflineplus">+    },</span>
<a href="#l93.158"></a><span id="l93.158" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l93.159"></a><span id="l93.159" class="difflineplus">+    {</span>
<a href="#l93.160"></a><span id="l93.160" class="difflineplus">+      dump(&quot;handleCompletion(&quot;+aReason+&quot;)\n&quot;);</span>
<a href="#l93.161"></a><span id="l93.161" class="difflineplus">+      do_check_eq(Ci.mozIStorageStatementCallback.REASON_ERROR, aReason);</span>
<a href="#l93.162"></a><span id="l93.162" class="difflineplus">+</span>
<a href="#l93.163"></a><span id="l93.163" class="difflineplus">+      // Run the next test.</span>
<a href="#l93.164"></a><span id="l93.164" class="difflineplus">+      run_next_test();</span>
<a href="#l93.165"></a><span id="l93.165" class="difflineplus">+    }</span>
<a href="#l93.166"></a><span id="l93.166" class="difflineplus">+  });</span>
<a href="#l93.167"></a><span id="l93.167" class="difflineplus">+  stmts[0].finalize();</span>
<a href="#l93.168"></a><span id="l93.168" class="difflineplus">+  stmts[1].finalize();</span>
<a href="#l93.169"></a><span id="l93.169" class="difflineplus">+}</span>
<a href="#l93.170"></a><span id="l93.170" class="difflineplus">+</span>
<a href="#l93.171"></a><span id="l93.171" class="difflineplus">+function test_multiple_bindings_on_statements()</span>
<a href="#l93.172"></a><span id="l93.172" class="difflineplus">+{</span>
<a href="#l93.173"></a><span id="l93.173" class="difflineplus">+  // This tests to make sure that we pass all the statements multiply bound</span>
<a href="#l93.174"></a><span id="l93.174" class="difflineplus">+  // parameters when we call executeAsync.</span>
<a href="#l93.175"></a><span id="l93.175" class="difflineplus">+  const AMOUNT_TO_ADD = 5;</span>
<a href="#l93.176"></a><span id="l93.176" class="difflineplus">+  const ITERATIONS = 5;</span>
<a href="#l93.177"></a><span id="l93.177" class="difflineplus">+</span>
<a href="#l93.178"></a><span id="l93.178" class="difflineplus">+  let stmts = [];</span>
<a href="#l93.179"></a><span id="l93.179" class="difflineplus">+  let db = getOpenedDatabase();</span>
<a href="#l93.180"></a><span id="l93.180" class="difflineplus">+  let sqlString = &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l93.181"></a><span id="l93.181" class="difflineplus">+                    &quot;VALUES (:int, :text, :real, :null, :blob)&quot;;</span>
<a href="#l93.182"></a><span id="l93.182" class="difflineplus">+  // We run the same statement twice, and should insert 2 * AMOUNT_TO_ADD.</span>
<a href="#l93.183"></a><span id="l93.183" class="difflineplus">+  for (let i = 0; i &lt; ITERATIONS; i++) {</span>
<a href="#l93.184"></a><span id="l93.184" class="difflineplus">+    // alternate the type of statement we create</span>
<a href="#l93.185"></a><span id="l93.185" class="difflineplus">+    if (i % 2)</span>
<a href="#l93.186"></a><span id="l93.186" class="difflineplus">+      stmts[i] = db.createStatement(sqlString);</span>
<a href="#l93.187"></a><span id="l93.187" class="difflineplus">+    else</span>
<a href="#l93.188"></a><span id="l93.188" class="difflineplus">+      stmts[i] = db.createAsyncStatement(sqlString);</span>
<a href="#l93.189"></a><span id="l93.189" class="difflineplus">+</span>
<a href="#l93.190"></a><span id="l93.190" class="difflineplus">+    let params = stmts[i].newBindingParamsArray();</span>
<a href="#l93.191"></a><span id="l93.191" class="difflineplus">+    for (let j = 0; j &lt; AMOUNT_TO_ADD; j++) {</span>
<a href="#l93.192"></a><span id="l93.192" class="difflineplus">+      let bp = params.newBindingParams();</span>
<a href="#l93.193"></a><span id="l93.193" class="difflineplus">+      bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l93.194"></a><span id="l93.194" class="difflineplus">+      bp.bindByName(&quot;text&quot;, TEXT);</span>
<a href="#l93.195"></a><span id="l93.195" class="difflineplus">+      bp.bindByName(&quot;real&quot;, REAL);</span>
<a href="#l93.196"></a><span id="l93.196" class="difflineplus">+      bp.bindByName(&quot;null&quot;, null);</span>
<a href="#l93.197"></a><span id="l93.197" class="difflineplus">+      bp.bindBlobByName(&quot;blob&quot;, BLOB, BLOB.length);</span>
<a href="#l93.198"></a><span id="l93.198" class="difflineplus">+      params.addParams(bp);</span>
<a href="#l93.199"></a><span id="l93.199" class="difflineplus">+    }</span>
<a href="#l93.200"></a><span id="l93.200" class="difflineplus">+    stmts[i].bindParameters(params);</span>
<a href="#l93.201"></a><span id="l93.201" class="difflineplus">+  }</span>
<a href="#l93.202"></a><span id="l93.202" class="difflineplus">+</span>
<a href="#l93.203"></a><span id="l93.203" class="difflineplus">+  // Get our current number of rows in the table.</span>
<a href="#l93.204"></a><span id="l93.204" class="difflineplus">+  let currentRows = 0;</span>
<a href="#l93.205"></a><span id="l93.205" class="difflineplus">+  let countStmt = getOpenedDatabase().createStatement(</span>
<a href="#l93.206"></a><span id="l93.206" class="difflineplus">+    &quot;SELECT COUNT(1) AS count FROM test&quot;</span>
<a href="#l93.207"></a><span id="l93.207" class="difflineplus">+  );</span>
<a href="#l93.208"></a><span id="l93.208" class="difflineplus">+  try {</span>
<a href="#l93.209"></a><span id="l93.209" class="difflineplus">+    do_check_true(countStmt.executeStep());</span>
<a href="#l93.210"></a><span id="l93.210" class="difflineplus">+    currentRows = countStmt.row.count;</span>
<a href="#l93.211"></a><span id="l93.211" class="difflineplus">+  }</span>
<a href="#l93.212"></a><span id="l93.212" class="difflineplus">+  finally {</span>
<a href="#l93.213"></a><span id="l93.213" class="difflineplus">+    countStmt.reset();</span>
<a href="#l93.214"></a><span id="l93.214" class="difflineplus">+  }</span>
<a href="#l93.215"></a><span id="l93.215" class="difflineplus">+</span>
<a href="#l93.216"></a><span id="l93.216" class="difflineplus">+  // Execute asynchronously.</span>
<a href="#l93.217"></a><span id="l93.217" class="difflineplus">+  getOpenedDatabase().executeAsync(stmts, stmts.length, {</span>
<a href="#l93.218"></a><span id="l93.218" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l93.219"></a><span id="l93.219" class="difflineplus">+    {</span>
<a href="#l93.220"></a><span id="l93.220" class="difflineplus">+      do_throw(&quot;Unexpected call to handleResult!&quot;);</span>
<a href="#l93.221"></a><span id="l93.221" class="difflineplus">+    },</span>
<a href="#l93.222"></a><span id="l93.222" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l93.223"></a><span id="l93.223" class="difflineplus">+    {</span>
<a href="#l93.224"></a><span id="l93.224" class="difflineplus">+      print(&quot;Error code &quot; + aError.result + &quot; with message '&quot; +</span>
<a href="#l93.225"></a><span id="l93.225" class="difflineplus">+            aError.message + &quot;' returned.&quot;);</span>
<a href="#l93.226"></a><span id="l93.226" class="difflineplus">+      do_throw(&quot;Unexpected error!&quot;);</span>
<a href="#l93.227"></a><span id="l93.227" class="difflineplus">+    },</span>
<a href="#l93.228"></a><span id="l93.228" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l93.229"></a><span id="l93.229" class="difflineplus">+    {</span>
<a href="#l93.230"></a><span id="l93.230" class="difflineplus">+      print(&quot;handleCompletion(&quot; + aReason +</span>
<a href="#l93.231"></a><span id="l93.231" class="difflineplus">+            &quot;) for test_multiple_bindings_on_statements&quot;);</span>
<a href="#l93.232"></a><span id="l93.232" class="difflineplus">+      do_check_eq(Ci.mozIStorageStatementCallback.REASON_FINISHED, aReason);</span>
<a href="#l93.233"></a><span id="l93.233" class="difflineplus">+</span>
<a href="#l93.234"></a><span id="l93.234" class="difflineplus">+      // Check to make sure we added all of our rows.</span>
<a href="#l93.235"></a><span id="l93.235" class="difflineplus">+      try {</span>
<a href="#l93.236"></a><span id="l93.236" class="difflineplus">+        do_check_true(countStmt.executeStep());</span>
<a href="#l93.237"></a><span id="l93.237" class="difflineplus">+        do_check_eq(currentRows + (ITERATIONS * AMOUNT_TO_ADD),</span>
<a href="#l93.238"></a><span id="l93.238" class="difflineplus">+                    countStmt.row.count);</span>
<a href="#l93.239"></a><span id="l93.239" class="difflineplus">+      }</span>
<a href="#l93.240"></a><span id="l93.240" class="difflineplus">+      finally {</span>
<a href="#l93.241"></a><span id="l93.241" class="difflineplus">+        countStmt.finalize();</span>
<a href="#l93.242"></a><span id="l93.242" class="difflineplus">+      }</span>
<a href="#l93.243"></a><span id="l93.243" class="difflineplus">+</span>
<a href="#l93.244"></a><span id="l93.244" class="difflineplus">+      // Run the next test.</span>
<a href="#l93.245"></a><span id="l93.245" class="difflineplus">+      run_next_test();</span>
<a href="#l93.246"></a><span id="l93.246" class="difflineplus">+    }</span>
<a href="#l93.247"></a><span id="l93.247" class="difflineplus">+  });</span>
<a href="#l93.248"></a><span id="l93.248" class="difflineplus">+  stmts.forEach(function(stmt) stmt.finalize());</span>
<a href="#l93.249"></a><span id="l93.249" class="difflineplus">+}</span>
<a href="#l93.250"></a><span id="l93.250" class="difflineplus">+</span>
<a href="#l93.251"></a><span id="l93.251" class="difflineplus">+function test_asyncClose_does_not_complete_before_statements()</span>
<a href="#l93.252"></a><span id="l93.252" class="difflineplus">+{</span>
<a href="#l93.253"></a><span id="l93.253" class="difflineplus">+  let stmt = createStatement(&quot;SELECT * FROM sqlite_master&quot;);</span>
<a href="#l93.254"></a><span id="l93.254" class="difflineplus">+  let executed = false;</span>
<a href="#l93.255"></a><span id="l93.255" class="difflineplus">+  stmt.executeAsync({</span>
<a href="#l93.256"></a><span id="l93.256" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l93.257"></a><span id="l93.257" class="difflineplus">+    {</span>
<a href="#l93.258"></a><span id="l93.258" class="difflineplus">+    },</span>
<a href="#l93.259"></a><span id="l93.259" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l93.260"></a><span id="l93.260" class="difflineplus">+    {</span>
<a href="#l93.261"></a><span id="l93.261" class="difflineplus">+      print(&quot;Error code &quot; + aError.result + &quot; with message '&quot; +</span>
<a href="#l93.262"></a><span id="l93.262" class="difflineplus">+            aError.message + &quot;' returned.&quot;);</span>
<a href="#l93.263"></a><span id="l93.263" class="difflineplus">+      do_throw(&quot;Unexpected error!&quot;);</span>
<a href="#l93.264"></a><span id="l93.264" class="difflineplus">+    },</span>
<a href="#l93.265"></a><span id="l93.265" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l93.266"></a><span id="l93.266" class="difflineplus">+    {</span>
<a href="#l93.267"></a><span id="l93.267" class="difflineplus">+      print(&quot;handleCompletion(&quot; + aReason +</span>
<a href="#l93.268"></a><span id="l93.268" class="difflineplus">+            &quot;) for test_asyncClose_does_not_complete_before_statements&quot;);</span>
<a href="#l93.269"></a><span id="l93.269" class="difflineplus">+      do_check_eq(Ci.mozIStorageStatementCallback.REASON_FINISHED, aReason);</span>
<a href="#l93.270"></a><span id="l93.270" class="difflineplus">+      executed = true;</span>
<a href="#l93.271"></a><span id="l93.271" class="difflineplus">+    }</span>
<a href="#l93.272"></a><span id="l93.272" class="difflineplus">+  });</span>
<a href="#l93.273"></a><span id="l93.273" class="difflineplus">+  stmt.finalize();</span>
<a href="#l93.274"></a><span id="l93.274" class="difflineplus">+</span>
<a href="#l93.275"></a><span id="l93.275" class="difflineplus">+  getOpenedDatabase().asyncClose(function() {</span>
<a href="#l93.276"></a><span id="l93.276" class="difflineplus">+    // Ensure that the statement executed to completion.</span>
<a href="#l93.277"></a><span id="l93.277" class="difflineplus">+    do_check_true(executed);</span>
<a href="#l93.278"></a><span id="l93.278" class="difflineplus">+</span>
<a href="#l93.279"></a><span id="l93.279" class="difflineplus">+    // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l93.280"></a><span id="l93.280" class="difflineplus">+    gDBConn = null;</span>
<a href="#l93.281"></a><span id="l93.281" class="difflineplus">+    run_next_test();</span>
<a href="#l93.282"></a><span id="l93.282" class="difflineplus">+  });</span>
<a href="#l93.283"></a><span id="l93.283" class="difflineplus">+}</span>
<a href="#l93.284"></a><span id="l93.284" class="difflineplus">+</span>
<a href="#l93.285"></a><span id="l93.285" class="difflineplus">+function test_asyncClose_does_not_throw_no_callback()</span>
<a href="#l93.286"></a><span id="l93.286" class="difflineplus">+{</span>
<a href="#l93.287"></a><span id="l93.287" class="difflineplus">+  getOpenedDatabase().asyncClose();</span>
<a href="#l93.288"></a><span id="l93.288" class="difflineplus">+</span>
<a href="#l93.289"></a><span id="l93.289" class="difflineplus">+  // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l93.290"></a><span id="l93.290" class="difflineplus">+  gDBConn = null;</span>
<a href="#l93.291"></a><span id="l93.291" class="difflineplus">+  run_next_test();</span>
<a href="#l93.292"></a><span id="l93.292" class="difflineplus">+}</span>
<a href="#l93.293"></a><span id="l93.293" class="difflineplus">+</span>
<a href="#l93.294"></a><span id="l93.294" class="difflineplus">+function test_double_asyncClose_throws()</span>
<a href="#l93.295"></a><span id="l93.295" class="difflineplus">+{</span>
<a href="#l93.296"></a><span id="l93.296" class="difflineplus">+  let conn = getOpenedDatabase();</span>
<a href="#l93.297"></a><span id="l93.297" class="difflineplus">+  conn.asyncClose();</span>
<a href="#l93.298"></a><span id="l93.298" class="difflineplus">+  try {</span>
<a href="#l93.299"></a><span id="l93.299" class="difflineplus">+    conn.asyncClose();</span>
<a href="#l93.300"></a><span id="l93.300" class="difflineplus">+    do_throw(&quot;should have thrown&quot;);</span>
<a href="#l93.301"></a><span id="l93.301" class="difflineplus">+  }</span>
<a href="#l93.302"></a><span id="l93.302" class="difflineplus">+  catch (e) {</span>
<a href="#l93.303"></a><span id="l93.303" class="difflineplus">+    do_check_eq(e.result, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l93.304"></a><span id="l93.304" class="difflineplus">+  }</span>
<a href="#l93.305"></a><span id="l93.305" class="difflineplus">+</span>
<a href="#l93.306"></a><span id="l93.306" class="difflineplus">+  // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l93.307"></a><span id="l93.307" class="difflineplus">+  gDBConn = null;</span>
<a href="#l93.308"></a><span id="l93.308" class="difflineplus">+  run_next_test();</span>
<a href="#l93.309"></a><span id="l93.309" class="difflineplus">+}</span>
<a href="#l93.310"></a><span id="l93.310" class="difflineplus">+</span>
<a href="#l93.311"></a><span id="l93.311" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l93.312"></a><span id="l93.312" class="difflineplus">+//// Test Runner</span>
<a href="#l93.313"></a><span id="l93.313" class="difflineplus">+</span>
<a href="#l93.314"></a><span id="l93.314" class="difflineplus">+let tests =</span>
<a href="#l93.315"></a><span id="l93.315" class="difflineplus">+[</span>
<a href="#l93.316"></a><span id="l93.316" class="difflineplus">+  test_create_and_add,</span>
<a href="#l93.317"></a><span id="l93.317" class="difflineplus">+  test_transaction_created,</span>
<a href="#l93.318"></a><span id="l93.318" class="difflineplus">+  test_multiple_bindings_on_statements,</span>
<a href="#l93.319"></a><span id="l93.319" class="difflineplus">+  test_asyncClose_does_not_complete_before_statements,</span>
<a href="#l93.320"></a><span id="l93.320" class="difflineplus">+  test_asyncClose_does_not_throw_no_callback,</span>
<a href="#l93.321"></a><span id="l93.321" class="difflineplus">+  test_double_asyncClose_throws,</span>
<a href="#l93.322"></a><span id="l93.322" class="difflineplus">+];</span>
<a href="#l93.323"></a><span id="l93.323" class="difflineplus">+let index = 0;</span>
<a href="#l93.324"></a><span id="l93.324" class="difflineplus">+</span>
<a href="#l93.325"></a><span id="l93.325" class="difflineplus">+function run_next_test()</span>
<a href="#l93.326"></a><span id="l93.326" class="difflineplus">+{</span>
<a href="#l93.327"></a><span id="l93.327" class="difflineplus">+  function _run_next_test() {</span>
<a href="#l93.328"></a><span id="l93.328" class="difflineplus">+    if (index &lt; tests.length) {</span>
<a href="#l93.329"></a><span id="l93.329" class="difflineplus">+      do_test_pending();</span>
<a href="#l93.330"></a><span id="l93.330" class="difflineplus">+      print(&quot;Running the next test: &quot; + tests[index].name);</span>
<a href="#l93.331"></a><span id="l93.331" class="difflineplus">+</span>
<a href="#l93.332"></a><span id="l93.332" class="difflineplus">+      // Asynchronous tests means that exceptions don't kill the test.</span>
<a href="#l93.333"></a><span id="l93.333" class="difflineplus">+      try {</span>
<a href="#l93.334"></a><span id="l93.334" class="difflineplus">+        tests[index++]();</span>
<a href="#l93.335"></a><span id="l93.335" class="difflineplus">+      }</span>
<a href="#l93.336"></a><span id="l93.336" class="difflineplus">+      catch (e) {</span>
<a href="#l93.337"></a><span id="l93.337" class="difflineplus">+        do_throw(e);</span>
<a href="#l93.338"></a><span id="l93.338" class="difflineplus">+      }</span>
<a href="#l93.339"></a><span id="l93.339" class="difflineplus">+    }</span>
<a href="#l93.340"></a><span id="l93.340" class="difflineplus">+</span>
<a href="#l93.341"></a><span id="l93.341" class="difflineplus">+    do_test_finished();</span>
<a href="#l93.342"></a><span id="l93.342" class="difflineplus">+  }</span>
<a href="#l93.343"></a><span id="l93.343" class="difflineplus">+</span>
<a href="#l93.344"></a><span id="l93.344" class="difflineplus">+  // For saner stacks, we execute this code RSN.</span>
<a href="#l93.345"></a><span id="l93.345" class="difflineplus">+  do_execute_soon(_run_next_test);</span>
<a href="#l93.346"></a><span id="l93.346" class="difflineplus">+}</span>
<a href="#l93.347"></a><span id="l93.347" class="difflineplus">+</span>
<a href="#l93.348"></a><span id="l93.348" class="difflineplus">+function run_test()</span>
<a href="#l93.349"></a><span id="l93.349" class="difflineplus">+{</span>
<a href="#l93.350"></a><span id="l93.350" class="difflineplus">+  cleanup();</span>
<a href="#l93.351"></a><span id="l93.351" class="difflineplus">+</span>
<a href="#l93.352"></a><span id="l93.352" class="difflineplus">+  do_test_pending();</span>
<a href="#l93.353"></a><span id="l93.353" class="difflineplus">+  run_next_test();</span>
<a href="#l93.354"></a><span id="l93.354" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1">new file mode 100644</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineminus">--- /dev/null</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineplus">+++ b/storage-backport/test/unit/test_js_helpers_enumerate.js</span>
<a href="#l94.4"></a><span id="l94.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l94.5"></a><span id="l94.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l94.6"></a><span id="l94.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l94.7"></a><span id="l94.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l94.8"></a><span id="l94.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l94.9"></a><span id="l94.9" class="difflineplus">+ *</span>
<a href="#l94.10"></a><span id="l94.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l94.11"></a><span id="l94.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l94.14"></a><span id="l94.14" class="difflineplus">+ *</span>
<a href="#l94.15"></a><span id="l94.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l94.16"></a><span id="l94.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l94.17"></a><span id="l94.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l94.18"></a><span id="l94.18" class="difflineplus">+ * License.</span>
<a href="#l94.19"></a><span id="l94.19" class="difflineplus">+ *</span>
<a href="#l94.20"></a><span id="l94.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l94.21"></a><span id="l94.21" class="difflineplus">+ *</span>
<a href="#l94.22"></a><span id="l94.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l94.24"></a><span id="l94.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l94.25"></a><span id="l94.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l94.26"></a><span id="l94.26" class="difflineplus">+ *</span>
<a href="#l94.27"></a><span id="l94.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l94.28"></a><span id="l94.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l94.29"></a><span id="l94.29" class="difflineplus">+ *</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l94.32"></a><span id="l94.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l94.33"></a><span id="l94.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l94.34"></a><span id="l94.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l94.35"></a><span id="l94.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l94.36"></a><span id="l94.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l94.37"></a><span id="l94.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l94.38"></a><span id="l94.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l94.39"></a><span id="l94.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l94.40"></a><span id="l94.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l94.41"></a><span id="l94.41" class="difflineplus">+ *</span>
<a href="#l94.42"></a><span id="l94.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l94.43"></a><span id="l94.43" class="difflineplus">+</span>
<a href="#l94.44"></a><span id="l94.44" class="difflineplus">+/**</span>
<a href="#l94.45"></a><span id="l94.45" class="difflineplus">+ * This file tests that the JS language helpers have the ability to enumerate</span>
<a href="#l94.46"></a><span id="l94.46" class="difflineplus">+ * their properties.</span>
<a href="#l94.47"></a><span id="l94.47" class="difflineplus">+ */</span>
<a href="#l94.48"></a><span id="l94.48" class="difflineplus">+</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l94.50"></a><span id="l94.50" class="difflineplus">+//// Test Functions</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineplus">+</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineplus">+function test_params_enumerate()</span>
<a href="#l94.53"></a><span id="l94.53" class="difflineplus">+{</span>
<a href="#l94.54"></a><span id="l94.54" class="difflineplus">+  let stmt = getOpenedDatabase().createStatement(</span>
<a href="#l94.55"></a><span id="l94.55" class="difflineplus">+    &quot;SELECT * FROM test WHERE id IN (:a, :b, :c)&quot;</span>
<a href="#l94.56"></a><span id="l94.56" class="difflineplus">+  );</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineplus">+</span>
<a href="#l94.58"></a><span id="l94.58" class="difflineplus">+  // Make sure they are right.</span>
<a href="#l94.59"></a><span id="l94.59" class="difflineplus">+  let expected = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;];</span>
<a href="#l94.60"></a><span id="l94.60" class="difflineplus">+  let index = 0;</span>
<a href="#l94.61"></a><span id="l94.61" class="difflineplus">+  for (let name in stmt.params)</span>
<a href="#l94.62"></a><span id="l94.62" class="difflineplus">+    do_check_eq(name, expected[index++]);</span>
<a href="#l94.63"></a><span id="l94.63" class="difflineplus">+}</span>
<a href="#l94.64"></a><span id="l94.64" class="difflineplus">+</span>
<a href="#l94.65"></a><span id="l94.65" class="difflineplus">+</span>
<a href="#l94.66"></a><span id="l94.66" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l94.67"></a><span id="l94.67" class="difflineplus">+//// Test Runner</span>
<a href="#l94.68"></a><span id="l94.68" class="difflineplus">+</span>
<a href="#l94.69"></a><span id="l94.69" class="difflineplus">+let tests = [</span>
<a href="#l94.70"></a><span id="l94.70" class="difflineplus">+  test_params_enumerate,</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineplus">+];</span>
<a href="#l94.72"></a><span id="l94.72" class="difflineplus">+function run_test()</span>
<a href="#l94.73"></a><span id="l94.73" class="difflineplus">+{</span>
<a href="#l94.74"></a><span id="l94.74" class="difflineplus">+  cleanup();</span>
<a href="#l94.75"></a><span id="l94.75" class="difflineplus">+</span>
<a href="#l94.76"></a><span id="l94.76" class="difflineplus">+  // Create our database.</span>
<a href="#l94.77"></a><span id="l94.77" class="difflineplus">+  getOpenedDatabase().executeSimpleSQL(</span>
<a href="#l94.78"></a><span id="l94.78" class="difflineplus">+    &quot;CREATE TABLE test (&quot; +</span>
<a href="#l94.79"></a><span id="l94.79" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY &quot; +</span>
<a href="#l94.80"></a><span id="l94.80" class="difflineplus">+    &quot;)&quot;</span>
<a href="#l94.81"></a><span id="l94.81" class="difflineplus">+  );</span>
<a href="#l94.82"></a><span id="l94.82" class="difflineplus">+</span>
<a href="#l94.83"></a><span id="l94.83" class="difflineplus">+  // Run the tests.</span>
<a href="#l94.84"></a><span id="l94.84" class="difflineplus">+  tests.forEach(function(test) test());</span>
<a href="#l94.85"></a><span id="l94.85" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1">new file mode 100644</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineminus">--- /dev/null</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineplus">+++ b/storage-backport/test/unit/test_js_helpers_prototype_chain_safe.js</span>
<a href="#l95.4"></a><span id="l95.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l95.5"></a><span id="l95.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l95.6"></a><span id="l95.6" class="difflineplus">+ * vim: sw=2 ts=2 sts=2 et</span>
<a href="#l95.7"></a><span id="l95.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l95.8"></a><span id="l95.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l95.9"></a><span id="l95.9" class="difflineplus">+ *</span>
<a href="#l95.10"></a><span id="l95.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l95.11"></a><span id="l95.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l95.14"></a><span id="l95.14" class="difflineplus">+ *</span>
<a href="#l95.15"></a><span id="l95.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l95.16"></a><span id="l95.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l95.17"></a><span id="l95.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l95.18"></a><span id="l95.18" class="difflineplus">+ * License.</span>
<a href="#l95.19"></a><span id="l95.19" class="difflineplus">+ *</span>
<a href="#l95.20"></a><span id="l95.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l95.21"></a><span id="l95.21" class="difflineplus">+ *</span>
<a href="#l95.22"></a><span id="l95.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l95.23"></a><span id="l95.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l95.24"></a><span id="l95.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l95.25"></a><span id="l95.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l95.26"></a><span id="l95.26" class="difflineplus">+ *</span>
<a href="#l95.27"></a><span id="l95.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l95.28"></a><span id="l95.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l95.29"></a><span id="l95.29" class="difflineplus">+ *</span>
<a href="#l95.30"></a><span id="l95.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l95.31"></a><span id="l95.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l95.32"></a><span id="l95.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l95.33"></a><span id="l95.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l95.34"></a><span id="l95.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l95.35"></a><span id="l95.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l95.36"></a><span id="l95.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l95.37"></a><span id="l95.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l95.38"></a><span id="l95.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l95.39"></a><span id="l95.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l95.40"></a><span id="l95.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l95.41"></a><span id="l95.41" class="difflineplus">+ *</span>
<a href="#l95.42"></a><span id="l95.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l95.43"></a><span id="l95.43" class="difflineplus">+</span>
<a href="#l95.44"></a><span id="l95.44" class="difflineplus">+/**</span>
<a href="#l95.45"></a><span id="l95.45" class="difflineplus">+ * This file tests that the JS language helpers check their prototype chain for</span>
<a href="#l95.46"></a><span id="l95.46" class="difflineplus">+ * most properties.</span>
<a href="#l95.47"></a><span id="l95.47" class="difflineplus">+ */</span>
<a href="#l95.48"></a><span id="l95.48" class="difflineplus">+</span>
<a href="#l95.49"></a><span id="l95.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l95.50"></a><span id="l95.50" class="difflineplus">+//// Test Functions</span>
<a href="#l95.51"></a><span id="l95.51" class="difflineplus">+</span>
<a href="#l95.52"></a><span id="l95.52" class="difflineplus">+function test_params_prototype()</span>
<a href="#l95.53"></a><span id="l95.53" class="difflineplus">+{</span>
<a href="#l95.54"></a><span id="l95.54" class="difflineplus">+  let stmt = getOpenedDatabase().createStatement(</span>
<a href="#l95.55"></a><span id="l95.55" class="difflineplus">+    &quot;SELECT * FROM sqlite_master&quot;</span>
<a href="#l95.56"></a><span id="l95.56" class="difflineplus">+  );</span>
<a href="#l95.57"></a><span id="l95.57" class="difflineplus">+</span>
<a href="#l95.58"></a><span id="l95.58" class="difflineplus">+  // Set a property on the prototype and make sure it exist (will not be a</span>
<a href="#l95.59"></a><span id="l95.59" class="difflineplus">+  // bindable parameter, however).</span>
<a href="#l95.60"></a><span id="l95.60" class="difflineplus">+  stmt.params.__proto__.test = 2;</span>
<a href="#l95.61"></a><span id="l95.61" class="difflineplus">+  do_check_eq(stmt.params.test, 2);</span>
<a href="#l95.62"></a><span id="l95.62" class="difflineplus">+  stmt.finalize();</span>
<a href="#l95.63"></a><span id="l95.63" class="difflineplus">+}</span>
<a href="#l95.64"></a><span id="l95.64" class="difflineplus">+</span>
<a href="#l95.65"></a><span id="l95.65" class="difflineplus">+function test_row_prototype()</span>
<a href="#l95.66"></a><span id="l95.66" class="difflineplus">+{</span>
<a href="#l95.67"></a><span id="l95.67" class="difflineplus">+  // First, create a table so that we actually have data in sqlite_master.</span>
<a href="#l95.68"></a><span id="l95.68" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test_table&quot;, &quot;id INTEGER PRIMARY KEY&quot;);</span>
<a href="#l95.69"></a><span id="l95.69" class="difflineplus">+</span>
<a href="#l95.70"></a><span id="l95.70" class="difflineplus">+  let stmt = getOpenedDatabase().createStatement(</span>
<a href="#l95.71"></a><span id="l95.71" class="difflineplus">+    &quot;SELECT * FROM sqlite_master&quot;</span>
<a href="#l95.72"></a><span id="l95.72" class="difflineplus">+  );</span>
<a href="#l95.73"></a><span id="l95.73" class="difflineplus">+</span>
<a href="#l95.74"></a><span id="l95.74" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l95.75"></a><span id="l95.75" class="difflineplus">+</span>
<a href="#l95.76"></a><span id="l95.76" class="difflineplus">+  // Set a property on the prototype and make sure it exists (will not be in the</span>
<a href="#l95.77"></a><span id="l95.77" class="difflineplus">+  // results, however).</span>
<a href="#l95.78"></a><span id="l95.78" class="difflineplus">+  stmt.row.__proto__.test = 2;</span>
<a href="#l95.79"></a><span id="l95.79" class="difflineplus">+  do_check_eq(stmt.row.test, 2);</span>
<a href="#l95.80"></a><span id="l95.80" class="difflineplus">+  stmt.finalize();</span>
<a href="#l95.81"></a><span id="l95.81" class="difflineplus">+}</span>
<a href="#l95.82"></a><span id="l95.82" class="difflineplus">+</span>
<a href="#l95.83"></a><span id="l95.83" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l95.84"></a><span id="l95.84" class="difflineplus">+//// Test Runner</span>
<a href="#l95.85"></a><span id="l95.85" class="difflineplus">+</span>
<a href="#l95.86"></a><span id="l95.86" class="difflineplus">+let tests = [</span>
<a href="#l95.87"></a><span id="l95.87" class="difflineplus">+  test_params_prototype,</span>
<a href="#l95.88"></a><span id="l95.88" class="difflineplus">+  test_row_prototype,</span>
<a href="#l95.89"></a><span id="l95.89" class="difflineplus">+];</span>
<a href="#l95.90"></a><span id="l95.90" class="difflineplus">+function run_test()</span>
<a href="#l95.91"></a><span id="l95.91" class="difflineplus">+{</span>
<a href="#l95.92"></a><span id="l95.92" class="difflineplus">+  cleanup();</span>
<a href="#l95.93"></a><span id="l95.93" class="difflineplus">+</span>
<a href="#l95.94"></a><span id="l95.94" class="difflineplus">+  // Run the tests.</span>
<a href="#l95.95"></a><span id="l95.95" class="difflineplus">+  tests.forEach(function(test) test());</span>
<a href="#l95.96"></a><span id="l95.96" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1">new file mode 100644</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineminus">--- /dev/null</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineplus">+++ b/storage-backport/test/unit/test_levenshtein.js</span>
<a href="#l96.4"></a><span id="l96.4" class="difflineat">@@ -0,0 +1,108 @@</span>
<a href="#l96.5"></a><span id="l96.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l96.6"></a><span id="l96.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l96.7"></a><span id="l96.7" class="difflineplus">+ *</span>
<a href="#l96.8"></a><span id="l96.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l96.9"></a><span id="l96.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l96.10"></a><span id="l96.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l96.11"></a><span id="l96.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineplus">+ *</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l96.14"></a><span id="l96.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l96.15"></a><span id="l96.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l96.16"></a><span id="l96.16" class="difflineplus">+ * License.</span>
<a href="#l96.17"></a><span id="l96.17" class="difflineplus">+ *</span>
<a href="#l96.18"></a><span id="l96.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l96.19"></a><span id="l96.19" class="difflineplus">+ *</span>
<a href="#l96.20"></a><span id="l96.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l96.21"></a><span id="l96.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l96.22"></a><span id="l96.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l96.23"></a><span id="l96.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l96.24"></a><span id="l96.24" class="difflineplus">+ *</span>
<a href="#l96.25"></a><span id="l96.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l96.26"></a><span id="l96.26" class="difflineplus">+ *   Curtis Bartley &lt;cbartley@mozilla.com&gt; (Original Author)</span>
<a href="#l96.27"></a><span id="l96.27" class="difflineplus">+ *</span>
<a href="#l96.28"></a><span id="l96.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l96.29"></a><span id="l96.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l96.30"></a><span id="l96.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l96.31"></a><span id="l96.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l96.32"></a><span id="l96.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l96.33"></a><span id="l96.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l96.34"></a><span id="l96.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l96.35"></a><span id="l96.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l96.36"></a><span id="l96.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l96.37"></a><span id="l96.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l96.38"></a><span id="l96.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l96.39"></a><span id="l96.39" class="difflineplus">+ *</span>
<a href="#l96.40"></a><span id="l96.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l96.41"></a><span id="l96.41" class="difflineplus">+</span>
<a href="#l96.42"></a><span id="l96.42" class="difflineplus">+// This file tests the Levenshtein Distance function we've registered.</span>
<a href="#l96.43"></a><span id="l96.43" class="difflineplus">+</span>
<a href="#l96.44"></a><span id="l96.44" class="difflineplus">+function createUtf16Database()</span>
<a href="#l96.45"></a><span id="l96.45" class="difflineplus">+{</span>
<a href="#l96.46"></a><span id="l96.46" class="difflineplus">+  print(&quot;Creating the in-memory UTF-16-encoded database.&quot;);</span>
<a href="#l96.47"></a><span id="l96.47" class="difflineplus">+  let conn = getService().openSpecialDatabase(&quot;memory&quot;);</span>
<a href="#l96.48"></a><span id="l96.48" class="difflineplus">+  conn.executeSimpleSQL(&quot;PRAGMA encoding = 'UTF-16'&quot;);</span>
<a href="#l96.49"></a><span id="l96.49" class="difflineplus">+</span>
<a href="#l96.50"></a><span id="l96.50" class="difflineplus">+  print(&quot;Make sure the encoding was set correctly and is now UTF-16.&quot;);</span>
<a href="#l96.51"></a><span id="l96.51" class="difflineplus">+  let stmt = conn.createStatement(&quot;PRAGMA encoding&quot;);</span>
<a href="#l96.52"></a><span id="l96.52" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l96.53"></a><span id="l96.53" class="difflineplus">+  let enc = stmt.getString(0);</span>
<a href="#l96.54"></a><span id="l96.54" class="difflineplus">+  stmt.finalize();</span>
<a href="#l96.55"></a><span id="l96.55" class="difflineplus">+</span>
<a href="#l96.56"></a><span id="l96.56" class="difflineplus">+  // The value returned will actually be UTF-16le or UTF-16be.</span>
<a href="#l96.57"></a><span id="l96.57" class="difflineplus">+  do_check_true(enc === &quot;UTF-16le&quot; || enc === &quot;UTF-16be&quot;);</span>
<a href="#l96.58"></a><span id="l96.58" class="difflineplus">+</span>
<a href="#l96.59"></a><span id="l96.59" class="difflineplus">+  return conn;</span>
<a href="#l96.60"></a><span id="l96.60" class="difflineplus">+}</span>
<a href="#l96.61"></a><span id="l96.61" class="difflineplus">+</span>
<a href="#l96.62"></a><span id="l96.62" class="difflineplus">+function check_levenshtein(db, s, t, expectedDistance)</span>
<a href="#l96.63"></a><span id="l96.63" class="difflineplus">+{</span>
<a href="#l96.64"></a><span id="l96.64" class="difflineplus">+  var stmt = db.createStatement(&quot;SELECT levenshteinDistance(:s, :t) AS result&quot;);</span>
<a href="#l96.65"></a><span id="l96.65" class="difflineplus">+  stmt.params.s = s;</span>
<a href="#l96.66"></a><span id="l96.66" class="difflineplus">+  stmt.params.t = t;</span>
<a href="#l96.67"></a><span id="l96.67" class="difflineplus">+  try {</span>
<a href="#l96.68"></a><span id="l96.68" class="difflineplus">+    do_check_true(stmt.executeStep());</span>
<a href="#l96.69"></a><span id="l96.69" class="difflineplus">+    do_check_eq(expectedDistance, stmt.row.result);</span>
<a href="#l96.70"></a><span id="l96.70" class="difflineplus">+  } </span>
<a href="#l96.71"></a><span id="l96.71" class="difflineplus">+  finally {</span>
<a href="#l96.72"></a><span id="l96.72" class="difflineplus">+    stmt.reset();</span>
<a href="#l96.73"></a><span id="l96.73" class="difflineplus">+    stmt.finalize();</span>
<a href="#l96.74"></a><span id="l96.74" class="difflineplus">+  }</span>
<a href="#l96.75"></a><span id="l96.75" class="difflineplus">+}</span>
<a href="#l96.76"></a><span id="l96.76" class="difflineplus">+</span>
<a href="#l96.77"></a><span id="l96.77" class="difflineplus">+function testLevenshtein(db)</span>
<a href="#l96.78"></a><span id="l96.78" class="difflineplus">+{</span>
<a href="#l96.79"></a><span id="l96.79" class="difflineplus">+  // Basic tests.</span>
<a href="#l96.80"></a><span id="l96.80" class="difflineplus">+  check_levenshtein(db, &quot;&quot;, &quot;&quot;, 0);</span>
<a href="#l96.81"></a><span id="l96.81" class="difflineplus">+  check_levenshtein(db, &quot;foo&quot;, &quot;&quot;, 3);</span>
<a href="#l96.82"></a><span id="l96.82" class="difflineplus">+  check_levenshtein(db, &quot;&quot;, &quot;bar&quot;, 3);</span>
<a href="#l96.83"></a><span id="l96.83" class="difflineplus">+  check_levenshtein(db, &quot;yellow&quot;, &quot;hello&quot;, 2);</span>
<a href="#l96.84"></a><span id="l96.84" class="difflineplus">+  check_levenshtein(db, &quot;gumbo&quot;, &quot;gambol&quot;, 2);</span>
<a href="#l96.85"></a><span id="l96.85" class="difflineplus">+  check_levenshtein(db, &quot;kitten&quot;, &quot;sitten&quot;, 1);</span>
<a href="#l96.86"></a><span id="l96.86" class="difflineplus">+  check_levenshtein(db, &quot;sitten&quot;, &quot;sittin&quot;, 1);</span>
<a href="#l96.87"></a><span id="l96.87" class="difflineplus">+  check_levenshtein(db, &quot;sittin&quot;, &quot;sitting&quot;, 1);</span>
<a href="#l96.88"></a><span id="l96.88" class="difflineplus">+  check_levenshtein(db, &quot;kitten&quot;, &quot;sitting&quot;, 3);</span>
<a href="#l96.89"></a><span id="l96.89" class="difflineplus">+  check_levenshtein(db, &quot;Saturday&quot;, &quot;Sunday&quot;, 3);</span>
<a href="#l96.90"></a><span id="l96.90" class="difflineplus">+  check_levenshtein(db, &quot;YHCQPGK&quot;, &quot;LAHYQQKPGKA&quot;, 6);</span>
<a href="#l96.91"></a><span id="l96.91" class="difflineplus">+</span>
<a href="#l96.92"></a><span id="l96.92" class="difflineplus">+  // Test SQL NULL handling.</span>
<a href="#l96.93"></a><span id="l96.93" class="difflineplus">+  check_levenshtein(db, &quot;foo&quot;, null, null);</span>
<a href="#l96.94"></a><span id="l96.94" class="difflineplus">+  check_levenshtein(db, null, &quot;bar&quot;, null);</span>
<a href="#l96.95"></a><span id="l96.95" class="difflineplus">+  check_levenshtein(db, null, null, null);</span>
<a href="#l96.96"></a><span id="l96.96" class="difflineplus">+  </span>
<a href="#l96.97"></a><span id="l96.97" class="difflineplus">+  // The levenshteinDistance function allocates temporary memory on the stack</span>
<a href="#l96.98"></a><span id="l96.98" class="difflineplus">+  // if it can.  Test some strings long enough to force a heap allocation.</span>
<a href="#l96.99"></a><span id="l96.99" class="difflineplus">+  var dots1000 = Array(1001).join(&quot;.&quot;);</span>
<a href="#l96.100"></a><span id="l96.100" class="difflineplus">+  var dashes1000 = Array(1001).join(&quot;-&quot;);</span>
<a href="#l96.101"></a><span id="l96.101" class="difflineplus">+  check_levenshtein(db, dots1000, dashes1000, 1000);</span>
<a href="#l96.102"></a><span id="l96.102" class="difflineplus">+}</span>
<a href="#l96.103"></a><span id="l96.103" class="difflineplus">+</span>
<a href="#l96.104"></a><span id="l96.104" class="difflineplus">+function run_test()</span>
<a href="#l96.105"></a><span id="l96.105" class="difflineplus">+{</span>
<a href="#l96.106"></a><span id="l96.106" class="difflineplus">+  testLevenshtein(getOpenedDatabase());</span>
<a href="#l96.107"></a><span id="l96.107" class="difflineplus">+  testLevenshtein(createUtf16Database());</span>
<a href="#l96.108"></a><span id="l96.108" class="difflineplus">+}</span>
<a href="#l96.109"></a><span id="l96.109" class="difflineplus">+</span>
<a href="#l96.110"></a><span id="l96.110" class="difflineplus">+</span>
<a href="#l96.111"></a><span id="l96.111" class="difflineplus">+</span>
<a href="#l96.112"></a><span id="l96.112" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1">new file mode 100644</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineminus">--- /dev/null</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineplus">+++ b/storage-backport/test/unit/test_like.js</span>
<a href="#l97.4"></a><span id="l97.4" class="difflineat">@@ -0,0 +1,237 @@</span>
<a href="#l97.5"></a><span id="l97.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l97.6"></a><span id="l97.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l97.7"></a><span id="l97.7" class="difflineplus">+ *</span>
<a href="#l97.8"></a><span id="l97.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l97.9"></a><span id="l97.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l97.10"></a><span id="l97.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l97.11"></a><span id="l97.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineplus">+ *</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l97.14"></a><span id="l97.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l97.15"></a><span id="l97.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l97.16"></a><span id="l97.16" class="difflineplus">+ * License.</span>
<a href="#l97.17"></a><span id="l97.17" class="difflineplus">+ *</span>
<a href="#l97.18"></a><span id="l97.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l97.19"></a><span id="l97.19" class="difflineplus">+ *</span>
<a href="#l97.20"></a><span id="l97.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l97.21"></a><span id="l97.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l97.22"></a><span id="l97.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l97.23"></a><span id="l97.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l97.24"></a><span id="l97.24" class="difflineplus">+ *</span>
<a href="#l97.25"></a><span id="l97.25" class="difflineplus">+ * This code is based off of like.test from the sqlite code</span>
<a href="#l97.26"></a><span id="l97.26" class="difflineplus">+ *</span>
<a href="#l97.27"></a><span id="l97.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l97.28"></a><span id="l97.28" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@mozilla.org&gt; (Original Author)</span>
<a href="#l97.29"></a><span id="l97.29" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt;</span>
<a href="#l97.30"></a><span id="l97.30" class="difflineplus">+ *</span>
<a href="#l97.31"></a><span id="l97.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l97.32"></a><span id="l97.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l97.33"></a><span id="l97.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l97.34"></a><span id="l97.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l97.35"></a><span id="l97.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l97.36"></a><span id="l97.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l97.37"></a><span id="l97.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l97.38"></a><span id="l97.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l97.39"></a><span id="l97.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l97.40"></a><span id="l97.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l97.41"></a><span id="l97.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l97.42"></a><span id="l97.42" class="difflineplus">+ *</span>
<a href="#l97.43"></a><span id="l97.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l97.44"></a><span id="l97.44" class="difflineplus">+</span>
<a href="#l97.45"></a><span id="l97.45" class="difflineplus">+// This file tests our LIKE implementation since we override it for unicode</span>
<a href="#l97.46"></a><span id="l97.46" class="difflineplus">+</span>
<a href="#l97.47"></a><span id="l97.47" class="difflineplus">+function setup()</span>
<a href="#l97.48"></a><span id="l97.48" class="difflineplus">+{</span>
<a href="#l97.49"></a><span id="l97.49" class="difflineplus">+  getOpenedDatabase().createTable(&quot;t1&quot;, &quot;x TEXT&quot;);</span>
<a href="#l97.50"></a><span id="l97.50" class="difflineplus">+</span>
<a href="#l97.51"></a><span id="l97.51" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('a')&quot;);</span>
<a href="#l97.52"></a><span id="l97.52" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.53"></a><span id="l97.53" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.54"></a><span id="l97.54" class="difflineplus">+</span>
<a href="#l97.55"></a><span id="l97.55" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('ab')&quot;);</span>
<a href="#l97.56"></a><span id="l97.56" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.57"></a><span id="l97.57" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.58"></a><span id="l97.58" class="difflineplus">+</span>
<a href="#l97.59"></a><span id="l97.59" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('abc')&quot;);</span>
<a href="#l97.60"></a><span id="l97.60" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.61"></a><span id="l97.61" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.62"></a><span id="l97.62" class="difflineplus">+</span>
<a href="#l97.63"></a><span id="l97.63" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('abcd')&quot;);</span>
<a href="#l97.64"></a><span id="l97.64" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.65"></a><span id="l97.65" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.66"></a><span id="l97.66" class="difflineplus">+</span>
<a href="#l97.67"></a><span id="l97.67" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('acd')&quot;);</span>
<a href="#l97.68"></a><span id="l97.68" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.69"></a><span id="l97.69" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.70"></a><span id="l97.70" class="difflineplus">+</span>
<a href="#l97.71"></a><span id="l97.71" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('abd')&quot;);</span>
<a href="#l97.72"></a><span id="l97.72" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.73"></a><span id="l97.73" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.74"></a><span id="l97.74" class="difflineplus">+</span>
<a href="#l97.75"></a><span id="l97.75" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('bc')&quot;);</span>
<a href="#l97.76"></a><span id="l97.76" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.77"></a><span id="l97.77" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.78"></a><span id="l97.78" class="difflineplus">+</span>
<a href="#l97.79"></a><span id="l97.79" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('bcd')&quot;);</span>
<a href="#l97.80"></a><span id="l97.80" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.81"></a><span id="l97.81" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.82"></a><span id="l97.82" class="difflineplus">+</span>
<a href="#l97.83"></a><span id="l97.83" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('xyz')&quot;);</span>
<a href="#l97.84"></a><span id="l97.84" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.85"></a><span id="l97.85" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.86"></a><span id="l97.86" class="difflineplus">+</span>
<a href="#l97.87"></a><span id="l97.87" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('ABC')&quot;);</span>
<a href="#l97.88"></a><span id="l97.88" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.89"></a><span id="l97.89" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.90"></a><span id="l97.90" class="difflineplus">+</span>
<a href="#l97.91"></a><span id="l97.91" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('CDE')&quot;);</span>
<a href="#l97.92"></a><span id="l97.92" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.93"></a><span id="l97.93" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.94"></a><span id="l97.94" class="difflineplus">+</span>
<a href="#l97.95"></a><span id="l97.95" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('ABC abc xyz')&quot;);</span>
<a href="#l97.96"></a><span id="l97.96" class="difflineplus">+  stmt.execute();</span>
<a href="#l97.97"></a><span id="l97.97" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.98"></a><span id="l97.98" class="difflineplus">+}</span>
<a href="#l97.99"></a><span id="l97.99" class="difflineplus">+</span>
<a href="#l97.100"></a><span id="l97.100" class="difflineplus">+function test_count()</span>
<a href="#l97.101"></a><span id="l97.101" class="difflineplus">+{</span>
<a href="#l97.102"></a><span id="l97.102" class="difflineplus">+  var stmt = createStatement(&quot;SELECT count(*) FROM t1;&quot;);</span>
<a href="#l97.103"></a><span id="l97.103" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.104"></a><span id="l97.104" class="difflineplus">+  do_check_eq(stmt.getInt32(0), 12);</span>
<a href="#l97.105"></a><span id="l97.105" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.106"></a><span id="l97.106" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.107"></a><span id="l97.107" class="difflineplus">+}</span>
<a href="#l97.108"></a><span id="l97.108" class="difflineplus">+</span>
<a href="#l97.109"></a><span id="l97.109" class="difflineplus">+function test_like_1()</span>
<a href="#l97.110"></a><span id="l97.110" class="difflineplus">+{</span>
<a href="#l97.111"></a><span id="l97.111" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.112"></a><span id="l97.112" class="difflineplus">+  stmt.bindStringParameter(0, 'abc');</span>
<a href="#l97.113"></a><span id="l97.113" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;ABC&quot;];</span>
<a href="#l97.114"></a><span id="l97.114" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.115"></a><span id="l97.115" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.116"></a><span id="l97.116" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.117"></a><span id="l97.117" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.118"></a><span id="l97.118" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.119"></a><span id="l97.119" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.120"></a><span id="l97.120" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.121"></a><span id="l97.121" class="difflineplus">+}</span>
<a href="#l97.122"></a><span id="l97.122" class="difflineplus">+</span>
<a href="#l97.123"></a><span id="l97.123" class="difflineplus">+function test_like_2()</span>
<a href="#l97.124"></a><span id="l97.124" class="difflineplus">+{</span>
<a href="#l97.125"></a><span id="l97.125" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.126"></a><span id="l97.126" class="difflineplus">+  stmt.bindStringParameter(0, 'ABC');</span>
<a href="#l97.127"></a><span id="l97.127" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;ABC&quot;];</span>
<a href="#l97.128"></a><span id="l97.128" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.129"></a><span id="l97.129" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.130"></a><span id="l97.130" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.131"></a><span id="l97.131" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.132"></a><span id="l97.132" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.133"></a><span id="l97.133" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.134"></a><span id="l97.134" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.135"></a><span id="l97.135" class="difflineplus">+}</span>
<a href="#l97.136"></a><span id="l97.136" class="difflineplus">+    </span>
<a href="#l97.137"></a><span id="l97.137" class="difflineplus">+function test_like_3()</span>
<a href="#l97.138"></a><span id="l97.138" class="difflineplus">+{</span>
<a href="#l97.139"></a><span id="l97.139" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.140"></a><span id="l97.140" class="difflineplus">+  stmt.bindStringParameter(0, 'aBc');</span>
<a href="#l97.141"></a><span id="l97.141" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;ABC&quot;];</span>
<a href="#l97.142"></a><span id="l97.142" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.143"></a><span id="l97.143" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.144"></a><span id="l97.144" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.145"></a><span id="l97.145" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.146"></a><span id="l97.146" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.147"></a><span id="l97.147" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.148"></a><span id="l97.148" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.149"></a><span id="l97.149" class="difflineplus">+}</span>
<a href="#l97.150"></a><span id="l97.150" class="difflineplus">+   </span>
<a href="#l97.151"></a><span id="l97.151" class="difflineplus">+function test_like_4()</span>
<a href="#l97.152"></a><span id="l97.152" class="difflineplus">+{</span>
<a href="#l97.153"></a><span id="l97.153" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.154"></a><span id="l97.154" class="difflineplus">+  stmt.bindStringParameter(0, 'abc%');</span>
<a href="#l97.155"></a><span id="l97.155" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;abcd&quot;, &quot;ABC&quot;, &quot;ABC abc xyz&quot;];</span>
<a href="#l97.156"></a><span id="l97.156" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.157"></a><span id="l97.157" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.158"></a><span id="l97.158" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.159"></a><span id="l97.159" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.160"></a><span id="l97.160" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.161"></a><span id="l97.161" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.162"></a><span id="l97.162" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.163"></a><span id="l97.163" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.164"></a><span id="l97.164" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.165"></a><span id="l97.165" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.166"></a><span id="l97.166" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.167"></a><span id="l97.167" class="difflineplus">+}</span>
<a href="#l97.168"></a><span id="l97.168" class="difflineplus">+</span>
<a href="#l97.169"></a><span id="l97.169" class="difflineplus">+function test_like_5()</span>
<a href="#l97.170"></a><span id="l97.170" class="difflineplus">+{</span>
<a href="#l97.171"></a><span id="l97.171" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.172"></a><span id="l97.172" class="difflineplus">+  stmt.bindStringParameter(0, 'a_c');</span>
<a href="#l97.173"></a><span id="l97.173" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;ABC&quot;];</span>
<a href="#l97.174"></a><span id="l97.174" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.175"></a><span id="l97.175" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.176"></a><span id="l97.176" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.177"></a><span id="l97.177" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.178"></a><span id="l97.178" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.179"></a><span id="l97.179" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.180"></a><span id="l97.180" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.181"></a><span id="l97.181" class="difflineplus">+}</span>
<a href="#l97.182"></a><span id="l97.182" class="difflineplus">+</span>
<a href="#l97.183"></a><span id="l97.183" class="difflineplus">+function test_like_6()</span>
<a href="#l97.184"></a><span id="l97.184" class="difflineplus">+{</span>
<a href="#l97.185"></a><span id="l97.185" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.186"></a><span id="l97.186" class="difflineplus">+  stmt.bindStringParameter(0, 'ab%d');</span>
<a href="#l97.187"></a><span id="l97.187" class="difflineplus">+  var solutions = [&quot;abcd&quot;, &quot;abd&quot;];</span>
<a href="#l97.188"></a><span id="l97.188" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.189"></a><span id="l97.189" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.190"></a><span id="l97.190" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.191"></a><span id="l97.191" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.192"></a><span id="l97.192" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.193"></a><span id="l97.193" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.194"></a><span id="l97.194" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.195"></a><span id="l97.195" class="difflineplus">+}</span>
<a href="#l97.196"></a><span id="l97.196" class="difflineplus">+    </span>
<a href="#l97.197"></a><span id="l97.197" class="difflineplus">+function test_like_7()</span>
<a href="#l97.198"></a><span id="l97.198" class="difflineplus">+{</span>
<a href="#l97.199"></a><span id="l97.199" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.200"></a><span id="l97.200" class="difflineplus">+  stmt.bindStringParameter(0, 'a_c%');</span>
<a href="#l97.201"></a><span id="l97.201" class="difflineplus">+  var solutions = [&quot;abc&quot;, &quot;abcd&quot;, &quot;ABC&quot;, &quot;ABC abc xyz&quot;];</span>
<a href="#l97.202"></a><span id="l97.202" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.203"></a><span id="l97.203" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.204"></a><span id="l97.204" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.205"></a><span id="l97.205" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.206"></a><span id="l97.206" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.207"></a><span id="l97.207" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.208"></a><span id="l97.208" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.209"></a><span id="l97.209" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.210"></a><span id="l97.210" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.211"></a><span id="l97.211" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.212"></a><span id="l97.212" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.213"></a><span id="l97.213" class="difflineplus">+}</span>
<a href="#l97.214"></a><span id="l97.214" class="difflineplus">+</span>
<a href="#l97.215"></a><span id="l97.215" class="difflineplus">+function test_like_8()</span>
<a href="#l97.216"></a><span id="l97.216" class="difflineplus">+{</span>
<a href="#l97.217"></a><span id="l97.217" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?;&quot;);</span>
<a href="#l97.218"></a><span id="l97.218" class="difflineplus">+  stmt.bindStringParameter(0, '%bcd');</span>
<a href="#l97.219"></a><span id="l97.219" class="difflineplus">+  var solutions = [&quot;abcd&quot;, &quot;bcd&quot;];</span>
<a href="#l97.220"></a><span id="l97.220" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.221"></a><span id="l97.221" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.222"></a><span id="l97.222" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l97.223"></a><span id="l97.223" class="difflineplus">+  do_check_true(solutions.indexOf(stmt.getString(0)) != -1);</span>
<a href="#l97.224"></a><span id="l97.224" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l97.225"></a><span id="l97.225" class="difflineplus">+  stmt.reset();</span>
<a href="#l97.226"></a><span id="l97.226" class="difflineplus">+  stmt.finalize();</span>
<a href="#l97.227"></a><span id="l97.227" class="difflineplus">+}</span>
<a href="#l97.228"></a><span id="l97.228" class="difflineplus">+    </span>
<a href="#l97.229"></a><span id="l97.229" class="difflineplus">+var tests = [test_count, test_like_1, test_like_2, test_like_3, test_like_4, </span>
<a href="#l97.230"></a><span id="l97.230" class="difflineplus">+             test_like_5, test_like_6, test_like_7, test_like_8];</span>
<a href="#l97.231"></a><span id="l97.231" class="difflineplus">+</span>
<a href="#l97.232"></a><span id="l97.232" class="difflineplus">+function run_test()</span>
<a href="#l97.233"></a><span id="l97.233" class="difflineplus">+{</span>
<a href="#l97.234"></a><span id="l97.234" class="difflineplus">+  setup();</span>
<a href="#l97.235"></a><span id="l97.235" class="difflineplus">+</span>
<a href="#l97.236"></a><span id="l97.236" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l97.237"></a><span id="l97.237" class="difflineplus">+    tests[i]();</span>
<a href="#l97.238"></a><span id="l97.238" class="difflineplus">+    </span>
<a href="#l97.239"></a><span id="l97.239" class="difflineplus">+  cleanup();</span>
<a href="#l97.240"></a><span id="l97.240" class="difflineplus">+}</span>
<a href="#l97.241"></a><span id="l97.241" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1">new file mode 100644</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineminus">--- /dev/null</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineplus">+++ b/storage-backport/test/unit/test_like_escape.js</span>
<a href="#l98.4"></a><span id="l98.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l98.5"></a><span id="l98.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l98.6"></a><span id="l98.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l98.7"></a><span id="l98.7" class="difflineplus">+ *</span>
<a href="#l98.8"></a><span id="l98.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l98.9"></a><span id="l98.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l98.10"></a><span id="l98.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l98.11"></a><span id="l98.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineplus">+ *</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l98.14"></a><span id="l98.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l98.15"></a><span id="l98.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l98.16"></a><span id="l98.16" class="difflineplus">+ * License.</span>
<a href="#l98.17"></a><span id="l98.17" class="difflineplus">+ *</span>
<a href="#l98.18"></a><span id="l98.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l98.19"></a><span id="l98.19" class="difflineplus">+ *</span>
<a href="#l98.20"></a><span id="l98.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l98.21"></a><span id="l98.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l98.22"></a><span id="l98.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l98.23"></a><span id="l98.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l98.24"></a><span id="l98.24" class="difflineplus">+ *</span>
<a href="#l98.25"></a><span id="l98.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l98.26"></a><span id="l98.26" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@mozilla.org&gt; (Original Author)</span>
<a href="#l98.27"></a><span id="l98.27" class="difflineplus">+ *</span>
<a href="#l98.28"></a><span id="l98.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l98.29"></a><span id="l98.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l98.30"></a><span id="l98.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l98.31"></a><span id="l98.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l98.32"></a><span id="l98.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l98.33"></a><span id="l98.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l98.34"></a><span id="l98.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l98.35"></a><span id="l98.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l98.36"></a><span id="l98.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l98.37"></a><span id="l98.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l98.38"></a><span id="l98.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l98.39"></a><span id="l98.39" class="difflineplus">+ *</span>
<a href="#l98.40"></a><span id="l98.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l98.41"></a><span id="l98.41" class="difflineplus">+</span>
<a href="#l98.42"></a><span id="l98.42" class="difflineplus">+const LATIN1_AE = &quot;\xc6&quot;;</span>
<a href="#l98.43"></a><span id="l98.43" class="difflineplus">+const LATIN1_ae = &quot;\xe6&quot;; </span>
<a href="#l98.44"></a><span id="l98.44" class="difflineplus">+</span>
<a href="#l98.45"></a><span id="l98.45" class="difflineplus">+function setup()</span>
<a href="#l98.46"></a><span id="l98.46" class="difflineplus">+{</span>
<a href="#l98.47"></a><span id="l98.47" class="difflineplus">+  getOpenedDatabase().createTable(&quot;t1&quot;, &quot;x TEXT&quot;);</span>
<a href="#l98.48"></a><span id="l98.48" class="difflineplus">+</span>
<a href="#l98.49"></a><span id="l98.49" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES ('foo/bar_baz%20cheese')&quot;);</span>
<a href="#l98.50"></a><span id="l98.50" class="difflineplus">+  stmt.execute();</span>
<a href="#l98.51"></a><span id="l98.51" class="difflineplus">+  stmt.finalize();</span>
<a href="#l98.52"></a><span id="l98.52" class="difflineplus">+</span>
<a href="#l98.53"></a><span id="l98.53" class="difflineplus">+  stmt = createStatement(&quot;INSERT INTO t1 (x) VALUES (?1)&quot;);</span>
<a href="#l98.54"></a><span id="l98.54" class="difflineplus">+  // insert LATIN_ae, but search on LATIN_AE</span>
<a href="#l98.55"></a><span id="l98.55" class="difflineplus">+  stmt.bindStringParameter(0, &quot;foo%20&quot; + LATIN1_ae + &quot;/_bar&quot;);</span>
<a href="#l98.56"></a><span id="l98.56" class="difflineplus">+  stmt.execute();</span>
<a href="#l98.57"></a><span id="l98.57" class="difflineplus">+  stmt.finalize();</span>
<a href="#l98.58"></a><span id="l98.58" class="difflineplus">+}</span>
<a href="#l98.59"></a><span id="l98.59" class="difflineplus">+    </span>
<a href="#l98.60"></a><span id="l98.60" class="difflineplus">+function test_escape_for_like_ascii()</span>
<a href="#l98.61"></a><span id="l98.61" class="difflineplus">+{</span>
<a href="#l98.62"></a><span id="l98.62" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?1 ESCAPE '/'&quot;);</span>
<a href="#l98.63"></a><span id="l98.63" class="difflineplus">+  var paramForLike = stmt.escapeStringForLIKE(&quot;oo/bar_baz%20chees&quot;, '/');</span>
<a href="#l98.64"></a><span id="l98.64" class="difflineplus">+  // verify that we escaped / _ and %</span>
<a href="#l98.65"></a><span id="l98.65" class="difflineplus">+  do_check_eq(paramForLike, &quot;oo//bar/_baz/%20chees&quot;);</span>
<a href="#l98.66"></a><span id="l98.66" class="difflineplus">+  // prepend and append with % for &quot;contains&quot;</span>
<a href="#l98.67"></a><span id="l98.67" class="difflineplus">+  stmt.bindStringParameter(0, &quot;%&quot; + paramForLike + &quot;%&quot;); </span>
<a href="#l98.68"></a><span id="l98.68" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l98.69"></a><span id="l98.69" class="difflineplus">+  do_check_eq(&quot;foo/bar_baz%20cheese&quot;, stmt.getString(0));</span>
<a href="#l98.70"></a><span id="l98.70" class="difflineplus">+  stmt.finalize();</span>
<a href="#l98.71"></a><span id="l98.71" class="difflineplus">+}</span>
<a href="#l98.72"></a><span id="l98.72" class="difflineplus">+</span>
<a href="#l98.73"></a><span id="l98.73" class="difflineplus">+function test_escape_for_like_non_ascii()</span>
<a href="#l98.74"></a><span id="l98.74" class="difflineplus">+{</span>
<a href="#l98.75"></a><span id="l98.75" class="difflineplus">+  var stmt = createStatement(&quot;SELECT x FROM t1 WHERE x LIKE ?1 ESCAPE '/'&quot;);</span>
<a href="#l98.76"></a><span id="l98.76" class="difflineplus">+  var paramForLike = stmt.escapeStringForLIKE(&quot;oo%20&quot; + LATIN1_AE + &quot;/_ba&quot;, '/');</span>
<a href="#l98.77"></a><span id="l98.77" class="difflineplus">+  // verify that we escaped / _ and %</span>
<a href="#l98.78"></a><span id="l98.78" class="difflineplus">+  do_check_eq(paramForLike, &quot;oo/%20&quot; + LATIN1_AE + &quot;///_ba&quot;);</span>
<a href="#l98.79"></a><span id="l98.79" class="difflineplus">+  // prepend and append with % for &quot;contains&quot;</span>
<a href="#l98.80"></a><span id="l98.80" class="difflineplus">+  stmt.bindStringParameter(0, &quot;%&quot; + paramForLike + &quot;%&quot;);</span>
<a href="#l98.81"></a><span id="l98.81" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l98.82"></a><span id="l98.82" class="difflineplus">+  do_check_eq(&quot;foo%20&quot; + LATIN1_ae + &quot;/_bar&quot;, stmt.getString(0));</span>
<a href="#l98.83"></a><span id="l98.83" class="difflineplus">+  stmt.finalize();</span>
<a href="#l98.84"></a><span id="l98.84" class="difflineplus">+}</span>
<a href="#l98.85"></a><span id="l98.85" class="difflineplus">+</span>
<a href="#l98.86"></a><span id="l98.86" class="difflineplus">+var tests = [test_escape_for_like_ascii, test_escape_for_like_non_ascii];</span>
<a href="#l98.87"></a><span id="l98.87" class="difflineplus">+</span>
<a href="#l98.88"></a><span id="l98.88" class="difflineplus">+function run_test()</span>
<a href="#l98.89"></a><span id="l98.89" class="difflineplus">+{</span>
<a href="#l98.90"></a><span id="l98.90" class="difflineplus">+  setup();</span>
<a href="#l98.91"></a><span id="l98.91" class="difflineplus">+</span>
<a href="#l98.92"></a><span id="l98.92" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l98.93"></a><span id="l98.93" class="difflineplus">+    tests[i]();</span>
<a href="#l98.94"></a><span id="l98.94" class="difflineplus">+    </span>
<a href="#l98.95"></a><span id="l98.95" class="difflineplus">+  cleanup();</span>
<a href="#l98.96"></a><span id="l98.96" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1">new file mode 100644</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineminus">--- /dev/null</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineplus">+++ b/storage-backport/test/unit/test_locale_collation.js</span>
<a href="#l99.4"></a><span id="l99.4" class="difflineat">@@ -0,0 +1,337 @@</span>
<a href="#l99.5"></a><span id="l99.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l99.6"></a><span id="l99.6" class="difflineplus">+ * vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l99.7"></a><span id="l99.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l99.8"></a><span id="l99.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l99.9"></a><span id="l99.9" class="difflineplus">+ *</span>
<a href="#l99.10"></a><span id="l99.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l99.11"></a><span id="l99.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l99.14"></a><span id="l99.14" class="difflineplus">+ *</span>
<a href="#l99.15"></a><span id="l99.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l99.16"></a><span id="l99.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l99.17"></a><span id="l99.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l99.18"></a><span id="l99.18" class="difflineplus">+ * License.</span>
<a href="#l99.19"></a><span id="l99.19" class="difflineplus">+ *</span>
<a href="#l99.20"></a><span id="l99.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l99.21"></a><span id="l99.21" class="difflineplus">+ *</span>
<a href="#l99.22"></a><span id="l99.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l99.23"></a><span id="l99.23" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l99.24"></a><span id="l99.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l99.25"></a><span id="l99.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l99.26"></a><span id="l99.26" class="difflineplus">+ *</span>
<a href="#l99.27"></a><span id="l99.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l99.28"></a><span id="l99.28" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt; (Original Author)</span>
<a href="#l99.29"></a><span id="l99.29" class="difflineplus">+ *</span>
<a href="#l99.30"></a><span id="l99.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l99.31"></a><span id="l99.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l99.32"></a><span id="l99.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l99.33"></a><span id="l99.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l99.34"></a><span id="l99.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l99.35"></a><span id="l99.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l99.38"></a><span id="l99.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l99.39"></a><span id="l99.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l99.40"></a><span id="l99.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l99.41"></a><span id="l99.41" class="difflineplus">+ *</span>
<a href="#l99.42"></a><span id="l99.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l99.43"></a><span id="l99.43" class="difflineplus">+</span>
<a href="#l99.44"></a><span id="l99.44" class="difflineplus">+/**</span>
<a href="#l99.45"></a><span id="l99.45" class="difflineplus">+ * Bug 499990 - Locale-aware collation</span>
<a href="#l99.46"></a><span id="l99.46" class="difflineplus">+ *</span>
<a href="#l99.47"></a><span id="l99.47" class="difflineplus">+ * Tests our custom, locale-aware collating sequences.</span>
<a href="#l99.48"></a><span id="l99.48" class="difflineplus">+ */</span>
<a href="#l99.49"></a><span id="l99.49" class="difflineplus">+</span>
<a href="#l99.50"></a><span id="l99.50" class="difflineplus">+// The name of the file containing the strings we'll sort during this test.</span>
<a href="#l99.51"></a><span id="l99.51" class="difflineplus">+// The file's data is taken from intl/locale/tests/sort/us-ascii_base.txt and</span>
<a href="#l99.52"></a><span id="l99.52" class="difflineplus">+// and intl/locale/tests/sort/us-ascii_sort.txt.</span>
<a href="#l99.53"></a><span id="l99.53" class="difflineplus">+const DATA_BASENAME = &quot;locale_collation.txt&quot;;</span>
<a href="#l99.54"></a><span id="l99.54" class="difflineplus">+</span>
<a href="#l99.55"></a><span id="l99.55" class="difflineplus">+// The test data from DATA_BASENAME is read into this array.</span>
<a href="#l99.56"></a><span id="l99.56" class="difflineplus">+var gStrings;</span>
<a href="#l99.57"></a><span id="l99.57" class="difflineplus">+</span>
<a href="#l99.58"></a><span id="l99.58" class="difflineplus">+// A collation created from the application's locale.  Used by localeCompare().</span>
<a href="#l99.59"></a><span id="l99.59" class="difflineplus">+var gLocaleCollation;</span>
<a href="#l99.60"></a><span id="l99.60" class="difflineplus">+</span>
<a href="#l99.61"></a><span id="l99.61" class="difflineplus">+// A connection to our in-memory UTF-16-encoded database.</span>
<a href="#l99.62"></a><span id="l99.62" class="difflineplus">+var gUtf16Conn;</span>
<a href="#l99.63"></a><span id="l99.63" class="difflineplus">+</span>
<a href="#l99.64"></a><span id="l99.64" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l99.65"></a><span id="l99.65" class="difflineplus">+//// Helper Functions</span>
<a href="#l99.66"></a><span id="l99.66" class="difflineplus">+</span>
<a href="#l99.67"></a><span id="l99.67" class="difflineplus">+/**</span>
<a href="#l99.68"></a><span id="l99.68" class="difflineplus">+ * Since we create a UTF-16 database we have to clean it up, in addition to</span>
<a href="#l99.69"></a><span id="l99.69" class="difflineplus">+ * the normal cleanup of Storage tests.</span>
<a href="#l99.70"></a><span id="l99.70" class="difflineplus">+ */</span>
<a href="#l99.71"></a><span id="l99.71" class="difflineplus">+function cleanupLocaleTests()</span>
<a href="#l99.72"></a><span id="l99.72" class="difflineplus">+{</span>
<a href="#l99.73"></a><span id="l99.73" class="difflineplus">+  print(&quot;-- Cleaning up test_locale_collation.js suite.&quot;);</span>
<a href="#l99.74"></a><span id="l99.74" class="difflineplus">+  gUtf16Conn.close();</span>
<a href="#l99.75"></a><span id="l99.75" class="difflineplus">+  cleanup();</span>
<a href="#l99.76"></a><span id="l99.76" class="difflineplus">+}</span>
<a href="#l99.77"></a><span id="l99.77" class="difflineplus">+</span>
<a href="#l99.78"></a><span id="l99.78" class="difflineplus">+/**</span>
<a href="#l99.79"></a><span id="l99.79" class="difflineplus">+ * Creates a test database similar to the default one created in</span>
<a href="#l99.80"></a><span id="l99.80" class="difflineplus">+ * head_storage.js, except that this one uses UTF-16 encoding.</span>
<a href="#l99.81"></a><span id="l99.81" class="difflineplus">+ *</span>
<a href="#l99.82"></a><span id="l99.82" class="difflineplus">+ * @return A connection to the database.</span>
<a href="#l99.83"></a><span id="l99.83" class="difflineplus">+ */</span>
<a href="#l99.84"></a><span id="l99.84" class="difflineplus">+function createUtf16Database()</span>
<a href="#l99.85"></a><span id="l99.85" class="difflineplus">+{</span>
<a href="#l99.86"></a><span id="l99.86" class="difflineplus">+  print(&quot;Creating the in-memory UTF-16-encoded database.&quot;);</span>
<a href="#l99.87"></a><span id="l99.87" class="difflineplus">+  let conn = getService().openSpecialDatabase(&quot;memory&quot;);</span>
<a href="#l99.88"></a><span id="l99.88" class="difflineplus">+  conn.executeSimpleSQL(&quot;PRAGMA encoding = 'UTF-16'&quot;);</span>
<a href="#l99.89"></a><span id="l99.89" class="difflineplus">+</span>
<a href="#l99.90"></a><span id="l99.90" class="difflineplus">+  print(&quot;Make sure the encoding was set correctly and is now UTF-16.&quot;);</span>
<a href="#l99.91"></a><span id="l99.91" class="difflineplus">+  let stmt = conn.createStatement(&quot;PRAGMA encoding&quot;);</span>
<a href="#l99.92"></a><span id="l99.92" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l99.93"></a><span id="l99.93" class="difflineplus">+  let enc = stmt.getString(0);</span>
<a href="#l99.94"></a><span id="l99.94" class="difflineplus">+  stmt.finalize();</span>
<a href="#l99.95"></a><span id="l99.95" class="difflineplus">+</span>
<a href="#l99.96"></a><span id="l99.96" class="difflineplus">+  // The value returned will actually be UTF-16le or UTF-16be.</span>
<a href="#l99.97"></a><span id="l99.97" class="difflineplus">+  do_check_true(enc === &quot;UTF-16le&quot; || enc === &quot;UTF-16be&quot;);</span>
<a href="#l99.98"></a><span id="l99.98" class="difflineplus">+</span>
<a href="#l99.99"></a><span id="l99.99" class="difflineplus">+  return conn;</span>
<a href="#l99.100"></a><span id="l99.100" class="difflineplus">+}</span>
<a href="#l99.101"></a><span id="l99.101" class="difflineplus">+</span>
<a href="#l99.102"></a><span id="l99.102" class="difflineplus">+/**</span>
<a href="#l99.103"></a><span id="l99.103" class="difflineplus">+ * Compares aActual to aExpected, ensuring that the numbers and orderings of</span>
<a href="#l99.104"></a><span id="l99.104" class="difflineplus">+ * the two arrays' elements are the same.</span>
<a href="#l99.105"></a><span id="l99.105" class="difflineplus">+ *</span>
<a href="#l99.106"></a><span id="l99.106" class="difflineplus">+ * @param aActual</span>
<a href="#l99.107"></a><span id="l99.107" class="difflineplus">+ *        An array of strings retrieved from the database.</span>
<a href="#l99.108"></a><span id="l99.108" class="difflineplus">+ * @param aExpected</span>
<a href="#l99.109"></a><span id="l99.109" class="difflineplus">+ *        An array of strings to which aActual should be equivalent.</span>
<a href="#l99.110"></a><span id="l99.110" class="difflineplus">+ */</span>
<a href="#l99.111"></a><span id="l99.111" class="difflineplus">+function ensureResultsAreCorrect(aActual, aExpected)</span>
<a href="#l99.112"></a><span id="l99.112" class="difflineplus">+{</span>
<a href="#l99.113"></a><span id="l99.113" class="difflineplus">+  print(&quot;Actual results:   &quot; + aActual);</span>
<a href="#l99.114"></a><span id="l99.114" class="difflineplus">+  print(&quot;Expected results: &quot; + aExpected);</span>
<a href="#l99.115"></a><span id="l99.115" class="difflineplus">+</span>
<a href="#l99.116"></a><span id="l99.116" class="difflineplus">+  do_check_eq(aActual.length, aExpected.length);</span>
<a href="#l99.117"></a><span id="l99.117" class="difflineplus">+  for (let i = 0; i &lt; aActual.length; i++)</span>
<a href="#l99.118"></a><span id="l99.118" class="difflineplus">+    do_check_eq(aActual[i], aExpected[i]);</span>
<a href="#l99.119"></a><span id="l99.119" class="difflineplus">+}</span>
<a href="#l99.120"></a><span id="l99.120" class="difflineplus">+</span>
<a href="#l99.121"></a><span id="l99.121" class="difflineplus">+/**</span>
<a href="#l99.122"></a><span id="l99.122" class="difflineplus">+ * Synchronously SELECTs all rows from the test table of the given database</span>
<a href="#l99.123"></a><span id="l99.123" class="difflineplus">+ * using the given collation.</span>
<a href="#l99.124"></a><span id="l99.124" class="difflineplus">+ *</span>
<a href="#l99.125"></a><span id="l99.125" class="difflineplus">+ * @param  aCollation</span>
<a href="#l99.126"></a><span id="l99.126" class="difflineplus">+ *         The name of one of our custom locale collations.  The rows are</span>
<a href="#l99.127"></a><span id="l99.127" class="difflineplus">+ *         ordered by this collation.</span>
<a href="#l99.128"></a><span id="l99.128" class="difflineplus">+ * @param  aConn</span>
<a href="#l99.129"></a><span id="l99.129" class="difflineplus">+ *         A connection to either the UTF-8 database or the UTF-16 database.</span>
<a href="#l99.130"></a><span id="l99.130" class="difflineplus">+ * @return The resulting strings in an array.</span>
<a href="#l99.131"></a><span id="l99.131" class="difflineplus">+ */</span>
<a href="#l99.132"></a><span id="l99.132" class="difflineplus">+function getResults(aCollation, aConn)</span>
<a href="#l99.133"></a><span id="l99.133" class="difflineplus">+{</span>
<a href="#l99.134"></a><span id="l99.134" class="difflineplus">+  let results = [];</span>
<a href="#l99.135"></a><span id="l99.135" class="difflineplus">+  let stmt = aConn.createStatement(&quot;SELECT t FROM test &quot; +</span>
<a href="#l99.136"></a><span id="l99.136" class="difflineplus">+                                   &quot;ORDER BY t COLLATE &quot; + aCollation + &quot; ASC&quot;);</span>
<a href="#l99.137"></a><span id="l99.137" class="difflineplus">+  while (stmt.executeStep())</span>
<a href="#l99.138"></a><span id="l99.138" class="difflineplus">+    results.push(stmt.row.t);</span>
<a href="#l99.139"></a><span id="l99.139" class="difflineplus">+  stmt.finalize();</span>
<a href="#l99.140"></a><span id="l99.140" class="difflineplus">+  return results;</span>
<a href="#l99.141"></a><span id="l99.141" class="difflineplus">+}</span>
<a href="#l99.142"></a><span id="l99.142" class="difflineplus">+</span>
<a href="#l99.143"></a><span id="l99.143" class="difflineplus">+/**</span>
<a href="#l99.144"></a><span id="l99.144" class="difflineplus">+ * Inserts strings into our test table of the given database in the order given.</span>
<a href="#l99.145"></a><span id="l99.145" class="difflineplus">+ *</span>
<a href="#l99.146"></a><span id="l99.146" class="difflineplus">+ * @param aStrings</span>
<a href="#l99.147"></a><span id="l99.147" class="difflineplus">+ *        An array of strings.</span>
<a href="#l99.148"></a><span id="l99.148" class="difflineplus">+ * @param aConn</span>
<a href="#l99.149"></a><span id="l99.149" class="difflineplus">+ *        A connection to either the UTF-8 database or the UTF-16 database.</span>
<a href="#l99.150"></a><span id="l99.150" class="difflineplus">+ */</span>
<a href="#l99.151"></a><span id="l99.151" class="difflineplus">+function initTableWithStrings(aStrings, aConn)</span>
<a href="#l99.152"></a><span id="l99.152" class="difflineplus">+{</span>
<a href="#l99.153"></a><span id="l99.153" class="difflineplus">+  print(&quot;Initializing test table.&quot;);</span>
<a href="#l99.154"></a><span id="l99.154" class="difflineplus">+</span>
<a href="#l99.155"></a><span id="l99.155" class="difflineplus">+  aConn.executeSimpleSQL(&quot;DROP TABLE IF EXISTS test&quot;);</span>
<a href="#l99.156"></a><span id="l99.156" class="difflineplus">+  aConn.createTable(&quot;test&quot;, &quot;t TEXT&quot;);</span>
<a href="#l99.157"></a><span id="l99.157" class="difflineplus">+  let stmt = aConn.createStatement(&quot;INSERT INTO test (t) VALUES (:t)&quot;);</span>
<a href="#l99.158"></a><span id="l99.158" class="difflineplus">+  aStrings.forEach(function (str) {</span>
<a href="#l99.159"></a><span id="l99.159" class="difflineplus">+    stmt.params.t = str;</span>
<a href="#l99.160"></a><span id="l99.160" class="difflineplus">+    stmt.execute();</span>
<a href="#l99.161"></a><span id="l99.161" class="difflineplus">+    stmt.reset();</span>
<a href="#l99.162"></a><span id="l99.162" class="difflineplus">+  });</span>
<a href="#l99.163"></a><span id="l99.163" class="difflineplus">+  stmt.finalize();</span>
<a href="#l99.164"></a><span id="l99.164" class="difflineplus">+}</span>
<a href="#l99.165"></a><span id="l99.165" class="difflineplus">+</span>
<a href="#l99.166"></a><span id="l99.166" class="difflineplus">+/**</span>
<a href="#l99.167"></a><span id="l99.167" class="difflineplus">+ * Returns a sorting function suitable for passing to Array.prototype.sort().</span>
<a href="#l99.168"></a><span id="l99.168" class="difflineplus">+ * The returned function uses the application's locale to compare strings.</span>
<a href="#l99.169"></a><span id="l99.169" class="difflineplus">+ *</span>
<a href="#l99.170"></a><span id="l99.170" class="difflineplus">+ * @param  aCollation</span>
<a href="#l99.171"></a><span id="l99.171" class="difflineplus">+ *         The name of one of our custom locale collations.  The sorting</span>
<a href="#l99.172"></a><span id="l99.172" class="difflineplus">+ *         strength is computed from this value.</span>
<a href="#l99.173"></a><span id="l99.173" class="difflineplus">+ * @return A function to use as a sorting callback.</span>
<a href="#l99.174"></a><span id="l99.174" class="difflineplus">+ */</span>
<a href="#l99.175"></a><span id="l99.175" class="difflineplus">+function localeCompare(aCollation)</span>
<a href="#l99.176"></a><span id="l99.176" class="difflineplus">+{</span>
<a href="#l99.177"></a><span id="l99.177" class="difflineplus">+  var strength;</span>
<a href="#l99.178"></a><span id="l99.178" class="difflineplus">+</span>
<a href="#l99.179"></a><span id="l99.179" class="difflineplus">+  switch (aCollation) {</span>
<a href="#l99.180"></a><span id="l99.180" class="difflineplus">+  case &quot;locale&quot;:</span>
<a href="#l99.181"></a><span id="l99.181" class="difflineplus">+    strength = Ci.nsICollation.kCollationCaseInSensitive;</span>
<a href="#l99.182"></a><span id="l99.182" class="difflineplus">+    break;</span>
<a href="#l99.183"></a><span id="l99.183" class="difflineplus">+  case &quot;locale_case_sensitive&quot;:</span>
<a href="#l99.184"></a><span id="l99.184" class="difflineplus">+    strength = Ci.nsICollation.kCollationAccentInsenstive;</span>
<a href="#l99.185"></a><span id="l99.185" class="difflineplus">+    break;</span>
<a href="#l99.186"></a><span id="l99.186" class="difflineplus">+  case &quot;locale_accent_sensitive&quot;:</span>
<a href="#l99.187"></a><span id="l99.187" class="difflineplus">+    strength = Ci.nsICollation.kCollationCaseInsensitiveAscii;</span>
<a href="#l99.188"></a><span id="l99.188" class="difflineplus">+    break;</span>
<a href="#l99.189"></a><span id="l99.189" class="difflineplus">+  case &quot;locale_case_accent_sensitive&quot;:</span>
<a href="#l99.190"></a><span id="l99.190" class="difflineplus">+    strength = Ci.nsICollation.kCollationCaseSensitive;</span>
<a href="#l99.191"></a><span id="l99.191" class="difflineplus">+    break;</span>
<a href="#l99.192"></a><span id="l99.192" class="difflineplus">+  default:</span>
<a href="#l99.193"></a><span id="l99.193" class="difflineplus">+    do_throw(&quot;Error in test: unknown collation '&quot; + aCollation + &quot;'&quot;);</span>
<a href="#l99.194"></a><span id="l99.194" class="difflineplus">+    break;</span>
<a href="#l99.195"></a><span id="l99.195" class="difflineplus">+  }</span>
<a href="#l99.196"></a><span id="l99.196" class="difflineplus">+  return function (aStr1, aStr2)</span>
<a href="#l99.197"></a><span id="l99.197" class="difflineplus">+         gLocaleCollation.compareString(strength, aStr1, aStr2);</span>
<a href="#l99.198"></a><span id="l99.198" class="difflineplus">+}</span>
<a href="#l99.199"></a><span id="l99.199" class="difflineplus">+</span>
<a href="#l99.200"></a><span id="l99.200" class="difflineplus">+/**</span>
<a href="#l99.201"></a><span id="l99.201" class="difflineplus">+ * Reads in the test data from the file DATA_BASENAME and returns it as an array</span>
<a href="#l99.202"></a><span id="l99.202" class="difflineplus">+ * of strings.</span>
<a href="#l99.203"></a><span id="l99.203" class="difflineplus">+ *</span>
<a href="#l99.204"></a><span id="l99.204" class="difflineplus">+ * @return The test data as an array of strings.</span>
<a href="#l99.205"></a><span id="l99.205" class="difflineplus">+ */</span>
<a href="#l99.206"></a><span id="l99.206" class="difflineplus">+function readTestData()</span>
<a href="#l99.207"></a><span id="l99.207" class="difflineplus">+{</span>
<a href="#l99.208"></a><span id="l99.208" class="difflineplus">+  print(&quot;Reading in test data.&quot;);</span>
<a href="#l99.209"></a><span id="l99.209" class="difflineplus">+</span>
<a href="#l99.210"></a><span id="l99.210" class="difflineplus">+  let file = do_get_file(DATA_BASENAME);</span>
<a href="#l99.211"></a><span id="l99.211" class="difflineplus">+</span>
<a href="#l99.212"></a><span id="l99.212" class="difflineplus">+  let istream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l99.213"></a><span id="l99.213" class="difflineplus">+                createInstance(Ci.nsIFileInputStream);</span>
<a href="#l99.214"></a><span id="l99.214" class="difflineplus">+  istream.init(file, -1, -1, 0);</span>
<a href="#l99.215"></a><span id="l99.215" class="difflineplus">+  istream.QueryInterface(Components.interfaces.nsILineInputStream);</span>
<a href="#l99.216"></a><span id="l99.216" class="difflineplus">+</span>
<a href="#l99.217"></a><span id="l99.217" class="difflineplus">+  let line = {};</span>
<a href="#l99.218"></a><span id="l99.218" class="difflineplus">+  let lines = [];</span>
<a href="#l99.219"></a><span id="l99.219" class="difflineplus">+  while (istream.readLine(line))</span>
<a href="#l99.220"></a><span id="l99.220" class="difflineplus">+    lines.push(line.value); </span>
<a href="#l99.221"></a><span id="l99.221" class="difflineplus">+  istream.close();</span>
<a href="#l99.222"></a><span id="l99.222" class="difflineplus">+</span>
<a href="#l99.223"></a><span id="l99.223" class="difflineplus">+  return lines;</span>
<a href="#l99.224"></a><span id="l99.224" class="difflineplus">+}</span>
<a href="#l99.225"></a><span id="l99.225" class="difflineplus">+</span>
<a href="#l99.226"></a><span id="l99.226" class="difflineplus">+/**</span>
<a href="#l99.227"></a><span id="l99.227" class="difflineplus">+ * Gets the results from the given database using the given collation and</span>
<a href="#l99.228"></a><span id="l99.228" class="difflineplus">+ * ensures that they match gStrings sorted by the same collation.</span>
<a href="#l99.229"></a><span id="l99.229" class="difflineplus">+ *</span>
<a href="#l99.230"></a><span id="l99.230" class="difflineplus">+ * @param aCollation</span>
<a href="#l99.231"></a><span id="l99.231" class="difflineplus">+ *        The name of one of our custom locale collations.  The rows from the</span>
<a href="#l99.232"></a><span id="l99.232" class="difflineplus">+ *        database and the expected results are ordered by this collation.</span>
<a href="#l99.233"></a><span id="l99.233" class="difflineplus">+ * @param aConn</span>
<a href="#l99.234"></a><span id="l99.234" class="difflineplus">+ *        A connection to either the UTF-8 database or the UTF-16 database.</span>
<a href="#l99.235"></a><span id="l99.235" class="difflineplus">+ */</span>
<a href="#l99.236"></a><span id="l99.236" class="difflineplus">+function runTest(aCollation, aConn)</span>
<a href="#l99.237"></a><span id="l99.237" class="difflineplus">+{</span>
<a href="#l99.238"></a><span id="l99.238" class="difflineplus">+  ensureResultsAreCorrect(getResults(aCollation, aConn),</span>
<a href="#l99.239"></a><span id="l99.239" class="difflineplus">+                          gStrings.slice(0).sort(localeCompare(aCollation)));</span>
<a href="#l99.240"></a><span id="l99.240" class="difflineplus">+}</span>
<a href="#l99.241"></a><span id="l99.241" class="difflineplus">+</span>
<a href="#l99.242"></a><span id="l99.242" class="difflineplus">+/**</span>
<a href="#l99.243"></a><span id="l99.243" class="difflineplus">+ * Gets the results from the UTF-8 database using the given collation and</span>
<a href="#l99.244"></a><span id="l99.244" class="difflineplus">+ * ensures that they match gStrings sorted by the same collation.</span>
<a href="#l99.245"></a><span id="l99.245" class="difflineplus">+ *</span>
<a href="#l99.246"></a><span id="l99.246" class="difflineplus">+ * @param aCollation</span>
<a href="#l99.247"></a><span id="l99.247" class="difflineplus">+ *        The name of one of our custom locale collations.  The rows from the</span>
<a href="#l99.248"></a><span id="l99.248" class="difflineplus">+ *        database and the expected results are ordered by this collation.</span>
<a href="#l99.249"></a><span id="l99.249" class="difflineplus">+ */</span>
<a href="#l99.250"></a><span id="l99.250" class="difflineplus">+function runUtf8Test(aCollation)</span>
<a href="#l99.251"></a><span id="l99.251" class="difflineplus">+{</span>
<a href="#l99.252"></a><span id="l99.252" class="difflineplus">+  runTest(aCollation, getOpenedDatabase());</span>
<a href="#l99.253"></a><span id="l99.253" class="difflineplus">+}</span>
<a href="#l99.254"></a><span id="l99.254" class="difflineplus">+</span>
<a href="#l99.255"></a><span id="l99.255" class="difflineplus">+/**</span>
<a href="#l99.256"></a><span id="l99.256" class="difflineplus">+ * Gets the results from the UTF-16 database using the given collation and</span>
<a href="#l99.257"></a><span id="l99.257" class="difflineplus">+ * ensures that they match gStrings sorted by the same collation.</span>
<a href="#l99.258"></a><span id="l99.258" class="difflineplus">+ *</span>
<a href="#l99.259"></a><span id="l99.259" class="difflineplus">+ * @param aCollation</span>
<a href="#l99.260"></a><span id="l99.260" class="difflineplus">+ *        The name of one of our custom locale collations.  The rows from the</span>
<a href="#l99.261"></a><span id="l99.261" class="difflineplus">+ *        database and the expected results are ordered by this collation.</span>
<a href="#l99.262"></a><span id="l99.262" class="difflineplus">+ */</span>
<a href="#l99.263"></a><span id="l99.263" class="difflineplus">+function runUtf16Test(aCollation)</span>
<a href="#l99.264"></a><span id="l99.264" class="difflineplus">+{</span>
<a href="#l99.265"></a><span id="l99.265" class="difflineplus">+  runTest(aCollation, gUtf16Conn);</span>
<a href="#l99.266"></a><span id="l99.266" class="difflineplus">+}</span>
<a href="#l99.267"></a><span id="l99.267" class="difflineplus">+</span>
<a href="#l99.268"></a><span id="l99.268" class="difflineplus">+/**</span>
<a href="#l99.269"></a><span id="l99.269" class="difflineplus">+ * Sets up the test suite.</span>
<a href="#l99.270"></a><span id="l99.270" class="difflineplus">+ */</span>
<a href="#l99.271"></a><span id="l99.271" class="difflineplus">+function setup()</span>
<a href="#l99.272"></a><span id="l99.272" class="difflineplus">+{</span>
<a href="#l99.273"></a><span id="l99.273" class="difflineplus">+  print(&quot;-- Setting up the test_locale_collation.js suite.&quot;);</span>
<a href="#l99.274"></a><span id="l99.274" class="difflineplus">+</span>
<a href="#l99.275"></a><span id="l99.275" class="difflineplus">+  gStrings = readTestData();</span>
<a href="#l99.276"></a><span id="l99.276" class="difflineplus">+</span>
<a href="#l99.277"></a><span id="l99.277" class="difflineplus">+  initTableWithStrings(gStrings, getOpenedDatabase());</span>
<a href="#l99.278"></a><span id="l99.278" class="difflineplus">+</span>
<a href="#l99.279"></a><span id="l99.279" class="difflineplus">+  gUtf16Conn = createUtf16Database();</span>
<a href="#l99.280"></a><span id="l99.280" class="difflineplus">+  initTableWithStrings(gStrings, gUtf16Conn);</span>
<a href="#l99.281"></a><span id="l99.281" class="difflineplus">+</span>
<a href="#l99.282"></a><span id="l99.282" class="difflineplus">+  let localeSvc = Cc[&quot;@mozilla.org/intl/nslocaleservice;1&quot;].</span>
<a href="#l99.283"></a><span id="l99.283" class="difflineplus">+                  getService(Ci.nsILocaleService);</span>
<a href="#l99.284"></a><span id="l99.284" class="difflineplus">+  let collFact = Cc[&quot;@mozilla.org/intl/collation-factory;1&quot;].</span>
<a href="#l99.285"></a><span id="l99.285" class="difflineplus">+                 createInstance(Ci.nsICollationFactory);</span>
<a href="#l99.286"></a><span id="l99.286" class="difflineplus">+  gLocaleCollation = collFact.CreateCollation(localeSvc.getApplicationLocale());</span>
<a href="#l99.287"></a><span id="l99.287" class="difflineplus">+}</span>
<a href="#l99.288"></a><span id="l99.288" class="difflineplus">+</span>
<a href="#l99.289"></a><span id="l99.289" class="difflineplus">+///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l99.290"></a><span id="l99.290" class="difflineplus">+//// Test Runs</span>
<a href="#l99.291"></a><span id="l99.291" class="difflineplus">+</span>
<a href="#l99.292"></a><span id="l99.292" class="difflineplus">+let gTests = [</span>
<a href="#l99.293"></a><span id="l99.293" class="difflineplus">+  {</span>
<a href="#l99.294"></a><span id="l99.294" class="difflineplus">+    desc: &quot;Case and accent sensitive UTF-8&quot;,</span>
<a href="#l99.295"></a><span id="l99.295" class="difflineplus">+    run:   function () runUtf8Test(&quot;locale_case_accent_sensitive&quot;)</span>
<a href="#l99.296"></a><span id="l99.296" class="difflineplus">+  },</span>
<a href="#l99.297"></a><span id="l99.297" class="difflineplus">+</span>
<a href="#l99.298"></a><span id="l99.298" class="difflineplus">+  {</span>
<a href="#l99.299"></a><span id="l99.299" class="difflineplus">+    desc: &quot;Case sensitive, accent insensitive UTF-8&quot;,</span>
<a href="#l99.300"></a><span id="l99.300" class="difflineplus">+    run:   function () runUtf8Test(&quot;locale_case_sensitive&quot;)</span>
<a href="#l99.301"></a><span id="l99.301" class="difflineplus">+  },</span>
<a href="#l99.302"></a><span id="l99.302" class="difflineplus">+</span>
<a href="#l99.303"></a><span id="l99.303" class="difflineplus">+  {</span>
<a href="#l99.304"></a><span id="l99.304" class="difflineplus">+    desc: &quot;Case insensitive, accent sensitive UTF-8&quot;,</span>
<a href="#l99.305"></a><span id="l99.305" class="difflineplus">+    run:   function () runUtf8Test(&quot;locale_accent_sensitive&quot;)</span>
<a href="#l99.306"></a><span id="l99.306" class="difflineplus">+  },</span>
<a href="#l99.307"></a><span id="l99.307" class="difflineplus">+</span>
<a href="#l99.308"></a><span id="l99.308" class="difflineplus">+  {</span>
<a href="#l99.309"></a><span id="l99.309" class="difflineplus">+    desc: &quot;Case and accent insensitive UTF-8&quot;,</span>
<a href="#l99.310"></a><span id="l99.310" class="difflineplus">+    run:   function () runUtf8Test(&quot;locale&quot;)</span>
<a href="#l99.311"></a><span id="l99.311" class="difflineplus">+  },</span>
<a href="#l99.312"></a><span id="l99.312" class="difflineplus">+</span>
<a href="#l99.313"></a><span id="l99.313" class="difflineplus">+  {</span>
<a href="#l99.314"></a><span id="l99.314" class="difflineplus">+    desc: &quot;Case and accent sensitive UTF-16&quot;,</span>
<a href="#l99.315"></a><span id="l99.315" class="difflineplus">+    run:   function () runUtf16Test(&quot;locale_case_accent_sensitive&quot;)</span>
<a href="#l99.316"></a><span id="l99.316" class="difflineplus">+  },</span>
<a href="#l99.317"></a><span id="l99.317" class="difflineplus">+</span>
<a href="#l99.318"></a><span id="l99.318" class="difflineplus">+  {</span>
<a href="#l99.319"></a><span id="l99.319" class="difflineplus">+    desc: &quot;Case sensitive, accent insensitive UTF-16&quot;,</span>
<a href="#l99.320"></a><span id="l99.320" class="difflineplus">+    run:   function () runUtf16Test(&quot;locale_case_sensitive&quot;)</span>
<a href="#l99.321"></a><span id="l99.321" class="difflineplus">+  },</span>
<a href="#l99.322"></a><span id="l99.322" class="difflineplus">+</span>
<a href="#l99.323"></a><span id="l99.323" class="difflineplus">+  {</span>
<a href="#l99.324"></a><span id="l99.324" class="difflineplus">+    desc: &quot;Case insensitive, accent sensitive UTF-16&quot;,</span>
<a href="#l99.325"></a><span id="l99.325" class="difflineplus">+    run:   function () runUtf16Test(&quot;locale_accent_sensitive&quot;)</span>
<a href="#l99.326"></a><span id="l99.326" class="difflineplus">+  },</span>
<a href="#l99.327"></a><span id="l99.327" class="difflineplus">+</span>
<a href="#l99.328"></a><span id="l99.328" class="difflineplus">+  {</span>
<a href="#l99.329"></a><span id="l99.329" class="difflineplus">+    desc: &quot;Case and accent insensitive UTF-16&quot;,</span>
<a href="#l99.330"></a><span id="l99.330" class="difflineplus">+    run:   function () runUtf16Test(&quot;locale&quot;)</span>
<a href="#l99.331"></a><span id="l99.331" class="difflineplus">+  },</span>
<a href="#l99.332"></a><span id="l99.332" class="difflineplus">+];</span>
<a href="#l99.333"></a><span id="l99.333" class="difflineplus">+</span>
<a href="#l99.334"></a><span id="l99.334" class="difflineplus">+function run_test()</span>
<a href="#l99.335"></a><span id="l99.335" class="difflineplus">+{</span>
<a href="#l99.336"></a><span id="l99.336" class="difflineplus">+  setup();</span>
<a href="#l99.337"></a><span id="l99.337" class="difflineplus">+  gTests.forEach(function (test) {</span>
<a href="#l99.338"></a><span id="l99.338" class="difflineplus">+    print(&quot;-- Running test: &quot; + test.desc);</span>
<a href="#l99.339"></a><span id="l99.339" class="difflineplus">+    test.run();</span>
<a href="#l99.340"></a><span id="l99.340" class="difflineplus">+  });</span>
<a href="#l99.341"></a><span id="l99.341" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1">new file mode 100644</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineminus">--- /dev/null</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineplus">+++ b/storage-backport/test/unit/test_sqlite_secure_delete.js</span>
<a href="#l100.4"></a><span id="l100.4" class="difflineat">@@ -0,0 +1,138 @@</span>
<a href="#l100.5"></a><span id="l100.5" class="difflineplus">+/*-*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l100.6"></a><span id="l100.6" class="difflineplus">+ *vim: sw=2 ts=2 et lcs=trail\:.,tab\:&gt;~ :</span>
<a href="#l100.7"></a><span id="l100.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l100.8"></a><span id="l100.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l100.9"></a><span id="l100.9" class="difflineplus">+ *</span>
<a href="#l100.10"></a><span id="l100.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l100.11"></a><span id="l100.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l100.12"></a><span id="l100.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l100.14"></a><span id="l100.14" class="difflineplus">+ *</span>
<a href="#l100.15"></a><span id="l100.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l100.16"></a><span id="l100.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l100.17"></a><span id="l100.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l100.18"></a><span id="l100.18" class="difflineplus">+ * License.</span>
<a href="#l100.19"></a><span id="l100.19" class="difflineplus">+ *</span>
<a href="#l100.20"></a><span id="l100.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l100.21"></a><span id="l100.21" class="difflineplus">+ *</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l100.23"></a><span id="l100.23" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l100.24"></a><span id="l100.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l100.25"></a><span id="l100.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l100.26"></a><span id="l100.26" class="difflineplus">+ *</span>
<a href="#l100.27"></a><span id="l100.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l100.28"></a><span id="l100.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l100.29"></a><span id="l100.29" class="difflineplus">+ *</span>
<a href="#l100.30"></a><span id="l100.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l100.31"></a><span id="l100.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l100.32"></a><span id="l100.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l100.33"></a><span id="l100.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l100.34"></a><span id="l100.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l100.35"></a><span id="l100.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l100.36"></a><span id="l100.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l100.37"></a><span id="l100.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l100.38"></a><span id="l100.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l100.39"></a><span id="l100.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l100.40"></a><span id="l100.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l100.41"></a><span id="l100.41" class="difflineplus">+ *</span>
<a href="#l100.42"></a><span id="l100.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l100.43"></a><span id="l100.43" class="difflineplus">+</span>
<a href="#l100.44"></a><span id="l100.44" class="difflineplus">+/**</span>
<a href="#l100.45"></a><span id="l100.45" class="difflineplus">+ * This file tests to make sure that SQLite was compiled with</span>
<a href="#l100.46"></a><span id="l100.46" class="difflineplus">+ * SQLITE_SECURE_DELETE=1.</span>
<a href="#l100.47"></a><span id="l100.47" class="difflineplus">+ */</span>
<a href="#l100.48"></a><span id="l100.48" class="difflineplus">+</span>
<a href="#l100.49"></a><span id="l100.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l100.50"></a><span id="l100.50" class="difflineplus">+//// Helper Methods</span>
<a href="#l100.51"></a><span id="l100.51" class="difflineplus">+</span>
<a href="#l100.52"></a><span id="l100.52" class="difflineplus">+/**</span>
<a href="#l100.53"></a><span id="l100.53" class="difflineplus">+ * Reads the contents of a file and returns it as a string.</span>
<a href="#l100.54"></a><span id="l100.54" class="difflineplus">+ *</span>
<a href="#l100.55"></a><span id="l100.55" class="difflineplus">+ * @param aFile</span>
<a href="#l100.56"></a><span id="l100.56" class="difflineplus">+ *        The file to return from.</span>
<a href="#l100.57"></a><span id="l100.57" class="difflineplus">+ * @return the contents of the file in the form of a string.</span>
<a href="#l100.58"></a><span id="l100.58" class="difflineplus">+ */</span>
<a href="#l100.59"></a><span id="l100.59" class="difflineplus">+function getFileContents(aFile)</span>
<a href="#l100.60"></a><span id="l100.60" class="difflineplus">+{</span>
<a href="#l100.61"></a><span id="l100.61" class="difflineplus">+  let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].</span>
<a href="#l100.62"></a><span id="l100.62" class="difflineplus">+                createInstance(Ci.nsIFileInputStream);</span>
<a href="#l100.63"></a><span id="l100.63" class="difflineplus">+  fstream.init(aFile, -1, 0, 0);</span>
<a href="#l100.64"></a><span id="l100.64" class="difflineplus">+</span>
<a href="#l100.65"></a><span id="l100.65" class="difflineplus">+  let bstream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;].</span>
<a href="#l100.66"></a><span id="l100.66" class="difflineplus">+                createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l100.67"></a><span id="l100.67" class="difflineplus">+  bstream.setInputStream(fstream);</span>
<a href="#l100.68"></a><span id="l100.68" class="difflineplus">+  return bstream.readBytes(bstream.available());</span>
<a href="#l100.69"></a><span id="l100.69" class="difflineplus">+}</span>
<a href="#l100.70"></a><span id="l100.70" class="difflineplus">+</span>
<a href="#l100.71"></a><span id="l100.71" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l100.72"></a><span id="l100.72" class="difflineplus">+//// Tests</span>
<a href="#l100.73"></a><span id="l100.73" class="difflineplus">+</span>
<a href="#l100.74"></a><span id="l100.74" class="difflineplus">+function test_delete_removes_data()</span>
<a href="#l100.75"></a><span id="l100.75" class="difflineplus">+{</span>
<a href="#l100.76"></a><span id="l100.76" class="difflineplus">+  const TEST_STRING = &quot;SomeRandomStringToFind&quot;;</span>
<a href="#l100.77"></a><span id="l100.77" class="difflineplus">+</span>
<a href="#l100.78"></a><span id="l100.78" class="difflineplus">+  let file = getTestDB();</span>
<a href="#l100.79"></a><span id="l100.79" class="difflineplus">+  let db = getService().openDatabase(file);</span>
<a href="#l100.80"></a><span id="l100.80" class="difflineplus">+</span>
<a href="#l100.81"></a><span id="l100.81" class="difflineplus">+  // Create the table and insert the data.</span>
<a href="#l100.82"></a><span id="l100.82" class="difflineplus">+  db.createTable(&quot;test&quot;, &quot;data TEXT&quot;);</span>
<a href="#l100.83"></a><span id="l100.83" class="difflineplus">+  let stmt = db.createStatement(&quot;INSERT INTO test VALUES(:data)&quot;);</span>
<a href="#l100.84"></a><span id="l100.84" class="difflineplus">+  stmt.params.data = TEST_STRING;</span>
<a href="#l100.85"></a><span id="l100.85" class="difflineplus">+  try {</span>
<a href="#l100.86"></a><span id="l100.86" class="difflineplus">+    stmt.execute();</span>
<a href="#l100.87"></a><span id="l100.87" class="difflineplus">+  }</span>
<a href="#l100.88"></a><span id="l100.88" class="difflineplus">+  finally {</span>
<a href="#l100.89"></a><span id="l100.89" class="difflineplus">+    stmt.finalize();</span>
<a href="#l100.90"></a><span id="l100.90" class="difflineplus">+  }</span>
<a href="#l100.91"></a><span id="l100.91" class="difflineplus">+</span>
<a href="#l100.92"></a><span id="l100.92" class="difflineplus">+  // Make sure this test is actually testing what it thinks by making sure the</span>
<a href="#l100.93"></a><span id="l100.93" class="difflineplus">+  // string shows up in the database.  Because the previous statement was</span>
<a href="#l100.94"></a><span id="l100.94" class="difflineplus">+  // automatically wrapped in a transaction, the contents are already on disk.</span>
<a href="#l100.95"></a><span id="l100.95" class="difflineplus">+  let contents = getFileContents(file);</span>
<a href="#l100.96"></a><span id="l100.96" class="difflineplus">+  do_check_neq(-1, contents.indexOf(TEST_STRING));</span>
<a href="#l100.97"></a><span id="l100.97" class="difflineplus">+</span>
<a href="#l100.98"></a><span id="l100.98" class="difflineplus">+  // Delete the data, and then close the database.</span>
<a href="#l100.99"></a><span id="l100.99" class="difflineplus">+  stmt = db.createStatement(&quot;DELETE FROM test WHERE data = :data&quot;);</span>
<a href="#l100.100"></a><span id="l100.100" class="difflineplus">+  stmt.params.data = TEST_STRING;</span>
<a href="#l100.101"></a><span id="l100.101" class="difflineplus">+  try {</span>
<a href="#l100.102"></a><span id="l100.102" class="difflineplus">+    stmt.execute();</span>
<a href="#l100.103"></a><span id="l100.103" class="difflineplus">+  }</span>
<a href="#l100.104"></a><span id="l100.104" class="difflineplus">+  finally {</span>
<a href="#l100.105"></a><span id="l100.105" class="difflineplus">+    stmt.finalize();</span>
<a href="#l100.106"></a><span id="l100.106" class="difflineplus">+  }</span>
<a href="#l100.107"></a><span id="l100.107" class="difflineplus">+  db.close();</span>
<a href="#l100.108"></a><span id="l100.108" class="difflineplus">+</span>
<a href="#l100.109"></a><span id="l100.109" class="difflineplus">+  // Check the file to see if the string can be found.</span>
<a href="#l100.110"></a><span id="l100.110" class="difflineplus">+  contents = getFileContents(file);</span>
<a href="#l100.111"></a><span id="l100.111" class="difflineplus">+  do_check_eq(-1, contents.indexOf(TEST_STRING));</span>
<a href="#l100.112"></a><span id="l100.112" class="difflineplus">+</span>
<a href="#l100.113"></a><span id="l100.113" class="difflineplus">+  run_next_test();</span>
<a href="#l100.114"></a><span id="l100.114" class="difflineplus">+}</span>
<a href="#l100.115"></a><span id="l100.115" class="difflineplus">+</span>
<a href="#l100.116"></a><span id="l100.116" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l100.117"></a><span id="l100.117" class="difflineplus">+//// Test Runner</span>
<a href="#l100.118"></a><span id="l100.118" class="difflineplus">+</span>
<a href="#l100.119"></a><span id="l100.119" class="difflineplus">+var tests =</span>
<a href="#l100.120"></a><span id="l100.120" class="difflineplus">+[</span>
<a href="#l100.121"></a><span id="l100.121" class="difflineplus">+  test_delete_removes_data,</span>
<a href="#l100.122"></a><span id="l100.122" class="difflineplus">+];</span>
<a href="#l100.123"></a><span id="l100.123" class="difflineplus">+let index = 0;</span>
<a href="#l100.124"></a><span id="l100.124" class="difflineplus">+</span>
<a href="#l100.125"></a><span id="l100.125" class="difflineplus">+function run_next_test()</span>
<a href="#l100.126"></a><span id="l100.126" class="difflineplus">+{</span>
<a href="#l100.127"></a><span id="l100.127" class="difflineplus">+  if (index &lt; tests.length) {</span>
<a href="#l100.128"></a><span id="l100.128" class="difflineplus">+    do_test_pending();</span>
<a href="#l100.129"></a><span id="l100.129" class="difflineplus">+    print(&quot;Running the next test: &quot; + tests[index].name);</span>
<a href="#l100.130"></a><span id="l100.130" class="difflineplus">+    tests[index++]();</span>
<a href="#l100.131"></a><span id="l100.131" class="difflineplus">+  }</span>
<a href="#l100.132"></a><span id="l100.132" class="difflineplus">+</span>
<a href="#l100.133"></a><span id="l100.133" class="difflineplus">+  do_test_finished();</span>
<a href="#l100.134"></a><span id="l100.134" class="difflineplus">+}</span>
<a href="#l100.135"></a><span id="l100.135" class="difflineplus">+</span>
<a href="#l100.136"></a><span id="l100.136" class="difflineplus">+function run_test()</span>
<a href="#l100.137"></a><span id="l100.137" class="difflineplus">+{</span>
<a href="#l100.138"></a><span id="l100.138" class="difflineplus">+  cleanup();</span>
<a href="#l100.139"></a><span id="l100.139" class="difflineplus">+</span>
<a href="#l100.140"></a><span id="l100.140" class="difflineplus">+  do_test_pending();</span>
<a href="#l100.141"></a><span id="l100.141" class="difflineplus">+  run_next_test();</span>
<a href="#l100.142"></a><span id="l100.142" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1">new file mode 100644</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineminus">--- /dev/null</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineplus">+++ b/storage-backport/test/unit/test_statement_executeAsync.js</span>
<a href="#l101.4"></a><span id="l101.4" class="difflineat">@@ -0,0 +1,1030 @@</span>
<a href="#l101.5"></a><span id="l101.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l101.6"></a><span id="l101.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l101.7"></a><span id="l101.7" class="difflineplus">+ *</span>
<a href="#l101.8"></a><span id="l101.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l101.9"></a><span id="l101.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l101.10"></a><span id="l101.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l101.11"></a><span id="l101.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineplus">+ *</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l101.14"></a><span id="l101.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l101.15"></a><span id="l101.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineplus">+ * License.</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+ *</span>
<a href="#l101.18"></a><span id="l101.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l101.19"></a><span id="l101.19" class="difflineplus">+ *</span>
<a href="#l101.20"></a><span id="l101.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l101.21"></a><span id="l101.21" class="difflineplus">+ * Mozilla Corporation.</span>
<a href="#l101.22"></a><span id="l101.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l101.23"></a><span id="l101.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l101.24"></a><span id="l101.24" class="difflineplus">+ *</span>
<a href="#l101.25"></a><span id="l101.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l101.26"></a><span id="l101.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l101.27"></a><span id="l101.27" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l101.28"></a><span id="l101.28" class="difflineplus">+ *</span>
<a href="#l101.29"></a><span id="l101.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l101.30"></a><span id="l101.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l101.31"></a><span id="l101.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l101.32"></a><span id="l101.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l101.33"></a><span id="l101.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l101.34"></a><span id="l101.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l101.35"></a><span id="l101.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l101.36"></a><span id="l101.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l101.37"></a><span id="l101.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l101.38"></a><span id="l101.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l101.39"></a><span id="l101.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l101.40"></a><span id="l101.40" class="difflineplus">+ *</span>
<a href="#l101.41"></a><span id="l101.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l101.42"></a><span id="l101.42" class="difflineplus">+</span>
<a href="#l101.43"></a><span id="l101.43" class="difflineplus">+/*</span>
<a href="#l101.44"></a><span id="l101.44" class="difflineplus">+ * This file tests the functionality of mozIStorageBaseStatement::executeAsync</span>
<a href="#l101.45"></a><span id="l101.45" class="difflineplus">+ * for both mozIStorageStatement and mozIStorageAsyncStatement.</span>
<a href="#l101.46"></a><span id="l101.46" class="difflineplus">+ */</span>
<a href="#l101.47"></a><span id="l101.47" class="difflineplus">+</span>
<a href="#l101.48"></a><span id="l101.48" class="difflineplus">+const INTEGER = 1;</span>
<a href="#l101.49"></a><span id="l101.49" class="difflineplus">+const TEXT = &quot;this is test text&quot;;</span>
<a href="#l101.50"></a><span id="l101.50" class="difflineplus">+const REAL = 3.23;</span>
<a href="#l101.51"></a><span id="l101.51" class="difflineplus">+const BLOB = [1, 2];</span>
<a href="#l101.52"></a><span id="l101.52" class="difflineplus">+</span>
<a href="#l101.53"></a><span id="l101.53" class="difflineplus">+/**</span>
<a href="#l101.54"></a><span id="l101.54" class="difflineplus">+ * Execute the given statement asynchronously, spinning an event loop until the</span>
<a href="#l101.55"></a><span id="l101.55" class="difflineplus">+ * async statement completes.</span>
<a href="#l101.56"></a><span id="l101.56" class="difflineplus">+ *</span>
<a href="#l101.57"></a><span id="l101.57" class="difflineplus">+ * @param aStmt</span>
<a href="#l101.58"></a><span id="l101.58" class="difflineplus">+ *        The statement to execute.</span>
<a href="#l101.59"></a><span id="l101.59" class="difflineplus">+ * @param [aOptions={}]</span>
<a href="#l101.60"></a><span id="l101.60" class="difflineplus">+ * @param [aOptions.error=false]</span>
<a href="#l101.61"></a><span id="l101.61" class="difflineplus">+ *        If true we should expect an error whose code we do not care about.  If</span>
<a href="#l101.62"></a><span id="l101.62" class="difflineplus">+ *        a numeric value, that's the error code we expect and require.  If we</span>
<a href="#l101.63"></a><span id="l101.63" class="difflineplus">+ *        are expecting an error, we expect a completion reason of REASON_ERROR.</span>
<a href="#l101.64"></a><span id="l101.64" class="difflineplus">+ *        Otherwise we expect no error notification and a completion reason of</span>
<a href="#l101.65"></a><span id="l101.65" class="difflineplus">+ *        REASON_FINISHED.</span>
<a href="#l101.66"></a><span id="l101.66" class="difflineplus">+ * @param [aOptions.cancel]</span>
<a href="#l101.67"></a><span id="l101.67" class="difflineplus">+ *        If true we cancel the pending statement and additionally return the</span>
<a href="#l101.68"></a><span id="l101.68" class="difflineplus">+ *        pending statement in case you want to further manipulate it.</span>
<a href="#l101.69"></a><span id="l101.69" class="difflineplus">+ * @param [aOptions.returnPending=false]</span>
<a href="#l101.70"></a><span id="l101.70" class="difflineplus">+ *        If true we keep the pending statement around and return it to you.  We</span>
<a href="#l101.71"></a><span id="l101.71" class="difflineplus">+ *        normally avoid doing this to try and minimize the amount of time a</span>
<a href="#l101.72"></a><span id="l101.72" class="difflineplus">+ *        reference is held to the returned pending statement.</span>
<a href="#l101.73"></a><span id="l101.73" class="difflineplus">+ * @param [aResults]</span>
<a href="#l101.74"></a><span id="l101.74" class="difflineplus">+ *        If omitted, we assume no results rows are expected.  If it is a</span>
<a href="#l101.75"></a><span id="l101.75" class="difflineplus">+ *        number, we assume it is the number of results rows expected.  If it is</span>
<a href="#l101.76"></a><span id="l101.76" class="difflineplus">+ *        a function, we assume it is a function that takes the 1) result row</span>
<a href="#l101.77"></a><span id="l101.77" class="difflineplus">+ *        number, 2) result tuple, 3) call stack for the original call to</span>
<a href="#l101.78"></a><span id="l101.78" class="difflineplus">+ *        execAsync as arguments.  If it is a list, we currently assume it is a</span>
<a href="#l101.79"></a><span id="l101.79" class="difflineplus">+ *        list of functions where each function is intended to evaluate the</span>
<a href="#l101.80"></a><span id="l101.80" class="difflineplus">+ *        result row at that ordinal position and takes the result tuple and</span>
<a href="#l101.81"></a><span id="l101.81" class="difflineplus">+ *        the call stack for the original call.</span>
<a href="#l101.82"></a><span id="l101.82" class="difflineplus">+ */</span>
<a href="#l101.83"></a><span id="l101.83" class="difflineplus">+function execAsync(aStmt, aOptions, aResults)</span>
<a href="#l101.84"></a><span id="l101.84" class="difflineplus">+{</span>
<a href="#l101.85"></a><span id="l101.85" class="difflineplus">+  let caller = Components.stack.caller;</span>
<a href="#l101.86"></a><span id="l101.86" class="difflineplus">+  if (aOptions == null)</span>
<a href="#l101.87"></a><span id="l101.87" class="difflineplus">+    aOptions = {};</span>
<a href="#l101.88"></a><span id="l101.88" class="difflineplus">+</span>
<a href="#l101.89"></a><span id="l101.89" class="difflineplus">+  let resultsExpected;</span>
<a href="#l101.90"></a><span id="l101.90" class="difflineplus">+  let resultsChecker;</span>
<a href="#l101.91"></a><span id="l101.91" class="difflineplus">+  if (aResults == null) {</span>
<a href="#l101.92"></a><span id="l101.92" class="difflineplus">+    resultsExpected = 0;</span>
<a href="#l101.93"></a><span id="l101.93" class="difflineplus">+  }</span>
<a href="#l101.94"></a><span id="l101.94" class="difflineplus">+  else if (typeof(aResults) == &quot;number&quot;) {</span>
<a href="#l101.95"></a><span id="l101.95" class="difflineplus">+    resultsExpected = aResults;</span>
<a href="#l101.96"></a><span id="l101.96" class="difflineplus">+  }</span>
<a href="#l101.97"></a><span id="l101.97" class="difflineplus">+  else if (typeof(aResults) == &quot;function&quot;) {</span>
<a href="#l101.98"></a><span id="l101.98" class="difflineplus">+    resultsChecker = aResults;</span>
<a href="#l101.99"></a><span id="l101.99" class="difflineplus">+  }</span>
<a href="#l101.100"></a><span id="l101.100" class="difflineplus">+  else { // array</span>
<a href="#l101.101"></a><span id="l101.101" class="difflineplus">+    resultsExpected = aResults.length;</span>
<a href="#l101.102"></a><span id="l101.102" class="difflineplus">+    resultsChecker = function(aResultNum, aTup, aCaller) {</span>
<a href="#l101.103"></a><span id="l101.103" class="difflineplus">+      aResults[aResultNum](aTup, aCaller);</span>
<a href="#l101.104"></a><span id="l101.104" class="difflineplus">+    };</span>
<a href="#l101.105"></a><span id="l101.105" class="difflineplus">+  }</span>
<a href="#l101.106"></a><span id="l101.106" class="difflineplus">+  let resultsSeen = 0;</span>
<a href="#l101.107"></a><span id="l101.107" class="difflineplus">+</span>
<a href="#l101.108"></a><span id="l101.108" class="difflineplus">+  let errorCodeExpected = false;</span>
<a href="#l101.109"></a><span id="l101.109" class="difflineplus">+  let reasonExpected = Ci.mozIStorageStatementCallback.REASON_FINISHED;</span>
<a href="#l101.110"></a><span id="l101.110" class="difflineplus">+  let altReasonExpected = null;</span>
<a href="#l101.111"></a><span id="l101.111" class="difflineplus">+  if (&quot;error&quot; in aOptions) {</span>
<a href="#l101.112"></a><span id="l101.112" class="difflineplus">+    errorCodeExpected = aOptions.error;</span>
<a href="#l101.113"></a><span id="l101.113" class="difflineplus">+    if (errorCodeExpected)</span>
<a href="#l101.114"></a><span id="l101.114" class="difflineplus">+      reasonExpected = Ci.mozIStorageStatementCallback.REASON_ERROR;</span>
<a href="#l101.115"></a><span id="l101.115" class="difflineplus">+  }</span>
<a href="#l101.116"></a><span id="l101.116" class="difflineplus">+  let errorCodeSeen = false;</span>
<a href="#l101.117"></a><span id="l101.117" class="difflineplus">+</span>
<a href="#l101.118"></a><span id="l101.118" class="difflineplus">+  if (&quot;cancel&quot; in aOptions &amp;&amp; aOptions.cancel)</span>
<a href="#l101.119"></a><span id="l101.119" class="difflineplus">+    altReasonExpected = Ci.mozIStorageStatementCallback.REASON_CANCELED;</span>
<a href="#l101.120"></a><span id="l101.120" class="difflineplus">+</span>
<a href="#l101.121"></a><span id="l101.121" class="difflineplus">+  let completed = false;</span>
<a href="#l101.122"></a><span id="l101.122" class="difflineplus">+</span>
<a href="#l101.123"></a><span id="l101.123" class="difflineplus">+  let listener = {</span>
<a href="#l101.124"></a><span id="l101.124" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l101.125"></a><span id="l101.125" class="difflineplus">+    {</span>
<a href="#l101.126"></a><span id="l101.126" class="difflineplus">+      let row, resultsSeenThisCall = 0;</span>
<a href="#l101.127"></a><span id="l101.127" class="difflineplus">+      while ((row = aResultSet.getNextRow()) != null) {</span>
<a href="#l101.128"></a><span id="l101.128" class="difflineplus">+        if (resultsChecker)</span>
<a href="#l101.129"></a><span id="l101.129" class="difflineplus">+          resultsChecker(resultsSeen, row, caller);</span>
<a href="#l101.130"></a><span id="l101.130" class="difflineplus">+        resultsSeen++;</span>
<a href="#l101.131"></a><span id="l101.131" class="difflineplus">+        resultsSeenThisCall++;</span>
<a href="#l101.132"></a><span id="l101.132" class="difflineplus">+      }</span>
<a href="#l101.133"></a><span id="l101.133" class="difflineplus">+</span>
<a href="#l101.134"></a><span id="l101.134" class="difflineplus">+      if (!resultsSeenThisCall)</span>
<a href="#l101.135"></a><span id="l101.135" class="difflineplus">+        do_throw(&quot;handleResult invoked with 0 result rows!&quot;);</span>
<a href="#l101.136"></a><span id="l101.136" class="difflineplus">+    },</span>
<a href="#l101.137"></a><span id="l101.137" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l101.138"></a><span id="l101.138" class="difflineplus">+    {</span>
<a href="#l101.139"></a><span id="l101.139" class="difflineplus">+      if (errorCodeSeen != false)</span>
<a href="#l101.140"></a><span id="l101.140" class="difflineplus">+        do_throw(&quot;handleError called when we already had an error!&quot;);</span>
<a href="#l101.141"></a><span id="l101.141" class="difflineplus">+      errorCodeSeen = aError.result;</span>
<a href="#l101.142"></a><span id="l101.142" class="difflineplus">+    },</span>
<a href="#l101.143"></a><span id="l101.143" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l101.144"></a><span id="l101.144" class="difflineplus">+    {</span>
<a href="#l101.145"></a><span id="l101.145" class="difflineplus">+      if (completed) // paranoia check</span>
<a href="#l101.146"></a><span id="l101.146" class="difflineplus">+        do_throw(&quot;Received a second handleCompletion notification!&quot;, caller);</span>
<a href="#l101.147"></a><span id="l101.147" class="difflineplus">+</span>
<a href="#l101.148"></a><span id="l101.148" class="difflineplus">+      if (resultsSeen != resultsExpected)</span>
<a href="#l101.149"></a><span id="l101.149" class="difflineplus">+        do_throw(&quot;Expected &quot; + resultsExpected + &quot; rows of results but &quot; +</span>
<a href="#l101.150"></a><span id="l101.150" class="difflineplus">+                 &quot;got &quot; + resultsSeen + &quot; rows!&quot;, caller);</span>
<a href="#l101.151"></a><span id="l101.151" class="difflineplus">+</span>
<a href="#l101.152"></a><span id="l101.152" class="difflineplus">+      if (errorCodeExpected == true &amp;&amp; errorCodeSeen == false)</span>
<a href="#l101.153"></a><span id="l101.153" class="difflineplus">+        do_throw(&quot;Expected an error, but did not see one.&quot;, caller);</span>
<a href="#l101.154"></a><span id="l101.154" class="difflineplus">+      else if (errorCodeExpected != errorCodeSeen)</span>
<a href="#l101.155"></a><span id="l101.155" class="difflineplus">+        do_throw(&quot;Expected error code &quot; + errorCodeExpected + &quot; but got &quot; +</span>
<a href="#l101.156"></a><span id="l101.156" class="difflineplus">+                 errorCodeSeen, caller);</span>
<a href="#l101.157"></a><span id="l101.157" class="difflineplus">+</span>
<a href="#l101.158"></a><span id="l101.158" class="difflineplus">+      if (aReason != reasonExpected &amp;&amp; aReason != altReasonExpected)</span>
<a href="#l101.159"></a><span id="l101.159" class="difflineplus">+        do_throw(&quot;Expected reason &quot; + reasonExpected +</span>
<a href="#l101.160"></a><span id="l101.160" class="difflineplus">+                 (altReasonExpected ? (&quot; or &quot; + altReasonExpected) : &quot;&quot;) +</span>
<a href="#l101.161"></a><span id="l101.161" class="difflineplus">+                 &quot; but got &quot; + aReason, caller);</span>
<a href="#l101.162"></a><span id="l101.162" class="difflineplus">+</span>
<a href="#l101.163"></a><span id="l101.163" class="difflineplus">+      completed = true;</span>
<a href="#l101.164"></a><span id="l101.164" class="difflineplus">+    }</span>
<a href="#l101.165"></a><span id="l101.165" class="difflineplus">+  };</span>
<a href="#l101.166"></a><span id="l101.166" class="difflineplus">+</span>
<a href="#l101.167"></a><span id="l101.167" class="difflineplus">+  let pending;</span>
<a href="#l101.168"></a><span id="l101.168" class="difflineplus">+  // Only get a pending reference if we're supposed to do.</span>
<a href="#l101.169"></a><span id="l101.169" class="difflineplus">+  // (note: This does not stop XPConnect from holding onto one currently.)</span>
<a href="#l101.170"></a><span id="l101.170" class="difflineplus">+  if ((&quot;cancel&quot; in aOptions &amp;&amp; aOptions.cancel) ||</span>
<a href="#l101.171"></a><span id="l101.171" class="difflineplus">+      (&quot;returnPending&quot; in aOptions &amp;&amp; aOptions.returnPending)) {</span>
<a href="#l101.172"></a><span id="l101.172" class="difflineplus">+    pending = aStmt.executeAsync(listener);</span>
<a href="#l101.173"></a><span id="l101.173" class="difflineplus">+  }</span>
<a href="#l101.174"></a><span id="l101.174" class="difflineplus">+  else {</span>
<a href="#l101.175"></a><span id="l101.175" class="difflineplus">+    aStmt.executeAsync(listener);</span>
<a href="#l101.176"></a><span id="l101.176" class="difflineplus">+  }</span>
<a href="#l101.177"></a><span id="l101.177" class="difflineplus">+</span>
<a href="#l101.178"></a><span id="l101.178" class="difflineplus">+  if (&quot;cancel&quot; in aOptions &amp;&amp; aOptions.cancel)</span>
<a href="#l101.179"></a><span id="l101.179" class="difflineplus">+    pending.cancel();</span>
<a href="#l101.180"></a><span id="l101.180" class="difflineplus">+</span>
<a href="#l101.181"></a><span id="l101.181" class="difflineplus">+  let curThread = Components.classes[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l101.182"></a><span id="l101.182" class="difflineplus">+                            .getService().currentThread;</span>
<a href="#l101.183"></a><span id="l101.183" class="difflineplus">+  while (!completed &amp;&amp; !_quit)</span>
<a href="#l101.184"></a><span id="l101.184" class="difflineplus">+    curThread.processNextEvent(true);</span>
<a href="#l101.185"></a><span id="l101.185" class="difflineplus">+</span>
<a href="#l101.186"></a><span id="l101.186" class="difflineplus">+  return pending;</span>
<a href="#l101.187"></a><span id="l101.187" class="difflineplus">+}</span>
<a href="#l101.188"></a><span id="l101.188" class="difflineplus">+</span>
<a href="#l101.189"></a><span id="l101.189" class="difflineplus">+/**</span>
<a href="#l101.190"></a><span id="l101.190" class="difflineplus">+ * Make sure that illegal SQL generates the expected runtime error and does not</span>
<a href="#l101.191"></a><span id="l101.191" class="difflineplus">+ * result in any crashes.  Async-only since the synchronous case generates the</span>
<a href="#l101.192"></a><span id="l101.192" class="difflineplus">+ * error synchronously (and is tested elsewhere).</span>
<a href="#l101.193"></a><span id="l101.193" class="difflineplus">+ */</span>
<a href="#l101.194"></a><span id="l101.194" class="difflineplus">+function test_illegal_sql_async_deferred()</span>
<a href="#l101.195"></a><span id="l101.195" class="difflineplus">+{</span>
<a href="#l101.196"></a><span id="l101.196" class="difflineplus">+  // gibberish</span>
<a href="#l101.197"></a><span id="l101.197" class="difflineplus">+  let stmt = makeTestStatement(&quot;I AM A ROBOT. DO AS I SAY.&quot;);</span>
<a href="#l101.198"></a><span id="l101.198" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.ERROR});</span>
<a href="#l101.199"></a><span id="l101.199" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.200"></a><span id="l101.200" class="difflineplus">+</span>
<a href="#l101.201"></a><span id="l101.201" class="difflineplus">+  // legal SQL syntax, but with semantics issues.</span>
<a href="#l101.202"></a><span id="l101.202" class="difflineplus">+  stmt = makeTestStatement(&quot;SELECT destination FROM funkytown&quot;);</span>
<a href="#l101.203"></a><span id="l101.203" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.ERROR});</span>
<a href="#l101.204"></a><span id="l101.204" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.205"></a><span id="l101.205" class="difflineplus">+</span>
<a href="#l101.206"></a><span id="l101.206" class="difflineplus">+  run_next_test();</span>
<a href="#l101.207"></a><span id="l101.207" class="difflineplus">+}</span>
<a href="#l101.208"></a><span id="l101.208" class="difflineplus">+test_illegal_sql_async_deferred.asyncOnly = true;</span>
<a href="#l101.209"></a><span id="l101.209" class="difflineplus">+</span>
<a href="#l101.210"></a><span id="l101.210" class="difflineplus">+function test_create_table()</span>
<a href="#l101.211"></a><span id="l101.211" class="difflineplus">+{</span>
<a href="#l101.212"></a><span id="l101.212" class="difflineplus">+  // Ensure our table doesn't exist</span>
<a href="#l101.213"></a><span id="l101.213" class="difflineplus">+  do_check_false(getOpenedDatabase().tableExists(&quot;test&quot;));</span>
<a href="#l101.214"></a><span id="l101.214" class="difflineplus">+</span>
<a href="#l101.215"></a><span id="l101.215" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.216"></a><span id="l101.216" class="difflineplus">+    &quot;CREATE TABLE test (&quot; +</span>
<a href="#l101.217"></a><span id="l101.217" class="difflineplus">+      &quot;id INTEGER, &quot; +</span>
<a href="#l101.218"></a><span id="l101.218" class="difflineplus">+      &quot;string TEXT, &quot; +</span>
<a href="#l101.219"></a><span id="l101.219" class="difflineplus">+      &quot;number REAL, &quot; +</span>
<a href="#l101.220"></a><span id="l101.220" class="difflineplus">+      &quot;nuller NULL, &quot; +</span>
<a href="#l101.221"></a><span id="l101.221" class="difflineplus">+      &quot;blober BLOB&quot; +</span>
<a href="#l101.222"></a><span id="l101.222" class="difflineplus">+    &quot;)&quot;</span>
<a href="#l101.223"></a><span id="l101.223" class="difflineplus">+  );</span>
<a href="#l101.224"></a><span id="l101.224" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.225"></a><span id="l101.225" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.226"></a><span id="l101.226" class="difflineplus">+</span>
<a href="#l101.227"></a><span id="l101.227" class="difflineplus">+  // Check that the table has been created</span>
<a href="#l101.228"></a><span id="l101.228" class="difflineplus">+  do_check_true(getOpenedDatabase().tableExists(&quot;test&quot;));</span>
<a href="#l101.229"></a><span id="l101.229" class="difflineplus">+</span>
<a href="#l101.230"></a><span id="l101.230" class="difflineplus">+  // Verify that it's created correctly (this will throw if it wasn't)</span>
<a href="#l101.231"></a><span id="l101.231" class="difflineplus">+  let checkStmt = getOpenedDatabase().createStatement(</span>
<a href="#l101.232"></a><span id="l101.232" class="difflineplus">+    &quot;SELECT id, string, number, nuller, blober FROM test&quot;</span>
<a href="#l101.233"></a><span id="l101.233" class="difflineplus">+  );</span>
<a href="#l101.234"></a><span id="l101.234" class="difflineplus">+  checkStmt.finalize();</span>
<a href="#l101.235"></a><span id="l101.235" class="difflineplus">+  run_next_test();</span>
<a href="#l101.236"></a><span id="l101.236" class="difflineplus">+}</span>
<a href="#l101.237"></a><span id="l101.237" class="difflineplus">+</span>
<a href="#l101.238"></a><span id="l101.238" class="difflineplus">+function test_add_data()</span>
<a href="#l101.239"></a><span id="l101.239" class="difflineplus">+{</span>
<a href="#l101.240"></a><span id="l101.240" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.241"></a><span id="l101.241" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.242"></a><span id="l101.242" class="difflineplus">+    &quot;VALUES (?, ?, ?, ?, ?)&quot;</span>
<a href="#l101.243"></a><span id="l101.243" class="difflineplus">+  );</span>
<a href="#l101.244"></a><span id="l101.244" class="difflineplus">+  stmt.bindBlobParameter(4, BLOB, BLOB.length);</span>
<a href="#l101.245"></a><span id="l101.245" class="difflineplus">+  stmt.bindNullParameter(3);</span>
<a href="#l101.246"></a><span id="l101.246" class="difflineplus">+  stmt.bindDoubleParameter(2, REAL);</span>
<a href="#l101.247"></a><span id="l101.247" class="difflineplus">+  stmt.bindStringParameter(1, TEXT);</span>
<a href="#l101.248"></a><span id="l101.248" class="difflineplus">+  stmt.bindInt32Parameter(0, INTEGER);</span>
<a href="#l101.249"></a><span id="l101.249" class="difflineplus">+</span>
<a href="#l101.250"></a><span id="l101.250" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.251"></a><span id="l101.251" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.252"></a><span id="l101.252" class="difflineplus">+</span>
<a href="#l101.253"></a><span id="l101.253" class="difflineplus">+  // Check that the result is in the table</span>
<a href="#l101.254"></a><span id="l101.254" class="difflineplus">+  verifyQuery(&quot;SELECT string, number, nuller, blober FROM test WHERE id = ?&quot;,</span>
<a href="#l101.255"></a><span id="l101.255" class="difflineplus">+              INTEGER,</span>
<a href="#l101.256"></a><span id="l101.256" class="difflineplus">+              [TEXT, REAL, null, BLOB]);</span>
<a href="#l101.257"></a><span id="l101.257" class="difflineplus">+  run_next_test();</span>
<a href="#l101.258"></a><span id="l101.258" class="difflineplus">+}</span>
<a href="#l101.259"></a><span id="l101.259" class="difflineplus">+</span>
<a href="#l101.260"></a><span id="l101.260" class="difflineplus">+function test_get_data()</span>
<a href="#l101.261"></a><span id="l101.261" class="difflineplus">+{</span>
<a href="#l101.262"></a><span id="l101.262" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.263"></a><span id="l101.263" class="difflineplus">+    &quot;SELECT string, number, nuller, blober, id FROM test WHERE id = ?&quot;</span>
<a href="#l101.264"></a><span id="l101.264" class="difflineplus">+  );</span>
<a href="#l101.265"></a><span id="l101.265" class="difflineplus">+  stmt.bindInt32Parameter(0, INTEGER);</span>
<a href="#l101.266"></a><span id="l101.266" class="difflineplus">+  execAsync(stmt, {}, [</span>
<a href="#l101.267"></a><span id="l101.267" class="difflineplus">+    function(tuple)</span>
<a href="#l101.268"></a><span id="l101.268" class="difflineplus">+    {</span>
<a href="#l101.269"></a><span id="l101.269" class="difflineplus">+      do_check_neq(null, tuple);</span>
<a href="#l101.270"></a><span id="l101.270" class="difflineplus">+</span>
<a href="#l101.271"></a><span id="l101.271" class="difflineplus">+      // Check that it's what we expect</span>
<a href="#l101.272"></a><span id="l101.272" class="difflineplus">+      do_check_false(tuple.getIsNull(0));</span>
<a href="#l101.273"></a><span id="l101.273" class="difflineplus">+      do_check_eq(tuple.getResultByName(&quot;string&quot;), tuple.getResultByIndex(0));</span>
<a href="#l101.274"></a><span id="l101.274" class="difflineplus">+      do_check_eq(TEXT, tuple.getResultByName(&quot;string&quot;));</span>
<a href="#l101.275"></a><span id="l101.275" class="difflineplus">+      do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_TEXT,</span>
<a href="#l101.276"></a><span id="l101.276" class="difflineplus">+                  tuple.getTypeOfIndex(0));</span>
<a href="#l101.277"></a><span id="l101.277" class="difflineplus">+</span>
<a href="#l101.278"></a><span id="l101.278" class="difflineplus">+      do_check_false(tuple.getIsNull(1));</span>
<a href="#l101.279"></a><span id="l101.279" class="difflineplus">+      do_check_eq(tuple.getResultByName(&quot;number&quot;), tuple.getResultByIndex(1));</span>
<a href="#l101.280"></a><span id="l101.280" class="difflineplus">+      do_check_eq(REAL, tuple.getResultByName(&quot;number&quot;));</span>
<a href="#l101.281"></a><span id="l101.281" class="difflineplus">+      do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_FLOAT,</span>
<a href="#l101.282"></a><span id="l101.282" class="difflineplus">+                  tuple.getTypeOfIndex(1));</span>
<a href="#l101.283"></a><span id="l101.283" class="difflineplus">+</span>
<a href="#l101.284"></a><span id="l101.284" class="difflineplus">+      do_check_true(tuple.getIsNull(2));</span>
<a href="#l101.285"></a><span id="l101.285" class="difflineplus">+      do_check_eq(tuple.getResultByName(&quot;nuller&quot;), tuple.getResultByIndex(2));</span>
<a href="#l101.286"></a><span id="l101.286" class="difflineplus">+      do_check_eq(null, tuple.getResultByName(&quot;nuller&quot;));</span>
<a href="#l101.287"></a><span id="l101.287" class="difflineplus">+      do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_NULL,</span>
<a href="#l101.288"></a><span id="l101.288" class="difflineplus">+                  tuple.getTypeOfIndex(2));</span>
<a href="#l101.289"></a><span id="l101.289" class="difflineplus">+</span>
<a href="#l101.290"></a><span id="l101.290" class="difflineplus">+      do_check_false(tuple.getIsNull(3));</span>
<a href="#l101.291"></a><span id="l101.291" class="difflineplus">+      var blobByName = tuple.getResultByName(&quot;blober&quot;);</span>
<a href="#l101.292"></a><span id="l101.292" class="difflineplus">+      do_check_eq(BLOB.length, blobByName.length);</span>
<a href="#l101.293"></a><span id="l101.293" class="difflineplus">+      var blobByIndex = tuple.getResultByIndex(3);</span>
<a href="#l101.294"></a><span id="l101.294" class="difflineplus">+      do_check_eq(BLOB.length, blobByIndex.length);</span>
<a href="#l101.295"></a><span id="l101.295" class="difflineplus">+      for (var i = 0; i &lt; BLOB.length; i++) {</span>
<a href="#l101.296"></a><span id="l101.296" class="difflineplus">+        do_check_eq(BLOB[i], blobByName[i]);</span>
<a href="#l101.297"></a><span id="l101.297" class="difflineplus">+        do_check_eq(BLOB[i], blobByIndex[i]);</span>
<a href="#l101.298"></a><span id="l101.298" class="difflineplus">+      }</span>
<a href="#l101.299"></a><span id="l101.299" class="difflineplus">+      var count = { value: 0 };</span>
<a href="#l101.300"></a><span id="l101.300" class="difflineplus">+      var blob = { value: null };</span>
<a href="#l101.301"></a><span id="l101.301" class="difflineplus">+      tuple.getBlob(3, count, blob);</span>
<a href="#l101.302"></a><span id="l101.302" class="difflineplus">+      do_check_eq(BLOB.length, count.value);</span>
<a href="#l101.303"></a><span id="l101.303" class="difflineplus">+      for (var i = 0; i &lt; BLOB.length; i++)</span>
<a href="#l101.304"></a><span id="l101.304" class="difflineplus">+        do_check_eq(BLOB[i], blob.value[i]);</span>
<a href="#l101.305"></a><span id="l101.305" class="difflineplus">+      do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_BLOB,</span>
<a href="#l101.306"></a><span id="l101.306" class="difflineplus">+                  tuple.getTypeOfIndex(3));</span>
<a href="#l101.307"></a><span id="l101.307" class="difflineplus">+</span>
<a href="#l101.308"></a><span id="l101.308" class="difflineplus">+      do_check_false(tuple.getIsNull(4));</span>
<a href="#l101.309"></a><span id="l101.309" class="difflineplus">+      do_check_eq(tuple.getResultByName(&quot;id&quot;), tuple.getResultByIndex(4));</span>
<a href="#l101.310"></a><span id="l101.310" class="difflineplus">+      do_check_eq(INTEGER, tuple.getResultByName(&quot;id&quot;));</span>
<a href="#l101.311"></a><span id="l101.311" class="difflineplus">+      do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_INTEGER,</span>
<a href="#l101.312"></a><span id="l101.312" class="difflineplus">+                  tuple.getTypeOfIndex(4));</span>
<a href="#l101.313"></a><span id="l101.313" class="difflineplus">+    }]);</span>
<a href="#l101.314"></a><span id="l101.314" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.315"></a><span id="l101.315" class="difflineplus">+  run_next_test();</span>
<a href="#l101.316"></a><span id="l101.316" class="difflineplus">+}</span>
<a href="#l101.317"></a><span id="l101.317" class="difflineplus">+</span>
<a href="#l101.318"></a><span id="l101.318" class="difflineplus">+function test_tuple_out_of_bounds()</span>
<a href="#l101.319"></a><span id="l101.319" class="difflineplus">+{</span>
<a href="#l101.320"></a><span id="l101.320" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.321"></a><span id="l101.321" class="difflineplus">+    &quot;SELECT string FROM test&quot;</span>
<a href="#l101.322"></a><span id="l101.322" class="difflineplus">+  );</span>
<a href="#l101.323"></a><span id="l101.323" class="difflineplus">+  execAsync(stmt, {}, [</span>
<a href="#l101.324"></a><span id="l101.324" class="difflineplus">+    function(tuple) {</span>
<a href="#l101.325"></a><span id="l101.325" class="difflineplus">+      do_check_neq(null, tuple);</span>
<a href="#l101.326"></a><span id="l101.326" class="difflineplus">+</span>
<a href="#l101.327"></a><span id="l101.327" class="difflineplus">+      // Check all out of bounds - should throw</span>
<a href="#l101.328"></a><span id="l101.328" class="difflineplus">+      var methods = [</span>
<a href="#l101.329"></a><span id="l101.329" class="difflineplus">+        &quot;getTypeOfIndex&quot;,</span>
<a href="#l101.330"></a><span id="l101.330" class="difflineplus">+        &quot;getInt32&quot;,</span>
<a href="#l101.331"></a><span id="l101.331" class="difflineplus">+        &quot;getInt64&quot;,</span>
<a href="#l101.332"></a><span id="l101.332" class="difflineplus">+        &quot;getDouble&quot;,</span>
<a href="#l101.333"></a><span id="l101.333" class="difflineplus">+        &quot;getUTF8String&quot;,</span>
<a href="#l101.334"></a><span id="l101.334" class="difflineplus">+        &quot;getString&quot;,</span>
<a href="#l101.335"></a><span id="l101.335" class="difflineplus">+        &quot;getIsNull&quot;,</span>
<a href="#l101.336"></a><span id="l101.336" class="difflineplus">+      ];</span>
<a href="#l101.337"></a><span id="l101.337" class="difflineplus">+      for (var i in methods) {</span>
<a href="#l101.338"></a><span id="l101.338" class="difflineplus">+        try {</span>
<a href="#l101.339"></a><span id="l101.339" class="difflineplus">+          tuple[methods[i]](tuple.numEntries);</span>
<a href="#l101.340"></a><span id="l101.340" class="difflineplus">+          do_throw(&quot;did not throw :(&quot;);</span>
<a href="#l101.341"></a><span id="l101.341" class="difflineplus">+        }</span>
<a href="#l101.342"></a><span id="l101.342" class="difflineplus">+        catch (e) {</span>
<a href="#l101.343"></a><span id="l101.343" class="difflineplus">+          do_check_eq(Cr.NS_ERROR_ILLEGAL_VALUE, e.result);</span>
<a href="#l101.344"></a><span id="l101.344" class="difflineplus">+        }</span>
<a href="#l101.345"></a><span id="l101.345" class="difflineplus">+      }</span>
<a href="#l101.346"></a><span id="l101.346" class="difflineplus">+</span>
<a href="#l101.347"></a><span id="l101.347" class="difflineplus">+      // getBlob requires more args...</span>
<a href="#l101.348"></a><span id="l101.348" class="difflineplus">+      try {</span>
<a href="#l101.349"></a><span id="l101.349" class="difflineplus">+        var blob = { value: null };</span>
<a href="#l101.350"></a><span id="l101.350" class="difflineplus">+        var size = { value: 0 };</span>
<a href="#l101.351"></a><span id="l101.351" class="difflineplus">+        tuple.getBlob(tuple.numEntries, blob, size);</span>
<a href="#l101.352"></a><span id="l101.352" class="difflineplus">+        do_throw(&quot;did not throw :(&quot;);</span>
<a href="#l101.353"></a><span id="l101.353" class="difflineplus">+      }</span>
<a href="#l101.354"></a><span id="l101.354" class="difflineplus">+      catch (e) {</span>
<a href="#l101.355"></a><span id="l101.355" class="difflineplus">+        do_check_eq(Cr.NS_ERROR_ILLEGAL_VALUE, e.result);</span>
<a href="#l101.356"></a><span id="l101.356" class="difflineplus">+      }</span>
<a href="#l101.357"></a><span id="l101.357" class="difflineplus">+    }]);</span>
<a href="#l101.358"></a><span id="l101.358" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.359"></a><span id="l101.359" class="difflineplus">+  run_next_test();</span>
<a href="#l101.360"></a><span id="l101.360" class="difflineplus">+}</span>
<a href="#l101.361"></a><span id="l101.361" class="difflineplus">+</span>
<a href="#l101.362"></a><span id="l101.362" class="difflineplus">+function test_no_listener_works_on_success()</span>
<a href="#l101.363"></a><span id="l101.363" class="difflineplus">+{</span>
<a href="#l101.364"></a><span id="l101.364" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.365"></a><span id="l101.365" class="difflineplus">+    &quot;DELETE FROM test WHERE id = ?&quot;</span>
<a href="#l101.366"></a><span id="l101.366" class="difflineplus">+  );</span>
<a href="#l101.367"></a><span id="l101.367" class="difflineplus">+  stmt.bindInt32Parameter(0, 0);</span>
<a href="#l101.368"></a><span id="l101.368" class="difflineplus">+  stmt.executeAsync();</span>
<a href="#l101.369"></a><span id="l101.369" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.370"></a><span id="l101.370" class="difflineplus">+</span>
<a href="#l101.371"></a><span id="l101.371" class="difflineplus">+  // Run the next test.</span>
<a href="#l101.372"></a><span id="l101.372" class="difflineplus">+  run_next_test();</span>
<a href="#l101.373"></a><span id="l101.373" class="difflineplus">+}</span>
<a href="#l101.374"></a><span id="l101.374" class="difflineplus">+</span>
<a href="#l101.375"></a><span id="l101.375" class="difflineplus">+function test_no_listener_works_on_results()</span>
<a href="#l101.376"></a><span id="l101.376" class="difflineplus">+{</span>
<a href="#l101.377"></a><span id="l101.377" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.378"></a><span id="l101.378" class="difflineplus">+    &quot;SELECT ?&quot;</span>
<a href="#l101.379"></a><span id="l101.379" class="difflineplus">+  );</span>
<a href="#l101.380"></a><span id="l101.380" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l101.381"></a><span id="l101.381" class="difflineplus">+  stmt.executeAsync();</span>
<a href="#l101.382"></a><span id="l101.382" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.383"></a><span id="l101.383" class="difflineplus">+</span>
<a href="#l101.384"></a><span id="l101.384" class="difflineplus">+  // Run the next test.</span>
<a href="#l101.385"></a><span id="l101.385" class="difflineplus">+  run_next_test();</span>
<a href="#l101.386"></a><span id="l101.386" class="difflineplus">+}</span>
<a href="#l101.387"></a><span id="l101.387" class="difflineplus">+</span>
<a href="#l101.388"></a><span id="l101.388" class="difflineplus">+function test_no_listener_works_on_error()</span>
<a href="#l101.389"></a><span id="l101.389" class="difflineplus">+{</span>
<a href="#l101.390"></a><span id="l101.390" class="difflineplus">+  // commit without a transaction will trigger an error</span>
<a href="#l101.391"></a><span id="l101.391" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.392"></a><span id="l101.392" class="difflineplus">+    &quot;COMMIT&quot;</span>
<a href="#l101.393"></a><span id="l101.393" class="difflineplus">+  );</span>
<a href="#l101.394"></a><span id="l101.394" class="difflineplus">+  stmt.executeAsync();</span>
<a href="#l101.395"></a><span id="l101.395" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.396"></a><span id="l101.396" class="difflineplus">+</span>
<a href="#l101.397"></a><span id="l101.397" class="difflineplus">+  // Run the next test.</span>
<a href="#l101.398"></a><span id="l101.398" class="difflineplus">+  run_next_test();</span>
<a href="#l101.399"></a><span id="l101.399" class="difflineplus">+}</span>
<a href="#l101.400"></a><span id="l101.400" class="difflineplus">+</span>
<a href="#l101.401"></a><span id="l101.401" class="difflineplus">+function test_partial_listener_works()</span>
<a href="#l101.402"></a><span id="l101.402" class="difflineplus">+{</span>
<a href="#l101.403"></a><span id="l101.403" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.404"></a><span id="l101.404" class="difflineplus">+    &quot;DELETE FROM test WHERE id = ?&quot;</span>
<a href="#l101.405"></a><span id="l101.405" class="difflineplus">+  );</span>
<a href="#l101.406"></a><span id="l101.406" class="difflineplus">+  stmt.bindInt32Parameter(0, 0);</span>
<a href="#l101.407"></a><span id="l101.407" class="difflineplus">+  stmt.executeAsync({</span>
<a href="#l101.408"></a><span id="l101.408" class="difflineplus">+    handleResult: function(aResultSet)</span>
<a href="#l101.409"></a><span id="l101.409" class="difflineplus">+    {</span>
<a href="#l101.410"></a><span id="l101.410" class="difflineplus">+    }</span>
<a href="#l101.411"></a><span id="l101.411" class="difflineplus">+  });</span>
<a href="#l101.412"></a><span id="l101.412" class="difflineplus">+  stmt.executeAsync({</span>
<a href="#l101.413"></a><span id="l101.413" class="difflineplus">+    handleError: function(aError)</span>
<a href="#l101.414"></a><span id="l101.414" class="difflineplus">+    {</span>
<a href="#l101.415"></a><span id="l101.415" class="difflineplus">+    }</span>
<a href="#l101.416"></a><span id="l101.416" class="difflineplus">+  });</span>
<a href="#l101.417"></a><span id="l101.417" class="difflineplus">+  stmt.executeAsync({</span>
<a href="#l101.418"></a><span id="l101.418" class="difflineplus">+    handleCompletion: function(aReason)</span>
<a href="#l101.419"></a><span id="l101.419" class="difflineplus">+    {</span>
<a href="#l101.420"></a><span id="l101.420" class="difflineplus">+    }</span>
<a href="#l101.421"></a><span id="l101.421" class="difflineplus">+  });</span>
<a href="#l101.422"></a><span id="l101.422" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.423"></a><span id="l101.423" class="difflineplus">+</span>
<a href="#l101.424"></a><span id="l101.424" class="difflineplus">+  // Run the next test.</span>
<a href="#l101.425"></a><span id="l101.425" class="difflineplus">+  run_next_test();</span>
<a href="#l101.426"></a><span id="l101.426" class="difflineplus">+}</span>
<a href="#l101.427"></a><span id="l101.427" class="difflineplus">+</span>
<a href="#l101.428"></a><span id="l101.428" class="difflineplus">+/**</span>
<a href="#l101.429"></a><span id="l101.429" class="difflineplus">+ * Dubious cancellation test that depends on system loading may or may not</span>
<a href="#l101.430"></a><span id="l101.430" class="difflineplus">+ * succeed in canceling things.  It does at least test if calling cancel blows</span>
<a href="#l101.431"></a><span id="l101.431" class="difflineplus">+ * up.  test_AsyncCancellation in test_true_async.cpp is our test that canceling</span>
<a href="#l101.432"></a><span id="l101.432" class="difflineplus">+ * actually works correctly.</span>
<a href="#l101.433"></a><span id="l101.433" class="difflineplus">+ */</span>
<a href="#l101.434"></a><span id="l101.434" class="difflineplus">+function test_immediate_cancellation()</span>
<a href="#l101.435"></a><span id="l101.435" class="difflineplus">+{</span>
<a href="#l101.436"></a><span id="l101.436" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.437"></a><span id="l101.437" class="difflineplus">+    &quot;DELETE FROM test WHERE id = ?&quot;</span>
<a href="#l101.438"></a><span id="l101.438" class="difflineplus">+  );</span>
<a href="#l101.439"></a><span id="l101.439" class="difflineplus">+  stmt.bindInt32Parameter(0, 0);</span>
<a href="#l101.440"></a><span id="l101.440" class="difflineplus">+  execAsync(stmt, {cancel: true});</span>
<a href="#l101.441"></a><span id="l101.441" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.442"></a><span id="l101.442" class="difflineplus">+  run_next_test();</span>
<a href="#l101.443"></a><span id="l101.443" class="difflineplus">+}</span>
<a href="#l101.444"></a><span id="l101.444" class="difflineplus">+</span>
<a href="#l101.445"></a><span id="l101.445" class="difflineplus">+/**</span>
<a href="#l101.446"></a><span id="l101.446" class="difflineplus">+ * Test that calling cancel twice throws the second time.</span>
<a href="#l101.447"></a><span id="l101.447" class="difflineplus">+ */</span>
<a href="#l101.448"></a><span id="l101.448" class="difflineplus">+function test_double_cancellation()</span>
<a href="#l101.449"></a><span id="l101.449" class="difflineplus">+{</span>
<a href="#l101.450"></a><span id="l101.450" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.451"></a><span id="l101.451" class="difflineplus">+    &quot;DELETE FROM test WHERE id = ?&quot;</span>
<a href="#l101.452"></a><span id="l101.452" class="difflineplus">+  );</span>
<a href="#l101.453"></a><span id="l101.453" class="difflineplus">+  stmt.bindInt32Parameter(0, 0);</span>
<a href="#l101.454"></a><span id="l101.454" class="difflineplus">+  let pendingStatement = execAsync(stmt, {cancel: true});</span>
<a href="#l101.455"></a><span id="l101.455" class="difflineplus">+  // And cancel again - expect an exception</span>
<a href="#l101.456"></a><span id="l101.456" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.457"></a><span id="l101.457" class="difflineplus">+              function() pendingStatement.cancel());</span>
<a href="#l101.458"></a><span id="l101.458" class="difflineplus">+</span>
<a href="#l101.459"></a><span id="l101.459" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.460"></a><span id="l101.460" class="difflineplus">+  run_next_test();</span>
<a href="#l101.461"></a><span id="l101.461" class="difflineplus">+}</span>
<a href="#l101.462"></a><span id="l101.462" class="difflineplus">+</span>
<a href="#l101.463"></a><span id="l101.463" class="difflineplus">+/**</span>
<a href="#l101.464"></a><span id="l101.464" class="difflineplus">+ * Verify that nothing untoward happens if we try and cancel something after it</span>
<a href="#l101.465"></a><span id="l101.465" class="difflineplus">+ * has fully run to completion.</span>
<a href="#l101.466"></a><span id="l101.466" class="difflineplus">+ */</span>
<a href="#l101.467"></a><span id="l101.467" class="difflineplus">+function test_cancellation_after_execution()</span>
<a href="#l101.468"></a><span id="l101.468" class="difflineplus">+{</span>
<a href="#l101.469"></a><span id="l101.469" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.470"></a><span id="l101.470" class="difflineplus">+    &quot;DELETE FROM test WHERE id = ?&quot;</span>
<a href="#l101.471"></a><span id="l101.471" class="difflineplus">+  );</span>
<a href="#l101.472"></a><span id="l101.472" class="difflineplus">+  stmt.bindInt32Parameter(0, 0);</span>
<a href="#l101.473"></a><span id="l101.473" class="difflineplus">+  let pendingStatement = execAsync(stmt, {returnPending: true});</span>
<a href="#l101.474"></a><span id="l101.474" class="difflineplus">+  // (the statement has fully executed at this point)</span>
<a href="#l101.475"></a><span id="l101.475" class="difflineplus">+  // canceling after the statement has run to completion should not throw!</span>
<a href="#l101.476"></a><span id="l101.476" class="difflineplus">+  pendingStatement.cancel();</span>
<a href="#l101.477"></a><span id="l101.477" class="difflineplus">+</span>
<a href="#l101.478"></a><span id="l101.478" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.479"></a><span id="l101.479" class="difflineplus">+  run_next_test();</span>
<a href="#l101.480"></a><span id="l101.480" class="difflineplus">+}</span>
<a href="#l101.481"></a><span id="l101.481" class="difflineplus">+</span>
<a href="#l101.482"></a><span id="l101.482" class="difflineplus">+/**</span>
<a href="#l101.483"></a><span id="l101.483" class="difflineplus">+ * Verifies that a single statement can be executed more than once.  Might once</span>
<a href="#l101.484"></a><span id="l101.484" class="difflineplus">+ * have been intended to also ensure that callback notifications were not</span>
<a href="#l101.485"></a><span id="l101.485" class="difflineplus">+ * incorrectly interleaved, but that part was brittle (it's totally fine for</span>
<a href="#l101.486"></a><span id="l101.486" class="difflineplus">+ * handleResult to get called multiple times) and not comprehensive.</span>
<a href="#l101.487"></a><span id="l101.487" class="difflineplus">+ */</span>
<a href="#l101.488"></a><span id="l101.488" class="difflineplus">+function test_double_execute()</span>
<a href="#l101.489"></a><span id="l101.489" class="difflineplus">+{</span>
<a href="#l101.490"></a><span id="l101.490" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.491"></a><span id="l101.491" class="difflineplus">+    &quot;SELECT 1&quot;</span>
<a href="#l101.492"></a><span id="l101.492" class="difflineplus">+  );</span>
<a href="#l101.493"></a><span id="l101.493" class="difflineplus">+  execAsync(stmt, null, 1);</span>
<a href="#l101.494"></a><span id="l101.494" class="difflineplus">+  execAsync(stmt, null, 1);</span>
<a href="#l101.495"></a><span id="l101.495" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.496"></a><span id="l101.496" class="difflineplus">+  run_next_test();</span>
<a href="#l101.497"></a><span id="l101.497" class="difflineplus">+}</span>
<a href="#l101.498"></a><span id="l101.498" class="difflineplus">+</span>
<a href="#l101.499"></a><span id="l101.499" class="difflineplus">+function test_finalized_statement_does_not_crash()</span>
<a href="#l101.500"></a><span id="l101.500" class="difflineplus">+{</span>
<a href="#l101.501"></a><span id="l101.501" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.502"></a><span id="l101.502" class="difflineplus">+    &quot;SELECT * FROM TEST&quot;</span>
<a href="#l101.503"></a><span id="l101.503" class="difflineplus">+  );</span>
<a href="#l101.504"></a><span id="l101.504" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.505"></a><span id="l101.505" class="difflineplus">+  // we are concerned about a crash here; an error is fine.</span>
<a href="#l101.506"></a><span id="l101.506" class="difflineplus">+  try {</span>
<a href="#l101.507"></a><span id="l101.507" class="difflineplus">+    stmt.executeAsync();</span>
<a href="#l101.508"></a><span id="l101.508" class="difflineplus">+  }</span>
<a href="#l101.509"></a><span id="l101.509" class="difflineplus">+  catch (ex) {}</span>
<a href="#l101.510"></a><span id="l101.510" class="difflineplus">+</span>
<a href="#l101.511"></a><span id="l101.511" class="difflineplus">+  // Run the next test.</span>
<a href="#l101.512"></a><span id="l101.512" class="difflineplus">+  run_next_test();</span>
<a href="#l101.513"></a><span id="l101.513" class="difflineplus">+}</span>
<a href="#l101.514"></a><span id="l101.514" class="difflineplus">+</span>
<a href="#l101.515"></a><span id="l101.515" class="difflineplus">+/**</span>
<a href="#l101.516"></a><span id="l101.516" class="difflineplus">+ * Bind by mozIStorageBindingParams on the mozIStorageBaseStatement by index.</span>
<a href="#l101.517"></a><span id="l101.517" class="difflineplus">+ */</span>
<a href="#l101.518"></a><span id="l101.518" class="difflineplus">+function test_bind_direct_binding_params_by_index()</span>
<a href="#l101.519"></a><span id="l101.519" class="difflineplus">+{</span>
<a href="#l101.520"></a><span id="l101.520" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.521"></a><span id="l101.521" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.522"></a><span id="l101.522" class="difflineplus">+    &quot;VALUES (?, ?, ?, ?, ?)&quot;</span>
<a href="#l101.523"></a><span id="l101.523" class="difflineplus">+  );</span>
<a href="#l101.524"></a><span id="l101.524" class="difflineplus">+  let insertId = nextUniqueId++;</span>
<a href="#l101.525"></a><span id="l101.525" class="difflineplus">+  stmt.bindByIndex(0, insertId);</span>
<a href="#l101.526"></a><span id="l101.526" class="difflineplus">+  stmt.bindByIndex(1, TEXT);</span>
<a href="#l101.527"></a><span id="l101.527" class="difflineplus">+  stmt.bindByIndex(2, REAL);</span>
<a href="#l101.528"></a><span id="l101.528" class="difflineplus">+  stmt.bindByIndex(3, null);</span>
<a href="#l101.529"></a><span id="l101.529" class="difflineplus">+  stmt.bindBlobByIndex(4, BLOB, BLOB.length);</span>
<a href="#l101.530"></a><span id="l101.530" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.531"></a><span id="l101.531" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.532"></a><span id="l101.532" class="difflineplus">+  verifyQuery(&quot;SELECT string, number, nuller, blober FROM test WHERE id = ?&quot;,</span>
<a href="#l101.533"></a><span id="l101.533" class="difflineplus">+              insertId,</span>
<a href="#l101.534"></a><span id="l101.534" class="difflineplus">+              [TEXT, REAL, null, BLOB]);</span>
<a href="#l101.535"></a><span id="l101.535" class="difflineplus">+  run_next_test();</span>
<a href="#l101.536"></a><span id="l101.536" class="difflineplus">+}</span>
<a href="#l101.537"></a><span id="l101.537" class="difflineplus">+</span>
<a href="#l101.538"></a><span id="l101.538" class="difflineplus">+/**</span>
<a href="#l101.539"></a><span id="l101.539" class="difflineplus">+ * Bind by mozIStorageBindingParams on the mozIStorageBaseStatement by name.</span>
<a href="#l101.540"></a><span id="l101.540" class="difflineplus">+ */</span>
<a href="#l101.541"></a><span id="l101.541" class="difflineplus">+function test_bind_direct_binding_params_by_name()</span>
<a href="#l101.542"></a><span id="l101.542" class="difflineplus">+{</span>
<a href="#l101.543"></a><span id="l101.543" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.544"></a><span id="l101.544" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.545"></a><span id="l101.545" class="difflineplus">+    &quot;VALUES (:int, :text, :real, :null, :blob)&quot;</span>
<a href="#l101.546"></a><span id="l101.546" class="difflineplus">+  );</span>
<a href="#l101.547"></a><span id="l101.547" class="difflineplus">+  let insertId = nextUniqueId++;</span>
<a href="#l101.548"></a><span id="l101.548" class="difflineplus">+  stmt.bindByName(&quot;int&quot;, insertId);</span>
<a href="#l101.549"></a><span id="l101.549" class="difflineplus">+  stmt.bindByName(&quot;text&quot;, TEXT);</span>
<a href="#l101.550"></a><span id="l101.550" class="difflineplus">+  stmt.bindByName(&quot;real&quot;, REAL);</span>
<a href="#l101.551"></a><span id="l101.551" class="difflineplus">+  stmt.bindByName(&quot;null&quot;, null);</span>
<a href="#l101.552"></a><span id="l101.552" class="difflineplus">+  stmt.bindBlobByName(&quot;blob&quot;, BLOB, BLOB.length);</span>
<a href="#l101.553"></a><span id="l101.553" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.554"></a><span id="l101.554" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.555"></a><span id="l101.555" class="difflineplus">+  verifyQuery(&quot;SELECT string, number, nuller, blober FROM test WHERE id = ?&quot;,</span>
<a href="#l101.556"></a><span id="l101.556" class="difflineplus">+              insertId,</span>
<a href="#l101.557"></a><span id="l101.557" class="difflineplus">+              [TEXT, REAL, null, BLOB]);</span>
<a href="#l101.558"></a><span id="l101.558" class="difflineplus">+  run_next_test();</span>
<a href="#l101.559"></a><span id="l101.559" class="difflineplus">+}</span>
<a href="#l101.560"></a><span id="l101.560" class="difflineplus">+</span>
<a href="#l101.561"></a><span id="l101.561" class="difflineplus">+function test_bind_js_params_helper_by_index()</span>
<a href="#l101.562"></a><span id="l101.562" class="difflineplus">+{</span>
<a href="#l101.563"></a><span id="l101.563" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.564"></a><span id="l101.564" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.565"></a><span id="l101.565" class="difflineplus">+    &quot;VALUES (?, ?, ?, ?, NULL)&quot;</span>
<a href="#l101.566"></a><span id="l101.566" class="difflineplus">+  );</span>
<a href="#l101.567"></a><span id="l101.567" class="difflineplus">+  let insertId = nextUniqueId++;</span>
<a href="#l101.568"></a><span id="l101.568" class="difflineplus">+  // we cannot bind blobs this way; no blober</span>
<a href="#l101.569"></a><span id="l101.569" class="difflineplus">+  stmt.params[3] = null;</span>
<a href="#l101.570"></a><span id="l101.570" class="difflineplus">+  stmt.params[2] = REAL;</span>
<a href="#l101.571"></a><span id="l101.571" class="difflineplus">+  stmt.params[1] = TEXT;</span>
<a href="#l101.572"></a><span id="l101.572" class="difflineplus">+  stmt.params[0] = insertId;</span>
<a href="#l101.573"></a><span id="l101.573" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.574"></a><span id="l101.574" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.575"></a><span id="l101.575" class="difflineplus">+  verifyQuery(&quot;SELECT string, number, nuller FROM test WHERE id = ?&quot;, insertId,</span>
<a href="#l101.576"></a><span id="l101.576" class="difflineplus">+              [TEXT, REAL, null]);</span>
<a href="#l101.577"></a><span id="l101.577" class="difflineplus">+  run_next_test();</span>
<a href="#l101.578"></a><span id="l101.578" class="difflineplus">+}</span>
<a href="#l101.579"></a><span id="l101.579" class="difflineplus">+</span>
<a href="#l101.580"></a><span id="l101.580" class="difflineplus">+function test_bind_js_params_helper_by_name()</span>
<a href="#l101.581"></a><span id="l101.581" class="difflineplus">+{</span>
<a href="#l101.582"></a><span id="l101.582" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.583"></a><span id="l101.583" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.584"></a><span id="l101.584" class="difflineplus">+    &quot;VALUES (:int, :text, :real, :null, NULL)&quot;</span>
<a href="#l101.585"></a><span id="l101.585" class="difflineplus">+  );</span>
<a href="#l101.586"></a><span id="l101.586" class="difflineplus">+  let insertId = nextUniqueId++;</span>
<a href="#l101.587"></a><span id="l101.587" class="difflineplus">+  // we cannot bind blobs this way; no blober</span>
<a href="#l101.588"></a><span id="l101.588" class="difflineplus">+  stmt.params.null = null;</span>
<a href="#l101.589"></a><span id="l101.589" class="difflineplus">+  stmt.params.real = REAL;</span>
<a href="#l101.590"></a><span id="l101.590" class="difflineplus">+  stmt.params.text = TEXT;</span>
<a href="#l101.591"></a><span id="l101.591" class="difflineplus">+  stmt.params.int = insertId;</span>
<a href="#l101.592"></a><span id="l101.592" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.593"></a><span id="l101.593" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.594"></a><span id="l101.594" class="difflineplus">+  verifyQuery(&quot;SELECT string, number, nuller FROM test WHERE id = ?&quot;, insertId,</span>
<a href="#l101.595"></a><span id="l101.595" class="difflineplus">+              [TEXT, REAL, null]);</span>
<a href="#l101.596"></a><span id="l101.596" class="difflineplus">+  run_next_test();</span>
<a href="#l101.597"></a><span id="l101.597" class="difflineplus">+}</span>
<a href="#l101.598"></a><span id="l101.598" class="difflineplus">+</span>
<a href="#l101.599"></a><span id="l101.599" class="difflineplus">+function test_bind_multiple_rows_by_index()</span>
<a href="#l101.600"></a><span id="l101.600" class="difflineplus">+{</span>
<a href="#l101.601"></a><span id="l101.601" class="difflineplus">+  const AMOUNT_TO_ADD = 5;</span>
<a href="#l101.602"></a><span id="l101.602" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.603"></a><span id="l101.603" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.604"></a><span id="l101.604" class="difflineplus">+    &quot;VALUES (?, ?, ?, ?, ?)&quot;</span>
<a href="#l101.605"></a><span id="l101.605" class="difflineplus">+  );</span>
<a href="#l101.606"></a><span id="l101.606" class="difflineplus">+  var array = stmt.newBindingParamsArray();</span>
<a href="#l101.607"></a><span id="l101.607" class="difflineplus">+  for (let i = 0; i &lt; AMOUNT_TO_ADD; i++) {</span>
<a href="#l101.608"></a><span id="l101.608" class="difflineplus">+    let bp = array.newBindingParams();</span>
<a href="#l101.609"></a><span id="l101.609" class="difflineplus">+    bp.bindByIndex(0, INTEGER);</span>
<a href="#l101.610"></a><span id="l101.610" class="difflineplus">+    bp.bindByIndex(1, TEXT);</span>
<a href="#l101.611"></a><span id="l101.611" class="difflineplus">+    bp.bindByIndex(2, REAL);</span>
<a href="#l101.612"></a><span id="l101.612" class="difflineplus">+    bp.bindByIndex(3, null);</span>
<a href="#l101.613"></a><span id="l101.613" class="difflineplus">+    bp.bindBlobByIndex(4, BLOB, BLOB.length);</span>
<a href="#l101.614"></a><span id="l101.614" class="difflineplus">+    array.addParams(bp);</span>
<a href="#l101.615"></a><span id="l101.615" class="difflineplus">+  }</span>
<a href="#l101.616"></a><span id="l101.616" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.617"></a><span id="l101.617" class="difflineplus">+</span>
<a href="#l101.618"></a><span id="l101.618" class="difflineplus">+  let rowCount = getTableRowCount(&quot;test&quot;);</span>
<a href="#l101.619"></a><span id="l101.619" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.620"></a><span id="l101.620" class="difflineplus">+  do_check_eq(rowCount + AMOUNT_TO_ADD, getTableRowCount(&quot;test&quot;));</span>
<a href="#l101.621"></a><span id="l101.621" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.622"></a><span id="l101.622" class="difflineplus">+  run_next_test();</span>
<a href="#l101.623"></a><span id="l101.623" class="difflineplus">+}</span>
<a href="#l101.624"></a><span id="l101.624" class="difflineplus">+</span>
<a href="#l101.625"></a><span id="l101.625" class="difflineplus">+function test_bind_multiple_rows_by_name()</span>
<a href="#l101.626"></a><span id="l101.626" class="difflineplus">+{</span>
<a href="#l101.627"></a><span id="l101.627" class="difflineplus">+  const AMOUNT_TO_ADD = 5;</span>
<a href="#l101.628"></a><span id="l101.628" class="difflineplus">+  var stmt = makeTestStatement(</span>
<a href="#l101.629"></a><span id="l101.629" class="difflineplus">+    &quot;INSERT INTO test (id, string, number, nuller, blober) &quot; +</span>
<a href="#l101.630"></a><span id="l101.630" class="difflineplus">+    &quot;VALUES (:int, :text, :real, :null, :blob)&quot;</span>
<a href="#l101.631"></a><span id="l101.631" class="difflineplus">+  );</span>
<a href="#l101.632"></a><span id="l101.632" class="difflineplus">+  var array = stmt.newBindingParamsArray();</span>
<a href="#l101.633"></a><span id="l101.633" class="difflineplus">+  for (let i = 0; i &lt; AMOUNT_TO_ADD; i++) {</span>
<a href="#l101.634"></a><span id="l101.634" class="difflineplus">+    let bp = array.newBindingParams();</span>
<a href="#l101.635"></a><span id="l101.635" class="difflineplus">+    bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.636"></a><span id="l101.636" class="difflineplus">+    bp.bindByName(&quot;text&quot;, TEXT);</span>
<a href="#l101.637"></a><span id="l101.637" class="difflineplus">+    bp.bindByName(&quot;real&quot;, REAL);</span>
<a href="#l101.638"></a><span id="l101.638" class="difflineplus">+    bp.bindByName(&quot;null&quot;, null);</span>
<a href="#l101.639"></a><span id="l101.639" class="difflineplus">+    bp.bindBlobByName(&quot;blob&quot;, BLOB, BLOB.length);</span>
<a href="#l101.640"></a><span id="l101.640" class="difflineplus">+    array.addParams(bp);</span>
<a href="#l101.641"></a><span id="l101.641" class="difflineplus">+  }</span>
<a href="#l101.642"></a><span id="l101.642" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.643"></a><span id="l101.643" class="difflineplus">+</span>
<a href="#l101.644"></a><span id="l101.644" class="difflineplus">+  let rowCount = getTableRowCount(&quot;test&quot;);</span>
<a href="#l101.645"></a><span id="l101.645" class="difflineplus">+  execAsync(stmt);</span>
<a href="#l101.646"></a><span id="l101.646" class="difflineplus">+  do_check_eq(rowCount + AMOUNT_TO_ADD, getTableRowCount(&quot;test&quot;));</span>
<a href="#l101.647"></a><span id="l101.647" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.648"></a><span id="l101.648" class="difflineplus">+  run_next_test();</span>
<a href="#l101.649"></a><span id="l101.649" class="difflineplus">+}</span>
<a href="#l101.650"></a><span id="l101.650" class="difflineplus">+</span>
<a href="#l101.651"></a><span id="l101.651" class="difflineplus">+/**</span>
<a href="#l101.652"></a><span id="l101.652" class="difflineplus">+ * Verify that a mozIStorageStatement instance throws immediately when we</span>
<a href="#l101.653"></a><span id="l101.653" class="difflineplus">+ * try and bind to an illegal index.</span>
<a href="#l101.654"></a><span id="l101.654" class="difflineplus">+ */</span>
<a href="#l101.655"></a><span id="l101.655" class="difflineplus">+function test_bind_out_of_bounds_sync_immediate()</span>
<a href="#l101.656"></a><span id="l101.656" class="difflineplus">+{</span>
<a href="#l101.657"></a><span id="l101.657" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.658"></a><span id="l101.658" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.659"></a><span id="l101.659" class="difflineplus">+    &quot;VALUES (?)&quot;</span>
<a href="#l101.660"></a><span id="l101.660" class="difflineplus">+  );</span>
<a href="#l101.661"></a><span id="l101.661" class="difflineplus">+</span>
<a href="#l101.662"></a><span id="l101.662" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.663"></a><span id="l101.663" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.664"></a><span id="l101.664" class="difflineplus">+</span>
<a href="#l101.665"></a><span id="l101.665" class="difflineplus">+  // Check variant binding.</span>
<a href="#l101.666"></a><span id="l101.666" class="difflineplus">+  expectError(Cr.NS_ERROR_INVALID_ARG,</span>
<a href="#l101.667"></a><span id="l101.667" class="difflineplus">+              function() bp.bindByIndex(1, INTEGER));</span>
<a href="#l101.668"></a><span id="l101.668" class="difflineplus">+  // Check blob binding.</span>
<a href="#l101.669"></a><span id="l101.669" class="difflineplus">+  expectError(Cr.NS_ERROR_INVALID_ARG,</span>
<a href="#l101.670"></a><span id="l101.670" class="difflineplus">+              function() bp.bindBlobByIndex(1, BLOB, BLOB.length));</span>
<a href="#l101.671"></a><span id="l101.671" class="difflineplus">+</span>
<a href="#l101.672"></a><span id="l101.672" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.673"></a><span id="l101.673" class="difflineplus">+  run_next_test();</span>
<a href="#l101.674"></a><span id="l101.674" class="difflineplus">+}</span>
<a href="#l101.675"></a><span id="l101.675" class="difflineplus">+test_bind_out_of_bounds_sync_immediate.syncOnly = true;</span>
<a href="#l101.676"></a><span id="l101.676" class="difflineplus">+</span>
<a href="#l101.677"></a><span id="l101.677" class="difflineplus">+/**</span>
<a href="#l101.678"></a><span id="l101.678" class="difflineplus">+ * Verify that a mozIStorageAsyncStatement reports an error asynchronously when</span>
<a href="#l101.679"></a><span id="l101.679" class="difflineplus">+ * we bind to an illegal index.</span>
<a href="#l101.680"></a><span id="l101.680" class="difflineplus">+ */</span>
<a href="#l101.681"></a><span id="l101.681" class="difflineplus">+function test_bind_out_of_bounds_async_deferred()</span>
<a href="#l101.682"></a><span id="l101.682" class="difflineplus">+{</span>
<a href="#l101.683"></a><span id="l101.683" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.684"></a><span id="l101.684" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.685"></a><span id="l101.685" class="difflineplus">+    &quot;VALUES (?)&quot;</span>
<a href="#l101.686"></a><span id="l101.686" class="difflineplus">+  );</span>
<a href="#l101.687"></a><span id="l101.687" class="difflineplus">+</span>
<a href="#l101.688"></a><span id="l101.688" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.689"></a><span id="l101.689" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.690"></a><span id="l101.690" class="difflineplus">+</span>
<a href="#l101.691"></a><span id="l101.691" class="difflineplus">+  // There is no difference between variant and blob binding for async purposes.</span>
<a href="#l101.692"></a><span id="l101.692" class="difflineplus">+  bp.bindByIndex(1, INTEGER);</span>
<a href="#l101.693"></a><span id="l101.693" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.694"></a><span id="l101.694" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.695"></a><span id="l101.695" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.RANGE});</span>
<a href="#l101.696"></a><span id="l101.696" class="difflineplus">+</span>
<a href="#l101.697"></a><span id="l101.697" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.698"></a><span id="l101.698" class="difflineplus">+  run_next_test();</span>
<a href="#l101.699"></a><span id="l101.699" class="difflineplus">+}</span>
<a href="#l101.700"></a><span id="l101.700" class="difflineplus">+test_bind_out_of_bounds_async_deferred.asyncOnly = true;</span>
<a href="#l101.701"></a><span id="l101.701" class="difflineplus">+</span>
<a href="#l101.702"></a><span id="l101.702" class="difflineplus">+function test_bind_no_such_name_sync_immediate()</span>
<a href="#l101.703"></a><span id="l101.703" class="difflineplus">+{</span>
<a href="#l101.704"></a><span id="l101.704" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.705"></a><span id="l101.705" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.706"></a><span id="l101.706" class="difflineplus">+    &quot;VALUES (:foo)&quot;</span>
<a href="#l101.707"></a><span id="l101.707" class="difflineplus">+  );</span>
<a href="#l101.708"></a><span id="l101.708" class="difflineplus">+</span>
<a href="#l101.709"></a><span id="l101.709" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.710"></a><span id="l101.710" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.711"></a><span id="l101.711" class="difflineplus">+</span>
<a href="#l101.712"></a><span id="l101.712" class="difflineplus">+  // Check variant binding.</span>
<a href="#l101.713"></a><span id="l101.713" class="difflineplus">+  expectError(Cr.NS_ERROR_INVALID_ARG,</span>
<a href="#l101.714"></a><span id="l101.714" class="difflineplus">+              function() bp.bindByName(&quot;doesnotexist&quot;, INTEGER));</span>
<a href="#l101.715"></a><span id="l101.715" class="difflineplus">+  // Check blob binding.</span>
<a href="#l101.716"></a><span id="l101.716" class="difflineplus">+  expectError(Cr.NS_ERROR_INVALID_ARG,</span>
<a href="#l101.717"></a><span id="l101.717" class="difflineplus">+              function() bp.bindBlobByName(&quot;doesnotexist&quot;, BLOB, BLOB.length));</span>
<a href="#l101.718"></a><span id="l101.718" class="difflineplus">+</span>
<a href="#l101.719"></a><span id="l101.719" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.720"></a><span id="l101.720" class="difflineplus">+  run_next_test();</span>
<a href="#l101.721"></a><span id="l101.721" class="difflineplus">+}</span>
<a href="#l101.722"></a><span id="l101.722" class="difflineplus">+test_bind_no_such_name_sync_immediate.syncOnly = true;</span>
<a href="#l101.723"></a><span id="l101.723" class="difflineplus">+</span>
<a href="#l101.724"></a><span id="l101.724" class="difflineplus">+function test_bind_no_such_name_async_deferred()</span>
<a href="#l101.725"></a><span id="l101.725" class="difflineplus">+{</span>
<a href="#l101.726"></a><span id="l101.726" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.727"></a><span id="l101.727" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.728"></a><span id="l101.728" class="difflineplus">+    &quot;VALUES (:foo)&quot;</span>
<a href="#l101.729"></a><span id="l101.729" class="difflineplus">+  );</span>
<a href="#l101.730"></a><span id="l101.730" class="difflineplus">+</span>
<a href="#l101.731"></a><span id="l101.731" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.732"></a><span id="l101.732" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.733"></a><span id="l101.733" class="difflineplus">+</span>
<a href="#l101.734"></a><span id="l101.734" class="difflineplus">+  bp.bindByName(&quot;doesnotexist&quot;, INTEGER);</span>
<a href="#l101.735"></a><span id="l101.735" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.736"></a><span id="l101.736" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.737"></a><span id="l101.737" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.RANGE});</span>
<a href="#l101.738"></a><span id="l101.738" class="difflineplus">+</span>
<a href="#l101.739"></a><span id="l101.739" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.740"></a><span id="l101.740" class="difflineplus">+  run_next_test();</span>
<a href="#l101.741"></a><span id="l101.741" class="difflineplus">+}</span>
<a href="#l101.742"></a><span id="l101.742" class="difflineplus">+test_bind_no_such_name_async_deferred.asyncOnly = true;</span>
<a href="#l101.743"></a><span id="l101.743" class="difflineplus">+</span>
<a href="#l101.744"></a><span id="l101.744" class="difflineplus">+function test_bind_bogus_type_by_index()</span>
<a href="#l101.745"></a><span id="l101.745" class="difflineplus">+{</span>
<a href="#l101.746"></a><span id="l101.746" class="difflineplus">+  // We try to bind a JS Object here that should fail to bind.</span>
<a href="#l101.747"></a><span id="l101.747" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.748"></a><span id="l101.748" class="difflineplus">+    &quot;INSERT INTO test (blober) &quot; +</span>
<a href="#l101.749"></a><span id="l101.749" class="difflineplus">+    &quot;VALUES (?)&quot;</span>
<a href="#l101.750"></a><span id="l101.750" class="difflineplus">+  );</span>
<a href="#l101.751"></a><span id="l101.751" class="difflineplus">+</span>
<a href="#l101.752"></a><span id="l101.752" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.753"></a><span id="l101.753" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.754"></a><span id="l101.754" class="difflineplus">+  // We get an error after calling executeAsync, not when we bind.</span>
<a href="#l101.755"></a><span id="l101.755" class="difflineplus">+  bp.bindByIndex(0, run_test);</span>
<a href="#l101.756"></a><span id="l101.756" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.757"></a><span id="l101.757" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.758"></a><span id="l101.758" class="difflineplus">+</span>
<a href="#l101.759"></a><span id="l101.759" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.MISMATCH});</span>
<a href="#l101.760"></a><span id="l101.760" class="difflineplus">+</span>
<a href="#l101.761"></a><span id="l101.761" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.762"></a><span id="l101.762" class="difflineplus">+  run_next_test();</span>
<a href="#l101.763"></a><span id="l101.763" class="difflineplus">+}</span>
<a href="#l101.764"></a><span id="l101.764" class="difflineplus">+</span>
<a href="#l101.765"></a><span id="l101.765" class="difflineplus">+function test_bind_bogus_type_by_name()</span>
<a href="#l101.766"></a><span id="l101.766" class="difflineplus">+{</span>
<a href="#l101.767"></a><span id="l101.767" class="difflineplus">+  // We try to bind a JS Object here that should fail to bind.</span>
<a href="#l101.768"></a><span id="l101.768" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.769"></a><span id="l101.769" class="difflineplus">+    &quot;INSERT INTO test (blober) &quot; +</span>
<a href="#l101.770"></a><span id="l101.770" class="difflineplus">+    &quot;VALUES (:blob)&quot;</span>
<a href="#l101.771"></a><span id="l101.771" class="difflineplus">+  );</span>
<a href="#l101.772"></a><span id="l101.772" class="difflineplus">+</span>
<a href="#l101.773"></a><span id="l101.773" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.774"></a><span id="l101.774" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.775"></a><span id="l101.775" class="difflineplus">+  // We get an error after calling executeAsync, not when we bind.</span>
<a href="#l101.776"></a><span id="l101.776" class="difflineplus">+  bp.bindByName(&quot;blob&quot;, run_test);</span>
<a href="#l101.777"></a><span id="l101.777" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.778"></a><span id="l101.778" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.779"></a><span id="l101.779" class="difflineplus">+</span>
<a href="#l101.780"></a><span id="l101.780" class="difflineplus">+  execAsync(stmt, {error: Ci.mozIStorageError.MISMATCH});</span>
<a href="#l101.781"></a><span id="l101.781" class="difflineplus">+</span>
<a href="#l101.782"></a><span id="l101.782" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.783"></a><span id="l101.783" class="difflineplus">+  run_next_test();</span>
<a href="#l101.784"></a><span id="l101.784" class="difflineplus">+}</span>
<a href="#l101.785"></a><span id="l101.785" class="difflineplus">+</span>
<a href="#l101.786"></a><span id="l101.786" class="difflineplus">+function test_bind_params_already_locked()</span>
<a href="#l101.787"></a><span id="l101.787" class="difflineplus">+{</span>
<a href="#l101.788"></a><span id="l101.788" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.789"></a><span id="l101.789" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.790"></a><span id="l101.790" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.791"></a><span id="l101.791" class="difflineplus">+  );</span>
<a href="#l101.792"></a><span id="l101.792" class="difflineplus">+</span>
<a href="#l101.793"></a><span id="l101.793" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.794"></a><span id="l101.794" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.795"></a><span id="l101.795" class="difflineplus">+  bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.796"></a><span id="l101.796" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.797"></a><span id="l101.797" class="difflineplus">+</span>
<a href="#l101.798"></a><span id="l101.798" class="difflineplus">+  // We should get an error after we call addParams and try to bind again.</span>
<a href="#l101.799"></a><span id="l101.799" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.800"></a><span id="l101.800" class="difflineplus">+              function() bp.bindByName(&quot;int&quot;, INTEGER));</span>
<a href="#l101.801"></a><span id="l101.801" class="difflineplus">+</span>
<a href="#l101.802"></a><span id="l101.802" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.803"></a><span id="l101.803" class="difflineplus">+  run_next_test();</span>
<a href="#l101.804"></a><span id="l101.804" class="difflineplus">+}</span>
<a href="#l101.805"></a><span id="l101.805" class="difflineplus">+</span>
<a href="#l101.806"></a><span id="l101.806" class="difflineplus">+function test_bind_params_array_already_locked()</span>
<a href="#l101.807"></a><span id="l101.807" class="difflineplus">+{</span>
<a href="#l101.808"></a><span id="l101.808" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.809"></a><span id="l101.809" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.810"></a><span id="l101.810" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.811"></a><span id="l101.811" class="difflineplus">+  );</span>
<a href="#l101.812"></a><span id="l101.812" class="difflineplus">+</span>
<a href="#l101.813"></a><span id="l101.813" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.814"></a><span id="l101.814" class="difflineplus">+  let bp1 = array.newBindingParams();</span>
<a href="#l101.815"></a><span id="l101.815" class="difflineplus">+  bp1.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.816"></a><span id="l101.816" class="difflineplus">+  array.addParams(bp1);</span>
<a href="#l101.817"></a><span id="l101.817" class="difflineplus">+  let bp2 = array.newBindingParams();</span>
<a href="#l101.818"></a><span id="l101.818" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.819"></a><span id="l101.819" class="difflineplus">+  bp2.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.820"></a><span id="l101.820" class="difflineplus">+</span>
<a href="#l101.821"></a><span id="l101.821" class="difflineplus">+  // We should get an error after we have bound the array to the statement.</span>
<a href="#l101.822"></a><span id="l101.822" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.823"></a><span id="l101.823" class="difflineplus">+              function() array.addParams(bp2));</span>
<a href="#l101.824"></a><span id="l101.824" class="difflineplus">+</span>
<a href="#l101.825"></a><span id="l101.825" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.826"></a><span id="l101.826" class="difflineplus">+  run_next_test();</span>
<a href="#l101.827"></a><span id="l101.827" class="difflineplus">+}</span>
<a href="#l101.828"></a><span id="l101.828" class="difflineplus">+</span>
<a href="#l101.829"></a><span id="l101.829" class="difflineplus">+function test_no_binding_params_from_locked_array()</span>
<a href="#l101.830"></a><span id="l101.830" class="difflineplus">+{</span>
<a href="#l101.831"></a><span id="l101.831" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.832"></a><span id="l101.832" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.833"></a><span id="l101.833" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.834"></a><span id="l101.834" class="difflineplus">+  );</span>
<a href="#l101.835"></a><span id="l101.835" class="difflineplus">+</span>
<a href="#l101.836"></a><span id="l101.836" class="difflineplus">+  let array = stmt.newBindingParamsArray();</span>
<a href="#l101.837"></a><span id="l101.837" class="difflineplus">+  let bp = array.newBindingParams();</span>
<a href="#l101.838"></a><span id="l101.838" class="difflineplus">+  bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.839"></a><span id="l101.839" class="difflineplus">+  array.addParams(bp);</span>
<a href="#l101.840"></a><span id="l101.840" class="difflineplus">+  stmt.bindParameters(array);</span>
<a href="#l101.841"></a><span id="l101.841" class="difflineplus">+</span>
<a href="#l101.842"></a><span id="l101.842" class="difflineplus">+  // We should not be able to get a new BindingParams object after we have bound</span>
<a href="#l101.843"></a><span id="l101.843" class="difflineplus">+  // to the statement.</span>
<a href="#l101.844"></a><span id="l101.844" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.845"></a><span id="l101.845" class="difflineplus">+              function() array.newBindingParams());</span>
<a href="#l101.846"></a><span id="l101.846" class="difflineplus">+</span>
<a href="#l101.847"></a><span id="l101.847" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.848"></a><span id="l101.848" class="difflineplus">+  run_next_test();</span>
<a href="#l101.849"></a><span id="l101.849" class="difflineplus">+}</span>
<a href="#l101.850"></a><span id="l101.850" class="difflineplus">+</span>
<a href="#l101.851"></a><span id="l101.851" class="difflineplus">+function test_not_right_owning_array()</span>
<a href="#l101.852"></a><span id="l101.852" class="difflineplus">+{</span>
<a href="#l101.853"></a><span id="l101.853" class="difflineplus">+  let stmt = makeTestStatement(</span>
<a href="#l101.854"></a><span id="l101.854" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.855"></a><span id="l101.855" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.856"></a><span id="l101.856" class="difflineplus">+  );</span>
<a href="#l101.857"></a><span id="l101.857" class="difflineplus">+</span>
<a href="#l101.858"></a><span id="l101.858" class="difflineplus">+  let array1 = stmt.newBindingParamsArray();</span>
<a href="#l101.859"></a><span id="l101.859" class="difflineplus">+  let array2 = stmt.newBindingParamsArray();</span>
<a href="#l101.860"></a><span id="l101.860" class="difflineplus">+  let bp = array1.newBindingParams();</span>
<a href="#l101.861"></a><span id="l101.861" class="difflineplus">+  bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.862"></a><span id="l101.862" class="difflineplus">+</span>
<a href="#l101.863"></a><span id="l101.863" class="difflineplus">+  // We should not be able to add bp to array2 since it was created from array1.</span>
<a href="#l101.864"></a><span id="l101.864" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.865"></a><span id="l101.865" class="difflineplus">+              function() array2.addParams(bp));</span>
<a href="#l101.866"></a><span id="l101.866" class="difflineplus">+</span>
<a href="#l101.867"></a><span id="l101.867" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.868"></a><span id="l101.868" class="difflineplus">+  run_next_test();</span>
<a href="#l101.869"></a><span id="l101.869" class="difflineplus">+}</span>
<a href="#l101.870"></a><span id="l101.870" class="difflineplus">+</span>
<a href="#l101.871"></a><span id="l101.871" class="difflineplus">+function test_not_right_owning_statement()</span>
<a href="#l101.872"></a><span id="l101.872" class="difflineplus">+{</span>
<a href="#l101.873"></a><span id="l101.873" class="difflineplus">+  let stmt1 = makeTestStatement(</span>
<a href="#l101.874"></a><span id="l101.874" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.875"></a><span id="l101.875" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.876"></a><span id="l101.876" class="difflineplus">+  );</span>
<a href="#l101.877"></a><span id="l101.877" class="difflineplus">+  let stmt2 = makeTestStatement(</span>
<a href="#l101.878"></a><span id="l101.878" class="difflineplus">+    &quot;INSERT INTO test (id) &quot; +</span>
<a href="#l101.879"></a><span id="l101.879" class="difflineplus">+    &quot;VALUES (:int)&quot;</span>
<a href="#l101.880"></a><span id="l101.880" class="difflineplus">+  );</span>
<a href="#l101.881"></a><span id="l101.881" class="difflineplus">+</span>
<a href="#l101.882"></a><span id="l101.882" class="difflineplus">+  let array1 = stmt1.newBindingParamsArray();</span>
<a href="#l101.883"></a><span id="l101.883" class="difflineplus">+  let array2 = stmt2.newBindingParamsArray();</span>
<a href="#l101.884"></a><span id="l101.884" class="difflineplus">+  let bp = array1.newBindingParams();</span>
<a href="#l101.885"></a><span id="l101.885" class="difflineplus">+  bp.bindByName(&quot;int&quot;, INTEGER);</span>
<a href="#l101.886"></a><span id="l101.886" class="difflineplus">+  array1.addParams(bp);</span>
<a href="#l101.887"></a><span id="l101.887" class="difflineplus">+</span>
<a href="#l101.888"></a><span id="l101.888" class="difflineplus">+  // We should not be able to bind array1 since it was created from stmt1.</span>
<a href="#l101.889"></a><span id="l101.889" class="difflineplus">+  expectError(Cr.NS_ERROR_UNEXPECTED,</span>
<a href="#l101.890"></a><span id="l101.890" class="difflineplus">+              function() stmt2.bindParameters(array1));</span>
<a href="#l101.891"></a><span id="l101.891" class="difflineplus">+</span>
<a href="#l101.892"></a><span id="l101.892" class="difflineplus">+  stmt1.finalize();</span>
<a href="#l101.893"></a><span id="l101.893" class="difflineplus">+  stmt2.finalize();</span>
<a href="#l101.894"></a><span id="l101.894" class="difflineplus">+  run_next_test();</span>
<a href="#l101.895"></a><span id="l101.895" class="difflineplus">+}</span>
<a href="#l101.896"></a><span id="l101.896" class="difflineplus">+</span>
<a href="#l101.897"></a><span id="l101.897" class="difflineplus">+function test_multiple_results()</span>
<a href="#l101.898"></a><span id="l101.898" class="difflineplus">+{</span>
<a href="#l101.899"></a><span id="l101.899" class="difflineplus">+  let expectedResults = getTableRowCount(&quot;test&quot;);</span>
<a href="#l101.900"></a><span id="l101.900" class="difflineplus">+  // Sanity check - we should have more than one result, but let's be sure.</span>
<a href="#l101.901"></a><span id="l101.901" class="difflineplus">+  do_check_true(expectedResults &gt; 1);</span>
<a href="#l101.902"></a><span id="l101.902" class="difflineplus">+</span>
<a href="#l101.903"></a><span id="l101.903" class="difflineplus">+  // Now check that we get back two rows of data from our async query.</span>
<a href="#l101.904"></a><span id="l101.904" class="difflineplus">+  let stmt = makeTestStatement(&quot;SELECT * FROM test&quot;);</span>
<a href="#l101.905"></a><span id="l101.905" class="difflineplus">+  execAsync(stmt, {}, expectedResults);</span>
<a href="#l101.906"></a><span id="l101.906" class="difflineplus">+</span>
<a href="#l101.907"></a><span id="l101.907" class="difflineplus">+  stmt.finalize();</span>
<a href="#l101.908"></a><span id="l101.908" class="difflineplus">+  run_next_test();</span>
<a href="#l101.909"></a><span id="l101.909" class="difflineplus">+}</span>
<a href="#l101.910"></a><span id="l101.910" class="difflineplus">+</span>
<a href="#l101.911"></a><span id="l101.911" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l101.912"></a><span id="l101.912" class="difflineplus">+//// Test Runner</span>
<a href="#l101.913"></a><span id="l101.913" class="difflineplus">+</span>
<a href="#l101.914"></a><span id="l101.914" class="difflineplus">+</span>
<a href="#l101.915"></a><span id="l101.915" class="difflineplus">+const TEST_PASS_SYNC = 0;</span>
<a href="#l101.916"></a><span id="l101.916" class="difflineplus">+const TEST_PASS_ASYNC = 1;</span>
<a href="#l101.917"></a><span id="l101.917" class="difflineplus">+/**</span>
<a href="#l101.918"></a><span id="l101.918" class="difflineplus">+ * We run 2 passes against the test.  One where makeTestStatement generates</span>
<a href="#l101.919"></a><span id="l101.919" class="difflineplus">+ * synchronous (mozIStorageStatement) statements and one where it generates</span>
<a href="#l101.920"></a><span id="l101.920" class="difflineplus">+ * asynchronous (mozIStorageAsyncStatement) statements.</span>
<a href="#l101.921"></a><span id="l101.921" class="difflineplus">+ *</span>
<a href="#l101.922"></a><span id="l101.922" class="difflineplus">+ * Because of differences in the ability to know the number of parameters before</span>
<a href="#l101.923"></a><span id="l101.923" class="difflineplus">+ * dispatching, some tests are sync/async specific.  These functions are marked</span>
<a href="#l101.924"></a><span id="l101.924" class="difflineplus">+ * with 'syncOnly' or 'asyncOnly' attributes and run_next_test knows what to do.</span>
<a href="#l101.925"></a><span id="l101.925" class="difflineplus">+ */</span>
<a href="#l101.926"></a><span id="l101.926" class="difflineplus">+let testPass = TEST_PASS_SYNC;</span>
<a href="#l101.927"></a><span id="l101.927" class="difflineplus">+</span>
<a href="#l101.928"></a><span id="l101.928" class="difflineplus">+/**</span>
<a href="#l101.929"></a><span id="l101.929" class="difflineplus">+ * Create a statement of the type under test per testPass.</span>
<a href="#l101.930"></a><span id="l101.930" class="difflineplus">+ *</span>
<a href="#l101.931"></a><span id="l101.931" class="difflineplus">+ * @param aSQL</span>
<a href="#l101.932"></a><span id="l101.932" class="difflineplus">+ *        The SQL string from which to build a statement.</span>
<a href="#l101.933"></a><span id="l101.933" class="difflineplus">+ * @return a statement of the type under test per testPass.</span>
<a href="#l101.934"></a><span id="l101.934" class="difflineplus">+ */</span>
<a href="#l101.935"></a><span id="l101.935" class="difflineplus">+function makeTestStatement(aSQL) {</span>
<a href="#l101.936"></a><span id="l101.936" class="difflineplus">+  if (testPass == TEST_PASS_SYNC)</span>
<a href="#l101.937"></a><span id="l101.937" class="difflineplus">+    return getOpenedDatabase().createStatement(aSQL);</span>
<a href="#l101.938"></a><span id="l101.938" class="difflineplus">+  else</span>
<a href="#l101.939"></a><span id="l101.939" class="difflineplus">+    return getOpenedDatabase().createAsyncStatement(aSQL);</span>
<a href="#l101.940"></a><span id="l101.940" class="difflineplus">+}</span>
<a href="#l101.941"></a><span id="l101.941" class="difflineplus">+</span>
<a href="#l101.942"></a><span id="l101.942" class="difflineplus">+var tests =</span>
<a href="#l101.943"></a><span id="l101.943" class="difflineplus">+[</span>
<a href="#l101.944"></a><span id="l101.944" class="difflineplus">+  test_illegal_sql_async_deferred,</span>
<a href="#l101.945"></a><span id="l101.945" class="difflineplus">+  test_create_table,</span>
<a href="#l101.946"></a><span id="l101.946" class="difflineplus">+  test_add_data,</span>
<a href="#l101.947"></a><span id="l101.947" class="difflineplus">+  test_get_data,</span>
<a href="#l101.948"></a><span id="l101.948" class="difflineplus">+  test_tuple_out_of_bounds,</span>
<a href="#l101.949"></a><span id="l101.949" class="difflineplus">+  test_no_listener_works_on_success,</span>
<a href="#l101.950"></a><span id="l101.950" class="difflineplus">+  test_no_listener_works_on_results,</span>
<a href="#l101.951"></a><span id="l101.951" class="difflineplus">+  test_no_listener_works_on_error,</span>
<a href="#l101.952"></a><span id="l101.952" class="difflineplus">+  test_partial_listener_works,</span>
<a href="#l101.953"></a><span id="l101.953" class="difflineplus">+  test_immediate_cancellation,</span>
<a href="#l101.954"></a><span id="l101.954" class="difflineplus">+  test_double_cancellation,</span>
<a href="#l101.955"></a><span id="l101.955" class="difflineplus">+  test_cancellation_after_execution,</span>
<a href="#l101.956"></a><span id="l101.956" class="difflineplus">+  test_double_execute,</span>
<a href="#l101.957"></a><span id="l101.957" class="difflineplus">+  test_finalized_statement_does_not_crash,</span>
<a href="#l101.958"></a><span id="l101.958" class="difflineplus">+  test_bind_direct_binding_params_by_index,</span>
<a href="#l101.959"></a><span id="l101.959" class="difflineplus">+  test_bind_direct_binding_params_by_name,</span>
<a href="#l101.960"></a><span id="l101.960" class="difflineplus">+  test_bind_js_params_helper_by_index,</span>
<a href="#l101.961"></a><span id="l101.961" class="difflineplus">+  test_bind_js_params_helper_by_name,</span>
<a href="#l101.962"></a><span id="l101.962" class="difflineplus">+  test_bind_multiple_rows_by_index,</span>
<a href="#l101.963"></a><span id="l101.963" class="difflineplus">+  test_bind_multiple_rows_by_name,</span>
<a href="#l101.964"></a><span id="l101.964" class="difflineplus">+  test_bind_out_of_bounds_sync_immediate,</span>
<a href="#l101.965"></a><span id="l101.965" class="difflineplus">+  test_bind_out_of_bounds_async_deferred,</span>
<a href="#l101.966"></a><span id="l101.966" class="difflineplus">+  test_bind_no_such_name_sync_immediate,</span>
<a href="#l101.967"></a><span id="l101.967" class="difflineplus">+  test_bind_no_such_name_async_deferred,</span>
<a href="#l101.968"></a><span id="l101.968" class="difflineplus">+  test_bind_bogus_type_by_index,</span>
<a href="#l101.969"></a><span id="l101.969" class="difflineplus">+  test_bind_bogus_type_by_name,</span>
<a href="#l101.970"></a><span id="l101.970" class="difflineplus">+  test_bind_params_already_locked,</span>
<a href="#l101.971"></a><span id="l101.971" class="difflineplus">+  test_bind_params_array_already_locked,</span>
<a href="#l101.972"></a><span id="l101.972" class="difflineplus">+  test_no_binding_params_from_locked_array,</span>
<a href="#l101.973"></a><span id="l101.973" class="difflineplus">+  test_not_right_owning_array,</span>
<a href="#l101.974"></a><span id="l101.974" class="difflineplus">+  test_not_right_owning_statement,</span>
<a href="#l101.975"></a><span id="l101.975" class="difflineplus">+  test_multiple_results,</span>
<a href="#l101.976"></a><span id="l101.976" class="difflineplus">+];</span>
<a href="#l101.977"></a><span id="l101.977" class="difflineplus">+let index = 0;</span>
<a href="#l101.978"></a><span id="l101.978" class="difflineplus">+</span>
<a href="#l101.979"></a><span id="l101.979" class="difflineplus">+const STARTING_UNIQUE_ID = 2;</span>
<a href="#l101.980"></a><span id="l101.980" class="difflineplus">+let nextUniqueId = STARTING_UNIQUE_ID;</span>
<a href="#l101.981"></a><span id="l101.981" class="difflineplus">+</span>
<a href="#l101.982"></a><span id="l101.982" class="difflineplus">+function run_next_test()</span>
<a href="#l101.983"></a><span id="l101.983" class="difflineplus">+{</span>
<a href="#l101.984"></a><span id="l101.984" class="difflineplus">+  function _run_next_test() {</span>
<a href="#l101.985"></a><span id="l101.985" class="difflineplus">+    // use a loop so we can skip tests...</span>
<a href="#l101.986"></a><span id="l101.986" class="difflineplus">+    while (index &lt; tests.length) {</span>
<a href="#l101.987"></a><span id="l101.987" class="difflineplus">+      let test = tests[index++];</span>
<a href="#l101.988"></a><span id="l101.988" class="difflineplus">+      // skip tests not appropriate to the current test pass</span>
<a href="#l101.989"></a><span id="l101.989" class="difflineplus">+      if ((testPass == TEST_PASS_SYNC &amp;&amp; (&quot;asyncOnly&quot; in test)) ||</span>
<a href="#l101.990"></a><span id="l101.990" class="difflineplus">+          (testPass == TEST_PASS_ASYNC &amp;&amp; (&quot;syncOnly&quot; in test)))</span>
<a href="#l101.991"></a><span id="l101.991" class="difflineplus">+        continue;</span>
<a href="#l101.992"></a><span id="l101.992" class="difflineplus">+</span>
<a href="#l101.993"></a><span id="l101.993" class="difflineplus">+      // Asynchronous tests means that exceptions don't kill the test.</span>
<a href="#l101.994"></a><span id="l101.994" class="difflineplus">+      try {</span>
<a href="#l101.995"></a><span id="l101.995" class="difflineplus">+        print(&quot;****** Running the next test: &quot; + test.name);</span>
<a href="#l101.996"></a><span id="l101.996" class="difflineplus">+        test();</span>
<a href="#l101.997"></a><span id="l101.997" class="difflineplus">+        return;</span>
<a href="#l101.998"></a><span id="l101.998" class="difflineplus">+      }</span>
<a href="#l101.999"></a><span id="l101.999" class="difflineplus">+      catch (e) {</span>
<a href="#l101.1000"></a><span id="l101.1000" class="difflineplus">+        do_throw(e);</span>
<a href="#l101.1001"></a><span id="l101.1001" class="difflineplus">+      }</span>
<a href="#l101.1002"></a><span id="l101.1002" class="difflineplus">+    }</span>
<a href="#l101.1003"></a><span id="l101.1003" class="difflineplus">+</span>
<a href="#l101.1004"></a><span id="l101.1004" class="difflineplus">+    // if we only completed the first pass, move to the next pass</span>
<a href="#l101.1005"></a><span id="l101.1005" class="difflineplus">+    if (testPass == TEST_PASS_SYNC) {</span>
<a href="#l101.1006"></a><span id="l101.1006" class="difflineplus">+      print(&quot;********* Beginning mozIStorageAsyncStatement pass.&quot;);</span>
<a href="#l101.1007"></a><span id="l101.1007" class="difflineplus">+      testPass++;</span>
<a href="#l101.1008"></a><span id="l101.1008" class="difflineplus">+      index = 0;</span>
<a href="#l101.1009"></a><span id="l101.1009" class="difflineplus">+      // a new pass demands a new database</span>
<a href="#l101.1010"></a><span id="l101.1010" class="difflineplus">+      asyncCleanup();</span>
<a href="#l101.1011"></a><span id="l101.1011" class="difflineplus">+      nextUniqueId = STARTING_UNIQUE_ID;</span>
<a href="#l101.1012"></a><span id="l101.1012" class="difflineplus">+      _run_next_test();</span>
<a href="#l101.1013"></a><span id="l101.1013" class="difflineplus">+      return;</span>
<a href="#l101.1014"></a><span id="l101.1014" class="difflineplus">+    }</span>
<a href="#l101.1015"></a><span id="l101.1015" class="difflineplus">+</span>
<a href="#l101.1016"></a><span id="l101.1016" class="difflineplus">+    // we did some async stuff; we need to clean up.</span>
<a href="#l101.1017"></a><span id="l101.1017" class="difflineplus">+    asyncCleanup();</span>
<a href="#l101.1018"></a><span id="l101.1018" class="difflineplus">+    do_test_finished();</span>
<a href="#l101.1019"></a><span id="l101.1019" class="difflineplus">+  }</span>
<a href="#l101.1020"></a><span id="l101.1020" class="difflineplus">+</span>
<a href="#l101.1021"></a><span id="l101.1021" class="difflineplus">+  // Don't actually schedule another test if we're quitting.</span>
<a href="#l101.1022"></a><span id="l101.1022" class="difflineplus">+  if (!_quit) {</span>
<a href="#l101.1023"></a><span id="l101.1023" class="difflineplus">+    // For saner stacks, we execute this code RSN.</span>
<a href="#l101.1024"></a><span id="l101.1024" class="difflineplus">+    do_execute_soon(_run_next_test);</span>
<a href="#l101.1025"></a><span id="l101.1025" class="difflineplus">+  }</span>
<a href="#l101.1026"></a><span id="l101.1026" class="difflineplus">+}</span>
<a href="#l101.1027"></a><span id="l101.1027" class="difflineplus">+</span>
<a href="#l101.1028"></a><span id="l101.1028" class="difflineplus">+function run_test()</span>
<a href="#l101.1029"></a><span id="l101.1029" class="difflineplus">+{</span>
<a href="#l101.1030"></a><span id="l101.1030" class="difflineplus">+  cleanup();</span>
<a href="#l101.1031"></a><span id="l101.1031" class="difflineplus">+</span>
<a href="#l101.1032"></a><span id="l101.1032" class="difflineplus">+  do_test_pending();</span>
<a href="#l101.1033"></a><span id="l101.1033" class="difflineplus">+  run_next_test();</span>
<a href="#l101.1034"></a><span id="l101.1034" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1">new file mode 100644</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineminus">--- /dev/null</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineplus">+++ b/storage-backport/test/unit/test_statement_wrapper_automatically.js</span>
<a href="#l102.4"></a><span id="l102.4" class="difflineat">@@ -0,0 +1,204 @@</span>
<a href="#l102.5"></a><span id="l102.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l102.6"></a><span id="l102.6" class="difflineplus">+   vim:set ts=2 sw=2 sts=2 et:</span>
<a href="#l102.7"></a><span id="l102.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l102.8"></a><span id="l102.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l102.9"></a><span id="l102.9" class="difflineplus">+ *</span>
<a href="#l102.10"></a><span id="l102.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l102.11"></a><span id="l102.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l102.14"></a><span id="l102.14" class="difflineplus">+ *</span>
<a href="#l102.15"></a><span id="l102.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l102.16"></a><span id="l102.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l102.17"></a><span id="l102.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l102.18"></a><span id="l102.18" class="difflineplus">+ * License.</span>
<a href="#l102.19"></a><span id="l102.19" class="difflineplus">+ *</span>
<a href="#l102.20"></a><span id="l102.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l102.21"></a><span id="l102.21" class="difflineplus">+ *</span>
<a href="#l102.22"></a><span id="l102.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l102.23"></a><span id="l102.23" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l102.24"></a><span id="l102.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l102.25"></a><span id="l102.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l102.26"></a><span id="l102.26" class="difflineplus">+ *</span>
<a href="#l102.27"></a><span id="l102.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l102.28"></a><span id="l102.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l102.29"></a><span id="l102.29" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l102.30"></a><span id="l102.30" class="difflineplus">+ *</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l102.33"></a><span id="l102.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l102.34"></a><span id="l102.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l102.35"></a><span id="l102.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l102.36"></a><span id="l102.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l102.37"></a><span id="l102.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l102.38"></a><span id="l102.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l102.39"></a><span id="l102.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l102.40"></a><span id="l102.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l102.42"></a><span id="l102.42" class="difflineplus">+ *</span>
<a href="#l102.43"></a><span id="l102.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l102.44"></a><span id="l102.44" class="difflineplus">+</span>
<a href="#l102.45"></a><span id="l102.45" class="difflineplus">+// This file tests the functions of mozIStorageStatementWrapper</span>
<a href="#l102.46"></a><span id="l102.46" class="difflineplus">+</span>
<a href="#l102.47"></a><span id="l102.47" class="difflineplus">+function setup()</span>
<a href="#l102.48"></a><span id="l102.48" class="difflineplus">+{</span>
<a href="#l102.49"></a><span id="l102.49" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, val NONE,&quot; +</span>
<a href="#l102.50"></a><span id="l102.50" class="difflineplus">+                                          &quot;alt_val NONE&quot;);</span>
<a href="#l102.51"></a><span id="l102.51" class="difflineplus">+}</span>
<a href="#l102.52"></a><span id="l102.52" class="difflineplus">+</span>
<a href="#l102.53"></a><span id="l102.53" class="difflineplus">+/**</span>
<a href="#l102.54"></a><span id="l102.54" class="difflineplus">+ * A convenience wrapper for do_check_eq.  Calls do_check_eq on aActualVal</span>
<a href="#l102.55"></a><span id="l102.55" class="difflineplus">+ * and aReturnedVal, with one caveat.</span>
<a href="#l102.56"></a><span id="l102.56" class="difflineplus">+ *</span>
<a href="#l102.57"></a><span id="l102.57" class="difflineplus">+ * Date objects are converted before parameter binding to PRTime's (microsecs</span>
<a href="#l102.58"></a><span id="l102.58" class="difflineplus">+ * since epoch).  They are not reconverted when retrieved from the database.</span>
<a href="#l102.59"></a><span id="l102.59" class="difflineplus">+ * This function abstracts away this reconversion so that you can pass in,</span>
<a href="#l102.60"></a><span id="l102.60" class="difflineplus">+ * for example:</span>
<a href="#l102.61"></a><span id="l102.61" class="difflineplus">+ *</span>
<a href="#l102.62"></a><span id="l102.62" class="difflineplus">+ *   checkVal(new Date(), aReturnedVal)                    // this</span>
<a href="#l102.63"></a><span id="l102.63" class="difflineplus">+ *   checkVal(new Date().valueOf() * 1000.0, aReturnedVal) // instead of this</span>
<a href="#l102.64"></a><span id="l102.64" class="difflineplus">+ *</span>
<a href="#l102.65"></a><span id="l102.65" class="difflineplus">+ * Should any other types require conversion in the future, their conversions</span>
<a href="#l102.66"></a><span id="l102.66" class="difflineplus">+ * may also be abstracted away here.</span>
<a href="#l102.67"></a><span id="l102.67" class="difflineplus">+ *</span>
<a href="#l102.68"></a><span id="l102.68" class="difflineplus">+ * @param aActualVal</span>
<a href="#l102.69"></a><span id="l102.69" class="difflineplus">+ *        the value inserted into the database</span>
<a href="#l102.70"></a><span id="l102.70" class="difflineplus">+ * @param aReturnedVal</span>
<a href="#l102.71"></a><span id="l102.71" class="difflineplus">+ *        the value retrieved from the database</span>
<a href="#l102.72"></a><span id="l102.72" class="difflineplus">+ */</span>
<a href="#l102.73"></a><span id="l102.73" class="difflineplus">+function checkVal(aActualVal, aReturnedVal)</span>
<a href="#l102.74"></a><span id="l102.74" class="difflineplus">+{</span>
<a href="#l102.75"></a><span id="l102.75" class="difflineplus">+  if (aActualVal instanceof Date) aActualVal = aActualVal.valueOf() * 1000.0;</span>
<a href="#l102.76"></a><span id="l102.76" class="difflineplus">+  do_check_eq(aActualVal, aReturnedVal);</span>
<a href="#l102.77"></a><span id="l102.77" class="difflineplus">+}</span>
<a href="#l102.78"></a><span id="l102.78" class="difflineplus">+</span>
<a href="#l102.79"></a><span id="l102.79" class="difflineplus">+/**</span>
<a href="#l102.80"></a><span id="l102.80" class="difflineplus">+ * Removes all rows from our test table.</span>
<a href="#l102.81"></a><span id="l102.81" class="difflineplus">+ */</span>
<a href="#l102.82"></a><span id="l102.82" class="difflineplus">+function clearTable()</span>
<a href="#l102.83"></a><span id="l102.83" class="difflineplus">+{</span>
<a href="#l102.84"></a><span id="l102.84" class="difflineplus">+  var stmt = createStatement(&quot;DELETE FROM test&quot;);</span>
<a href="#l102.85"></a><span id="l102.85" class="difflineplus">+  stmt.execute();</span>
<a href="#l102.86"></a><span id="l102.86" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.87"></a><span id="l102.87" class="difflineplus">+  ensureNumRows(0);</span>
<a href="#l102.88"></a><span id="l102.88" class="difflineplus">+}</span>
<a href="#l102.89"></a><span id="l102.89" class="difflineplus">+</span>
<a href="#l102.90"></a><span id="l102.90" class="difflineplus">+/**</span>
<a href="#l102.91"></a><span id="l102.91" class="difflineplus">+ * Ensures that the number of rows in our test table is equal to aNumRows.</span>
<a href="#l102.92"></a><span id="l102.92" class="difflineplus">+ * Calls do_check_eq on aNumRows and the value retrieved by SELECT'ing COUNT(*).</span>
<a href="#l102.93"></a><span id="l102.93" class="difflineplus">+ *</span>
<a href="#l102.94"></a><span id="l102.94" class="difflineplus">+ * @param aNumRows</span>
<a href="#l102.95"></a><span id="l102.95" class="difflineplus">+ *        the number of rows our test table should contain</span>
<a href="#l102.96"></a><span id="l102.96" class="difflineplus">+ */</span>
<a href="#l102.97"></a><span id="l102.97" class="difflineplus">+function ensureNumRows(aNumRows)</span>
<a href="#l102.98"></a><span id="l102.98" class="difflineplus">+{</span>
<a href="#l102.99"></a><span id="l102.99" class="difflineplus">+  var stmt = createStatement(&quot;SELECT COUNT(*) AS number FROM test&quot;);</span>
<a href="#l102.100"></a><span id="l102.100" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l102.101"></a><span id="l102.101" class="difflineplus">+  do_check_eq(aNumRows, stmt.row.number);</span>
<a href="#l102.102"></a><span id="l102.102" class="difflineplus">+  stmt.reset();</span>
<a href="#l102.103"></a><span id="l102.103" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.104"></a><span id="l102.104" class="difflineplus">+}</span>
<a href="#l102.105"></a><span id="l102.105" class="difflineplus">+</span>
<a href="#l102.106"></a><span id="l102.106" class="difflineplus">+/**</span>
<a href="#l102.107"></a><span id="l102.107" class="difflineplus">+ * Inserts aVal into our test table and checks that insertion was successful by</span>
<a href="#l102.108"></a><span id="l102.108" class="difflineplus">+ * retrieving the newly inserted value from the database and comparing it</span>
<a href="#l102.109"></a><span id="l102.109" class="difflineplus">+ * against aVal.  aVal is bound to a single parameter.</span>
<a href="#l102.110"></a><span id="l102.110" class="difflineplus">+ *</span>
<a href="#l102.111"></a><span id="l102.111" class="difflineplus">+ * @param aVal</span>
<a href="#l102.112"></a><span id="l102.112" class="difflineplus">+ *        value to insert into our test table and check</span>
<a href="#l102.113"></a><span id="l102.113" class="difflineplus">+ */</span>
<a href="#l102.114"></a><span id="l102.114" class="difflineplus">+function insertAndCheckSingleParam(aVal)</span>
<a href="#l102.115"></a><span id="l102.115" class="difflineplus">+{</span>
<a href="#l102.116"></a><span id="l102.116" class="difflineplus">+  clearTable();</span>
<a href="#l102.117"></a><span id="l102.117" class="difflineplus">+</span>
<a href="#l102.118"></a><span id="l102.118" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (val) VALUES (:val)&quot;);</span>
<a href="#l102.119"></a><span id="l102.119" class="difflineplus">+  stmt.params.val = aVal;</span>
<a href="#l102.120"></a><span id="l102.120" class="difflineplus">+  stmt.execute();</span>
<a href="#l102.121"></a><span id="l102.121" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.122"></a><span id="l102.122" class="difflineplus">+</span>
<a href="#l102.123"></a><span id="l102.123" class="difflineplus">+  ensureNumRows(1);</span>
<a href="#l102.124"></a><span id="l102.124" class="difflineplus">+</span>
<a href="#l102.125"></a><span id="l102.125" class="difflineplus">+  stmt = createStatement(&quot;SELECT val FROM test WHERE id = 1&quot;);</span>
<a href="#l102.126"></a><span id="l102.126" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l102.127"></a><span id="l102.127" class="difflineplus">+  checkVal(aVal, stmt.row.val);</span>
<a href="#l102.128"></a><span id="l102.128" class="difflineplus">+  stmt.reset();</span>
<a href="#l102.129"></a><span id="l102.129" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.130"></a><span id="l102.130" class="difflineplus">+}</span>
<a href="#l102.131"></a><span id="l102.131" class="difflineplus">+</span>
<a href="#l102.132"></a><span id="l102.132" class="difflineplus">+/**</span>
<a href="#l102.133"></a><span id="l102.133" class="difflineplus">+ * Inserts aVal into our test table and checks that insertion was successful by</span>
<a href="#l102.134"></a><span id="l102.134" class="difflineplus">+ * retrieving the newly inserted value from the database and comparing it</span>
<a href="#l102.135"></a><span id="l102.135" class="difflineplus">+ * against aVal.  aVal is bound to two separate parameters, both of which are</span>
<a href="#l102.136"></a><span id="l102.136" class="difflineplus">+ * checked against aVal.</span>
<a href="#l102.137"></a><span id="l102.137" class="difflineplus">+ *</span>
<a href="#l102.138"></a><span id="l102.138" class="difflineplus">+ * @param aVal</span>
<a href="#l102.139"></a><span id="l102.139" class="difflineplus">+ *        value to insert into our test table and check</span>
<a href="#l102.140"></a><span id="l102.140" class="difflineplus">+ */</span>
<a href="#l102.141"></a><span id="l102.141" class="difflineplus">+function insertAndCheckMultipleParams(aVal)</span>
<a href="#l102.142"></a><span id="l102.142" class="difflineplus">+{</span>
<a href="#l102.143"></a><span id="l102.143" class="difflineplus">+  clearTable();</span>
<a href="#l102.144"></a><span id="l102.144" class="difflineplus">+</span>
<a href="#l102.145"></a><span id="l102.145" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (val, alt_val) &quot; +</span>
<a href="#l102.146"></a><span id="l102.146" class="difflineplus">+                             &quot;VALUES (:val, :val)&quot;);</span>
<a href="#l102.147"></a><span id="l102.147" class="difflineplus">+  stmt.params.val = aVal;</span>
<a href="#l102.148"></a><span id="l102.148" class="difflineplus">+  stmt.execute();</span>
<a href="#l102.149"></a><span id="l102.149" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.150"></a><span id="l102.150" class="difflineplus">+</span>
<a href="#l102.151"></a><span id="l102.151" class="difflineplus">+  ensureNumRows(1);</span>
<a href="#l102.152"></a><span id="l102.152" class="difflineplus">+</span>
<a href="#l102.153"></a><span id="l102.153" class="difflineplus">+  stmt = createStatement(&quot;SELECT val, alt_val FROM test WHERE id = 1&quot;);</span>
<a href="#l102.154"></a><span id="l102.154" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l102.155"></a><span id="l102.155" class="difflineplus">+  checkVal(aVal, stmt.row.val);</span>
<a href="#l102.156"></a><span id="l102.156" class="difflineplus">+  checkVal(aVal, stmt.row.alt_val);</span>
<a href="#l102.157"></a><span id="l102.157" class="difflineplus">+  stmt.reset();</span>
<a href="#l102.158"></a><span id="l102.158" class="difflineplus">+  stmt.finalize();</span>
<a href="#l102.159"></a><span id="l102.159" class="difflineplus">+}</span>
<a href="#l102.160"></a><span id="l102.160" class="difflineplus">+</span>
<a href="#l102.161"></a><span id="l102.161" class="difflineplus">+/**</span>
<a href="#l102.162"></a><span id="l102.162" class="difflineplus">+ * A convenience function that prints out a description of aVal using</span>
<a href="#l102.163"></a><span id="l102.163" class="difflineplus">+ * aVal.toString and aVal.toSource.  Output is useful when the test fails.</span>
<a href="#l102.164"></a><span id="l102.164" class="difflineplus">+ *</span>
<a href="#l102.165"></a><span id="l102.165" class="difflineplus">+ * @param aVal</span>
<a href="#l102.166"></a><span id="l102.166" class="difflineplus">+ *        a value inserted or to be inserted into our test table</span>
<a href="#l102.167"></a><span id="l102.167" class="difflineplus">+ */</span>
<a href="#l102.168"></a><span id="l102.168" class="difflineplus">+function printValDesc(aVal)</span>
<a href="#l102.169"></a><span id="l102.169" class="difflineplus">+{</span>
<a href="#l102.170"></a><span id="l102.170" class="difflineplus">+  try</span>
<a href="#l102.171"></a><span id="l102.171" class="difflineplus">+  {</span>
<a href="#l102.172"></a><span id="l102.172" class="difflineplus">+    var toSource = aVal.toSource();</span>
<a href="#l102.173"></a><span id="l102.173" class="difflineplus">+  }</span>
<a href="#l102.174"></a><span id="l102.174" class="difflineplus">+  catch (exc)</span>
<a href="#l102.175"></a><span id="l102.175" class="difflineplus">+  {</span>
<a href="#l102.176"></a><span id="l102.176" class="difflineplus">+    toSource = &quot;&quot;;</span>
<a href="#l102.177"></a><span id="l102.177" class="difflineplus">+  }</span>
<a href="#l102.178"></a><span id="l102.178" class="difflineplus">+  print(&quot;Testing value: toString=&quot; + aVal +</span>
<a href="#l102.179"></a><span id="l102.179" class="difflineplus">+        (toSource ? &quot; toSource=&quot; + toSource : &quot;&quot;));</span>
<a href="#l102.180"></a><span id="l102.180" class="difflineplus">+}</span>
<a href="#l102.181"></a><span id="l102.181" class="difflineplus">+</span>
<a href="#l102.182"></a><span id="l102.182" class="difflineplus">+function run_test()</span>
<a href="#l102.183"></a><span id="l102.183" class="difflineplus">+{</span>
<a href="#l102.184"></a><span id="l102.184" class="difflineplus">+  setup();</span>
<a href="#l102.185"></a><span id="l102.185" class="difflineplus">+</span>
<a href="#l102.186"></a><span id="l102.186" class="difflineplus">+  // function JSValStorageStatementBinder in</span>
<a href="#l102.187"></a><span id="l102.187" class="difflineplus">+  // storage/src/mozStorageStatementParams.cpp tells us that the following types</span>
<a href="#l102.188"></a><span id="l102.188" class="difflineplus">+  // and only the following types are valid as statement parameters:</span>
<a href="#l102.189"></a><span id="l102.189" class="difflineplus">+  var vals = [</span>
<a href="#l102.190"></a><span id="l102.190" class="difflineplus">+    1337,       // int</span>
<a href="#l102.191"></a><span id="l102.191" class="difflineplus">+    3.1337,     // double</span>
<a href="#l102.192"></a><span id="l102.192" class="difflineplus">+    &quot;foo&quot;,      // string</span>
<a href="#l102.193"></a><span id="l102.193" class="difflineplus">+    true,       // boolean</span>
<a href="#l102.194"></a><span id="l102.194" class="difflineplus">+    null,       // null</span>
<a href="#l102.195"></a><span id="l102.195" class="difflineplus">+    new Date(), // Date object</span>
<a href="#l102.196"></a><span id="l102.196" class="difflineplus">+  ];</span>
<a href="#l102.197"></a><span id="l102.197" class="difflineplus">+</span>
<a href="#l102.198"></a><span id="l102.198" class="difflineplus">+  vals.forEach(function (val)</span>
<a href="#l102.199"></a><span id="l102.199" class="difflineplus">+  {</span>
<a href="#l102.200"></a><span id="l102.200" class="difflineplus">+    printValDesc(val);</span>
<a href="#l102.201"></a><span id="l102.201" class="difflineplus">+    print(&quot;Single parameter&quot;);</span>
<a href="#l102.202"></a><span id="l102.202" class="difflineplus">+    insertAndCheckSingleParam(val);</span>
<a href="#l102.203"></a><span id="l102.203" class="difflineplus">+    print(&quot;Multiple parameters&quot;);</span>
<a href="#l102.204"></a><span id="l102.204" class="difflineplus">+    insertAndCheckMultipleParams(val)</span>
<a href="#l102.205"></a><span id="l102.205" class="difflineplus">+  });</span>
<a href="#l102.206"></a><span id="l102.206" class="difflineplus">+</span>
<a href="#l102.207"></a><span id="l102.207" class="difflineplus">+  cleanup();</span>
<a href="#l102.208"></a><span id="l102.208" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1">new file mode 100644</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineminus">--- /dev/null</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_aggregates.js</span>
<a href="#l103.4"></a><span id="l103.4" class="difflineat">@@ -0,0 +1,146 @@</span>
<a href="#l103.5"></a><span id="l103.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l103.6"></a><span id="l103.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l103.7"></a><span id="l103.7" class="difflineplus">+ *</span>
<a href="#l103.8"></a><span id="l103.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l103.9"></a><span id="l103.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l103.10"></a><span id="l103.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l103.11"></a><span id="l103.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l103.12"></a><span id="l103.12" class="difflineplus">+ *</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l103.14"></a><span id="l103.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l103.15"></a><span id="l103.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l103.16"></a><span id="l103.16" class="difflineplus">+ * License.</span>
<a href="#l103.17"></a><span id="l103.17" class="difflineplus">+ *</span>
<a href="#l103.18"></a><span id="l103.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l103.19"></a><span id="l103.19" class="difflineplus">+ *</span>
<a href="#l103.20"></a><span id="l103.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l103.21"></a><span id="l103.21" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l103.22"></a><span id="l103.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l103.23"></a><span id="l103.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l103.24"></a><span id="l103.24" class="difflineplus">+ *</span>
<a href="#l103.25"></a><span id="l103.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l103.26"></a><span id="l103.26" class="difflineplus">+ *</span>
<a href="#l103.27"></a><span id="l103.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l103.28"></a><span id="l103.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l103.29"></a><span id="l103.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l103.30"></a><span id="l103.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l103.31"></a><span id="l103.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l103.32"></a><span id="l103.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l103.33"></a><span id="l103.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l103.34"></a><span id="l103.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l103.35"></a><span id="l103.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l103.36"></a><span id="l103.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l103.37"></a><span id="l103.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l103.38"></a><span id="l103.38" class="difflineplus">+ *</span>
<a href="#l103.39"></a><span id="l103.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l103.40"></a><span id="l103.40" class="difflineplus">+</span>
<a href="#l103.41"></a><span id="l103.41" class="difflineplus">+// This file tests the custom aggregate functions</span>
<a href="#l103.42"></a><span id="l103.42" class="difflineplus">+</span>
<a href="#l103.43"></a><span id="l103.43" class="difflineplus">+var testNums = [1, 2, 3, 4];</span>
<a href="#l103.44"></a><span id="l103.44" class="difflineplus">+</span>
<a href="#l103.45"></a><span id="l103.45" class="difflineplus">+function setup()</span>
<a href="#l103.46"></a><span id="l103.46" class="difflineplus">+{</span>
<a href="#l103.47"></a><span id="l103.47" class="difflineplus">+  getOpenedDatabase().createTable(&quot;function_tests&quot;, &quot;id INTEGER PRIMARY KEY&quot;);</span>
<a href="#l103.48"></a><span id="l103.48" class="difflineplus">+</span>
<a href="#l103.49"></a><span id="l103.49" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO function_tests (id) VALUES(?1)&quot;);</span>
<a href="#l103.50"></a><span id="l103.50" class="difflineplus">+  for(var i = 0; i &lt; testNums.length; ++i) {</span>
<a href="#l103.51"></a><span id="l103.51" class="difflineplus">+    stmt.bindInt32Parameter(0, testNums[i]);</span>
<a href="#l103.52"></a><span id="l103.52" class="difflineplus">+    stmt.execute();</span>
<a href="#l103.53"></a><span id="l103.53" class="difflineplus">+  }</span>
<a href="#l103.54"></a><span id="l103.54" class="difflineplus">+  stmt.reset();</span>
<a href="#l103.55"></a><span id="l103.55" class="difflineplus">+  stmt.finalize();</span>
<a href="#l103.56"></a><span id="l103.56" class="difflineplus">+}</span>
<a href="#l103.57"></a><span id="l103.57" class="difflineplus">+</span>
<a href="#l103.58"></a><span id="l103.58" class="difflineplus">+var testSquareAndSumFunction = {</span>
<a href="#l103.59"></a><span id="l103.59" class="difflineplus">+  calls: 0,</span>
<a href="#l103.60"></a><span id="l103.60" class="difflineplus">+  _sas: 0,</span>
<a href="#l103.61"></a><span id="l103.61" class="difflineplus">+</span>
<a href="#l103.62"></a><span id="l103.62" class="difflineplus">+  reset: function() {</span>
<a href="#l103.63"></a><span id="l103.63" class="difflineplus">+    this.calls = 0;</span>
<a href="#l103.64"></a><span id="l103.64" class="difflineplus">+    this._sas  = 0;</span>
<a href="#l103.65"></a><span id="l103.65" class="difflineplus">+  },</span>
<a href="#l103.66"></a><span id="l103.66" class="difflineplus">+</span>
<a href="#l103.67"></a><span id="l103.67" class="difflineplus">+  onStep: function(val) {</span>
<a href="#l103.68"></a><span id="l103.68" class="difflineplus">+    ++this.calls;</span>
<a href="#l103.69"></a><span id="l103.69" class="difflineplus">+    this._sas += val.getInt32(0) * val.getInt32(0);</span>
<a href="#l103.70"></a><span id="l103.70" class="difflineplus">+  },</span>
<a href="#l103.71"></a><span id="l103.71" class="difflineplus">+</span>
<a href="#l103.72"></a><span id="l103.72" class="difflineplus">+  onFinal: function() {</span>
<a href="#l103.73"></a><span id="l103.73" class="difflineplus">+    var retval = this._sas;</span>
<a href="#l103.74"></a><span id="l103.74" class="difflineplus">+    this._sas = 0; // Prepare for next group</span>
<a href="#l103.75"></a><span id="l103.75" class="difflineplus">+    return retval;</span>
<a href="#l103.76"></a><span id="l103.76" class="difflineplus">+  }</span>
<a href="#l103.77"></a><span id="l103.77" class="difflineplus">+};</span>
<a href="#l103.78"></a><span id="l103.78" class="difflineplus">+</span>
<a href="#l103.79"></a><span id="l103.79" class="difflineplus">+function test_aggregate_registration()</span>
<a href="#l103.80"></a><span id="l103.80" class="difflineplus">+{</span>
<a href="#l103.81"></a><span id="l103.81" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l103.82"></a><span id="l103.82" class="difflineplus">+  msc.createAggregateFunction(&quot;test_sas_aggr&quot;, 1, testSquareAndSumFunction);</span>
<a href="#l103.83"></a><span id="l103.83" class="difflineplus">+}</span>
<a href="#l103.84"></a><span id="l103.84" class="difflineplus">+</span>
<a href="#l103.85"></a><span id="l103.85" class="difflineplus">+function test_aggregate_no_double_registration()</span>
<a href="#l103.86"></a><span id="l103.86" class="difflineplus">+{</span>
<a href="#l103.87"></a><span id="l103.87" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l103.88"></a><span id="l103.88" class="difflineplus">+  try {</span>
<a href="#l103.89"></a><span id="l103.89" class="difflineplus">+    msc.createAggregateFunction(&quot;test_sas_aggr&quot;, 2, testSquareAndSumFunction);</span>
<a href="#l103.90"></a><span id="l103.90" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l103.91"></a><span id="l103.91" class="difflineplus">+  } catch (e) {</span>
<a href="#l103.92"></a><span id="l103.92" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l103.93"></a><span id="l103.93" class="difflineplus">+  }</span>
<a href="#l103.94"></a><span id="l103.94" class="difflineplus">+}</span>
<a href="#l103.95"></a><span id="l103.95" class="difflineplus">+</span>
<a href="#l103.96"></a><span id="l103.96" class="difflineplus">+function test_aggregate_removal()</span>
<a href="#l103.97"></a><span id="l103.97" class="difflineplus">+{</span>
<a href="#l103.98"></a><span id="l103.98" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l103.99"></a><span id="l103.99" class="difflineplus">+  msc.removeFunction(&quot;test_sas_aggr&quot;);</span>
<a href="#l103.100"></a><span id="l103.100" class="difflineplus">+  // Should be Ok now</span>
<a href="#l103.101"></a><span id="l103.101" class="difflineplus">+  msc.createAggregateFunction(&quot;test_sas_aggr&quot;, 1, testSquareAndSumFunction);</span>
<a href="#l103.102"></a><span id="l103.102" class="difflineplus">+}</span>
<a href="#l103.103"></a><span id="l103.103" class="difflineplus">+</span>
<a href="#l103.104"></a><span id="l103.104" class="difflineplus">+function test_aggregate_no_aliases()</span>
<a href="#l103.105"></a><span id="l103.105" class="difflineplus">+{</span>
<a href="#l103.106"></a><span id="l103.106" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l103.107"></a><span id="l103.107" class="difflineplus">+  try {</span>
<a href="#l103.108"></a><span id="l103.108" class="difflineplus">+    msc.createAggregateFunction(&quot;test_sas_aggr2&quot;, 1, testSquareAndSumFunction);</span>
<a href="#l103.109"></a><span id="l103.109" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l103.110"></a><span id="l103.110" class="difflineplus">+  } catch (e) {</span>
<a href="#l103.111"></a><span id="l103.111" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l103.112"></a><span id="l103.112" class="difflineplus">+  }</span>
<a href="#l103.113"></a><span id="l103.113" class="difflineplus">+}</span>
<a href="#l103.114"></a><span id="l103.114" class="difflineplus">+</span>
<a href="#l103.115"></a><span id="l103.115" class="difflineplus">+function test_aggregate_call()</span>
<a href="#l103.116"></a><span id="l103.116" class="difflineplus">+{</span>
<a href="#l103.117"></a><span id="l103.117" class="difflineplus">+  var stmt = createStatement(&quot;SELECT test_sas_aggr(id) FROM function_tests&quot;);</span>
<a href="#l103.118"></a><span id="l103.118" class="difflineplus">+  while(stmt.executeStep());</span>
<a href="#l103.119"></a><span id="l103.119" class="difflineplus">+  do_check_eq(testNums.length, testSquareAndSumFunction.calls);</span>
<a href="#l103.120"></a><span id="l103.120" class="difflineplus">+  testSquareAndSumFunction.reset();</span>
<a href="#l103.121"></a><span id="l103.121" class="difflineplus">+  stmt.finalize();</span>
<a href="#l103.122"></a><span id="l103.122" class="difflineplus">+}</span>
<a href="#l103.123"></a><span id="l103.123" class="difflineplus">+</span>
<a href="#l103.124"></a><span id="l103.124" class="difflineplus">+function test_aggregate_result()</span>
<a href="#l103.125"></a><span id="l103.125" class="difflineplus">+{</span>
<a href="#l103.126"></a><span id="l103.126" class="difflineplus">+  var sas = 0;</span>
<a href="#l103.127"></a><span id="l103.127" class="difflineplus">+  for(var i = 0; i &lt; testNums.length; ++i) {</span>
<a href="#l103.128"></a><span id="l103.128" class="difflineplus">+    sas += testNums[i] * testNums[i];</span>
<a href="#l103.129"></a><span id="l103.129" class="difflineplus">+  }</span>
<a href="#l103.130"></a><span id="l103.130" class="difflineplus">+  var stmt = createStatement(&quot;SELECT test_sas_aggr(id) FROM function_tests&quot;);</span>
<a href="#l103.131"></a><span id="l103.131" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l103.132"></a><span id="l103.132" class="difflineplus">+  do_check_eq(sas, stmt.getInt32(0));</span>
<a href="#l103.133"></a><span id="l103.133" class="difflineplus">+  testSquareAndSumFunction.reset();</span>
<a href="#l103.134"></a><span id="l103.134" class="difflineplus">+  stmt.finalize();</span>
<a href="#l103.135"></a><span id="l103.135" class="difflineplus">+}</span>
<a href="#l103.136"></a><span id="l103.136" class="difflineplus">+</span>
<a href="#l103.137"></a><span id="l103.137" class="difflineplus">+var tests = [test_aggregate_registration, test_aggregate_no_double_registration,</span>
<a href="#l103.138"></a><span id="l103.138" class="difflineplus">+             test_aggregate_removal, test_aggregate_no_aliases, test_aggregate_call,</span>
<a href="#l103.139"></a><span id="l103.139" class="difflineplus">+             test_aggregate_result];</span>
<a href="#l103.140"></a><span id="l103.140" class="difflineplus">+</span>
<a href="#l103.141"></a><span id="l103.141" class="difflineplus">+function run_test()</span>
<a href="#l103.142"></a><span id="l103.142" class="difflineplus">+{</span>
<a href="#l103.143"></a><span id="l103.143" class="difflineplus">+  setup();</span>
<a href="#l103.144"></a><span id="l103.144" class="difflineplus">+</span>
<a href="#l103.145"></a><span id="l103.145" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++) {</span>
<a href="#l103.146"></a><span id="l103.146" class="difflineplus">+    tests[i]();</span>
<a href="#l103.147"></a><span id="l103.147" class="difflineplus">+  }</span>
<a href="#l103.148"></a><span id="l103.148" class="difflineplus">+</span>
<a href="#l103.149"></a><span id="l103.149" class="difflineplus">+  cleanup();</span>
<a href="#l103.150"></a><span id="l103.150" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1">new file mode 100644</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineminus">--- /dev/null</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_connection.js</span>
<a href="#l104.4"></a><span id="l104.4" class="difflineat">@@ -0,0 +1,367 @@</span>
<a href="#l104.5"></a><span id="l104.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l104.6"></a><span id="l104.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l104.7"></a><span id="l104.7" class="difflineplus">+ *</span>
<a href="#l104.8"></a><span id="l104.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l104.9"></a><span id="l104.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l104.10"></a><span id="l104.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l104.11"></a><span id="l104.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineplus">+ *</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l104.14"></a><span id="l104.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l104.15"></a><span id="l104.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l104.16"></a><span id="l104.16" class="difflineplus">+ * License.</span>
<a href="#l104.17"></a><span id="l104.17" class="difflineplus">+ *</span>
<a href="#l104.18"></a><span id="l104.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l104.19"></a><span id="l104.19" class="difflineplus">+ *</span>
<a href="#l104.20"></a><span id="l104.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l104.21"></a><span id="l104.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l104.22"></a><span id="l104.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l104.23"></a><span id="l104.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l104.24"></a><span id="l104.24" class="difflineplus">+ *</span>
<a href="#l104.25"></a><span id="l104.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l104.26"></a><span id="l104.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l104.27"></a><span id="l104.27" class="difflineplus">+ *</span>
<a href="#l104.28"></a><span id="l104.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l104.29"></a><span id="l104.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l104.30"></a><span id="l104.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l104.31"></a><span id="l104.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l104.32"></a><span id="l104.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l104.33"></a><span id="l104.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l104.34"></a><span id="l104.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l104.35"></a><span id="l104.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l104.36"></a><span id="l104.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l104.37"></a><span id="l104.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l104.38"></a><span id="l104.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l104.39"></a><span id="l104.39" class="difflineplus">+ *</span>
<a href="#l104.40"></a><span id="l104.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l104.41"></a><span id="l104.41" class="difflineplus">+</span>
<a href="#l104.42"></a><span id="l104.42" class="difflineplus">+// This file tests the functions of mozIStorageConnection</span>
<a href="#l104.43"></a><span id="l104.43" class="difflineplus">+</span>
<a href="#l104.44"></a><span id="l104.44" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l104.45"></a><span id="l104.45" class="difflineplus">+//// Test Functions</span>
<a href="#l104.46"></a><span id="l104.46" class="difflineplus">+</span>
<a href="#l104.47"></a><span id="l104.47" class="difflineplus">+function test_connectionReady_open()</span>
<a href="#l104.48"></a><span id="l104.48" class="difflineplus">+{</span>
<a href="#l104.49"></a><span id="l104.49" class="difflineplus">+  // there doesn't seem to be a way for the connection to not be ready (unless</span>
<a href="#l104.50"></a><span id="l104.50" class="difflineplus">+  // we close it with mozIStorageConnection::Close(), but we don't for this).</span>
<a href="#l104.51"></a><span id="l104.51" class="difflineplus">+  // It can only fail if GetPath fails on the database file, or if we run out</span>
<a href="#l104.52"></a><span id="l104.52" class="difflineplus">+  // of memory trying to use an in-memory database</span>
<a href="#l104.53"></a><span id="l104.53" class="difflineplus">+</span>
<a href="#l104.54"></a><span id="l104.54" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.55"></a><span id="l104.55" class="difflineplus">+  do_check_true(msc.connectionReady);</span>
<a href="#l104.56"></a><span id="l104.56" class="difflineplus">+  run_next_test();</span>
<a href="#l104.57"></a><span id="l104.57" class="difflineplus">+}</span>
<a href="#l104.58"></a><span id="l104.58" class="difflineplus">+</span>
<a href="#l104.59"></a><span id="l104.59" class="difflineplus">+function test_connectionReady_closed()</span>
<a href="#l104.60"></a><span id="l104.60" class="difflineplus">+{</span>
<a href="#l104.61"></a><span id="l104.61" class="difflineplus">+  // This also tests mozIStorageConnection::Close()</span>
<a href="#l104.62"></a><span id="l104.62" class="difflineplus">+</span>
<a href="#l104.63"></a><span id="l104.63" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.64"></a><span id="l104.64" class="difflineplus">+  msc.close();</span>
<a href="#l104.65"></a><span id="l104.65" class="difflineplus">+  do_check_false(msc.connectionReady);</span>
<a href="#l104.66"></a><span id="l104.66" class="difflineplus">+  gDBConn = null; // this is so later tests don't start to fail.</span>
<a href="#l104.67"></a><span id="l104.67" class="difflineplus">+  run_next_test();</span>
<a href="#l104.68"></a><span id="l104.68" class="difflineplus">+}</span>
<a href="#l104.69"></a><span id="l104.69" class="difflineplus">+</span>
<a href="#l104.70"></a><span id="l104.70" class="difflineplus">+function test_databaseFile()</span>
<a href="#l104.71"></a><span id="l104.71" class="difflineplus">+{</span>
<a href="#l104.72"></a><span id="l104.72" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.73"></a><span id="l104.73" class="difflineplus">+  do_check_true(getTestDB().equals(msc.databaseFile));</span>
<a href="#l104.74"></a><span id="l104.74" class="difflineplus">+  run_next_test();</span>
<a href="#l104.75"></a><span id="l104.75" class="difflineplus">+}</span>
<a href="#l104.76"></a><span id="l104.76" class="difflineplus">+</span>
<a href="#l104.77"></a><span id="l104.77" class="difflineplus">+function test_tableExists_not_created()</span>
<a href="#l104.78"></a><span id="l104.78" class="difflineplus">+{</span>
<a href="#l104.79"></a><span id="l104.79" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.80"></a><span id="l104.80" class="difflineplus">+  do_check_false(msc.tableExists(&quot;foo&quot;));</span>
<a href="#l104.81"></a><span id="l104.81" class="difflineplus">+  run_next_test();</span>
<a href="#l104.82"></a><span id="l104.82" class="difflineplus">+}</span>
<a href="#l104.83"></a><span id="l104.83" class="difflineplus">+</span>
<a href="#l104.84"></a><span id="l104.84" class="difflineplus">+function test_indexExists_not_created()</span>
<a href="#l104.85"></a><span id="l104.85" class="difflineplus">+{</span>
<a href="#l104.86"></a><span id="l104.86" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.87"></a><span id="l104.87" class="difflineplus">+  do_check_false(msc.indexExists(&quot;foo&quot;));</span>
<a href="#l104.88"></a><span id="l104.88" class="difflineplus">+  run_next_test();</span>
<a href="#l104.89"></a><span id="l104.89" class="difflineplus">+}</span>
<a href="#l104.90"></a><span id="l104.90" class="difflineplus">+</span>
<a href="#l104.91"></a><span id="l104.91" class="difflineplus">+function test_createTable_not_created()</span>
<a href="#l104.92"></a><span id="l104.92" class="difflineplus">+{</span>
<a href="#l104.93"></a><span id="l104.93" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.94"></a><span id="l104.94" class="difflineplus">+  msc.createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, name TEXT&quot;);</span>
<a href="#l104.95"></a><span id="l104.95" class="difflineplus">+  do_check_true(msc.tableExists(&quot;test&quot;));</span>
<a href="#l104.96"></a><span id="l104.96" class="difflineplus">+  run_next_test();</span>
<a href="#l104.97"></a><span id="l104.97" class="difflineplus">+}</span>
<a href="#l104.98"></a><span id="l104.98" class="difflineplus">+</span>
<a href="#l104.99"></a><span id="l104.99" class="difflineplus">+function test_indexExists_created()</span>
<a href="#l104.100"></a><span id="l104.100" class="difflineplus">+{</span>
<a href="#l104.101"></a><span id="l104.101" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.102"></a><span id="l104.102" class="difflineplus">+  msc.executeSimpleSQL(&quot;CREATE INDEX name_ind ON test (name)&quot;);</span>
<a href="#l104.103"></a><span id="l104.103" class="difflineplus">+  do_check_true(msc.indexExists(&quot;name_ind&quot;));</span>
<a href="#l104.104"></a><span id="l104.104" class="difflineplus">+  run_next_test();</span>
<a href="#l104.105"></a><span id="l104.105" class="difflineplus">+}</span>
<a href="#l104.106"></a><span id="l104.106" class="difflineplus">+</span>
<a href="#l104.107"></a><span id="l104.107" class="difflineplus">+function test_createTable_already_created()</span>
<a href="#l104.108"></a><span id="l104.108" class="difflineplus">+{</span>
<a href="#l104.109"></a><span id="l104.109" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.110"></a><span id="l104.110" class="difflineplus">+  do_check_true(msc.tableExists(&quot;test&quot;));</span>
<a href="#l104.111"></a><span id="l104.111" class="difflineplus">+  try {</span>
<a href="#l104.112"></a><span id="l104.112" class="difflineplus">+    msc.createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, name TEXT&quot;);</span>
<a href="#l104.113"></a><span id="l104.113" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l104.114"></a><span id="l104.114" class="difflineplus">+  } catch (e) {</span>
<a href="#l104.115"></a><span id="l104.115" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l104.116"></a><span id="l104.116" class="difflineplus">+  }</span>
<a href="#l104.117"></a><span id="l104.117" class="difflineplus">+  run_next_test();</span>
<a href="#l104.118"></a><span id="l104.118" class="difflineplus">+}</span>
<a href="#l104.119"></a><span id="l104.119" class="difflineplus">+</span>
<a href="#l104.120"></a><span id="l104.120" class="difflineplus">+function test_lastInsertRowID()</span>
<a href="#l104.121"></a><span id="l104.121" class="difflineplus">+{</span>
<a href="#l104.122"></a><span id="l104.122" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.123"></a><span id="l104.123" class="difflineplus">+  msc.executeSimpleSQL(&quot;INSERT INTO test (name) VALUES ('foo')&quot;);</span>
<a href="#l104.124"></a><span id="l104.124" class="difflineplus">+  do_check_eq(1, msc.lastInsertRowID);</span>
<a href="#l104.125"></a><span id="l104.125" class="difflineplus">+  run_next_test();</span>
<a href="#l104.126"></a><span id="l104.126" class="difflineplus">+}</span>
<a href="#l104.127"></a><span id="l104.127" class="difflineplus">+</span>
<a href="#l104.128"></a><span id="l104.128" class="difflineplus">+function test_transactionInProgress_no()</span>
<a href="#l104.129"></a><span id="l104.129" class="difflineplus">+{</span>
<a href="#l104.130"></a><span id="l104.130" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.131"></a><span id="l104.131" class="difflineplus">+  do_check_false(msc.transactionInProgress);</span>
<a href="#l104.132"></a><span id="l104.132" class="difflineplus">+  run_next_test();</span>
<a href="#l104.133"></a><span id="l104.133" class="difflineplus">+}</span>
<a href="#l104.134"></a><span id="l104.134" class="difflineplus">+</span>
<a href="#l104.135"></a><span id="l104.135" class="difflineplus">+function test_transactionInProgress_yes()</span>
<a href="#l104.136"></a><span id="l104.136" class="difflineplus">+{</span>
<a href="#l104.137"></a><span id="l104.137" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.138"></a><span id="l104.138" class="difflineplus">+  msc.beginTransaction();</span>
<a href="#l104.139"></a><span id="l104.139" class="difflineplus">+  do_check_true(msc.transactionInProgress);</span>
<a href="#l104.140"></a><span id="l104.140" class="difflineplus">+  msc.commitTransaction();</span>
<a href="#l104.141"></a><span id="l104.141" class="difflineplus">+  do_check_false(msc.transactionInProgress);</span>
<a href="#l104.142"></a><span id="l104.142" class="difflineplus">+</span>
<a href="#l104.143"></a><span id="l104.143" class="difflineplus">+  msc.beginTransaction();</span>
<a href="#l104.144"></a><span id="l104.144" class="difflineplus">+  do_check_true(msc.transactionInProgress);</span>
<a href="#l104.145"></a><span id="l104.145" class="difflineplus">+  msc.rollbackTransaction();</span>
<a href="#l104.146"></a><span id="l104.146" class="difflineplus">+  do_check_false(msc.transactionInProgress);</span>
<a href="#l104.147"></a><span id="l104.147" class="difflineplus">+  run_next_test();</span>
<a href="#l104.148"></a><span id="l104.148" class="difflineplus">+}</span>
<a href="#l104.149"></a><span id="l104.149" class="difflineplus">+</span>
<a href="#l104.150"></a><span id="l104.150" class="difflineplus">+function test_commitTransaction_no_transaction()</span>
<a href="#l104.151"></a><span id="l104.151" class="difflineplus">+{</span>
<a href="#l104.152"></a><span id="l104.152" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.153"></a><span id="l104.153" class="difflineplus">+  do_check_false(msc.transactionInProgress);</span>
<a href="#l104.154"></a><span id="l104.154" class="difflineplus">+  try {</span>
<a href="#l104.155"></a><span id="l104.155" class="difflineplus">+    msc.commitTransaction();</span>
<a href="#l104.156"></a><span id="l104.156" class="difflineplus">+    do_throw(&quot;We should not get here!&quot;);</span>
<a href="#l104.157"></a><span id="l104.157" class="difflineplus">+  } catch (e) {</span>
<a href="#l104.158"></a><span id="l104.158" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l104.159"></a><span id="l104.159" class="difflineplus">+  }</span>
<a href="#l104.160"></a><span id="l104.160" class="difflineplus">+  run_next_test();</span>
<a href="#l104.161"></a><span id="l104.161" class="difflineplus">+}</span>
<a href="#l104.162"></a><span id="l104.162" class="difflineplus">+</span>
<a href="#l104.163"></a><span id="l104.163" class="difflineplus">+function test_rollbackTransaction_no_transaction()</span>
<a href="#l104.164"></a><span id="l104.164" class="difflineplus">+{</span>
<a href="#l104.165"></a><span id="l104.165" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.166"></a><span id="l104.166" class="difflineplus">+  do_check_false(msc.transactionInProgress);</span>
<a href="#l104.167"></a><span id="l104.167" class="difflineplus">+  try {</span>
<a href="#l104.168"></a><span id="l104.168" class="difflineplus">+    msc.rollbackTransaction();</span>
<a href="#l104.169"></a><span id="l104.169" class="difflineplus">+    do_throw(&quot;We should not get here!&quot;);</span>
<a href="#l104.170"></a><span id="l104.170" class="difflineplus">+  } catch (e) {</span>
<a href="#l104.171"></a><span id="l104.171" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l104.172"></a><span id="l104.172" class="difflineplus">+  }</span>
<a href="#l104.173"></a><span id="l104.173" class="difflineplus">+  run_next_test();</span>
<a href="#l104.174"></a><span id="l104.174" class="difflineplus">+}</span>
<a href="#l104.175"></a><span id="l104.175" class="difflineplus">+</span>
<a href="#l104.176"></a><span id="l104.176" class="difflineplus">+function test_get_schemaVersion_not_set()</span>
<a href="#l104.177"></a><span id="l104.177" class="difflineplus">+{</span>
<a href="#l104.178"></a><span id="l104.178" class="difflineplus">+  do_check_eq(0, getOpenedDatabase().schemaVersion);</span>
<a href="#l104.179"></a><span id="l104.179" class="difflineplus">+  run_next_test();</span>
<a href="#l104.180"></a><span id="l104.180" class="difflineplus">+}</span>
<a href="#l104.181"></a><span id="l104.181" class="difflineplus">+</span>
<a href="#l104.182"></a><span id="l104.182" class="difflineplus">+function test_set_schemaVersion()</span>
<a href="#l104.183"></a><span id="l104.183" class="difflineplus">+{</span>
<a href="#l104.184"></a><span id="l104.184" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.185"></a><span id="l104.185" class="difflineplus">+  const version = 1;</span>
<a href="#l104.186"></a><span id="l104.186" class="difflineplus">+  msc.schemaVersion = version;</span>
<a href="#l104.187"></a><span id="l104.187" class="difflineplus">+  do_check_eq(version, msc.schemaVersion);</span>
<a href="#l104.188"></a><span id="l104.188" class="difflineplus">+  run_next_test();</span>
<a href="#l104.189"></a><span id="l104.189" class="difflineplus">+}</span>
<a href="#l104.190"></a><span id="l104.190" class="difflineplus">+</span>
<a href="#l104.191"></a><span id="l104.191" class="difflineplus">+function test_set_schemaVersion_same()</span>
<a href="#l104.192"></a><span id="l104.192" class="difflineplus">+{</span>
<a href="#l104.193"></a><span id="l104.193" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.194"></a><span id="l104.194" class="difflineplus">+  const version = 1;</span>
<a href="#l104.195"></a><span id="l104.195" class="difflineplus">+  msc.schemaVersion = version; // should still work ok</span>
<a href="#l104.196"></a><span id="l104.196" class="difflineplus">+  do_check_eq(version, msc.schemaVersion);</span>
<a href="#l104.197"></a><span id="l104.197" class="difflineplus">+  run_next_test();</span>
<a href="#l104.198"></a><span id="l104.198" class="difflineplus">+}</span>
<a href="#l104.199"></a><span id="l104.199" class="difflineplus">+</span>
<a href="#l104.200"></a><span id="l104.200" class="difflineplus">+function test_set_schemaVersion_negative()</span>
<a href="#l104.201"></a><span id="l104.201" class="difflineplus">+{</span>
<a href="#l104.202"></a><span id="l104.202" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.203"></a><span id="l104.203" class="difflineplus">+  const version = -1;</span>
<a href="#l104.204"></a><span id="l104.204" class="difflineplus">+  msc.schemaVersion = version;</span>
<a href="#l104.205"></a><span id="l104.205" class="difflineplus">+  do_check_eq(version, msc.schemaVersion);</span>
<a href="#l104.206"></a><span id="l104.206" class="difflineplus">+  run_next_test();</span>
<a href="#l104.207"></a><span id="l104.207" class="difflineplus">+}</span>
<a href="#l104.208"></a><span id="l104.208" class="difflineplus">+</span>
<a href="#l104.209"></a><span id="l104.209" class="difflineplus">+function test_createTable(){</span>
<a href="#l104.210"></a><span id="l104.210" class="difflineplus">+  var temp = getTestDB().parent;</span>
<a href="#l104.211"></a><span id="l104.211" class="difflineplus">+  temp.append(&quot;test_db_table&quot;);</span>
<a href="#l104.212"></a><span id="l104.212" class="difflineplus">+  try {</span>
<a href="#l104.213"></a><span id="l104.213" class="difflineplus">+    var con = getService().openDatabase(temp);</span>
<a href="#l104.214"></a><span id="l104.214" class="difflineplus">+    con.createTable(&quot;a&quot;,&quot;&quot;);</span>
<a href="#l104.215"></a><span id="l104.215" class="difflineplus">+  } catch (e) {</span>
<a href="#l104.216"></a><span id="l104.216" class="difflineplus">+    if (temp.exists()) try {</span>
<a href="#l104.217"></a><span id="l104.217" class="difflineplus">+      temp.remove(false);</span>
<a href="#l104.218"></a><span id="l104.218" class="difflineplus">+    } catch (e2) {}</span>
<a href="#l104.219"></a><span id="l104.219" class="difflineplus">+    do_check_true(e.result==Cr.NS_ERROR_NOT_INITIALIZED ||</span>
<a href="#l104.220"></a><span id="l104.220" class="difflineplus">+                  e.result==Cr.NS_ERROR_FAILURE);</span>
<a href="#l104.221"></a><span id="l104.221" class="difflineplus">+  }</span>
<a href="#l104.222"></a><span id="l104.222" class="difflineplus">+  run_next_test();</span>
<a href="#l104.223"></a><span id="l104.223" class="difflineplus">+}</span>
<a href="#l104.224"></a><span id="l104.224" class="difflineplus">+</span>
<a href="#l104.225"></a><span id="l104.225" class="difflineplus">+function test_defaultSynchronousAtNormal()</span>
<a href="#l104.226"></a><span id="l104.226" class="difflineplus">+{</span>
<a href="#l104.227"></a><span id="l104.227" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l104.228"></a><span id="l104.228" class="difflineplus">+  var stmt = createStatement(&quot;PRAGMA synchronous;&quot;);</span>
<a href="#l104.229"></a><span id="l104.229" class="difflineplus">+  try {</span>
<a href="#l104.230"></a><span id="l104.230" class="difflineplus">+    stmt.executeStep();</span>
<a href="#l104.231"></a><span id="l104.231" class="difflineplus">+    do_check_eq(1, stmt.getInt32(0));</span>
<a href="#l104.232"></a><span id="l104.232" class="difflineplus">+  }</span>
<a href="#l104.233"></a><span id="l104.233" class="difflineplus">+  finally {</span>
<a href="#l104.234"></a><span id="l104.234" class="difflineplus">+    stmt.reset();</span>
<a href="#l104.235"></a><span id="l104.235" class="difflineplus">+    stmt.finalize();</span>
<a href="#l104.236"></a><span id="l104.236" class="difflineplus">+  }</span>
<a href="#l104.237"></a><span id="l104.237" class="difflineplus">+  run_next_test();</span>
<a href="#l104.238"></a><span id="l104.238" class="difflineplus">+}</span>
<a href="#l104.239"></a><span id="l104.239" class="difflineplus">+</span>
<a href="#l104.240"></a><span id="l104.240" class="difflineplus">+function test_close_does_not_spin_event_loop()</span>
<a href="#l104.241"></a><span id="l104.241" class="difflineplus">+{</span>
<a href="#l104.242"></a><span id="l104.242" class="difflineplus">+  // We want to make sure that the event loop on the calling thread does not</span>
<a href="#l104.243"></a><span id="l104.243" class="difflineplus">+  // spin when close is called.</span>
<a href="#l104.244"></a><span id="l104.244" class="difflineplus">+  let event = {</span>
<a href="#l104.245"></a><span id="l104.245" class="difflineplus">+    ran: false,</span>
<a href="#l104.246"></a><span id="l104.246" class="difflineplus">+    run: function()</span>
<a href="#l104.247"></a><span id="l104.247" class="difflineplus">+    {</span>
<a href="#l104.248"></a><span id="l104.248" class="difflineplus">+      this.ran = true;</span>
<a href="#l104.249"></a><span id="l104.249" class="difflineplus">+    },</span>
<a href="#l104.250"></a><span id="l104.250" class="difflineplus">+  };</span>
<a href="#l104.251"></a><span id="l104.251" class="difflineplus">+</span>
<a href="#l104.252"></a><span id="l104.252" class="difflineplus">+  // Post the event before we call close, so it would run if the event loop was</span>
<a href="#l104.253"></a><span id="l104.253" class="difflineplus">+  // spun during close.</span>
<a href="#l104.254"></a><span id="l104.254" class="difflineplus">+  let thread = Cc[&quot;@mozilla.org/thread-manager;1&quot;].</span>
<a href="#l104.255"></a><span id="l104.255" class="difflineplus">+               getService(Ci.nsIThreadManager).</span>
<a href="#l104.256"></a><span id="l104.256" class="difflineplus">+               currentThread;</span>
<a href="#l104.257"></a><span id="l104.257" class="difflineplus">+  thread.dispatch(event, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l104.258"></a><span id="l104.258" class="difflineplus">+</span>
<a href="#l104.259"></a><span id="l104.259" class="difflineplus">+  // Sanity check, then close the database.  Afterwards, we should not have ran!</span>
<a href="#l104.260"></a><span id="l104.260" class="difflineplus">+  do_check_false(event.ran);</span>
<a href="#l104.261"></a><span id="l104.261" class="difflineplus">+  getOpenedDatabase().close();</span>
<a href="#l104.262"></a><span id="l104.262" class="difflineplus">+  do_check_false(event.ran);</span>
<a href="#l104.263"></a><span id="l104.263" class="difflineplus">+</span>
<a href="#l104.264"></a><span id="l104.264" class="difflineplus">+  // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l104.265"></a><span id="l104.265" class="difflineplus">+  gDBConn = null;</span>
<a href="#l104.266"></a><span id="l104.266" class="difflineplus">+  run_next_test();</span>
<a href="#l104.267"></a><span id="l104.267" class="difflineplus">+}</span>
<a href="#l104.268"></a><span id="l104.268" class="difflineplus">+</span>
<a href="#l104.269"></a><span id="l104.269" class="difflineplus">+function test_asyncClose_succeeds_with_finalized_async_statement()</span>
<a href="#l104.270"></a><span id="l104.270" class="difflineplus">+{</span>
<a href="#l104.271"></a><span id="l104.271" class="difflineplus">+  // XXX this test isn't perfect since we can't totally control when events will</span>
<a href="#l104.272"></a><span id="l104.272" class="difflineplus">+  //     run.  If this paticular function fails randomly, it means we have a</span>
<a href="#l104.273"></a><span id="l104.273" class="difflineplus">+  //     real bug.</span>
<a href="#l104.274"></a><span id="l104.274" class="difflineplus">+</span>
<a href="#l104.275"></a><span id="l104.275" class="difflineplus">+  // We want to make sure we create a cached async statement to make sure that</span>
<a href="#l104.276"></a><span id="l104.276" class="difflineplus">+  // when we finalize our statement, we end up finalizing the async one too so</span>
<a href="#l104.277"></a><span id="l104.277" class="difflineplus">+  // close will succeed.</span>
<a href="#l104.278"></a><span id="l104.278" class="difflineplus">+  let stmt = createStatement(&quot;SELECT * FROM test&quot;);</span>
<a href="#l104.279"></a><span id="l104.279" class="difflineplus">+  stmt.executeAsync();</span>
<a href="#l104.280"></a><span id="l104.280" class="difflineplus">+  stmt.finalize();</span>
<a href="#l104.281"></a><span id="l104.281" class="difflineplus">+</span>
<a href="#l104.282"></a><span id="l104.282" class="difflineplus">+  getOpenedDatabase().asyncClose(function() {</span>
<a href="#l104.283"></a><span id="l104.283" class="difflineplus">+    // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l104.284"></a><span id="l104.284" class="difflineplus">+    gDBConn = null;</span>
<a href="#l104.285"></a><span id="l104.285" class="difflineplus">+    run_next_test();</span>
<a href="#l104.286"></a><span id="l104.286" class="difflineplus">+  });</span>
<a href="#l104.287"></a><span id="l104.287" class="difflineplus">+}</span>
<a href="#l104.288"></a><span id="l104.288" class="difflineplus">+</span>
<a href="#l104.289"></a><span id="l104.289" class="difflineplus">+function test_close_fails_with_async_statement_ran()</span>
<a href="#l104.290"></a><span id="l104.290" class="difflineplus">+{</span>
<a href="#l104.291"></a><span id="l104.291" class="difflineplus">+  let stmt = createStatement(&quot;SELECT * FROM test&quot;);</span>
<a href="#l104.292"></a><span id="l104.292" class="difflineplus">+  stmt.executeAsync();</span>
<a href="#l104.293"></a><span id="l104.293" class="difflineplus">+  stmt.finalize();</span>
<a href="#l104.294"></a><span id="l104.294" class="difflineplus">+</span>
<a href="#l104.295"></a><span id="l104.295" class="difflineplus">+  let db = getOpenedDatabase();</span>
<a href="#l104.296"></a><span id="l104.296" class="difflineplus">+  try {</span>
<a href="#l104.297"></a><span id="l104.297" class="difflineplus">+    db.close();</span>
<a href="#l104.298"></a><span id="l104.298" class="difflineplus">+    do_throw(&quot;should have thrown&quot;);</span>
<a href="#l104.299"></a><span id="l104.299" class="difflineplus">+  }</span>
<a href="#l104.300"></a><span id="l104.300" class="difflineplus">+  catch (e) {</span>
<a href="#l104.301"></a><span id="l104.301" class="difflineplus">+    do_check_eq(e.result, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l104.302"></a><span id="l104.302" class="difflineplus">+  }</span>
<a href="#l104.303"></a><span id="l104.303" class="difflineplus">+  finally {</span>
<a href="#l104.304"></a><span id="l104.304" class="difflineplus">+    // Clean up after ourselves.</span>
<a href="#l104.305"></a><span id="l104.305" class="difflineplus">+    db.asyncClose(function() {</span>
<a href="#l104.306"></a><span id="l104.306" class="difflineplus">+      // Reset gDBConn so that later tests will get a new connection object.</span>
<a href="#l104.307"></a><span id="l104.307" class="difflineplus">+      gDBConn = null;</span>
<a href="#l104.308"></a><span id="l104.308" class="difflineplus">+      run_next_test();</span>
<a href="#l104.309"></a><span id="l104.309" class="difflineplus">+    });</span>
<a href="#l104.310"></a><span id="l104.310" class="difflineplus">+  }</span>
<a href="#l104.311"></a><span id="l104.311" class="difflineplus">+}</span>
<a href="#l104.312"></a><span id="l104.312" class="difflineplus">+</span>
<a href="#l104.313"></a><span id="l104.313" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l104.314"></a><span id="l104.314" class="difflineplus">+//// Test Runner</span>
<a href="#l104.315"></a><span id="l104.315" class="difflineplus">+</span>
<a href="#l104.316"></a><span id="l104.316" class="difflineplus">+var tests = [</span>
<a href="#l104.317"></a><span id="l104.317" class="difflineplus">+  test_connectionReady_open,</span>
<a href="#l104.318"></a><span id="l104.318" class="difflineplus">+  test_connectionReady_closed,</span>
<a href="#l104.319"></a><span id="l104.319" class="difflineplus">+  test_databaseFile,</span>
<a href="#l104.320"></a><span id="l104.320" class="difflineplus">+  test_tableExists_not_created,</span>
<a href="#l104.321"></a><span id="l104.321" class="difflineplus">+  test_indexExists_not_created,</span>
<a href="#l104.322"></a><span id="l104.322" class="difflineplus">+  test_createTable_not_created,</span>
<a href="#l104.323"></a><span id="l104.323" class="difflineplus">+  test_indexExists_created,</span>
<a href="#l104.324"></a><span id="l104.324" class="difflineplus">+  test_createTable_already_created,</span>
<a href="#l104.325"></a><span id="l104.325" class="difflineplus">+  test_lastInsertRowID,</span>
<a href="#l104.326"></a><span id="l104.326" class="difflineplus">+  test_transactionInProgress_no,</span>
<a href="#l104.327"></a><span id="l104.327" class="difflineplus">+  test_transactionInProgress_yes,</span>
<a href="#l104.328"></a><span id="l104.328" class="difflineplus">+  test_commitTransaction_no_transaction,</span>
<a href="#l104.329"></a><span id="l104.329" class="difflineplus">+  test_rollbackTransaction_no_transaction,</span>
<a href="#l104.330"></a><span id="l104.330" class="difflineplus">+  test_get_schemaVersion_not_set,</span>
<a href="#l104.331"></a><span id="l104.331" class="difflineplus">+  test_set_schemaVersion,</span>
<a href="#l104.332"></a><span id="l104.332" class="difflineplus">+  test_set_schemaVersion_same,</span>
<a href="#l104.333"></a><span id="l104.333" class="difflineplus">+  test_set_schemaVersion_negative,</span>
<a href="#l104.334"></a><span id="l104.334" class="difflineplus">+  test_createTable,</span>
<a href="#l104.335"></a><span id="l104.335" class="difflineplus">+  test_defaultSynchronousAtNormal,</span>
<a href="#l104.336"></a><span id="l104.336" class="difflineplus">+  test_close_does_not_spin_event_loop, // must be ran before executeAsync tests</span>
<a href="#l104.337"></a><span id="l104.337" class="difflineplus">+  test_asyncClose_succeeds_with_finalized_async_statement,</span>
<a href="#l104.338"></a><span id="l104.338" class="difflineplus">+  test_close_fails_with_async_statement_ran,</span>
<a href="#l104.339"></a><span id="l104.339" class="difflineplus">+];</span>
<a href="#l104.340"></a><span id="l104.340" class="difflineplus">+let index = 0;</span>
<a href="#l104.341"></a><span id="l104.341" class="difflineplus">+</span>
<a href="#l104.342"></a><span id="l104.342" class="difflineplus">+function run_next_test()</span>
<a href="#l104.343"></a><span id="l104.343" class="difflineplus">+{</span>
<a href="#l104.344"></a><span id="l104.344" class="difflineplus">+  function _run_next_test() {</span>
<a href="#l104.345"></a><span id="l104.345" class="difflineplus">+    if (index &lt; tests.length) {</span>
<a href="#l104.346"></a><span id="l104.346" class="difflineplus">+      do_test_pending();</span>
<a href="#l104.347"></a><span id="l104.347" class="difflineplus">+      print(&quot;Running the next test: &quot; + tests[index].name);</span>
<a href="#l104.348"></a><span id="l104.348" class="difflineplus">+</span>
<a href="#l104.349"></a><span id="l104.349" class="difflineplus">+      // Asynchronous tests means that exceptions don't kill the test.</span>
<a href="#l104.350"></a><span id="l104.350" class="difflineplus">+      try {</span>
<a href="#l104.351"></a><span id="l104.351" class="difflineplus">+        tests[index++]();</span>
<a href="#l104.352"></a><span id="l104.352" class="difflineplus">+      }</span>
<a href="#l104.353"></a><span id="l104.353" class="difflineplus">+      catch (e) {</span>
<a href="#l104.354"></a><span id="l104.354" class="difflineplus">+        do_throw(e);</span>
<a href="#l104.355"></a><span id="l104.355" class="difflineplus">+      }</span>
<a href="#l104.356"></a><span id="l104.356" class="difflineplus">+    }</span>
<a href="#l104.357"></a><span id="l104.357" class="difflineplus">+</span>
<a href="#l104.358"></a><span id="l104.358" class="difflineplus">+    do_test_finished();</span>
<a href="#l104.359"></a><span id="l104.359" class="difflineplus">+  }</span>
<a href="#l104.360"></a><span id="l104.360" class="difflineplus">+</span>
<a href="#l104.361"></a><span id="l104.361" class="difflineplus">+  // For saner stacks, we execute this code RSN.</span>
<a href="#l104.362"></a><span id="l104.362" class="difflineplus">+  do_execute_soon(_run_next_test);</span>
<a href="#l104.363"></a><span id="l104.363" class="difflineplus">+}</span>
<a href="#l104.364"></a><span id="l104.364" class="difflineplus">+</span>
<a href="#l104.365"></a><span id="l104.365" class="difflineplus">+function run_test()</span>
<a href="#l104.366"></a><span id="l104.366" class="difflineplus">+{</span>
<a href="#l104.367"></a><span id="l104.367" class="difflineplus">+  cleanup();</span>
<a href="#l104.368"></a><span id="l104.368" class="difflineplus">+</span>
<a href="#l104.369"></a><span id="l104.369" class="difflineplus">+  do_test_pending();</span>
<a href="#l104.370"></a><span id="l104.370" class="difflineplus">+  run_next_test();</span>
<a href="#l104.371"></a><span id="l104.371" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1">new file mode 100644</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineminus">--- /dev/null</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_fulltextindex.js</span>
<a href="#l105.4"></a><span id="l105.4" class="difflineat">@@ -0,0 +1,119 @@</span>
<a href="#l105.5"></a><span id="l105.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l105.6"></a><span id="l105.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l105.7"></a><span id="l105.7" class="difflineplus">+ *</span>
<a href="#l105.8"></a><span id="l105.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l105.9"></a><span id="l105.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l105.10"></a><span id="l105.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l105.11"></a><span id="l105.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineplus">+ *</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l105.14"></a><span id="l105.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l105.15"></a><span id="l105.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l105.16"></a><span id="l105.16" class="difflineplus">+ * License.</span>
<a href="#l105.17"></a><span id="l105.17" class="difflineplus">+ *</span>
<a href="#l105.18"></a><span id="l105.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l105.19"></a><span id="l105.19" class="difflineplus">+ *</span>
<a href="#l105.20"></a><span id="l105.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l105.21"></a><span id="l105.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l105.22"></a><span id="l105.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l105.23"></a><span id="l105.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l105.24"></a><span id="l105.24" class="difflineplus">+ *</span>
<a href="#l105.25"></a><span id="l105.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l105.26"></a><span id="l105.26" class="difflineplus">+ *   Myk Melez &lt;myk@mozilla.org&gt; (Original Author)</span>
<a href="#l105.27"></a><span id="l105.27" class="difflineplus">+ *</span>
<a href="#l105.28"></a><span id="l105.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l105.29"></a><span id="l105.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l105.30"></a><span id="l105.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l105.31"></a><span id="l105.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l105.32"></a><span id="l105.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l105.33"></a><span id="l105.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l105.34"></a><span id="l105.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l105.35"></a><span id="l105.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l105.36"></a><span id="l105.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l105.37"></a><span id="l105.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l105.38"></a><span id="l105.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l105.39"></a><span id="l105.39" class="difflineplus">+ *</span>
<a href="#l105.40"></a><span id="l105.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l105.41"></a><span id="l105.41" class="difflineplus">+</span>
<a href="#l105.42"></a><span id="l105.42" class="difflineplus">+// This file tests support for the fts3 (full-text index) module.</span>
<a href="#l105.43"></a><span id="l105.43" class="difflineplus">+</span>
<a href="#l105.44"></a><span id="l105.44" class="difflineplus">+// Example statements in these tests are taken from the Full Text Index page</span>
<a href="#l105.45"></a><span id="l105.45" class="difflineplus">+// on the SQLite wiki: http://www.sqlite.org/cvstrac/wiki?p=FullTextIndex</span>
<a href="#l105.46"></a><span id="l105.46" class="difflineplus">+</span>
<a href="#l105.47"></a><span id="l105.47" class="difflineplus">+function test_table_creation()</span>
<a href="#l105.48"></a><span id="l105.48" class="difflineplus">+{</span>
<a href="#l105.49"></a><span id="l105.49" class="difflineplus">+  var msc = getOpenedDatabase(true);</span>
<a href="#l105.50"></a><span id="l105.50" class="difflineplus">+</span>
<a href="#l105.51"></a><span id="l105.51" class="difflineplus">+  msc.executeSimpleSQL(</span>
<a href="#l105.52"></a><span id="l105.52" class="difflineplus">+    &quot;CREATE VIRTUAL TABLE recipe USING fts3(name, ingredients)&quot;);</span>
<a href="#l105.53"></a><span id="l105.53" class="difflineplus">+</span>
<a href="#l105.54"></a><span id="l105.54" class="difflineplus">+  do_check_true(msc.tableExists(&quot;recipe&quot;));</span>
<a href="#l105.55"></a><span id="l105.55" class="difflineplus">+}</span>
<a href="#l105.56"></a><span id="l105.56" class="difflineplus">+</span>
<a href="#l105.57"></a><span id="l105.57" class="difflineplus">+function test_insertion()</span>
<a href="#l105.58"></a><span id="l105.58" class="difflineplus">+{</span>
<a href="#l105.59"></a><span id="l105.59" class="difflineplus">+  var msc = getOpenedDatabase(true);</span>
<a href="#l105.60"></a><span id="l105.60" class="difflineplus">+</span>
<a href="#l105.61"></a><span id="l105.61" class="difflineplus">+  msc.executeSimpleSQL(&quot;INSERT INTO recipe (name, ingredients) VALUES &quot; +</span>
<a href="#l105.62"></a><span id="l105.62" class="difflineplus">+                       &quot;('broccoli stew', 'broccoli peppers cheese tomatoes')&quot;);</span>
<a href="#l105.63"></a><span id="l105.63" class="difflineplus">+  msc.executeSimpleSQL(&quot;INSERT INTO recipe (name, ingredients) VALUES &quot; +</span>
<a href="#l105.64"></a><span id="l105.64" class="difflineplus">+                       &quot;('pumpkin stew', 'pumpkin onions garlic celery')&quot;);</span>
<a href="#l105.65"></a><span id="l105.65" class="difflineplus">+  msc.executeSimpleSQL(&quot;INSERT INTO recipe (name, ingredients) VALUES &quot; +</span>
<a href="#l105.66"></a><span id="l105.66" class="difflineplus">+                       &quot;('broccoli pie', 'broccoli cheese onions flour')&quot;);</span>
<a href="#l105.67"></a><span id="l105.67" class="difflineplus">+  msc.executeSimpleSQL(&quot;INSERT INTO recipe (name, ingredients) VALUES &quot; +</span>
<a href="#l105.68"></a><span id="l105.68" class="difflineplus">+                       &quot;('pumpkin pie', 'pumpkin sugar flour butter')&quot;);</span>
<a href="#l105.69"></a><span id="l105.69" class="difflineplus">+</span>
<a href="#l105.70"></a><span id="l105.70" class="difflineplus">+  var stmt = msc.createStatement(&quot;SELECT COUNT(*) FROM recipe&quot;);</span>
<a href="#l105.71"></a><span id="l105.71" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l105.72"></a><span id="l105.72" class="difflineplus">+</span>
<a href="#l105.73"></a><span id="l105.73" class="difflineplus">+  do_check_eq(stmt.getInt32(0), 4);</span>
<a href="#l105.74"></a><span id="l105.74" class="difflineplus">+</span>
<a href="#l105.75"></a><span id="l105.75" class="difflineplus">+  stmt.reset();</span>
<a href="#l105.76"></a><span id="l105.76" class="difflineplus">+  stmt.finalize();</span>
<a href="#l105.77"></a><span id="l105.77" class="difflineplus">+}</span>
<a href="#l105.78"></a><span id="l105.78" class="difflineplus">+</span>
<a href="#l105.79"></a><span id="l105.79" class="difflineplus">+function test_selection()</span>
<a href="#l105.80"></a><span id="l105.80" class="difflineplus">+{</span>
<a href="#l105.81"></a><span id="l105.81" class="difflineplus">+  var msc = getOpenedDatabase(true);</span>
<a href="#l105.82"></a><span id="l105.82" class="difflineplus">+</span>
<a href="#l105.83"></a><span id="l105.83" class="difflineplus">+  var stmt = msc.createStatement(</span>
<a href="#l105.84"></a><span id="l105.84" class="difflineplus">+    &quot;SELECT rowid, name, ingredients FROM recipe WHERE name MATCH 'pie'&quot;);</span>
<a href="#l105.85"></a><span id="l105.85" class="difflineplus">+</span>
<a href="#l105.86"></a><span id="l105.86" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l105.87"></a><span id="l105.87" class="difflineplus">+  do_check_eq(stmt.getInt32(0), 3);</span>
<a href="#l105.88"></a><span id="l105.88" class="difflineplus">+  do_check_eq(stmt.getString(1), &quot;broccoli pie&quot;);</span>
<a href="#l105.89"></a><span id="l105.89" class="difflineplus">+  do_check_eq(stmt.getString(2), &quot;broccoli cheese onions flour&quot;);</span>
<a href="#l105.90"></a><span id="l105.90" class="difflineplus">+</span>
<a href="#l105.91"></a><span id="l105.91" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l105.92"></a><span id="l105.92" class="difflineplus">+  do_check_eq(stmt.getInt32(0), 4);</span>
<a href="#l105.93"></a><span id="l105.93" class="difflineplus">+  do_check_eq(stmt.getString(1), &quot;pumpkin pie&quot;);</span>
<a href="#l105.94"></a><span id="l105.94" class="difflineplus">+  do_check_eq(stmt.getString(2), &quot;pumpkin sugar flour butter&quot;);</span>
<a href="#l105.95"></a><span id="l105.95" class="difflineplus">+</span>
<a href="#l105.96"></a><span id="l105.96" class="difflineplus">+  do_check_false(stmt.executeStep());</span>
<a href="#l105.97"></a><span id="l105.97" class="difflineplus">+</span>
<a href="#l105.98"></a><span id="l105.98" class="difflineplus">+  stmt.reset();</span>
<a href="#l105.99"></a><span id="l105.99" class="difflineplus">+  stmt.finalize();</span>
<a href="#l105.100"></a><span id="l105.100" class="difflineplus">+}</span>
<a href="#l105.101"></a><span id="l105.101" class="difflineplus">+</span>
<a href="#l105.102"></a><span id="l105.102" class="difflineplus">+var tests = [test_table_creation, test_insertion, test_selection];</span>
<a href="#l105.103"></a><span id="l105.103" class="difflineplus">+</span>
<a href="#l105.104"></a><span id="l105.104" class="difflineplus">+function run_test()</span>
<a href="#l105.105"></a><span id="l105.105" class="difflineplus">+{</span>
<a href="#l105.106"></a><span id="l105.106" class="difflineplus">+  // It's extra important to start from scratch, since these tests won't work</span>
<a href="#l105.107"></a><span id="l105.107" class="difflineplus">+  // with an existing shared cache connection, so we do it even though the last</span>
<a href="#l105.108"></a><span id="l105.108" class="difflineplus">+  // test probably did it already.</span>
<a href="#l105.109"></a><span id="l105.109" class="difflineplus">+  cleanup();</span>
<a href="#l105.110"></a><span id="l105.110" class="difflineplus">+</span>
<a href="#l105.111"></a><span id="l105.111" class="difflineplus">+  try {</span>
<a href="#l105.112"></a><span id="l105.112" class="difflineplus">+    for (var i = 0; i &lt; tests.length; i++) {</span>
<a href="#l105.113"></a><span id="l105.113" class="difflineplus">+      tests[i]();</span>
<a href="#l105.114"></a><span id="l105.114" class="difflineplus">+    }</span>
<a href="#l105.115"></a><span id="l105.115" class="difflineplus">+  }</span>
<a href="#l105.116"></a><span id="l105.116" class="difflineplus">+  // It's extra important to clean up afterwards, since later tests that use</span>
<a href="#l105.117"></a><span id="l105.117" class="difflineplus">+  // a shared cache connection will not be able to read the database we create,</span>
<a href="#l105.118"></a><span id="l105.118" class="difflineplus">+  // so we do this in a finally block to ensure it happens even if some of our</span>
<a href="#l105.119"></a><span id="l105.119" class="difflineplus">+  // tests fail.</span>
<a href="#l105.120"></a><span id="l105.120" class="difflineplus">+  finally {</span>
<a href="#l105.121"></a><span id="l105.121" class="difflineplus">+    cleanup();</span>
<a href="#l105.122"></a><span id="l105.122" class="difflineplus">+  }</span>
<a href="#l105.123"></a><span id="l105.123" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1">new file mode 100644</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineminus">--- /dev/null</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_function.js</span>
<a href="#l106.4"></a><span id="l106.4" class="difflineat">@@ -0,0 +1,125 @@</span>
<a href="#l106.5"></a><span id="l106.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l106.6"></a><span id="l106.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l106.7"></a><span id="l106.7" class="difflineplus">+ *</span>
<a href="#l106.8"></a><span id="l106.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l106.9"></a><span id="l106.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l106.10"></a><span id="l106.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l106.11"></a><span id="l106.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l106.12"></a><span id="l106.12" class="difflineplus">+ *</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l106.14"></a><span id="l106.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l106.15"></a><span id="l106.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l106.16"></a><span id="l106.16" class="difflineplus">+ * License.</span>
<a href="#l106.17"></a><span id="l106.17" class="difflineplus">+ *</span>
<a href="#l106.18"></a><span id="l106.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l106.19"></a><span id="l106.19" class="difflineplus">+ *</span>
<a href="#l106.20"></a><span id="l106.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l106.21"></a><span id="l106.21" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l106.22"></a><span id="l106.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l106.23"></a><span id="l106.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l106.24"></a><span id="l106.24" class="difflineplus">+ *</span>
<a href="#l106.25"></a><span id="l106.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l106.26"></a><span id="l106.26" class="difflineplus">+ *</span>
<a href="#l106.27"></a><span id="l106.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l106.28"></a><span id="l106.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l106.29"></a><span id="l106.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l106.30"></a><span id="l106.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l106.31"></a><span id="l106.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l106.32"></a><span id="l106.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l106.33"></a><span id="l106.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l106.34"></a><span id="l106.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l106.35"></a><span id="l106.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l106.36"></a><span id="l106.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l106.37"></a><span id="l106.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l106.38"></a><span id="l106.38" class="difflineplus">+ *</span>
<a href="#l106.39"></a><span id="l106.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l106.40"></a><span id="l106.40" class="difflineplus">+</span>
<a href="#l106.41"></a><span id="l106.41" class="difflineplus">+// This file tests the custom functions</span>
<a href="#l106.42"></a><span id="l106.42" class="difflineplus">+</span>
<a href="#l106.43"></a><span id="l106.43" class="difflineplus">+var testNums = [1, 2, 3, 4];</span>
<a href="#l106.44"></a><span id="l106.44" class="difflineplus">+</span>
<a href="#l106.45"></a><span id="l106.45" class="difflineplus">+function setup()</span>
<a href="#l106.46"></a><span id="l106.46" class="difflineplus">+{</span>
<a href="#l106.47"></a><span id="l106.47" class="difflineplus">+  getOpenedDatabase().createTable(&quot;function_tests&quot;, &quot;id INTEGER PRIMARY KEY&quot;);</span>
<a href="#l106.48"></a><span id="l106.48" class="difflineplus">+</span>
<a href="#l106.49"></a><span id="l106.49" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO function_tests (id) VALUES(?1)&quot;);</span>
<a href="#l106.50"></a><span id="l106.50" class="difflineplus">+  for(var i = 0; i &lt; testNums.length; ++i) {</span>
<a href="#l106.51"></a><span id="l106.51" class="difflineplus">+    stmt.bindInt32Parameter(0, testNums[i]);</span>
<a href="#l106.52"></a><span id="l106.52" class="difflineplus">+    stmt.execute();</span>
<a href="#l106.53"></a><span id="l106.53" class="difflineplus">+  }</span>
<a href="#l106.54"></a><span id="l106.54" class="difflineplus">+  stmt.reset();</span>
<a href="#l106.55"></a><span id="l106.55" class="difflineplus">+  stmt.finalize();</span>
<a href="#l106.56"></a><span id="l106.56" class="difflineplus">+}</span>
<a href="#l106.57"></a><span id="l106.57" class="difflineplus">+</span>
<a href="#l106.58"></a><span id="l106.58" class="difflineplus">+var testSquareFunction = {</span>
<a href="#l106.59"></a><span id="l106.59" class="difflineplus">+  calls: 0,</span>
<a href="#l106.60"></a><span id="l106.60" class="difflineplus">+</span>
<a href="#l106.61"></a><span id="l106.61" class="difflineplus">+  onFunctionCall: function(val) {</span>
<a href="#l106.62"></a><span id="l106.62" class="difflineplus">+    ++this.calls;</span>
<a href="#l106.63"></a><span id="l106.63" class="difflineplus">+    return val.getInt32(0) * val.getInt32(0);</span>
<a href="#l106.64"></a><span id="l106.64" class="difflineplus">+  }</span>
<a href="#l106.65"></a><span id="l106.65" class="difflineplus">+};</span>
<a href="#l106.66"></a><span id="l106.66" class="difflineplus">+</span>
<a href="#l106.67"></a><span id="l106.67" class="difflineplus">+function test_function_registration()</span>
<a href="#l106.68"></a><span id="l106.68" class="difflineplus">+{</span>
<a href="#l106.69"></a><span id="l106.69" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l106.70"></a><span id="l106.70" class="difflineplus">+  msc.createFunction(&quot;test_square&quot;, 1, testSquareFunction);</span>
<a href="#l106.71"></a><span id="l106.71" class="difflineplus">+}</span>
<a href="#l106.72"></a><span id="l106.72" class="difflineplus">+</span>
<a href="#l106.73"></a><span id="l106.73" class="difflineplus">+function test_function_no_double_registration()</span>
<a href="#l106.74"></a><span id="l106.74" class="difflineplus">+{</span>
<a href="#l106.75"></a><span id="l106.75" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l106.76"></a><span id="l106.76" class="difflineplus">+  try {</span>
<a href="#l106.77"></a><span id="l106.77" class="difflineplus">+    msc.createFunction(&quot;test_square&quot;, 2, testSquareFunction);</span>
<a href="#l106.78"></a><span id="l106.78" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l106.79"></a><span id="l106.79" class="difflineplus">+  } catch (e) {</span>
<a href="#l106.80"></a><span id="l106.80" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FAILURE, e.result);</span>
<a href="#l106.81"></a><span id="l106.81" class="difflineplus">+  }</span>
<a href="#l106.82"></a><span id="l106.82" class="difflineplus">+}</span>
<a href="#l106.83"></a><span id="l106.83" class="difflineplus">+</span>
<a href="#l106.84"></a><span id="l106.84" class="difflineplus">+function test_function_removal()</span>
<a href="#l106.85"></a><span id="l106.85" class="difflineplus">+{</span>
<a href="#l106.86"></a><span id="l106.86" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l106.87"></a><span id="l106.87" class="difflineplus">+  msc.removeFunction(&quot;test_square&quot;);</span>
<a href="#l106.88"></a><span id="l106.88" class="difflineplus">+  // Should be Ok now</span>
<a href="#l106.89"></a><span id="l106.89" class="difflineplus">+  msc.createFunction(&quot;test_square&quot;, 1, testSquareFunction);</span>
<a href="#l106.90"></a><span id="l106.90" class="difflineplus">+}</span>
<a href="#l106.91"></a><span id="l106.91" class="difflineplus">+</span>
<a href="#l106.92"></a><span id="l106.92" class="difflineplus">+function test_function_aliases()</span>
<a href="#l106.93"></a><span id="l106.93" class="difflineplus">+{</span>
<a href="#l106.94"></a><span id="l106.94" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l106.95"></a><span id="l106.95" class="difflineplus">+  msc.createFunction(&quot;test_square2&quot;, 1, testSquareFunction);</span>
<a href="#l106.96"></a><span id="l106.96" class="difflineplus">+}</span>
<a href="#l106.97"></a><span id="l106.97" class="difflineplus">+</span>
<a href="#l106.98"></a><span id="l106.98" class="difflineplus">+function test_function_call()</span>
<a href="#l106.99"></a><span id="l106.99" class="difflineplus">+{</span>
<a href="#l106.100"></a><span id="l106.100" class="difflineplus">+  var stmt = createStatement(&quot;SELECT test_square(id) FROM function_tests&quot;);</span>
<a href="#l106.101"></a><span id="l106.101" class="difflineplus">+  while(stmt.executeStep());</span>
<a href="#l106.102"></a><span id="l106.102" class="difflineplus">+  do_check_eq(testNums.length, testSquareFunction.calls);</span>
<a href="#l106.103"></a><span id="l106.103" class="difflineplus">+  testSquareFunction.calls = 0;</span>
<a href="#l106.104"></a><span id="l106.104" class="difflineplus">+  stmt.finalize();</span>
<a href="#l106.105"></a><span id="l106.105" class="difflineplus">+}</span>
<a href="#l106.106"></a><span id="l106.106" class="difflineplus">+</span>
<a href="#l106.107"></a><span id="l106.107" class="difflineplus">+function test_function_result()</span>
<a href="#l106.108"></a><span id="l106.108" class="difflineplus">+{</span>
<a href="#l106.109"></a><span id="l106.109" class="difflineplus">+  var stmt = createStatement(&quot;SELECT test_square(42) FROM function_tests&quot;);</span>
<a href="#l106.110"></a><span id="l106.110" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l106.111"></a><span id="l106.111" class="difflineplus">+  do_check_eq(42*42, stmt.getInt32(0));</span>
<a href="#l106.112"></a><span id="l106.112" class="difflineplus">+  testSquareFunction.calls = 0;</span>
<a href="#l106.113"></a><span id="l106.113" class="difflineplus">+  stmt.finalize();</span>
<a href="#l106.114"></a><span id="l106.114" class="difflineplus">+}</span>
<a href="#l106.115"></a><span id="l106.115" class="difflineplus">+</span>
<a href="#l106.116"></a><span id="l106.116" class="difflineplus">+var tests = [test_function_registration, test_function_no_double_registration,</span>
<a href="#l106.117"></a><span id="l106.117" class="difflineplus">+             test_function_removal, test_function_aliases, test_function_call,</span>
<a href="#l106.118"></a><span id="l106.118" class="difflineplus">+             test_function_result];</span>
<a href="#l106.119"></a><span id="l106.119" class="difflineplus">+</span>
<a href="#l106.120"></a><span id="l106.120" class="difflineplus">+function run_test()</span>
<a href="#l106.121"></a><span id="l106.121" class="difflineplus">+{</span>
<a href="#l106.122"></a><span id="l106.122" class="difflineplus">+  setup();</span>
<a href="#l106.123"></a><span id="l106.123" class="difflineplus">+</span>
<a href="#l106.124"></a><span id="l106.124" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++) {</span>
<a href="#l106.125"></a><span id="l106.125" class="difflineplus">+    tests[i]();</span>
<a href="#l106.126"></a><span id="l106.126" class="difflineplus">+  }</span>
<a href="#l106.127"></a><span id="l106.127" class="difflineplus">+</span>
<a href="#l106.128"></a><span id="l106.128" class="difflineplus">+  cleanup();</span>
<a href="#l106.129"></a><span id="l106.129" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1">new file mode 100644</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineminus">--- /dev/null</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_progresshandler.js</span>
<a href="#l107.4"></a><span id="l107.4" class="difflineat">@@ -0,0 +1,139 @@</span>
<a href="#l107.5"></a><span id="l107.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l107.6"></a><span id="l107.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l107.7"></a><span id="l107.7" class="difflineplus">+ *</span>
<a href="#l107.8"></a><span id="l107.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l107.9"></a><span id="l107.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l107.10"></a><span id="l107.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l107.11"></a><span id="l107.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineplus">+ *</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l107.14"></a><span id="l107.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l107.15"></a><span id="l107.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l107.16"></a><span id="l107.16" class="difflineplus">+ * License.</span>
<a href="#l107.17"></a><span id="l107.17" class="difflineplus">+ *</span>
<a href="#l107.18"></a><span id="l107.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l107.19"></a><span id="l107.19" class="difflineplus">+ *</span>
<a href="#l107.20"></a><span id="l107.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l107.21"></a><span id="l107.21" class="difflineplus">+ *   Lev Serebryakov &lt;lev@serebryakov.spb.ru&gt;</span>
<a href="#l107.22"></a><span id="l107.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l107.23"></a><span id="l107.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l107.24"></a><span id="l107.24" class="difflineplus">+ *</span>
<a href="#l107.25"></a><span id="l107.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l107.26"></a><span id="l107.26" class="difflineplus">+ *</span>
<a href="#l107.27"></a><span id="l107.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l107.28"></a><span id="l107.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l107.29"></a><span id="l107.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l107.30"></a><span id="l107.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l107.31"></a><span id="l107.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l107.32"></a><span id="l107.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l107.33"></a><span id="l107.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l107.34"></a><span id="l107.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l107.35"></a><span id="l107.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l107.36"></a><span id="l107.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l107.37"></a><span id="l107.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l107.38"></a><span id="l107.38" class="difflineplus">+ *</span>
<a href="#l107.39"></a><span id="l107.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l107.40"></a><span id="l107.40" class="difflineplus">+</span>
<a href="#l107.41"></a><span id="l107.41" class="difflineplus">+// This file tests the custom progress handlers</span>
<a href="#l107.42"></a><span id="l107.42" class="difflineplus">+</span>
<a href="#l107.43"></a><span id="l107.43" class="difflineplus">+function setup()</span>
<a href="#l107.44"></a><span id="l107.44" class="difflineplus">+{</span>
<a href="#l107.45"></a><span id="l107.45" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.46"></a><span id="l107.46" class="difflineplus">+  msc.createTable(&quot;handler_tests&quot;, &quot;id INTEGER PRIMARY KEY, num INTEGER&quot;);</span>
<a href="#l107.47"></a><span id="l107.47" class="difflineplus">+  msc.beginTransaction();</span>
<a href="#l107.48"></a><span id="l107.48" class="difflineplus">+</span>
<a href="#l107.49"></a><span id="l107.49" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO handler_tests (id, num) VALUES(?1, ?2)&quot;);</span>
<a href="#l107.50"></a><span id="l107.50" class="difflineplus">+  for(var i = 0; i &lt; 100; ++i) {</span>
<a href="#l107.51"></a><span id="l107.51" class="difflineplus">+    stmt.bindInt32Parameter(0, i);</span>
<a href="#l107.52"></a><span id="l107.52" class="difflineplus">+    stmt.bindInt32Parameter(1, Math.floor(Math.random()*1000));</span>
<a href="#l107.53"></a><span id="l107.53" class="difflineplus">+    stmt.execute();</span>
<a href="#l107.54"></a><span id="l107.54" class="difflineplus">+  }</span>
<a href="#l107.55"></a><span id="l107.55" class="difflineplus">+  stmt.reset();</span>
<a href="#l107.56"></a><span id="l107.56" class="difflineplus">+  msc.commitTransaction();</span>
<a href="#l107.57"></a><span id="l107.57" class="difflineplus">+  stmt.finalize();</span>
<a href="#l107.58"></a><span id="l107.58" class="difflineplus">+}</span>
<a href="#l107.59"></a><span id="l107.59" class="difflineplus">+</span>
<a href="#l107.60"></a><span id="l107.60" class="difflineplus">+var testProgressHandler = {</span>
<a href="#l107.61"></a><span id="l107.61" class="difflineplus">+  calls: 0,</span>
<a href="#l107.62"></a><span id="l107.62" class="difflineplus">+  abort: false,</span>
<a href="#l107.63"></a><span id="l107.63" class="difflineplus">+</span>
<a href="#l107.64"></a><span id="l107.64" class="difflineplus">+  onProgress: function(comm) {</span>
<a href="#l107.65"></a><span id="l107.65" class="difflineplus">+    ++this.calls;</span>
<a href="#l107.66"></a><span id="l107.66" class="difflineplus">+    return this.abort;</span>
<a href="#l107.67"></a><span id="l107.67" class="difflineplus">+  }</span>
<a href="#l107.68"></a><span id="l107.68" class="difflineplus">+};</span>
<a href="#l107.69"></a><span id="l107.69" class="difflineplus">+</span>
<a href="#l107.70"></a><span id="l107.70" class="difflineplus">+function test_handler_registration()</span>
<a href="#l107.71"></a><span id="l107.71" class="difflineplus">+{</span>
<a href="#l107.72"></a><span id="l107.72" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.73"></a><span id="l107.73" class="difflineplus">+  msc.setProgressHandler(10, testProgressHandler);</span>
<a href="#l107.74"></a><span id="l107.74" class="difflineplus">+}</span>
<a href="#l107.75"></a><span id="l107.75" class="difflineplus">+</span>
<a href="#l107.76"></a><span id="l107.76" class="difflineplus">+function test_handler_return()</span>
<a href="#l107.77"></a><span id="l107.77" class="difflineplus">+{</span>
<a href="#l107.78"></a><span id="l107.78" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.79"></a><span id="l107.79" class="difflineplus">+  var oldH = msc.setProgressHandler(5, testProgressHandler);</span>
<a href="#l107.80"></a><span id="l107.80" class="difflineplus">+  do_check_true(oldH instanceof Ci.mozIStorageProgressHandler);</span>
<a href="#l107.81"></a><span id="l107.81" class="difflineplus">+}</span>
<a href="#l107.82"></a><span id="l107.82" class="difflineplus">+</span>
<a href="#l107.83"></a><span id="l107.83" class="difflineplus">+function test_handler_removal()</span>
<a href="#l107.84"></a><span id="l107.84" class="difflineplus">+{</span>
<a href="#l107.85"></a><span id="l107.85" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.86"></a><span id="l107.86" class="difflineplus">+  msc.removeProgressHandler();</span>
<a href="#l107.87"></a><span id="l107.87" class="difflineplus">+  var oldH = msc.removeProgressHandler();</span>
<a href="#l107.88"></a><span id="l107.88" class="difflineplus">+  do_check_eq(oldH, null);</span>
<a href="#l107.89"></a><span id="l107.89" class="difflineplus">+}</span>
<a href="#l107.90"></a><span id="l107.90" class="difflineplus">+</span>
<a href="#l107.91"></a><span id="l107.91" class="difflineplus">+function test_handler_call()</span>
<a href="#l107.92"></a><span id="l107.92" class="difflineplus">+{</span>
<a href="#l107.93"></a><span id="l107.93" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.94"></a><span id="l107.94" class="difflineplus">+  msc.setProgressHandler(50, testProgressHandler);</span>
<a href="#l107.95"></a><span id="l107.95" class="difflineplus">+  // Some long-executing request</span>
<a href="#l107.96"></a><span id="l107.96" class="difflineplus">+  var stmt = createStatement(</span>
<a href="#l107.97"></a><span id="l107.97" class="difflineplus">+    &quot;SELECT SUM(t1.num * t2.num) FROM handler_tests AS t1, handler_tests AS t2&quot;);</span>
<a href="#l107.98"></a><span id="l107.98" class="difflineplus">+  while(stmt.executeStep());</span>
<a href="#l107.99"></a><span id="l107.99" class="difflineplus">+  do_check_true(testProgressHandler.calls &gt; 0);</span>
<a href="#l107.100"></a><span id="l107.100" class="difflineplus">+  stmt.finalize();</span>
<a href="#l107.101"></a><span id="l107.101" class="difflineplus">+}</span>
<a href="#l107.102"></a><span id="l107.102" class="difflineplus">+</span>
<a href="#l107.103"></a><span id="l107.103" class="difflineplus">+function test_handler_abort()</span>
<a href="#l107.104"></a><span id="l107.104" class="difflineplus">+{</span>
<a href="#l107.105"></a><span id="l107.105" class="difflineplus">+  var msc = getOpenedDatabase();</span>
<a href="#l107.106"></a><span id="l107.106" class="difflineplus">+  testProgressHandler.abort = true;</span>
<a href="#l107.107"></a><span id="l107.107" class="difflineplus">+  msc.setProgressHandler(50, testProgressHandler);</span>
<a href="#l107.108"></a><span id="l107.108" class="difflineplus">+  // Some long-executing request</span>
<a href="#l107.109"></a><span id="l107.109" class="difflineplus">+  var stmt = createStatement(</span>
<a href="#l107.110"></a><span id="l107.110" class="difflineplus">+    &quot;SELECT SUM(t1.num * t2.num) FROM handler_tests AS t1, handler_tests AS t2&quot;);</span>
<a href="#l107.111"></a><span id="l107.111" class="difflineplus">+</span>
<a href="#l107.112"></a><span id="l107.112" class="difflineplus">+  const SQLITE_INTERRUPT = 9;</span>
<a href="#l107.113"></a><span id="l107.113" class="difflineplus">+  try {</span>
<a href="#l107.114"></a><span id="l107.114" class="difflineplus">+    while(stmt.executeStep());</span>
<a href="#l107.115"></a><span id="l107.115" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l107.116"></a><span id="l107.116" class="difflineplus">+  } catch (e) {</span>
<a href="#l107.117"></a><span id="l107.117" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_ABORT, e.result);</span>
<a href="#l107.118"></a><span id="l107.118" class="difflineplus">+    do_check_eq(SQLITE_INTERRUPT, msc.lastError);</span>
<a href="#l107.119"></a><span id="l107.119" class="difflineplus">+  }</span>
<a href="#l107.120"></a><span id="l107.120" class="difflineplus">+  try {</span>
<a href="#l107.121"></a><span id="l107.121" class="difflineplus">+    stmt.finalize();</span>
<a href="#l107.122"></a><span id="l107.122" class="difflineplus">+    do_throw(&quot;We shouldn't get here!&quot;);</span>
<a href="#l107.123"></a><span id="l107.123" class="difflineplus">+  } catch (e) {</span>
<a href="#l107.124"></a><span id="l107.124" class="difflineplus">+    // finalize should return the error code since we encountered an error</span>
<a href="#l107.125"></a><span id="l107.125" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_ABORT, e.result);</span>
<a href="#l107.126"></a><span id="l107.126" class="difflineplus">+    do_check_eq(SQLITE_INTERRUPT, msc.lastError);</span>
<a href="#l107.127"></a><span id="l107.127" class="difflineplus">+  }</span>
<a href="#l107.128"></a><span id="l107.128" class="difflineplus">+}</span>
<a href="#l107.129"></a><span id="l107.129" class="difflineplus">+</span>
<a href="#l107.130"></a><span id="l107.130" class="difflineplus">+var tests = [test_handler_registration, test_handler_return,</span>
<a href="#l107.131"></a><span id="l107.131" class="difflineplus">+             test_handler_removal, test_handler_call,</span>
<a href="#l107.132"></a><span id="l107.132" class="difflineplus">+             test_handler_abort];</span>
<a href="#l107.133"></a><span id="l107.133" class="difflineplus">+</span>
<a href="#l107.134"></a><span id="l107.134" class="difflineplus">+function run_test()</span>
<a href="#l107.135"></a><span id="l107.135" class="difflineplus">+{</span>
<a href="#l107.136"></a><span id="l107.136" class="difflineplus">+  setup();</span>
<a href="#l107.137"></a><span id="l107.137" class="difflineplus">+</span>
<a href="#l107.138"></a><span id="l107.138" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++) {</span>
<a href="#l107.139"></a><span id="l107.139" class="difflineplus">+    tests[i]();</span>
<a href="#l107.140"></a><span id="l107.140" class="difflineplus">+  }</span>
<a href="#l107.141"></a><span id="l107.141" class="difflineplus">+</span>
<a href="#l107.142"></a><span id="l107.142" class="difflineplus">+  cleanup();</span>
<a href="#l107.143"></a><span id="l107.143" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1">new file mode 100644</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineminus">--- /dev/null</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_service.js</span>
<a href="#l108.4"></a><span id="l108.4" class="difflineat">@@ -0,0 +1,136 @@</span>
<a href="#l108.5"></a><span id="l108.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l108.6"></a><span id="l108.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l108.7"></a><span id="l108.7" class="difflineplus">+ *</span>
<a href="#l108.8"></a><span id="l108.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l108.9"></a><span id="l108.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l108.10"></a><span id="l108.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l108.11"></a><span id="l108.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l108.12"></a><span id="l108.12" class="difflineplus">+ *</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l108.14"></a><span id="l108.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l108.15"></a><span id="l108.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l108.16"></a><span id="l108.16" class="difflineplus">+ * License.</span>
<a href="#l108.17"></a><span id="l108.17" class="difflineplus">+ *</span>
<a href="#l108.18"></a><span id="l108.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l108.19"></a><span id="l108.19" class="difflineplus">+ *</span>
<a href="#l108.20"></a><span id="l108.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l108.21"></a><span id="l108.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l108.22"></a><span id="l108.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l108.23"></a><span id="l108.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l108.24"></a><span id="l108.24" class="difflineplus">+ *</span>
<a href="#l108.25"></a><span id="l108.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l108.26"></a><span id="l108.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l108.27"></a><span id="l108.27" class="difflineplus">+ *</span>
<a href="#l108.28"></a><span id="l108.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l108.29"></a><span id="l108.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l108.30"></a><span id="l108.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l108.31"></a><span id="l108.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l108.32"></a><span id="l108.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l108.33"></a><span id="l108.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l108.34"></a><span id="l108.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l108.35"></a><span id="l108.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l108.36"></a><span id="l108.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l108.37"></a><span id="l108.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l108.38"></a><span id="l108.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l108.39"></a><span id="l108.39" class="difflineplus">+ *</span>
<a href="#l108.40"></a><span id="l108.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l108.41"></a><span id="l108.41" class="difflineplus">+</span>
<a href="#l108.42"></a><span id="l108.42" class="difflineplus">+// This file tests the functions of mozIStorageService except for</span>
<a href="#l108.43"></a><span id="l108.43" class="difflineplus">+// openUnsharedDatabase, which is tested by test_storage_service_unshared.js.</span>
<a href="#l108.44"></a><span id="l108.44" class="difflineplus">+</span>
<a href="#l108.45"></a><span id="l108.45" class="difflineplus">+const BACKUP_FILE_NAME = &quot;test_storage.sqlite.backup&quot;;</span>
<a href="#l108.46"></a><span id="l108.46" class="difflineplus">+</span>
<a href="#l108.47"></a><span id="l108.47" class="difflineplus">+function test_openSpecialDatabase_invalid_arg()</span>
<a href="#l108.48"></a><span id="l108.48" class="difflineplus">+{</span>
<a href="#l108.49"></a><span id="l108.49" class="difflineplus">+  try {</span>
<a href="#l108.50"></a><span id="l108.50" class="difflineplus">+    getService().openSpecialDatabase(&quot;abcd&quot;);</span>
<a href="#l108.51"></a><span id="l108.51" class="difflineplus">+    do_throw(&quot;We should not get here!&quot;);</span>
<a href="#l108.52"></a><span id="l108.52" class="difflineplus">+  } catch (e) {</span>
<a href="#l108.53"></a><span id="l108.53" class="difflineplus">+    print(e);</span>
<a href="#l108.54"></a><span id="l108.54" class="difflineplus">+    print(&quot;e.result is &quot; + e.result);</span>
<a href="#l108.55"></a><span id="l108.55" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_INVALID_ARG, e.result);</span>
<a href="#l108.56"></a><span id="l108.56" class="difflineplus">+  }</span>
<a href="#l108.57"></a><span id="l108.57" class="difflineplus">+}</span>
<a href="#l108.58"></a><span id="l108.58" class="difflineplus">+</span>
<a href="#l108.59"></a><span id="l108.59" class="difflineplus">+function test_openDatabase_file_DNE()</span>
<a href="#l108.60"></a><span id="l108.60" class="difflineplus">+{</span>
<a href="#l108.61"></a><span id="l108.61" class="difflineplus">+  // the file should be created after calling</span>
<a href="#l108.62"></a><span id="l108.62" class="difflineplus">+  var db = getTestDB();</span>
<a href="#l108.63"></a><span id="l108.63" class="difflineplus">+  do_check_false(db.exists());</span>
<a href="#l108.64"></a><span id="l108.64" class="difflineplus">+  getService().openDatabase(db);</span>
<a href="#l108.65"></a><span id="l108.65" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l108.66"></a><span id="l108.66" class="difflineplus">+}</span>
<a href="#l108.67"></a><span id="l108.67" class="difflineplus">+</span>
<a href="#l108.68"></a><span id="l108.68" class="difflineplus">+function test_openDatabase_file_exists()</span>
<a href="#l108.69"></a><span id="l108.69" class="difflineplus">+{</span>
<a href="#l108.70"></a><span id="l108.70" class="difflineplus">+  // it should already exist from our last test</span>
<a href="#l108.71"></a><span id="l108.71" class="difflineplus">+  var db = getTestDB();</span>
<a href="#l108.72"></a><span id="l108.72" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l108.73"></a><span id="l108.73" class="difflineplus">+  getService().openDatabase(db);</span>
<a href="#l108.74"></a><span id="l108.74" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l108.75"></a><span id="l108.75" class="difflineplus">+}</span>
<a href="#l108.76"></a><span id="l108.76" class="difflineplus">+</span>
<a href="#l108.77"></a><span id="l108.77" class="difflineplus">+function test_corrupt_db_throws_with_openDatabase()</span>
<a href="#l108.78"></a><span id="l108.78" class="difflineplus">+{</span>
<a href="#l108.79"></a><span id="l108.79" class="difflineplus">+  try {</span>
<a href="#l108.80"></a><span id="l108.80" class="difflineplus">+    getDatabase(getCorruptDB());</span>
<a href="#l108.81"></a><span id="l108.81" class="difflineplus">+    do_throw(&quot;should not be here&quot;);</span>
<a href="#l108.82"></a><span id="l108.82" class="difflineplus">+  }</span>
<a href="#l108.83"></a><span id="l108.83" class="difflineplus">+  catch (e) {</span>
<a href="#l108.84"></a><span id="l108.84" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_FILE_CORRUPTED, e.result);</span>
<a href="#l108.85"></a><span id="l108.85" class="difflineplus">+  }</span>
<a href="#l108.86"></a><span id="l108.86" class="difflineplus">+}</span>
<a href="#l108.87"></a><span id="l108.87" class="difflineplus">+</span>
<a href="#l108.88"></a><span id="l108.88" class="difflineplus">+function test_backup_not_new_filename()</span>
<a href="#l108.89"></a><span id="l108.89" class="difflineplus">+{</span>
<a href="#l108.90"></a><span id="l108.90" class="difflineplus">+  const fname = getTestDB().leafName;</span>
<a href="#l108.91"></a><span id="l108.91" class="difflineplus">+</span>
<a href="#l108.92"></a><span id="l108.92" class="difflineplus">+  var backup = getService().backupDatabaseFile(getTestDB(), fname);</span>
<a href="#l108.93"></a><span id="l108.93" class="difflineplus">+  do_check_neq(fname, backup.leafName);</span>
<a href="#l108.94"></a><span id="l108.94" class="difflineplus">+</span>
<a href="#l108.95"></a><span id="l108.95" class="difflineplus">+  backup.remove(false);</span>
<a href="#l108.96"></a><span id="l108.96" class="difflineplus">+}</span>
<a href="#l108.97"></a><span id="l108.97" class="difflineplus">+</span>
<a href="#l108.98"></a><span id="l108.98" class="difflineplus">+function test_backup_new_filename()</span>
<a href="#l108.99"></a><span id="l108.99" class="difflineplus">+{</span>
<a href="#l108.100"></a><span id="l108.100" class="difflineplus">+  var backup = getService().backupDatabaseFile(getTestDB(), BACKUP_FILE_NAME);</span>
<a href="#l108.101"></a><span id="l108.101" class="difflineplus">+  do_check_eq(BACKUP_FILE_NAME, backup.leafName);</span>
<a href="#l108.102"></a><span id="l108.102" class="difflineplus">+  </span>
<a href="#l108.103"></a><span id="l108.103" class="difflineplus">+  backup.remove(false);</span>
<a href="#l108.104"></a><span id="l108.104" class="difflineplus">+}</span>
<a href="#l108.105"></a><span id="l108.105" class="difflineplus">+</span>
<a href="#l108.106"></a><span id="l108.106" class="difflineplus">+function test_backup_new_folder()</span>
<a href="#l108.107"></a><span id="l108.107" class="difflineplus">+{</span>
<a href="#l108.108"></a><span id="l108.108" class="difflineplus">+  var parentDir = getTestDB().parent;</span>
<a href="#l108.109"></a><span id="l108.109" class="difflineplus">+  parentDir.append(&quot;test_storage_temp&quot;);</span>
<a href="#l108.110"></a><span id="l108.110" class="difflineplus">+  if (parentDir.exists())</span>
<a href="#l108.111"></a><span id="l108.111" class="difflineplus">+    parentDir.remove(true);</span>
<a href="#l108.112"></a><span id="l108.112" class="difflineplus">+  parentDir.create(Ci.nsIFile.DIRECTORY_TYPE, 0755);</span>
<a href="#l108.113"></a><span id="l108.113" class="difflineplus">+  do_check_true(parentDir.exists());</span>
<a href="#l108.114"></a><span id="l108.114" class="difflineplus">+</span>
<a href="#l108.115"></a><span id="l108.115" class="difflineplus">+  var backup = getService().backupDatabaseFile(getTestDB(), BACKUP_FILE_NAME,</span>
<a href="#l108.116"></a><span id="l108.116" class="difflineplus">+                                               parentDir);</span>
<a href="#l108.117"></a><span id="l108.117" class="difflineplus">+  do_check_eq(BACKUP_FILE_NAME, backup.leafName);</span>
<a href="#l108.118"></a><span id="l108.118" class="difflineplus">+  do_check_true(parentDir.equals(backup.parent));</span>
<a href="#l108.119"></a><span id="l108.119" class="difflineplus">+</span>
<a href="#l108.120"></a><span id="l108.120" class="difflineplus">+  parentDir.remove(true);</span>
<a href="#l108.121"></a><span id="l108.121" class="difflineplus">+}</span>
<a href="#l108.122"></a><span id="l108.122" class="difflineplus">+</span>
<a href="#l108.123"></a><span id="l108.123" class="difflineplus">+var tests = [</span>
<a href="#l108.124"></a><span id="l108.124" class="difflineplus">+  test_openSpecialDatabase_invalid_arg,</span>
<a href="#l108.125"></a><span id="l108.125" class="difflineplus">+  test_openDatabase_file_DNE, </span>
<a href="#l108.126"></a><span id="l108.126" class="difflineplus">+  test_openDatabase_file_exists,</span>
<a href="#l108.127"></a><span id="l108.127" class="difflineplus">+  test_corrupt_db_throws_with_openDatabase,</span>
<a href="#l108.128"></a><span id="l108.128" class="difflineplus">+  test_backup_not_new_filename,</span>
<a href="#l108.129"></a><span id="l108.129" class="difflineplus">+  test_backup_new_filename,</span>
<a href="#l108.130"></a><span id="l108.130" class="difflineplus">+  test_backup_new_folder,</span>
<a href="#l108.131"></a><span id="l108.131" class="difflineplus">+];</span>
<a href="#l108.132"></a><span id="l108.132" class="difflineplus">+</span>
<a href="#l108.133"></a><span id="l108.133" class="difflineplus">+function run_test()</span>
<a href="#l108.134"></a><span id="l108.134" class="difflineplus">+{</span>
<a href="#l108.135"></a><span id="l108.135" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l108.136"></a><span id="l108.136" class="difflineplus">+    tests[i]();</span>
<a href="#l108.137"></a><span id="l108.137" class="difflineplus">+    </span>
<a href="#l108.138"></a><span id="l108.138" class="difflineplus">+  cleanup();</span>
<a href="#l108.139"></a><span id="l108.139" class="difflineplus">+}</span>
<a href="#l108.140"></a><span id="l108.140" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1">new file mode 100644</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineminus">--- /dev/null</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_service_unshared.js</span>
<a href="#l109.4"></a><span id="l109.4" class="difflineat">@@ -0,0 +1,68 @@</span>
<a href="#l109.5"></a><span id="l109.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l109.6"></a><span id="l109.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l109.7"></a><span id="l109.7" class="difflineplus">+ *</span>
<a href="#l109.8"></a><span id="l109.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l109.9"></a><span id="l109.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l109.10"></a><span id="l109.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l109.11"></a><span id="l109.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineplus">+ *</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l109.14"></a><span id="l109.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l109.15"></a><span id="l109.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l109.16"></a><span id="l109.16" class="difflineplus">+ * License.</span>
<a href="#l109.17"></a><span id="l109.17" class="difflineplus">+ *</span>
<a href="#l109.18"></a><span id="l109.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l109.19"></a><span id="l109.19" class="difflineplus">+ *</span>
<a href="#l109.20"></a><span id="l109.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l109.21"></a><span id="l109.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l109.22"></a><span id="l109.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l109.23"></a><span id="l109.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l109.24"></a><span id="l109.24" class="difflineplus">+ *</span>
<a href="#l109.25"></a><span id="l109.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l109.26"></a><span id="l109.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l109.27"></a><span id="l109.27" class="difflineplus">+ *</span>
<a href="#l109.28"></a><span id="l109.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l109.29"></a><span id="l109.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l109.30"></a><span id="l109.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l109.31"></a><span id="l109.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l109.32"></a><span id="l109.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l109.33"></a><span id="l109.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l109.34"></a><span id="l109.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l109.35"></a><span id="l109.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l109.36"></a><span id="l109.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l109.37"></a><span id="l109.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l109.38"></a><span id="l109.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l109.39"></a><span id="l109.39" class="difflineplus">+ *</span>
<a href="#l109.40"></a><span id="l109.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l109.41"></a><span id="l109.41" class="difflineplus">+</span>
<a href="#l109.42"></a><span id="l109.42" class="difflineplus">+// This file tests the openUnsharedDatabase function of mozIStorageService.</span>
<a href="#l109.43"></a><span id="l109.43" class="difflineplus">+</span>
<a href="#l109.44"></a><span id="l109.44" class="difflineplus">+function test_openUnsharedDatabase_file_DNE()</span>
<a href="#l109.45"></a><span id="l109.45" class="difflineplus">+{</span>
<a href="#l109.46"></a><span id="l109.46" class="difflineplus">+  // the file should be created after calling</span>
<a href="#l109.47"></a><span id="l109.47" class="difflineplus">+  var db = getTestDB();</span>
<a href="#l109.48"></a><span id="l109.48" class="difflineplus">+  do_check_false(db.exists());</span>
<a href="#l109.49"></a><span id="l109.49" class="difflineplus">+  getService().openUnsharedDatabase(db);</span>
<a href="#l109.50"></a><span id="l109.50" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l109.51"></a><span id="l109.51" class="difflineplus">+}</span>
<a href="#l109.52"></a><span id="l109.52" class="difflineplus">+</span>
<a href="#l109.53"></a><span id="l109.53" class="difflineplus">+function test_openUnsharedDatabase_file_exists()</span>
<a href="#l109.54"></a><span id="l109.54" class="difflineplus">+{</span>
<a href="#l109.55"></a><span id="l109.55" class="difflineplus">+  // it should already exist from our last test</span>
<a href="#l109.56"></a><span id="l109.56" class="difflineplus">+  var db = getTestDB();</span>
<a href="#l109.57"></a><span id="l109.57" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l109.58"></a><span id="l109.58" class="difflineplus">+  getService().openUnsharedDatabase(db);</span>
<a href="#l109.59"></a><span id="l109.59" class="difflineplus">+  do_check_true(db.exists());</span>
<a href="#l109.60"></a><span id="l109.60" class="difflineplus">+}</span>
<a href="#l109.61"></a><span id="l109.61" class="difflineplus">+</span>
<a href="#l109.62"></a><span id="l109.62" class="difflineplus">+var tests = [test_openUnsharedDatabase_file_DNE,</span>
<a href="#l109.63"></a><span id="l109.63" class="difflineplus">+             test_openUnsharedDatabase_file_exists];</span>
<a href="#l109.64"></a><span id="l109.64" class="difflineplus">+</span>
<a href="#l109.65"></a><span id="l109.65" class="difflineplus">+function run_test()</span>
<a href="#l109.66"></a><span id="l109.66" class="difflineplus">+{</span>
<a href="#l109.67"></a><span id="l109.67" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l109.68"></a><span id="l109.68" class="difflineplus">+    tests[i]();</span>
<a href="#l109.69"></a><span id="l109.69" class="difflineplus">+    </span>
<a href="#l109.70"></a><span id="l109.70" class="difflineplus">+  cleanup();</span>
<a href="#l109.71"></a><span id="l109.71" class="difflineplus">+}</span>
<a href="#l109.72"></a><span id="l109.72" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1">new file mode 100644</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineminus">--- /dev/null</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_statement.js</span>
<a href="#l110.4"></a><span id="l110.4" class="difflineat">@@ -0,0 +1,197 @@</span>
<a href="#l110.5"></a><span id="l110.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l110.6"></a><span id="l110.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l110.7"></a><span id="l110.7" class="difflineplus">+ *</span>
<a href="#l110.8"></a><span id="l110.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l110.9"></a><span id="l110.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l110.10"></a><span id="l110.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l110.11"></a><span id="l110.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l110.12"></a><span id="l110.12" class="difflineplus">+ *</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l110.14"></a><span id="l110.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l110.15"></a><span id="l110.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l110.16"></a><span id="l110.16" class="difflineplus">+ * License.</span>
<a href="#l110.17"></a><span id="l110.17" class="difflineplus">+ *</span>
<a href="#l110.18"></a><span id="l110.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l110.19"></a><span id="l110.19" class="difflineplus">+ *</span>
<a href="#l110.20"></a><span id="l110.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l110.21"></a><span id="l110.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l110.22"></a><span id="l110.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l110.23"></a><span id="l110.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l110.24"></a><span id="l110.24" class="difflineplus">+ *</span>
<a href="#l110.25"></a><span id="l110.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l110.26"></a><span id="l110.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l110.27"></a><span id="l110.27" class="difflineplus">+ *</span>
<a href="#l110.28"></a><span id="l110.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l110.29"></a><span id="l110.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l110.30"></a><span id="l110.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l110.31"></a><span id="l110.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l110.32"></a><span id="l110.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l110.33"></a><span id="l110.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l110.34"></a><span id="l110.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l110.35"></a><span id="l110.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l110.36"></a><span id="l110.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l110.37"></a><span id="l110.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l110.38"></a><span id="l110.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l110.39"></a><span id="l110.39" class="difflineplus">+ *</span>
<a href="#l110.40"></a><span id="l110.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l110.41"></a><span id="l110.41" class="difflineplus">+</span>
<a href="#l110.42"></a><span id="l110.42" class="difflineplus">+// This file tests the functions of mozIStorageStatement</span>
<a href="#l110.43"></a><span id="l110.43" class="difflineplus">+</span>
<a href="#l110.44"></a><span id="l110.44" class="difflineplus">+function setup()</span>
<a href="#l110.45"></a><span id="l110.45" class="difflineplus">+{</span>
<a href="#l110.46"></a><span id="l110.46" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, name TEXT&quot;);</span>
<a href="#l110.47"></a><span id="l110.47" class="difflineplus">+}</span>
<a href="#l110.48"></a><span id="l110.48" class="difflineplus">+</span>
<a href="#l110.49"></a><span id="l110.49" class="difflineplus">+function test_parameterCount_none()</span>
<a href="#l110.50"></a><span id="l110.50" class="difflineplus">+{</span>
<a href="#l110.51"></a><span id="l110.51" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test&quot;);</span>
<a href="#l110.52"></a><span id="l110.52" class="difflineplus">+  do_check_eq(0, stmt.parameterCount);</span>
<a href="#l110.53"></a><span id="l110.53" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.54"></a><span id="l110.54" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.55"></a><span id="l110.55" class="difflineplus">+}</span>
<a href="#l110.56"></a><span id="l110.56" class="difflineplus">+</span>
<a href="#l110.57"></a><span id="l110.57" class="difflineplus">+function test_parameterCount_one()</span>
<a href="#l110.58"></a><span id="l110.58" class="difflineplus">+{</span>
<a href="#l110.59"></a><span id="l110.59" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = ?1&quot;);</span>
<a href="#l110.60"></a><span id="l110.60" class="difflineplus">+  do_check_eq(1, stmt.parameterCount);</span>
<a href="#l110.61"></a><span id="l110.61" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.62"></a><span id="l110.62" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.63"></a><span id="l110.63" class="difflineplus">+}</span>
<a href="#l110.64"></a><span id="l110.64" class="difflineplus">+</span>
<a href="#l110.65"></a><span id="l110.65" class="difflineplus">+function test_getParameterName()</span>
<a href="#l110.66"></a><span id="l110.66" class="difflineplus">+{</span>
<a href="#l110.67"></a><span id="l110.67" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = :id&quot;);</span>
<a href="#l110.68"></a><span id="l110.68" class="difflineplus">+  do_check_eq(&quot;:id&quot;, stmt.getParameterName(0));</span>
<a href="#l110.69"></a><span id="l110.69" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.70"></a><span id="l110.70" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.71"></a><span id="l110.71" class="difflineplus">+}</span>
<a href="#l110.72"></a><span id="l110.72" class="difflineplus">+</span>
<a href="#l110.73"></a><span id="l110.73" class="difflineplus">+function test_getParameterIndex_different()</span>
<a href="#l110.74"></a><span id="l110.74" class="difflineplus">+{</span>
<a href="#l110.75"></a><span id="l110.75" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = :id OR name = :name&quot;);</span>
<a href="#l110.76"></a><span id="l110.76" class="difflineplus">+  do_check_eq(0, stmt.getParameterIndex(&quot;id&quot;));</span>
<a href="#l110.77"></a><span id="l110.77" class="difflineplus">+  do_check_eq(1, stmt.getParameterIndex(&quot;name&quot;));</span>
<a href="#l110.78"></a><span id="l110.78" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.79"></a><span id="l110.79" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.80"></a><span id="l110.80" class="difflineplus">+}</span>
<a href="#l110.81"></a><span id="l110.81" class="difflineplus">+</span>
<a href="#l110.82"></a><span id="l110.82" class="difflineplus">+function test_getParameterIndex_same()</span>
<a href="#l110.83"></a><span id="l110.83" class="difflineplus">+{</span>
<a href="#l110.84"></a><span id="l110.84" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = :test OR name = :test&quot;);</span>
<a href="#l110.85"></a><span id="l110.85" class="difflineplus">+  do_check_eq(0, stmt.getParameterIndex(&quot;test&quot;));</span>
<a href="#l110.86"></a><span id="l110.86" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.87"></a><span id="l110.87" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.88"></a><span id="l110.88" class="difflineplus">+}</span>
<a href="#l110.89"></a><span id="l110.89" class="difflineplus">+</span>
<a href="#l110.90"></a><span id="l110.90" class="difflineplus">+function test_columnCount()</span>
<a href="#l110.91"></a><span id="l110.91" class="difflineplus">+{</span>
<a href="#l110.92"></a><span id="l110.92" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = ?1 OR name = ?2&quot;);</span>
<a href="#l110.93"></a><span id="l110.93" class="difflineplus">+  do_check_eq(2, stmt.columnCount);</span>
<a href="#l110.94"></a><span id="l110.94" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.95"></a><span id="l110.95" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.96"></a><span id="l110.96" class="difflineplus">+}</span>
<a href="#l110.97"></a><span id="l110.97" class="difflineplus">+</span>
<a href="#l110.98"></a><span id="l110.98" class="difflineplus">+function test_getColumnName()</span>
<a href="#l110.99"></a><span id="l110.99" class="difflineplus">+{</span>
<a href="#l110.100"></a><span id="l110.100" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.101"></a><span id="l110.101" class="difflineplus">+  do_check_eq(&quot;id&quot;, stmt.getColumnName(1));</span>
<a href="#l110.102"></a><span id="l110.102" class="difflineplus">+  do_check_eq(&quot;name&quot;, stmt.getColumnName(0));</span>
<a href="#l110.103"></a><span id="l110.103" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.104"></a><span id="l110.104" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.105"></a><span id="l110.105" class="difflineplus">+}</span>
<a href="#l110.106"></a><span id="l110.106" class="difflineplus">+</span>
<a href="#l110.107"></a><span id="l110.107" class="difflineplus">+function test_getColumnIndex_same_case()</span>
<a href="#l110.108"></a><span id="l110.108" class="difflineplus">+{</span>
<a href="#l110.109"></a><span id="l110.109" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.110"></a><span id="l110.110" class="difflineplus">+  do_check_eq(0, stmt.getColumnIndex(&quot;name&quot;));</span>
<a href="#l110.111"></a><span id="l110.111" class="difflineplus">+  do_check_eq(1, stmt.getColumnIndex(&quot;id&quot;));</span>
<a href="#l110.112"></a><span id="l110.112" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.113"></a><span id="l110.113" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.114"></a><span id="l110.114" class="difflineplus">+}</span>
<a href="#l110.115"></a><span id="l110.115" class="difflineplus">+</span>
<a href="#l110.116"></a><span id="l110.116" class="difflineplus">+function test_getColumnIndex_different_case()</span>
<a href="#l110.117"></a><span id="l110.117" class="difflineplus">+{</span>
<a href="#l110.118"></a><span id="l110.118" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.119"></a><span id="l110.119" class="difflineplus">+  try {</span>
<a href="#l110.120"></a><span id="l110.120" class="difflineplus">+    do_check_eq(0, stmt.getColumnIndex(&quot;NaMe&quot;));</span>
<a href="#l110.121"></a><span id="l110.121" class="difflineplus">+    do_throw(&quot;should not get here&quot;);</span>
<a href="#l110.122"></a><span id="l110.122" class="difflineplus">+  } catch (e) {</span>
<a href="#l110.123"></a><span id="l110.123" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_INVALID_ARG, e.result);</span>
<a href="#l110.124"></a><span id="l110.124" class="difflineplus">+  }</span>
<a href="#l110.125"></a><span id="l110.125" class="difflineplus">+  try {</span>
<a href="#l110.126"></a><span id="l110.126" class="difflineplus">+  do_check_eq(1, stmt.getColumnIndex(&quot;Id&quot;));</span>
<a href="#l110.127"></a><span id="l110.127" class="difflineplus">+    do_throw(&quot;should not get here&quot;);</span>
<a href="#l110.128"></a><span id="l110.128" class="difflineplus">+  } catch (e) {</span>
<a href="#l110.129"></a><span id="l110.129" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_INVALID_ARG, e.result);</span>
<a href="#l110.130"></a><span id="l110.130" class="difflineplus">+  }</span>
<a href="#l110.131"></a><span id="l110.131" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.132"></a><span id="l110.132" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.133"></a><span id="l110.133" class="difflineplus">+}</span>
<a href="#l110.134"></a><span id="l110.134" class="difflineplus">+</span>
<a href="#l110.135"></a><span id="l110.135" class="difflineplus">+function test_state_ready()</span>
<a href="#l110.136"></a><span id="l110.136" class="difflineplus">+{</span>
<a href="#l110.137"></a><span id="l110.137" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.138"></a><span id="l110.138" class="difflineplus">+  do_check_eq(Ci.mozIStorageStatement.MOZ_STORAGE_STATEMENT_READY, stmt.state);</span>
<a href="#l110.139"></a><span id="l110.139" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.140"></a><span id="l110.140" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.141"></a><span id="l110.141" class="difflineplus">+}</span>
<a href="#l110.142"></a><span id="l110.142" class="difflineplus">+</span>
<a href="#l110.143"></a><span id="l110.143" class="difflineplus">+function test_state_executing()</span>
<a href="#l110.144"></a><span id="l110.144" class="difflineplus">+{</span>
<a href="#l110.145"></a><span id="l110.145" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (name) VALUES ('foo')&quot;);</span>
<a href="#l110.146"></a><span id="l110.146" class="difflineplus">+  stmt.execute();</span>
<a href="#l110.147"></a><span id="l110.147" class="difflineplus">+  stmt.execute();</span>
<a href="#l110.148"></a><span id="l110.148" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.149"></a><span id="l110.149" class="difflineplus">+</span>
<a href="#l110.150"></a><span id="l110.150" class="difflineplus">+  stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.151"></a><span id="l110.151" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l110.152"></a><span id="l110.152" class="difflineplus">+  do_check_eq(Ci.mozIStorageStatement.MOZ_STORAGE_STATEMENT_EXECUTING,</span>
<a href="#l110.153"></a><span id="l110.153" class="difflineplus">+              stmt.state);</span>
<a href="#l110.154"></a><span id="l110.154" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l110.155"></a><span id="l110.155" class="difflineplus">+  do_check_eq(Ci.mozIStorageStatement.MOZ_STORAGE_STATEMENT_EXECUTING,</span>
<a href="#l110.156"></a><span id="l110.156" class="difflineplus">+              stmt.state);</span>
<a href="#l110.157"></a><span id="l110.157" class="difflineplus">+  stmt.reset();</span>
<a href="#l110.158"></a><span id="l110.158" class="difflineplus">+  do_check_eq(Ci.mozIStorageStatement.MOZ_STORAGE_STATEMENT_READY, stmt.state);</span>
<a href="#l110.159"></a><span id="l110.159" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.160"></a><span id="l110.160" class="difflineplus">+}</span>
<a href="#l110.161"></a><span id="l110.161" class="difflineplus">+</span>
<a href="#l110.162"></a><span id="l110.162" class="difflineplus">+function test_state_after_finalize()</span>
<a href="#l110.163"></a><span id="l110.163" class="difflineplus">+{</span>
<a href="#l110.164"></a><span id="l110.164" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.165"></a><span id="l110.165" class="difflineplus">+  stmt.executeStep();</span>
<a href="#l110.166"></a><span id="l110.166" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.167"></a><span id="l110.167" class="difflineplus">+  do_check_eq(Ci.mozIStorageStatement.MOZ_STORAGE_STATEMENT_INVALID, stmt.state);</span>
<a href="#l110.168"></a><span id="l110.168" class="difflineplus">+}</span>
<a href="#l110.169"></a><span id="l110.169" class="difflineplus">+</span>
<a href="#l110.170"></a><span id="l110.170" class="difflineplus">+function test_getColumnDecltype()</span>
<a href="#l110.171"></a><span id="l110.171" class="difflineplus">+{</span>
<a href="#l110.172"></a><span id="l110.172" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test&quot;);</span>
<a href="#l110.173"></a><span id="l110.173" class="difflineplus">+  do_check_eq(&quot;TEXT&quot;, stmt.getColumnDecltype(0));</span>
<a href="#l110.174"></a><span id="l110.174" class="difflineplus">+  do_check_eq(&quot;INTEGER&quot;, stmt.getColumnDecltype(1));</span>
<a href="#l110.175"></a><span id="l110.175" class="difflineplus">+  try {</span>
<a href="#l110.176"></a><span id="l110.176" class="difflineplus">+    do_check_eq(&quot;GARBAGE&quot;, stmt.getColumnDecltype(2));</span>
<a href="#l110.177"></a><span id="l110.177" class="difflineplus">+    do_throw(&quot;should not get here&quot;);</span>
<a href="#l110.178"></a><span id="l110.178" class="difflineplus">+  } catch (e) {</span>
<a href="#l110.179"></a><span id="l110.179" class="difflineplus">+    do_check_eq(Cr.NS_ERROR_ILLEGAL_VALUE, e.result);</span>
<a href="#l110.180"></a><span id="l110.180" class="difflineplus">+  }</span>
<a href="#l110.181"></a><span id="l110.181" class="difflineplus">+  stmt.finalize();</span>
<a href="#l110.182"></a><span id="l110.182" class="difflineplus">+}</span>
<a href="#l110.183"></a><span id="l110.183" class="difflineplus">+</span>
<a href="#l110.184"></a><span id="l110.184" class="difflineplus">+var tests = [test_parameterCount_none, test_parameterCount_one,</span>
<a href="#l110.185"></a><span id="l110.185" class="difflineplus">+             test_getParameterName, test_getParameterIndex_different,</span>
<a href="#l110.186"></a><span id="l110.186" class="difflineplus">+             test_getParameterIndex_same, test_columnCount,</span>
<a href="#l110.187"></a><span id="l110.187" class="difflineplus">+             test_getColumnName, test_getColumnIndex_same_case,</span>
<a href="#l110.188"></a><span id="l110.188" class="difflineplus">+             test_getColumnIndex_different_case, test_state_ready,</span>
<a href="#l110.189"></a><span id="l110.189" class="difflineplus">+             test_state_executing, test_state_after_finalize,</span>
<a href="#l110.190"></a><span id="l110.190" class="difflineplus">+             test_getColumnDecltype];</span>
<a href="#l110.191"></a><span id="l110.191" class="difflineplus">+</span>
<a href="#l110.192"></a><span id="l110.192" class="difflineplus">+function run_test()</span>
<a href="#l110.193"></a><span id="l110.193" class="difflineplus">+{</span>
<a href="#l110.194"></a><span id="l110.194" class="difflineplus">+  setup();</span>
<a href="#l110.195"></a><span id="l110.195" class="difflineplus">+</span>
<a href="#l110.196"></a><span id="l110.196" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l110.197"></a><span id="l110.197" class="difflineplus">+    tests[i]();</span>
<a href="#l110.198"></a><span id="l110.198" class="difflineplus">+    </span>
<a href="#l110.199"></a><span id="l110.199" class="difflineplus">+  cleanup();</span>
<a href="#l110.200"></a><span id="l110.200" class="difflineplus">+}</span>
<a href="#l110.201"></a><span id="l110.201" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1">new file mode 100644</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineminus">--- /dev/null</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_statement_wrapper.js</span>
<a href="#l111.4"></a><span id="l111.4" class="difflineat">@@ -0,0 +1,213 @@</span>
<a href="#l111.5"></a><span id="l111.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l111.6"></a><span id="l111.6" class="difflineplus">+   vim:set ts=2 sw=2 sts=2 et:</span>
<a href="#l111.7"></a><span id="l111.7" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l111.8"></a><span id="l111.8" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l111.9"></a><span id="l111.9" class="difflineplus">+ *</span>
<a href="#l111.10"></a><span id="l111.10" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l111.11"></a><span id="l111.11" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l111.14"></a><span id="l111.14" class="difflineplus">+ *</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l111.16"></a><span id="l111.16" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l111.17"></a><span id="l111.17" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l111.18"></a><span id="l111.18" class="difflineplus">+ * License.</span>
<a href="#l111.19"></a><span id="l111.19" class="difflineplus">+ *</span>
<a href="#l111.20"></a><span id="l111.20" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l111.21"></a><span id="l111.21" class="difflineplus">+ *</span>
<a href="#l111.22"></a><span id="l111.22" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l111.23"></a><span id="l111.23" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l111.24"></a><span id="l111.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l111.25"></a><span id="l111.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l111.26"></a><span id="l111.26" class="difflineplus">+ *</span>
<a href="#l111.27"></a><span id="l111.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l111.28"></a><span id="l111.28" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l111.29"></a><span id="l111.29" class="difflineplus">+ *   Drew Willcoxon &lt;adw@mozilla.com&gt;</span>
<a href="#l111.30"></a><span id="l111.30" class="difflineplus">+ *</span>
<a href="#l111.31"></a><span id="l111.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l111.32"></a><span id="l111.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l111.33"></a><span id="l111.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l111.34"></a><span id="l111.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l111.35"></a><span id="l111.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l111.36"></a><span id="l111.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l111.37"></a><span id="l111.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l111.38"></a><span id="l111.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l111.39"></a><span id="l111.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l111.40"></a><span id="l111.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l111.41"></a><span id="l111.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l111.42"></a><span id="l111.42" class="difflineplus">+ *</span>
<a href="#l111.43"></a><span id="l111.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l111.44"></a><span id="l111.44" class="difflineplus">+</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineplus">+// This file tests the functions of mozIStorageStatementWrapper</span>
<a href="#l111.46"></a><span id="l111.46" class="difflineplus">+</span>
<a href="#l111.47"></a><span id="l111.47" class="difflineplus">+function setup()</span>
<a href="#l111.48"></a><span id="l111.48" class="difflineplus">+{</span>
<a href="#l111.49"></a><span id="l111.49" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, val NONE,&quot; +</span>
<a href="#l111.50"></a><span id="l111.50" class="difflineplus">+                                          &quot;alt_val NONE&quot;);</span>
<a href="#l111.51"></a><span id="l111.51" class="difflineplus">+}</span>
<a href="#l111.52"></a><span id="l111.52" class="difflineplus">+</span>
<a href="#l111.53"></a><span id="l111.53" class="difflineplus">+var wrapper = new Components.Constructor(&quot;@mozilla.org/storage/statement-wrapper;1&quot;,</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineplus">+                                         Ci.mozIStorageStatementWrapper,</span>
<a href="#l111.55"></a><span id="l111.55" class="difflineplus">+                                         &quot;initialize&quot;);</span>
<a href="#l111.56"></a><span id="l111.56" class="difflineplus">+</span>
<a href="#l111.57"></a><span id="l111.57" class="difflineplus">+// we want to override the default function for this file</span>
<a href="#l111.58"></a><span id="l111.58" class="difflineplus">+createStatement = function(aSQL) {</span>
<a href="#l111.59"></a><span id="l111.59" class="difflineplus">+  return new wrapper(getOpenedDatabase().createStatement(aSQL));</span>
<a href="#l111.60"></a><span id="l111.60" class="difflineplus">+}</span>
<a href="#l111.61"></a><span id="l111.61" class="difflineplus">+</span>
<a href="#l111.62"></a><span id="l111.62" class="difflineplus">+/**</span>
<a href="#l111.63"></a><span id="l111.63" class="difflineplus">+ * A convenience wrapper for do_check_eq.  Calls do_check_eq on aActualVal</span>
<a href="#l111.64"></a><span id="l111.64" class="difflineplus">+ * and aReturnedVal, with one caveat.</span>
<a href="#l111.65"></a><span id="l111.65" class="difflineplus">+ *</span>
<a href="#l111.66"></a><span id="l111.66" class="difflineplus">+ * Date objects are converted before parameter binding to PRTime's (microsecs</span>
<a href="#l111.67"></a><span id="l111.67" class="difflineplus">+ * since epoch).  They are not reconverted when retrieved from the database.</span>
<a href="#l111.68"></a><span id="l111.68" class="difflineplus">+ * This function abstracts away this reconversion so that you can pass in,</span>
<a href="#l111.69"></a><span id="l111.69" class="difflineplus">+ * for example:</span>
<a href="#l111.70"></a><span id="l111.70" class="difflineplus">+ *</span>
<a href="#l111.71"></a><span id="l111.71" class="difflineplus">+ *   checkVal(new Date(), aReturnedVal)                    // this</span>
<a href="#l111.72"></a><span id="l111.72" class="difflineplus">+ *   checkVal(new Date().valueOf() * 1000.0, aReturnedVal) // instead of this</span>
<a href="#l111.73"></a><span id="l111.73" class="difflineplus">+ *</span>
<a href="#l111.74"></a><span id="l111.74" class="difflineplus">+ * Should any other types require conversion in the future, their conversions</span>
<a href="#l111.75"></a><span id="l111.75" class="difflineplus">+ * may also be abstracted away here.</span>
<a href="#l111.76"></a><span id="l111.76" class="difflineplus">+ *</span>
<a href="#l111.77"></a><span id="l111.77" class="difflineplus">+ * @param aActualVal</span>
<a href="#l111.78"></a><span id="l111.78" class="difflineplus">+ *        the value inserted into the database</span>
<a href="#l111.79"></a><span id="l111.79" class="difflineplus">+ * @param aReturnedVal</span>
<a href="#l111.80"></a><span id="l111.80" class="difflineplus">+ *        the value retrieved from the database</span>
<a href="#l111.81"></a><span id="l111.81" class="difflineplus">+ */</span>
<a href="#l111.82"></a><span id="l111.82" class="difflineplus">+function checkVal(aActualVal, aReturnedVal)</span>
<a href="#l111.83"></a><span id="l111.83" class="difflineplus">+{</span>
<a href="#l111.84"></a><span id="l111.84" class="difflineplus">+  if (aActualVal instanceof Date) aActualVal = aActualVal.valueOf() * 1000.0;</span>
<a href="#l111.85"></a><span id="l111.85" class="difflineplus">+  do_check_eq(aActualVal, aReturnedVal);</span>
<a href="#l111.86"></a><span id="l111.86" class="difflineplus">+}</span>
<a href="#l111.87"></a><span id="l111.87" class="difflineplus">+</span>
<a href="#l111.88"></a><span id="l111.88" class="difflineplus">+/**</span>
<a href="#l111.89"></a><span id="l111.89" class="difflineplus">+ * Removes all rows from our test table.</span>
<a href="#l111.90"></a><span id="l111.90" class="difflineplus">+ */</span>
<a href="#l111.91"></a><span id="l111.91" class="difflineplus">+function clearTable()</span>
<a href="#l111.92"></a><span id="l111.92" class="difflineplus">+{</span>
<a href="#l111.93"></a><span id="l111.93" class="difflineplus">+  var stmt = createStatement(&quot;DELETE FROM test&quot;);</span>
<a href="#l111.94"></a><span id="l111.94" class="difflineplus">+  stmt.execute();</span>
<a href="#l111.95"></a><span id="l111.95" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.96"></a><span id="l111.96" class="difflineplus">+  ensureNumRows(0);</span>
<a href="#l111.97"></a><span id="l111.97" class="difflineplus">+}</span>
<a href="#l111.98"></a><span id="l111.98" class="difflineplus">+</span>
<a href="#l111.99"></a><span id="l111.99" class="difflineplus">+/**</span>
<a href="#l111.100"></a><span id="l111.100" class="difflineplus">+ * Ensures that the number of rows in our test table is equal to aNumRows.</span>
<a href="#l111.101"></a><span id="l111.101" class="difflineplus">+ * Calls do_check_eq on aNumRows and the value retrieved by SELECT'ing COUNT(*).</span>
<a href="#l111.102"></a><span id="l111.102" class="difflineplus">+ *</span>
<a href="#l111.103"></a><span id="l111.103" class="difflineplus">+ * @param aNumRows</span>
<a href="#l111.104"></a><span id="l111.104" class="difflineplus">+ *        the number of rows our test table should contain</span>
<a href="#l111.105"></a><span id="l111.105" class="difflineplus">+ */</span>
<a href="#l111.106"></a><span id="l111.106" class="difflineplus">+function ensureNumRows(aNumRows)</span>
<a href="#l111.107"></a><span id="l111.107" class="difflineplus">+{</span>
<a href="#l111.108"></a><span id="l111.108" class="difflineplus">+  var stmt = createStatement(&quot;SELECT COUNT(*) AS number FROM test&quot;);</span>
<a href="#l111.109"></a><span id="l111.109" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l111.110"></a><span id="l111.110" class="difflineplus">+  do_check_eq(aNumRows, stmt.row.number);</span>
<a href="#l111.111"></a><span id="l111.111" class="difflineplus">+  stmt.reset();</span>
<a href="#l111.112"></a><span id="l111.112" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.113"></a><span id="l111.113" class="difflineplus">+}</span>
<a href="#l111.114"></a><span id="l111.114" class="difflineplus">+</span>
<a href="#l111.115"></a><span id="l111.115" class="difflineplus">+/**</span>
<a href="#l111.116"></a><span id="l111.116" class="difflineplus">+ * Inserts aVal into our test table and checks that insertion was successful by</span>
<a href="#l111.117"></a><span id="l111.117" class="difflineplus">+ * retrieving the newly inserted value from the database and comparing it</span>
<a href="#l111.118"></a><span id="l111.118" class="difflineplus">+ * against aVal.  aVal is bound to a single parameter.</span>
<a href="#l111.119"></a><span id="l111.119" class="difflineplus">+ *</span>
<a href="#l111.120"></a><span id="l111.120" class="difflineplus">+ * @param aVal</span>
<a href="#l111.121"></a><span id="l111.121" class="difflineplus">+ *        value to insert into our test table and check</span>
<a href="#l111.122"></a><span id="l111.122" class="difflineplus">+ */</span>
<a href="#l111.123"></a><span id="l111.123" class="difflineplus">+function insertAndCheckSingleParam(aVal)</span>
<a href="#l111.124"></a><span id="l111.124" class="difflineplus">+{</span>
<a href="#l111.125"></a><span id="l111.125" class="difflineplus">+  clearTable();</span>
<a href="#l111.126"></a><span id="l111.126" class="difflineplus">+</span>
<a href="#l111.127"></a><span id="l111.127" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (val) VALUES (:val)&quot;);</span>
<a href="#l111.128"></a><span id="l111.128" class="difflineplus">+  stmt.params.val = aVal;</span>
<a href="#l111.129"></a><span id="l111.129" class="difflineplus">+  stmt.execute();</span>
<a href="#l111.130"></a><span id="l111.130" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.131"></a><span id="l111.131" class="difflineplus">+</span>
<a href="#l111.132"></a><span id="l111.132" class="difflineplus">+  ensureNumRows(1);</span>
<a href="#l111.133"></a><span id="l111.133" class="difflineplus">+</span>
<a href="#l111.134"></a><span id="l111.134" class="difflineplus">+  stmt = createStatement(&quot;SELECT val FROM test WHERE id = 1&quot;);</span>
<a href="#l111.135"></a><span id="l111.135" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l111.136"></a><span id="l111.136" class="difflineplus">+  checkVal(aVal, stmt.row.val);</span>
<a href="#l111.137"></a><span id="l111.137" class="difflineplus">+  stmt.reset();</span>
<a href="#l111.138"></a><span id="l111.138" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.139"></a><span id="l111.139" class="difflineplus">+}</span>
<a href="#l111.140"></a><span id="l111.140" class="difflineplus">+</span>
<a href="#l111.141"></a><span id="l111.141" class="difflineplus">+/**</span>
<a href="#l111.142"></a><span id="l111.142" class="difflineplus">+ * Inserts aVal into our test table and checks that insertion was successful by</span>
<a href="#l111.143"></a><span id="l111.143" class="difflineplus">+ * retrieving the newly inserted value from the database and comparing it</span>
<a href="#l111.144"></a><span id="l111.144" class="difflineplus">+ * against aVal.  aVal is bound to two separate parameters, both of which are</span>
<a href="#l111.145"></a><span id="l111.145" class="difflineplus">+ * checked against aVal.</span>
<a href="#l111.146"></a><span id="l111.146" class="difflineplus">+ *</span>
<a href="#l111.147"></a><span id="l111.147" class="difflineplus">+ * @param aVal</span>
<a href="#l111.148"></a><span id="l111.148" class="difflineplus">+ *        value to insert into our test table and check</span>
<a href="#l111.149"></a><span id="l111.149" class="difflineplus">+ */</span>
<a href="#l111.150"></a><span id="l111.150" class="difflineplus">+function insertAndCheckMultipleParams(aVal)</span>
<a href="#l111.151"></a><span id="l111.151" class="difflineplus">+{</span>
<a href="#l111.152"></a><span id="l111.152" class="difflineplus">+  clearTable();</span>
<a href="#l111.153"></a><span id="l111.153" class="difflineplus">+</span>
<a href="#l111.154"></a><span id="l111.154" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (val, alt_val) &quot; +</span>
<a href="#l111.155"></a><span id="l111.155" class="difflineplus">+                             &quot;VALUES (:val, :val)&quot;);</span>
<a href="#l111.156"></a><span id="l111.156" class="difflineplus">+  stmt.params.val = aVal;</span>
<a href="#l111.157"></a><span id="l111.157" class="difflineplus">+  stmt.execute();</span>
<a href="#l111.158"></a><span id="l111.158" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.159"></a><span id="l111.159" class="difflineplus">+</span>
<a href="#l111.160"></a><span id="l111.160" class="difflineplus">+  ensureNumRows(1);</span>
<a href="#l111.161"></a><span id="l111.161" class="difflineplus">+</span>
<a href="#l111.162"></a><span id="l111.162" class="difflineplus">+  stmt = createStatement(&quot;SELECT val, alt_val FROM test WHERE id = 1&quot;);</span>
<a href="#l111.163"></a><span id="l111.163" class="difflineplus">+  do_check_true(stmt.step());</span>
<a href="#l111.164"></a><span id="l111.164" class="difflineplus">+  checkVal(aVal, stmt.row.val);</span>
<a href="#l111.165"></a><span id="l111.165" class="difflineplus">+  checkVal(aVal, stmt.row.alt_val);</span>
<a href="#l111.166"></a><span id="l111.166" class="difflineplus">+  stmt.reset();</span>
<a href="#l111.167"></a><span id="l111.167" class="difflineplus">+  stmt.statement.finalize();</span>
<a href="#l111.168"></a><span id="l111.168" class="difflineplus">+}</span>
<a href="#l111.169"></a><span id="l111.169" class="difflineplus">+</span>
<a href="#l111.170"></a><span id="l111.170" class="difflineplus">+/**</span>
<a href="#l111.171"></a><span id="l111.171" class="difflineplus">+ * A convenience function that prints out a description of aVal using</span>
<a href="#l111.172"></a><span id="l111.172" class="difflineplus">+ * aVal.toString and aVal.toSource.  Output is useful when the test fails.</span>
<a href="#l111.173"></a><span id="l111.173" class="difflineplus">+ *</span>
<a href="#l111.174"></a><span id="l111.174" class="difflineplus">+ * @param aVal</span>
<a href="#l111.175"></a><span id="l111.175" class="difflineplus">+ *        a value inserted or to be inserted into our test table</span>
<a href="#l111.176"></a><span id="l111.176" class="difflineplus">+ */</span>
<a href="#l111.177"></a><span id="l111.177" class="difflineplus">+function printValDesc(aVal)</span>
<a href="#l111.178"></a><span id="l111.178" class="difflineplus">+{</span>
<a href="#l111.179"></a><span id="l111.179" class="difflineplus">+  try</span>
<a href="#l111.180"></a><span id="l111.180" class="difflineplus">+  {</span>
<a href="#l111.181"></a><span id="l111.181" class="difflineplus">+    var toSource = aVal.toSource();</span>
<a href="#l111.182"></a><span id="l111.182" class="difflineplus">+  }</span>
<a href="#l111.183"></a><span id="l111.183" class="difflineplus">+  catch (exc)</span>
<a href="#l111.184"></a><span id="l111.184" class="difflineplus">+  {</span>
<a href="#l111.185"></a><span id="l111.185" class="difflineplus">+    toSource = &quot;&quot;;</span>
<a href="#l111.186"></a><span id="l111.186" class="difflineplus">+  }</span>
<a href="#l111.187"></a><span id="l111.187" class="difflineplus">+  print(&quot;Testing value: toString=&quot; + aVal +</span>
<a href="#l111.188"></a><span id="l111.188" class="difflineplus">+        (toSource ? &quot; toSource=&quot; + toSource : &quot;&quot;));</span>
<a href="#l111.189"></a><span id="l111.189" class="difflineplus">+}</span>
<a href="#l111.190"></a><span id="l111.190" class="difflineplus">+</span>
<a href="#l111.191"></a><span id="l111.191" class="difflineplus">+function run_test()</span>
<a href="#l111.192"></a><span id="l111.192" class="difflineplus">+{</span>
<a href="#l111.193"></a><span id="l111.193" class="difflineplus">+  setup();</span>
<a href="#l111.194"></a><span id="l111.194" class="difflineplus">+</span>
<a href="#l111.195"></a><span id="l111.195" class="difflineplus">+  // function JSValStorageStatementBinder in</span>
<a href="#l111.196"></a><span id="l111.196" class="difflineplus">+  // storage/src/mozStorageStatementParams.cpp tells us that the following types</span>
<a href="#l111.197"></a><span id="l111.197" class="difflineplus">+  // and only the following types are valid as statement parameters:</span>
<a href="#l111.198"></a><span id="l111.198" class="difflineplus">+  var vals = [</span>
<a href="#l111.199"></a><span id="l111.199" class="difflineplus">+    1337,       // int</span>
<a href="#l111.200"></a><span id="l111.200" class="difflineplus">+    3.1337,     // double</span>
<a href="#l111.201"></a><span id="l111.201" class="difflineplus">+    &quot;foo&quot;,      // string</span>
<a href="#l111.202"></a><span id="l111.202" class="difflineplus">+    true,       // boolean</span>
<a href="#l111.203"></a><span id="l111.203" class="difflineplus">+    null,       // null</span>
<a href="#l111.204"></a><span id="l111.204" class="difflineplus">+    new Date(), // Date object</span>
<a href="#l111.205"></a><span id="l111.205" class="difflineplus">+  ];</span>
<a href="#l111.206"></a><span id="l111.206" class="difflineplus">+</span>
<a href="#l111.207"></a><span id="l111.207" class="difflineplus">+  vals.forEach(function (val)</span>
<a href="#l111.208"></a><span id="l111.208" class="difflineplus">+  {</span>
<a href="#l111.209"></a><span id="l111.209" class="difflineplus">+    printValDesc(val);</span>
<a href="#l111.210"></a><span id="l111.210" class="difflineplus">+    print(&quot;Single parameter&quot;);</span>
<a href="#l111.211"></a><span id="l111.211" class="difflineplus">+    insertAndCheckSingleParam(val);</span>
<a href="#l111.212"></a><span id="l111.212" class="difflineplus">+    print(&quot;Multiple parameters&quot;);</span>
<a href="#l111.213"></a><span id="l111.213" class="difflineplus">+    insertAndCheckMultipleParams(val)</span>
<a href="#l111.214"></a><span id="l111.214" class="difflineplus">+  });</span>
<a href="#l111.215"></a><span id="l111.215" class="difflineplus">+</span>
<a href="#l111.216"></a><span id="l111.216" class="difflineplus">+  cleanup();</span>
<a href="#l111.217"></a><span id="l111.217" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1">new file mode 100644</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineminus">--- /dev/null</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineplus">+++ b/storage-backport/test/unit/test_storage_value_array.js</span>
<a href="#l112.4"></a><span id="l112.4" class="difflineat">@@ -0,0 +1,243 @@</span>
<a href="#l112.5"></a><span id="l112.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l112.6"></a><span id="l112.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l112.7"></a><span id="l112.7" class="difflineplus">+ *</span>
<a href="#l112.8"></a><span id="l112.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l112.9"></a><span id="l112.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l112.10"></a><span id="l112.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l112.11"></a><span id="l112.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineplus">+ *</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l112.14"></a><span id="l112.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l112.15"></a><span id="l112.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l112.16"></a><span id="l112.16" class="difflineplus">+ * License.</span>
<a href="#l112.17"></a><span id="l112.17" class="difflineplus">+ *</span>
<a href="#l112.18"></a><span id="l112.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l112.19"></a><span id="l112.19" class="difflineplus">+ *</span>
<a href="#l112.20"></a><span id="l112.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l112.21"></a><span id="l112.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l112.22"></a><span id="l112.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l112.23"></a><span id="l112.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l112.24"></a><span id="l112.24" class="difflineplus">+ *</span>
<a href="#l112.25"></a><span id="l112.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l112.27"></a><span id="l112.27" class="difflineplus">+ *</span>
<a href="#l112.28"></a><span id="l112.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l112.29"></a><span id="l112.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l112.30"></a><span id="l112.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l112.31"></a><span id="l112.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l112.32"></a><span id="l112.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l112.33"></a><span id="l112.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l112.34"></a><span id="l112.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l112.35"></a><span id="l112.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l112.36"></a><span id="l112.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l112.37"></a><span id="l112.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l112.38"></a><span id="l112.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l112.39"></a><span id="l112.39" class="difflineplus">+ *</span>
<a href="#l112.40"></a><span id="l112.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l112.41"></a><span id="l112.41" class="difflineplus">+</span>
<a href="#l112.42"></a><span id="l112.42" class="difflineplus">+// This file tests the functions of mozIStorageValueArray</span>
<a href="#l112.43"></a><span id="l112.43" class="difflineplus">+</span>
<a href="#l112.44"></a><span id="l112.44" class="difflineplus">+function setup()</span>
<a href="#l112.45"></a><span id="l112.45" class="difflineplus">+{</span>
<a href="#l112.46"></a><span id="l112.46" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, name TEXT,&quot; +</span>
<a href="#l112.47"></a><span id="l112.47" class="difflineplus">+                                          &quot;number REAL, nuller NULL, blobber BLOB&quot;);</span>
<a href="#l112.48"></a><span id="l112.48" class="difflineplus">+  </span>
<a href="#l112.49"></a><span id="l112.49" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (name, number, blobber) &quot; +</span>
<a href="#l112.50"></a><span id="l112.50" class="difflineplus">+                             &quot;VALUES (?1, ?2, ?3)&quot;);</span>
<a href="#l112.51"></a><span id="l112.51" class="difflineplus">+  stmt.bindUTF8StringParameter(0, &quot;foo&quot;);</span>
<a href="#l112.52"></a><span id="l112.52" class="difflineplus">+  stmt.bindDoubleParameter(1, 2.34);</span>
<a href="#l112.53"></a><span id="l112.53" class="difflineplus">+  stmt.bindBlobParameter(2, [], 0);</span>
<a href="#l112.54"></a><span id="l112.54" class="difflineplus">+  stmt.execute();</span>
<a href="#l112.55"></a><span id="l112.55" class="difflineplus">+  </span>
<a href="#l112.56"></a><span id="l112.56" class="difflineplus">+  stmt.bindStringParameter(0, &quot;&quot;);</span>
<a href="#l112.57"></a><span id="l112.57" class="difflineplus">+  stmt.bindDoubleParameter(1, 1.23);</span>
<a href="#l112.58"></a><span id="l112.58" class="difflineplus">+  stmt.bindBlobParameter(2, [1, 2], 2);</span>
<a href="#l112.59"></a><span id="l112.59" class="difflineplus">+  stmt.execute();</span>
<a href="#l112.60"></a><span id="l112.60" class="difflineplus">+</span>
<a href="#l112.61"></a><span id="l112.61" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.62"></a><span id="l112.62" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.63"></a><span id="l112.63" class="difflineplus">+}</span>
<a href="#l112.64"></a><span id="l112.64" class="difflineplus">+</span>
<a href="#l112.65"></a><span id="l112.65" class="difflineplus">+function test_getIsNull_for_null()</span>
<a href="#l112.66"></a><span id="l112.66" class="difflineplus">+{</span>
<a href="#l112.67"></a><span id="l112.67" class="difflineplus">+  var stmt = createStatement(&quot;SELECT nuller, blobber FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.68"></a><span id="l112.68" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.69"></a><span id="l112.69" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.70"></a><span id="l112.70" class="difflineplus">+  </span>
<a href="#l112.71"></a><span id="l112.71" class="difflineplus">+  do_check_true(stmt.getIsNull(0)); // null field</span>
<a href="#l112.72"></a><span id="l112.72" class="difflineplus">+  do_check_true(stmt.getIsNull(1)); // data is null if size is 0</span>
<a href="#l112.73"></a><span id="l112.73" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.74"></a><span id="l112.74" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.75"></a><span id="l112.75" class="difflineplus">+}</span>
<a href="#l112.76"></a><span id="l112.76" class="difflineplus">+</span>
<a href="#l112.77"></a><span id="l112.77" class="difflineplus">+function test_getIsNull_for_non_null()</span>
<a href="#l112.78"></a><span id="l112.78" class="difflineplus">+{</span>
<a href="#l112.79"></a><span id="l112.79" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, blobber FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.80"></a><span id="l112.80" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.81"></a><span id="l112.81" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.82"></a><span id="l112.82" class="difflineplus">+</span>
<a href="#l112.83"></a><span id="l112.83" class="difflineplus">+  do_check_false(stmt.getIsNull(0));</span>
<a href="#l112.84"></a><span id="l112.84" class="difflineplus">+  do_check_false(stmt.getIsNull(1));</span>
<a href="#l112.85"></a><span id="l112.85" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.86"></a><span id="l112.86" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.87"></a><span id="l112.87" class="difflineplus">+}</span>
<a href="#l112.88"></a><span id="l112.88" class="difflineplus">+</span>
<a href="#l112.89"></a><span id="l112.89" class="difflineplus">+function test_value_type_null()</span>
<a href="#l112.90"></a><span id="l112.90" class="difflineplus">+{</span>
<a href="#l112.91"></a><span id="l112.91" class="difflineplus">+  var stmt = createStatement(&quot;SELECT nuller FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.92"></a><span id="l112.92" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.93"></a><span id="l112.93" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.94"></a><span id="l112.94" class="difflineplus">+</span>
<a href="#l112.95"></a><span id="l112.95" class="difflineplus">+  do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_NULL,</span>
<a href="#l112.96"></a><span id="l112.96" class="difflineplus">+              stmt.getTypeOfIndex(0));</span>
<a href="#l112.97"></a><span id="l112.97" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.98"></a><span id="l112.98" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.99"></a><span id="l112.99" class="difflineplus">+}</span>
<a href="#l112.100"></a><span id="l112.100" class="difflineplus">+</span>
<a href="#l112.101"></a><span id="l112.101" class="difflineplus">+function test_value_type_integer()</span>
<a href="#l112.102"></a><span id="l112.102" class="difflineplus">+{</span>
<a href="#l112.103"></a><span id="l112.103" class="difflineplus">+  var stmt = createStatement(&quot;SELECT id FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.104"></a><span id="l112.104" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.105"></a><span id="l112.105" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.106"></a><span id="l112.106" class="difflineplus">+</span>
<a href="#l112.107"></a><span id="l112.107" class="difflineplus">+  do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_INTEGER,</span>
<a href="#l112.108"></a><span id="l112.108" class="difflineplus">+              stmt.getTypeOfIndex(0));</span>
<a href="#l112.109"></a><span id="l112.109" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.110"></a><span id="l112.110" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.111"></a><span id="l112.111" class="difflineplus">+}</span>
<a href="#l112.112"></a><span id="l112.112" class="difflineplus">+</span>
<a href="#l112.113"></a><span id="l112.113" class="difflineplus">+function test_value_type_float()</span>
<a href="#l112.114"></a><span id="l112.114" class="difflineplus">+{</span>
<a href="#l112.115"></a><span id="l112.115" class="difflineplus">+  var stmt = createStatement(&quot;SELECT number FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.116"></a><span id="l112.116" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.117"></a><span id="l112.117" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.118"></a><span id="l112.118" class="difflineplus">+</span>
<a href="#l112.119"></a><span id="l112.119" class="difflineplus">+  do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_FLOAT,</span>
<a href="#l112.120"></a><span id="l112.120" class="difflineplus">+              stmt.getTypeOfIndex(0));</span>
<a href="#l112.121"></a><span id="l112.121" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.122"></a><span id="l112.122" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.123"></a><span id="l112.123" class="difflineplus">+}</span>
<a href="#l112.124"></a><span id="l112.124" class="difflineplus">+</span>
<a href="#l112.125"></a><span id="l112.125" class="difflineplus">+function test_value_type_text()</span>
<a href="#l112.126"></a><span id="l112.126" class="difflineplus">+{</span>
<a href="#l112.127"></a><span id="l112.127" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.128"></a><span id="l112.128" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.129"></a><span id="l112.129" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.130"></a><span id="l112.130" class="difflineplus">+</span>
<a href="#l112.131"></a><span id="l112.131" class="difflineplus">+  do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_TEXT,</span>
<a href="#l112.132"></a><span id="l112.132" class="difflineplus">+              stmt.getTypeOfIndex(0));</span>
<a href="#l112.133"></a><span id="l112.133" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.134"></a><span id="l112.134" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.135"></a><span id="l112.135" class="difflineplus">+}</span>
<a href="#l112.136"></a><span id="l112.136" class="difflineplus">+</span>
<a href="#l112.137"></a><span id="l112.137" class="difflineplus">+function test_value_type_blob()</span>
<a href="#l112.138"></a><span id="l112.138" class="difflineplus">+{</span>
<a href="#l112.139"></a><span id="l112.139" class="difflineplus">+  var stmt = createStatement(&quot;SELECT blobber FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.140"></a><span id="l112.140" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.141"></a><span id="l112.141" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.142"></a><span id="l112.142" class="difflineplus">+</span>
<a href="#l112.143"></a><span id="l112.143" class="difflineplus">+  do_check_eq(Ci.mozIStorageValueArray.VALUE_TYPE_BLOB,</span>
<a href="#l112.144"></a><span id="l112.144" class="difflineplus">+              stmt.getTypeOfIndex(0));</span>
<a href="#l112.145"></a><span id="l112.145" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.146"></a><span id="l112.146" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.147"></a><span id="l112.147" class="difflineplus">+}</span>
<a href="#l112.148"></a><span id="l112.148" class="difflineplus">+</span>
<a href="#l112.149"></a><span id="l112.149" class="difflineplus">+function test_numEntries_one()</span>
<a href="#l112.150"></a><span id="l112.150" class="difflineplus">+{</span>
<a href="#l112.151"></a><span id="l112.151" class="difflineplus">+  var stmt = createStatement(&quot;SELECT blobber FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.152"></a><span id="l112.152" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.153"></a><span id="l112.153" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.154"></a><span id="l112.154" class="difflineplus">+</span>
<a href="#l112.155"></a><span id="l112.155" class="difflineplus">+  do_check_eq(1, stmt.numEntries);</span>
<a href="#l112.156"></a><span id="l112.156" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.157"></a><span id="l112.157" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.158"></a><span id="l112.158" class="difflineplus">+}</span>
<a href="#l112.159"></a><span id="l112.159" class="difflineplus">+</span>
<a href="#l112.160"></a><span id="l112.160" class="difflineplus">+function test_numEntries_all()</span>
<a href="#l112.161"></a><span id="l112.161" class="difflineplus">+{</span>
<a href="#l112.162"></a><span id="l112.162" class="difflineplus">+  var stmt = createStatement(&quot;SELECT * FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.163"></a><span id="l112.163" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.164"></a><span id="l112.164" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.165"></a><span id="l112.165" class="difflineplus">+</span>
<a href="#l112.166"></a><span id="l112.166" class="difflineplus">+  do_check_eq(5, stmt.numEntries);</span>
<a href="#l112.167"></a><span id="l112.167" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.168"></a><span id="l112.168" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.169"></a><span id="l112.169" class="difflineplus">+}</span>
<a href="#l112.170"></a><span id="l112.170" class="difflineplus">+</span>
<a href="#l112.171"></a><span id="l112.171" class="difflineplus">+function test_getInt()</span>
<a href="#l112.172"></a><span id="l112.172" class="difflineplus">+{</span>
<a href="#l112.173"></a><span id="l112.173" class="difflineplus">+  var stmt = createStatement(&quot;SELECT id FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.174"></a><span id="l112.174" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.175"></a><span id="l112.175" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.176"></a><span id="l112.176" class="difflineplus">+</span>
<a href="#l112.177"></a><span id="l112.177" class="difflineplus">+  do_check_eq(2, stmt.getInt32(0));</span>
<a href="#l112.178"></a><span id="l112.178" class="difflineplus">+  do_check_eq(2, stmt.getInt64(0));</span>
<a href="#l112.179"></a><span id="l112.179" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.180"></a><span id="l112.180" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.181"></a><span id="l112.181" class="difflineplus">+}</span>
<a href="#l112.182"></a><span id="l112.182" class="difflineplus">+</span>
<a href="#l112.183"></a><span id="l112.183" class="difflineplus">+function test_getDouble()</span>
<a href="#l112.184"></a><span id="l112.184" class="difflineplus">+{</span>
<a href="#l112.185"></a><span id="l112.185" class="difflineplus">+  var stmt = createStatement(&quot;SELECT number FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.186"></a><span id="l112.186" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.187"></a><span id="l112.187" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.188"></a><span id="l112.188" class="difflineplus">+</span>
<a href="#l112.189"></a><span id="l112.189" class="difflineplus">+  do_check_eq(1.23, stmt.getDouble(0));</span>
<a href="#l112.190"></a><span id="l112.190" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.191"></a><span id="l112.191" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.192"></a><span id="l112.192" class="difflineplus">+}</span>
<a href="#l112.193"></a><span id="l112.193" class="difflineplus">+</span>
<a href="#l112.194"></a><span id="l112.194" class="difflineplus">+function test_getUTF8String()</span>
<a href="#l112.195"></a><span id="l112.195" class="difflineplus">+{</span>
<a href="#l112.196"></a><span id="l112.196" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.197"></a><span id="l112.197" class="difflineplus">+  stmt.bindInt32Parameter(0, 1);</span>
<a href="#l112.198"></a><span id="l112.198" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.199"></a><span id="l112.199" class="difflineplus">+</span>
<a href="#l112.200"></a><span id="l112.200" class="difflineplus">+  do_check_eq(&quot;foo&quot;, stmt.getUTF8String(0));</span>
<a href="#l112.201"></a><span id="l112.201" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.202"></a><span id="l112.202" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.203"></a><span id="l112.203" class="difflineplus">+}</span>
<a href="#l112.204"></a><span id="l112.204" class="difflineplus">+</span>
<a href="#l112.205"></a><span id="l112.205" class="difflineplus">+function test_getString()</span>
<a href="#l112.206"></a><span id="l112.206" class="difflineplus">+{</span>
<a href="#l112.207"></a><span id="l112.207" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.208"></a><span id="l112.208" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.209"></a><span id="l112.209" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.210"></a><span id="l112.210" class="difflineplus">+</span>
<a href="#l112.211"></a><span id="l112.211" class="difflineplus">+  do_check_eq(&quot;&quot;, stmt.getString(0));</span>
<a href="#l112.212"></a><span id="l112.212" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.213"></a><span id="l112.213" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.214"></a><span id="l112.214" class="difflineplus">+}</span>
<a href="#l112.215"></a><span id="l112.215" class="difflineplus">+</span>
<a href="#l112.216"></a><span id="l112.216" class="difflineplus">+function test_getBlob()</span>
<a href="#l112.217"></a><span id="l112.217" class="difflineplus">+{</span>
<a href="#l112.218"></a><span id="l112.218" class="difflineplus">+  var stmt = createStatement(&quot;SELECT blobber FROM test WHERE id = ?1&quot;);</span>
<a href="#l112.219"></a><span id="l112.219" class="difflineplus">+  stmt.bindInt32Parameter(0, 2);</span>
<a href="#l112.220"></a><span id="l112.220" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l112.221"></a><span id="l112.221" class="difflineplus">+</span>
<a href="#l112.222"></a><span id="l112.222" class="difflineplus">+  var count = { value: 0 };</span>
<a href="#l112.223"></a><span id="l112.223" class="difflineplus">+  var arr = { value: null };</span>
<a href="#l112.224"></a><span id="l112.224" class="difflineplus">+  stmt.getBlob(0, count, arr);</span>
<a href="#l112.225"></a><span id="l112.225" class="difflineplus">+  do_check_eq(2, count.value);</span>
<a href="#l112.226"></a><span id="l112.226" class="difflineplus">+  do_check_eq(1, arr.value[0]);</span>
<a href="#l112.227"></a><span id="l112.227" class="difflineplus">+  do_check_eq(2, arr.value[1]);</span>
<a href="#l112.228"></a><span id="l112.228" class="difflineplus">+  stmt.reset();</span>
<a href="#l112.229"></a><span id="l112.229" class="difflineplus">+  stmt.finalize();</span>
<a href="#l112.230"></a><span id="l112.230" class="difflineplus">+}</span>
<a href="#l112.231"></a><span id="l112.231" class="difflineplus">+</span>
<a href="#l112.232"></a><span id="l112.232" class="difflineplus">+var tests = [test_getIsNull_for_null, test_getIsNull_for_non_null,</span>
<a href="#l112.233"></a><span id="l112.233" class="difflineplus">+             test_value_type_null, test_value_type_integer,</span>
<a href="#l112.234"></a><span id="l112.234" class="difflineplus">+             test_value_type_float, test_value_type_text, test_value_type_blob,</span>
<a href="#l112.235"></a><span id="l112.235" class="difflineplus">+             test_numEntries_one, test_numEntries_all, test_getInt,</span>
<a href="#l112.236"></a><span id="l112.236" class="difflineplus">+             test_getDouble, test_getUTF8String, test_getString, test_getBlob];</span>
<a href="#l112.237"></a><span id="l112.237" class="difflineplus">+</span>
<a href="#l112.238"></a><span id="l112.238" class="difflineplus">+function run_test()</span>
<a href="#l112.239"></a><span id="l112.239" class="difflineplus">+{</span>
<a href="#l112.240"></a><span id="l112.240" class="difflineplus">+  setup();</span>
<a href="#l112.241"></a><span id="l112.241" class="difflineplus">+</span>
<a href="#l112.242"></a><span id="l112.242" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l112.243"></a><span id="l112.243" class="difflineplus">+    tests[i]();</span>
<a href="#l112.244"></a><span id="l112.244" class="difflineplus">+    </span>
<a href="#l112.245"></a><span id="l112.245" class="difflineplus">+  cleanup();</span>
<a href="#l112.246"></a><span id="l112.246" class="difflineplus">+}</span>
<a href="#l112.247"></a><span id="l112.247" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1">new file mode 100644</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineminus">--- /dev/null</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineplus">+++ b/storage-backport/test/unit/test_unicode.js</span>
<a href="#l113.4"></a><span id="l113.4" class="difflineat">@@ -0,0 +1,136 @@</span>
<a href="#l113.5"></a><span id="l113.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l113.6"></a><span id="l113.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l113.7"></a><span id="l113.7" class="difflineplus">+ *</span>
<a href="#l113.8"></a><span id="l113.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l113.9"></a><span id="l113.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l113.10"></a><span id="l113.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l113.11"></a><span id="l113.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l113.12"></a><span id="l113.12" class="difflineplus">+ *</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l113.14"></a><span id="l113.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l113.15"></a><span id="l113.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l113.16"></a><span id="l113.16" class="difflineplus">+ * License.</span>
<a href="#l113.17"></a><span id="l113.17" class="difflineplus">+ *</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+ * The Original Code is Storage Test Code.</span>
<a href="#l113.19"></a><span id="l113.19" class="difflineplus">+ *</span>
<a href="#l113.20"></a><span id="l113.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l113.21"></a><span id="l113.21" class="difflineplus">+ *   Mozilla Corporation.</span>
<a href="#l113.22"></a><span id="l113.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l113.23"></a><span id="l113.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l113.24"></a><span id="l113.24" class="difflineplus">+ *</span>
<a href="#l113.25"></a><span id="l113.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l113.26"></a><span id="l113.26" class="difflineplus">+ *   Shawn Wilsher &lt;me@shawnwilsher.com&gt; (Original Author)</span>
<a href="#l113.27"></a><span id="l113.27" class="difflineplus">+ *</span>
<a href="#l113.28"></a><span id="l113.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l113.29"></a><span id="l113.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l113.30"></a><span id="l113.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l113.31"></a><span id="l113.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l113.32"></a><span id="l113.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l113.33"></a><span id="l113.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l113.34"></a><span id="l113.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l113.35"></a><span id="l113.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l113.36"></a><span id="l113.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l113.37"></a><span id="l113.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l113.38"></a><span id="l113.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l113.39"></a><span id="l113.39" class="difflineplus">+ *</span>
<a href="#l113.40"></a><span id="l113.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l113.41"></a><span id="l113.41" class="difflineplus">+</span>
<a href="#l113.42"></a><span id="l113.42" class="difflineplus">+// This file tests the unicode functions that we have added</span>
<a href="#l113.43"></a><span id="l113.43" class="difflineplus">+</span>
<a href="#l113.44"></a><span id="l113.44" class="difflineplus">+const LATIN1_AE = &quot;\xc6&quot;; // &quot;&quot;</span>
<a href="#l113.45"></a><span id="l113.45" class="difflineplus">+const LATIN1_ae = &quot;\xe6&quot;;  // &quot;&quot;</span>
<a href="#l113.46"></a><span id="l113.46" class="difflineplus">+</span>
<a href="#l113.47"></a><span id="l113.47" class="difflineplus">+function setup()</span>
<a href="#l113.48"></a><span id="l113.48" class="difflineplus">+{</span>
<a href="#l113.49"></a><span id="l113.49" class="difflineplus">+  getOpenedDatabase().createTable(&quot;test&quot;, &quot;id INTEGER PRIMARY KEY, name TEXT&quot;);</span>
<a href="#l113.50"></a><span id="l113.50" class="difflineplus">+</span>
<a href="#l113.51"></a><span id="l113.51" class="difflineplus">+  var stmt = createStatement(&quot;INSERT INTO test (name, id) VALUES (?1, ?2)&quot;);</span>
<a href="#l113.52"></a><span id="l113.52" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_AE);</span>
<a href="#l113.53"></a><span id="l113.53" class="difflineplus">+  stmt.bindInt32Parameter(1, 1);</span>
<a href="#l113.54"></a><span id="l113.54" class="difflineplus">+  stmt.execute();</span>
<a href="#l113.55"></a><span id="l113.55" class="difflineplus">+  stmt.bindStringParameter(0, &quot;A&quot;);</span>
<a href="#l113.56"></a><span id="l113.56" class="difflineplus">+  stmt.bindInt32Parameter(1, 2);</span>
<a href="#l113.57"></a><span id="l113.57" class="difflineplus">+  stmt.execute();</span>
<a href="#l113.58"></a><span id="l113.58" class="difflineplus">+  stmt.bindStringParameter(0, &quot;b&quot;);</span>
<a href="#l113.59"></a><span id="l113.59" class="difflineplus">+  stmt.bindInt32Parameter(1, 3);</span>
<a href="#l113.60"></a><span id="l113.60" class="difflineplus">+  stmt.execute();</span>
<a href="#l113.61"></a><span id="l113.61" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_ae);</span>
<a href="#l113.62"></a><span id="l113.62" class="difflineplus">+  stmt.bindInt32Parameter(1, 4);</span>
<a href="#l113.63"></a><span id="l113.63" class="difflineplus">+  stmt.execute();</span>
<a href="#l113.64"></a><span id="l113.64" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.65"></a><span id="l113.65" class="difflineplus">+}</span>
<a href="#l113.66"></a><span id="l113.66" class="difflineplus">+</span>
<a href="#l113.67"></a><span id="l113.67" class="difflineplus">+function test_upper_ascii()</span>
<a href="#l113.68"></a><span id="l113.68" class="difflineplus">+{</span>
<a href="#l113.69"></a><span id="l113.69" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test WHERE name = upper('a')&quot;);</span>
<a href="#l113.70"></a><span id="l113.70" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.71"></a><span id="l113.71" class="difflineplus">+  do_check_eq(&quot;A&quot;, stmt.getString(0));</span>
<a href="#l113.72"></a><span id="l113.72" class="difflineplus">+  do_check_eq(2, stmt.getInt32(1));</span>
<a href="#l113.73"></a><span id="l113.73" class="difflineplus">+  stmt.reset();</span>
<a href="#l113.74"></a><span id="l113.74" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.75"></a><span id="l113.75" class="difflineplus">+}</span>
<a href="#l113.76"></a><span id="l113.76" class="difflineplus">+</span>
<a href="#l113.77"></a><span id="l113.77" class="difflineplus">+function test_upper_non_ascii()</span>
<a href="#l113.78"></a><span id="l113.78" class="difflineplus">+{</span>
<a href="#l113.79"></a><span id="l113.79" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test WHERE name = upper(?1)&quot;);</span>
<a href="#l113.80"></a><span id="l113.80" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_ae);</span>
<a href="#l113.81"></a><span id="l113.81" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.82"></a><span id="l113.82" class="difflineplus">+  do_check_eq(LATIN1_AE, stmt.getString(0));</span>
<a href="#l113.83"></a><span id="l113.83" class="difflineplus">+  do_check_eq(1, stmt.getInt32(1));</span>
<a href="#l113.84"></a><span id="l113.84" class="difflineplus">+  stmt.reset();</span>
<a href="#l113.85"></a><span id="l113.85" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.86"></a><span id="l113.86" class="difflineplus">+}</span>
<a href="#l113.87"></a><span id="l113.87" class="difflineplus">+</span>
<a href="#l113.88"></a><span id="l113.88" class="difflineplus">+function test_lower_ascii()</span>
<a href="#l113.89"></a><span id="l113.89" class="difflineplus">+{</span>
<a href="#l113.90"></a><span id="l113.90" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test WHERE name = lower('B')&quot;);</span>
<a href="#l113.91"></a><span id="l113.91" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.92"></a><span id="l113.92" class="difflineplus">+  do_check_eq(&quot;b&quot;, stmt.getString(0));</span>
<a href="#l113.93"></a><span id="l113.93" class="difflineplus">+  do_check_eq(3, stmt.getInt32(1));</span>
<a href="#l113.94"></a><span id="l113.94" class="difflineplus">+  stmt.reset();</span>
<a href="#l113.95"></a><span id="l113.95" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.96"></a><span id="l113.96" class="difflineplus">+}</span>
<a href="#l113.97"></a><span id="l113.97" class="difflineplus">+</span>
<a href="#l113.98"></a><span id="l113.98" class="difflineplus">+function test_lower_non_ascii()</span>
<a href="#l113.99"></a><span id="l113.99" class="difflineplus">+{</span>
<a href="#l113.100"></a><span id="l113.100" class="difflineplus">+  var stmt = createStatement(&quot;SELECT name, id FROM test WHERE name = lower(?1)&quot;);</span>
<a href="#l113.101"></a><span id="l113.101" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_AE);</span>
<a href="#l113.102"></a><span id="l113.102" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.103"></a><span id="l113.103" class="difflineplus">+  do_check_eq(LATIN1_ae, stmt.getString(0));</span>
<a href="#l113.104"></a><span id="l113.104" class="difflineplus">+  do_check_eq(4, stmt.getInt32(1));</span>
<a href="#l113.105"></a><span id="l113.105" class="difflineplus">+  stmt.reset();</span>
<a href="#l113.106"></a><span id="l113.106" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.107"></a><span id="l113.107" class="difflineplus">+}</span>
<a href="#l113.108"></a><span id="l113.108" class="difflineplus">+</span>
<a href="#l113.109"></a><span id="l113.109" class="difflineplus">+function test_like_search_different()</span>
<a href="#l113.110"></a><span id="l113.110" class="difflineplus">+{</span>
<a href="#l113.111"></a><span id="l113.111" class="difflineplus">+  var stmt = createStatement(&quot;SELECT COUNT(*) FROM test WHERE name LIKE ?1&quot;);</span>
<a href="#l113.112"></a><span id="l113.112" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_AE);</span>
<a href="#l113.113"></a><span id="l113.113" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.114"></a><span id="l113.114" class="difflineplus">+  do_check_eq(2, stmt.getInt32(0));</span>
<a href="#l113.115"></a><span id="l113.115" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.116"></a><span id="l113.116" class="difflineplus">+}</span>
<a href="#l113.117"></a><span id="l113.117" class="difflineplus">+</span>
<a href="#l113.118"></a><span id="l113.118" class="difflineplus">+function test_like_search_same()</span>
<a href="#l113.119"></a><span id="l113.119" class="difflineplus">+{</span>
<a href="#l113.120"></a><span id="l113.120" class="difflineplus">+  var stmt = createStatement(&quot;SELECT COUNT(*) FROM test WHERE name LIKE ?1&quot;);</span>
<a href="#l113.121"></a><span id="l113.121" class="difflineplus">+  stmt.bindStringParameter(0, LATIN1_ae);</span>
<a href="#l113.122"></a><span id="l113.122" class="difflineplus">+  do_check_true(stmt.executeStep());</span>
<a href="#l113.123"></a><span id="l113.123" class="difflineplus">+  do_check_eq(2, stmt.getInt32(0));</span>
<a href="#l113.124"></a><span id="l113.124" class="difflineplus">+  stmt.finalize();</span>
<a href="#l113.125"></a><span id="l113.125" class="difflineplus">+}</span>
<a href="#l113.126"></a><span id="l113.126" class="difflineplus">+</span>
<a href="#l113.127"></a><span id="l113.127" class="difflineplus">+var tests = [test_upper_ascii, test_upper_non_ascii, test_lower_ascii,</span>
<a href="#l113.128"></a><span id="l113.128" class="difflineplus">+             test_lower_non_ascii, test_like_search_different,</span>
<a href="#l113.129"></a><span id="l113.129" class="difflineplus">+             test_like_search_same];</span>
<a href="#l113.130"></a><span id="l113.130" class="difflineplus">+</span>
<a href="#l113.131"></a><span id="l113.131" class="difflineplus">+function run_test()</span>
<a href="#l113.132"></a><span id="l113.132" class="difflineplus">+{</span>
<a href="#l113.133"></a><span id="l113.133" class="difflineplus">+  setup();</span>
<a href="#l113.134"></a><span id="l113.134" class="difflineplus">+</span>
<a href="#l113.135"></a><span id="l113.135" class="difflineplus">+  for (var i = 0; i &lt; tests.length; i++)</span>
<a href="#l113.136"></a><span id="l113.136" class="difflineplus">+    tests[i]();</span>
<a href="#l113.137"></a><span id="l113.137" class="difflineplus">+    </span>
<a href="#l113.138"></a><span id="l113.138" class="difflineplus">+  cleanup();</span>
<a href="#l113.139"></a><span id="l113.139" class="difflineplus">+}</span>
<a href="#l113.140"></a><span id="l113.140" class="difflineplus">+</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

