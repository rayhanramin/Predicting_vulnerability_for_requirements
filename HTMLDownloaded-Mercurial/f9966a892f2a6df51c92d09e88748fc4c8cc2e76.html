<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29718:f9966a892f2a6df51c92d09e88748fc4c8cc2e76</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f9966a892f2a6df51c92d09e88748fc4c8cc2e76" />
<meta property="og:url" content="/comm-central/rev/f9966a892f2a6df51c92d09e88748fc4c8cc2e76" />
<meta property="og:description" content="Bug 546932 - Add CardDAVDirectory class for syncing with CardDAV servers. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f9966a892f2a6df51c92d09e88748fc4c8cc2e76 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">shortlog</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">files</a> |
changeset |
<a href="/comm-central/raw-rev/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">raw</a>  | <a href="/comm-central/archive/f9966a892f2a6df51c92d09e88748fc4c8cc2e76.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=546932">Bug 546932</a> - Add CardDAVDirectory class for syncing with CardDAV servers. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 31 May 2020 15:31:54 +0300</td></tr>

<tr>
 <td>changeset 29718</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f9966a892f2a6df51c92d09e88748fc4c8cc2e76">f9966a892f2a6df51c92d09e88748fc4c8cc2e76</a></td>
</tr>



<tr>
<td>parent 29717</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/530f652a7c3412d9d9e72e8303c4b4ec24661830">530f652a7c3412d9d9e72e8303c4b4ec24661830</a>
</td>
</tr>

<tr>
<td>child 29719</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/41e929c17e1b7074022c82f1c3616689961eaed7">41e929c17e1b7074022c82f1c3616689961eaed7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f9966a892f2a6df51c92d09e88748fc4c8cc2e76">17499</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sun, 31 May 2020 17:48:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9f4a9f7ce106 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9f4a9f7ce10651f40e6788c3c1d648f4fb99d9dd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9f4a9f7ce10651f40e6788c3c1d648f4fb99d9dd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f4a9f7ce10651f40e6788c3c1d648f4fb99d9dd&newProject=comm-central&newRevision=894c67ced89cc5c864d24eba23a6c4cc6f60fbc4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f4a9f7ce10651f40e6788c3c1d648f4fb99d9dd&newProject=comm-central&newRevision=894c67ced89cc5c864d24eba23a6c4cc6f60fbc4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9f4a9f7ce10651f40e6788c3c1d648f4fb99d9dd&newProject=comm-central&newRevision=894c67ced89cc5c864d24eba23a6c4cc6f60fbc4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=546932">546932</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=546932">Bug 546932</a> - Add CardDAVDirectory class for syncing with CardDAV servers. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">mail/components/addrbook/content/abTrees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mail/components/addrbook/content/abTrees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">mailnews/addrbook/jsaddrbook/VCardUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">mailnews/addrbook/jsaddrbook/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">mailnews/addrbook/jsaddrbook/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/jsaddrbook/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">mailnews/addrbook/test/CardDAVServer.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/CardDAVServer.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">mailnews/addrbook/test/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">mailnews/addrbook/test/unit/head_cardDAV.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/head_cardDAV.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">mailnews/addrbook/test/unit/test_cardDAV_sync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_sync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">mailnews/addrbook/test/unit/test_cardDAV_syncV2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">mailnews/addrbook/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/f9966a892f2a6df51c92d09e88748fc4c8cc2e76/mailnews/addrbook/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/addrbook/content/abTrees.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/addrbook/content/abTrees.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -11,35 +11,45 @@</span>
<a href="#l1.4"></a><span id="l1.4">  */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l1.8"></a><span id="l1.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> );</span>
<a href="#l1.10"></a><span id="l1.10"> var { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-const DIRTYPE_JS = 101;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14"> // Tree Sort helper methods.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-var AB_ORDER = [&quot;aab&quot;, &quot;pab&quot;, &quot;js&quot;, &quot;ldap&quot;, &quot;mapi+other&quot;, &quot;anyab&quot;, &quot;cab&quot;];</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+var AB_ORDER = [</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  &quot;aab&quot;,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  &quot;pab&quot;,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  &quot;js&quot;,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+  &quot;carddav&quot;,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  &quot;ldap&quot;,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  &quot;mapi+other&quot;,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  &quot;anyab&quot;,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  &quot;cab&quot;,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+];</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> function getDirectoryValue(aDir, aKey) {</span>
<a href="#l1.28"></a><span id="l1.28">   if (aKey == &quot;ab_type&quot;) {</span>
<a href="#l1.29"></a><span id="l1.29">     if (aDir._directory.URI == kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l1.30"></a><span id="l1.30">       return &quot;aab&quot;;</span>
<a href="#l1.31"></a><span id="l1.31">     }</span>
<a href="#l1.32"></a><span id="l1.32">     if (aDir._directory.URI == kPersonalAddressbookURI) {</span>
<a href="#l1.33"></a><span id="l1.33">       return &quot;pab&quot;;</span>
<a href="#l1.34"></a><span id="l1.34">     }</span>
<a href="#l1.35"></a><span id="l1.35">     if (aDir._directory.URI == kCollectedAddressbookURI) {</span>
<a href="#l1.36"></a><span id="l1.36">       return &quot;cab&quot;;</span>
<a href="#l1.37"></a><span id="l1.37">     }</span>
<a href="#l1.38"></a><span id="l1.38">     if (aDir._directory.URI.startsWith(&quot;jsaddrbook://&quot;)) {</span>
<a href="#l1.39"></a><span id="l1.39">       return &quot;js&quot;;</span>
<a href="#l1.40"></a><span id="l1.40">     }</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    if (aDir._directory.URI.startsWith(&quot;jscarddav://&quot;)) {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+      return &quot;carddav&quot;;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    }</span>
<a href="#l1.44"></a><span id="l1.44">     if (aDir._directory instanceof Ci.nsIAbLDAPDirectory) {</span>
<a href="#l1.45"></a><span id="l1.45">       return &quot;ldap&quot;;</span>
<a href="#l1.46"></a><span id="l1.46">     }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">     // If there is any other AB type.</span>
<a href="#l1.49"></a><span id="l1.49">     return &quot;mapi+other&quot;;</span>
<a href="#l1.50"></a><span id="l1.50">   } else if (aKey == &quot;ab_name&quot;) {</span>
<a href="#l1.51"></a><span id="l1.51">     return aDir._directory.dirName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -124,27 +124,23 @@ function closeConnectionTo(file) {</span>
<a href="#l2.4"></a><span id="l2.4"> class AddrBookDirectory {</span>
<a href="#l2.5"></a><span id="l2.5">   constructor() {</span>
<a href="#l2.6"></a><span id="l2.6">     this._uid = null;</span>
<a href="#l2.7"></a><span id="l2.7">     this._nextCardId = null;</span>
<a href="#l2.8"></a><span id="l2.8">     this._nextListId = null;</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   init(uri) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    this._uri = uri;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    let index = uri.indexOf(&quot;?&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    if (index &gt;= 0) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-    }</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    if (/\/MailList\d+$/.test(uri)) {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    let uriParts = /^([\w-]+):\/\/([\w-]+\.sqlite)$/.exec(uri);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    if (!uriParts) {</span>
<a href="#l2.21"></a><span id="l2.21">       throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l2.22"></a><span id="l2.22">     }</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    let fileName = uri.substring(&quot;jsaddrbook://&quot;.length);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    this._uri = uri;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    let fileName = uriParts[2];</span>
<a href="#l2.27"></a><span id="l2.27">     if (fileName.includes(&quot;/&quot;)) {</span>
<a href="#l2.28"></a><span id="l2.28">       fileName = fileName.substring(0, fileName.indexOf(&quot;/&quot;));</span>
<a href="#l2.29"></a><span id="l2.29">     }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">     for (let child of Services.prefs.getChildList(&quot;ldap_2.servers.&quot;)) {</span>
<a href="#l2.32"></a><span id="l2.32">       if (</span>
<a href="#l2.33"></a><span id="l2.33">         child.endsWith(&quot;.filename&quot;) &amp;&amp;</span>
<a href="#l2.34"></a><span id="l2.34">         Services.prefs.getStringPref(child) == fileName</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -34,16 +34,17 @@ XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l3.4"></a><span id="l3.4">   &quot;@mozilla.org/process/environment;1&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">   &quot;nsIEnvironment&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> );</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> /** Directory type constants, as defined in nsDirPrefs.h. */</span>
<a href="#l3.9"></a><span id="l3.9"> const LDAP_DIRECTORY_TYPE = 0;</span>
<a href="#l3.10"></a><span id="l3.10"> const MAPI_DIRECTORY_TYPE = 3;</span>
<a href="#l3.11"></a><span id="l3.11"> const JS_DIRECTORY_TYPE = 101;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+const CARDDAV_DIRECTORY_TYPE = 102;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> /** Test for valid directory URIs. */</span>
<a href="#l3.15"></a><span id="l3.15"> const URI_REGEXP = /^([\w-]+):\/\/([\w\.-]*)([?/:].*|$)/;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> /**</span>
<a href="#l3.18"></a><span id="l3.18">  * All registered nsIAbListener objects. Keys to this map are the listeners</span>
<a href="#l3.19"></a><span id="l3.19">  * themselves; values are a bitmap of events to notify. See nsIAbListener.idl.</span>
<a href="#l3.20"></a><span id="l3.20">  */</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -51,17 +52,17 @@ let listeners = new Map();</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> /**</span>
<a href="#l3.24"></a><span id="l3.24">  * When initialized, a map of nsIAbDirectory objects. Keys to this map are</span>
<a href="#l3.25"></a><span id="l3.25">  * the directories' URIs.</span>
<a href="#l3.26"></a><span id="l3.26">  */</span>
<a href="#l3.27"></a><span id="l3.27"> let store = null;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> /** Valid address book types. This differs by operating system. */</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-let types = [&quot;jsaddrbook&quot;, &quot;moz-abldapdirectory&quot;];</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+let types = [&quot;jsaddrbook&quot;, &quot;jscarddav&quot;, &quot;moz-abldapdirectory&quot;];</span>
<a href="#l3.32"></a><span id="l3.32"> if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l3.33"></a><span id="l3.33">   types.push(&quot;moz-abosxdirectory&quot;);</span>
<a href="#l3.34"></a><span id="l3.34"> } else if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l3.35"></a><span id="l3.35">   types.push(&quot;moz-aboutlookdirectory&quot;);</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> /**</span>
<a href="#l3.39"></a><span id="l3.39">  * Initialise an address book directory by URI.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -139,16 +140,22 @@ function ensureInitialized() {</span>
<a href="#l3.41"></a><span id="l3.41">             }</span>
<a href="#l3.42"></a><span id="l3.42">             break;</span>
<a href="#l3.43"></a><span id="l3.43">           case JS_DIRECTORY_TYPE:</span>
<a href="#l3.44"></a><span id="l3.44">             if (fileName) {</span>
<a href="#l3.45"></a><span id="l3.45">               let uri = `jsaddrbook://${fileName}`;</span>
<a href="#l3.46"></a><span id="l3.46">               createDirectoryObject(uri, true);</span>
<a href="#l3.47"></a><span id="l3.47">             }</span>
<a href="#l3.48"></a><span id="l3.48">             break;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+          case CARDDAV_DIRECTORY_TYPE:</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+            if (fileName) {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+              let uri = `jscarddav://${fileName}`;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+              createDirectoryObject(uri, true);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+            }</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+            break;</span>
<a href="#l3.55"></a><span id="l3.55">         }</span>
<a href="#l3.56"></a><span id="l3.56">       }</span>
<a href="#l3.57"></a><span id="l3.57">     } catch (ex) {</span>
<a href="#l3.58"></a><span id="l3.58">       Cu.reportError(ex);</span>
<a href="#l3.59"></a><span id="l3.59">     }</span>
<a href="#l3.60"></a><span id="l3.60">   }</span>
<a href="#l3.61"></a><span id="l3.61"> }</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63" class="difflineat">@@ -199,16 +206,18 @@ AddrBookManager.prototype = {</span>
<a href="#l3.64"></a><span id="l3.64">         let parent = this.getDirectory(`${scheme}://${fileName}`);</span>
<a href="#l3.65"></a><span id="l3.65">         for (let list of parent.childNodes) {</span>
<a href="#l3.66"></a><span id="l3.66">           list.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l3.67"></a><span id="l3.67">           if (list.URI == uri) {</span>
<a href="#l3.68"></a><span id="l3.68">             return list;</span>
<a href="#l3.69"></a><span id="l3.69">           }</span>
<a href="#l3.70"></a><span id="l3.70">         }</span>
<a href="#l3.71"></a><span id="l3.71">         throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+      } else if (scheme == &quot;jscarddav&quot;) {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+        throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l3.74"></a><span id="l3.74">       }</span>
<a href="#l3.75"></a><span id="l3.75">       // `tail` could either point to a mailing list or a query.</span>
<a href="#l3.76"></a><span id="l3.76">       // Both of these will be handled differently in future.</span>
<a href="#l3.77"></a><span id="l3.77">       return createDirectoryObject(uri);</span>
<a href="#l3.78"></a><span id="l3.78">     }</span>
<a href="#l3.79"></a><span id="l3.79">     throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_FAILURE);</span>
<a href="#l3.80"></a><span id="l3.80">   },</span>
<a href="#l3.81"></a><span id="l3.81">   getDirectoryFromId(dirPrefId) {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineat">@@ -312,27 +321,29 @@ AddrBookManager.prototype = {</span>
<a href="#l3.83"></a><span id="l3.83">           for (let folderURI of outlookInterface.getFolderURIs(uri)) {</span>
<a href="#l3.84"></a><span id="l3.84">             let dir = createDirectoryObject(folderURI, true);</span>
<a href="#l3.85"></a><span id="l3.85">             this.notifyDirectoryItemAdded(null, dir);</span>
<a href="#l3.86"></a><span id="l3.86">             Services.obs.notifyObservers(dir, &quot;addrbook-directory-created&quot;);</span>
<a href="#l3.87"></a><span id="l3.87">           }</span>
<a href="#l3.88"></a><span id="l3.88">         }</span>
<a href="#l3.89"></a><span id="l3.89">         break;</span>
<a href="#l3.90"></a><span id="l3.90">       }</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      case JS_DIRECTORY_TYPE: {</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+      case JS_DIRECTORY_TYPE:</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+      case CARDDAV_DIRECTORY_TYPE: {</span>
<a href="#l3.94"></a><span id="l3.94">         let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l3.95"></a><span id="l3.95">         file.append(&quot;abook.sqlite&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">         file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o644);</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">         ensureUniquePrefName();</span>
<a href="#l3.99"></a><span id="l3.99">         Services.prefs.setStringPref(`${prefName}.description`, dirName);</span>
<a href="#l3.100"></a><span id="l3.100">         Services.prefs.setIntPref(`${prefName}.dirType`, type);</span>
<a href="#l3.101"></a><span id="l3.101">         Services.prefs.setStringPref(`${prefName}.filename`, file.leafName);</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-        uri = `jsaddrbook://${file.leafName}`;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+        let scheme = type == JS_DIRECTORY_TYPE ? &quot;jsaddrbook&quot; : &quot;jscarddav&quot;;</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+        uri = `${scheme}://${file.leafName}`;</span>
<a href="#l3.106"></a><span id="l3.106">         let dir = createDirectoryObject(uri, true);</span>
<a href="#l3.107"></a><span id="l3.107">         this.notifyDirectoryItemAdded(null, dir);</span>
<a href="#l3.108"></a><span id="l3.108">         Services.obs.notifyObservers(dir, &quot;addrbook-directory-created&quot;);</span>
<a href="#l3.109"></a><span id="l3.109">         break;</span>
<a href="#l3.110"></a><span id="l3.110">       }</span>
<a href="#l3.111"></a><span id="l3.111">       default:</span>
<a href="#l3.112"></a><span id="l3.112">         throw Components.Exception(&quot;&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l3.113"></a><span id="l3.113">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/CardDAVDirectory.jsm</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,625 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;CardDAVDirectory&quot;];</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+const { AddrBookDirectory } = ChromeUtils.import(</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  &quot;resource:///modules/AddrBookDirectory.jsm&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+const { VCardUtils } = ChromeUtils.import(&quot;resource:///modules/VCardUtils.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+/**</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * @extends AddrBookDirectory</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * @implements nsIAbDirectory</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ */</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+class CardDAVDirectory extends AddrBookDirectory {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  /** nsIAbDirectory */</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  get supportsMailingLists() {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    return false;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  }</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  modifyCard(card) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    super.modifyCard(card);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    this._sendCardToServer(card);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  }</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  deleteCards(cards) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    super.deleteCards(cards);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    for (let card of cards) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      this._deleteCardFromServer(card);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    }</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  dropCard(card, needToCopyCard) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    let newCard = super.dropCard(card, needToCopyCard);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    this._sendCardToServer(newCard);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    return newCard;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  }</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  get _serverURL() {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    return this.getStringValue(&quot;carddav.url&quot;, &quot;&quot;);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  }</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  get _syncToken() {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    return this.getStringValue(&quot;carddav.token&quot;, &quot;&quot;);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  }</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  set _syncToken(value) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    this.setStringValue(&quot;carddav.token&quot;, value);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  /**</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+   * Wraps makeRequest, resolving path this directory's server URL, and</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+   * providing a mechanism to give a username and password specific to this</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+   * directory.</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+   *</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+   * @param {String} path - A path relative to the server URL.</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+   * @param {Object} details - See makeRequest.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+   * @return {Promise&lt;Object&gt;} - See makeRequest.</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+   */</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  _makeRequest(path, details = {}) {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    let serverURI = Services.io.newURI(this._serverURL);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    let uri = serverURI.resolve(path);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    return CardDAVDirectory.makeRequest(uri, details);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  }</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  /**</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+   * Gets or creates the path for storing this card on the server. Cards that</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+   * already exist on the server have this value in the _href property.</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+   *</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+   * @param {nsIAbCard} card</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+   * @return {String}</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+   */</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  _getCardHref(card) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+    let href = card.getProperty(&quot;_href&quot;, &quot;&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    if (href) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      return href;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    href = Services.io.newURI(this._serverURL).resolve(`${card.UID}.vcf`);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    return new URL(href).pathname;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  /**</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+   * Converts the card to a vCard and performs a PUT request to store it on the</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   * server. Then immediately performs a GET request ensuring the local copy</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+   * matches the server copy.</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   *</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+   * @param {nsIAbCard} card</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   */</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  async _sendCardToServer(card) {</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    if (this._syncInProgress) {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+      return;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    }</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    let href = this._getCardHref(card);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    let existing = card.getProperty(&quot;_vCard&quot;, &quot;&quot;);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    let data;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    if (existing) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+      data = VCardUtils.modifyVCard(existing, card);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+    } else {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+      // TODO 3.0 is the default, should we be able to use other versions?</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+      data = VCardUtils.abCardToVCard(card, &quot;3.0&quot;);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    }</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    let response = await this._makeRequest(href, {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      method: &quot;PUT&quot;,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      body: data,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+      contentType: &quot;text/vcard&quot;,</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    });</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    response = await this._makeRequest(href);</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    card.setProperty(&quot;_etag&quot;, response.etag);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    card.setProperty(&quot;_href&quot;, href);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    card.setProperty(&quot;_vCard&quot;, response.text);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    this._syncInProgress = true;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    this.modifyCard(card);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    this._syncInProgress = false;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  }</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  /**</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+   * Deletes card from the server.</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+   *</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+   * @param {nsIAbCard} card</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+   */</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  _deleteCardFromServer(card) {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    if (this._syncInProgress) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+      return Promise.resolve();</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    }</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    let href = card.getProperty(&quot;_href&quot;, &quot;&quot;);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    if (!href) {</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+      return Promise.resolve();</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    }</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    return this._makeRequest(href, { method: &quot;DELETE&quot; });</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  }</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  /**</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+   * Get all cards on the server and add them to this directory. This should</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+   * be used for the initial population of a directory.</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+   */</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  async fetchAllFromServer() {</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    let data = `&lt;propfind xmlns=&quot;DAV:&quot; xmlns:cs=&quot;http://calendarserver.org/ns/&quot;&gt;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      &lt;prop&gt;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+        &lt;resourcetype/&gt;</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        &lt;cs:getetag/&gt;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+      &lt;/prop&gt;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    &lt;/propfind&gt;`;</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    let response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+      method: &quot;PROPFIND&quot;,</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+      body: data,</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+      headers: {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+        Depth: 1,</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+      },</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+    });</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+    let hrefsToFetch = [];</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    for (let r of response.dom.querySelectorAll(&quot;response&quot;)) {</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+      if (!r.querySelector(&quot;resourcetype collection&quot;)) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+        hrefsToFetch.push(r.querySelector(&quot;href&quot;).textContent);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+      }</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    }</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+    hrefsToFetch = hrefsToFetch.map(</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+      href =&gt; `&lt;d:href&gt;${xmlEncode(href)}&lt;/d:href&gt;`</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+    );</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    data = `&lt;addressbook-multiget xmlns=&quot;urn:ietf:params:xml:ns:carddav&quot; xmlns:d=&quot;DAV:&quot;&gt;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+      &lt;d:prop&gt;</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+        &lt;d:getetag/&gt;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+        &lt;address-data/&gt;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+      &lt;/d:prop&gt;</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+      ${hrefsToFetch.join(&quot;\n&quot;)}</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+    &lt;/addressbook-multiget&gt;`;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+    response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+      method: &quot;REPORT&quot;,</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+      body: data,</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+      headers: {</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+        Depth: 1,</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+      },</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+    });</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    let abCards = [];</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    for (let r of response.dom.querySelectorAll(&quot;response&quot;)) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+      let etag = r.querySelector(&quot;getetag&quot;).textContent;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+      let href = r.querySelector(&quot;href&quot;).textContent;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+      let vCard = normalizeLineEndings(</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        r.querySelector(&quot;address-data&quot;).textContent</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+      );</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+      try {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+        let abCard = VCardUtils.vCardToAbCard(vCard);</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+        abCard.setProperty(&quot;_etag&quot;, etag);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+        abCard.setProperty(&quot;_href&quot;, href);</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+        abCard.setProperty(&quot;_vCard&quot;, vCard);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+        abCards.push(abCard);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      } catch (ex) {</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+        console.error(`Error parsing: ${vCard}`);</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+      }</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    }</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    await this._bulkAddCards(abCards);</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+  }</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+  /**</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+   * Compares cards in the directory with cards on the server, and updates the</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+   * directory to match what is on the server.</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+   */</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  async updateAllFromServer() {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+    let data = `&lt;addressbook-query xmlns=&quot;urn:ietf:params:xml:ns:carddav&quot; xmlns:d=&quot;DAV:&quot;&gt;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+      &lt;d:prop&gt;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+        &lt;d:getetag/&gt;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+      &lt;/d:prop&gt;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+    &lt;/addressbook-query&gt;`;</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    let response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+      method: &quot;REPORT&quot;,</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+      body: data,</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+      headers: {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+        Depth: 1,</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      },</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    });</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+    let hrefMap = new Map();</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+    for (let r of response.dom.querySelectorAll(&quot;response&quot;)) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      let etag = r.querySelector(&quot;getetag&quot;).textContent;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+      let href = r.querySelector(&quot;href&quot;).textContent;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      hrefMap.set(href, etag);</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+    }</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+    let cardMap = new Map();</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    let hrefsToFetch = [];</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    let cardsToAdd = [];</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+    let cardsToModify = [];</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    let cardsToDelete = [];</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    for (let card of this.childCards) {</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+      let href = card.getProperty(&quot;_href&quot;);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+      let etag = card.getProperty(&quot;_etag&quot;);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+      if (!href || !etag) {</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+        // Not sure how we got here. Ignore it.</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+        continue;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+      }</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+      cardMap.set(href, card);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+      if (hrefMap.has(href)) {</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+        if (hrefMap.get(href) != etag) {</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+          // The card was updated on server.</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+          hrefsToFetch.push(href);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+          cardsToModify.push(href);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+        }</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+      } else {</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+        // The card doesn't exist on the server.</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+        cardsToDelete.push(card);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+      }</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    }</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    for (let href of hrefMap.keys()) {</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+      if (!cardMap.has(href)) {</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+        // The card is new on the server.</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+        hrefsToFetch.push(href);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+        cardsToAdd.push(href);</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+      }</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    }</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+    if (cardsToDelete.length &gt; 0) {</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+      this._syncInProgress = true;</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+      this.deleteCards(cardsToDelete);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+      this._syncInProgress = false;</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    }</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+    if (hrefsToFetch.length == 0) {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+      return;</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+    }</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+    hrefsToFetch = hrefsToFetch.map(</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+      href =&gt; `&lt;d:href&gt;${xmlEncode(href)}&lt;/d:href&gt;`</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+    );</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+    data = `&lt;addressbook-multiget xmlns=&quot;urn:ietf:params:xml:ns:carddav&quot; xmlns:d=&quot;DAV:&quot;&gt;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+      &lt;d:prop&gt;</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+        &lt;d:getetag/&gt;</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+        &lt;address-data/&gt;</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+      &lt;/d:prop&gt;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+      ${hrefsToFetch.join(&quot;\n&quot;)}</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    &lt;/addressbook-multiget&gt;`;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+      method: &quot;REPORT&quot;,</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+      body: data,</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+      headers: {</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+        Depth: 1,</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+      },</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    });</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    this._syncInProgress = true;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    for (let r of response.dom.querySelectorAll(&quot;response&quot;)) {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+      let etag = r.querySelector(&quot;getetag&quot;).textContent;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+      let href = r.querySelector(&quot;href&quot;).textContent;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+      let vCard = normalizeLineEndings(</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+        r.querySelector(&quot;address-data&quot;).textContent</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+      );</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+      let abCard = VCardUtils.vCardToAbCard(vCard);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+      abCard.setProperty(&quot;_etag&quot;, etag);</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+      abCard.setProperty(&quot;_href&quot;, href);</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+      abCard.setProperty(&quot;_vCard&quot;, vCard);</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+      if (cardsToAdd.includes(href)) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+        this.addCard(abCard);</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+      } else {</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+        this.modifyCard(abCard);</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+      }</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+    }</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+    this._syncInProgress = false;</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+  }</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+  /**</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+   * Retrieves the current sync token from the server.</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+   *</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+   * @see RFC 6578</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+   */</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+  async getSyncToken() {</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+    let data = `&lt;propfind xmlns=&quot;DAV:&quot;&gt;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+      &lt;prop&gt;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+         &lt;displayname/&gt;</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+         &lt;sync-token/&gt;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+      &lt;/prop&gt;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+    &lt;/propfind&gt;`;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+    let response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+      method: &quot;PROPFIND&quot;,</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+      body: data,</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+    });</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+    this._syncToken = response.dom.querySelector(&quot;sync-token&quot;).textContent;</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+  }</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+  /**</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+   * Gets a list of changes on the server since the last call to getSyncToken</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+   * or updateAllFromServerV2, and updates the directory to match what is on</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+   * the server.</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+   *</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+   * @see RFC 6578</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+   */</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+  async updateAllFromServerV2() {</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    let syncToken = this._syncToken;</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+    if (!syncToken) {</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+      throw new Components.Exception(&quot;No sync token&quot;, Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    }</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+    let data = `&lt;sync-collection xmlns=&quot;DAV:&quot; xmlns:card=&quot;urn:ietf:params:xml:ns:carddav&quot;&gt;</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+      &lt;sync-token&gt;${xmlEncode(syncToken)}&lt;/sync-token&gt;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+      &lt;sync-level&gt;1&lt;/sync-level&gt;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+      &lt;prop&gt;</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+        &lt;getetag/&gt;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+        &lt;card:address-data/&gt;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+      &lt;/prop&gt;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    &lt;/sync-collection&gt;`;</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    let response = await this._makeRequest(&quot;&quot;, {</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+      method: &quot;REPORT&quot;,</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+      body: data,</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+    });</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+    let dom = response.dom;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+    this._syncToken = dom.querySelector(&quot;sync-token&quot;).textContent;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+    let cardsToDelete = [];</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+    for (let response of dom.querySelectorAll(&quot;response&quot;)) {</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+      let href = response.querySelector(&quot;href&quot;).textContent;</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+      let status = response.querySelector(&quot;response &gt; status&quot;);</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+      let card = this.getCardFromProperty(&quot;_href&quot;, href, true);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+      if (status &amp;&amp; status.textContent == &quot;HTTP/1.1 404 Not Found&quot;) {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+        if (card) {</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+          cardsToDelete.push(card);</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+        }</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+        continue;</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+      }</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+      let etag = response.querySelector(&quot;getetag&quot;).textContent;</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+      let vCard = normalizeLineEndings(</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+        response.querySelector(&quot;address-data&quot;).textContent</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+      );</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+      let abCard = VCardUtils.vCardToAbCard(vCard);</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+      abCard.setProperty(&quot;_etag&quot;, etag);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+      abCard.setProperty(&quot;_href&quot;, href);</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+      abCard.setProperty(&quot;_vCard&quot;, vCard);</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+      this._syncInProgress = true;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+      if (card) {</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+        if (card.getProperty(&quot;_etag&quot;) != etag) {</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+          this.modifyCard(abCard);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+        }</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+      } else {</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+        this.addCard(abCard);</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+      }</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+      this._syncInProgress = false;</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+    }</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+    if (cardsToDelete.length &gt; 0) {</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+      this._syncInProgress = true;</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+      this.deleteCards(cardsToDelete);</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+      this._syncInProgress = false;</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+    }</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+  }</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+  /**</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+   * Make an HTTP request. If the request needs a username and password, the</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+   * given authPrompt is called.</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+   *</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+   * @param {String} uri</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+   * @param {Object} details</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+   * @param {String} details.method</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+   * @param {String} details.header</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+   * @param {nsIAuthPrompt2} details.authPrompt</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+   * @param {String} details.body</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+   * @param {String} details.contentType</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+   * @return {Promise&lt;Object&gt;} - Resolves to an object with three getters:</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+   *    - etag, the ETag header if any</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+   *    - text, the returned data as a String</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+   *    - dom, the returned data parsed into a Document</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+   */</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+  static async makeRequest(</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+    uri,</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+    { method = &quot;GET&quot;, headers = {}, body = null, contentType = &quot;text/xml&quot; }</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+  ) {</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+    uri = Services.io.newURI(uri);</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+      let principal = Services.scriptSecurityManager.createContentPrincipal(</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+        uri,</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+        {}</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+      );</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+      let channel = Services.io.newChannelFromURI(</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+        uri,</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+        null,</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+        principal,</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+        null,</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+        Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+        Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+      );</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+      channel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+      for (let [name, value] of Object.entries(headers)) {</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+        channel.setRequestHeader(name, value, false);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+      }</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+      channel.notificationCallbacks = {</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+        getInterface(iid) {</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+          if (iid.equals(Ci.nsIAuthPrompt2)) {</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+            return {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+              promptAuth(channel, level, authInfo) {</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+                let logins = Services.logins.findLogins(</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+                  channel.URI.prePath,</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+                  null,</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+                  &quot;&quot;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+                );</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+                for (let l of logins) {</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+                  authInfo.username = l.username;</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+                  authInfo.password = l.password;</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+                  return true;</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+                }</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+                let savePasswordLabel = null;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+                if (</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+                  Services.prefs.getBoolPref(&quot;signon.rememberSignons&quot;, true)</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+                ) {</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+                  savePasswordLabel = Services.strings</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+                    .createBundle(</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+                      &quot;chrome://passwordmgr/locale/passwordmgr.properties&quot;</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+                    )</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+                    .GetStringFromName(&quot;rememberPassword&quot;);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+                }</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+                let savePassword = {};</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+                let returnValue = Services.prompt.promptAuth(</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+                  null,</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+                  channel,</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+                  level,</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+                  authInfo,</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+                  savePasswordLabel,</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+                  savePassword</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+                );</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+                if (savePassword.value) {</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+                  let newLoginInfo = Cc[</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+                    &quot;@mozilla.org/login-manager/loginInfo;1&quot;</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+                  ].createInstance(Ci.nsILoginInfo);</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+                  newLoginInfo.init(</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+                    channel.URI.prePath,</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+                    null,</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+                    authInfo.realm,</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+                    authInfo.username,</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+                    authInfo.password,</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+                    &quot;&quot;,</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+                    &quot;&quot;</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+                  );</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+                  Services.logins.addLogin(newLoginInfo);</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+                }</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+                return returnValue;</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+              },</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+            };</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+          } else if (iid.equals(Ci.nsIChannelEventSink)) {</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+            return {</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+              asyncOnChannelRedirect(oldChannel, newChannel, flags, callback) {</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+                /**</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+                 * Copy the given header from the old channel to the new one, ignoring missing headers</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+                 *</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+                 * @param {String} aHdr         The header to copy</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+                 */</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+                function copyHeader(aHdr) {</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+                  try {</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+                    let hdrValue = oldChannel.getRequestHeader(aHdr);</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+                    if (hdrValue) {</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+                      newChannel.setRequestHeader(aHdr, hdrValue, false);</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+                    }</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+                  } catch (e) {</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+                    if (e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+                      // The header could possibly not be availible, ignore that</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+                      // case but throw otherwise</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+                      throw e;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+                    }</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+                  }</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+                }</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+                // Make sure we can get/set headers on both channels.</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+                newChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+                oldChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+                // If any other header is used, it should be added here. We might want</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+                // to just copy all headers over to the new channel.</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+                copyHeader(&quot;Depth&quot;);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+                copyHeader(&quot;Originator&quot;);</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+                copyHeader(&quot;Recipient&quot;);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+                copyHeader(&quot;If-None-Match&quot;);</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+                copyHeader(&quot;If-Match&quot;);</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+                newChannel.requestMethod = oldChannel.requestMethod;</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+                callback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+              },</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+            };</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+          }</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+          return null;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+        },</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+      };</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+      if (body !== null) {</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        let converter = Cc[</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+          &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+        ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+        converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+        let stream = converter.convertToInputStream(body.toString());</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+        channel.QueryInterface(Ci.nsIUploadChannel);</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+        channel.setUploadStream(stream, contentType, -1);</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+      }</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+      channel.requestMethod = method; // Must go after setUploadStream.</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+      let listener = Cc[&quot;@mozilla.org/network/stream-loader;1&quot;].createInstance(</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+        Ci.nsIStreamLoader</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+      );</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+      listener.init({</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+        onStreamComplete(loader, context, status, resultLength, result) {</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+          if (!Components.isSuccessCode(status)) {</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+            // TODO: Improve this exception.</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+            reject(new Components.Exception(&quot;Connection failure&quot;, status));</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+            return;</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+          }</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+          if (</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+            !channel.requestSucceeded &amp;&amp;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+            Math.floor(channel.responseStatus / 100) != 3</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+          ) {</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+            // TODO: Improve this exception.</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+            reject(</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+              new Components.Exception(</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+                channel.responseStatusText,</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+                Cr.NS_ERROR_FAILURE</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+              )</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+            );</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+            return;</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+          }</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+          resolve({</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+            get etag() {</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+              try {</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+                return channel.getResponseHeader(&quot;etag&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+              } catch (ex) {</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+                return null;</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+              }</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+            },</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+            get text() {</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+              return new TextDecoder().decode(Uint8Array.from(result));</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+            },</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+            get dom() {</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+              return new DOMParser().parseFromString(this.text, &quot;text/xml&quot;);</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+            },</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+          });</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+        },</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+      });</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+      channel.asyncOpen(listener, channel);</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+    });</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+  }</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+}</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+CardDAVDirectory.prototype.classID = Components.ID(</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+  &quot;{1fa9941a-07d5-4a6f-9673-15327fc2b9ab}&quot;</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+);</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+/**</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+ * Ensure that `string` always has Windows line-endings. Some functions,</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+ * notably DOMParser.parseFromString, strip \r, but we want it because \r\n</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+ * is a part of the vCard specification.</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+ */</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+function normalizeLineEndings(string) {</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+  if (string.includes(&quot;\r\n&quot;)) {</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+    return string;</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+  }</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+  return string.replace(/\n/g, &quot;\r\n&quot;);</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+}</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+/**</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+ * Encode special characters safely for XML.</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+ */</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+function xmlEncode(string) {</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+  return string</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+    .replace(/&amp;/g, &quot;&amp;amp;&quot;)</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+    .replace(/&quot;/g, &quot;&amp;quot;&quot;)</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+    .replace(/&lt;/g, &quot;&amp;lt;&quot;)</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+    .replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/VCardUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/VCardUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -97,18 +97,18 @@ var VCardUtils = {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">     // Always add a UID if there isn't one.</span>
<a href="#l5.6"></a><span id="l5.6">     if (vProps.findIndex(prop =&gt; prop[0] == &quot;uid&quot;) == -1) {</span>
<a href="#l5.7"></a><span id="l5.7">       vProps.push([&quot;uid&quot;, {}, &quot;text&quot;, abCard.UID]);</span>
<a href="#l5.8"></a><span id="l5.8">     }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">     return ICAL.stringify(card);</span>
<a href="#l5.11"></a><span id="l5.11">   },</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  abCardToVCard(abCard) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    let vProps = [[&quot;version&quot;, {}, &quot;text&quot;, &quot;4.0&quot;]];</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  abCardToVCard(abCard, version = &quot;4.0&quot;) {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    let vProps = [[&quot;version&quot;, {}, &quot;text&quot;, version]];</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">     // Collect all of the AB card properties into a Map.</span>
<a href="#l5.18"></a><span id="l5.18">     let abProps = new Map();</span>
<a href="#l5.19"></a><span id="l5.19">     for (let abProp of abCard.properties) {</span>
<a href="#l5.20"></a><span id="l5.20">       if (abProp.value) {</span>
<a href="#l5.21"></a><span id="l5.21">         abProps.set(abProp.name, abProp.value);</span>
<a href="#l5.22"></a><span id="l5.22">       }</span>
<a href="#l5.23"></a><span id="l5.23">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -10,16 +10,21 @@ Classes = [</span>
<a href="#l6.4"></a><span id="l6.4">         'jsm': 'resource:///modules/AddrBookCard.jsm',</span>
<a href="#l6.5"></a><span id="l6.5">         'constructor': 'AddrBookCard',</span>
<a href="#l6.6"></a><span id="l6.6">     }, {</span>
<a href="#l6.7"></a><span id="l6.7">         'cid': '{224d3ef9-d81c-4d94-8826-a79a5835af93}',</span>
<a href="#l6.8"></a><span id="l6.8">         'contract_ids': ['@mozilla.org/abmanager;1'],</span>
<a href="#l6.9"></a><span id="l6.9">         'jsm': 'resource:///modules/AddrBookManager.jsm',</span>
<a href="#l6.10"></a><span id="l6.10">         'constructor': 'AddrBookManager',</span>
<a href="#l6.11"></a><span id="l6.11">     }, {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+        'cid': '{1fa9941a-07d5-4a6f-9673-15327fc2b9ab}',</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        'contract_ids': ['@mozilla.org/addressbook/directory;1?type=jscarddav'],</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+        'jsm': 'resource:///modules/CardDAVDirectory.jsm',</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+        'constructor': 'CardDAVDirectory',</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    }, {</span>
<a href="#l6.17"></a><span id="l6.17">         'cid': '{e2e0f615-bc5a-4441-a16b-a26e75949376}',</span>
<a href="#l6.18"></a><span id="l6.18">         'contract_ids': ['@mozilla.org/addressbook/msgvcardservice;1'],</span>
<a href="#l6.19"></a><span id="l6.19">         'jsm': 'resource:///modules/VCardUtils.jsm',</span>
<a href="#l6.20"></a><span id="l6.20">         'constructor': 'VCardService',</span>
<a href="#l6.21"></a><span id="l6.21">     }, {</span>
<a href="#l6.22"></a><span id="l6.22">         'cid': '{dafab386-bd4c-4238-bb48-228fbc98ba29}',</span>
<a href="#l6.23"></a><span id="l6.23">         'contract_ids': ['@mozilla.org/mimecth;1?type=text/x-vcard'],</span>
<a href="#l6.24"></a><span id="l6.24">         'jsm': 'resource:///modules/VCardUtils.jsm',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,14 +3,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> # file, you can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> EXTRA_JS_MODULES += [</span>
<a href="#l7.7"></a><span id="l7.7">     'AddrBookCard.jsm',</span>
<a href="#l7.8"></a><span id="l7.8">     'AddrBookDirectory.jsm',</span>
<a href="#l7.9"></a><span id="l7.9">     'AddrBookMailingList.jsm',</span>
<a href="#l7.10"></a><span id="l7.10">     'AddrBookManager.jsm',</span>
<a href="#l7.11"></a><span id="l7.11">     'AddrBookUtils.jsm',</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+    'CardDAVDirectory.jsm',</span>
<a href="#l7.13"></a><span id="l7.13">     'VCardUtils.jsm',</span>
<a href="#l7.14"></a><span id="l7.14"> ]</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> XPCOM_MANIFESTS += [</span>
<a href="#l7.17"></a><span id="l7.17">     'components.conf',</span>
<a href="#l7.18"></a><span id="l7.18"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/addrbook/test/CardDAVServer.jsm</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,282 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;CardDAVServer&quot;];</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+const CARD_NS = &quot;urn:ietf:params:xml:ns:carddav&quot;;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+const DAV_NS = &quot;DAV:&quot;;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+const { Assert } = ChromeUtils.import(&quot;resource://testing-common/Assert.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+const { CommonUtils } = ChromeUtils.import(</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  &quot;resource://services-common/utils.js&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+const { HttpServer } = ChromeUtils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+var CardDAVServer = {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  cards: new Map(),</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  deletedCards: new Map(),</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  changeCount: 0,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  server: null,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  open() {</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    this.server = new HttpServer();</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+    this.server.start(-1);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    this.server.registerPathHandler(&quot;/ping&quot;, this.ping);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    this.server.registerPathHandler(this.path, this.pathHandler.bind(this));</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    this.server.registerPrefixHandler(this.path, this.prefixHandler.bind(this));</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  },</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  close() {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    return new Promise(resolve =&gt; this.server.stop({ onStopped: resolve }));</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  },</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  get path() {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    return &quot;/addressbooks/me/test/&quot;;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  },</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  get url() {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    return `http://localhost:${this.server.identity.primaryPort}${this.path}`;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  },</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  setUsernameAndPassword(username, password) {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    this.username = username;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    this.password = password;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  },</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  ping(request, response) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    response.write(&quot;pong&quot;);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  },</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  checkAuth(request, response) {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    if (!this.username || !this.password) {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      return true;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    }</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    if (!request.hasHeader(&quot;Authorization&quot;)) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+      response.setStatusLine(&quot;1.1&quot;, 401, &quot;Unauthorized&quot;);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+      response.setHeader(&quot;WWW-Authenticate&quot;, `Basic realm=&quot;test&quot;`);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+      return false;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    }</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    let value = request.getHeader(&quot;Authorization&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    if (!value.startsWith(&quot;Basic &quot;)) {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+      response.setStatusLine(&quot;1.1&quot;, 401, &quot;Unauthorized&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+      response.setHeader(&quot;WWW-Authenticate&quot;, `Basic realm=&quot;test&quot;`);</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      return false;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    }</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+    let [username, password] = atob(value.substring(6)).split(&quot;:&quot;);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+    if (username != this.username || password != this.password) {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      response.setStatusLine(&quot;1.1&quot;, 401, &quot;Unauthorized&quot;);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+      return false;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    }</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    return true;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  },</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  pathHandler(request, response) {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    if (!this.checkAuth(request, response)) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+      return;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+    }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    let input = new DOMParser().parseFromString(</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+      CommonUtils.readBytesFromInputStream(request.bodyInputStream),</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+      &quot;text/xml&quot;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    );</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    switch (input.documentElement.localName) {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      case &quot;addressbook-query&quot;:</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+        Assert.equal(request.method, &quot;REPORT&quot;);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+        this.addressBookQuery(input, response);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+        return;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+      case &quot;addressbook-multiget&quot;:</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+        Assert.equal(request.method, &quot;REPORT&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+        this.addressBookMultiGet(input, response);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+        return;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+      case &quot;propfind&quot;:</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+        Assert.equal(request.method, &quot;PROPFIND&quot;);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+        this.propFind(</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+          input,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+          request.hasHeader(&quot;Depth&quot;) ? request.getHeader(&quot;Depth&quot;) : 0,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+          response</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+        );</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+        return;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+      case &quot;sync-collection&quot;:</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+        Assert.equal(request.method, &quot;REPORT&quot;);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+        this.syncCollection(input, response);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+        return;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+    }</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    Assert.report(true, undefined, undefined, &quot;Should not have reached here&quot;);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 404, &quot;Not Found&quot;);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+    response.write(`No handler found for &lt;${input.documentElement.localName}&gt;`);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  },</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  addressBookQuery(input, response) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    let includeVCard = input.querySelector(&quot;address-data&quot;);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    let output = `&lt;multistatus xmlns:card=&quot;${CARD_NS}&quot; xmlns=&quot;${DAV_NS}&quot;&gt;`;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    for (let [href, card] of this.cards) {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+      output += this._cardResponse(href, card, includeVCard);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    }</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    output += `&lt;/multistatus&gt;`;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    response.write(output.replace(/&gt;\s+&lt;/g, &quot;&gt;&lt;&quot;));</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  },</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  addressBookMultiGet(input, response) {</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    let output = `&lt;multistatus xmlns:card=&quot;${CARD_NS}&quot; xmlns=&quot;${DAV_NS}&quot;&gt;`;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    for (let href of input.querySelectorAll(&quot;href&quot;)) {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      href = href.textContent;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+      let card = this.cards.get(href);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+      if (card) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+        output += this._cardResponse(href, card, true);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+      }</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    }</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    output += `&lt;/multistatus&gt;`;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    response.write(output.replace(/&gt;\s+&lt;/g, &quot;&gt;&lt;&quot;));</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+  },</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  propFind(input, depth, response) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    let output = `&lt;multistatus xmlns=&quot;${DAV_NS}&quot;&gt;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+      &lt;response&gt;</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+        &lt;href&gt;${this.path}&lt;/href&gt;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+        &lt;propstat&gt;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+          &lt;prop&gt;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+            &lt;displayname&gt;test&lt;/displayname&gt;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+            &lt;sync-token&gt;http://mochi.test/sync/${this.changeCount}&lt;/sync-token&gt;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+          &lt;/prop&gt;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+          &lt;status&gt;HTTP/1.1 200 OK&lt;/status&gt;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+        &lt;/propstat&gt;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+      &lt;/response&gt;`;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    if (depth == 1) {</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+      for (let [href, card] of this.cards) {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+        output += this._cardResponse(href, card, false);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+      }</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    }</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+    output += `&lt;/multistatus&gt;`;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    response.write(output.replace(/&gt;\s+&lt;/g, &quot;&gt;&lt;&quot;));</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  },</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  syncCollection(input, response) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+    let token = input</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+      .querySelector(&quot;sync-token&quot;)</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+      .textContent.replace(/\D/g, &quot;&quot;);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    let includeVCard = input.querySelector(&quot;address-data&quot;);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    let output = `&lt;multistatus xmlns:card=&quot;${CARD_NS}&quot; xmlns=&quot;${DAV_NS}&quot;&gt;`;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    for (let [href, card] of this.cards) {</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+      if (card.changed &gt; token) {</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+        output += this._cardResponse(href, card, includeVCard);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+      }</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    }</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    for (let [href, deleted] of this.deletedCards) {</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      if (deleted &gt; token) {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+        output += `&lt;response&gt;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+          &lt;status&gt;HTTP/1.1 404 Not Found&lt;/status&gt;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+          &lt;href&gt;${href}&lt;/href&gt;</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+          &lt;propstat&gt;</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+            &lt;prop/&gt;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+            &lt;status&gt;HTTP/1.1 418 I'm a teapot&lt;/status&gt;</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+          &lt;/propstat&gt;</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+        &lt;/response&gt;`;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      }</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    }</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+    output += `&lt;sync-token&gt;http://mochi.test/sync/${this.changeCount}&lt;/sync-token&gt;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    &lt;/multistatus&gt;`;</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+    response.write(output.replace(/&gt;\s+&lt;/g, &quot;&gt;&lt;&quot;));</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+  },</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+  _cardResponse(href, card, includeVCard) {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    let outString = `&lt;response&gt;</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      &lt;href&gt;${href}&lt;/href&gt;</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      &lt;propstat&gt;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+        &lt;prop&gt;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+          &lt;getetag&gt;${card.etag}&lt;/getetag&gt;`;</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+    if (includeVCard) {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+      outString += `&lt;card:address-data&gt;${card.vCard}&lt;/card:address-data&gt;`;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+    }</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    outString += `&lt;status&gt;HTTP/1.1 200 OK&lt;/status&gt;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+        &lt;/prop&gt;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+      &lt;/propstat&gt;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+    &lt;/response&gt;`;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+    return outString;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+  },</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+  prefixHandler(request, response) {</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+    if (!this.checkAuth(request, response)) {</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      return;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    }</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+    if (!/\/[\w-]+\.vcf$/.test(request.path)) {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+      response.setStatusLine(&quot;1.1&quot;, 404, &quot;Not Found&quot;);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+      response.write(`Card not found at ${request.path}`);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+      return;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+    }</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+    switch (request.method) {</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+      case &quot;GET&quot;:</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+        this.getCard(request, response);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+        return;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+      case &quot;PUT&quot;:</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+        this.putCard(request, response);</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+        return;</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+      case &quot;DELETE&quot;:</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+        this.deleteCard(request, response);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+        return;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+    }</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    Assert.report(true, undefined, undefined, &quot;Should not have reached here&quot;);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 405, &quot;Method Not Allowed&quot;);</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+    response.write(`Method not allowed: ${request.method}`);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+  },</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+  getCard(request, response) {</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+    let card = this.cards.get(request.path);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+    if (!card) {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      response.setStatusLine(&quot;1.1&quot;, 404, &quot;Not Found&quot;);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      response.write(`Card not found at ${request.path}`);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+      return;</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    }</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    response.setHeader(&quot;ETag&quot;, card.etag);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+    response.write(card.vCard);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+  },</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+  putCard(request, response) {</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    let vCard = CommonUtils.readBytesFromInputStream(request.bodyInputStream);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+    this.putCardInternal(request.path, vCard);</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+  },</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+  putCardInternal(name, vCard) {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+    if (!name.startsWith(&quot;/&quot;)) {</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+      name = this.path + name;</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+    }</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+    let etag = &quot;&quot; + vCard.length;</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+    this.cards.set(name, { etag, vCard, changed: ++this.changeCount });</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+    this.deletedCards.delete(name);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+  },</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  deleteCard(request, response) {</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+    this.deleteCardInternal(request.path);</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+    response.setStatusLine(&quot;1.1&quot;, 200, &quot;OK&quot;);</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+  },</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  deleteCardInternal(name) {</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+    if (!name.startsWith(&quot;/&quot;)) {</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+      name = this.path + name;</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+    }</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+    this.cards.delete(name);</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+    this.deletedCards.set(name, ++this.changeCount);</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+  },</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/test/moz.build</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/test/moz.build</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> # vim: set filetype=python:</span>
<a href="#l9.5"></a><span id="l9.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> TESTING_JS_MODULES += [</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+    'CardDAVServer.jsm',</span>
<a href="#l9.11"></a><span id="l9.11">     'LDAPServer.jsm',</span>
<a href="#l9.12"></a><span id="l9.12"> ]</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l9.15"></a><span id="l9.15">     'unit/xpcshell.ini',</span>
<a href="#l9.16"></a><span id="l9.16">     'unit/xpcshell_migration.ini',</span>
<a href="#l9.17"></a><span id="l9.17"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/head_cardDAV.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,75 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+const { CardDAVDirectory } = ChromeUtils.import(</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+  &quot;resource:///modules/CardDAVDirectory.jsm&quot;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+const { CardDAVServer } = ChromeUtils.import(</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  &quot;resource://testing-common/CardDAVServer.jsm&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+do_get_profile();</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+async function checkCardsOnServer(expectedCards) {</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  // Send a request to the server. When the server responds, we know it has</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  // completed all earlier requests.</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  await fetch(`${CardDAVServer.url}/ping`);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  let actualCards = [...CardDAVServer.cards];</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  Assert.equal(actualCards.length, Object.keys(expectedCards).length);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  for (let [href, { etag, vCard }] of actualCards) {</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    let baseName = href</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+      .substring(CardDAVServer.path.length)</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+      .replace(/\.vcf$/, &quot;&quot;);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    info(baseName);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    Assert.equal(etag, expectedCards[baseName].etag);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    Assert.equal(href, expectedCards[baseName].href);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+    Assert.equal(vCard, expectedCards[baseName].vCard);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  }</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+}</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+let observer = {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  notifications: {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  },</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  pendingPromise: null,</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  init() {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    for (let key of Object.keys(this.notifications)) {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+      Services.obs.addObserver(observer, key);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    }</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  },</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  checkAndClearNotifications(expected) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    Assert.deepEqual(this.notifications, expected);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    for (let array of Object.values(this.notifications)) {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+      array.length = 0;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    }</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  },</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  observe(subject, topic) {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    let uid = subject.QueryInterface(Ci.nsIAbCard).UID;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    if (this.pendingPromise &amp;&amp; this.pendingPromise.topic == topic) {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+      let promise = this.pendingPromise;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+      this.pendingPromise = null;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+      promise.resolve(uid);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+      return;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    }</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+    this.notifications[topic].push(uid);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  },</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  waitFor(topic) {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+      this.pendingPromise = { resolve, topic };</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    });</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  },</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+};</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  CardDAVServer.open();</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  registerCleanupFunction(async () =&gt; {</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+    await CardDAVServer.close();</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  });</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardDAV_sync.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,269 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+  // Put some cards on the server.</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    &quot;keep-me.vcf&quot;,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:keep-me\r\nFN:I'm going to stay.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  );</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    &quot;change-me.vcf&quot;,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:change-me\r\nFN:I'm going to be changed.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  );</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    &quot;delete-me.vcf&quot;,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:delete-me\r\nFN:I'm going to be deleted.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  );</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  // Set up a new directory and get the cards from the server. Do this by</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+  // creating an instance of CardDAVDirectory rather than through the address</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  // book manager, so that we can access the internals of the directory.</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    &quot;ldap_2.servers.carddav.description&quot;,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    &quot;CardDAV Test&quot;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  );</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    &quot;ldap_2.servers.carddav.carddav.url&quot;,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    CardDAVServer.url</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  );</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  Services.prefs.setIntPref(&quot;ldap_2.servers.carddav.dirType&quot;, 102);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    &quot;ldap_2.servers.carddav.filename&quot;,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    &quot;carddav.sqlite&quot;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  );</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  // Save a username and password to the login manager.</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  let loginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    Ci.nsILoginInfo</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  );</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+  loginInfo.init(</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+    new URL(CardDAVServer.url).origin,</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+    null,</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+    &quot;test&quot;,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    &quot;bob&quot;,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    &quot;bob&quot;,</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    &quot;&quot;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  );</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  Services.logins.addLogin(loginInfo);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  CardDAVServer.setUsernameAndPassword(&quot;bob&quot;, &quot;bob&quot;);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  let directory = new CardDAVDirectory();</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  directory.init(&quot;jscarddav://carddav.sqlite&quot;);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  // We'll only use this for the initial sync, so I think it's okay to use</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  // _bulkAddCards and not get a notification for every contact.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  info(&quot;Initial sync with server.&quot;);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  await directory.fetchAllFromServer();</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  info(&quot;Cards:&quot;);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  let cardMap = new Map();</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+  let oldETags = new Map();</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+    info(card.displayName);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    info(card.getProperty(&quot;_href&quot;, &quot;&quot;));</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+    info(card.getProperty(&quot;_etag&quot;, &quot;&quot;));</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+    cardMap.set(card.UID, card);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    oldETags.set(card.UID, card.getProperty(&quot;_etag&quot;));</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  }</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  Assert.equal(cardMap.size, 3);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  Assert.deepEqual([...cardMap.keys()].sort(), [</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    &quot;change-me&quot;,</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    &quot;delete-me&quot;,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+    &quot;keep-me&quot;,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  ]);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  Assert.equal(</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+    cardMap.get(&quot;change-me&quot;).displayName,</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+    &quot;I'm going to be changed.&quot;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  );</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  // Make some changes on the server.</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    &quot;change-me.vcf&quot;,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:change-me\r\nFN:I've been changed.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  );</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+  CardDAVServer.deleteCardInternal(&quot;delete-me.vcf&quot;);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+    &quot;new.vcf&quot;,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:new\r\nFN:I'm new!\r\nEND:VCARD\r\n&quot;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  );</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  // Sync with the server.</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  info(&quot;Second sync with server.&quot;);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  observer.init();</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  await directory.updateAllFromServer();</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [&quot;new&quot;],</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [&quot;change-me&quot;],</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [&quot;delete-me&quot;],</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+  });</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  info(&quot;Cards:&quot;);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  cardMap.clear();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    info(card.displayName);</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    info(card.getProperty(&quot;_href&quot;, &quot;&quot;));</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    info(card.getProperty(&quot;_etag&quot;, &quot;&quot;));</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+    cardMap.set(card.UID, card);</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  }</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  Assert.equal(cardMap.size, 3);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  Assert.deepEqual([...cardMap.keys()].sort(), [&quot;change-me&quot;, &quot;keep-me&quot;, &quot;new&quot;]);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  Assert.equal(</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+    cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    oldETags.get(&quot;keep-me&quot;)</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  );</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  Assert.equal(cardMap.get(&quot;change-me&quot;).displayName, &quot;I've been changed.&quot;);</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+    cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    oldETags.get(&quot;change-me&quot;)</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  );</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+  oldETags.set(&quot;change-me&quot;, cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;));</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  Assert.equal(cardMap.get(&quot;new&quot;).displayName, &quot;I'm new!&quot;);</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  oldETags.set(&quot;new&quot;, cardMap.get(&quot;new&quot;).getProperty(&quot;_etag&quot;));</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  oldETags.delete(&quot;delete-me&quot;);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+  // Double-check that what we have matches what's on the server.</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    },</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    },</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+    new: {</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+      etag: cardMap.get(&quot;new&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+      href: cardMap.get(&quot;new&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+      vCard: cardMap.get(&quot;new&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+    },</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  });</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+  info(&quot;Third sync with server. No changes expected.&quot;);</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+  await directory.updateAllFromServer();</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  });</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+  // Delete a card on the client.</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+  info(&quot;Deleting a card on the client.&quot;);</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  directory.deleteCards([cardMap.get(&quot;new&quot;)]);</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [&quot;new&quot;],</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  });</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+    },</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    },</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  });</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+  // Change a card on the client.</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+  info(&quot;Changing a card on the client.&quot;);</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+  let changeMeCard = cardMap.get(&quot;change-me&quot;);</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+  changeMeCard.displayName = &quot;I've been changed again!&quot;;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  directory.modifyCard(changeMeCard);</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [&quot;change-me&quot;],</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  });</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+  Assert.equal(await observer.waitFor(&quot;addrbook-contact-updated&quot;), &quot;change-me&quot;);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+      etag: changeMeCard.getProperty(&quot;_etag&quot;),</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      href: changeMeCard.getProperty(&quot;_href&quot;),</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+      vCard: changeMeCard.getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+    },</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+    },</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+  });</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  // Add a new card on the client.</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+  info(&quot;Adding a new card on the client.&quot;);</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+  let newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+    Ci.nsIAbCard</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+  );</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  newCard.displayName = &quot;I'm another new contact.&quot;;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+  newCard.UID = &quot;another-new&quot;;</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+  newCard = directory.addCard(newCard);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [&quot;another-new&quot;],</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  });</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+  Assert.equal(</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+    await observer.waitFor(&quot;addrbook-contact-updated&quot;),</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+    &quot;another-new&quot;</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  );</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+    &quot;another-new&quot;: {</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+      etag: newCard.getProperty(&quot;_etag&quot;),</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+      href: newCard.getProperty(&quot;_href&quot;),</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+      vCard: newCard.getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+    },</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+    },</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+    },</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  });</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  info(&quot;Fourth sync with server. No changes expected.&quot;);</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+  await directory.updateAllFromServer();</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+  });</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardDAV_syncV2.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,283 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+  // Put some cards on the server.</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    &quot;keep-me.vcf&quot;,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:keep-me\r\nFN:I'm going to stay.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  );</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    &quot;change-me.vcf&quot;,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:change-me\r\nFN:I'm going to be changed.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  );</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    &quot;delete-me.vcf&quot;,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:delete-me\r\nFN:I'm going to be deleted.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+  );</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  // Set up a new directory and get the cards from the server. Do this by</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+  // creating an instance of CardDAVDirectory rather than through the address</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  // book manager, so that we can access the internals of the directory.</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+    &quot;ldap_2.servers.carddav.description&quot;,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    &quot;CardDAV Test&quot;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+  );</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+    &quot;ldap_2.servers.carddav.carddav.url&quot;,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    CardDAVServer.url</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  );</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  Services.prefs.setIntPref(&quot;ldap_2.servers.carddav.dirType&quot;, 102);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    &quot;ldap_2.servers.carddav.filename&quot;,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    &quot;carddav.sqlite&quot;</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+  );</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  // Save a username and password to the login manager.</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  let loginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    Ci.nsILoginInfo</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  );</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  loginInfo.init(</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    new URL(CardDAVServer.url).origin,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    null,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+    &quot;test&quot;,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    &quot;bob&quot;,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    &quot;bob&quot;,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    &quot;&quot;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  );</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  Services.logins.addLogin(loginInfo);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+  CardDAVServer.setUsernameAndPassword(&quot;bob&quot;, &quot;bob&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  let directory = new CardDAVDirectory();</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  directory.init(&quot;jscarddav://carddav.sqlite&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  info(&quot;Getting sync token.&quot;);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  await directory.getSyncToken();</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  let lastSyncToken = directory._syncToken;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  info(`Token is: ${lastSyncToken}`);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  // We'll only use this for the initial sync, so I think it's okay to use</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  // _bulkAddCards and not get a notification for every contact.</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  info(&quot;Initial sync with server.&quot;);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  await directory.fetchAllFromServer();</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  info(&quot;Cards:&quot;);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  let cardMap = new Map();</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  let oldETags = new Map();</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+    info(card.displayName);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    info(card.getProperty(&quot;_href&quot;, &quot;&quot;));</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+    info(card.getProperty(&quot;_etag&quot;, &quot;&quot;));</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+    cardMap.set(card.UID, card);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    oldETags.set(card.UID, card.getProperty(&quot;_etag&quot;));</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  }</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  Assert.equal(cardMap.size, 3);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  Assert.deepEqual([...cardMap.keys()].sort(), [</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    &quot;change-me&quot;,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+    &quot;delete-me&quot;,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    &quot;keep-me&quot;,</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  ]);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  Assert.equal(</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    cardMap.get(&quot;change-me&quot;).displayName,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    &quot;I'm going to be changed.&quot;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  );</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  // Make some changes on the server.</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+    &quot;change-me.vcf&quot;,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:change-me\r\nFN:I've been changed.\r\nEND:VCARD\r\n&quot;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  );</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  CardDAVServer.deleteCardInternal(&quot;delete-me.vcf&quot;);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  CardDAVServer.putCardInternal(</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+    &quot;new.vcf&quot;,</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+    &quot;BEGIN:VCARD\r\nUID:new\r\nFN:I'm new!\r\nEND:VCARD\r\n&quot;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  );</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  // Sync with the server.</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+  info(&quot;Second sync with server.&quot;);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  observer.init();</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  await directory.updateAllFromServerV2();</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  Assert.notEqual(directory._syncToken, lastSyncToken);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  lastSyncToken = directory._syncToken;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [&quot;new&quot;],</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [&quot;change-me&quot;],</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [&quot;delete-me&quot;],</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  });</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  info(&quot;Cards:&quot;);</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  cardMap.clear();</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  for (let card of directory.childCards) {</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+    info(card.displayName);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    info(card.getProperty(&quot;_href&quot;, &quot;&quot;));</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+    info(card.getProperty(&quot;_etag&quot;, &quot;&quot;));</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+    cardMap.set(card.UID, card);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  }</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  Assert.equal(cardMap.size, 3);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+  Assert.deepEqual([...cardMap.keys()].sort(), [&quot;change-me&quot;, &quot;keep-me&quot;, &quot;new&quot;]);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  Assert.equal(</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+    cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+    oldETags.get(&quot;keep-me&quot;)</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+  );</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  Assert.equal(cardMap.get(&quot;change-me&quot;).displayName, &quot;I've been changed.&quot;);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+    cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+    oldETags.get(&quot;change-me&quot;)</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  );</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  oldETags.set(&quot;change-me&quot;, cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;));</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+  Assert.equal(cardMap.get(&quot;new&quot;).displayName, &quot;I'm new!&quot;);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  oldETags.set(&quot;new&quot;, cardMap.get(&quot;new&quot;).getProperty(&quot;_etag&quot;));</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  oldETags.delete(&quot;delete-me&quot;);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+  // Double-check that what we have matches what's on the server.</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+    },</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+    },</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    new: {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+      etag: cardMap.get(&quot;new&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+      href: cardMap.get(&quot;new&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+      vCard: cardMap.get(&quot;new&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    },</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  });</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+  info(&quot;Third sync with server. No changes expected.&quot;);</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+  await directory.updateAllFromServerV2();</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  // This time the token should NOT change, there's been no contact with the</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+  // server since last time.</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  Assert.equal(directory._syncToken, lastSyncToken);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  lastSyncToken = directory._syncToken;</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+  });</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+  // Delete a card on the client.</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  info(&quot;Deleting a card on the client.&quot;);</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+  directory.deleteCards([cardMap.get(&quot;new&quot;)]);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [&quot;new&quot;],</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+  });</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    },</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+    },</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+  });</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+  // Change a card on the client.</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+  info(&quot;Changing a card on the client.&quot;);</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+  let changeMeCard = cardMap.get(&quot;change-me&quot;);</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+  changeMeCard.displayName = &quot;I've been changed again!&quot;;</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+  directory.modifyCard(changeMeCard);</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [&quot;change-me&quot;],</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+  });</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+  Assert.equal(await observer.waitFor(&quot;addrbook-contact-updated&quot;), &quot;change-me&quot;);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+      etag: changeMeCard.getProperty(&quot;_etag&quot;),</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+      href: changeMeCard.getProperty(&quot;_href&quot;),</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+      vCard: changeMeCard.getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+    },</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    },</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+  });</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+  // Add a new card on the client.</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+  info(&quot;Adding a new card on the client.&quot;);</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+  let newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+    Ci.nsIAbCard</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+  );</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+  newCard.displayName = &quot;I'm another new contact.&quot;;</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+  newCard.UID = &quot;another-new&quot;;</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+  newCard = directory.addCard(newCard);</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [&quot;another-new&quot;],</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+  });</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+  Assert.equal(</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+    await observer.waitFor(&quot;addrbook-contact-updated&quot;),</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+    &quot;another-new&quot;</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+  );</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+  await checkCardsOnServer({</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+    &quot;another-new&quot;: {</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+      etag: newCard.getProperty(&quot;_etag&quot;),</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+      href: newCard.getProperty(&quot;_href&quot;),</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+      vCard: newCard.getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+    },</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+    &quot;change-me&quot;: {</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+      etag: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+      href: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+      vCard: cardMap.get(&quot;change-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+    },</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+    &quot;keep-me&quot;: {</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+      etag: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_etag&quot;),</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+      href: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_href&quot;),</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+      vCard: cardMap.get(&quot;keep-me&quot;).getProperty(&quot;_vCard&quot;),</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+    },</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  });</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+  info(&quot;Fourth sync with server. No changes expected.&quot;);</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+  await directory.updateAllFromServerV2();</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+  Assert.notEqual(directory._syncToken, lastSyncToken);</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+  lastSyncToken = directory._syncToken;</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+  observer.checkAndClearNotifications({</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+    &quot;addrbook-contact-created&quot;: [],</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+    &quot;addrbook-contact-updated&quot;: [],</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+    &quot;addrbook-contact-deleted&quot;: [],</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+  });</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -5,16 +5,22 @@ tags = addrbook</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> [test_basic_nsIAbCard.js]</span>
<a href="#l13.6"></a><span id="l13.6"> [test_basic_nsIAbDirectory.js]</span>
<a href="#l13.7"></a><span id="l13.7"> [test_bug387403.js]</span>
<a href="#l13.8"></a><span id="l13.8"> tags = vcard</span>
<a href="#l13.9"></a><span id="l13.9"> [test_bug448165.js]</span>
<a href="#l13.10"></a><span id="l13.10"> [test_bug534822.js]</span>
<a href="#l13.11"></a><span id="l13.11"> [test_bug1522453.js]</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+[test_cardDAV_sync.js]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+head = head_cardDAV.js</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+tags = vcard</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+[test_cardDAV_syncV2.js]</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+head = head_cardDAV.js</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+tags = vcard</span>
<a href="#l13.18"></a><span id="l13.18"> [test_cardForEmail.js]</span>
<a href="#l13.19"></a><span id="l13.19"> [test_collection.js]</span>
<a href="#l13.20"></a><span id="l13.20"> [test_collection_2.js]</span>
<a href="#l13.21"></a><span id="l13.21"> [test_db_enumerator.js]</span>
<a href="#l13.22"></a><span id="l13.22"> [test_delete_book.js]</span>
<a href="#l13.23"></a><span id="l13.23"> [test_export.js]</span>
<a href="#l13.24"></a><span id="l13.24"> tags = vcard</span>
<a href="#l13.25"></a><span id="l13.25"> [test_jsaddrbook.js]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

