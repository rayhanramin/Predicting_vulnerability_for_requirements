<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2184:996cdbab71a91ad267a26fd9f92d10ff0cd9a90d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 996cdbab71a91ad267a26fd9f92d10ff0cd9a90d" />
<meta property="og:url" content="/comm-central/rev/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d" />
<meta property="og:description" content="Bug 481676 - &quot;Move bayes listeners to nsMsgDBFolder&quot; [r=neil sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 996cdbab71a91ad267a26fd9f92d10ff0cd9a90d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">shortlog</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">files</a> |
changeset |
<a href="/comm-central/raw-rev/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">raw</a>  | <a href="/comm-central/archive/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481676">Bug 481676</a> - &quot;Move bayes listeners to nsMsgDBFolder&quot; [r=neil sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 11 Mar 2009 19:53:12 +0000</td></tr>

<tr>
 <td>changeset 2184</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">996cdbab71a91ad267a26fd9f92d10ff0cd9a90d</a></td>
</tr>



<tr>
<td>parent 2183</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a4305dcef0180bc0a6768f5ead0428211a0aedf9">a4305dcef0180bc0a6768f5ead0428211a0aedf9</a>
</td>
</tr>

<tr>
<td>child 2185</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/92b814189264999c947ed7fa9e332da62b86efe4">92b814189264999c947ed7fa9e332da62b86efe4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=996cdbab71a91ad267a26fd9f92d10ff0cd9a90d">1768</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 11 Mar 2009 19:57:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@92b814189264 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=92b814189264999c947ed7fa9e332da62b86efe4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=92b814189264999c947ed7fa9e332da62b86efe4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=92b814189264999c947ed7fa9e332da62b86efe4&newProject=comm-central&newRevision=a4305dcef0180bc0a6768f5ead0428211a0aedf9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=92b814189264999c947ed7fa9e332da62b86efe4&newProject=comm-central&newRevision=a4305dcef0180bc0a6768f5ead0428211a0aedf9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=92b814189264999c947ed7fa9e332da62b86efe4&newProject=comm-central&newRevision=a4305dcef0180bc0a6768f5ead0428211a0aedf9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481676">481676</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=481676">Bug 481676</a> - &quot;Move bayes listeners to nsMsgDBFolder&quot; [r=neil sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">mailnews/base/search/public/nsIMsgFilterPlugin.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/search/public/nsIMsgFilterPlugin.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/996cdbab71a91ad267a26fd9f92d10ff0cd9a90d/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterPlugin.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterPlugin.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -70,38 +70,44 @@ interface nsIMsgFilterPlugin : nsISuppor</span>
<a href="#l1.4"></a><span id="l1.4"> /*</span>
<a href="#l1.5"></a><span id="l1.5">  * These interfaces typically implement a Bayesian classifier of messages.</span>
<a href="#l1.6"></a><span id="l1.6">  *</span>
<a href="#l1.7"></a><span id="l1.7">  * Two sets of interfaces may be used: the older junk-only interfaces, and</span>
<a href="#l1.8"></a><span id="l1.8">  * the newer trait-oriented interfaces that treat junk classification as</span>
<a href="#l1.9"></a><span id="l1.9">  * one of a set of classifications to accomplish.</span>
<a href="#l1.10"></a><span id="l1.10">  */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * Inform a listener of a message's classification aClassification, which</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- * can be one of 3 values:  UNCLASSIFIED, GOOD, or JUNK.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">- * Pass the indicator aJunkPercent, where 0 is not junk,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">- * 100 is junk, and intermediate values represent varying uncertainty.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">- */</span>
<a href="#l1.18"></a><span id="l1.18"> [scriptable, uuid(b15a0f9c-df07-4af0-9ba8-80dca68ac35d)]</span>
<a href="#l1.19"></a><span id="l1.19"> interface nsIJunkMailClassificationListener : nsISupports</span>
<a href="#l1.20"></a><span id="l1.20"> {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-    void onMessageClassified(in string aMsgURI,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-      in nsMsgJunkStatus aClassification,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-      in PRUint32 aJunkPercent);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+  /**</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+   * Inform a listener of a message's classification as junk. At the end</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+   * of a batch of classifications, signify end of batch by calling with</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+   * null aMsgURI (other parameters are don't care)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+   *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+   * @param aMsgURI          URI of the message that was classified.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+   * @param aClassification  classification of message as UNCLASSIFIED, GOOD,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   *                         or JUNK.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * @param aJunkPercent     indicator of degree of uncertainty, with 100 being</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   *                         probably junk, and 0 probably good</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+   */</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  void onMessageClassified(in string aMsgURI,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                           in nsMsgJunkStatus aClassification,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                           in PRUint32 aJunkPercent);</span>
<a href="#l1.39"></a><span id="l1.39"> };</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> [scriptable, uuid(AF247D07-72F0-482d-9EAB-5A786407AA4C)]</span>
<a href="#l1.42"></a><span id="l1.42"> interface nsIMsgTraitClassificationListener : nsISupports</span>
<a href="#l1.43"></a><span id="l1.43"> {</span>
<a href="#l1.44"></a><span id="l1.44">   /**</span>
<a href="#l1.45"></a><span id="l1.45">    * Inform a listener of a message's match to traits. The list</span>
<a href="#l1.46"></a><span id="l1.46">    * of traits being matched is in aTraits. Corresponding</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-   * indicator of match (percent) is in aPercents.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+   * indicator of match (percent) is in aPercents. At the end</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+   * of a batch of classifications, signify end of batch by calling with</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+   * null aMsgURI (other parameters are don't care)</span>
<a href="#l1.51"></a><span id="l1.51">    *</span>
<a href="#l1.52"></a><span id="l1.52">    * @param aMsgURI      URI of the message that was classified</span>
<a href="#l1.53"></a><span id="l1.53">    * @param aTraitCount  length of aTraits and aPercents arrays</span>
<a href="#l1.54"></a><span id="l1.54">    * @param aTraits      array of matched trait ids</span>
<a href="#l1.55"></a><span id="l1.55">    * @param aPercents    array of percent match (0 is unmatched, 100 is fully</span>
<a href="#l1.56"></a><span id="l1.56">    *                     matched) of the trait with the corresponding array</span>
<a href="#l1.57"></a><span id="l1.57">    *                     index in aTraits</span>
<a href="#l1.58"></a><span id="l1.58">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -143,19 +143,21 @@ PRUnichar *nsMsgDBFolder::kLocalizedTemp</span>
<a href="#l2.4"></a><span id="l2.4"> PRUnichar *nsMsgDBFolder::kLocalizedUnsentName;</span>
<a href="#l2.5"></a><span id="l2.5"> PRUnichar *nsMsgDBFolder::kLocalizedJunkName;</span>
<a href="#l2.6"></a><span id="l2.6"> PRUnichar *nsMsgDBFolder::kLocalizedArchivesName;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> PRUnichar *nsMsgDBFolder::kLocalizedBrandShortName;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> nsrefcnt nsMsgDBFolder::mInstanceCount=0;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED4(nsMsgDBFolder, nsRDFResource, </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED6(nsMsgDBFolder, nsRDFResource, </span>
<a href="#l2.14"></a><span id="l2.14">                              nsISupportsWeakReference, nsIMsgFolder,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-                             nsIDBChangeListener, nsIUrlListener)</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                             nsIDBChangeListener, nsIUrlListener,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                             nsIJunkMailClassificationListener,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+                             nsIMsgTraitClassificationListener)</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> const nsStaticAtom nsMsgDBFolder::folder_atoms[] = {</span>
<a href="#l2.21"></a><span id="l2.21">   { &quot;FolderLoaded&quot;, &amp;nsMsgDBFolder::mFolderLoadedAtom },</span>
<a href="#l2.22"></a><span id="l2.22">   { &quot;DeleteOrMoveMsgCompleted&quot;, &amp;nsMsgDBFolder::mDeleteOrMoveMsgCompletedAtom },</span>
<a href="#l2.23"></a><span id="l2.23">   { &quot;DeleteOrMoveMsgFailed&quot;, &amp;nsMsgDBFolder::mDeleteOrMoveMsgFailedAtom },</span>
<a href="#l2.24"></a><span id="l2.24">   { &quot;JunkStatusChanged&quot;, &amp;nsMsgDBFolder::mJunkStatusChangedAtom },</span>
<a href="#l2.25"></a><span id="l2.25">   { &quot;BiffState&quot;, &amp;nsMsgDBFolder::kBiffStateAtom },</span>
<a href="#l2.26"></a><span id="l2.26">   { &quot;NewMailReceived&quot;, &amp;nsMsgDBFolder::kNewMailReceivedAtom },</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -2018,27 +2020,163 @@ nsMsgDBFolder::GetInheritedStringPropert</span>
<a href="#l2.28"></a><span id="l2.28">     if (parent)</span>
<a href="#l2.29"></a><span id="l2.29">       return parent-&gt;GetInheritedStringProperty(aPropertyName, aPropertyValue);</span>
<a href="#l2.30"></a><span id="l2.30">   }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   aPropertyValue.Assign(value);</span>
<a href="#l2.33"></a><span id="l2.33">   return NS_OK;</span>
<a href="#l2.34"></a><span id="l2.34"> }</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-// sub-classes need to override</span>
<a href="#l2.37"></a><span id="l2.37"> nsresult</span>
<a href="#l2.38"></a><span id="l2.38"> nsMsgDBFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l2.39"></a><span id="l2.39"> {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessage(aURI, aMsgWindow, nsnull);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  PRUint32 count;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  return rv;</span>
<a href="#l2.55"></a><span id="l2.55"> }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> nsresult</span>
<a href="#l2.58"></a><span id="l2.58"> nsMsgDBFolder::SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l2.59"></a><span id="l2.59"> {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessages(aURICount, aURIArray, aMsgWindow, nsnull);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  PRUint32 count;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  return rv;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+}</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+nsMsgDBFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+                                   nsMsgJunkStatus aClassification,</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+                                   PRUint32 aJunkPercent)</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+{</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  if (!aMsgURI)</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+    return NS_OK;; // ignore end-of-batch signal</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  // check if this message needs junk classification</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+  if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+    AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    nsCAutoString msgJunkScore;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    nsCAutoString strPercent;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    strPercent.AppendInt(aJunkPercent);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strPercent.get());</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      // IMAP has its own way of marking read.</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+      if (!(mFlags &amp; nsMsgFolderFlags::ImapBox))</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+      {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+        PRBool markAsReadOnSpam;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+        (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+        if (markAsReadOnSpam)</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+        {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+          rv = mDatabase-&gt;MarkRead(msgKey, true, this);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+          if (!NS_SUCCEEDED(rv))</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+            NS_WARNING(&quot;failed marking spam message as read&quot;);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+        }</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+      }</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+      // mail folders will log junk hits with move info. Perhaps we should</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+      // add a log here for non-mail folders as well, that don't override</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+      // onMessageClassified</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      //rv = spamSettings-&gt;LogJunkHit(msgHdr, PR_FALSE);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+      //NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    }</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+}</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+nsMsgDBFolder::OnMessageTraitsClassified(const char *aMsgURI,</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+                                         PRUint32 aTraitCount,</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+                                         PRUint32 *aTraits,</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+                                         PRUint32 *aPercents)</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+{</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  if (!aMsgURI) // This signifies end of batch</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    return NS_OK; // We are not handling batching</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+  </span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  if (!(processingFlags &amp; nsMsgProcessingFlags::ClassifyTraits))</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  for (PRUint32 i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  {</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+      continue; // junk is processed by the junk listener</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    nsCAutoString traitId;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+    rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    traitId.Insert(NS_LITERAL_CSTRING(&quot;bayespercent/&quot;), 0);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    nsCAutoString strPercent;</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    strPercent.AppendInt(aPercents[i]);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+    mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  }</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.186"></a><span id="l2.186"> }</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188"> /**</span>
<a href="#l2.189"></a><span id="l2.189">  * Call the filter plugins (XXX currently just one)</span>
<a href="#l2.190"></a><span id="l2.190">  */</span>
<a href="#l2.191"></a><span id="l2.191"> NS_IMETHODIMP</span>
<a href="#l2.192"></a><span id="l2.192"> nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, PRBool *aFiltersRun)</span>
<a href="#l2.193"></a><span id="l2.193"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -55,42 +55,46 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsITransport.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> class nsIMsgFolderCacheElement;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-class nsIJunkMailPlugin;</span>
<a href="#l3.15"></a><span id="l3.15"> class nsICollation;</span>
<a href="#l3.16"></a><span id="l3.16"> class nsMsgKeySetU;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">  /* </span>
<a href="#l3.19"></a><span id="l3.19">   * nsMsgDBFolder</span>
<a href="#l3.20"></a><span id="l3.20">   * class derived from nsMsgFolder for those folders that use an nsIMsgDatabase</span>
<a href="#l3.21"></a><span id="l3.21">   */ </span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> #undef IMETHOD_VISIBILITY</span>
<a href="#l3.24"></a><span id="l3.24"> #define IMETHOD_VISIBILITY NS_VISIBILITY_DEFAULT</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> class NS_MSG_BASE nsMsgDBFolder: public nsRDFResource,</span>
<a href="#l3.27"></a><span id="l3.27">                                  public nsSupportsWeakReference,</span>
<a href="#l3.28"></a><span id="l3.28">                                  public nsIMsgFolder,</span>
<a href="#l3.29"></a><span id="l3.29">                                  public nsIDBChangeListener,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                                 public nsIUrlListener</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+                                 public nsIUrlListener,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                                 public nsIJunkMailClassificationListener,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+                                 public nsIMsgTraitClassificationListener</span>
<a href="#l3.34"></a><span id="l3.34"> {</span>
<a href="#l3.35"></a><span id="l3.35"> public: </span>
<a href="#l3.36"></a><span id="l3.36">   nsMsgDBFolder(void);</span>
<a href="#l3.37"></a><span id="l3.37">   virtual ~nsMsgDBFolder(void);</span>
<a href="#l3.38"></a><span id="l3.38">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l3.39"></a><span id="l3.39">   NS_DECL_NSIMSGFOLDER</span>
<a href="#l3.40"></a><span id="l3.40">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l3.41"></a><span id="l3.41">   NS_DECL_NSIURLLISTENER</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l3.44"></a><span id="l3.44">   </span>
<a href="#l3.45"></a><span id="l3.45">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l3.46"></a><span id="l3.46">   NS_IMETHOD ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   // nsRDFResource overrides</span>
<a href="#l3.49"></a><span id="l3.49">   NS_IMETHOD Init(const char* aURI);</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">   // These functions are used for tricking the front end into thinking that we have more </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1146,16 +1146,21 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">     {</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">       if (++mCurMessageToClassify &lt; mNumMessagesToClassify &amp;&amp; mMessageURIs[mCurMessageToClassify]) {</span>
<a href="#l4.7"></a><span id="l4.7">         PR_LOG(BayesianFilterLogModule, PR_LOG_WARNING, (&quot;classifyNextMessage(%s)&quot;, mMessageURIs[mCurMessageToClassify]));</span>
<a href="#l4.8"></a><span id="l4.8">         mFilter-&gt;tokenizeMessage(mMessageURIs[mCurMessageToClassify], mMsgWindow, this);</span>
<a href="#l4.9"></a><span id="l4.9">       }</span>
<a href="#l4.10"></a><span id="l4.10">       else</span>
<a href="#l4.11"></a><span id="l4.11">       {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+        // call all listeners with null parameters to signify end of batch</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+        if (mJunkListener)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+          mJunkListener-&gt;OnMessageClassified(nsnull, nsnull, nsnull);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+        if (mTraitListener)</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+          mTraitListener-&gt;OnMessageTraitsClassified(nsnull, nsnull, nsnull, nsnull);</span>
<a href="#l4.17"></a><span id="l4.17">         mTokenListener = nsnull; // this breaks the circular ref that keeps this object alive</span>
<a href="#l4.18"></a><span id="l4.18">                                  // so we will be destroyed as a result.</span>
<a href="#l4.19"></a><span id="l4.19">       }</span>
<a href="#l4.20"></a><span id="l4.20">     }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> private:</span>
<a href="#l4.23"></a><span id="l4.23">     nsBayesianFilter* mFilter;</span>
<a href="#l4.24"></a><span id="l4.24">     nsCOMPtr&lt;nsISupports&gt; mSupports;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_bug228675.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -72,16 +72,18 @@ function run_test()</span>
<a href="#l5.4"></a><span id="l5.4">   nsIJunkMailPlugin.setMessageClassification(getSpec(email),</span>
<a href="#l5.5"></a><span id="l5.5">     kUnclassified, classification, null, doTestingListener);</span>
<a href="#l5.6"></a><span id="l5.6"> }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var doTestingListener = </span>
<a href="#l5.9"></a><span id="l5.9"> {</span>
<a href="#l5.10"></a><span id="l5.10">   onMessageClassified: function(aMsgURI, aClassification, aJunkPercent)</span>
<a href="#l5.11"></a><span id="l5.11">   {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    if (!aMsgURI)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      return; // ignore end-of-batch signal</span>
<a href="#l5.14"></a><span id="l5.14">     var email = emails.shift();</span>
<a href="#l5.15"></a><span id="l5.15">     var classification = classifications.shift();</span>
<a href="#l5.16"></a><span id="l5.16">     if (email)</span>
<a href="#l5.17"></a><span id="l5.17">     { nsIJunkMailPlugin.setMessageClassification(getSpec(email),</span>
<a href="#l5.18"></a><span id="l5.18">           kUnclassified, classification, null, doTestingListener);</span>
<a href="#l5.19"></a><span id="l5.19">       return;</span>
<a href="#l5.20"></a><span id="l5.20">     }</span>
<a href="#l5.21"></a><span id="l5.21">     </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_junkAsTraits.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -311,16 +311,18 @@ function run_test()</span>
<a href="#l6.4"></a><span id="l6.4">   startCommand();</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> var junkListener =</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9"> // nsIJunkMailClassificationListener implementation</span>
<a href="#l6.10"></a><span id="l6.10">   onMessageClassified: function(aMsgURI, aClassification, aJunkPercent)</span>
<a href="#l6.11"></a><span id="l6.11">   {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    if (!aMsgURI)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      return; // ignore end-of-batch signal</span>
<a href="#l6.14"></a><span id="l6.14">     //print(&quot;Message URI is &quot; + aMsgURI);</span>
<a href="#l6.15"></a><span id="l6.15">     //print(&quot;Junk percent is &quot; + aJunkPercent);</span>
<a href="#l6.16"></a><span id="l6.16">     //print(&quot;Classification is &quot; + aClassification);</span>
<a href="#l6.17"></a><span id="l6.17">     var command = gTest.command;</span>
<a href="#l6.18"></a><span id="l6.18">     var junkPercent = gTest.junkPercent;</span>
<a href="#l6.19"></a><span id="l6.19">     // file returned correctly</span>
<a href="#l6.20"></a><span id="l6.20">     do_check_eq(getSpec(gTest.fileName), aMsgURI);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -359,16 +361,18 @@ var junkListener =</span>
<a href="#l6.23"></a><span id="l6.23">   }</span>
<a href="#l6.24"></a><span id="l6.24"> };</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> var traitListener =</span>
<a href="#l6.27"></a><span id="l6.27"> {</span>
<a href="#l6.28"></a><span id="l6.28">   //nsIMsgTraitClassificationListener implementation</span>
<a href="#l6.29"></a><span id="l6.29">   onMessageTraitsClassified: function(aMsgURI, {}, aTraits, aPercents)</span>
<a href="#l6.30"></a><span id="l6.30">   {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+    if (!aMsgURI)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      return; //ignore end-of-batch signal</span>
<a href="#l6.33"></a><span id="l6.33">     //print(&quot;(Trait Listener)Message URI is &quot; + aMsgURI);</span>
<a href="#l6.34"></a><span id="l6.34">     //print(&quot;(Trait Listener)Junk percent is &quot; + aPercents);</span>
<a href="#l6.35"></a><span id="l6.35">     var command = gTest.command;</span>
<a href="#l6.36"></a><span id="l6.36">     var junkPercent = gTest.junkPercent;</span>
<a href="#l6.37"></a><span id="l6.37">     //print(&quot;command, junkPercent is &quot; + command + &quot; , &quot; + junkPercent);</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">     do_check_eq(getSpec(gTest.fileName), aMsgURI);</span>
<a href="#l6.40"></a><span id="l6.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/test_traits.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -141,16 +141,18 @@ function run_test()</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> var listener =</span>
<a href="#l7.7"></a><span id="l7.7"> {</span>
<a href="#l7.8"></a><span id="l7.8">   //nsIMsgTraitClassificationListener implementation</span>
<a href="#l7.9"></a><span id="l7.9">   onMessageTraitsClassified: function(aMsgURI, {}, aTraits, aPercents)</span>
<a href="#l7.10"></a><span id="l7.10">   {</span>
<a href="#l7.11"></a><span id="l7.11">     //print(&quot;Message URI is &quot; + aMsgURI);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+    if (!aMsgURI)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      return; //ignore end-of-batch signal</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">     switch (gTest.command)</span>
<a href="#l7.16"></a><span id="l7.16">     {</span>
<a href="#l7.17"></a><span id="l7.17">       case kClass:</span>
<a href="#l7.18"></a><span id="l7.18">         do_check_eq(gTest.files[gTest.currentIndex], aMsgURI);</span>
<a href="#l7.19"></a><span id="l7.19">         var currentPercents = gTest.percents[gTest.currentIndex];</span>
<a href="#l7.20"></a><span id="l7.20">         for (var i = 0; i &lt; currentPercents.length; i++)</span>
<a href="#l7.21"></a><span id="l7.21">         {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -119,17 +119,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;prprf.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsMsgReadStateTxn.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l8.17"></a><span id="l8.17"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l8.18"></a><span id="l8.18"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> nsIAtom* nsImapMailFolder::mImapHdrDownloadedAtom=nsnull;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -240,17 +239,16 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l8.22"></a><span id="l8.22">   m_numServerUnseenMessages = 0;</span>
<a href="#l8.23"></a><span id="l8.23">   m_numServerTotalMessages = 0;</span>
<a href="#l8.24"></a><span id="l8.24">   m_nextUID = nsMsgKey_None;</span>
<a href="#l8.25"></a><span id="l8.25">   m_hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l8.26"></a><span id="l8.26">   m_folderACL = nsnull;</span>
<a href="#l8.27"></a><span id="l8.27">   m_aclFlags = 0;</span>
<a href="#l8.28"></a><span id="l8.28">   m_supportedUserFlags = 0;</span>
<a href="#l8.29"></a><span id="l8.29">   m_namespace = nsnull;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  m_numFilterClassifyRequests = 0;</span>
<a href="#l8.31"></a><span id="l8.31">   m_pendingPlaybackReq = nsnull;</span>
<a href="#l8.32"></a><span id="l8.32"> }</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34"> nsImapMailFolder::~nsImapMailFolder()</span>
<a href="#l8.35"></a><span id="l8.35"> {</span>
<a href="#l8.36"></a><span id="l8.36">   MOZ_COUNT_DTOR(nsImapMailFolder);</span>
<a href="#l8.37"></a><span id="l8.37">   if (m_appendMsgMonitor)</span>
<a href="#l8.38"></a><span id="l8.38">       PR_DestroyMonitor(m_appendMsgMonitor);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -269,18 +267,16 @@ NS_IMPL_ADDREF_INHERITED(nsImapMailFolde</span>
<a href="#l8.40"></a><span id="l8.40"> NS_IMPL_RELEASE_INHERITED(nsImapMailFolder, nsMsgDBFolder)</span>
<a href="#l8.41"></a><span id="l8.41"> NS_IMPL_QUERY_HEAD(nsImapMailFolder)</span>
<a href="#l8.42"></a><span id="l8.42">     NS_IMPL_QUERY_BODY(nsIMsgImapMailFolder)</span>
<a href="#l8.43"></a><span id="l8.43">     NS_IMPL_QUERY_BODY(nsICopyMessageListener)</span>
<a href="#l8.44"></a><span id="l8.44">     NS_IMPL_QUERY_BODY(nsIImapMailFolderSink)</span>
<a href="#l8.45"></a><span id="l8.45">     NS_IMPL_QUERY_BODY(nsIImapMessageSink)</span>
<a href="#l8.46"></a><span id="l8.46">     NS_IMPL_QUERY_BODY(nsIUrlListener)</span>
<a href="#l8.47"></a><span id="l8.47">     NS_IMPL_QUERY_BODY(nsIMsgFilterHitNotify)</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    NS_IMPL_QUERY_BODY(nsIJunkMailClassificationListener)</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    NS_IMPL_QUERY_BODY(nsIMsgTraitClassificationListener)</span>
<a href="#l8.50"></a><span id="l8.50"> NS_IMPL_QUERY_TAIL_INHERITING(nsMsgDBFolder)</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52"> nsresult nsImapMailFolder::AddDirectorySeparator(nsILocalFile *path)</span>
<a href="#l8.53"></a><span id="l8.53"> {</span>
<a href="#l8.54"></a><span id="l8.54">   if (mURI.Equals(kImapRootURI))</span>
<a href="#l8.55"></a><span id="l8.55">   {</span>
<a href="#l8.56"></a><span id="l8.56">     // don't concat the full separator with .sbd</span>
<a href="#l8.57"></a><span id="l8.57">   }</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineat">@@ -7916,58 +7912,16 @@ nsresult nsImapMailFolder::GetMoveCoales</span>
<a href="#l8.59"></a><span id="l8.59">   {</span>
<a href="#l8.60"></a><span id="l8.60">     m_moveCoalescer = new nsImapMoveCoalescer(this, nsnull /* msgWindow */);</span>
<a href="#l8.61"></a><span id="l8.61">     NS_ENSURE_TRUE (m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l8.62"></a><span id="l8.62">     m_moveCoalescer-&gt;AddRef();</span>
<a href="#l8.63"></a><span id="l8.63">   }</span>
<a href="#l8.64"></a><span id="l8.64">   return NS_OK;</span>
<a href="#l8.65"></a><span id="l8.65"> }</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-nsresult</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-nsImapMailFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-{</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  PRUint32 count;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-  PRUint32 *proIndices;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-  PRUint32 *antiIndices;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  ++m_numFilterClassifyRequests;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices,</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-                          antiIndices, this, aMsgWindow, this);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  NS_Free(proIndices);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  NS_Free(antiIndices);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-  return rv;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-}</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-nsresult</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-nsImapMailFolder::SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-{</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-  PRUint32 count;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-  PRUint32 *proIndices;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-  PRUint32 *antiIndices;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-  m_numFilterClassifyRequests += aURICount;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-                          proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  NS_Free(proIndices);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  NS_Free(antiIndices);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  return rv;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-}</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-</span>
<a href="#l8.109"></a><span id="l8.109"> NS_IMETHODIMP</span>
<a href="#l8.110"></a><span id="l8.110"> nsImapMailFolder::StoreCustomKeywords(nsIMsgWindow *aMsgWindow, const nsACString&amp; aFlagsToAdd,</span>
<a href="#l8.111"></a><span id="l8.111">                                       const nsACString&amp; aFlagsToSubtract, nsMsgKey *aKeysToStore, PRUint32 aNumKeys, nsIURI **_retval)</span>
<a href="#l8.112"></a><span id="l8.112"> {</span>
<a href="#l8.113"></a><span id="l8.113">   nsresult rv;</span>
<a href="#l8.114"></a><span id="l8.114">   if (WeAreOffline())</span>
<a href="#l8.115"></a><span id="l8.115">   {</span>
<a href="#l8.116"></a><span id="l8.116">     GetDatabase();</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineat">@@ -8054,119 +8008,114 @@ NS_IMETHODIMP</span>
<a href="#l8.118"></a><span id="l8.118"> nsImapMailFolder::OnMessageClassified(const char * aMsgURI,</span>
<a href="#l8.119"></a><span id="l8.119">   nsMsgJunkStatus aClassification,</span>
<a href="#l8.120"></a><span id="l8.120">   PRUint32 aJunkPercent)</span>
<a href="#l8.121"></a><span id="l8.121"> {</span>
<a href="#l8.122"></a><span id="l8.122">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l8.123"></a><span id="l8.123">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l8.124"></a><span id="l8.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-  rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  nsMsgKey msgKey;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-  // check if this message needs junk classification</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-  PRUint32 processingFlags;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-  if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-  {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-    AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    nsCString spamFolderURI;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    nsCAutoString msgJunkScore;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-    nsCAutoString msgJunkPercent;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    msgJunkPercent.AppendInt(aJunkPercent);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, msgJunkPercent.get());</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-    GetMoveCoalescer();</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-    if (m_moveCoalescer)</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-    {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-      nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket((aClassification == nsIJunkMailPlugin::JUNK) ? 0 : 1);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-      NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-      if (keysToClassify)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-        keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-    }</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-      PRBool markAsReadOnSpam;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-      if (markAsReadOnSpam)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  if (aMsgURI) // not end of batch</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  {</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    nsMsgKey msgKey;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    // check if this message needs junk classification</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    PRUint32 processingFlags;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+    GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+      nsMsgDBFolder::OnMessageClassified(aMsgURI, aClassification, aJunkPercent);</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+      GetMoveCoalescer();</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      if (m_moveCoalescer)</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      {</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+        nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket((aClassification == nsIJunkMailPlugin::JUNK) ? 0 : 1);</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+        NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+        if (keysToClassify)</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+          keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+      }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+      if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l8.200"></a><span id="l8.200">       {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-        if (!m_junkMessagesToMarkAsRead)</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-          m_junkMessagesToMarkAsRead = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-        m_junkMessagesToMarkAsRead-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-      }</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-      PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      // don't do the move when we are opening up</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-      // the junk mail folder or the trash folder</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-      // or when manually classifying messages in those folders</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-      if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-      {</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-        PRBool moveOnSpam;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-        (void)spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-        if (moveOnSpam)</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+        nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+        rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+        PRBool markAsReadOnSpam;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+        (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+        if (markAsReadOnSpam)</span>
<a href="#l8.223"></a><span id="l8.223">         {</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-          rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-          if (!spamFolderURI.IsEmpty())</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+          if (!m_junkMessagesToMarkAsRead)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+          {</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+            m_junkMessagesToMarkAsRead = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+          }</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+          m_junkMessagesToMarkAsRead-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+        }</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+        PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+        // don't do the move when we are opening up</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+        // the junk mail folder or the trash folder</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+        // or when manually classifying messages in those folders</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+        if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+        {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+          PRBool moveOnSpam;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+          (void)spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+          if (moveOnSpam)</span>
<a href="#l8.246"></a><span id="l8.246">           {</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-            nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-            rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+            nsCString spamFolderURI;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+            rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+            if (!spamFolderURI.IsEmpty())</span>
<a href="#l8.255"></a><span id="l8.255">             {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-              rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-              if (NS_SUCCEEDED(GetMoveCoalescer()))</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+              nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+              rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+              if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l8.262"></a><span id="l8.262">               {</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-                m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-                willMoveMessage = PR_TRUE;</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+                rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+                NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+                if (NS_SUCCEEDED(GetMoveCoalescer()))</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+                {</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+                  m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+                  willMoveMessage = PR_TRUE;</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+                }</span>
<a href="#l8.272"></a><span id="l8.272">               }</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-            }</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-            else</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-            {</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-              // XXX TODO</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-              // JUNK MAIL RELATED</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-              // the listener should do</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-              // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-              // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-              // if (NS_SUCCEEDED(GetMoveCoalescer())) {</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-              //   m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-              //   willMoveMessage = PR_TRUE;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-              // }</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-              rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-              NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+              else</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+              {</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+                // XXX TODO</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+                // JUNK MAIL RELATED</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+                // the listener should do</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+                // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+                // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+                // if (NS_SUCCEEDED(GetMoveCoalescer())) {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+                //   m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+                //   willMoveMessage = PR_TRUE;</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+                // }</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+                rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+                NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+              }</span>
<a href="#l8.301"></a><span id="l8.301">             }</span>
<a href="#l8.302"></a><span id="l8.302">           }</span>
<a href="#l8.303"></a><span id="l8.303">         }</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+        rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.306"></a><span id="l8.306">       }</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-      rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-    }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-  }</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-  if (--m_numFilterClassifyRequests == 0)</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+    }</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+  }</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+  else // end of batch</span>
<a href="#l8.317"></a><span id="l8.317">   {</span>
<a href="#l8.318"></a><span id="l8.318">     if (m_junkMessagesToMarkAsRead)</span>
<a href="#l8.319"></a><span id="l8.319">     {</span>
<a href="#l8.320"></a><span id="l8.320">       PRUint32 count;</span>
<a href="#l8.321"></a><span id="l8.321">       m_junkMessagesToMarkAsRead-&gt;GetLength(&amp;count);</span>
<a href="#l8.322"></a><span id="l8.322">       if (count &gt; 0)</span>
<a href="#l8.323"></a><span id="l8.323">       {</span>
<a href="#l8.324"></a><span id="l8.324">         rv = MarkMessagesRead(m_junkMessagesToMarkAsRead, true);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineat">@@ -8180,56 +8129,17 @@ nsImapMailFolder::OnMessageClassified(co</span>
<a href="#l8.326"></a><span id="l8.326">     if ((!pendingMoves || !ShowPreviewText()) &amp;&amp; m_performingBiff)</span>
<a href="#l8.327"></a><span id="l8.327">     {</span>
<a href="#l8.328"></a><span id="l8.328">       // we don't need to adjust the num new messages in this folder because</span>
<a href="#l8.329"></a><span id="l8.329">       // the playback moves code already did that.</span>
<a href="#l8.330"></a><span id="l8.330">       (void) PerformBiffNotifications();</span>
<a href="#l8.331"></a><span id="l8.331">       server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l8.332"></a><span id="l8.332">       m_performingBiff = PR_FALSE;</span>
<a href="#l8.333"></a><span id="l8.333">     }</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-  }</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-}</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-nsImapMailFolder::OnMessageTraitsClassified(</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-    const char *aMsgURI, PRUint32 aTraitCount,</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-    PRUint32 *aTraits, PRUint32 *aPercents)</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-{</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-  nsMsgKey msgKey;</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-  PRUint32 processingFlags;</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-  if (!(processingFlags &amp; nsMsgProcessingFlags::ClassifyTraits))</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-    return NS_OK;</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-  AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-  traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-  for (PRUint32 i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-  {</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-    if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-      continue; // junk is processed by the junk listener</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-    nsCAutoString traitId;</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-    traitId.Insert(NS_LITERAL_CSTRING(&quot;bayespercent/&quot;), 0);</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    nsCAutoString strPercent;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-    strPercent.AppendInt(aPercents[i]);</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-    mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+    // We aren't calling the parent method, since it ignores batching anyway</span>
<a href="#l8.375"></a><span id="l8.375">   }</span>
<a href="#l8.376"></a><span id="l8.376">   return NS_OK;</span>
<a href="#l8.377"></a><span id="l8.377"> }</span>
<a href="#l8.378"></a><span id="l8.378"> </span>
<a href="#l8.379"></a><span id="l8.379"> NS_IMETHODIMP</span>
<a href="#l8.380"></a><span id="l8.380"> nsImapMailFolder::GetShouldDownloadAllHeaders(PRBool *aResult)</span>
<a href="#l8.381"></a><span id="l8.381"> {</span>
<a href="#l8.382"></a><span id="l8.382">   NS_ENSURE_ARG_POINTER(aResult);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -48,17 +48,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIImapIncomingServer.h&quot; // we need this for its IID</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgParseMailMsgState.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsMsgTxn.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIMsgFilterHitNotify.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;prmon.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsIImapMailFolderSink.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> #include &quot;nsIEventTarget.h&quot;</span>
<a href="#l9.20"></a><span id="l9.20"> #include &quot;nsIThread.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -215,19 +214,17 @@ struct nsPlaybackRequest</span>
<a href="#l9.22"></a><span id="l9.22">   nsIMsgWindow *MsgWindow;</span>
<a href="#l9.23"></a><span id="l9.23"> };</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> class nsImapMailFolder :  public nsMsgDBFolder,</span>
<a href="#l9.26"></a><span id="l9.26">                           public nsIMsgImapMailFolder,</span>
<a href="#l9.27"></a><span id="l9.27">                           public nsIImapMailFolderSink,</span>
<a href="#l9.28"></a><span id="l9.28">                           public nsIImapMessageSink,</span>
<a href="#l9.29"></a><span id="l9.29">                           public nsICopyMessageListener,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-                          public nsIMsgFilterHitNotify,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                          public nsIJunkMailClassificationListener,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-                          public nsIMsgTraitClassificationListener</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+                          public nsIMsgFilterHitNotify</span>
<a href="#l9.34"></a><span id="l9.34"> {</span>
<a href="#l9.35"></a><span id="l9.35">  static const PRUint32 PLAYBACK_TIMER_INTERVAL_IN_MS = 500; </span>
<a href="#l9.36"></a><span id="l9.36"> public:</span>
<a href="#l9.37"></a><span id="l9.37">   nsImapMailFolder();</span>
<a href="#l9.38"></a><span id="l9.38">   virtual ~nsImapMailFolder();</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42" class="difflineat">@@ -324,30 +321,27 @@ public:</span>
<a href="#l9.43"></a><span id="l9.43">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45">   // nsIUrlListener methods</span>
<a href="#l9.46"></a><span id="l9.46">   NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl);</span>
<a href="#l9.47"></a><span id="l9.47">   NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode);</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l9.50"></a><span id="l9.50">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   NS_IMETHOD IsCommandEnabled(const nsACString&amp; command, PRBool *result);</span>
<a href="#l9.54"></a><span id="l9.54">   NS_IMETHOD SetFilterList(nsIMsgFilterList *aMsgFilterList);</span>
<a href="#l9.55"></a><span id="l9.55">   NS_IMETHOD GetCustomIdentity(nsIMsgIdentity **aIdentity);</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57">   nsresult AddSubfolderWithPath(nsAString&amp; name, nsILocalFile *dbPath, nsIMsgFolder **child, PRBool brandNew = PR_FALSE);</span>
<a href="#l9.58"></a><span id="l9.58">   nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l9.59"></a><span id="l9.59">                                   nsIMsgDatabase *sourceDB,</span>
<a href="#l9.60"></a><span id="l9.60">                                   const nsACString&amp; destFolder,</span>
<a href="#l9.61"></a><span id="l9.61">                                   nsIMsgFilter *filter,</span>
<a href="#l9.62"></a><span id="l9.62">                                   nsIMsgWindow *msgWindow);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">   static nsresult  AllocateUidStringFromKeys(nsMsgKey *keys, PRUint32 numKeys, nsCString &amp;msgIds);</span>
<a href="#l9.67"></a><span id="l9.67">   static nsresult  BuildIdsAndKeyArray(nsIArray* messages, nsCString&amp; msgIds, nsTArray&lt;nsMsgKey&gt;&amp; keyArray);</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">   // these might end up as an nsIImapMailFolder attribute.</span>
<a href="#l9.70"></a><span id="l9.70">   nsresult SetSupportedUserFlags(PRUint32 userFlags);</span>
<a href="#l9.71"></a><span id="l9.71">   nsresult GetSupportedUserFlags(PRUint32 *userFlags);</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineat">@@ -448,17 +442,16 @@ protected:</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">   PRBool m_initialized;</span>
<a href="#l9.76"></a><span id="l9.76">   PRBool m_haveDiscoveredAllFolders;</span>
<a href="#l9.77"></a><span id="l9.77">   PRBool m_haveReadNameFromDB;</span>
<a href="#l9.78"></a><span id="l9.78">   nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; m_msgParser;</span>
<a href="#l9.79"></a><span id="l9.79">   nsCOMPtr&lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l9.80"></a><span id="l9.80">   nsCOMPtr&lt;nsIMsgFilterPlugin&gt; m_filterPlugin;  // XXX should be a list</span>
<a href="#l9.81"></a><span id="l9.81">   // used with filter plugins to know when we've finished classifying and can playback moves</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  PRInt32 m_numFilterClassifyRequests;</span>
<a href="#l9.83"></a><span id="l9.83">   PRBool m_msgMovedByFilter;</span>
<a href="#l9.84"></a><span id="l9.84">   nsImapMoveCoalescer *m_moveCoalescer; // strictly owned by the nsImapMailFolder</span>
<a href="#l9.85"></a><span id="l9.85">   nsCOMPtr&lt;nsIMutableArray&gt; m_junkMessagesToMarkAsRead;</span>
<a href="#l9.86"></a><span id="l9.86">   nsMsgKey m_curMsgUid;</span>
<a href="#l9.87"></a><span id="l9.87">   PRUint32 m_uidValidity;</span>
<a href="#l9.88"></a><span id="l9.88">   // used for condstore support;</span>
<a href="#l9.89"></a><span id="l9.89">   PRUint64 m_highestModSeq;</span>
<a href="#l9.90"></a><span id="l9.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -151,30 +151,28 @@ nsLocalFolderScanState::~nsLocalFolderSc</span>
<a href="#l10.4"></a><span id="l10.4"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.5"></a><span id="l10.5"> // nsMsgLocalMailFolder interface</span>
<a href="#l10.6"></a><span id="l10.6"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> nsMsgLocalMailFolder::nsMsgLocalMailFolder(void)</span>
<a href="#l10.9"></a><span id="l10.9">   : mCopyState(nsnull), mHaveReadNameFromDB(PR_FALSE),</span>
<a href="#l10.10"></a><span id="l10.10">     mInitialized(PR_FALSE),</span>
<a href="#l10.11"></a><span id="l10.11">     mCheckForNewMessagesAfterParsing(PR_FALSE), m_parsingFolder(PR_FALSE),</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    mNumFilterClassifyRequests(0), mDownloadState(DOWNLOAD_STATE_NONE)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    mDownloadState(DOWNLOAD_STATE_NONE)</span>
<a href="#l10.14"></a><span id="l10.14"> {</span>
<a href="#l10.15"></a><span id="l10.15"> }</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> nsMsgLocalMailFolder::~nsMsgLocalMailFolder(void)</span>
<a href="#l10.18"></a><span id="l10.18"> {</span>
<a href="#l10.19"></a><span id="l10.19"> }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED4(nsMsgLocalMailFolder,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED2(nsMsgLocalMailFolder,</span>
<a href="#l10.23"></a><span id="l10.23">                              nsMsgDBFolder,</span>
<a href="#l10.24"></a><span id="l10.24">                              nsICopyMessageListener,</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-                             nsIMsgLocalMailFolder,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-                             nsIJunkMailClassificationListener,</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-                             nsIMsgTraitClassificationListener)</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+                             nsIMsgLocalMailFolder)</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32"> static PRBool</span>
<a href="#l10.33"></a><span id="l10.33"> nsStringEndsWith(nsString&amp; name, const char *ending)</span>
<a href="#l10.34"></a><span id="l10.34"> {</span>
<a href="#l10.35"></a><span id="l10.35">   PRInt32 len = name.Length();</span>
<a href="#l10.36"></a><span id="l10.36">   if (len == 0) return PR_FALSE;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineat">@@ -3468,238 +3466,134 @@ nsMsgLocalMailFolder::NotifyCompactCompl</span>
<a href="#l10.38"></a><span id="l10.38"> }</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40"> NS_IMETHODIMP nsMsgLocalMailFolder::Shutdown(PRBool shutdownChildren)</span>
<a href="#l10.41"></a><span id="l10.41"> {</span>
<a href="#l10.42"></a><span id="l10.42">   mInitialized = PR_FALSE;</span>
<a href="#l10.43"></a><span id="l10.43">   return nsMsgDBFolder::Shutdown(shutdownChildren);</span>
<a href="#l10.44"></a><span id="l10.44"> }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-nsresult</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-nsMsgLocalMailFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-{</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  PRUint32 count;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  PRUint32 *proIndices;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  PRUint32 *antiIndices;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  ++mNumFilterClassifyRequests;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  NS_Free(proIndices);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-  NS_Free(antiIndices);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  return rv;</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-}</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-nsresult</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-nsMsgLocalMailFolder::SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-{</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  NS_ASSERTION(!mNumFilterClassifyRequests, &quot;shouldn't call this when already classifying messages&quot;);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  mNumFilterClassifyRequests = aURICount;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  PRUint32 count;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  PRUint32 *proIndices;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  PRUint32 *antiIndices;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-      proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-  NS_Free(proIndices);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  NS_Free(antiIndices);</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  return rv;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-}</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-</span>
<a href="#l10.88"></a><span id="l10.88"> NS_IMETHODIMP</span>
<a href="#l10.89"></a><span id="l10.89"> nsMsgLocalMailFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l10.90"></a><span id="l10.90">   nsMsgJunkStatus aClassification,</span>
<a href="#l10.91"></a><span id="l10.91">   PRUint32 aJunkPercent)</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93"> {</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-  if (mNumFilterClassifyRequests &gt; 0)</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-    --mNumFilterClassifyRequests;</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-</span>
<a href="#l10.97"></a><span id="l10.97">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l10.98"></a><span id="l10.98">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l10.99"></a><span id="l10.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.100"></a><span id="l10.100"> </span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  nsMsgKey msgKey;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-</span>
<a href="#l10.109"></a><span id="l10.109">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l10.110"></a><span id="l10.110">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l10.111"></a><span id="l10.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-  // check if this message needs junk classification</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-  PRUint32 processingFlags;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-  if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+  nsCString spamFolderURI;</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  if (aMsgURI) // not end of batch</span>
<a href="#l10.123"></a><span id="l10.123">   {</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-    AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-    nsCAutoString msgJunkScore;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-    nsCAutoString strPercent;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    strPercent.AppendInt(aJunkPercent);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strPercent.get());</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-    PRBool moveOnSpam = PR_FALSE;</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    nsMsgKey msgKey;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+    rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    // check if this message needs junk classification</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    PRUint32 processingFlags;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+    GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+    if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l10.153"></a><span id="l10.153">     {</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-      PRBool markAsReadOnSpam;</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-      if (markAsReadOnSpam)</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+      nsMsgDBFolder::OnMessageClassified(aMsgURI, aClassification, aJunkPercent);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+      if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l10.160"></a><span id="l10.160">       {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-        rv = mDatabase-&gt;MarkRead(msgKey, true, this);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-          if (!NS_SUCCEEDED(rv))</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-            NS_WARNING(&quot;failed marking spam message as read&quot;);</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-      }</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-      PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-      // don't do the move when we are opening up</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-      // the junk mail folder or the trash folder</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-      // or when manually classifying messages in those folders</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-      if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-      {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-        rv = spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-        if (moveOnSpam)</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+        PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+        // don't do the move when we are opening up</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+        // the junk mail folder or the trash folder</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+        // or when manually classifying messages in those folders</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+        if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l10.182"></a><span id="l10.182">         {</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-          nsCString uriStr;</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-          rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(uriStr));</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+          PRBool moveOnSpam = PR_FALSE;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+          rv = spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l10.187"></a><span id="l10.187">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-          mSpamFolderURI = uriStr;</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-          rv = GetExistingFolder(mSpamFolderURI, getter_AddRefs(folder));</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+          if (moveOnSpam)</span>
<a href="#l10.194"></a><span id="l10.194">           {</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-            mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-            willMoveMessage = PR_TRUE;</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-          }</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-          else</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-          {</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-            // XXX TODO</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-            // JUNK MAIL RELATED</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-            // the listener should do</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-            // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-            // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-            // mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-            // willMoveMessage = PR_TRUE;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-            rv = GetOrCreateFolder(mSpamFolderURI, nsnull /* aListener */);</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+            rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+            {</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+              rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+              mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+              willMoveMessage = PR_TRUE;</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+            }</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+            else</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+            {</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+              // XXX TODO</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+              // JUNK MAIL RELATED</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+              // the listener should do</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+              // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+              // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+              // mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+              // willMoveMessage = PR_TRUE;</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+              rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+              NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+            }</span>
<a href="#l10.232"></a><span id="l10.232">           }</span>
<a href="#l10.233"></a><span id="l10.233">         }</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+        rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.236"></a><span id="l10.236">       }</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-      rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.239"></a><span id="l10.239">     }</span>
<a href="#l10.240"></a><span id="l10.240">   }</span>
<a href="#l10.241"></a><span id="l10.241"> </span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-  if (mNumFilterClassifyRequests == 0)</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+  else // end of batch</span>
<a href="#l10.244"></a><span id="l10.244">   {</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-    if (!mSpamKeysToMove.IsEmpty())</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+    if (!mSpamKeysToMove.IsEmpty() &amp;&amp; !spamFolderURI.IsEmpty())</span>
<a href="#l10.247"></a><span id="l10.247">     {</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-      if (!mSpamFolderURI.IsEmpty())</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-      {</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-        rv = GetExistingFolder(mSpamFolderURI, getter_AddRefs(folder));</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-          nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-          for (PRUint32 keyIndex = 0; keyIndex &lt; mSpamKeysToMove.Length(); keyIndex++)</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-          {</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr = nsnull;</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-            rv = GetMessageHeader(mSpamKeysToMove.ElementAt(keyIndex), getter_AddRefs(mailHdr));</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-              messages-&gt;AppendElement(mailHdr, PR_FALSE);</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-          }</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-          nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-          rv = copySvc-&gt;CopyMessages(this, messages, folder, PR_TRUE,</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-            /*nsIMsgCopyServiceListener* listener*/ nsnull, nsnull, PR_FALSE /*allowUndo*/);</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CopyMessages failed&quot;);</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-          {</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-            nsCAutoString logMsg(&quot;failed to copy junk messages to junk folder rv = &quot;);</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-            logMsg.AppendInt(rv, 16);</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-            spamSettings-&gt;LogJunkString(logMsg.get());</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-          }</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+      rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+        for (PRUint32 keyIndex = 0; keyIndex &lt; mSpamKeysToMove.Length(); keyIndex++)</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+        {</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+          rv = GetMessageHeader(mSpamKeysToMove.ElementAt(keyIndex), getter_AddRefs(mailHdr));</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+            messages-&gt;AppendElement(mailHdr, PR_FALSE);</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+        }</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+        nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+        rv = copySvc-&gt;CopyMessages(this, messages, folder, PR_TRUE,</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+          /*nsIMsgCopyServiceListener* listener*/ nsnull, nsnull, PR_FALSE /*allowUndo*/);</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CopyMessages failed&quot;);</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+        {</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+          nsCAutoString logMsg(&quot;failed to copy junk messages to junk folder rv = &quot;);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+          logMsg.AppendInt(rv, 16);</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+          spamSettings-&gt;LogJunkString(logMsg.get());</span>
<a href="#l10.297"></a><span id="l10.297">         }</span>
<a href="#l10.298"></a><span id="l10.298">       }</span>
<a href="#l10.299"></a><span id="l10.299">     }</span>
<a href="#l10.300"></a><span id="l10.300">     PRInt32 numNewMessages;</span>
<a href="#l10.301"></a><span id="l10.301">     GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l10.302"></a><span id="l10.302">     SetNumNewMessages(numNewMessages - mSpamKeysToMove.Length());</span>
<a href="#l10.303"></a><span id="l10.303">     mSpamKeysToMove.Clear();</span>
<a href="#l10.304"></a><span id="l10.304">     // check if this is the inbox first...</span>
<a href="#l10.305"></a><span id="l10.305">     if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l10.306"></a><span id="l10.306">       PerformBiffNotifications();</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-  }</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-}</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-nsMsgLocalMailFolder::OnMessageTraitsClassified(</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-    const char *aMsgURI, PRUint32 aTraitCount,</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-    PRUint32 *aTraits, PRUint32 *aPercents)</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-{</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-  nsMsgKey msgKey;</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-  PRUint32 processingFlags;</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-  if (!(processingFlags &amp; nsMsgProcessingFlags::ClassifyTraits))</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-  AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::ClassifyTraits);</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-  traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-  for (PRUint32 i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-  {</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-    if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-      continue; // junk is processed by the junk listener</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-    nsCAutoString traitId;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-    rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-    traitId.Insert(NS_LITERAL_CSTRING(&quot;bayespercent/&quot;), 0);</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-    nsCAutoString strPercent;</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-    strPercent.AppendInt(aPercents[i]);</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-    mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+    // Note we are not calling the parent class's method, since it</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+    // currently ignores end-of-batch anyway</span>
<a href="#l10.348"></a><span id="l10.348">   }</span>
<a href="#l10.349"></a><span id="l10.349">   return NS_OK;</span>
<a href="#l10.350"></a><span id="l10.350"> }</span>
<a href="#l10.351"></a><span id="l10.351"> </span>
<a href="#l10.352"></a><span id="l10.352"> NS_IMETHODIMP</span>
<a href="#l10.353"></a><span id="l10.353"> nsMsgLocalMailFolder::GetFolderScanState(nsLocalFolderScanState *aState)</span>
<a href="#l10.354"></a><span id="l10.354"> {</span>
<a href="#l10.355"></a><span id="l10.355">   NS_ENSURE_ARG_POINTER(aState);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -47,17 +47,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsICopyMessageListener.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIPop3IncomingServer.h&quot;  // need this for an interface ID</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsMsgTxn.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIMsgParseMailMsgState.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsLocalUndoTxn.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> #define COPY_BUFFER_SIZE 16384</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> class nsParseMailMessageState;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -112,27 +111,24 @@ struct nsLocalFolderScanState</span>
<a href="#l11.22"></a><span id="l11.22">   nsCOMPtr&lt;nsILineInputStream&gt; m_fileLineStream;</span>
<a href="#l11.23"></a><span id="l11.23">   nsCString m_header;</span>
<a href="#l11.24"></a><span id="l11.24">   nsCString m_accountKey;</span>
<a href="#l11.25"></a><span id="l11.25">   const char *m_uidl; // memory is owned by m_header</span>
<a href="#l11.26"></a><span id="l11.26"> };</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28"> class nsMsgLocalMailFolder : public nsMsgDBFolder,</span>
<a href="#l11.29"></a><span id="l11.29">                              public nsIMsgLocalMailFolder,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-                             public nsICopyMessageListener,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-                             public nsIJunkMailClassificationListener,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-                             public nsIMsgTraitClassificationListener</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+                             public nsICopyMessageListener</span>
<a href="#l11.34"></a><span id="l11.34"> {</span>
<a href="#l11.35"></a><span id="l11.35"> public:</span>
<a href="#l11.36"></a><span id="l11.36">   nsMsgLocalMailFolder(void);</span>
<a href="#l11.37"></a><span id="l11.37">   virtual ~nsMsgLocalMailFolder(void);</span>
<a href="#l11.38"></a><span id="l11.38">   NS_DECL_NSICOPYMESSAGELISTENER</span>
<a href="#l11.39"></a><span id="l11.39">   NS_DECL_NSIMSGLOCALMAILFOLDER</span>
<a href="#l11.40"></a><span id="l11.40">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l11.42"></a><span id="l11.42">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l11.43"></a><span id="l11.43">   // nsIRDFResource methods:</span>
<a href="#l11.44"></a><span id="l11.44">   NS_IMETHOD Init(const char *aURI);</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   // nsIUrlListener methods</span>
<a href="#l11.47"></a><span id="l11.47">   NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl);</span>
<a href="#l11.48"></a><span id="l11.48">   NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode);</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50" class="difflineat">@@ -237,32 +233,28 @@ protected:</span>
<a href="#l11.51"></a><span id="l11.51">                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l11.52"></a><span id="l11.52">                                        nsIMsgFolder *dstFolder,</span>
<a href="#l11.53"></a><span id="l11.53">                                        PRBool isMove);</span>
<a href="#l11.54"></a><span id="l11.54">   virtual void GetIncomingServerType(nsCString&amp; serverType);</span>
<a href="#l11.55"></a><span id="l11.55">   nsresult InitCopyState(nsISupports* aSupport, nsIArray* messages,</span>
<a href="#l11.56"></a><span id="l11.56">                          PRBool isMove, nsIMsgCopyServiceListener* listener, nsIMsgWindow *msgWindow, PRBool isMoveFolder, PRBool allowUndo);</span>
<a href="#l11.57"></a><span id="l11.57">   void CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr);</span>
<a href="#l11.58"></a><span id="l11.58">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l11.61"></a><span id="l11.61">   nsresult ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeyword, PRBool add);</span>
<a href="#l11.62"></a><span id="l11.62">   PRBool GetDeleteFromServerOnMove();</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64"> protected:</span>
<a href="#l11.65"></a><span id="l11.65">   nsLocalMailCopyState *mCopyState; //We only allow one of these at a time</span>
<a href="#l11.66"></a><span id="l11.66">   nsCString mType;</span>
<a href="#l11.67"></a><span id="l11.67">   PRPackedBool mHaveReadNameFromDB;</span>
<a href="#l11.68"></a><span id="l11.68">   PRPackedBool mInitialized;</span>
<a href="#l11.69"></a><span id="l11.69">   PRPackedBool mCheckForNewMessagesAfterParsing;</span>
<a href="#l11.70"></a><span id="l11.70">   PRPackedBool m_parsingFolder;</span>
<a href="#l11.71"></a><span id="l11.71">   nsCOMPtr&lt;nsIUrlListener&gt; mReparseListener;</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  PRInt32 mNumFilterClassifyRequests;</span>
<a href="#l11.73"></a><span id="l11.73">   nsTArray&lt;nsMsgKey&gt; mSpamKeysToMove;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  nsCString mSpamFolderURI;</span>
<a href="#l11.75"></a><span id="l11.75">   nsresult setSubfolderFlag(const nsAString&amp; aFolderName, PRUint32 flags);</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77">   // state variables for DownloadMessagesForOffline</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">   // Do we notify the owning window of Delete's before or after</span>
<a href="#l11.80"></a><span id="l11.80">   // Adding the new msg?</span>
<a href="#l11.81"></a><span id="l11.81"> #define DOWNLOAD_NOTIFY_FIRST 1</span>
<a href="#l11.82"></a><span id="l11.82"> #define DOWNLOAD_NOTIFY_LAST  2</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

