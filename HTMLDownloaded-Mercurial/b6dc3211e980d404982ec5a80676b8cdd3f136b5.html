<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29198:b6dc3211e980d404982ec5a80676b8cdd3f136b5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b6dc3211e980d404982ec5a80676b8cdd3f136b5" />
<meta property="og:url" content="/comm-central/rev/b6dc3211e980d404982ec5a80676b8cdd3f136b5" />
<meta property="og:description" content="Bug 1626683 - Initial OpenPGP key trust management. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b6dc3211e980d404982ec5a80676b8cdd3f136b5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b6dc3211e980d404982ec5a80676b8cdd3f136b5">shortlog</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b6dc3211e980d404982ec5a80676b8cdd3f136b5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5">files</a> |
changeset |
<a href="/comm-central/raw-rev/b6dc3211e980d404982ec5a80676b8cdd3f136b5">raw</a>  | <a href="/comm-central/archive/b6dc3211e980d404982ec5a80676b8cdd3f136b5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1626683">Bug 1626683</a> - Initial OpenPGP key trust management. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 30 Mar 2020 22:53:03 +0200</td></tr>

<tr>
 <td>changeset 29198</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b6dc3211e980d404982ec5a80676b8cdd3f136b5">b6dc3211e980d404982ec5a80676b8cdd3f136b5</a></td>
</tr>



<tr>
<td>parent 29197</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/00561da9004e181752e29f514e2dd18494a0d6f4">00561da9004e181752e29f514e2dd18494a0d6f4</a>
</td>
</tr>

<tr>
<td>child 29199</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3cdb2ce79d794c2d76961bfa7c2a4da788eb9b18">3cdb2ce79d794c2d76961bfa7c2a4da788eb9b18</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b6dc3211e980d404982ec5a80676b8cdd3f136b5">17252</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Tue, 07 Apr 2020 13:01:42 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b6dc3211e980 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b6dc3211e980d404982ec5a80676b8cdd3f136b5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b6dc3211e980d404982ec5a80676b8cdd3f136b5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6dc3211e980d404982ec5a80676b8cdd3f136b5&newProject=comm-central&newRevision=00561da9004e181752e29f514e2dd18494a0d6f4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6dc3211e980d404982ec5a80676b8cdd3f136b5&newProject=comm-central&newRevision=00561da9004e181752e29f514e2dd18494a0d6f4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b6dc3211e980d404982ec5a80676b8cdd3f136b5&newProject=comm-central&newRevision=00561da9004e181752e29f514e2dd18494a0d6f4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1626683">1626683</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1626683">Bug 1626683</a> - Initial OpenPGP key trust management. r=PatrickBrunschwig

Differential Revision: <a href="https://phabricator.services.mozilla.com/D69242">https://phabricator.services.mozilla.com/D69242</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">mail/extensions/openpgp/content/modules/constants.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/constants.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">mail/extensions/openpgp/content/modules/core.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/core.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">mail/extensions/openpgp/content/modules/decryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/decryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">mail/extensions/openpgp/content/modules/mimeVerify.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/mimeVerify.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">mail/extensions/openpgp/content/modules/rnp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnp.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">mail/extensions/openpgp/content/modules/rnpLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/rnpLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">mail/extensions/openpgp/content/modules/singletons.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/singletons.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">mail/extensions/openpgp/content/modules/sqliteDb.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/sqliteDb.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">mail/extensions/openpgp/content/modules/uidHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/modules/uidHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">mail/extensions/openpgp/content/strings/enigmail.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">mail/extensions/openpgp/content/ui/enigmailKeyManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">mail/extensions/openpgp/content/ui/enigmailKeygen.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">mail/extensions/openpgp/content/ui/keyDetailsDlg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">file</a> |
<a href="/comm-central/annotate/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">annotate</a> |
<a href="/comm-central/diff/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">diff</a> |
<a href="/comm-central/comparison/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">comparison</a> |
<a href="/comm-central/log/b6dc3211e980d404982ec5a80676b8cdd3f136b5/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/constants.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/constants.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -77,17 +77,17 @@ var EnigmailConstants = {</span>
<a href="#l1.4"></a><span id="l1.4">   SEND_STRIP_WHITESPACE: 0x0400, // 1024</span>
<a href="#l1.5"></a><span id="l1.5">   SEND_ATTACHMENT: 0x0800, // 2048</span>
<a href="#l1.6"></a><span id="l1.6">   ENCRYPT_HEADERS: 0x1000, // 4096</span>
<a href="#l1.7"></a><span id="l1.7">   SEND_VERBATIM: 0x2000, // 8192</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">   /* Status flags */</span>
<a href="#l1.10"></a><span id="l1.10">   GOOD_SIGNATURE: 0x00000001,</span>
<a href="#l1.11"></a><span id="l1.11">   BAD_SIGNATURE: 0x00000002,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  UNVERIFIED_SIGNATURE: 0x00000004,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  UNCERTAIN_SIGNATURE: 0x00000004,</span>
<a href="#l1.14"></a><span id="l1.14">   EXPIRED_SIGNATURE: 0x00000008,</span>
<a href="#l1.15"></a><span id="l1.15">   EXPIRED_KEY_SIGNATURE: 0x00000010,</span>
<a href="#l1.16"></a><span id="l1.16">   EXPIRED_KEY: 0x00000020,</span>
<a href="#l1.17"></a><span id="l1.17">   REVOKED_KEY: 0x00000040,</span>
<a href="#l1.18"></a><span id="l1.18">   NO_PUBKEY: 0x00000080,</span>
<a href="#l1.19"></a><span id="l1.19">   NO_SECKEY: 0x00000100,</span>
<a href="#l1.20"></a><span id="l1.20">   IMPORTED_KEY: 0x00000200,</span>
<a href="#l1.21"></a><span id="l1.21">   INVALID_RECIPIENT: 0x00000400,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -108,16 +108,18 @@ var EnigmailConstants = {</span>
<a href="#l1.23"></a><span id="l1.23">   PHOTO_AVAILABLE: 0x02000000,</span>
<a href="#l1.24"></a><span id="l1.24">   OVERFLOWED: 0x04000000,</span>
<a href="#l1.25"></a><span id="l1.25">   CARDCTRL: 0x08000000,</span>
<a href="#l1.26"></a><span id="l1.26">   SC_OP_FAILURE: 0x10000000,</span>
<a href="#l1.27"></a><span id="l1.27">   UNKNOWN_ALGO: 0x20000000,</span>
<a href="#l1.28"></a><span id="l1.28">   SIG_CREATED: 0x40000000,</span>
<a href="#l1.29"></a><span id="l1.29">   END_ENCRYPTION: 0x80000000,</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  EXT_SELF_IDENTITY: 0x00000001,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+</span>
<a href="#l1.33"></a><span id="l1.33">   /*** key handling functions ***/</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">   EXTRACT_SECRET_KEY: 0x01,</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   /* Keyserver Action Flags */</span>
<a href="#l1.38"></a><span id="l1.38">   SEARCH_KEY: 1,</span>
<a href="#l1.39"></a><span id="l1.39">   DOWNLOAD_KEY: 2,</span>
<a href="#l1.40"></a><span id="l1.40">   UPLOAD_KEY: 3,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -64,20 +64,26 @@ const getEnigmailWksMimeHandler = Enigma</span>
<a href="#l2.4"></a><span id="l2.4">   &quot;enigmail/wksMimeHandler.jsm&quot;,</span>
<a href="#l2.5"></a><span id="l2.5">   &quot;EnigmailWksMimeHandler&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> );</span>
<a href="#l2.7"></a><span id="l2.7"> const getEnigmailPgpmimeHander = EnigmailLazy.loader(</span>
<a href="#l2.8"></a><span id="l2.8">   &quot;enigmail/pgpmimeHandler.jsm&quot;,</span>
<a href="#l2.9"></a><span id="l2.9">   &quot;EnigmailPgpmimeHander&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> );</span>
<a href="#l2.11"></a><span id="l2.11"> //const getEnigmailOverlays = EnigmailLazy.loader(&quot;enigmail/enigmailOverlays.jsm&quot;, &quot;EnigmailOverlays&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+/*</span>
<a href="#l2.13"></a><span id="l2.13"> const getEnigmailSqlite = EnigmailLazy.loader(</span>
<a href="#l2.14"></a><span id="l2.14">   &quot;enigmail/sqliteDb.jsm&quot;,</span>
<a href="#l2.15"></a><span id="l2.15">   &quot;EnigmailSqliteDb&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> );</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+*/</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+const getPgpSqlite2 = EnigmailLazy.loader(</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  &quot;enigmail/sqliteDb.jsm&quot;,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  &quot;PgpSqliteDb2&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+);</span>
<a href="#l2.22"></a><span id="l2.22"> const getOpenPGPMasterpass = EnigmailLazy.loader(</span>
<a href="#l2.23"></a><span id="l2.23">   &quot;enigmail/masterpass.jsm&quot;,</span>
<a href="#l2.24"></a><span id="l2.24">   &quot;OpenPGPMasterpass&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> );</span>
<a href="#l2.26"></a><span id="l2.26"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> var EXPORTED_SYMBOLS = [&quot;EnigmailCore&quot;];</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -107,17 +113,18 @@ var EnigmailCore = {</span>
<a href="#l2.31"></a><span id="l2.31">     let env = getEnvironment();</span>
<a href="#l2.32"></a><span id="l2.32">     initializeLogDirectory();</span>
<a href="#l2.33"></a><span id="l2.33">     initializeLogging(env);</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">     const logger = getEnigmailLog();</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     logger.DEBUG(&quot;core.jsm: startup()\n&quot;);</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    getEnigmailSqlite().checkDatabaseStructure();</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    //getEnigmailSqlite().checkDatabaseStructure();</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    getPgpSqlite2().checkDatabaseStructure();</span>
<a href="#l2.42"></a><span id="l2.42">     getEnigmailPrefs().startup(reason);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">     this.factories = [];</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     function continueStartup(type) {</span>
<a href="#l2.47"></a><span id="l2.47">       logger.DEBUG(`core.jsm: startup.continueStartup(${type})\n`);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">       try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -51,17 +51,17 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l3.4"></a><span id="l3.4">    * Obtain signatures for a given set of key IDs.</span>
<a href="#l3.5"></a><span id="l3.5">    *</span>
<a href="#l3.6"></a><span id="l3.6">    * @param {String}  keyId:            space-separated list of key IDs</span>
<a href="#l3.7"></a><span id="l3.7">    * @param {Boolean} ignoreUnknownUid: if true, filter out unknown signer's UIDs</span>
<a href="#l3.8"></a><span id="l3.8">    *</span>
<a href="#l3.9"></a><span id="l3.9">    * @return {Promise&lt;Array of Object&gt;} - see extractSignatures()</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11">   async getKeySignatures(keyId, ignoreUnknownUid = false) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    return RNP.getKeySignatures(keyId, ignoreUnknownUid);</span>
<a href="#l3.14"></a><span id="l3.14">   }</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   /**</span>
<a href="#l3.17"></a><span id="l3.17">    * Export the minimum key for the public key object:</span>
<a href="#l3.18"></a><span id="l3.18">    * public key, primary user ID, newest encryption subkey</span>
<a href="#l3.19"></a><span id="l3.19">    *</span>
<a href="#l3.20"></a><span id="l3.20">    * @param {String} fpr:                a single FPR</span>
<a href="#l3.21"></a><span id="l3.21">    * @param {String} email:              [optional] the email address of the desired user ID.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -86,17 +86,17 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l3.23"></a><span id="l3.23">    * @return {nsIFile} object or null in case no data / error.</span>
<a href="#l3.24"></a><span id="l3.24">    */</span>
<a href="#l3.25"></a><span id="l3.25">   async getPhotoFile(keyId, photoNumber) {</span>
<a href="#l3.26"></a><span id="l3.26">     throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">   }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   async importKeyBlock(keyBlock, pubkey, seckey) {</span>
<a href="#l3.30"></a><span id="l3.30">     // TODO: get status results</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    let res = RNP.importKeyBlock(null, null, keyBlock, pubkey, seckey);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    let res = await RNP.importKeyBlock(null, null, keyBlock, pubkey, seckey);</span>
<a href="#l3.33"></a><span id="l3.33">     RNP.saveKeyRings();</span>
<a href="#l3.34"></a><span id="l3.34">     return res;</span>
<a href="#l3.35"></a><span id="l3.35">   }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   /**</span>
<a href="#l3.38"></a><span id="l3.38">    * Import key(s) from a file</span>
<a href="#l3.39"></a><span id="l3.39">    *</span>
<a href="#l3.40"></a><span id="l3.40">    * @param {nsIFile} inputFile:  the file holding the keys</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -178,34 +178,32 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l3.42"></a><span id="l3.42">    *</span>
<a href="#l3.43"></a><span id="l3.43">    * Use Promise.catch to handle failed decryption.</span>
<a href="#l3.44"></a><span id="l3.44">    * retObj.errorMsg will be an error message in this case.</span>
<a href="#l3.45"></a><span id="l3.45">    */</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">   async decrypt(encrypted, options) {</span>
<a href="#l3.48"></a><span id="l3.48">     EnigmailLog.DEBUG(`rnp-cryptoAPI.js: decrypt()\n`);</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    let result = RNP.decrypt(encrypted, options);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    return result;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    return RNP.decrypt(encrypted, options);</span>
<a href="#l3.54"></a><span id="l3.54">   }</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">   /**</span>
<a href="#l3.57"></a><span id="l3.57">    *</span>
<a href="#l3.58"></a><span id="l3.58">    * @param {String} encrypted     The encrypted data</span>
<a href="#l3.59"></a><span id="l3.59">    * @param {Object} options       Decryption options</span>
<a href="#l3.60"></a><span id="l3.60">    *</span>
<a href="#l3.61"></a><span id="l3.61">    * @return {Promise&lt;Object&gt;} - Return object with decryptedData and</span>
<a href="#l3.62"></a><span id="l3.62">    * status information</span>
<a href="#l3.63"></a><span id="l3.63">    *</span>
<a href="#l3.64"></a><span id="l3.64">    * Use Promise.catch to handle failed decryption.</span>
<a href="#l3.65"></a><span id="l3.65">    * retObj.errorMsg will be an error message in this case.</span>
<a href="#l3.66"></a><span id="l3.66">    */</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-  decryptMime(encrypted, options) {</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  async decryptMime(encrypted, options) {</span>
<a href="#l3.70"></a><span id="l3.70">     EnigmailLog.DEBUG(`rnp-cryptoAPI.js: decryptMime()\n`);</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">     // write something to gpg such that the process doesn't get stuck</span>
<a href="#l3.73"></a><span id="l3.73">     if (encrypted.length === 0) {</span>
<a href="#l3.74"></a><span id="l3.74">       encrypted = &quot;NO DATA\n&quot;;</span>
<a href="#l3.75"></a><span id="l3.75">     }</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77">     options.noOutput = false;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineat">@@ -253,16 +251,20 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l3.79"></a><span id="l3.79">   async deleteKey(keyFingerprint, deleteSecret) {</span>
<a href="#l3.80"></a><span id="l3.80">     return RNP.deleteKey(keyFingerprint, deleteSecret);</span>
<a href="#l3.81"></a><span id="l3.81">   }</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">   async encryptAndOrSign(plaintext, args, resultStatus) {</span>
<a href="#l3.84"></a><span id="l3.84">     return RNP.encryptAndOrSign(plaintext, args, resultStatus);</span>
<a href="#l3.85"></a><span id="l3.85">   }</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  async getNewRevocation(id) {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    return RNP.getNewRevocation(id);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  }</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+</span>
<a href="#l3.91"></a><span id="l3.91">   async getPublicKey(id) {</span>
<a href="#l3.92"></a><span id="l3.92">     return RNP.getPublicKey(id);</span>
<a href="#l3.93"></a><span id="l3.93">   }</span>
<a href="#l3.94"></a><span id="l3.94"> }</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96"> function getRNPAPI() {</span>
<a href="#l3.97"></a><span id="l3.97">   return new RNPCryptoAPI();</span>
<a href="#l3.98"></a><span id="l3.98"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -36,24 +36,21 @@ class CryptoAPI {</span>
<a href="#l4.4"></a><span id="l4.4">       inspector = Cc[&quot;@mozilla.org/jsinspector;1&quot;].createInstance(</span>
<a href="#l4.5"></a><span id="l4.5">         Ci.nsIJSInspector</span>
<a href="#l4.6"></a><span id="l4.6">       );</span>
<a href="#l4.7"></a><span id="l4.7">     }</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">     let res = null;</span>
<a href="#l4.10"></a><span id="l4.10">     promise</span>
<a href="#l4.11"></a><span id="l4.11">       .then(gotResult =&gt; {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        console.log(&quot;CryptoAPI.sync() good result:&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-        console.log(gotResult);</span>
<a href="#l4.14"></a><span id="l4.14">         res = gotResult;</span>
<a href="#l4.15"></a><span id="l4.15">         inspector.exitNestedEventLoop();</span>
<a href="#l4.16"></a><span id="l4.16">       })</span>
<a href="#l4.17"></a><span id="l4.17">       .catch(gotResult =&gt; {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-        console.log(&quot;CryptoAPI.sync() failed result:&quot;);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-        console.log(gotResult);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+        console.log(&quot;CryptoAPI.sync() failed result: %o&quot;, gotResult);</span>
<a href="#l4.21"></a><span id="l4.21">         res = gotResult;</span>
<a href="#l4.22"></a><span id="l4.22">         inspector.exitNestedEventLoop();</span>
<a href="#l4.23"></a><span id="l4.23">       });</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     inspector.enterNestedEventLoop(0);</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">     console.log(&quot;CryptoAPI.sync() leaving&quot;);</span>
<a href="#l4.28"></a><span id="l4.28">     return res;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -284,9 +281,13 @@ class CryptoAPI {</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   async deleteKey(keyFingerprint, deleteSecret) {</span>
<a href="#l4.32"></a><span id="l4.32">     return null;</span>
<a href="#l4.33"></a><span id="l4.33">   }</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   async encryptAndOrSign(plaintext, args, resultStatus) {</span>
<a href="#l4.36"></a><span id="l4.36">     return null;</span>
<a href="#l4.37"></a><span id="l4.37">   }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  async getNewRevocation(id) {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    return null;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  }</span>
<a href="#l4.42"></a><span id="l4.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -96,27 +96,42 @@ function newStatusObject() {</span>
<a href="#l5.4"></a><span id="l5.4"> var EnigmailDecryption = {</span>
<a href="#l5.5"></a><span id="l5.5">   isReady(win) {</span>
<a href="#l5.6"></a><span id="l5.6">     // this used to return false while generating a key. still necessary?</span>
<a href="#l5.7"></a><span id="l5.7">     return EnigmailCore.getService(win);</span>
<a href="#l5.8"></a><span id="l5.8">   },</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   getFromAddr(win) {</span>
<a href="#l5.11"></a><span id="l5.11">     var fromAddr;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    if (win &amp;&amp; win.gFolderDisplay &amp;&amp; win.gFolderDisplay.selectedMessage) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-      fromAddr = win.gFolderDisplay.selectedMessage.author;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    if (</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+      win &amp;&amp;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+      win.gFolderDisplay &amp;&amp;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+      win.gFolderDisplay.messageDisplay &amp;&amp;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      win.gFolderDisplay.messageDisplay.displayedMessage</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+    ) {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      fromAddr = win.gFolderDisplay.messageDisplay.displayedMessage.author;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+    } else if (</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+      win &amp;&amp;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+      win.gFolderDisplay &amp;&amp;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+      win.gFolderDisplay.selectedMessage</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    ) {</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+      fromAddr =</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+        win &amp;&amp; win.gFolderDisplay &amp;&amp; win.gFolderDisplay.selectedMessage.author;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+    }</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    if (fromAddr) {</span>
<a href="#l5.30"></a><span id="l5.30">       try {</span>
<a href="#l5.31"></a><span id="l5.31">         fromAddr = EnigmailFuncs.stripEmail(fromAddr);</span>
<a href="#l5.32"></a><span id="l5.32">         if (fromAddr.search(/[a-zA-Z0-9]@.*[\(\)]/) &gt;= 0) {</span>
<a href="#l5.33"></a><span id="l5.33">           fromAddr = false;</span>
<a href="#l5.34"></a><span id="l5.34">         }</span>
<a href="#l5.35"></a><span id="l5.35">       } catch (ex) {</span>
<a href="#l5.36"></a><span id="l5.36">         fromAddr = false;</span>
<a href="#l5.37"></a><span id="l5.37">       }</span>
<a href="#l5.38"></a><span id="l5.38">     }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+</span>
<a href="#l5.40"></a><span id="l5.40">     return fromAddr;</span>
<a href="#l5.41"></a><span id="l5.41">   },</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">   /**</span>
<a href="#l5.44"></a><span id="l5.44">    *  Decrypts a PGP ciphertext and returns the the plaintext</span>
<a href="#l5.45"></a><span id="l5.45">    *</span>
<a href="#l5.46"></a><span id="l5.46">    *in  @parent a window object</span>
<a href="#l5.47"></a><span id="l5.47">    *in  @uiFlags see flag options in EnigmailConstants, UI_INTERACTIVE, UI_ALLOW_KEY_IMPORT</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -168,16 +183,17 @@ var EnigmailDecryption = {</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">     EnigmailLog.DEBUG(</span>
<a href="#l5.51"></a><span id="l5.51">       &quot;decryption.jsm: decryptMessage: oldSignature=&quot; + oldSignature + &quot;\n&quot;</span>
<a href="#l5.52"></a><span id="l5.52">     );</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">     signatureObj.value = &quot;&quot;;</span>
<a href="#l5.55"></a><span id="l5.55">     exitCodeObj.value = -1;</span>
<a href="#l5.56"></a><span id="l5.56">     statusFlagsObj.value = 0;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+    statusFlagsObj.ext = 0;</span>
<a href="#l5.58"></a><span id="l5.58">     keyIdObj.value = &quot;&quot;;</span>
<a href="#l5.59"></a><span id="l5.59">     userIdObj.value = &quot;&quot;;</span>
<a href="#l5.60"></a><span id="l5.60">     errorMsgObj.value = &quot;&quot;;</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     var beginIndexObj = {};</span>
<a href="#l5.63"></a><span id="l5.63">     var endIndexObj = {};</span>
<a href="#l5.64"></a><span id="l5.64">     var indentStrObj = {};</span>
<a href="#l5.65"></a><span id="l5.65">     var blockType = EnigmailArmor.locateArmoredBlock(</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -390,17 +406,17 @@ var EnigmailDecryption = {</span>
<a href="#l5.67"></a><span id="l5.67">           errorMsgObj.value;</span>
<a href="#l5.68"></a><span id="l5.68">         return &quot;&quot;;</span>
<a href="#l5.69"></a><span id="l5.69">       }</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">       // Return bad signature (for checking later)</span>
<a href="#l5.72"></a><span id="l5.72">       signatureObj.value = newSignature;</span>
<a href="#l5.73"></a><span id="l5.73">     } else if (</span>
<a href="#l5.74"></a><span id="l5.74">       pubKeyId &amp;&amp;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      statusFlagsObj.value &amp; EnigmailConstants.UNVERIFIED_SIGNATURE</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+      statusFlagsObj.value &amp; EnigmailConstants.UNCERTAIN_SIGNATURE</span>
<a href="#l5.77"></a><span id="l5.77">     ) {</span>
<a href="#l5.78"></a><span id="l5.78">       // TODO: import into scratch area</span>
<a href="#l5.79"></a><span id="l5.79">       /*</span>
<a href="#l5.80"></a><span id="l5.80">       var innerKeyBlock;</span>
<a href="#l5.81"></a><span id="l5.81">       if (verifyOnly) {</span>
<a href="#l5.82"></a><span id="l5.82">         // Search for indented public key block in signed message</span>
<a href="#l5.83"></a><span id="l5.83">         var innerBlockType = EnigmailArmor.locateArmoredBlock(</span>
<a href="#l5.84"></a><span id="l5.84">           pgpBlock,</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineat">@@ -585,16 +601,17 @@ var EnigmailDecryption = {</span>
<a href="#l5.86"></a><span id="l5.86">               statusFlagsObj.value = EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l5.87"></a><span id="l5.87">             }</span>
<a href="#l5.88"></a><span id="l5.88">           }</span>
<a href="#l5.89"></a><span id="l5.89">         }</span>
<a href="#l5.90"></a><span id="l5.90">       } else {</span>
<a href="#l5.91"></a><span id="l5.91">         exitCodeObj.value = 0;</span>
<a href="#l5.92"></a><span id="l5.92">         statusFlagsObj.value = EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l5.93"></a><span id="l5.93">       }</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+      statusFlagsObj.ext = 0;</span>
<a href="#l5.95"></a><span id="l5.95">       return true;</span>
<a href="#l5.96"></a><span id="l5.96">     }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">     //var outFileName = EnigmailFiles.getEscapedFilename(EnigmailFiles.getFilePathReadonly(outFile.QueryInterface(Ci.nsIFile), NS_WRONLY));</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l5.101"></a><span id="l5.101">     let result = cApi.sync(cApi.decryptAttachment(byteData));</span>
<a href="#l5.102"></a><span id="l5.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -451,18 +451,16 @@ var EnigmailEncryption = {</span>
<a href="#l6.4"></a><span id="l6.4">       statusFlagsObj.value =</span>
<a href="#l6.5"></a><span id="l6.5">         EnigmailConstants.INVALID_RECIPIENT |</span>
<a href="#l6.6"></a><span id="l6.6">         EnigmailConstants.NO_SECKEY |</span>
<a href="#l6.7"></a><span id="l6.7">         EnigmailConstants.DISPLAY_MESSAGE;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">       return null;</span>
<a href="#l6.10"></a><span id="l6.10">     }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    var pgpMime = uiFlags &amp; EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-</span>
<a href="#l6.14"></a><span id="l6.14">     var hashAlgo =</span>
<a href="#l6.15"></a><span id="l6.15">       gMimeHashAlgorithms[EnigmailPrefs.getPref(&quot;mimeHashAlgorithm&quot;)];</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">     if (hashAlgorithm) {</span>
<a href="#l6.18"></a><span id="l6.18">       hashAlgo = hashAlgorithm;</span>
<a href="#l6.19"></a><span id="l6.19">     }</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">     errorMsgObj.value = &quot;&quot;;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -521,29 +519,26 @@ var EnigmailEncryption = {</span>
<a href="#l6.23"></a><span id="l6.23">     console.debug(&quot;listener: %o&quot;, listener);</span>
<a href="#l6.24"></a><span id="l6.24">     let encrypted = cApi.sync(</span>
<a href="#l6.25"></a><span id="l6.25">       cApi.encryptAndOrSign(</span>
<a href="#l6.26"></a><span id="l6.26">         listener.getInputForEncryption(),</span>
<a href="#l6.27"></a><span id="l6.27">         encryptArgs,</span>
<a href="#l6.28"></a><span id="l6.28">         resultStatus</span>
<a href="#l6.29"></a><span id="l6.29">       )</span>
<a href="#l6.30"></a><span id="l6.30">     );</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    console.debug(`encryptAndOrSign returned: ${encrypted}`);</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    if (encrypted) {</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    if (resultStatus.exitCode) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+      if (resultStatus.errorMsg.length) {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+        EnigmailDialog.alert(win, resultStatus.errorMsg);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+      }</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    } else if (encrypted) {</span>
<a href="#l6.39"></a><span id="l6.39">       listener.addEncryptedOutput(encrypted);</span>
<a href="#l6.40"></a><span id="l6.40">     }</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    if (pgpMime &amp;&amp; errorMsgObj.value) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-      EnigmailDialog.alert(win, errorMsgObj.value);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-</span>
<a href="#l6.46"></a><span id="l6.46">     listener.done(resultStatus.exitCode);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    //return proc;</span>
<a href="#l6.49"></a><span id="l6.49">     return null;</span>
<a href="#l6.50"></a><span id="l6.50">   },</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   encryptMessageEnd(</span>
<a href="#l6.53"></a><span id="l6.53">     fromMailAddr,</span>
<a href="#l6.54"></a><span id="l6.54">     stderrStr,</span>
<a href="#l6.55"></a><span id="l6.55">     exitCode,</span>
<a href="#l6.56"></a><span id="l6.56">     uiFlags,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1136,17 +1136,17 @@ function loadKeyList(win, sortColumn, so</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * no return value</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> function updateSortList() {</span>
<a href="#l7.8"></a><span id="l7.8">   gKeyListObj.keySortList = [];</span>
<a href="#l7.9"></a><span id="l7.9">   for (let i = 0; i &lt; gKeyListObj.keyList.length; i++) {</span>
<a href="#l7.10"></a><span id="l7.10">     let keyObj = gKeyListObj.keyList[i];</span>
<a href="#l7.11"></a><span id="l7.11">     gKeyListObj.keySortList.push({</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      userId: keyObj.userId.toLowerCase(),</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      userId: keyObj.userId ? keyObj.userId.toLowerCase() : &quot;&quot;,</span>
<a href="#l7.14"></a><span id="l7.14">       keyId: keyObj.keyId,</span>
<a href="#l7.15"></a><span id="l7.15">       fpr: keyObj.fpr,</span>
<a href="#l7.16"></a><span id="l7.16">       keyNum: i,</span>
<a href="#l7.17"></a><span id="l7.17">     });</span>
<a href="#l7.18"></a><span id="l7.18">   }</span>
<a href="#l7.19"></a><span id="l7.19"> }</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeDecrypt.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,16 +6,18 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> var EXPORTED_SYMBOLS = [&quot;EnigmailMimeDecrypt&quot;];</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> /**</span>
<a href="#l8.8"></a><span id="l8.8">  *  Module for handling PGP/MIME encrypted messages</span>
<a href="#l8.9"></a><span id="l8.9">  *  implemented as an XPCOM object</span>
<a href="#l8.10"></a><span id="l8.10">  */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14"> const { EnigmailCore } = ChromeUtils.import(</span>
<a href="#l8.15"></a><span id="l8.15">   &quot;chrome://openpgp/content/modules/core.jsm&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> );</span>
<a href="#l8.17"></a><span id="l8.17"> const { EnigmailVerify } = ChromeUtils.import(</span>
<a href="#l8.18"></a><span id="l8.18">   &quot;chrome://openpgp/content/modules/mimeVerify.jsm&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> );</span>
<a href="#l8.20"></a><span id="l8.20"> const { EnigmailLog } = ChromeUtils.import(</span>
<a href="#l8.21"></a><span id="l8.21">   &quot;chrome://openpgp/content/modules/log.jsm&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -58,17 +60,17 @@ const { EnigmailCompat } = ChromeUtils.i</span>
<a href="#l8.23"></a><span id="l8.23"> );</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> const ENCODING_DEFAULT = 0;</span>
<a href="#l8.26"></a><span id="l8.26"> const ENCODING_BASE64 = 1;</span>
<a href="#l8.27"></a><span id="l8.27"> const ENCODING_QP = 2;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> const LAST_MSG = EnigmailSingletons.lastDecryptedMessage;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-var gDebugLogLevel = 5;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+var gDebugLogLevel = 3;</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34"> var gNumProc = 0;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> var EnigmailMimeDecrypt = {</span>
<a href="#l8.37"></a><span id="l8.37">   /**</span>
<a href="#l8.38"></a><span id="l8.38">    * create a new instance of a PGP/MIME decryption handler</span>
<a href="#l8.39"></a><span id="l8.39">    */</span>
<a href="#l8.40"></a><span id="l8.40">   newPgpMimeHandler() {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -132,17 +134,19 @@ Content-Type: text/html</span>
<a href="#l8.42"></a><span id="l8.42">           msg += `From: ${dbHdr.author}\r\n`;</span>
<a href="#l8.43"></a><span id="l8.43">         }</span>
<a href="#l8.44"></a><span id="l8.44">         if (dbHdr.recipients) {</span>
<a href="#l8.45"></a><span id="l8.45">           msg += `To: ${dbHdr.recipients}\r\n`;</span>
<a href="#l8.46"></a><span id="l8.46">         }</span>
<a href="#l8.47"></a><span id="l8.47">         if (dbHdr.ccList) {</span>
<a href="#l8.48"></a><span id="l8.48">           msg += `Cc: ${dbHdr.ccList}\r\n`;</span>
<a href="#l8.49"></a><span id="l8.49">         }</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-      } catch (x) {}</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      } catch (x) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+        console.debug(x);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      }</span>
<a href="#l8.54"></a><span id="l8.54">     }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">     return msg;</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58"> };</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60"> ////////////////////////////////////////////////////////////////////</span>
<a href="#l8.61"></a><span id="l8.61"> // handler for PGP/MIME encrypted messages</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineat">@@ -237,18 +241,23 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.63"></a><span id="l8.63">     this.base64Cache = &quot;&quot;;</span>
<a href="#l8.64"></a><span id="l8.64">     this.outQueue = &quot;&quot;;</span>
<a href="#l8.65"></a><span id="l8.65">     this.statusStr = &quot;&quot;;</span>
<a href="#l8.66"></a><span id="l8.66">     this.headerMode = 0;</span>
<a href="#l8.67"></a><span id="l8.67">     this.decryptedHeaders = {};</span>
<a href="#l8.68"></a><span id="l8.68">     this.xferEncoding = ENCODING_DEFAULT;</span>
<a href="#l8.69"></a><span id="l8.69">     this.boundary = EnigmailMime.getBoundary(this.mimeSvc.contentType);</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    if (!this.isReloadingLastMessage()) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    let now = Date.now();</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    let timeoutReached =</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+      EnigmailSingletons.lastMessageDecryptTime &amp;&amp;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+      now - EnigmailSingletons.lastMessageDecryptTime &gt; 10000;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    if (timeoutReached || !this.isReloadingLastMessage()) {</span>
<a href="#l8.77"></a><span id="l8.77">       EnigmailSingletons.clearLastDecryptedMessage();</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+      EnigmailSingletons.lastMessageDecryptTime = now;</span>
<a href="#l8.79"></a><span id="l8.79">     }</span>
<a href="#l8.80"></a><span id="l8.80">   },</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82">   processData(data) {</span>
<a href="#l8.83"></a><span id="l8.83">     // detect MIME part boundary</span>
<a href="#l8.84"></a><span id="l8.84">     if (data.includes(this.boundary)) {</span>
<a href="#l8.85"></a><span id="l8.85">       LOCAL_DEBUG(&quot;mimeDecrypt.jsm: processData: found boundary\n&quot;);</span>
<a href="#l8.86"></a><span id="l8.86">       ++this.mimePartCount;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineat">@@ -329,16 +338,17 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.88"></a><span id="l8.88">       str = str.substring(0, str.length - excess);</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">       try {</span>
<a href="#l8.91"></a><span id="l8.91">         atob(str);</span>
<a href="#l8.92"></a><span id="l8.92">         // if the conversion succeds, we have a base64 encoded message</span>
<a href="#l8.93"></a><span id="l8.93">         ret = true;</span>
<a href="#l8.94"></a><span id="l8.94">       } catch (ex) {</span>
<a href="#l8.95"></a><span id="l8.95">         // not a base64 encoded</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+        console.debug(ex);</span>
<a href="#l8.97"></a><span id="l8.97">       }</span>
<a href="#l8.98"></a><span id="l8.98">     }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100">     return ret;</span>
<a href="#l8.101"></a><span id="l8.101">   },</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">   // cache encrypted data</span>
<a href="#l8.104"></a><span id="l8.104">   cacheData(str) {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineat">@@ -351,16 +361,17 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107">   processBase64Message() {</span>
<a href="#l8.108"></a><span id="l8.108">     LOCAL_DEBUG(&quot;mimeDecrypt.jsm: processBase64Message\n&quot;);</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110">     try {</span>
<a href="#l8.111"></a><span id="l8.111">       this.base64Cache = EnigmailData.decodeBase64(this.base64Cache);</span>
<a href="#l8.112"></a><span id="l8.112">     } catch (ex) {</span>
<a href="#l8.113"></a><span id="l8.113">       // if decoding failed, try non-encoded version</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+      console.debug(ex);</span>
<a href="#l8.115"></a><span id="l8.115">     }</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">     let lines = this.base64Cache.replace(/\r\n/g, &quot;\n&quot;).split(/\n/);</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">     for (let i = 0; i &lt; lines.length; i++) {</span>
<a href="#l8.120"></a><span id="l8.120">       this.processData(lines[i] + &quot;\r\n&quot;);</span>
<a href="#l8.121"></a><span id="l8.121">     }</span>
<a href="#l8.122"></a><span id="l8.122">   },</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineat">@@ -491,16 +502,17 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.124"></a><span id="l8.124">               url.value.host !== this.uri.host ||</span>
<a href="#l8.125"></a><span id="l8.125">               url.value.pathQueryRef !== this.uri.pathQueryRef</span>
<a href="#l8.126"></a><span id="l8.126">             ) {</span>
<a href="#l8.127"></a><span id="l8.127">               return;</span>
<a href="#l8.128"></a><span id="l8.128">             }</span>
<a href="#l8.129"></a><span id="l8.129">           }</span>
<a href="#l8.130"></a><span id="l8.130">         }</span>
<a href="#l8.131"></a><span id="l8.131">       } catch (ex) {</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+        console.debug(ex);</span>
<a href="#l8.133"></a><span id="l8.133">         EnigmailLog.writeException(&quot;mimeDecrypt.js&quot;, ex);</span>
<a href="#l8.134"></a><span id="l8.134">         EnigmailLog.DEBUG(</span>
<a href="#l8.135"></a><span id="l8.135">           &quot;mimeDecrypt.jsm: error while processing &quot; + this.msgUriSpec + &quot;\n&quot;</span>
<a href="#l8.136"></a><span id="l8.136">         );</span>
<a href="#l8.137"></a><span id="l8.137">       }</span>
<a href="#l8.138"></a><span id="l8.138">     }</span>
<a href="#l8.139"></a><span id="l8.139"> </span>
<a href="#l8.140"></a><span id="l8.140">     let spec = this.uri ? this.uri.spec : null;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineat">@@ -531,39 +543,64 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.142"></a><span id="l8.142">       if (!EnigmailDecryption.isReady(win)) {</span>
<a href="#l8.143"></a><span id="l8.143">         return;</span>
<a href="#l8.144"></a><span id="l8.144">       }</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146">       // limit output to 100 times message size to avoid DoS attack</span>
<a href="#l8.147"></a><span id="l8.147">       let maxOutput = this.outQueue.length * 100;</span>
<a href="#l8.148"></a><span id="l8.148"> </span>
<a href="#l8.149"></a><span id="l8.149">       EnigmailLog.DEBUG(&quot;mimeDecryp.jsm: starting decryption\n&quot;);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      EnigmailLog.DEBUG(this.outQueue + &quot;\n&quot;);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      //EnigmailLog.DEBUG(this.outQueue + &quot;\n&quot;);</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153">       let keyserver = EnigmailPrefs.getPref(&quot;autoKeyRetrieve&quot;);</span>
<a href="#l8.154"></a><span id="l8.154">       let options = {</span>
<a href="#l8.155"></a><span id="l8.155">         keyserver,</span>
<a href="#l8.156"></a><span id="l8.156">         keyserverProxy: EnigmailHttpProxy.getHttpProxy(keyserver),</span>
<a href="#l8.157"></a><span id="l8.157">         fromAddr: EnigmailDecryption.getFromAddr(win),</span>
<a href="#l8.158"></a><span id="l8.158">         maxOutputLength: maxOutput,</span>
<a href="#l8.159"></a><span id="l8.159">       };</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+      if (!options.fromAddr) {</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+        var win2 = Services.wm.getMostRecentWindow(null);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+        options.fromAddr = EnigmailDecryption.getFromAddr(win2);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+      }</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+</span>
<a href="#l8.166"></a><span id="l8.166">       const cApi = EnigmailCryptoAPI();</span>
<a href="#l8.167"></a><span id="l8.167">       EnigmailLog.DEBUG(&quot;mimeDecrypt.jsm: got API: &quot; + cApi.api_name + &quot;\n&quot;);</span>
<a href="#l8.168"></a><span id="l8.168">       this.returnStatus = cApi.sync(cApi.decryptMime(this.outQueue, options));</span>
<a href="#l8.169"></a><span id="l8.169">       if (!this.returnStatus) {</span>
<a href="#l8.170"></a><span id="l8.170">         this.returnStatus = {</span>
<a href="#l8.171"></a><span id="l8.171">           decryptedData: &quot;&quot;,</span>
<a href="#l8.172"></a><span id="l8.172">           exitCode: -1,</span>
<a href="#l8.173"></a><span id="l8.173">           statusFlags: EnigmailConstants.DECRYPTION_FAILED,</span>
<a href="#l8.174"></a><span id="l8.174">         };</span>
<a href="#l8.175"></a><span id="l8.175">       }</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177">       this.returnStatus.statusFlags |= EnigmailConstants.PGP_MIME_ENCRYPTED;</span>
<a href="#l8.178"></a><span id="l8.178"> </span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-      if (this.returnStatus.exitCode) {</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+      if (</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+        this.returnStatus.exitCode &amp;&amp;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+        this.returnStatus.decryptedData.length</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+      ) {</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+        // We got a failure return, however, we got decrypted data.</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+        // Did we get any verification failure flags?</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+        // If yes, then conclude only verification failed.</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+        if (</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+          this.returnStatus.statusFlags &amp;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+          (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+            EnigmailConstants.UNCERTAIN_SIGNATURE |</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+            EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+            EnigmailConstants.EXPIRED_KEY_SIGNATURE)</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+        ) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+          this.returnStatus.statusFlags |= EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+        } else {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+          this.returnStatus.statusFlags |= EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+        }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+      } else if (this.returnStatus.exitCode) {</span>
<a href="#l8.200"></a><span id="l8.200">         this.returnStatus.statusFlags |= EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l8.201"></a><span id="l8.201">       } else if (</span>
<a href="#l8.202"></a><span id="l8.202">         !(this.returnStatus.statusFlags &amp; EnigmailConstants.DECRYPTION_FAILED)</span>
<a href="#l8.203"></a><span id="l8.203">       ) {</span>
<a href="#l8.204"></a><span id="l8.204">         this.returnStatus.statusFlags |= EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l8.205"></a><span id="l8.205">       }</span>
<a href="#l8.206"></a><span id="l8.206"> </span>
<a href="#l8.207"></a><span id="l8.207">       this.decryptedData = this.returnStatus.decryptedData;</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineat">@@ -657,32 +694,34 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.209"></a><span id="l8.209">           JSON.stringify(this.decryptedHeaders),</span>
<a href="#l8.210"></a><span id="l8.210">           this.mimePartNumber</span>
<a href="#l8.211"></a><span id="l8.211">         );</span>
<a href="#l8.212"></a><span id="l8.212"> </span>
<a href="#l8.213"></a><span id="l8.213">         headerSink.updateSecurityStatus(</span>
<a href="#l8.214"></a><span id="l8.214">           this.msgUriSpec,</span>
<a href="#l8.215"></a><span id="l8.215">           this.exitCode,</span>
<a href="#l8.216"></a><span id="l8.216">           this.returnStatus.statusFlags,</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+          this.returnStatus.extStatusFlags,</span>
<a href="#l8.218"></a><span id="l8.218">           this.returnStatus.keyId,</span>
<a href="#l8.219"></a><span id="l8.219">           this.returnStatus.userId,</span>
<a href="#l8.220"></a><span id="l8.220">           this.returnStatus.sigDetails,</span>
<a href="#l8.221"></a><span id="l8.221">           this.returnStatus.errorMsg,</span>
<a href="#l8.222"></a><span id="l8.222">           this.returnStatus.blockSeparation,</span>
<a href="#l8.223"></a><span id="l8.223">           this.uri,</span>
<a href="#l8.224"></a><span id="l8.224">           JSON.stringify({</span>
<a href="#l8.225"></a><span id="l8.225">             encryptedTo: this.returnStatus.encToDetails,</span>
<a href="#l8.226"></a><span id="l8.226">           }),</span>
<a href="#l8.227"></a><span id="l8.227">           this.mimePartNumber</span>
<a href="#l8.228"></a><span id="l8.228">         );</span>
<a href="#l8.229"></a><span id="l8.229">       } else {</span>
<a href="#l8.230"></a><span id="l8.230">         this.updateHeadersInMsgDb();</span>
<a href="#l8.231"></a><span id="l8.231">       }</span>
<a href="#l8.232"></a><span id="l8.232">       this.statusDisplayed = true;</span>
<a href="#l8.233"></a><span id="l8.233">     } catch (ex) {</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+      console.debug(ex);</span>
<a href="#l8.235"></a><span id="l8.235">       EnigmailLog.writeException(&quot;mimeDecrypt.jsm&quot;, ex);</span>
<a href="#l8.236"></a><span id="l8.236">     }</span>
<a href="#l8.237"></a><span id="l8.237">     LOCAL_DEBUG(&quot;mimeDecrypt.jsm: displayStatus done\n&quot;);</span>
<a href="#l8.238"></a><span id="l8.238">   },</span>
<a href="#l8.239"></a><span id="l8.239"> </span>
<a href="#l8.240"></a><span id="l8.240">   handleResult(exitCode) {</span>
<a href="#l8.241"></a><span id="l8.241">     LOCAL_DEBUG(&quot;mimeDecrypt.jsm: done: &quot; + exitCode + &quot;\n&quot;);</span>
<a href="#l8.242"></a><span id="l8.242"> </span>
<a href="#l8.243"></a><span id="l8.243" class="difflineat">@@ -695,17 +734,19 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.244"></a><span id="l8.244">     // ensure newline at the end of the stream</span>
<a href="#l8.245"></a><span id="l8.245">     if (!this.decryptedData.endsWith(&quot;\n&quot;)) {</span>
<a href="#l8.246"></a><span id="l8.246">       this.decryptedData += &quot;\r\n&quot;;</span>
<a href="#l8.247"></a><span id="l8.247">     }</span>
<a href="#l8.248"></a><span id="l8.248"> </span>
<a href="#l8.249"></a><span id="l8.249">     try {</span>
<a href="#l8.250"></a><span id="l8.250">       this.extractEncryptedHeaders();</span>
<a href="#l8.251"></a><span id="l8.251">       this.extractAutocryptGossip();</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    } catch (ex) {</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      console.debug(ex);</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    }</span>
<a href="#l8.256"></a><span id="l8.256"> </span>
<a href="#l8.257"></a><span id="l8.257">     let i = this.decryptedData.search(/\n\r?\n/);</span>
<a href="#l8.258"></a><span id="l8.258">     if (i &gt; 0) {</span>
<a href="#l8.259"></a><span id="l8.259">       var hdr = this.decryptedData.substr(0, i).split(/\r?\n/);</span>
<a href="#l8.260"></a><span id="l8.260">       for (let j = 0; j &lt; hdr.length; j++) {</span>
<a href="#l8.261"></a><span id="l8.261">         if (hdr[j].search(/^\s*content-type:\s+text\/(plain|html)/i) &gt;= 0) {</span>
<a href="#l8.262"></a><span id="l8.262">           LOCAL_DEBUG(</span>
<a href="#l8.263"></a><span id="l8.263">             &quot;mimeDecrypt.jsm: done: adding multipart/mixed around &quot; +</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineat">@@ -791,43 +832,47 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.265"></a><span id="l8.265">           Ci.nsIStringInputStream</span>
<a href="#l8.266"></a><span id="l8.266">         );</span>
<a href="#l8.267"></a><span id="l8.267">         gConv.setData(data, data.length);</span>
<a href="#l8.268"></a><span id="l8.268">         this.mimeSvc.onStartRequest(null, null);</span>
<a href="#l8.269"></a><span id="l8.269">         this.mimeSvc.onDataAvailable(null, null, gConv, 0, data.length);</span>
<a href="#l8.270"></a><span id="l8.270">         this.mimeSvc.onStopRequest(null, null, 0);</span>
<a href="#l8.271"></a><span id="l8.271">       }</span>
<a href="#l8.272"></a><span id="l8.272">     } catch (ex) {</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+      console.debug(ex);</span>
<a href="#l8.274"></a><span id="l8.274">       EnigmailLog.ERROR(</span>
<a href="#l8.275"></a><span id="l8.275">         &quot;mimeDecrypt.jsm: returnData(): mimeSvc.onDataAvailable failed:\n&quot; +</span>
<a href="#l8.276"></a><span id="l8.276">           ex.toString()</span>
<a href="#l8.277"></a><span id="l8.277">       );</span>
<a href="#l8.278"></a><span id="l8.278">     }</span>
<a href="#l8.279"></a><span id="l8.279">   },</span>
<a href="#l8.280"></a><span id="l8.280"> </span>
<a href="#l8.281"></a><span id="l8.281">   handleManualDecrypt() {</span>
<a href="#l8.282"></a><span id="l8.282">     try {</span>
<a href="#l8.283"></a><span id="l8.283">       let headerSink = EnigmailSingletons.messageReader;</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285">       if (headerSink &amp;&amp; this.uri &amp;&amp; !this.backgroundJob) {</span>
<a href="#l8.286"></a><span id="l8.286">         headerSink.updateSecurityStatus(</span>
<a href="#l8.287"></a><span id="l8.287">           this.msgUriSpec,</span>
<a href="#l8.288"></a><span id="l8.288">           EnigmailConstants.POSSIBLE_PGPMIME,</span>
<a href="#l8.289"></a><span id="l8.289">           0,</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+          0,</span>
<a href="#l8.291"></a><span id="l8.291">           &quot;&quot;,</span>
<a href="#l8.292"></a><span id="l8.292">           &quot;&quot;,</span>
<a href="#l8.293"></a><span id="l8.293">           &quot;&quot;,</span>
<a href="#l8.294"></a><span id="l8.294">           EnigmailLocale.getString(&quot;possiblyPgpMime&quot;),</span>
<a href="#l8.295"></a><span id="l8.295">           &quot;&quot;,</span>
<a href="#l8.296"></a><span id="l8.296">           this.uri,</span>
<a href="#l8.297"></a><span id="l8.297">           null,</span>
<a href="#l8.298"></a><span id="l8.298">           &quot;&quot;</span>
<a href="#l8.299"></a><span id="l8.299">         );</span>
<a href="#l8.300"></a><span id="l8.300">       }</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    } catch (ex) {</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+      console.debug(ex);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    }</span>
<a href="#l8.305"></a><span id="l8.305"> </span>
<a href="#l8.306"></a><span id="l8.306">     return 0;</span>
<a href="#l8.307"></a><span id="l8.307">   },</span>
<a href="#l8.308"></a><span id="l8.308"> </span>
<a href="#l8.309"></a><span id="l8.309">   updateHeadersInMsgDb() {</span>
<a href="#l8.310"></a><span id="l8.310">     if (this.mimePartNumber !== &quot;1&quot;) {</span>
<a href="#l8.311"></a><span id="l8.311">       return;</span>
<a href="#l8.312"></a><span id="l8.312">     }</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineat">@@ -838,17 +883,19 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.314"></a><span id="l8.314">     if (this.decryptedHeaders &amp;&amp; &quot;subject&quot; in this.decryptedHeaders) {</span>
<a href="#l8.315"></a><span id="l8.315">       try {</span>
<a href="#l8.316"></a><span id="l8.316">         let msgDbHdr = this.uri.QueryInterface(Ci.nsIMsgMessageUrl)</span>
<a href="#l8.317"></a><span id="l8.317">           .messageHeader;</span>
<a href="#l8.318"></a><span id="l8.318">         msgDbHdr.subject = EnigmailData.convertFromUnicode(</span>
<a href="#l8.319"></a><span id="l8.319">           this.decryptedHeaders.subject,</span>
<a href="#l8.320"></a><span id="l8.320">           &quot;utf-8&quot;</span>
<a href="#l8.321"></a><span id="l8.321">         );</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-      } catch (x) {}</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+      } catch (x) {</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+        console.debug(x);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+      }</span>
<a href="#l8.326"></a><span id="l8.326">     }</span>
<a href="#l8.327"></a><span id="l8.327">   },</span>
<a href="#l8.328"></a><span id="l8.328"> </span>
<a href="#l8.329"></a><span id="l8.329">   extractEncryptedHeaders() {</span>
<a href="#l8.330"></a><span id="l8.330">     let r = EnigmailMime.extractProtectedHeaders(this.decryptedData);</span>
<a href="#l8.331"></a><span id="l8.331">     if (!r) {</span>
<a href="#l8.332"></a><span id="l8.332">       return;</span>
<a href="#l8.333"></a><span id="l8.333">     }</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineat">@@ -875,30 +922,33 @@ MimeDecryptHandler.prototype = {</span>
<a href="#l8.335"></a><span id="l8.335">     EnigmailLog.DEBUG(</span>
<a href="#l8.336"></a><span id="l8.336">       `mimeDecrypt.jsm: extractAutocryptGossip: found ${gossip.length} headers\n`</span>
<a href="#l8.337"></a><span id="l8.337">     );</span>
<a href="#l8.338"></a><span id="l8.338"> </span>
<a href="#l8.339"></a><span id="l8.339">     let msgDate = null;</span>
<a href="#l8.340"></a><span id="l8.340">     try {</span>
<a href="#l8.341"></a><span id="l8.341">       msgDate = this.uri.QueryInterface(Ci.nsIMsgMessageUrl).messageHeader</span>
<a href="#l8.342"></a><span id="l8.342">         .dateInSeconds;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-    } catch (x) {}</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+    } catch (x) {</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+      console.debug(x);</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+    }</span>
<a href="#l8.347"></a><span id="l8.347"> </span>
<a href="#l8.348"></a><span id="l8.348">     for (let i in gossip) {</span>
<a href="#l8.349"></a><span id="l8.349">       let addr = EnigmailMime.getParameter(gossip[i], &quot;addr&quot;);</span>
<a href="#l8.350"></a><span id="l8.350">       try {</span>
<a href="#l8.351"></a><span id="l8.351">         let r = await EnigmailAutocrypt.processAutocryptHeader(</span>
<a href="#l8.352"></a><span id="l8.352">           addr,</span>
<a href="#l8.353"></a><span id="l8.353">           [gossip[i].replace(/ /g, &quot;&quot;)],</span>
<a href="#l8.354"></a><span id="l8.354">           msgDate,</span>
<a href="#l8.355"></a><span id="l8.355">           true,</span>
<a href="#l8.356"></a><span id="l8.356">           true</span>
<a href="#l8.357"></a><span id="l8.357">         );</span>
<a href="#l8.358"></a><span id="l8.358">         EnigmailLog.DEBUG(`mimeDecrypt.jsm: extractAutocryptGossip: r=${r}\n`);</span>
<a href="#l8.359"></a><span id="l8.359">       } catch (x) {</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+        console.debug(x);</span>
<a href="#l8.361"></a><span id="l8.361">         EnigmailLog.DEBUG(</span>
<a href="#l8.362"></a><span id="l8.362">           `mimeDecrypt.jsm: extractAutocryptGossip: Error: ${x}\n`</span>
<a href="#l8.363"></a><span id="l8.363">         );</span>
<a href="#l8.364"></a><span id="l8.364">       }</span>
<a href="#l8.365"></a><span id="l8.365">     }</span>
<a href="#l8.366"></a><span id="l8.366">   },</span>
<a href="#l8.367"></a><span id="l8.367"> };</span>
<a href="#l8.368"></a><span id="l8.368"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeEncrypt.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -47,22 +47,20 @@ const PGPMIME_ENCRYPT_CID = Components.I</span>
<a href="#l9.4"></a><span id="l9.4">   &quot;{96fe88f9-d2cd-466f-93e0-3a351df4c6d2}&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> );</span>
<a href="#l9.6"></a><span id="l9.6"> const PGPMIME_ENCRYPT_CONTRACTID = &quot;@enigmail.net/compose/mimeencrypt;1&quot;;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> const maxBufferLen = 102400;</span>
<a href="#l9.9"></a><span id="l9.9"> const MIME_SIGNED = 1;</span>
<a href="#l9.10"></a><span id="l9.10"> const MIME_ENCRYPTED = 2;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var gDebugLogLevel = 0;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+var gDebugLogLevel = 1;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> function PgpMimeEncrypt(sMimeSecurityInfo) {</span>
<a href="#l9.16"></a><span id="l9.16">   this.wrappedJSObject = this;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  console.debug(`in PgpMimeEncrypt: wrappedJSObject:`);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  console.debug(this);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   this.signMessage = false;</span>
<a href="#l9.21"></a><span id="l9.21">   this.requireEncryptMessage = false;</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   // &quot;securityInfo&quot; variables</span>
<a href="#l9.24"></a><span id="l9.24">   this.sendFlags = 0;</span>
<a href="#l9.25"></a><span id="l9.25">   this.UIFlags = 0;</span>
<a href="#l9.26"></a><span id="l9.26">   this.senderEmailAddr = &quot;&quot;;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -158,16 +156,17 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l9.28"></a><span id="l9.28">       return (</span>
<a href="#l9.29"></a><span id="l9.29">         (this.sendFlags &amp;</span>
<a href="#l9.30"></a><span id="l9.30">           (EnigmailConstants.SEND_SIGNED |</span>
<a href="#l9.31"></a><span id="l9.31">             EnigmailConstants.SEND_ENCRYPTED |</span>
<a href="#l9.32"></a><span id="l9.32">             EnigmailConstants.SEND_VERBATIM)) !==</span>
<a href="#l9.33"></a><span id="l9.33">         0</span>
<a href="#l9.34"></a><span id="l9.34">       );</span>
<a href="#l9.35"></a><span id="l9.35">     } catch (ex) {</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+      console.debug(ex);</span>
<a href="#l9.37"></a><span id="l9.37">       EnigmailLog.writeException(&quot;mimeEncrypt.js&quot;, ex);</span>
<a href="#l9.38"></a><span id="l9.38">       throw ex;</span>
<a href="#l9.39"></a><span id="l9.39">     }</span>
<a href="#l9.40"></a><span id="l9.40">   },</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42">   beginCryptoEncapsulation(</span>
<a href="#l9.43"></a><span id="l9.43">     outStream,</span>
<a href="#l9.44"></a><span id="l9.44">     recipientList,</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -230,16 +229,17 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l9.46"></a><span id="l9.46">         }</span>
<a href="#l9.47"></a><span id="l9.47">       } else {</span>
<a href="#l9.48"></a><span id="l9.48">         throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.49"></a><span id="l9.49">       }</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">       this.cryptoBoundary = EnigmailMime.createBoundary();</span>
<a href="#l9.52"></a><span id="l9.52">       this.startCryptoHeaders();</span>
<a href="#l9.53"></a><span id="l9.53">     } catch (ex) {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      console.debug(ex);</span>
<a href="#l9.55"></a><span id="l9.55">       EnigmailLog.writeException(&quot;mimeEncrypt.js&quot;, ex);</span>
<a href="#l9.56"></a><span id="l9.56">       throw ex;</span>
<a href="#l9.57"></a><span id="l9.57">     }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">     return null;</span>
<a href="#l9.60"></a><span id="l9.60">   },</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62">   startCryptoHeaders() {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineat">@@ -529,30 +529,31 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l9.64"></a><span id="l9.64">       //proc.wait();</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">       LOCAL_DEBUG(</span>
<a href="#l9.67"></a><span id="l9.67">         &quot;mimeEncrypt.js: finishCryptoEncapsulation: exitCode = &quot; +</span>
<a href="#l9.68"></a><span id="l9.68">           this.exitCode +</span>
<a href="#l9.69"></a><span id="l9.69">           &quot;\n&quot;</span>
<a href="#l9.70"></a><span id="l9.70">       );</span>
<a href="#l9.71"></a><span id="l9.71">       if (this.exitCode !== 0) {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-        throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+        throw new Error(&quot;failure in finishCryptoEncapsulation&quot;);</span>
<a href="#l9.74"></a><span id="l9.74">       }</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">       if (this.cryptoMode == MIME_SIGNED) {</span>
<a href="#l9.77"></a><span id="l9.77">         this.signedHeaders2();</span>
<a href="#l9.78"></a><span id="l9.78">       }</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">       this.encryptedData = this.encryptedData</span>
<a href="#l9.81"></a><span id="l9.81">         .replace(/\r/g, &quot;&quot;)</span>
<a href="#l9.82"></a><span id="l9.82">         .replace(/\n/g, &quot;\r\n&quot;); // force CRLF</span>
<a href="#l9.83"></a><span id="l9.83">       this.writeOut(this.encryptedData);</span>
<a href="#l9.84"></a><span id="l9.84">       this.finishCryptoHeaders();</span>
<a href="#l9.85"></a><span id="l9.85">       this.flushOutput();</span>
<a href="#l9.86"></a><span id="l9.86">     } catch (ex) {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+      console.debug(ex);</span>
<a href="#l9.88"></a><span id="l9.88">       EnigmailLog.writeException(&quot;mimeEncrypt.js&quot;, ex);</span>
<a href="#l9.89"></a><span id="l9.89">       throw ex;</span>
<a href="#l9.90"></a><span id="l9.90">     }</span>
<a href="#l9.91"></a><span id="l9.91">   },</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   mimeCryptoWriteBlock(buffer, length) {</span>
<a href="#l9.94"></a><span id="l9.94">     if (gDebugLogLevel &gt; 4) {</span>
<a href="#l9.95"></a><span id="l9.95">       LOCAL_DEBUG(&quot;mimeEncrypt.js: mimeCryptoWriteBlock: &quot; + length + &quot;\n&quot;);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineat">@@ -634,16 +635,17 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l9.97"></a><span id="l9.97">           );</span>
<a href="#l9.98"></a><span id="l9.98">         }</span>
<a href="#l9.99"></a><span id="l9.99">       } else if (this.inputMode == 2) {</span>
<a href="#l9.100"></a><span id="l9.100">         if (line.replace(/[\r\n]/g, &quot;&quot;).length === 0) {</span>
<a href="#l9.101"></a><span id="l9.101">           this.inputMode = 0;</span>
<a href="#l9.102"></a><span id="l9.102">         }</span>
<a href="#l9.103"></a><span id="l9.103">       }</span>
<a href="#l9.104"></a><span id="l9.104">     } catch (ex) {</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+      console.debug(ex);</span>
<a href="#l9.106"></a><span id="l9.106">       EnigmailLog.writeException(&quot;mimeEncrypt.js&quot;, ex);</span>
<a href="#l9.107"></a><span id="l9.107">       throw ex;</span>
<a href="#l9.108"></a><span id="l9.108">     }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">     return null;</span>
<a href="#l9.111"></a><span id="l9.111">   },</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113">   writeOut(str) {</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineat">@@ -777,17 +779,19 @@ PgpMimeEncrypt.prototype = {</span>
<a href="#l9.115"></a><span id="l9.115">       exitCode,</span>
<a href="#l9.116"></a><span id="l9.116">       this.UIFlags,</span>
<a href="#l9.117"></a><span id="l9.117">       this.sendFlags,</span>
<a href="#l9.118"></a><span id="l9.118">       this.dataLength,</span>
<a href="#l9.119"></a><span id="l9.119">       retStatusObj</span>
<a href="#l9.120"></a><span id="l9.120">     );</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122">     if (this.exitCode !== 0) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-      EnigmailDialog.alert(this.win, retStatusObj.errorMsg);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+      if (retStatusObj.errorMsg.length) {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+        EnigmailDialog.alert(this.win, retStatusObj.errorMsg);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+      }</span>
<a href="#l9.127"></a><span id="l9.127">     }</span>
<a href="#l9.128"></a><span id="l9.128">   },</span>
<a href="#l9.129"></a><span id="l9.129"> };</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131"> ////////////////////////////////////////////////////////////////////</span>
<a href="#l9.132"></a><span id="l9.132"> // General-purpose functions, not exported</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134"> function LOCAL_DEBUG(str) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/mimeVerify.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/mimeVerify.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -659,16 +659,17 @@ MimeVerify.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4">         );</span>
<a href="#l10.5"></a><span id="l10.5">       }</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">       if (headerSink) {</span>
<a href="#l10.8"></a><span id="l10.8">         headerSink.updateSecurityStatus(</span>
<a href="#l10.9"></a><span id="l10.9">           this.lastMsgUri,</span>
<a href="#l10.10"></a><span id="l10.10">           this.exitCode,</span>
<a href="#l10.11"></a><span id="l10.11">           this.returnStatus.statusFlags,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+          this.returnStatus.extStatusFlags,</span>
<a href="#l10.13"></a><span id="l10.13">           this.returnStatus.keyId,</span>
<a href="#l10.14"></a><span id="l10.14">           this.returnStatus.userId,</span>
<a href="#l10.15"></a><span id="l10.15">           this.returnStatus.sigDetails,</span>
<a href="#l10.16"></a><span id="l10.16">           this.returnStatus.errorMsg,</span>
<a href="#l10.17"></a><span id="l10.17">           this.returnStatus.blockSeparation,</span>
<a href="#l10.18"></a><span id="l10.18">           this.uri,</span>
<a href="#l10.19"></a><span id="l10.19">           JSON.stringify({</span>
<a href="#l10.20"></a><span id="l10.20">             encryptedTo: this.returnStatus.encToDetails,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -10,21 +10,28 @@ const { EnigmailConstants } = ChromeUtil</span>
<a href="#l11.4"></a><span id="l11.4">   &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> );</span>
<a href="#l11.6"></a><span id="l11.6"> const { EnigmailTime } = ChromeUtils.import(</span>
<a href="#l11.7"></a><span id="l11.7">   &quot;chrome://openpgp/content/modules/time.jsm&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> );</span>
<a href="#l11.9"></a><span id="l11.9"> var { OpenPGPMasterpass } = ChromeUtils.import(</span>
<a href="#l11.10"></a><span id="l11.10">   &quot;chrome://openpgp/content/modules/masterpass.jsm&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> );</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+const { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+var { uidHelper } = ChromeUtils.import(</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  &quot;chrome://openpgp/content/modules/uidHelper.jsm&quot;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> const str_encrypt = &quot;encrypt&quot;;</span>
<a href="#l11.20"></a><span id="l11.20"> const str_sign = &quot;sign&quot;;</span>
<a href="#l11.21"></a><span id="l11.21"> const str_certify = &quot;certify&quot;;</span>
<a href="#l11.22"></a><span id="l11.22"> const str_authenticate = &quot;authenticate&quot;;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+const RNP_PHOTO_USERID_ID = &quot;(photo)&quot;; // string is harcoded inside RNP</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> // rnp module</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> var RNPLib;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> var RNP = {</span>
<a href="#l11.30"></a><span id="l11.30">   hasRan: false,</span>
<a href="#l11.31"></a><span id="l11.31">   libLoaded: false,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineat">@@ -147,33 +154,42 @@ var RNP = {</span>
<a href="#l11.33"></a><span id="l11.33">       throw new Error(&quot;rnp_key_allows_usage failed&quot;);</span>
<a href="#l11.34"></a><span id="l11.34">     }</span>
<a href="#l11.35"></a><span id="l11.35">     if (allowed.value) {</span>
<a href="#l11.36"></a><span id="l11.36">       keyObj.keyUseFor += &quot;a&quot;;</span>
<a href="#l11.37"></a><span id="l11.37">       meta.a = true;</span>
<a href="#l11.38"></a><span id="l11.38">     }</span>
<a href="#l11.39"></a><span id="l11.39">   },</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  getKeys(onlyKeys = null) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  async getKeys(onlyKeys = null) {</span>
<a href="#l11.43"></a><span id="l11.43">     return this.getKeysFromFFI(RNPLib.ffi, false, onlyKeys);</span>
<a href="#l11.44"></a><span id="l11.44">   },</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   /* Some consumers want a different listing of keys, and expect</span>
<a href="#l11.47"></a><span id="l11.47">    * slightly different attribute names...</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-   * If forListing is true, we'll set those additional attributes. */</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  getKeysFromFFI(ffi, forListing, onlyKeys = null) {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+   * If forListing is true, we'll set those additional attributes</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+   * If onlyKeys is given: only returns keys in that array</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+   */</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  async getKeysFromFFI(ffi, forListing, onlyKeys = null) {</span>
<a href="#l11.54"></a><span id="l11.54">     let keys = [];</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">     if (onlyKeys) {</span>
<a href="#l11.57"></a><span id="l11.57">       for (let ki = 0; ki &lt; onlyKeys.length; ki++) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-        let handle = this.getKeyHandleByIdentifier(onlyKeys[ki]);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+        let handle = await this.getKeyHandleByIdentifier(onlyKeys[ki]);</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">         let keyObj = {};</span>
<a href="#l11.62"></a><span id="l11.62">         try {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-          let ok = this.getKeyInfoFromHandle(handle, keyObj, forListing);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+          // Parameter false: skip if this is a primary key, it will be processed together with primary key later.</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+          let ok = this.getKeyInfoFromHandle(</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+            ffi,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+            handle,</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+            keyObj,</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+            false,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+            forListing</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+          );</span>
<a href="#l11.72"></a><span id="l11.72">           if (!ok) {</span>
<a href="#l11.73"></a><span id="l11.73">             continue;</span>
<a href="#l11.74"></a><span id="l11.74">           }</span>
<a href="#l11.75"></a><span id="l11.75">         } catch (ex) {</span>
<a href="#l11.76"></a><span id="l11.76">           console.log(ex);</span>
<a href="#l11.77"></a><span id="l11.77">         } finally {</span>
<a href="#l11.78"></a><span id="l11.78">           RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l11.79"></a><span id="l11.79">         }</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineat">@@ -203,17 +219,24 @@ var RNP = {</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82">         if (RNPLib.rnp_locate_key(ffi, &quot;grip&quot;, grip, handle.address())) {</span>
<a href="#l11.83"></a><span id="l11.83">           throw new Error(&quot;rnp_locate_key failed&quot;);</span>
<a href="#l11.84"></a><span id="l11.84">         }</span>
<a href="#l11.85"></a><span id="l11.85">         have_handle = true;</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87">         let keyObj = {};</span>
<a href="#l11.88"></a><span id="l11.88">         try {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-          let ok = this.getKeyInfoFromHandle(handle, keyObj, forListing);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+          // Parameter false: skip if this is a primary key, it will be processed together with primary key later.</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+          let ok = this.getKeyInfoFromHandle(</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+            ffi,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+            handle,</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+            keyObj,</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+            false,</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+            forListing</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+          );</span>
<a href="#l11.98"></a><span id="l11.98">           if (!ok) {</span>
<a href="#l11.99"></a><span id="l11.99">             continue;</span>
<a href="#l11.100"></a><span id="l11.100">           }</span>
<a href="#l11.101"></a><span id="l11.101">         } catch (ex) {</span>
<a href="#l11.102"></a><span id="l11.102">           console.log(ex);</span>
<a href="#l11.103"></a><span id="l11.103">         } finally {</span>
<a href="#l11.104"></a><span id="l11.104">           if (have_handle) {</span>
<a href="#l11.105"></a><span id="l11.105">             RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineat">@@ -228,17 +251,17 @@ var RNP = {</span>
<a href="#l11.107"></a><span id="l11.107">       RNPLib.rnp_identifier_iterator_destroy(iter);</span>
<a href="#l11.108"></a><span id="l11.108">     }</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110">     console.debug(keys);</span>
<a href="#l11.111"></a><span id="l11.111">     return keys;</span>
<a href="#l11.112"></a><span id="l11.112">   },</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">   // return false if handle refers to subkey and should be ignored</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-  getKeyInfoFromHandle(handle, keyObj, forListing) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  getKeyInfoFromHandle(ffi, handle, keyObj, usePrimaryIfSubkey, forListing) {</span>
<a href="#l11.117"></a><span id="l11.117">     keyObj.ownerTrust = null;</span>
<a href="#l11.118"></a><span id="l11.118">     keyObj.userId = null;</span>
<a href="#l11.119"></a><span id="l11.119">     keyObj.userIds = [];</span>
<a href="#l11.120"></a><span id="l11.120">     keyObj.subKeys = [];</span>
<a href="#l11.121"></a><span id="l11.121">     keyObj.photoAvailable = false;</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">     let is_subkey = new ctypes.bool();</span>
<a href="#l11.124"></a><span id="l11.124">     let sub_count = new ctypes.size_t();</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineat">@@ -247,20 +270,42 @@ var RNP = {</span>
<a href="#l11.126"></a><span id="l11.126">     if (RNPLib.rnp_key_is_sub(handle, is_subkey.address())) {</span>
<a href="#l11.127"></a><span id="l11.127">       throw new Error(&quot;rnp_key_is_sub failed&quot;);</span>
<a href="#l11.128"></a><span id="l11.128">     }</span>
<a href="#l11.129"></a><span id="l11.129">     if (is_subkey.value) {</span>
<a href="#l11.130"></a><span id="l11.130">       let primary_grip = new ctypes.char.ptr();</span>
<a href="#l11.131"></a><span id="l11.131">       if (RNPLib.rnp_key_get_primary_grip(handle, primary_grip.address())) {</span>
<a href="#l11.132"></a><span id="l11.132">         throw new Error(&quot;rnp_key_get_primary_grip failed&quot;);</span>
<a href="#l11.133"></a><span id="l11.133">       }</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-      /* Skip if we have primary key. Subkey will be processed together with primary */</span>
<a href="#l11.135"></a><span id="l11.135">       if (!primary_grip.isNull()) {</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+        let rv = false;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+        if (usePrimaryIfSubkey) {</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+          let newHandle = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+          if (</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+            RNPLib.rnp_locate_key(</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+              ffi,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+              &quot;grip&quot;,</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+              primary_grip,</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+              newHandle.address()</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+            )</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+          ) {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+            throw new Error(&quot;rnp_locate_key failed&quot;);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+          }</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+          // recursively call ourselves to get primary key info</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+          rv = this.getKeyInfoFromHandle(</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+            ffi,</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+            newHandle,</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+            keyObj,</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+            false,</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+            forListing</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+          );</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+          RNPLib.rnp_key_handle_destroy(newHandle);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+        }</span>
<a href="#l11.159"></a><span id="l11.159">         RNPLib.rnp_buffer_destroy(primary_grip);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-        return false;</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+        return rv;</span>
<a href="#l11.162"></a><span id="l11.162">       }</span>
<a href="#l11.163"></a><span id="l11.163">     }</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165">     let meta = {</span>
<a href="#l11.166"></a><span id="l11.166">       a: false,</span>
<a href="#l11.167"></a><span id="l11.167">       s: false,</span>
<a href="#l11.168"></a><span id="l11.168">       c: false,</span>
<a href="#l11.169"></a><span id="l11.169">       e: false,</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineat">@@ -302,39 +347,49 @@ var RNP = {</span>
<a href="#l11.171"></a><span id="l11.171">           throw new Error(&quot;rnp_uid_is_revoked failed&quot;);</span>
<a href="#l11.172"></a><span id="l11.172">         }</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174">         if (!is_revoked.value) {</span>
<a href="#l11.175"></a><span id="l11.175">           let uid_str = new ctypes.char.ptr();</span>
<a href="#l11.176"></a><span id="l11.176">           if (RNPLib.rnp_key_get_uid_at(handle, i, uid_str.address())) {</span>
<a href="#l11.177"></a><span id="l11.177">             throw new Error(&quot;rnp_key_get_uid_at failed&quot;);</span>
<a href="#l11.178"></a><span id="l11.178">           }</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+          let userIdStr = uid_str.readString();</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+          if (userIdStr !== RNP_PHOTO_USERID_ID) {</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+            if (!primary_uid_set) {</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+              keyObj.userId = userIdStr;</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+              if (forListing) {</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+                keyObj.name = keyObj.userId;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+              }</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+              primary_uid_set = true;</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+            }</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-          if (!primary_uid_set) {</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-            keyObj.userId = uid_str.readString();</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-            if (forListing) {</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-              keyObj.name = keyObj.userId;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-            }</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-            primary_uid_set = true;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+            let uidObj = {};</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+            uidObj.userId = uid_str.readString();</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+            uidObj.type = &quot;uid&quot;;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+            uidObj.keyTrust = keyObj.keyTrust;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+            uidObj.uidFpr = &quot;??fpr??&quot;;</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+            keyObj.userIds.push(uidObj);</span>
<a href="#l11.202"></a><span id="l11.202">           }</span>
<a href="#l11.203"></a><span id="l11.203"> </span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-          let uidObj = {};</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-          uidObj.userId = uid_str.readString();</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-          uidObj.type = &quot;uid&quot;;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-          uidObj.keyTrust = keyObj.keyTrust;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-          uidObj.uidFpr = &quot;??fpr??&quot;;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-          keyObj.userIds.push(uidObj);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-</span>
<a href="#l11.212"></a><span id="l11.212">           RNPLib.rnp_buffer_destroy(uid_str);</span>
<a href="#l11.213"></a><span id="l11.213">         }</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215">         RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l11.216"></a><span id="l11.216">       }</span>
<a href="#l11.217"></a><span id="l11.217"> </span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+      if (!keyObj.userId) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+        let prim_uid_str = new ctypes.char.ptr();</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+        if (RNPLib.rnp_key_get_primary_uid(handle, prim_uid_str.address())) {</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+          throw new Error(&quot;rnp_key_get_primary_uid failed&quot;);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+        }</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+        keyObj.userId = prim_uid_str.readString();</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+      }</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+</span>
<a href="#l11.226"></a><span id="l11.226">       if (RNPLib.rnp_key_get_subkey_count(handle, sub_count.address())) {</span>
<a href="#l11.227"></a><span id="l11.227">         throw new Error(&quot;rnp_key_get_subkey_count failed&quot;);</span>
<a href="#l11.228"></a><span id="l11.228">       }</span>
<a href="#l11.229"></a><span id="l11.229">       for (let i = 0; i &lt; sub_count.value; i++) {</span>
<a href="#l11.230"></a><span id="l11.230">         let sub_handle = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.231"></a><span id="l11.231">         if (RNPLib.rnp_key_get_subkey_at(handle, i, sub_handle.address())) {</span>
<a href="#l11.232"></a><span id="l11.232">           throw new Error(&quot;rnp_key_get_subkey_at failed&quot;);</span>
<a href="#l11.233"></a><span id="l11.233">         }</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineat">@@ -359,17 +414,162 @@ var RNP = {</span>
<a href="#l11.235"></a><span id="l11.235">       if (meta.e) {</span>
<a href="#l11.236"></a><span id="l11.236">         keyObj.keyUseFor += &quot;E&quot;;</span>
<a href="#l11.237"></a><span id="l11.237">       }</span>
<a href="#l11.238"></a><span id="l11.238">     }</span>
<a href="#l11.239"></a><span id="l11.239"> </span>
<a href="#l11.240"></a><span id="l11.240">     return true;</span>
<a href="#l11.241"></a><span id="l11.241">   },</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-  decrypt(encrypted, options) {</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  getKeySignatures(keyId, ignoreUnknownUid) {</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+    let handle = this.getKeyHandleByKeyIdOrFingerprint(</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+      RNPLib.ffi,</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+      &quot;0x&quot; + keyId</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+    );</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+    let mainKeyObj = {};</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+    this.getKeyInfoFromHandle(RNPLib.ffi, handle, mainKeyObj, false, true);</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+    let rList = {};</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+    try {</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+      let uid_count = new ctypes.size_t();</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+      if (RNPLib.rnp_key_get_uid_count(handle, uid_count.address())) {</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+        throw new Error(&quot;rnp_key_get_uid_count failed&quot;);</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+      }</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+      let outputIndex = 0;</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+      for (let i = 0; i &lt; uid_count.value; i++) {</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+        let uid_handle = new RNPLib.rnp_uid_handle_t();</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+        let is_revoked = new ctypes.bool();</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+        if (RNPLib.rnp_key_get_uid_handle_at(handle, i, uid_handle.address())) {</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+          throw new Error(&quot;rnp_key_get_uid_handle_at failed&quot;);</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+        }</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+        if (RNPLib.rnp_uid_is_revoked(uid_handle, is_revoked.address())) {</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+          throw new Error(&quot;rnp_uid_is_revoked failed&quot;);</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+        }</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+        if (!is_revoked.value) {</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+          let uid_str = new ctypes.char.ptr();</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+          if (RNPLib.rnp_key_get_uid_at(handle, i, uid_str.address())) {</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+            throw new Error(&quot;rnp_key_get_uid_at failed&quot;);</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+          }</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+          let userIdStr = uid_str.readString();</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+          if (userIdStr !== RNP_PHOTO_USERID_ID) {</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+            let id = outputIndex;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+            ++outputIndex;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+            rList[id] = {};</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+            rList[id].created = mainKeyObj.created;</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+            rList[id].fpr = mainKeyObj.fpr;</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+            rList[id].keyId = mainKeyObj.keyId;</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+            rList[id].userId = userIdStr;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+            rList[id].sigList = [];</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+            let sig_count = new ctypes.size_t();</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+            if (</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+              RNPLib.rnp_uid_get_signature_count(</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+                uid_handle,</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+                sig_count.address()</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+              )</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+            ) {</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+              throw new Error(&quot;rnp_uid_get_signature_count failed&quot;);</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+            }</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+            for (let j = 0; j &lt; sig_count.value; j++) {</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+              let sigObj = {};</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+              let sig_handle = new RNPLib.rnp_signature_handle_t();</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+              if (</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+                RNPLib.rnp_uid_get_signature_at(</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+                  uid_handle,</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+                  j,</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+                  sig_handle.address()</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+                )</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+              ) {</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+                throw new Error(&quot;rnp_uid_get_signature_at failed&quot;);</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+              }</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+              let creation = new ctypes.uint32_t();</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+              if (</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+                RNPLib.rnp_signature_get_creation(</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+                  sig_handle,</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+                  creation.address()</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+                )</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+              ) {</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+                throw new Error(&quot;rnp_signature_get_creation failed&quot;);</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+              }</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+              sigObj.created = EnigmailTime.getDateTime(</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+                creation.value,</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+                true,</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+                false</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+              );</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+              sigObj.sigType = &quot;?&quot;;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+              let sig_id_str = new ctypes.char.ptr();</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+              if (</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+                RNPLib.rnp_signature_get_keyid(sig_handle, sig_id_str.address())</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+              ) {</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+                throw new Error(&quot;rnp_signature_get_keyid failed&quot;);</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+              }</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+              let sigIdStr = sig_id_str.readString();</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+              sigObj.signerKeyId = sigIdStr;</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+              let signerHandle = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+              if (</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+                RNPLib.rnp_signature_get_signer(</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+                  sig_handle,</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+                  signerHandle.address()</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+                )</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+              ) {</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+                throw new Error(&quot;rnp_signature_get_signer failed&quot;);</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+              }</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+              if (signerHandle.isNull()) {</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+                if (!ignoreUnknownUid) {</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+                  sigObj.userId = &quot;?&quot;;</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+                  sigObj.sigKnown = false;</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+                  rList[id].sigList.push(sigObj);</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+                }</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+              } else {</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+                let signer_uid_str = new ctypes.char.ptr();</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+                if (</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+                  RNPLib.rnp_key_get_primary_uid(</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+                    signerHandle,</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+                    signer_uid_str.address()</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+                  )</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+                ) {</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+                  throw new Error(&quot;rnp_key_get_uid_at failed&quot;);</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+                }</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+                sigObj.userId = signer_uid_str.readString();</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+                sigObj.sigKnown = true;</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+                rList[id].sigList.push(sigObj);</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+                RNPLib.rnp_key_handle_destroy(signerHandle);</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+              }</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+              RNPLib.rnp_signature_handle_destroy(sig_handle);</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+            }</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+          }</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+          RNPLib.rnp_buffer_destroy(uid_str);</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+        }</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+        RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+      }</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+    } catch (ex) {</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+      console.log(ex);</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+    } finally {</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+      RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+    }</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+    return rList;</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+  },</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+  async decrypt(encrypted, options) {</span>
<a href="#l11.390"></a><span id="l11.390">     let input_from_memory = new RNPLib.rnp_input_t();</span>
<a href="#l11.391"></a><span id="l11.391"> </span>
<a href="#l11.392"></a><span id="l11.392">     var tmp_array = ctypes.char.array()(encrypted);</span>
<a href="#l11.393"></a><span id="l11.393">     var encrypted_array = ctypes.cast(</span>
<a href="#l11.394"></a><span id="l11.394">       tmp_array,</span>
<a href="#l11.395"></a><span id="l11.395">       ctypes.uint8_t.array(encrypted.length)</span>
<a href="#l11.396"></a><span id="l11.396">     );</span>
<a href="#l11.397"></a><span id="l11.397"> </span>
<a href="#l11.398"></a><span id="l11.398" class="difflineat">@@ -383,16 +583,17 @@ var RNP = {</span>
<a href="#l11.399"></a><span id="l11.399">     let max_out = encrypted.length * 10;</span>
<a href="#l11.400"></a><span id="l11.400"> </span>
<a href="#l11.401"></a><span id="l11.401">     let output_to_memory = new RNPLib.rnp_output_t();</span>
<a href="#l11.402"></a><span id="l11.402">     RNPLib.rnp_output_to_memory(output_to_memory.address(), max_out);</span>
<a href="#l11.403"></a><span id="l11.403"> </span>
<a href="#l11.404"></a><span id="l11.404">     let result = {};</span>
<a href="#l11.405"></a><span id="l11.405">     result.decryptedData = &quot;&quot;;</span>
<a href="#l11.406"></a><span id="l11.406">     result.statusFlags = 0;</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+    result.extStatusFlags = 0;</span>
<a href="#l11.408"></a><span id="l11.408"> </span>
<a href="#l11.409"></a><span id="l11.409">     result.userId = &quot;&quot;;</span>
<a href="#l11.410"></a><span id="l11.410">     result.keyId = &quot;&quot;;</span>
<a href="#l11.411"></a><span id="l11.411"> </span>
<a href="#l11.412"></a><span id="l11.412">     let verify_op = new RNPLib.rnp_op_verify_t();</span>
<a href="#l11.413"></a><span id="l11.413">     result.exitCode = RNPLib.rnp_op_verify_create(</span>
<a href="#l11.414"></a><span id="l11.414">       verify_op.address(),</span>
<a href="#l11.415"></a><span id="l11.415">       RNPLib.ffi,</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineat">@@ -414,31 +615,40 @@ var RNP = {</span>
<a href="#l11.417"></a><span id="l11.417"> </span>
<a href="#l11.418"></a><span id="l11.418">       if (!result.exitCode) {</span>
<a href="#l11.419"></a><span id="l11.419">         let char_array = ctypes.cast(</span>
<a href="#l11.420"></a><span id="l11.420">           result_buf,</span>
<a href="#l11.421"></a><span id="l11.421">           ctypes.char.array(result_len.value).ptr</span>
<a href="#l11.422"></a><span id="l11.422">         ).contents;</span>
<a href="#l11.423"></a><span id="l11.423"> </span>
<a href="#l11.424"></a><span id="l11.424">         result.decryptedData = char_array.readString();</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-        console.debug(result.decryptedData);</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+        //console.debug(result.decryptedData);</span>
<a href="#l11.427"></a><span id="l11.427"> </span>
<a href="#l11.428"></a><span id="l11.428">         // ignore &quot;no signature&quot; result, that's ok</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-        this.getVerifyDetails(verify_op, result);</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+        await this.getVerifyDetails(</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+          RNPLib.ffi,</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+          options.fromAddr,</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+          verify_op,</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+          result</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+        );</span>
<a href="#l11.436"></a><span id="l11.436">       }</span>
<a href="#l11.437"></a><span id="l11.437">     }</span>
<a href="#l11.438"></a><span id="l11.438"> </span>
<a href="#l11.439"></a><span id="l11.439">     RNPLib.rnp_input_destroy(input_from_memory);</span>
<a href="#l11.440"></a><span id="l11.440">     RNPLib.rnp_output_destroy(output_to_memory);</span>
<a href="#l11.441"></a><span id="l11.441">     RNPLib.rnp_op_verify_destroy(verify_op);</span>
<a href="#l11.442"></a><span id="l11.442"> </span>
<a href="#l11.443"></a><span id="l11.443">     return result;</span>
<a href="#l11.444"></a><span id="l11.444">   },</span>
<a href="#l11.445"></a><span id="l11.445"> </span>
<a href="#l11.446"></a><span id="l11.446" class="difflineminus">-  getVerifyDetails(verify_op, result) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+  async getVerifyDetails(ffi, fromAddr, verify_op, result) {</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+    if (!fromAddr) {</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+      throw new Error(&quot;RNPgetVerifyDetails no fromAddr&quot;);</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+    }</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+</span>
<a href="#l11.452"></a><span id="l11.452">     let sig_count = new ctypes.size_t();</span>
<a href="#l11.453"></a><span id="l11.453">     if (</span>
<a href="#l11.454"></a><span id="l11.454">       RNPLib.rnp_op_verify_get_signature_count(verify_op, sig_count.address())</span>
<a href="#l11.455"></a><span id="l11.455">     ) {</span>
<a href="#l11.456"></a><span id="l11.456">       throw new Error(&quot;rnp_op_verify_get_signature_count failed&quot;);</span>
<a href="#l11.457"></a><span id="l11.457">     }</span>
<a href="#l11.458"></a><span id="l11.458"> </span>
<a href="#l11.459"></a><span id="l11.459">     // TODO: How should handle (sig_count.value &gt; 1) ?</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineat">@@ -459,21 +669,20 @@ var RNP = {</span>
<a href="#l11.461"></a><span id="l11.461">       result.exitCode = -1;</span>
<a href="#l11.462"></a><span id="l11.462">     }</span>
<a href="#l11.463"></a><span id="l11.463"> </span>
<a href="#l11.464"></a><span id="l11.464">     let query_times = true;</span>
<a href="#l11.465"></a><span id="l11.465">     let query_signer = true;</span>
<a href="#l11.466"></a><span id="l11.466"> </span>
<a href="#l11.467"></a><span id="l11.467">     switch (sig_status) {</span>
<a href="#l11.468"></a><span id="l11.468">       case RNPLib.RNP_SUCCESS:</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineminus">-        // TODO: set EnigmailConstants.TRUSTED_IDENTITY based on key trust status</span>
<a href="#l11.470"></a><span id="l11.470">         result.statusFlags |= EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l11.471"></a><span id="l11.471">         break;</span>
<a href="#l11.472"></a><span id="l11.472">       case RNPLib.RNP_ERROR_KEY_NOT_FOUND:</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-        result.statusFlags |= EnigmailConstants.UNVERIFIED_SIGNATURE;</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+        result.statusFlags |= EnigmailConstants.UNCERTAIN_SIGNATURE;</span>
<a href="#l11.475"></a><span id="l11.475">         query_signer = false;</span>
<a href="#l11.476"></a><span id="l11.476">         break;</span>
<a href="#l11.477"></a><span id="l11.477">       case RNPLib.RNP_ERROR_SIGNATURE_EXPIRED:</span>
<a href="#l11.478"></a><span id="l11.478">         result.statusFlags |= EnigmailConstants.EXPIRED_SIGNATURE;</span>
<a href="#l11.479"></a><span id="l11.479">         break;</span>
<a href="#l11.480"></a><span id="l11.480">       case RNPLib.RNP_ERROR_SIGNATURE_INVALID:</span>
<a href="#l11.481"></a><span id="l11.481">         result.statusFlags |= EnigmailConstants.BAD_SIGNATURE;</span>
<a href="#l11.482"></a><span id="l11.482">         break;</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineat">@@ -501,32 +710,106 @@ var RNP = {</span>
<a href="#l11.484"></a><span id="l11.484"> </span>
<a href="#l11.485"></a><span id="l11.485">     if (query_signer) {</span>
<a href="#l11.486"></a><span id="l11.486">       let key = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.487"></a><span id="l11.487">       if (RNPLib.rnp_op_verify_signature_get_key(sig, key.address())) {</span>
<a href="#l11.488"></a><span id="l11.488">         throw new Error(&quot;rnp_op_verify_signature_get_key&quot;);</span>
<a href="#l11.489"></a><span id="l11.489">       }</span>
<a href="#l11.490"></a><span id="l11.490"> </span>
<a href="#l11.491"></a><span id="l11.491">       let keyInfo = {};</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineminus">-      let ok = this.getKeyInfoFromHandle(key, keyInfo, false);</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+      let ok = this.getKeyInfoFromHandle(ffi, key, keyInfo, true, false);</span>
<a href="#l11.494"></a><span id="l11.494">       if (!ok) {</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-        console.debug(</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-          &quot;TODO: use primary key for signature made with a sub key!&quot;</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-        );</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+        throw new Error(&quot;getKeyInfoFromHandle failed&quot;);</span>
<a href="#l11.499"></a><span id="l11.499">       }</span>
<a href="#l11.500"></a><span id="l11.500"> </span>
<a href="#l11.501"></a><span id="l11.501">       result.keyId = keyInfo.keyId;</span>
<a href="#l11.502"></a><span id="l11.502"> </span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+      let fromMatchesAnyUid = false;</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+      let fromLower = fromAddr ? fromAddr.toLowerCase() : &quot;&quot;;</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+      for (let uid of keyInfo.userIds) {</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+        if (uid.type !== &quot;uid&quot;) {</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+          continue;</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+        }</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+        let split = {};</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+        if (uidHelper.getPartsFromUidStr(uid.userId, split)) {</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+          let uidEmail = split.email.toLowerCase();</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+          if (uidEmail === fromLower) {</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+            fromMatchesAnyUid = true;</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+            break;</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+          }</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+        }</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+      }</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+      let useUndecided = true;</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+      if (keyInfo.secretAvailable) {</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+        if (fromMatchesAnyUid) {</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+          result.extStatusFlags |= EnigmailConstants.EXT_SELF_IDENTITY;</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineplus">+          useUndecided = false;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+        }</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+      } else if (result.statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) {</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+        let acceptanceResult = {};</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+        try {</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+          await PgpSqliteDb2.getAcceptance(</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+            keyInfo.fpr,</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+            fromLower,</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+            acceptanceResult</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+          );</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineplus">+        } catch (ex) {</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+          console.debug(&quot;getAcceptance failed: &quot; + ex);</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+        }</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+        // unverified key acceptance means, we consider the signature OK,</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+        //   but it's not a trusted identity.</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+        // unverified signature means, we cannot decide if the signature</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+        //   is ok.</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineplus">+        if (</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+          &quot;emailDecided&quot; in acceptanceResult &amp;&amp;</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+          acceptanceResult.emailDecided &amp;&amp;</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineplus">+          &quot;fingerprintAcceptance&quot; in acceptanceResult &amp;&amp;</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+          acceptanceResult.fingerprintAcceptance != &quot;undecided&quot;</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+        ) {</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+          if (acceptanceResult.fingerprintAcceptance == &quot;rejected&quot;) {</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+            result.statusFlags &amp;= ~EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+            result.statusFlags |= EnigmailConstants.BAD_SIGNATURE;</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+            useUndecided = false;</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+          } else if (!fromMatchesAnyUid) {</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+            /* At the time the user had accepted the key,</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+             * a different set of email addresses might have been</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+             * contained inside the key. In the meantime, we might</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+             * have refreshed the key, a email addresses</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+             * might have been removed or revoked.</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+             * If the current from was removed/revoked, we'd still</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+             * get an acceptance match, but the from is no longer found</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineplus">+             * in the key's UID list. That should get &quot;undecided&quot;.</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+             */</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+            useUndecided = true;</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+          } else if (acceptanceResult.fingerprintAcceptance == &quot;verified&quot;) {</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+            result.statusFlags |= EnigmailConstants.TRUSTED_IDENTITY;</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+            useUndecided = false;</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+          } else if (acceptanceResult.fingerprintAcceptance == &quot;unverified&quot;) {</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+            useUndecided = false;</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+          }</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+        }</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+      }</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineplus">+      if (useUndecided) {</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+        result.statusFlags &amp;= ~EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+        result.statusFlags |= EnigmailConstants.UNCERTAIN_SIGNATURE;</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+      }</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+</span>
<a href="#l11.579"></a><span id="l11.579">       RNPLib.rnp_key_handle_destroy(key);</span>
<a href="#l11.580"></a><span id="l11.580">     }</span>
<a href="#l11.581"></a><span id="l11.581"> </span>
<a href="#l11.582"></a><span id="l11.582">     return true;</span>
<a href="#l11.583"></a><span id="l11.583">   },</span>
<a href="#l11.584"></a><span id="l11.584"> </span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-  verifyDetached(data, options) {</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+  async verifyDetached(data, options) {</span>
<a href="#l11.587"></a><span id="l11.587">     let input_from_memory = new RNPLib.rnp_input_t();</span>
<a href="#l11.588"></a><span id="l11.588"> </span>
<a href="#l11.589"></a><span id="l11.589">     var tmp_array = ctypes.char.array()(data);</span>
<a href="#l11.590"></a><span id="l11.590">     var data_array = ctypes.cast(tmp_array, ctypes.uint8_t.array(data.length));</span>
<a href="#l11.591"></a><span id="l11.591"> </span>
<a href="#l11.592"></a><span id="l11.592">     RNPLib.rnp_input_from_memory(</span>
<a href="#l11.593"></a><span id="l11.593">       input_from_memory.address(),</span>
<a href="#l11.594"></a><span id="l11.594">       data_array,</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineat">@@ -538,16 +821,17 @@ var RNP = {</span>
<a href="#l11.596"></a><span id="l11.596">     RNPLib.rnp_input_from_path(</span>
<a href="#l11.597"></a><span id="l11.597">       input_from_file.address(),</span>
<a href="#l11.598"></a><span id="l11.598">       options.mimeSignatureFile</span>
<a href="#l11.599"></a><span id="l11.599">     );</span>
<a href="#l11.600"></a><span id="l11.600"> </span>
<a href="#l11.601"></a><span id="l11.601">     let result = {};</span>
<a href="#l11.602"></a><span id="l11.602">     result.decryptedData = &quot;&quot;;</span>
<a href="#l11.603"></a><span id="l11.603">     result.statusFlags = 0;</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+    result.extStatusFlags = 0;</span>
<a href="#l11.605"></a><span id="l11.605"> </span>
<a href="#l11.606"></a><span id="l11.606">     result.userId = &quot;&quot;;</span>
<a href="#l11.607"></a><span id="l11.607">     result.keyId = &quot;&quot;;</span>
<a href="#l11.608"></a><span id="l11.608"> </span>
<a href="#l11.609"></a><span id="l11.609">     let verify_op = new RNPLib.rnp_op_verify_t();</span>
<a href="#l11.610"></a><span id="l11.610">     if (</span>
<a href="#l11.611"></a><span id="l11.611">       RNPLib.rnp_op_verify_detached_create(</span>
<a href="#l11.612"></a><span id="l11.612">         verify_op.address(),</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineat">@@ -556,17 +840,22 @@ var RNP = {</span>
<a href="#l11.614"></a><span id="l11.614">         input_from_file</span>
<a href="#l11.615"></a><span id="l11.615">       )</span>
<a href="#l11.616"></a><span id="l11.616">     ) {</span>
<a href="#l11.617"></a><span id="l11.617">       throw new Error(&quot;rnp_op_verify_detached_create failed&quot;);</span>
<a href="#l11.618"></a><span id="l11.618">     }</span>
<a href="#l11.619"></a><span id="l11.619"> </span>
<a href="#l11.620"></a><span id="l11.620">     result.exitCode = RNPLib.rnp_op_verify_execute(verify_op);</span>
<a href="#l11.621"></a><span id="l11.621"> </span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-    let haveSignature = this.getVerifyDetails(verify_op, result);</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineplus">+    let haveSignature = await this.getVerifyDetails(</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineplus">+      RNPLib.ffi,</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineplus">+      options.fromAddr,</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+      verify_op,</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+      result</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+    );</span>
<a href="#l11.629"></a><span id="l11.629">     if (!haveSignature) {</span>
<a href="#l11.630"></a><span id="l11.630">       if (!result.exitCode) {</span>
<a href="#l11.631"></a><span id="l11.631">         /* Don't allow a good exit code. Keep existing bad code. */</span>
<a href="#l11.632"></a><span id="l11.632">         result.exitCode = -1;</span>
<a href="#l11.633"></a><span id="l11.633">       }</span>
<a href="#l11.634"></a><span id="l11.634">       result.statusFlags |= EnigmailConstants.BAD_SIGNATURE;</span>
<a href="#l11.635"></a><span id="l11.635">     }</span>
<a href="#l11.636"></a><span id="l11.636"> </span>
<a href="#l11.637"></a><span id="l11.637" class="difflineat">@@ -787,72 +1076,78 @@ var RNP = {</span>
<a href="#l11.638"></a><span id="l11.638">           if (c &lt; 32 || c &gt; 126) {</span>
<a href="#l11.639"></a><span id="l11.639">             return false;</span>
<a href="#l11.640"></a><span id="l11.640">           }</span>
<a href="#l11.641"></a><span id="l11.641">       }</span>
<a href="#l11.642"></a><span id="l11.642">     }</span>
<a href="#l11.643"></a><span id="l11.643">     return true;</span>
<a href="#l11.644"></a><span id="l11.644">   },</span>
<a href="#l11.645"></a><span id="l11.645"> </span>
<a href="#l11.646"></a><span id="l11.646" class="difflineminus">-  getKeyListFromKeyBlock(keyBlockStr, pubkey = true, seckey = false) {</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineplus">+  async getKeyListFromKeyBlock(keyBlockStr, pubkey = true, seckey = false) {</span>
<a href="#l11.648"></a><span id="l11.648">     // Create a separate, temporary RNP storage area (FFI),</span>
<a href="#l11.649"></a><span id="l11.649">     // import the key block into it, then get the listing.</span>
<a href="#l11.650"></a><span id="l11.650">     if (!this.isSimpleASCII(keyBlockStr)) {</span>
<a href="#l11.651"></a><span id="l11.651">       return null;</span>
<a href="#l11.652"></a><span id="l11.652">     }</span>
<a href="#l11.653"></a><span id="l11.653"> </span>
<a href="#l11.654"></a><span id="l11.654">     let tempFFI = new RNPLib.rnp_ffi_t();</span>
<a href="#l11.655"></a><span id="l11.655">     if (RNPLib.rnp_ffi_create(tempFFI.address(), &quot;GPG&quot;, &quot;GPG&quot;)) {</span>
<a href="#l11.656"></a><span id="l11.656">       throw new Error(&quot;Couldn't initialize librnp.&quot;);</span>
<a href="#l11.657"></a><span id="l11.657">     }</span>
<a href="#l11.658"></a><span id="l11.658"> </span>
<a href="#l11.659"></a><span id="l11.659">     // check result</span>
<a href="#l11.660"></a><span id="l11.660">     this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey);</span>
<a href="#l11.661"></a><span id="l11.661"> </span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-    let keys = this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineplus">+    let keys = await this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l11.664"></a><span id="l11.664"> </span>
<a href="#l11.665"></a><span id="l11.665">     RNPLib.rnp_ffi_destroy(tempFFI);</span>
<a href="#l11.666"></a><span id="l11.666">     return keys;</span>
<a href="#l11.667"></a><span id="l11.667">   },</span>
<a href="#l11.668"></a><span id="l11.668"> </span>
<a href="#l11.669"></a><span id="l11.669" class="difflineminus">-  importKeyBlock(win, passCB, keyBlockStr, pubkey, seckey, password = null) {</span>
<a href="#l11.670"></a><span id="l11.670" class="difflineplus">+  async importKeyBlock(</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineplus">+    win,</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineplus">+    passCB,</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineplus">+    keyBlockStr,</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineplus">+    pubkey,</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineplus">+    seckey,</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineplus">+    password = null</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineplus">+  ) {</span>
<a href="#l11.678"></a><span id="l11.678">     /*</span>
<a href="#l11.679"></a><span id="l11.679">      * Import strategy:</span>
<a href="#l11.680"></a><span id="l11.680">      * - import file into a temporary space, in-memory only (ffi)</span>
<a href="#l11.681"></a><span id="l11.681">      * - if we failed to decrypt the secret keys, return null</span>
<a href="#l11.682"></a><span id="l11.682">      * - change the password of all secret keys</span>
<a href="#l11.683"></a><span id="l11.683">      * - get the key listing of all keys from the temporary space,</span>
<a href="#l11.684"></a><span id="l11.684">      *   which is want we want to return as the import report</span>
<a href="#l11.685"></a><span id="l11.685">      * - export all keys from the temporary space, and import them</span>
<a href="#l11.686"></a><span id="l11.686">      *   into our permanent space.</span>
<a href="#l11.687"></a><span id="l11.687">      */</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineminus">-</span>
<a href="#l11.689"></a><span id="l11.689">     let userFlags = { canceled: false };</span>
<a href="#l11.690"></a><span id="l11.690"> </span>
<a href="#l11.691"></a><span id="l11.691">     let result = {};</span>
<a href="#l11.692"></a><span id="l11.692">     result.exitCode = -1;</span>
<a href="#l11.693"></a><span id="l11.693">     result.importedKeys = [];</span>
<a href="#l11.694"></a><span id="l11.694">     result.errorMsg = &quot;&quot;;</span>
<a href="#l11.695"></a><span id="l11.695"> </span>
<a href="#l11.696"></a><span id="l11.696">     let tempFFI = new RNPLib.rnp_ffi_t();</span>
<a href="#l11.697"></a><span id="l11.697">     if (RNPLib.rnp_ffi_create(tempFFI.address(), &quot;GPG&quot;, &quot;GPG&quot;)) {</span>
<a href="#l11.698"></a><span id="l11.698">       throw new Error(&quot;Couldn't initialize librnp.&quot;);</span>
<a href="#l11.699"></a><span id="l11.699">     }</span>
<a href="#l11.700"></a><span id="l11.700"> </span>
<a href="#l11.701"></a><span id="l11.701">     // TODO: check result</span>
<a href="#l11.702"></a><span id="l11.702">     this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey);</span>
<a href="#l11.703"></a><span id="l11.703"> </span>
<a href="#l11.704"></a><span id="l11.704" class="difflineminus">-    let keys = this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineplus">+    let keys = await this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l11.706"></a><span id="l11.706"> </span>
<a href="#l11.707"></a><span id="l11.707">     let recentPass = &quot;&quot;;</span>
<a href="#l11.708"></a><span id="l11.708"> </span>
<a href="#l11.709"></a><span id="l11.709">     // Prior to importing, ensure we can unprotect all keys</span>
<a href="#l11.710"></a><span id="l11.710">     for (let ki = 0; ki &lt; keys.length; ki++) {</span>
<a href="#l11.711"></a><span id="l11.711">       let k = keys[ki];</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-      let impKey = this.getKeyHandleByIdentifier(tempFFI, &quot;0x&quot; + k.fpr);</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineplus">+      let impKey = await this.getKeyHandleByIdentifier(tempFFI, &quot;0x&quot; + k.fpr);</span>
<a href="#l11.714"></a><span id="l11.714">       if (impKey.isNull()) {</span>
<a href="#l11.715"></a><span id="l11.715">         throw new Error(&quot;cannot get key handle for imported key: &quot; + k.fpr);</span>
<a href="#l11.716"></a><span id="l11.716">       }</span>
<a href="#l11.717"></a><span id="l11.717"> </span>
<a href="#l11.718"></a><span id="l11.718">       if (k.secretAvailable) {</span>
<a href="#l11.719"></a><span id="l11.719">         while (!userFlags.canceled) {</span>
<a href="#l11.720"></a><span id="l11.720">           let rv = RNPLib.rnp_key_unprotect(impKey, recentPass);</span>
<a href="#l11.721"></a><span id="l11.721"> </span>
<a href="#l11.722"></a><span id="l11.722" class="difflineat">@@ -872,17 +1167,17 @@ var RNP = {</span>
<a href="#l11.723"></a><span id="l11.723">       if (userFlags.canceled) {</span>
<a href="#l11.724"></a><span id="l11.724">         break;</span>
<a href="#l11.725"></a><span id="l11.725">       }</span>
<a href="#l11.726"></a><span id="l11.726">     }</span>
<a href="#l11.727"></a><span id="l11.727"> </span>
<a href="#l11.728"></a><span id="l11.728">     if (!userFlags.canceled) {</span>
<a href="#l11.729"></a><span id="l11.729">       for (let ki = 0; ki &lt; keys.length; ki++) {</span>
<a href="#l11.730"></a><span id="l11.730">         let k = keys[ki];</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineminus">-        let impKey = this.getKeyHandleByIdentifier(tempFFI, &quot;0x&quot; + k.fpr);</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+        let impKey = await this.getKeyHandleByIdentifier(tempFFI, &quot;0x&quot; + k.fpr);</span>
<a href="#l11.733"></a><span id="l11.733"> </span>
<a href="#l11.734"></a><span id="l11.734">         if (</span>
<a href="#l11.735"></a><span id="l11.735">           k.secretAvailable &amp;&amp;</span>
<a href="#l11.736"></a><span id="l11.736">           RNPLib.rnp_key_protect(</span>
<a href="#l11.737"></a><span id="l11.737">             impKey,</span>
<a href="#l11.738"></a><span id="l11.738">             OpenPGPMasterpass.retrieveOpenPGPPassword(),</span>
<a href="#l11.739"></a><span id="l11.739">             null,</span>
<a href="#l11.740"></a><span id="l11.740">             null,</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineat">@@ -995,65 +1290,55 @@ var RNP = {</span>
<a href="#l11.742"></a><span id="l11.742">     if (RNPLib.rnp_key_remove(handle, flags)) {</span>
<a href="#l11.743"></a><span id="l11.743">       throw new Error(&quot;rnp_key_remove failed&quot;);</span>
<a href="#l11.744"></a><span id="l11.744">     }</span>
<a href="#l11.745"></a><span id="l11.745"> </span>
<a href="#l11.746"></a><span id="l11.746">     RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l11.747"></a><span id="l11.747">     this.saveKeyRings();</span>
<a href="#l11.748"></a><span id="l11.748">   },</span>
<a href="#l11.749"></a><span id="l11.749"> </span>
<a href="#l11.750"></a><span id="l11.750" class="difflineminus">-  getKeyHandleByIdentifier(ffi, id) {</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+  getKeyHandleByKeyIdOrFingerprint(ffi, id) {</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+    if (!id.startsWith(&quot;0x&quot;)) {</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+      throw new Error(&quot;unexpected identifier &quot; + id);</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+    } else {</span>
<a href="#l11.755"></a><span id="l11.755" class="difflineplus">+      // remove 0x</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineplus">+      id = id.substring(2);</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineplus">+    }</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineplus">+    let type = null;</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineplus">+    if (id.length == 16) {</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineplus">+      type = &quot;keyid&quot;;</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineplus">+    } else if (id.length == 40 || id.length == 32) {</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineplus">+      type = &quot;fingerprint&quot;;</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+    } else {</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineplus">+      throw new Error(&quot;key/fingerprint identifier of unexpected length: &quot; + id);</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineplus">+    }</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineplus">+</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineplus">+    let key = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineplus">+    if (RNPLib.rnp_locate_key(ffi, type, id, key.address())) {</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineplus">+      throw new Error(&quot;rnp_locate_key failed, &quot; + type + &quot;, &quot; + id);</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineplus">+    }</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+    return key;</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineplus">+  },</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineplus">+</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineplus">+  async getKeyHandleByIdentifier(ffi, id) {</span>
<a href="#l11.776"></a><span id="l11.776">     console.debug(&quot;getKeyHandleByIdentifier searching for: &quot; + id);</span>
<a href="#l11.777"></a><span id="l11.777">     let key = null;</span>
<a href="#l11.778"></a><span id="l11.778"> </span>
<a href="#l11.779"></a><span id="l11.779">     if (id.startsWith(&quot;&lt;&quot;)) {</span>
<a href="#l11.780"></a><span id="l11.780">       //throw new Error(&quot;search by email address not yet implemented: &quot; + id);</span>
<a href="#l11.781"></a><span id="l11.781">       if (!id.endsWith(&quot;&gt;&quot;)) {</span>
<a href="#l11.782"></a><span id="l11.782">         throw new Error(</span>
<a href="#l11.783"></a><span id="l11.783">           &quot;if search identifier starts with &lt; then it must end with &gt; : &quot; + id</span>
<a href="#l11.784"></a><span id="l11.784">         );</span>
<a href="#l11.785"></a><span id="l11.785">       }</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineminus">-      key = this.findKeyByEmail(id);</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineplus">+      key = await this.findKeyByEmail(id);</span>
<a href="#l11.788"></a><span id="l11.788">     } else {</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineminus">-      if (!id.startsWith(&quot;0x&quot;)) {</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineminus">-        throw new Error(&quot;unexpected identifier &quot; + id);</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineminus">-      } else {</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-        // remove 0x</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineminus">-        id = id.substring(2);</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineminus">-      }</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineminus">-</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineminus">-      let type = null;</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-      if (id.length == 16) {</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineminus">-        type = &quot;keyid&quot;;</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineminus">-      } else if (id.length == 40 || id.length == 32) {</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineminus">-        type = &quot;fingerprint&quot;;</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineminus">-      } else {</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-        throw new Error(</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-          &quot;key/fingerprint identifier of unexpected length: &quot; + id</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineminus">-        );</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineminus">-      }</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineminus">-</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-      key = new RNPLib.rnp_key_handle_t();</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-      if (RNPLib.rnp_locate_key(ffi, type, id, key.address())) {</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineminus">-        throw new Error(&quot;rnp_locate_key failed, &quot; + type + &quot;, &quot; + id);</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineminus">-      }</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineplus">+      key = this.getKeyHandleByKeyIdOrFingerprint(ffi, id);</span>
<a href="#l11.812"></a><span id="l11.812">     }</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-    if (!key || key.isNull()) {</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-      console.debug(&quot;getKeyHandleByIdentifier nothing found&quot;);</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineminus">-    } else {</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineminus">-      console.debug(&quot;getKeyHandleByIdentifier found!&quot;);</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineminus">-      let is_subkey = new ctypes.bool();</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-      let res = RNPLib.rnp_key_is_sub(key, is_subkey.address());</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineminus">-      if (res) {</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-        throw new Error(&quot;rnp_key_is_sub failed: &quot; + res);</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineminus">-      }</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineminus">-      console.debug(&quot;is_primary? &quot; + !is_subkey.value);</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineminus">-    }</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-</span>
<a href="#l11.826"></a><span id="l11.826">     return key;</span>
<a href="#l11.827"></a><span id="l11.827">   },</span>
<a href="#l11.828"></a><span id="l11.828"> </span>
<a href="#l11.829"></a><span id="l11.829">   isKeyUsableFor(key, usage) {</span>
<a href="#l11.830"></a><span id="l11.830">     let allowed = new ctypes.bool();</span>
<a href="#l11.831"></a><span id="l11.831">     if (RNPLib.rnp_key_allows_usage(key, usage, allowed.address())) {</span>
<a href="#l11.832"></a><span id="l11.832">       throw new Error(&quot;rnp_key_allows_usage failed&quot;);</span>
<a href="#l11.833"></a><span id="l11.833">     }</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineat">@@ -1125,17 +1410,17 @@ var RNP = {</span>
<a href="#l11.835"></a><span id="l11.835">     ) {</span>
<a href="#l11.836"></a><span id="l11.836">       throw new Error(&quot;rnp_op_encrypt_add_recipient sender failed&quot;);</span>
<a href="#l11.837"></a><span id="l11.837">     }</span>
<a href="#l11.838"></a><span id="l11.838">     if (use_sub) {</span>
<a href="#l11.839"></a><span id="l11.839">       RNPLib.rnp_key_handle_destroy(use_sub);</span>
<a href="#l11.840"></a><span id="l11.840">     }</span>
<a href="#l11.841"></a><span id="l11.841">   },</span>
<a href="#l11.842"></a><span id="l11.842"> </span>
<a href="#l11.843"></a><span id="l11.843" class="difflineminus">-  encryptAndOrSign(plaintext, args, resultStatus) {</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineplus">+  async encryptAndOrSign(plaintext, args, resultStatus) {</span>
<a href="#l11.845"></a><span id="l11.845">     resultStatus.exitCode = -1;</span>
<a href="#l11.846"></a><span id="l11.846">     resultStatus.statusFlags = 0;</span>
<a href="#l11.847"></a><span id="l11.847">     resultStatus.statusMsg = &quot;&quot;;</span>
<a href="#l11.848"></a><span id="l11.848">     resultStatus.errorMsg = &quot;&quot;;</span>
<a href="#l11.849"></a><span id="l11.849"> </span>
<a href="#l11.850"></a><span id="l11.850">     console.debug(</span>
<a href="#l11.851"></a><span id="l11.851">       `encryptAndOrSign, plaintext (length=${plaintext.length}): ${plaintext}`</span>
<a href="#l11.852"></a><span id="l11.852">     );</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineat">@@ -1199,18 +1484,18 @@ var RNP = {</span>
<a href="#l11.854"></a><span id="l11.854">         );</span>
<a href="#l11.855"></a><span id="l11.855">       }</span>
<a href="#l11.856"></a><span id="l11.856">     } else {</span>
<a href="#l11.857"></a><span id="l11.857">       throw new Error(&quot;invalid parameters, neither encrypt nor sign&quot;);</span>
<a href="#l11.858"></a><span id="l11.858">     }</span>
<a href="#l11.859"></a><span id="l11.859"> </span>
<a href="#l11.860"></a><span id="l11.860">     let senderKey = null;</span>
<a href="#l11.861"></a><span id="l11.861">     if (args.sign || args.encryptToSender) {</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-      senderKey = this.getKeyHandleByIdentifier(RNPLib.ffi, args.sender);</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-      if (senderKey.isNull()) {</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+      senderKey = await this.getKeyHandleByIdentifier(RNPLib.ffi, args.sender);</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineplus">+      if (!senderKey || senderKey.isNull()) {</span>
<a href="#l11.866"></a><span id="l11.866">         return null;</span>
<a href="#l11.867"></a><span id="l11.867">       }</span>
<a href="#l11.868"></a><span id="l11.868">       if (args.encryptToSender) {</span>
<a href="#l11.869"></a><span id="l11.869">         this.addSuitableEncryptKey(senderKey, op);</span>
<a href="#l11.870"></a><span id="l11.870">       }</span>
<a href="#l11.871"></a><span id="l11.871">       if (args.sign) {</span>
<a href="#l11.872"></a><span id="l11.872">         let use_sub = null;</span>
<a href="#l11.873"></a><span id="l11.873">         if (!this.isKeyUsableFor(senderKey, str_sign)) {</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineat">@@ -1242,27 +1527,27 @@ var RNP = {</span>
<a href="#l11.875"></a><span id="l11.875">           RNPLib.rnp_key_handle_destroy(use_sub);</span>
<a href="#l11.876"></a><span id="l11.876">         }</span>
<a href="#l11.877"></a><span id="l11.877">       }</span>
<a href="#l11.878"></a><span id="l11.878">       RNPLib.rnp_key_handle_destroy(senderKey);</span>
<a href="#l11.879"></a><span id="l11.879">     }</span>
<a href="#l11.880"></a><span id="l11.880"> </span>
<a href="#l11.881"></a><span id="l11.881">     if (args.encrypt) {</span>
<a href="#l11.882"></a><span id="l11.882">       for (let id in args.to) {</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineminus">-        let toKey = this.getKeyHandleByIdentifier(RNPLib.ffi, args.to[id]);</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+        let toKey = await this.findKeyByEmail(args.to[id], true);</span>
<a href="#l11.885"></a><span id="l11.885">         if (!toKey || toKey.isNull()) {</span>
<a href="#l11.886"></a><span id="l11.886">           resultStatus.statusFlags |= EnigmailConstants.INVALID_RECIPIENT;</span>
<a href="#l11.887"></a><span id="l11.887">           return null;</span>
<a href="#l11.888"></a><span id="l11.888">         }</span>
<a href="#l11.889"></a><span id="l11.889">         this.addSuitableEncryptKey(toKey, op);</span>
<a href="#l11.890"></a><span id="l11.890">         RNPLib.rnp_key_handle_destroy(toKey);</span>
<a href="#l11.891"></a><span id="l11.891">       }</span>
<a href="#l11.892"></a><span id="l11.892"> </span>
<a href="#l11.893"></a><span id="l11.893">       for (let id in args.bcc) {</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-        let bccKey = this.getKeyHandleByIdentifier(RNPLib.ffi, args.bcc[id]);</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+        let bccKey = await this.findKeyByEmail(args.bcc[id], true);</span>
<a href="#l11.896"></a><span id="l11.896">         if (bccKey.isNull()) {</span>
<a href="#l11.897"></a><span id="l11.897">           resultStatus.statusFlags |= EnigmailConstants.INVALID_RECIPIENT;</span>
<a href="#l11.898"></a><span id="l11.898">           return null;</span>
<a href="#l11.899"></a><span id="l11.899">         }</span>
<a href="#l11.900"></a><span id="l11.900">         this.addSuitableEncryptKey(bccKey, op);</span>
<a href="#l11.901"></a><span id="l11.901">         RNPLib.rnp_key_handle_destroy(bccKey);</span>
<a href="#l11.902"></a><span id="l11.902">       }</span>
<a href="#l11.903"></a><span id="l11.903"> </span>
<a href="#l11.904"></a><span id="l11.904" class="difflineat">@@ -1308,26 +1593,23 @@ var RNP = {</span>
<a href="#l11.905"></a><span id="l11.905">       !RNPLib.rnp_output_memory_get_buf(</span>
<a href="#l11.906"></a><span id="l11.906">         output,</span>
<a href="#l11.907"></a><span id="l11.907">         result_buf.address(),</span>
<a href="#l11.908"></a><span id="l11.908">         result_len.address(),</span>
<a href="#l11.909"></a><span id="l11.909">         false</span>
<a href="#l11.910"></a><span id="l11.910">       )</span>
<a href="#l11.911"></a><span id="l11.911">     ) {</span>
<a href="#l11.912"></a><span id="l11.912">       console.debug(&quot;encrypt result len: &quot; + result_len.value);</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineminus">-      //let buf_array = ctypes.cast(result_buf, ctypes.uint8_t.array(result_len.value).ptr).contents;</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineminus">-      //let char_array = ctypes.cast(buf_array, ctypes.char.array(result_len.value));</span>
<a href="#l11.915"></a><span id="l11.915"> </span>
<a href="#l11.916"></a><span id="l11.916">       let char_array = ctypes.cast(</span>
<a href="#l11.917"></a><span id="l11.917">         result_buf,</span>
<a href="#l11.918"></a><span id="l11.918">         ctypes.char.array(result_len.value).ptr</span>
<a href="#l11.919"></a><span id="l11.919">       ).contents;</span>
<a href="#l11.920"></a><span id="l11.920"> </span>
<a href="#l11.921"></a><span id="l11.921">       result = char_array.readString();</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineminus">-      console.debug(result);</span>
<a href="#l11.923"></a><span id="l11.923">     }</span>
<a href="#l11.924"></a><span id="l11.924"> </span>
<a href="#l11.925"></a><span id="l11.925">     RNPLib.rnp_output_destroy(output);</span>
<a href="#l11.926"></a><span id="l11.926"> </span>
<a href="#l11.927"></a><span id="l11.927">     resultStatus.exitCode = 0;</span>
<a href="#l11.928"></a><span id="l11.928"> </span>
<a href="#l11.929"></a><span id="l11.929">     if (args.encrypt) {</span>
<a href="#l11.930"></a><span id="l11.930">       resultStatus.statusFlags |= EnigmailConstants.END_ENCRYPTION;</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineat">@@ -1353,36 +1635,35 @@ var RNP = {</span>
<a href="#l11.932"></a><span id="l11.932">     if (RNPLib.rnp_key_get_creation(handle, creation.address())) {</span>
<a href="#l11.933"></a><span id="l11.933">       throw new Error(&quot;rnp_key_get_creation failed&quot;);</span>
<a href="#l11.934"></a><span id="l11.934">     }</span>
<a href="#l11.935"></a><span id="l11.935">     let expirationSeconds = creation.value + expiration.value;</span>
<a href="#l11.936"></a><span id="l11.936">     let isExpired = nowSeconds &gt; expirationSeconds;</span>
<a href="#l11.937"></a><span id="l11.937">     return isExpired;</span>
<a href="#l11.938"></a><span id="l11.938">   },</span>
<a href="#l11.939"></a><span id="l11.939"> </span>
<a href="#l11.940"></a><span id="l11.940" class="difflineminus">-  findKeyByEmail(id) {</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineminus">-    if (!id.startsWith(&quot;&lt;&quot;) || !id.endsWith(&quot;&gt;&quot;)) {</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+  async findKeyByEmail(id, onlyAcceptableAsPublic = false) {</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineplus">+    if (!id.startsWith(&quot;&lt;&quot;) || !id.endsWith(&quot;&gt;&quot;) || id.includes(&quot; &quot;)) {</span>
<a href="#l11.944"></a><span id="l11.944">       throw new Error(&quot;invalid parameter given to findKeyByEmail&quot;);</span>
<a href="#l11.945"></a><span id="l11.945">     }</span>
<a href="#l11.946"></a><span id="l11.946"> </span>
<a href="#l11.947"></a><span id="l11.947" class="difflineminus">-    let rv;</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+    let emailWithoutBrackets = id.substring(1, id.length - 1);</span>
<a href="#l11.949"></a><span id="l11.949"> </span>
<a href="#l11.950"></a><span id="l11.950">     let iter = new RNPLib.rnp_identifier_iterator_t();</span>
<a href="#l11.951"></a><span id="l11.951">     let grip = new ctypes.char.ptr();</span>
<a href="#l11.952"></a><span id="l11.952"> </span>
<a href="#l11.953"></a><span id="l11.953" class="difflineminus">-    rv = RNPLib.rnp_identifier_iterator_create(</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineminus">-      RNPLib.ffi,</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineminus">-      iter.address(),</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-      &quot;grip&quot;</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-    );</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineminus">-    if (rv) {</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineminus">-      return null;</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineplus">+    if (</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+      RNPLib.rnp_identifier_iterator_create(RNPLib.ffi, iter.address(), &quot;grip&quot;)</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineplus">+    ) {</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+      throw new Error(&quot;rnp_identifier_iterator_create failed&quot;);</span>
<a href="#l11.964"></a><span id="l11.964">     }</span>
<a href="#l11.965"></a><span id="l11.965"> </span>
<a href="#l11.966"></a><span id="l11.966">     let foundHandle = null;</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineplus">+    let tentativeUnverifiedHandle = null;</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+</span>
<a href="#l11.969"></a><span id="l11.969">     while (</span>
<a href="#l11.970"></a><span id="l11.970">       !foundHandle &amp;&amp;</span>
<a href="#l11.971"></a><span id="l11.971">       !RNPLib.rnp_identifier_iterator_next(iter, grip.address())</span>
<a href="#l11.972"></a><span id="l11.972">     ) {</span>
<a href="#l11.973"></a><span id="l11.973">       if (grip.isNull()) {</span>
<a href="#l11.974"></a><span id="l11.974">         break;</span>
<a href="#l11.975"></a><span id="l11.975">       }</span>
<a href="#l11.976"></a><span id="l11.976"> </span>
<a href="#l11.977"></a><span id="l11.977" class="difflineat">@@ -1412,20 +1693,55 @@ var RNP = {</span>
<a href="#l11.978"></a><span id="l11.978">         if (key_revoked.value) {</span>
<a href="#l11.979"></a><span id="l11.979">           continue;</span>
<a href="#l11.980"></a><span id="l11.980">         }</span>
<a href="#l11.981"></a><span id="l11.981"> </span>
<a href="#l11.982"></a><span id="l11.982">         if (this.isKeyExpired(handle)) {</span>
<a href="#l11.983"></a><span id="l11.983">           continue;</span>
<a href="#l11.984"></a><span id="l11.984">         }</span>
<a href="#l11.985"></a><span id="l11.985"> </span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+        let acceptance = &quot;&quot;;</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+        if (onlyAcceptableAsPublic) {</span>
<a href="#l11.989"></a><span id="l11.989" class="difflineplus">+          let fingerprint = new ctypes.char.ptr();</span>
<a href="#l11.990"></a><span id="l11.990" class="difflineplus">+          if (RNPLib.rnp_key_get_fprint(handle, fingerprint.address())) {</span>
<a href="#l11.991"></a><span id="l11.991" class="difflineplus">+            throw new Error(&quot;rnp_key_get_fprint failed&quot;);</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineplus">+          }</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineplus">+          let fpr = fingerprint.readString();</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+          let acceptanceResult = {};</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+          try {</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+            await PgpSqliteDb2.getAcceptance(</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+              fpr,</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+              emailWithoutBrackets,</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+              acceptanceResult</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineplus">+            );</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineplus">+          } catch (ex) {</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+            console.debug(&quot;getAcceptance failed: &quot; + ex);</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineplus">+          }</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineplus">+</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+          if (!acceptanceResult.emailDecided) {</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineplus">+            continue;</span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineplus">+          }</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineplus">+          acceptance = acceptanceResult.fingerprintAcceptance;</span>
<a href="#l11.1010"></a><span id="l11.1010" class="difflineplus">+          let isAcceptable =</span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineplus">+            acceptance == &quot;unverified&quot; || acceptance == &quot;verified&quot;;</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineplus">+          if (!isAcceptable) {</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineplus">+            continue;</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineplus">+          }</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineplus">+        }</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+        /* Ensure the desired email is still contained in the set of</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+         * valid UIDs, hasn't been removed, nor revoked. */</span>
<a href="#l11.1019"></a><span id="l11.1019">         if (RNPLib.rnp_key_get_uid_count(handle, uid_count.address())) {</span>
<a href="#l11.1020"></a><span id="l11.1020">           throw new Error(&quot;rnp_key_get_uid_count failed&quot;);</span>
<a href="#l11.1021"></a><span id="l11.1021">         }</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineminus">-        for (let i = 0; i &lt; uid_count.value; i++) {</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+        let foundUid = false;</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineplus">+        for (let i = 0; i &lt; uid_count.value &amp;&amp; !foundUid; i++) {</span>
<a href="#l11.1026"></a><span id="l11.1026">           let uid_handle = new RNPLib.rnp_uid_handle_t();</span>
<a href="#l11.1027"></a><span id="l11.1027">           let is_revoked = new ctypes.bool();</span>
<a href="#l11.1028"></a><span id="l11.1028"> </span>
<a href="#l11.1029"></a><span id="l11.1029">           if (</span>
<a href="#l11.1030"></a><span id="l11.1030">             RNPLib.rnp_key_get_uid_handle_at(handle, i, uid_handle.address())</span>
<a href="#l11.1031"></a><span id="l11.1031">           ) {</span>
<a href="#l11.1032"></a><span id="l11.1032">             throw new Error(&quot;rnp_key_get_uid_handle_at failed&quot;);</span>
<a href="#l11.1033"></a><span id="l11.1033">           }</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineat">@@ -1436,43 +1752,66 @@ var RNP = {</span>
<a href="#l11.1035"></a><span id="l11.1035"> </span>
<a href="#l11.1036"></a><span id="l11.1036">           if (!is_revoked.value) {</span>
<a href="#l11.1037"></a><span id="l11.1037">             let uid_str = new ctypes.char.ptr();</span>
<a href="#l11.1038"></a><span id="l11.1038">             if (RNPLib.rnp_key_get_uid_at(handle, i, uid_str.address())) {</span>
<a href="#l11.1039"></a><span id="l11.1039">               throw new Error(&quot;rnp_key_get_uid_at failed&quot;);</span>
<a href="#l11.1040"></a><span id="l11.1040">             }</span>
<a href="#l11.1041"></a><span id="l11.1041"> </span>
<a href="#l11.1042"></a><span id="l11.1042">             let userId = uid_str.readString();</span>
<a href="#l11.1043"></a><span id="l11.1043" class="difflineplus">+            if (userId.includes(id)) {</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineplus">+              foundUid = true;</span>
<a href="#l11.1045"></a><span id="l11.1045"> </span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineminus">-            if (userId.includes(id)) {</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineminus">-              foundHandle = handle;</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineplus">+              if (onlyAcceptableAsPublic) {</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+                if (acceptance == &quot;unverified&quot;) {</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineplus">+                  /* keep searching for a better, verified key */</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineplus">+                  if (!tentativeUnverifiedHandle) {</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+                    tentativeUnverifiedHandle = handle;</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineplus">+                    have_handle = false;</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineplus">+                  }</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+                } else if (acceptance == &quot;verified&quot;) {</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+                  foundHandle = handle;</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineplus">+                  have_handle = false;</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineplus">+                  if (tentativeUnverifiedHandle) {</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+                    RNPLib.rnp_key_handle_destroy(tentativeUnverifiedHandle);</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+                    tentativeUnverifiedHandle = null;</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+                  }</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineplus">+                }</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+              } else {</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+                foundHandle = handle;</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+                have_handle = false;</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+              }</span>
<a href="#l11.1067"></a><span id="l11.1067">             }</span>
<a href="#l11.1068"></a><span id="l11.1068"> </span>
<a href="#l11.1069"></a><span id="l11.1069">             RNPLib.rnp_buffer_destroy(uid_str);</span>
<a href="#l11.1070"></a><span id="l11.1070">           }</span>
<a href="#l11.1071"></a><span id="l11.1071"> </span>
<a href="#l11.1072"></a><span id="l11.1072">           RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l11.1073"></a><span id="l11.1073">         }</span>
<a href="#l11.1074"></a><span id="l11.1074">       } catch (ex) {</span>
<a href="#l11.1075"></a><span id="l11.1075">         console.log(ex);</span>
<a href="#l11.1076"></a><span id="l11.1076">       } finally {</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-        if (!foundHandle &amp;&amp; have_handle) {</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+        if (have_handle) {</span>
<a href="#l11.1079"></a><span id="l11.1079">           RNPLib.rnp_key_handle_destroy(handle);</span>
<a href="#l11.1080"></a><span id="l11.1080">         }</span>
<a href="#l11.1081"></a><span id="l11.1081">       }</span>
<a href="#l11.1082"></a><span id="l11.1082">     }</span>
<a href="#l11.1083"></a><span id="l11.1083"> </span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+    if (!foundHandle &amp;&amp; tentativeUnverifiedHandle) {</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+      foundHandle = tentativeUnverifiedHandle;</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineplus">+      tentativeUnverifiedHandle = null;</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineplus">+    }</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineplus">+</span>
<a href="#l11.1089"></a><span id="l11.1089">     RNPLib.rnp_identifier_iterator_destroy(iter);</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineminus">-</span>
<a href="#l11.1091"></a><span id="l11.1091">     return foundHandle;</span>
<a href="#l11.1092"></a><span id="l11.1092">   },</span>
<a href="#l11.1093"></a><span id="l11.1093"> </span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineminus">-  getPublicKey(id) {</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineplus">+  async getPublicKey(id) {</span>
<a href="#l11.1096"></a><span id="l11.1096">     let result = &quot;&quot;;</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineminus">-    let key = this.getKeyHandleByIdentifier(RNPLib.ffi, id);</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineplus">+    let key = await this.getKeyHandleByIdentifier(RNPLib.ffi, id);</span>
<a href="#l11.1099"></a><span id="l11.1099"> </span>
<a href="#l11.1100"></a><span id="l11.1100">     if (key.isNull()) {</span>
<a href="#l11.1101"></a><span id="l11.1101">       return result;</span>
<a href="#l11.1102"></a><span id="l11.1102">     }</span>
<a href="#l11.1103"></a><span id="l11.1103"> </span>
<a href="#l11.1104"></a><span id="l11.1104">     let flags =</span>
<a href="#l11.1105"></a><span id="l11.1105">       RNPLib.RNP_KEY_EXPORT_ARMORED |</span>
<a href="#l11.1106"></a><span id="l11.1106">       RNPLib.RNP_KEY_EXPORT_PUBLIC |</span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineat">@@ -1503,19 +1842,19 @@ var RNP = {</span>
<a href="#l11.1108"></a><span id="l11.1108">       result = char_array.readString();</span>
<a href="#l11.1109"></a><span id="l11.1109">     }</span>
<a href="#l11.1110"></a><span id="l11.1110"> </span>
<a href="#l11.1111"></a><span id="l11.1111">     RNPLib.rnp_output_destroy(output_to_memory);</span>
<a href="#l11.1112"></a><span id="l11.1112">     RNPLib.rnp_key_handle_destroy(key);</span>
<a href="#l11.1113"></a><span id="l11.1113">     return result;</span>
<a href="#l11.1114"></a><span id="l11.1114">   },</span>
<a href="#l11.1115"></a><span id="l11.1115"> </span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineminus">-  getNewRevocation(id) {</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+  async getNewRevocation(id) {</span>
<a href="#l11.1118"></a><span id="l11.1118">     let result = &quot;&quot;;</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineminus">-    let key = this.getKeyHandleByIdentifier(RNPLib.ffi, id);</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineplus">+    let key = await this.getKeyHandleByIdentifier(RNPLib.ffi, id);</span>
<a href="#l11.1121"></a><span id="l11.1121"> </span>
<a href="#l11.1122"></a><span id="l11.1122">     if (key.isNull()) {</span>
<a href="#l11.1123"></a><span id="l11.1123">       return result;</span>
<a href="#l11.1124"></a><span id="l11.1124">     }</span>
<a href="#l11.1125"></a><span id="l11.1125"> </span>
<a href="#l11.1126"></a><span id="l11.1126">     let out_final = new RNPLib.rnp_output_t();</span>
<a href="#l11.1127"></a><span id="l11.1127">     RNPLib.rnp_output_to_memory(out_final.address(), 0);</span>
<a href="#l11.1128"></a><span id="l11.1128"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -97,16 +97,17 @@ const rnp_key_handle_t = ctypes.void_t.p</span>
<a href="#l12.4"></a><span id="l12.4"> const rnp_uid_handle_t = ctypes.void_t.ptr;</span>
<a href="#l12.5"></a><span id="l12.5"> const rnp_identifier_iterator_t = ctypes.void_t.ptr;</span>
<a href="#l12.6"></a><span id="l12.6"> const rnp_op_generate_t = ctypes.void_t.ptr;</span>
<a href="#l12.7"></a><span id="l12.7"> const rnp_op_encrypt_t = ctypes.void_t.ptr;</span>
<a href="#l12.8"></a><span id="l12.8"> const rnp_op_sign_t = ctypes.void_t.ptr;</span>
<a href="#l12.9"></a><span id="l12.9"> const rnp_op_sign_signature_t = ctypes.void_t.ptr;</span>
<a href="#l12.10"></a><span id="l12.10"> const rnp_op_verify_t = ctypes.void_t.ptr;</span>
<a href="#l12.11"></a><span id="l12.11"> const rnp_op_verify_signature_t = ctypes.void_t.ptr;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+const rnp_signature_handle_t = ctypes.void_t.ptr;</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> const rnp_password_cb_t = ctypes.FunctionType(abi, ctypes.bool, [</span>
<a href="#l12.15"></a><span id="l12.15">   rnp_ffi_t,</span>
<a href="#l12.16"></a><span id="l12.16">   ctypes.void_t.ptr,</span>
<a href="#l12.17"></a><span id="l12.17">   rnp_key_handle_t,</span>
<a href="#l12.18"></a><span id="l12.18">   ctypes.char.ptr,</span>
<a href="#l12.19"></a><span id="l12.19">   ctypes.char.ptr,</span>
<a href="#l12.20"></a><span id="l12.20">   ctypes.size_t,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -581,16 +582,24 @@ function enableRNPLibJS() {</span>
<a href="#l12.22"></a><span id="l12.22">     rnp_key_get_uid_count: librnp.declare(</span>
<a href="#l12.23"></a><span id="l12.23">       &quot;rnp_key_get_uid_count&quot;,</span>
<a href="#l12.24"></a><span id="l12.24">       abi,</span>
<a href="#l12.25"></a><span id="l12.25">       rnp_result_t,</span>
<a href="#l12.26"></a><span id="l12.26">       rnp_key_handle_t,</span>
<a href="#l12.27"></a><span id="l12.27">       ctypes.size_t.ptr</span>
<a href="#l12.28"></a><span id="l12.28">     ),</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    rnp_key_get_primary_uid: librnp.declare(</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+      &quot;rnp_key_get_primary_uid&quot;,</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+      abi,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+      rnp_key_handle_t,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+      ctypes.char.ptr.ptr</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    ),</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+</span>
<a href="#l12.38"></a><span id="l12.38">     rnp_key_get_uid_at: librnp.declare(</span>
<a href="#l12.39"></a><span id="l12.39">       &quot;rnp_key_get_uid_at&quot;,</span>
<a href="#l12.40"></a><span id="l12.40">       abi,</span>
<a href="#l12.41"></a><span id="l12.41">       rnp_result_t,</span>
<a href="#l12.42"></a><span id="l12.42">       rnp_key_handle_t,</span>
<a href="#l12.43"></a><span id="l12.43">       ctypes.size_t,</span>
<a href="#l12.44"></a><span id="l12.44">       ctypes.char.ptr.ptr</span>
<a href="#l12.45"></a><span id="l12.45">     ),</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineat">@@ -984,30 +993,79 @@ function enableRNPLibJS() {</span>
<a href="#l12.47"></a><span id="l12.47">       &quot;rnp_op_verify_signature_get_times&quot;,</span>
<a href="#l12.48"></a><span id="l12.48">       abi,</span>
<a href="#l12.49"></a><span id="l12.49">       rnp_result_t,</span>
<a href="#l12.50"></a><span id="l12.50">       rnp_op_verify_signature_t,</span>
<a href="#l12.51"></a><span id="l12.51">       ctypes.uint32_t.ptr,</span>
<a href="#l12.52"></a><span id="l12.52">       ctypes.uint32_t.ptr</span>
<a href="#l12.53"></a><span id="l12.53">     ),</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    rnp_uid_get_signature_count: librnp.declare(</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+      &quot;rnp_uid_get_signature_count&quot;,</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+      abi,</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+      rnp_uid_handle_t,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+      ctypes.size_t.ptr</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    ),</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    rnp_uid_get_signature_at: librnp.declare(</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+      &quot;rnp_uid_get_signature_at&quot;,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+      abi,</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+      rnp_uid_handle_t,</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+      ctypes.size_t,</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+      rnp_signature_handle_t.ptr</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    ),</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    rnp_signature_get_creation: librnp.declare(</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+      &quot;rnp_signature_get_creation&quot;,</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+      abi,</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+      rnp_signature_handle_t,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+      ctypes.uint32_t.ptr</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+    ),</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+    rnp_signature_get_keyid: librnp.declare(</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+      &quot;rnp_signature_get_keyid&quot;,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+      abi,</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+      rnp_signature_handle_t,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+      ctypes.char.ptr.ptr</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    ),</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    rnp_signature_get_signer: librnp.declare(</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+      &quot;rnp_signature_get_signer&quot;,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+      abi,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+      rnp_signature_handle_t,</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+      rnp_key_handle_t.ptr</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+    ),</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    rnp_signature_handle_destroy: librnp.declare(</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+      &quot;rnp_signature_handle_destroy&quot;,</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+      abi,</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+      rnp_result_t,</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+      rnp_signature_handle_t</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+    ),</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+</span>
<a href="#l12.103"></a><span id="l12.103">     rnp_result_t,</span>
<a href="#l12.104"></a><span id="l12.104">     rnp_ffi_t,</span>
<a href="#l12.105"></a><span id="l12.105">     rnp_password_cb_t,</span>
<a href="#l12.106"></a><span id="l12.106">     rnp_input_t,</span>
<a href="#l12.107"></a><span id="l12.107">     rnp_output_t,</span>
<a href="#l12.108"></a><span id="l12.108">     rnp_key_handle_t,</span>
<a href="#l12.109"></a><span id="l12.109">     rnp_uid_handle_t,</span>
<a href="#l12.110"></a><span id="l12.110">     rnp_identifier_iterator_t,</span>
<a href="#l12.111"></a><span id="l12.111">     rnp_op_generate_t,</span>
<a href="#l12.112"></a><span id="l12.112">     rnp_op_encrypt_t,</span>
<a href="#l12.113"></a><span id="l12.113">     rnp_op_sign_t,</span>
<a href="#l12.114"></a><span id="l12.114">     rnp_op_sign_signature_t,</span>
<a href="#l12.115"></a><span id="l12.115">     rnp_op_verify_t,</span>
<a href="#l12.116"></a><span id="l12.116">     rnp_op_verify_signature_t,</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+    rnp_signature_handle_t,</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">     RNP_LOAD_SAVE_PUBLIC_KEYS: 1,</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121">     RNP_LOAD_SAVE_SECRET_KEYS: 2,</span>
<a href="#l12.122"></a><span id="l12.122"> </span>
<a href="#l12.123"></a><span id="l12.123">     RNP_KEY_REMOVE_PUBLIC: 1,</span>
<a href="#l12.124"></a><span id="l12.124"> </span>
<a href="#l12.125"></a><span id="l12.125">     RNP_KEY_REMOVE_SECRET: 2,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/singletons.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/singletons.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -7,16 +7,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> var EXPORTED_SYMBOLS = [&quot;EnigmailSingletons&quot;];</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> var EnigmailSingletons = {</span>
<a href="#l13.7"></a><span id="l13.7">   // handle to most recent message reader window</span>
<a href="#l13.8"></a><span id="l13.8">   messageReader: null,</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   // information about the last PGP/MIME decrypted message (mimeDecrypt)</span>
<a href="#l13.11"></a><span id="l13.11">   lastDecryptedMessage: {},</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  lastMessageDecryptTime: 0,</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14">   clearLastDecryptedMessage() {</span>
<a href="#l13.15"></a><span id="l13.15">     let lm = this.lastDecryptedMessage;</span>
<a href="#l13.16"></a><span id="l13.16">     lm.lastMessageData = &quot;&quot;;</span>
<a href="#l13.17"></a><span id="l13.17">     lm.lastMessageURI = null;</span>
<a href="#l13.18"></a><span id="l13.18">     lm.lastStatus = {};</span>
<a href="#l13.19"></a><span id="l13.19">   },</span>
<a href="#l13.20"></a><span id="l13.20"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,98 +3,298 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * file, You can obtain one at https://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> &quot;use strict&quot;;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> /**</span>
<a href="#l14.9"></a><span id="l14.9">  *  Module that provides generic functions for the Enigmail SQLite database</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;EnigmailSqliteDb&quot;];</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;EnigmailSqliteDb&quot;, &quot;PgpSqliteDb2&quot;];</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> const { Sqlite } = ChromeUtils.import(&quot;resource://gre/modules/Sqlite.jsm&quot;);</span>
<a href="#l14.16"></a><span id="l14.16"> const { EnigmailTimer } = ChromeUtils.import(</span>
<a href="#l14.17"></a><span id="l14.17">   &quot;chrome://openpgp/content/modules/timer.jsm&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> );</span>
<a href="#l14.19"></a><span id="l14.19"> const { EnigmailLog } = ChromeUtils.import(</span>
<a href="#l14.20"></a><span id="l14.20">   &quot;chrome://openpgp/content/modules/log.jsm&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> );</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+var PgpSqliteDb2 = {</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  openDatabase() {</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+    EnigmailLog.DEBUG(&quot;sqliteDb.jsm: PgpSqliteDb2 openDatabase()\n&quot;);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+      openDatabaseConn(</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+        &quot;openpgp.sqlite&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+        resolve,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+        reject,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+        100,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+        Date.now() + 10000</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      );</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    });</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  },</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  async checkDatabaseStructure() {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    EnigmailLog.DEBUG(`sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure()\n`);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    let conn;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    try {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+      conn = await this.openDatabase();</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+      await checkAcceptanceTable(conn);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+      conn.close();</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+      EnigmailLog.DEBUG(</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+        `sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure - success\n`</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+      );</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+      EnigmailLog.ERROR(</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+        `sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure: ERROR: ${ex}\n`</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      );</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      if (conn) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+        conn.close();</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+      }</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    }</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  },</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  async getFingerprintAcceptance(conn, fingerprint, rv) {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    let myConn = false;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    try {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+      if (!conn) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+        myConn = true;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        conn = await this.openDatabase();</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+      }</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+      let qObj = { fpr: fingerprint.toLowerCase() };</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+      await conn</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+        .execute(</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+          &quot;select decision from acceptance_decision where fpr = :fpr&quot;,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+          qObj</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+        )</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+        .then(result =&gt; {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+          if (result.length) {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+            rv.fingerprintAcceptance = result[0].getResultByName(&quot;decision&quot;);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+          }</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+        });</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+      console.debug(ex);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    }</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    if (myConn &amp;&amp; conn) {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+      conn.close();</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    }</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  },</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  async getAcceptance(fingerprint, email, rv) {</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    rv.emailDecided = false;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+    rv.fingerprintAcceptance = &quot;&quot;;</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    let conn;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    try {</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+      conn = await this.openDatabase();</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      await this.getFingerprintAcceptance(conn, fingerprint, rv);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+      if (rv.fingerprintAcceptance) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+        let qObj = {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+          fpr: fingerprint.toLowerCase(),</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+          email: email.toLowerCase(),</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+        };</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+        await conn</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+          .execute(</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+            &quot;select count(*) from acceptance_email where fpr = :fpr and email = :email&quot;,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+            qObj</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+          )</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+          .then(result =&gt; {</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+            if (result.length) {</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+              let count = result[0].getResultByName(&quot;count(*)&quot;);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+              rv.emailDecided = count &gt; 0;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+            }</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+          });</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+      }</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+      conn.close();</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+      console.debug(ex);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+      if (conn) {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+        conn.close();</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+      }</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    }</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  },</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  async updateAcceptance(fingerprint, emailArray, decision) {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+    let conn;</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    try {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+      conn = await this.openDatabase();</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+      await conn.executeTransaction(async function() {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+        fingerprint = fingerprint.toLowerCase();</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+        let delObj = { fpr: fingerprint };</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+        await conn.execute(</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+          &quot;delete from acceptance_decision where fpr = :fpr&quot;,</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+          delObj</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        );</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        await conn.execute(</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+          &quot;delete from acceptance_email where fpr = :fpr&quot;,</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+          delObj</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+        );</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+        if (decision !== &quot;undecided&quot;) {</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+          let decisionObj = {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+            fpr: fingerprint,</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+            decision,</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+          };</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+          await conn.execute(</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+            &quot;insert into acceptance_decision values (:fpr, :decision)&quot;,</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+            decisionObj</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+          );</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+          let insertObj = {</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+            fpr: fingerprint,</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+          };</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+          for (let email of emailArray) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+            insertObj.email = email.toLowerCase();</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+            await conn.execute(</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+              &quot;insert into acceptance_email values (:fpr, :email)&quot;,</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+              insertObj</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+            );</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+          }</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+        }</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+      });</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+      conn.close();</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+      console.debug(ex);</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      if (conn) {</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+        conn.close();</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+      }</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+    }</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+  },</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+};</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+</span>
<a href="#l14.172"></a><span id="l14.172"> var EnigmailSqliteDb = {</span>
<a href="#l14.173"></a><span id="l14.173">   /**</span>
<a href="#l14.174"></a><span id="l14.174">    * Provide an sqlite conection object asynchronously, retrying if needed</span>
<a href="#l14.175"></a><span id="l14.175">    *</span>
<a href="#l14.176"></a><span id="l14.176">    * @return {Promise&lt;Sqlite Connection&gt;}: the Sqlite database object</span>
<a href="#l14.177"></a><span id="l14.177">    */</span>
<a href="#l14.178"></a><span id="l14.178"> </span>
<a href="#l14.179"></a><span id="l14.179">   openDatabase() {</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    /*</span>
<a href="#l14.181"></a><span id="l14.181">     EnigmailLog.DEBUG(&quot;sqliteDb.jsm: openDatabase()\n&quot;);</span>
<a href="#l14.182"></a><span id="l14.182">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-      openDatabaseConn(resolve, reject, 100, Date.now() + 10000);</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+      openDatabaseConn(&quot;enigmail.sqlite&quot;, resolve, reject, 100, Date.now() + 10000);</span>
<a href="#l14.185"></a><span id="l14.185">     });</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+    */</span>
<a href="#l14.187"></a><span id="l14.187">   },</span>
<a href="#l14.188"></a><span id="l14.188"> </span>
<a href="#l14.189"></a><span id="l14.189">   async checkDatabaseStructure() {</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+    /*</span>
<a href="#l14.191"></a><span id="l14.191">     EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure()\n`);</span>
<a href="#l14.192"></a><span id="l14.192">     let conn;</span>
<a href="#l14.193"></a><span id="l14.193">     try {</span>
<a href="#l14.194"></a><span id="l14.194">       conn = await this.openDatabase();</span>
<a href="#l14.195"></a><span id="l14.195">       await checkAutocryptTable(conn);</span>
<a href="#l14.196"></a><span id="l14.196">       await checkWkdTable(conn);</span>
<a href="#l14.197"></a><span id="l14.197">       conn.close();</span>
<a href="#l14.198"></a><span id="l14.198">       EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure - success\n`);</span>
<a href="#l14.199"></a><span id="l14.199">     } catch (ex) {</span>
<a href="#l14.200"></a><span id="l14.200">       EnigmailLog.ERROR(`sqliteDb.jsm: checkDatabaseStructure: ERROR: ${ex}\n`);</span>
<a href="#l14.201"></a><span id="l14.201">       if (conn) {</span>
<a href="#l14.202"></a><span id="l14.202">         conn.close();</span>
<a href="#l14.203"></a><span id="l14.203">       }</span>
<a href="#l14.204"></a><span id="l14.204">     }</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    */</span>
<a href="#l14.206"></a><span id="l14.206">   },</span>
<a href="#l14.207"></a><span id="l14.207"> };</span>
<a href="#l14.208"></a><span id="l14.208"> </span>
<a href="#l14.209"></a><span id="l14.209"> /**</span>
<a href="#l14.210"></a><span id="l14.210">  * use a promise to open the Enigmail database.</span>
<a href="#l14.211"></a><span id="l14.211">  *</span>
<a href="#l14.212"></a><span id="l14.212">  * it's possible that there will be an NS_ERROR_STORAGE_BUSY</span>
<a href="#l14.213"></a><span id="l14.213">  * so we're willing to retry for a little while.</span>
<a href="#l14.214"></a><span id="l14.214">  *</span>
<a href="#l14.215"></a><span id="l14.215">  * @param {function} resolve: function to call when promise succeeds</span>
<a href="#l14.216"></a><span id="l14.216">  * @param {function} reject:  function to call when promise fails</span>
<a href="#l14.217"></a><span id="l14.217">  * @param {Number}   waitms:  Integer - number of milliseconds to wait before trying again in case of NS_ERROR_STORAGE_BUSY</span>
<a href="#l14.218"></a><span id="l14.218">  * @param {Number}   maxtime: Integer - unix epoch (in milliseconds) of the point at which we should give up.</span>
<a href="#l14.219"></a><span id="l14.219">  */</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-function openDatabaseConn(resolve, reject, waitms, maxtime) {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+function openDatabaseConn(filename, resolve, reject, waitms, maxtime) {</span>
<a href="#l14.222"></a><span id="l14.222">   EnigmailLog.DEBUG(&quot;sqliteDb.jsm: openDatabaseConn()\n&quot;);</span>
<a href="#l14.223"></a><span id="l14.223">   Sqlite.openConnection({</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-    path: &quot;enigmail.sqlite&quot;,</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    path: filename,</span>
<a href="#l14.226"></a><span id="l14.226">     sharedMemoryCache: false,</span>
<a href="#l14.227"></a><span id="l14.227">   })</span>
<a href="#l14.228"></a><span id="l14.228">     .then(connection =&gt; {</span>
<a href="#l14.229"></a><span id="l14.229">       resolve(connection);</span>
<a href="#l14.230"></a><span id="l14.230">     })</span>
<a href="#l14.231"></a><span id="l14.231">     .catch(error =&gt; {</span>
<a href="#l14.232"></a><span id="l14.232">       let now = Date.now();</span>
<a href="#l14.233"></a><span id="l14.233">       if (now &gt; maxtime) {</span>
<a href="#l14.234"></a><span id="l14.234">         reject(error);</span>
<a href="#l14.235"></a><span id="l14.235">         return;</span>
<a href="#l14.236"></a><span id="l14.236">       }</span>
<a href="#l14.237"></a><span id="l14.237">       EnigmailTimer.setTimeout(function() {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-        openDatabaseConn(resolve, reject, waitms, maxtime);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+        openDatabaseConn(filename, resolve, reject, waitms, maxtime);</span>
<a href="#l14.240"></a><span id="l14.240">       }, waitms);</span>
<a href="#l14.241"></a><span id="l14.241">     });</span>
<a href="#l14.242"></a><span id="l14.242"> }</span>
<a href="#l14.243"></a><span id="l14.243"> </span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+async function checkAcceptanceTable(connection) {</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+  try {</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+    let exists = await connection.tableExists(&quot;acceptance_email&quot;);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+    let exists2 = await connection.tableExists(&quot;acceptance_decision&quot;);</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+    EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkAcceptanceTable - success\n&quot;);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+    if (!exists || !exists2) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+      await createAcceptanceTable(connection);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+    }</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  } catch (error) {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+    EnigmailLog.DEBUG(`sqliteDB.jsm: checkAcceptanceTable - error ${error}\n`);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+    throw error;</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+  }</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+  return true;</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+}</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+async function createAcceptanceTable(connection) {</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+  EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createAcceptanceTable()\n&quot;);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+  await connection.execute(</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+    &quot;create table acceptance_email (&quot; +</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+      &quot;fpr text not null, &quot; +</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+      &quot;email text not null, &quot; +</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+      &quot;unique(fpr, email));&quot;</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+  );</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+  await connection.execute(</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+    &quot;create table acceptance_decision (&quot; +</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+      &quot;fpr text not null, &quot; +</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+      &quot;decision text not null, &quot; +</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+      &quot;unique(fpr));&quot;</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  );</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+  EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createAcceptanceTable - index1\n&quot;);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+  await connection.execute(</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+    &quot;create unique index acceptance_email_i1 on acceptance_email(fpr, email);&quot;</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+  );</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+  EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createAcceptanceTable - index2\n&quot;);</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+  await connection.execute(</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+    &quot;create unique index acceptance__decision_i1 on acceptance_decision(fpr);&quot;</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+  );</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+  return null;</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+}</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+</span>
<a href="#l14.290"></a><span id="l14.290"> /**</span>
<a href="#l14.291"></a><span id="l14.291">  * Ensure that the database structure matches the latest version</span>
<a href="#l14.292"></a><span id="l14.292">  * (table is available)</span>
<a href="#l14.293"></a><span id="l14.293">  *</span>
<a href="#l14.294"></a><span id="l14.294">  * @param connection: Object - SQLite connection</span>
<a href="#l14.295"></a><span id="l14.295">  *</span>
<a href="#l14.296"></a><span id="l14.296">  * @return {Promise&lt;Boolean&gt;}</span>
<a href="#l14.297"></a><span id="l14.297">  */</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+/*</span>
<a href="#l14.299"></a><span id="l14.299"> async function checkAutocryptTable(connection) {</span>
<a href="#l14.300"></a><span id="l14.300">   try {</span>
<a href="#l14.301"></a><span id="l14.301">     let exists = await connection.tableExists(&quot;autocrypt_keydata&quot;);</span>
<a href="#l14.302"></a><span id="l14.302">     EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkAutocryptTable - success\n&quot;);</span>
<a href="#l14.303"></a><span id="l14.303">     if (!exists) {</span>
<a href="#l14.304"></a><span id="l14.304">       await createAutocryptTable(connection);</span>
<a href="#l14.305"></a><span id="l14.305">     } else {</span>
<a href="#l14.306"></a><span id="l14.306">       let hasKeyRingInserted = false;</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineat">@@ -124,23 +324,26 @@ async function checkAutocryptTable(conne</span>
<a href="#l14.308"></a><span id="l14.308">     }</span>
<a href="#l14.309"></a><span id="l14.309">   } catch (error) {</span>
<a href="#l14.310"></a><span id="l14.310">     EnigmailLog.DEBUG(`sqliteDB.jsm: checkAutocryptTable - error ${error}\n`);</span>
<a href="#l14.311"></a><span id="l14.311">     throw error;</span>
<a href="#l14.312"></a><span id="l14.312">   }</span>
<a href="#l14.313"></a><span id="l14.313"> </span>
<a href="#l14.314"></a><span id="l14.314">   return true;</span>
<a href="#l14.315"></a><span id="l14.315"> }</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+*/</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+</span>
<a href="#l14.318"></a><span id="l14.318"> /**</span>
<a href="#l14.319"></a><span id="l14.319">  * Create the &quot;autocrypt_keydata&quot; table and the corresponding index</span>
<a href="#l14.320"></a><span id="l14.320">  *</span>
<a href="#l14.321"></a><span id="l14.321">  * @param connection: Object - SQLite connection</span>
<a href="#l14.322"></a><span id="l14.322">  *</span>
<a href="#l14.323"></a><span id="l14.323">  * @return {Promise}</span>
<a href="#l14.324"></a><span id="l14.324">  */</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+/*</span>
<a href="#l14.326"></a><span id="l14.326"> async function createAutocryptTable(connection) {</span>
<a href="#l14.327"></a><span id="l14.327">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createAutocryptTable()\n&quot;);</span>
<a href="#l14.328"></a><span id="l14.328"> </span>
<a href="#l14.329"></a><span id="l14.329">   await connection.execute(</span>
<a href="#l14.330"></a><span id="l14.330">     &quot;create table autocrypt_keydata (&quot; +</span>
<a href="#l14.331"></a><span id="l14.331">     &quot;email text not null, &quot; + // email address of correspondent</span>
<a href="#l14.332"></a><span id="l14.332">     &quot;keydata text not null, &quot; + // base64-encoded key as received</span>
<a href="#l14.333"></a><span id="l14.333">     &quot;fpr text, &quot; + // fingerprint of key</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineat">@@ -153,47 +356,52 @@ async function createAutocryptTable(conn</span>
<a href="#l14.335"></a><span id="l14.335"> </span>
<a href="#l14.336"></a><span id="l14.336">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createAutocryptTable - index\n&quot;);</span>
<a href="#l14.337"></a><span id="l14.337">   await connection.execute(</span>
<a href="#l14.338"></a><span id="l14.338">     &quot;create unique index autocrypt_keydata_i1 on autocrypt_keydata(email, type)&quot;</span>
<a href="#l14.339"></a><span id="l14.339">   );</span>
<a href="#l14.340"></a><span id="l14.340"> </span>
<a href="#l14.341"></a><span id="l14.341">   return null;</span>
<a href="#l14.342"></a><span id="l14.342"> }</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+*/</span>
<a href="#l14.344"></a><span id="l14.344"> </span>
<a href="#l14.345"></a><span id="l14.345"> /**</span>
<a href="#l14.346"></a><span id="l14.346">  * Ensure that the database has the wkd_lookup_timestamp table.</span>
<a href="#l14.347"></a><span id="l14.347">  *</span>
<a href="#l14.348"></a><span id="l14.348">  * @param connection: Object - SQLite connection</span>
<a href="#l14.349"></a><span id="l14.349">  *</span>
<a href="#l14.350"></a><span id="l14.350">  * @return Promise</span>
<a href="#l14.351"></a><span id="l14.351">  */</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+/*</span>
<a href="#l14.353"></a><span id="l14.353"> async function checkWkdTable(connection) {</span>
<a href="#l14.354"></a><span id="l14.354">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable()\n&quot;);</span>
<a href="#l14.355"></a><span id="l14.355"> </span>
<a href="#l14.356"></a><span id="l14.356">   try {</span>
<a href="#l14.357"></a><span id="l14.357">     let exists = await connection.tableExists(&quot;wkd_lookup_timestamp&quot;);</span>
<a href="#l14.358"></a><span id="l14.358">     EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable - success\n&quot;);</span>
<a href="#l14.359"></a><span id="l14.359">     if (!exists) {</span>
<a href="#l14.360"></a><span id="l14.360">       await createWkdTable(connection);</span>
<a href="#l14.361"></a><span id="l14.361">     }</span>
<a href="#l14.362"></a><span id="l14.362">   } catch (error) {</span>
<a href="#l14.363"></a><span id="l14.363">     EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable - error\n&quot;);</span>
<a href="#l14.364"></a><span id="l14.364">     throw error;</span>
<a href="#l14.365"></a><span id="l14.365">   }</span>
<a href="#l14.366"></a><span id="l14.366"> }</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+*/</span>
<a href="#l14.368"></a><span id="l14.368"> </span>
<a href="#l14.369"></a><span id="l14.369"> /**</span>
<a href="#l14.370"></a><span id="l14.370">  * Create the &quot;wkd_lookup_timestamp&quot; table.</span>
<a href="#l14.371"></a><span id="l14.371">  *</span>
<a href="#l14.372"></a><span id="l14.372">  * @param connection: Object - SQLite connection</span>
<a href="#l14.373"></a><span id="l14.373">  *</span>
<a href="#l14.374"></a><span id="l14.374">  * @return Promise</span>
<a href="#l14.375"></a><span id="l14.375">  */</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+/*</span>
<a href="#l14.377"></a><span id="l14.377"> function createWkdTable(connection) {</span>
<a href="#l14.378"></a><span id="l14.378">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createWkdTable()\n&quot;);</span>
<a href="#l14.379"></a><span id="l14.379"> </span>
<a href="#l14.380"></a><span id="l14.380">   return connection.execute(</span>
<a href="#l14.381"></a><span id="l14.381">     &quot;create table wkd_lookup_timestamp (&quot; +</span>
<a href="#l14.382"></a><span id="l14.382">     &quot;email text not null primary key, &quot; + // email address of correspondent</span>
<a href="#l14.383"></a><span id="l14.383">       &quot;last_seen integer);&quot;</span>
<a href="#l14.384"></a><span id="l14.384">   ); // timestamp of last mail received for the email/type combination</span>
<a href="#l14.385"></a><span id="l14.385"> }</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/uidHelper.jsm</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/*</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ */</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;uidHelper&quot;];</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+/* Parse a OpenPGP user ID string and split it into its parts.</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * The expected syntax is:</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *    Name (comment) &lt;email&gt;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * Each part is allowed to be empty.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ */</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+var uidHelper = {</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  getPartsFromUidStr(uid, resultObj) {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+    // RegExp strategy:</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+    // Search until the first ( or &lt; character, use that as Name.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+    // Then search for the () characters, allow any characters until ).</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+    // Do the same for &lt;&gt;.</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+    // No characters are allowed between a closing ) and opening &lt;.</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+    // All characters after a trailing &gt; are ignored.</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+    let result = uid.match(/^ *([^(&lt;]*)? *(\([^)]*\))? *(&lt;[^&gt;]*&gt;)?/);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+    if (result.length != 4) {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+      return false;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    }</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+    resultObj.name = result[1].trim();</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    resultObj.comment = &quot;&quot;;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+    if (result[2]) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+      resultObj.comment = result[2].substring(1, result[2].length - 1).trim();</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+    }</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+    resultObj.email = &quot;&quot;;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+    if (result[3]) {</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+      resultObj.email = result[3].substring(1, result[3].length - 1).trim();</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    }</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+    return true;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  },</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.dtd</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -60,17 +60,22 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> &lt;!ENTITY enigmail.restorePrefsButton.label &quot;Restore Settings and Keys&quot;&gt;</span>
<a href="#l16.6"></a><span id="l16.6"> &lt;!ENTITY enigmail.restorePrefs.tooltip     &quot;Restore all Gine-Liam preferences including your OpenPGP keys from a file.&quot;&gt;</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> &lt;!ENTITY enigmail.pref.acSetupMessage.button &quot;Initiate Autocrypt Setup&quot;&gt;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> &lt;!ENTITY enigmail.backupRestore.desc       &quot;Export (backup) and Restore your Gine-Liam settings including your OpenPGP keys.&quot;&gt;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-&lt;!ENTITY enigmail.basic.label            &quot;Basic&quot;&gt;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+&lt;!ENTITY enigmail.acceptance.label            &quot;Your Acceptance&quot;&gt;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+&lt;!ENTITY enigmail.acceptance.rejected.label   &quot;No, never use this key. (rejected)&quot;&gt;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+&lt;!ENTITY enigmail.acceptance.undecided.label  &quot;Not yet, maybe later. (undecided)&quot;&gt;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+&lt;!ENTITY enigmail.acceptance.unverified.label &quot;Yes, but I don't know if it is the correct key. (unverified)&quot;&gt;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+&lt;!ENTITY enigmail.acceptance.verified.label   &quot;Yes, I've verified in person this key has the correct fingerprint. (verified)&quot;&gt;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+</span>
<a href="#l16.19"></a><span id="l16.19"> &lt;!ENTITY enigmail.sending.label          &quot;Sending&quot;&gt;</span>
<a href="#l16.20"></a><span id="l16.20"> &lt;!ENTITY enigmail.keySel.label           &quot;Key Selection&quot;&gt;</span>
<a href="#l16.21"></a><span id="l16.21"> &lt;!ENTITY enigmail.pgpMime.label          &quot;PGP/MIME&quot;&gt;</span>
<a href="#l16.22"></a><span id="l16.22"> &lt;!ENTITY enigmail.advanced.label         &quot;Advanced&quot;&gt;</span>
<a href="#l16.23"></a><span id="l16.23"> &lt;!ENTITY enigmail.transferSettings.label &quot;Transfer Settings&quot;&gt;</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> &lt;!ENTITY enigmail.basicPrefs.label       &quot;Basic Settings&quot;&gt;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineat">@@ -440,109 +445,82 @@</span>
<a href="#l16.28"></a><span id="l16.28"> &lt;!ENTITY enigmail.keyTrust.ultimateTrust.label     &quot;Ultimate (Only use for keys you own yourself)&quot;&gt;</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30"> &lt;!ENTITY enigmail.keyExpiry.title                   &quot;Gine-Liam - Change Expiration Date&quot;&gt;</span>
<a href="#l16.31"></a><span id="l16.31"> &lt;!ENTITY enigmail.keyExpiry.expiryKey.label         &quot;Keys to change expiration date:&quot;&gt;</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33"> &lt;!ENTITY enigmail.keyMan.title                     &quot;Gine-Liam Key Management&quot;&gt;</span>
<a href="#l16.34"></a><span id="l16.34"> &lt;!ENTITY enigmail.keyMan.close.label               &quot;Close Window&quot;&gt;</span>
<a href="#l16.35"></a><span id="l16.35"> &lt;!ENTITY enigmail.keyMan.generate.label            &quot;New Key Pair&quot;&gt;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.sign.label                &quot;Sign Key&quot;&gt;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.setTrust.label            &quot;Set Owner Trust&quot;&gt;</span>
<a href="#l16.38"></a><span id="l16.38"> &lt;!ENTITY enigmail.keyMan.genRevoke.label           &quot;Revocation Certificate&quot;&gt;</span>
<a href="#l16.39"></a><span id="l16.39"> &lt;!ENTITY enigmail.keyMan.ctxGenRevoke.label        &quot;Generate &amp;amp; Save Revocation Certificate&quot;&gt;</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41"> &lt;!ENTITY enigmail.keyMan.fileMenu.label            &quot;File&quot;&gt;</span>
<a href="#l16.42"></a><span id="l16.42"> &lt;!ENTITY enigmail.keyMan.editMenu.label            &quot;Edit&quot;&gt;</span>
<a href="#l16.43"></a><span id="l16.43"> &lt;!ENTITY enigmail.keyMan.viewMenu.label            &quot;View&quot;&gt;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.keyserverMenu.label       &quot;Keyserver&quot;&gt;</span>
<a href="#l16.45"></a><span id="l16.45"> &lt;!ENTITY enigmail.keyMan.generateMenu.label        &quot;Generate&quot;&gt;</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47"> &lt;!ENTITY enigmail.keyMan.fileMenu.accesskey        &quot;F&quot;&gt;</span>
<a href="#l16.48"></a><span id="l16.48"> &lt;!ENTITY enigmail.keyMan.editMenu.accesskey        &quot;E&quot;&gt;</span>
<a href="#l16.49"></a><span id="l16.49"> &lt;!ENTITY enigmail.keyMan.viewMenu.accesskey        &quot;V&quot;&gt;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.keyserverMenu.accesskey   &quot;K&quot;&gt;</span>
<a href="#l16.51"></a><span id="l16.51"> &lt;!ENTITY enigmail.keyMan.generateMenu.accesskey    &quot;G&quot;&gt;</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53"> &lt;!ENTITY enigmail.keyMan.importPublicFromFile.label      &quot;Import Public Key(s) from File&quot;&gt;</span>
<a href="#l16.54"></a><span id="l16.54"> &lt;!ENTITY enigmail.keyMan.importSecretFromFile.label      &quot;Import Secret Keys from File&quot;&gt;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.importFromServer.label    &quot;Search for Keys&quot;&gt;</span>
<a href="#l16.56"></a><span id="l16.56"> &lt;!ENTITY enigmail.keyMan.importFromClipbrd.label   &quot;Import Keys from Clipboard&quot;&gt;</span>
<a href="#l16.57"></a><span id="l16.57"> &lt;!ENTITY enigmail.keyMan.importFromUrl.label       &quot;Import Keys from URL&quot;&gt;</span>
<a href="#l16.58"></a><span id="l16.58"> &lt;!ENTITY enigmail.keyMan.exportToFile.label        &quot;Export Keys to File&quot;&gt;</span>
<a href="#l16.59"></a><span id="l16.59"> &lt;!ENTITY enigmail.keyMan.sendKeys.label            &quot;Send Public Keys by Email&quot;&gt;</span>
<a href="#l16.60"></a><span id="l16.60"> &lt;!ENTITY enigmail.keyMan.createMail.label          &quot;Compose Email to Selected Keys&quot;&gt;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.uploadToServer.label      &quot;Upload Public Keys&quot;&gt;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.uploadToWkd.label         &quot;Upload to your provider's Web Key Directory&quot;&gt;</span>
<a href="#l16.63"></a><span id="l16.63"> &lt;!ENTITY enigmail.keyMan.copyToClipbrd.label       &quot;Copy Public Keys to Clipboard&quot;&gt;</span>
<a href="#l16.64"></a><span id="l16.64"> &lt;!ENTITY enigmail.keyMan.ctxExportToFile.label     &quot;Export Keys to File&quot;&gt;</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.ctxUploadToServer.label   &quot;Upload Public Keys to Keyserver&quot;&gt;</span>
<a href="#l16.66"></a><span id="l16.66"> &lt;!ENTITY enigmail.keyMan.ctxCopyToClipbrd.label    &quot;Copy Public Keys to Clipboard&quot;&gt;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.refreshSelKeys.label      &quot;Refresh Selected Public Keys&quot;&gt;</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.refreshAllKeys.label      &quot;Refresh All Public Keys&quot;&gt;</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.downloadContactKeys.label &quot;Find keys for all contacts&quot;&gt;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.ctxRefreshKey.label       &quot;Refresh Public Keys From Keyserver&quot;&gt;</span>
<a href="#l16.71"></a><span id="l16.71"> &lt;!ENTITY enigmail.keyMan.initiateAcBackup.label    &quot;Create Autocrypt Setup Message&quot;&gt;</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73"> &lt;!ENTITY enigmail.keyMan.reload.label              &quot;Reload Key Cache&quot;&gt;</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.manageUid.label           &quot;Manage User IDs&quot;&gt;</span>
<a href="#l16.75"></a><span id="l16.75"> &lt;!ENTITY enigmail.keyMan.changeExpiry.label        &quot;Change Expiration Date&quot;&gt;</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.changePwd.label           &quot;Change Passphrase&quot;&gt;</span>
<a href="#l16.77"></a><span id="l16.77"> &lt;!ENTITY enigmail.keyMan.delKey.label              &quot;Delete Key&quot;&gt;</span>
<a href="#l16.78"></a><span id="l16.78"> &lt;!ENTITY enigmail.keyMan.revokeKey.label           &quot;Revoke Key&quot;&gt;</span>
<a href="#l16.79"></a><span id="l16.79"> &lt;!ENTITY enigmail.keyMan.keyProps.label            &quot;Key Properties&quot;&gt;</span>
<a href="#l16.80"></a><span id="l16.80"> &lt;!ENTITY enigmail.keyMan.showAllKeys.label         &quot;Display All Keys by Default&quot;&gt;</span>
<a href="#l16.81"></a><span id="l16.81"> &lt;!ENTITY enigmail.keyMan.viewPhoto.label           &quot;Photo ID&quot;&gt;</span>
<a href="#l16.82"></a><span id="l16.82"> &lt;!ENTITY enigmail.keyMan.ctxViewPhoto.label        &quot;View Photo ID&quot;&gt;</span>
<a href="#l16.83"></a><span id="l16.83"> &lt;!ENTITY enigmail.keyMan.showInvalidKeys.label     &quot;Display invalid keys&quot;&gt;</span>
<a href="#l16.84"></a><span id="l16.84"> &lt;!ENTITY enigmail.keyMan.showUntrustedKeys.label   &quot;Display untrusted keys&quot;&gt;</span>
<a href="#l16.85"></a><span id="l16.85"> &lt;!ENTITY enigmail.keyMan.showOthersKeys.label      &quot;Display keys from other people&quot;&gt;</span>
<a href="#l16.86"></a><span id="l16.86"> &lt;!ENTITY enigmail.keyMan.userId.label              &quot;Name&quot;&gt;</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.keyType.label             &quot;Type&quot;&gt;</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.calcTrust.label           &quot;Key Validity&quot;&gt;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.ownerTrust.label          &quot;Owner Trust&quot;&gt;</span>
<a href="#l16.90"></a><span id="l16.90"> &lt;!ENTITY enigmail.keyMan.fingerprint.label         &quot;Fingerprint&quot;&gt;</span>
<a href="#l16.91"></a><span id="l16.91"> &lt;!ENTITY enigmail.keyMan.selectAll.label           &quot;Select all Keys&quot;&gt;</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.addToPRRule.label         &quot;Add to Per-Recipient Rule&quot;&gt;</span>
<a href="#l16.93"></a><span id="l16.93"> &lt;!ENTITY enigmail.keyMan.emptyTree.tooltip         &quot;Enter search terms in the box above&quot;&gt;</span>
<a href="#l16.94"></a><span id="l16.94"> &lt;!ENTITY enigmail.keyMan.nothingFound.tooltip      &quot;No keys match your search terms&quot;&gt;</span>
<a href="#l16.95"></a><span id="l16.95"> &lt;!ENTITY enigmail.keyMan.pleaseWait.tooltip        &quot;Please wait while keys are being loaded ...&quot;&gt;</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97"> &lt;!ENTITY enigmail.keyMan.filter.label              &quot;Search for keys&quot;&gt;</span>
<a href="#l16.98"></a><span id="l16.98"> </span>
<a href="#l16.99"></a><span id="l16.99"> &lt;!ENTITY enigmail.keyMan.close.accesskey             &quot;C&quot;&gt;</span>
<a href="#l16.100"></a><span id="l16.100"> &lt;!ENTITY enigmail.keyMan.generate.accesskey          &quot;K&quot;&gt;</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.sign.accesskey              &quot;S&quot;&gt;</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.setTrust.accesskey          &quot;T&quot;&gt;</span>
<a href="#l16.103"></a><span id="l16.103"> &lt;!ENTITY enigmail.keyMan.genRevoke.accesskey         &quot;R&quot;&gt;</span>
<a href="#l16.104"></a><span id="l16.104"> &lt;!ENTITY enigmail.keyMan.delKey.accesskey            &quot;D&quot;&gt;</span>
<a href="#l16.105"></a><span id="l16.105"> &lt;!ENTITY enigmail.keyMan.revokeKey.accesskey         &quot;R&quot;&gt;</span>
<a href="#l16.106"></a><span id="l16.106"> &lt;!ENTITY enigmail.keyMan.importPublicFromFile.accesskey    &quot;I&quot;&gt;</span>
<a href="#l16.107"></a><span id="l16.107"> &lt;!ENTITY enigmail.keyMan.exportToFile.accesskey      &quot;E&quot;&gt;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.importFromServer.accesskey  &quot;S&quot;&gt;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.uploadToServer.accesskey    &quot;U&quot;&gt;</span>
<a href="#l16.110"></a><span id="l16.110"> &lt;!ENTITY enigmail.keyMan.reload.accesskey            &quot;R&quot;&gt;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.manageUid.accesskey         &quot;M&quot;&gt;</span>
<a href="#l16.112"></a><span id="l16.112"> &lt;!ENTITY enigmail.keyMan.changeExpiry.accesskey      &quot;E&quot;&gt;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.changePwd.accesskey         &quot;P&quot;&gt;</span>
<a href="#l16.114"></a><span id="l16.114"> &lt;!ENTITY enigmail.keyMan.showInvalidKeys.accesskey   &quot;D&quot;&gt;</span>
<a href="#l16.115"></a><span id="l16.115"> &lt;!ENTITY enigmail.keyMan.showUntrustedKeys.accesskey &quot;U&quot;&gt;</span>
<a href="#l16.116"></a><span id="l16.116"> &lt;!ENTITY enigmail.keyMan.showOthersKeys.accesskey    &quot;O&quot;&gt;</span>
<a href="#l16.117"></a><span id="l16.117"> &lt;!ENTITY enigmail.keyMan.showPhoto.accesskey         &quot;P&quot;&gt;</span>
<a href="#l16.118"></a><span id="l16.118"> &lt;!ENTITY enigmail.keyMan.importFromClipbrd.accesskey &quot;I&quot;&gt;</span>
<a href="#l16.119"></a><span id="l16.119"> &lt;!ENTITY enigmail.keyMan.importFromUrl.accesskey     &quot;U&quot;&gt;</span>
<a href="#l16.120"></a><span id="l16.120"> &lt;!ENTITY enigmail.keyMan.copyToClipbrd.accesskey     &quot;C&quot;&gt;</span>
<a href="#l16.121"></a><span id="l16.121"> &lt;!ENTITY enigmail.keyMan.keyDetails.accesskey        &quot;K&quot;&gt;</span>
<a href="#l16.122"></a><span id="l16.122"> &lt;!ENTITY enigmail.keyMan.showAllKeys.accesskey       &quot;D&quot;&gt;</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.refreshSelKeys.accesskey    &quot;R&quot;&gt;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.refreshAllKeys.accesskey    &quot;A&quot;&gt;</span>
<a href="#l16.125"></a><span id="l16.125"> &lt;!ENTITY enigmail.keyMan.selectAll.accesskey         &quot;A&quot;&gt;</span>
<a href="#l16.126"></a><span id="l16.126"> &lt;!ENTITY enigmail.keyMan.sendKeys.accesskey          &quot;S&quot;&gt;</span>
<a href="#l16.127"></a><span id="l16.127"> &lt;!ENTITY enigmail.keyMan.createMail.accesskey        &quot;C&quot;&gt;</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-&lt;!ENTITY enigmail.keyMan.downloadContactKeys.accesskey &quot;F&quot;&gt;</span>
<a href="#l16.129"></a><span id="l16.129"> &lt;!ENTITY enigmail.keyMan.initiateAcBackup.accesskey  &quot;A&quot;&gt;</span>
<a href="#l16.130"></a><span id="l16.130"> </span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132"> &lt;!ENTITY enigmail.keyMan.selectAll.key               &quot;A&quot;&gt;</span>
<a href="#l16.133"></a><span id="l16.133"> &lt;!ENTITY enigmail.keyMan.keyDetails.key              &quot;I&quot;&gt;</span>
<a href="#l16.134"></a><span id="l16.134"> &lt;!ENTITY enigmail.keyMan.refreshKey.key              &quot;R&quot;&gt;</span>
<a href="#l16.135"></a><span id="l16.135"> </span>
<a href="#l16.136"></a><span id="l16.136"> &lt;!ENTITY enigmail.keySearch.selectAll.key            &quot;A&quot;&gt;</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineat">@@ -553,33 +531,29 @@</span>
<a href="#l16.138"></a><span id="l16.138"> &lt;!ENTITY enigmail.manageUidDlg.addUid.label          &quot;Add&quot;&gt;</span>
<a href="#l16.139"></a><span id="l16.139"> &lt;!ENTITY enigmail.manageUidDlg.revokeUid.label       &quot;Revoke&quot;&gt;</span>
<a href="#l16.140"></a><span id="l16.140"> &lt;!ENTITY enigmail.manageUidDlg.setPrimary.label      &quot;Set primary&quot;&gt;</span>
<a href="#l16.141"></a><span id="l16.141"> </span>
<a href="#l16.142"></a><span id="l16.142"> &lt;!ENTITY enigmail.keyDetails.title                   &quot;Key Properties&quot;&gt;</span>
<a href="#l16.143"></a><span id="l16.143"> &lt;!ENTITY enigmail.keyDetails.signaturesTab           &quot;Certifications&quot;&gt;</span>
<a href="#l16.144"></a><span id="l16.144"> &lt;!ENTITY enigmail.keyDetails.structureTab            &quot;Structure&quot;&gt;</span>
<a href="#l16.145"></a><span id="l16.145"> &lt;!ENTITY enigmail.keyDetails.uidCertifiedCol         &quot;User ID / Certified by&quot;&gt;</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.userId.label            &quot;Primary User ID&quot;&gt;</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+&lt;!ENTITY enigmail.keyDetails.userId2.label            &quot;Alleged Key Owner&quot;&gt;</span>
<a href="#l16.148"></a><span id="l16.148"> &lt;!ENTITY enigmail.keyDetails.ID.label                &quot;ID&quot;&gt;</span>
<a href="#l16.149"></a><span id="l16.149"> &lt;!ENTITY enigmail.keyDetails.keyType.label           &quot;Type&quot;&gt;</span>
<a href="#l16.150"></a><span id="l16.150"> &lt;!ENTITY enigmail.keyDetails.keyPart.label           &quot;Key Part&quot;&gt;</span>
<a href="#l16.151"></a><span id="l16.151"> &lt;!ENTITY enigmail.keyDetails.algorithm.label         &quot;Algorithm&quot;&gt;</span>
<a href="#l16.152"></a><span id="l16.152"> &lt;!ENTITY enigmail.keyDetails.size.label              &quot;Size&quot;&gt;</span>
<a href="#l16.153"></a><span id="l16.153"> &lt;!ENTITY enigmail.keyDetails.created.label           &quot;Created&quot;&gt;</span>
<a href="#l16.154"></a><span id="l16.154"> &lt;!ENTITY enigmail.keyDetails.expiry.label            &quot;Expiry&quot;&gt;</span>
<a href="#l16.155"></a><span id="l16.155"> &lt;!ENTITY enigmail.keyDetails.usage.label             &quot;Usage&quot;&gt;</span>
<a href="#l16.156"></a><span id="l16.156"> &lt;!ENTITY enigmail.keyDetails.fingerprint.label       &quot;Fingerprint&quot;&gt;</span>
<a href="#l16.157"></a><span id="l16.157"> &lt;!ENTITY enigmail.keyDetails.selAction.label         &quot;Select action ...&quot;&gt;</span>
<a href="#l16.158"></a><span id="l16.158"> &lt;!ENTITY enigmail.keyDetails.selAction.accesskey     &quot;S&quot;&gt;</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.change.label            &quot;Change&quot;&gt;</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.signKey.label           &quot;Certify&quot;&gt;</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.trustStatus.label       &quot;You rely on certifications&quot;&gt;</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.keyValidity.label       &quot;Validity&quot;&gt;</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-&lt;!ENTITY enigmail.keyDetails.alsoKnown.label         &quot;Also known as&quot;&gt;</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+&lt;!ENTITY enigmail.keyDetails.alsoKnown.label         &quot;Alleged Alternative Identities of the Key Owner:&quot;&gt;</span>
<a href="#l16.165"></a><span id="l16.165"> </span>
<a href="#l16.166"></a><span id="l16.166"> &lt;!ENTITY enigmail.cardDetails.title                  &quot;OpenPGP SmartCard Details&quot;&gt;</span>
<a href="#l16.167"></a><span id="l16.167"> &lt;!ENTITY enigmail.cardDetails.cardMenu.label         &quot;SmartCard&quot;&gt;</span>
<a href="#l16.168"></a><span id="l16.168"> &lt;!ENTITY enigmail.cardDetails.adminPin.label         &quot;Change PIN&quot;&gt;</span>
<a href="#l16.169"></a><span id="l16.169"> &lt;!ENTITY enigmail.cardDetails.genCardKey.label       &quot;Generate Key&quot;&gt;</span>
<a href="#l16.170"></a><span id="l16.170"> </span>
<a href="#l16.171"></a><span id="l16.171"> &lt;!ENTITY enigmail.cardDetails.vendor.label           &quot;Manufacturer&quot;&gt;</span>
<a href="#l16.172"></a><span id="l16.172"> &lt;!ENTITY enigmail.cardDetails.serial.label           &quot;Serial Number&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -243,35 +243,35 @@ attachOwnKeyYes=Your own public key will</span>
<a href="#l17.4"></a><span id="l17.4"> attachOwnKeyDisabled=Your own public key cannot be attached. You have to select a specific key\nin the OpenPGP section of the Account Settings to enable this feature.</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> rulesConflict=Conflicting per-recipient rules detected\n%S\n\nSend message with these settings?</span>
<a href="#l17.7"></a><span id="l17.7"> msgCompose.button.configure=&amp;Configure</span>
<a href="#l17.8"></a><span id="l17.8"> msgCompose.button.send=&amp;Send Message</span>
<a href="#l17.9"></a><span id="l17.9"> msgCompose.button.save=&amp;Save Message</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> # Strings in enigmailMsgHdrViewOverlay.js</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-keyNeeded=Public key %S needed to verify signature</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-keyUsed=Public key %S used to verify signature</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+signatureFrom=Signature from public key %S</span>
<a href="#l17.15"></a><span id="l17.15"> clickDecrypt=; use 'Decrypt/Verify' function</span>
<a href="#l17.16"></a><span id="l17.16"> clickDecryptRetry=; use 'Decrypt/Verify' function to retry</span>
<a href="#l17.17"></a><span id="l17.17"> clickDetailsButton=; click on 'Details' button for more information</span>
<a href="#l17.18"></a><span id="l17.18"> clickImportButton=; click on the 'Import Key' button to import the key</span>
<a href="#l17.19"></a><span id="l17.19"> keyTypeUnsupported=; the key type is not supported by your version of GnuPG</span>
<a href="#l17.20"></a><span id="l17.20"> decryptManually=; click on the 'Decrypt' button to decrypt the message</span>
<a href="#l17.21"></a><span id="l17.21"> verifyManually=; click on the 'Verify' button to verify the signature</span>
<a href="#l17.22"></a><span id="l17.22"> headerView.button.verify=Verify</span>
<a href="#l17.23"></a><span id="l17.23"> headerView.button.decrypt=Decrypt</span>
<a href="#l17.24"></a><span id="l17.24"> msgPart=Part of the message %S</span>
<a href="#l17.25"></a><span id="l17.25"> msgSigned=signed</span>
<a href="#l17.26"></a><span id="l17.26"> msgSignedUnkownKey=signed with unknown key</span>
<a href="#l17.27"></a><span id="l17.27"> msgEncrypted=encrypted</span>
<a href="#l17.28"></a><span id="l17.28"> msgSignedAndEnc=signed and encrypted</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> goodSig=Good signature</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-unverifiedSig=Unverified signature</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+uncertainSig=Uncertain signature</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+badSig=Bad signature</span>
<a href="#l17.34"></a><span id="l17.34"> incompleteDecrypt=Decryption incomplete</span>
<a href="#l17.35"></a><span id="l17.35"> needKey=Error - no matching secret key found to decrypt message</span>
<a href="#l17.36"></a><span id="l17.36"> failedDecrypt=Error - decryption failed</span>
<a href="#l17.37"></a><span id="l17.37"> badPhrase=Error - bad passphrase</span>
<a href="#l17.38"></a><span id="l17.38"> missingMdcError=Error - missing or broken integrity protection (MDC)</span>
<a href="#l17.39"></a><span id="l17.39"> failedDecryptVerify=Error - decryption/verification failed</span>
<a href="#l17.40"></a><span id="l17.40"> viewInfo=; View &gt; Message security info for details</span>
<a href="#l17.41"></a><span id="l17.41"> brokenExchangeMessage=Broken PGP/MIME message from MS-Exchange.</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineat">@@ -479,17 +479,16 @@ deleteKeyFailed=The key could not be del</span>
<a href="#l17.43"></a><span id="l17.43"> revokeKeyQuestion=You are about to revoke the key '%S'.\n\nYou will no longer be able to sign with this key, and once distributed, others will no longer be able to encrypt with that key. You can still use the key to decrypt old messages.\n\nDo you want to proceed?</span>
<a href="#l17.44"></a><span id="l17.44"> revokeKeyOk=The key has been revoked. If your key is available on a key server, it is recommended to re-upload it, so that others can see the revocation.</span>
<a href="#l17.45"></a><span id="l17.45"> revokeKeyFailed=The key could not be revoked.</span>
<a href="#l17.46"></a><span id="l17.46"> revokeKeyNotPresent=You have no key (0x%S) which matches this revocation certificate!\n\nIf you have lost your key, you must import it (e.g. from a keyserver) before importing the revocation certificate!</span>
<a href="#l17.47"></a><span id="l17.47"> revokeKeyAlreadyRevoked=The key 0x%S has already been revoked.</span>
<a href="#l17.48"></a><span id="l17.48"> refreshAllQuestion=You did not select any key. Would you like to refresh ALL keys?</span>
<a href="#l17.49"></a><span id="l17.49"> refreshKeyServiceOn.warn=Warning: Your keys are currently being refreshed in the background as safely as possible.\nRefreshing all your keys at once will unnecessarily reveal information about you.\nDo you really want to do this?</span>
<a href="#l17.50"></a><span id="l17.50"> refreshKey.warn=Warning: depending on the number of keys and the connection speed, refreshing all keys could be quite a lengthy process!</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-downloadContactsKeys.warn=Warning: depending on the number of contacts and the connection speed, downloading all keys could be quite a lengthy process!</span>
<a href="#l17.52"></a><span id="l17.52"> downloadContactsKeys.importFrom=Import contacts from address book '%S'?</span>
<a href="#l17.53"></a><span id="l17.53"> keyMan.button.exportSecKey=Export &amp;Secret Keys</span>
<a href="#l17.54"></a><span id="l17.54"> keyMan.button.exportPubKey=Export &amp;Public Keys Only</span>
<a href="#l17.55"></a><span id="l17.55"> keyMan.button.import=&amp;Import</span>
<a href="#l17.56"></a><span id="l17.56"> keyMan.button.refreshAll=&amp;Refresh All Keys</span>
<a href="#l17.57"></a><span id="l17.57"> keyMan.button.revokeKey=&amp;Revoke Key</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59"> keylist.noOtherUids=Has no other identities</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineat">@@ -519,32 +518,36 @@ importInfoCreated=Created</span>
<a href="#l17.61"></a><span id="l17.61"> importInfoFpr=Fingerprint</span>
<a href="#l17.62"></a><span id="l17.62"> importInfoDetails=(Details)</span>
<a href="#l17.63"></a><span id="l17.63"> importInfoNoKeys=No keys imported.</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65"> # Strings in enigmailKeyDetailsDlg.xhtml</span>
<a href="#l17.66"></a><span id="l17.66"> keyTypePublic=public key</span>
<a href="#l17.67"></a><span id="l17.67"> keyTypePrimary=primary key</span>
<a href="#l17.68"></a><span id="l17.68"> keyTypeSubkey=subkey</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-keyTypePair=key pair</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+keyTypePair2=personal key (secret key and public key)</span>
<a href="#l17.71"></a><span id="l17.71"> keyExpiryNever=never</span>
<a href="#l17.72"></a><span id="l17.72"> keyAlgorithm_1=RSA</span>
<a href="#l17.73"></a><span id="l17.73"> keyAlgorithm_2=RSA</span>
<a href="#l17.74"></a><span id="l17.74"> keyAlgorithm_3=RSA</span>
<a href="#l17.75"></a><span id="l17.75"> keyAlgorithm_16=ELG</span>
<a href="#l17.76"></a><span id="l17.76"> keyAlgorithm_17=DSA</span>
<a href="#l17.77"></a><span id="l17.77"> keyAlgorithm_18=ECDH</span>
<a href="#l17.78"></a><span id="l17.78"> keyAlgorithm_19=ECDSA</span>
<a href="#l17.79"></a><span id="l17.79"> keyAlgorithm_20=ELG</span>
<a href="#l17.80"></a><span id="l17.80"> keyAlgorithm_22=EDDSA</span>
<a href="#l17.81"></a><span id="l17.81"> keyUsageEncrypt=Encrypt</span>
<a href="#l17.82"></a><span id="l17.82"> keyUsageSign=Sign</span>
<a href="#l17.83"></a><span id="l17.83"> keyUsageCertify=Certify</span>
<a href="#l17.84"></a><span id="l17.84"> keyUsageAuthentication=Authentication</span>
<a href="#l17.85"></a><span id="l17.85"> keyDoesNotExpire=Key does not expire</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+keyExpired=Key expired on %S</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+keyRevoked=Key was revoked</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+keyAutoAcceptPersonal=You accept this key for all uses, because it is one of your personal keys. (You have the secret key.)</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+keyDoYouAccept=Do you accept this key for verifying digital signatures and for encrypting messages?</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91"> # Strings in enigmailGenCardKey.xhtml</span>
<a href="#l17.92"></a><span id="l17.92"> keygen.started=Please wait while the key is being generated ....</span>
<a href="#l17.93"></a><span id="l17.93"> keygen.completed=Key Generated. The new Key ID is: 0x%S</span>
<a href="#l17.94"></a><span id="l17.94"> keygen.keyBackup=The key is backed up as %S</span>
<a href="#l17.95"></a><span id="l17.95"> keygen.passRequired=Please specify a passphrase if you want to create a backup copy of your key outside your SmartCard.</span>
<a href="#l17.96"></a><span id="l17.96"> </span>
<a href="#l17.97"></a><span id="l17.97"> # Strings in enigmailSetCardPin.xhtml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -212,55 +212,45 @@ function getSelectedKeyIds() {</span>
<a href="#l18.4"></a><span id="l18.4">   }</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">   return a;</span>
<a href="#l18.7"></a><span id="l18.7"> }</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> function enigmailKeyMenu() {</span>
<a href="#l18.10"></a><span id="l18.10">   var keyList = getSelectedKeys();</span>
<a href="#l18.11"></a><span id="l18.11">   if (keyList.length == 1 &amp;&amp; gKeyList[keyList[0]].secretAvailable) {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    document.getElementById(&quot;bcUploadToWkd&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.13"></a><span id="l18.13">     document.getElementById(&quot;bcRevoke&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l18.14"></a><span id="l18.14">     document.getElementById(&quot;bcEditKey&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l18.15"></a><span id="l18.15">   } else {</span>
<a href="#l18.16"></a><span id="l18.16">     document.getElementById(&quot;bcRevoke&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.17"></a><span id="l18.17">     document.getElementById(&quot;bcEditKey&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-    document.getElementById(&quot;bcUploadToWkd&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.19"></a><span id="l18.19">   }</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">   if (keyList.length == 1 &amp;&amp; gKeyList[keyList[0]].photoAvailable) {</span>
<a href="#l18.22"></a><span id="l18.22">     document.getElementById(&quot;bcViewPhoto&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l18.23"></a><span id="l18.23">   } else {</span>
<a href="#l18.24"></a><span id="l18.24">     document.getElementById(&quot;bcViewPhoto&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.25"></a><span id="l18.25">   }</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   if (enigGetClipboard().length &gt; 0) {</span>
<a href="#l18.28"></a><span id="l18.28">     document.getElementById(&quot;bcClipbrd&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.29"></a><span id="l18.29">   } else {</span>
<a href="#l18.30"></a><span id="l18.30">     document.getElementById(&quot;bcClipbrd&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.31"></a><span id="l18.31">   }</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  if (keyList.length == 1 &amp;&amp; gKeyList[keyList[0]].isOwnerTrustUseful()) {</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    document.getElementById(&quot;bcSetTrust&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  } else {</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    document.getElementById(&quot;bcSetTrust&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  }</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-</span>
<a href="#l18.39"></a><span id="l18.39">   if (keyList.length == 1) {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-    document.getElementById(&quot;bcSignKey&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.41"></a><span id="l18.41">     document.getElementById(&quot;bcOneKey&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.42"></a><span id="l18.42">     document.getElementById(&quot;bcDeleteKey&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.43"></a><span id="l18.43">     document.getElementById(&quot;bcNoKey&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.44"></a><span id="l18.44">   } else {</span>
<a href="#l18.45"></a><span id="l18.45">     if (keyList.length === 0) {</span>
<a href="#l18.46"></a><span id="l18.46">       document.getElementById(&quot;bcNoKey&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.47"></a><span id="l18.47">     } else {</span>
<a href="#l18.48"></a><span id="l18.48">       document.getElementById(&quot;bcNoKey&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.49"></a><span id="l18.49">     }</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    document.getElementById(&quot;bcSignKey&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.51"></a><span id="l18.51">     document.getElementById(&quot;bcOneKey&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.52"></a><span id="l18.52">     document.getElementById(&quot;bcDeleteKey&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.53"></a><span id="l18.53">   }</span>
<a href="#l18.54"></a><span id="l18.54"> }</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56"> function onListClick(event) {</span>
<a href="#l18.57"></a><span id="l18.57">   if (event.detail &gt; 2) {</span>
<a href="#l18.58"></a><span id="l18.58">     return;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineat">@@ -277,38 +267,17 @@ function onListClick(event) {</span>
<a href="#l18.60"></a><span id="l18.60">   }</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">   if (event.detail != 2) {</span>
<a href="#l18.63"></a><span id="l18.63">     return;</span>
<a href="#l18.64"></a><span id="l18.64">   }</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">   // do not propagate double clicks</span>
<a href="#l18.67"></a><span id="l18.67">   event.stopPropagation();</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-  var keyList = getSelectedKeys();</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  var keyType = &quot;&quot;;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-  var uatNum = &quot;&quot;;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  if (keyList.length == 1) {</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-    var start = {};</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-    var end = {};</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-    gUserList.view.selection.getRangeAt(0, start, end);</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-    try {</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-      keyType = gUserList.view</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-        .getItemAtIndex(start.value)</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-        .getAttribute(&quot;keytype&quot;);</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-      uatNum = gUserList.view</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-        .getItemAtIndex(start.value)</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-        .getAttribute(&quot;uatNum&quot;);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-  }</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  if (keyType == &quot;uat&quot;) {</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-    enigShowSpecificPhoto(Number(uatNum));</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-  } else {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-    enigmailKeyDetails();</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-  }</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  enigmailKeyDetails();</span>
<a href="#l18.91"></a><span id="l18.91"> }</span>
<a href="#l18.92"></a><span id="l18.92"> </span>
<a href="#l18.93"></a><span id="l18.93"> function enigmailSelectAllKeys() {</span>
<a href="#l18.94"></a><span id="l18.94">   gUserList.view.selection.selectAll();</span>
<a href="#l18.95"></a><span id="l18.95"> }</span>
<a href="#l18.96"></a><span id="l18.96"> </span>
<a href="#l18.97"></a><span id="l18.97"> function enigmailKeyDetails() {</span>
<a href="#l18.98"></a><span id="l18.98">   var keyList = getSelectedKeys();</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineat">@@ -380,56 +349,16 @@ function enigmailDeleteKey() {</span>
<a href="#l18.100"></a><span id="l18.100"> </span>
<a href="#l18.101"></a><span id="l18.101">   const cApi = EnigmailCryptoAPI();</span>
<a href="#l18.102"></a><span id="l18.102">   for (let j in keyList) {</span>
<a href="#l18.103"></a><span id="l18.103">     cApi.sync(cApi.deleteKey(gKeyList[keyList[j]].fpr, deleteSecret));</span>
<a href="#l18.104"></a><span id="l18.104">   }</span>
<a href="#l18.105"></a><span id="l18.105">   clearKeyCache();</span>
<a href="#l18.106"></a><span id="l18.106"> }</span>
<a href="#l18.107"></a><span id="l18.107"> </span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-function enigShowPhoto() {</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-  var keyList = getSelectedKeys();</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-  var keyType = &quot;&quot;;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-  var uatNum = &quot;&quot;;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-  if (keyList.length == 1) {</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-    var start = {};</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-    var end = {};</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-    gUserList.view.selection.getRangeAt(0, start, end);</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-    try {</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-      keyType = gUserList.view</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-        .getItemAtIndex(start.value)</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-        .getAttribute(&quot;keytype&quot;);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-      uatNum = gUserList.view</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-        .getItemAtIndex(start.value)</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-        .getAttribute(&quot;uatNum&quot;);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-    if (keyType == &quot;uat&quot;) {</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-      enigShowSpecificPhoto(uatNum);</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-      return;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-    }</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-  }</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-  enigShowSpecificPhoto(null);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-}</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-function enigShowSpecificPhoto(uatNumber) {</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-  var keyList = getSelectedKeys();</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  EnigShowPhoto(</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    gKeyList[keyList[0]].keyId,</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-    gKeyList[keyList[0]].userId,</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-    uatNumber</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-  );</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-}</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-function keyMgrAddPhoto(userId, keyId) {</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-}</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-</span>
<a href="#l18.148"></a><span id="l18.148"> function enigCreateKeyMsg() {</span>
<a href="#l18.149"></a><span id="l18.149">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l18.150"></a><span id="l18.150">   if (!enigmailSvc) {</span>
<a href="#l18.151"></a><span id="l18.151">     return;</span>
<a href="#l18.152"></a><span id="l18.152">   }</span>
<a href="#l18.153"></a><span id="l18.153"> </span>
<a href="#l18.154"></a><span id="l18.154">   var keyList = getSelectedKeyIds();</span>
<a href="#l18.155"></a><span id="l18.155">   if (keyList.length === 0) {</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineat">@@ -552,16 +481,17 @@ function createNewMail() {</span>
<a href="#l18.157"></a><span id="l18.157">   msgCompParam.composeFields = msgCompFields;</span>
<a href="#l18.158"></a><span id="l18.158">   msgCompParam.identity = EnigmailFuncs.getDefaultIdentity();</span>
<a href="#l18.159"></a><span id="l18.159">   msgCompParam.type = Ci.nsIMsgCompType.New;</span>
<a href="#l18.160"></a><span id="l18.160">   msgCompParam.format = Ci.nsIMsgCompFormat.Default;</span>
<a href="#l18.161"></a><span id="l18.161">   msgCompParam.originalMsgURI = &quot;&quot;;</span>
<a href="#l18.162"></a><span id="l18.162">   msgCompSvc.OpenComposeWindowWithParams(&quot;&quot;, msgCompParam);</span>
<a href="#l18.163"></a><span id="l18.163"> }</span>
<a href="#l18.164"></a><span id="l18.164"> </span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+/*</span>
<a href="#l18.166"></a><span id="l18.166"> function enigEditKeyTrust() {</span>
<a href="#l18.167"></a><span id="l18.167">   var keyList = getSelectedKeys();</span>
<a href="#l18.168"></a><span id="l18.168">   if (keyList.length === 0) {</span>
<a href="#l18.169"></a><span id="l18.169">     EnigmailDialog.info(window, EnigGetString(&quot;noKeySelected&quot;));</span>
<a href="#l18.170"></a><span id="l18.170">     return;</span>
<a href="#l18.171"></a><span id="l18.171">   }</span>
<a href="#l18.172"></a><span id="l18.172">   var userIdList = [];</span>
<a href="#l18.173"></a><span id="l18.173">   var keyIds = [];</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineat">@@ -569,17 +499,19 @@ function enigEditKeyTrust() {</span>
<a href="#l18.175"></a><span id="l18.175">     userIdList.push(gKeyList[keyList[i]].userId);</span>
<a href="#l18.176"></a><span id="l18.176">     keyIds.push(gKeyList[keyList[i]].keyId);</span>
<a href="#l18.177"></a><span id="l18.177">   }</span>
<a href="#l18.178"></a><span id="l18.178"> </span>
<a href="#l18.179"></a><span id="l18.179">   if (EnigEditKeyTrust(userIdList, keyIds)) {</span>
<a href="#l18.180"></a><span id="l18.180">     refreshKeys();</span>
<a href="#l18.181"></a><span id="l18.181">   }</span>
<a href="#l18.182"></a><span id="l18.182"> }</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+*/</span>
<a href="#l18.184"></a><span id="l18.184"> </span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+/*</span>
<a href="#l18.186"></a><span id="l18.186"> function enigEditKeyExpiry() {</span>
<a href="#l18.187"></a><span id="l18.187">   var keyList = getSelectedKeys();</span>
<a href="#l18.188"></a><span id="l18.188">   if (keyList.length === 0) {</span>
<a href="#l18.189"></a><span id="l18.189">     EnigmailDialog.info(window, EnigGetString(&quot;noKeySelected&quot;));</span>
<a href="#l18.190"></a><span id="l18.190">     return;</span>
<a href="#l18.191"></a><span id="l18.191">   }</span>
<a href="#l18.192"></a><span id="l18.192">   var userIdList = [];</span>
<a href="#l18.193"></a><span id="l18.193">   var keyIds = [];</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineat">@@ -587,30 +519,34 @@ function enigEditKeyExpiry() {</span>
<a href="#l18.195"></a><span id="l18.195">     userIdList.push(gKeyList[keyList[i]].userId);</span>
<a href="#l18.196"></a><span id="l18.196">     keyIds.push(gKeyList[keyList[i]].keyId);</span>
<a href="#l18.197"></a><span id="l18.197">   }</span>
<a href="#l18.198"></a><span id="l18.198"> </span>
<a href="#l18.199"></a><span id="l18.199">   if (EnigEditKeyExpiry(userIdList, keyIds)) {</span>
<a href="#l18.200"></a><span id="l18.200">     refreshKeys();</span>
<a href="#l18.201"></a><span id="l18.201">   }</span>
<a href="#l18.202"></a><span id="l18.202"> }</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+*/</span>
<a href="#l18.204"></a><span id="l18.204"> </span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+/*</span>
<a href="#l18.206"></a><span id="l18.206"> function enigSignKey() {</span>
<a href="#l18.207"></a><span id="l18.207">   var keyList = getSelectedKeys();</span>
<a href="#l18.208"></a><span id="l18.208">   if (keyList.length === 0) {</span>
<a href="#l18.209"></a><span id="l18.209">     EnigmailDialog.info(window, EnigGetString(&quot;noKeySelected&quot;));</span>
<a href="#l18.210"></a><span id="l18.210">     return;</span>
<a href="#l18.211"></a><span id="l18.211">   }</span>
<a href="#l18.212"></a><span id="l18.212">   if (</span>
<a href="#l18.213"></a><span id="l18.213">     EnigSignKey(gKeyList[keyList[0]].userId, gKeyList[keyList[0]].keyId, null)</span>
<a href="#l18.214"></a><span id="l18.214">   ) {</span>
<a href="#l18.215"></a><span id="l18.215">     refreshKeys();</span>
<a href="#l18.216"></a><span id="l18.216">   }</span>
<a href="#l18.217"></a><span id="l18.217"> }</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+*/</span>
<a href="#l18.219"></a><span id="l18.219"> </span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+/*</span>
<a href="#l18.221"></a><span id="l18.221"> function enigmailRevokeKey() {</span>
<a href="#l18.222"></a><span id="l18.222">   var keyList = getSelectedKeys();</span>
<a href="#l18.223"></a><span id="l18.223">   EnigRevokeKey(</span>
<a href="#l18.224"></a><span id="l18.224">     gKeyList[keyList[0]].keyId,</span>
<a href="#l18.225"></a><span id="l18.225">     gKeyList[keyList[0]].userId,</span>
<a href="#l18.226"></a><span id="l18.226">     function(success) {</span>
<a href="#l18.227"></a><span id="l18.227">       if (success) {</span>
<a href="#l18.228"></a><span id="l18.228">         refreshKeys();</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineat">@@ -619,16 +555,17 @@ function enigmailRevokeKey() {</span>
<a href="#l18.230"></a><span id="l18.230">   );</span>
<a href="#l18.231"></a><span id="l18.231"> }</span>
<a href="#l18.232"></a><span id="l18.232"> </span>
<a href="#l18.233"></a><span id="l18.233"> function enigCreateRevokeCert() {</span>
<a href="#l18.234"></a><span id="l18.234">   var keyList = getSelectedKeys();</span>
<a href="#l18.235"></a><span id="l18.235"> </span>
<a href="#l18.236"></a><span id="l18.236">   EnigCreateRevokeCert(gKeyList[keyList[0]].keyId, gKeyList[keyList[0]].userId);</span>
<a href="#l18.237"></a><span id="l18.237"> }</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+*/</span>
<a href="#l18.239"></a><span id="l18.239"> </span>
<a href="#l18.240"></a><span id="l18.240"> function enigmailExportKeys() {</span>
<a href="#l18.241"></a><span id="l18.241">   var keyList = getSelectedKeys();</span>
<a href="#l18.242"></a><span id="l18.242">   if (keyList.length === 0) {</span>
<a href="#l18.243"></a><span id="l18.243">     EnigmailDialog.info(window, EnigGetString(&quot;noKeySelected&quot;));</span>
<a href="#l18.244"></a><span id="l18.244">     return;</span>
<a href="#l18.245"></a><span id="l18.245">   }</span>
<a href="#l18.246"></a><span id="l18.246"> </span>
<a href="#l18.247"></a><span id="l18.247" class="difflineat">@@ -722,16 +659,17 @@ function enigmailExportKeys() {</span>
<a href="#l18.248"></a><span id="l18.248">   );</span>
<a href="#l18.249"></a><span id="l18.249">   if (exitCodeObj.value !== 0) {</span>
<a href="#l18.250"></a><span id="l18.250">     EnigAlert(EnigGetString(&quot;saveKeysFailed&quot;) + &quot;\n\n&quot; + errorMsgObj.value);</span>
<a href="#l18.251"></a><span id="l18.251">   } else {</span>
<a href="#l18.252"></a><span id="l18.252">     EnigmailDialog.info(window, EnigGetString(&quot;saveKeysOK&quot;));</span>
<a href="#l18.253"></a><span id="l18.253">   }</span>
<a href="#l18.254"></a><span id="l18.254"> }</span>
<a href="#l18.255"></a><span id="l18.255"> </span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+/*</span>
<a href="#l18.257"></a><span id="l18.257"> function enigmailManageUids() {</span>
<a href="#l18.258"></a><span id="l18.258">   var keyList = getSelectedKeys();</span>
<a href="#l18.259"></a><span id="l18.259">   var inputObj = {</span>
<a href="#l18.260"></a><span id="l18.260">     keyId: gKeyList[keyList[0]].keyId,</span>
<a href="#l18.261"></a><span id="l18.261">     ownKey: gKeyList[keyList[0]].secretAvailable,</span>
<a href="#l18.262"></a><span id="l18.262">   };</span>
<a href="#l18.263"></a><span id="l18.263">   var resultObj = {</span>
<a href="#l18.264"></a><span id="l18.264">     refresh: false,</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineat">@@ -742,21 +680,24 @@ function enigmailManageUids() {</span>
<a href="#l18.266"></a><span id="l18.266">     &quot;dialog,modal,centerscreen,resizable=yes&quot;,</span>
<a href="#l18.267"></a><span id="l18.267">     inputObj,</span>
<a href="#l18.268"></a><span id="l18.268">     resultObj</span>
<a href="#l18.269"></a><span id="l18.269">   );</span>
<a href="#l18.270"></a><span id="l18.270">   if (resultObj.refresh) {</span>
<a href="#l18.271"></a><span id="l18.271">     refreshKeys();</span>
<a href="#l18.272"></a><span id="l18.272">   }</span>
<a href="#l18.273"></a><span id="l18.273"> }</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+*/</span>
<a href="#l18.275"></a><span id="l18.275"> </span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+/*</span>
<a href="#l18.277"></a><span id="l18.277"> function enigmailChangePwd() {</span>
<a href="#l18.278"></a><span id="l18.278">   var keyList = getSelectedKeys();</span>
<a href="#l18.279"></a><span id="l18.279">   EnigChangeKeyPwd(gKeyList[keyList[0]].keyId, gKeyList[keyList[0]].userId);</span>
<a href="#l18.280"></a><span id="l18.280"> }</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineplus">+*/</span>
<a href="#l18.282"></a><span id="l18.282"> </span>
<a href="#l18.283"></a><span id="l18.283"> function enigGetClipboard() {</span>
<a href="#l18.284"></a><span id="l18.284">   return EnigmailClipboard.getClipboardContent(</span>
<a href="#l18.285"></a><span id="l18.285">     window,</span>
<a href="#l18.286"></a><span id="l18.286">     Ci.nsIClipboard.kGlobalClipboard</span>
<a href="#l18.287"></a><span id="l18.287">   );</span>
<a href="#l18.288"></a><span id="l18.288"> }</span>
<a href="#l18.289"></a><span id="l18.289"> </span>
<a href="#l18.290"></a><span id="l18.290" class="difflineat">@@ -845,16 +786,17 @@ function enigmailCopyToClipbrd() {</span>
<a href="#l18.291"></a><span id="l18.291">       &quot;enigmailKeyManager.js: enigmailImportFromClipbrd: set clipboard data\n&quot;</span>
<a href="#l18.292"></a><span id="l18.292">     );</span>
<a href="#l18.293"></a><span id="l18.293">     EnigmailDialog.info(window, EnigGetString(&quot;copyToClipbrdOK&quot;));</span>
<a href="#l18.294"></a><span id="l18.294">   } else {</span>
<a href="#l18.295"></a><span id="l18.295">     EnigAlert(EnigGetString(&quot;copyToClipbrdFailed&quot;));</span>
<a href="#l18.296"></a><span id="l18.296">   }</span>
<a href="#l18.297"></a><span id="l18.297"> }</span>
<a href="#l18.298"></a><span id="l18.298"> </span>
<a href="#l18.299"></a><span id="l18.299" class="difflineplus">+/*</span>
<a href="#l18.300"></a><span id="l18.300"> function enigmailSearchKey() {</span>
<a href="#l18.301"></a><span id="l18.301">   var inputObj = {</span>
<a href="#l18.302"></a><span id="l18.302">     searchList: null,</span>
<a href="#l18.303"></a><span id="l18.303">   };</span>
<a href="#l18.304"></a><span id="l18.304">   var resultObj = {};</span>
<a href="#l18.305"></a><span id="l18.305"> </span>
<a href="#l18.306"></a><span id="l18.306">   EnigDownloadKeys(inputObj, resultObj);</span>
<a href="#l18.307"></a><span id="l18.307"> </span>
<a href="#l18.308"></a><span id="l18.308" class="difflineat">@@ -904,20 +846,23 @@ function enigmailUploadToWkd() {</span>
<a href="#l18.309"></a><span id="l18.309">       }</span>
<a href="#l18.310"></a><span id="l18.310">     })</span>
<a href="#l18.311"></a><span id="l18.311">     .catch(error =&gt; {</span>
<a href="#l18.312"></a><span id="l18.312">       EnigmailDialog.alert(</span>
<a href="#l18.313"></a><span id="l18.313">         window.EnigmailLocale.getString(&quot;sendKeysFailed&quot;) + &quot;\n&quot; + error</span>
<a href="#l18.314"></a><span id="l18.314">       );</span>
<a href="#l18.315"></a><span id="l18.315">     });</span>
<a href="#l18.316"></a><span id="l18.316"> }</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+*/</span>
<a href="#l18.318"></a><span id="l18.318"> </span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+/*</span>
<a href="#l18.320"></a><span id="l18.320"> function enigmailReceiveKey() {</span>
<a href="#l18.321"></a><span id="l18.321">   accessKeyServer(EnigmailConstants.DOWNLOAD_KEY, enigmailReceiveKeyCb);</span>
<a href="#l18.322"></a><span id="l18.322"> }</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineplus">+*/</span>
<a href="#l18.324"></a><span id="l18.324"> </span>
<a href="#l18.325"></a><span id="l18.325"> function userAcceptsWarning(warningMessage) {</span>
<a href="#l18.326"></a><span id="l18.326">   if (!EnigGetPref(&quot;warnRefreshAll&quot;)) {</span>
<a href="#l18.327"></a><span id="l18.327">     return true;</span>
<a href="#l18.328"></a><span id="l18.328">   }</span>
<a href="#l18.329"></a><span id="l18.329"> </span>
<a href="#l18.330"></a><span id="l18.330">   let checkedObj = {};</span>
<a href="#l18.331"></a><span id="l18.331"> </span>
<a href="#l18.332"></a><span id="l18.332" class="difflineat">@@ -936,29 +881,32 @@ function userAcceptsWarning(warningMessa</span>
<a href="#l18.333"></a><span id="l18.333">     ) === 0;</span>
<a href="#l18.334"></a><span id="l18.334"> </span>
<a href="#l18.335"></a><span id="l18.335">   if (checkedObj.value) {</span>
<a href="#l18.336"></a><span id="l18.336">     EnigSetPref(&quot;warnRefreshAll&quot;, false);</span>
<a href="#l18.337"></a><span id="l18.337">   }</span>
<a href="#l18.338"></a><span id="l18.338">   return confirm;</span>
<a href="#l18.339"></a><span id="l18.339"> }</span>
<a href="#l18.340"></a><span id="l18.340"> </span>
<a href="#l18.341"></a><span id="l18.341" class="difflineplus">+/*</span>
<a href="#l18.342"></a><span id="l18.342"> function userAcceptsRefreshWarning() {</span>
<a href="#l18.343"></a><span id="l18.343">   if (EnigmailPrefs.getPref(&quot;keyRefreshOn&quot;) === true) {</span>
<a href="#l18.344"></a><span id="l18.344">     return userAcceptsWarning(EnigGetString(&quot;refreshKeyServiceOn.warn&quot;));</span>
<a href="#l18.345"></a><span id="l18.345">   }</span>
<a href="#l18.346"></a><span id="l18.346">   return userAcceptsWarning(EnigGetString(&quot;refreshKey.warn&quot;));</span>
<a href="#l18.347"></a><span id="l18.347"> }</span>
<a href="#l18.348"></a><span id="l18.348"> </span>
<a href="#l18.349"></a><span id="l18.349"> function enigmailRefreshAllKeys() {</span>
<a href="#l18.350"></a><span id="l18.350">   if (userAcceptsRefreshWarning() === true) {</span>
<a href="#l18.351"></a><span id="l18.351">     accessKeyServer(EnigmailConstants.REFRESH_KEY, enigmailReceiveKeyCb);</span>
<a href="#l18.352"></a><span id="l18.352">   }</span>
<a href="#l18.353"></a><span id="l18.353"> }</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineplus">+*/</span>
<a href="#l18.355"></a><span id="l18.355"> </span>
<a href="#l18.356"></a><span id="l18.356" class="difflineplus">+/*</span>
<a href="#l18.357"></a><span id="l18.357"> // Iterate through contact emails and download them</span>
<a href="#l18.358"></a><span id="l18.358"> function enigmailDowloadContactKeysEngine() {</span>
<a href="#l18.359"></a><span id="l18.359">   let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l18.360"></a><span id="l18.360">   let emails = [];</span>
<a href="#l18.361"></a><span id="l18.361"> </span>
<a href="#l18.362"></a><span id="l18.362">   for (let addressBook of abManager.directories) {</span>
<a href="#l18.363"></a><span id="l18.363">     if (addressBook instanceof Ci.nsIAbDirectory) {</span>
<a href="#l18.364"></a><span id="l18.364">       // or nsIAbItem or nsIAbCollection</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineat">@@ -1032,21 +980,23 @@ function enigmailDownloadContactKeys() {</span>
<a href="#l18.366"></a><span id="l18.366">     EnigGetString(&quot;dlg.button.continue&quot;),</span>
<a href="#l18.367"></a><span id="l18.367">     EnigGetString(&quot;dlg.button.cancel&quot;)</span>
<a href="#l18.368"></a><span id="l18.368">   );</span>
<a href="#l18.369"></a><span id="l18.369"> </span>
<a href="#l18.370"></a><span id="l18.370">   if (doIt) {</span>
<a href="#l18.371"></a><span id="l18.371">     enigmailDowloadContactKeysEngine();</span>
<a href="#l18.372"></a><span id="l18.372">   }</span>
<a href="#l18.373"></a><span id="l18.373"> }</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineplus">+*/</span>
<a href="#l18.375"></a><span id="l18.375"> </span>
<a href="#l18.376"></a><span id="l18.376"> function displayResult(arrayOfMsgText) {</span>
<a href="#l18.377"></a><span id="l18.377">   EnigmailDialog.info(window, arrayOfMsgText.join(&quot;\n&quot;));</span>
<a href="#l18.378"></a><span id="l18.378"> }</span>
<a href="#l18.379"></a><span id="l18.379"> </span>
<a href="#l18.380"></a><span id="l18.380" class="difflineplus">+/*</span>
<a href="#l18.381"></a><span id="l18.381"> function enigmailReceiveKeyCb(exitCode, errorMsg, msgBox) {</span>
<a href="#l18.382"></a><span id="l18.382">   EnigmailLog.DEBUG(&quot;enigmailKeyManager.js: enigmailReceiveKeyCb\n&quot;);</span>
<a href="#l18.383"></a><span id="l18.383">   if (msgBox) {</span>
<a href="#l18.384"></a><span id="l18.384">     if (exitCode === 0) {</span>
<a href="#l18.385"></a><span id="l18.385">       refreshKeys();</span>
<a href="#l18.386"></a><span id="l18.386">       EnigmailEvents.dispatchEvent(displayResult, 100, [</span>
<a href="#l18.387"></a><span id="l18.387">         EnigGetString(&quot;receiveKeysOk&quot;),</span>
<a href="#l18.388"></a><span id="l18.388">         errorMsg,</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineat">@@ -1059,16 +1009,17 @@ function enigmailReceiveKeyCb(exitCode, </span>
<a href="#l18.390"></a><span id="l18.390">     }</span>
<a href="#l18.391"></a><span id="l18.391">   } else {</span>
<a href="#l18.392"></a><span id="l18.392">     return EnigGetString(</span>
<a href="#l18.393"></a><span id="l18.393">       exitCode === 0 ? &quot;receiveKeysOk&quot; : &quot;receiveKeysFailed&quot;</span>
<a href="#l18.394"></a><span id="l18.394">     );</span>
<a href="#l18.395"></a><span id="l18.395">   }</span>
<a href="#l18.396"></a><span id="l18.396">   return &quot;&quot;;</span>
<a href="#l18.397"></a><span id="l18.397"> }</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineplus">+*/</span>
<a href="#l18.399"></a><span id="l18.399"> </span>
<a href="#l18.400"></a><span id="l18.400"> function enigmailImportKeysFromUrl() {</span>
<a href="#l18.401"></a><span id="l18.401">   var value = {</span>
<a href="#l18.402"></a><span id="l18.402">     value: &quot;&quot;,</span>
<a href="#l18.403"></a><span id="l18.403">   };</span>
<a href="#l18.404"></a><span id="l18.404">   if (</span>
<a href="#l18.405"></a><span id="l18.405">     EnigmailDialog.promptValue(window, EnigGetString(&quot;importFromUrl&quot;), value)</span>
<a href="#l18.406"></a><span id="l18.406">   ) {</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineat">@@ -1338,22 +1289,16 @@ function sortTree(column) {</span>
<a href="#l18.408"></a><span id="l18.408"> }</span>
<a href="#l18.409"></a><span id="l18.409"> </span>
<a href="#l18.410"></a><span id="l18.410"> function getSortColumn() {</span>
<a href="#l18.411"></a><span id="l18.411">   switch (gUserList.getAttribute(&quot;sortResource&quot;)) {</span>
<a href="#l18.412"></a><span id="l18.412">     case &quot;enigUserNameCol&quot;:</span>
<a href="#l18.413"></a><span id="l18.413">       return &quot;userid&quot;;</span>
<a href="#l18.414"></a><span id="l18.414">     case &quot;keyCol&quot;:</span>
<a href="#l18.415"></a><span id="l18.415">       return &quot;keyid&quot;;</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineminus">-    case &quot;typeCol&quot;:</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-      return &quot;keytype&quot;;</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineminus">-    case &quot;validityCol&quot;:</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineminus">-      return &quot;validity&quot;;</span>
<a href="#l18.420"></a><span id="l18.420" class="difflineminus">-    case &quot;trustCol&quot;:</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-      return &quot;trust&quot;; // ownerTrust</span>
<a href="#l18.422"></a><span id="l18.422">     case &quot;expCol&quot;:</span>
<a href="#l18.423"></a><span id="l18.423">       return &quot;expiry&quot;;</span>
<a href="#l18.424"></a><span id="l18.424">     case &quot;fprCol&quot;:</span>
<a href="#l18.425"></a><span id="l18.425">       return &quot;fpr&quot;;</span>
<a href="#l18.426"></a><span id="l18.426">     default:</span>
<a href="#l18.427"></a><span id="l18.427">       return &quot;?&quot;;</span>
<a href="#l18.428"></a><span id="l18.428">   }</span>
<a href="#l18.429"></a><span id="l18.429"> }</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineat">@@ -1393,17 +1338,16 @@ var gKeyListView = {</span>
<a href="#l18.431"></a><span id="l18.431"> </span>
<a href="#l18.432"></a><span id="l18.432">     let keyObj = gKeyList[r.keyNum];</span>
<a href="#l18.433"></a><span id="l18.433"> </span>
<a href="#l18.434"></a><span id="l18.434">     let keyTrustStyle = &quot;&quot;;</span>
<a href="#l18.435"></a><span id="l18.435"> </span>
<a href="#l18.436"></a><span id="l18.436">     switch (r.rowType) {</span>
<a href="#l18.437"></a><span id="l18.437">       case &quot;key&quot;:</span>
<a href="#l18.438"></a><span id="l18.438">       case &quot;uid&quot;:</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineminus">-      case &quot;uat&quot;:</span>
<a href="#l18.440"></a><span id="l18.440">         switch (keyObj.keyTrust) {</span>
<a href="#l18.441"></a><span id="l18.441">           case &quot;q&quot;:</span>
<a href="#l18.442"></a><span id="l18.442">             keyTrustStyle = &quot;enigmail_keyValid_unknown&quot;;</span>
<a href="#l18.443"></a><span id="l18.443">             break;</span>
<a href="#l18.444"></a><span id="l18.444">           case &quot;i&quot;:</span>
<a href="#l18.445"></a><span id="l18.445">             keyTrustStyle = &quot;enigmail_keyValid_invalid&quot;;</span>
<a href="#l18.446"></a><span id="l18.446">             break;</span>
<a href="#l18.447"></a><span id="l18.447">           case &quot;d&quot;:</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineat">@@ -1465,70 +1409,26 @@ var gKeyListView = {</span>
<a href="#l18.449"></a><span id="l18.449"> </span>
<a href="#l18.450"></a><span id="l18.450">     switch (r.rowType) {</span>
<a href="#l18.451"></a><span id="l18.451">       case &quot;key&quot;:</span>
<a href="#l18.452"></a><span id="l18.452">         switch (col.id) {</span>
<a href="#l18.453"></a><span id="l18.453">           case &quot;enigUserNameCol&quot;:</span>
<a href="#l18.454"></a><span id="l18.454">             return keyObj.userId;</span>
<a href="#l18.455"></a><span id="l18.455">           case &quot;keyCol&quot;:</span>
<a href="#l18.456"></a><span id="l18.456">             return keyObj.keyId;</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-          case &quot;typeCol&quot;:</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-            if (keyObj.secretAvailable) {</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-              return EnigmailLocale.getString(&quot;keyType.publicAndSec&quot;);</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-            }</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-            return EnigmailLocale.getString(&quot;keyType.public&quot;);</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineminus">-          case &quot;validityCol&quot;:</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineminus">-            if (keyObj.keyUseFor.includes(&quot;D&quot;)) {</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineminus">-              return EnigmailLocale.getString(&quot;keyValid.disabled&quot;);</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineminus">-            }</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineminus">-            return EnigGetTrustLabel(keyObj.keyTrust);</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineminus">-          case &quot;trustCol&quot;:</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineminus">-            return EnigGetTrustLabel(keyObj.ownerTrust);</span>
<a href="#l18.469"></a><span id="l18.469">           case &quot;expCol&quot;:</span>
<a href="#l18.470"></a><span id="l18.470">             return keyObj.expiry;</span>
<a href="#l18.471"></a><span id="l18.471">           case &quot;fprCol&quot;:</span>
<a href="#l18.472"></a><span id="l18.472">             return keyObj.fprFormatted;</span>
<a href="#l18.473"></a><span id="l18.473">         }</span>
<a href="#l18.474"></a><span id="l18.474">         break;</span>
<a href="#l18.475"></a><span id="l18.475">       case &quot;uid&quot;:</span>
<a href="#l18.476"></a><span id="l18.476">         switch (col.id) {</span>
<a href="#l18.477"></a><span id="l18.477">           case &quot;enigUserNameCol&quot;:</span>
<a href="#l18.478"></a><span id="l18.478">             return keyObj.userIds[r.uidNum].userId;</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-          case &quot;validityCol&quot;:</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineminus">-            if (keyObj.keyUseFor.includes(&quot;D&quot;) &gt;= 0) {</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineminus">-              return EnigmailLocale.getString(&quot;keyValid.disabled&quot;);</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineminus">-            }</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineminus">-            return EnigGetTrustLabel(keyObj.userIds[r.uidNum].keyTrust);</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineminus">-          case &quot;trustCol&quot;:</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineminus">-            return EnigGetTrustLabel(keyObj.ownerTrust);</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineminus">-        }</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-        break;</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-      case &quot;uidHdr&quot;:</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineminus">-        if (col.id === &quot;enigUserNameCol&quot;) {</span>
<a href="#l18.490"></a><span id="l18.490" class="difflineminus">-          return EnigmailLocale.getString(&quot;keylist.hasOtherUids&quot;);</span>
<a href="#l18.491"></a><span id="l18.491" class="difflineminus">-        }</span>
<a href="#l18.492"></a><span id="l18.492" class="difflineminus">-        break;</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineminus">-      case &quot;noUidHdr&quot;:</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineminus">-        if (col.id === &quot;enigUserNameCol&quot;) {</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineminus">-          return EnigmailLocale.getString(&quot;keylist.noOtherUids&quot;);</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineminus">-        }</span>
<a href="#l18.497"></a><span id="l18.497" class="difflineminus">-        break;</span>
<a href="#l18.498"></a><span id="l18.498" class="difflineminus">-      case &quot;uat&quot;:</span>
<a href="#l18.499"></a><span id="l18.499" class="difflineminus">-        if (col.id === &quot;enigUserNameCol&quot;) {</span>
<a href="#l18.500"></a><span id="l18.500" class="difflineminus">-          return EnigmailLocale.getString(&quot;userAtt.photo&quot;);</span>
<a href="#l18.501"></a><span id="l18.501" class="difflineminus">-        }</span>
<a href="#l18.502"></a><span id="l18.502" class="difflineminus">-        break;</span>
<a href="#l18.503"></a><span id="l18.503" class="difflineminus">-      case &quot;uatHdr&quot;:</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineminus">-        if (col.id === &quot;enigUserNameCol&quot;) {</span>
<a href="#l18.505"></a><span id="l18.505" class="difflineminus">-          return EnigmailLocale.getString(&quot;keylist.hasPhotos&quot;);</span>
<a href="#l18.506"></a><span id="l18.506" class="difflineminus">-        }</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineminus">-        break;</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineminus">-      case &quot;noUatHdr&quot;:</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineminus">-        if (col.id === &quot;enigUserNameCol&quot;) {</span>
<a href="#l18.510"></a><span id="l18.510" class="difflineminus">-          return EnigmailLocale.getString(&quot;keylist.noPhotos&quot;);</span>
<a href="#l18.511"></a><span id="l18.511">         }</span>
<a href="#l18.512"></a><span id="l18.512">         break;</span>
<a href="#l18.513"></a><span id="l18.513">     }</span>
<a href="#l18.514"></a><span id="l18.514"> </span>
<a href="#l18.515"></a><span id="l18.515">     return &quot;&quot;;</span>
<a href="#l18.516"></a><span id="l18.516">   },</span>
<a href="#l18.517"></a><span id="l18.517">   getCellValue(row, col) {</span>
<a href="#l18.518"></a><span id="l18.518">     return &quot;&quot;;</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineat">@@ -1554,24 +1454,18 @@ var gKeyListView = {</span>
<a href="#l18.520"></a><span id="l18.520">     let r = this.getFilteredRow(row);</span>
<a href="#l18.521"></a><span id="l18.521">     if (!r) {</span>
<a href="#l18.522"></a><span id="l18.522">       return 0;</span>
<a href="#l18.523"></a><span id="l18.523">     }</span>
<a href="#l18.524"></a><span id="l18.524"> </span>
<a href="#l18.525"></a><span id="l18.525">     switch (r.rowType) {</span>
<a href="#l18.526"></a><span id="l18.526">       case &quot;key&quot;:</span>
<a href="#l18.527"></a><span id="l18.527">         return 0;</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineminus">-      case &quot;uidHdr&quot;:</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineminus">-      case &quot;noUidHdr&quot;:</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineminus">-      case &quot;uatHdr&quot;:</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineminus">-      case &quot;noUatHdr&quot;:</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineplus">+      case &quot;uid&quot;:</span>
<a href="#l18.533"></a><span id="l18.533">         return 1;</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-      case &quot;uid&quot;:</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineminus">-      case &quot;uat&quot;:</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineminus">-        return 2;</span>
<a href="#l18.537"></a><span id="l18.537">     }</span>
<a href="#l18.538"></a><span id="l18.538"> </span>
<a href="#l18.539"></a><span id="l18.539">     return 0;</span>
<a href="#l18.540"></a><span id="l18.540">   },</span>
<a href="#l18.541"></a><span id="l18.541"> </span>
<a href="#l18.542"></a><span id="l18.542">   getParentIndex(idx) {</span>
<a href="#l18.543"></a><span id="l18.543">     return -1;</span>
<a href="#l18.544"></a><span id="l18.544">   },</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineat">@@ -1597,19 +1491,17 @@ var gKeyListView = {</span>
<a href="#l18.546"></a><span id="l18.546">   },</span>
<a href="#l18.547"></a><span id="l18.547">   isContainerEmpty(row) {</span>
<a href="#l18.548"></a><span id="l18.548">     let r = this.getFilteredRow(row);</span>
<a href="#l18.549"></a><span id="l18.549">     if (!r) {</span>
<a href="#l18.550"></a><span id="l18.550">       return true;</span>
<a href="#l18.551"></a><span id="l18.551">     }</span>
<a href="#l18.552"></a><span id="l18.552">     switch (r.rowType) {</span>
<a href="#l18.553"></a><span id="l18.553">       case &quot;key&quot;:</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineminus">-        return false;</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineminus">-      case &quot;uidHdr&quot;:</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineminus">-        return r.isOpen;</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineplus">+        return !r.hasSubUID;</span>
<a href="#l18.558"></a><span id="l18.558">     }</span>
<a href="#l18.559"></a><span id="l18.559">     return true;</span>
<a href="#l18.560"></a><span id="l18.560">   },</span>
<a href="#l18.561"></a><span id="l18.561">   isContainerOpen(row) {</span>
<a href="#l18.562"></a><span id="l18.562">     return this.getFilteredRow(row).isOpen;</span>
<a href="#l18.563"></a><span id="l18.563">   },</span>
<a href="#l18.564"></a><span id="l18.564">   isEditable(row, col) {</span>
<a href="#l18.565"></a><span id="l18.565">     return false;</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineat">@@ -1649,41 +1541,17 @@ var gKeyListView = {</span>
<a href="#l18.567"></a><span id="l18.567">           ) {</span>
<a href="#l18.568"></a><span id="l18.568">             ++i;</span>
<a href="#l18.569"></a><span id="l18.569">           }</span>
<a href="#l18.570"></a><span id="l18.570"> </span>
<a href="#l18.571"></a><span id="l18.571">           this.keyViewList.splice(realRow + 1, i);</span>
<a href="#l18.572"></a><span id="l18.572">           r.isOpen = false;</span>
<a href="#l18.573"></a><span id="l18.573">           this.applyFilter(row);</span>
<a href="#l18.574"></a><span id="l18.574">         } else {</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineminus">-          let numUid = this.appendUids(</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineminus">-            &quot;uid&quot;,</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineminus">-            r.keyNum,</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-            realRow,</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineminus">-            this.keyViewList[row]</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineminus">-          );</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineminus">-</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineminus">-          if (numUid &gt; 0) {</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineminus">-            this.appendHdr(realRow, &quot;uidHdr&quot;, true);</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineminus">-          } else {</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineminus">-            this.appendHdr(realRow, &quot;noUidHdr&quot;, false);</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineminus">-          }</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineminus">-</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineminus">-          let numPhoto = this.appendUids(</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineminus">-            &quot;uat&quot;,</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineminus">-            r.keyNum,</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineminus">-            realRow + numUid + 1,</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineminus">-            this.keyViewList[row]</span>
<a href="#l18.593"></a><span id="l18.593" class="difflineminus">-          );</span>
<a href="#l18.594"></a><span id="l18.594" class="difflineminus">-</span>
<a href="#l18.595"></a><span id="l18.595" class="difflineminus">-          if (numPhoto &gt; 0) {</span>
<a href="#l18.596"></a><span id="l18.596" class="difflineminus">-            this.appendHdr(realRow + numUid + 1, &quot;uatHdr&quot;, true);</span>
<a href="#l18.597"></a><span id="l18.597" class="difflineminus">-          } else {</span>
<a href="#l18.598"></a><span id="l18.598" class="difflineminus">-            this.appendHdr(realRow + numUid + 1, &quot;noUatHdr&quot;, false);</span>
<a href="#l18.599"></a><span id="l18.599" class="difflineminus">-          }</span>
<a href="#l18.600"></a><span id="l18.600" class="difflineplus">+          this.appendUids(&quot;uid&quot;, r.keyNum, realRow, this.keyViewList[row]);</span>
<a href="#l18.601"></a><span id="l18.601"> </span>
<a href="#l18.602"></a><span id="l18.602">           r.isOpen = true;</span>
<a href="#l18.603"></a><span id="l18.603">           this.applyFilter(row);</span>
<a href="#l18.604"></a><span id="l18.604">         }</span>
<a href="#l18.605"></a><span id="l18.605">         break;</span>
<a href="#l18.606"></a><span id="l18.606">     }</span>
<a href="#l18.607"></a><span id="l18.607">   },</span>
<a href="#l18.608"></a><span id="l18.608"> </span>
<a href="#l18.609"></a><span id="l18.609" class="difflineat">@@ -1711,45 +1579,29 @@ var gKeyListView = {</span>
<a href="#l18.610"></a><span id="l18.610">         });</span>
<a href="#l18.611"></a><span id="l18.611">       }</span>
<a href="#l18.612"></a><span id="l18.612">     }</span>
<a href="#l18.613"></a><span id="l18.613"> </span>
<a href="#l18.614"></a><span id="l18.614">     return uidAdded;</span>
<a href="#l18.615"></a><span id="l18.615">   },</span>
<a href="#l18.616"></a><span id="l18.616"> </span>
<a href="#l18.617"></a><span id="l18.617">   /**</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineminus">-   * add header row (e.g. &quot;also known as&quot;) to tree view</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineminus">-   *</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineminus">-   * @param realRow:     Number - index of row in keyViewList (i.e. without filter)</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineminus">-   * @param headerType:  String - one of uid (user ID), uat (photo)</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineminus">-   * @param hasChildren: Boolean - whether or not there are rows underneath the header</span>
<a href="#l18.623"></a><span id="l18.623" class="difflineminus">-   */</span>
<a href="#l18.624"></a><span id="l18.624" class="difflineminus">-  appendHdr(realRow, headerType, hasChildren) {</span>
<a href="#l18.625"></a><span id="l18.625" class="difflineminus">-    let r = this.keyViewList[realRow];</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-    this.keyViewList.splice(realRow + 1, 0, {</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-      rowType: headerType,</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineminus">-      isOpen: hasChildren,</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineminus">-      keyNum: r.keyNum,</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineminus">-      parent: this.keyViewList[realRow],</span>
<a href="#l18.631"></a><span id="l18.631" class="difflineminus">-    });</span>
<a href="#l18.632"></a><span id="l18.632" class="difflineminus">-  },</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-</span>
<a href="#l18.634"></a><span id="l18.634" class="difflineminus">-  /**</span>
<a href="#l18.635"></a><span id="l18.635">    * Reload key list entirely</span>
<a href="#l18.636"></a><span id="l18.636">    */</span>
<a href="#l18.637"></a><span id="l18.637">   keysRefreshed() {</span>
<a href="#l18.638"></a><span id="l18.638">     this.keyViewList = [];</span>
<a href="#l18.639"></a><span id="l18.639">     this.keyFilterList = [];</span>
<a href="#l18.640"></a><span id="l18.640">     for (let i = 0; i &lt; gKeySortList.length; i++) {</span>
<a href="#l18.641"></a><span id="l18.641">       this.keyViewList.push({</span>
<a href="#l18.642"></a><span id="l18.642">         row: i,</span>
<a href="#l18.643"></a><span id="l18.643">         rowType: &quot;key&quot;,</span>
<a href="#l18.644"></a><span id="l18.644">         fpr: gKeySortList[i].fpr,</span>
<a href="#l18.645"></a><span id="l18.645">         keyNum: gKeySortList[i].keyNum,</span>
<a href="#l18.646"></a><span id="l18.646">         isOpen: false,</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineplus">+        hasSubUID: gKeyList[gKeySortList[i].keyNum].userIds.length &gt; 1,</span>
<a href="#l18.648"></a><span id="l18.648">       });</span>
<a href="#l18.649"></a><span id="l18.649">     }</span>
<a href="#l18.650"></a><span id="l18.650"> </span>
<a href="#l18.651"></a><span id="l18.651">     this.applyFilter(0);</span>
<a href="#l18.652"></a><span id="l18.652">     let oldRowCount = this.rowCount;</span>
<a href="#l18.653"></a><span id="l18.653">     this.rowCount = this.keyViewList.length;</span>
<a href="#l18.654"></a><span id="l18.654">     gTreeFuncs.rowCountChanged(0, this.rowCount - oldRowCount);</span>
<a href="#l18.655"></a><span id="l18.655">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyManager.xhtml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -46,38 +46,31 @@</span>
<a href="#l19.4"></a><span id="l19.4">   &lt;keyset id=&quot;winKeys&quot;&gt;</span>
<a href="#l19.5"></a><span id="l19.5">     &lt;key id=&quot;key_selectAll&quot; key=&quot;&amp;enigmail.keyMan.selectAll.key;&quot;</span>
<a href="#l19.6"></a><span id="l19.6">          oncommand=&quot;enigmailSelectAllKeys()&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">     &lt;key id=&quot;key_keyDetails&quot; key=&quot;&amp;enigmail.keyMan.keyDetails.key;&quot;</span>
<a href="#l19.9"></a><span id="l19.9">          oncommand=&quot;enigmailKeyDetails()&quot; modifiers=&quot;accel&quot;</span>
<a href="#l19.10"></a><span id="l19.10">          observes=&quot;bcOneKey&quot;/&gt;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    &lt;key id=&quot;key_refreshKey&quot; key=&quot;&amp;enigmail.keyMan.refreshKey.key;&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-         oncommand=&quot;enigmailReceiveKey()&quot; modifiers=&quot;accel&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-         observes=&quot;bcNoKey&quot;/&gt;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16">     &lt;key id=&quot;key_enigDelete&quot;</span>
<a href="#l19.17"></a><span id="l19.17">          keycode=&quot;VK_DELETE&quot;</span>
<a href="#l19.18"></a><span id="l19.18">          command=&quot;cmd_enigmailDeleteKey&quot;/&gt;</span>
<a href="#l19.19"></a><span id="l19.19">     &lt;key id=&quot;key_close&quot;/&gt;</span>
<a href="#l19.20"></a><span id="l19.20">     &lt;key id=&quot;key_quit&quot;/&gt;</span>
<a href="#l19.21"></a><span id="l19.21">   &lt;/keyset&gt;</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">   &lt;broadcasterset&gt;</span>
<a href="#l19.24"></a><span id="l19.24">     &lt;broadcaster id=&quot;bcNoKey&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-    &lt;broadcaster id=&quot;bcSignKey&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    &lt;broadcaster id=&quot;bcSetTrust&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.27"></a><span id="l19.27">     &lt;broadcaster id=&quot;bcViewPhoto&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.28"></a><span id="l19.28">     &lt;broadcaster id=&quot;bcEditKey&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.29"></a><span id="l19.29">     &lt;broadcaster id=&quot;bcRevoke&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.30"></a><span id="l19.30">     &lt;broadcaster id=&quot;bcOneKey&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.31"></a><span id="l19.31">     &lt;broadcaster id=&quot;bcDeleteKey&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.32"></a><span id="l19.32">     &lt;broadcaster id=&quot;bcClipbrd&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-    &lt;broadcaster id=&quot;bcUploadToWkd&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l19.34"></a><span id="l19.34">   &lt;/broadcasterset&gt;</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   &lt;menubar id=&quot;main-menubar&quot; grippyhidden=&quot;true&quot;&gt;</span>
<a href="#l19.37"></a><span id="l19.37">     &lt;menu label=&quot;&amp;enigmail.keyMan.fileMenu.label;&quot;</span>
<a href="#l19.38"></a><span id="l19.38">           id=&quot;menu_File&quot;</span>
<a href="#l19.39"></a><span id="l19.39">           accesskey=&quot;&amp;enigmail.keyMan.fileMenu.accesskey;&quot;&gt;</span>
<a href="#l19.40"></a><span id="l19.40">       &lt;menupopup id=&quot;menu_FilePopup&quot; onpopupshowing=&quot;enigmailKeyMenu()&quot;&gt;</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42" class="difflineat">@@ -108,18 +101,16 @@</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44">         &lt;menuseparator/&gt;</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.reload.label;&quot;</span>
<a href="#l19.47"></a><span id="l19.47">                 id=&quot;refreshKeys&quot;</span>
<a href="#l19.48"></a><span id="l19.48">                 accesskey=&quot;&amp;enigmail.keyMan.reload.accesskey;&quot;</span>
<a href="#l19.49"></a><span id="l19.49">                 oncommand=&quot;clearKeyCache();&quot;/&gt;</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-        &lt;menuseparator/&gt;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-</span>
<a href="#l19.53"></a><span id="l19.53">         &lt;!-- add Close and Exit menu items --&gt;</span>
<a href="#l19.54"></a><span id="l19.54">         &lt;menuitem id=&quot;menu_close&quot;/&gt;</span>
<a href="#l19.55"></a><span id="l19.55">       &lt;/menupopup&gt;</span>
<a href="#l19.56"></a><span id="l19.56">     &lt;/menu&gt;</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58">     &lt;menu label=&quot;&amp;enigmail.keyMan.editMenu.label;&quot;</span>
<a href="#l19.59"></a><span id="l19.59">           accesskey=&quot;&amp;enigmail.keyMan.editMenu.accesskey;&quot;&gt;</span>
<a href="#l19.60"></a><span id="l19.60">       &lt;menupopup onpopupshowing=&quot;enigmailKeyMenu()&quot;&gt;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineat">@@ -136,61 +127,39 @@</span>
<a href="#l19.62"></a><span id="l19.62">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.copyToClipbrd.label;&quot;</span>
<a href="#l19.63"></a><span id="l19.63">                   id=&quot;copyToClipbrd&quot;</span>
<a href="#l19.64"></a><span id="l19.64">                   observes=&quot;bcNoKey&quot;</span>
<a href="#l19.65"></a><span id="l19.65">                   accesskey=&quot;&amp;enigmail.keyMan.copyToClipbrd.accesskey;&quot;</span>
<a href="#l19.66"></a><span id="l19.66">                   oncommand=&quot;enigmailCopyToClipbrd()&quot;/&gt;</span>
<a href="#l19.67"></a><span id="l19.67"> </span>
<a href="#l19.68"></a><span id="l19.68">         &lt;menuseparator/&gt;</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.sign.label;&quot;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-                  id=&quot;signKey&quot;</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-                  observes=&quot;bcSignKey&quot;</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.sign.accesskey;&quot;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-                  oncommand=&quot;enigSignKey()&quot;/&gt;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.setTrust.label;&quot;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-                  id=&quot;setTrust&quot;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-                  observes=&quot;bcSetTrust&quot;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.setTrust.accesskey;&quot;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-                  oncommand=&quot;enigEditKeyTrust()&quot;/&gt;</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-        &lt;menuseparator/&gt;</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+        &lt;!--</span>
<a href="#l19.84"></a><span id="l19.84">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.revokeKey.label;&quot;</span>
<a href="#l19.85"></a><span id="l19.85">           id=&quot;revokeKey&quot;</span>
<a href="#l19.86"></a><span id="l19.86">           observes=&quot;bcRevoke&quot;</span>
<a href="#l19.87"></a><span id="l19.87">           accesskey=&quot;&amp;enigmail.keyMan.revokeKey.accesskey;&quot;</span>
<a href="#l19.88"></a><span id="l19.88">           oncommand=&quot;enigmailRevokeKey()&quot;/&gt;</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+        --&gt;</span>
<a href="#l19.90"></a><span id="l19.90"> </span>
<a href="#l19.91"></a><span id="l19.91">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.delKey.label;&quot;</span>
<a href="#l19.92"></a><span id="l19.92">           id=&quot;deleteKey&quot;</span>
<a href="#l19.93"></a><span id="l19.93">           key=&quot;key_enigDelete&quot;</span>
<a href="#l19.94"></a><span id="l19.94">           observes=&quot;bcNoKey&quot;</span>
<a href="#l19.95"></a><span id="l19.95">           accesskey=&quot;&amp;enigmail.keyMan.delKey.accesskey;&quot;</span>
<a href="#l19.96"></a><span id="l19.96">           oncommand=&quot;enigmailDeleteKey()&quot;/&gt;</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+        &lt;!--</span>
<a href="#l19.99"></a><span id="l19.99">         &lt;menuseparator/&gt;</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-        &lt;menuitem id=&quot;manageUid&quot;</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-                  label=&quot;&amp;enigmail.keyMan.manageUid.label;&quot;</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-                  observes=&quot;bcEditKey&quot;</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.manageUid.accesskey;&quot;</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-                  oncommand=&quot;enigmailManageUids()&quot;/&gt;</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-</span>
<a href="#l19.107"></a><span id="l19.107">         &lt;menuitem id=&quot;changeExpiry&quot;</span>
<a href="#l19.108"></a><span id="l19.108">                   label=&quot;&amp;enigmail.keyMan.changeExpiry.label;&quot;</span>
<a href="#l19.109"></a><span id="l19.109">                   observes=&quot;bcEditKey&quot;</span>
<a href="#l19.110"></a><span id="l19.110">                   accesskey=&quot;&amp;enigmail.keyMan.changeExpiry.accesskey;&quot;</span>
<a href="#l19.111"></a><span id="l19.111">                   oncommand=&quot;enigEditKeyExpiry()&quot;/&gt;</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-        &lt;menuitem id=&quot;changePwd&quot;</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-                  label=&quot;&amp;enigmail.keyMan.changePwd.label;&quot;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-                  observes=&quot;bcEditKey&quot;</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.changePwd.accesskey;&quot;</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-                  oncommand=&quot;enigmailChangePwd()&quot;/&gt;</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+        --&gt;</span>
<a href="#l19.119"></a><span id="l19.119"> </span>
<a href="#l19.120"></a><span id="l19.120">         &lt;menuseparator/&gt;</span>
<a href="#l19.121"></a><span id="l19.121"> </span>
<a href="#l19.122"></a><span id="l19.122">         &lt;menuitem id=&quot;selectAll&quot;</span>
<a href="#l19.123"></a><span id="l19.123">                   label=&quot;&amp;enigmail.keyMan.selectAll.label;&quot;</span>
<a href="#l19.124"></a><span id="l19.124">                   accesskey=&quot;&amp;enigmail.keyMan.selectAll.accesskey;&quot;</span>
<a href="#l19.125"></a><span id="l19.125">                   oncommand=&quot;enigmailSelectAllKeys()&quot;</span>
<a href="#l19.126"></a><span id="l19.126">                   key=&quot;key_selectAll&quot;/&gt;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineat">@@ -234,65 +203,31 @@</span>
<a href="#l19.128"></a><span id="l19.128">                   checked=&quot;true&quot;</span>
<a href="#l19.129"></a><span id="l19.129">                   persist=&quot;checked&quot;</span>
<a href="#l19.130"></a><span id="l19.130">                   accesskey=&quot;&amp;enigmail.keyMan.showOthersKeys.accesskey;&quot;</span>
<a href="#l19.131"></a><span id="l19.131">                   oncommand=&quot;applyFilter()&quot;/&gt;</span>
<a href="#l19.132"></a><span id="l19.132"> </span>
<a href="#l19.133"></a><span id="l19.133">       &lt;/menupopup&gt;</span>
<a href="#l19.134"></a><span id="l19.134">     &lt;/menu&gt;</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-    &lt;menu id=&quot;keyserverMenu&quot;</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-          label=&quot;&amp;enigmail.keyMan.keyserverMenu.label;&quot;</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-          accesskey=&quot;&amp;enigmail.keyMan.keyserverMenu.accesskey;&quot;&gt;</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-      &lt;menupopup onpopupshowing=&quot;enigmailKeyMenu()&quot;&gt; &lt;!-- keyserverMenu menu --&gt;</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.refreshSelKeys.label;&quot;</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-                  id=&quot;refreshKey&quot;</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-                  observes=&quot;bcNoKey&quot;</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.refreshSelKeys.accesskey;&quot;</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-                  key=&quot;key_refreshKey&quot;</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-                  oncommand=&quot;enigmailReceiveKey()&quot;/&gt;</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.importFromServer.label;&quot;</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-                  id=&quot;importFromServer&quot;</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.importFromServer.accesskey;&quot;</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-                  oncommand=&quot;enigmailSearchKey()&quot;/&gt;</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.uploadToServer.label;&quot;</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-                  id=&quot;uploadToServer&quot;</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-                  observes=&quot;bcNoKey&quot;</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.uploadToServer.accesskey;&quot;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-                  oncommand=&quot;enigmailUploadKeys()&quot;/&gt;</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.uploadToWkd.label;&quot;</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-                  id=&quot;uploadToWkd&quot;</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-                  observes=&quot;bcUploadToWkd&quot;</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-                  oncommand=&quot;enigmailUploadToWkd()&quot;/&gt;</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-        &lt;menuseparator/&gt;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.refreshAllKeys.label;&quot;</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-                  id=&quot;refreshAllKeys&quot;</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.refreshAllKeys.accesskey;&quot;</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-                  oncommand=&quot;enigmailRefreshAllKeys()&quot;/&gt;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.downloadContactKeys.label;&quot;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-                  accesskey=&quot;&amp;enigmail.keyMan.downloadContactKeys.accesskey;&quot;</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-                  id=&quot;downloadContactKeys&quot;</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-                  oncommand=&quot;enigmailDownloadContactKeys()&quot;/&gt;</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-      &lt;/menupopup&gt;</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-    &lt;/menu&gt;</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-</span>
<a href="#l19.172"></a><span id="l19.172">     &lt;menu id=&quot;generateMenu&quot;</span>
<a href="#l19.173"></a><span id="l19.173">           label=&quot;&amp;enigmail.keyMan.generateMenu.label;&quot;</span>
<a href="#l19.174"></a><span id="l19.174">           accesskey=&quot;&amp;enigmail.keyMan.generateMenu.accesskey;&quot;&gt;</span>
<a href="#l19.175"></a><span id="l19.175">       &lt;menupopup onpopupshowing=&quot;enigmailKeyMenu()&quot;&gt; &lt;!-- generate menu --&gt;</span>
<a href="#l19.176"></a><span id="l19.176">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.generate.label;&quot;</span>
<a href="#l19.177"></a><span id="l19.177">                   id=&quot;genKey&quot;</span>
<a href="#l19.178"></a><span id="l19.178">                   accesskey=&quot;&amp;enigmail.keyMan.generate.accesskey;&quot;</span>
<a href="#l19.179"></a><span id="l19.179">                   oncommand=&quot;EnigKeygen();&quot;/&gt;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+        &lt;!--</span>
<a href="#l19.181"></a><span id="l19.181">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.genRevoke.label;&quot;</span>
<a href="#l19.182"></a><span id="l19.182">                   id=&quot;revokationCertificate&quot;</span>
<a href="#l19.183"></a><span id="l19.183">                   observes=&quot;bcRevoke&quot;</span>
<a href="#l19.184"></a><span id="l19.184">                   accesskey=&quot;&amp;enigmail.keyMan.genRevoke.accesskey;&quot;</span>
<a href="#l19.185"></a><span id="l19.185">                   oncommand=&quot;enigCreateRevokeCert()&quot;/&gt;</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+        --&gt;</span>
<a href="#l19.187"></a><span id="l19.187">       &lt;/menupopup&gt;</span>
<a href="#l19.188"></a><span id="l19.188">     &lt;/menu&gt;</span>
<a href="#l19.189"></a><span id="l19.189"> </span>
<a href="#l19.190"></a><span id="l19.190">   &lt;/menubar&gt;</span>
<a href="#l19.191"></a><span id="l19.191"> </span>
<a href="#l19.192"></a><span id="l19.192">   &lt;popupset&gt;</span>
<a href="#l19.193"></a><span id="l19.193">     &lt;menupopup id=&quot;ctxmenu&quot;</span>
<a href="#l19.194"></a><span id="l19.194">            onpopupshowing=&quot;enigmailKeyMenu();&quot;&gt;</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineat">@@ -303,45 +238,26 @@</span>
<a href="#l19.196"></a><span id="l19.196">                 id=&quot;ctxExport&quot;</span>
<a href="#l19.197"></a><span id="l19.197">                 oncommand=&quot;enigmailExportKeys()&quot;/&gt;</span>
<a href="#l19.198"></a><span id="l19.198">       &lt;menuitem label=&quot;&amp;enigmail.keyMan.sendKeys.label;&quot;</span>
<a href="#l19.199"></a><span id="l19.199">                 id=&quot;ctxSendKey&quot;</span>
<a href="#l19.200"></a><span id="l19.200">                 oncommand=&quot;enigCreateKeyMsg()&quot;/&gt;</span>
<a href="#l19.201"></a><span id="l19.201"> </span>
<a href="#l19.202"></a><span id="l19.202">       &lt;menuseparator/&gt;</span>
<a href="#l19.203"></a><span id="l19.203"> </span>
<a href="#l19.204"></a><span id="l19.204" class="difflineminus">-      &lt;menuitem label=&quot;&amp;enigmail.keyMan.ctxUploadToServer.label;&quot;</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-                id=&quot;ctxUpload&quot;</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-                oncommand=&quot;enigmailUploadKeys()&quot;/&gt;</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-      &lt;menuitem label=&quot;&amp;enigmail.keyMan.ctxRefreshKey.label;&quot;</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-                id=&quot;ctxRefreshKey&quot;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-                oncommand=&quot;enigmailReceiveKey()&quot;/&gt;</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-      &lt;menuitem label=&quot;&amp;enigmail.keyMan.uploadToWkd.label;&quot;</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-                id=&quot;ctxUploadToWkd&quot;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-                observes=&quot;bcUploadToWkd&quot;</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-                oncommand=&quot;enigmailUploadToWkd()&quot;/&gt;</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-      &lt;menuseparator/&gt;</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-      &lt;menuitem id=&quot;ctxSign&quot; observes=&quot;bcSignKey&quot; label=&quot;&amp;enigmail.keyMan.sign.label;&quot; oncommand=&quot;enigSignKey()&quot;/&gt;</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-      &lt;menuitem id=&quot;ctxTrust&quot; observes=&quot;bcSetTrust&quot; label=&quot;&amp;enigmail.keyMan.setTrust.label;&quot; oncommand=&quot;enigEditKeyTrust()&quot;/&gt;</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-      &lt;menuitem id=&quot;ctxAddToRule&quot; observes=&quot;bcSignKey&quot; label=&quot;&amp;enigmail.keyMan.addToPRRule.label;&quot; oncommand=&quot;addToPRRule()&quot;/&gt;</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-      &lt;menuseparator/&gt;</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineminus">-</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineminus">-</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineplus">+      &lt;!--</span>
<a href="#l19.225"></a><span id="l19.225">       &lt;menuitem id=&quot;ctxRevokeKey&quot; observes=&quot;bcRevoke&quot; label=&quot;&amp;enigmail.keyMan.revokeKey.label;&quot; oncommand=&quot;enigmailRevokeKey()&quot;/&gt;</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineplus">+      --&gt;</span>
<a href="#l19.227"></a><span id="l19.227">       &lt;menuitem id=&quot;ctxDeleteKey&quot; label=&quot;&amp;enigmail.keyMan.delKey.label;&quot; oncommand=&quot;enigmailDeleteKey()&quot;/&gt;</span>
<a href="#l19.228"></a><span id="l19.228"> </span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+      &lt;!--</span>
<a href="#l19.230"></a><span id="l19.230">       &lt;menuseparator/&gt;</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineminus">-</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-      &lt;menuitem id=&quot;ctxManageUid&quot; observes=&quot;bcEditKey&quot; label=&quot;&amp;enigmail.keyMan.manageUid.label;&quot; oncommand=&quot;enigmailManageUids()&quot;/&gt;</span>
<a href="#l19.233"></a><span id="l19.233">       &lt;menuitem id=&quot;ctxChangeExpiry&quot; observes=&quot;bcEditKey&quot; label=&quot;&amp;enigmail.keyMan.changeExpiry.label;&quot; oncommand=&quot;enigEditKeyExpiry()&quot;/&gt;</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-      &lt;menuitem id=&quot;ctxChangePwd&quot; observes=&quot;bcEditKey&quot; label=&quot;&amp;enigmail.keyMan.changePwd.label;&quot; oncommand=&quot;enigmailChangePwd()&quot;/&gt;</span>
<a href="#l19.235"></a><span id="l19.235">       &lt;menuitem id=&quot;ctxRevokationCert&quot; observes=&quot;bcRevoke&quot; label=&quot;&amp;enigmail.keyMan.ctxGenRevoke.label;&quot; oncommand=&quot;enigCreateRevokeCert()&quot;/&gt;</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineplus">+      --&gt;</span>
<a href="#l19.237"></a><span id="l19.237"> </span>
<a href="#l19.238"></a><span id="l19.238">       &lt;menuseparator observes=&quot;bcEditKey&quot;/&gt;</span>
<a href="#l19.239"></a><span id="l19.239"> </span>
<a href="#l19.240"></a><span id="l19.240">       &lt;menuitem id=&quot;ctxViewPhoto&quot; observes=&quot;bcViewPhoto&quot; label=&quot;&amp;enigmail.keyMan.ctxViewPhoto.label;&quot; oncommand=&quot;enigShowPhoto()&quot;/&gt;</span>
<a href="#l19.241"></a><span id="l19.241">       &lt;menuitem id=&quot;ctxDetails&quot; observes=&quot;bcOneKey&quot; label=&quot;&amp;enigmail.keyMan.keyProps.label;&quot;</span>
<a href="#l19.242"></a><span id="l19.242">                 oncommand=&quot;enigmailKeyDetails()&quot;/&gt;</span>
<a href="#l19.243"></a><span id="l19.243">     &lt;/menupopup&gt;</span>
<a href="#l19.244"></a><span id="l19.244">   &lt;/popupset&gt;</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineat">@@ -372,50 +288,26 @@</span>
<a href="#l19.246"></a><span id="l19.246">         hidecolumnpicker=&quot;false&quot;&gt;</span>
<a href="#l19.247"></a><span id="l19.247"> </span>
<a href="#l19.248"></a><span id="l19.248">         &lt;treecols&gt;</span>
<a href="#l19.249"></a><span id="l19.249">           &lt;treecol id=&quot;enigUserNameCol&quot; primary=&quot;true&quot;</span>
<a href="#l19.250"></a><span id="l19.250">                   flex=&quot;1&quot;</span>
<a href="#l19.251"></a><span id="l19.251">                   class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.252"></a><span id="l19.252">                   onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.253"></a><span id="l19.253">                   label=&quot;&amp;enigmail.keyMan.userId.label;&quot;</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-                  style=&quot;width: 50px&quot;</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+                  style=&quot;width: 400px&quot;</span>
<a href="#l19.256"></a><span id="l19.256">                   persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.257"></a><span id="l19.257">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-          &lt;treecol id=&quot;keyCol&quot; style=&quot;width:90px&quot;</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+          &lt;treecol id=&quot;keyCol&quot; style=&quot;width:100px&quot;</span>
<a href="#l19.260"></a><span id="l19.260">                    label=&quot;&amp;enigmail.keyId.label;&quot;</span>
<a href="#l19.261"></a><span id="l19.261">                    flex=&quot;1&quot;</span>
<a href="#l19.262"></a><span id="l19.262">                    class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.263"></a><span id="l19.263">                    onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.264"></a><span id="l19.264">                    persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.265"></a><span id="l19.265">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-          &lt;treecol id=&quot;typeCol&quot; style=&quot;width:70px&quot;</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-                   label=&quot;&amp;enigmail.keyMan.keyType.label;&quot;</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-                   flex=&quot;1&quot;</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-                   class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-                   onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-                   hidden=&quot;true&quot;</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-                   persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-          &lt;treecol id=&quot;validityCol&quot; style=&quot;width:70px&quot;</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-                   label=&quot;&amp;enigmail.keyMan.calcTrust.label;&quot;</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-                   flex=&quot;1&quot;</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-                   class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-                   onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-                   hidden=&quot;true&quot;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-                   persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-          &lt;treecol id=&quot;trustCol&quot; style=&quot;width:70px&quot;</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-                   label=&quot;&amp;enigmail.keyMan.ownerTrust.label;&quot;</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-                   flex=&quot;1&quot;</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-                   class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-                   onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-                   hidden=&quot;true&quot;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-                   persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l19.290"></a><span id="l19.290">           &lt;treecol id=&quot;expCol&quot; style=&quot;width:70px&quot;</span>
<a href="#l19.291"></a><span id="l19.291">                    label=&quot;&amp;enigmail.keyExpiry.label;&quot;</span>
<a href="#l19.292"></a><span id="l19.292">                    flex=&quot;1&quot;</span>
<a href="#l19.293"></a><span id="l19.293">                    class=&quot;sortDirectionIndicator&quot;</span>
<a href="#l19.294"></a><span id="l19.294">                    onclick=&quot;sortTree(this)&quot;</span>
<a href="#l19.295"></a><span id="l19.295">                    hidden=&quot;true&quot;</span>
<a href="#l19.296"></a><span id="l19.296">                    persist=&quot;width ordinal hidden&quot;/&gt;</span>
<a href="#l19.297"></a><span id="l19.297">           &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -220,19 +220,20 @@ function enigmailKeygenStart() {</span>
<a href="#l20.4"></a><span id="l20.4">   idString += &quot; &lt;&quot; + userEmail + &quot;&gt;&quot;;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">   var confirmMsg = EnigGetString(&quot;keyConfirm&quot;, idString);</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">   if (!EnigConfirm(confirmMsg, EnigGetString(&quot;keyMan.button.generateKey&quot;))) {</span>
<a href="#l20.9"></a><span id="l20.9">     return;</span>
<a href="#l20.10"></a><span id="l20.10">   }</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  var cApi;</span>
<a href="#l20.13"></a><span id="l20.13">   try {</span>
<a href="#l20.14"></a><span id="l20.14">     let newId = null;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-    const cApi = EnigmailCryptoAPI();</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+    cApi = EnigmailCryptoAPI();</span>
<a href="#l20.17"></a><span id="l20.17">     newId = cApi.sync(</span>
<a href="#l20.18"></a><span id="l20.18">       cApi.genKey(</span>
<a href="#l20.19"></a><span id="l20.19">         idString,</span>
<a href="#l20.20"></a><span id="l20.20">         keyType,</span>
<a href="#l20.21"></a><span id="l20.21">         keySize,</span>
<a href="#l20.22"></a><span id="l20.22">         expiryTime,</span>
<a href="#l20.23"></a><span id="l20.23">         OpenPGPMasterpass.retrieveOpenPGPPassword()</span>
<a href="#l20.24"></a><span id="l20.24">       )</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineat">@@ -255,17 +256,17 @@ function enigmailKeygenStart() {</span>
<a href="#l20.26"></a><span id="l20.26">   } else {</span>
<a href="#l20.27"></a><span id="l20.27">     console.debug(&quot;saving new key id &quot; + gGeneratedKey);</span>
<a href="#l20.28"></a><span id="l20.28">     curId.setCharAttribute(&quot;openpgp_key_id&quot;, gGeneratedKey);</span>
<a href="#l20.29"></a><span id="l20.29">     EnigSavePrefs();</span>
<a href="#l20.30"></a><span id="l20.30">   }</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32">   closeAndReset();</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  let rev = RNP.getNewRevocation(&quot;0x&quot; + gGeneratedKey);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+  let rev = cApi.sync(cApi.getNewRevocation(&quot;0x&quot; + gGeneratedKey));</span>
<a href="#l20.36"></a><span id="l20.36">   if (!rev) {</span>
<a href="#l20.37"></a><span id="l20.37">     throw new Error(&quot;failed to obtain revocation for key &quot; + gGeneratedKey);</span>
<a href="#l20.38"></a><span id="l20.38">   }</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">   let revFull =</span>
<a href="#l20.41"></a><span id="l20.41">     revocationFilePrefix1 +</span>
<a href="#l20.42"></a><span id="l20.42">     &quot;\n\n&quot; +</span>
<a href="#l20.43"></a><span id="l20.43">     gGeneratedKey +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -985,16 +985,17 @@ Enigmail.msg = {</span>
<a href="#l21.4"></a><span id="l21.4">         }</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">         if (isAuto &amp;&amp; !EnigmailPrefs.getPref(&quot;autoDecrypt&quot;)) {</span>
<a href="#l21.7"></a><span id="l21.7">           if (EnigmailVerify.getManualUri() != this.getCurrentMsgUriSpec()) {</span>
<a href="#l21.8"></a><span id="l21.8">             // decryption set to manual</span>
<a href="#l21.9"></a><span id="l21.9">             Enigmail.hdrView.updateHdrIcons(</span>
<a href="#l21.10"></a><span id="l21.10">               EnigmailConstants.POSSIBLE_PGPMIME,</span>
<a href="#l21.11"></a><span id="l21.11">               0, // exitCode, statusFlags</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+              0,</span>
<a href="#l21.13"></a><span id="l21.13">               &quot;&quot;,</span>
<a href="#l21.14"></a><span id="l21.14">               &quot;&quot;, // keyId, userId</span>
<a href="#l21.15"></a><span id="l21.15">               &quot;&quot;, // sigDetails</span>
<a href="#l21.16"></a><span id="l21.16">               EnigmailLocale.getString(&quot;possiblyPgpMime&quot;), // infoMsg</span>
<a href="#l21.17"></a><span id="l21.17">               null, // blockSeparation</span>
<a href="#l21.18"></a><span id="l21.18">               &quot;&quot;, // encToDetails</span>
<a href="#l21.19"></a><span id="l21.19">               null</span>
<a href="#l21.20"></a><span id="l21.20">             ); // xtraStatus</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -1028,16 +1029,17 @@ Enigmail.msg = {</span>
<a href="#l21.22"></a><span id="l21.22">     );</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">     let ph = new EnigmailProtocolHandler();</span>
<a href="#l21.25"></a><span id="l21.25">     let uri = ph.newURI(uriStr);</span>
<a href="#l21.26"></a><span id="l21.26">     Enigmail.hdrView.headerPane.updateSecurityStatus(</span>
<a href="#l21.27"></a><span id="l21.27">       &quot;&quot;,</span>
<a href="#l21.28"></a><span id="l21.28">       0,</span>
<a href="#l21.29"></a><span id="l21.29">       0,</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+      0,</span>
<a href="#l21.31"></a><span id="l21.31">       &quot;&quot;,</span>
<a href="#l21.32"></a><span id="l21.32">       &quot;&quot;,</span>
<a href="#l21.33"></a><span id="l21.33">       &quot;&quot;,</span>
<a href="#l21.34"></a><span id="l21.34">       &quot;&quot;,</span>
<a href="#l21.35"></a><span id="l21.35">       &quot;&quot;,</span>
<a href="#l21.36"></a><span id="l21.36">       uri,</span>
<a href="#l21.37"></a><span id="l21.37">       &quot;&quot;,</span>
<a href="#l21.38"></a><span id="l21.38">       &quot;1&quot;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineat">@@ -1212,16 +1214,17 @@ Enigmail.msg = {</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">     if (isAuto) {</span>
<a href="#l21.42"></a><span id="l21.42">       let ht = this.hasHeadOrTailBesidesInlinePGP(msgText);</span>
<a href="#l21.43"></a><span id="l21.43">       if (ht) {</span>
<a href="#l21.44"></a><span id="l21.44">         /*</span>
<a href="#l21.45"></a><span id="l21.45">         Enigmail.hdrView.updateHdrIcons(</span>
<a href="#l21.46"></a><span id="l21.46">           0,</span>
<a href="#l21.47"></a><span id="l21.47">           ht,</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+          0,</span>
<a href="#l21.49"></a><span id="l21.49">           &quot;&quot;,</span>
<a href="#l21.50"></a><span id="l21.50">           &quot;&quot;,</span>
<a href="#l21.51"></a><span id="l21.51">           &quot;&quot;,</span>
<a href="#l21.52"></a><span id="l21.52">           &quot;&quot;,</span>
<a href="#l21.53"></a><span id="l21.53">           null,</span>
<a href="#l21.54"></a><span id="l21.54">           &quot;&quot;,</span>
<a href="#l21.55"></a><span id="l21.55">           &quot;process-manually&quot;</span>
<a href="#l21.56"></a><span id="l21.56">         );</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineat">@@ -1294,17 +1297,17 @@ Enigmail.msg = {</span>
<a href="#l21.58"></a><span id="l21.58">     let endIndex = msgText.indexOf(&quot;-----END PGP&quot;);</span>
<a href="#l21.59"></a><span id="l21.59">     let hasHead = false;</span>
<a href="#l21.60"></a><span id="l21.60">     let hasTail = false;</span>
<a href="#l21.61"></a><span id="l21.61">     let crypto = 0;</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63">     if (startIndex &gt; 0) {</span>
<a href="#l21.64"></a><span id="l21.64">       let pgpMsg = msgText.match(/(-----BEGIN PGP (SIGNED )?MESSAGE-----)/m)[0];</span>
<a href="#l21.65"></a><span id="l21.65">       if (pgpMsg.search(/SIGNED/) &gt; 0) {</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-        crypto = EnigmailConstants.UNVERIFIED_SIGNATURE;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+        crypto = EnigmailConstants.UNCERTAIN_SIGNATURE;</span>
<a href="#l21.68"></a><span id="l21.68">       } else {</span>
<a href="#l21.69"></a><span id="l21.69">         crypto = EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l21.70"></a><span id="l21.70">       }</span>
<a href="#l21.71"></a><span id="l21.71">       let startSection = msgText.substr(0, startIndex - 1);</span>
<a href="#l21.72"></a><span id="l21.72">       hasHead = startSection.search(/\S/) &gt;= 0;</span>
<a href="#l21.73"></a><span id="l21.73">     }</span>
<a href="#l21.74"></a><span id="l21.74"> </span>
<a href="#l21.75"></a><span id="l21.75">     if (endIndex &gt; startIndex) {</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineat">@@ -1371,16 +1374,17 @@ Enigmail.msg = {</span>
<a href="#l21.77"></a><span id="l21.77">     if (!enigmailSvc) {</span>
<a href="#l21.78"></a><span id="l21.78">       return;</span>
<a href="#l21.79"></a><span id="l21.79">     }</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81">     var plainText;</span>
<a href="#l21.82"></a><span id="l21.82">     var exitCode;</span>
<a href="#l21.83"></a><span id="l21.83">     var newSignature = &quot;&quot;;</span>
<a href="#l21.84"></a><span id="l21.84">     var statusFlags = 0;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+    var extStatusFlags = 0;</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87">     var errorMsgObj = {</span>
<a href="#l21.88"></a><span id="l21.88">       value: &quot;&quot;,</span>
<a href="#l21.89"></a><span id="l21.89">     };</span>
<a href="#l21.90"></a><span id="l21.90">     var keyIdObj = {};</span>
<a href="#l21.91"></a><span id="l21.91">     var userIdObj = {};</span>
<a href="#l21.92"></a><span id="l21.92">     var sigDetailsObj = {};</span>
<a href="#l21.93"></a><span id="l21.93">     var encToDetailsObj = {};</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineat">@@ -1435,16 +1439,17 @@ Enigmail.msg = {</span>
<a href="#l21.95"></a><span id="l21.95">     exitCode = exitCodeObj.value;</span>
<a href="#l21.96"></a><span id="l21.96">     newSignature = signatureObj.value;</span>
<a href="#l21.97"></a><span id="l21.97"> </span>
<a href="#l21.98"></a><span id="l21.98">     if (plainText === &quot;&quot; &amp;&amp; exitCode === 0) {</span>
<a href="#l21.99"></a><span id="l21.99">       plainText = &quot; &quot;;</span>
<a href="#l21.100"></a><span id="l21.100">     }</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102">     statusFlags = statusFlagsObj.value;</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+    extStatusFlags = statusFlagsObj.ext;</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105">     EnigmailLog.DEBUG(</span>
<a href="#l21.106"></a><span id="l21.106">       &quot;enigmailMessengerOverlay.js: messageParseCallback: newSignature='&quot; +</span>
<a href="#l21.107"></a><span id="l21.107">         newSignature +</span>
<a href="#l21.108"></a><span id="l21.108">         &quot;'\n&quot;</span>
<a href="#l21.109"></a><span id="l21.109">     );</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">     var errorMsg = errorMsgObj.value;</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineat">@@ -1459,16 +1464,17 @@ Enigmail.msg = {</span>
<a href="#l21.113"></a><span id="l21.113">     var displayedUriSpec = Enigmail.msg.getCurrentMsgUriSpec();</span>
<a href="#l21.114"></a><span id="l21.114">     if (!msgUriSpec || displayedUriSpec == msgUriSpec) {</span>
<a href="#l21.115"></a><span id="l21.115">       if (tail.length &gt; 0) {</span>
<a href="#l21.116"></a><span id="l21.116">         statusFlags |= EnigmailConstants.PARTIALLY_PGP;</span>
<a href="#l21.117"></a><span id="l21.117">       }</span>
<a href="#l21.118"></a><span id="l21.118">       Enigmail.hdrView.updateHdrIcons(</span>
<a href="#l21.119"></a><span id="l21.119">         exitCode,</span>
<a href="#l21.120"></a><span id="l21.120">         statusFlags,</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+        extStatusFlags,</span>
<a href="#l21.122"></a><span id="l21.122">         keyIdObj.value,</span>
<a href="#l21.123"></a><span id="l21.123">         userIdObj.value,</span>
<a href="#l21.124"></a><span id="l21.124">         sigDetailsObj.value,</span>
<a href="#l21.125"></a><span id="l21.125">         errorMsg,</span>
<a href="#l21.126"></a><span id="l21.126">         null, // blockSeparation</span>
<a href="#l21.127"></a><span id="l21.127">         encToDetailsObj.value,</span>
<a href="#l21.128"></a><span id="l21.128">         null</span>
<a href="#l21.129"></a><span id="l21.129">       ); // xtraStatus</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineat">@@ -1732,16 +1738,17 @@ Enigmail.msg = {</span>
<a href="#l21.131"></a><span id="l21.131">         while (node) {</span>
<a href="#l21.132"></a><span id="l21.132">           if (node.nodeName == &quot;DIV&quot;) {</span>
<a href="#l21.133"></a><span id="l21.133">             node.innerHTML = EnigmailFuncs.formatPlaintextMsg(</span>
<a href="#l21.134"></a><span id="l21.134">               EnigmailData.convertToUnicode(messageContent, charset)</span>
<a href="#l21.135"></a><span id="l21.135">             );</span>
<a href="#l21.136"></a><span id="l21.136">             Enigmail.hdrView.updateHdrIcons(</span>
<a href="#l21.137"></a><span id="l21.137">               exitCode,</span>
<a href="#l21.138"></a><span id="l21.138">               statusFlags,</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+              extStatusFlags,</span>
<a href="#l21.140"></a><span id="l21.140">               keyIdObj.value,</span>
<a href="#l21.141"></a><span id="l21.141">               userIdObj.value,</span>
<a href="#l21.142"></a><span id="l21.142">               sigDetailsObj.value,</span>
<a href="#l21.143"></a><span id="l21.143">               errorMsg,</span>
<a href="#l21.144"></a><span id="l21.144">               null, // blockSeparation</span>
<a href="#l21.145"></a><span id="l21.145">               encToDetailsObj.value,</span>
<a href="#l21.146"></a><span id="l21.146">               &quot;buggyMailFormat&quot;</span>
<a href="#l21.147"></a><span id="l21.147">             );</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineat">@@ -2840,17 +2847,17 @@ Enigmail.msg = {</span>
<a href="#l21.149"></a><span id="l21.149">       statusFlagsObj,</span>
<a href="#l21.150"></a><span id="l21.150">       errorMsgObj</span>
<a href="#l21.151"></a><span id="l21.151">     );</span>
<a href="#l21.152"></a><span id="l21.152"> </span>
<a href="#l21.153"></a><span id="l21.153">     if (!exitStatus || exitCodeObj.value !== 0) {</span>
<a href="#l21.154"></a><span id="l21.154">       exitStatus = false;</span>
<a href="#l21.155"></a><span id="l21.155">       if (</span>
<a href="#l21.156"></a><span id="l21.156">         statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY &amp;&amp;</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-        statusFlagsObj.value &amp; EnigmailConstants.UNVERIFIED_SIGNATURE</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+        statusFlagsObj.value &amp; EnigmailConstants.UNCERTAIN_SIGNATURE</span>
<a href="#l21.159"></a><span id="l21.159">       ) {</span>
<a href="#l21.160"></a><span id="l21.160">         if (callbackArg.actionType == &quot;openAttachment&quot;) {</span>
<a href="#l21.161"></a><span id="l21.161">           exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l21.162"></a><span id="l21.162">             window,</span>
<a href="#l21.163"></a><span id="l21.163">             EnigmailLocale.getString(&quot;decryptOkNoSig&quot;),</span>
<a href="#l21.164"></a><span id="l21.164">             EnigmailLocale.getString(&quot;msgOvl.button.contAnyway&quot;)</span>
<a href="#l21.165"></a><span id="l21.165">           );</span>
<a href="#l21.166"></a><span id="l21.166">         } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -803,17 +803,17 @@ Enigmail.msg = {</span>
<a href="#l22.4"></a><span id="l22.4">               //this.setFinalSendMode('final-signYes');</span>
<a href="#l22.5"></a><span id="l22.5">             }</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">             //this.disableSmime = true;</span>
<a href="#l22.8"></a><span id="l22.8">           } else if (</span>
<a href="#l22.9"></a><span id="l22.9">             msgFlags &amp;</span>
<a href="#l22.10"></a><span id="l22.10">             (EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l22.11"></a><span id="l22.11">               EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-              EnigmailConstants.UNVERIFIED_SIGNATURE)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+              EnigmailConstants.UNCERTAIN_SIGNATURE)</span>
<a href="#l22.14"></a><span id="l22.14">           ) {</span>
<a href="#l22.15"></a><span id="l22.15">             //this.setSendMode('sign');</span>
<a href="#l22.16"></a><span id="l22.16">             gIsRelatedToSignedOriginal = true;</span>
<a href="#l22.17"></a><span id="l22.17">           }</span>
<a href="#l22.18"></a><span id="l22.18">         }</span>
<a href="#l22.19"></a><span id="l22.19">         this.removeAttachedKey();</span>
<a href="#l22.20"></a><span id="l22.20">       }</span>
<a href="#l22.21"></a><span id="l22.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -188,30 +188,33 @@ Enigmail.hdrView = {</span>
<a href="#l23.4"></a><span id="l23.4">     if (s) {</span>
<a href="#l23.5"></a><span id="l23.5">       s.firstChild.data = txt;</span>
<a href="#l23.6"></a><span id="l23.6">     }</span>
<a href="#l23.7"></a><span id="l23.7">   },</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">   updateHdrIcons(</span>
<a href="#l23.10"></a><span id="l23.10">     exitCode,</span>
<a href="#l23.11"></a><span id="l23.11">     statusFlags,</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+    extStatusFlags,</span>
<a href="#l23.13"></a><span id="l23.13">     keyId,</span>
<a href="#l23.14"></a><span id="l23.14">     userId,</span>
<a href="#l23.15"></a><span id="l23.15">     sigDetails,</span>
<a href="#l23.16"></a><span id="l23.16">     errorMsg,</span>
<a href="#l23.17"></a><span id="l23.17">     blockSeparation,</span>
<a href="#l23.18"></a><span id="l23.18">     encToDetails,</span>
<a href="#l23.19"></a><span id="l23.19">     xtraStatus,</span>
<a href="#l23.20"></a><span id="l23.20">     encMimePartNumber</span>
<a href="#l23.21"></a><span id="l23.21">   ) {</span>
<a href="#l23.22"></a><span id="l23.22">     EnigmailLog.DEBUG(</span>
<a href="#l23.23"></a><span id="l23.23">       &quot;enigmailMsgHdrViewOverlay.js: this.updateHdrIcons: exitCode=&quot; +</span>
<a href="#l23.24"></a><span id="l23.24">         exitCode +</span>
<a href="#l23.25"></a><span id="l23.25">         &quot;, statusFlags=&quot; +</span>
<a href="#l23.26"></a><span id="l23.26">         statusFlags +</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+        &quot;, extStatusFlags=&quot; +</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+        extStatusFlags +</span>
<a href="#l23.29"></a><span id="l23.29">         &quot;, keyId=&quot; +</span>
<a href="#l23.30"></a><span id="l23.30">         keyId +</span>
<a href="#l23.31"></a><span id="l23.31">         &quot;, userId=&quot; +</span>
<a href="#l23.32"></a><span id="l23.32">         userId +</span>
<a href="#l23.33"></a><span id="l23.33">         &quot;, &quot; +</span>
<a href="#l23.34"></a><span id="l23.34">         errorMsg +</span>
<a href="#l23.35"></a><span id="l23.35">         &quot;\n&quot;</span>
<a href="#l23.36"></a><span id="l23.36">     );</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineat">@@ -294,17 +297,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39">       errorMsg = errorLines.join(&quot;\n&quot;) + &quot;\n...\n&quot; + lastLines;</span>
<a href="#l23.40"></a><span id="l23.40">     }</span>
<a href="#l23.41"></a><span id="l23.41"> </span>
<a href="#l23.42"></a><span id="l23.42">     var statusInfo = &quot;&quot;;</span>
<a href="#l23.43"></a><span id="l23.43"> </span>
<a href="#l23.44"></a><span id="l23.44">     if (statusFlags &amp; EnigmailConstants.NODATA) {</span>
<a href="#l23.45"></a><span id="l23.45">       if (statusFlags &amp; EnigmailConstants.PGP_MIME_SIGNED) {</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-        statusFlags |= EnigmailConstants.UNVERIFIED_SIGNATURE;</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+        statusFlags |= EnigmailConstants.UNCERTAIN_SIGNATURE;</span>
<a href="#l23.48"></a><span id="l23.48">       }</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50">       if (statusFlags &amp; EnigmailConstants.PGP_MIME_ENCRYPTED) {</span>
<a href="#l23.51"></a><span id="l23.51">         statusFlags |= EnigmailConstants.DECRYPTION_INCOMPLETE;</span>
<a href="#l23.52"></a><span id="l23.52">       }</span>
<a href="#l23.53"></a><span id="l23.53">     }</span>
<a href="#l23.54"></a><span id="l23.54"> </span>
<a href="#l23.55"></a><span id="l23.55">     if (!(statusFlags &amp; EnigmailConstants.PGP_MIME_ENCRYPTED)) {</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineat">@@ -325,17 +328,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.57"></a><span id="l23.57">     }</span>
<a href="#l23.58"></a><span id="l23.58"> </span>
<a href="#l23.59"></a><span id="l23.59">     var msgSigned =</span>
<a href="#l23.60"></a><span id="l23.60">       statusFlags &amp;</span>
<a href="#l23.61"></a><span id="l23.61">       (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l23.62"></a><span id="l23.62">         EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l23.63"></a><span id="l23.63">         EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l23.64"></a><span id="l23.64">         EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-        EnigmailConstants.UNVERIFIED_SIGNATURE |</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+        EnigmailConstants.UNCERTAIN_SIGNATURE |</span>
<a href="#l23.67"></a><span id="l23.67">         EnigmailConstants.REVOKED_KEY |</span>
<a href="#l23.68"></a><span id="l23.68">         EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l23.69"></a><span id="l23.69">         EnigmailConstants.EXPIRED_SIGNATURE);</span>
<a href="#l23.70"></a><span id="l23.70">     /*</span>
<a href="#l23.71"></a><span id="l23.71">     var msgEncrypted =</span>
<a href="#l23.72"></a><span id="l23.72">       statusFlags &amp;</span>
<a href="#l23.73"></a><span id="l23.73">       (EnigmailConstants.DECRYPTION_OKAY |</span>
<a href="#l23.74"></a><span id="l23.74">         EnigmailConstants.DECRYPTION_INCOMPLETE |</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineat">@@ -363,46 +366,42 @@ Enigmail.hdrView = {</span>
<a href="#l23.76"></a><span id="l23.76">         statusInfo = EnigmailLocale.getString(&quot;missingMdcError&quot;);</span>
<a href="#l23.77"></a><span id="l23.77">       } else if (statusFlags &amp; EnigmailConstants.MISSING_PASSPHRASE) {</span>
<a href="#l23.78"></a><span id="l23.78">         statusInfo = EnigmailLocale.getString(&quot;missingPassphrase&quot;);</span>
<a href="#l23.79"></a><span id="l23.79">       } else if (statusFlags &amp; EnigmailConstants.NO_SECKEY) {</span>
<a href="#l23.80"></a><span id="l23.80">         statusInfo = EnigmailLocale.getString(&quot;needKey&quot;);</span>
<a href="#l23.81"></a><span id="l23.81">       } else {</span>
<a href="#l23.82"></a><span id="l23.82">         statusInfo = EnigmailLocale.getString(&quot;failedDecrypt&quot;);</span>
<a href="#l23.83"></a><span id="l23.83">       }</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-    } else if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-      statusInfo = EnigmailLocale.getString(&quot;unverifiedSig&quot;);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+    } else if (statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) {</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+      statusInfo = EnigmailLocale.getString(&quot;uncertainSig&quot;);</span>
<a href="#l23.88"></a><span id="l23.88">     } else if (statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) {</span>
<a href="#l23.89"></a><span id="l23.89">       statusInfo = EnigmailLocale.getString(&quot;goodSig&quot;, [keyId]);</span>
<a href="#l23.90"></a><span id="l23.90">     } else if (</span>
<a href="#l23.91"></a><span id="l23.91">       statusFlags &amp;</span>
<a href="#l23.92"></a><span id="l23.92">       (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l23.93"></a><span id="l23.93">         EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l23.94"></a><span id="l23.94">         EnigmailConstants.EXPIRED_KEY_SIGNATURE)</span>
<a href="#l23.95"></a><span id="l23.95">     ) {</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-      statusInfo = EnigmailLocale.getString(&quot;unverifiedSig&quot;);</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+      statusInfo = EnigmailLocale.getString(&quot;badSig&quot;);</span>
<a href="#l23.98"></a><span id="l23.98">     } else if (statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l23.99"></a><span id="l23.99">       statusInfo = EnigmailLocale.getString(&quot;decryptedMsg&quot;);</span>
<a href="#l23.100"></a><span id="l23.100">     } else if (statusFlags &amp; EnigmailConstants.DECRYPTION_INCOMPLETE) {</span>
<a href="#l23.101"></a><span id="l23.101">       statusInfo = EnigmailLocale.getString(&quot;incompleteDecrypt&quot;);</span>
<a href="#l23.102"></a><span id="l23.102">     } else if (statusFlags &amp; EnigmailConstants.IMPORTED_KEY) {</span>
<a href="#l23.103"></a><span id="l23.103">       statusInfo = &quot;&quot;;</span>
<a href="#l23.104"></a><span id="l23.104">       EnigmailDialog.info(window, errorMsg);</span>
<a href="#l23.105"></a><span id="l23.105">     }</span>
<a href="#l23.106"></a><span id="l23.106">     // add key infos if available</span>
<a href="#l23.107"></a><span id="l23.107">     if (keyId) {</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-      var si = EnigmailLocale.getString(&quot;unverifiedSig&quot;); // &quot;Unverified signature&quot;</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+      var si = EnigmailLocale.getString(&quot;uncertainSig&quot;); // &quot;Uncertain signature&quot;</span>
<a href="#l23.110"></a><span id="l23.110">       if (statusInfo === &quot;&quot;) {</span>
<a href="#l23.111"></a><span id="l23.111">         statusInfo += si;</span>
<a href="#l23.112"></a><span id="l23.112">       }</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-      if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-        statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;keyNeeded&quot;, [keyId]); // &quot;public key ... needed&quot;</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-      } else {</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-        statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;keyUsed&quot;, [keyId]); // &quot;public key ... used&quot;</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-      }</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+      statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;signatureFrom&quot;, [keyId]);</span>
<a href="#l23.119"></a><span id="l23.119">     }</span>
<a href="#l23.120"></a><span id="l23.120">     //statusInfo += &quot;\n\n&quot; + errorMsg;</span>
<a href="#l23.121"></a><span id="l23.121"> </span>
<a href="#l23.122"></a><span id="l23.122">     if (</span>
<a href="#l23.123"></a><span id="l23.123">       statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY ||</span>
<a href="#l23.124"></a><span id="l23.124">       this.isEncrypted === &quot;ok&quot;</span>
<a href="#l23.125"></a><span id="l23.125">     ) {</span>
<a href="#l23.126"></a><span id="l23.126">       var statusMsg;</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineat">@@ -423,17 +422,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.128"></a><span id="l23.128">     }</span>
<a href="#l23.129"></a><span id="l23.129"> </span>
<a href="#l23.130"></a><span id="l23.130">     // TODO: if encToDetails.length then make it available in status</span>
<a href="#l23.131"></a><span id="l23.131">     // EnigmailLocale.getString(&quot;encryptKeysNote&quot;, [encToDetails]);</span>
<a href="#l23.132"></a><span id="l23.132"> </span>
<a href="#l23.133"></a><span id="l23.133">     /*</span>
<a href="#l23.134"></a><span id="l23.134">     if (xtraStatus === &quot;process-manually&quot;) {</span>
<a href="#l23.135"></a><span id="l23.135">       let buttonLabel = &quot;&quot;;</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-      if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) {</span>
<a href="#l23.138"></a><span id="l23.138">         statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [</span>
<a href="#l23.139"></a><span id="l23.139">           EnigmailLocale.getString(&quot;msgSigned&quot;),</span>
<a href="#l23.140"></a><span id="l23.140">         ]);</span>
<a href="#l23.141"></a><span id="l23.141">         statusLine += EnigmailLocale.getString(&quot;verifyManually&quot;);</span>
<a href="#l23.142"></a><span id="l23.142">         buttonLabel = EnigmailLocale.getString(&quot;headerView.button.verify&quot;);</span>
<a href="#l23.143"></a><span id="l23.143">       } else {</span>
<a href="#l23.144"></a><span id="l23.144">         statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [</span>
<a href="#l23.145"></a><span id="l23.145">           EnigmailLocale.getString(&quot;msgEncrypted&quot;),</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineat">@@ -445,31 +444,32 @@ Enigmail.hdrView = {</span>
<a href="#l23.147"></a><span id="l23.147">       Enigmail.msg.securityInfo = {};</span>
<a href="#l23.148"></a><span id="l23.148">       this.displayFlexAction(statusLine, buttonLabel, xtraStatus);</span>
<a href="#l23.149"></a><span id="l23.149">       return;</span>
<a href="#l23.150"></a><span id="l23.150">     }</span>
<a href="#l23.151"></a><span id="l23.151">     */</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153">     let tmp = {</span>
<a href="#l23.154"></a><span id="l23.154">       statusFlags,</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+      extStatusFlags,</span>
<a href="#l23.156"></a><span id="l23.156">       keyId,</span>
<a href="#l23.157"></a><span id="l23.157">       userId,</span>
<a href="#l23.158"></a><span id="l23.158">       msgSigned,</span>
<a href="#l23.159"></a><span id="l23.159">       statusInfo,</span>
<a href="#l23.160"></a><span id="l23.160">       fullStatusInfo,</span>
<a href="#l23.161"></a><span id="l23.161">       blockSeparation,</span>
<a href="#l23.162"></a><span id="l23.162">       xtraStatus,</span>
<a href="#l23.163"></a><span id="l23.163">       encryptedMimePart: encMimePartNumber,</span>
<a href="#l23.164"></a><span id="l23.164">     };</span>
<a href="#l23.165"></a><span id="l23.165">     Enigmail.msg.securityInfo = tmp;</span>
<a href="#l23.166"></a><span id="l23.166"> </span>
<a href="#l23.167"></a><span id="l23.167">     //Enigmail.msg.createArtificialAutocryptHeader();</span>
<a href="#l23.168"></a><span id="l23.168"> </span>
<a href="#l23.169"></a><span id="l23.169">     /*</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-    if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+    if (statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) {</span>
<a href="#l23.172"></a><span id="l23.172">       this.tryImportAutocryptHeader();</span>
<a href="#l23.173"></a><span id="l23.173">     }</span>
<a href="#l23.174"></a><span id="l23.174">     */</span>
<a href="#l23.175"></a><span id="l23.175"> </span>
<a href="#l23.176"></a><span id="l23.176">     this.displayStatusBar();</span>
<a href="#l23.177"></a><span id="l23.177">     this.updateMsgDb();</span>
<a href="#l23.178"></a><span id="l23.178">   },</span>
<a href="#l23.179"></a><span id="l23.179"> </span>
<a href="#l23.180"></a><span id="l23.180" class="difflineat">@@ -560,17 +560,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.181"></a><span id="l23.181">       enigMsgPane.textContent = EnigmailLocale.getString(</span>
<a href="#l23.182"></a><span id="l23.182">         &quot;wksConfirmationReq.message&quot;</span>
<a href="#l23.183"></a><span id="l23.183">       );</span>
<a href="#l23.184"></a><span id="l23.184">     }</span>
<a href="#l23.185"></a><span id="l23.185">   },</span>
<a href="#l23.186"></a><span id="l23.186">   */</span>
<a href="#l23.187"></a><span id="l23.187"> </span>
<a href="#l23.188"></a><span id="l23.188">   /**</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-   * Try to import an autocrypt header from an unverified signature</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+   * Try to import an autocrypt header from an uncertain signature</span>
<a href="#l23.191"></a><span id="l23.191">    * (i.e. the sender's key is not available)</span>
<a href="#l23.192"></a><span id="l23.192">    */</span>
<a href="#l23.193"></a><span id="l23.193">   /*</span>
<a href="#l23.194"></a><span id="l23.194">   tryImportAutocryptHeader() {</span>
<a href="#l23.195"></a><span id="l23.195">     EnigmailLog.DEBUG(</span>
<a href="#l23.196"></a><span id="l23.196">       &quot;enigmailMsgHdrViewOverlay.js: tryImportAutocryptHeader()\n&quot;</span>
<a href="#l23.197"></a><span id="l23.197">     );</span>
<a href="#l23.198"></a><span id="l23.198"> </span>
<a href="#l23.199"></a><span id="l23.199" class="difflineat">@@ -637,26 +637,28 @@ Enigmail.hdrView = {</span>
<a href="#l23.200"></a><span id="l23.200"> </span>
<a href="#l23.201"></a><span id="l23.201">   displayStatusBar() {</span>
<a href="#l23.202"></a><span id="l23.202">     //let statusText = document.getElementById(&quot;enigmailStatusText&quot;);</span>
<a href="#l23.203"></a><span id="l23.203">     //let icon = document.getElementById(&quot;enigToggleHeaderView2&quot;);</span>
<a href="#l23.204"></a><span id="l23.204">     let bodyElement = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l23.205"></a><span id="l23.205"> </span>
<a href="#l23.206"></a><span id="l23.206">     let secInfo = Enigmail.msg.securityInfo;</span>
<a href="#l23.207"></a><span id="l23.207">     let statusFlags = secInfo.statusFlags;</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+    let extStatusFlags =</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+      &quot;extStatusFlags&quot; in secInfo ? secInfo.extStatusFlags : 0;</span>
<a href="#l23.210"></a><span id="l23.210">     let sMimeContainer, encryptedUINode, signedUINode;</span>
<a href="#l23.211"></a><span id="l23.211"> </span>
<a href="#l23.212"></a><span id="l23.212">     if (secInfo.statusInfo) {</span>
<a href="#l23.213"></a><span id="l23.213">       this.setStatusText(secInfo.statusInfo + &quot; &quot;);</span>
<a href="#l23.214"></a><span id="l23.214">       //this.enigmailBox.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l23.215"></a><span id="l23.215"> </span>
<a href="#l23.216"></a><span id="l23.216">       /*</span>
<a href="#l23.217"></a><span id="l23.217">       if (</span>
<a href="#l23.218"></a><span id="l23.218">         (secInfo.keyId &amp;&amp;</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-          statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) ||</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+          statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) ||</span>
<a href="#l23.221"></a><span id="l23.221">         statusFlags &amp; EnigmailConstants.INLINE_KEY</span>
<a href="#l23.222"></a><span id="l23.222">       ) {</span>
<a href="#l23.223"></a><span id="l23.223">         document.getElementById(&quot;enigmail_importKey&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l23.224"></a><span id="l23.224">       } else {</span>
<a href="#l23.225"></a><span id="l23.225">         document</span>
<a href="#l23.226"></a><span id="l23.226">           .getElementById(&quot;enigmail_importKey&quot;)</span>
<a href="#l23.227"></a><span id="l23.227">           .setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l23.228"></a><span id="l23.228">       }</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineat">@@ -704,48 +706,51 @@ Enigmail.hdrView = {</span>
<a href="#l23.230"></a><span id="l23.230">         statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE &amp;&amp;</span>
<a href="#l23.231"></a><span id="l23.231">         !(</span>
<a href="#l23.232"></a><span id="l23.232">           statusFlags &amp;</span>
<a href="#l23.233"></a><span id="l23.233">           (EnigmailConstants.REVOKED_KEY |</span>
<a href="#l23.234"></a><span id="l23.234">             EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l23.235"></a><span id="l23.235">             EnigmailConstants.EXPIRED_SIGNATURE)</span>
<a href="#l23.236"></a><span id="l23.236">         )</span>
<a href="#l23.237"></a><span id="l23.237">       ) {</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-        let val =</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-          statusFlags &amp; EnigmailConstants.TRUSTED_IDENTITY</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-            ? &quot;verified&quot;</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-            : &quot;unverified&quot;;</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+        let val;</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+        if (extStatusFlags &amp; EnigmailConstants.EXT_SELF_IDENTITY) {</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+          val = &quot;ok&quot;;</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+        } else if (statusFlags &amp; EnigmailConstants.TRUSTED_IDENTITY) {</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+          val = &quot;verified&quot;;</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineplus">+        } else {</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineplus">+          val = &quot;unverified&quot;;</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineplus">+        }</span>
<a href="#l23.250"></a><span id="l23.250"> </span>
<a href="#l23.251"></a><span id="l23.251">         // Display trusted good signature icon</span>
<a href="#l23.252"></a><span id="l23.252">         signedUINode.setAttribute(&quot;signed&quot;, val);</span>
<a href="#l23.253"></a><span id="l23.253">         /*</span>
<a href="#l23.254"></a><span id="l23.254">         this.enigmailBox.setAttribute(</span>
<a href="#l23.255"></a><span id="l23.255">           &quot;class&quot;,</span>
<a href="#l23.256"></a><span id="l23.256">           &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureOk&quot;</span>
<a href="#l23.257"></a><span id="l23.257">         );</span>
<a href="#l23.258"></a><span id="l23.258">         */</span>
<a href="#l23.259"></a><span id="l23.259">         this.isSigned = val;</span>
<a href="#l23.260"></a><span id="l23.260">         bodyElement.setAttribute(&quot;enigSigned&quot;, val);</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-      } else if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-        // Display unverified signature icon</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+      } else if (statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) {</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+        // Display uncertain signature icon</span>
<a href="#l23.265"></a><span id="l23.265">         signedUINode.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l23.266"></a><span id="l23.266">         /*</span>
<a href="#l23.267"></a><span id="l23.267">         this.enigmailBox.setAttribute(</span>
<a href="#l23.268"></a><span id="l23.268">           &quot;class&quot;,</span>
<a href="#l23.269"></a><span id="l23.269">           &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;</span>
<a href="#l23.270"></a><span id="l23.270">         );</span>
<a href="#l23.271"></a><span id="l23.271">         */</span>
<a href="#l23.272"></a><span id="l23.272">         this.isSigned = &quot;unknown&quot;;</span>
<a href="#l23.273"></a><span id="l23.273">       } else if (</span>
<a href="#l23.274"></a><span id="l23.274">         statusFlags &amp;</span>
<a href="#l23.275"></a><span id="l23.275">         (EnigmailConstants.REVOKED_KEY |</span>
<a href="#l23.276"></a><span id="l23.276">           EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l23.277"></a><span id="l23.277">           EnigmailConstants.EXPIRED_SIGNATURE)</span>
<a href="#l23.278"></a><span id="l23.278">       ) {</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-        // Display unverified signature icon</span>
<a href="#l23.280"></a><span id="l23.280">         signedUINode.setAttribute(&quot;signed&quot;, &quot;notok&quot;);</span>
<a href="#l23.281"></a><span id="l23.281">         /*</span>
<a href="#l23.282"></a><span id="l23.282">         this.enigmailBox.setAttribute(</span>
<a href="#l23.283"></a><span id="l23.283">           &quot;class&quot;,</span>
<a href="#l23.284"></a><span id="l23.284">           &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureVerified&quot;</span>
<a href="#l23.285"></a><span id="l23.285">         );</span>
<a href="#l23.286"></a><span id="l23.286">         */</span>
<a href="#l23.287"></a><span id="l23.287">         this.isSigned = &quot;notok&quot;;</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineat">@@ -884,28 +889,28 @@ Enigmail.hdrView = {</span>
<a href="#l23.289"></a><span id="l23.289">       }</span>
<a href="#l23.290"></a><span id="l23.290">       if (Enigmail.msg.securityInfo.msgSigned) {</span>
<a href="#l23.291"></a><span id="l23.291">         signedMsg = true;</span>
<a href="#l23.292"></a><span id="l23.292">         if (</span>
<a href="#l23.293"></a><span id="l23.293">           !(</span>
<a href="#l23.294"></a><span id="l23.294">             Enigmail.msg.securityInfo.statusFlags &amp;</span>
<a href="#l23.295"></a><span id="l23.295">             (EnigmailConstants.REVOKED_KEY |</span>
<a href="#l23.296"></a><span id="l23.296">               EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineminus">-              EnigmailConstants.UNVERIFIED_SIGNATURE)</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineplus">+              EnigmailConstants.UNCERTAIN_SIGNATURE)</span>
<a href="#l23.299"></a><span id="l23.299">           )</span>
<a href="#l23.300"></a><span id="l23.300">         ) {</span>
<a href="#l23.301"></a><span id="l23.301">           sign = true;</span>
<a href="#l23.302"></a><span id="l23.302">         }</span>
<a href="#l23.303"></a><span id="l23.303">         if (keyObj &amp;&amp; keyObj.isOwnerTrustUseful()) {</span>
<a href="#l23.304"></a><span id="l23.304">           trust = true;</span>
<a href="#l23.305"></a><span id="l23.305">         }</span>
<a href="#l23.306"></a><span id="l23.306"> </span>
<a href="#l23.307"></a><span id="l23.307">         if (</span>
<a href="#l23.308"></a><span id="l23.308">           Enigmail.msg.securityInfo.statusFlags &amp;</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-          EnigmailConstants.UNVERIFIED_SIGNATURE</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineplus">+          EnigmailConstants.UNCERTAIN_SIGNATURE</span>
<a href="#l23.311"></a><span id="l23.311">         ) {</span>
<a href="#l23.312"></a><span id="l23.312">           unknown = true;</span>
<a href="#l23.313"></a><span id="l23.313">         }</span>
<a href="#l23.314"></a><span id="l23.314">       }</span>
<a href="#l23.315"></a><span id="l23.315">     }</span>
<a href="#l23.316"></a><span id="l23.316"> </span>
<a href="#l23.317"></a><span id="l23.317">     if (elemTrust) {</span>
<a href="#l23.318"></a><span id="l23.318">       setElemStatus(elemTrust, trust);</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineat">@@ -1452,16 +1457,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.320"></a><span id="l23.320"> </span>
<a href="#l23.321"></a><span id="l23.321">       return false;</span>
<a href="#l23.322"></a><span id="l23.322">     },</span>
<a href="#l23.323"></a><span id="l23.323"> </span>
<a href="#l23.324"></a><span id="l23.324">     updateSecurityStatus(</span>
<a href="#l23.325"></a><span id="l23.325">       unusedUriSpec,</span>
<a href="#l23.326"></a><span id="l23.326">       exitCode,</span>
<a href="#l23.327"></a><span id="l23.327">       statusFlags,</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineplus">+      extStatusFlags,</span>
<a href="#l23.329"></a><span id="l23.329">       keyId,</span>
<a href="#l23.330"></a><span id="l23.330">       userId,</span>
<a href="#l23.331"></a><span id="l23.331">       sigDetails,</span>
<a href="#l23.332"></a><span id="l23.332">       errorMsg,</span>
<a href="#l23.333"></a><span id="l23.333">       blockSeparation,</span>
<a href="#l23.334"></a><span id="l23.334">       uri,</span>
<a href="#l23.335"></a><span id="l23.335">       extraDetails,</span>
<a href="#l23.336"></a><span id="l23.336">       mimePartNumber</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineat">@@ -1508,16 +1514,17 @@ Enigmail.hdrView = {</span>
<a href="#l23.338"></a><span id="l23.338">           } catch (x) {</span>
<a href="#l23.339"></a><span id="l23.339">             console.debug(x);</span>
<a href="#l23.340"></a><span id="l23.340">           }</span>
<a href="#l23.341"></a><span id="l23.341">         }</span>
<a href="#l23.342"></a><span id="l23.342"> </span>
<a href="#l23.343"></a><span id="l23.343">         Enigmail.hdrView.updateHdrIcons(</span>
<a href="#l23.344"></a><span id="l23.344">           exitCode,</span>
<a href="#l23.345"></a><span id="l23.345">           statusFlags,</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+          extStatusFlags,</span>
<a href="#l23.347"></a><span id="l23.347">           keyId,</span>
<a href="#l23.348"></a><span id="l23.348">           userId,</span>
<a href="#l23.349"></a><span id="l23.349">           sigDetails,</span>
<a href="#l23.350"></a><span id="l23.350">           errorMsg,</span>
<a href="#l23.351"></a><span id="l23.351">           blockSeparation,</span>
<a href="#l23.352"></a><span id="l23.352">           encToDetails,</span>
<a href="#l23.353"></a><span id="l23.353">           null,</span>
<a href="#l23.354"></a><span id="l23.354">           mimePartNumber</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -14,95 +14,124 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> // from enigmailKeyManager.js:</span>
<a href="#l24.6"></a><span id="l24.6"> /* global keyMgrAddPhoto: false, EnigmailCompat: false */</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> &quot;use strict&quot;;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+var { uidHelper } = ChromeUtils.import(</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/uidHelper.jsm&quot;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+const { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+</span>
<a href="#l24.19"></a><span id="l24.19"> var gKeyId = null;</span>
<a href="#l24.20"></a><span id="l24.20"> var gUserId = null;</span>
<a href="#l24.21"></a><span id="l24.21"> var gKeyList = null;</span>
<a href="#l24.22"></a><span id="l24.22"> var gTreeFuncs = null;</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-function onLoad() {</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+var gAllEmails = [];</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+var gFingerprint = &quot;&quot;;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+var gAcceptanceRadio = null;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+var gOriginalAcceptance;</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+var gUpdateAllowed = false;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+async function onLoad() {</span>
<a href="#l24.33"></a><span id="l24.33">   window.arguments[1].refresh = false;</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  gAcceptanceRadio = document.getElementById(&quot;acceptanceRadio&quot;);</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+</span>
<a href="#l24.37"></a><span id="l24.37">   gKeyId = window.arguments[0].keyId;</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39">   let accept = document</span>
<a href="#l24.40"></a><span id="l24.40">     .getElementById(&quot;enigmailKeyDetailsDlg&quot;)</span>
<a href="#l24.41"></a><span id="l24.41">     .getButton(&quot;accept&quot;);</span>
<a href="#l24.42"></a><span id="l24.42">   accept.focus();</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-  reloadData();</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+  await reloadData();</span>
<a href="#l24.46"></a><span id="l24.46"> }</span>
<a href="#l24.47"></a><span id="l24.47"> </span>
<a href="#l24.48"></a><span id="l24.48"> /***</span>
<a href="#l24.49"></a><span id="l24.49">  * Set the label text of a HTML element</span>
<a href="#l24.50"></a><span id="l24.50">  */</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52"> function setText(elementId, label) {</span>
<a href="#l24.53"></a><span id="l24.53">   let node = document.getElementById(elementId);</span>
<a href="#l24.54"></a><span id="l24.54">   node.textContent = label;</span>
<a href="#l24.55"></a><span id="l24.55"> }</span>
<a href="#l24.56"></a><span id="l24.56"> </span>
<a href="#l24.57"></a><span id="l24.57"> function setLabel(elementId, label) {</span>
<a href="#l24.58"></a><span id="l24.58">   let node = document.getElementById(elementId);</span>
<a href="#l24.59"></a><span id="l24.59">   node.setAttribute(&quot;value&quot;, label);</span>
<a href="#l24.60"></a><span id="l24.60"> }</span>
<a href="#l24.61"></a><span id="l24.61"> </span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-function reloadData() {</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+async function reloadData() {</span>
<a href="#l24.64"></a><span id="l24.64">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l24.65"></a><span id="l24.65">   if (!enigmailSvc) {</span>
<a href="#l24.66"></a><span id="l24.66">     EnigAlert(EnigmailLocale.getString(&quot;accessError&quot;));</span>
<a href="#l24.67"></a><span id="l24.67">     window.close();</span>
<a href="#l24.68"></a><span id="l24.68">     return;</span>
<a href="#l24.69"></a><span id="l24.69">   }</span>
<a href="#l24.70"></a><span id="l24.70"> </span>
<a href="#l24.71"></a><span id="l24.71">   gUserId = null;</span>
<a href="#l24.72"></a><span id="l24.72"> </span>
<a href="#l24.73"></a><span id="l24.73">   var treeChildren = document.getElementById(&quot;keyListChildren&quot;);</span>
<a href="#l24.74"></a><span id="l24.74">   var uidList = document.getElementById(&quot;additionalUid&quot;);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  var photoImg = document.getElementById(&quot;photoIdImg&quot;);</span>
<a href="#l24.76"></a><span id="l24.76"> </span>
<a href="#l24.77"></a><span id="l24.77">   // clean lists</span>
<a href="#l24.78"></a><span id="l24.78">   EnigCleanGuiList(treeChildren);</span>
<a href="#l24.79"></a><span id="l24.79">   EnigCleanGuiList(uidList);</span>
<a href="#l24.80"></a><span id="l24.80"> </span>
<a href="#l24.81"></a><span id="l24.81">   let keyObj = EnigmailKeyRing.getKeyById(gKeyId);</span>
<a href="#l24.82"></a><span id="l24.82">   if (keyObj) {</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    let keyIsExpired =</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+      keyObj.expiryTime &amp;&amp; keyObj.expiryTime &lt; Math.floor(Date.now() / 1000);</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+    let acceptanceIntroText = &quot;&quot;;</span>
<a href="#l24.87"></a><span id="l24.87">     if (keyObj.secretAvailable) {</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-      setLabel(&quot;keyType&quot;, EnigmailLocale.getString(&quot;keyTypePair&quot;));</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+      setLabel(&quot;keyType&quot;, EnigmailLocale.getString(&quot;keyTypePair2&quot;));</span>
<a href="#l24.90"></a><span id="l24.90">       document.getElementById(&quot;ownKeyCommands&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+      acceptanceIntroText = EnigmailLocale.getString(&quot;keyAutoAcceptPersonal&quot;);</span>
<a href="#l24.92"></a><span id="l24.92">     } else {</span>
<a href="#l24.93"></a><span id="l24.93">       document.getElementById(&quot;ownKeyCommands&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l24.94"></a><span id="l24.94">       setLabel(&quot;keyType&quot;, EnigmailLocale.getString(&quot;keyTypePublic&quot;));</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-    }</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-    if (keyObj.photoAvailable === true) {</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-      let pFile = keyObj.getPhotoFile(0);</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+      let isStillValid = !(</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+        keyObj.keyTrust == &quot;r&quot; ||</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+        keyObj.keyTrust == &quot;e&quot; ||</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+        keyIsExpired</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+      );</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+      if (isStillValid) {</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+        document</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+          .getElementById(&quot;acceptanceRadio&quot;)</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+          .setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+        acceptanceIntroText = EnigmailLocale.getString(&quot;keyDoYouAccept&quot;);</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+        gUpdateAllowed = true;</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-      if (pFile &amp;&amp; pFile.isFile() &amp;&amp; pFile.isReadable()) {</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-        const photoUri = Services.io.newFileURI(pFile).spec;</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+        let acceptanceResult = {};</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+        await PgpSqliteDb2.getFingerprintAcceptance(</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+          null,</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+          keyObj.fpr,</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+          acceptanceResult</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+        );</span>
<a href="#l24.119"></a><span id="l24.119"> </span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-        photoImg.setAttribute(&quot;src&quot;, photoUri);</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-        photoImg.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+        if (</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+          &quot;fingerprintAcceptance&quot; in acceptanceResult &amp;&amp;</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+          acceptanceResult.fingerprintAcceptance != &quot;undecided&quot;</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+        ) {</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+          gOriginalAcceptance = acceptanceResult.fingerprintAcceptance;</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+        } else {</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+          gOriginalAcceptance = &quot;undecided&quot;;</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+        }</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+        gAcceptanceRadio.value = gOriginalAcceptance;</span>
<a href="#l24.131"></a><span id="l24.131">       }</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-    } else {</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-      photoImg.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-    }</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-    if (keyObj.isOwnerTrustUseful()) {</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-      document.getElementById(&quot;setOwnerTrust&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-    } else {</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-      document</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-        .getElementById(&quot;setOwnerTrust&quot;)</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-        .setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l24.142"></a><span id="l24.142">     }</span>
<a href="#l24.143"></a><span id="l24.143"> </span>
<a href="#l24.144"></a><span id="l24.144">     if (keyObj.hasSubUserIds()) {</span>
<a href="#l24.145"></a><span id="l24.145">       document.getElementById(&quot;alsoknown&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l24.146"></a><span id="l24.146">       createUidData(uidList, keyObj);</span>
<a href="#l24.147"></a><span id="l24.147">     } else {</span>
<a href="#l24.148"></a><span id="l24.148">       document.getElementById(&quot;alsoknown&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l24.149"></a><span id="l24.149">     }</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineat">@@ -113,39 +142,62 @@ function reloadData() {</span>
<a href="#l24.151"></a><span id="l24.151">       tree.view = sigListViewObj;</span>
<a href="#l24.152"></a><span id="l24.152">       gTreeFuncs = EnigmailCompat.getTreeCompatibleFuncs(tree, sigListViewObj);</span>
<a href="#l24.153"></a><span id="l24.153">     }</span>
<a href="#l24.154"></a><span id="l24.154"> </span>
<a href="#l24.155"></a><span id="l24.155">     let subkeyListViewObj = new SubkeyListView(keyObj);</span>
<a href="#l24.156"></a><span id="l24.156">     document.getElementById(&quot;subkeyList&quot;).view = subkeyListViewObj;</span>
<a href="#l24.157"></a><span id="l24.157"> </span>
<a href="#l24.158"></a><span id="l24.158">     gUserId = keyObj.userId;</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-    let expiryDate = keyObj.expiry;</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-    if (expiryDate.length === 0) {</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-      expiryDate = EnigmailLocale.getString(&quot;keyDoesNotExpire&quot;);</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+    let splitUid = {};</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+    uidHelper.getPartsFromUidStr(keyObj.userId, splitUid);</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+    if (splitUid.email) {</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+      gAllEmails.push(splitUid.email);</span>
<a href="#l24.167"></a><span id="l24.167">     }</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+</span>
<a href="#l24.169"></a><span id="l24.169">     setLabel(&quot;userId&quot;, gUserId);</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-    setText(&quot;keyValidity&quot;, getTrustLabel(keyObj.keyTrust));</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-    setText(&quot;ownerTrust&quot;, getTrustLabel(keyObj.ownerTrust));</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-    setText(&quot;keyCreated&quot;, keyObj.created);</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-    setText(&quot;keyExpiry&quot;, expiryDate);</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+    setLabel(&quot;keyCreated&quot;, keyObj.created);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+    let expiryInfo;</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+    if (keyObj.keyTrust == &quot;r&quot;) {</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+      expiryInfo = EnigmailLocale.getString(&quot;keyRevoked&quot;);</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+      acceptanceIntroText = expiryInfo;</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+    } else if (keyObj.keyTrust == &quot;e&quot; || keyIsExpired) {</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+      expiryInfo = EnigmailLocale.getString(&quot;keyExpired&quot;, keyObj.expiry);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+      acceptanceIntroText = expiryInfo;</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+    } else if (keyObj.expiry.length === 0) {</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+      expiryInfo = EnigmailLocale.getString(&quot;keyDoesNotExpire&quot;);</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+    } else {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+      expiryInfo = keyObj.expiry;</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+    }</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineplus">+    setText(&quot;acceptanceIntro&quot;, acceptanceIntroText);</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineplus">+    setLabel(&quot;keyExpiry&quot;, expiryInfo);</span>
<a href="#l24.191"></a><span id="l24.191">     if (keyObj.fpr) {</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+      gFingerprint = keyObj.fpr;</span>
<a href="#l24.193"></a><span id="l24.193">       setLabel(&quot;fingerprint&quot;, EnigmailKey.formatFpr(keyObj.fpr));</span>
<a href="#l24.194"></a><span id="l24.194">     }</span>
<a href="#l24.195"></a><span id="l24.195">   }</span>
<a href="#l24.196"></a><span id="l24.196"> }</span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198"> function createUidData(listNode, keyDetails) {</span>
<a href="#l24.199"></a><span id="l24.199">   for (let i = 1; i &lt; keyDetails.userIds.length; i++) {</span>
<a href="#l24.200"></a><span id="l24.200">     if (keyDetails.userIds[i].type === &quot;uid&quot;) {</span>
<a href="#l24.201"></a><span id="l24.201">       let item = listNode.appendItem(keyDetails.userIds[i].userId);</span>
<a href="#l24.202"></a><span id="l24.202">       item.setAttribute(&quot;label&quot;, keyDetails.userIds[i].userId);</span>
<a href="#l24.203"></a><span id="l24.203">       if (&quot;dre&quot;.search(keyDetails.userIds[i].keyTrust) &gt;= 0) {</span>
<a href="#l24.204"></a><span id="l24.204">         item.setAttribute(&quot;class&quot;, &quot;enigmailDisabled&quot;);</span>
<a href="#l24.205"></a><span id="l24.205">       }</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+      let splitUid = {};</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+      uidHelper.getPartsFromUidStr(keyDetails.userIds[i].userId, splitUid);</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+      if (splitUid.email) {</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineplus">+        gAllEmails.push(splitUid.email);</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+      }</span>
<a href="#l24.212"></a><span id="l24.212">     }</span>
<a href="#l24.213"></a><span id="l24.213">   }</span>
<a href="#l24.214"></a><span id="l24.214"> }</span>
<a href="#l24.215"></a><span id="l24.215"> </span>
<a href="#l24.216"></a><span id="l24.216"> function getTrustLabel(trustCode) {</span>
<a href="#l24.217"></a><span id="l24.217">   var trustTxt = EnigGetTrustLabel(trustCode);</span>
<a href="#l24.218"></a><span id="l24.218">   if (trustTxt == &quot;-&quot; || trustTxt.length === 0) {</span>
<a href="#l24.219"></a><span id="l24.219">     trustTxt = EnigmailLocale.getString(&quot;keyValid.unknown&quot;);</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineat">@@ -161,45 +213,33 @@ function setAttr(attribute, value) {</span>
<a href="#l24.221"></a><span id="l24.221"> }</span>
<a href="#l24.222"></a><span id="l24.222"> </span>
<a href="#l24.223"></a><span id="l24.223"> function enableRefresh() {</span>
<a href="#l24.224"></a><span id="l24.224">   window.arguments[1].refresh = true;</span>
<a href="#l24.225"></a><span id="l24.225"> }</span>
<a href="#l24.226"></a><span id="l24.226"> </span>
<a href="#l24.227"></a><span id="l24.227"> // ------------------ onCommand Functions  -----------------</span>
<a href="#l24.228"></a><span id="l24.228"> </span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-function showPhoto() {</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-  EnigShowPhoto(gKeyId, gUserId, 0);</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineminus">-}</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-function keyDetailsAddPhoto() {</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-  keyMgrAddPhoto(gUserId, gKeyId);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-}</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineplus">+/*</span>
<a href="#l24.238"></a><span id="l24.238"> function signKey() {</span>
<a href="#l24.239"></a><span id="l24.239">   if (EnigSignKey(gUserId, gKeyId, null)) {</span>
<a href="#l24.240"></a><span id="l24.240">     enableRefresh();</span>
<a href="#l24.241"></a><span id="l24.241">     reloadData();</span>
<a href="#l24.242"></a><span id="l24.242">   }</span>
<a href="#l24.243"></a><span id="l24.243"> }</span>
<a href="#l24.244"></a><span id="l24.244"> </span>
<a href="#l24.245"></a><span id="l24.245"> function changeExpirationDate() {</span>
<a href="#l24.246"></a><span id="l24.246">   if (EnigEditKeyExpiry([gUserId], [gKeyId])) {</span>
<a href="#l24.247"></a><span id="l24.247">     enableRefresh();</span>
<a href="#l24.248"></a><span id="l24.248">     reloadData();</span>
<a href="#l24.249"></a><span id="l24.249">   }</span>
<a href="#l24.250"></a><span id="l24.250"> }</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+*/</span>
<a href="#l24.252"></a><span id="l24.252"> </span>
<a href="#l24.253"></a><span id="l24.253" class="difflineminus">-function setOwnerTrust() {</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-  if (EnigEditKeyTrust([gUserId], [gKeyId])) {</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-    enableRefresh();</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-    reloadData();</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-  }</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-}</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineplus">+/*</span>
<a href="#l24.261"></a><span id="l24.261"> function manageUids() {</span>
<a href="#l24.262"></a><span id="l24.262">   let keyObj = EnigmailKeyRing.getKeyById(gKeyId);</span>
<a href="#l24.263"></a><span id="l24.263"> </span>
<a href="#l24.264"></a><span id="l24.264">   var inputObj = {</span>
<a href="#l24.265"></a><span id="l24.265">     keyId: keyObj.keyId,</span>
<a href="#l24.266"></a><span id="l24.266">     ownKey: keyObj.secretAvailable,</span>
<a href="#l24.267"></a><span id="l24.267">   };</span>
<a href="#l24.268"></a><span id="l24.268"> </span>
<a href="#l24.269"></a><span id="l24.269" class="difflineat">@@ -213,58 +253,60 @@ function manageUids() {</span>
<a href="#l24.270"></a><span id="l24.270">     inputObj,</span>
<a href="#l24.271"></a><span id="l24.271">     resultObj</span>
<a href="#l24.272"></a><span id="l24.272">   );</span>
<a href="#l24.273"></a><span id="l24.273">   if (resultObj.refresh) {</span>
<a href="#l24.274"></a><span id="l24.274">     enableRefresh();</span>
<a href="#l24.275"></a><span id="l24.275">     reloadData();</span>
<a href="#l24.276"></a><span id="l24.276">   }</span>
<a href="#l24.277"></a><span id="l24.277"> }</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineplus">+*/</span>
<a href="#l24.279"></a><span id="l24.279"> </span>
<a href="#l24.280"></a><span id="l24.280" class="difflineplus">+/*</span>
<a href="#l24.281"></a><span id="l24.281"> function changePassword() {</span>
<a href="#l24.282"></a><span id="l24.282">   EnigChangeKeyPwd(gKeyId, gUserId);</span>
<a href="#l24.283"></a><span id="l24.283"> }</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineplus">+*/</span>
<a href="#l24.285"></a><span id="l24.285"> </span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-function revokeKey() {</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineplus">+async function revokeKey() {</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineplus">+  /*</span>
<a href="#l24.289"></a><span id="l24.289">   EnigRevokeKey(gKeyId, gUserId, function(success) {</span>
<a href="#l24.290"></a><span id="l24.290">     if (success) {</span>
<a href="#l24.291"></a><span id="l24.291">       enableRefresh();</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-      reloadData();</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineplus">+      await reloadData();</span>
<a href="#l24.294"></a><span id="l24.294">     }</span>
<a href="#l24.295"></a><span id="l24.295">   });</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineplus">+  */</span>
<a href="#l24.297"></a><span id="l24.297"> }</span>
<a href="#l24.298"></a><span id="l24.298"> </span>
<a href="#l24.299"></a><span id="l24.299"> function genRevocationCert() {</span>
<a href="#l24.300"></a><span id="l24.300">   EnigCreateRevokeCert(gKeyId, gUserId);</span>
<a href="#l24.301"></a><span id="l24.301"> }</span>
<a href="#l24.302"></a><span id="l24.302"> </span>
<a href="#l24.303"></a><span id="l24.303"> function SigListView(keyObj) {</span>
<a href="#l24.304"></a><span id="l24.304">   this.keyObj = [];</span>
<a href="#l24.305"></a><span id="l24.305"> </span>
<a href="#l24.306"></a><span id="l24.306">   let sigObj = keyObj.signatures;</span>
<a href="#l24.307"></a><span id="l24.307">   for (let i in sigObj) {</span>
<a href="#l24.308"></a><span id="l24.308">     let k = {</span>
<a href="#l24.309"></a><span id="l24.309">       uid: sigObj[i].userId,</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineminus">-      fpr: sigObj[i].fpr,</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineplus">+      keyId: sigObj[i].keyId,</span>
<a href="#l24.312"></a><span id="l24.312">       created: sigObj[i].created,</span>
<a href="#l24.313"></a><span id="l24.313">       expanded: true,</span>
<a href="#l24.314"></a><span id="l24.314">       sigList: [],</span>
<a href="#l24.315"></a><span id="l24.315">     };</span>
<a href="#l24.316"></a><span id="l24.316"> </span>
<a href="#l24.317"></a><span id="l24.317">     for (let j in sigObj[i].sigList) {</span>
<a href="#l24.318"></a><span id="l24.318">       let s = sigObj[i].sigList[j];</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-      if (s.sigKnown) {</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-        let sig = EnigmailKeyRing.getKeyById(s.signerKeyId);</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineminus">-        k.sigList.push({</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-          uid: s.userId,</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineminus">-          created: s.created,</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineminus">-          fpr: sig ? sig.fpr : &quot;&quot;,</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineminus">-          sigType: s.sigType,</span>
<a href="#l24.326"></a><span id="l24.326" class="difflineminus">-        });</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-      }</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineplus">+      k.sigList.push({</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineplus">+        uid: s.userId,</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineplus">+        created: s.created,</span>
<a href="#l24.331"></a><span id="l24.331" class="difflineplus">+        keyId: s.signerKeyId,</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineplus">+        sigType: s.sigType,</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineplus">+      });</span>
<a href="#l24.334"></a><span id="l24.334">     }</span>
<a href="#l24.335"></a><span id="l24.335">     this.keyObj.push(k);</span>
<a href="#l24.336"></a><span id="l24.336">   }</span>
<a href="#l24.337"></a><span id="l24.337"> </span>
<a href="#l24.338"></a><span id="l24.338">   this.prevKeyObj = null;</span>
<a href="#l24.339"></a><span id="l24.339">   this.prevRow = -1;</span>
<a href="#l24.340"></a><span id="l24.340"> </span>
<a href="#l24.341"></a><span id="l24.341">   this.updateRowCount();</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineat">@@ -317,18 +359,18 @@ SigListView.prototype = {</span>
<a href="#l24.343"></a><span id="l24.343"> </span>
<a href="#l24.344"></a><span id="l24.344">   getCellText(row, column) {</span>
<a href="#l24.345"></a><span id="l24.345">     let s = this.getSigAtIndex(row);</span>
<a href="#l24.346"></a><span id="l24.346"> </span>
<a href="#l24.347"></a><span id="l24.347">     if (s) {</span>
<a href="#l24.348"></a><span id="l24.348">       switch (column.id) {</span>
<a href="#l24.349"></a><span id="l24.349">         case &quot;sig_uid_col&quot;:</span>
<a href="#l24.350"></a><span id="l24.350">           return s.uid;</span>
<a href="#l24.351"></a><span id="l24.351" class="difflineminus">-        case &quot;sig_fingerprint_col&quot;:</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineminus">-          return EnigmailKey.formatFpr(s.fpr);</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineplus">+        case &quot;sig_keyid_col&quot;:</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineplus">+          return s.keyId;</span>
<a href="#l24.355"></a><span id="l24.355">         case &quot;sig_created_col&quot;:</span>
<a href="#l24.356"></a><span id="l24.356">           return s.created;</span>
<a href="#l24.357"></a><span id="l24.357">       }</span>
<a href="#l24.358"></a><span id="l24.358">     }</span>
<a href="#l24.359"></a><span id="l24.359"> </span>
<a href="#l24.360"></a><span id="l24.360">     return &quot;&quot;;</span>
<a href="#l24.361"></a><span id="l24.361">   },</span>
<a href="#l24.362"></a><span id="l24.362"> </span>
<a href="#l24.363"></a><span id="l24.363" class="difflineat">@@ -358,17 +400,17 @@ SigListView.prototype = {</span>
<a href="#l24.364"></a><span id="l24.364"> </span>
<a href="#l24.365"></a><span id="l24.365">   getImageSrc(row, col) {</span>
<a href="#l24.366"></a><span id="l24.366">     return null;</span>
<a href="#l24.367"></a><span id="l24.367">   },</span>
<a href="#l24.368"></a><span id="l24.368"> </span>
<a href="#l24.369"></a><span id="l24.369">   getRowProperties(row, props) {},</span>
<a href="#l24.370"></a><span id="l24.370"> </span>
<a href="#l24.371"></a><span id="l24.371">   getCellProperties(row, col) {</span>
<a href="#l24.372"></a><span id="l24.372" class="difflineminus">-    if (col.id === &quot;sig_fingerprint_col&quot;) {</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineplus">+    if (col.id === &quot;sig_keyid_col&quot;) {</span>
<a href="#l24.374"></a><span id="l24.374">       return &quot;fixedWidthFont&quot;;</span>
<a href="#l24.375"></a><span id="l24.375">     }</span>
<a href="#l24.376"></a><span id="l24.376"> </span>
<a href="#l24.377"></a><span id="l24.377">     return &quot;&quot;;</span>
<a href="#l24.378"></a><span id="l24.378">   },</span>
<a href="#l24.379"></a><span id="l24.379"> </span>
<a href="#l24.380"></a><span id="l24.380">   canDrop(row, orientation, data) {</span>
<a href="#l24.381"></a><span id="l24.381">     return false;</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineat">@@ -563,8 +605,27 @@ SubkeyListView.prototype = {</span>
<a href="#l24.383"></a><span id="l24.383">   },</span>
<a href="#l24.384"></a><span id="l24.384"> </span>
<a href="#l24.385"></a><span id="l24.385">   isSelectable(row, col) {</span>
<a href="#l24.386"></a><span id="l24.386">     return true;</span>
<a href="#l24.387"></a><span id="l24.387">   },</span>
<a href="#l24.388"></a><span id="l24.388"> </span>
<a href="#l24.389"></a><span id="l24.389">   toggleOpenState(row) {},</span>
<a href="#l24.390"></a><span id="l24.390"> };</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineplus">+</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineplus">+function sigHandleDblClick(event) {}</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineplus">+</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineplus">+function onAccept() {</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineplus">+  if (gUpdateAllowed &amp;&amp; gAcceptanceRadio.value != gOriginalAcceptance) {</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineplus">+    PgpSqliteDb2.updateAcceptance(</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineplus">+      gFingerprint,</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+      gAllEmails,</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+      gAcceptanceRadio.value</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineplus">+    );</span>
<a href="#l24.401"></a><span id="l24.401" class="difflineplus">+  }</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineplus">+  return true;</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineplus">+}</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineplus">+document.addEventListener(&quot;dialogaccept&quot;, function(event) {</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineplus">+  if (!onAccept()) {</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineplus">+    event.preventDefault();</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineplus">+  } // Prevent the dialog closing.</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -37,110 +37,89 @@</span>
<a href="#l25.4"></a><span id="l25.4">     &lt;vbox&gt;</span>
<a href="#l25.5"></a><span id="l25.5">       &lt;grid&gt;</span>
<a href="#l25.6"></a><span id="l25.6">         &lt;columns&gt;</span>
<a href="#l25.7"></a><span id="l25.7">           &lt;column style=&quot;min-width:15%;&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l25.8"></a><span id="l25.8">           &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l25.9"></a><span id="l25.9">         &lt;/columns&gt;</span>
<a href="#l25.10"></a><span id="l25.10">         &lt;rows&gt;</span>
<a href="#l25.11"></a><span id="l25.11">           &lt;row&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-            &lt;label value=&quot;&amp;enigmail.keyDetails.userId.label;&quot; control=&quot;userId&quot;/&gt;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+            &lt;label value=&quot;&amp;enigmail.keyDetails.userId2.label;&quot; control=&quot;userId&quot;/&gt;</span>
<a href="#l25.14"></a><span id="l25.14">             &lt;html:input id=&quot;userId&quot; class=&quot;plain&quot; style=&quot;white-space: pre;&quot;</span>
<a href="#l25.15"></a><span id="l25.15">               readonly=&quot;true&quot; value=&quot;?&quot; multiline=&quot;false&quot; size=&quot;60&quot;/&gt;</span>
<a href="#l25.16"></a><span id="l25.16">           &lt;/row&gt;</span>
<a href="#l25.17"></a><span id="l25.17">           &lt;row&gt;</span>
<a href="#l25.18"></a><span id="l25.18">             &lt;label value=&quot;&amp;enigmail.keyDetails.keyType.label;&quot; control=&quot;keyType&quot;/&gt;</span>
<a href="#l25.19"></a><span id="l25.19">             &lt;html:input id=&quot;keyType&quot; class=&quot;plain&quot; style=&quot;white-space: pre;&quot;</span>
<a href="#l25.20"></a><span id="l25.20">               readonly=&quot;true&quot; value=&quot;?&quot; multiline=&quot;false&quot; size=&quot;60&quot;/&gt;</span>
<a href="#l25.21"></a><span id="l25.21">           &lt;/row&gt;</span>
<a href="#l25.22"></a><span id="l25.22">           &lt;row&gt;</span>
<a href="#l25.23"></a><span id="l25.23">             &lt;label value=&quot;&amp;enigmail.keyDetails.fingerprint.label;&quot; control=&quot;fingerprint&quot;/&gt;</span>
<a href="#l25.24"></a><span id="l25.24">             &lt;html:input id=&quot;fingerprint&quot; class=&quot;plain&quot; style=&quot;white-space: pre;&quot;</span>
<a href="#l25.25"></a><span id="l25.25">               readonly=&quot;true&quot; value=&quot;?&quot; multiline=&quot;false&quot; size=&quot;60&quot;/&gt;</span>
<a href="#l25.26"></a><span id="l25.26">           &lt;/row&gt;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+          &lt;row&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+            &lt;label value=&quot;&amp;enigmail.keyDetails.created.label;&quot;/&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+            &lt;html:input id=&quot;keyCreated&quot; class=&quot;plain&quot; style=&quot;white-space: pre;&quot;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+              readonly=&quot;true&quot; value=&quot;?&quot; multiline=&quot;false&quot; size=&quot;60&quot;/&gt;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+          &lt;row&gt;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+            &lt;label value=&quot;&amp;enigmail.keyDetails.expiry.label;&quot;/&gt;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+            &lt;html:input id=&quot;keyExpiry&quot; class=&quot;plain&quot; style=&quot;white-space: pre;&quot;</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+              readonly=&quot;true&quot; value=&quot;?&quot; multiline=&quot;false&quot; size=&quot;60&quot;/&gt;</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l25.37"></a><span id="l25.37">         &lt;/rows&gt;</span>
<a href="#l25.38"></a><span id="l25.38">       &lt;/grid&gt;</span>
<a href="#l25.39"></a><span id="l25.39">       &lt;vbox class=&quot;enigmailCaptionbox&quot; id=&quot;alsoknown&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l25.40"></a><span id="l25.40">         &lt;html:h1&gt;&lt;html:span&gt;&amp;enigmail.keyDetails.alsoKnown.label;:&lt;/html:span&gt;&lt;/html:h1&gt;</span>
<a href="#l25.41"></a><span id="l25.41">         &lt;richlistbox id=&quot;additionalUid&quot; style=&quot;height: 4em;&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l25.42"></a><span id="l25.42">       &lt;/vbox&gt;</span>
<a href="#l25.43"></a><span id="l25.43">     &lt;/vbox&gt;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-    &lt;vbox flex=&quot;1&quot; align=&quot;end&quot;&gt;</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-      &lt;hbox flex=&quot;1&quot; align=&quot;end&quot;&gt;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-        &lt;image src=&quot;&quot; id=&quot;photoIdImg&quot; style=&quot;display: block; height: auto; width: auto; max-width: 100px; max-height: 120px;&quot;/&gt;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l25.49"></a><span id="l25.49">   &lt;/hbox&gt;</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51">   &lt;tabbox flex=&quot;1&quot; style=&quot;margin:5px&quot; id=&quot;mainTabs&quot;&gt;</span>
<a href="#l25.52"></a><span id="l25.52">     &lt;tabs id=&quot;mainTabBox&quot;&gt;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-      &lt;tab id=&quot;basicTab&quot;       label=&quot;&amp;enigmail.basic.label;&quot;/&gt;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+      &lt;tab id=&quot;acceptanceTab&quot;  label=&quot;&amp;enigmail.acceptance.label;&quot;/&gt;</span>
<a href="#l25.55"></a><span id="l25.55">       &lt;tab id=&quot;signaturesTab&quot;  label=&quot;&amp;enigmail.keyDetails.signaturesTab;&quot;/&gt;</span>
<a href="#l25.56"></a><span id="l25.56">       &lt;tab id=&quot;structureTab&quot;   label=&quot;&amp;enigmail.keyDetails.structureTab;&quot;/&gt;</span>
<a href="#l25.57"></a><span id="l25.57">     &lt;/tabs&gt;</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59">     &lt;tabpanels flex=&quot;1&quot; id=&quot;mainTabPanel&quot;&gt;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-       &lt;!-- Basic Tab --&gt;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-      &lt;vbox id=&quot;basicPanel&quot;&gt;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-        &lt;html:table style=&quot;width: 100%;&quot;&gt;</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-          &lt;html:colgroup&gt;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-            &lt;html:col/&gt;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-            &lt;html:col style=&quot;width: 100%;&quot;/&gt;</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-            &lt;html:col style=&quot;text-align: right;&quot;/&gt;</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-          &lt;/html:colgroup&gt;</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-          &lt;html:tr&gt;</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-            &lt;html:td style=&quot;white-space: nowrap; padding: 0 15px 0 0;&quot;&gt;</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-              &amp;enigmail.keyDetails.created.label;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-            &lt;html:td id=&quot;keyCreated&quot;/&gt;</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-          &lt;/html:tr&gt;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-          &lt;html:tr&gt;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-            &lt;html:td style=&quot;white-space: nowrap; padding: 0 15px 0 0;&quot;&gt;</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-              &amp;enigmail.keyDetails.expiry.label;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-            &lt;html:td id=&quot;keyExpiry&quot;/&gt;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-            &lt;html:td&gt;</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-              &lt;button observes=&quot;ownKeyCommands&quot; label=&quot;&amp;enigmail.keyDetails.change.label;&quot; oncommand=&quot;changeExpirationDate()&quot;/&gt;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-          &lt;/html:tr&gt;</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-          &lt;html:tr&gt;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-            &lt;html:td&gt;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-              &amp;enigmail.keyDetails.keyValidity.label;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-            &lt;html:td id=&quot;keyValidity&quot;/&gt;</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-            &lt;html:td&gt;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-              &lt;button label=&quot;&amp;enigmail.keyDetails.signKey.label;&quot; oncommand=&quot;signKey()&quot;/&gt;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-          &lt;/html:tr&gt;</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-          &lt;html:tr&gt;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-            &lt;html:td style=&quot;white-space: nowrap; padding: 0 15px 0 0;&quot;&gt;</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-              &amp;enigmail.keyDetails.trustStatus.label;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-            &lt;html:td id=&quot;ownerTrust&quot;/&gt;</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-            &lt;html:td&gt;</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-              &lt;button id=&quot;setOwnerTrust&quot; label=&quot;&amp;enigmail.keyDetails.change.label;&quot; oncommand=&quot;setOwnerTrust()&quot;/&gt;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineminus">-            &lt;/html:td&gt;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-          &lt;/html:tr&gt;</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-        &lt;/html:table&gt;</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+       &lt;!-- Acceptance Tab --&gt;</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+      &lt;vbox id=&quot;acceptancePanel&quot;&gt;</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+        &lt;description id=&quot;acceptanceIntro&quot;/&gt;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+        &lt;radiogroup id=&quot;acceptanceRadio&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+          &lt;radio id=&quot;acceptRejected&quot; value=&quot;rejected&quot;</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+                 label=&quot;&amp;enigmail.acceptance.rejected.label;&quot;/&gt;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+          &lt;radio id=&quot;acceptUndecided&quot; value=&quot;undecided&quot;</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+                 label=&quot;&amp;enigmail.acceptance.undecided.label;&quot;/&gt;</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+          &lt;radio id=&quot;acceptUnverified&quot; value=&quot;unverified&quot;</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+                 label=&quot;&amp;enigmail.acceptance.unverified.label;&quot;/&gt;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+          &lt;radio id=&quot;acceptVerified&quot; value=&quot;verified&quot;</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+                 label=&quot;&amp;enigmail.acceptance.verified.label;&quot;/&gt;</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+        &lt;/radiogroup&gt;</span>
<a href="#l25.118"></a><span id="l25.118">       &lt;/vbox&gt;</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120">       &lt;!-- certifications tab --&gt;</span>
<a href="#l25.121"></a><span id="l25.121">       &lt;vbox id=&quot;signaturesPanel&quot;&gt;</span>
<a href="#l25.122"></a><span id="l25.122">         &lt;tree id=&quot;signatures_tree&quot; flex=&quot;1&quot;</span>
<a href="#l25.123"></a><span id="l25.123">           hidecolumnpicker=&quot;true&quot;</span>
<a href="#l25.124"></a><span id="l25.124">           ondblclick=&quot;sigHandleDblClick(event)&quot;&gt;</span>
<a href="#l25.125"></a><span id="l25.125"> </span>
<a href="#l25.126"></a><span id="l25.126">           &lt;treecols&gt;</span>
<a href="#l25.127"></a><span id="l25.127">             &lt;treecol id=&quot;sig_uid_col&quot; flex=&quot;1&quot;</span>
<a href="#l25.128"></a><span id="l25.128">                 label=&quot;&amp;enigmail.keyDetails.uidCertifiedCol;&quot;</span>
<a href="#l25.129"></a><span id="l25.129">                 primary=&quot;true&quot;/&gt;</span>
<a href="#l25.130"></a><span id="l25.130">             &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l25.131"></a><span id="l25.131">             &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-            &lt;treecol id=&quot;sig_fingerprint_col&quot;</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-                     label=&quot;&amp;enigmail.keyDetails.fingerprint.label;&quot;</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+            &lt;treecol id=&quot;sig_keyid_col&quot;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+                     label=&quot;&amp;enigmail.keyId.label;&quot;</span>
<a href="#l25.136"></a><span id="l25.136">                      persist=&quot;width&quot;/&gt;</span>
<a href="#l25.137"></a><span id="l25.137">             &lt;treecol id=&quot;sig_created_col&quot;</span>
<a href="#l25.138"></a><span id="l25.138">                      label=&quot;&amp;enigmail.keyDetails.created.label;&quot;</span>
<a href="#l25.139"></a><span id="l25.139">                      persist=&quot;width&quot;/&gt;</span>
<a href="#l25.140"></a><span id="l25.140">           &lt;/treecols&gt;</span>
<a href="#l25.141"></a><span id="l25.141"> </span>
<a href="#l25.142"></a><span id="l25.142">           &lt;treechildren/&gt;</span>
<a href="#l25.143"></a><span id="l25.143">         &lt;/tree&gt;</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineat">@@ -188,24 +167,24 @@</span>
<a href="#l25.145"></a><span id="l25.145">             &lt;treechildren id=&quot;keyListChildren&quot;/&gt;</span>
<a href="#l25.146"></a><span id="l25.146"> </span>
<a href="#l25.147"></a><span id="l25.147">           &lt;/tree&gt;</span>
<a href="#l25.148"></a><span id="l25.148">         &lt;/hbox&gt;</span>
<a href="#l25.149"></a><span id="l25.149">       &lt;/vbox&gt;</span>
<a href="#l25.150"></a><span id="l25.150">     &lt;/tabpanels&gt;</span>
<a href="#l25.151"></a><span id="l25.151">   &lt;/tabbox&gt;</span>
<a href="#l25.152"></a><span id="l25.152"> </span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+  &lt;!--</span>
<a href="#l25.154"></a><span id="l25.154">   &lt;separator/&gt;</span>
<a href="#l25.155"></a><span id="l25.155"> </span>
<a href="#l25.156"></a><span id="l25.156">   &lt;hbox flex=&quot;0&quot; observes=&quot;ownKeyCommands&quot;&gt;</span>
<a href="#l25.157"></a><span id="l25.157">     &lt;button id=&quot;actions&quot; label=&quot;&amp;enigmail.keyDetails.selAction.label;&quot;</span>
<a href="#l25.158"></a><span id="l25.158">             accesskey=&quot;&amp;enigmail.keyDetails.selAction.accesskey;&quot; type=&quot;menu&quot;&gt;</span>
<a href="#l25.159"></a><span id="l25.159">       &lt;menupopup id=&quot;actionPopup&quot;&gt;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.manageUid.label;&quot; oncommand=&quot;manageUids()&quot;/&gt;</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineminus">-        &lt;menuitem label=&quot;&amp;enigmail.keyMan.changePwd.label;&quot; oncommand=&quot;changePassword()&quot;/&gt;</span>
<a href="#l25.162"></a><span id="l25.162">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.revokeKey.label;&quot; oncommand=&quot;revokeKey()&quot;/&gt;</span>
<a href="#l25.163"></a><span id="l25.163">         &lt;menuitem label=&quot;&amp;enigmail.keyMan.ctxGenRevoke.label;&quot; oncommand=&quot;genRevocationCert()&quot;/&gt;</span>
<a href="#l25.164"></a><span id="l25.164">       &lt;/menupopup&gt;</span>
<a href="#l25.165"></a><span id="l25.165">     &lt;/button&gt;</span>
<a href="#l25.166"></a><span id="l25.166">   &lt;/hbox&gt;</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+  --&gt;</span>
<a href="#l25.168"></a><span id="l25.168"> </span>
<a href="#l25.169"></a><span id="l25.169"> &lt;/dialog&gt;</span>
<a href="#l25.170"></a><span id="l25.170"> &lt;/window&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

