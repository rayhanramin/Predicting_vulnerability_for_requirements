<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22212:2434e5fd8480accdadfed0e52759cd992425bf15</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2434e5fd8480accdadfed0e52759cd992425bf15" />
<meta property="og:url" content="/comm-central/rev/2434e5fd8480accdadfed0e52759cd992425bf15" />
<meta property="og:description" content="Bug 1399756 - white-space clean-up in mailnews/compose/src/nsMsgAppleDouble.h. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2434e5fd8480accdadfed0e52759cd992425bf15 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2434e5fd8480accdadfed0e52759cd992425bf15">shortlog</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2434e5fd8480accdadfed0e52759cd992425bf15">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15">files</a> |
changeset |
<a href="/comm-central/raw-rev/2434e5fd8480accdadfed0e52759cd992425bf15">raw</a>  | <a href="/comm-central/archive/2434e5fd8480accdadfed0e52759cd992425bf15.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - white-space clean-up in mailnews/compose/src/nsMsgAppleDouble.h. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 26 Sep 2017 00:51:29 +0200</td></tr>

<tr>
 <td>changeset 22212</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2434e5fd8480accdadfed0e52759cd992425bf15">2434e5fd8480accdadfed0e52759cd992425bf15</a></td>
</tr>



<tr>
<td>parent 22211</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f9af05463902187f17613110616326aff2cd4387">f9af05463902187f17613110616326aff2cd4387</a>
</td>
</tr>

<tr>
<td>child 22213</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f431a95645cdf312393eac5f0a2ad5a57839706">8f431a95645cdf312393eac5f0a2ad5a57839706</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2434e5fd8480accdadfed0e52759cd992425bf15">13553</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 25 Sep 2017 23:35:01 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2434e5fd8480 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2434e5fd8480accdadfed0e52759cd992425bf15">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2434e5fd8480accdadfed0e52759cd992425bf15&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2434e5fd8480accdadfed0e52759cd992425bf15&newProject=comm-central&newRevision=fdc9f3574d6ece7b18d60bf6fe94b63324e9536d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2434e5fd8480accdadfed0e52759cd992425bf15&newProject=comm-central&newRevision=fdc9f3574d6ece7b18d60bf6fe94b63324e9536d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2434e5fd8480accdadfed0e52759cd992425bf15&newProject=comm-central&newRevision=fdc9f3574d6ece7b18d60bf6fe94b63324e9536d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">1399756</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - white-space clean-up in mailnews/compose/src/nsMsgAppleDouble.h. rs=white-space-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">mailnews/compose/src/nsMsgAppleDouble.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/compose/src/nsMsgAppleDouble.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">mailnews/db/msgdb/public/nsDBFolderInfo.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsDBFolderInfo.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">mailnews/db/msgdb/public/nsMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">mailnews/db/msgdb/public/nsMsgHdr.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgHdr.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">mailnews/db/msgdb/public/nsMsgThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsMsgThread.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">mailnews/db/msgdb/public/nsNewsDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/public/nsNewsDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">mailnews/db/msgdb/src/nsImapMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/2434e5fd8480accdadfed0e52759cd992425bf15/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,207 +1,200 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l1.5"></a><span id="l1.5">  *</span>
<a href="#l1.6"></a><span id="l1.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> /*</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-*   AppleDouble.h</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-*	-------------</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-*</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-*  	  The header file for a stream based apple single/double encodor/decodor.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-*		</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-*		2aug95	mym		</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-*		</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-*/</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ * AppleDouble.h</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ * -------------</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ *</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * The header file for a stream based apple single/double encodor/decodor.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ *</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+ * 2aug95    mym</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+ *</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+ */</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> #ifndef AppleDouble_h</span>
<a href="#l1.30"></a><span id="l1.30"> #define AppleDouble_h</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> #include &quot;msgCore.h&quot;</span>
<a href="#l1.33"></a><span id="l1.33"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l1.34"></a><span id="l1.34"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l1.35"></a><span id="l1.35"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37"> #include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-#define NOERR			0</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-#define errDone			1</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-								/* Done with current operation.	*/</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-#define errEOB			2</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-								/* 	End of a buffer.			*/</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-#define errEOP			3	</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-								/* 	End of a Part.				*/</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+#define NOERR            0</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+#define errDone          1  /* Done with current operation. */</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+#define errEOB           2  /* End of a buffer.             */</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+#define errEOP           3  /* End of a Part.               */</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-					</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-#define errFileOpen	NS_ERROR_GET_CODE(NS_MSG_UNABLE_TO_OPEN_TMP_FILE)</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-#define errFileWrite	-202 /*Error writing temporary file.*/</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-#define errUsrCancel	-2  /*MK_INTERRUPTED */</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-#define errDecoding		-1</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+#define errFileOpen    NS_ERROR_GET_CODE(NS_MSG_UNABLE_TO_OPEN_TMP_FILE)</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+#define errFileWrite   -202  /* Error writing temporary file. */</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+#define errUsrCancel     -2  /* MK_INTERRUPTED */</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+#define errDecoding      -1</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62"> /*</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-** The envirment block data type.</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-*/</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+ ** The envirment block data type.</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+ */</span>
<a href="#l1.67"></a><span id="l1.67"> enum</span>
<a href="#l1.68"></a><span id="l1.68"> {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-	kInit,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-	kDoingHeaderPortion,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-	kDoneHeaderPortion,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-	kDoingDataPortion,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-	kDoneDataPortion</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  kInit,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  kDoingHeaderPortion,</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  kDoneHeaderPortion,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  kDoingDataPortion,</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  kDoneDataPortion</span>
<a href="#l1.79"></a><span id="l1.79"> };</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81"> typedef struct _appledouble_encode_object</span>
<a href="#l1.82"></a><span id="l1.82"> {</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    char    fname[256];</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    FSIORefNum fileId;				/* the id for the open file (data/resource fork) */</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  char    fname[256];</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  FSIORefNum fileId;         /* the id for the open file (data/resource fork) */</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-	int 	state;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-	int		text_file_type;		/* if the file has a text file type with it.	*/</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-	char	*boundary;			/* the boundary string.							*/</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  int     state;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+  int     text_file_type;    /* if the file has a text file type with it.     */</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  char    *boundary;         /* the boundary string.                          */</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-	int		status;				/* the error code if anyerror happens.			*/</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-	char 	b_overflow[200];</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-	int		s_overflow;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-	</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-	int		state64;			/* the left over state of base64 enocding 		*/</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-	int		ct;					/* the character count of base64 encoding		*/</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-	int 	c1, c2;				/* the left of the last base64 encoding 		*/		</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  int     status;            /* the error code if anyerror happens.           */</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  char    b_overflow[200];</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  int     s_overflow;</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-	char 	*outbuff;			/* the outbuff by the caller.           		*/</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-	int		s_outbuff;			/* the size of the buffer.						*/</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-	int		pos_outbuff;		/* the offset in the current buffer.			*/</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+  int     state64;           /* the left over state of base64 enocding        */</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+  int     ct;                /* the character count of base64 encoding        */</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+  int     c1, c2;            /* the left of the last base64 encoding          */</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  char    *outbuff;          /* the outbuff by the caller.                    */</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  int     s_outbuff;         /* the size of the buffer.                       */</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  int     pos_outbuff;       /* the offset in the current buffer.             */</span>
<a href="#l1.116"></a><span id="l1.116"> } appledouble_encode_object;</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118"> /* The possible content transfer encodings */</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120"> enum</span>
<a href="#l1.121"></a><span id="l1.121"> {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-	kEncodeNone,</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-	kEncodeQP,</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-	kEncodeBase64,</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-	kEncodeUU</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  kEncodeNone,</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  kEncodeQP,</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  kEncodeBase64,</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  kEncodeUU</span>
<a href="#l1.130"></a><span id="l1.130"> };</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132"> enum</span>
<a href="#l1.133"></a><span id="l1.133"> {</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-	kGeneralMine,</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-	kAppleDouble,</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-	kAppleSingle</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  kGeneralMine,</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  kAppleDouble,</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  kAppleSingle</span>
<a href="#l1.140"></a><span id="l1.140"> };</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142"> enum</span>
<a href="#l1.143"></a><span id="l1.143"> {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-	kInline,</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-	kDontCare</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  kInline,</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  kDontCare</span>
<a href="#l1.148"></a><span id="l1.148"> };</span>
<a href="#l1.149"></a><span id="l1.149"> </span>
<a href="#l1.150"></a><span id="l1.150"> enum</span>
<a href="#l1.151"></a><span id="l1.151"> {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-	kHeaderPortion,</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-	kDataPortion</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  kHeaderPortion,</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+  kDataPortion</span>
<a href="#l1.156"></a><span id="l1.156"> };</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-/* the decode states.	*/</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+/* the decode states. */</span>
<a href="#l1.160"></a><span id="l1.160"> enum</span>
<a href="#l1.161"></a><span id="l1.161"> {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-	kBeginParseHeader = 3,</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-	kParsingHeader,</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-	kBeginSeekBoundary,</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-	kSeekingBoundary,</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-	kBeginHeaderPortion,</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-	kProcessingHeaderPortion,</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-	kBeginDataPortion,</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-	kProcessingDataPortion,</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-	kFinishing</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  kBeginParseHeader = 3,</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+  kParsingHeader,</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+  kBeginSeekBoundary,</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+  kSeekingBoundary,</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+  kBeginHeaderPortion,</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+  kProcessingHeaderPortion,</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+  kBeginDataPortion,</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+  kProcessingDataPortion,</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+  kFinishing</span>
<a href="#l1.180"></a><span id="l1.180"> };</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182"> /* uuencode states */</span>
<a href="#l1.183"></a><span id="l1.183"> enum</span>
<a href="#l1.184"></a><span id="l1.184"> {</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-	kWaitingForBegin = (int) 0,</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-	kBegin,</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-	kMainBody,</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-	kEnd</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  kWaitingForBegin = (int) 0,</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+  kBegin,</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  kMainBody,</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+  kEnd</span>
<a href="#l1.193"></a><span id="l1.193"> };</span>
<a href="#l1.194"></a><span id="l1.194"> </span>
<a href="#l1.195"></a><span id="l1.195"> typedef struct _appledouble_decode_object</span>
<a href="#l1.196"></a><span id="l1.196"> {</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-	int		is_binary;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-	int		is_apple_single;	/* if the object encoded is in apple single		*/</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-	int		write_as_binhex;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-	</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-	int		messagetype;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-	char*	boundary0;			/* the boundary for the enclosure.				*/</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-	int		deposition;			/* the deposition.								*/</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-	int		encoding;			/* the encoding method.							*/</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-	int		which_part;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-	</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-	char	fname[256];</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-	// nsIOFileStream *fileSpec;					/* the stream for data fork work.					 */</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  int     is_binary;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  int     is_apple_single;    /* if the object encoded is in apple single  */</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  int     write_as_binhex;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  int     messagetype;</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+  char*   boundary0;          /* the boundary for the enclosure.           */</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  int     deposition;         /* the deposition.                           */</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  int     encoding;           /* the encoding method.                      */</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+  int     which_part;</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+  char    fname[256];</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+// nsIOFileStream *fileSpec;   /* the stream for data fork work.            */</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+  int     state;</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+  int     rksize;             /* the resource fork size count.             */</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+  int     dksize;             /* the data fork size count.                 */</span>
<a href="#l1.226"></a><span id="l1.226"> </span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-	int 	state;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-	</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-	int		rksize;				/* the resource fork size count.				*/</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-	int		dksize;				/* the data fork size count.					*/</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-	</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-	int		status;				/* the error code if anyerror happens.			*/</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-	char 	b_leftover[256];</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-	int		s_leftover;</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-	</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-	int		encode;				/* the encode type of the message.				*/</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-	int		state64;			/* the left over state of base64 enocding 		*/</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-	int		left;				/* the character count of base64 encoding		*/</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-	int 	c[4];				/* the left of the last base64 encoding 		*/		</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-	int		uu_starts_line;		/* is decoder at the start of a line? (uuencode)	*/</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-	int		uu_state;			/* state w/r/t the uuencode body */</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-	int		uu_bytes_written;	/* bytes written from the current tuple (uuencode) */</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-	int		uu_line_bytes;		/* encoded bytes remaining in the current line (uuencode) */</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+  int      status;            /* the error code if anyerror happens.       */</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+  char     b_leftover[256];</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+  int      s_leftover;</span>
<a href="#l1.247"></a><span id="l1.247"> </span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-	char 	*inbuff;			/* the outbuff by the caller.           		*/</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-	int		s_inbuff;			/* the size of the buffer.						*/</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-	int		pos_inbuff;			/* the offset in the current buffer.			*/</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+  int      encode;            /* the encode type of the message.           */</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+  int      state64;           /* the left over state of base64 enocding    */</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+  int      left;              /* the character count of base64 encoding    */</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  int      c[4];              /* the left of the last base64 encoding      */</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+  int      uu_starts_line;    /* is decoder at the start of a line? (uuencode) */</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  int      uu_state;          /* state w/r/t the uuencode body */</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  int      uu_bytes_written;  /* bytes written from the current tuple (uuencode) */</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  int      uu_line_bytes;     /* encoded bytes remaining in the current line (uuencode) */</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-	nsCOMPtr &lt;nsIFile&gt; tmpFile;		/* the temp file to hold the decode data fork 	*/</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-								                      /* when doing the binhex exporting.				*/</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream; /* The output File Stream */</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-	int32_t	            data_size;			/* the size of the data in the tmp file.		*/</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+  char     *inbuff;           /* the outbuff by the caller.                */</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+  int      s_inbuff;          /* the size of the buffer.                   */</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+  int      pos_inbuff;        /* the offset in the current buffer.         */</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+  nsCOMPtr &lt;nsIFile&gt; tmpFile; /* the temp file to hold the decode data fork */</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+                              /* when doing the binhex exporting.          */</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+  nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream; /* The output File Stream      */</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+  int32_t  data_size;         /* the size of the data in the tmp file.     */</span>
<a href="#l1.273"></a><span id="l1.273"> } appledouble_decode_object;</span>
<a href="#l1.274"></a><span id="l1.274"> </span>
<a href="#l1.275"></a><span id="l1.275"> </span>
<a href="#l1.276"></a><span id="l1.276"> /*</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-**	The protypes.</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-*/</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+ ** The protypes.</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+ */</span>
<a href="#l1.281"></a><span id="l1.281"> </span>
<a href="#l1.282"></a><span id="l1.282"> PR_BEGIN_EXTERN_C</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284"> int ap_encode_init(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-					const char* fname,</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-					char* separator);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+                   const char* fname,</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+                   char* separator);</span>
<a href="#l1.289"></a><span id="l1.289"> </span>
<a href="#l1.290"></a><span id="l1.290"> int ap_encode_next(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-					char 	*to_buff,</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-					int32_t 	buff_size,</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-					int32_t*	real_size);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+                   char     *to_buff,</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+                   int32_t  buff_size,</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+                   int32_t* real_size);</span>
<a href="#l1.297"></a><span id="l1.297"> </span>
<a href="#l1.298"></a><span id="l1.298"> int ap_encode_end(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-					bool	is_aborting);</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+                   bool is_aborting);</span>
<a href="#l1.301"></a><span id="l1.301"> </span>
<a href="#l1.302"></a><span id="l1.302"> int ap_decode_init(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-					bool	is_apple_single,</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-					bool	write_as_bin_hex,</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-					void  	*closure);</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+                   bool is_apple_single,</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+                   bool write_as_bin_hex,</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+                   void *closure);</span>
<a href="#l1.309"></a><span id="l1.309"> </span>
<a href="#l1.310"></a><span id="l1.310"> int ap_decode_next(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-					char 	*in_buff,</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-					int32_t 	buff_size);</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+                   char    *in_buff,</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+                   int32_t buff_size);</span>
<a href="#l1.315"></a><span id="l1.315"> </span>
<a href="#l1.316"></a><span id="l1.316"> int ap_decode_end(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-				 	bool is_aborting);</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+                  bool is_aborting);</span>
<a href="#l1.319"></a><span id="l1.319"> </span>
<a href="#l1.320"></a><span id="l1.320"> PR_END_EXTERN_C</span>
<a href="#l1.321"></a><span id="l1.321"> </span>
<a href="#l1.322"></a><span id="l1.322"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -19,38 +19,38 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> class nsMsgDatabase;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> // again, this could inherit from nsISupports, but I don't see the need as of yet.</span>
<a href="#l2.8"></a><span id="l2.8"> // I'm not sure it needs to be ref-counted (but I think it does).</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> // I think these getters and setters really need to go through mdb and not rely on the object</span>
<a href="#l2.11"></a><span id="l2.11"> // caching the values. If this somehow turns out to be prohibitively expensive, we can invent</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// some sort of dirty mechanism, but I think it turns out that these values will be cached by </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// some sort of dirty mechanism, but I think it turns out that these values will be cached by</span>
<a href="#l2.14"></a><span id="l2.14"> // the MSG_FolderInfo's anyway.</span>
<a href="#l2.15"></a><span id="l2.15"> class nsDBFolderInfo : public nsIDBFolderInfo</span>
<a href="#l2.16"></a><span id="l2.16"> {</span>
<a href="#l2.17"></a><span id="l2.17"> public:</span>
<a href="#l2.18"></a><span id="l2.18">   friend class nsMsgDatabase;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  </span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21">   nsDBFolderInfo(nsMsgDatabase *mdb);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24">   NS_DECL_ISUPPORTS</span>
<a href="#l2.25"></a><span id="l2.25">     // interface methods.</span>
<a href="#l2.26"></a><span id="l2.26">     NS_DECL_NSIDBFOLDERINFO</span>
<a href="#l2.27"></a><span id="l2.27">     // create the appropriate table and row in a new db.</span>
<a href="#l2.28"></a><span id="l2.28">     nsresult			AddToNewMDB();</span>
<a href="#l2.29"></a><span id="l2.29">   // accessor methods.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32">   bool      TestFlag(int32_t flags);</span>
<a href="#l2.33"></a><span id="l2.33">   int16_t   GetIMAPHierarchySeparator() ;</span>
<a href="#l2.34"></a><span id="l2.34">   void      SetIMAPHierarchySeparator(int16_t hierarchyDelimiter) ;</span>
<a href="#l2.35"></a><span id="l2.35">   void      ChangeImapTotalPendingMessages(int32_t delta);</span>
<a href="#l2.36"></a><span id="l2.36">   void      ChangeImapUnreadPendingMessages(int32_t delta) ;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  </span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39">   nsresult      InitFromExistingDB();</span>
<a href="#l2.40"></a><span id="l2.40">   // get and set arbitrary property, aka row cell value.</span>
<a href="#l2.41"></a><span id="l2.41">   nsresult SetPropertyWithToken(mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l2.42"></a><span id="l2.42">   nsresult SetUint32PropertyWithToken(mdb_token aProperty, uint32_t propertyValue);</span>
<a href="#l2.43"></a><span id="l2.43">   nsresult SetInt64PropertyWithToken(mdb_token aProperty, int64_t propertyValue);</span>
<a href="#l2.44"></a><span id="l2.44">   nsresult SetInt32PropertyWithToken(mdb_token aProperty, int32_t propertyValue);</span>
<a href="#l2.45"></a><span id="l2.45">   nsresult GetPropertyWithToken(mdb_token aProperty, nsAString &amp;propertyValue);</span>
<a href="#l2.46"></a><span id="l2.46">   nsresult GetUint32PropertyWithToken(mdb_token aProperty, uint32_t &amp;propertyValue, uint32_t defaultValue = 0);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineat">@@ -88,48 +88,48 @@ protected:</span>
<a href="#l2.48"></a><span id="l2.48">   int32_t   m_numUnreadMessages;</span>
<a href="#l2.49"></a><span id="l2.49">   int32_t   m_numMessages;    // includes expunged and ignored messages</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   int32_t   m_flags;  // folder specific flags. This holds things like re-use thread pane,</span>
<a href="#l2.52"></a><span id="l2.52">   // configured for off-line use, use default retrieval, purge article/header options</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   uint16_t    m_version;                // for upgrading...</span>
<a href="#l2.55"></a><span id="l2.55">   int16_t     m_IMAPHierarchySeparator;	// imap path separator</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58">   // mail only (for now)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-  </span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+</span>
<a href="#l2.61"></a><span id="l2.61">   // IMAP only</span>
<a href="#l2.62"></a><span id="l2.62">   int32_t     m_ImapUidValidity;</span>
<a href="#l2.63"></a><span id="l2.63">   int32_t     m_totalPendingMessages;</span>
<a href="#l2.64"></a><span id="l2.64">   int32_t     m_unreadPendingMessages;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  </span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67">   // news only (for now)</span>
<a href="#l2.68"></a><span id="l2.68">   nsMsgKey    m_expiredMark;		// Highest invalid article number in group - for expiring</span>
<a href="#l2.69"></a><span id="l2.69">   // the db folder info will have to know what db and row it belongs to, since it is really</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  // just a wrapper around the singleton folder info row in the mdb. </span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  // just a wrapper around the singleton folder info row in the mdb.</span>
<a href="#l2.72"></a><span id="l2.72">   nsMsgDatabase *m_mdb;</span>
<a href="#l2.73"></a><span id="l2.73">   nsIMdbTable   *m_mdbTable;	// singleton table in db</span>
<a href="#l2.74"></a><span id="l2.74">   nsIMdbRow     *m_mdbRow;	// singleton row in table;</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">   nsCString     m_charSet;</span>
<a href="#l2.77"></a><span id="l2.77">   bool          m_charSetOverride;</span>
<a href="#l2.78"></a><span id="l2.78">   bool          m_mdbTokensInitialized;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+</span>
<a href="#l2.81"></a><span id="l2.81">   mdb_token     m_rowScopeToken;</span>
<a href="#l2.82"></a><span id="l2.82">   mdb_token     m_tableKindToken;</span>
<a href="#l2.83"></a><span id="l2.83">   // tokens for the pre-set columns - we cache these for speed, which may be silly</span>
<a href="#l2.84"></a><span id="l2.84">   mdb_token     m_mailboxNameColumnToken;</span>
<a href="#l2.85"></a><span id="l2.85">   mdb_token     m_numMessagesColumnToken;</span>
<a href="#l2.86"></a><span id="l2.86">   mdb_token     m_numUnreadMessagesColumnToken;</span>
<a href="#l2.87"></a><span id="l2.87">   mdb_token     m_flagsColumnToken;</span>
<a href="#l2.88"></a><span id="l2.88">   mdb_token     m_folderSizeColumnToken;</span>
<a href="#l2.89"></a><span id="l2.89">   mdb_token     m_expungedBytesColumnToken;</span>
<a href="#l2.90"></a><span id="l2.90">   mdb_token     m_folderDateColumnToken;</span>
<a href="#l2.91"></a><span id="l2.91">   mdb_token     m_highWaterMessageKeyColumnToken;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-  </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+</span>
<a href="#l2.94"></a><span id="l2.94">   mdb_token     m_imapUidValidityColumnToken;</span>
<a href="#l2.95"></a><span id="l2.95">   mdb_token     m_totalPendingMessagesColumnToken;</span>
<a href="#l2.96"></a><span id="l2.96">   mdb_token     m_unreadPendingMessagesColumnToken;</span>
<a href="#l2.97"></a><span id="l2.97">   mdb_token     m_expiredMarkColumnToken;</span>
<a href="#l2.98"></a><span id="l2.98">   mdb_token     m_versionColumnToken;</span>
<a href="#l2.99"></a><span id="l2.99"> };</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -26,17 +26,17 @@ public:</span>
<a href="#l3.4"></a><span id="l3.4">   NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l3.5"></a><span id="l3.5">                             nsIDBChangeListener *instigator) override;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   nsresult  Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile, bool create, bool upgrading) override;</span>
<a href="#l3.9"></a><span id="l3.9">   virtual nsMailDatabase  *GetMailDB() {return this;}</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   virtual uint32_t  GetCurVersion() override {return kMsgDBVersion;}</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14">   NS_IMETHOD  GetOfflineOpForKey(nsMsgKey opKey, bool create,</span>
<a href="#l3.15"></a><span id="l3.15">                                  nsIMsgOfflineImapOperation **op) override;</span>
<a href="#l3.16"></a><span id="l3.16">   NS_IMETHOD  RemoveOfflineOp(nsIMsgOfflineImapOperation *op) override;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   NS_IMETHOD  SetSummaryValid(bool valid) override;</span>
<a href="#l3.19"></a><span id="l3.19">   NS_IMETHOD  GetSummaryValid(bool *valid) override;</span>
<a href="#l3.20"></a><span id="l3.20"> 	</span>
<a href="#l3.21"></a><span id="l3.21">   NS_IMETHOD    EnumerateOfflineOps(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -44,22 +44,22 @@ public:</span>
<a href="#l3.23"></a><span id="l3.23">   NS_IMETHOD    ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes) override;</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">   friend class nsMsgOfflineOpEnumerator;</span>
<a href="#l3.26"></a><span id="l3.26"> protected:</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   nsresult        GetAllOfflineOpsTable(); // get this on demand</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   // get the time and date of the mailbox file</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  void            GetMailboxModProperties(int64_t *aSize, uint32_t *aDate); </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  void            GetMailboxModProperties(int64_t *aSize, uint32_t *aDate);</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">   nsCOMPtr &lt;nsIMdbTable&gt;  m_mdbAllOfflineOpsTable;</span>
<a href="#l3.35"></a><span id="l3.35">   mdb_token       m_offlineOpsRowScopeToken;</span>
<a href="#l3.36"></a><span id="l3.36">   mdb_token       m_offlineOpsTableKindToken;</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   virtual void    SetReparse(bool reparse);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41"> protected:</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  </span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44">   bool            m_reparse;</span>
<a href="#l3.45"></a><span id="l3.45"> };</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -57,20 +57,20 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4">     nsresult SetUInt64Column(uint64_t value, mdb_token token);</span>
<a href="#l4.5"></a><span id="l4.5">     nsresult GetUInt64Column(mdb_token token, uint64_t *pvalue, uint64_t defaultValue = 0);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     // reference and threading stuff.</span>
<a href="#l4.8"></a><span id="l4.8">     nsresult	ParseReferences(const char *references);</span>
<a href="#l4.9"></a><span id="l4.9">     const char* GetNextReference(const char *startNextRef, nsCString &amp;reference,</span>
<a href="#l4.10"></a><span id="l4.10">                                  bool acceptNonDelimitedReferences);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    nsMsgKey	m_threadId; </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    nsMsgKey	m_threadId;</span>
<a href="#l4.14"></a><span id="l4.14">     nsMsgKey	m_messageKey; 	//news: article number, mail mbox offset, imap uid...</span>
<a href="#l4.15"></a><span id="l4.15">     nsMsgKey	m_threadParent;	// message this is a reply to, in thread.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    PRTime      m_date;                         </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    PRTime      m_date;</span>
<a href="#l4.18"></a><span id="l4.18">     uint32_t    m_messageSize;	// lines for news articles, bytes for mail messages</span>
<a href="#l4.19"></a><span id="l4.19">     uint32_t    m_statusOffset;	// offset in a local mail message of the mozilla status hdr</span>
<a href="#l4.20"></a><span id="l4.20">     uint32_t    m_flags;</span>
<a href="#l4.21"></a><span id="l4.21">     // avoid parsing references every time we want one</span>
<a href="#l4.22"></a><span id="l4.22">     nsTArray&lt;nsCString&gt; m_references;</span>
<a href="#l4.23"></a><span id="l4.23">     nsMsgPriorityValue  m_priority;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     // nsMsgHdrs will have to know what db and row they belong to, since they are really</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgThread.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgThread.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -34,26 +34,26 @@ protected:</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   void                  Init();</span>
<a href="#l5.6"></a><span id="l5.6">   void                  Clear();</span>
<a href="#l5.7"></a><span id="l5.7">   virtual nsresult      InitCachedValues();</span>
<a href="#l5.8"></a><span id="l5.8">   nsresult              ChangeChildCount(int32_t delta);</span>
<a href="#l5.9"></a><span id="l5.9">   nsresult              ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l5.10"></a><span id="l5.10">   nsresult              RemoveChild(nsMsgKey msgKey);</span>
<a href="#l5.11"></a><span id="l5.11">   nsresult              SetThreadRootKey(nsMsgKey threadRootKey);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsresult              GetChildHdrForKey(nsMsgKey desiredKey, </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                                          nsIMsgDBHdr **result, int32_t *resultIndex); </span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  nsresult              GetChildHdrForKey(nsMsgKey desiredKey,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                                          nsIMsgDBHdr **result, int32_t *resultIndex);</span>
<a href="#l5.16"></a><span id="l5.16">   nsresult              RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l5.17"></a><span id="l5.17">   nsresult              ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20">   nsresult              ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l5.21"></a><span id="l5.21">                                                        nsIDBChangeAnnouncer *announcer);</span>
<a href="#l5.22"></a><span id="l5.22">   nsresult              ReparentMsgsWithInvalidParent(uint32_t numChildren, nsMsgKey threadParentKey);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  nsMsgKey              m_threadKey; </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  nsMsgKey              m_threadKey;</span>
<a href="#l5.26"></a><span id="l5.26">   uint32_t              m_numChildren;</span>
<a href="#l5.27"></a><span id="l5.27">   uint32_t              m_numUnreadChildren;</span>
<a href="#l5.28"></a><span id="l5.28">   uint32_t              m_flags;</span>
<a href="#l5.29"></a><span id="l5.29">   nsCOMPtr&lt;nsIMdbTable&gt; m_mdbTable;</span>
<a href="#l5.30"></a><span id="l5.30">   nsCOMPtr&lt;nsIMdbRow&gt;   m_metaRow;</span>
<a href="#l5.31"></a><span id="l5.31">   bool                  m_cachedValuesInitialized;</span>
<a href="#l5.32"></a><span id="l5.32">   nsMsgKey              m_threadRootKey;</span>
<a href="#l5.33"></a><span id="l5.33">   uint32_t              m_newestMsgDate;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -15,17 +15,17 @@ class MSG_RetrieveArtInfo;</span>
<a href="#l6.4"></a><span id="l6.4"> class MSG_PurgeInfo;</span>
<a href="#l6.5"></a><span id="l6.5"> // news group database</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> class nsNewsDatabase : public nsMsgDatabase , public nsINewsDatabase</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9"> public:</span>
<a href="#l6.10"></a><span id="l6.10">   nsNewsDatabase();</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l6.14"></a><span id="l6.14">   NS_DECL_NSINEWSDATABASE</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   NS_IMETHOD Close(bool forceCommit) override;</span>
<a href="#l6.17"></a><span id="l6.17">   NS_IMETHOD ForceClosed() override;</span>
<a href="#l6.18"></a><span id="l6.18">   NS_IMETHOD Commit(nsMsgDBCommit commitType) override;</span>
<a href="#l6.19"></a><span id="l6.19">   virtual uint32_t GetCurVersion() override;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   // methods to get and set docsets for ids.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -33,22 +33,22 @@ public:</span>
<a href="#l6.23"></a><span id="l6.23">   virtual nsresult  IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead) override;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">   NS_IMETHOD         GetHighWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l6.26"></a><span id="l6.26">   NS_IMETHOD         GetLowWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l6.27"></a><span id="l6.27">   NS_IMETHOD         MarkAllRead(uint32_t *aNumMarked, nsMsgKey **thoseMarked) override;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   virtual nsresult    ExpireUpTo(nsMsgKey expireKey);</span>
<a href="#l6.30"></a><span id="l6.30">   virtual nsresult    ExpireRange(nsMsgKey startRange, nsMsgKey endRange);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">- </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+</span>
<a href="#l6.33"></a><span id="l6.33">   virtual bool        SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead) override;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">- </span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36">   virtual nsresult  AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) override;</span>
<a href="#l6.37"></a><span id="l6.37">   nsresult          SyncWithReadSet();</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-  </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+</span>
<a href="#l6.40"></a><span id="l6.40">   NS_IMETHOD GetDefaultViewFlags(nsMsgViewFlagsTypeValue *aDefaultViewFlags) override;</span>
<a href="#l6.41"></a><span id="l6.41">   NS_IMETHOD GetDefaultSortType(nsMsgViewSortTypeValue *aDefaultSortType) override;</span>
<a href="#l6.42"></a><span id="l6.42">   NS_IMETHOD GetDefaultSortOrder(nsMsgViewSortOrderValue *aDefaultSortOrder) override;</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44"> protected:</span>
<a href="#l6.45"></a><span id="l6.45">   virtual ~nsNewsDatabase();</span>
<a href="#l6.46"></a><span id="l6.46">   // this is owned by the nsNewsFolder, which lives longer than the db.</span>
<a href="#l6.47"></a><span id="l6.47">   nsMsgKeySet           *m_readSet;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -48,17 +48,17 @@ NS_IMETHODIMP	nsImapMailDatabase::SetSum</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> // IMAP does not set local file flags, override does nothing</span>
<a href="#l7.7"></a><span id="l7.7"> void nsImapMailDatabase::UpdateFolderFlag(nsIMsgDBHdr * /* msgHdr */, bool /* bSet */,</span>
<a href="#l7.8"></a><span id="l7.8">                                           nsMsgMessageFlagType /* flag */, nsIOutputStream ** /* ppFileStream */)</span>
<a href="#l7.9"></a><span id="l7.9"> {</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-// We override this to avoid our parent class (nsMailDatabase)'s </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+// We override this to avoid our parent class (nsMailDatabase)'s</span>
<a href="#l7.14"></a><span id="l7.14"> // grabbing of the folder semaphore, and bailing on failure.</span>
<a href="#l7.15"></a><span id="l7.15"> NS_IMETHODIMP nsImapMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l7.16"></a><span id="l7.16"> {</span>
<a href="#l7.17"></a><span id="l7.17">   return nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l7.18"></a><span id="l7.18"> }</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> nsresult nsImapMailDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr)</span>
<a href="#l7.21"></a><span id="l7.21"> {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -177,17 +177,17 @@ nsresult nsImapMailDatabase::GetRowForPe</span>
<a href="#l7.23"></a><span id="l7.23">     rv  = m_mdbStore-&gt;NewRow(GetEnv(), m_pendingHdrsRowScopeToken, getter_AddRefs(pendingRow));</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.26"></a><span id="l7.26">   if (pendingRow)</span>
<a href="#l7.27"></a><span id="l7.27">   {</span>
<a href="#l7.28"></a><span id="l7.28">     // now we need to add cells to the row to remember the messageid, property and property value, and flags.</span>
<a href="#l7.29"></a><span id="l7.29">     // Then, when hdrs are added to the db, we'll check if they have a matching message-id, and if so,</span>
<a href="#l7.30"></a><span id="l7.30">     // set the property and flags</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    // XXX we already fetched messageId from the pending hdr, could it have changed by the time we get here? </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    // XXX we already fetched messageId from the pending hdr, could it have changed by the time we get here?</span>
<a href="#l7.33"></a><span id="l7.33">     nsCString messageId;</span>
<a href="#l7.34"></a><span id="l7.34">     pendingHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l7.35"></a><span id="l7.35">     // we're just going to ignore messages without a message-id. They should be rare. If SPAM messages often</span>
<a href="#l7.36"></a><span id="l7.36">     // didn't have message-id's, they'd be filtered on the server, most likely, and spammers would then</span>
<a href="#l7.37"></a><span id="l7.37">     // start putting in message-id's.</span>
<a href="#l7.38"></a><span id="l7.38">     if (!messageId.IsEmpty())</span>
<a href="#l7.39"></a><span id="l7.39">     {</span>
<a href="#l7.40"></a><span id="l7.40">        extern const char *kMessageIdColumnName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -59,17 +59,17 @@ NS_IMETHODIMP nsMailDatabase::ForceClose</span>
<a href="#l8.4"></a><span id="l8.4"> }</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> // get this on demand so that only db's that have offline ops will</span>
<a href="#l8.7"></a><span id="l8.7"> // create the table.</span>
<a href="#l8.8"></a><span id="l8.8"> nsresult nsMailDatabase::GetAllOfflineOpsTable()</span>
<a href="#l8.9"></a><span id="l8.9"> {</span>
<a href="#l8.10"></a><span id="l8.10">   nsresult rv = NS_OK;</span>
<a href="#l8.11"></a><span id="l8.11">   if (!m_mdbAllOfflineOpsTable)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind, getter_AddRefs(m_mdbAllOfflineOpsTable), </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind, getter_AddRefs(m_mdbAllOfflineOpsTable),</span>
<a href="#l8.14"></a><span id="l8.14">                                                 m_offlineOpsRowScopeToken, m_offlineOpsTableKindToken) ;</span>
<a href="#l8.15"></a><span id="l8.15">   return rv;</span>
<a href="#l8.16"></a><span id="l8.16"> }</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> NS_IMETHODIMP nsMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l8.20"></a><span id="l8.20"> {</span>
<a href="#l8.21"></a><span id="l8.21">   nsresult rv;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -97,17 +97,17 @@ NS_IMETHODIMP nsMailDatabase::GetSummary</span>
<a href="#l8.23"></a><span id="l8.23">   {</span>
<a href="#l8.24"></a><span id="l8.24">     *aResult = false;</span>
<a href="#l8.25"></a><span id="l8.25">     return NS_OK;</span>
<a href="#l8.26"></a><span id="l8.26">   }</span>
<a href="#l8.27"></a><span id="l8.27">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l8.28"></a><span id="l8.28">   if (!m_folder) {</span>
<a href="#l8.29"></a><span id="l8.29">     // If the folder is not set, we just return without checking the validity</span>
<a href="#l8.30"></a><span id="l8.30">     // of the summary file. For now, this is an expected condition when the</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    // message database is being opened from a URL in </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    // message database is being opened from a URL in</span>
<a href="#l8.33"></a><span id="l8.33">     // nsMailboxUrl::GetMsgHdrForKey() which calls</span>
<a href="#l8.34"></a><span id="l8.34">     // nsMsgDBService::OpenMailDBFromFile() without a folder.</span>
<a href="#l8.35"></a><span id="l8.35">     // Returning an error here would lead to the deletion of the MSF in the</span>
<a href="#l8.36"></a><span id="l8.36">     // caller nsMsgDatabase::CheckForErrors().</span>
<a href="#l8.37"></a><span id="l8.37">     *aResult = true;</span>
<a href="#l8.38"></a><span id="l8.38">     return NS_OK;</span>
<a href="#l8.39"></a><span id="l8.39">   }</span>
<a href="#l8.40"></a><span id="l8.40">   nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -131,20 +131,20 @@ NS_IMETHODIMP nsMailDatabase::SetSummary</span>
<a href="#l8.42"></a><span id="l8.42">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l8.43"></a><span id="l8.43">   nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l8.44"></a><span id="l8.44">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.45"></a><span id="l8.45">   return msgStore-&gt;SetSummaryFileValid(m_folder, this, aValid);</span>
<a href="#l8.46"></a><span id="l8.46"> }</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> NS_IMETHODIMP  nsMailDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l8.49"></a><span id="l8.49"> {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l8.53"></a><span id="l8.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+</span>
<a href="#l8.56"></a><span id="l8.56">   if (!op || !m_mdbAllOfflineOpsTable)</span>
<a href="#l8.57"></a><span id="l8.57">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.58"></a><span id="l8.58">   nsMsgOfflineImapOperation* offlineOp = static_cast&lt;nsMsgOfflineImapOperation*&gt;(op);  // closed system, so this is ok</span>
<a href="#l8.59"></a><span id="l8.59">   nsIMdbRow* row = offlineOp-&gt;GetMDBRow();</span>
<a href="#l8.60"></a><span id="l8.60">   rv = m_mdbAllOfflineOpsTable-&gt;CutRow(GetEnv(), row);</span>
<a href="#l8.61"></a><span id="l8.61">   row-&gt;CutAllColumns(GetEnv());</span>
<a href="#l8.62"></a><span id="l8.62">   return rv;</span>
<a href="#l8.63"></a><span id="l8.63"> }</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineat">@@ -152,41 +152,41 @@ NS_IMETHODIMP  nsMailDatabase::RemoveOff</span>
<a href="#l8.65"></a><span id="l8.65"> NS_IMETHODIMP nsMailDatabase::GetOfflineOpForKey(nsMsgKey msgKey, bool create, nsIMsgOfflineImapOperation **offlineOp)</span>
<a href="#l8.66"></a><span id="l8.66"> {</span>
<a href="#l8.67"></a><span id="l8.67">   mdb_bool	hasOid;</span>
<a href="#l8.68"></a><span id="l8.68">   mdbOid		rowObjectId;</span>
<a href="#l8.69"></a><span id="l8.69">   nsresult err;</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l8.72"></a><span id="l8.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+</span>
<a href="#l8.75"></a><span id="l8.75">   if (!offlineOp || !m_mdbAllOfflineOpsTable)</span>
<a href="#l8.76"></a><span id="l8.76">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  </span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+</span>
<a href="#l8.79"></a><span id="l8.79">   *offlineOp = NULL;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  </span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+</span>
<a href="#l8.82"></a><span id="l8.82">   rowObjectId.mOid_Id = msgKey;</span>
<a href="#l8.83"></a><span id="l8.83">   rowObjectId.mOid_Scope = m_offlineOpsRowScopeToken;</span>
<a href="#l8.84"></a><span id="l8.84">   err = m_mdbAllOfflineOpsTable-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l8.85"></a><span id="l8.85">   if (NS_SUCCEEDED(err) &amp;&amp; m_mdbStore &amp;&amp; (hasOid  || create))</span>
<a href="#l8.86"></a><span id="l8.86">   {</span>
<a href="#l8.87"></a><span id="l8.87">     nsCOMPtr &lt;nsIMdbRow&gt; offlineOpRow;</span>
<a href="#l8.88"></a><span id="l8.88">     err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;rowObjectId, getter_AddRefs(offlineOpRow));</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-    </span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91">     if (create)</span>
<a href="#l8.92"></a><span id="l8.92">     {</span>
<a href="#l8.93"></a><span id="l8.93">       if (!offlineOpRow)</span>
<a href="#l8.94"></a><span id="l8.94">       {</span>
<a href="#l8.95"></a><span id="l8.95">         err  = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;rowObjectId, getter_AddRefs(offlineOpRow));</span>
<a href="#l8.96"></a><span id="l8.96">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l8.97"></a><span id="l8.97">       }</span>
<a href="#l8.98"></a><span id="l8.98">       if (offlineOpRow &amp;&amp; !hasOid)</span>
<a href="#l8.99"></a><span id="l8.99">         m_mdbAllOfflineOpsTable-&gt;AddRow(GetEnv(), offlineOpRow);</span>
<a href="#l8.100"></a><span id="l8.100">     }</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-    </span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103">     if (NS_SUCCEEDED(err) &amp;&amp; offlineOpRow)</span>
<a href="#l8.104"></a><span id="l8.104">     {</span>
<a href="#l8.105"></a><span id="l8.105">       NS_IF_ADDREF(*offlineOp = new nsMsgOfflineImapOperation(this, offlineOpRow));</span>
<a href="#l8.106"></a><span id="l8.106">       (*offlineOp)-&gt;SetMessageKey(msgKey);</span>
<a href="#l8.107"></a><span id="l8.107">     }</span>
<a href="#l8.108"></a><span id="l8.108">     if (!hasOid &amp;&amp; m_dbFolderInfo)</span>
<a href="#l8.109"></a><span id="l8.109">     {</span>
<a href="#l8.110"></a><span id="l8.110">       // set initial value for flags so we don't lose them.</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineat">@@ -197,17 +197,17 @@ NS_IMETHODIMP nsMailDatabase::GetOffline</span>
<a href="#l8.112"></a><span id="l8.112">         uint32_t flags;</span>
<a href="#l8.113"></a><span id="l8.113">         msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l8.114"></a><span id="l8.114">         (*offlineOp)-&gt;SetNewFlags(flags);</span>
<a href="#l8.115"></a><span id="l8.115">       }</span>
<a href="#l8.116"></a><span id="l8.116">       int32_t newFlags;</span>
<a href="#l8.117"></a><span id="l8.117">       m_dbFolderInfo-&gt;OrFlags(nsMsgFolderFlags::OfflineEvents, &amp;newFlags);</span>
<a href="#l8.118"></a><span id="l8.118">     }</span>
<a href="#l8.119"></a><span id="l8.119">   }</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-  </span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+</span>
<a href="#l8.122"></a><span id="l8.122">   return err;</span>
<a href="#l8.123"></a><span id="l8.123"> }</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125"> NS_IMETHODIMP nsMailDatabase::EnumerateOfflineOps(nsISimpleEnumerator **enumerator)</span>
<a href="#l8.126"></a><span id="l8.126"> {</span>
<a href="#l8.127"></a><span id="l8.127">   NS_ASSERTION(false, &quot;not impl yet&quot;);</span>
<a href="#l8.128"></a><span id="l8.128">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.129"></a><span id="l8.129"> }</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineat">@@ -222,17 +222,17 @@ NS_IMETHODIMP nsMailDatabase::ListAllOff</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132">   if (m_mdbAllOfflineOpsTable)</span>
<a href="#l8.133"></a><span id="l8.133">   {</span>
<a href="#l8.134"></a><span id="l8.134">     nsresult err = m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l8.135"></a><span id="l8.135">     while (NS_SUCCEEDED(err) &amp;&amp; rowCursor)</span>
<a href="#l8.136"></a><span id="l8.136">     {</span>
<a href="#l8.137"></a><span id="l8.137">       mdbOid outOid;</span>
<a href="#l8.138"></a><span id="l8.138">       mdb_pos	outPos;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-      </span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+</span>
<a href="#l8.141"></a><span id="l8.141">       err = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l8.142"></a><span id="l8.142">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l8.143"></a><span id="l8.143">       if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id) -1)</span>
<a href="#l8.144"></a><span id="l8.144">         break;</span>
<a href="#l8.145"></a><span id="l8.145">       if (NS_SUCCEEDED(err))</span>
<a href="#l8.146"></a><span id="l8.146">       {</span>
<a href="#l8.147"></a><span id="l8.147">         offlineOpIds-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l8.148"></a><span id="l8.148">         if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineat">@@ -360,17 +360,17 @@ NS_IMETHODIMP nsMsgOfflineOpEnumerator::</span>
<a href="#l8.150"></a><span id="l8.150"> {</span>
<a href="#l8.151"></a><span id="l8.151">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153">   nsresult rv = NS_OK;</span>
<a href="#l8.154"></a><span id="l8.154">   if (!mNextPrefetched)</span>
<a href="#l8.155"></a><span id="l8.155">     rv = PrefetchNext();</span>
<a href="#l8.156"></a><span id="l8.156">   if (NS_SUCCEEDED(rv))</span>
<a href="#l8.157"></a><span id="l8.157">   {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    if (mResultOp) </span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    if (mResultOp)</span>
<a href="#l8.160"></a><span id="l8.160">     {</span>
<a href="#l8.161"></a><span id="l8.161">       NS_ADDREF(*aItem = mResultOp);</span>
<a href="#l8.162"></a><span id="l8.162">       mNextPrefetched = false;</span>
<a href="#l8.163"></a><span id="l8.163">     }</span>
<a href="#l8.164"></a><span id="l8.164">   }</span>
<a href="#l8.165"></a><span id="l8.165">   return rv;</span>
<a href="#l8.166"></a><span id="l8.166"> }</span>
<a href="#l8.167"></a><span id="l8.167"> </span>
<a href="#l8.168"></a><span id="l8.168" class="difflineat">@@ -383,33 +383,33 @@ nsresult nsMsgOfflineOpEnumerator::Prefe</span>
<a href="#l8.169"></a><span id="l8.169">   if (!mRowCursor)</span>
<a href="#l8.170"></a><span id="l8.170">   {</span>
<a href="#l8.171"></a><span id="l8.171">     rv = GetRowCursor();</span>
<a href="#l8.172"></a><span id="l8.172">     if (NS_FAILED(rv))</span>
<a href="#l8.173"></a><span id="l8.173">       return rv;</span>
<a href="#l8.174"></a><span id="l8.174">   }</span>
<a href="#l8.175"></a><span id="l8.175"> </span>
<a href="#l8.176"></a><span id="l8.176">   rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;offlineOpRow, &amp;rowPos);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-  if (!offlineOpRow) </span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  if (!offlineOpRow)</span>
<a href="#l8.179"></a><span id="l8.179">   {</span>
<a href="#l8.180"></a><span id="l8.180">     mDone = true;</span>
<a href="#l8.181"></a><span id="l8.181">     return NS_ERROR_FAILURE;</span>
<a href="#l8.182"></a><span id="l8.182">   }</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.185"></a><span id="l8.185">   {</span>
<a href="#l8.186"></a><span id="l8.186">     mDone = true;</span>
<a href="#l8.187"></a><span id="l8.187">     return rv;</span>
<a href="#l8.188"></a><span id="l8.188">   }</span>
<a href="#l8.189"></a><span id="l8.189"> </span>
<a href="#l8.190"></a><span id="l8.190">   nsIMsgOfflineImapOperation *op = new nsMsgOfflineImapOperation(mDB, offlineOpRow);</span>
<a href="#l8.191"></a><span id="l8.191">   mResultOp = op;</span>
<a href="#l8.192"></a><span id="l8.192">   if (!op)</span>
<a href="#l8.193"></a><span id="l8.193">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.194"></a><span id="l8.194"> </span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-  if (mResultOp) </span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  if (mResultOp)</span>
<a href="#l8.197"></a><span id="l8.197">   {</span>
<a href="#l8.198"></a><span id="l8.198">     mNextPrefetched = true;</span>
<a href="#l8.199"></a><span id="l8.199">     return NS_OK;</span>
<a href="#l8.200"></a><span id="l8.200">   }</span>
<a href="#l8.201"></a><span id="l8.201">   return NS_ERROR_FAILURE;</span>
<a href="#l8.202"></a><span id="l8.202"> }</span>
<a href="#l8.203"></a><span id="l8.203"> </span>
<a href="#l8.204"></a><span id="l8.204"> NS_IMETHODIMP nsMsgOfflineOpEnumerator::HasMoreElements(bool *aResult)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -267,17 +267,17 @@ NS_IMETHODIMP nsMsgDBService::OpenMore(n</span>
<a href="#l9.4"></a><span id="l9.4">     }</span>
<a href="#l9.5"></a><span id="l9.5">   }</span>
<a href="#l9.6"></a><span id="l9.6">   while (PR_IntervalToMilliseconds(PR_IntervalNow() - startTime) &lt;= aTimeHint);</span>
<a href="#l9.7"></a><span id="l9.7">   *_retval = !msgDatabase-&gt;m_thumb;</span>
<a href="#l9.8"></a><span id="l9.8">   return rv;</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- * When a db is opened, we need to hook up any pending listeners for </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * When a db is opened, we need to hook up any pending listeners for</span>
<a href="#l9.14"></a><span id="l9.14">  * that db, and notify them.</span>
<a href="#l9.15"></a><span id="l9.15">  */</span>
<a href="#l9.16"></a><span id="l9.16"> void nsMsgDBService::HookupPendingListeners(nsIMsgDatabase *db,</span>
<a href="#l9.17"></a><span id="l9.17">                                             nsIMsgFolder *folder)</span>
<a href="#l9.18"></a><span id="l9.18"> {</span>
<a href="#l9.19"></a><span id="l9.19">   for (int32_t listenerIndex = 0;</span>
<a href="#l9.20"></a><span id="l9.20">        listenerIndex &lt; m_foldersPendingListeners.Count(); listenerIndex++)</span>
<a href="#l9.21"></a><span id="l9.21">   {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -363,30 +363,30 @@ NS_IMETHODIMP nsMsgDBService::OpenMailDB</span>
<a href="#l9.23"></a><span id="l9.23">     msgDB-&gt;m_folder = aFolder;</span>
<a href="#l9.24"></a><span id="l9.24">   return rv;</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> NS_IMETHODIMP nsMsgDBService::CreateNewDB(nsIMsgFolder *aFolder,</span>
<a href="#l9.28"></a><span id="l9.28">                                           nsIMsgDatabase **_retval)</span>
<a href="#l9.29"></a><span id="l9.29"> {</span>
<a href="#l9.30"></a><span id="l9.30">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+</span>
<a href="#l9.33"></a><span id="l9.33">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l9.34"></a><span id="l9.34">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l9.35"></a><span id="l9.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">   nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l9.38"></a><span id="l9.38">   rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(summaryFilePath));</span>
<a href="#l9.39"></a><span id="l9.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   nsCString localDatabaseType;</span>
<a href="#l9.42"></a><span id="l9.42">   incomingServer-&gt;GetLocalDatabaseType(localDatabaseType);</span>
<a href="#l9.43"></a><span id="l9.43">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l9.44"></a><span id="l9.44">   dbContractID.Append(localDatabaseType.get());</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  </span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l9.48"></a><span id="l9.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l9.53"></a><span id="l9.53">   rv = msgDatabase-&gt;Open(this, summaryFilePath, true, true);</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55" class="difflineat">@@ -875,17 +875,17 @@ public:</span>
<a href="#l9.56"></a><span id="l9.56">                             nsISupports* aClosure,</span>
<a href="#l9.57"></a><span id="l9.57">                             bool aAnonymize) override</span>
<a href="#l9.58"></a><span id="l9.58">   {</span>
<a href="#l9.59"></a><span id="l9.59">     nsCString path;</span>
<a href="#l9.60"></a><span id="l9.60">     GetPath(path, aAnonymize);</span>
<a href="#l9.61"></a><span id="l9.61">     return aCb-&gt;Callback(EmptyCString(), path,</span>
<a href="#l9.62"></a><span id="l9.62">                          nsIMemoryReporter::KIND_HEAP,</span>
<a href="#l9.63"></a><span id="l9.63">                          nsIMemoryReporter::UNITS_BYTES,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-                         mDatabase-&gt;SizeOfIncludingThis(GetMallocSize),           </span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+                         mDatabase-&gt;SizeOfIncludingThis(GetMallocSize),</span>
<a href="#l9.66"></a><span id="l9.66">                          NS_LITERAL_CSTRING(&quot;Memory used for the folder database.&quot;),</span>
<a href="#l9.67"></a><span id="l9.67">                          aClosure);</span>
<a href="#l9.68"></a><span id="l9.68">   }</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70">   void GetPath(nsACString &amp;memoryPath, bool aAnonymize)</span>
<a href="#l9.71"></a><span id="l9.71">   {</span>
<a href="#l9.72"></a><span id="l9.72">     memoryPath.AssignLiteral(&quot;explicit/maildb/database(&quot;);</span>
<a href="#l9.73"></a><span id="l9.73">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineat">@@ -1169,17 +1169,17 @@ nsresult nsMsgDatabase::OpenMDB(const ch</span>
<a href="#l9.75"></a><span id="l9.75">         if (NS_SUCCEEDED(ret))</span>
<a href="#l9.76"></a><span id="l9.76">           ret = dbFile-&gt;Exists(&amp;exists);</span>
<a href="#l9.77"></a><span id="l9.77">       }</span>
<a href="#l9.78"></a><span id="l9.78">       if (!exists)</span>
<a href="#l9.79"></a><span id="l9.79">       {</span>
<a href="#l9.80"></a><span id="l9.80">         ret = NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l9.81"></a><span id="l9.81">       }</span>
<a href="#l9.82"></a><span id="l9.82">       // If m_thumb is set, we're asynchronously opening the db already.</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-      else if (!m_thumb) </span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+      else if (!m_thumb)</span>
<a href="#l9.85"></a><span id="l9.85">       {</span>
<a href="#l9.86"></a><span id="l9.86">         mdbOpenPolicy inOpenPolicy;</span>
<a href="#l9.87"></a><span id="l9.87">         mdb_bool  canOpen;</span>
<a href="#l9.88"></a><span id="l9.88">         mdbYarn    outFormatVersion;</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">         nsIMdbFile* oldFile = nullptr;</span>
<a href="#l9.91"></a><span id="l9.91">         ret = mdbFactory-&gt;OpenOldFile(m_mdbEnv, dbHeap, dbName,</span>
<a href="#l9.92"></a><span id="l9.92">                                       mdbBool_kFalse, // not readonly, we want modifiable</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineat">@@ -1823,17 +1823,17 @@ NS_IMETHODIMP nsMsgDatabase::DeleteHeade</span>
<a href="#l9.94"></a><span id="l9.94">   {</span>
<a href="#l9.95"></a><span id="l9.95">     (void)msg-&gt;GetFlags(&amp;flags);</span>
<a href="#l9.96"></a><span id="l9.96">     msg-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l9.97"></a><span id="l9.97">   }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99">   RemoveHeaderFromThread(msgHdr);</span>
<a href="#l9.100"></a><span id="l9.100">   if (notify)</span>
<a href="#l9.101"></a><span id="l9.101">   {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    // If deleted hdr was new, restore the new flag on flags </span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    // If deleted hdr was new, restore the new flag on flags</span>
<a href="#l9.104"></a><span id="l9.104">     // so saved searches will know to reduce their new msg count.</span>
<a href="#l9.105"></a><span id="l9.105">     if (hdrWasNew)</span>
<a href="#l9.106"></a><span id="l9.106">       flags |= nsMsgMessageFlags::New;</span>
<a href="#l9.107"></a><span id="l9.107">     NotifyHdrDeletedAll(msg, threadParent, flags, instigator); // tell listeners</span>
<a href="#l9.108"></a><span id="l9.108">   }</span>
<a href="#l9.109"></a><span id="l9.109">   //  if (!onlyRemoveFromThread)  // to speed up expiration, try this. But really need to do this in RemoveHeaderFromDB</span>
<a href="#l9.110"></a><span id="l9.110">   nsresult ret = RemoveHeaderFromDB(msgHdr);</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112" class="difflineat">@@ -2273,17 +2273,17 @@ nsMsgDatabase::SetUint32PropertyByHdr(ns</span>
<a href="#l9.113"></a><span id="l9.113">   // If no change to this property, bail out.</span>
<a href="#l9.114"></a><span id="l9.114">   uint32_t oldValue;</span>
<a href="#l9.115"></a><span id="l9.115">   nsresult rv = aMsgHdr-&gt;GetUint32Property(aProperty, &amp;oldValue);</span>
<a href="#l9.116"></a><span id="l9.116">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.117"></a><span id="l9.117">   if (oldValue == aValue)</span>
<a href="#l9.118"></a><span id="l9.118">     return NS_OK;</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120">   // Don't do notifications if message not yet added to database.</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-  bool notify = true;  </span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  bool notify = true;</span>
<a href="#l9.123"></a><span id="l9.123">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l9.124"></a><span id="l9.124">   aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l9.125"></a><span id="l9.125">   ContainsKey(key, &amp;notify);</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127">   // Precall OnHdrPropertyChanged to store prechange status.</span>
<a href="#l9.128"></a><span id="l9.128">   nsTArray&lt;uint32_t&gt; statusArray(m_ChangeListeners.Length());</span>
<a href="#l9.129"></a><span id="l9.129">   uint32_t status;</span>
<a href="#l9.130"></a><span id="l9.130">   nsCOMPtr&lt;nsIDBChangeListener&gt; listener;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineat">@@ -2466,17 +2466,17 @@ NS_IMETHODIMP nsMsgDatabase::MarkHdrRead</span>
<a href="#l9.132"></a><span id="l9.132">   // if the flag is already correct in the db, don't change it.</span>
<a href="#l9.133"></a><span id="l9.133">   // Check msg flags as well as IsHeaderRead in case it's a newsgroup</span>
<a href="#l9.134"></a><span id="l9.134">   // and the msghdr flags are out of sync with the newsrc settings.</span>
<a href="#l9.135"></a><span id="l9.135">   // (we could override this method for news db's, but it's a trivial fix here.</span>
<a href="#l9.136"></a><span id="l9.136">   if (bRead != isRead || isRead != isReadInDB)</span>
<a href="#l9.137"></a><span id="l9.137">   {</span>
<a href="#l9.138"></a><span id="l9.138">     nsMsgKey msgKey;</span>
<a href="#l9.139"></a><span id="l9.139">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-    </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+</span>
<a href="#l9.142"></a><span id="l9.142">     bool inDB = false;</span>
<a href="#l9.143"></a><span id="l9.143">     (void)ContainsKey(msgKey, &amp;inDB);</span>
<a href="#l9.144"></a><span id="l9.144"> </span>
<a href="#l9.145"></a><span id="l9.145">     if (inDB)</span>
<a href="#l9.146"></a><span id="l9.146">     {</span>
<a href="#l9.147"></a><span id="l9.147">       nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l9.148"></a><span id="l9.148">       rv = GetThreadForMsgKey(msgKey, getter_AddRefs(threadHdr));</span>
<a href="#l9.149"></a><span id="l9.149">       if (threadHdr)</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineat">@@ -2853,17 +2853,17 @@ nsMsgDatabase::ReverseEnumerateMessages(</span>
<a href="#l9.151"></a><span id="l9.151">   return NS_OK;</span>
<a href="#l9.152"></a><span id="l9.152"> }</span>
<a href="#l9.153"></a><span id="l9.153"> </span>
<a href="#l9.154"></a><span id="l9.154"> NS_IMETHODIMP</span>
<a href="#l9.155"></a><span id="l9.155"> nsMsgDatabase::GetFilterEnumerator(nsIArray *searchTerms, bool aReverse,</span>
<a href="#l9.156"></a><span id="l9.156">                                    nsISimpleEnumerator **aResult)</span>
<a href="#l9.157"></a><span id="l9.157"> {</span>
<a href="#l9.158"></a><span id="l9.158">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-  RefPtr&lt;nsMsgFilteredDBEnumerator&gt; e = </span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  RefPtr&lt;nsMsgFilteredDBEnumerator&gt; e =</span>
<a href="#l9.161"></a><span id="l9.161">     new nsMsgFilteredDBEnumerator(this, m_mdbAllMsgHeadersTable, aReverse,</span>
<a href="#l9.162"></a><span id="l9.162">                                   searchTerms);</span>
<a href="#l9.163"></a><span id="l9.163"> </span>
<a href="#l9.164"></a><span id="l9.164">   NS_ENSURE_TRUE(e, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.165"></a><span id="l9.165">   nsresult rv = e-&gt;InitSearchSession(searchTerms, m_folder);</span>
<a href="#l9.166"></a><span id="l9.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.167"></a><span id="l9.167">   return CallQueryInterface(e.get(), aResult);</span>
<a href="#l9.168"></a><span id="l9.168"> }</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineat">@@ -3042,20 +3042,20 @@ NS_IMPL_ISUPPORTS(nsMsgDBThreadEnumerato</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172"> /* void OnHdrFlagsChanged (in nsIMsgDBHdr aHdrChanged, in unsigned long aOldFlags, in unsigned long aNewFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l9.173"></a><span id="l9.173"> NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l9.174"></a><span id="l9.174"> {</span>
<a href="#l9.175"></a><span id="l9.175">     return NS_OK;</span>
<a href="#l9.176"></a><span id="l9.176"> }</span>
<a href="#l9.177"></a><span id="l9.177"> </span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-//void OnHdrPropertyChanged(in nsIMsgDBHdr aHdrToChange, in bool aPreChange, </span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+//void OnHdrPropertyChanged(in nsIMsgDBHdr aHdrToChange, in bool aPreChange,</span>
<a href="#l9.180"></a><span id="l9.180"> // inout uint32_t aStatus, in nsIDBChangeListener aInstigator);</span>
<a href="#l9.181"></a><span id="l9.181"> NS_IMETHODIMP</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-nsMsgDBThreadEnumerator::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus, </span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+nsMsgDBThreadEnumerator::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l9.184"></a><span id="l9.184">                                          nsIDBChangeListener * aInstigator)</span>
<a href="#l9.185"></a><span id="l9.185"> {</span>
<a href="#l9.186"></a><span id="l9.186">   return NS_OK;</span>
<a href="#l9.187"></a><span id="l9.187"> }</span>
<a href="#l9.188"></a><span id="l9.188"> </span>
<a href="#l9.189"></a><span id="l9.189"> /* void onHdrDeleted (in nsIMsgDBHdr aHdrChanged, in nsMsgKey aParentKey, in long aFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l9.190"></a><span id="l9.190"> NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l9.191"></a><span id="l9.191"> {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineat">@@ -3843,27 +3843,27 @@ nsresult nsMsgDatabase::SetUint64Propert</span>
<a href="#l9.193"></a><span id="l9.193">   if (NS_SUCCEEDED(err))</span>
<a href="#l9.194"></a><span id="l9.194">   {</span>
<a href="#l9.195"></a><span id="l9.195">     UInt64ToYarn(&amp;yarn, propertyVal);</span>
<a href="#l9.196"></a><span id="l9.196">     err = row-&gt;AddColumn(GetEnv(), property_token, &amp;yarn);</span>
<a href="#l9.197"></a><span id="l9.197">   }</span>
<a href="#l9.198"></a><span id="l9.198">   return err;</span>
<a href="#l9.199"></a><span id="l9.199"> }</span>
<a href="#l9.200"></a><span id="l9.200"> </span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-nsresult nsMsgDatabase::GetBooleanProperty(nsIMdbRow *row, const char *propertyName, </span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-                                     bool *result, </span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+nsresult nsMsgDatabase::GetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+                                     bool *result,</span>
<a href="#l9.205"></a><span id="l9.205">                                      bool defaultValue /* = false */)</span>
<a href="#l9.206"></a><span id="l9.206"> {</span>
<a href="#l9.207"></a><span id="l9.207">   uint32_t res;</span>
<a href="#l9.208"></a><span id="l9.208">   nsresult rv = GetUint32Property(row, propertyName, &amp;res, (uint32_t) defaultValue);</span>
<a href="#l9.209"></a><span id="l9.209">   *result = !!res;</span>
<a href="#l9.210"></a><span id="l9.210">   return rv;</span>
<a href="#l9.211"></a><span id="l9.211"> }</span>
<a href="#l9.212"></a><span id="l9.212"> </span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-nsresult nsMsgDatabase::SetBooleanProperty(nsIMdbRow *row, const char *propertyName, </span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+nsresult nsMsgDatabase::SetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l9.215"></a><span id="l9.215">                                     bool propertyVal)</span>
<a href="#l9.216"></a><span id="l9.216"> {</span>
<a href="#l9.217"></a><span id="l9.217">   return SetUint32Property(row, propertyName, (uint32_t) propertyVal);</span>
<a href="#l9.218"></a><span id="l9.218"> }</span>
<a href="#l9.219"></a><span id="l9.219"> </span>
<a href="#l9.220"></a><span id="l9.220"> nsresult nsMsgDatabase::SetNSStringPropertyWithToken(nsIMdbRow *row, mdb_token aProperty, const nsAString &amp;propertyStr)</span>
<a href="#l9.221"></a><span id="l9.221"> {</span>
<a href="#l9.222"></a><span id="l9.222">   NS_ENSURE_ARG(row);</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineat">@@ -3950,17 +3950,17 @@ void nsMsgDatabase::AddMsgRefsToHash(nsI</span>
<a href="#l9.224"></a><span id="l9.224">   nsMsgKey threadId;</span>
<a href="#l9.225"></a><span id="l9.225"> </span>
<a href="#l9.226"></a><span id="l9.226">   msgHdr-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l9.227"></a><span id="l9.227">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l9.228"></a><span id="l9.228"> </span>
<a href="#l9.229"></a><span id="l9.229">   for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l9.230"></a><span id="l9.230">   {</span>
<a href="#l9.231"></a><span id="l9.231">     nsAutoCString reference;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-    </span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+</span>
<a href="#l9.234"></a><span id="l9.234">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l9.235"></a><span id="l9.235">     if (reference.IsEmpty())</span>
<a href="#l9.236"></a><span id="l9.236">       break;</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238">     AddRefToHash(reference, threadId);</span>
<a href="#l9.239"></a><span id="l9.239">   }</span>
<a href="#l9.240"></a><span id="l9.240"> }</span>
<a href="#l9.241"></a><span id="l9.241"> </span>
<a href="#l9.242"></a><span id="l9.242" class="difflineat">@@ -3974,17 +3974,17 @@ void nsMsgDatabase::RemoveMsgRefsFromHas</span>
<a href="#l9.243"></a><span id="l9.243"> {</span>
<a href="#l9.244"></a><span id="l9.244">   uint16_t numReferences = 0;</span>
<a href="#l9.245"></a><span id="l9.245"> </span>
<a href="#l9.246"></a><span id="l9.246">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l9.247"></a><span id="l9.247"> </span>
<a href="#l9.248"></a><span id="l9.248">   for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l9.249"></a><span id="l9.249">   {</span>
<a href="#l9.250"></a><span id="l9.250">     nsAutoCString reference;</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-    </span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+</span>
<a href="#l9.253"></a><span id="l9.253">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l9.254"></a><span id="l9.254">     if (reference.IsEmpty())</span>
<a href="#l9.255"></a><span id="l9.255">       break;</span>
<a href="#l9.256"></a><span id="l9.256"> </span>
<a href="#l9.257"></a><span id="l9.257">     RemoveRefFromHash(reference);</span>
<a href="#l9.258"></a><span id="l9.258">   }</span>
<a href="#l9.259"></a><span id="l9.259"> }</span>
<a href="#l9.260"></a><span id="l9.260"> </span>
<a href="#l9.261"></a><span id="l9.261" class="difflineat">@@ -4187,17 +4187,17 @@ nsIMsgThread *  nsMsgDatabase::GetThread</span>
<a href="#l9.262"></a><span id="l9.262">   return thread;</span>
<a href="#l9.263"></a><span id="l9.263"> }</span>
<a href="#l9.264"></a><span id="l9.264"> </span>
<a href="#l9.265"></a><span id="l9.265"> // Returns thread that contains a message that references the passed message ID</span>
<a href="#l9.266"></a><span id="l9.266"> nsIMsgThread *nsMsgDatabase::GetThreadForMessageId(nsCString &amp;msgId)</span>
<a href="#l9.267"></a><span id="l9.267"> {</span>
<a href="#l9.268"></a><span id="l9.268">   nsIMsgThread *thread = NULL;</span>
<a href="#l9.269"></a><span id="l9.269">   nsMsgKey threadId;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-  </span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+</span>
<a href="#l9.272"></a><span id="l9.272">   if (NS_SUCCEEDED(GetRefFromHash(msgId, &amp;threadId)))</span>
<a href="#l9.273"></a><span id="l9.273">     thread = GetThreadForThreadId(threadId);</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275">   return thread;</span>
<a href="#l9.276"></a><span id="l9.276"> }</span>
<a href="#l9.277"></a><span id="l9.277"> </span>
<a href="#l9.278"></a><span id="l9.278"> nsresult nsMsgDatabase::ThreadNewHdr(nsMsgHdr* newHdr, bool &amp;newThread)</span>
<a href="#l9.279"></a><span id="l9.279"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -692,46 +692,46 @@ nsresult nsMsgHdr::GetUInt64Column(mdb_t</span>
<a href="#l10.4"></a><span id="l10.4"> /**</span>
<a href="#l10.5"></a><span id="l10.5">  * Roughly speaking, get the next message-id (starts with a '&lt;' ends with a</span>
<a href="#l10.6"></a><span id="l10.6">  *  '&gt;').  Except, we also try to handle the case where your reference is of</span>
<a href="#l10.7"></a><span id="l10.7">  *  a prehistoric vintage that just stuck any old random junk in there.  Our</span>
<a href="#l10.8"></a><span id="l10.8">  *  old logic would (unintentionally?) just trim the whitespace off the front</span>
<a href="#l10.9"></a><span id="l10.9">  *  and hand you everything after that.  We change things at all because that</span>
<a href="#l10.10"></a><span id="l10.10">  *  same behaviour does not make sense if we have already seen a proper message</span>
<a href="#l10.11"></a><span id="l10.11">  *  id.  We keep the old behaviour at all because it would seem to have</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- *  benefits.  (See jwz's non-zero stats: http://www.jwz.org/doc/threading.html) </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ *  benefits.  (See jwz's non-zero stats: http://www.jwz.org/doc/threading.html)</span>
<a href="#l10.14"></a><span id="l10.14">  * So, to re-state, if there is a valid message-id in there at all, we only</span>
<a href="#l10.15"></a><span id="l10.15">  *  return valid message-id's (sans bracketing '&lt;' and '&gt;').  If there isn't,</span>
<a href="#l10.16"></a><span id="l10.16">  *  our result (via &quot;references&quot;) is a left-trimmed copy of the string.  If</span>
<a href="#l10.17"></a><span id="l10.17">  *  there is nothing in there, our result is an empty string.)  We do require</span>
<a href="#l10.18"></a><span id="l10.18">  *  that you pass allowNonDelimitedReferences what it demands, though.</span>
<a href="#l10.19"></a><span id="l10.19">  * For example: &quot;&lt;valid@stuff&gt; this stuff is invalid&quot; would net you</span>
<a href="#l10.20"></a><span id="l10.20">  *  &quot;valid@stuff&quot; and &quot;this stuff is invalid&quot; as results.  We now only would</span>
<a href="#l10.21"></a><span id="l10.21">  *  provide &quot;valid-stuff&quot; and an empty string (which you should ignore) as</span>
<a href="#l10.22"></a><span id="l10.22">  *  results.  However &quot;this stuff is invalid&quot; would return itself, allowing</span>
<a href="#l10.23"></a><span id="l10.23">  *  anything relying on that behaviour to keep working.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">- * </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ *</span>
<a href="#l10.26"></a><span id="l10.26">  * Note: We accept anything inside the '&lt;' and '&gt;'; technically, we should want</span>
<a href="#l10.27"></a><span id="l10.27">  *  at least a '@' in there (per rfc 2822).  But since we're going out of our</span>
<a href="#l10.28"></a><span id="l10.28">  *  way to support weird things...</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">- * </span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ *</span>
<a href="#l10.31"></a><span id="l10.31">  * @param startNextRef The position to start at; this should either be the start</span>
<a href="#l10.32"></a><span id="l10.32">  *     of your references string or our return value from a previous call.</span>
<a href="#l10.33"></a><span id="l10.33">  * @param reference You pass a nsCString by reference, we put the reference we</span>
<a href="#l10.34"></a><span id="l10.34">  *     find in it, if we find one.  It may be empty!  Beware!</span>
<a href="#l10.35"></a><span id="l10.35">  * @param allowNonDelimitedReferences Should we support the</span>
<a href="#l10.36"></a><span id="l10.36">  *     pre-reasonable-standards form of In-Reply-To where it could be any</span>
<a href="#l10.37"></a><span id="l10.37">  *     arbitrary string and our behaviour was just to take off leading</span>
<a href="#l10.38"></a><span id="l10.38">  *     whitespace.  It only makes sense to pass true for your first call to this</span>
<a href="#l10.39"></a><span id="l10.39">  *     function, as if you are around to make a second call, it means we found</span>
<a href="#l10.40"></a><span id="l10.40">  *     a properly formatted message-id and so we should only look for more</span>
<a href="#l10.41"></a><span id="l10.41">  *     properly formatted message-ids.</span>
<a href="#l10.42"></a><span id="l10.42">  * @returns The next starting position of this routine, which may be pointing at</span>
<a href="#l10.43"></a><span id="l10.43">  *     a nul '\0' character to indicate termination.</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">- */ </span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ */</span>
<a href="#l10.46"></a><span id="l10.46"> const char *nsMsgHdr::GetNextReference(const char *startNextRef,</span>
<a href="#l10.47"></a><span id="l10.47">                                        nsCString &amp;reference,</span>
<a href="#l10.48"></a><span id="l10.48">                                        bool acceptNonDelimitedReferences)</span>
<a href="#l10.49"></a><span id="l10.49"> {</span>
<a href="#l10.50"></a><span id="l10.50">   const char *ptr = startNextRef;</span>
<a href="#l10.51"></a><span id="l10.51">   const char *whitespaceEndedAt = nullptr;</span>
<a href="#l10.52"></a><span id="l10.52">   const char *firstMessageIdChar = nullptr;</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54" class="difflineat">@@ -767,17 +767,17 @@ const char *nsMsgHdr::GetNextReference(c</span>
<a href="#l10.55"></a><span id="l10.55">         MOZ_FALLTHROUGH;</span>
<a href="#l10.56"></a><span id="l10.56">       default:</span>
<a href="#l10.57"></a><span id="l10.57">         if (!whitespaceEndedAt)</span>
<a href="#l10.58"></a><span id="l10.58">             whitespaceEndedAt = ptr;</span>
<a href="#l10.59"></a><span id="l10.59">         break;</span>
<a href="#l10.60"></a><span id="l10.60">     }</span>
<a href="#l10.61"></a><span id="l10.61">   }</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  // keep going until we hit a '&gt;' or hit the end of the string </span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  // keep going until we hit a '&gt;' or hit the end of the string</span>
<a href="#l10.65"></a><span id="l10.65">   for(; *ptr ; ptr++)</span>
<a href="#l10.66"></a><span id="l10.66">   {</span>
<a href="#l10.67"></a><span id="l10.67">     if (*ptr == '&gt;')</span>
<a href="#l10.68"></a><span id="l10.68">     {</span>
<a href="#l10.69"></a><span id="l10.69">       // it's valid, update reference, making sure to stop before the '&gt;'</span>
<a href="#l10.70"></a><span id="l10.70">       reference.Assign(firstMessageIdChar, ptr - firstMessageIdChar);</span>
<a href="#l10.71"></a><span id="l10.71">       // and return a start point just after the '&gt;'</span>
<a href="#l10.72"></a><span id="l10.72">       return ++ptr;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

