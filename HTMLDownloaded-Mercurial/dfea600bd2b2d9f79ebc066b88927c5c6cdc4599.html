<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26469:dfea600bd2b2d9f79ebc066b88927c5c6cdc4599</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dfea600bd2b2d9f79ebc066b88927c5c6cdc4599" />
<meta property="og:url" content="/comm-central/rev/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599" />
<meta property="og:description" content="Bug 697522 - add logging of message filter runs and actions. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dfea600bd2b2d9f79ebc066b88927c5c6cdc4599 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">shortlog</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">files</a> |
changeset |
<a href="/comm-central/raw-rev/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">raw</a>  | <a href="/comm-central/archive/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697522">Bug 697522</a> - add logging of message filter runs and actions. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 26 Apr 2019 15:10:00 +0200</td></tr>

<tr>
 <td>changeset 26469</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">dfea600bd2b2d9f79ebc066b88927c5c6cdc4599</a></td>
</tr>



<tr>
<td>parent 26468</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fb9349e31a408f2003984e170190228ffc2b5456">fb9349e31a408f2003984e170190228ffc2b5456</a>
</td>
</tr>

<tr>
<td>child 26470</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2ff21f9b620670f3222763b4f276525f7bff9550">2ff21f9b620670f3222763b4f276525f7bff9550</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">15843</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 26 Apr 2019 22:19:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dfea600bd2b2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&newProject=comm-central&newRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&newProject=comm-central&newRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&newProject=comm-central&newRevision=dfea600bd2b2d9f79ebc066b88927c5c6cdc4599&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697522">697522</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697522">Bug 697522</a> - add logging of message filter runs and actions. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">mail/locales/en-US/chrome/messenger/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mail/locales/en-US/chrome/messenger/filter.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">mailnews/base/search/public/nsIMsgFilterList.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterList.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">mailnews/base/search/public/nsIMsgFilterService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/public/nsIMsgFilterService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">mailnews/base/search/src/nsMsgFilterList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterList.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">mailnews/base/search/src/nsMsgFilterService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/search/src/nsMsgFilterService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">mailnews/base/util/nsMsgUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/base/util/nsMsgUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">suite/locales/en-US/chrome/mailnews/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">file</a> |
<a href="/comm-central/annotate/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">annotate</a> |
<a href="/comm-central/diff/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">diff</a> |
<a href="/comm-central/comparison/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">comparison</a> |
<a href="/comm-central/log/dfea600bd2b2d9f79ebc066b88927c5c6cdc4599/suite/locales/en-US/chrome/mailnews/filter.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -63,16 +63,22 @@ filterCountItems=#1 item; #1 items</span>
<a href="#l1.4"></a><span id="l1.4"> # %1$S=author, %2$S=subject, %3$S=date</span>
<a href="#l1.5"></a><span id="l1.5"> junkLogDetectStr=Detected junk message from %1$S - %2$S at %3$S</span>
<a href="#l1.6"></a><span id="l1.6"> # LOCALIZATION NOTE(logMoveStr)</span>
<a href="#l1.7"></a><span id="l1.7"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l1.8"></a><span id="l1.8"> logMoveStr=moved message id = %1$S to %2$S</span>
<a href="#l1.9"></a><span id="l1.9"> # LOCALIZATION NOTE(logCopyStr)</span>
<a href="#l1.10"></a><span id="l1.10"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l1.11"></a><span id="l1.11"> logCopyStr=copied message id = %1$S to %2$S</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# LOCALIZATION NOTE(filterLogLine):</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+# %1$S=timestamp, %2$S=log message</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+filterLogLine=[%1$S] %2$S</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+# LOCALIZATION NOTE(filterMessage):</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+# %1$S=filter name, %1$S=log message</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+filterMessage=Message from filter &quot;%1$S&quot;: %2$S</span>
<a href="#l1.18"></a><span id="l1.18"> # LOCALIZATION NOTE(filterLogDetectStr)</span>
<a href="#l1.19"></a><span id="l1.19"> # %1$S=filter name %2$S=author, %3$S=subject, %4$S=date</span>
<a href="#l1.20"></a><span id="l1.20"> filterLogDetectStr=Applied filter &quot;%1$S&quot; to message from %2$S - %3$S at %4$S</span>
<a href="#l1.21"></a><span id="l1.21"> filterMissingCustomAction=Missing Custom Action</span>
<a href="#l1.22"></a><span id="l1.22"> filterAction2=priority changed</span>
<a href="#l1.23"></a><span id="l1.23"> filterAction3=deleted</span>
<a href="#l1.24"></a><span id="l1.24"> filterAction4=marked as read</span>
<a href="#l1.25"></a><span id="l1.25"> filterAction5=thread killed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterList.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterList.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -32,16 +32,18 @@ interface nsIMsgFilterList : nsISupports</span>
<a href="#l2.4"></a><span id="l2.4">     const nsMsgFilterFileAttribValue attribDescription = 5;</span>
<a href="#l2.5"></a><span id="l2.5">     const nsMsgFilterFileAttribValue attribType = 6;</span>
<a href="#l2.6"></a><span id="l2.6">     const nsMsgFilterFileAttribValue attribScriptFile = 7;</span>
<a href="#l2.7"></a><span id="l2.7">     const nsMsgFilterFileAttribValue attribAction = 8;</span>
<a href="#l2.8"></a><span id="l2.8">     const nsMsgFilterFileAttribValue attribActionValue = 9;</span>
<a href="#l2.9"></a><span id="l2.9">     const nsMsgFilterFileAttribValue attribCondition = 10;</span>
<a href="#l2.10"></a><span id="l2.10">     const nsMsgFilterFileAttribValue attribCustomId = 11;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    /// Unique text identifier of this filter list.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    readonly attribute ACString listId;</span>
<a href="#l2.14"></a><span id="l2.14">     attribute nsIMsgFolder folder;</span>
<a href="#l2.15"></a><span id="l2.15">     readonly attribute short version;</span>
<a href="#l2.16"></a><span id="l2.16">     readonly attribute ACString arbitraryHeaders;</span>
<a href="#l2.17"></a><span id="l2.17">     readonly attribute boolean shouldDownloadAllHeaders;</span>
<a href="#l2.18"></a><span id="l2.18">     readonly attribute unsigned long filterCount;</span>
<a href="#l2.19"></a><span id="l2.19">     nsIMsgFilter getFilterAt(in unsigned long filterIndex);</span>
<a href="#l2.20"></a><span id="l2.20">     nsIMsgFilter getFilterNamed(in AString filterName);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -86,16 +88,23 @@ interface nsIMsgFilterList : nsISupports</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">     // for filter logging</span>
<a href="#l2.25"></a><span id="l2.25">     // If both attributes are fetched successfully, they guarantee</span>
<a href="#l2.26"></a><span id="l2.26">     // the log file exists and is set up with a header.</span>
<a href="#l2.27"></a><span id="l2.27">     attribute nsIOutputStream logStream;</span>
<a href="#l2.28"></a><span id="l2.28">     readonly attribute ACString logURL;</span>
<a href="#l2.29"></a><span id="l2.29">     void clearLog();</span>
<a href="#l2.30"></a><span id="l2.30">     void flushLogIfNecessary();</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    /**</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+     * Push a message to the filter log file, adding a timestamp.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+     *</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+     * @param message  The message text to log.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+     * @param filter   Optional filter object that reports the message.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+     */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    void logFilterMessage(in AString message, [optional] in nsIMsgFilter filter);</span>
<a href="#l2.38"></a><span id="l2.38"> };</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41"> /* these longs are all actually of type nsMsgFilterMotionValue */</span>
<a href="#l2.42"></a><span id="l2.42"> [scriptable, uuid(d067b528-304e-11d3-a0e1-00a0c900d445)]</span>
<a href="#l2.43"></a><span id="l2.43"> interface nsMsgFilterMotion {</span>
<a href="#l2.44"></a><span id="l2.44">     const long up = 0;</span>
<a href="#l2.45"></a><span id="l2.45">     const long down = 1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -87,9 +87,18 @@ interface nsIMsgFilterService : nsISuppo</span>
<a href="#l3.4"></a><span id="l3.4">      * lookup a custom search term given its id</span>
<a href="#l3.5"></a><span id="l3.5">      *</span>
<a href="#l3.6"></a><span id="l3.6">      * @param  id  unique identifier for a particular custom search term</span>
<a href="#l3.7"></a><span id="l3.7">      *</span>
<a href="#l3.8"></a><span id="l3.8">      * @return     the custom search term, or null if not found</span>
<a href="#l3.9"></a><span id="l3.9">      */</span>
<a href="#l3.10"></a><span id="l3.10">     nsIMsgSearchCustomTerm getCustomTerm(in ACString id);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    /**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+     * Translate the filter type flag into human readable type names.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+     * In case of multiple flag they are delimited by '&amp;'.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+     *</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+     * @param  filterType  nsMsgFilterType flags of filter type</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+     *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+     * @return             A string describing the filter type.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+     */</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    ACString filterTypeName(in nsMsgFilterTypeType filterType);</span>
<a href="#l3.21"></a><span id="l3.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -460,23 +460,16 @@ NS_IMETHODIMP nsMsgFilter::SetScope(nsIM</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> NS_IMETHODIMP nsMsgFilter::GetScope(nsIMsgSearchScopeTerm **aResult)</span>
<a href="#l4.6"></a><span id="l4.6"> {</span>
<a href="#l4.7"></a><span id="l4.7">     NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l4.8"></a><span id="l4.8">     NS_IF_ADDREF(*aResult = m_scope);</span>
<a href="#l4.9"></a><span id="l4.9">     return NS_OK;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define LOG_ENTRY_START_TAG &quot;&lt;p&gt;\n&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#define LOG_ENTRY_START_TAG_LEN (strlen(LOG_ENTRY_START_TAG))</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-#define LOG_ENTRY_END_TAG &quot;&lt;/p&gt;\n&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-#define LOG_ENTRY_END_TAG_LEN (strlen(LOG_ENTRY_END_TAG))</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-// Does this need to be localizable?</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-#define LOG_ENTRY_TIMESTAMP &quot;[$S] &quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-</span>
<a href="#l4.19"></a><span id="l4.19"> // This function handles the logging both for success of filtering</span>
<a href="#l4.20"></a><span id="l4.20"> // (NS_SUCCEEDED(aRcode)), and for error reporting (NS_FAILED(aRcode)</span>
<a href="#l4.21"></a><span id="l4.21"> // when the filter action (such as file move/copy) failed.</span>
<a href="#l4.22"></a><span id="l4.22"> //</span>
<a href="#l4.23"></a><span id="l4.23"> // @param aRcode  NS_OK for successful filtering</span>
<a href="#l4.24"></a><span id="l4.24"> //                operation, otherwise, an error code for filtering failure.</span>
<a href="#l4.25"></a><span id="l4.25"> // @param aErrmsg Not used for success case (ignored), and a non-null</span>
<a href="#l4.26"></a><span id="l4.26"> //                error message for failure case.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -501,19 +494,16 @@ nsMsgFilter::LogRuleHitGeneric(nsIMsgRul</span>
<a href="#l4.28"></a><span id="l4.28">                                nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l4.29"></a><span id="l4.29">                                nsresult aRcode,</span>
<a href="#l4.30"></a><span id="l4.30">                                const nsACString &amp;aErrmsg)</span>
<a href="#l4.31"></a><span id="l4.31"> {</span>
<a href="#l4.32"></a><span id="l4.32">     NS_ENSURE_ARG_POINTER(aFilterAction);</span>
<a href="#l4.33"></a><span id="l4.33">     NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">     NS_ENSURE_TRUE(m_filterList, NS_OK);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-    nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    nsresult rv = m_filterList-&gt;GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">     PRTime date;</span>
<a href="#l4.41"></a><span id="l4.41">     nsMsgRuleActionType actionType;</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">     nsString authorValue;</span>
<a href="#l4.44"></a><span id="l4.44">     nsString subjectValue;</span>
<a href="#l4.45"></a><span id="l4.45">     nsString filterName;</span>
<a href="#l4.46"></a><span id="l4.46">     nsString dateValue;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineat">@@ -527,27 +517,27 @@ nsMsgFilter::LogRuleHitGeneric(nsIMsgRul</span>
<a href="#l4.48"></a><span id="l4.48">     mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l4.49"></a><span id="l4.49">                                                   mozilla::kTimeFormatSeconds,</span>
<a href="#l4.50"></a><span id="l4.50">                                                   &amp;exploded,</span>
<a href="#l4.51"></a><span id="l4.51">                                                   dateValue);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">     (void)aMsgHdr-&gt;GetMime2DecodedAuthor(authorValue);</span>
<a href="#l4.54"></a><span id="l4.54">     (void)aMsgHdr-&gt;GetMime2DecodedSubject(subjectValue);</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    nsCString buffer;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    nsString buffer;</span>
<a href="#l4.58"></a><span id="l4.58">     // this is big enough to hold a log entry.</span>
<a href="#l4.59"></a><span id="l4.59">     // do this so we avoid growing and copying as we append to the log.</span>
<a href="#l4.60"></a><span id="l4.60">     buffer.SetCapacity(512);</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l4.63"></a><span id="l4.63">       mozilla::services::GetStringBundleService();</span>
<a href="#l4.64"></a><span id="l4.64">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    nsresult rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l4.69"></a><span id="l4.69">       getter_AddRefs(bundle));</span>
<a href="#l4.70"></a><span id="l4.70">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">     // If error, prefix with the error code and error message.</span>
<a href="#l4.73"></a><span id="l4.73">     // A desired wording (without NEWLINEs):</span>
<a href="#l4.74"></a><span id="l4.74">     // Filter Action Failed &quot;Move failed&quot; with error code=0x80004005</span>
<a href="#l4.75"></a><span id="l4.75">     // while attempting: Applied filter &quot;test&quot; to message from</span>
<a href="#l4.76"></a><span id="l4.76">     // Some Test &lt;test@example.com&gt; - send test 3 at 2/13/2015 11:32:53 AM</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineat">@@ -575,30 +565,30 @@ nsMsgFilter::LogRuleHitGeneric(nsIMsgRul</span>
<a href="#l4.78"></a><span id="l4.78">       const char16_t *logErrorFormatStrings[2] = { tErrmsg.get(), tcode16.get() };</span>
<a href="#l4.79"></a><span id="l4.79"> </span>
<a href="#l4.80"></a><span id="l4.80">       nsString filterFailureWarningPrefix;</span>
<a href="#l4.81"></a><span id="l4.81">       rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l4.82"></a><span id="l4.82">                       &quot;filterFailureWarningPrefix&quot;,</span>
<a href="#l4.83"></a><span id="l4.83">                       logErrorFormatStrings, 2,</span>
<a href="#l4.84"></a><span id="l4.84">                       filterFailureWarningPrefix);</span>
<a href="#l4.85"></a><span id="l4.85">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-      buffer += NS_ConvertUTF16toUTF8(filterFailureWarningPrefix);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-      buffer += &quot;\n&quot;;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+      buffer += filterFailureWarningPrefix;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l4.90"></a><span id="l4.90">     }</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">     const char16_t *filterLogDetectFormatStrings[4] = { filterName.get(), authorValue.get(), subjectValue.get(), dateValue.get() };</span>
<a href="#l4.93"></a><span id="l4.93">     nsString filterLogDetectStr;</span>
<a href="#l4.94"></a><span id="l4.94">     rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l4.95"></a><span id="l4.95">       &quot;filterLogDetectStr&quot;,</span>
<a href="#l4.96"></a><span id="l4.96">       filterLogDetectFormatStrings, 4,</span>
<a href="#l4.97"></a><span id="l4.97">       filterLogDetectStr);</span>
<a href="#l4.98"></a><span id="l4.98">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    buffer += NS_ConvertUTF16toUTF8(filterLogDetectStr);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-    buffer +=  &quot;\n&quot;;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    buffer += filterLogDetectStr;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+    buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">     if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l4.106"></a><span id="l4.106">         actionType == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l4.107"></a><span id="l4.107">     {</span>
<a href="#l4.108"></a><span id="l4.108">       nsCString actionFolderUri;</span>
<a href="#l4.109"></a><span id="l4.109">       aFilterAction-&gt;GetTargetFolderUri(actionFolderUri);</span>
<a href="#l4.110"></a><span id="l4.110">       NS_ConvertASCIItoUTF16 actionFolderUriValue(actionFolderUri);</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineat">@@ -610,82 +600,45 @@ nsMsgFilter::LogRuleHitGeneric(nsIMsgRul</span>
<a href="#l4.113"></a><span id="l4.113">       nsString logMoveStr;</span>
<a href="#l4.114"></a><span id="l4.114">       rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l4.115"></a><span id="l4.115">         (actionType == nsMsgFilterAction::MoveToFolder) ?</span>
<a href="#l4.116"></a><span id="l4.116">           &quot;logMoveStr&quot; : &quot;logCopyStr&quot;,</span>
<a href="#l4.117"></a><span id="l4.117">         logMoveFormatStrings, 2,</span>
<a href="#l4.118"></a><span id="l4.118">         logMoveStr);</span>
<a href="#l4.119"></a><span id="l4.119">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-      buffer += NS_ConvertUTF16toUTF8(logMoveStr);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+      buffer += logMoveStr;</span>
<a href="#l4.123"></a><span id="l4.123">     }</span>
<a href="#l4.124"></a><span id="l4.124">     else if (actionType == nsMsgFilterAction::Custom)</span>
<a href="#l4.125"></a><span id="l4.125">     {</span>
<a href="#l4.126"></a><span id="l4.126">       nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l4.127"></a><span id="l4.127">       nsAutoString filterActionName;</span>
<a href="#l4.128"></a><span id="l4.128">       rv = aFilterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l4.129"></a><span id="l4.129">       if (NS_SUCCEEDED(rv) &amp;&amp; customAction)</span>
<a href="#l4.130"></a><span id="l4.130">         customAction-&gt;GetName(filterActionName);</span>
<a href="#l4.131"></a><span id="l4.131">       if (filterActionName.IsEmpty())</span>
<a href="#l4.132"></a><span id="l4.132">         bundle-&gt;GetStringFromName(</span>
<a href="#l4.133"></a><span id="l4.133">                   &quot;filterMissingCustomAction&quot;,</span>
<a href="#l4.134"></a><span id="l4.134">                   filterActionName);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-      buffer += NS_ConvertUTF16toUTF8(filterActionName);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+      buffer += filterActionName;</span>
<a href="#l4.137"></a><span id="l4.137">     }</span>
<a href="#l4.138"></a><span id="l4.138">     else</span>
<a href="#l4.139"></a><span id="l4.139">     {</span>
<a href="#l4.140"></a><span id="l4.140">       nsString actionValue;</span>
<a href="#l4.141"></a><span id="l4.141">       nsAutoCString filterActionID;</span>
<a href="#l4.142"></a><span id="l4.142">       filterActionID = NS_LITERAL_CSTRING(&quot;filterAction&quot;);</span>
<a href="#l4.143"></a><span id="l4.143">       filterActionID.AppendInt(actionType);</span>
<a href="#l4.144"></a><span id="l4.144">       rv = bundle-&gt;GetStringFromName(filterActionID.get(), actionValue);</span>
<a href="#l4.145"></a><span id="l4.145">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-      buffer += NS_ConvertUTF16toUTF8(actionValue);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+      buffer += actionValue;</span>
<a href="#l4.149"></a><span id="l4.149">     }</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-    buffer += &quot;\n&quot;;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-    // Prepare timestamp</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-    PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-                                                  mozilla::kTimeFormatSeconds,</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-                                                  &amp;exploded,</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-                                                  dateValue);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-    nsCString timestampString(LOG_ENTRY_TIMESTAMP);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-    MsgReplaceSubstring(timestampString, &quot;$S&quot;, NS_ConvertUTF16toUTF8(dateValue).get());</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-    // XXX: Finally, here we have enough context and buffer</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-    // (string) to display the filtering error if we want: for</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-    // example, a sticky error message in status bar, etc.</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-    uint32_t writeCount;</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN, &amp;writeCount);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN, &quot;failed to write out start log tag&quot;);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    rv = logStream-&gt;Write(timestampString.get(), timestampString.Length(), &amp;writeCount);</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    NS_ASSERTION(writeCount == timestampString.Length(), &quot;failed to write out timestamp&quot;);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-    // HTML-escape the log for security reasons.</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-    // We don't want someone to send us a message with a subject with</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-    // HTML tags, especially &lt;script&gt;.</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    nsCString escapedBuffer;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-    nsAppendEscapedHTML(buffer, escapedBuffer);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-    uint32_t escapedBufferLen = escapedBuffer.Length();</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-    rv = logStream-&gt;Write(escapedBuffer.get(), escapedBufferLen, &amp;writeCount);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-    NS_ASSERTION(writeCount == escapedBufferLen, &quot;failed to write out log hit&quot;);</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-    rv = logStream-&gt;Write(LOG_ENTRY_END_TAG, LOG_ENTRY_END_TAG_LEN, &amp;writeCount);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-    NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN, &quot;failed to write out end log tag&quot;);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    m_filterList-&gt;LogFilterMessage(buffer, nullptr);</span>
<a href="#l4.192"></a><span id="l4.192">     return NS_OK;</span>
<a href="#l4.193"></a><span id="l4.193"> }</span>
<a href="#l4.194"></a><span id="l4.194"> </span>
<a href="#l4.195"></a><span id="l4.195"> NS_IMETHODIMP nsMsgFilter::LogRuleHit(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l4.196"></a><span id="l4.196">                                       nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l4.197"></a><span id="l4.197"> {</span>
<a href="#l4.198"></a><span id="l4.198">   return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, NS_OK, EmptyCString());</span>
<a href="#l4.199"></a><span id="l4.199"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5,41 +5,53 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> // this file implements the nsMsgFilterList interface</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsMsgFilterList.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsMsgFilter.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;nsIMsgFilterHitNotify.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsMsgSearchTerm.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsString.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> #include &quot;nsMsgSearchScopeTerm.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l5.23"></a><span id="l5.23"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsMemory.h&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> #include &quot;prmem.h&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l5.28"></a><span id="l5.28"> #include &lt;ctype.h&gt;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30"> // Marker for EOF or failure during read</span>
<a href="#l5.31"></a><span id="l5.31"> #define EOF_CHAR -1</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+using namespace mozilla;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+static uint32_t nextListId = 0;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39"> nsMsgFilterList::nsMsgFilterList() :</span>
<a href="#l5.40"></a><span id="l5.40">     m_fileVersion(0)</span>
<a href="#l5.41"></a><span id="l5.41"> {</span>
<a href="#l5.42"></a><span id="l5.42">   m_loggingEnabled = false;</span>
<a href="#l5.43"></a><span id="l5.43">   m_startWritingToBuffer = false;</span>
<a href="#l5.44"></a><span id="l5.44">   m_temporaryList = false;</span>
<a href="#l5.45"></a><span id="l5.45">   m_curFilter = nullptr;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  m_listId.Assign(&quot;List&quot;);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  m_listId.AppendInt(nextListId++);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Creating a new filter list with id=%s&quot;, m_listId.get()));</span>
<a href="#l5.49"></a><span id="l5.49"> }</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51"> NS_IMPL_ADDREF(nsMsgFilterList)</span>
<a href="#l5.52"></a><span id="l5.52"> NS_IMPL_RELEASE(nsMsgFilterList)</span>
<a href="#l5.53"></a><span id="l5.53"> NS_IMPL_QUERY_INTERFACE(nsMsgFilterList, nsIMsgFilterList)</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55"> NS_IMETHODIMP nsMsgFilterList::CreateFilter(const nsAString &amp;name,class nsIMsgFilter **aFilter)</span>
<a href="#l5.56"></a><span id="l5.56"> {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineat">@@ -50,16 +62,22 @@ NS_IMETHODIMP nsMsgFilterList::CreateFil</span>
<a href="#l5.58"></a><span id="l5.58">   (*aFilter)-&gt;SetFilterName(name);</span>
<a href="#l5.59"></a><span id="l5.59">   (*aFilter)-&gt;SetFilterList(this);</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">   return NS_OK;</span>
<a href="#l5.62"></a><span id="l5.62"> }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> NS_IMPL_GETSET(nsMsgFilterList, LoggingEnabled, bool, m_loggingEnabled)</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::GetListId(nsACString &amp;aListId)</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+{</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  aListId.Assign(m_listId);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+}</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+</span>
<a href="#l5.72"></a><span id="l5.72"> NS_IMETHODIMP nsMsgFilterList::GetFolder(nsIMsgFolder **aFolder)</span>
<a href="#l5.73"></a><span id="l5.73"> {</span>
<a href="#l5.74"></a><span id="l5.74">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l5.77"></a><span id="l5.77">   return NS_OK;</span>
<a href="#l5.78"></a><span id="l5.78"> }</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80" class="difflineat">@@ -265,55 +283,100 @@ NS_IMETHODIMP</span>
<a href="#l5.81"></a><span id="l5.81"> nsMsgFilterList::ApplyFiltersToHdr(nsMsgFilterTypeType filterType,</span>
<a href="#l5.82"></a><span id="l5.82">                                    nsIMsgDBHdr *msgHdr,</span>
<a href="#l5.83"></a><span id="l5.83">                                    nsIMsgFolder *folder,</span>
<a href="#l5.84"></a><span id="l5.84">                                    nsIMsgDatabase *db,</span>
<a href="#l5.85"></a><span id="l5.85">                                    const nsACString&amp; headers,</span>
<a href="#l5.86"></a><span id="l5.86">                                    nsIMsgFilterHitNotify *listener,</span>
<a href="#l5.87"></a><span id="l5.87">                                    nsIMsgWindow *msgWindow)</span>
<a href="#l5.88"></a><span id="l5.88"> {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) nsMsgFilterList::ApplyFiltersToHdr&quot;));</span>
<a href="#l5.90"></a><span id="l5.90">   nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l5.91"></a><span id="l5.91">   uint32_t filterCount = 0;</span>
<a href="#l5.92"></a><span id="l5.92">   nsresult rv = GetFilterCount(&amp;filterCount);</span>
<a href="#l5.93"></a><span id="l5.93">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95">   RefPtr&lt;nsMsgSearchScopeTerm&gt; scope =</span>
<a href="#l5.96"></a><span id="l5.96">     new nsMsgSearchScopeTerm(nullptr, nsMsgSearchScope::offlineMail, folder);</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  nsString folderName;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  folder-&gt;GetName(folderName);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  nsCString typeName;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  filterService-&gt;FilterTypeName(filterType, typeName);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(), filterType));</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Running %&quot; PRIu32 &quot; filters from %s on message with key %&quot; PRIu32 &quot; in folder '%s'&quot;,</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+                                            filterCount, m_listId.get(), msgKeyToInt(msgKey), NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+</span>
<a href="#l5.110"></a><span id="l5.110">   for (uint32_t filterIndex = 0; filterIndex &lt; filterCount; filterIndex++)</span>
<a href="#l5.111"></a><span id="l5.111">   {</span>
<a href="#l5.112"></a><span id="l5.112">     if (NS_SUCCEEDED(GetFilterAt(filterIndex, getter_AddRefs(filter))))</span>
<a href="#l5.113"></a><span id="l5.113">     {</span>
<a href="#l5.114"></a><span id="l5.114">       bool isEnabled;</span>
<a href="#l5.115"></a><span id="l5.115">       nsMsgFilterTypeType curFilterType;</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">       filter-&gt;GetEnabled(&amp;isEnabled);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-      if (!isEnabled)</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+      if (!isEnabled) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Skipping disabled filter at index %&quot; PRIu32, filterIndex));</span>
<a href="#l5.121"></a><span id="l5.121">         continue;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+      }</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      nsString filterName;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+      filter-&gt;GetFilterName(filterName);</span>
<a href="#l5.126"></a><span id="l5.126">       filter-&gt;GetFilterType(&amp;curFilterType);</span>
<a href="#l5.127"></a><span id="l5.127">       if (curFilterType &amp; filterType)</span>
<a href="#l5.128"></a><span id="l5.128">       {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Running filter %&quot; PRIu32, filterIndex));</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) Filter name: %s&quot;,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+                                                   NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+</span>
<a href="#l5.133"></a><span id="l5.133">         nsresult matchTermStatus = NS_OK;</span>
<a href="#l5.134"></a><span id="l5.134">         bool result;</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">         filter-&gt;SetScope(scope);</span>
<a href="#l5.137"></a><span id="l5.137">         matchTermStatus = filter-&gt;MatchHdr(msgHdr, folder, db, headers, &amp;result);</span>
<a href="#l5.138"></a><span id="l5.138">         filter-&gt;SetScope(nullptr);</span>
<a href="#l5.139"></a><span id="l5.139">         if (NS_SUCCEEDED(matchTermStatus) &amp;&amp; result &amp;&amp; listener)</span>
<a href="#l5.140"></a><span id="l5.140">         {</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+          nsCString msgId;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+          msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter matched message with key %&quot; PRIu32,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+                                                    msgKeyToInt(msgKey)));</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Auto) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+</span>
<a href="#l5.147"></a><span id="l5.147">           bool applyMore = true;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-</span>
<a href="#l5.149"></a><span id="l5.149">           rv = listener-&gt;ApplyFilterHit(filter, msgWindow, &amp;applyMore);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-          if (NS_FAILED(rv) || !applyMore)</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+          if (NS_FAILED(rv) || !applyMore) {</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+              LogFilterMessage(NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+            }</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Stopping further filter execution on this message&quot;));</span>
<a href="#l5.157"></a><span id="l5.157">             break;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+          }</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+        } else {</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+          if (NS_FAILED(matchTermStatus)) {</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Filter evaluation failed&quot;));</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+            LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;), filter);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+          }</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+          if (!result)</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Filter didn't match&quot;));</span>
<a href="#l5.166"></a><span id="l5.166">         }</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+      } else {</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Auto) Skipping filter of non-matching type at index %&quot; PRIu32, filterIndex));</span>
<a href="#l5.169"></a><span id="l5.169">       }</span>
<a href="#l5.170"></a><span id="l5.170">     }</span>
<a href="#l5.171"></a><span id="l5.171">   }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+    LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), nullptr);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+  }</span>
<a href="#l5.176"></a><span id="l5.176">   return rv;</span>
<a href="#l5.177"></a><span id="l5.177"> }</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179"> NS_IMETHODIMP</span>
<a href="#l5.180"></a><span id="l5.180"> nsMsgFilterList::SetDefaultFile(nsIFile *aFile)</span>
<a href="#l5.181"></a><span id="l5.181"> {</span>
<a href="#l5.182"></a><span id="l5.182">   m_defaultFile = aFile;</span>
<a href="#l5.183"></a><span id="l5.183">   return NS_OK;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineat">@@ -874,16 +937,17 @@ nsresult nsMsgFilterList::SaveTextFilter</span>
<a href="#l5.185"></a><span id="l5.185">   }</span>
<a href="#l5.186"></a><span id="l5.186">   if (NS_SUCCEEDED(err))</span>
<a href="#l5.187"></a><span id="l5.187">     m_arbitraryHeaders.Truncate();</span>
<a href="#l5.188"></a><span id="l5.188">   return err;</span>
<a href="#l5.189"></a><span id="l5.189"> }</span>
<a href="#l5.190"></a><span id="l5.190"> </span>
<a href="#l5.191"></a><span id="l5.191"> nsMsgFilterList::~nsMsgFilterList()</span>
<a href="#l5.192"></a><span id="l5.192"> {</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Closing filter list %s&quot;, m_listId.get()));</span>
<a href="#l5.194"></a><span id="l5.194"> }</span>
<a href="#l5.195"></a><span id="l5.195"> </span>
<a href="#l5.196"></a><span id="l5.196"> nsresult nsMsgFilterList::Close()</span>
<a href="#l5.197"></a><span id="l5.197"> {</span>
<a href="#l5.198"></a><span id="l5.198">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.199"></a><span id="l5.199"> }</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201"> nsresult nsMsgFilterList::GetFilterCount(uint32_t *pCount)</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineat">@@ -1163,9 +1227,89 @@ NS_IMETHODIMP nsMsgFilterList::FlushLogI</span>
<a href="#l5.203"></a><span id="l5.203">     rv = GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l5.204"></a><span id="l5.204">     if (NS_SUCCEEDED(rv) &amp;&amp; logStream) {</span>
<a href="#l5.205"></a><span id="l5.205">       rv = logStream-&gt;Flush();</span>
<a href="#l5.206"></a><span id="l5.206">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.207"></a><span id="l5.207">     }</span>
<a href="#l5.208"></a><span id="l5.208">   }</span>
<a href="#l5.209"></a><span id="l5.209">   return rv;</span>
<a href="#l5.210"></a><span id="l5.210"> }</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+#define LOG_ENTRY_START_TAG &quot;&lt;p&gt;\n&quot;</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+#define LOG_ENTRY_START_TAG_LEN (strlen(LOG_ENTRY_START_TAG))</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+#define LOG_ENTRY_END_TAG &quot;&lt;/p&gt;\n&quot;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+#define LOG_ENTRY_END_TAG_LEN (strlen(LOG_ENTRY_END_TAG))</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+NS_IMETHODIMP nsMsgFilterList::LogFilterMessage(const nsAString &amp;message, nsIMsgFilter *filter)</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+{</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+  nsCOMPtr &lt;nsIOutputStream&gt; logStream;</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  nsresult rv = GetLogStream(getter_AddRefs(logStream));</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+    mozilla::services::GetStringBundleService();</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/filter.properties&quot;,</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+    getter_AddRefs(bundle));</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  nsString tempMessage(message);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+  if (filter) {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+    // If a filter was passed, prepend its name in the log message.</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+    nsString filterName;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+    filter-&gt;GetFilterName(filterName);</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+    const char16_t *logFormatStrings[2] = { filterName.get(),</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+                                            tempMessage.get() };</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    nsString statusLogMessage;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;filterMessage&quot;,</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+                                      logFormatStrings, 2,</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+                                      statusLogMessage);</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+      tempMessage.Assign(statusLogMessage);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  }</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+  // Prepare timestamp</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+  PRExplodedTime exploded;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  nsString dateValue;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+  PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+  mozilla::DateTimeFormat::FormatPRExplodedTime(mozilla::kDateFormatShort,</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+                                                mozilla::kTimeFormatSeconds,</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+                                                &amp;exploded,</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+                                                dateValue);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+  // HTML-escape the log for security reasons.</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+  // We don't want someone to send us a message with a subject with</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+  // HTML tags, especially &lt;script&gt;.</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  nsCString escapedBuffer;</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+  nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(tempMessage), escapedBuffer);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+  NS_ConvertUTF8toUTF16 finalMessage(escapedBuffer);</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+  // Print timestamp and the message.</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  const char16_t *logFormatStrings[2] = { dateValue.get(),</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+                                          finalMessage.get() };</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+  nsString filterLogMessage;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+  rv = bundle-&gt;FormatStringFromName(&quot;filterLogLine&quot;,</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+                                    logFormatStrings, 2,</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+                                    filterLogMessage);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+  // Write message into log stream.</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+  uint32_t writeCount;</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+  rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN, &amp;writeCount);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN, &quot;failed to write out start log tag&quot;);</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+  NS_ConvertUTF16toUTF8 buffer(filterLogMessage);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  uint32_t escapedBufferLen = buffer.Length();</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  rv = logStream-&gt;Write(buffer.get(), escapedBufferLen, &amp;writeCount);</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  NS_ASSERTION(writeCount == escapedBufferLen, &quot;failed to write out log hit&quot;);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+  rv = logStream-&gt;Write(LOG_ENTRY_END_TAG, LOG_ENTRY_END_TAG_LEN, &amp;writeCount);</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  NS_ASSERTION(writeCount == LOG_ENTRY_END_TAG_LEN, &quot;failed to write out end log tag&quot;);</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+}</span>
<a href="#l5.291"></a><span id="l5.291"> // ------------ End FilterList methods ------------------</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -54,17 +54,17 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   int LoadAttrib(nsMsgFilterFileAttribValue &amp;attrib, nsIInputStream *aStream);</span>
<a href="#l6.5"></a><span id="l6.5">   const char *GetStringForAttrib(nsMsgFilterFileAttribValue attrib);</span>
<a href="#l6.6"></a><span id="l6.6">   nsresult LoadValue(nsCString &amp;value, nsIInputStream *aStream);</span>
<a href="#l6.7"></a><span id="l6.7">   int16_t m_fileVersion;</span>
<a href="#l6.8"></a><span id="l6.8">   bool m_loggingEnabled;</span>
<a href="#l6.9"></a><span id="l6.9">   bool m_startWritingToBuffer; //tells us when to start writing one whole filter to m_unparsedBuffer</span>
<a href="#l6.10"></a><span id="l6.10">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l6.11"></a><span id="l6.11">   nsMsgFilter *m_curFilter; // filter we're filing in or out(?)</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsCString m_filterFileName;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsCString m_listId;</span>
<a href="#l6.14"></a><span id="l6.14">   nsTArray&lt;nsCOMPtr&lt;nsIMsgFilter&gt; &gt; m_filters;</span>
<a href="#l6.15"></a><span id="l6.15">   nsCString m_arbitraryHeaders;</span>
<a href="#l6.16"></a><span id="l6.16">   nsCOMPtr&lt;nsIFile&gt; m_defaultFile;</span>
<a href="#l6.17"></a><span id="l6.17">   nsCString m_unparsedFilterBuffer; //holds one entire filter unparsed</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> private:</span>
<a href="#l6.20"></a><span id="l6.20">   nsresult TruncateLog();</span>
<a href="#l6.21"></a><span id="l6.21">   nsresult GetLogFile(nsIFile **aFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -28,76 +28,104 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24"> #include &quot;nsIMsgOperationListener.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+using namespace mozilla;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+LazyLogModule FILTERLOGMODULE(&quot;Filters&quot;);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32"> #define BREAK_IF_FAILURE(_rv, _text) if (NS_FAILED(_rv)) { \</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter error: %s&quot;, _text)); \</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l7.35"></a><span id="l7.35">   NS_WARNING(_text); \</span>
<a href="#l7.36"></a><span id="l7.36">   mFinalResult = _rv; \</span>
<a href="#l7.37"></a><span id="l7.37">   break; \</span>
<a href="#l7.38"></a><span id="l7.38"> }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40"> #define CONTINUE_IF_FAILURE(_rv, _text) if (NS_FAILED(_rv)) { \</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning, (&quot;(Post) Filter problem: %s&quot;, _text)); \</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l7.43"></a><span id="l7.43">   NS_WARNING(_text); \</span>
<a href="#l7.44"></a><span id="l7.44">   mFinalResult = _rv; \</span>
<a href="#l7.45"></a><span id="l7.45">   if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) \</span>
<a href="#l7.46"></a><span id="l7.46">     return OnEndExecution(); \</span>
<a href="#l7.47"></a><span id="l7.47">   continue; \</span>
<a href="#l7.48"></a><span id="l7.48"> }</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50"> #define BREAK_IF_FALSE(_assertTrue, _text) if (!(_assertTrue)) { \</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter error: %s&quot;, _text)); \</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l7.53"></a><span id="l7.53">   NS_WARNING(_text); \</span>
<a href="#l7.54"></a><span id="l7.54">   mFinalResult = NS_ERROR_FAILURE; \</span>
<a href="#l7.55"></a><span id="l7.55">   break; \</span>
<a href="#l7.56"></a><span id="l7.56"> }</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58"> #define CONTINUE_IF_FALSE(_assertTrue, _text) if (!(_assertTrue)) { \</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning, (&quot;(Post) Filter problem: %s&quot;, _text)); \</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l7.61"></a><span id="l7.61">   NS_WARNING(_text); \</span>
<a href="#l7.62"></a><span id="l7.62">   mFinalResult = NS_ERROR_FAILURE; \</span>
<a href="#l7.63"></a><span id="l7.63">   if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) \</span>
<a href="#l7.64"></a><span id="l7.64">     return OnEndExecution(); \</span>
<a href="#l7.65"></a><span id="l7.65">   continue; \</span>
<a href="#l7.66"></a><span id="l7.66"> }</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68"> NS_IMPL_ISUPPORTS(nsMsgFilterService, nsIMsgFilterService)</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70"> nsMsgFilterService::nsMsgFilterService()</span>
<a href="#l7.71"></a><span id="l7.71"> {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;nsMsgFilterService&quot;));</span>
<a href="#l7.73"></a><span id="l7.73"> }</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75"> nsMsgFilterService::~nsMsgFilterService()</span>
<a href="#l7.76"></a><span id="l7.76"> {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;~nsMsgFilterService&quot;));</span>
<a href="#l7.78"></a><span id="l7.78"> }</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80"> NS_IMETHODIMP nsMsgFilterService::OpenFilterList(nsIFile *aFilterFile,</span>
<a href="#l7.81"></a><span id="l7.81">                                                  nsIMsgFolder *rootFolder,</span>
<a href="#l7.82"></a><span id="l7.82">                                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.83"></a><span id="l7.83">                                                  nsIMsgFilterList **resultFilterList)</span>
<a href="#l7.84"></a><span id="l7.84"> {</span>
<a href="#l7.85"></a><span id="l7.85">   NS_ENSURE_ARG_POINTER(aFilterFile);</span>
<a href="#l7.86"></a><span id="l7.86">   NS_ENSURE_ARG_POINTER(resultFilterList);</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  if (rootFolder) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    nsString serverName;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    server-&gt;GetPrettyName(serverName);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Reading filter list for account '%s'&quot;, NS_ConvertUTF16toUTF8(serverName).get()));</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  nsString fileName;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  (void)aFilterFile-&gt;GetPath(fileName);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;Reading filter list from file '%s'&quot;, NS_ConvertUTF16toUTF8(fileName).get()));</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100">   bool exists = false;</span>
<a href="#l7.101"></a><span id="l7.101">   nsresult rv = aFilterFile-&gt;Exists(&amp;exists);</span>
<a href="#l7.102"></a><span id="l7.102">   if (NS_FAILED(rv) || !exists)</span>
<a href="#l7.103"></a><span id="l7.103">   {</span>
<a href="#l7.104"></a><span id="l7.104">     rv = aFilterFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0644);</span>
<a href="#l7.105"></a><span id="l7.105">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.106"></a><span id="l7.106">   }</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108" class="difflineat">@@ -134,45 +162,57 @@ NS_IMETHODIMP nsMsgFilterService::OpenFi</span>
<a href="#l7.109"></a><span id="l7.109">       return OpenFilterList(aFilterFile, rootFolder, aMsgWindow, resultFilterList);</span>
<a href="#l7.110"></a><span id="l7.110">     }</span>
<a href="#l7.111"></a><span id="l7.111">     else if (rv == NS_MSG_CUSTOM_HEADERS_OVERFLOW &amp;&amp; aMsgWindow)</span>
<a href="#l7.112"></a><span id="l7.112">       ThrowAlertMsg(&quot;filterCustomHeaderOverflow&quot;, aMsgWindow);</span>
<a href="#l7.113"></a><span id="l7.113">     else if (rv == NS_MSG_INVALID_CUSTOM_HEADER &amp;&amp; aMsgWindow)</span>
<a href="#l7.114"></a><span id="l7.114">       ThrowAlertMsg(&quot;invalidCustomHeader&quot;, aMsgWindow);</span>
<a href="#l7.115"></a><span id="l7.115">   }</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  nsCString listId;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  filterList-&gt;GetListId(listId);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+  uint32_t filterCount = 0;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  (void)filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Read %&quot; PRIu32 &quot; filters&quot;, filterCount));</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Filter list stored as %s&quot;, listId.get()));</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+</span>
<a href="#l7.124"></a><span id="l7.124">   filterList.forget(resultFilterList);</span>
<a href="#l7.125"></a><span id="l7.125">   return rv;</span>
<a href="#l7.126"></a><span id="l7.126"> }</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128"> NS_IMETHODIMP nsMsgFilterService::CloseFilterList(nsIMsgFilterList *filterList)</span>
<a href="#l7.129"></a><span id="l7.129"> {</span>
<a href="#l7.130"></a><span id="l7.130">   //NS_ASSERTION(false,&quot;CloseFilterList doesn't do anything yet&quot;);</span>
<a href="#l7.131"></a><span id="l7.131">   return NS_OK;</span>
<a href="#l7.132"></a><span id="l7.132"> }</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134"> /* save without deleting */</span>
<a href="#l7.135"></a><span id="l7.135"> NS_IMETHODIMP  nsMsgFilterService::SaveFilterList(nsIMsgFilterList *filterList, nsIFile *filterFile)</span>
<a href="#l7.136"></a><span id="l7.136"> {</span>
<a href="#l7.137"></a><span id="l7.137">   NS_ENSURE_ARG_POINTER(filterFile);</span>
<a href="#l7.138"></a><span id="l7.138">   NS_ENSURE_ARG_POINTER(filterList);</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  nsCString listId;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  filterList-&gt;GetListId(listId);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Saving filter list %s&quot;, listId.get()));</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+</span>
<a href="#l7.144"></a><span id="l7.144">   nsCOMPtr&lt;nsIOutputStream&gt; strm;</span>
<a href="#l7.145"></a><span id="l7.145">   nsresult rv = MsgNewSafeBufferedFileOutputStream(getter_AddRefs(strm),</span>
<a href="#l7.146"></a><span id="l7.146">                                                 filterFile, -1, 0600);</span>
<a href="#l7.147"></a><span id="l7.147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149">   rv = filterList-&gt;SaveToFile(strm);</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151">   nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(strm);</span>
<a href="#l7.152"></a><span id="l7.152">   NS_ASSERTION(safeStream, &quot;expected a safe output stream!&quot;);</span>
<a href="#l7.153"></a><span id="l7.153">   if (safeStream) {</span>
<a href="#l7.154"></a><span id="l7.154">     rv = safeStream-&gt;Finish();</span>
<a href="#l7.155"></a><span id="l7.155">     if (NS_FAILED(rv)) {</span>
<a href="#l7.156"></a><span id="l7.156">       NS_WARNING(&quot;failed to save filter file! possible data loss&quot;);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;Save of list failed&quot;));</span>
<a href="#l7.158"></a><span id="l7.158">     }</span>
<a href="#l7.159"></a><span id="l7.159">   }</span>
<a href="#l7.160"></a><span id="l7.160">   return rv;</span>
<a href="#l7.161"></a><span id="l7.161"> }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163"> NS_IMETHODIMP nsMsgFilterService::CancelFilterList(nsIMsgFilterList *filterList)</span>
<a href="#l7.164"></a><span id="l7.164"> {</span>
<a href="#l7.165"></a><span id="l7.165">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineat">@@ -318,16 +358,17 @@ protected:</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168"> NS_IMPL_ISUPPORTS(nsMsgFilterAfterTheFact, nsIUrlListener, nsIMsgSearchNotify, nsIMsgCopyServiceListener)</span>
<a href="#l7.169"></a><span id="l7.169"> </span>
<a href="#l7.170"></a><span id="l7.170"> nsMsgFilterAfterTheFact::nsMsgFilterAfterTheFact(nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.171"></a><span id="l7.171">                                                  nsIMsgFilterList *aFilterList,</span>
<a href="#l7.172"></a><span id="l7.172">                                                  nsIArray *aFolderList,</span>
<a href="#l7.173"></a><span id="l7.173">                                                  nsIMsgOperationListener *aCallback)</span>
<a href="#l7.174"></a><span id="l7.174"> {</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l7.176"></a><span id="l7.176">   m_curFilterIndex = m_curFolderIndex = m_nextAction = 0;</span>
<a href="#l7.177"></a><span id="l7.177">   m_msgWindow = aMsgWindow;</span>
<a href="#l7.178"></a><span id="l7.178">   m_filters = aFilterList;</span>
<a href="#l7.179"></a><span id="l7.179">   m_folders = aFolderList;</span>
<a href="#l7.180"></a><span id="l7.180">   m_filters-&gt;GetFilterCount(&amp;m_numFilters);</span>
<a href="#l7.181"></a><span id="l7.181">   m_folders-&gt;GetLength(&amp;m_numFolders);</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">   NS_ADDREF_THIS(); // we own ourselves, and will release ourselves when execution is done.</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineat">@@ -335,16 +376,17 @@ nsMsgFilterAfterTheFact::nsMsgFilterAfte</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">   m_searchHitHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l7.187"></a><span id="l7.187">   m_callback = aCallback;</span>
<a href="#l7.188"></a><span id="l7.188">   mFinalResult = NS_OK;</span>
<a href="#l7.189"></a><span id="l7.189"> }</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191"> nsMsgFilterAfterTheFact::~nsMsgFilterAfterTheFact()</span>
<a href="#l7.192"></a><span id="l7.192"> {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) ~nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l7.194"></a><span id="l7.194"> }</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196"> // do what we have to do to cleanup.</span>
<a href="#l7.197"></a><span id="l7.197"> nsresult nsMsgFilterAfterTheFact::OnEndExecution()</span>
<a href="#l7.198"></a><span id="l7.198"> {</span>
<a href="#l7.199"></a><span id="l7.199">   if (m_searchSession)</span>
<a href="#l7.200"></a><span id="l7.200">     m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l7.201"></a><span id="l7.201"> </span>
<a href="#l7.202"></a><span id="l7.202" class="difflineat">@@ -357,31 +399,41 @@ nsresult nsMsgFilterAfterTheFact::OnEndE</span>
<a href="#l7.203"></a><span id="l7.203">   nsresult rv = mFinalResult;</span>
<a href="#l7.204"></a><span id="l7.204">   // OnEndExecution() can be called a second time when a rule execution fails</span>
<a href="#l7.205"></a><span id="l7.205">   // and the user is prompted whether he wants to continue.</span>
<a href="#l7.206"></a><span id="l7.206">   if (mNeedsRelease)</span>
<a href="#l7.207"></a><span id="l7.207">   {</span>
<a href="#l7.208"></a><span id="l7.208">     NS_RELEASE_THIS(); // release ourselves.</span>
<a href="#l7.209"></a><span id="l7.209">     mNeedsRelease = false;</span>
<a href="#l7.210"></a><span id="l7.210">   }</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) End executing filters&quot;));</span>
<a href="#l7.212"></a><span id="l7.212">   return rv;</span>
<a href="#l7.213"></a><span id="l7.213"> }</span>
<a href="#l7.214"></a><span id="l7.214"> </span>
<a href="#l7.215"></a><span id="l7.215"> nsresult nsMsgFilterAfterTheFact::RunNextFilter()</span>
<a href="#l7.216"></a><span id="l7.216"> {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::RunNextFilter&quot;));</span>
<a href="#l7.218"></a><span id="l7.218">   nsresult rv = NS_OK;</span>
<a href="#l7.219"></a><span id="l7.219">   while (true)</span>
<a href="#l7.220"></a><span id="l7.220">   {</span>
<a href="#l7.221"></a><span id="l7.221">     m_curFilter = nullptr;</span>
<a href="#l7.222"></a><span id="l7.222">     if (m_curFilterIndex &gt;= m_numFilters)</span>
<a href="#l7.223"></a><span id="l7.223">       break;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+</span>
<a href="#l7.225"></a><span id="l7.225">     BREAK_IF_FALSE(m_filters, &quot;Missing filters&quot;);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+</span>
<a href="#l7.229"></a><span id="l7.229">     rv = m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l7.230"></a><span id="l7.230">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter at index&quot;);</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    nsString filterName;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    m_curFilter-&gt;GetFilterName(filterName);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+</span>
<a href="#l7.236"></a><span id="l7.236">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l7.237"></a><span id="l7.237">     rv = m_curFilter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l7.238"></a><span id="l7.238">     CONTINUE_IF_FAILURE(rv, &quot;Could not get searchTerms&quot;);</span>
<a href="#l7.239"></a><span id="l7.239"> </span>
<a href="#l7.240"></a><span id="l7.240">     if (m_searchSession)</span>
<a href="#l7.241"></a><span id="l7.241">       m_searchSession-&gt;UnregisterListener(this);</span>
<a href="#l7.242"></a><span id="l7.242">     m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l7.243"></a><span id="l7.243">     BREAK_IF_FAILURE(rv, &quot;Failed to get search session&quot;);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineat">@@ -402,46 +454,65 @@ nsresult nsMsgFilterAfterTheFact::RunNex</span>
<a href="#l7.245"></a><span id="l7.245"> </span>
<a href="#l7.246"></a><span id="l7.246">     rv = m_searchSession-&gt;AddScopeTerm(searchScope, m_curFolder);</span>
<a href="#l7.247"></a><span id="l7.247">     CONTINUE_IF_FAILURE(rv, &quot;Failed to add scope term&quot;);</span>
<a href="#l7.248"></a><span id="l7.248">     m_nextAction = 0;</span>
<a href="#l7.249"></a><span id="l7.249">     rv = m_searchSession-&gt;Search(m_msgWindow);</span>
<a href="#l7.250"></a><span id="l7.250">     CONTINUE_IF_FAILURE(rv, &quot;Search failed&quot;);</span>
<a href="#l7.251"></a><span id="l7.251">     return NS_OK; // OnSearchDone will continue</span>
<a href="#l7.252"></a><span id="l7.252">   }</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter evaluation failed&quot;));</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;), m_curFilter);</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  }</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+</span>
<a href="#l7.259"></a><span id="l7.259">   m_curFilter = nullptr;</span>
<a href="#l7.260"></a><span id="l7.260">   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;Search failed&quot;);</span>
<a href="#l7.261"></a><span id="l7.261">   return AdvanceToNextFolder();</span>
<a href="#l7.262"></a><span id="l7.262"> }</span>
<a href="#l7.263"></a><span id="l7.263"> </span>
<a href="#l7.264"></a><span id="l7.264"> nsresult nsMsgFilterAfterTheFact::AdvanceToNextFolder()</span>
<a href="#l7.265"></a><span id="l7.265"> {</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::AdvanceToNextFolder&quot;));</span>
<a href="#l7.267"></a><span id="l7.267">   nsresult rv = NS_OK;</span>
<a href="#l7.268"></a><span id="l7.268">   // Advance through folders, making sure m_curFolder is null on errors</span>
<a href="#l7.269"></a><span id="l7.269">   while (true)</span>
<a href="#l7.270"></a><span id="l7.270">   {</span>
<a href="#l7.271"></a><span id="l7.271">     m_stopFiltering.Clear();</span>
<a href="#l7.272"></a><span id="l7.272">     m_curFolder = nullptr;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-    if (m_curFolderIndex &gt;= m_numFolders)</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+    if (m_curFolderIndex &gt;= m_numFolders) {</span>
<a href="#l7.275"></a><span id="l7.275">       // final end of nsMsgFilterAfterTheFact object</span>
<a href="#l7.276"></a><span id="l7.276">       return OnEndExecution();</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+    }</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Entering folder %&quot; PRIu32, m_curFolderIndex));</span>
<a href="#l7.280"></a><span id="l7.280"> </span>
<a href="#l7.281"></a><span id="l7.281">     // reset the filter index to apply all filters to this new folder</span>
<a href="#l7.282"></a><span id="l7.282">     m_curFilterIndex = 0;</span>
<a href="#l7.283"></a><span id="l7.283">     m_nextAction = 0;</span>
<a href="#l7.284"></a><span id="l7.284">     m_curFolder = do_QueryElementAt(m_folders, m_curFolderIndex++, &amp;rv);</span>
<a href="#l7.285"></a><span id="l7.285">     CONTINUE_IF_FAILURE(rv, &quot;Could not get next folder&quot;);</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287">     // Note: I got rv = NS_OK but null m_curFolder after deleting a folder</span>
<a href="#l7.288"></a><span id="l7.288">     // outside of TB, when I select a single message and &quot;run filter on message&quot;</span>
<a href="#l7.289"></a><span id="l7.289">     // and the filter is to move the message to the deleted folder.</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291">      // m_curFolder may be null when the folder is deleted externally.</span>
<a href="#l7.292"></a><span id="l7.292">     CONTINUE_IF_FALSE(m_curFolder, &quot;Next folder returned null&quot;);</span>
<a href="#l7.293"></a><span id="l7.293"> </span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+    nsString folderName;</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+    (void)m_curFolder-&gt;GetName(folderName);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Folder name: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+    (void)m_curFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+    (void)folderPath-&gt;GetPath(folderName);</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Folder path: %s&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+</span>
<a href="#l7.303"></a><span id="l7.303">     rv = m_curFolder-&gt;GetMsgDatabase(getter_AddRefs(m_curFolderDB));</span>
<a href="#l7.304"></a><span id="l7.304">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l7.305"></a><span id="l7.305">     {</span>
<a href="#l7.306"></a><span id="l7.306">       nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_curFolder, &amp;rv);</span>
<a href="#l7.307"></a><span id="l7.307">       if (NS_SUCCEEDED(rv) &amp;&amp; localFolder)</span>
<a href="#l7.308"></a><span id="l7.308">         // will continue with OnStopRunningUrl</span>
<a href="#l7.309"></a><span id="l7.309">         return localFolder-&gt;ParseFolder(m_msgWindow, this);</span>
<a href="#l7.310"></a><span id="l7.310">     }</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineat">@@ -480,29 +551,37 @@ NS_IMETHODIMP nsMsgFilterAfterTheFact::O</span>
<a href="#l7.312"></a><span id="l7.312"> NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchHit(nsIMsgDBHdr *header, nsIMsgFolder *folder)</span>
<a href="#l7.313"></a><span id="l7.313"> {</span>
<a href="#l7.314"></a><span id="l7.314">   NS_ENSURE_ARG_POINTER(header);</span>
<a href="#l7.315"></a><span id="l7.315">   NS_ENSURE_TRUE(m_searchHitHdrs, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l7.316"></a><span id="l7.316"> </span>
<a href="#l7.317"></a><span id="l7.317">   nsMsgKey msgKey;</span>
<a href="#l7.318"></a><span id="l7.318">   header-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.319"></a><span id="l7.319"> </span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  nsCString msgId;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  header-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter matched message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+</span>
<a href="#l7.325"></a><span id="l7.325">   // Under various previous actions (a move, delete, or stopExecution)</span>
<a href="#l7.326"></a><span id="l7.326">   //  we do not want to process filters on a per-message basis.</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-  if (m_stopFiltering.Contains(msgKey))</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+  if (m_stopFiltering.Contains(msgKey)) {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Stopping further filter execution on this message&quot;));</span>
<a href="#l7.330"></a><span id="l7.330">     return NS_OK;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+  }</span>
<a href="#l7.332"></a><span id="l7.332"> </span>
<a href="#l7.333"></a><span id="l7.333">   m_searchHits.AppendElement(msgKey);</span>
<a href="#l7.334"></a><span id="l7.334">   m_searchHitHdrs-&gt;AppendElement(header);</span>
<a href="#l7.335"></a><span id="l7.335">   return NS_OK;</span>
<a href="#l7.336"></a><span id="l7.336"> }</span>
<a href="#l7.337"></a><span id="l7.337"> </span>
<a href="#l7.338"></a><span id="l7.338"> // Continue after an async operation.</span>
<a href="#l7.339"></a><span id="l7.339"> NS_IMETHODIMP nsMsgFilterAfterTheFact::OnSearchDone(nsresult status)</span>
<a href="#l7.340"></a><span id="l7.340"> {</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Done matching current filter&quot;));</span>
<a href="#l7.342"></a><span id="l7.342">   if (NS_SUCCEEDED(status))</span>
<a href="#l7.343"></a><span id="l7.343">     return m_searchHits.IsEmpty() ? RunNextFilter() : ApplyFilter();</span>
<a href="#l7.344"></a><span id="l7.344"> </span>
<a href="#l7.345"></a><span id="l7.345">   mFinalResult = status;</span>
<a href="#l7.346"></a><span id="l7.346">   if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt())</span>
<a href="#l7.347"></a><span id="l7.347">     return OnEndExecution();</span>
<a href="#l7.348"></a><span id="l7.348"> </span>
<a href="#l7.349"></a><span id="l7.349">   // The search failed, so move on to the next filter.</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineat">@@ -518,16 +597,17 @@ NS_IMETHODIMP nsMsgFilterAfterTheFact::O</span>
<a href="#l7.351"></a><span id="l7.351"> </span>
<a href="#l7.352"></a><span id="l7.352"> // This method will apply filters. It will continue to advance though headers,</span>
<a href="#l7.353"></a><span id="l7.353"> //   filters, and folders until done, unless it starts an async operation with</span>
<a href="#l7.354"></a><span id="l7.354"> //   a callback. The callback should call ApplyFilter again. It only returns</span>
<a href="#l7.355"></a><span id="l7.355"> //   an error if it is impossible to continue after attempting to continue the</span>
<a href="#l7.356"></a><span id="l7.356"> //   next filter action, filter, or folder.</span>
<a href="#l7.357"></a><span id="l7.357"> nsresult nsMsgFilterAfterTheFact::ApplyFilter()</span>
<a href="#l7.358"></a><span id="l7.358"> {</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact::ApplyFilter&quot;));</span>
<a href="#l7.360"></a><span id="l7.360">   nsresult rv;</span>
<a href="#l7.361"></a><span id="l7.361">   do { // error management block, break if unable to continue with filter.</span>
<a href="#l7.362"></a><span id="l7.362">     // 'm_curFolder' can be reset asynchronously by the copy service</span>
<a href="#l7.363"></a><span id="l7.363">     // calling OnStopCopy(). So take a local copy here and use it throughout the</span>
<a href="#l7.364"></a><span id="l7.364">     // function.</span>
<a href="#l7.365"></a><span id="l7.365">     nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = m_curFolder;</span>
<a href="#l7.366"></a><span id="l7.366">     if (!m_curFilter)</span>
<a href="#l7.367"></a><span id="l7.367">       break; // Maybe not an error, we just need to call RunNextFilter();</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineat">@@ -542,16 +622,18 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l7.369"></a><span id="l7.369"> </span>
<a href="#l7.370"></a><span id="l7.370">     nsCOMPtr&lt;nsIArray&gt; actionList;</span>
<a href="#l7.371"></a><span id="l7.371">     rv = m_curFilter-&gt;GetSortedActionList(getter_AddRefs(actionList));</span>
<a href="#l7.372"></a><span id="l7.372">     BREAK_IF_FAILURE(rv, &quot;Could not get action list for filter&quot;);</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">     uint32_t numActions;</span>
<a href="#l7.375"></a><span id="l7.375">     actionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Applying filter actions to %&quot; PRIu32 &quot; matched messages&quot;, static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+</span>
<a href="#l7.379"></a><span id="l7.379">     // We start from m_nextAction to allow us to continue applying actions</span>
<a href="#l7.380"></a><span id="l7.380">     // after the return from an async copy.</span>
<a href="#l7.381"></a><span id="l7.381">     while (m_nextAction &lt; numActions)</span>
<a href="#l7.382"></a><span id="l7.382">     {</span>
<a href="#l7.383"></a><span id="l7.383">       nsCOMPtr&lt;nsIMsgRuleAction&gt;filterAction(do_QueryElementAt(actionList, m_nextAction++, &amp;rv));</span>
<a href="#l7.384"></a><span id="l7.384">       CONTINUE_IF_FAILURE(rv, &quot;actionList cannot QI element&quot;);</span>
<a href="#l7.385"></a><span id="l7.385"> </span>
<a href="#l7.386"></a><span id="l7.386">       nsMsgRuleActionType actionType;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineat">@@ -899,19 +981,30 @@ NS_IMETHODIMP nsMsgFilterService::GetTem</span>
<a href="#l7.388"></a><span id="l7.388"> }</span>
<a href="#l7.389"></a><span id="l7.389"> </span>
<a href="#l7.390"></a><span id="l7.390"> NS_IMETHODIMP</span>
<a href="#l7.391"></a><span id="l7.391"> nsMsgFilterService::ApplyFiltersToFolders(nsIMsgFilterList *aFilterList,</span>
<a href="#l7.392"></a><span id="l7.392">                                           nsIArray *aFolders,</span>
<a href="#l7.393"></a><span id="l7.393">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.394"></a><span id="l7.394">                                           nsIMsgOperationListener *aCallback)</span>
<a href="#l7.395"></a><span id="l7.395"> {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterService::ApplyFiltersToFolders&quot;));</span>
<a href="#l7.397"></a><span id="l7.397">   NS_ENSURE_ARG_POINTER(aFilterList);</span>
<a href="#l7.398"></a><span id="l7.398">   NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l7.399"></a><span id="l7.399"> </span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+  uint32_t filterCount;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+  aFilterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  nsCString listId;</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+  aFilterList-&gt;GetListId(listId);</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  uint32_t folderCount;</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+  aFolders-&gt;GetLength(&amp;folderCount);</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Manual filter run initiated&quot;));</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; folders&quot;,</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+                                            filterCount, listId.get(), folderCount));</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+</span>
<a href="#l7.410"></a><span id="l7.410">   RefPtr&lt;nsMsgFilterAfterTheFact&gt; filterExecutor =</span>
<a href="#l7.411"></a><span id="l7.411">     new nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolders, aCallback);</span>
<a href="#l7.412"></a><span id="l7.412">   if (filterExecutor)</span>
<a href="#l7.413"></a><span id="l7.413">     return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l7.414"></a><span id="l7.414">   else</span>
<a href="#l7.415"></a><span id="l7.415">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.416"></a><span id="l7.416"> }</span>
<a href="#l7.417"></a><span id="l7.417"> </span>
<a href="#l7.418"></a><span id="l7.418" class="difflineat">@@ -977,16 +1070,66 @@ nsMsgFilterService::GetCustomTerm(const </span>
<a href="#l7.419"></a><span id="l7.419">       return NS_OK;</span>
<a href="#l7.420"></a><span id="l7.420">     }</span>
<a href="#l7.421"></a><span id="l7.421">   }</span>
<a href="#l7.422"></a><span id="l7.422">   aResult = nullptr;</span>
<a href="#l7.423"></a><span id="l7.423">   // we use a null result to indicate failure to find a term</span>
<a href="#l7.424"></a><span id="l7.424">   return NS_OK;</span>
<a href="#l7.425"></a><span id="l7.425"> }</span>
<a href="#l7.426"></a><span id="l7.426"> </span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+/**</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+ * Translate the filter type flag into human readable type names.</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+ * In case of multiple flag they are delimited by '&amp;'.</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+ */</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+nsMsgFilterService::FilterTypeName(nsMsgFilterTypeType filterType, nsACString &amp;typeName) {</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+  typeName.Truncate();</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+  if (filterType == nsMsgFilterType::None) {</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+    typeName.Assign(&quot;None&quot;);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  }</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+  if ((filterType &amp; nsMsgFilterType::Incoming) == nsMsgFilterType::Incoming) {</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+    typeName.Append(&quot;Incoming&amp;&quot;);</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  } else {</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+    if ((filterType &amp; nsMsgFilterType::Inbox) == nsMsgFilterType::Inbox) {</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+      typeName.Append(&quot;Inbox&amp;&quot;);</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+    } else {</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+      if (filterType &amp; nsMsgFilterType::InboxRule)</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+        typeName.Append(&quot;InboxRule&amp;&quot;);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+      if (filterType &amp; nsMsgFilterType::InboxJavaScript)</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+        typeName.Append(&quot;InboxJavaScript&amp;&quot;);</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+    }</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+    if ((filterType &amp; nsMsgFilterType::News) == nsMsgFilterType::News) {</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+      typeName.Append(&quot;News&amp;&quot;);</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+    } else {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+      if (filterType &amp; nsMsgFilterType::NewsRule)</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+        typeName.Append(&quot;NewsRule&amp;&quot;);</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+      if (filterType &amp; nsMsgFilterType::NewsJavaScript)</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+        typeName.Append(&quot;NewsJavaScript&amp;&quot;);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+    }</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+  }</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::Manual)</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+    typeName.Append(&quot;Manual&amp;&quot;);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::PostPlugin)</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+    typeName.Append(&quot;PostPlugin&amp;&quot;);</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::PostOutgoing)</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    typeName.Append(&quot;PostOutgoing&amp;&quot;);</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+  if (filterType &amp; nsMsgFilterType::Archive)</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+    typeName.Append(&quot;Archive&amp;&quot;);</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+  if (typeName.IsEmpty()) {</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    typeName.Assign(&quot;UNKNOWN&quot;);</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  } else {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+    // Cut the trailing '&amp;' character.</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+    typeName.Truncate(typeName.Length() - 1);</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  }</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+}</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+</span>
<a href="#l7.477"></a><span id="l7.477"> // nsMsgApplyFiltersToMessages overrides nsMsgFilterAfterTheFact in order to</span>
<a href="#l7.478"></a><span id="l7.478"> // apply filters to a list of messages, rather than an entire folder</span>
<a href="#l7.479"></a><span id="l7.479"> class nsMsgApplyFiltersToMessages : public nsMsgFilterAfterTheFact</span>
<a href="#l7.480"></a><span id="l7.480"> {</span>
<a href="#l7.481"></a><span id="l7.481"> public:</span>
<a href="#l7.482"></a><span id="l7.482">   nsMsgApplyFiltersToMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.483"></a><span id="l7.483">                               nsIMsgFilterList *aFilterList,</span>
<a href="#l7.484"></a><span id="l7.484">                               nsIArray *aFolderList, nsIArray *aMsgHdrList,</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineat">@@ -1004,16 +1147,17 @@ nsMsgApplyFiltersToMessages::nsMsgApplyF</span>
<a href="#l7.486"></a><span id="l7.486">                                                          nsIMsgFilterList *aFilterList,</span>
<a href="#l7.487"></a><span id="l7.487">                                                          nsIArray *aFolderList,</span>
<a href="#l7.488"></a><span id="l7.488">                                                          nsIArray *aMsgHdrList,</span>
<a href="#l7.489"></a><span id="l7.489">                                                          nsMsgFilterTypeType aFilterType,</span>
<a href="#l7.490"></a><span id="l7.490">                                                          nsIMsgOperationListener *aCallback)</span>
<a href="#l7.491"></a><span id="l7.491"> : nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolderList, aCallback),</span>
<a href="#l7.492"></a><span id="l7.492">   m_filterType(aFilterType)</span>
<a href="#l7.493"></a><span id="l7.493"> {</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages&quot;));</span>
<a href="#l7.495"></a><span id="l7.495">   nsCOMPtr&lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l7.496"></a><span id="l7.496">   if (NS_SUCCEEDED(aMsgHdrList-&gt;Enumerate(getter_AddRefs(msgEnumerator))))</span>
<a href="#l7.497"></a><span id="l7.497">   {</span>
<a href="#l7.498"></a><span id="l7.498">     uint32_t length;</span>
<a href="#l7.499"></a><span id="l7.499">     if (NS_SUCCEEDED(aMsgHdrList-&gt;GetLength(&amp;length)))</span>
<a href="#l7.500"></a><span id="l7.500">       m_msgHdrList.SetCapacity(length);</span>
<a href="#l7.501"></a><span id="l7.501"> </span>
<a href="#l7.502"></a><span id="l7.502">     bool hasMore;</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineat">@@ -1025,37 +1169,44 @@ nsMsgApplyFiltersToMessages::nsMsgApplyF</span>
<a href="#l7.504"></a><span id="l7.504">           (msgHdr = do_QueryInterface(supports)))</span>
<a href="#l7.505"></a><span id="l7.505">         m_msgHdrList.AppendObject(msgHdr);</span>
<a href="#l7.506"></a><span id="l7.506">     }</span>
<a href="#l7.507"></a><span id="l7.507">   }</span>
<a href="#l7.508"></a><span id="l7.508"> }</span>
<a href="#l7.509"></a><span id="l7.509"> </span>
<a href="#l7.510"></a><span id="l7.510"> nsresult nsMsgApplyFiltersToMessages::RunNextFilter()</span>
<a href="#l7.511"></a><span id="l7.511"> {</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages::RunNextFilter&quot;));</span>
<a href="#l7.513"></a><span id="l7.513">   nsresult rv = NS_OK;</span>
<a href="#l7.514"></a><span id="l7.514">   while (true)</span>
<a href="#l7.515"></a><span id="l7.515">   {</span>
<a href="#l7.516"></a><span id="l7.516">     m_curFilter = nullptr; // we are done with the current filter</span>
<a href="#l7.517"></a><span id="l7.517">     if (!m_curFolder || // Not an error, we just need to run AdvanceToNextFolder()</span>
<a href="#l7.518"></a><span id="l7.518">         m_curFilterIndex &gt;= m_numFilters)</span>
<a href="#l7.519"></a><span id="l7.519">       break;</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+</span>
<a href="#l7.521"></a><span id="l7.521">     BREAK_IF_FALSE(m_filters, &quot;No filters&quot;);</span>
<a href="#l7.522"></a><span id="l7.522">     nsMsgFilterTypeType filterType;</span>
<a href="#l7.523"></a><span id="l7.523">     bool isEnabled;</span>
<a href="#l7.524"></a><span id="l7.524">     rv = m_filters-&gt;GetFilterAt(m_curFilterIndex++, getter_AddRefs(m_curFilter));</span>
<a href="#l7.525"></a><span id="l7.525">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter&quot;);</span>
<a href="#l7.526"></a><span id="l7.526">     rv = m_curFilter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l7.527"></a><span id="l7.527">     CONTINUE_IF_FAILURE(rv, &quot;Could not get filter type&quot;);</span>
<a href="#l7.528"></a><span id="l7.528">     if (!(filterType &amp; m_filterType))</span>
<a href="#l7.529"></a><span id="l7.529">       continue;</span>
<a href="#l7.530"></a><span id="l7.530">     rv = m_curFilter-&gt;GetEnabled(&amp;isEnabled);</span>
<a href="#l7.531"></a><span id="l7.531">     CONTINUE_IF_FAILURE(rv, &quot;Could not get isEnabled&quot;);</span>
<a href="#l7.532"></a><span id="l7.532">     if (!isEnabled)</span>
<a href="#l7.533"></a><span id="l7.533">       continue;</span>
<a href="#l7.534"></a><span id="l7.534"> </span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) Running filter %&quot; PRIu32, m_curFilterIndex));</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+    nsString filterName;</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+    m_curFilter-&gt;GetFilterName(filterName);</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter name: %s&quot;, NS_ConvertUTF16toUTF8(filterName).get()));</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+</span>
<a href="#l7.540"></a><span id="l7.540">     nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt; scope(new nsMsgSearchScopeTerm(nullptr, nsMsgSearchScope::offlineMail, m_curFolder));</span>
<a href="#l7.541"></a><span id="l7.541">     BREAK_IF_FALSE(scope, &quot;Could not create scope, OOM?&quot;);</span>
<a href="#l7.542"></a><span id="l7.542">     m_curFilter-&gt;SetScope(scope);</span>
<a href="#l7.543"></a><span id="l7.543">     OnNewSearch();</span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545">     for (int32_t i = 0; i &lt; m_msgHdrList.Count(); i++)</span>
<a href="#l7.546"></a><span id="l7.546">     {</span>
<a href="#l7.547"></a><span id="l7.547">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_msgHdrList[i];</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineat">@@ -1076,41 +1227,65 @@ nsresult nsMsgApplyFiltersToMessages::Ru</span>
<a href="#l7.549"></a><span id="l7.549">     if (m_searchHits.Length() &gt; 0)</span>
<a href="#l7.550"></a><span id="l7.550">     {</span>
<a href="#l7.551"></a><span id="l7.551">       m_nextAction = 0;</span>
<a href="#l7.552"></a><span id="l7.552">       rv = ApplyFilter();</span>
<a href="#l7.553"></a><span id="l7.553">       if (NS_SUCCEEDED(rv))</span>
<a href="#l7.554"></a><span id="l7.554">         return NS_OK; // async callback will continue, or we are done.</span>
<a href="#l7.555"></a><span id="l7.555">     }</span>
<a href="#l7.556"></a><span id="l7.556">   }</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Post) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), m_curFilter);</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+    NS_WARNING_ASSERTION(false, &quot;Failed to run filters&quot;);</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+  } else {</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter run finished on the current folder&quot;));</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+  }</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+</span>
<a href="#l7.566"></a><span id="l7.566">   m_curFilter = nullptr;</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to run filters&quot;);</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+</span>
<a href="#l7.569"></a><span id="l7.569">   // We expect the failure is already recorded through one of the macro</span>
<a href="#l7.570"></a><span id="l7.570">   // expressions, that will have console logging added to them.</span>
<a href="#l7.571"></a><span id="l7.571">   // So an additional console warning is not needed here.</span>
<a href="#l7.572"></a><span id="l7.572">   return AdvanceToNextFolder();</span>
<a href="#l7.573"></a><span id="l7.573"> }</span>
<a href="#l7.574"></a><span id="l7.574"> </span>
<a href="#l7.575"></a><span id="l7.575"> NS_IMETHODIMP nsMsgFilterService::ApplyFilters(nsMsgFilterTypeType aFilterType,</span>
<a href="#l7.576"></a><span id="l7.576">                                                nsIArray *aMsgHdrList,</span>
<a href="#l7.577"></a><span id="l7.577">                                                nsIMsgFolder *aFolder,</span>
<a href="#l7.578"></a><span id="l7.578">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.579"></a><span id="l7.579">                                                nsIMsgOperationListener *aCallback)</span>
<a href="#l7.580"></a><span id="l7.580"> {</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgApplyFiltersToMessages::ApplyFilters&quot;));</span>
<a href="#l7.582"></a><span id="l7.582">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l7.583"></a><span id="l7.583"> </span>
<a href="#l7.584"></a><span id="l7.584">   nsCOMPtr&lt;nsIMsgFilterList&gt;    filterList;</span>
<a href="#l7.585"></a><span id="l7.585">   nsresult rv = aFolder-&gt;GetFilterList(aMsgWindow, getter_AddRefs(filterList));</span>
<a href="#l7.586"></a><span id="l7.586">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.587"></a><span id="l7.587"> </span>
<a href="#l7.588"></a><span id="l7.588">   nsCOMPtr&lt;nsIMutableArray&gt; folderList(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l7.589"></a><span id="l7.589">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.590"></a><span id="l7.590"> </span>
<a href="#l7.591"></a><span id="l7.591">   folderList-&gt;AppendElement(aFolder);</span>
<a href="#l7.592"></a><span id="l7.592"> </span>
<a href="#l7.593"></a><span id="l7.593" class="difflineplus">+  uint32_t filterCount;</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineplus">+  filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+  uint32_t msgCount;</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineplus">+  aMsgHdrList-&gt;GetLength(&amp;msgCount);</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+  nsCString listId;</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineplus">+  filterList-&gt;GetListId(listId);</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+  nsString folderName;</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+  aFolder-&gt;GetName(folderName);</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineplus">+  nsCString typeName;</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+  FilterTypeName(aFilterType, typeName);</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(), aFilterType));</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; message(s) in folder '%s'&quot;,</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineplus">+                                            filterCount, listId.get(), msgCount, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+</span>
<a href="#l7.607"></a><span id="l7.607">   // Create our nsMsgApplyFiltersToMessages object which will be called when ApplyFiltersToHdr</span>
<a href="#l7.608"></a><span id="l7.608">   // finds one or more filters that hit.</span>
<a href="#l7.609"></a><span id="l7.609">   RefPtr&lt;nsMsgApplyFiltersToMessages&gt; filterExecutor =</span>
<a href="#l7.610"></a><span id="l7.610">     new nsMsgApplyFiltersToMessages(aMsgWindow, filterList, folderList,</span>
<a href="#l7.611"></a><span id="l7.611">                                     aMsgHdrList, aFilterType, aCallback);</span>
<a href="#l7.612"></a><span id="l7.612"> </span>
<a href="#l7.613"></a><span id="l7.613">   if (filterExecutor)</span>
<a href="#l7.614"></a><span id="l7.614">     return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineat">@@ -1196,8 +1371,9 @@ nsMsgFilterAfterTheFact::DisplayConfirma</span>
<a href="#l7.616"></a><span id="l7.616">     {</span>
<a href="#l7.617"></a><span id="l7.617">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l7.618"></a><span id="l7.618">       if (dialog &amp;&amp; confirmString)</span>
<a href="#l7.619"></a><span id="l7.619">         dialog-&gt;Confirm(nullptr, confirmString, confirmed);</span>
<a href="#l7.620"></a><span id="l7.620">     }</span>
<a href="#l7.621"></a><span id="l7.621">   }</span>
<a href="#l7.622"></a><span id="l7.622">   return NS_OK;</span>
<a href="#l7.623"></a><span id="l7.623"> }</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,23 +2,23 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> #ifndef _nsMsgFilterService_H_</span>
<a href="#l8.9"></a><span id="l8.9"> #define _nsMsgFilterService_H_</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> class nsIMsgWindow;</span>
<a href="#l8.16"></a><span id="l8.16"> class nsIStringBundle;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-</span>
<a href="#l8.20"></a><span id="l8.20"> // The filter service is used to acquire and manipulate filter lists.</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> class nsMsgFilterService : public nsIMsgFilterService</span>
<a href="#l8.23"></a><span id="l8.23"> {</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> public:</span>
<a href="#l8.26"></a><span id="l8.26">   nsMsgFilterService();</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineat">@@ -34,13 +34,12 @@ public:</span>
<a href="#l8.29"></a><span id="l8.29">   nsresult GetStringFromBundle(const char *aMsgName, nsAString&amp; aResult);</span>
<a href="#l8.30"></a><span id="l8.30">   nsresult GetFilterStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> protected:</span>
<a href="#l8.33"></a><span id="l8.33">   virtual ~nsMsgFilterService();</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">   nsCOMArray&lt;nsIMsgFilterCustomAction&gt; mCustomActions; // defined custom action list</span>
<a href="#l8.36"></a><span id="l8.36">   nsCOMArray&lt;nsIMsgSearchCustomTerm&gt; mCustomTerms; // defined custom term list</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-</span>
<a href="#l8.38"></a><span id="l8.38"> };</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40"> #endif  // _nsMsgFilterService_H_</span>
<a href="#l8.41"></a><span id="l8.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -62,18 +62,23 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #define oneHour 3600000000U</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsIScriptError.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;mozilla/intl/LocaleService.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-#include &quot;nsIURIMutator.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+using namespace mozilla;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> static PRTime gtimeOfLastPurgeCheck;  // variable to know when to check for purge threshold</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23"> #define PREF_MAIL_PROMPT_PURGE_THRESHOLD &quot;mail.prompt_purge_threshhold&quot;</span>
<a href="#l9.24"></a><span id="l9.24"> #define PREF_MAIL_PURGE_THRESHOLD &quot;mail.purge_threshhold&quot;</span>
<a href="#l9.25"></a><span id="l9.25"> #define PREF_MAIL_PURGE_THRESHOLD_MB &quot;mail.purge_threshhold_mb&quot;</span>
<a href="#l9.26"></a><span id="l9.26"> #define PREF_MAIL_PURGE_MIGRATED &quot;mail.purge_threshold_migrated&quot;</span>
<a href="#l9.27"></a><span id="l9.27"> #define PREF_MAIL_PURGE_ASK &quot;mail.purge.ask&quot;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineat">@@ -2294,16 +2299,17 @@ nsMsgDBFolder::SpamFilterClassifyMessage</span>
<a href="#l9.29"></a><span id="l9.29">   free(proIndices);</span>
<a href="#l9.30"></a><span id="l9.30">   free(antiIndices);</span>
<a href="#l9.31"></a><span id="l9.31">   return rv;</span>
<a href="#l9.32"></a><span id="l9.32"> }</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> nsresult</span>
<a href="#l9.35"></a><span id="l9.35"> nsMsgDBFolder::SpamFilterClassifyMessages(const char **aURIArray, uint32_t aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l9.36"></a><span id="l9.36"> {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running Spam classification on %&quot; PRIu32 &quot; messages&quot;, aURICount));</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">   nsresult rv;</span>
<a href="#l9.40"></a><span id="l9.40">   nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l9.41"></a><span id="l9.41">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43">   uint32_t count;</span>
<a href="#l9.44"></a><span id="l9.44">   uint32_t *proIndices;</span>
<a href="#l9.45"></a><span id="l9.45">   uint32_t *antiIndices;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineat">@@ -2489,16 +2495,21 @@ nsMsgDBFolder::OnMessageTraitsClassified</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> /**</span>
<a href="#l9.49"></a><span id="l9.49">  * Call the filter plugins (XXX currently just one)</span>
<a href="#l9.50"></a><span id="l9.50">  */</span>
<a href="#l9.51"></a><span id="l9.51"> NS_IMETHODIMP</span>
<a href="#l9.52"></a><span id="l9.52"> nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, bool *aFiltersRun)</span>
<a href="#l9.53"></a><span id="l9.53"> {</span>
<a href="#l9.54"></a><span id="l9.54">   NS_ENSURE_ARG_POINTER(aFiltersRun);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  nsString folderName;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  GetPrettyName(folderName);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filter plugins on folder '%s'&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+</span>
<a href="#l9.60"></a><span id="l9.60">   *aFiltersRun = false;</span>
<a href="#l9.61"></a><span id="l9.61">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l9.62"></a><span id="l9.62">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l9.63"></a><span id="l9.63">   int32_t spamLevel = 0;</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l9.66"></a><span id="l9.66">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineat">@@ -2566,16 +2577,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.69"></a><span id="l9.69">   bool userHasClassified = false;</span>
<a href="#l9.70"></a><span id="l9.70">   // if the user has not classified any messages yet, then we shouldn't bother</span>
<a href="#l9.71"></a><span id="l9.71">   // running the junk mail controls. This creates a better first use experience.</span>
<a href="#l9.72"></a><span id="l9.72">   // See Bug #250084.</span>
<a href="#l9.73"></a><span id="l9.73">   junkMailPlugin-&gt;GetUserHasClassified(&amp;userHasClassified);</span>
<a href="#l9.74"></a><span id="l9.74">   if (!userHasClassified)</span>
<a href="#l9.75"></a><span id="l9.75">     filterForJunk = false;</span>
<a href="#l9.76"></a><span id="l9.76"> </span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Spam filter: %s&quot;, filterForJunk ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+</span>
<a href="#l9.79"></a><span id="l9.79">   nsCOMPtr&lt;nsIMsgDatabase&gt; database(mDatabase);</span>
<a href="#l9.80"></a><span id="l9.80">   rv = GetMsgDatabase(getter_AddRefs(database));</span>
<a href="#l9.81"></a><span id="l9.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83">   // check if trait processing needed</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85">   nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l9.86"></a><span id="l9.86">       do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineat">@@ -2612,16 +2625,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.88"></a><span id="l9.88">         // for now there is no way for that to affect the processing</span>
<a href="#l9.89"></a><span id="l9.89">         break;</span>
<a href="#l9.90"></a><span id="l9.90">       }</span>
<a href="#l9.91"></a><span id="l9.91">     }</span>
<a href="#l9.92"></a><span id="l9.92">     free(proIndices);</span>
<a href="#l9.93"></a><span id="l9.93">     free(antiIndices);</span>
<a href="#l9.94"></a><span id="l9.94">   }</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Trait classification: %s&quot;, filterForOther ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+</span>
<a href="#l9.98"></a><span id="l9.98">   // Do we need to apply message filters?</span>
<a href="#l9.99"></a><span id="l9.99">   bool filterPostPlugin = false; // Do we have a post-analysis filter?</span>
<a href="#l9.100"></a><span id="l9.100">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l9.101"></a><span id="l9.101">   GetFilterList(aMsgWindow, getter_AddRefs(filterList));</span>
<a href="#l9.102"></a><span id="l9.102">   if (filterList)</span>
<a href="#l9.103"></a><span id="l9.103">   {</span>
<a href="#l9.104"></a><span id="l9.104">     uint32_t filterCount = 0;</span>
<a href="#l9.105"></a><span id="l9.105">     filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineat">@@ -2638,32 +2653,38 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.107"></a><span id="l9.107">       bool enabled = false;</span>
<a href="#l9.108"></a><span id="l9.108">       filter-&gt;GetEnabled(&amp;enabled);</span>
<a href="#l9.109"></a><span id="l9.109">       if (!enabled)</span>
<a href="#l9.110"></a><span id="l9.110">         continue;</span>
<a href="#l9.111"></a><span id="l9.111">       filterPostPlugin = true;</span>
<a href="#l9.112"></a><span id="l9.112">     }</span>
<a href="#l9.113"></a><span id="l9.113">   }</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Will run Post-classification filters: %s&quot;,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+                                            filterPostPlugin ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+</span>
<a href="#l9.118"></a><span id="l9.118">   // If there is nothing to do, leave now but let NotifyHdrsNotBeingClassified</span>
<a href="#l9.119"></a><span id="l9.119">   // generate the msgsClassified notification for all newly added messages as</span>
<a href="#l9.120"></a><span id="l9.120">   // tracked by the NotReportedClassified processing flag.</span>
<a href="#l9.121"></a><span id="l9.121">   if (!filterForOther &amp;&amp; !filterForJunk &amp;&amp; !filterPostPlugin)</span>
<a href="#l9.122"></a><span id="l9.122">   {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;No filters need to be run&quot;));</span>
<a href="#l9.124"></a><span id="l9.124">     NotifyHdrsNotBeingClassified();</span>
<a href="#l9.125"></a><span id="l9.125">     return NS_OK;</span>
<a href="#l9.126"></a><span id="l9.126">   }</span>
<a href="#l9.127"></a><span id="l9.127"> </span>
<a href="#l9.128"></a><span id="l9.128">   // get the list of new messages</span>
<a href="#l9.129"></a><span id="l9.129">   //</span>
<a href="#l9.130"></a><span id="l9.130">   uint32_t numNewKeys;</span>
<a href="#l9.131"></a><span id="l9.131">   nsMsgKey *newKeys;</span>
<a href="#l9.132"></a><span id="l9.132">   rv = database-&gt;GetNewList(&amp;numNewKeys, &amp;newKeys);</span>
<a href="#l9.133"></a><span id="l9.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.134"></a><span id="l9.134"> </span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filters on %&quot; PRIu32 &quot; new messages&quot;, numNewKeys));</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+</span>
<a href="#l9.137"></a><span id="l9.137">   nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l9.138"></a><span id="l9.138">   // Start from m_saveNewMsgs (and clear its current state).  m_saveNewMsgs is</span>
<a href="#l9.139"></a><span id="l9.139">   // where we stash the list of new messages when we are told to clear the list</span>
<a href="#l9.140"></a><span id="l9.140">   // of new messages by the UI (which purges the list from the nsMsgDatabase).</span>
<a href="#l9.141"></a><span id="l9.141">   newMessageKeys.SwapElements(m_saveNewMsgs);</span>
<a href="#l9.142"></a><span id="l9.142">   if (numNewKeys)</span>
<a href="#l9.143"></a><span id="l9.143">     newMessageKeys.AppendElements(newKeys, numNewKeys);</span>
<a href="#l9.144"></a><span id="l9.144"> </span>
<a href="#l9.145"></a><span id="l9.145" class="difflineat">@@ -2671,44 +2692,50 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147">   // build up list of keys to classify</span>
<a href="#l9.148"></a><span id="l9.148">   nsTArray&lt;nsMsgKey&gt; classifyMsgKeys;</span>
<a href="#l9.149"></a><span id="l9.149">   nsCString uri;</span>
<a href="#l9.150"></a><span id="l9.150"> </span>
<a href="#l9.151"></a><span id="l9.151">   uint32_t numNewMessages = newMessageKeys.Length();</span>
<a href="#l9.152"></a><span id="l9.152">   for (uint32_t i = 0 ; i &lt; numNewMessages ; ++i)</span>
<a href="#l9.153"></a><span id="l9.153">   {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.155"></a><span id="l9.155">     nsMsgKey msgKey = newMessageKeys[i];</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Running filters on message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.158"></a><span id="l9.158">     rv = database-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l9.159"></a><span id="l9.159">     if (!NS_SUCCEEDED(rv))</span>
<a href="#l9.160"></a><span id="l9.160">       continue;</span>
<a href="#l9.161"></a><span id="l9.161">     // per-message junk tests.</span>
<a href="#l9.162"></a><span id="l9.162">     bool filterMessageForJunk = false;</span>
<a href="#l9.163"></a><span id="l9.163">     while (filterForJunk)  // we'll break from this at the end</span>
<a href="#l9.164"></a><span id="l9.164">     {</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Spam filter&quot;));</span>
<a href="#l9.166"></a><span id="l9.166">       nsCString junkScore;</span>
<a href="#l9.167"></a><span id="l9.167">       msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScore));</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-      if (!junkScore.IsEmpty()) // ignore already scored messages.</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+      if (!junkScore.IsEmpty()) {</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        // ignore already scored messages.</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message already scored previously, skipping&quot;));</span>
<a href="#l9.172"></a><span id="l9.172">         break;</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+      }</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175">       bool whiteListMessage = false;</span>
<a href="#l9.176"></a><span id="l9.176">       spamSettings-&gt;CheckWhiteList(msgHdr, &amp;whiteListMessage);</span>
<a href="#l9.177"></a><span id="l9.177">       if (whiteListMessage)</span>
<a href="#l9.178"></a><span id="l9.178">       {</span>
<a href="#l9.179"></a><span id="l9.179">         // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-</span>
<a href="#l9.181"></a><span id="l9.181">         nsAutoCString msgJunkScore;</span>
<a href="#l9.182"></a><span id="l9.182">         msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l9.183"></a><span id="l9.183">         database-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l9.184"></a><span id="l9.184">         database-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message whitelisted, skipping&quot;));</span>
<a href="#l9.186"></a><span id="l9.186">         break; // skip this msg since it's in the white list</span>
<a href="#l9.187"></a><span id="l9.187">       }</span>
<a href="#l9.188"></a><span id="l9.188">       filterMessageForJunk = true;</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Message is to be classified&quot;));</span>
<a href="#l9.191"></a><span id="l9.191">       OrProcessingFlags(msgKey, nsMsgProcessingFlags::ClassifyJunk);</span>
<a href="#l9.192"></a><span id="l9.192">       // Since we are junk processing, we want to defer the msgsClassified</span>
<a href="#l9.193"></a><span id="l9.193">       // notification until the junk classification has occurred.  The event</span>
<a href="#l9.194"></a><span id="l9.194">       // is sufficiently reliable that we know this will be handled in</span>
<a href="#l9.195"></a><span id="l9.195">       // OnMessageClassified at the end of the batch.  We clear the</span>
<a href="#l9.196"></a><span id="l9.196">       // NotReportedClassified flag since we know the message is in good hands.</span>
<a href="#l9.197"></a><span id="l9.197">       AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l9.198"></a><span id="l9.198">       break;</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineat">@@ -2737,16 +2764,17 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.200"></a><span id="l9.200">     // Have we already filtered this message?</span>
<a href="#l9.201"></a><span id="l9.201">     if (!(processingFlags &amp; nsMsgProcessingFlags::FiltersDone))</span>
<a href="#l9.202"></a><span id="l9.202">     {</span>
<a href="#l9.203"></a><span id="l9.203">       if (filterPostPlugin)</span>
<a href="#l9.204"></a><span id="l9.204">       {</span>
<a href="#l9.205"></a><span id="l9.205">         // Don't do filters on this message again.</span>
<a href="#l9.206"></a><span id="l9.206">         // (Only set this if we are actually filtering since this is</span>
<a href="#l9.207"></a><span id="l9.207">         // tantamount to a memory leak.)</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;Filters done on this message&quot;));</span>
<a href="#l9.209"></a><span id="l9.209">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::FiltersDone);</span>
<a href="#l9.210"></a><span id="l9.210">         // Lazily create the array.</span>
<a href="#l9.211"></a><span id="l9.211">         if (!mPostBayesMessagesToFilter)</span>
<a href="#l9.212"></a><span id="l9.212">           mPostBayesMessagesToFilter = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l9.213"></a><span id="l9.213">         mPostBayesMessagesToFilter-&gt;AppendElement(msgHdr);</span>
<a href="#l9.214"></a><span id="l9.214">       }</span>
<a href="#l9.215"></a><span id="l9.215">     }</span>
<a href="#l9.216"></a><span id="l9.216">   }</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineat">@@ -2764,16 +2792,17 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.218"></a><span id="l9.218">   {</span>
<a href="#l9.219"></a><span id="l9.219">     // Remember what classifications are the source of this decision for when</span>
<a href="#l9.220"></a><span id="l9.220">     // we perform the notification in OnMessageClassified at the conclusion of</span>
<a href="#l9.221"></a><span id="l9.221">     // classification.</span>
<a href="#l9.222"></a><span id="l9.222">     mBayesJunkClassifying = filterForJunk;</span>
<a href="#l9.223"></a><span id="l9.223">     mBayesTraitClassifying = filterForOther;</span>
<a href="#l9.224"></a><span id="l9.224"> </span>
<a href="#l9.225"></a><span id="l9.225">     uint32_t numMessagesToClassify = classifyMsgKeys.Length();</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;%&quot; PRIu32 &quot; messages to be classified&quot;, numMessagesToClassify));</span>
<a href="#l9.227"></a><span id="l9.227">     char ** messageURIs = (char **) PR_MALLOC(sizeof(const char *) * numMessagesToClassify);</span>
<a href="#l9.228"></a><span id="l9.228">     if (!messageURIs)</span>
<a href="#l9.229"></a><span id="l9.229">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.230"></a><span id="l9.230"> </span>
<a href="#l9.231"></a><span id="l9.231">     for (uint32_t msgIndex = 0; msgIndex &lt; numMessagesToClassify ; ++msgIndex )</span>
<a href="#l9.232"></a><span id="l9.232">     {</span>
<a href="#l9.233"></a><span id="l9.233">       nsCString tmpStr;</span>
<a href="#l9.234"></a><span id="l9.234">       rv = GenerateMessageURI(classifyMsgKeys[msgIndex], tmpStr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2100,16 +2100,21 @@ NS_MSG_BASE nsMsgKey msgKeyFromInt(uint3</span>
<a href="#l10.4"></a><span id="l10.4"> }</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> NS_MSG_BASE nsMsgKey msgKeyFromInt(uint64_t aValue)</span>
<a href="#l10.7"></a><span id="l10.7"> {</span>
<a href="#l10.8"></a><span id="l10.8">   NS_ASSERTION(aValue &lt;= PR_UINT32_MAX, &quot;Msg key value too big!&quot;);</span>
<a href="#l10.9"></a><span id="l10.9">   return aValue;</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+NS_MSG_BASE uint32_t msgKeyToInt(nsMsgKey aMsgKey)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  return (uint32_t)aMsgKey;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+}</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17"> // Helper function to extract a query qualifier.</span>
<a href="#l10.18"></a><span id="l10.18"> nsCString MsgExtractQueryPart(const nsACString&amp; spec, const char* queryToExtract)</span>
<a href="#l10.19"></a><span id="l10.19"> {</span>
<a href="#l10.20"></a><span id="l10.20">   nsCString queryPart;</span>
<a href="#l10.21"></a><span id="l10.21">   int32_t queryIndex = PromiseFlatCString(spec).Find(queryToExtract);</span>
<a href="#l10.22"></a><span id="l10.22">   if (queryIndex == kNotFound)</span>
<a href="#l10.23"></a><span id="l10.23">     return queryPart;</span>
<a href="#l10.24"></a><span id="l10.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -368,16 +368,18 @@ NS_MSG_BASE bool MsgIsHex(const char *aH</span>
<a href="#l11.4"></a><span id="l11.4">  * nsMsgKey is an opaque value that can't be treated as a generic integer</span>
<a href="#l11.5"></a><span id="l11.5">  * (except when storing it into the database). It enables type safety checks and</span>
<a href="#l11.6"></a><span id="l11.6">  * may prevent coding errors.</span>
<a href="#l11.7"></a><span id="l11.7">  */</span>
<a href="#l11.8"></a><span id="l11.8"> NS_MSG_BASE nsMsgKey msgKeyFromInt(uint32_t aValue);</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> NS_MSG_BASE nsMsgKey msgKeyFromInt(uint64_t aValue);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+NS_MSG_BASE uint32_t msgKeyToInt(nsMsgKey aMsgKey);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14"> /**</span>
<a href="#l11.15"></a><span id="l11.15">  * Helper function to extract query part from URL spec.</span>
<a href="#l11.16"></a><span id="l11.16">  */</span>
<a href="#l11.17"></a><span id="l11.17"> nsCString MsgExtractQueryPart(const nsACString&amp; spec, const char* queryToExtract);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> /**</span>
<a href="#l11.20"></a><span id="l11.20">  * Helper macro for defining getter/setters. Ported from nsISupportsObsolete.h</span>
<a href="#l11.21"></a><span id="l11.21">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -73,24 +73,27 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;mozilla/dom/HTMLAnchorElement.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;mozilla/dom/HTMLBodyElement.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;mozilla/dom/HTMLImageElement.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsINSSErrorsService.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+#include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> using namespace mozilla;</span>
<a href="#l12.19"></a><span id="l12.19"> using namespace mozilla::dom;</span>
<a href="#l12.20"></a><span id="l12.20"> using namespace mozilla::mailnews;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+</span>
<a href="#l12.24"></a><span id="l12.24"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l12.25"></a><span id="l12.25"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l12.26"></a><span id="l12.26"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l12.27"></a><span id="l12.27"> #define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> #define ATTR_MOZ_DO_NOT_SEND &quot;moz-do-not-send&quot;</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31"> enum  { kDefaultMode = (PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE) };</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineat">@@ -3949,28 +3952,32 @@ nsMsgComposeAndSend::FilterSentMessage()</span>
<a href="#l12.33"></a><span id="l12.33">   rv = msgArray-&gt;AppendElement(msgHdr);</span>
<a href="#l12.34"></a><span id="l12.34">   if (NS_FAILED(rv))</span>
<a href="#l12.35"></a><span id="l12.35">     return rv;</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l12.38"></a><span id="l12.38">   if (mSendProgress)</span>
<a href="#l12.39"></a><span id="l12.39">     mSendProgress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Running filters on sent message&quot;));</span>
<a href="#l12.42"></a><span id="l12.42">   return filterSvc-&gt;ApplyFilters(nsMsgFilterType::PostOutgoing, msgArray, folder, msgWindow, this);</span>
<a href="#l12.43"></a><span id="l12.43"> }</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45"> NS_IMETHODIMP</span>
<a href="#l12.46"></a><span id="l12.46"> nsMsgComposeAndSend::OnStopOperation(nsresult aStatus)</span>
<a href="#l12.47"></a><span id="l12.47"> {</span>
<a href="#l12.48"></a><span id="l12.48">   // Set a status message...</span>
<a href="#l12.49"></a><span id="l12.49">   nsString msg;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l12.52"></a><span id="l12.52">     mComposeBundle-&gt;GetStringFromName(&quot;filterMessageComplete&quot;, msg);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-  else</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Filter run complete&quot;));</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+  } else {</span>
<a href="#l12.56"></a><span id="l12.56">     mComposeBundle-&gt;GetStringFromName(&quot;filterMessageFailed&quot;, msg);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Filter run failed&quot;));</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">   SetStatusMessage(msg);</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">   if (NS_FAILED(aStatus))</span>
<a href="#l12.63"></a><span id="l12.63">   {</span>
<a href="#l12.64"></a><span id="l12.64">     nsresult rv = mComposeBundle-&gt;GetStringFromName(&quot;errorFilteringMsg&quot;, msg);</span>
<a href="#l12.65"></a><span id="l12.65">     if (NS_SUCCEEDED(rv))</span>
<a href="#l12.66"></a><span id="l12.66">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -89,23 +89,26 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l13.10"></a><span id="l13.10"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-extern mozilla::LazyLogModule gAutoSyncLog; // defined in nsAutoSyncManager.cpp</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-extern mozilla::LazyLogModule IMAP;         // defined in nsImapProtocol.cpp</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-extern mozilla::LazyLogModule IMAP_CS;      // For CONDSTORE, defined in nsImapProtocol.cpp</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-mozilla::LazyLogModule IMAP_KW(&quot;IMAP_KW&quot;);  // for logging keyword (tag) processing</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17"> #define MAILNEWS_CUSTOM_HEADERS &quot;mailnews.customHeaders&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+using namespace mozilla;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+extern LazyLogModule gAutoSyncLog;    // defined in nsAutoSyncManager.cpp</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+extern LazyLogModule IMAP;            // defined in nsImapProtocol.cpp</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+extern LazyLogModule IMAP_CS;         // For CONDSTORE, defined in nsImapProtocol.cpp</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE; // defined in nsMsgFilterService.cpp</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+LazyLogModule IMAP_KW(&quot;IMAP_KW&quot;);     // for logging keyword (tag) processing</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+</span>
<a href="#l13.27"></a><span id="l13.27"> /*</span>
<a href="#l13.28"></a><span id="l13.28">     Copies the contents of srcDir into destDir.</span>
<a href="#l13.29"></a><span id="l13.29">     destDir will be created if it doesn't exist.</span>
<a href="#l13.30"></a><span id="l13.30"> */</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> static</span>
<a href="#l13.33"></a><span id="l13.33"> nsresult RecursiveCopy(nsIFile* srcDir, nsIFile* destDir)</span>
<a href="#l13.34"></a><span id="l13.34"> {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineat">@@ -597,28 +600,41 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l13.36"></a><span id="l13.36">   // If this is the inbox, filters will be applied. Otherwise, we test the</span>
<a href="#l13.37"></a><span id="l13.37">   // inherited folder property &quot;applyIncomingFilters&quot; (which defaults to empty).</span>
<a href="#l13.38"></a><span id="l13.38">   // If this inherited property has the string value &quot;true&quot;, we will apply</span>
<a href="#l13.39"></a><span id="l13.39">   // filters even if this is not the inbox folder.</span>
<a href="#l13.40"></a><span id="l13.40">   nsCString applyIncomingFilters;</span>
<a href="#l13.41"></a><span id="l13.41">   GetInheritedStringProperty(&quot;applyIncomingFilters&quot;, applyIncomingFilters);</span>
<a href="#l13.42"></a><span id="l13.42">   m_applyIncomingFilters = applyIncomingFilters.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  nsString folderName;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  GetPrettyName(folderName);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Imap) nsImapMailFolder::UpdateFolderWithListener() on folder '%s'&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l13.47"></a><span id="l13.47">   if (mFlags &amp; nsMsgFolderFlags::Inbox || m_applyIncomingFilters)</span>
<a href="#l13.48"></a><span id="l13.48">   {</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    if (!m_filterList)</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) Preparing filter run on folder '%s'&quot;, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    if (!m_filterList) {</span>
<a href="#l13.53"></a><span id="l13.53">       rv = GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Imap) Loading of filter list failed&quot;));</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      }</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    }</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+</span>
<a href="#l13.59"></a><span id="l13.59">     // if there's no msg window, but someone is updating the inbox, we're</span>
<a href="#l13.60"></a><span id="l13.60">     // doing something biff-like, and may download headers, so make biff notify.</span>
<a href="#l13.61"></a><span id="l13.61">     if (!aMsgWindow &amp;&amp; mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l13.62"></a><span id="l13.62">       SetPerformingBiff(true);</span>
<a href="#l13.63"></a><span id="l13.63">   }</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65">   if (m_filterList)</span>
<a href="#l13.66"></a><span id="l13.66">   {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    nsCString listId;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    m_filterList-&gt;GetListId(listId);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) Preparing filter list %s&quot;, listId.get()));</span>
<a href="#l13.70"></a><span id="l13.70">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.71"></a><span id="l13.71">     rv = GetServer(getter_AddRefs(server));</span>
<a href="#l13.72"></a><span id="l13.72">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.73"></a><span id="l13.73"> </span>
<a href="#l13.74"></a><span id="l13.74">     bool canFileMessagesOnServer = true;</span>
<a href="#l13.75"></a><span id="l13.75">     rv = server-&gt;GetCanFileMessagesOnServer(&amp;canFileMessagesOnServer);</span>
<a href="#l13.76"></a><span id="l13.76">     // the mdn filter is for filing return receipts into the sent folder</span>
<a href="#l13.77"></a><span id="l13.77">     // some servers (like AOL mail servers)</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineat">@@ -707,16 +723,18 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">           bool needsBody = false;</span>
<a href="#l13.81"></a><span id="l13.81">           customAction-&gt;GetNeedsBody(&amp;needsBody);</span>
<a href="#l13.82"></a><span id="l13.82">           if (needsBody)</span>
<a href="#l13.83"></a><span id="l13.83">             m_filterListRequiresBody = true;</span>
<a href="#l13.84"></a><span id="l13.84">         }</span>
<a href="#l13.85"></a><span id="l13.85">       }</span>
<a href="#l13.86"></a><span id="l13.86">     }</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) Filters require the message body: %s&quot;,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+                                              (m_filterListRequiresBody ? &quot;true&quot; : &quot;false&quot;)));</span>
<a href="#l13.89"></a><span id="l13.89">   }</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91">   selectFolder = true;</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93">   bool isServer;</span>
<a href="#l13.94"></a><span id="l13.94">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l13.95"></a><span id="l13.95">   if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l13.96"></a><span id="l13.96">   {</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineat">@@ -3021,16 +3039,21 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99">     bool doFilter = filterOnHighwater ?</span>
<a href="#l13.100"></a><span id="l13.100">       // Filter on largest UUID and not deleted.</span>
<a href="#l13.101"></a><span id="l13.101">       m_curMsgUid &gt; highestUID &amp;&amp; !(msgFlags &amp; nsMsgMessageFlags::IMAPDeleted) :</span>
<a href="#l13.102"></a><span id="l13.102">       // Filter on unread and not deleted.</span>
<a href="#l13.103"></a><span id="l13.103">       !(msgFlags &amp; (nsMsgMessageFlags::Read | nsMsgMessageFlags::IMAPDeleted));</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">     if (doFilter)</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) New message parsed, and filters will be run on it&quot;));</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+    else</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) New message parsed, but filters will not be run on it&quot;));</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    if (doFilter)</span>
<a href="#l13.111"></a><span id="l13.111">     {</span>
<a href="#l13.112"></a><span id="l13.112">       int32_t duplicateAction = nsIMsgIncomingServer::keepDups;</span>
<a href="#l13.113"></a><span id="l13.113">       if (server)</span>
<a href="#l13.114"></a><span id="l13.114">         server-&gt;GetIncomingDuplicateAction(&amp;duplicateAction);</span>
<a href="#l13.115"></a><span id="l13.115">       if ((duplicateAction != nsIMsgIncomingServer::keepDups) &amp;&amp;</span>
<a href="#l13.116"></a><span id="l13.116">           mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l13.117"></a><span id="l13.117">       {</span>
<a href="#l13.118"></a><span id="l13.118">         bool isDup;</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineat">@@ -3081,16 +3104,18 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l13.120"></a><span id="l13.120">       rv = m_msgParser-&gt;GetAllHeaders(&amp;headers, &amp;headersSize);</span>
<a href="#l13.121"></a><span id="l13.121"> </span>
<a href="#l13.122"></a><span id="l13.122">       if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter &amp;&amp;</span>
<a href="#l13.123"></a><span id="l13.123">           !m_filterListRequiresBody)</span>
<a href="#l13.124"></a><span id="l13.124">       {</span>
<a href="#l13.125"></a><span id="l13.125">         if (m_filterList)</span>
<a href="#l13.126"></a><span id="l13.126">         {</span>
<a href="#l13.127"></a><span id="l13.127">           GetMoveCoalescer();  // not sure why we're doing this here.</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+                  (&quot;(Imap) ApplyFilterToHdr from nsImapMailFolder::NormalEndHeaderParseStream()&quot;));</span>
<a href="#l13.130"></a><span id="l13.130">           m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr,</span>
<a href="#l13.131"></a><span id="l13.131">                                           this, mDatabase, nsDependentCSubstring(headers, headersSize),</span>
<a href="#l13.132"></a><span id="l13.132">                                           this, msgWindow);</span>
<a href="#l13.133"></a><span id="l13.133">           NotifyFolderEvent(kFiltersApplied);</span>
<a href="#l13.134"></a><span id="l13.134">         }</span>
<a href="#l13.135"></a><span id="l13.135">       }</span>
<a href="#l13.136"></a><span id="l13.136">     }</span>
<a href="#l13.137"></a><span id="l13.137">   }</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineat">@@ -3379,39 +3404,40 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l13.139"></a><span id="l13.139">   //  should be performed.</span>
<a href="#l13.140"></a><span id="l13.140">   //</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142">   NS_ENSURE_ARG_POINTER(filter);</span>
<a href="#l13.143"></a><span id="l13.143">   NS_ENSURE_ARG_POINTER(applyMore);</span>
<a href="#l13.144"></a><span id="l13.144"> </span>
<a href="#l13.145"></a><span id="l13.145">   nsresult rv = NS_OK;</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-  // look at action - currently handle move</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-#ifdef DEBUG_bienvenu</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-  printf(&quot;got a rule hit!\n&quot;);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-#endif</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-</span>
<a href="#l13.152"></a><span id="l13.152">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l13.153"></a><span id="l13.153">   if (m_filterListRequiresBody)</span>
<a href="#l13.154"></a><span id="l13.154">     GetMessageHeader(m_curMsgUid, getter_AddRefs(msgHdr));</span>
<a href="#l13.155"></a><span id="l13.155">   else if (m_msgParser)</span>
<a href="#l13.156"></a><span id="l13.156">     m_msgParser-&gt;GetNewMsgHdr(getter_AddRefs(msgHdr));</span>
<a href="#l13.157"></a><span id="l13.157">   NS_ENSURE_TRUE(msgHdr, NS_ERROR_NULL_POINTER); //fatal error, cannot apply filters</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">   bool deleteToTrash = DeleteIsMoveToTrash();</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161">   nsCOMPtr&lt;nsIArray&gt; filterActionList;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-</span>
<a href="#l13.163"></a><span id="l13.163">   rv = filter-&gt;GetSortedActionList(getter_AddRefs(filterActionList));</span>
<a href="#l13.164"></a><span id="l13.164">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.165"></a><span id="l13.165"> </span>
<a href="#l13.166"></a><span id="l13.166">   uint32_t numActions;</span>
<a href="#l13.167"></a><span id="l13.167">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l13.168"></a><span id="l13.168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.169"></a><span id="l13.169"> </span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+  nsCString msgId;</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Imap) Applying filter actions on message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Imap) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+</span>
<a href="#l13.177"></a><span id="l13.177">   bool loggingEnabled = false;</span>
<a href="#l13.178"></a><span id="l13.178">   if (m_filterList &amp;&amp; numActions)</span>
<a href="#l13.179"></a><span id="l13.179">     (void)m_filterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181">   bool msgIsNew = true;</span>
<a href="#l13.182"></a><span id="l13.182"> </span>
<a href="#l13.183"></a><span id="l13.183">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++)</span>
<a href="#l13.184"></a><span id="l13.184">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -47,16 +47,21 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &lt;ctype.h&gt;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsQueryObject.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+using namespace mozilla;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> /* the following macros actually implement addref, release and query interface</span>
<a href="#l14.19"></a><span id="l14.19">  * for our component. */</span>
<a href="#l14.20"></a><span id="l14.20"> NS_IMPL_ISUPPORTS_INHERITED(nsMsgMailboxParser, nsParseMailMessageState,</span>
<a href="#l14.21"></a><span id="l14.21">                             nsIStreamListener, nsIRequestObserver)</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> // Whenever data arrives from the connection, core netlib notifices the protocol</span>
<a href="#l14.24"></a><span id="l14.24"> // by calling OnDataAvailable. We then read and process the incoming data from</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineat">@@ -1577,16 +1582,20 @@ nsresult nsParseNewMailState::Init(nsIMs</span>
<a href="#l14.26"></a><span id="l14.26">   if (msgDBService &amp;&amp; !m_mailDB)</span>
<a href="#l14.27"></a><span id="l14.27">     rv = msgDBService-&gt;OpenFolderDB(downloadFolder, false,</span>
<a href="#l14.28"></a><span id="l14.28">                                     getter_AddRefs(m_mailDB));</span>
<a href="#l14.29"></a><span id="l14.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l14.32"></a><span id="l14.32">   rv = serverFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l14.33"></a><span id="l14.33">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    nsString serverName;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    server-&gt;GetPrettyName(serverName);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Detected new local messages on account '%s'&quot;,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                                              NS_ConvertUTF16toUTF8(serverName).get()));</span>
<a href="#l14.38"></a><span id="l14.38">     rv = server-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">     if (m_filterList) rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l14.41"></a><span id="l14.41">     // check if this server defers to another server, in which case</span>
<a href="#l14.42"></a><span id="l14.42">     // we'll use that server's filters as well.</span>
<a href="#l14.43"></a><span id="l14.43">     nsCOMPtr&lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l14.44"></a><span id="l14.44">     server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l14.45"></a><span id="l14.45">     if (serverFolder != deferredToRootFolder) {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineat">@@ -1773,21 +1782,26 @@ void nsParseNewMailState::ApplyFilters(b</span>
<a href="#l14.47"></a><span id="l14.47">     nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder = m_downloadFolder;</span>
<a href="#l14.48"></a><span id="l14.48">     if (m_rootFolder) {</span>
<a href="#l14.49"></a><span id="l14.49">       if (!downloadFolder)</span>
<a href="#l14.50"></a><span id="l14.50">         m_rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l14.51"></a><span id="l14.51">                                          getter_AddRefs(downloadFolder));</span>
<a href="#l14.52"></a><span id="l14.52">       if (downloadFolder) downloadFolder-&gt;GetURI(m_inboxUri);</span>
<a href="#l14.53"></a><span id="l14.53">       char *headers = m_headers.GetBuffer();</span>
<a href="#l14.54"></a><span id="l14.54">       uint32_t headersSize = m_headers.GetBufferPos();</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      if (m_filterList)</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+      if (m_filterList) {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Running filters on 1 message at offset %&quot; PRIu64, msgOffset));</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Using filters from the original account&quot;));</span>
<a href="#l14.59"></a><span id="l14.59">         (void)m_filterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l14.60"></a><span id="l14.60">             nsMsgFilterType::InboxRule, msgHdr, downloadFolder, m_mailDB,</span>
<a href="#l14.61"></a><span id="l14.61">             nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+      }</span>
<a href="#l14.63"></a><span id="l14.63">       if (!m_msgMovedByFilter &amp;&amp; m_deferredToServerFilterList) {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Running filters on 1 message at offset %&quot; PRIu64, msgOffset));</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Using filters from the deferred to account&quot;));</span>
<a href="#l14.66"></a><span id="l14.66">         (void)m_deferredToServerFilterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l14.67"></a><span id="l14.67">             nsMsgFilterType::InboxRule, msgHdr, downloadFolder, m_mailDB,</span>
<a href="#l14.68"></a><span id="l14.68">             nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l14.69"></a><span id="l14.69">       }</span>
<a href="#l14.70"></a><span id="l14.70">     }</span>
<a href="#l14.71"></a><span id="l14.71">   }</span>
<a href="#l14.72"></a><span id="l14.72">   if (pMoved) *pMoved = m_msgMovedByFilter;</span>
<a href="#l14.73"></a><span id="l14.73"> }</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineat">@@ -1801,24 +1815,30 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l14.75"></a><span id="l14.75">   uint32_t newFlags;</span>
<a href="#l14.76"></a><span id="l14.76">   nsresult rv = NS_OK;</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   *applyMore = true;</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_newMsgHdr;</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82">   nsCOMPtr&lt;nsIArray&gt; filterActionList;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-</span>
<a href="#l14.84"></a><span id="l14.84">   rv = filter-&gt;GetSortedActionList(getter_AddRefs(filterActionList));</span>
<a href="#l14.85"></a><span id="l14.85">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87">   uint32_t numActions;</span>
<a href="#l14.88"></a><span id="l14.88">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l14.89"></a><span id="l14.89">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  nsCString msgId;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Applying filter actions on message with key %&quot; PRIu32, msgKeyToInt(msgKey)));</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Local) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+</span>
<a href="#l14.98"></a><span id="l14.98">   bool loggingEnabled = false;</span>
<a href="#l14.99"></a><span id="l14.99">   if (m_filterList &amp;&amp; numActions)</span>
<a href="#l14.100"></a><span id="l14.100">     m_filterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l14.101"></a><span id="l14.101"> </span>
<a href="#l14.102"></a><span id="l14.102">   bool msgIsNew = true;</span>
<a href="#l14.103"></a><span id="l14.103">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions &amp;&amp; *applyMore;</span>
<a href="#l14.104"></a><span id="l14.104">        actionIndex++) {</span>
<a href="#l14.105"></a><span id="l14.105">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineat">@@ -2106,49 +2126,62 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l14.107"></a><span id="l14.107"> // this gets run in a second pass, after apply filters to a header.</span>
<a href="#l14.108"></a><span id="l14.108"> nsresult nsParseNewMailState::ApplyForwardAndReplyFilter(</span>
<a href="#l14.109"></a><span id="l14.109">     nsIMsgWindow *msgWindow) {</span>
<a href="#l14.110"></a><span id="l14.110">   nsresult rv = NS_OK;</span>
<a href="#l14.111"></a><span id="l14.111">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l14.112"></a><span id="l14.112"> </span>
<a href="#l14.113"></a><span id="l14.113">   uint32_t i;</span>
<a href="#l14.114"></a><span id="l14.114">   uint32_t count = m_forwardTo.Length();</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  if (count &gt; 0 &amp;&amp; m_msgToForwardOrReply) {</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    m_msgToForwardOrReply-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Forwarding message with key %&quot; PRIu32 &quot; to %&quot; PRIu32 &quot; addresses&quot;, msgKeyToInt(msgKey), count));</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+  }</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+</span>
<a href="#l14.121"></a><span id="l14.121">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l14.122"></a><span id="l14.122">     if (!m_forwardTo[i].IsEmpty()) {</span>
<a href="#l14.123"></a><span id="l14.123">       nsAutoString forwardStr;</span>
<a href="#l14.124"></a><span id="l14.124">       CopyASCIItoUTF16(m_forwardTo[i], forwardStr);</span>
<a href="#l14.125"></a><span id="l14.125">       rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l14.126"></a><span id="l14.126">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.127"></a><span id="l14.127">       {</span>
<a href="#l14.128"></a><span id="l14.128">         nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l14.129"></a><span id="l14.129">             do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.130"></a><span id="l14.130">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.131"></a><span id="l14.131">         rv = compService-&gt;ForwardMessage(</span>
<a href="#l14.132"></a><span id="l14.132">             forwardStr, m_msgToForwardOrReply, msgWindow, server,</span>
<a href="#l14.133"></a><span id="l14.133">             nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Local) Forwarding failed&quot;));</span>
<a href="#l14.136"></a><span id="l14.136">       }</span>
<a href="#l14.137"></a><span id="l14.137">     }</span>
<a href="#l14.138"></a><span id="l14.138">   }</span>
<a href="#l14.139"></a><span id="l14.139">   m_forwardTo.Clear();</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141">   count = m_replyTemplateUri.Length();</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+  if (count &gt; 0 &amp;&amp; m_msgToForwardOrReply) {</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Local) Replying message with key %&quot; PRIu32 &quot; to %&quot; PRIu32 &quot; addresses&quot;, msgKeyToInt(msgKey), count));</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  }</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+</span>
<a href="#l14.146"></a><span id="l14.146">   for (i = 0; i &lt; count; i++) {</span>
<a href="#l14.147"></a><span id="l14.147">     if (!m_replyTemplateUri[i].IsEmpty()) {</span>
<a href="#l14.148"></a><span id="l14.148">       // copy this and truncate the original, so we don't accidentally re-use it</span>
<a href="#l14.149"></a><span id="l14.149">       // on the next hdr.</span>
<a href="#l14.150"></a><span id="l14.150">       rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l14.151"></a><span id="l14.151">       if (server) {</span>
<a href="#l14.152"></a><span id="l14.152">         nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l14.153"></a><span id="l14.153">             do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID);</span>
<a href="#l14.154"></a><span id="l14.154">         if (compService) {</span>
<a href="#l14.155"></a><span id="l14.155">           rv = compService-&gt;ReplyWithTemplate(m_msgToForwardOrReply,</span>
<a href="#l14.156"></a><span id="l14.156">                                               m_replyTemplateUri[i].get(),</span>
<a href="#l14.157"></a><span id="l14.157">                                               msgWindow, server);</span>
<a href="#l14.158"></a><span id="l14.158">           if (NS_FAILED(rv)) {</span>
<a href="#l14.159"></a><span id="l14.159">             NS_WARNING(&quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error, (&quot;(Local) Replying failed&quot;));</span>
<a href="#l14.161"></a><span id="l14.161">             if (rv == NS_ERROR_ABORT) {</span>
<a href="#l14.162"></a><span id="l14.162">               (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l14.163"></a><span id="l14.163">                   m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l14.164"></a><span id="l14.164">                   NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l14.165"></a><span id="l14.165">             } else {</span>
<a href="#l14.166"></a><span id="l14.166">               (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l14.167"></a><span id="l14.167">                   m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l14.168"></a><span id="l14.168">                   NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -54,18 +54,23 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+using namespace mozilla;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+</span>
<a href="#l15.19"></a><span id="l15.19"> // update status on header download once per second</span>
<a href="#l15.20"></a><span id="l15.20"> #define MIN_STATUS_UPDATE_INTERVAL PRTime(PR_USEC_PER_SEC)</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> nsNNTPNewsgroupList::nsNNTPNewsgroupList()</span>
<a href="#l15.23"></a><span id="l15.23">     : m_finishingXover(false),</span>
<a href="#l15.24"></a><span id="l15.24">       m_getOldMessages(false),</span>
<a href="#l15.25"></a><span id="l15.25">       m_promptedAlready(false),</span>
<a href="#l15.26"></a><span id="l15.26">       m_downloadAll(false),</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineat">@@ -561,24 +566,31 @@ NS_IMETHODIMP nsNNTPNewsgroupList::Apply</span>
<a href="#l15.28"></a><span id="l15.28">   NS_ENSURE_ARG_POINTER(aApplyMore);</span>
<a href="#l15.29"></a><span id="l15.29">   NS_ENSURE_TRUE(m_newMsgHdr, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.30"></a><span id="l15.30">   NS_ENSURE_TRUE(m_newsDB, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32">   // you can't move news messages, so applyMore is always true</span>
<a href="#l15.33"></a><span id="l15.33">   *aApplyMore = true;</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   nsCOMPtr&lt;nsIArray&gt; filterActionList;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-</span>
<a href="#l15.37"></a><span id="l15.37">   nsresult rv = aFilter-&gt;GetSortedActionList(getter_AddRefs(filterActionList));</span>
<a href="#l15.38"></a><span id="l15.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40">   uint32_t numActions;</span>
<a href="#l15.41"></a><span id="l15.41">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l15.42"></a><span id="l15.42">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  nsCString msgId;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  m_newMsgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(News) Applying filter actions on message with key %&quot; PRIu32,</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+                                            msgKeyToInt(msgKey)));</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(News) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52">   bool loggingEnabled = false;</span>
<a href="#l15.53"></a><span id="l15.53">   nsCOMPtr&lt;nsIMsgFilterList&gt; currentFilterList;</span>
<a href="#l15.54"></a><span id="l15.54">   rv = aFilter-&gt;GetFilterList(getter_AddRefs(currentFilterList));</span>
<a href="#l15.55"></a><span id="l15.55">   if (NS_SUCCEEDED(rv) &amp;&amp; currentFilterList &amp;&amp; numActions)</span>
<a href="#l15.56"></a><span id="l15.56">     currentFilterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l15.59"></a><span id="l15.59">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -978,16 +990,20 @@ nsresult nsNNTPNewsgroupList::CallFilter</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62">   uint32_t serverFilterCount = 0;</span>
<a href="#l15.63"></a><span id="l15.63">   if (m_serverFilterList) {</span>
<a href="#l15.64"></a><span id="l15.64">     rv = m_serverFilterList-&gt;GetFilterCount(&amp;serverFilterCount);</span>
<a href="#l15.65"></a><span id="l15.65">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.66"></a><span id="l15.66">   }</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">   uint32_t count = m_newHeaders.Count();</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  nsString folderName;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  folder-&gt;GetPrettyName(folderName);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(News) Running filters on %&quot; PRIu32 &quot; new messages in folder '%s'&quot;,</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                                            count, NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74">   // Notify MsgFolderListeners of message adds</span>
<a href="#l15.75"></a><span id="l15.75">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l15.76"></a><span id="l15.76">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78">   for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l15.79"></a><span id="l15.79">     m_newMsgHdr = m_newHeaders[i];</span>
<a href="#l15.80"></a><span id="l15.80">     if (!filterCount &amp;&amp; !serverFilterCount) {</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineat">@@ -1035,21 +1051,23 @@ nsresult nsNNTPNewsgroupList::CallFilter</span>
<a href="#l15.82"></a><span id="l15.82">         fullHeaders += '\0';</span>
<a href="#l15.83"></a><span id="l15.83">       }</span>
<a href="#l15.84"></a><span id="l15.84">     }</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86">     // The per-newsgroup filters should go first. If something stops filter</span>
<a href="#l15.87"></a><span id="l15.87">     // execution, then users should be able to override the global filters in</span>
<a href="#l15.88"></a><span id="l15.88">     // the per-newsgroup filters.</span>
<a href="#l15.89"></a><span id="l15.89">     if (filterCount) {</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(News) Running filters from current newsgroup&quot;));</span>
<a href="#l15.91"></a><span id="l15.91">       rv = m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::NewsRule,</span>
<a href="#l15.92"></a><span id="l15.92">                                            m_newMsgHdr, folder, m_newsDB,</span>
<a href="#l15.93"></a><span id="l15.93">                                            fullHeaders, this, m_msgWindow);</span>
<a href="#l15.94"></a><span id="l15.94">     }</span>
<a href="#l15.95"></a><span id="l15.95">     if (serverFilterCount) {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(News) Running filters from parent server&quot;));</span>
<a href="#l15.97"></a><span id="l15.97">       rv = m_serverFilterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l15.98"></a><span id="l15.98">           nsMsgFilterType::NewsRule, m_newMsgHdr, folder, m_newsDB, fullHeaders,</span>
<a href="#l15.99"></a><span id="l15.99">           this, m_msgWindow);</span>
<a href="#l15.100"></a><span id="l15.100">     }</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">     if (m_addHdrToDB) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -46,16 +46,22 @@ filterActionItem=%1$S. %2$S %3$S\n</span>
<a href="#l16.4"></a><span id="l16.4"> # %1$S=author, %2$S=subject, %3$S=date</span>
<a href="#l16.5"></a><span id="l16.5"> junkLogDetectStr=Detected junk message from %1$S - %2$S at %3$S</span>
<a href="#l16.6"></a><span id="l16.6"> # LOCALIZATION NOTE(logMoveStr)</span>
<a href="#l16.7"></a><span id="l16.7"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l16.8"></a><span id="l16.8"> logMoveStr=moved message id = %1$S to %2$S</span>
<a href="#l16.9"></a><span id="l16.9"> # LOCALIZATION NOTE(logCopyStr)</span>
<a href="#l16.10"></a><span id="l16.10"> # %1$S=message id, %2$S=folder URI</span>
<a href="#l16.11"></a><span id="l16.11"> logCopyStr=copied message id = %1$S to %2$S</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+# LOCALIZATION NOTE(filterLogLine):</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+# %1$S=timestamp %2$S=log message</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+filterLogLine=[%1$S] %2$S</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+# LOCALIZATION NOTE(filterMessage):</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+# %1$S=filter name, %1$S=log message</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+filterMessage=Message from filter &quot;%1$S&quot;: %2$S</span>
<a href="#l16.18"></a><span id="l16.18"> # LOCALIZATION NOTE(filterLogDetectStr)</span>
<a href="#l16.19"></a><span id="l16.19"> # %1$S=filter name %2$S=author, %3$S=subject, %4$S=date</span>
<a href="#l16.20"></a><span id="l16.20"> filterLogDetectStr=Applied filter &quot;%1$S&quot; to message from %2$S - %3$S at %4$S</span>
<a href="#l16.21"></a><span id="l16.21"> filterMissingCustomAction=Missing Custom Action</span>
<a href="#l16.22"></a><span id="l16.22"> filterAction2=priority changed</span>
<a href="#l16.23"></a><span id="l16.23"> filterAction3=deleted</span>
<a href="#l16.24"></a><span id="l16.24"> filterAction4=marked as read</span>
<a href="#l16.25"></a><span id="l16.25"> filterAction5=thread killed</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

