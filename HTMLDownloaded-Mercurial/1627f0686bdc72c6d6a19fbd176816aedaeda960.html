<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5638:1627f0686bdc72c6d6a19fbd176816aedaeda960</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1627f0686bdc72c6d6a19fbd176816aedaeda960" />
<meta property="og:url" content="/comm-central/rev/1627f0686bdc72c6d6a19fbd176816aedaeda960" />
<meta property="og:description" content="Bug 499069 - Clicking on an empty IMAP folder does not display it until headers have been downloaded (flicker, account central shown). v1 change the policy to enter empty folders immediately, test the end-to-end goal. note: new test may experience harmless leak occasionally which would appear to be a test framework/harness issue; we are aware but punting. r=bienvenu. a=blocking-thunderbird3.1" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1627f0686bdc72c6d6a19fbd176816aedaeda960 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1627f0686bdc72c6d6a19fbd176816aedaeda960">shortlog</a> |
<a href="/comm-central/log/1627f0686bdc72c6d6a19fbd176816aedaeda960">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1627f0686bdc72c6d6a19fbd176816aedaeda960">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1627f0686bdc72c6d6a19fbd176816aedaeda960">files</a> |
changeset |
<a href="/comm-central/raw-rev/1627f0686bdc72c6d6a19fbd176816aedaeda960">raw</a>  | <a href="/comm-central/archive/1627f0686bdc72c6d6a19fbd176816aedaeda960.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=499069">Bug 499069</a> - Clicking on an empty IMAP folder does not display it until headers have been downloaded (flicker, account central shown). v1 change the policy to enter empty folders immediately, test the end-to-end goal. note: new test may experience harmless leak occasionally which would appear to be a test framework/harness issue; we are aware but punting. r=bienvenu. a=blocking-thunderbird3.1
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 11 May 2010 00:44:08 -0700</td></tr>

<tr>
 <td>changeset 5638</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1627f0686bdc72c6d6a19fbd176816aedaeda960">1627f0686bdc72c6d6a19fbd176816aedaeda960</a></td>
</tr>



<tr>
<td>parent 5637</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5d4478a6a2f953f903700946e9cb1c36a6859266">5d4478a6a2f953f903700946e9cb1c36a6859266</a>
</td>
</tr>

<tr>
<td>child 5639</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4a6a1e8f4389553eb9f39877d0b263e5d46b2676">4a6a1e8f4389553eb9f39877d0b263e5d46b2676</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1627f0686bdc72c6d6a19fbd176816aedaeda960">4373</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 11 May 2010 07:44:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1627f0686bdc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1627f0686bdc72c6d6a19fbd176816aedaeda960">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1627f0686bdc72c6d6a19fbd176816aedaeda960&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&newProject=comm-central&newRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&newProject=comm-central&newRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&newProject=comm-central&newRevision=1627f0686bdc72c6d6a19fbd176816aedaeda960&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28blocking-thunderbird3.1%29&revcount=50">blocking-thunderbird3.1</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=499069">499069</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=499069">Bug 499069</a> - Clicking on an empty IMAP folder does not display it until headers have been downloaded (flicker, account central shown). v1 change the policy to enter empty folders immediately, test the end-to-end goal. note: new test may experience harmless leak occasionally which would appear to be a test framework/harness issue; we are aware but punting. r=bienvenu. a=blocking-thunderbird3.1</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">mail/base/modules/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/modules/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">mail/base/test/unit/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">mail/base/test/unit/test_viewWrapper_imapFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">file</a> |
<a href="/comm-central/annotate/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">annotate</a> |
<a href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">diff</a> |
<a href="/comm-central/comparison/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">comparison</a> |
<a href="/comm-central/log/1627f0686bdc72c6d6a19fbd176816aedaeda960/mail/base/test/unit/test_viewWrapper_imapFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/1627f0686bdc72c6d6a19fbd176816aedaeda960/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/dbViewWrapper.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/dbViewWrapper.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -910,23 +910,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">       this.listener.onAllMessagesLoaded();</span>
<a href="#l1.5"></a><span id="l1.5">   },</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">    /**</span>
<a href="#l1.8"></a><span id="l1.8">    * Do we want to show the messages immediately, or should we wait for</span>
<a href="#l1.9"></a><span id="l1.9">    *  updateFolder to complete?  The historical heuristic is:</span>
<a href="#l1.10"></a><span id="l1.10">    * - Virtual folders get shown immediately (and updateFolder has no</span>
<a href="#l1.11"></a><span id="l1.11">    *   meaning for them anyways.)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-   * - A folder for which &quot;manyHeadersToDownload&quot; is true waits on</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-   *   updateFolder.  It will return true if the database does not yet exist</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-   *   (presumably because the user has never looked in the folder), or if the</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-   *   database exists and the number of total messages (current and pending)</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-   *   is &lt;= 0 (which I presume means no messages or a bunch pending</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-   *   deletion?)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-   *   If _underlyingFolders == null, we failed to open the database,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+   * - If _underlyingFolders == null, we failed to open the database,</span>
<a href="#l1.20"></a><span id="l1.20">    *   so we need to wait for UpdateFolder to reparse the folder (in the</span>
<a href="#l1.21"></a><span id="l1.21">    *   local folder case).</span>
<a href="#l1.22"></a><span id="l1.22">    * - Wait on updateFolder if our poor man's security via</span>
<a href="#l1.23"></a><span id="l1.23">    *   &quot;mail.password_protect_local_cache&quot; preference is enabled and the</span>
<a href="#l1.24"></a><span id="l1.24">    *   server requires a password to login.  This is accomplished by asking our</span>
<a href="#l1.25"></a><span id="l1.25">    *   listener via shouldDeferMessageDisplayUntilAfterServerConnect.  Note that</span>
<a href="#l1.26"></a><span id="l1.26">    *   there is an obvious hole in this logic because of the virtual folder case</span>
<a href="#l1.27"></a><span id="l1.27">    *   above.</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -934,18 +928,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l1.29"></a><span id="l1.29">    * @pre this.folderDisplayed is the folder we are talking about.</span>
<a href="#l1.30"></a><span id="l1.30">    *</span>
<a href="#l1.31"></a><span id="l1.31">    * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l1.32"></a><span id="l1.32">    *     wait for updateFolder to complete.</span>
<a href="#l1.33"></a><span id="l1.33">    */</span>
<a href="#l1.34"></a><span id="l1.34">   shouldShowMessagesForFolderImmediately:</span>
<a href="#l1.35"></a><span id="l1.35">       function DBViewWrapper_showShowMessagesForFolderImmediately() {</span>
<a href="#l1.36"></a><span id="l1.36">     return (this.isVirtual ||</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-            !(this.displayedFolder.manyHeadersToDownload ||</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-              this._underlyingFolders == null ||</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+            !(this._underlyingFolders == null ||</span>
<a href="#l1.40"></a><span id="l1.40">               this.listener.shouldDeferMessageDisplayUntilAfterServerConnect));</span>
<a href="#l1.41"></a><span id="l1.41">   },</span>
<a href="#l1.42"></a><span id="l1.42">   /**</span>
<a href="#l1.43"></a><span id="l1.43">    * Extract information about the view from the dbFolderInfo (e.g., sort type,</span>
<a href="#l1.44"></a><span id="l1.44">    * sort order, current view flags, etc), and save in the view wrapper.</span>
<a href="#l1.45"></a><span id="l1.45">    */</span>
<a href="#l1.46"></a><span id="l1.46">   _prepareToLoadView:</span>
<a href="#l1.47"></a><span id="l1.47">       function DBViewWrapper_prepareToLoadView(msgDatabase, aFolder) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -34,30 +34,32 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> Components.utils.import(&quot;resource:///modules/dbViewWrapper.js&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> Components.utils.import(&quot;resource:///modules/mailViewManager.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Components.utils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+var gInbox;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> /**</span>
<a href="#l2.15"></a><span id="l2.15">  * Do initialization for xpcshell-tests; not used by</span>
<a href="#l2.16"></a><span id="l2.16">  *  test-folder-display-helpers.js, our friendly mozmill test helper.</span>
<a href="#l2.17"></a><span id="l2.17">  */</span>
<a href="#l2.18"></a><span id="l2.18"> function initViewWrapperTestUtils(aInjectionConfig) {</span>
<a href="#l2.19"></a><span id="l2.19">   gMessageGenerator = new MessageGenerator();</span>
<a href="#l2.20"></a><span id="l2.20">   gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l2.23"></a><span id="l2.23">   register_message_injection_listener(VWTU_testHelper);</span>
<a href="#l2.24"></a><span id="l2.24">   if (aInjectionConfig)</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    configure_message_injection(aInjectionConfig);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    gInbox = configure_message_injection(aInjectionConfig);</span>
<a href="#l2.27"></a><span id="l2.27">   else</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-    configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    gInbox = configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l2.30"></a><span id="l2.30"> }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> // something less sucky than do_check_true</span>
<a href="#l2.33"></a><span id="l2.33"> function assert_true(aBeTrue, aWhy, aDumpView) {</span>
<a href="#l2.34"></a><span id="l2.34">   if (!aBeTrue) {</span>
<a href="#l2.35"></a><span id="l2.35">     if (aDumpView)</span>
<a href="#l2.36"></a><span id="l2.36">       dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l2.37"></a><span id="l2.37">     do_throw(aWhy);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/base/test/unit/test_viewWrapper_imapFolder.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,60 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/**</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * Test DBViewWrapper against a single imap folder.  Try and test all the</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *  features we can without having a fake newsgroup.  (Some features are</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ *  newsgroup specific.)</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ */</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+load(&quot;../../mailnews/resources/logHelper.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+load(&quot;../../mailnews/resources/messageInjection.js&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+load(&quot;resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+initViewWrapperTestUtils({mode: &quot;imap&quot;, offline: false});</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+/**</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Create an empty folder, inject messages into it without triggering an</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ *  updateFolder, sanity check that we believe there are no messages in the</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ *  folder, then enter, making sure we immediately enter and that the view</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *  properly updates to reflect there being the right set of messages.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * (It will fail to update if the db change listener ended up detaching itself</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *  and not reattaching correctly when the updateFolder completes.)</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ */</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+function test_enter_imap_folder_requiring_update_folder_immediately() {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  // - create the folder and wait for the IMAP op to complete</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  let folderHandle = make_empty_folder();</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  yield wait_for_async_promises();</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  let msgFolder = get_real_injection_folder(folderHandle);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  // - add the messages</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  let [msgSet] = make_new_sets_in_folder(folderHandle, [{count: 1}], true);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  yield wait_for_message_injection();</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  // - make sure we don't know about the message!</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  do_check_eq(msgFolder.getTotalMessages(false), 0);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  // - sync open the folder, verify we claim we entered, and make sure it has</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  //  nothing in it!</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  viewWrapper.listener.pendingLoad = true;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  viewWrapper.open(msgFolder);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  do_check_true(viewWrapper._enteredFolder);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  verify_empty_view(viewWrapper);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  // - async wait for all the messages to load</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  yield false;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  // - make sure the view sees the message though...</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  verify_messages_in_view(msgSet, viewWrapper);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+}</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+var tests = [</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  test_enter_imap_folder_requiring_update_folder_immediately,</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+];</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+function run_test() {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -513,20 +513,24 @@ function make_folders_with_sets(aFolderC</span>
<a href="#l4.4"></a><span id="l4.4">  * Given one or more existing local folder, create new message sets and add them</span>
<a href="#l4.5"></a><span id="l4.5">  *  to the folders using</span>
<a href="#l4.6"></a><span id="l4.6">  *</span>
<a href="#l4.7"></a><span id="l4.7">  * @param aMsgFolders A single nsIMsgLocalMailFolder or a list of them.  The</span>
<a href="#l4.8"></a><span id="l4.8">  *     synthetic messages will be added to the folder(s).</span>
<a href="#l4.9"></a><span id="l4.9">  * @param aSynSetDefs Either an integer describing the number of sets of</span>
<a href="#l4.10"></a><span id="l4.10">  *     messages to create (using default parameters), or a list of set</span>
<a href="#l4.11"></a><span id="l4.11">  *     definition objects as defined by MessageGenerator.makeMessages.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * @param [aDoNotForceUpdate=false] By default we force an updateFolder on IMAP</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *     folders to ensure Thunderbird knows about the newly injected messages.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ *     If you are testing Thunderbird's use of updateFolder itself, you will</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ *     not want this and so will want to pass true for this argument.</span>
<a href="#l4.16"></a><span id="l4.16">  * @return A list of SyntheticMessageSet objects, each corresponding to the</span>
<a href="#l4.17"></a><span id="l4.17">  *     entry in aSynSetDefs (or implied if an integer was passed).</span>
<a href="#l4.18"></a><span id="l4.18">  */</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-function make_new_sets_in_folders(aMsgFolders, aSynSetDefs) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+function make_new_sets_in_folders(aMsgFolders, aSynSetDefs, aDoNotForceUpdate) {</span>
<a href="#l4.21"></a><span id="l4.21">   // is it just a count of the number of plain vanilla sets to create?</span>
<a href="#l4.22"></a><span id="l4.22">   if (typeof(aSynSetDefs) == &quot;number&quot;) {</span>
<a href="#l4.23"></a><span id="l4.23">     let setCount = aSynSetDefs;</span>
<a href="#l4.24"></a><span id="l4.24">     aSynSetDefs = [];</span>
<a href="#l4.25"></a><span id="l4.25">     for (let iSet = 0; iSet &lt; setCount; iSet++)</span>
<a href="#l4.26"></a><span id="l4.26">       aSynSetDefs.push({});</span>
<a href="#l4.27"></a><span id="l4.27">   }</span>
<a href="#l4.28"></a><span id="l4.28">   // now it must be a list of set descriptors</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -534,17 +538,17 @@ function make_new_sets_in_folders(aMsgFo</span>
<a href="#l4.30"></a><span id="l4.30">   // - create the synthetic message sets</span>
<a href="#l4.31"></a><span id="l4.31">   let messageSets = [];</span>
<a href="#l4.32"></a><span id="l4.32">   for each (let [, synSetDef] in Iterator(aSynSetDefs)) {</span>
<a href="#l4.33"></a><span id="l4.33">     let messages = gMessageGenerator.makeMessages(synSetDef);</span>
<a href="#l4.34"></a><span id="l4.34">     messageSets.push(new SyntheticMessageSet(messages));</span>
<a href="#l4.35"></a><span id="l4.35">   }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // - add the messages to the folders (interleaving them)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  add_sets_to_folders(aMsgFolders, messageSets);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  add_sets_to_folders(aMsgFolders, messageSets, aDoNotForceUpdate);</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">   return messageSets;</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> /** singular folder alias for single-folder users' readability */</span>
<a href="#l4.44"></a><span id="l4.44"> let make_new_sets_in_folder = make_new_sets_in_folders;</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> /**</span>
<a href="#l4.47"></a><span id="l4.47">  * An iterator that generates an infinite sequence of its argument.  So</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -581,23 +585,27 @@ function _looperator(aList) {</span>
<a href="#l4.49"></a><span id="l4.49">  * across 3 folders:</span>
<a href="#l4.50"></a><span id="l4.50">  *  folder 1: [a A d D G]</span>
<a href="#l4.51"></a><span id="l4.51">  *  folder 2: [b B e E H]</span>
<a href="#l4.52"></a><span id="l4.52">  *  folder 3: [c C f F]</span>
<a href="#l4.53"></a><span id="l4.53">  *</span>
<a href="#l4.54"></a><span id="l4.54">  * @param aMsgFolders An nsIMsgLocalMailFolder to add the message sets to or a</span>
<a href="#l4.55"></a><span id="l4.55">  *     list of them.</span>
<a href="#l4.56"></a><span id="l4.56">  * @param aMessageSets A list of SyntheticMessageSets.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+ * @param [aDoNotForceUpdate=false] By default we force an updateFolder on IMAP</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+ *     folders to ensure Thunderbird knows about the newly injected messages.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ *     If you are testing Thunderbird's use of updateFolder itself, you will</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ *     not want this and so will want to pass true for this argument.</span>
<a href="#l4.61"></a><span id="l4.61">  *</span>
<a href="#l4.62"></a><span id="l4.62">  * @return true if we were able to do the injection synchronously (e.g. for</span>
<a href="#l4.63"></a><span id="l4.63">  *     a localstore account), false if we kicked off an asynchronous process</span>
<a href="#l4.64"></a><span id="l4.64">  *     (e.g. for an imap account) and we will call |async_driver| when</span>
<a href="#l4.65"></a><span id="l4.65">  *     we are done.  This is consistent with asyncTestUtils support.</span>
<a href="#l4.66"></a><span id="l4.66">  */</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-function add_sets_to_folders(aMsgFolders, aMessageSets) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+function add_sets_to_folders(aMsgFolders, aMessageSets, aDoNotForceUpdate) {</span>
<a href="#l4.69"></a><span id="l4.69">   if ((typeof(aMsgFolders) == &quot;string&quot;) || !('length' in aMsgFolders))</span>
<a href="#l4.70"></a><span id="l4.70">     aMsgFolders = [aMsgFolders];</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">   let mis = _messageInjectionSetup;</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   let iterFolders, folderList;</span>
<a href="#l4.75"></a><span id="l4.75">   let ioService, popMessages, msgHdrs;</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77" class="difflineat">@@ -710,16 +718,21 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l4.78"></a><span id="l4.78">               imapMsg.setFlag(&quot;\\Seen&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">             fakeFolder.addMessage(imapMsg);</span>
<a href="#l4.80"></a><span id="l4.80">           }</span>
<a href="#l4.81"></a><span id="l4.81">         }</span>
<a href="#l4.82"></a><span id="l4.82">         iPerSet++;</span>
<a href="#l4.83"></a><span id="l4.83">         folder = iterFolders.next();</span>
<a href="#l4.84"></a><span id="l4.84">       } while (didSomething);</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+      // We have nothing more to do if we aren't support to force the update.</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+      if (aDoNotForceUpdate)</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+        return;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+</span>
<a href="#l4.91"></a><span id="l4.91">       for (let iFolder = 0; iFolder &lt; aMsgFolders.length; iFolder++) {</span>
<a href="#l4.92"></a><span id="l4.92">         let realFolder = mis.handleUriToRealFolder[aMsgFolders[iFolder]];</span>
<a href="#l4.93"></a><span id="l4.93">         mark_action(&quot;messageInjection&quot;, &quot;forcing update of folder&quot;,</span>
<a href="#l4.94"></a><span id="l4.94">                     [realFolder]);</span>
<a href="#l4.95"></a><span id="l4.95">         updateFolderAndNotify(realFolder, async_driver);</span>
<a href="#l4.96"></a><span id="l4.96">         yield false;</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">         // compel download of the messages if appropriate</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineat">@@ -744,16 +757,18 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l4.100"></a><span id="l4.100">           didSomething = true;</span>
<a href="#l4.101"></a><span id="l4.101">         }</span>
<a href="#l4.102"></a><span id="l4.102">       }</span>
<a href="#l4.103"></a><span id="l4.103">       iPerSet++;</span>
<a href="#l4.104"></a><span id="l4.104">       folder = iterFolders.next();</span>
<a href="#l4.105"></a><span id="l4.105">     } while (didSomething);</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">     ims.daemon.setMessages(_synthMessagesToFakeRep(popMessages));</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    if (aDoNotForceUpdate)</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      return true;</span>
<a href="#l4.110"></a><span id="l4.110">     ims.pop3Service.GetNewMail(null, asyncUrlListener, mis.inboxFolder,</span>
<a href="#l4.111"></a><span id="l4.111">                                mis.incomingServer);</span>
<a href="#l4.112"></a><span id="l4.112">     return false; // wait for the url listener to be notified</span>
<a href="#l4.113"></a><span id="l4.113">   }</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115">   return true;</span>
<a href="#l4.116"></a><span id="l4.116"> };</span>
<a href="#l4.117"></a><span id="l4.117"> /** singular function name for understandability of single-folder users */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

