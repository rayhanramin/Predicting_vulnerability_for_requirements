<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5609:ef67aa880d3657ac34d10d7d9dc2a3c590314cc9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ef67aa880d3657ac34d10d7d9dc2a3c590314cc9" />
<meta property="og:url" content="/comm-central/rev/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9" />
<meta property="og:description" content="Fix bug 463392 - caldav calendars are not visible in the 'select calendar' dialog. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ef67aa880d3657ac34d10d7d9dc2a3c590314cc9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">shortlog</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">files</a> |
changeset |
<a href="/comm-central/raw-rev/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">raw</a>  | <a href="/comm-central/archive/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463392">bug 463392</a> - caldav calendars are not visible in the 'select calendar' dialog. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#109;&#111;&#110;&#32;&#86;&#97;&#105;&#108;&#108;&#97;&#110;&#99;&#111;&#117;&#114;&#116;&#32;&#60;&#115;&#105;&#109;&#111;&#110;&#46;&#97;&#116;&#46;&#111;&#114;&#99;&#108;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 07 May 2010 14:39:00 +0200</td></tr>

<tr>
 <td>changeset 5609</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">ef67aa880d3657ac34d10d7d9dc2a3c590314cc9</a></td>
</tr>



<tr>
<td>parent 5608</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0f01091253c9a329718852d7d6a8a91d089e6a4b">0f01091253c9a329718852d7d6a8a91d089e6a4b</a>
</td>
</tr>

<tr>
<td>child 5610</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6f195902e307fb410a1c7a95ac70cb36efd3c12a">6f195902e307fb410a1c7a95ac70cb36efd3c12a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">4351</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 08 May 2010 09:28:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ef67aa880d36 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&newProject=comm-central&newRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&newProject=comm-central&newRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&newProject=comm-central&newRevision=ef67aa880d3657ac34d10d7d9dc2a3c590314cc9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463392">463392</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=463392">bug 463392</a> - caldav calendars are not visible in the 'select calendar' dialog. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">calendar/base/content/dialogs/chooseCalendarDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/content/dialogs/chooseCalendarDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">calendar/base/public/calICalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/base/public/calICalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">calendar/libical/design-data/parameters.csv</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/parameters.csv">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">calendar/libical/design-data/params-in-prop.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/libical/design-data/params-in-prop.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">calendar/locales/en-US/chrome/lightning/lightning.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/locales/en-US/chrome/lightning/lightning.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/ef67aa880d3657ac34d10d7d9dc2a3c590314cc9/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/dialogs/chooseCalendarDialog.xul</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/dialogs/chooseCalendarDialog.xul</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -45,17 +45,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &lt;!ENTITY % dtd1 SYSTEM &quot;chrome://calendar/locale/calendar.dtd&quot; &gt; %dtd1;</span>
<a href="#l1.5"></a><span id="l1.5"> ]&gt;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> &lt;dialog id=&quot;chooseCalendar&quot;</span>
<a href="#l1.8"></a><span id="l1.8">         title=&quot;&amp;calendar.select.dialog.title;&quot;</span>
<a href="#l1.9"></a><span id="l1.9">         windowtype=&quot;Calendar:CalendarPicker&quot;</span>
<a href="#l1.10"></a><span id="l1.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l1.11"></a><span id="l1.11">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        onload=&quot;loadCalendars();&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        onload=&quot;setTimeout('loadCalendars()',0);&quot;</span>
<a href="#l1.14"></a><span id="l1.14">         ondialogaccept=&quot;return doOK();&quot;</span>
<a href="#l1.15"></a><span id="l1.15">         persist=&quot;screenX screenY height width&quot;&gt;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">     &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l1.18"></a><span id="l1.18">     &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l1.19"></a><span id="l1.19">         function loadCalendars() {</span>
<a href="#l1.20"></a><span id="l1.20">             const calendarManager = Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l1.21"></a><span id="l1.21">                                             .getService(Components.interfaces.calICalendarManager);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l2.5"></a><span id="l2.5">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.6"></a><span id="l2.6">  *</span>
<a href="#l2.7"></a><span id="l2.7">  * Contributor(s):</span>
<a href="#l2.8"></a><span id="l2.8">  *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l2.9"></a><span id="l2.9">  *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l2.10"></a><span id="l2.10">  *   Clint Talbert &lt;ctalbert.moz@gmail.com&gt;</span>
<a href="#l2.11"></a><span id="l2.11">  *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *   Simon Vaillancourt &lt;simon.at.orcl@gmail.com&gt;</span>
<a href="#l2.13"></a><span id="l2.13">  *</span>
<a href="#l2.14"></a><span id="l2.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.15"></a><span id="l2.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.16"></a><span id="l2.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.17"></a><span id="l2.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.18"></a><span id="l2.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.19"></a><span id="l2.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.20"></a><span id="l2.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -562,17 +563,17 @@ function sendMessage(aItem, aMethod, aRe</span>
<a href="#l2.22"></a><span id="l2.22">     aTransport.sendItems(aRecipientsList.length, aRecipientsList, itipItem);</span>
<a href="#l2.23"></a><span id="l2.23"> }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> /** local to this module file</span>
<a href="#l2.26"></a><span id="l2.26">  * An operation listener that is used on calendar operations which checks and sends further iTIP</span>
<a href="#l2.27"></a><span id="l2.27">  * messages based on the calendar action.</span>
<a href="#l2.28"></a><span id="l2.28">  *</span>
<a href="#l2.29"></a><span id="l2.29">  * @param opListener operation listener to forward</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">- * @param oldItem the previous item before modification (if any) </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+ * @param oldItem the previous item before modification (if any)</span>
<a href="#l2.32"></a><span id="l2.32">  */</span>
<a href="#l2.33"></a><span id="l2.33"> function ItipOpListener(opListener, oldItem) {</span>
<a href="#l2.34"></a><span id="l2.34">     this.mOpListener = opListener;</span>
<a href="#l2.35"></a><span id="l2.35">     this.mOldItem = oldItem;</span>
<a href="#l2.36"></a><span id="l2.36"> }</span>
<a href="#l2.37"></a><span id="l2.37"> ItipOpListener.prototype = {</span>
<a href="#l2.38"></a><span id="l2.38">     onOperationComplete: function ItipOpListener_onOperationComplete(aCalendar,</span>
<a href="#l2.39"></a><span id="l2.39">                                                                      aStatus,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -596,16 +597,32 @@ ItipOpListener.prototype = {</span>
<a href="#l2.41"></a><span id="l2.41">                                                      aItemType,</span>
<a href="#l2.42"></a><span id="l2.42">                                                      aDetail,</span>
<a href="#l2.43"></a><span id="l2.43">                                                      aCount,</span>
<a href="#l2.44"></a><span id="l2.44">                                                      aItems) {</span>
<a href="#l2.45"></a><span id="l2.45">     }</span>
<a href="#l2.46"></a><span id="l2.46"> };</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48"> /** local to this module file</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ * Add a the parameter SCHEDULE-AGENT=CLIENT to the item before it is</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ * created or updated so that the providers knows scheduling will</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+ * be handled by the client.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+ *</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+ * @param item item about to be added or updated</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * @param calendar calendar into which the item is about to be added or updated</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ */</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+function addScheduleAgentClient(item, calendar) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+     if (calendar.getProperty(&quot;capabilities.autoschedule.supported&quot;) === true) {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+          if (item.organizer) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+             item.organizer.setProperty(&quot;SCHEDULE-AGENT&quot;,&quot;CLIENT&quot;);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+          }</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+     }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+}</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+/** local to this module file</span>
<a href="#l2.65"></a><span id="l2.65">  * An operation listener triggered by cal.itip.processItipItem() for lookup of the sent iTIP item's UID.</span>
<a href="#l2.66"></a><span id="l2.66">  *</span>
<a href="#l2.67"></a><span id="l2.67">  * @param itipItem sent iTIP item</span>
<a href="#l2.68"></a><span id="l2.68">  * @param optionsFunc options func, see cal.itip.processItipItem()</span>
<a href="#l2.69"></a><span id="l2.69">  */</span>
<a href="#l2.70"></a><span id="l2.70"> function ItipFindItemListener(itipItem, optionsFunc) {</span>
<a href="#l2.71"></a><span id="l2.71">     this.mItipItem = itipItem;</span>
<a href="#l2.72"></a><span id="l2.72">     this.mOptionsFunc = optionsFunc;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineat">@@ -692,16 +709,17 @@ ItipFindItemListener.prototype = {</span>
<a href="#l2.74"></a><span id="l2.74">                                         let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l2.75"></a><span id="l2.75">                                         if (!att) { // fall back to using configured organizer</span>
<a href="#l2.76"></a><span id="l2.76">                                             att = createOrganizer(newItem.calendar);</span>
<a href="#l2.77"></a><span id="l2.77">                                             if (att) {</span>
<a href="#l2.78"></a><span id="l2.78">                                                 att.isOrganizer = false;</span>
<a href="#l2.79"></a><span id="l2.79">                                             }</span>
<a href="#l2.80"></a><span id="l2.80">                                         }</span>
<a href="#l2.81"></a><span id="l2.81">                                         if (att) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+                                            addScheduleAgentClient(newItem, item.calendar);</span>
<a href="#l2.83"></a><span id="l2.83">                                             newItem.removeAttendee(att);</span>
<a href="#l2.84"></a><span id="l2.84">                                             att = att.clone();</span>
<a href="#l2.85"></a><span id="l2.85">                                             let action = function(opListener, partStat) {</span>
<a href="#l2.86"></a><span id="l2.86">                                                 if (!partStat) { // keep PARTSTAT</span>
<a href="#l2.87"></a><span id="l2.87">                                                     let att_ = cal.getInvitedAttendee(item);</span>
<a href="#l2.88"></a><span id="l2.88">                                                     partStat = (att_ ? att_.participationStatus : &quot;NEEDS-ACTION&quot;);</span>
<a href="#l2.89"></a><span id="l2.89">                                                 }</span>
<a href="#l2.90"></a><span id="l2.90">                                                 att.participationStatus = partStat;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineat">@@ -793,16 +811,17 @@ ItipFindItemListener.prototype = {</span>
<a href="#l2.92"></a><span id="l2.92">                 switch (method) {</span>
<a href="#l2.93"></a><span id="l2.93">                     case &quot;REQUEST&quot;:</span>
<a href="#l2.94"></a><span id="l2.94">                     case &quot;PUBLISH&quot;: {</span>
<a href="#l2.95"></a><span id="l2.95">                         let this_ = this;</span>
<a href="#l2.96"></a><span id="l2.96">                         let action = function(opListener, partStat) {</span>
<a href="#l2.97"></a><span id="l2.97">                             let newItem = itipItemItem.clone();</span>
<a href="#l2.98"></a><span id="l2.98">                             setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l2.99"></a><span id="l2.99">                             newItem.parentItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+                            addScheduleAgentClient(newItem, this_.mItipItem.targetCalendar);</span>
<a href="#l2.101"></a><span id="l2.101">                             if (partStat) {</span>
<a href="#l2.102"></a><span id="l2.102">                                 if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l2.103"></a><span id="l2.103">                                     cal.alarms.setDefaultValues(newItem);</span>
<a href="#l2.104"></a><span id="l2.104">                                 }</span>
<a href="#l2.105"></a><span id="l2.105">                                 let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l2.106"></a><span id="l2.106">                                 if (!att) { // fall back to using configured organizer</span>
<a href="#l2.107"></a><span id="l2.107">                                     att = createOrganizer(newItem.calendar);</span>
<a href="#l2.108"></a><span id="l2.108">                                     if (att) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/public/calICalendar.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/public/calICalendar.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -183,16 +183,17 @@ interface calICalendar : nsISupports</span>
<a href="#l3.4"></a><span id="l3.4">    *   capabilities.privacy.supported      Supports a privacy state</span>
<a href="#l3.5"></a><span id="l3.5">    *   capabilities.priority.supported     Supports the priority field</span>
<a href="#l3.6"></a><span id="l3.6">    *   capabilities.events.supported       Supports tasks</span>
<a href="#l3.7"></a><span id="l3.7">    *   capabilities.tasks.supported        Supports events</span>
<a href="#l3.8"></a><span id="l3.8">    *   capabilities.alarms.popup.supported Supports popup alarms</span>
<a href="#l3.9"></a><span id="l3.9">    *   capabilities.alarms.oninviations.supported Supports alarms on inviations.</span>
<a href="#l3.10"></a><span id="l3.10">    *   capabilities.timezones.floating.supported Supports local time</span>
<a href="#l3.11"></a><span id="l3.11">    *   capabilities.timezones.UTC.supported      Supports UTC/GMT timezone</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+   *   capabilities.autoschedule.supported       Supports caldav schedule properties in icalendar (SCHEDULE-AGENT, SCHEDULE-STATUS...)</span>
<a href="#l3.13"></a><span id="l3.13">    *</span>
<a href="#l3.14"></a><span id="l3.14">    * The following capabilities are used to restrict the values for specific</span>
<a href="#l3.15"></a><span id="l3.15">    * fields. An array should be specified with the values, the default</span>
<a href="#l3.16"></a><span id="l3.16">    * values are specified here. Extensions using this need to take care of</span>
<a href="#l3.17"></a><span id="l3.17">    * adding any UI elements needed in an overlay. To make sure the correct</span>
<a href="#l3.18"></a><span id="l3.18">    * elements are shown, those elements should additionally specify an attribute</span>
<a href="#l3.19"></a><span id="l3.19">    * &quot;provider&quot;, with the type of the provider.</span>
<a href="#l3.20"></a><span id="l3.20">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/libical/design-data/parameters.csv</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/libical/design-data/parameters.csv</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -29,8 +29,11 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &quot;#this parameter should really be called ACTION, but this conflicts with the ACTION property&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> &quot;ACTIONPARAM&quot;,&quot;icalparameter_action&quot;,&quot;ASK;ABORT&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> &quot;ID&quot;,&quot;const char*&quot;,</span>
<a href="#l4.7"></a><span id="l4.7"> &quot;ENABLE&quot;,&quot;icalparameter_enable&quot;,&quot;TRUE;FALSE&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> &quot;LATENCY&quot;,&quot;const char*&quot;,</span>
<a href="#l4.9"></a><span id="l4.9"> &quot;LOCAL&quot;,&quot;icalparameter_local&quot;,&quot;TRUE;FALSE&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> &quot;LOCALIZE&quot;,&quot;const char*&quot;,</span>
<a href="#l4.11"></a><span id="l4.11"> &quot;OPTIONS&quot;,&quot;const char*&quot;,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+&quot;SCHEDULE-AGENT&quot;,&quot;const char*&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+&quot;SCHEDULE-STATUS&quot;,&quot;const char*&quot;,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+&quot;SCHEDULE-FORCE-SEND&quot;,&quot;const char*&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/libical/design-data/params-in-prop.txt</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/libical/design-data/params-in-prop.txt</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l5.4"></a><span id="l5.4"> ACTION               VALUE X</span>
<a href="#l5.5"></a><span id="l5.5"> ATTACH               FMTTYPE ENCODING VALUE X</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-ATTENDEE             CN CUTYPE DELEGATED-FROM DELEGATED-TO DIR LANGUAGE MEMBER PARTSTAT ROLE RSVP SENT-BY RECEIVED-SEQUENCE RECEIVED-DTSTAMP X</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ATTENDEE             CN CUTYPE DELEGATED-FROM DELEGATED-TO DIR LANGUAGE MEMBER PARTSTAT ROLE RSVP SENT-BY RECEIVED-SEQUENCE RECEIVED-DTSTAMP SCHEDULE-STATUS SCHEDULE-AGENT SCHEDULE-FORCE-SEND X</span>
<a href="#l5.8"></a><span id="l5.8"> CALSCALE             X</span>
<a href="#l5.9"></a><span id="l5.9"> CATEGORIES           LANGUAGE X</span>
<a href="#l5.10"></a><span id="l5.10"> CLASS                X</span>
<a href="#l5.11"></a><span id="l5.11"> CMD		     ACTIONPARAM ID LATENCY LOCALIZE OPTIONS X</span>
<a href="#l5.12"></a><span id="l5.12"> COMMENT              ALTREP LANGUAGE X</span>
<a href="#l5.13"></a><span id="l5.13"> COMPLETED            X</span>
<a href="#l5.14"></a><span id="l5.14"> CONTACT              ALTREP LANGUAGE X</span>
<a href="#l5.15"></a><span id="l5.15"> CREATED              X</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineat">@@ -17,17 +17,17 @@ DUE                  VALUE TZID X</span>
<a href="#l5.17"></a><span id="l5.17"> DURATION             X</span>
<a href="#l5.18"></a><span id="l5.18"> EXDATE               VALUE TZID X</span>
<a href="#l5.19"></a><span id="l5.19"> EXRULE               X</span>
<a href="#l5.20"></a><span id="l5.20"> FREEBUSY             FBTYPE X</span>
<a href="#l5.21"></a><span id="l5.21"> GEO                  X</span>
<a href="#l5.22"></a><span id="l5.22"> LAST-MODIFIED        X</span>
<a href="#l5.23"></a><span id="l5.23"> LOCATION             ALTREP LANGUAGE X</span>
<a href="#l5.24"></a><span id="l5.24"> METHOD               X</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-ORGANIZER            CN DIR LANGUAGE SENT-BY X</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ORGANIZER            CN DIR LANGUAGE SENT-BY SCHEDULE-STATUS SCHEDULE-AGENT SCHEDULE-FORCE-SEND X</span>
<a href="#l5.27"></a><span id="l5.27"> PERCENT-COMPLETE     X</span>
<a href="#l5.28"></a><span id="l5.28"> PRIORITY             X</span>
<a href="#l5.29"></a><span id="l5.29"> PRODID               X</span>
<a href="#l5.30"></a><span id="l5.30"> RDATE                VALUE TZID X</span>
<a href="#l5.31"></a><span id="l5.31"> RECURRENCE-ID        VALUE RANGE TZID X</span>
<a href="#l5.32"></a><span id="l5.32"> RELATED-TO           RELTYPE X</span>
<a href="#l5.33"></a><span id="l5.33"> REPEAT               X</span>
<a href="#l5.34"></a><span id="l5.34"> REQUEST-STATUS       LANGUAGE X</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.5"></a><span id="l6.5">  *</span>
<a href="#l6.6"></a><span id="l6.6">  * Contributor(s):</span>
<a href="#l6.7"></a><span id="l6.7">  *   Clint Talbert &lt;ctalbert.moz@gmail.com&gt;</span>
<a href="#l6.8"></a><span id="l6.8">  *   Matthew Willis &lt;lilmatt@mozilla.com&gt;</span>
<a href="#l6.9"></a><span id="l6.9">  *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l6.10"></a><span id="l6.10">  *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l6.11"></a><span id="l6.11">  *   Martin Schroeder &lt;mschroeder@mozilla.x-home.org&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *   Simon Vaillancourt &lt;simon.at.orcl@gmail.com&gt;</span>
<a href="#l6.13"></a><span id="l6.13">  *</span>
<a href="#l6.14"></a><span id="l6.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.15"></a><span id="l6.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.16"></a><span id="l6.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.17"></a><span id="l6.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.18"></a><span id="l6.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.19"></a><span id="l6.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.20"></a><span id="l6.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -374,32 +375,35 @@ function ltnItipOptions(itipItem, rc, ac</span>
<a href="#l6.22"></a><span id="l6.22">     } else {</span>
<a href="#l6.23"></a><span id="l6.23">         imipBar.setAttribute(&quot;label&quot;, ltnGetString(&quot;lightning&quot;, &quot;imipBarUnsupportedText&quot;));</span>
<a href="#l6.24"></a><span id="l6.24">     }</span>
<a href="#l6.25"></a><span id="l6.25"> }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> function ltnGetTargetCalendar(itipItem) {</span>
<a href="#l6.28"></a><span id="l6.28">     let calendarToReturn = null;</span>
<a href="#l6.29"></a><span id="l6.29">     let calendars = getCalendarManager().getCalendars({}).filter(ltnIsSchedulingCalendar);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    // XXXNeed an error message if there is no calendar</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">     if (itipItem.receivedMethod == &quot;REQUEST&quot;) {</span>
<a href="#l6.33"></a><span id="l6.33">         // try to further limit down the list to those calendars that are configured to a matching attendee;</span>
<a href="#l6.34"></a><span id="l6.34">         let item = itipItem.getItemList({})[0];</span>
<a href="#l6.35"></a><span id="l6.35">         let matchingCals = calendars.filter(</span>
<a href="#l6.36"></a><span id="l6.36">             function(calendar) {</span>
<a href="#l6.37"></a><span id="l6.37">                 return (cal.getInvitedAttendee(item, calendar) != null);</span>
<a href="#l6.38"></a><span id="l6.38">             });</span>
<a href="#l6.39"></a><span id="l6.39">         // if there's none, we will show the whole list of calendars:</span>
<a href="#l6.40"></a><span id="l6.40">         if (matchingCals.length &gt; 0) {</span>
<a href="#l6.41"></a><span id="l6.41">             calendars = matchingCals;</span>
<a href="#l6.42"></a><span id="l6.42">         }</span>
<a href="#l6.43"></a><span id="l6.43">     }</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    if (calendars.length == 1) {</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    if (calendars.length == 0) {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        var stringBundle = getLightningStringBundle();</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+        window.alert(stringBundle.GetStringFromName(&quot;imipNoCalendarAvailable&quot;));</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    }</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    else if (calendars.length == 1) {</span>
<a href="#l6.51"></a><span id="l6.51">         // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l6.52"></a><span id="l6.52">         // the user wants to import into.</span>
<a href="#l6.53"></a><span id="l6.53">         calendarToReturn = calendars[0];</span>
<a href="#l6.54"></a><span id="l6.54">     } else {</span>
<a href="#l6.55"></a><span id="l6.55">         // Ask what calendar to import into</span>
<a href="#l6.56"></a><span id="l6.56">         var args = {};</span>
<a href="#l6.57"></a><span id="l6.57">         args.calendars = calendars;</span>
<a href="#l6.58"></a><span id="l6.58">         args.onOk = function selectCalendar(aCal) { calendarToReturn = aCal; };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/locales/en-US/chrome/lightning/lightning.properties</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -79,16 +79,17 @@ imipCancelInvitation.label=Delete</span>
<a href="#l7.4"></a><span id="l7.4"> imipDeclineInvitation.label=Decline</span>
<a href="#l7.5"></a><span id="l7.5"> imipUpdate.label=Update</span>
<a href="#l7.6"></a><span id="l7.6"> imipAcceptTentativeInvitation.label=Tentative</span>
<a href="#l7.7"></a><span id="l7.7"> imipSend.label=Send</span>
<a href="#l7.8"></a><span id="l7.8"> imipSendMail.title=E-Mail Notification</span>
<a href="#l7.9"></a><span id="l7.9"> imipSendMail.text=Would you like to send out notification E-Mail now?</span>
<a href="#l7.10"></a><span id="l7.10"> imipSendMail.Outlook2000CompatMode.text=Support Outlook 2000 and Outlook 2002/XP</span>
<a href="#l7.11"></a><span id="l7.11"> imipNoIdentity=None</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+imipNoCalendarAvailable=There are no writable calendars available.</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> itipReplySubject=Event Invitation Reply: %1$S</span>
<a href="#l7.15"></a><span id="l7.15"> itipReplyBodyAccept=%1$S has accepted your event invitation.</span>
<a href="#l7.16"></a><span id="l7.16"> itipReplyBodyDecline=%1$S has declined your event invitation.</span>
<a href="#l7.17"></a><span id="l7.17"> itipRequestSubject=Event Invitation: %1$S</span>
<a href="#l7.18"></a><span id="l7.18"> itipRequestBody=%1$S has invited you to %2$S</span>
<a href="#l7.19"></a><span id="l7.19"> itipCancelSubject=Event Canceled: %1$S</span>
<a href="#l7.20"></a><span id="l7.20"> itipCancelBody=%1$S has canceled this event: « %2$S »</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -380,26 +380,26 @@ calDavCalendar.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">                     return this.calendarUserAddress;</span>
<a href="#l8.5"></a><span id="l8.5">                 } // else use configured email identity</span>
<a href="#l8.6"></a><span id="l8.6">                 break;</span>
<a href="#l8.7"></a><span id="l8.7">             case &quot;organizerCN&quot;:</span>
<a href="#l8.8"></a><span id="l8.8">                 return null; // xxx todo</span>
<a href="#l8.9"></a><span id="l8.9">             case &quot;cache.updateTimer&quot;:</span>
<a href="#l8.10"></a><span id="l8.10">                 return getPrefSafe(&quot;calendar.autorefresh.timeout&quot;);</span>
<a href="#l8.11"></a><span id="l8.11">             case &quot;itip.transport&quot;:</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                if (this.hasAutoScheduling) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                    return null;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                } else if (this.hasScheduling) {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                if (this.hasAutoScheduling || this.hasScheduling) {</span>
<a href="#l8.16"></a><span id="l8.16">                     return this.QueryInterface(Components.interfaces.calIItipTransport);</span>
<a href="#l8.17"></a><span id="l8.17">                 } // else use outbound email-based iTIP (from cal.ProviderBase)</span>
<a href="#l8.18"></a><span id="l8.18">                 break;</span>
<a href="#l8.19"></a><span id="l8.19">             case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l8.20"></a><span id="l8.20">                 return (this.supportedItemTypes.indexOf(&quot;VTODO&quot;) &gt; -1);</span>
<a href="#l8.21"></a><span id="l8.21">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l8.22"></a><span id="l8.22">                 return (this.supportedItemTypes.indexOf(&quot;VEVENT&quot;) &gt; -1);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+            case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+                return this.hasAutoScheduling;</span>
<a href="#l8.25"></a><span id="l8.25">         }</span>
<a href="#l8.26"></a><span id="l8.26">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l8.27"></a><span id="l8.27">     },</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">     promptOverwrite: function caldav_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l8.30"></a><span id="l8.30">         var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l8.31"></a><span id="l8.31">                                       .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineat">@@ -714,17 +714,18 @@ calDavCalendar.prototype = {</span>
<a href="#l8.34"></a><span id="l8.34">                     if (thisCalendar.isCached) {</span>
<a href="#l8.35"></a><span id="l8.35">                         // the item is deleted in the storage calendar from calCachedCalendar</span>
<a href="#l8.36"></a><span id="l8.36">                         realListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l8.37"></a><span id="l8.37">                                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l8.38"></a><span id="l8.38">                                                          null, null);</span>
<a href="#l8.39"></a><span id="l8.39">                     } else {</span>
<a href="#l8.40"></a><span id="l8.40">                         thisCalendar.mTargetCalendar.deleteItem(aItem, aListener);</span>
<a href="#l8.41"></a><span id="l8.41">                     }</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-                    delete thisCalendar.mHrefIndex[eventUri.path];</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+                    let decodedHRef = decodeURIComponent(eventUri.path);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+                    delete thisCalendar.mHrefIndex[decodedHRef];</span>
<a href="#l8.45"></a><span id="l8.45">                     delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l8.46"></a><span id="l8.46">                     cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; +</span>
<a href="#l8.47"></a><span id="l8.47">                             thisCalendar.name);</span>
<a href="#l8.48"></a><span id="l8.48">                 }</span>
<a href="#l8.49"></a><span id="l8.49">             } else if (status == 412) {</span>
<a href="#l8.50"></a><span id="l8.50">                 // item has either been modified or deleted by someone else</span>
<a href="#l8.51"></a><span id="l8.51">                 // check to see which</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53" class="difflineat">@@ -2145,17 +2146,23 @@ calDavCalendar.prototype = {</span>
<a href="#l8.54"></a><span id="l8.54">                 thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l8.55"></a><span id="l8.55">             }</span>
<a href="#l8.56"></a><span id="l8.56">         };</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">         this.mTargetCalendar.getItem(aItem.id, getItemListener);</span>
<a href="#l8.59"></a><span id="l8.59">     },</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">     canNotify: function caldav_canNotify(aMethod, aItem) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-        if (this.hasAutoScheduling) { // auto-sched takes precedence</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+        if (this.hasAutoScheduling) {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+            // canNotify should return false if the schedule agent is client</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+            // so the itip transport(imip) takes care of notifying participants</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+            if (aItem.organizer &amp;&amp;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+                aItem.organizer.getProperty(&quot;SCHEDULE-AGENT&quot;) == &quot;CLIENT&quot;) {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+                return false;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+            }</span>
<a href="#l8.70"></a><span id="l8.70">             return true;</span>
<a href="#l8.71"></a><span id="l8.71">         }</span>
<a href="#l8.72"></a><span id="l8.72">         return false; // use outbound iTIP for all</span>
<a href="#l8.73"></a><span id="l8.73">     },</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75">     //</span>
<a href="#l8.76"></a><span id="l8.76">     // calIItipTransport interface</span>
<a href="#l8.77"></a><span id="l8.77">     //</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineat">@@ -2169,16 +2176,36 @@ calDavCalendar.prototype = {</span>
<a href="#l8.79"></a><span id="l8.79">         return this.mSenderAddress || this.calendarUserAddress;</span>
<a href="#l8.80"></a><span id="l8.80">     },</span>
<a href="#l8.81"></a><span id="l8.81">     set senderAddress(aString) {</span>
<a href="#l8.82"></a><span id="l8.82">         return (this.mSenderAddress = aString);</span>
<a href="#l8.83"></a><span id="l8.83">     },</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85">     sendItems: function caldav_sendItems(aCount, aRecipients, aItipItem) {</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        if (this.hasAutoScheduling) {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+            // If auto scheduling is supported by the server we still need</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+            // to send out REPLIES for meetings where the ORGANIZER has the</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+            // parameter SCHEDULE-AGENT set to CLIENT, this property is</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+            // checked in in canNotify()</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+            if (aItipItem.responseMethod == &quot;REPLY&quot;) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+                let imipTransport = cal.getImipTransport(this);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+                if (imipTransport) {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+                    imipTransport.sendItems(aCount, aRecipients, aItipItem);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+                }</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+            }</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+            // Servers supporting auto schedule should handle all other</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+            // scheduling operations for now. Note that eventually the client</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+            // could support setting a SCHEDULE-AGENT=CLIENT parameter on</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+            // ATTENDEES and/or interpreting the SCHEDULE-STATUS parameter which</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+            // could translate in the client sending out IMIP REQUESTS</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+            // for specific attendees.</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+            return;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+        }</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107">         if (aItipItem.responseMethod == &quot;REPLY&quot;) {</span>
<a href="#l8.108"></a><span id="l8.108">             // Get my participation status</span>
<a href="#l8.109"></a><span id="l8.109">             var attendee = aItipItem.getItemList({})[0].getAttendeeById(this.calendarUserAddress);</span>
<a href="#l8.110"></a><span id="l8.110">             if (!attendee) {</span>
<a href="#l8.111"></a><span id="l8.111">                 return;</span>
<a href="#l8.112"></a><span id="l8.112">             }</span>
<a href="#l8.113"></a><span id="l8.113">             // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l8.114"></a><span id="l8.114">             aItipItem.setAttendeeStatus(attendee.id, attendee.participationStatus);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -734,17 +734,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">         let D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l9.5"></a><span id="l9.5">         let queryXml =</span>
<a href="#l9.6"></a><span id="l9.6">           &lt;calendar-multiget xmlns:D={D} xmlns={C}&gt;</span>
<a href="#l9.7"></a><span id="l9.7">             &lt;D:prop&gt;</span>
<a href="#l9.8"></a><span id="l9.8">               &lt;D:getetag/&gt;</span>
<a href="#l9.9"></a><span id="l9.9">               &lt;calendar-data/&gt;</span>
<a href="#l9.10"></a><span id="l9.10">             &lt;/D:prop&gt;</span>
<a href="#l9.11"></a><span id="l9.11">           &lt;/calendar-multiget&gt;;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-          </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14">         let batchSize = cal.getPrefSafe(&quot;calendar.caldav.multigetBatchSize&quot;, 100);</span>
<a href="#l9.15"></a><span id="l9.15">         while (this.itemsNeedFetching.length &amp;&amp; batchSize &gt; 0) {</span>
<a href="#l9.16"></a><span id="l9.16">             batchSize --;</span>
<a href="#l9.17"></a><span id="l9.17">             let locpath = this.itemsNeedFetching.pop();</span>
<a href="#l9.18"></a><span id="l9.18">             queryXml.D::prop += &lt;D:href xmlns:D={D}&gt;{locpath}&lt;/D:href&gt;;</span>
<a href="#l9.19"></a><span id="l9.19">         }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">         let multigetQueryString = xmlHeader + queryXml.toXMLString();</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -799,17 +799,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l9.23"></a><span id="l9.23">             return;</span>
<a href="#l9.24"></a><span id="l9.24">         }</span>
<a href="#l9.25"></a><span id="l9.25">         if (this.itemsNeedFetching.length == 0) {</span>
<a href="#l9.26"></a><span id="l9.26">             if (this.newSyncToken) {</span>
<a href="#l9.27"></a><span id="l9.27">                 this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l9.28"></a><span id="l9.28">                 this.calendar.mTargetCalendar.setMetaData(&quot;sync-token&quot;, this.newSyncToken);</span>
<a href="#l9.29"></a><span id="l9.29">               cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l9.30"></a><span id="l9.30">             }</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+</span>
<a href="#l9.33"></a><span id="l9.33">             this.calendar.finalizeUpdatedItems(this.changelogListener,</span>
<a href="#l9.34"></a><span id="l9.34">                                                this.baseUri);</span>
<a href="#l9.35"></a><span id="l9.35">         }</span>
<a href="#l9.36"></a><span id="l9.36">         if (!this._reader) {</span>
<a href="#l9.37"></a><span id="l9.37">             // No reader means there was a request error</span>
<a href="#l9.38"></a><span id="l9.38">             cal.LOG(&quot;CalDAV: onStopRequest: no reader&quot;);</span>
<a href="#l9.39"></a><span id="l9.39">             return;</span>
<a href="#l9.40"></a><span id="l9.40">         }</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -819,17 +819,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l9.42"></a><span id="l9.42">             this._reader = null;</span>
<a href="#l9.43"></a><span id="l9.43">         }</span>
<a href="#l9.44"></a><span id="l9.44">         if (this.itemsNeedFetching.length &gt; 0) {</span>
<a href="#l9.45"></a><span id="l9.45">             cal.LOG(&quot;CalDAV: Still need to fetch &quot; + this.itemsNeedFetching.length + &quot; elements.&quot;);</span>
<a href="#l9.46"></a><span id="l9.46">             this._reader = Components.classes[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l9.47"></a><span id="l9.47">                                      .createInstance(Components.interfaces.nsISAXXMLReader);</span>
<a href="#l9.48"></a><span id="l9.48">             this._reader.contentHandler = this;</span>
<a href="#l9.49"></a><span id="l9.49">             this._reader.errorHandler = this;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-            this._reader.parseAsync(null);            </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+            this._reader.parseAsync(null);</span>
<a href="#l9.52"></a><span id="l9.52">             let timerCallback = {</span>
<a href="#l9.53"></a><span id="l9.53">                 requestHandler : this,</span>
<a href="#l9.54"></a><span id="l9.54">                 notify: function(timer) {</span>
<a href="#l9.55"></a><span id="l9.55">                     // Call multiget again to get another batch</span>
<a href="#l9.56"></a><span id="l9.56">                     this.requestHandler.doMultiGet();</span>
<a href="#l9.57"></a><span id="l9.57">                 }</span>
<a href="#l9.58"></a><span id="l9.58">             };</span>
<a href="#l9.59"></a><span id="l9.59">             let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineat">@@ -872,17 +872,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l9.61"></a><span id="l9.61">         if (this.calendar.isCached) {</span>
<a href="#l9.62"></a><span id="l9.62">             this.calendar.superCalendar.startBatch();</span>
<a href="#l9.63"></a><span id="l9.63">         }</span>
<a href="#l9.64"></a><span id="l9.64">     },</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">     endDocument: function mg_endDocument() {</span>
<a href="#l9.67"></a><span id="l9.67">         if (this.calendar.isCached) {</span>
<a href="#l9.68"></a><span id="l9.68">             this.calendar.superCalendar.endBatch();</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-        }        </span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+        }</span>
<a href="#l9.71"></a><span id="l9.71">     },</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">     startElement: function mg_startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l9.74"></a><span id="l9.74">         switch (aLocalName) {</span>
<a href="#l9.75"></a><span id="l9.75">             case &quot;response&quot;:</span>
<a href="#l9.76"></a><span id="l9.76">                 this.currentResponse = {};</span>
<a href="#l9.77"></a><span id="l9.77">                 this.tag = null</span>
<a href="#l9.78"></a><span id="l9.78">                 this.isInPropStat=false;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineat">@@ -943,17 +943,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l9.80"></a><span id="l9.80">                         oldEtag = null;</span>
<a href="#l9.81"></a><span id="l9.81">                     }</span>
<a href="#l9.82"></a><span id="l9.82">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l9.83"></a><span id="l9.83">                         this.changeCount++;</span>
<a href="#l9.84"></a><span id="l9.84">                         this.calendar.addTargetCalendarItem(r.href,</span>
<a href="#l9.85"></a><span id="l9.85">                                                             r.calendardata,</span>
<a href="#l9.86"></a><span id="l9.86">                                                             this.baseUri,</span>
<a href="#l9.87"></a><span id="l9.87">                                                             r.getetag,</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-                                                            null);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+                                                            this.listener);</span>
<a href="#l9.90"></a><span id="l9.90">                     }</span>
<a href="#l9.91"></a><span id="l9.91">                 } else {</span>
<a href="#l9.92"></a><span id="l9.92">                     cal.WARN(&quot;CalDAV: Unexpected response, status: &quot; +</span>
<a href="#l9.93"></a><span id="l9.93">                              r.status + &quot;, href: &quot; + r.href + &quot; calendar-data:&quot;);</span>
<a href="#l9.94"></a><span id="l9.94">                     this.unhandledErrors++;</span>
<a href="#l9.95"></a><span id="l9.95">                 }</span>
<a href="#l9.96"></a><span id="l9.96">                 break;</span>
<a href="#l9.97"></a><span id="l9.97">             case &quot;propstat&quot;:</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

