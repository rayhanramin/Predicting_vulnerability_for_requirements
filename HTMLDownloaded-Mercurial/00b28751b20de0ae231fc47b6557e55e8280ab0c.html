<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6178:00b28751b20de0ae231fc47b6557e55e8280ab0c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 00b28751b20de0ae231fc47b6557e55e8280ab0c" />
<meta property="og:url" content="/comm-central/rev/00b28751b20de0ae231fc47b6557e55e8280ab0c" />
<meta property="og:description" content="Bug 561851 - Hack libmime so that it notifies attachment sizes to GlodaMimeAttachments; r=asuth,sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 00b28751b20de0ae231fc47b6557e55e8280ab0c &#x2620;
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/00b28751b20de0ae231fc47b6557e55e8280ab0c">shortlog</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/00b28751b20de0ae231fc47b6557e55e8280ab0c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c">files</a> |
changeset |
<a href="/comm-central/raw-rev/00b28751b20de0ae231fc47b6557e55e8280ab0c">raw</a>  | <a href="/comm-central/archive/00b28751b20de0ae231fc47b6557e55e8280ab0c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561851">Bug 561851</a> - Hack libmime so that it notifies attachment sizes to GlodaMimeAttachments; r=asuth,sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">
<tr><td colspan="2" style="background:#ff3333;"><strong>&#x2620;&#x2620; backed out by <a style="font-family: monospace" href="/comm-central/rev/f444a2daf464">f444a2daf464</a> &#x2620; &#x2620;</strong></td></tr>
<tr><td>author</td><td>&#74;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#32;&#80;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#32;&#60;&#106;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#46;&#112;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 17 Aug 2010 08:22:04 +0100</td></tr>

<tr>
 <td>changeset 6178</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/00b28751b20de0ae231fc47b6557e55e8280ab0c">00b28751b20de0ae231fc47b6557e55e8280ab0c</a></td>
</tr>



<tr>
<td>parent 6177</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/311ea60cc2b871711599f9ed44de5cf76cfaf43b">311ea60cc2b871711599f9ed44de5cf76cfaf43b</a>
</td>
</tr>

<tr>
<td>child 6179</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f0b28551f86260ebfecd9857c79cf2c985a9d362">f0b28551f86260ebfecd9857c79cf2c985a9d362</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=00b28751b20de0ae231fc47b6557e55e8280ab0c">4778</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Aug 2010 07:24:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@3871e8092a3a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3871e8092a3a259501a6917862a258bf04355b5c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=3871e8092a3a259501a6917862a258bf04355b5c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3871e8092a3a259501a6917862a258bf04355b5c&newProject=comm-central&newRevision=311ea60cc2b871711599f9ed44de5cf76cfaf43b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3871e8092a3a259501a6917862a258bf04355b5c&newProject=comm-central&newRevision=311ea60cc2b871711599f9ed44de5cf76cfaf43b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=3871e8092a3a259501a6917862a258bf04355b5c&newProject=comm-central&newRevision=311ea60cc2b871711599f9ed44de5cf76cfaf43b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561851">561851</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=561851">Bug 561851</a> - Hack libmime so that it notifies attachment sizes to GlodaMimeAttachments; r=asuth,sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">mailnews/db/gloda/components/jsmimeemitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/components/jsmimeemitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">mailnews/db/gloda/modules/mimemsg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/modules/mimemsg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">mailnews/db/gloda/test/unit/test_mime_attachments_size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">mailnews/mime/public/nsMailHeaders.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/public/nsMailHeaders.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">mailnews/mime/src/mimecryp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimecryp.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">mailnews/mime/src/mimeenc.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeenc.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">mailnews/mime/src/mimeeobj.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeeobj.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">mailnews/mime/src/mimei.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimei.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">mailnews/mime/src/mimeiimg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeiimg.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">mailnews/mime/src/mimeleaf.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">mailnews/mime/src/mimeleaf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimeleaf.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">mailnews/mime/src/mimemsig.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemsig.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">mailnews/mime/src/mimemult.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/mimemult.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">mailnews/mime/src/modlmime.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modlmime.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">mailnews/mime/src/modmimee.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">file</a> |
<a href="/comm-central/annotate/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">annotate</a> |
<a href="/comm-central/diff/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">diff</a> |
<a href="/comm-central/comparison/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">comparison</a> |
<a href="/comm-central/log/00b28751b20de0ae231fc47b6557e55e8280ab0c/mailnews/mime/src/modmimee.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -110,16 +110,17 @@ struct nsMsgAttachmentData</span>
<a href="#l1.4"></a><span id="l1.4">                           // Content-Disposition header. For example, if you had copied a document to a </span>
<a href="#l1.5"></a><span id="l1.5">                           // tmp file, this would be the original, human-readable name of the document.</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   char *description;      // If you put a string here, it will show up as the Content-Description header.  </span>
<a href="#l1.8"></a><span id="l1.8">                           // This can be any explanatory text; it's not a file name.             </span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   char *x_mac_type, *x_mac_creator; // Mac-specific data that should show up as optional parameters</span>
<a href="#l1.11"></a><span id="l1.11">                                     // to the content-type header.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  PRInt32 size;                  // The size of the attachment. May be 0.</span>
<a href="#l1.13"></a><span id="l1.13">   PRBool  isExternalAttachment;  // Flag for determining if the attachment is external</span>
<a href="#l1.14"></a><span id="l1.14"> };</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> //</span>
<a href="#l1.18"></a><span id="l1.18"> // When we have downloaded a URL to a tmp file for attaching, this</span>
<a href="#l1.19"></a><span id="l1.19"> // represents everything we learned about it (and did to it) in the</span>
<a href="#l1.20"></a><span id="l1.20"> // process. </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -86,16 +86,17 @@ function MimeMessageEmitter() {</span>
<a href="#l2.4"></a><span id="l2.4">   this._mimeMsg = {};</span>
<a href="#l2.5"></a><span id="l2.5">   Cu.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, this._mimeMsg);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   this._url = null;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   this._outputListener = null;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   this._curPart = null;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  this._curAttachment = null;</span>
<a href="#l2.13"></a><span id="l2.13">   this._partMap = {};</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   this._state = kStateUnknown;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   this._writeBody = false;</span>
<a href="#l2.18"></a><span id="l2.18"> }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> const deathToNewlines = /\n/g;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -107,16 +108,17 @@ MimeMessageEmitter.prototype = {</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMimeEmitter]),</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   initialize: function mime_emitter_initialize(aUrl, aChannel, aFormat) {</span>
<a href="#l2.26"></a><span id="l2.26">     this._url = aUrl;</span>
<a href="#l2.27"></a><span id="l2.27">     this._curPart = new this._mimeMsg.MimeMessage();</span>
<a href="#l2.28"></a><span id="l2.28">     // the partName is intentionally &quot;&quot;!  not a place-holder!</span>
<a href="#l2.29"></a><span id="l2.29">     this._curPart.partName = &quot;&quot;;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    this._curAttachment = &quot;&quot;;</span>
<a href="#l2.31"></a><span id="l2.31">     this._partMap[&quot;&quot;] = this._curPart;</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">     // pull options across...</span>
<a href="#l2.34"></a><span id="l2.34">     let options = this._mimeMsg.MsgHdrToMimeMessage.OPTION_TUNNEL;</span>
<a href="#l2.35"></a><span id="l2.35">     this._saneBodySize = (options &amp;&amp; (&quot;saneBodySize&quot; in options)) ?</span>
<a href="#l2.36"></a><span id="l2.36">                            options.saneBodySize : false;</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     this._mimeMsg.MsgHdrToMimeMessage.RESULT_RENDEVOUZ[aUrl.spec] =</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -124,16 +126,17 @@ MimeMessageEmitter.prototype = {</span>
<a href="#l2.40"></a><span id="l2.40">   },</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   complete: function mime_emitter_complete() {</span>
<a href="#l2.43"></a><span id="l2.43">     this._url = null;</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     this._outputListener = null;</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">     this._curPart = null;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    this._curAttachment = null;</span>
<a href="#l2.49"></a><span id="l2.49">     this._partMap = null;</span>
<a href="#l2.50"></a><span id="l2.50">   },</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   setPipe: function mime_emitter_setPipe(aInputStream, aOutputStream) {</span>
<a href="#l2.53"></a><span id="l2.53">     // we do not care about these</span>
<a href="#l2.54"></a><span id="l2.54">   },</span>
<a href="#l2.55"></a><span id="l2.55">   set outputListener(aListener) {</span>
<a href="#l2.56"></a><span id="l2.56">     this._outputListener = aListener;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineat">@@ -335,58 +338,64 @@ MimeMessageEmitter.prototype = {</span>
<a href="#l2.58"></a><span id="l2.58">   // The attachment processing happens after the initial streaming phase (during</span>
<a href="#l2.59"></a><span id="l2.59">   //  which time we receive the messages, both bodies and headers).  Our caller</span>
<a href="#l2.60"></a><span id="l2.60">   //  traverses the libmime child object hierarchy, emitting an attachment for</span>
<a href="#l2.61"></a><span id="l2.61">   //  each leaf object or sub-message.</span>
<a href="#l2.62"></a><span id="l2.62">   startAttachment: function mime_emitter_startAttachment(aName, aContentType,</span>
<a href="#l2.63"></a><span id="l2.63">       aUrl, aIsExternalAttachment) {</span>
<a href="#l2.64"></a><span id="l2.64">     this._state = kStateInAttachment;</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    // we need to strip our magic flags from the URL</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    aUrl = aUrl.replace(&quot;header=filter&amp;emitter=js&amp;&quot;, &quot;&quot;);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    // the url should contain a part= piece that tells us the part name, which</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    // we then use to figure out where to place that part if it's a real</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    // attachment.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    let partMatch = this._partRE.exec(aUrl);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    let partName = partMatch &amp;&amp; partMatch[1];</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+</span>
<a href="#l2.74"></a><span id="l2.74">     if (aContentType == &quot;message/rfc822&quot;) {</span>
<a href="#l2.75"></a><span id="l2.75">       // we want to offer extension authors a way to see attachments as the</span>
<a href="#l2.76"></a><span id="l2.76">       // message readers sees them, which means attaching an extra url property</span>
<a href="#l2.77"></a><span id="l2.77">       // to the part that was already created before</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-      aUrl = aUrl.replace(&quot;header=filter&amp;emitter=js&amp;&quot;, &quot;&quot;);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-      let partMatch = this._partRE.exec(aUrl);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-      if (partMatch) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+      if (partName) {</span>
<a href="#l2.82"></a><span id="l2.82">         // we disguise this MimeMessage into something that can be used as a</span>
<a href="#l2.83"></a><span id="l2.83">         // MimeAttachment so that it is transparent for the user code</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-        let partName = partMatch[1];</span>
<a href="#l2.85"></a><span id="l2.85">         this._partMap[partName].url = aUrl;</span>
<a href="#l2.86"></a><span id="l2.86">         this._partMap[partName].isExternalAttachment = aIsExternalAttachment;</span>
<a href="#l2.87"></a><span id="l2.87">         this._partMap[partName].name = aName;</span>
<a href="#l2.88"></a><span id="l2.88">         this._partMap[partName].isRealAttachment = true;</span>
<a href="#l2.89"></a><span id="l2.89">       }</span>
<a href="#l2.90"></a><span id="l2.90">     }</span>
<a href="#l2.91"></a><span id="l2.91">     else if (aIsExternalAttachment) {</span>
<a href="#l2.92"></a><span id="l2.92">       // external attachments do not pass their part path information.</span>
<a href="#l2.93"></a><span id="l2.93">       // both aUrl in this call and the call to addAttachmentField (with</span>
<a href="#l2.94"></a><span id="l2.94">       // X-Mozilla-PartURL) receive the same thing; the URL to the file on disk.</span>
<a href="#l2.95"></a><span id="l2.95">     }</span>
<a href="#l2.96"></a><span id="l2.96">     else {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-      // we need to strip our magic flags from the URL</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-      aUrl = aUrl.replace(&quot;header=filter&amp;emitter=js&amp;&quot;, &quot;&quot;);</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-      // the url should contain a part= piece that tells us the part name, which</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-      //  we then use to figure out where.</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-      let partMatch = this._partRE.exec(aUrl);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-      if (partMatch) {</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-        let part = new this._mimeMsg.MimeMessageAttachment(partMatch[1],</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+      if (partName) {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+        let part = new this._mimeMsg.MimeMessageAttachment(partName,</span>
<a href="#l2.106"></a><span id="l2.106">             aName, aContentType, aUrl, aIsExternalAttachment);</span>
<a href="#l2.107"></a><span id="l2.107">         if (part.isRealAttachment) {</span>
<a href="#l2.108"></a><span id="l2.108">           // replace the existing part with the attachment...</span>
<a href="#l2.109"></a><span id="l2.109">           this._replacePart(part);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+          this._curAttachment = partName;</span>
<a href="#l2.111"></a><span id="l2.111">         }</span>
<a href="#l2.112"></a><span id="l2.112">       }</span>
<a href="#l2.113"></a><span id="l2.113">     }</span>
<a href="#l2.114"></a><span id="l2.114">   },</span>
<a href="#l2.115"></a><span id="l2.115">   addAttachmentField: function mime_emitter_addAttachmentField(aField, aValue) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    // all that gets passed in here is X-Mozilla-PartURL with a value that</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+    // what gets passed in here is X-Mozilla-PartURL with a value that</span>
<a href="#l2.118"></a><span id="l2.118">     //  is completely identical to aUrl from the call to startAttachment.</span>
<a href="#l2.119"></a><span id="l2.119">     //  (it's the same variable they use in each case).  As such, there is</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-    //  no reason to handle anything here.</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    //  no reason to handle that here.</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    //</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    //  However, we also pass information about the size of the attachment, and</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    //  that we want to handle</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+    if (aField == &quot;X-Mozilla-PartSize&quot; &amp;&amp; this._curPart)</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+        this._partMap[this._curAttachment].size = parseInt(aValue);</span>
<a href="#l2.127"></a><span id="l2.127">   },</span>
<a href="#l2.128"></a><span id="l2.128">   endAttachment: function mime_emitter_endAttachment() {</span>
<a href="#l2.129"></a><span id="l2.129">     // don't need to do anything here, since we don't care about the headers.</span>
<a href="#l2.130"></a><span id="l2.130">   },</span>
<a href="#l2.131"></a><span id="l2.131">   endAllAttachments: function mime_emitter_endAllAttachments() {</span>
<a href="#l2.132"></a><span id="l2.132">     // nop</span>
<a href="#l2.133"></a><span id="l2.133">   },</span>
<a href="#l2.134"></a><span id="l2.134"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -367,16 +367,24 @@ MimeMessage.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">       return [this];</span>
<a href="#l3.5"></a><span id="l3.5">     else</span>
<a href="#l3.6"></a><span id="l3.6">       // Why is there no flatten method for arrays?</span>
<a href="#l3.7"></a><span id="l3.7">       return [child.allUserAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l3.8"></a><span id="l3.8">         .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+   * @return the total size of this message, that is, the size of all subparts</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+   */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  get size () {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    return [child.size for each ([, child] in Iterator(this.parts))]</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      .reduce(function (a, b) a + Math.max(b, 0), 0);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  },</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  /**</span>
<a href="#l3.20"></a><span id="l3.20">    * @param aMsgFolder A message folder, any message folder.  Because this is</span>
<a href="#l3.21"></a><span id="l3.21">    *    a hack.</span>
<a href="#l3.22"></a><span id="l3.22">    * @return The concatenation of all of the body parts where parts</span>
<a href="#l3.23"></a><span id="l3.23">    *    available as text/plain are pulled as-is, and parts only available</span>
<a href="#l3.24"></a><span id="l3.24">    *    as text/html are converted to plaintext form first.  In other words,</span>
<a href="#l3.25"></a><span id="l3.25">    *    if we see a multipart/alternative with a text/plain, we take the</span>
<a href="#l3.26"></a><span id="l3.26">    *    text/plain.  If we see a text/html without an alternative, we convert</span>
<a href="#l3.27"></a><span id="l3.27">    *    that to text.</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineat">@@ -447,16 +455,20 @@ MimeContainer.prototype = {</span>
<a href="#l3.29"></a><span id="l3.29">       results = results.concat(child.allAttachments);</span>
<a href="#l3.30"></a><span id="l3.30">     }</span>
<a href="#l3.31"></a><span id="l3.31">     return results;</span>
<a href="#l3.32"></a><span id="l3.32">   },</span>
<a href="#l3.33"></a><span id="l3.33">   get allUserAttachments () {</span>
<a href="#l3.34"></a><span id="l3.34">     return [child.allUserAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l3.35"></a><span id="l3.35">       .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l3.36"></a><span id="l3.36">   },</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  get size () {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    return [child.size for each ([, child] in Iterator(this.parts))]</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      .reduce(function (a, b) a + Math.max(b, 0), 0);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  },</span>
<a href="#l3.41"></a><span id="l3.41">   coerceBodyToPlaintext:</span>
<a href="#l3.42"></a><span id="l3.42">       function MimeContainer_coerceBodyToPlaintext(aMsgFolder) {</span>
<a href="#l3.43"></a><span id="l3.43">     if (this.contentType == &quot;multipart/alternative&quot;) {</span>
<a href="#l3.44"></a><span id="l3.44">       let htmlPart;</span>
<a href="#l3.45"></a><span id="l3.45">       // pick the text/plain if we can find one, otherwise remember the HTML one</span>
<a href="#l3.46"></a><span id="l3.46">       for each (let [, part] in Iterator(this.parts)) {</span>
<a href="#l3.47"></a><span id="l3.47">         if (part.contentType == &quot;text/plain&quot;)</span>
<a href="#l3.48"></a><span id="l3.48">           return part.body;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -509,16 +521,19 @@ function MimeBody(aContentType) {</span>
<a href="#l3.50"></a><span id="l3.50"> MimeBody.prototype = {</span>
<a href="#l3.51"></a><span id="l3.51">   __proto__: HeaderHandlerBase,</span>
<a href="#l3.52"></a><span id="l3.52">   get allAttachments() {</span>
<a href="#l3.53"></a><span id="l3.53">     return []; // we are a leaf</span>
<a href="#l3.54"></a><span id="l3.54">   },</span>
<a href="#l3.55"></a><span id="l3.55">   get allUserAttachments() {</span>
<a href="#l3.56"></a><span id="l3.56">     return []; // we are a leaf</span>
<a href="#l3.57"></a><span id="l3.57">   },</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  get size() {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    return this.body.length;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  },</span>
<a href="#l3.61"></a><span id="l3.61">   coerceBodyToPlaintext:</span>
<a href="#l3.62"></a><span id="l3.62">       function MimeBody_coerceBodyToPlaintext(aMsgFolder) {</span>
<a href="#l3.63"></a><span id="l3.63">     if (this.contentType == &quot;text/plain&quot;)</span>
<a href="#l3.64"></a><span id="l3.64">       return this.body;</span>
<a href="#l3.65"></a><span id="l3.65">     if (this.contentType == &quot;text/html&quot;)</span>
<a href="#l3.66"></a><span id="l3.66">       return aMsgFolder.convertMsgSnippetToPlainText(this.body);</span>
<a href="#l3.67"></a><span id="l3.67">     return &quot;&quot;;</span>
<a href="#l3.68"></a><span id="l3.68">   },</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -589,16 +604,18 @@ function getLocalizedPartStr() {</span>
<a href="#l3.70"></a><span id="l3.70">  * @class An attachment proper.  We think it's an attachment because it has a</span>
<a href="#l3.71"></a><span id="l3.71">  *  filename that libmime was able to figure out.</span>
<a href="#l3.72"></a><span id="l3.72">  *</span>
<a href="#l3.73"></a><span id="l3.73">  * @ivar partName @see{MimeMessage.partName}</span>
<a href="#l3.74"></a><span id="l3.74">  * @ivar name The filename of this attachment.</span>
<a href="#l3.75"></a><span id="l3.75">  * @ivar contentType The MIME content type of this part.</span>
<a href="#l3.76"></a><span id="l3.76">  * @ivar url The URL to stream if you want the contents of this part.</span>
<a href="#l3.77"></a><span id="l3.77">  * @ivar isExternal Is the attachment stored someplace else than in the message?</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ * @ivar size The size of the attachment if available, -1 otherwise (size is set</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+ *  after initialization by jsmimeemitter.js)</span>
<a href="#l3.80"></a><span id="l3.80">  */</span>
<a href="#l3.81"></a><span id="l3.81"> function MimeMessageAttachment(aPartName, aName, aContentType, aUrl,</span>
<a href="#l3.82"></a><span id="l3.82">                                aIsExternal) {</span>
<a href="#l3.83"></a><span id="l3.83">   this.partName = aPartName;</span>
<a href="#l3.84"></a><span id="l3.84">   this.name = aName;</span>
<a href="#l3.85"></a><span id="l3.85">   this.contentType = aContentType;</span>
<a href="#l3.86"></a><span id="l3.86">   this.url = aUrl;</span>
<a href="#l3.87"></a><span id="l3.87">   this.isExternal = aIsExternal;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_mime_attachments_size.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,227 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * the Mozilla Foundation</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Jonathan Protzenko &lt;jonathan.protzenko@gmail.com&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+/*</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ * General testing of the byte-counting libmime facility, to make sure that what</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ * is streamed to us is actually labeled with the right size.</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ */</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+/*</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+ * Do not include glodaTestHelper because we do not want gloda loaded and it</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+ *  adds a lot of runtime overhead which makes certain debugging strategies like</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+ *  using chronicle-recorder impractical.</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+ */</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+load(&quot;../../mailnews/resources/logHelper.js&quot;);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+load(&quot;../../mailnews/resources/messageInjection.js&quot;);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+// Create a message generator</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+const msgGen = gMessageGenerator = new MessageGenerator();</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+// Create a message scenario generator using that message generator</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+const scenarios = gMessageScenarioFactory = new MessageScenarioFactory(msgGen);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+Components.utils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+var htmlText = &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! &lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+var partHtml = new SyntheticPartLeaf(</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  htmlText,</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    contentType: &quot;text/html&quot;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+var originalText =</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  &quot;Longtemps, je me suis couch de bonne heure. Parfois,  &quot;+</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  &quot;peine ma bougie teinte, mes yeux se fermaient si vite que je n'avais pas le &quot;+</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  &quot;temps de me dire :  Je m'endors. &quot;;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+var b64Text =</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  &quot;TG9uZ3RlbXBzLCBqZSBtZSBzdWlzIGNvdWNow6kgZGUgYm9ubmUgaGV1cmUuIFBhcmZvaXMs\n&quot;+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  &quot;IMOgIHBlaW5lIG1hIGJvdWdpZSDDqXRlaW50ZSwgbWVzIHlldXggc2UgZmVybWFpZW50IHNp\n&quot;+</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  &quot;IHZpdGUgcXVlIGplIG4nYXZhaXMgcGFzIGxlIHRlbXBzIGRlIG1lIGRpcmUgOiDCqyBKZSBt\n&quot;+</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  &quot;J2VuZG9ycy4gwrsK&quot;;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+var qpText =</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  &quot;Longtemps,=20je=20me=20suis=20couch=C3=A9=20de=20bonne=20heure.=20Parfois,=\n&quot;+</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  &quot;=20=C3=A0=20peine=20ma=20bougie=20=C3=A9teinte,=20mes=20yeux=20se=20fermaie=\n&quot;+</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  &quot;nt=20si=20vite=20que=20je=20n'avais=20pas=20le=20temps=20de=20me=20dire=20:=\n&quot;+</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  &quot;=20=C2=AB=20Je=20m'endors.=20=C2=BB&quot;;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+var uuText =</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  &quot;begin 666 -\n&quot;+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  &quot;M3&amp;]N9W1E;7!S+\&quot;!J92!M92!S=6ES(&amp;-O=6-HPZD@9&amp;4@8F]N;F4@:&amp;5U&lt;F4N\n&quot;+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  &quot;M(%!A&lt;F9O:7,L(,.@('!E:6YE(&amp;UA(&amp;)O=6=I92##J71E:6YT92P@;65S('EE\n&quot;+</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  &quot;M=7@@&lt;V4@9F5R;6%I96YT('-I('9I=&amp;4@&lt;75E(&amp;IE(&amp;XG879A:7,@&lt;&amp;%S(&amp;QE\n&quot;+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  &quot;G('1E;7!S(&amp;1E(&amp;UE(&amp;1I&lt;F4@.B#\&quot;JR!*92!M)V5N9&amp;]R&lt;RX@PKL*\n&quot;+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  &quot;\n&quot;+</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  &quot;end&quot;;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+var yencText =</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  &quot;Hello there --\n&quot;+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  &quot;=ybegin line=128 size=174 name=jane.doe\n&quot;+</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  &quot;\x76\x99\x98\x91\x9e\x8f\x97\x9a\x9d\x56\x4a\x94\x8f\x4a\x97\x8f&quot;+</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  &quot;\x4a\x9d\x9f\x93\x9d\x4a\x8d\x99\x9f\x8d\x92\xed\xd3\x4a\x8e\x8f&quot;+</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  &quot;\x4a\x8c\x99\x98\x98\x8f\x4a\x92\x8f\x9f\x9c\x8f\x58\x4a\x7a\x8b&quot;+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  &quot;\x9c\x90\x99\x93\x9d\x56\x4a\xed\xca\x4a\x9a\x8f\x93\x98\x8f\x4a&quot;+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  &quot;\x97\x8b\x4a\x8c\x99\x9f\x91\x93\x8f\x4a\xed\xd3\x9e\x8f\x93\x98&quot;+</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  &quot;\x9e\x8f\x56\x4a\x97\x8f\x9d\x4a\xa3\x8f\x9f\xa2\x4a\x9d\x8f\x4a&quot;+</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  &quot;\x90\x8f\x9c\x97\x8b\x93\x8f\x98\x9e\x4a\x9d\x93\x4a\xa0\x93\x9e&quot;+</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  &quot;\x8f\x4a\x9b\x9f\x8f\x4a\x94\x8f\x4a\x98\x51\x8b\xa0\x8b\x93\x9d&quot;+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  &quot;\x0d\x0a\x4a\x9a\x8b\x9d\x4a\x96\x8f\x4a\x9e\x8f\x97\x9a\x9d\x4a&quot;+</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  &quot;\x8e\x8f\x4a\x97\x8f\x4a\x8e\x93\x9c\x8f\x4a\x64\x4a\xec\xd5\x4a&quot;+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  &quot;\x74\x8f\x4a\x97\x51\x8f\x98\x8e\x99\x9c\x9d\x58\x4a\xec\xe5\x34&quot;+</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  &quot;\x0d\x0a&quot;+</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  &quot;=yend size=174 crc32=7efccd8e\n&quot;;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+// that completely exotic encoding is only detected if there is no content type</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+// on the message, which is usually the case in newsgroups. I hate you yencode!</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+var partYencText = new SyntheticPartLeaf(&quot;I am text! Woo!\n\n&quot;+yencText,</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  { contentType: '' } );</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+var tachText = {filename: 'bob.txt', body: originalText};</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+var tachInlineText = {filename: 'foo.txt', body: originalText,</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+                      format: null, charset: null,</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+                      disposition: 'inline'};</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+// images have a different behavior than other attachments: they are displayed</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+// inline most of the time, so there are two different code paths that need to</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+// enable streaming and byte counting to the JS mime emitter</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+var tachImage = {filename: 'bob.png', contentType: 'image/png',</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+                 encoding: 'base64', charset: null, format: null,</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+                 body: b64Text};</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+var tachPdf = {filename: 'bob.pdf', contentType: 'application/pdf',</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+                 encoding: 'base64', charset: null, format: null,</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+                 body: b64Text};</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+var tachUU = {filename: 'john.doe', contentType: 'application/x-uuencode',</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+                 encoding: 'uuencode', charset: null, format: null,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+                 body: uuText};</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+var tachApplication = {filename: 'funky.funk',</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+                       contentType: 'application/x-funky', body: originalText};</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+var relImage = {contentType: 'image/png',</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+                encoding: 'base64', charset: null, format: null,</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+                contentId: 'part1.foo@bar.com',</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+                body: b64Text};</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+var partRelImage = new SyntheticPartLeaf(relImage.body, relImage);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+var messageInfos = [</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  // encoding type specific to newsgroups, not interested, gloda doesn't even</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+  // treat this as an attachment (libmime probably doesn't notify us properly),</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  // but size IS counted properly</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  /*{</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+    name: 'text/plain with yenc inline',</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    bodyPart: partYencText,</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    subject: &quot;yEnc-Prefix: \&quot;jane.doe\&quot; 174 yEnc bytes - yEnc test (1)&quot;,</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  },*/</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  // inline image, not interested either, gloda doesn't keep that as an</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  // attachment (probably a deliberate choice), size is NOT counted properly</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  // (don't want to investigate, I doubt it's a useful information anyway)</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+  /*{</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+    name: 'multipart/related',</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+    bodyPart: new SyntheticPartMultiRelated([partHtml, partRelImage]),</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  },*/</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+  // all of the other common cases work fine</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+  {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+    name: 'text/plain w/app attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    attachments: [tachImage, tachPdf, tachUU,</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+      tachApplication, tachText, tachInlineText,],</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  },</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+];</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+function check_attachments(aMimeMsg) {</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+  if (aMimeMsg == null)</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+    do_throw(&quot;We really should have gotten a result!&quot;);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  do_check_true(aMimeMsg.allAttachments.length &gt; 0);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  let totalSize = htmlText.length + 1;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  for each (let [i, att] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    dump(&quot;*** Attachment now is &quot;+att.name+&quot;\n&quot;);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    do_check_eq(att.size, originalText.length + 1);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    totalSize += att.size;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  }</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  do_check_eq(aMimeMsg.size, totalSize);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  async_driver();</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+}</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+function test_message_attachments(info) {</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+  let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  let msgHdr = synSet.getMsgHdr(0);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+  dump(synMsg.toMboxString()+&quot;\n&quot;);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+  MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+    try {</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+      check_attachments(aMimeMsg);</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+      do_throw(e);</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    }</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  });</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  yield false;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+}</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+/* ===== Driver ===== */</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+var tests = [</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  parameterizeTest(test_message_attachments, messageInfos),</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+];</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+var gInbox;</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+function run_test() {</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+  // use mbox injection because the fake server chokes sometimes right now</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+  gInbox = configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/public/nsMailHeaders.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -107,12 +107,13 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #define HEADER_PARM_CHARSET                 &quot;charset&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #define HEADER_PARM_START                   &quot;start&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #define HEADER_PARM_BOUNDARY                &quot;BOUNDARY&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #define HEADER_PARM_FILENAME                &quot;FILENAME&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #define HEADER_PARM_NAME                    &quot;NAME&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #define HEADER_PARM_TYPE                    &quot;TYPE&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> #define HEADER_X_MOZILLA_PART_URL           &quot;X-Mozilla-PartURL&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#define HEADER_X_MOZILLA_PART_SIZE          &quot;X-Mozilla-PartSize&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #define HEADER_X_MOZILLA_IDENTITY_KEY       &quot;X-Identity-Key&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #define HEADER_X_MOZILLA_ACCOUNT_KEY       &quot;X-Account-Key&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #define HEADER_X_MOZILLA_KEYWORDS          &quot;X-Mozilla-Keys&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #endif /* nsMailHeaders_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/src/mimecryp.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/src/mimecryp.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -162,17 +162,17 @@ MimeEncrypted_parse_buffer (const char *</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   /* Don't consult output_p here, since at this point we're behaving as a</span>
<a href="#l6.8"></a><span id="l6.8">    simple container object -- the output_p decision should be made by</span>
<a href="#l6.9"></a><span id="l6.9">    the child of this object. */</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   if (enc-&gt;decoder_data)</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  return MimeDecoderWrite (enc-&gt;decoder_data, buffer, size);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  return MimeDecoderWrite (enc-&gt;decoder_data, buffer, size, nsnull);</span>
<a href="#l6.14"></a><span id="l6.14">   else</span>
<a href="#l6.15"></a><span id="l6.15">   return ((MimeEncryptedClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer (buffer,</span>
<a href="#l6.16"></a><span id="l6.16">                                    size,</span>
<a href="#l6.17"></a><span id="l6.17">                                    obj);</span>
<a href="#l6.18"></a><span id="l6.18"> }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> static int</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2006,17 +2006,17 @@ mime_decompose_file_output_fn (const cha</span>
<a href="#l7.4"></a><span id="l7.4">   NS_ASSERTION (mdd &amp;&amp; buf, &quot;missing mime draft data and/or buf&quot;);</span>
<a href="#l7.5"></a><span id="l7.5">   if (!mdd || !buf) return -1;</span>
<a href="#l7.6"></a><span id="l7.6">   if (!size) return NS_OK;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   if ( !mdd-&gt;tmpFileStream )</span>
<a href="#l7.9"></a><span id="l7.9">     return NS_OK;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   if (mdd-&gt;decoder_data) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    ret = MimeDecoderWrite(mdd-&gt;decoder_data, buf, size);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    ret = MimeDecoderWrite(mdd-&gt;decoder_data, buf, size, nsnull);</span>
<a href="#l7.14"></a><span id="l7.14">     if (ret == -1) return -1;</span>
<a href="#l7.15"></a><span id="l7.15">   }</span>
<a href="#l7.16"></a><span id="l7.16">   else</span>
<a href="#l7.17"></a><span id="l7.17">   {</span>
<a href="#l7.18"></a><span id="l7.18">     PRUint32 bytesWritten;</span>
<a href="#l7.19"></a><span id="l7.19">     mdd-&gt;tmpFileStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l7.20"></a><span id="l7.20">     if (bytesWritten &lt; size)</span>
<a href="#l7.21"></a><span id="l7.21">       return MIME_ERROR_WRITING_FILE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -66,17 +66,18 @@ struct MimeDecoderData {</span>
<a href="#l8.4"></a><span id="l8.4">   MimeObject *objectToDecode; // might be null, only used for QP currently</span>
<a href="#l8.5"></a><span id="l8.5">   /* Where to write the decoded data */</span>
<a href="#l8.6"></a><span id="l8.6">   nsresult (*write_buffer) (const char *buf, PRInt32 size, void *closure);</span>
<a href="#l8.7"></a><span id="l8.7">   void *closure;</span>
<a href="#l8.8"></a><span id="l8.8"> };</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> static int</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-mime_decode_qp_buffer (MimeDecoderData *data, const char *buffer, PRInt32 length)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+mime_decode_qp_buffer (MimeDecoderData *data, const char *buffer,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+          PRInt32 length, PRInt32 *outSize)</span>
<a href="#l8.15"></a><span id="l8.15"> {</span>
<a href="#l8.16"></a><span id="l8.16">   /* Warning, we are overwriting the buffer which was passed in.</span>
<a href="#l8.17"></a><span id="l8.17">    This is ok, because decoding these formats will never result</span>
<a href="#l8.18"></a><span id="l8.18">    in larger data than the input, only smaller. */</span>
<a href="#l8.19"></a><span id="l8.19">   const char *in  = buffer;</span>
<a href="#l8.20"></a><span id="l8.20">   char *out = (char *) buffer;</span>
<a href="#l8.21"></a><span id="l8.21">   char token [3];</span>
<a href="#l8.22"></a><span id="l8.22">   int i;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -189,16 +190,20 @@ mime_decode_qp_buffer (MimeDecoderData *</span>
<a href="#l8.24"></a><span id="l8.24">       *out++ = token[0];</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">       token[0] = token[1];</span>
<a href="#l8.27"></a><span id="l8.27">       token[1] = token[2];</span>
<a href="#l8.28"></a><span id="l8.28">       i = 2;</span>
<a href="#l8.29"></a><span id="l8.29">     }</span>
<a href="#l8.30"></a><span id="l8.30">   }</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  // Fill the size</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  if (outSize)</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+    *outSize = out - buffer;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36">   /* Now that we've altered the data in place, write it. */</span>
<a href="#l8.37"></a><span id="l8.37">   if (out &gt; buffer)</span>
<a href="#l8.38"></a><span id="l8.38">   return data-&gt;write_buffer (buffer, (out - buffer), data-&gt;closure);</span>
<a href="#l8.39"></a><span id="l8.39">   else</span>
<a href="#l8.40"></a><span id="l8.40">   return 1;</span>
<a href="#l8.41"></a><span id="l8.41"> }</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44" class="difflineat">@@ -242,17 +247,17 @@ mime_decode_base64_token (const char *in</span>
<a href="#l8.45"></a><span id="l8.45">     NS_ERROR(&quot;Count is 6 bits, should be at least 8&quot;);</span>
<a href="#l8.46"></a><span id="l8.46">     return 1;</span>
<a href="#l8.47"></a><span id="l8.47">   }</span>
<a href="#l8.48"></a><span id="l8.48"> }</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51"> static int</span>
<a href="#l8.52"></a><span id="l8.52"> mime_decode_base64_buffer (MimeDecoderData *data,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-               const char *buffer, PRInt32 length)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+               const char *buffer, PRInt32 length, PRInt32 *outSize)</span>
<a href="#l8.55"></a><span id="l8.55"> {</span>
<a href="#l8.56"></a><span id="l8.56">   /* Warning, we are overwriting the buffer which was passed in.</span>
<a href="#l8.57"></a><span id="l8.57">    This is ok, because decoding these formats will never result</span>
<a href="#l8.58"></a><span id="l8.58">    in larger data than the input, only smaller. */</span>
<a href="#l8.59"></a><span id="l8.59">   const char *in  = buffer;</span>
<a href="#l8.60"></a><span id="l8.60">   char *out = (char *) buffer;</span>
<a href="#l8.61"></a><span id="l8.61">   char token [4];</span>
<a href="#l8.62"></a><span id="l8.62">   int i;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineat">@@ -316,27 +321,29 @@ mime_decode_base64_buffer (MimeDecoderDa</span>
<a href="#l8.64"></a><span id="l8.64">     else</span>
<a href="#l8.65"></a><span id="l8.65">     {</span>
<a href="#l8.66"></a><span id="l8.66">       int n = mime_decode_base64_token (token, out);</span>
<a href="#l8.67"></a><span id="l8.67">       /* Advance &quot;out&quot; by the number of bytes just written to it. */</span>
<a href="#l8.68"></a><span id="l8.68">       out += n;</span>
<a href="#l8.69"></a><span id="l8.69">     }</span>
<a href="#l8.70"></a><span id="l8.70">   }</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  if (outSize)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    *outSize = out - buffer;</span>
<a href="#l8.74"></a><span id="l8.74">   /* Now that we've altered the data in place, write it. */</span>
<a href="#l8.75"></a><span id="l8.75">   if (out &gt; buffer)</span>
<a href="#l8.76"></a><span id="l8.76">   return data-&gt;write_buffer (buffer, (out - buffer), data-&gt;closure);</span>
<a href="#l8.77"></a><span id="l8.77">   else</span>
<a href="#l8.78"></a><span id="l8.78">   return 1;</span>
<a href="#l8.79"></a><span id="l8.79"> }</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82"> static int</span>
<a href="#l8.83"></a><span id="l8.83"> mime_decode_uue_buffer (MimeDecoderData *data,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-            const char *input_buffer, PRInt32 input_length)</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+            const char *input_buffer, PRInt32 input_length, PRInt32 *outSize)</span>
<a href="#l8.86"></a><span id="l8.86"> {</span>
<a href="#l8.87"></a><span id="l8.87">   /* First, copy input_buffer into state-&gt;line_buffer until we have</span>
<a href="#l8.88"></a><span id="l8.88">    a complete line.</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">    Then decode that line in place (in the line_buffer) and write</span>
<a href="#l8.91"></a><span id="l8.91">    it out.</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">    Then pull the next line into line_buffer and continue.</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineat">@@ -542,16 +549,20 @@ mime_decode_uue_buffer (MimeDecoderData </span>
<a href="#l8.95"></a><span id="l8.95"> # undef DEC</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">       /* Now write out what we decoded for this line.</span>
<a href="#l8.98"></a><span id="l8.98">        */</span>
<a href="#l8.99"></a><span id="l8.99">       NS_ASSERTION(out &gt;= line &amp;&amp; out &lt; in, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l8.100"></a><span id="l8.100">       if (out &gt; line)</span>
<a href="#l8.101"></a><span id="l8.101">       status = data-&gt;write_buffer (line, (out - line), data-&gt;closure);</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+      // The assertion above tells us this is &gt;= 0</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+      if (outSize)</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+        *outSize = out - line;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107">       /* Reset the line so that we don't think it's partial next time. */</span>
<a href="#l8.108"></a><span id="l8.108">       *line = 0;</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110">       if (status &lt; 0) /* abort */</span>
<a href="#l8.111"></a><span id="l8.111">       goto DONE;</span>
<a href="#l8.112"></a><span id="l8.112">     }</span>
<a href="#l8.113"></a><span id="l8.113">   }</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115" class="difflineat">@@ -559,17 +570,17 @@ mime_decode_uue_buffer (MimeDecoderData </span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">  DONE:</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">   return status;</span>
<a href="#l8.120"></a><span id="l8.120"> }</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122"> static int</span>
<a href="#l8.123"></a><span id="l8.123"> mime_decode_yenc_buffer (MimeDecoderData *data,</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-            const char *input_buffer, PRInt32 input_length)</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+            const char *input_buffer, PRInt32 input_length, PRInt32 *outSize)</span>
<a href="#l8.126"></a><span id="l8.126"> {</span>
<a href="#l8.127"></a><span id="l8.127">   /* First, copy input_buffer into state-&gt;line_buffer until we have</span>
<a href="#l8.128"></a><span id="l8.128">    a complete line.</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130">    Then decode that line in place (in the line_buffer) and write</span>
<a href="#l8.131"></a><span id="l8.131">    it out.</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133">    Then pull the next line into line_buffer and continue.</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineat">@@ -733,16 +744,20 @@ mime_decode_yenc_buffer (MimeDecoderData</span>
<a href="#l8.135"></a><span id="l8.135">             return -1;  /* last character cannot be escape char */</span>
<a href="#l8.136"></a><span id="l8.136">           c -= 64;</span>
<a href="#l8.137"></a><span id="l8.137">         }</span>
<a href="#l8.138"></a><span id="l8.138">         c -= 42;</span>
<a href="#l8.139"></a><span id="l8.139">         *dest = c;</span>
<a href="#l8.140"></a><span id="l8.140">         dest ++;</span>
<a href="#l8.141"></a><span id="l8.141">       }</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      // The assertion below is helpful, too</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      if (outSize)</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+        *outSize = dest - line;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+</span>
<a href="#l8.147"></a><span id="l8.147">       /* Now write out what we decoded for this line. */</span>
<a href="#l8.148"></a><span id="l8.148">       NS_ASSERTION(dest &gt;= line &amp;&amp; dest &lt; src, &quot;nothing to write!&quot;);</span>
<a href="#l8.149"></a><span id="l8.149">       if (dest &gt; line)</span>
<a href="#l8.150"></a><span id="l8.150">       {</span>
<a href="#l8.151"></a><span id="l8.151">         status = data-&gt;write_buffer (line, dest - line, data-&gt;closure);</span>
<a href="#l8.152"></a><span id="l8.152">         if (status &lt; 0) /* abort */</span>
<a href="#l8.153"></a><span id="l8.153">           return status;</span>
<a href="#l8.154"></a><span id="l8.154">       }</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineat">@@ -823,30 +838,31 @@ MimeUUDecoderInit (nsresult (*output_fn)</span>
<a href="#l8.156"></a><span id="l8.156"> MimeDecoderData *</span>
<a href="#l8.157"></a><span id="l8.157"> MimeYDecoderInit (nsresult (*output_fn) (const char *, PRInt32, void *),</span>
<a href="#l8.158"></a><span id="l8.158">            void *closure)</span>
<a href="#l8.159"></a><span id="l8.159"> {</span>
<a href="#l8.160"></a><span id="l8.160">   return mime_decoder_init (mime_yencode, output_fn, closure);</span>
<a href="#l8.161"></a><span id="l8.161"> }</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163"> int</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-MimeDecoderWrite (MimeDecoderData *data, const char *buffer, PRInt32 size)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+MimeDecoderWrite (MimeDecoderData *data, const char *buffer, PRInt32 size,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+          PRInt32 *outSize)</span>
<a href="#l8.167"></a><span id="l8.167"> {</span>
<a href="#l8.168"></a><span id="l8.168">   NS_ASSERTION(data, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l8.169"></a><span id="l8.169">   if (!data) return -1;</span>
<a href="#l8.170"></a><span id="l8.170">   switch(data-&gt;encoding)</span>
<a href="#l8.171"></a><span id="l8.171">   {</span>
<a href="#l8.172"></a><span id="l8.172">   case mime_Base64:</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    return mime_decode_base64_buffer (data, buffer, size);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    return mime_decode_base64_buffer (data, buffer, size, outSize);</span>
<a href="#l8.175"></a><span id="l8.175">   case mime_QuotedPrintable:</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    return mime_decode_qp_buffer (data, buffer, size);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    return mime_decode_qp_buffer (data, buffer, size, outSize);</span>
<a href="#l8.178"></a><span id="l8.178">   case mime_uuencode:</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    return mime_decode_uue_buffer (data, buffer, size);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    return mime_decode_uue_buffer (data, buffer, size, outSize);</span>
<a href="#l8.181"></a><span id="l8.181">   case mime_yencode:</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-    return mime_decode_yenc_buffer (data, buffer, size);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    return mime_decode_yenc_buffer (data, buffer, size, outSize);</span>
<a href="#l8.184"></a><span id="l8.184">   default:</span>
<a href="#l8.185"></a><span id="l8.185">     NS_ERROR(&quot;Invalid decoding&quot;);</span>
<a href="#l8.186"></a><span id="l8.186">     return -1;</span>
<a href="#l8.187"></a><span id="l8.187">   }</span>
<a href="#l8.188"></a><span id="l8.188"> }</span>
<a href="#l8.189"></a><span id="l8.189"> </span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191"> /* ================== Encoders.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/src/mimeeobj.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/src/mimeeobj.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -210,19 +210,19 @@ GOTTA STILL DO THIS FOR QUOTING!</span>
<a href="#l9.4"></a><span id="l9.4"> }</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> static int</span>
<a href="#l9.7"></a><span id="l9.7"> MimeExternalObject_parse_buffer (const char *buffer, PRInt32 size, MimeObject *obj)</span>
<a href="#l9.8"></a><span id="l9.8"> {</span>
<a href="#l9.9"></a><span id="l9.9">   NS_ASSERTION(!obj-&gt;closed_p, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l9.10"></a><span id="l9.10">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    obj-&gt;options &amp;&amp;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    !obj-&gt;options-&gt;write_html_p)</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  // If we want to stream anyway, or we have a good reason to stream</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  if ((obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_all_attachments) ||</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+      obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; !obj-&gt;options-&gt;write_html_p)</span>
<a href="#l9.18"></a><span id="l9.18">   {</span>
<a href="#l9.19"></a><span id="l9.19">     /* The data will be base64-decoded and passed to</span>
<a href="#l9.20"></a><span id="l9.20">      MimeExternalObject_parse_decoded_buffer. */</span>
<a href="#l9.21"></a><span id="l9.21">     return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_buffer(buffer, size,</span>
<a href="#l9.22"></a><span id="l9.22">                                 obj);</span>
<a href="#l9.23"></a><span id="l9.23">   }</span>
<a href="#l9.24"></a><span id="l9.24">   else</span>
<a href="#l9.25"></a><span id="l9.25">   {</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineat">@@ -241,25 +241,32 @@ MimeExternalObject_parse_decoded_buffer </span>
<a href="#l9.27"></a><span id="l9.27">    the case where we're not emitting HTML, and want access to the raw</span>
<a href="#l9.28"></a><span id="l9.28">    data itself.</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">    We override the `parse_decoded_buffer' method provided by MimeLeaf</span>
<a href="#l9.31"></a><span id="l9.31">    because, unlike most children of MimeLeaf, we do not want to line-</span>
<a href="#l9.32"></a><span id="l9.32">    buffer the decoded data -- we want to simply pass it along to the</span>
<a href="#l9.33"></a><span id="l9.33">    backend, without going through our `parse_line' method.</span>
<a href="#l9.34"></a><span id="l9.34">    */</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  if (!obj-&gt;output_p ||</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    !obj-&gt;options ||</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    obj-&gt;options-&gt;write_html_p)</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  // So unless it's intentional and we do want to actually stream it...</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  if (!(obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_all_attachments) &amp;&amp;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      (!obj-&gt;output_p || !obj-&gt;options || obj-&gt;options-&gt;write_html_p))</span>
<a href="#l9.41"></a><span id="l9.41">   {</span>
<a href="#l9.42"></a><span id="l9.42">     NS_ERROR(&quot;MimeObject is missing some data&quot;);</span>
<a href="#l9.43"></a><span id="l9.43">     return -1;</span>
<a href="#l9.44"></a><span id="l9.44">   }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-  return MimeObject_write(obj, buf, size, PR_TRUE);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  /* Don't do a roundtrip through XPConnect when we're only interested in</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+   * metadata and size. 0 means ok, the caller just checks for negative return</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+   * value</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+   */</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_all_attachments)</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    return 0;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  else</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    return MimeObject_write(obj, buf, size, PR_TRUE);</span>
<a href="#l9.55"></a><span id="l9.55"> }</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58"> static int</span>
<a href="#l9.59"></a><span id="l9.59"> MimeExternalObject_parse_line (const char *line, PRInt32 length, MimeObject *obj)</span>
<a href="#l9.60"></a><span id="l9.60"> {</span>
<a href="#l9.61"></a><span id="l9.61">   NS_ERROR(&quot;This method should never be called (externals do no line buffering).&quot;);</span>
<a href="#l9.62"></a><span id="l9.62">   return -1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1555,16 +1555,20 @@ mime_parse_url_options(const char *url, </span>
<a href="#l10.4"></a><span id="l10.4">         //  really appreciates.</span>
<a href="#l10.5"></a><span id="l10.5">         options-&gt;show_attachment_inline_p = PR_TRUE;</span>
<a href="#l10.6"></a><span id="l10.6">         // however, show_attachment_inline_p also results in a few</span>
<a href="#l10.7"></a><span id="l10.7">         //  subclasses writing junk into the body for display purposes.</span>
<a href="#l10.8"></a><span id="l10.8">         // put a stop to these shenanigans by enabling write_pure_bodies.</span>
<a href="#l10.9"></a><span id="l10.9">         //  current offenders are:</span>
<a href="#l10.10"></a><span id="l10.10">         //  - MimeInlineImage</span>
<a href="#l10.11"></a><span id="l10.11">         options-&gt;write_pure_bodies = PR_TRUE;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+        // we also want (in this case) libmime to decode all attachments, not</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        // just the ones it displays inline, so that we can count the bytes and</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+        // notify the js mime emitter about the total size of attachments</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+        options-&gt;stream_all_attachments = PR_TRUE;</span>
<a href="#l10.16"></a><span id="l10.16">       }</span>
<a href="#l10.17"></a><span id="l10.17">     }</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">     q = end;</span>
<a href="#l10.20"></a><span id="l10.20">     if (*q)</span>
<a href="#l10.21"></a><span id="l10.21">       q++;</span>
<a href="#l10.22"></a><span id="l10.22">   }</span>
<a href="#l10.23"></a><span id="l10.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -216,16 +216,23 @@ MimeInlineImage_parse_decoded_buffer (co</span>
<a href="#l11.4"></a><span id="l11.4"> {</span>
<a href="#l11.5"></a><span id="l11.5">   /* This is called (by MimeLeafClass-&gt;parse_buffer) with blocks of data</span>
<a href="#l11.6"></a><span id="l11.6">    that have already been base64-decoded.  Pass this raw image data</span>
<a href="#l11.7"></a><span id="l11.7">    along to the backend-specific image display code.</span>
<a href="#l11.8"></a><span id="l11.8">    */</span>
<a href="#l11.9"></a><span id="l11.9">   MimeInlineImage *img  = (MimeInlineImage *) obj;</span>
<a href="#l11.10"></a><span id="l11.10">   int status;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  /* Don't do a roundtrip through XPConnect when we're only interested in</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+   * metadata and size. 0 means ok, the caller just checks for negative return</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+   * value</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+   */</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;stream_all_attachments)</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    return 0;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+</span>
<a href="#l11.19"></a><span id="l11.19">   if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l11.20"></a><span id="l11.20">     obj-&gt;options &amp;&amp;</span>
<a href="#l11.21"></a><span id="l11.21">     !obj-&gt;options-&gt;write_html_p)</span>
<a href="#l11.22"></a><span id="l11.22">   {</span>
<a href="#l11.23"></a><span id="l11.23">     /* in this case, we just want the raw data...</span>
<a href="#l11.24"></a><span id="l11.24">      Make the stream, if it's not made, and dump the data out.</span>
<a href="#l11.25"></a><span id="l11.25">      */</span>
<a href="#l11.26"></a><span id="l11.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/mimeleaf.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/mimeleaf.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -111,16 +111,19 @@ MimeLeaf_finalize (MimeObject *object)</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> static int</span>
<a href="#l12.7"></a><span id="l12.7"> MimeLeaf_parse_begin (MimeObject *obj)</span>
<a href="#l12.8"></a><span id="l12.8"> {</span>
<a href="#l12.9"></a><span id="l12.9">   MimeLeaf *leaf = (MimeLeaf *) obj;</span>
<a href="#l12.10"></a><span id="l12.10">   MimeDecoderData *(*fn) (nsresult (*) (const char*, PRInt32, void*), void*) = 0;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  // Initial size is zero</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  leaf-&gt;sizeSoFar = 0;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15">   /* Initialize a decoder if necessary.</span>
<a href="#l12.16"></a><span id="l12.16">    */</span>
<a href="#l12.17"></a><span id="l12.17">   if (!obj-&gt;encoding)</span>
<a href="#l12.18"></a><span id="l12.18">   ;</span>
<a href="#l12.19"></a><span id="l12.19">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_BASE64))</span>
<a href="#l12.20"></a><span id="l12.20">   fn = &amp;MimeB64DecoderInit;</span>
<a href="#l12.21"></a><span id="l12.21">   else if (!PL_strcasecmp(obj-&gt;encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l12.22"></a><span id="l12.22">   leaf-&gt;decoder_data = </span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -162,24 +165,31 @@ MimeLeaf_parse_buffer (const char *buffe</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25">   /* If we're not supposed to write this object, bug out now.</span>
<a href="#l12.26"></a><span id="l12.26">    */</span>
<a href="#l12.27"></a><span id="l12.27">   if (!obj-&gt;output_p ||</span>
<a href="#l12.28"></a><span id="l12.28">     !obj-&gt;options ||</span>
<a href="#l12.29"></a><span id="l12.29">     !obj-&gt;options-&gt;output_fn)</span>
<a href="#l12.30"></a><span id="l12.30">   return 0;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  int rv;</span>
<a href="#l12.33"></a><span id="l12.33">   if (leaf-&gt;decoder_data &amp;&amp;</span>
<a href="#l12.34"></a><span id="l12.34">       obj-&gt;options &amp;&amp; </span>
<a href="#l12.35"></a><span id="l12.35">       obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageDecrypt</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-      &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  return MimeDecoderWrite (leaf-&gt;decoder_data, buffer, size);</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  else</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  return ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer (buffer, size,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+      &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach) {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    int outSize = 0;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    rv = MimeDecoderWrite (leaf-&gt;decoder_data, buffer, size, &amp;outSize);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    leaf-&gt;sizeSoFar += outSize;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  }</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  else {</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    rv = ((MimeLeafClass *)obj-&gt;clazz)-&gt;parse_decoded_buffer (buffer, size,</span>
<a href="#l12.47"></a><span id="l12.47">                                 obj);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    leaf-&gt;sizeSoFar += size;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  }</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  return rv;</span>
<a href="#l12.51"></a><span id="l12.51"> }</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53"> static int</span>
<a href="#l12.54"></a><span id="l12.54"> MimeLeaf_parse_line (const char *line, PRInt32 length, MimeObject *obj)</span>
<a href="#l12.55"></a><span id="l12.55"> {</span>
<a href="#l12.56"></a><span id="l12.56">   NS_ERROR(&quot;MimeLeaf_parse_line shouldn't ever be called.&quot;);</span>
<a href="#l12.57"></a><span id="l12.57">   return -1;</span>
<a href="#l12.58"></a><span id="l12.58"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/src/mimeleaf.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/src/mimeleaf.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -73,11 +73,16 @@ struct MimeLeafClass {</span>
<a href="#l13.4"></a><span id="l13.4"> extern MimeLeafClass mimeLeafClass;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> struct MimeLeaf {</span>
<a href="#l13.7"></a><span id="l13.7">   MimeObject object;    /* superclass variables */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   /* If we're doing Base64, Quoted-Printable, or UU decoding, this is the</span>
<a href="#l13.10"></a><span id="l13.10">    state object for the decoder. */</span>
<a href="#l13.11"></a><span id="l13.11">   MimeDecoderData *decoder_data;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  /* We want to count the size of the MimeObject to offer consumers the</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+   * opportunity to display the sizes of attachments.</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+   */</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+  int sizeSoFar;</span>
<a href="#l13.17"></a><span id="l13.17"> };</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> #endif /* _MIMELEAF_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -281,17 +281,17 @@ ValidateRealName(nsMsgAttachmentData *aA</span>
<a href="#l14.4"></a><span id="l14.4">     aAttach-&gt;real_name = ToNewCString(newAttachName);</span>
<a href="#l14.5"></a><span id="l14.5">   }</span>
<a href="#l14.6"></a><span id="l14.6"> }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> static  PRInt32     attIndex = 0;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> nsresult</span>
<a href="#l14.11"></a><span id="l14.11"> GenerateAttachmentData(MimeObject *object, const char *aMessageURL, MimeDisplayOptions *options,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                       PRBool isAnAppleDoublePart, nsMsgAttachmentData *aAttachData)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                       PRBool isAnAppleDoublePart, PRInt32 attSize, nsMsgAttachmentData *aAttachData)</span>
<a href="#l14.14"></a><span id="l14.14"> {</span>
<a href="#l14.15"></a><span id="l14.15">   nsCString imappart;</span>
<a href="#l14.16"></a><span id="l14.16">   nsCString part;</span>
<a href="#l14.17"></a><span id="l14.17">   PRBool isIMAPPart;</span>
<a href="#l14.18"></a><span id="l14.18">   PRBool isExternalAttachment = PR_FALSE;</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   /* be sure the object has not be marked as Not to be an attachment */</span>
<a href="#l14.21"></a><span id="l14.21">   if (object-&gt;dontShowAsAttachment)</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -338,16 +338,17 @@ GenerateAttachmentData(MimeObject *objec</span>
<a href="#l14.23"></a><span id="l14.23">   if ((options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp; (PL_strncasecmp(aMessageURL, urlSpec, strlen(urlSpec)) == 0))</span>
<a href="#l14.24"></a><span id="l14.24">     return NS_OK;</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   nsMsgAttachmentData *tmp = &amp;(aAttachData[attIndex++]);</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   tmp-&gt;real_type = object-&gt;content_type ? strdup(object-&gt;content_type) : nsnull;</span>
<a href="#l14.29"></a><span id="l14.29">   tmp-&gt;real_encoding = object-&gt;encoding ? strdup(object-&gt;encoding) : nsnull;</span>
<a href="#l14.30"></a><span id="l14.30">   tmp-&gt;isExternalAttachment = isExternalAttachment;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  tmp-&gt;size = attSize;</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33">   PRInt32 i;</span>
<a href="#l14.34"></a><span id="l14.34">   char *charset = nsnull;</span>
<a href="#l14.35"></a><span id="l14.35">   char *disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DISPOSITION, PR_FALSE, PR_FALSE);</span>
<a href="#l14.36"></a><span id="l14.36">   if (disp)</span>
<a href="#l14.37"></a><span id="l14.37">   {</span>
<a href="#l14.38"></a><span id="l14.38">     tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nsnull);</span>
<a href="#l14.39"></a><span id="l14.39">     if (isAnAppleDoublePart)</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineat">@@ -512,19 +513,25 @@ BuildAttachmentList(MimeObject *anObject</span>
<a href="#l14.41"></a><span id="l14.41">     PRBool isAnInlineMessage = mime_typep(child, (MimeObjectClass *) &amp;mimeMessageClass);</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43">     // AppleDouble part need special care: we need to fetch the part as well its two</span>
<a href="#l14.44"></a><span id="l14.44">     // children for the needed info as they could be anywhere, eventually, they won't contain</span>
<a href="#l14.45"></a><span id="l14.45">     // a name or file name. In any case we need to build only one attachment data</span>
<a href="#l14.46"></a><span id="l14.46">     PRBool isAnAppleDoublePart = mime_typep(child, (MimeObjectClass *) &amp;mimeMultipartAppleDoubleClass) &amp;&amp;</span>
<a href="#l14.47"></a><span id="l14.47">                                  ((MimeContainer *)child)-&gt;nchildren == 2;</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    // -1 means we don't know the size. So far, we only give the size of leaf</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    // objects</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    PRInt32 attSize = -1;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    if (isALeafObject)</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+      attSize = ((MimeLeaf *)child)-&gt;sizeSoFar;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+</span>
<a href="#l14.55"></a><span id="l14.55">     if (isALeafObject || isAnInlineMessage || isAnAppleDoublePart)</span>
<a href="#l14.56"></a><span id="l14.56">     {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-      rv = GenerateAttachmentData(child, aMessageURL, anObject-&gt;options, isAnAppleDoublePart, aAttachData);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      rv = GenerateAttachmentData(child, aMessageURL, anObject-&gt;options, isAnAppleDoublePart, attSize, aAttachData);</span>
<a href="#l14.59"></a><span id="l14.59">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.60"></a><span id="l14.60">     }</span>
<a href="#l14.61"></a><span id="l14.61"> </span>
<a href="#l14.62"></a><span id="l14.62">     // Now build the attachment list for the children of our object...</span>
<a href="#l14.63"></a><span id="l14.63">     if (!isALeafObject &amp;&amp; !isAnAppleDoublePart)</span>
<a href="#l14.64"></a><span id="l14.64">     {</span>
<a href="#l14.65"></a><span id="l14.65">       rv = BuildAttachmentList((MimeObject *)child, aAttachData, aMessageURL);</span>
<a href="#l14.66"></a><span id="l14.66">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineat">@@ -579,17 +586,17 @@ MimeGetAttachmentList(MimeObject *tobj, </span>
<a href="#l14.68"></a><span id="l14.68">   memset(*data, 0, (n + 1) * sizeof(nsMsgAttachmentData));</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">   // Now, build the list!</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72">   nsresult rv;</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74">   if (isAnInlineMessage)</span>
<a href="#l14.75"></a><span id="l14.75">   {</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-    rv = GenerateAttachmentData(obj, aMessageURL, obj-&gt;options, PR_FALSE, *data);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    rv = GenerateAttachmentData(obj, aMessageURL, obj-&gt;options, PR_FALSE, -1, *data);</span>
<a href="#l14.78"></a><span id="l14.78">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.79"></a><span id="l14.79">   }</span>
<a href="#l14.80"></a><span id="l14.80">   return BuildAttachmentList((MimeObject *) cobj, *data, aMessageURL);</span>
<a href="#l14.81"></a><span id="l14.81"> }</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83"> extern &quot;C&quot; void</span>
<a href="#l14.84"></a><span id="l14.84"> MimeFreeAttachmentList(nsMsgAttachmentData *data)</span>
<a href="#l14.85"></a><span id="l14.85"> {</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineat">@@ -633,38 +640,42 @@ NotifyEmittersOfAttachmentList(MimeDispl</span>
<a href="#l14.87"></a><span id="l14.87">       ++tmp;</span>
<a href="#l14.88"></a><span id="l14.88">       continue;</span>
<a href="#l14.89"></a><span id="l14.89">     }</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91">     nsCAutoString spec;</span>
<a href="#l14.92"></a><span id="l14.92">     if ( tmp-&gt;url )</span>
<a href="#l14.93"></a><span id="l14.93">       tmp-&gt;url-&gt;GetSpec(spec);</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+    nsCAutoString sizeStr;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    sizeStr.AppendInt(tmp-&gt;size);</span>
<a href="#l14.97"></a><span id="l14.97">     mimeEmitterStartAttachment(opt, tmp-&gt;real_name, tmp-&gt;real_type, spec.get(), tmp-&gt;isExternalAttachment);</span>
<a href="#l14.98"></a><span id="l14.98">     mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_URL, spec.get());</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_SIZE, sizeStr.get());</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101">     if ( (opt-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l14.102"></a><span id="l14.102">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting) ||</span>
<a href="#l14.103"></a><span id="l14.103">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) ||</span>
<a href="#l14.104"></a><span id="l14.104">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l14.105"></a><span id="l14.105">     {</span>
<a href="#l14.106"></a><span id="l14.106">       mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_DESCRIPTION, tmp-&gt;description);</span>
<a href="#l14.107"></a><span id="l14.107">       mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_TYPE, tmp-&gt;real_type);</span>
<a href="#l14.108"></a><span id="l14.108">       mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_ENCODING,    tmp-&gt;real_encoding);</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">       /* rhp - for now, just leave these here, but they are really</span>
<a href="#l14.111"></a><span id="l14.111">                not necessary</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-      printf(&quot;URL for Part      : %s\n&quot;, spec);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+      printf(&quot;URL for Part      : %s\n&quot;, spec.get());</span>
<a href="#l14.114"></a><span id="l14.114">       printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;real_name);</span>
<a href="#l14.115"></a><span id="l14.115">       printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;desired_type);</span>
<a href="#l14.116"></a><span id="l14.116">       printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;real_type);</span>
<a href="#l14.117"></a><span id="l14.117">       printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;real_encoding);</span>
<a href="#l14.118"></a><span id="l14.118">       printf(&quot;Description       : %s\n&quot;, tmp-&gt;description);</span>
<a href="#l14.119"></a><span id="l14.119">       printf(&quot;Mac Type          : %s\n&quot;, tmp-&gt;x_mac_type);</span>
<a href="#l14.120"></a><span id="l14.120">       printf(&quot;Mac Creator       : %s\n&quot;, tmp-&gt;x_mac_creator);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+      printf(&quot;Size              : %d\n&quot;, tmp-&gt;size);</span>
<a href="#l14.122"></a><span id="l14.122">       */</span>
<a href="#l14.123"></a><span id="l14.123">     }</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125">     mimeEmitterEndAttachment(opt);</span>
<a href="#l14.126"></a><span id="l14.126">     ++i;</span>
<a href="#l14.127"></a><span id="l14.127">     ++tmp;</span>
<a href="#l14.128"></a><span id="l14.128">   }</span>
<a href="#l14.129"></a><span id="l14.129">   mimeEmitterEndAllAttachments(opt);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineat">@@ -1445,16 +1456,17 @@ MimeDisplayOptions::MimeDisplayOptions()</span>
<a href="#l14.131"></a><span id="l14.131"> </span>
<a href="#l14.132"></a><span id="l14.132">   attachment_icon_layer_id = 0;</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">   missing_parts = PR_FALSE;</span>
<a href="#l14.135"></a><span id="l14.135">   show_attachment_inline_p = PR_FALSE;</span>
<a href="#l14.136"></a><span id="l14.136">   quote_attachment_inline_p = PR_FALSE;</span>
<a href="#l14.137"></a><span id="l14.137">   notify_nested_bodies = PR_FALSE;</span>
<a href="#l14.138"></a><span id="l14.138">   write_pure_bodies = PR_FALSE;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  stream_all_attachments = PR_FALSE;</span>
<a href="#l14.140"></a><span id="l14.140"> }</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142"> MimeDisplayOptions::~MimeDisplayOptions()</span>
<a href="#l14.143"></a><span id="l14.143"> {</span>
<a href="#l14.144"></a><span id="l14.144">   PR_FREEIF(part_to_load);</span>
<a href="#l14.145"></a><span id="l14.145">   PR_FREEIF(default_charset);</span>
<a href="#l14.146"></a><span id="l14.146"> }</span>
<a href="#l14.147"></a><span id="l14.147"> ////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -436,17 +436,17 @@ MimeMultipartSigned_parse_line (const ch</span>
<a href="#l15.4"></a><span id="l15.4">     /* fall through. */</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">   case MimeMultipartSignedSignatureLine:</span>
<a href="#l15.7"></a><span id="l15.7">     if (hash_line_p)</span>
<a href="#l15.8"></a><span id="l15.8">     {</span>
<a href="#l15.9"></a><span id="l15.9">       /* Feed this line into the signature verification routines. */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">       if (sig-&gt;sig_decoder_data)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-      status = MimeDecoderWrite (sig-&gt;sig_decoder_data, line, length);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+      status = MimeDecoderWrite (sig-&gt;sig_decoder_data, line, length, nsnull);</span>
<a href="#l15.14"></a><span id="l15.14">       else</span>
<a href="#l15.15"></a><span id="l15.15">       status = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l15.16"></a><span id="l15.16">             -&gt;crypto_signature_hash (line, length,</span>
<a href="#l15.17"></a><span id="l15.17">                          sig-&gt;crypto_closure));</span>
<a href="#l15.18"></a><span id="l15.18">       if (status &lt; 0) return status;</span>
<a href="#l15.19"></a><span id="l15.19">     }</span>
<a href="#l15.20"></a><span id="l15.20">     break;</span>
<a href="#l15.21"></a><span id="l15.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -162,17 +162,16 @@ MimeMultipart_parse_line (const char *li</span>
<a href="#l16.4"></a><span id="l16.4">      it to HTML, simply pass it through unaltered. */</span>
<a href="#l16.5"></a><span id="l16.5">   if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l16.6"></a><span id="l16.6">     obj-&gt;options &amp;&amp;</span>
<a href="#l16.7"></a><span id="l16.7">     !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l16.8"></a><span id="l16.8">     obj-&gt;options-&gt;output_fn</span>
<a href="#l16.9"></a><span id="l16.9">           &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l16.10"></a><span id="l16.10">   return MimeObject_write(obj, line, length, PR_TRUE);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13">   if (mult-&gt;state == MimeMultipartEpilogue)  /* already done */</span>
<a href="#l16.14"></a><span id="l16.14">     boundary = MimeMultipartBoundaryTypeNone;</span>
<a href="#l16.15"></a><span id="l16.15">   else</span>
<a href="#l16.16"></a><span id="l16.16">     boundary = ((MimeMultipartClass *)obj-&gt;clazz)-&gt;check_boundary(obj, line,</span>
<a href="#l16.17"></a><span id="l16.17">                                                                   length);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   if (boundary == MimeMultipartBoundaryTypeTerminator ||</span>
<a href="#l16.20"></a><span id="l16.20">     boundary == MimeMultipartBoundaryTypeSeparator)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/src/modlmime.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/src/modlmime.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -401,11 +401,18 @@ public:</span>
<a href="#l17.4"></a><span id="l17.4">   PRBool notify_nested_bodies;</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">   /**</span>
<a href="#l17.7"></a><span id="l17.7">    * When true, compels mime parts to only write the actual body</span>
<a href="#l17.8"></a><span id="l17.8">    *  payload and not display-gunk like links to attachments. This was</span>
<a href="#l17.9"></a><span id="l17.9">    *  primarily introduced for the benefit of the javascript emitter.</span>
<a href="#l17.10"></a><span id="l17.10">    */</span>
<a href="#l17.11"></a><span id="l17.11">   PRBool write_pure_bodies;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  /**</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+   * When true, forces all attachments to be decoded and streamed to the mime</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+   *  emitter. At the moment, only the JS mime emitter uses this. Other mime</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+   *  emitters would probably choke.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+   */</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  PRBool stream_all_attachments;</span>
<a href="#l17.19"></a><span id="l17.19"> };</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> #endif /* _MODLMIME_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/src/modmimee.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/src/modmimee.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -87,17 +87,18 @@ MimeEncoderData *MimeQPEncoderInit (nsre</span>
<a href="#l18.4"></a><span id="l18.4"> MimeEncoderData *MimeUUEncoderInit (const char *filename,</span>
<a href="#l18.5"></a><span id="l18.5">                   nsresult (*output_fn) (const char *buf,</span>
<a href="#l18.6"></a><span id="l18.6">                             PRInt32 size,</span>
<a href="#l18.7"></a><span id="l18.7">                             void *closure),</span>
<a href="#l18.8"></a><span id="l18.8">                   void *closure);</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> /* Push data through the encoder/decoder, causing the above-provided write_fn</span>
<a href="#l18.11"></a><span id="l18.11">    to be called with encoded/decoded data. */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-int MimeDecoderWrite (MimeDecoderData *data, const char *buffer, PRInt32 size);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+int MimeDecoderWrite (MimeDecoderData *data, const char *buffer, PRInt32 size,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+                  PRInt32 *outSize);</span>
<a href="#l18.15"></a><span id="l18.15"> int MimeEncoderWrite (MimeEncoderData *data, const char *buffer, PRInt32 size);</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> /* When you're done encoding/decoding, call this to free the data.  If</span>
<a href="#l18.18"></a><span id="l18.18">    abort_p is PR_FALSE, then calling this may cause the write_fn to be called</span>
<a href="#l18.19"></a><span id="l18.19">    one last time (as the last buffered data is flushed out.)</span>
<a href="#l18.20"></a><span id="l18.20">  */</span>
<a href="#l18.21"></a><span id="l18.21"> int MimeDecoderDestroy(MimeDecoderData *data, PRBool abort_p);</span>
<a href="#l18.22"></a><span id="l18.22"> int MimeEncoderDestroy(MimeEncoderData *data, PRBool abort_p);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

