<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10842:71eae60afbf60a611153125ea034c2f92e9ed511</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 71eae60afbf60a611153125ea034c2f92e9ed511" />
<meta property="og:url" content="/comm-central/rev/71eae60afbf60a611153125ea034c2f92e9ed511" />
<meta property="og:description" content="Fix bug 776673 - Allow easily observing all calendars at once. r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 71eae60afbf60a611153125ea034c2f92e9ed511 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/71eae60afbf60a611153125ea034c2f92e9ed511">shortlog</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/71eae60afbf60a611153125ea034c2f92e9ed511">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511">files</a> |
changeset |
<a href="/comm-central/raw-rev/71eae60afbf60a611153125ea034c2f92e9ed511">raw</a>  | <a href="/comm-central/archive/71eae60afbf60a611153125ea034c2f92e9ed511.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=776673">bug 776673</a> - Allow easily observing all calendars at once. r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 Aug 2012 20:37:59 +0200</td></tr>

<tr>
 <td>changeset 10842</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/71eae60afbf60a611153125ea034c2f92e9ed511">71eae60afbf60a611153125ea034c2f92e9ed511</a></td>
</tr>



<tr>
<td>parent 10841</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7ce307d297ff36486fbaaa0b3dc0d78fe13176eb">7ce307d297ff36486fbaaa0b3dc0d78fe13176eb</a>
</td>
</tr>

<tr>
<td>child 10843</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2019e8845fbfd133c0d6dc246c1ae6392dc4cfa6">2019e8845fbfd133c0d6dc246c1ae6392dc4cfa6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=71eae60afbf60a611153125ea034c2f92e9ed511">8141</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Aug 2012 18:38:27 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@71eae60afbf6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=71eae60afbf60a611153125ea034c2f92e9ed511">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=71eae60afbf60a611153125ea034c2f92e9ed511&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71eae60afbf60a611153125ea034c2f92e9ed511&newProject=comm-central&newRevision=71eae60afbf60a611153125ea034c2f92e9ed511&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71eae60afbf60a611153125ea034c2f92e9ed511&newProject=comm-central&newRevision=71eae60afbf60a611153125ea034c2f92e9ed511&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71eae60afbf60a611153125ea034c2f92e9ed511&newProject=comm-central&newRevision=71eae60afbf60a611153125ea034c2f92e9ed511&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=776673">776673</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=776673">bug 776673</a> - Allow easily observing all calendars at once. r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">calendar/base/public/calICalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">calendar/base/public/calICalendarManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/public/calICalendarManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">calendar/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/71eae60afbf60a611153125ea034c2f92e9ed511/calendar/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // New code must not load/import calUtils.js, but should use calUtils.jsm.</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> var gCalThreadingEnabled;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l1.15"></a><span id="l1.15"> let cal = {</span>
<a href="#l1.16"></a><span id="l1.16">     // new code should land here,</span>
<a href="#l1.17"></a><span id="l1.17">     // and more code should be moved from calUtils.js into this object to avoid</span>
<a href="#l1.18"></a><span id="l1.18">     // clashes with other extensions</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">     getThreadManager: generateServiceAccessor(&quot;@mozilla.org/thread-manager;1&quot;,</span>
<a href="#l1.21"></a><span id="l1.21">                                               Components.interfaces.nsIThreadManager),</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -61,16 +63,66 @@ let cal = {</span>
<a href="#l1.23"></a><span id="l1.23">         if (this.threadingEnabled) {</span>
<a href="#l1.24"></a><span id="l1.24">             cal.getThreadManager().currentThread.dispatch({ run: func },</span>
<a href="#l1.25"></a><span id="l1.25">                                                           Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l1.26"></a><span id="l1.26">         } else {</span>
<a href="#l1.27"></a><span id="l1.27">             func();</span>
<a href="#l1.28"></a><span id="l1.28">         }</span>
<a href="#l1.29"></a><span id="l1.29">     },</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    /**</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+     * Create an adapter for the given interface. If passed, methods will be</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+     * added to the template object, otherwise a new object will be returned.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+     *</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+     * @param iface     The interface to adapt (Components.interfaces...)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+     * @param template  (optional) A template object to extend</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+     * @return          If passed the adapted template object, otherwise a</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+     *                    clean adapter.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+     *</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+     * Currently supported interfaces are:</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+     *  - calIObserver</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+     *  - calICalendarManagerObserver</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+     *  - calIOperationListener</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+     *  - calICompositeObserver</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+     */</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    createAdapter: function createAdapter(iface, template) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        let methods;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+        let adapter = template || {};</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        switch (iface) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+            case Components.interfaces.calIObserver:</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+                methods = [&quot;onStartBatch&quot;, &quot;onEndBatch&quot;, &quot;onLoad&quot;, &quot;onAddItem&quot;,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                           &quot;onModifyItem&quot;, &quot;onDeleteItem&quot;, &quot;onError&quot;,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                           &quot;onPropertyChanged&quot;, &quot;onPropertyDeleting&quot;];</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                break;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+            case Components.interfaces.calICalendarManagerObserver:</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                methods = [&quot;onCalendarRegistered&quot;, &quot;onCalendarUnregistering&quot;,</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                           &quot;onCalendarDeleting&quot;];</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+                break;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+            case Components.interfaces.calIOperationListener:</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                methods = [&quot;onGetResult&quot;, &quot;onOperationComplete&quot;];</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                break;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+            case Components.interfaces.calICompositeObserver:</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+                methods = [&quot;onCalendarAdded&quot;, &quot;onCalendarRemoved&quot;,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                           &quot;onDefaultCalendarChanged&quot;];</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+                break;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+            default:</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                methods = [];</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+                break;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+        }</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        for each (let method in methods) {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+            if (!(method in template)) {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+                adapter[method] = function() {};</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+            }</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        }</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+        adapter.QueryInterface = XPCOMUtils.generateQI([iface]);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        return adapter;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    },</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+</span>
<a href="#l1.81"></a><span id="l1.81">     get threadingEnabled() {</span>
<a href="#l1.82"></a><span id="l1.82">         if (gCalThreadingEnabled === undefined) {</span>
<a href="#l1.83"></a><span id="l1.83">             gCalThreadingEnabled = !cal.getPrefSafe(&quot;calendar.threading.disabled&quot;, false);</span>
<a href="#l1.84"></a><span id="l1.84">         }</span>
<a href="#l1.85"></a><span id="l1.85">         return gCalThreadingEnabled;</span>
<a href="#l1.86"></a><span id="l1.86">     },</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/public/calICalendar.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/public/calICalendar.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -528,16 +528,19 @@ interface calICompositeCalendar : calICa</span>
<a href="#l2.4"></a><span id="l2.4">    * Sets a statusobserver for status notifications like startMeteors() and StopMeteors().</span>
<a href="#l2.5"></a><span id="l2.5">    */</span>
<a href="#l2.6"></a><span id="l2.6">   void setStatusObserver(in calIStatusObserver aStatusObserver, in nsIDOMChromeWindow aWindow);</span>
<a href="#l2.7"></a><span id="l2.7"> };</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> /**</span>
<a href="#l2.10"></a><span id="l2.10">  * Make a more general nsIObserverService2 and friends to support</span>
<a href="#l2.11"></a><span id="l2.11">  * nsISupports data and use that instead?</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * NOTE: When adding methods here, please also add them in calUtils.jsm's</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * createAdapter() method.</span>
<a href="#l2.15"></a><span id="l2.15">  */</span>
<a href="#l2.16"></a><span id="l2.16"> [scriptable, uuid(2953c9b2-2c73-11d9-80b6-00045ace3b8d)]</span>
<a href="#l2.17"></a><span id="l2.17"> interface calIObserver : nsISupports</span>
<a href="#l2.18"></a><span id="l2.18"> {</span>
<a href="#l2.19"></a><span id="l2.19">   void onStartBatch();</span>
<a href="#l2.20"></a><span id="l2.20">   void onEndBatch();</span>
<a href="#l2.21"></a><span id="l2.21">   void onLoad( in calICalendar aCalendar );</span>
<a href="#l2.22"></a><span id="l2.22">   void onAddItem( in calIItemBase aItem );</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -567,16 +570,19 @@ interface calICompositeObserver : calIOb</span>
<a href="#l2.24"></a><span id="l2.24">   void onCalendarRemoved( in calICalendar aCalendar );</span>
<a href="#l2.25"></a><span id="l2.25">   void onDefaultCalendarChanged( in calICalendar aNewDefaultCalendar );</span>
<a href="#l2.26"></a><span id="l2.26"> };</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> /**</span>
<a href="#l2.29"></a><span id="l2.29">  * Async operations are called back via this interface.  If you know that your</span>
<a href="#l2.30"></a><span id="l2.30">  * object is not going to get called back for either of these methods, having</span>
<a href="#l2.31"></a><span id="l2.31">  * them return NS_ERROR_NOT_IMPLEMENTED is reasonable.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ *</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * NOTE: When adding methods here, please also add them in calUtils.jsm's</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ * createAdapter() method.</span>
<a href="#l2.35"></a><span id="l2.35">  */</span>
<a href="#l2.36"></a><span id="l2.36"> [scriptable, uuid(ed3d87d8-2c77-11d9-8f5f-00045ace3b8d)]</span>
<a href="#l2.37"></a><span id="l2.37"> interface calIOperationListener : nsISupports</span>
<a href="#l2.38"></a><span id="l2.38"> {</span>
<a href="#l2.39"></a><span id="l2.39">   /**</span>
<a href="#l2.40"></a><span id="l2.40">    * For add, modify, and delete.</span>
<a href="#l2.41"></a><span id="l2.41">    *</span>
<a href="#l2.42"></a><span id="l2.42">    * @param aCalendar       the calICalendar on which the operation took place</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/public/calICalendarManager.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/public/calICalendarManager.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,21 +1,22 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> interface calICalendar;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+interface calIObserver;</span>
<a href="#l3.12"></a><span id="l3.12"> interface nsIURI;</span>
<a href="#l3.13"></a><span id="l3.13"> interface nsIVariant;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> interface calICalendarManagerObserver;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-[scriptable, uuid(43a71d40-7807-4e2f-b741-2926ee73f89a)]</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+[scriptable, uuid(613fb99f-359c-4a12-9c87-10b2b968f8cd)]</span>
<a href="#l3.19"></a><span id="l3.19"> interface calICalendarManager : nsISupports</span>
<a href="#l3.20"></a><span id="l3.20"> {</span>
<a href="#l3.21"></a><span id="l3.21">   /**</span>
<a href="#l3.22"></a><span id="l3.22">    * Gives the number of registered calendars that require network access.</span>
<a href="#l3.23"></a><span id="l3.23">    */</span>
<a href="#l3.24"></a><span id="l3.24">   readonly attribute PRUint32 networkCalendarCount;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   /***</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineat">@@ -44,36 +45,49 @@ interface calICalendarManager : nsISuppo</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   /* get a calendar by its id */</span>
<a href="#l3.30"></a><span id="l3.30">   calICalendar getCalendarById(in AUTF8String aId);</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">   /* return a list of all calendars currently registered */</span>
<a href="#l3.33"></a><span id="l3.33">   void getCalendars(out PRUint32 count,</span>
<a href="#l3.34"></a><span id="l3.34">                     [array, size_is(count), retval] out calICalendar aCalendars);</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  /** Add an observer for the calendar manager, i.e when calendars are registered */</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  void addObserver(in calICalendarManagerObserver aObserver);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  /** Remove an observer for the calendar manager */</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  void removeObserver(in calICalendarManagerObserver aObserver);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  /** Add an observer to handle changes to all calendars (even disabled or unchecked ones) */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  void addCalendarObserver(in calIObserver aObserver);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  /** Remove an observer to handle changes to all calendars */</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  void removeCalendarObserver(in calIObserver aObserver);</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   /* XXX private, don't use:</span>
<a href="#l3.47"></a><span id="l3.47">          will vanish as soon as providers will directly read/write from moz prefs</span>
<a href="#l3.48"></a><span id="l3.48">   */</span>
<a href="#l3.49"></a><span id="l3.49">   nsIVariant getCalendarPref_(in calICalendar aCalendar,</span>
<a href="#l3.50"></a><span id="l3.50">                               in AUTF8String aName);</span>
<a href="#l3.51"></a><span id="l3.51">   void setCalendarPref_(in calICalendar aCalendar,</span>
<a href="#l3.52"></a><span id="l3.52">                         in nsIVariant aName,</span>
<a href="#l3.53"></a><span id="l3.53">                         in nsIVariant aValue);</span>
<a href="#l3.54"></a><span id="l3.54">   void deleteCalendarPref_(in calICalendar aCalendar,</span>
<a href="#l3.55"></a><span id="l3.55">                            in AUTF8String aName);</span>
<a href="#l3.56"></a><span id="l3.56">   </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  void addObserver(in calICalendarManagerObserver aObserver);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  void removeObserver(in calICalendarManagerObserver aObserver);</span>
<a href="#l3.59"></a><span id="l3.59"> };</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+/**</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * Observer to handle actions done by the calendar manager</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ *</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+ * NOTE: When adding methods here, please also add them in calUtils.jsm's</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+ * createAdapter() method.</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+ */</span>
<a href="#l3.67"></a><span id="l3.67"> [scriptable, uuid(383f36f1-e669-4ca4-be7f-06b43910f44a)]</span>
<a href="#l3.68"></a><span id="l3.68"> interface calICalendarManagerObserver : nsISupports</span>
<a href="#l3.69"></a><span id="l3.69"> {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  // called after the calendar is registered</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  /** Called after the calendar is registered */</span>
<a href="#l3.72"></a><span id="l3.72">   void onCalendarRegistered(in calICalendar aCalendar);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  // called before the unregister actually takes place</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  /** Called before the unregister actually takes place */</span>
<a href="#l3.76"></a><span id="l3.76">   void onCalendarUnregistering(in calICalendar aCalendar);</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  // called before the delete actually takes place</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  /** Called before the delete actually takes place */</span>
<a href="#l3.80"></a><span id="l3.80">   void onCalendarDeleting(in calICalendar aCalendar);</span>
<a href="#l3.81"></a><span id="l3.81"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,123 +5,41 @@</span>
<a href="#l4.4"></a><span id="l4.4"> Components.utils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> const REGISTRY_BRANCH = &quot;calendar.registry.&quot;;</span>
<a href="#l4.10"></a><span id="l4.10"> const DB_SCHEMA_VERSION = 10;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function getPrefBranchFor(id) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    return (REGISTRY_BRANCH + id + &quot;.&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-}</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-/**</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">- * Helper function to flush the preferences file. If the application crashes</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">- * after a calendar has been created using the prefs registry, then the calendar</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">- * won't show up. Writing the prefs helps counteract.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">- */</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-function flushPrefs() {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-              .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-              .savePrefFile(null);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-}</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-/**</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">- * Callback object for the refresh timer. Should be called as an object, i.e</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">- * let foo = new timerCallback(calendar);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">- *</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">- * @param aCalendar     The calendar to refresh on notification</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">- */</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-function timerCallback(aCalendar) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    this.notify = function refreshNotify(aTimer) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-        if (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-            aCalendar.refresh();</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-        }</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    }</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-}</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-var gCalendarManagerAddonListener = {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    onDisabling: function(aAddon, aNeedsRestart) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-            // If the addon should not be disabled, then re-enable it.</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-            aAddon.userDisabled = false;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-        }</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    },</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    onUninstalling: function(aAddon, aNeedsRestart) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-        if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-            // If the addon should not be uninstalled, then cancel the uninstall.</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-            aAddon.cancelUninstall();</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-        }</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    },</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    queryUninstallProvider: function(aAddon) {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-        const uri = &quot;chrome://calendar/content/calendar-providerUninstall-dialog.xul&quot;;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-        const features = &quot;chrome,titlebar,resizable,modal&quot;;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        let calMgr = cal.getCalendarManager();</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-        let affectedCalendars =</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-            [ calendar for each (calendar in calMgr.getCalendars({}))</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-              if (calendar.providerID == aAddon.id) ];</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-        if (!affectedCalendars.length) {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-            // If no calendars are affected, then everything is fine.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-            return true;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-        }</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-        let args = { shouldUninstall: false, extension: aAddon };</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-        // Now find a window. The best choice would be the most recent</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-        // addons window, otherwise the most recent calendar window, or we</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-        // create a new toplevel window.</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-        let win = Services.wm.getMostRecentWindow(&quot;Extension:Manager&quot;) ||</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-                  cal.getCalendarWindow();</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-        if (win) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-            win.openDialog(uri, &quot;CalendarProviderUninstallDialog&quot;, features, args);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        } else {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-            // Use the window watcher to open a parentless window.</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-            Services.ww.openWindow(null, uri, &quot;CalendarProviderUninstallWindow&quot;, features, args);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-        }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-        // Now that we are done, check if the dialog was accepted or canceled.</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-        return args.shouldUninstall;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-    }</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-};</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-</span>
<a href="#l4.88"></a><span id="l4.88"> function calCalendarManager() {</span>
<a href="#l4.89"></a><span id="l4.89">     this.wrappedJSObject = this;</span>
<a href="#l4.90"></a><span id="l4.90">     this.mObservers = new calListenerBag(Components.interfaces.calICalendarManagerObserver);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    this.mCalendarObservers = new calListenerBag(Components.interfaces.calIObserver);</span>
<a href="#l4.92"></a><span id="l4.92"> }</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94"> calCalendarManager.prototype = {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/manager;1&quot;,</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    classDescription: &quot;Calendar Manager&quot;,</span>
<a href="#l4.97"></a><span id="l4.97">     classID: Components.ID(&quot;{f42585e7-e736-4600-985d-9624c1c51992}&quot;),</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        Components.interfaces.calICalendarManager,</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+        Components.interfaces.calIStartupService,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        Components.interfaces.nsIObserver,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    ]),</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-        let ifaces = [</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+        classID: Components.ID(&quot;{f42585e7-e736-4600-985d-9624c1c51992}&quot;),</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/manager;1&quot;,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+        classDescription: &quot;Calendar Manager&quot;,</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        interfaces: [</span>
<a href="#l4.112"></a><span id="l4.112">             Components.interfaces.calICalendarManager,</span>
<a href="#l4.113"></a><span id="l4.113">             Components.interfaces.calIStartupService,</span>
<a href="#l4.114"></a><span id="l4.114">             Components.interfaces.nsIObserver,</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-            Components.interfaces.nsIClassInfo</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-        ];</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-        return ifaces;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    },</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-        return null;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-    flags: Components.interfaces.nsIClassInfo.SINGLETON,</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-    QueryInterface: function (aIID) {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-        return cal.doQueryInterface(this, calCalendarManager.prototype, aIID, null, this);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-    },</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        ],</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+        flags: Components.interfaces.nsIClassInfo.SINGLETON</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    }),</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">     get networkCalendarCount() {</span>
<a href="#l4.135"></a><span id="l4.135">         return this.mNetworkCalendarCount;</span>
<a href="#l4.136"></a><span id="l4.136">     },</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">     get readOnlyCalendarCount() {</span>
<a href="#l4.139"></a><span id="l4.139">         return this.mReadonlyCalendarCount;</span>
<a href="#l4.140"></a><span id="l4.140">     },</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineat">@@ -556,20 +474,16 @@ calCalendarManager.prototype = {</span>
<a href="#l4.142"></a><span id="l4.142">             AddonManager.getAddonByID(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;, function getLightningExt(aAddon) {</span>
<a href="#l4.143"></a><span id="l4.143">                 aAddon.userDisabled = true;</span>
<a href="#l4.144"></a><span id="l4.144">                 startup.quit(Components.interfaces.nsIAppStartup.eRestart |</span>
<a href="#l4.145"></a><span id="l4.145">                     Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l4.146"></a><span id="l4.146">             });</span>
<a href="#l4.147"></a><span id="l4.147">         }</span>
<a href="#l4.148"></a><span id="l4.148">     },</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-    notifyObservers: function(functionName, args) {</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-        this.mObservers.notify(functionName, args);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-    },</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-</span>
<a href="#l4.154"></a><span id="l4.154">     /**</span>
<a href="#l4.155"></a><span id="l4.155">      * calICalendarManager interface</span>
<a href="#l4.156"></a><span id="l4.156">      */</span>
<a href="#l4.157"></a><span id="l4.157">     createCalendar: function cmgr_createCalendar(type, uri) {</span>
<a href="#l4.158"></a><span id="l4.158">         try {</span>
<a href="#l4.159"></a><span id="l4.159">             if (!Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]) {</span>
<a href="#l4.160"></a><span id="l4.160">                 // Don't notify the user with an extra dialog if the provider</span>
<a href="#l4.161"></a><span id="l4.161">                 // interface is missing.</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineat">@@ -585,16 +499,17 @@ calCalendarManager.prototype = {</span>
<a href="#l4.163"></a><span id="l4.163">             if (ex instanceof Components.interfaces.nsIException) {</span>
<a href="#l4.164"></a><span id="l4.164">                 rc = ex.result;</span>
<a href="#l4.165"></a><span id="l4.165">                 uiMessage = ex.message;</span>
<a href="#l4.166"></a><span id="l4.166">             }</span>
<a href="#l4.167"></a><span id="l4.167">             switch (rc) {</span>
<a href="#l4.168"></a><span id="l4.168">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l4.169"></a><span id="l4.169">                     // For now we alert and quit on schema errors like we've done before:</span>
<a href="#l4.170"></a><span id="l4.170">                     this.alertAndQuit();</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+                    return;</span>
<a href="#l4.172"></a><span id="l4.172">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l4.173"></a><span id="l4.173">                     uiMessage = calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l4.174"></a><span id="l4.174">                     break;</span>
<a href="#l4.175"></a><span id="l4.175">                 default:</span>
<a href="#l4.176"></a><span id="l4.176">                     uiMessage = calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l4.177"></a><span id="l4.177">                     break;</span>
<a href="#l4.178"></a><span id="l4.178">             }</span>
<a href="#l4.179"></a><span id="l4.179">             // Log the original exception via error console to provide more debug info</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineat">@@ -770,31 +685,29 @@ calCalendarManager.prototype = {</span>
<a href="#l4.181"></a><span id="l4.181">         return calendars;</span>
<a href="#l4.182"></a><span id="l4.182">     },</span>
<a href="#l4.183"></a><span id="l4.183"> </span>
<a href="#l4.184"></a><span id="l4.184">     assureCache: function cmgr_assureCache() {</span>
<a href="#l4.185"></a><span id="l4.185">         if (!this.mCache) {</span>
<a href="#l4.186"></a><span id="l4.186">             this.mCache = {};</span>
<a href="#l4.187"></a><span id="l4.187">             this.mCalObservers = {};</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-            let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-                                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.191"></a><span id="l4.191">             let allCals = {};</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-            for each (let key in prefService.getChildList(REGISTRY_BRANCH)) { // merge down all keys</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+            for each (let key in Services.prefs.getChildList(REGISTRY_BRANCH)) { // merge down all keys</span>
<a href="#l4.194"></a><span id="l4.194">                 allCals[key.substring(0, key.indexOf(&quot;.&quot;, REGISTRY_BRANCH.length))] = true;</span>
<a href="#l4.195"></a><span id="l4.195">             }</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197">             for (let calBranch in allCals) {</span>
<a href="#l4.198"></a><span id="l4.198">                 let id = calBranch.substring(REGISTRY_BRANCH.length);</span>
<a href="#l4.199"></a><span id="l4.199">                 let ctype = cal.getPrefSafe(calBranch + &quot;.type&quot;, null);</span>
<a href="#l4.200"></a><span id="l4.200">                 let curi = cal.getPrefSafe(calBranch + &quot;.uri&quot;, null);</span>
<a href="#l4.201"></a><span id="l4.201"> </span>
<a href="#l4.202"></a><span id="l4.202">                 try {</span>
<a href="#l4.203"></a><span id="l4.203">                     if (!ctype || !curi) { // sanity check</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-                        prefService.deleteBranch(calBranch + &quot;.&quot;);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+                        Services.prefs.deleteBranch(calBranch + &quot;.&quot;);</span>
<a href="#l4.206"></a><span id="l4.206">                         continue;</span>
<a href="#l4.207"></a><span id="l4.207">                     }</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209">                     let uri = cal.makeURL(curi);</span>
<a href="#l4.210"></a><span id="l4.210">                     let calendar = this.createCalendar(ctype, uri);</span>
<a href="#l4.211"></a><span id="l4.211">                     if (calendar) {</span>
<a href="#l4.212"></a><span id="l4.212">                         calendar.id = id;</span>
<a href="#l4.213"></a><span id="l4.213">                         if (calendar.getProperty(&quot;auto-enabled&quot;)) {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineat">@@ -847,47 +760,42 @@ calCalendarManager.prototype = {</span>
<a href="#l4.215"></a><span id="l4.215">     },</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217">     setCalendarPref_: function(calendar, name, value) {</span>
<a href="#l4.218"></a><span id="l4.218">         cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l4.219"></a><span id="l4.219">         cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l4.220"></a><span id="l4.220">         cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l4.221"></a><span id="l4.221"> </span>
<a href="#l4.222"></a><span id="l4.222">         let branch = (getPrefBranchFor(calendar.id) + name);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-        let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                                    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        // delete before to allow pref-type changes:</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-        prefService.deleteBranch(branch);</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+        // Delete before to allow pref-type changes:</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+        Services.prefs.deleteBranch(branch);</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231">         if ( name === &quot;name&quot; ) {</span>
<a href="#l4.232"></a><span id="l4.232">             cal.setLocalizedPref(branch, value);</span>
<a href="#l4.233"></a><span id="l4.233">         } else {</span>
<a href="#l4.234"></a><span id="l4.234">             cal.setPref(branch, value);</span>
<a href="#l4.235"></a><span id="l4.235">         }</span>
<a href="#l4.236"></a><span id="l4.236">     },</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238">     deleteCalendarPref_: function(calendar, name) {</span>
<a href="#l4.239"></a><span id="l4.239">         cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l4.240"></a><span id="l4.240">         cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l4.241"></a><span id="l4.241">         cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-        let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-                                    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        prefService.deleteBranch(getPrefBranchFor(calendar.id) + name);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+        Services.prefs.deleteBranch(getPrefBranchFor(calendar.id) + name);</span>
<a href="#l4.247"></a><span id="l4.247">     },</span>
<a href="#l4.248"></a><span id="l4.248"> </span>
<a href="#l4.249"></a><span id="l4.249">     mObservers: null,</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    addObserver: function(aObserver) {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-        this.mObservers.add(aObserver);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-    },</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    addObserver: function(aObserver) this.mObservers.add(aObserver),</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    removeObserver: function(aObserver) this.mObservers.remove(aObserver),</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    notifyObservers: function(functionName, args) this.mObservers.notify(functionName, args),</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-    removeObserver: function(aObserver) {</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-        this.mObservers.remove(aObserver);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    }</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    mCalendarObservers: null,</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    addCalendarObserver: function(aObserver) this.mCalendarObservers.add(aObserver),</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    removeCalendarObserver: function(aObserver) this.mCalendarObservers.remove(aObserver),</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    notifyCalendarObservers: function(functionName, args) this.mCalendarObservers.notify(functionName, args)</span>
<a href="#l4.264"></a><span id="l4.264"> };</span>
<a href="#l4.265"></a><span id="l4.265"> </span>
<a href="#l4.266"></a><span id="l4.266"> function equalMessage(msg1, msg2) {</span>
<a href="#l4.267"></a><span id="l4.267">     if (msg1.GetString(0) == msg2.GetString(0) &amp;&amp;</span>
<a href="#l4.268"></a><span id="l4.268">         msg1.GetString(1) == msg2.GetString(1) &amp;&amp;</span>
<a href="#l4.269"></a><span id="l4.269">         msg1.GetString(2) == msg2.GetString(2)) {</span>
<a href="#l4.270"></a><span id="l4.270">         return true;</span>
<a href="#l4.271"></a><span id="l4.271">     }</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineat">@@ -902,113 +810,114 @@ function calMgrCalendarObserver(calendar</span>
<a href="#l4.273"></a><span id="l4.273">     this.calMgr = calMgr;</span>
<a href="#l4.274"></a><span id="l4.274"> }</span>
<a href="#l4.275"></a><span id="l4.275"> </span>
<a href="#l4.276"></a><span id="l4.276"> calMgrCalendarObserver.prototype = {</span>
<a href="#l4.277"></a><span id="l4.277">     calendar: null,</span>
<a href="#l4.278"></a><span id="l4.278">     storedReadOnly: null,</span>
<a href="#l4.279"></a><span id="l4.279">     calMgr: null,</span>
<a href="#l4.280"></a><span id="l4.280"> </span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-    QueryInterface: function mBL_QueryInterface(aIID) {</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-        return doQueryInterface(this, calMgrCalendarObserver.prototype, aIID,</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-                                [Components.interfaces.nsIWindowMediatorListener,</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-                                 Components.interfaces.calIObserver]);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-    },</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+        Components.interfaces.nsIWindowMediatorListener,</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+        Components.interfaces.calIObserver</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+    ]),</span>
<a href="#l4.290"></a><span id="l4.290"> </span>
<a href="#l4.291"></a><span id="l4.291">     // calIObserver:</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-    onStartBatch: function() {},</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-    onEndBatch: function() {},</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-    onLoad: function(calendar) {},</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-    onAddItem: function(aItem) {},</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-    onModifyItem: function(aNewItem, aOldItem) {},</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-    onDeleteItem: function(aDeletedItem) {},</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+    onStartBatch: function() this.calMgr.notifyCalendarObservers(&quot;onStartBatch&quot;, arguments),</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    onEndBatch: function() this.calMgr.notifyCalendarObservers(&quot;onEndBatch&quot;, arguments),</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+    onLoad: function(calendar) this.calMgr.notifyCalendarObservers(&quot;onLoad&quot;, arguments),</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    onAddItem: function(aItem) this.calMgr.notifyCalendarObservers(&quot;onAddItem&quot;, arguments),</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    onModifyItem: function(aNewItem, aOldItem) this.calMgr.notifyCalendarObservers(&quot;onModifyItem&quot;, arguments),</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+    onDeleteItem: function(aDeletedItem) this.calMgr.notifyCalendarObservers(&quot;onDeleteItem&quot;, arguments),</span>
<a href="#l4.304"></a><span id="l4.304">     onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+        this.calMgr.notifyCalendarObservers(&quot;onError&quot;, arguments);</span>
<a href="#l4.306"></a><span id="l4.306">         this.announceError(aCalendar, aErrNo, aMessage);</span>
<a href="#l4.307"></a><span id="l4.307">     },</span>
<a href="#l4.308"></a><span id="l4.308"> </span>
<a href="#l4.309"></a><span id="l4.309">     onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+        this.calMgr.notifyCalendarObservers(&quot;onPropertyChanged&quot;, arguments);</span>
<a href="#l4.311"></a><span id="l4.311">         switch (aName) {</span>
<a href="#l4.312"></a><span id="l4.312">             case &quot;requiresNetwork&quot;:</span>
<a href="#l4.313"></a><span id="l4.313">                 this.calMgr.mNetworkCalendarCount += (aValue ? 1 : -1);</span>
<a href="#l4.314"></a><span id="l4.314">                 break;</span>
<a href="#l4.315"></a><span id="l4.315">             case &quot;readOnly&quot;:</span>
<a href="#l4.316"></a><span id="l4.316">                 this.calMgr.mReadonlyCalendarCount += (aValue ? 1 : -1);</span>
<a href="#l4.317"></a><span id="l4.317">                 break;</span>
<a href="#l4.318"></a><span id="l4.318">             case &quot;refreshInterval&quot;:</span>
<a href="#l4.319"></a><span id="l4.319">                 this.calMgr.setupRefreshTimer(aCalendar);</span>
<a href="#l4.320"></a><span id="l4.320">                 break;</span>
<a href="#l4.321"></a><span id="l4.321">             case &quot;cache.enabled&quot;:</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-                aOldValue = aOldValue || false;</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-                aValue = aValue || false;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-                if (aOldValue != aValue) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-                    // Try to find the current sort order</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-                    let sortOrderPref = cal.getPrefSafe(&quot;calendar.list.sortOrder&quot;, &quot;&quot;).split(&quot; &quot;);</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-                    let initialSortOrderPos = null;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-                    for (let i = 0; i &lt; sortOrderPref.length; ++i) {</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-                        if (sortOrderPref[i] == aCalendar.id) {</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-                            initialSortOrderPos = i;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-                        }</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-                    }</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-                    // Enabling or disabling cache on a calendar re-creates</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-                    // it so the registerCalendar call can wrap/unwrap the</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-                    // calCachedCalendar facade saving the user the need to</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-                    // restart Thunderbird and making sure a new Id is used.</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-                    this.calMgr.unregisterCalendar(aCalendar);</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-                    this.calMgr.deleteCalendar(aCalendar);</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-                    var newCal = this.calMgr.createCalendar(aCalendar.type,aCalendar.uri);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-                    newCal.name = aCalendar.name;</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-                    // TODO: if properties get added this list will need to be adjusted,</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-                    // ideally we should add a &quot;getProperties&quot; method to calICalendar.idl</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-                    // to retrieve all non-transient properties for a calendar.</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-                    let propsToCopy = [ &quot;color&quot;,</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-                                        &quot;disabled&quot;,</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-                                        &quot;auto-enabled&quot;,</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-                                        &quot;cache.enabled&quot;,</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-                                        &quot;refreshInterval&quot;,</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-                                        &quot;suppressAlarms&quot;,</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-                                        &quot;calendar-main-in-composite&quot;,</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-                                        &quot;calendar-main-default&quot;,</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-                                        &quot;readOnly&quot;,</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-                                        &quot;imip.identity.key&quot;];</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-                    for each (let prop in propsToCopy ) {</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-                      newCal.setProperty(prop,</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-                                         aCalendar.getProperty(prop));</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-                    }</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-                    if (initialSortOrderPos != null) {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-                        newCal.setProperty(&quot;initialSortOrderPos&quot;,</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-                                           initialSortOrderPos);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-                    }</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-                    this.calMgr.registerCalendar(newCal);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-                }</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-                else {</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-                    if (aCalendar.wrappedJSObject instanceof calCachedCalendar) {</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-                        // any attempt to switch this flag will reset the cached calendar;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-                        // could be useful for users in case the cache may be corrupted.</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-                        aCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-                    }</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-                }</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-                break;</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+                this.changeCalendarCache.apply(this, arguments);</span>
<a href="#l4.377"></a><span id="l4.377">             case &quot;disabled&quot;:</span>
<a href="#l4.378"></a><span id="l4.378">                 if (!aValue &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l4.379"></a><span id="l4.379">                     aCalendar.refresh();</span>
<a href="#l4.380"></a><span id="l4.380">                 }</span>
<a href="#l4.381"></a><span id="l4.381">                 break;</span>
<a href="#l4.382"></a><span id="l4.382">         }</span>
<a href="#l4.383"></a><span id="l4.383">     },</span>
<a href="#l4.384"></a><span id="l4.384"> </span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+    changeCalendarCache: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+        aOldValue = aOldValue || false;</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+        aValue = aValue || false;</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+        if (aOldValue != aValue) {</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+            // Try to find the current sort order</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+            let sortOrderPref = cal.getPrefSafe(&quot;calendar.list.sortOrder&quot;, &quot;&quot;).split(&quot; &quot;);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+            let initialSortOrderPos = null;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+            for (let i = 0; i &lt; sortOrderPref.length; ++i) {</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+                if (sortOrderPref[i] == aCalendar.id) {</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+                    initialSortOrderPos = i;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+                }</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+            }</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+            // Enabling or disabling cache on a calendar re-creates</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+            // it so the registerCalendar call can wrap/unwrap the</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+            // calCachedCalendar facade saving the user the need to</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+            // restart Thunderbird and making sure a new Id is used.</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+            this.calMgr.unregisterCalendar(aCalendar);</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+            this.calMgr.deleteCalendar(aCalendar);</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+            var newCal = this.calMgr.createCalendar(aCalendar.type,aCalendar.uri);</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+            newCal.name = aCalendar.name;</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+            // TODO: if properties get added this list will need to be adjusted,</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+            // ideally we should add a &quot;getProperties&quot; method to calICalendar.idl</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+            // to retrieve all non-transient properties for a calendar.</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+            let propsToCopy = [ &quot;color&quot;,</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+                                &quot;disabled&quot;,</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+                                &quot;auto-enabled&quot;,</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+                                &quot;cache.enabled&quot;,</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+                                &quot;refreshInterval&quot;,</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+                                &quot;suppressAlarms&quot;,</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+                                &quot;calendar-main-in-composite&quot;,</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+                                &quot;calendar-main-default&quot;,</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+                                &quot;readOnly&quot;,</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+                                &quot;imip.identity.key&quot;];</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+            for each (let prop in propsToCopy ) {</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+              newCal.setProperty(prop,</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+                                 aCalendar.getProperty(prop));</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+            }</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+            if (initialSortOrderPos != null) {</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+                newCal.setProperty(&quot;initialSortOrderPos&quot;,</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+                                   initialSortOrderPos);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+            }</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+            this.calMgr.registerCalendar(newCal);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+        } else {</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+            if (aCalendar.wrappedJSObject instanceof calCachedCalendar) {</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+                // any attempt to switch this flag will reset the cached calendar;</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+                // could be useful for users in case the cache may be corrupted.</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+                aCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+            }</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+        }</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+    },</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+</span>
<a href="#l4.439"></a><span id="l4.439">     onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l4.440"></a><span id="l4.440">         this.onPropertyChanged(aCalendar, aName, false, true);</span>
<a href="#l4.441"></a><span id="l4.441">     },</span>
<a href="#l4.442"></a><span id="l4.442"> </span>
<a href="#l4.443"></a><span id="l4.443">     // Error announcer specific functions</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-</span>
<a href="#l4.445"></a><span id="l4.445">     announceError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l4.446"></a><span id="l4.446"> </span>
<a href="#l4.447"></a><span id="l4.447">         var paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l4.448"></a><span id="l4.448">                                    .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l4.449"></a><span id="l4.449">         var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l4.450"></a><span id="l4.450">                             .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l4.451"></a><span id="l4.451">         var props = sbs.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l4.452"></a><span id="l4.452">         var errMsg;</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineat">@@ -1136,8 +1045,83 @@ calDummyCalendar.prototype = {</span>
<a href="#l4.454"></a><span id="l4.454">         switch (aName) {</span>
<a href="#l4.455"></a><span id="l4.455">             case &quot;force-disabled&quot;:</span>
<a href="#l4.456"></a><span id="l4.456">                 return true;</span>
<a href="#l4.457"></a><span id="l4.457">             default:</span>
<a href="#l4.458"></a><span id="l4.458">                 return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l4.459"></a><span id="l4.459">         }</span>
<a href="#l4.460"></a><span id="l4.460">     }</span>
<a href="#l4.461"></a><span id="l4.461"> };</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+function getPrefBranchFor(id) {</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    return (REGISTRY_BRANCH + id + &quot;.&quot;);</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+}</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+/**</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+ * Helper function to flush the preferences file. If the application crashes</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+ * after a calendar has been created using the prefs registry, then the calendar</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+ * won't show up. Writing the prefs helps counteract.</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+ */</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+function flushPrefs() {</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+              .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+              .savePrefFile(null);</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+}</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+/**</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+ * Callback object for the refresh timer. Should be called as an object, i.e</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+ * let foo = new timerCallback(calendar);</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+ *</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+ * @param aCalendar     The calendar to refresh on notification</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+ */</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+function timerCallback(aCalendar) {</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+    this.notify = function refreshNotify(aTimer) {</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+        if (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+            aCalendar.refresh();</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+        }</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+    }</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+}</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+var gCalendarManagerAddonListener = {</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+    onDisabling: function(aAddon, aNeedsRestart) {</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+        if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+            // If the addon should not be disabled, then re-enable it.</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+            aAddon.userDisabled = false;</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+        }</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+    },</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+    onUninstalling: function(aAddon, aNeedsRestart) {</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+        if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+            // If the addon should not be uninstalled, then cancel the uninstall.</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+            aAddon.cancelUninstall();</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+        }</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    },</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+    queryUninstallProvider: function(aAddon) {</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+        const uri = &quot;chrome://calendar/content/calendar-providerUninstall-dialog.xul&quot;;</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+        const features = &quot;chrome,titlebar,resizable,modal&quot;;</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+        let affectedCalendars =</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+            [ calendar for each (calendar in calMgr.getCalendars({}))</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+              if (calendar.providerID == aAddon.id) ];</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+        if (!affectedCalendars.length) {</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+            // If no calendars are affected, then everything is fine.</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+            return true;</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+        }</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+        let args = { shouldUninstall: false, extension: aAddon };</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+        // Now find a window. The best choice would be the most recent</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+        // addons window, otherwise the most recent calendar window, or we</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+        // create a new toplevel window.</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+        let win = Services.wm.getMostRecentWindow(&quot;Extension:Manager&quot;) ||</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+                  cal.getCalendarWindow();</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+        if (win) {</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+            win.openDialog(uri, &quot;CalendarProviderUninstallDialog&quot;, features, args);</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+        } else {</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+            // Use the window watcher to open a parentless window.</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+            Services.ww.openWindow(null, uri, &quot;CalendarProviderUninstallWindow&quot;, features, args);</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+        }</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+        // Now that we are done, check if the dialog was accepted or canceled.</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+        return args.shouldUninstall;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+    }</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1283,22 +1283,24 @@ function getProgressAtom(aTask) {</span>
<a href="#l5.4"></a><span id="l5.4">     }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">     return &quot;future&quot;;</span>
<a href="#l5.7"></a><span id="l5.7"> }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> /**</span>
<a href="#l5.10"></a><span id="l5.10">  * Returns true if we are Sunbird (according to our UUID), false otherwise.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-function isSunbird()</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+function isSunbird() {</span>
<a href="#l5.15"></a><span id="l5.15">     if (isSunbird.mIsSunbird === undefined) {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-        var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                                .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-        isSunbird.mIsSunbird = (appInfo.ID == &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        try {</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+            isSunbird.mIsSunbird = (Services.appinfo.ID == &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+        } catch (e) {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+            dump(&quot;### Warning: Could not access appinfo, using unreliable check for Lightning\n&quot;);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+            isSunbird.mIsSunbird = !(&quot;@mozilla.org/lightning/mime-converter;1&quot; in Components.classes);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        }</span>
<a href="#l5.25"></a><span id="l5.25">     }</span>
<a href="#l5.26"></a><span id="l5.26">     return isSunbird.mIsSunbird;</span>
<a href="#l5.27"></a><span id="l5.27"> }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> function hasPositiveIntegerValue(elementId)</span>
<a href="#l5.30"></a><span id="l5.30"> {</span>
<a href="#l5.31"></a><span id="l5.31">     var value = document.getElementById(elementId).value;</span>
<a href="#l5.32"></a><span id="l5.32">     if (value &amp;&amp; (parseInt(value) == value) &amp;&amp; value &gt; 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+/**</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Tests the calICalendarManager interface</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ */</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+function run_test() {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    do_get_profile();</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    add_test(test_registration);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    add_test(test_calobserver);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+    cal.getCalendarManager().startup({ onResult: function() {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+        run_next_test();</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+    }});</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+}</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+function test_calobserver() {</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    function checkCounters(add, modify, del, alladd, allmodify, alldel) {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+        do_check_eq(calcounter.addItem, add);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+        do_check_eq(calcounter.modifyItem, modify);</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+        do_check_eq(calcounter.deleteItem, del);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+        do_check_eq(allcounter.addItem, alladd === undefined ? add : alladd);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+        do_check_eq(allcounter.modifyItem, allmodify === undefined ? modify : allmodify);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+        do_check_eq(allcounter.deleteItem, alldel === undefined ? del : alldel);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        resetCounters();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    }</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    function resetCounters() {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+        calcounter = { addItem: 0, modifyItem: 0, deleteItem: 0 };</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+        allcounter = { addItem: 0, modifyItem: 0, deleteItem: 0 };</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    }</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    // First of all we need a local calendar to work on and some variables</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    let calmgr = cal.getCalendarManager();</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;, null, null));</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    let memory2 = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;, null, null));</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    let calcounter, allcounter;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    // These observers will end up counting calls which we will use later on</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    let calobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+        onAddItem: function(itm) calcounter.addItem++,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+        onModifyItem: function(itm) calcounter.modifyItem++,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+        onDeleteItem: function(itm) calcounter.deleteItem++</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    });</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    let allobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+        onAddItem: function(itm) allcounter.addItem++,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+        onModifyItem: function(itm) allcounter.modifyItem++,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+        onDeleteItem: function(itm) allcounter.deleteItem++</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+    });</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    // Set up counters and observers</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    resetCounters();</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    calmgr.registerCalendar(memory);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    calmgr.registerCalendar(memory2);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+    calmgr.addCalendarObserver(allobs);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    memory.addObserver(calobs);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+    // Add an item</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    let item = cal.createEvent();</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    item.id = cal.getUUID()</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    item.startDate = cal.now();</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+    item.endDate = cal.now();</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+    memory.addItem(item, null);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    checkCounters(1, 0, 0);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    // Modify the item</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    let newItem = item.clone();</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    newItem.title = &quot;title&quot;;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    memory.modifyItem(newItem, item, null);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+    checkCounters(0, 1, 0);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    // Delete the item</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+    newItem.generation++; // circumvent generation checks for easier code</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    memory.deleteItem(newItem, null);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+    checkCounters(0, 0, 1);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    // Now check the same for adding the item to a calendar only observed by the</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+    // calendar manager. The calcounters should still be 0, but the calendar</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    // manager counter should have an item added, modified and deleted</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    memory2.addItem(item, null);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    memory2.modifyItem(newItem, item, null);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    memory2.deleteItem(newItem, null);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    checkCounters(0, 0, 0, 1, 1, 1);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    // Remove observers</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    memory.removeObserver(calobs);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    calmgr.removeCalendarObserver(allobs);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    // Make sure removing it actually worked</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    memory.addItem(item, null);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    memory.modifyItem(newItem, item, null);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    memory.deleteItem(newItem, null);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    checkCounters(0, 0, 0);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    // We are done now, start the next test</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+    run_next_test();</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+}</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+function test_registration() {</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+    function checkCalendarCount(net, rdonly, all) {</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+        do_check_eq(calmgr.networkCalendarCount, net);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+        do_check_eq(calmgr.readOnlyCalendarCount , rdonly);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+        do_check_eq(calmgr.calendarCount, all);</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+    }</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+    function checkRegistration(reg, unreg, del) {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+        do_check_eq(registered, reg);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+        do_check_eq(unregistered, unreg);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+        do_check_eq(deleted, del);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+        registered = false;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+        unregistered = false;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+        deleted = false;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    }</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    // Initially there should be no calendars</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    let calmgr = cal.getCalendarManager();</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    checkCalendarCount(0, 0, 0);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    // Create a local memory calendar, ths shouldn't register any calendars</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+    let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-memory-calendar://&quot;, null, null));</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+    checkCalendarCount(0, 0, 0);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+    // Register an observer to test it.</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+    let registered = false, unregistered = false, deleted = false, readOnly = false;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+    let mgrobs = cal.createAdapter(Components.interfaces.calICalendarManagerObserver, {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+        onCalendarRegistered: function onCalendarRegistered(aCalendar) {</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+            if (aCalendar.id == memory.id) registered = true;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+        },</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+        onCalendarUnregistering: function onCalendarUnregistering(aCalendar) {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+            if (aCalendar.id == memory.id) unregistered = true;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+        },</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+        onCalendarDeleting: function onCalendarDeleting(aCalendar) {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+            if (aCalendar.id == memory.id) deleted = true;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+        }</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    });</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    let calobs = cal.createAdapter(Components.interfaces.calIObserver, {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+        onPropertyChanged: function onPropertyChanging(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+            do_check_eq(aCalendar.id, memory.id);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+            do_check_eq(aName, &quot;readOnly&quot;);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+            readOnly = aValue;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+        }</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+    });</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    memory.addObserver(calobs);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    calmgr.addObserver(mgrobs);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    // Register the calendar and check if its counted and observed</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    calmgr.registerCalendar(memory);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+    checkRegistration(true, false, false);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    checkCalendarCount(0, 0, 1);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    // The calendar should now have an id</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+    do_check_neq(memory.id, null);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+    // And be in the list of calendars</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+    do_check_true(memory == calmgr.getCalendarById(memory.id));</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+    do_check_true(calmgr.getCalendars({}).some(function(x) x.id == memory.id));</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+    // Make it readonly and check if the observer caught it</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+    memory.setProperty(&quot;readOnly&quot;, true);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+    do_check_eq(readOnly, true);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    // Now unregister it</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+    calmgr.unregisterCalendar(memory);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+    checkRegistration(false, true, false);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+    checkCalendarCount(0, 0, 0);</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+    // The calendar shouldn't be in the list of ids</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+    do_check_eq(calmgr.getCalendarById(memory.id), null);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+    do_check_true(calmgr.getCalendars({}).every(function(x) x.id != memory.id));</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    // And finally delete it</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+    calmgr.deleteCalendar(memory);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+    checkRegistration(false, false, true);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+    checkCalendarCount(0, 0, 0);</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+    // Now remove the observer again</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    calmgr.removeObserver(mgrobs);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    memory.removeObserver(calobs);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+    // Check if removing it actually worked</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+    calmgr.registerCalendar(memory);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    calmgr.unregisterCalendar(memory);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+    calmgr.deleteCalendar(memory);</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+    memory.setProperty(&quot;readOnly&quot;, false);</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+    checkRegistration(false, false, false);</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+    do_check_eq(readOnly, true);</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+    checkCalendarCount(0, 0, 0);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+    // We are done now, start the next test</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+    run_next_test();</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/test/unit/xpcshell.ini</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell.ini</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -18,12 +18,13 @@ tail =</span>
<a href="#l7.4"></a><span id="l7.4"> [test_datetime.js]</span>
<a href="#l7.5"></a><span id="l7.5"> [test_datetime_before_1970.js]</span>
<a href="#l7.6"></a><span id="l7.6"> [test_freebusy.js]</span>
<a href="#l7.7"></a><span id="l7.7"> [test_hashedarray.js]</span>
<a href="#l7.8"></a><span id="l7.8"> [test_ics.js]</span>
<a href="#l7.9"></a><span id="l7.9"> [test_providers.js]</span>
<a href="#l7.10"></a><span id="l7.10"> [test_recur.js]</span>
<a href="#l7.11"></a><span id="l7.11"> [test_relation.js]</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+[test_calmgr.js]</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> # Bug 680201 Skip this test because it doesn't work properly yet.</span>
<a href="#l7.15"></a><span id="l7.15"> [test_webcal.js]</span>
<a href="#l7.16"></a><span id="l7.16"> skip-if = true</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

