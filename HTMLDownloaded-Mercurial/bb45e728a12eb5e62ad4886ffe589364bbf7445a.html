<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11142:bb45e728a12eb5e62ad4886ffe589364bbf7445a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ bb45e728a12eb5e62ad4886ffe589364bbf7445a" />
<meta property="og:url" content="/comm-central/rev/bb45e728a12eb5e62ad4886ffe589364bbf7445a" />
<meta property="og:description" content="Bug 721316. Patch contains all the changes required to implement the new message storage scheme. Patch also contains three new tests and one modified test, to test the new message storage scheme. r=bienvenu,sr=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / bb45e728a12eb5e62ad4886ffe589364bbf7445a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/bb45e728a12eb5e62ad4886ffe589364bbf7445a">shortlog</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/bb45e728a12eb5e62ad4886ffe589364bbf7445a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a">files</a> |
changeset |
<a href="/comm-central/raw-rev/bb45e728a12eb5e62ad4886ffe589364bbf7445a">raw</a>  | <a href="/comm-central/archive/bb45e728a12eb5e62ad4886ffe589364bbf7445a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721316">Bug 721316</a>. Patch contains all the changes required to implement the new message storage scheme. Patch also contains three new tests and one modified test, to test the new message storage scheme. r=bienvenu,sr=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#116;&#117;&#108;&#32;&#74;&#97;&#110;&#103;&#114;&#97;&#32;&#60;&#97;&#116;&#117;&#108;&#106;&#97;&#110;&#103;&#114;&#97;&#54;&#54;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 27 Sep 2012 21:41:16 +0100</td></tr>

<tr>
 <td>changeset 11142</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/bb45e728a12eb5e62ad4886ffe589364bbf7445a">bb45e728a12eb5e62ad4886ffe589364bbf7445a</a></td>
</tr>



<tr>
<td>parent 11141</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/85ae661d2a06760f0d29eb915d7117a1674476aa">85ae661d2a06760f0d29eb915d7117a1674476aa</a>
</td>
</tr>

<tr>
<td>child 11143</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b25b81b354c2989183c5241453440651ef86e195">b25b81b354c2989183c5241453440651ef86e195</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=bb45e728a12eb5e62ad4886ffe589364bbf7445a">8358</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 27 Sep 2012 20:41:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b25b81b354c2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b25b81b354c2989183c5241453440651ef86e195">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b25b81b354c2989183c5241453440651ef86e195&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b25b81b354c2989183c5241453440651ef86e195&newProject=comm-central&newRevision=bb45e728a12eb5e62ad4886ffe589364bbf7445a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b25b81b354c2989183c5241453440651ef86e195&newProject=comm-central&newRevision=bb45e728a12eb5e62ad4886ffe589364bbf7445a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b25b81b354c2989183c5241453440651ef86e195&newProject=comm-central&newRevision=bb45e728a12eb5e62ad4886ffe589364bbf7445a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721316">721316</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=721316">Bug 721316</a>. Patch contains all the changes required to implement the new message storage scheme. Patch also contains three new tests and one modified test, to test the new message storage scheme. r=bienvenu,sr=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">mailnews/imap/public/nsIImapFlagAndUidState.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapFlagAndUidState.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">mailnews/imap/public/nsIImapProtocol.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/public/nsIImapProtocol.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">mailnews/imap/src/nsImapFlagAndUidState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">mailnews/imap/src/nsImapFlagAndUidState.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapFlagAndUidState.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">mailnews/imap/src/nsImapServerResponseParser.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/src/nsImapServerResponseParser.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">mailnews/imap/test/unit/test_fetchCustomAttribute.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_fetchCustomAttribute.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">mailnews/imap/test/unit/test_gmailAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">mailnews/imap/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/imap/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/bb45e728a12eb5e62ad4886ffe589364bbf7445a/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,17 +40,17 @@ interface nsIMsgKeyArray;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsIOutputStream;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsIUrlListener;</span>
<a href="#l1.6"></a><span id="l1.6"> interface nsIFile;</span>
<a href="#l1.7"></a><span id="l1.7"> interface nsIArray;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> typedef unsigned long nsMsgRetainByPreference;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(b01d6b3b-78c2-4958-b836-2259c76dbc24)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(0bbe00df-17f8-4e36-8917-40172c3a95fc)]</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> interface nsIMsgRetentionSettings : nsISupports</span>
<a href="#l1.16"></a><span id="l1.16"> {</span>
<a href="#l1.17"></a><span id="l1.17">   const unsigned long nsMsgRetainAll = 1;</span>
<a href="#l1.18"></a><span id="l1.18">   const unsigned long nsMsgRetainByAge = 2;</span>
<a href="#l1.19"></a><span id="l1.19">   const unsigned long nsMsgRetainByNumHeaders = 3;</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">   attribute boolean useServerDefaults;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -264,16 +264,21 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l1.23"></a><span id="l1.23">    * nsIMsgFolder.msgDatabase can set the last use time.</span>
<a href="#l1.24"></a><span id="l1.24">    */</span>
<a href="#l1.25"></a><span id="l1.25">   attribute PRTime lastUseTime;</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">   // get a message header for the given key. Caller must release()!</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   nsIMsgDBHdr GetMsgHdrForKey(in nsMsgKey key);</span>
<a href="#l1.30"></a><span id="l1.30">   nsIMsgDBHdr getMsgHdrForMessageID(in string messageID);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  /**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * get a message header for a Gmail message with the given X-GM-MSGID.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   */</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  nsIMsgDBHdr GetMsgHdrForGMMsgID(in string aGmailMessageID);</span>
<a href="#l1.36"></a><span id="l1.36">   //Returns whether or not this database contains the given key</span>
<a href="#l1.37"></a><span id="l1.37">   boolean ContainsKey(in nsMsgKey key);</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> /**</span>
<a href="#l1.40"></a><span id="l1.40">  * Must call AddNewHdrToDB after creating. The idea is that you create</span>
<a href="#l1.41"></a><span id="l1.41">  * a new header, fill in its properties, and then call AddNewHdrToDB.</span>
<a href="#l1.42"></a><span id="l1.42">  * AddNewHdrToDB will send notifications to any listeners.</span>
<a href="#l1.43"></a><span id="l1.43">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4588,16 +4588,55 @@ NS_IMETHODIMP nsMsgDatabase::GetMsgHdrFo</span>
<a href="#l2.4"></a><span id="l2.4">       hdrRow-&gt;Release();</span>
<a href="#l2.5"></a><span id="l2.5">     else</span>
<a href="#l2.6"></a><span id="l2.6">       rv = CreateMsgHdr(hdrRow, key, &amp;msgHdr);</span>
<a href="#l2.7"></a><span id="l2.7">   }</span>
<a href="#l2.8"></a><span id="l2.8">   *aHdr = msgHdr; // already addreffed above.</span>
<a href="#l2.9"></a><span id="l2.9">   return NS_OK; // it's not an error not to find a msg hdr.</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForGMMsgID(const char *aGMMsgId, nsIMsgDBHdr **aHdr)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aGMMsgId);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  mdbYarn gMailMessageIdYarn;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  gMailMessageIdYarn.mYarn_Buf = (void *) aGMMsgId;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  gMailMessageIdYarn.mYarn_Fill = strlen(aGMMsgId);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  gMailMessageIdYarn.mYarn_Form = 0;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+  gMailMessageIdYarn.mYarn_Size = gMailMessageIdYarn.mYarn_Fill;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  nsIMdbRow *hdrRow;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  mdbOid outRowId;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  mdb_err result;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  NS_ENSURE_TRUE(m_mdbStore, NS_ERROR_NULL_POINTER);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  result = m_mdbStore-&gt;StringToToken(GetEnv(), &quot;X-GM-MSGID&quot;,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    &amp;property_token);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  result = m_mdbStore-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    property_token, &amp;gMailMessageIdYarn, &amp;outRowId, &amp;hdrRow);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow)</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    // Get key from row</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    mdbOid outOid;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    rv = hdrRow-&gt;GetOid(GetEnv(), &amp;outOid);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    nsMsgKey key = outOid.mOid_Id;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    rv = GetHdrFromUseCache(key, &amp;msgHdr);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    if ((NS_SUCCEEDED(rv) &amp;&amp; msgHdr))</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+      hdrRow-&gt;Release();</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    else</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+      rv = CreateMsgHdr(hdrRow, key, &amp;msgHdr);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  }</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  *aHdr = msgHdr;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  return NS_OK; // it's not an error not to find a msg hdr.</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+}</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51"> nsIMsgDBHdr *nsMsgDatabase::GetMsgHdrForSubject(nsCString &amp;subject)</span>
<a href="#l2.52"></a><span id="l2.52"> {</span>
<a href="#l2.53"></a><span id="l2.53">   nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l2.54"></a><span id="l2.54">   nsresult rv = NS_OK;</span>
<a href="#l2.55"></a><span id="l2.55">   mdbYarn subjectYarn;</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57">   subjectYarn.mYarn_Buf = (void*)subject.get();</span>
<a href="#l2.58"></a><span id="l2.58">   subjectYarn.mYarn_Fill = PL_strlen(subject.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapFlagAndUidState.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapFlagAndUidState.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-[scriptable, uuid(444e0d79-874d-4174-b7f3-189db317473c)]</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-interface nsIImapFlagAndUidState : nsISupports </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(290412eb-5824-4087-8984-05450c9397be)]</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+interface nsIImapFlagAndUidState : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">   readonly attribute long numberOfMessages;</span>
<a href="#l3.17"></a><span id="l3.17">   readonly attribute long numberOfRecentMessages;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   /**</span>
<a href="#l3.20"></a><span id="l3.20">    * If a full update, the total number of deleted messages</span>
<a href="#l3.21"></a><span id="l3.21">    * in the folder; if a partial update, the number of deleted</span>
<a href="#l3.22"></a><span id="l3.22">    * messages in the partial update</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -45,10 +45,30 @@ interface nsIImapFlagAndUidState : nsISu</span>
<a href="#l3.24"></a><span id="l3.24">   void getMessageFlags(in long zeroBasedIndex, out unsigned short result);</span>
<a href="#l3.25"></a><span id="l3.25">   void setMessageFlags(in long zeroBasedIndex, in unsigned short flags);</span>
<a href="#l3.26"></a><span id="l3.26">   void expungeByIndex(in unsigned long zeroBasedIndex);</span>
<a href="#l3.27"></a><span id="l3.27">   void addUidFlagPair(in unsigned long uid, in unsigned short flags, in unsigned long zeroBasedIndex);</span>
<a href="#l3.28"></a><span id="l3.28">   void addUidCustomFlagPair(in unsigned long uid, in string customFlag);</span>
<a href="#l3.29"></a><span id="l3.29">   string getCustomFlags(in unsigned long uid); // returns space-separated keywords</span>
<a href="#l3.30"></a><span id="l3.30">   void reset();</span>
<a href="#l3.31"></a><span id="l3.31">   void clearCustomFlags(in unsigned long uid);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  /**</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+   * Adds custom attributes to a hash table for the purpose of storing them</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+   * them.</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+   * @param aUid   UID of the associated msg</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+   * @param aCustomAttributeName   Name of the custom attribute value</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+   * @param aCustomAttributeValue   Value of the attribute,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+   */</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  void setCustomAttribute(in unsigned long aUid,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+                          in ACString aCustomAttributeName,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                          in ACString aCustomAttributeValue);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  /**</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+   * Gets the custom attributes from the hash table where they were stored earlier</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+   * them.</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+   * @param aUid   UID of the associated msg</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+   * @param aCustomAttributeName   Name of the custom attribute value</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+   * @param aCustomAttributeValue   Value of the attribute,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+   */</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  ACString getCustomAttribute(in unsigned long aUid,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+                              in ACString aCustomAttributeName);</span>
<a href="#l3.52"></a><span id="l3.52"> };</span>
<a href="#l3.53"></a><span id="l3.53"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -9,18 +9,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> interface nsIUrlListener;</span>
<a href="#l4.5"></a><span id="l4.5"> interface nsIURI;</span>
<a href="#l4.6"></a><span id="l4.6"> interface nsIImapUrl;</span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIImapProtocol;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsIImapIncomingServer;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIMsgFolder;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIImapHostSessionList;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsIMsgWindow;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+interface nsIImapFlagAndUidState;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-[scriptable, uuid(177f4140-37ad-4828-880c-42d4ee5d2015)]</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+[scriptable, uuid(290412eb-5824-4087-8984-05450c9397be)]</span>
<a href="#l4.16"></a><span id="l4.16"> interface nsIImapProtocol : nsISupports {</span>
<a href="#l4.17"></a><span id="l4.17">   void LoadImapUrl(in nsIURI aUrl, in nsISupports aConsumer);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   /**</span>
<a href="#l4.20"></a><span id="l4.20">    * IsBusy returns true if the connection is currently processing a url</span>
<a href="#l4.21"></a><span id="l4.21">    * and false otherwise.</span>
<a href="#l4.22"></a><span id="l4.22">    */</span>
<a href="#l4.23"></a><span id="l4.23">   void IsBusy(out boolean aIsConnectionBusy,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -46,16 +47,17 @@ interface nsIImapProtocol : nsISupports </span>
<a href="#l4.25"></a><span id="l4.25">   // methods to get data from the imap parser flag state.</span>
<a href="#l4.26"></a><span id="l4.26">   void GetFlagsForUID(in unsigned long uid, out boolean foundIt, out unsigned short flags, out string customFlags);</span>
<a href="#l4.27"></a><span id="l4.27">   void GetSupportedUserFlags(out unsigned short flags);</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   void GetRunningImapURL(out nsIImapUrl aImapUrl);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   void GetRunningUrl(out nsIURI aUrl);</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  readonly attribute nsIImapFlagAndUidState flagAndUidState;</span>
<a href="#l4.34"></a><span id="l4.34">   /**</span>
<a href="#l4.35"></a><span id="l4.35">    * Tell thread to die - only call from the UI thread</span>
<a href="#l4.36"></a><span id="l4.36">    *</span>
<a href="#l4.37"></a><span id="l4.37">    * @param aIsSafeToClose false if we're dropping a timed out connection.</span>
<a href="#l4.38"></a><span id="l4.38">    */</span>
<a href="#l4.39"></a><span id="l4.39">   void tellThreadToDie(in boolean aIsSafeToClose);</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">   // Get last active time stamp</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapFlagAndUidState.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapFlagAndUidState.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -80,16 +80,17 @@ nsImapFlagAndUidState::nsImapFlagAndUidS</span>
<a href="#l5.4"></a><span id="l5.4">   : fUids(numberOfMessages),</span>
<a href="#l5.5"></a><span id="l5.5">     fFlags(numberOfMessages),</span>
<a href="#l5.6"></a><span id="l5.6">     mLock(&quot;nsImapFlagAndUidState.mLock&quot;)</span>
<a href="#l5.7"></a><span id="l5.7"> {</span>
<a href="#l5.8"></a><span id="l5.8">   fSupportedUserFlags = 0;</span>
<a href="#l5.9"></a><span id="l5.9">   fNumberDeleted = 0;</span>
<a href="#l5.10"></a><span id="l5.10">   fPartialUIDFetch = true;</span>
<a href="#l5.11"></a><span id="l5.11">   m_customFlagsHash.Init(10);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  m_customAttributesHash.Init(10);  </span>
<a href="#l5.13"></a><span id="l5.13"> }</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> /* static */PLDHashOperator nsImapFlagAndUidState::FreeCustomFlags(const uint32_t &amp;aKey, char *aData,</span>
<a href="#l5.16"></a><span id="l5.16">                                         void *closure)</span>
<a href="#l5.17"></a><span id="l5.17"> {</span>
<a href="#l5.18"></a><span id="l5.18">   PR_Free(aData);</span>
<a href="#l5.19"></a><span id="l5.19">   return PL_DHASH_NEXT;</span>
<a href="#l5.20"></a><span id="l5.20"> }</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -301,8 +302,38 @@ NS_IMETHODIMP nsImapFlagAndUidState::Get</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> NS_IMETHODIMP nsImapFlagAndUidState::ClearCustomFlags(uint32_t uid)</span>
<a href="#l5.24"></a><span id="l5.24"> {</span>
<a href="#l5.25"></a><span id="l5.25">   MutexAutoLock mon(mLock);</span>
<a href="#l5.26"></a><span id="l5.26">   m_customFlagsHash.Remove(uid);</span>
<a href="#l5.27"></a><span id="l5.27">   return NS_OK;</span>
<a href="#l5.28"></a><span id="l5.28"> }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+NS_IMETHODIMP nsImapFlagAndUidState::SetCustomAttribute(uint32_t aUid,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                                                        const nsACString &amp;aCustomAttributeName,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                                                        const nsACString &amp;aCustomAttributeValue)</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+{</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  if (!m_customAttributesHash.IsInitialized())</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  nsCString key;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  key.AppendInt((int64_t)aUid);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  key.Append(aCustomAttributeName);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  nsCString value;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  value.Assign(aCustomAttributeValue);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  m_customAttributesHash.Put(key, value);</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+}</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+NS_IMETHODIMP nsImapFlagAndUidState::GetCustomAttribute(uint32_t aUid,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+                                                        const nsACString &amp;aCustomAttributeName,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+                                                        nsACString &amp;aCustomAttributeValue)</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+{</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  if (m_customAttributesHash.IsInitialized())</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    nsCString key;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    key.AppendInt((int64_t)aUid);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    key.Append(aCustomAttributeName);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    nsCString val;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    m_customAttributesHash.Get(key, &amp;val);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    aCustomAttributeValue.Assign(val);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  }</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapFlagAndUidState.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapFlagAndUidState.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -37,16 +37,18 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> private:</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   static PLDHashOperator FreeCustomFlags(const uint32_t &amp;aKey, char *aData, void *closure);</span>
<a href="#l6.8"></a><span id="l6.8">     nsTArray&lt;nsMsgKey&gt;      fUids;</span>
<a href="#l6.9"></a><span id="l6.9">     nsTArray&lt;imapMessageFlagsType&gt; fFlags;</span>
<a href="#l6.10"></a><span id="l6.10">     // Hash table, mapping uids to extra flags</span>
<a href="#l6.11"></a><span id="l6.11">     nsDataHashtable&lt;nsUint32HashKey, char *&gt; m_customFlagsHash;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    // Hash table, mapping UID+customAttributeName to customAttributeValue.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    nsDataHashtable&lt;nsCStringHashKey, nsCString&gt; m_customAttributesHash;</span>
<a href="#l6.14"></a><span id="l6.14">     uint16_t                fSupportedUserFlags;</span>
<a href="#l6.15"></a><span id="l6.15">     int32_t                 fNumberDeleted;</span>
<a href="#l6.16"></a><span id="l6.16">     bool                    fPartialUIDFetch;</span>
<a href="#l6.17"></a><span id="l6.17">     mozilla::Mutex mLock;</span>
<a href="#l6.18"></a><span id="l6.18"> };</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3055,16 +3055,21 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l7.4"></a><span id="l7.4">     msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l7.5"></a><span id="l7.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.6"></a><span id="l7.6">     msgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.7"></a><span id="l7.7">   }</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.10"></a><span id="l7.10">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l7.11"></a><span id="l7.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  rv = imapServer-&gt;GetIsGMailServer(&amp;m_isGmailServer);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  </span>
<a href="#l7.17"></a><span id="l7.17">   newMsgHdr-&gt;SetMessageKey(m_curMsgUid);</span>
<a href="#l7.18"></a><span id="l7.18">   TweakHeaderFlags(aProtocol, newMsgHdr);</span>
<a href="#l7.19"></a><span id="l7.19">   uint32_t messageSize;</span>
<a href="#l7.20"></a><span id="l7.20">   if (NS_SUCCEEDED(newMsgHdr-&gt;GetMessageSize(&amp;messageSize)))</span>
<a href="#l7.21"></a><span id="l7.21">     mFolderSize += messageSize;</span>
<a href="#l7.22"></a><span id="l7.22">   m_msgMovedByFilter = false;</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   // If this is the inbox, try to apply filters. Otherwise, test the inherited</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineat">@@ -3175,16 +3180,31 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l7.26"></a><span id="l7.26">     nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l7.27"></a><span id="l7.27">     nsMsgKey highestUID;</span>
<a href="#l7.28"></a><span id="l7.28">     mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l7.29"></a><span id="l7.29">     dbFolderInfo-&gt;GetUint32Property(kHighestRecordedUIDPropertyName, 0, &amp;highestUID);</span>
<a href="#l7.30"></a><span id="l7.30">     if (m_curMsgUid &gt; highestUID)</span>
<a href="#l7.31"></a><span id="l7.31">       dbFolderInfo-&gt;SetUint32Property(kHighestRecordedUIDPropertyName, m_curMsgUid);</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   }</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  if (m_isGmailServer)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    nsCOMPtr&lt;nsIImapFlagAndUidState&gt; flagState;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    aProtocol-&gt;GetFlagAndUidState(getter_AddRefs(flagState));</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    nsCString msgIDValue;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    nsCString threadIDValue;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    nsCString labelsValue;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;), msgIDValue);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;), threadIDValue);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    flagState-&gt;GetCustomAttribute(m_curMsgUid, NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;), labelsValue);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    newMsgHdr-&gt;SetStringProperty(&quot;X-GM-MSGID&quot;, msgIDValue.get());</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    newMsgHdr-&gt;SetStringProperty(&quot;X-GM-THRID&quot;, threadIDValue.get());</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    newMsgHdr-&gt;SetStringProperty(&quot;X-GM-LABELS&quot;, labelsValue.get());</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  }</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+</span>
<a href="#l7.49"></a><span id="l7.49">   m_msgParser-&gt;Clear(); // clear out parser, because it holds onto a msg hdr.</span>
<a href="#l7.50"></a><span id="l7.50">   m_msgParser-&gt;SetMailDB(nullptr); // tell it to let go of the db too.</span>
<a href="#l7.51"></a><span id="l7.51">   // I don't think we want to do this - it does bad things like set the size incorrectly.</span>
<a href="#l7.52"></a><span id="l7.52">   //    m_msgParser-&gt;FinishHeader();</span>
<a href="#l7.53"></a><span id="l7.53">     return NS_OK;</span>
<a href="#l7.54"></a><span id="l7.54"> }</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56"> NS_IMETHODIMP nsImapMailFolder::AbortHeaderParseStream(nsIImapProtocol* aProtocol)</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineat">@@ -9517,8 +9537,170 @@ void nsImapMailFolder::PlaybackTimerCall</span>
<a href="#l7.58"></a><span id="l7.58">   delete request;</span>
<a href="#l7.59"></a><span id="l7.59"> }</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61"> void nsImapMailFolder::InitAutoSyncState()</span>
<a href="#l7.62"></a><span id="l7.62"> {</span>
<a href="#l7.63"></a><span id="l7.63">   if (!m_autoSyncStateObj)</span>
<a href="#l7.64"></a><span id="l7.64">     m_autoSyncStateObj = new nsAutoSyncState(this);</span>
<a href="#l7.65"></a><span id="l7.65"> }</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::HasMsgOffline(nsMsgKey msgKey, bool *_retval)</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+{</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  *_retval = false;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  nsresult rv = GetOfflineMsgFolder(msgKey, getter_AddRefs(msgFolder));</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    *_retval = true;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+}</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+nsresult nsImapMailFolder::GetOfflineMsgFolder(nsMsgKey msgKey, nsIMsgFolder **aMsgFolder)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+{</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  // Check if we have the message in the current folder.</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; subMsgFolder;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  GetDatabase();</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  if (!mDatabase)</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  nsresult rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    return rv;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  if (hdr)</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    uint32_t msgFlags = 0;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    hdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    // Check if we already have this message body offline</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    if ((msgFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      NS_IF_ADDREF(*aMsgFolder = this);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+      return NS_OK;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    }</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  }</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  if (!*aMsgFolder)</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    // Checking the existence of message in other folders in case of GMail Server</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    bool isGMail;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+    nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    rv = GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    rv = imapServer-&gt;GetIsGMailServer(&amp;isGMail);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    if (isGMail)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      nsCString labels;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+      nsTArray&lt;nsCString&gt; labelNames;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      hdr-&gt;GetStringProperty(&quot;X-GM-LABELS&quot;, getter_Copies(labels));</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+      ParseString(labels, ' ', labelNames);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+      nsCOMPtr&lt;nsIMsgImapMailFolder&gt; subFolder;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      for (uint32_t i = 0; i &lt; labelNames.Length(); i++)</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+      {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+        rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; (rootFolder))</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+        {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+          nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapRootFolder = do_QueryInterface(rootFolder);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\Draft\&quot;&quot;))</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Drafts,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\Inbox\&quot;&quot;))</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\All Mail\&quot;&quot;))</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Archive,</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\Trash\&quot;&quot;))</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Trash,</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\Spam\&quot;&quot;))</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Junk,</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+          if (labelNames[i].Equals(&quot;\&quot;\\\\Sent\&quot;&quot;))</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+             rv = rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::SentMail,</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+                                                 getter_AddRefs(subMsgFolder));</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+          if ((labelNames[i].Find(NS_LITERAL_CSTRING(&quot;[Imap]/&quot;), true, 0, -1) != -1))</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+          {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+            labelNames[i].ReplaceSubstring(&quot;[Imap]/&quot;, &quot;&quot;);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+            imapRootFolder-&gt;FindOnlineSubFolder(labelNames[i], getter_AddRefs(subFolder));</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+            subMsgFolder = do_QueryInterface(subFolder);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+          }</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+          if (!subMsgFolder)</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+          {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+            imapRootFolder-&gt;FindOnlineSubFolder(labelNames[i], getter_AddRefs(subFolder));</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+            subMsgFolder = do_QueryInterface(subFolder);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+          }</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+          if (subMsgFolder)</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+          {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+            subMsgFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+            if (db)</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+            {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+              nsCOMPtr&lt;nsIMsgDBHdr&gt; retHdr;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+              nsCString gmMsgID;</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+              hdr-&gt;GetStringProperty(&quot;X-GM-MSGID&quot;, getter_Copies(gmMsgID));</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+              rv = db-&gt;GetMsgHdrForGMMsgID(gmMsgID.get(), getter_AddRefs(retHdr));</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+                return rv;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+              if (retHdr)</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+              {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+                uint32_t gmFlags = 0;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+                retHdr-&gt;GetFlags(&amp;gmFlags);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+                if ((gmFlags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+                {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+                  subMsgFolder.forget(aMsgFolder);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+                  // Focus on first positive result.</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+                  return NS_OK;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+                }</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+              }</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+            }</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+          }</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+        }</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+      }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    }</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  }</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+}</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::GetOfflineFileStream(nsMsgKey msgKey, int64_t *offset, uint32_t *size, nsIInputStream **aFileStream)</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+{</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  NS_ENSURE_ARG(aFileStream);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; offlineFolder;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+  nsresult rv = GetOfflineMsgFolder(msgKey, getter_AddRefs(offlineFolder));</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  if(!offlineFolder)</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  GetDatabase();</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  if (!mDatabase)</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  if (offlineFolder == this)</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    return nsMsgDBFolder::GetOfflineFileStream(msgKey, offset, size, aFileStream);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+  else</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+    nsresult rv;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+      return rv;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+    if (hdr)</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+      nsCString gmMsgID;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+      hdr-&gt;GetStringProperty(&quot;X-GM-MSGID&quot;, getter_Copies(gmMsgID));</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+      offlineFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+      rv = db-&gt;GetMsgHdrForGMMsgID(gmMsgID.get(), getter_AddRefs(hdr));</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+        return rv;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+      nsMsgKey newMsgKey;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      hdr-&gt;GetMessageKey(&amp;newMsgKey);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      return offlineFolder-&gt;GetOfflineFileStream(newMsgKey, offset, size, aFileStream);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    }</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+  }</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -283,16 +283,21 @@ public:</span>
<a href="#l8.4"></a><span id="l8.4">                                                  bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l8.5"></a><span id="l8.5">                                                  bool *aAsyncResults);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   NS_IMETHOD AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords);</span>
<a href="#l8.8"></a><span id="l8.8">   NS_IMETHOD RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   NS_IMETHOD NotifyCompactCompleted();</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  // overrides nsMsgDBFolder::HasMsgOffline()</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  NS_IMETHOD HasMsgOffline(nsMsgKey msgKey, bool *_retval);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  // overrides nsMsgDBFolder::GetOfflineFileStream()</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  NS_IMETHOD GetOfflineFileStream(nsMsgKey msgKey, int64_t *offset, uint32_t *size, nsIInputStream **aFileStream);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17">   NS_DECL_NSIMSGIMAPMAILFOLDER</span>
<a href="#l8.18"></a><span id="l8.18">   NS_DECL_NSIIMAPMAILFOLDERSINK</span>
<a href="#l8.19"></a><span id="l8.19">   NS_DECL_NSIIMAPMESSAGESINK</span>
<a href="#l8.20"></a><span id="l8.20">   NS_DECL_NSICOPYMESSAGELISTENER</span>
<a href="#l8.21"></a><span id="l8.21">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">   // nsIUrlListener methods</span>
<a href="#l8.24"></a><span id="l8.24">   NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineat">@@ -300,16 +305,25 @@ public:</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l8.28"></a><span id="l8.28">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">   NS_IMETHOD IsCommandEnabled(const nsACString&amp; command, bool *result);</span>
<a href="#l8.31"></a><span id="l8.31">   NS_IMETHOD SetFilterList(nsIMsgFilterList *aMsgFilterList);</span>
<a href="#l8.32"></a><span id="l8.32">   NS_IMETHOD GetCustomIdentity(nsIMsgIdentity **aIdentity);</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ /**</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  * This method is used to locate a folder where a msg could be present, not just</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  * the folder where the message first arrives, this method searches for the existence</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  * of msg in all the folders/labels that we retrieve from X-GM-LABELS also.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  *  @param msgKey key  of the msg for which we are trying to get the folder;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  *  @param aMsgFolder  required folder;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  nsresult GetOfflineMsgFolder(nsMsgKey msgKey, nsIMsgFolder **aMsgFolder);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+</span>
<a href="#l8.43"></a><span id="l8.43">   nsresult AddSubfolderWithPath(nsAString&amp; name, nsIFile *dbPath, nsIMsgFolder **child, bool brandNew = false);</span>
<a href="#l8.44"></a><span id="l8.44">   nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l8.45"></a><span id="l8.45">                                   nsIMsgDatabase *sourceDB,</span>
<a href="#l8.46"></a><span id="l8.46">                                   const nsACString&amp; destFolder,</span>
<a href="#l8.47"></a><span id="l8.47">                                   nsIMsgFilter *filter,</span>
<a href="#l8.48"></a><span id="l8.48">                                   nsIMsgWindow *msgWindow);</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   // send notification to copy service listener.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineat">@@ -479,16 +493,18 @@ protected:</span>
<a href="#l8.52"></a><span id="l8.52">   // when to send a done notification.</span>
<a href="#l8.53"></a><span id="l8.53">   bool m_compactingOfflineStore;</span>
<a href="#l8.54"></a><span id="l8.54">   bool m_expunging;</span>
<a href="#l8.55"></a><span id="l8.55">   bool m_applyIncomingFilters; // apply filters to this folder, even if not the inbox</span>
<a href="#l8.56"></a><span id="l8.56">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l8.57"></a><span id="l8.57">   uint32_t     m_aclFlags;</span>
<a href="#l8.58"></a><span id="l8.58">   uint32_t     m_supportedUserFlags;</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  // determines if we are on GMail server</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  bool m_isGmailServer;</span>
<a href="#l8.62"></a><span id="l8.62">   // offline imap support</span>
<a href="#l8.63"></a><span id="l8.63">   bool m_downloadingFolderForOfflineUse;</span>
<a href="#l8.64"></a><span id="l8.64">   bool m_filterListRequiresBody;</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">   // auto-sync (automatic message download) support</span>
<a href="#l8.67"></a><span id="l8.67">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">   // Quota support</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -368,16 +368,17 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l9.4"></a><span id="l9.4">   m_failedAuthMethods = 0;</span>
<a href="#l9.5"></a><span id="l9.5">   m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l9.6"></a><span id="l9.6">   m_socketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l9.7"></a><span id="l9.7">   m_connectionStatus = NS_OK;</span>
<a href="#l9.8"></a><span id="l9.8">   m_safeToCloseConnection = false;</span>
<a href="#l9.9"></a><span id="l9.9">   m_hostSessionList = nullptr;</span>
<a href="#l9.10"></a><span id="l9.10">   m_flagState = nullptr;</span>
<a href="#l9.11"></a><span id="l9.11">   m_fetchBodyIdList = nullptr;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  m_isGmailServer = false;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l9.15"></a><span id="l9.15">   NS_ASSERTION(prefBranch, &quot;FAILED to create the preference service&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   // read in the accept languages preference</span>
<a href="#l9.18"></a><span id="l9.18">   if (prefBranch)</span>
<a href="#l9.19"></a><span id="l9.19">   {</span>
<a href="#l9.20"></a><span id="l9.20">     if (!gInitialized)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -658,16 +659,17 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l9.22"></a><span id="l9.22">         folderInfo-&gt;GetNumMessages(&amp;mFolderTotalMsgCount);</span>
<a href="#l9.23"></a><span id="l9.23">         folderInfo-&gt;GetUint32Property(kHighestRecordedUIDPropertyName, 0, &amp;mFolderHighestUID);</span>
<a href="#l9.24"></a><span id="l9.24">         folderInfo-&gt;GetImapUidValidity(&amp;m_uidValidity);</span>
<a href="#l9.25"></a><span id="l9.25">       }</span>
<a href="#l9.26"></a><span id="l9.26">     }</span>
<a href="#l9.27"></a><span id="l9.27">     nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l9.28"></a><span id="l9.28">     nsCOMPtr&lt;nsIStreamListener&gt; aRealStreamListener = do_QueryInterface(aConsumer);</span>
<a href="#l9.29"></a><span id="l9.29">     m_runningUrl-&gt;GetMockChannel(getter_AddRefs(m_mockChannel));</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    imapServer-&gt;GetIsGMailServer(&amp;m_isGmailServer);</span>
<a href="#l9.31"></a><span id="l9.31">     if (!m_mockChannel)</span>
<a href="#l9.32"></a><span id="l9.32">     {</span>
<a href="#l9.33"></a><span id="l9.33">       // there are several imap operations that aren't initiated via a nsIChannel::AsyncOpen call on the mock channel.</span>
<a href="#l9.34"></a><span id="l9.34">       // such as selecting a folder. nsImapProtocol now insists on a mock channel when processing a url.</span>
<a href="#l9.35"></a><span id="l9.35">       nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l9.36"></a><span id="l9.36">       rv = NS_NewChannel(getter_AddRefs(channel), aURL, nullptr, nullptr, nullptr, 0);</span>
<a href="#l9.37"></a><span id="l9.37">       m_mockChannel = do_QueryInterface(channel);</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineat">@@ -3406,16 +3408,18 @@ nsImapProtocol::FetchMessage(const nsCSt</span>
<a href="#l9.40"></a><span id="l9.40">         if (gUseEnvelopeCmd)</span>
<a href="#l9.41"></a><span id="l9.41">           what = PR_smprintf(&quot; ENVELOPE BODY.PEEK[HEADER.FIELDS (%s)])&quot;, headersToDL);</span>
<a href="#l9.42"></a><span id="l9.42">         else</span>
<a href="#l9.43"></a><span id="l9.43">           what = PR_smprintf(&quot; BODY.PEEK[HEADER.FIELDS (%s)])&quot;,headersToDL);</span>
<a href="#l9.44"></a><span id="l9.44">         NS_Free(headersToDL);</span>
<a href="#l9.45"></a><span id="l9.45">         if (what)</span>
<a href="#l9.46"></a><span id="l9.46">         {</span>
<a href="#l9.47"></a><span id="l9.47">           commandString.Append(&quot; %s (UID &quot;);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+           if (m_isGmailServer)</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+            commandString.Append(&quot;X-GM-MSGID X-GM-THRID X-GM-LABELS &quot;);</span>
<a href="#l9.50"></a><span id="l9.50">           if (aolImapServer)</span>
<a href="#l9.51"></a><span id="l9.51">             commandString.Append(&quot; XAOL.SIZE&quot;) ;</span>
<a href="#l9.52"></a><span id="l9.52">           else</span>
<a href="#l9.53"></a><span id="l9.53">             commandString.Append(&quot;RFC822.SIZE&quot;);</span>
<a href="#l9.54"></a><span id="l9.54">           commandString.Append(&quot; FLAGS&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">           commandString.Append(what);</span>
<a href="#l9.56"></a><span id="l9.56">           PR_Free(what);</span>
<a href="#l9.57"></a><span id="l9.57">         }</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineat">@@ -4216,16 +4220,23 @@ NS_IMETHODIMP nsImapProtocol::GetFlagsFo</span>
<a href="#l9.59"></a><span id="l9.59">   {</span>
<a href="#l9.60"></a><span id="l9.60">     *resultFlags = flags;</span>
<a href="#l9.61"></a><span id="l9.61">     if ((flags &amp; kImapMsgCustomKeywordFlag) &amp;&amp; customFlags)</span>
<a href="#l9.62"></a><span id="l9.62">       m_flagState-&gt;GetCustomFlags(uid, customFlags);</span>
<a href="#l9.63"></a><span id="l9.63">   }</span>
<a href="#l9.64"></a><span id="l9.64">   return NS_OK;</span>
<a href="#l9.65"></a><span id="l9.65"> }</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+NS_IMETHODIMP nsImapProtocol::GetFlagAndUidState(nsIImapFlagAndUidState **aFlagState)</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+{</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFlagState);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  NS_IF_ADDREF(*aFlagState = m_flagState);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+}</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+</span>
<a href="#l9.74"></a><span id="l9.74"> NS_IMETHODIMP nsImapProtocol::GetSupportedUserFlags(uint16_t *supportedFlags)</span>
<a href="#l9.75"></a><span id="l9.75"> {</span>
<a href="#l9.76"></a><span id="l9.76">   if (!supportedFlags)</span>
<a href="#l9.77"></a><span id="l9.77">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">   *supportedFlags = m_flagState-&gt;GetSupportedUserFlags();</span>
<a href="#l9.80"></a><span id="l9.80">   return NS_OK;</span>
<a href="#l9.81"></a><span id="l9.81"> }</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineat">@@ -4802,16 +4813,17 @@ nsImapProtocol::DiscoverMailboxSpec(nsIm</span>
<a href="#l9.83"></a><span id="l9.83">       m_specialXListMailboxes.Put(mailboxName, adoptedBoxSpec-&gt;mBoxFlags);</span>
<a href="#l9.84"></a><span id="l9.84">       // Remember hierarchy delimiter in case this is the first time we've</span>
<a href="#l9.85"></a><span id="l9.85">       // connected to the server and we need it to be correct for the two-level</span>
<a href="#l9.86"></a><span id="l9.86">       // XLIST we send (INBOX is guaranteed to be in the first response).</span>
<a href="#l9.87"></a><span id="l9.87">       if (adoptedBoxSpec-&gt;mBoxFlags &amp; kImapInbox)</span>
<a href="#l9.88"></a><span id="l9.88">         m_runningUrl-&gt;SetOnlineSubDirSeparator(adoptedBoxSpec-&gt;mHierarchySeparator);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">     }</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+    NS_IF_RELEASE(adoptedBoxSpec);</span>
<a href="#l9.92"></a><span id="l9.92">     break;</span>
<a href="#l9.93"></a><span id="l9.93">   case kListingForCreate:</span>
<a href="#l9.94"></a><span id="l9.94">   case kNoOperationInProgress:</span>
<a href="#l9.95"></a><span id="l9.95">   case kDiscoverTrashFolderInProgress:</span>
<a href="#l9.96"></a><span id="l9.96">   case kListingForInfoAndDiscovery:</span>
<a href="#l9.97"></a><span id="l9.97">     {</span>
<a href="#l9.98"></a><span id="l9.98">       if (ns &amp;&amp; nsPrefix) // if no personal namespace, there can be no Trash folder</span>
<a href="#l9.99"></a><span id="l9.99">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -570,16 +570,17 @@ private:</span>
<a href="#l10.4"></a><span id="l10.4">   bool m_useCompressDeflate; </span>
<a href="#l10.5"></a><span id="l10.5">   // these come from the nsIDBFolderInfo in the msgDatabase and</span>
<a href="#l10.6"></a><span id="l10.6">   // are initialized in nsImapProtocol::SetupWithUrl.</span>
<a href="#l10.7"></a><span id="l10.7">   uint64_t mFolderLastModSeq;</span>
<a href="#l10.8"></a><span id="l10.8">   int32_t mFolderTotalMsgCount;</span>
<a href="#l10.9"></a><span id="l10.9">   uint32_t mFolderHighestUID;</span>
<a href="#l10.10"></a><span id="l10.10">   uint32_t mFolderNumDeleted;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  bool m_isGmailServer;</span>
<a href="#l10.13"></a><span id="l10.13">   nsTArray&lt;nsCString&gt; mCustomDBHeaders;</span>
<a href="#l10.14"></a><span id="l10.14">   bool    m_trackingTime;</span>
<a href="#l10.15"></a><span id="l10.15">   PRTime  m_startTime;</span>
<a href="#l10.16"></a><span id="l10.16">   PRTime  m_endTime;</span>
<a href="#l10.17"></a><span id="l10.17">   PRTime  m_lastActiveTime;</span>
<a href="#l10.18"></a><span id="l10.18">   int32_t m_tooFastTime;</span>
<a href="#l10.19"></a><span id="l10.19">   int32_t m_idealTime;</span>
<a href="#l10.20"></a><span id="l10.20">   int32_t m_chunkAddSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1253,16 +1253,72 @@ void nsImapServerResponseParser::msg_fet</span>
<a href="#l11.4"></a><span id="l11.4">         if (! fNextToken) </span>
<a href="#l11.5"></a><span id="l11.5">           SetSyntaxError(true);</span>
<a href="#l11.6"></a><span id="l11.6">         else</span>
<a href="#l11.7"></a><span id="l11.7">         {</span>
<a href="#l11.8"></a><span id="l11.8">           fXSenderInfo = CreateAstring(); </span>
<a href="#l11.9"></a><span id="l11.9">           AdvanceToNextToken();</span>
<a href="#l11.10"></a><span id="l11.10">         }</span>
<a href="#l11.11"></a><span id="l11.11">       }</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-MSGID&quot;))</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+        if (!fNextToken)</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+        else</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+        {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+          fMsgID = CreateAtom();</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+          AdvanceToNextToken();</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+          nsCString msgIDValue;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+          msgIDValue.Assign(fMsgID);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+          if (fCurrentResponseUID == 0)</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+                                         NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;), msgIDValue);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+          PR_FREEIF(fMsgID);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+        }</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+      }</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-THRID&quot;))</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+      {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+        if (!fNextToken)</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+        else</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+          fThreadID = CreateAtom();</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+          AdvanceToNextToken();</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+          nsCString threadIDValue;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+          threadIDValue.Assign(fThreadID);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+          if (fCurrentResponseUID == 0)</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                                         NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;), threadIDValue);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+          PR_FREEIF(fThreadID);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+        }</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+      }</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-LABELS&quot;))</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+      {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+        if (!fNextToken)</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+        else</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+        {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+          fLabels = CreateParenGroup();</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+          nsCString labelsValue;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+          labelsValue.Assign(fLabels);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+          labelsValue.Cut(0, 1);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+          labelsValue.Cut(labelsValue.Length()-1, 1);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+          if (fCurrentResponseUID == 0)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+                                         NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;), labelsValue);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+          PR_FREEIF(fLabels);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+        }</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+      }</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+</span>
<a href="#l11.68"></a><span id="l11.68">       // I only fetch RFC822 so I should never see these BODY responses</span>
<a href="#l11.69"></a><span id="l11.69">       else if (!PL_strcasecmp(fNextToken, &quot;BODY&quot;))</span>
<a href="#l11.70"></a><span id="l11.70">         skip_to_CRLF(); // I never ask for this</span>
<a href="#l11.71"></a><span id="l11.71">       else if (!PL_strcasecmp(fNextToken, &quot;BODYSTRUCTURE&quot;))</span>
<a href="#l11.72"></a><span id="l11.72">       {</span>
<a href="#l11.73"></a><span id="l11.73">         if (fCurrentResponseUID == 0)</span>
<a href="#l11.74"></a><span id="l11.74">           fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l11.75"></a><span id="l11.75">         bodystructure_data();</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineat">@@ -1307,25 +1363,25 @@ void nsImapServerResponseParser::msg_fet</span>
<a href="#l11.77"></a><span id="l11.77">           return;</span>
<a href="#l11.78"></a><span id="l11.78">         fServerConnection.GetCurrentUrl()-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l11.79"></a><span id="l11.79">         nsAutoCString userDefinedFetchAttribute;</span>
<a href="#l11.80"></a><span id="l11.80">         fServerConnection.GetCurrentUrl()-&gt;GetCustomAttributeToFetch(userDefinedFetchAttribute);</span>
<a href="#l11.81"></a><span id="l11.81">         if ((imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute &amp;&amp; !strcmp(userDefinedFetchAttribute.get(), fNextToken)) ||</span>
<a href="#l11.82"></a><span id="l11.82">             imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l11.83"></a><span id="l11.83">         {</span>
<a href="#l11.84"></a><span id="l11.84">           AdvanceToNextToken();</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-          char *fetchResult;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-          if (fNextToken[0] == '(') </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-            // look through the tokens until we find the closing ')'</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-            // we can have a result like the following:</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-            // ((A B) (C D) (E F))</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-            fetchResult = CreateParenGroup();</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-          else {</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-            fetchResult = CreateAstring();</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+          char *fetchResult;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+          if (fNextToken[0] == '(')</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+            // look through the tokens until we find the closing ')'</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+            // we can have a result like the following:</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+            // ((A B) (C D) (E F))</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+            fetchResult = CreateParenGroup();</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+          else {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+            fetchResult = CreateAstring();</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+            AdvanceToNextToken();</span>
<a href="#l11.103"></a><span id="l11.103">           }</span>
<a href="#l11.104"></a><span id="l11.104">           if (imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute)</span>
<a href="#l11.105"></a><span id="l11.105">             fServerConnection.GetCurrentUrl()-&gt;SetCustomAttributeResult(nsDependentCString(fetchResult));</span>
<a href="#l11.106"></a><span id="l11.106">           if (imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l11.107"></a><span id="l11.107">             fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(nsDependentCString(fetchResult));</span>
<a href="#l11.108"></a><span id="l11.108">           PR_Free(fetchResult);</span>
<a href="#l11.109"></a><span id="l11.109">         }</span>
<a href="#l11.110"></a><span id="l11.110">         else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -236,16 +236,19 @@ private:</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   eIMAPstate               fIMAPstate;</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">   eIMAPCapabilityFlags      fCapabilityFlag;</span>
<a href="#l12.8"></a><span id="l12.8">   nsCString     fMailAccountUrl;</span>
<a href="#l12.9"></a><span id="l12.9">   char          *fNetscapeServerVersionString;</span>
<a href="#l12.10"></a><span id="l12.10">   char          *fXSenderInfo; /* changed per message download */</span>
<a href="#l12.11"></a><span id="l12.11">   char          *fLastAlert; /* used to avoid displaying the same alert over and over */</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+  char          *fMsgID; /* MessageID for Gmail only (X-GM-MSGID) */</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  char          *fThreadID; /* ThreadID for Gmail only (X-GM-THRID) */</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  char          *fLabels; /* Labels for Gmail only (X-GM-LABELS) [will include parens, removed while passing to hashTable ]*/</span>
<a href="#l12.15"></a><span id="l12.15">   nsCString     fManageListsUrl;</span>
<a href="#l12.16"></a><span id="l12.16">   nsCString    fManageFiltersUrl;</span>
<a href="#l12.17"></a><span id="l12.17">   char          *fFolderAdminUrl;</span>
<a href="#l12.18"></a><span id="l12.18">   nsCString    fServerIdResponse; // RFC </span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   int32_t fFetchResponseIndex;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">   // used for aborting a fetch stream when we're pseudo-Interrupted</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,129 +1,128 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> /*</span>
<a href="#l13.9"></a><span id="l13.9">  * Test to ensure that imap customCommandResult function works properly</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">- * Bug ?????? </span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">- * uses Gmail extensions as test case - also useful for bug 721316</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ * Bug 778246</span>
<a href="#l13.13"></a><span id="l13.13">  */</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-// async support </span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+// async support</span>
<a href="#l13.17"></a><span id="l13.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l13.18"></a><span id="l13.18"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l13.19"></a><span id="l13.19"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21"> // IMAP pump</span>
<a href="#l13.22"></a><span id="l13.22"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> // Globals</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l13.29"></a><span id="l13.29"> const gMessageFileName = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l13.30"></a><span id="l13.30"> var gMessage, gExpectedLength;</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-var gXGmLabels = ['\\\\Inbox', '\\\\Sent', 'Important', '&quot;Muy Importante&quot;', 'foo'];</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+var gCustomList = ['Custom1', 'Custom2', 'Custom3'];</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35"> var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l13.36"></a><span id="l13.36">   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41"> // Definition of tests</span>
<a href="#l13.42"></a><span id="l13.42"> var tests = [</span>
<a href="#l13.43"></a><span id="l13.43">   loadImapMessage,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  testStoreXGMLabel,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  testStoreMinusXGmLabel,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  testStorePlusXGmLabel,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  testStoreCustomList,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  testStoreMinusCustomList,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  testStorePlusCustomList,</span>
<a href="#l13.50"></a><span id="l13.50">   endTest</span>
<a href="#l13.51"></a><span id="l13.51"> ]</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53"> // load and update a message in the imap fake server</span>
<a href="#l13.54"></a><span id="l13.54"> function loadImapMessage()</span>
<a href="#l13.55"></a><span id="l13.55"> {</span>
<a href="#l13.56"></a><span id="l13.56">   gMessage = new imapMessage(specForFileName(gMessageFileName),</span>
<a href="#l13.57"></a><span id="l13.57">     gIMAPMailbox.uidnext++, []);</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  gMessage.xGmLabels = [];</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  gMessage.xCustomList = [];</span>
<a href="#l13.60"></a><span id="l13.60">   gIMAPMailbox.addMessage(gMessage);</span>
<a href="#l13.61"></a><span id="l13.61">   gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.62"></a><span id="l13.62">   yield false;</span>
<a href="#l13.63"></a><span id="l13.63"> }</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-function testStoreXGMLabel()</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+function testStoreCustomList()</span>
<a href="#l13.67"></a><span id="l13.67"> {</span>
<a href="#l13.68"></a><span id="l13.68">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  gExpectedLength = gXGmLabels.length;</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  gExpectedLength = gCustomList.length;</span>
<a href="#l13.71"></a><span id="l13.71">   let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-    &quot; X-GM-LABELS (&quot; + gXGmLabels.join(&quot; &quot;) + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    &quot; X-CUSTOM-LIST (&quot; + gCustomList.join(&quot; &quot;) + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.74"></a><span id="l13.74">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-  uri.RegisterListener(xGmLabelsSetListener);</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  uri.RegisterListener(storeCustomListSetListener);</span>
<a href="#l13.77"></a><span id="l13.77">   yield false;</span>
<a href="#l13.78"></a><span id="l13.78"> }</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-// listens for response from customCommandResult request for X-GM-MSGID</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-var xGmLabelsSetListener = {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+// listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+var storeCustomListSetListener = {</span>
<a href="#l13.84"></a><span id="l13.84">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.87"></a><span id="l13.87">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.88"></a><span id="l13.88">     do_check_eq(aUrl.customCommandResult,</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-      &quot;(&quot; + gMessage.xGmLabels.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-    do_check_eq(gMessage.xGmLabels.length, gExpectedLength);</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+      &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    do_check_eq(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.93"></a><span id="l13.93">     async_driver();</span>
<a href="#l13.94"></a><span id="l13.94">   }</span>
<a href="#l13.95"></a><span id="l13.95"> };</span>
<a href="#l13.96"></a><span id="l13.96"> </span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-function testStoreMinusXGmLabel()</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+function testStoreMinusCustomList()</span>
<a href="#l13.99"></a><span id="l13.99"> {</span>
<a href="#l13.100"></a><span id="l13.100">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l13.101"></a><span id="l13.101">   gExpectedLength--;</span>
<a href="#l13.102"></a><span id="l13.102">   let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-    &quot; -X-GM-LABELS (&quot; + gXGmLabels[0] + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+    &quot; -X-CUSTOM-LIST (&quot; + gCustomList[0] + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.105"></a><span id="l13.105">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  uri.RegisterListener(xGmLabelRemovedListener);</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  uri.RegisterListener(storeCustomListRemovedListener);</span>
<a href="#l13.108"></a><span id="l13.108">   yield false;</span>
<a href="#l13.109"></a><span id="l13.109"> }</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-// listens for response from customCommandResult request for X-GM-MSGID</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-var xGmLabelRemovedListener = {</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+// listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+var storeCustomListRemovedListener = {</span>
<a href="#l13.115"></a><span id="l13.115">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.116"></a><span id="l13.116"> </span>
<a href="#l13.117"></a><span id="l13.117">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.118"></a><span id="l13.118">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.119"></a><span id="l13.119">     do_check_eq(aUrl.customCommandResult,</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-      &quot;(&quot; + gMessage.xGmLabels.join(&quot; &quot;) + &quot;)&quot;);      </span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-    do_check_eq(gMessage.xGmLabels.length, gExpectedLength);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    do_check_eq(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.124"></a><span id="l13.124">     async_driver();</span>
<a href="#l13.125"></a><span id="l13.125">   }</span>
<a href="#l13.126"></a><span id="l13.126"> };</span>
<a href="#l13.127"></a><span id="l13.127"> </span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-function testStorePlusXGmLabel()</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+function testStorePlusCustomList()</span>
<a href="#l13.130"></a><span id="l13.130"> {</span>
<a href="#l13.131"></a><span id="l13.131">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l13.132"></a><span id="l13.132">   gExpectedLength++;</span>
<a href="#l13.133"></a><span id="l13.133">   let uri = gIMAPInbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-    ' +X-GM-LABELS (&quot;New Label&quot;)', gMsgWindow);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    ' +X-CUSTOM-LIST (&quot;Custom4&quot;)', gMsgWindow);</span>
<a href="#l13.136"></a><span id="l13.136">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-  uri.RegisterListener(xGmLabelAddedListener);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  uri.RegisterListener(storeCustomListAddedListener);</span>
<a href="#l13.139"></a><span id="l13.139">   yield false;</span>
<a href="#l13.140"></a><span id="l13.140"> }</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-// listens for response from customCommandResult request for X-GM-THRID</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-var xGmLabelAddedListener = {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+// listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+var storeCustomListAddedListener = {</span>
<a href="#l13.146"></a><span id="l13.146">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.147"></a><span id="l13.147"> </span>
<a href="#l13.148"></a><span id="l13.148">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.149"></a><span id="l13.149">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.150"></a><span id="l13.150">     do_check_eq(aUrl.customCommandResult,</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-      &quot;(&quot; + gMessage.xGmLabels.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-    do_check_eq(gMessage.xGmLabels.length, gExpectedLength);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+      &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+    do_check_eq(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.155"></a><span id="l13.155">     async_driver();</span>
<a href="#l13.156"></a><span id="l13.156">   }</span>
<a href="#l13.157"></a><span id="l13.157"> };</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159"> </span>
<a href="#l13.160"></a><span id="l13.160"> // Cleanup at end</span>
<a href="#l13.161"></a><span id="l13.161"> function endTest()</span>
<a href="#l13.162"></a><span id="l13.162"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,120 +1,98 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> /*</span>
<a href="#l14.9"></a><span id="l14.9">  * Test to ensure that imap fetchCustomMsgAttribute function works properly</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">- * Bug 750012 </span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">- * uses Gmail extensions as test case - also useful for bug 721316</span>
<a href="#l14.12"></a><span id="l14.12">  */</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-// async support </span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+// async support</span>
<a href="#l14.16"></a><span id="l14.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l14.17"></a><span id="l14.17"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l14.18"></a><span id="l14.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> // IMAP pump</span>
<a href="#l14.21"></a><span id="l14.21"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> // Globals</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l14.28"></a><span id="l14.28"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-const gXGmMsgid = &quot;1278455344230334865&quot;;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-const gXGmThrid = &quot;1266894439832287888&quot;;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-const gXGmLabels = '(\\Inbox \\Sent Important &quot;Muy Importante&quot; foo)';</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+const gCustomValue = &quot;Custom&quot;;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+const gCustomList = [&quot;Custom1&quot;, &quot;Custom2&quot;, &quot;Custom3&quot;];</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36"> var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l14.37"></a><span id="l14.37">   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-setupIMAPPump();</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l14.41"></a><span id="l14.41"> </span>
<a href="#l14.42"></a><span id="l14.42"> // Definition of tests</span>
<a href="#l14.43"></a><span id="l14.43"> var tests = [</span>
<a href="#l14.44"></a><span id="l14.44">   loadImapMessage,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  testFetchXGmMsgid,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  testFetchXGmThrid,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  testFetchXGmLabels,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  testFetchCustomValue,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  testFetchCustomList,</span>
<a href="#l14.50"></a><span id="l14.50">   endTest</span>
<a href="#l14.51"></a><span id="l14.51"> ]</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53"> // load and update a message in the imap fake server</span>
<a href="#l14.54"></a><span id="l14.54"> function loadImapMessage()</span>
<a href="#l14.55"></a><span id="l14.55"> {</span>
<a href="#l14.56"></a><span id="l14.56">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l14.57"></a><span id="l14.57">                           gIMAPMailbox.uidnext++, []);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  message.xGmMsgid = gXGmMsgid;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  message.xGmThrid = gXGmThrid;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  message.xGmLabels = gXGmLabels;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  message.xCustomValue = gCustomValue;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  message.xCustomList = gCustomList;</span>
<a href="#l14.63"></a><span id="l14.63">   gIMAPMailbox.addMessage(message);</span>
<a href="#l14.64"></a><span id="l14.64">   gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l14.65"></a><span id="l14.65">   yield false;</span>
<a href="#l14.66"></a><span id="l14.66"> }</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-function testFetchXGmMsgid()</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+// Used to verify that nsIServerResponseParser.msg_fetch() can handle</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+// not in a parenthesis group - Bug 750012</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+function testFetchCustomValue()</span>
<a href="#l14.72"></a><span id="l14.72"> {</span>
<a href="#l14.73"></a><span id="l14.73">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-GM-MSGID&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-VALUE&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l14.76"></a><span id="l14.76">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-  uri.RegisterListener(xGmMsgidListener);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  uri.RegisterListener(fetchCustomValueListener);</span>
<a href="#l14.79"></a><span id="l14.79">   yield false;</span>
<a href="#l14.80"></a><span id="l14.80"> }</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-// listens for respone from fetchCustomMsgAttribute request for X-GM-MSGID</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-var xGmMsgidListener = {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+// listens for resposne from fetchCustomMsgAttribute request for X-CUSTOM-VALUE</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+var fetchCustomValueListener = {</span>
<a href="#l14.86"></a><span id="l14.86">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l14.89"></a><span id="l14.89">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-    do_check_eq(aUrl.customAttributeResult, gXGmMsgid);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    do_check_eq(aUrl.customAttributeResult, gCustomValue);</span>
<a href="#l14.92"></a><span id="l14.92">     async_driver();</span>
<a href="#l14.93"></a><span id="l14.93">   }</span>
<a href="#l14.94"></a><span id="l14.94"> };</span>
<a href="#l14.95"></a><span id="l14.95"> </span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-function testFetchXGmThrid()</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+// Used to verify that nsIServerResponseParser.msg_fetch() can handle a parenthesis group - Bug 735542</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+function testFetchCustomList()</span>
<a href="#l14.99"></a><span id="l14.99"> {</span>
<a href="#l14.100"></a><span id="l14.100">   let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-GM-THRID&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-LIST&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l14.103"></a><span id="l14.103">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  uri.RegisterListener(xGmThridListener);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  uri.RegisterListener(fetchCustomListListener);</span>
<a href="#l14.106"></a><span id="l14.106">   yield false;</span>
<a href="#l14.107"></a><span id="l14.107"> }</span>
<a href="#l14.108"></a><span id="l14.108"> </span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-// listens for respone from fetchCustomMsgAttribute request for X-GM-THRID</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-var xGmThridListener = {</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+// listens for response from fetchCustomMsgAttribute request for X-CUSTOM-LIST</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+var fetchCustomListListener = {</span>
<a href="#l14.113"></a><span id="l14.113">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l14.116"></a><span id="l14.116">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-    do_check_eq(aUrl.customAttributeResult, gXGmThrid);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-    async_driver();</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-  }</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-};</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-function testFetchXGmLabels()</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-{</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-  let uri = gIMAPInbox.fetchCustomMsgAttribute(&quot;X-GM-LABELS&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-  uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-  uri.RegisterListener(xGmLabelsListener);</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-  yield false;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-}</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-// listens for respone from fetchCustomMsgAttribute request for X-GM-LABELS</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-var xGmLabelsListener = {</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-    aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-    do_check_eq(aUrl.customAttributeResult, gXGmLabels);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+    do_check_eq(aUrl.customAttributeResult, &quot;(&quot; + gCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l14.139"></a><span id="l14.139">     async_driver();</span>
<a href="#l14.140"></a><span id="l14.140">   }</span>
<a href="#l14.141"></a><span id="l14.141"> };</span>
<a href="#l14.142"></a><span id="l14.142"> </span>
<a href="#l14.143"></a><span id="l14.143"> // Cleanup at end</span>
<a href="#l14.144"></a><span id="l14.144"> function endTest()</span>
<a href="#l14.145"></a><span id="l14.145"> {</span>
<a href="#l14.146"></a><span id="l14.146">   teardownIMAPPump();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,108 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+/*</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * Test to ensure that, in case of GMail server, fetching of custom GMail</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * attributes works properly.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Bug 721316</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ *</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * See https://bugzilla.mozilla.org/show_bug.cgi?id=721316</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * for more info.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * Original Author: Atul Jangra&lt;atuljangra66@gmail.com&gt;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ */</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+// async support</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+// IMAP pump</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+// Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+const gXGmMsgid = &quot;1278455344230334865&quot;;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+const gXGmThrid = &quot;1266894439832287888&quot;;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+const gXGmLabels = '(\\Inbox \\Sent Important &quot;Muy Importante&quot; foo)';</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+  .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+// Definition of tests</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+var tests = [</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  loadImapMessage,</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  testFetchXGmMsgid,</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  testFetchXGmThrid,</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  testFetchXGmLabels,</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  endTest</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+]</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+// load and update a message in the imap fake server</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+function loadImapMessage()</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+{</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+                          gIMAPMailbox.uidnext++, []);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  message.xGmMsgid = gXGmMsgid;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+  message.xGmThrid = gXGmThrid;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  message.xGmLabels = gXGmLabels;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  gIMAPMailbox.addMessage(message);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  yield false;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+}</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+function testFetchXGmMsgid()</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+{</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  let val = msgHdr.getStringProperty(&quot;X-GM-MSGID&quot;);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  do_check_eq(val, gXGmMsgid);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+}</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+function testFetchXGmThrid()</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+{</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  let val = msgHdr.getStringProperty(&quot;X-GM-THRID&quot;);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  do_check_eq(val, gXGmThrid);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+}</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+function testFetchXGmLabels()</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+{</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  let msgHdr = firstMsgHdr(gIMAPInbox);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  let val = msgHdr.getStringProperty(&quot;X-GM-LABELS&quot;);</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+   // We need to remove the starting &quot;(&quot; and ending &quot;)&quot; from gXGmLabels while comparing</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  do_check_eq(val, gXGmLabels.substring(1 ,gXGmLabels.length - 1));</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+}</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+// Cleanup at end</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+function endTest()</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+{</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+}</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+function run_test()</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+{</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+}</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+/*</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+ * helper functions</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+ */</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+{</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+                     .getService(Ci.nsIIOService)</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+                     .newFileURI(file)</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+                     .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,282 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+/*</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * Test to ensure that, in case of GMail server, fetching of a message,</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * which is already present in offline store of some folder, from a folder</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ * doesn't make us add it to the offline store twice(in this case, in general it can</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ * be any number of times).</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ *</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * Bug 721316</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ *</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ * See https://bugzilla.mozilla.org/show_bug.cgi?id=721316</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ * for more info.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ * Original Author: Atul Jangra&lt;atuljangra66@gmail.com&gt;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ */</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+// Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+const gMessage1 = &quot;bugmail10&quot;; // message file used as the test message for Inbox and fooFolder</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+const gXGmMsgid1 = &quot;1278455344230334865&quot;;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+const gXGmThrid1 = &quot;1266894439832287888&quot;;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+// We need to have different X-GM-LABELS for different folders. I am doing it here manually, but this issue will be tackled in Bug 781443.</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+const gXGmLabels11 = '( \&quot;\\\\Sent\&quot; foo bar)'; // for message in Inbox</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+const gXGmLabels12 = '(\&quot;\\\\Inbox\&quot; \&quot;\\\\Sent\&quot; bar)'; // for message in fooFolder</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+const gMessage2 = &quot;bugmail11&quot; // message file used as the test message for fooFolder</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+const gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+const gXGmMsgid2 = &quot;1278455345230334555&quot;;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+const gXGmThrid2 = &quot;1266894639832287111&quot;;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+const gXGmLabels2 = '(\&quot;\\\\Sent\&quot;)';</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+var fooBox;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+var imapInbox;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+var fooFolder;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+var rootFolder;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+var gImapInboxOfflineStoreSizeInitial;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+var gImapInboxOfflineStoreSizeFinal;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+var gFooOfflineStoreSizeInitial;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+var gFooOfflineStoreSizeFinal;</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+// We use this as a display consumer</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+var streamListener =</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+{</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+  _data: &quot;&quot;,</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  QueryInterface:</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    XPCOMUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  // nsIRequestObserver</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+  onStartRequest: function(aRequest, aContext) {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  },</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+    do_check_eq(aStatusCode, 0);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  },</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  // nsIStreamListener</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+    let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+                         .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+    scriptStream.init(aInputStream);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    scriptStream.read(aCount);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+  }</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+};</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+function setup()</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+{</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+  // these hacks are required because we've created the inbox before</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  // Creating the mailbox &quot;foo&quot;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;foo&quot;, {subscribed : true}, {&quot;uidnext&quot;: 150});</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  fooBox = gIMAPDaemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  // Add message1 to inbox.</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+  message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+                          imapInbox.uidnext++, []);</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+  message.messageId = gMsgId1;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+  message.xGmThrid = gXGmThrid1;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  message.xGmLabels = gXGmLabels11; // With labels excluding &quot;//INBOX&quot;</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  imapInbox.addMessage(message);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+}</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+function addFoo()</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+{</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  // Adding our test message</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+  message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+                          fooBox.uidnext++, []);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+  message.messageId = gMsgId1;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+  message.xGmThrid = gXGmThrid1;</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+  message.xGmLabels = gXGmLabels12; // With labels excluding &quot;foo&quot;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  fooBox.addMessage(message);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  // Adding another message so that fooFolder behaves as LocalFolder while calculating it's size.</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+  message1 = new imapMessage(specForFileName(gMessage2),</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+                          fooBox.uidnext++, []);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+  message1.messageId = gMsgId2;</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  message1.xGmMsgid = gXGmMsgid2;</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+  message1.xGmThrid = gXGmThrid2;</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  message1.xGmLabels = gXGmLabels2;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+  fooBox.addMessage(message1);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+}</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+var gIMAPService;</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+var tests = [</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  setup,</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+  function updateFolder()</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+  {</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+    yield false;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+  },</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+  function selectInboxMsg()</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+  {</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    // Select mesasage1 from inbox which makes message1 available in offline store.</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+    gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+    let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+    let url = new Object;</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1),</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+                                            streamListener,</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+                                            null,</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+                                            asyncUrlListener,</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+                                            null,</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+                                            url);</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    yield false;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+  },</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+  function StreamMessageInbox()</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+  {</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    // Stream message1 from inbox</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+    let newMsgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+    let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+    gImapInboxOfflineStoreSizeInitial = gIMAPInbox.filePath.fileSize; // Initial Size of Inbox</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+    yield false;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+  },</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+  function createAndUpdate()</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+  {</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+    rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+    fooFolder =  rootFolder.getChildNamed(&quot;foo&quot;).QueryInterface(Ci.nsIMsgImapMailFolder); // We have created the mailbox earlier.</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+    fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+    yield false;</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+  },</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+  addFoo,</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+  function updateFoo() {</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+    fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+    yield false;</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+  },</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+  function selectFooMsg()</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  {</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+    // Select message2 from fooFolder, which makes fooFolder a local folder.</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+    gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+    let msg1 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+    let url = new Object;</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+    gIMAPService.DisplayMessage(fooFolder.getUriForMsg(msg1),</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+                                            streamListener,</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+                                            null,</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+                                            asyncUrlListener,</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+                                            null,</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+                                            url);</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+    yield false;</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+  },</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+  function StreamMessageFoo()</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+  {</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+    // Stream message2 from fooFolder</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+    let newMsgHdr = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+    let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+    gFooOfflineStoreSizeInitial = fooFolder.filePath.fileSize;</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+    yield false;</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+  },</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+  function crossStreaming()</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+  {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+    /**</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+     * Streaming message1 from fooFolder. message1 is present in</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+     * offline store of inbox. We now test that streaming the message1</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+     * from fooFolder does not make us add message1 to offline store of</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+     * fooFolder. We check this by comparing the sizes of inbox and fooFolder</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+     * before and after streaming.</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+     */</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+    let msg2 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+    do_check_neq(msg2, null);</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+    let msgURI = fooFolder.getUriForMsg(msg2);</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+    // pass true for aLocalOnly since message should be in offline store of Inbox.</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+    gFooOfflineStoreSizeFinal = fooFolder.filePath.fileSize;</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+    gImapInboxOfflineStoreSizeFinal = gIMAPInbox.filePath.fileSize;</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+    do_check_eq(gFooOfflineStoreSizeFinal, gFooOfflineStoreSizeInitial);</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+    do_check_eq(gImapInboxOfflineStoreSizeFinal,gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+    yield false;</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+  },</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+  teardown</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+]</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+};</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+function teardown() {</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+}</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+function run_test() {</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+}</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+/*</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+ * helper functions</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+ */</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+gStreamListener = {</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+  QueryInterface : XPCOMUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+  _stream : null,</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+  _data : null,</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+  onStartRequest : function (aRequest, aContext) {</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+    this._data = &quot;&quot;;</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+  },</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+  onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+    async_driver();</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+  },</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+  onDataAvailable : function (aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+    if (this._stream == null) {</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+      this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+      this._stream.init(aInputStream);</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+    }</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+    this._data += this._stream.read(aCount);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+  },</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+};</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+{</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+                     .getService(Ci.nsIIOService)</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+                     .newFileURI(file)</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+                     .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+}</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,23 +2,25 @@</span>
<a href="#l17.4"></a><span id="l17.4"> head = head_server.js</span>
<a href="#l17.5"></a><span id="l17.5"> tail = tail_imap.js</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> [test_autosync_date_constraints.js]</span>
<a href="#l17.8"></a><span id="l17.8"> [test_bccProperty.js]</span>
<a href="#l17.9"></a><span id="l17.9"> [test_bug460636.js]</span>
<a href="#l17.10"></a><span id="l17.10"> [test_compactOfflineStore.js]</span>
<a href="#l17.11"></a><span id="l17.11"> [test_copyThenMove.js]</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+[test_customCommandReturnsFetchResponse.js]</span>
<a href="#l17.13"></a><span id="l17.13"> [test_dod.js]</span>
<a href="#l17.14"></a><span id="l17.14"> [test_dontStatNoSelect.js]</span>
<a href="#l17.15"></a><span id="l17.15"> [test_downloadOffline.js]</span>
<a href="#l17.16"></a><span id="l17.16"> [test_fetchCustomAttribute.js]</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-[test_customCommandReturnsFetchResponse.js]</span>
<a href="#l17.18"></a><span id="l17.18"> [test_filterCustomHeaders.js]</span>
<a href="#l17.19"></a><span id="l17.19"> [test_filterNeedsBody.js]</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+[test_gmailAttributes.js]</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+[test_gmailOfflineMsgStore.js]</span>
<a href="#l17.22"></a><span id="l17.22"> [test_imapAttachmentSaves.js]</span>
<a href="#l17.23"></a><span id="l17.23"> [test_imapAuthMethods.js]</span>
<a href="#l17.24"></a><span id="l17.24"> # Disabled per bug 553764</span>
<a href="#l17.25"></a><span id="l17.25"> skip-if = true</span>
<a href="#l17.26"></a><span id="l17.26"> [test_imapAutoSync.js]</span>
<a href="#l17.27"></a><span id="l17.27"> [test_imapContentLength.js]</span>
<a href="#l17.28"></a><span id="l17.28"> [test_imapCopyTimeout.js]</span>
<a href="#l17.29"></a><span id="l17.29"> [test_imapFilterActions.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1210,18 +1210,18 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l18.4"></a><span id="l18.4">       response += &quot;* &quot; + ids[i] + &quot; FETCH (&quot;;</span>
<a href="#l18.5"></a><span id="l18.5">       var parts = [];</span>
<a href="#l18.6"></a><span id="l18.6">       for each (var item in items) {</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8">         // Brief explanation: an item like BODY[]&lt;&gt; can't be hardcoded easily,</span>
<a href="#l18.9"></a><span id="l18.9">         // so we go for the initial alphanumeric substring, passing in the</span>
<a href="#l18.10"></a><span id="l18.10">         // actual string as an optional second part.</span>
<a href="#l18.11"></a><span id="l18.11">         var front = item.split(/[^A-Z0-9-]/, 1)[0];</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        var functionName = &quot;_FETCH_&quot; + front.replace(/-/g, &quot;_&quot;); // '-' is not allowed in js identifiers;     </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-       </span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+        var functionName = &quot;_FETCH_&quot; + front.replace(/-/g, &quot;_&quot;); // '-' is not allowed in js identifiers;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+</span>
<a href="#l18.16"></a><span id="l18.16">         if (!(functionName in this))</span>
<a href="#l18.17"></a><span id="l18.17">           return &quot;BAD can't fetch &quot; + front;</span>
<a href="#l18.18"></a><span id="l18.18">         try {</span>
<a href="#l18.19"></a><span id="l18.19">           parts.push(this[functionName](messages[i], item));</span>
<a href="#l18.20"></a><span id="l18.20">         } catch (ex) {</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">           return &quot;BAD error in fetching: &quot;+ex;</span>
<a href="#l18.23"></a><span id="l18.23">         }</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineat">@@ -1593,17 +1593,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l18.25"></a><span id="l18.25">     }</span>
<a href="#l18.26"></a><span id="l18.26">   },</span>
<a href="#l18.27"></a><span id="l18.27">   _FETCH_X_GM_LABELS : function (message) {</span>
<a href="#l18.28"></a><span id="l18.28">     if (message.xGmLabels) {</span>
<a href="#l18.29"></a><span id="l18.29">         return &quot;X-GM-LABELS &quot; + message.xGmLabels;</span>
<a href="#l18.30"></a><span id="l18.30">     } else {</span>
<a href="#l18.31"></a><span id="l18.31">         return &quot;BAD can't fetch X-GM-LABELS&quot;;</span>
<a href="#l18.32"></a><span id="l18.32">     }</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  }</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+   }</span>
<a href="#l18.35"></a><span id="l18.35"> }</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.38"></a><span id="l18.38"> //                            IMAP4 RFC extensions                            //</span>
<a href="#l18.39"></a><span id="l18.39"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.40"></a><span id="l18.40"> // Since there are so many extensions to IMAP, and since these extensions are //</span>
<a href="#l18.41"></a><span id="l18.41"> // not strictly hierarchial (e.g., an RFC 2342-compliant server can also be   //</span>
<a href="#l18.42"></a><span id="l18.42"> // RFC 3516-compliant, but a server might only implement one of them), they   //</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineat">@@ -1620,18 +1620,18 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l18.44"></a><span id="l18.44"> // MOVE extension) because it changes behavior of that extension.</span>
<a href="#l18.45"></a><span id="l18.45"> var configurations = {</span>
<a href="#l18.46"></a><span id="l18.46">   Cyrus: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l18.47"></a><span id="l18.47">   UW: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l18.48"></a><span id="l18.48">   Dovecot: [&quot;RFC2195&quot;],</span>
<a href="#l18.49"></a><span id="l18.49">   Zimbra: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l18.50"></a><span id="l18.50">   Exchange: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l18.51"></a><span id="l18.51">   LEMONADE: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-  CUSTOM1: [&quot;RFCMOVE&quot;, &quot;RFC4315&quot;],</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-  GMail: [&quot;RFCGMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC4315&quot;]</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+  CUSTOM1: [&quot;RFCMOVE&quot;, &quot;RFC4315&quot;, &quot;RFCCUSTOM&quot;],</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+  GMail: [&quot;XLIST&quot;, &quot;RFCGMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC4315&quot;]</span>
<a href="#l18.56"></a><span id="l18.56"> };</span>
<a href="#l18.57"></a><span id="l18.57"> </span>
<a href="#l18.58"></a><span id="l18.58"> function mixinExtension(handler, extension) {</span>
<a href="#l18.59"></a><span id="l18.59">   if (extension.preload)</span>
<a href="#l18.60"></a><span id="l18.60">     extension.preload(handler);</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">   for (var property in extension) {</span>
<a href="#l18.63"></a><span id="l18.63">     if (property == 'preload')</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineat">@@ -1681,17 +1681,57 @@ var IMAP_RFC2342_extension = {</span>
<a href="#l18.65"></a><span id="l18.65">     return response;</span>
<a href="#l18.66"></a><span id="l18.66">   },</span>
<a href="#l18.67"></a><span id="l18.67">   kCapabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l18.68"></a><span id="l18.68">   _argFormat : { NAMESPACE : [] },</span>
<a href="#l18.69"></a><span id="l18.69">   // Enabled in AUTHED and SELECTED states</span>
<a href="#l18.70"></a><span id="l18.70">   _enabledCommands : { 1 : [&quot;NAMESPACE&quot;], 2 : [&quot;NAMESPACE&quot;] }</span>
<a href="#l18.71"></a><span id="l18.71"> };</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-// Proposed MOVE extension (imapPump requires the string &quot;RFC&quot;).</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+var IMAP_XLIST_extension = {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  XLIST : function(args) {</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+    if (!base)</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+      return &quot;NO no such mailbox&quot;;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+    if(!this._daemon.getMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true})) {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+      // No special mailbox exist, so we will create them.</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+      // Creating parent first</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]&quot;);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+      // now other folders inside the parent</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true});</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]/Sent Mail&quot;, {subscribed : true});</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {subscribed : true});</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {subscribed : true});</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+      this._daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {subscribed : true});</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+    }</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+    var people = base.matchKids(args[1]);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+    var response = &quot;&quot;;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+    var specialFolderFlagsLookupTable = {</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+      &quot;[Gmail]/All Mail&quot;: &quot;AllMail&quot;,</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+      &quot;[Gmail]/Drafts&quot;: &quot;Drafts&quot;,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+      &quot;[Gmail]/Sent Mail&quot;: &quot;Sent&quot;,</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+      &quot;[Gmail]/Starred&quot;: &quot;Starred&quot;,</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+      &quot;[Gmail]/Spam&quot;: &quot;Spam&quot;,</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+      &quot;INBOX&quot;: &quot;Inbox&quot;</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+    };</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+    for each (var box in people) {</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+      let specialFlag = box.displayName in specialFolderFlagsLookupTable ?</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+        ' \\' +specialFolderFlagsLookupTable[box.displayName] : ' ';</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+      response += '* XLIST (' + box.flags.join(&quot; &quot;) + specialFlag + ') &quot;' +</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+              box.delimiter + '&quot; &quot;' + box.displayName + '&quot;\0';</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+    }</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+    return response + &quot;OK XLIST completed&quot;;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  },</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  kCapabilities : [&quot;XLIST&quot;],</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  _argFormat : { XLIST : [&quot;mailbox&quot;, &quot;mailbox&quot;]},</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+  // Enabled in AUTHED and SELECTED states</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+  _enabledCommands : {1 : [&quot;XLIST&quot;], 2 : [&quot;XLIST&quot;]}</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+};</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+</span>
<a href="#l18.115"></a><span id="l18.115"> var IMAP_RFCMOVE_extension = {</span>
<a href="#l18.116"></a><span id="l18.116">   MOVE: function (args, uid) {</span>
<a href="#l18.117"></a><span id="l18.117">     let messages = this._parseSequenceSet(args[0], uid);</span>
<a href="#l18.118"></a><span id="l18.118"> </span>
<a href="#l18.119"></a><span id="l18.119">     let dest = this._daemon.getMailbox(args[1]);</span>
<a href="#l18.120"></a><span id="l18.120">     if (!dest)</span>
<a href="#l18.121"></a><span id="l18.121">       return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l18.122"></a><span id="l18.122"> </span>
<a href="#l18.123"></a><span id="l18.123" class="difflineat">@@ -1717,21 +1757,21 @@ var IMAP_RFCMOVE_extension = {</span>
<a href="#l18.124"></a><span id="l18.124">   },</span>
<a href="#l18.125"></a><span id="l18.125">   kCapabilities: [&quot;MOVE&quot;],</span>
<a href="#l18.126"></a><span id="l18.126">   kUidCommands: [&quot;MOVE&quot;],</span>
<a href="#l18.127"></a><span id="l18.127">   _argFormat: { MOVE: [&quot;number&quot;, &quot;mailbox&quot;] },</span>
<a href="#l18.128"></a><span id="l18.128">   // Enabled in SELECTED state</span>
<a href="#l18.129"></a><span id="l18.129">   _enabledCommands: { 2: [&quot;MOVE&quot;] }</span>
<a href="#l18.130"></a><span id="l18.130"> };</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-// Support for Gmail extensions (imapPump requires the string &quot;RFC&quot;).</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-var IMAP_RFCGMAIL_extension = {  </span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+// Support for Gmail extensions.</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+var IMAP_RFCGMAIL_extension = {</span>
<a href="#l18.136"></a><span id="l18.136">   preload: function (toBeThis) {</span>
<a href="#l18.137"></a><span id="l18.137">     toBeThis._preRFCGMAIL_STORE = toBeThis.STORE;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    toBeThis._preRFCGMAIL_STORE_argFormat = toBeThis._argFormat.STORE;  </span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+    toBeThis._preRFCGMAIL_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l18.140"></a><span id="l18.140">     toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l18.141"></a><span id="l18.141">   },</span>
<a href="#l18.142"></a><span id="l18.142">   STORE : function (args, uid) {</span>
<a href="#l18.143"></a><span id="l18.143">     let regex = /[+-]?FLAGS.*/;</span>
<a href="#l18.144"></a><span id="l18.144">     if (regex.test(args[1])) {</span>
<a href="#l18.145"></a><span id="l18.145">       // if we are storing flags, use the method that was overridden</span>
<a href="#l18.146"></a><span id="l18.146">       this._argFormat = this._preRFCGMAIL_STORE_argFormat;</span>
<a href="#l18.147"></a><span id="l18.147">       args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineat">@@ -1739,67 +1779,146 @@ var IMAP_RFCGMAIL_extension = {</span>
<a href="#l18.149"></a><span id="l18.149">     }</span>
<a href="#l18.150"></a><span id="l18.150">     // otherwise, handle gmail specific cases</span>
<a href="#l18.151"></a><span id="l18.151">     let ids = [];</span>
<a href="#l18.152"></a><span id="l18.152">     let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l18.153"></a><span id="l18.153">     args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l18.154"></a><span id="l18.154">     for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l18.155"></a><span id="l18.155">       if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l18.156"></a><span id="l18.156">         args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-      }      </span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+      }</span>
<a href="#l18.159"></a><span id="l18.159">     }</span>
<a href="#l18.160"></a><span id="l18.160">     let response = &quot;&quot;;</span>
<a href="#l18.161"></a><span id="l18.161">     for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l18.162"></a><span id="l18.162">       let message = messages[i];</span>
<a href="#l18.163"></a><span id="l18.163">       switch (args[1]) {</span>
<a href="#l18.164"></a><span id="l18.164">       case &quot;X-GM-LABELS&quot;:</span>
<a href="#l18.165"></a><span id="l18.165">         if (message.xGmLabels) {</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-          do_print(&quot;replacing [&quot; + message.xGmLabels + &quot;] with [&quot; + args[2] + &quot;]&quot;);</span>
<a href="#l18.167"></a><span id="l18.167">           message.xGmLabels = args[2];</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-          do_print(message.xGmLabels);</span>
<a href="#l18.169"></a><span id="l18.169">         } else {</span>
<a href="#l18.170"></a><span id="l18.170">           return &quot;BAD can't store X-GM-LABELS&quot;;</span>
<a href="#l18.171"></a><span id="l18.171">         }</span>
<a href="#l18.172"></a><span id="l18.172">         break;</span>
<a href="#l18.173"></a><span id="l18.173">       case &quot;+X-GM-LABELS&quot;:</span>
<a href="#l18.174"></a><span id="l18.174">         if (message.xGmLabels) {</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-          do_print(&quot;adding [&quot; + args[2] + &quot;] to [&quot; + message.xGmLabels + &quot;]&quot;);</span>
<a href="#l18.176"></a><span id="l18.176">           message.xGmLabels = message.xGmLabels.concat(args[2]);</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-          do_print(message.xGmLabels);</span>
<a href="#l18.178"></a><span id="l18.178">         } else {</span>
<a href="#l18.179"></a><span id="l18.179">           return &quot;BAD can't store X-GM-LABELS&quot;;</span>
<a href="#l18.180"></a><span id="l18.180">         }</span>
<a href="#l18.181"></a><span id="l18.181">         break;</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-      case &quot;-X-GM-LABELS&quot;:      </span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+      case &quot;-X-GM-LABELS&quot;:</span>
<a href="#l18.184"></a><span id="l18.184">         if (message.xGmLabels) {</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-          do_print(&quot;removing [&quot; + args[2] + &quot;] from [&quot; + message.xGmLabels + &quot;]&quot;);</span>
<a href="#l18.186"></a><span id="l18.186">           for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l18.187"></a><span id="l18.187">             let idx = message.xGmLabels.indexOf(args[2][i]);</span>
<a href="#l18.188"></a><span id="l18.188">             if (idx != -1) {</span>
<a href="#l18.189"></a><span id="l18.189">               message.xGmLabels.splice(idx,1);</span>
<a href="#l18.190"></a><span id="l18.190">             }</span>
<a href="#l18.191"></a><span id="l18.191">           }</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-          do_print(message.xGmLabels);</span>
<a href="#l18.193"></a><span id="l18.193">         } else {</span>
<a href="#l18.194"></a><span id="l18.194">           return &quot;BAD can't store X-GM-LABELS&quot;;</span>
<a href="#l18.195"></a><span id="l18.195">         }</span>
<a href="#l18.196"></a><span id="l18.196">         break;</span>
<a href="#l18.197"></a><span id="l18.197">       default:</span>
<a href="#l18.198"></a><span id="l18.198">         return &quot;BAD change what now?&quot;;</span>
<a href="#l18.199"></a><span id="l18.199">       }</span>
<a href="#l18.200"></a><span id="l18.200">       response += &quot;* &quot; + ids[i] + &quot; FETCH (X-GM-LABELS (&quot;;</span>
<a href="#l18.201"></a><span id="l18.201">       response += message.xGmLabels.join(' ');</span>
<a href="#l18.202"></a><span id="l18.202">       response += '))\0';</span>
<a href="#l18.203"></a><span id="l18.203">     }</span>
<a href="#l18.204"></a><span id="l18.204">     return response + 'OK STORE completed';</span>
<a href="#l18.205"></a><span id="l18.205">   },</span>
<a href="#l18.206"></a><span id="l18.206">   kCapabilities: [&quot;XLIST&quot;, &quot;X-GM-EXT-1&quot;]</span>
<a href="#l18.207"></a><span id="l18.207"> };</span>
<a href="#l18.208"></a><span id="l18.208"> </span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+// Provides methods for testing fetchCustomAttribute and issueCustomCommand</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+var IMAP_RFCCUSTOM_extension = {</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+  preload: function (toBeThis) {</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+    toBeThis._preRFCCUSTOM_STORE = toBeThis.STORE;</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+    toBeThis._preRFCCUSTOM_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+    toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+  },</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+  STORE : function (args, uid) {</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+    let regex = /[+-]?FLAGS.*/;</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+    if (regex.test(args[1])) {</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+      // if we are storing flags, use the method that was overridden</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+      this._argFormat = this._preRFCCUSTOM_STORE_argFormat;</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+      args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+      return this._preRFCCUSTOM_STORE(args, uid);</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+    }</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+    // otherwise, handle custom attribute</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+    let ids = [];</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+    let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+    args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+    for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+      if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+        args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+      }</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+    }</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+    let response = &quot;&quot;;</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+      let message = messages[i];</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+      switch (args[1]) {</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+      case &quot;X-CUSTOM-VALUE&quot;:</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+        if (message.xCustomValue &amp;&amp; args[2].length == 1) {</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+          message.xCustomValue = args[2][0];</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+        } else {</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+          return &quot;BAD can't store X-CUSTOM-VALUE&quot;;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+        }</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+        break;</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+      case &quot;X-CUSTOM-LIST&quot;:</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+        if (message.xCustomList) {</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+          message.xCustomList = args[2];</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+        } else {</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineplus">+          return &quot;BAD can't store X-CUSTOM-LIST&quot;;</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineplus">+        }</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineplus">+        break;</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineplus">+      case &quot;+X-CUSTOM-LIST&quot;:</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+        if (message.xCustomList) {</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+          message.xCustomList = message.xCustomList.concat(args[2]);</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+        } else {</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+          return &quot;BAD can't store X-CUSTOM-LIST&quot;;</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+        }</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+        break;</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+      case &quot;-X-CUSTOM-LIST&quot;:</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+        if (message.xCustomList) {</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+          for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+            let idx = message.xCustomList.indexOf(args[2][i]);</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+            if (idx != -1) {</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+              message.xCustomList.splice(idx,1);</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+            }</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+          }</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+        } else {</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineplus">+          return &quot;BAD can't store X-CUSTOM-LIST&quot;;</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineplus">+        }</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineplus">+        break;</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineplus">+      default:</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+        return &quot;BAD change what now?&quot;;</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+      }</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+      response += &quot;* &quot; + ids[i] + &quot; FETCH (X-CUSTOM-LIST (&quot;;</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+      response += message.xCustomList.join(' ');</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+      response += '))\0';</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineplus">+    }</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineplus">+    return response + 'OK STORE completed';</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineplus">+  },</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineplus">+  _FETCH_X_CUSTOM_VALUE : function (message) {</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineplus">+    if (message.xCustomValue) {</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineplus">+        return &quot;X-CUSTOM-VALUE &quot; + message.xCustomValue;</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineplus">+    } else {</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineplus">+        return &quot;BAD can't fetch X-CUSTOM-VALUE&quot;;</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+    }</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineplus">+  },</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+  _FETCH_X_CUSTOM_LIST : function (message) {</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+    if (message.xCustomList) {</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+        return &quot;X-CUSTOM-LIST (&quot; + message.xCustomList.join(' ') + &quot;)&quot;;</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+    } else {</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+        return &quot;BAD can't fetch X-CUSTOM-LIST&quot;;</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+    }</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineplus">+  },</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+  kCapabilities: [&quot;X-CUSTOM1&quot;]</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+};</span>
<a href="#l18.296"></a><span id="l18.296"> // RFC 2197: ID</span>
<a href="#l18.297"></a><span id="l18.297"> var IMAP_RFC2197_extension = {</span>
<a href="#l18.298"></a><span id="l18.298">   ID: function (args) {</span>
<a href="#l18.299"></a><span id="l18.299">     let clientID = &quot;(&quot;;</span>
<a href="#l18.300"></a><span id="l18.300">     for each (let i in args)</span>
<a href="#l18.301"></a><span id="l18.301">       clientID += &quot;\&quot;&quot; + i + &quot;\&quot;&quot;;</span>
<a href="#l18.302"></a><span id="l18.302"> </span>
<a href="#l18.303"></a><span id="l18.303">     clientID += &quot;)&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -53,18 +53,17 @@ function setupIMAPPump(extensions)</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">     function createHandler(d) {</span>
<a href="#l19.6"></a><span id="l19.6">       var handler = new IMAP_RFC3501_handler(d);</span>
<a href="#l19.7"></a><span id="l19.7">       if (!infoString)</span>
<a href="#l19.8"></a><span id="l19.8">         infoString = &quot;RFC2195&quot;;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">       var parts = infoString.split(/ *, */);</span>
<a href="#l19.11"></a><span id="l19.11">       for each (var part in parts) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-          mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+        mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l19.15"></a><span id="l19.15">       }</span>
<a href="#l19.16"></a><span id="l19.16">       return handler;</span>
<a href="#l19.17"></a><span id="l19.17">     }</span>
<a href="#l19.18"></a><span id="l19.18">     var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l19.19"></a><span id="l19.19">     server.start(IMAP_PORT);</span>
<a href="#l19.20"></a><span id="l19.20">     return server;</span>
<a href="#l19.21"></a><span id="l19.21">   }</span>
<a href="#l19.22"></a><span id="l19.22"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

