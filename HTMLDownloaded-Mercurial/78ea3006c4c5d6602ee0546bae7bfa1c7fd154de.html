<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6227:78ea3006c4c5d6602ee0546bae7bfa1c7fd154de</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 78ea3006c4c5d6602ee0546bae7bfa1c7fd154de" />
<meta property="og:url" content="/comm-central/rev/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de" />
<meta property="og:description" content="Bug 586742 - Add an attachmentInfos noun to gloda messages, including, but not limited to, attachment url, name, size, and content-type; r=asuth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 78ea3006c4c5d6602ee0546bae7bfa1c7fd154de 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">shortlog</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">files</a> |
changeset |
<a href="/comm-central/raw-rev/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">raw</a>  | <a href="/comm-central/archive/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586742">Bug 586742</a> - Add an attachmentInfos noun to gloda messages, including, but not limited to, attachment url, name, size, and content-type; r=asuth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#32;&#80;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#32;&#60;&#106;&#111;&#110;&#97;&#116;&#104;&#97;&#110;&#46;&#112;&#114;&#111;&#116;&#122;&#101;&#110;&#107;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Aug 2010 10:33:54 +0100</td></tr>

<tr>
 <td>changeset 6227</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">78ea3006c4c5d6602ee0546bae7bfa1c7fd154de</a></td>
</tr>



<tr>
<td>parent 6226</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d0dfea29e25261b5df9c25281a42d0c9862af574">d0dfea29e25261b5df9c25281a42d0c9862af574</a>
</td>
</tr>

<tr>
<td>child 6228</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/574ee823683ffcef19c3defe3daea53413d022f5">574ee823683ffcef19c3defe3daea53413d022f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=78ea3006c4c5d6602ee0546bae7bfa1c7fd154de">4806</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 20 Aug 2010 09:36:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@574ee823683f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=574ee823683ffcef19c3defe3daea53413d022f5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=574ee823683ffcef19c3defe3daea53413d022f5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=574ee823683ffcef19c3defe3daea53413d022f5&newProject=comm-central&newRevision=78ea3006c4c5d6602ee0546bae7bfa1c7fd154de&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=574ee823683ffcef19c3defe3daea53413d022f5&newProject=comm-central&newRevision=78ea3006c4c5d6602ee0546bae7bfa1c7fd154de&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=574ee823683ffcef19c3defe3daea53413d022f5&newProject=comm-central&newRevision=78ea3006c4c5d6602ee0546bae7bfa1c7fd154de&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586742">586742</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=586742">Bug 586742</a> - Add an attachmentInfos noun to gloda messages, including, but not limited to, attachment url, name, size, and content-type; r=asuth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">mailnews/db/gloda/modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">mailnews/db/gloda/modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">mailnews/db/gloda/test/unit/base_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/base_index_messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">mailnews/db/gloda/test/unit/test_mime_attachments_size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_attachments_size.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">mailnews/db/gloda/test/unit/test_mime_emitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">file</a> |
<a href="/comm-central/annotate/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">annotate</a> |
<a href="/comm-central/diff/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">diff</a> |
<a href="/comm-central/comparison/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">comparison</a> |
<a href="/comm-central/log/78ea3006c4c5d6602ee0546bae7bfa1c7fd154de/mailnews/db/gloda/test/unit/test_mime_emitter.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,17 +32,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.5"></a><span id="l1.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.6"></a><span id="l1.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.7"></a><span id="l1.7">  *</span>
<a href="#l1.8"></a><span id="l1.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> const EXPORTED_SYMBOLS = [&quot;GlodaAttributeDBDef&quot;,</span>
<a href="#l1.11"></a><span id="l1.11">                     &quot;GlodaConversation&quot;, &quot;GlodaFolder&quot;, &quot;GlodaMessage&quot;,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                    &quot;GlodaContact&quot;, &quot;GlodaIdentity&quot;];</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                    &quot;GlodaContact&quot;, &quot;GlodaIdentity&quot;, &quot;GlodaAttachment&quot;];</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> const Cc = Components.classes;</span>
<a href="#l1.16"></a><span id="l1.16"> const Ci = Components.interfaces;</span>
<a href="#l1.17"></a><span id="l1.17"> const Cr = Components.results;</span>
<a href="#l1.18"></a><span id="l1.18"> const Cu = Components.utils;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> const LOG = Log4Moz.repository.getLogger(&quot;gloda.datamodel&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -117,19 +117,24 @@ GlodaAttributeDBDef.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">     let dbAttributes = [];</span>
<a href="#l1.24"></a><span id="l1.24">     if (nounDef.usesParameter) {</span>
<a href="#l1.25"></a><span id="l1.25">       for each (let [, instanceValue] in Iterator(aInstanceValues)) {</span>
<a href="#l1.26"></a><span id="l1.26">         let [param, dbValue] = nounDef.toParamAndValue(instanceValue);</span>
<a href="#l1.27"></a><span id="l1.27">         dbAttributes.push([this.bindParameter(param), dbValue]);</span>
<a href="#l1.28"></a><span id="l1.28">       }</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30">     else {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      for each (let [, instanceValue] in Iterator(aInstanceValues)) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-        dbAttributes.push([this._id,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-                           nounDef.toParamAndValue(instanceValue)[1]]);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      // Not generating any attributes is ok. This basically means the noun is</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      // just an informative property on the Gloda Message and has no real</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+      // indexing purposes.</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      if (&quot;toParamAndValue&quot; in nounDef) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        for each (let [, instanceValue] in Iterator(aInstanceValues)) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+          dbAttributes.push([this._id,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                             nounDef.toParamAndValue(instanceValue)[1]]);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+        }</span>
<a href="#l1.42"></a><span id="l1.42">       }</span>
<a href="#l1.43"></a><span id="l1.43">     }</span>
<a href="#l1.44"></a><span id="l1.44">     return dbAttributes;</span>
<a href="#l1.45"></a><span id="l1.45">   },</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   toString: function() {</span>
<a href="#l1.48"></a><span id="l1.48">     return this._compoundName;</span>
<a href="#l1.49"></a><span id="l1.49">   }</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineat">@@ -830,8 +835,34 @@ GlodaIdentity.prototype = {</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   pictureURL: function(aSize) {</span>
<a href="#l1.53"></a><span id="l1.53">     if (this.inAddressBook) {</span>
<a href="#l1.54"></a><span id="l1.54">       // XXX should get the photo if we have it.</span>
<a href="#l1.55"></a><span id="l1.55">     }</span>
<a href="#l1.56"></a><span id="l1.56">     return &quot;&quot;;</span>
<a href="#l1.57"></a><span id="l1.57">   }</span>
<a href="#l1.58"></a><span id="l1.58"> };</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+/**</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+ * An attachment, with as much information as we can gather on it</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+ */</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+function GlodaAttachment(aName, aContentType, aSize, aURL) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  // _datastore set on the prototype by GlodaDatastore</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  this._name = aName;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  this._contentType = aContentType;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  this._size = aSize;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  this._url = aURL;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+}</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+GlodaAttachment.prototype = {</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  NOUN_ID: 105,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  // set by GlodaDatastore</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  get name() { return this._name; },</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  get contentType() { return this._contentType; },</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  get size() { return this._size; },</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  get url() { return this._url; },</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  toString: function gloda_attachment_toString() {</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    return &quot;attachment: &quot; + this._name + &quot;:&quot; + this._contentType;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  },</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -43,16 +43,17 @@ const Cr = Components.results;</span>
<a href="#l2.4"></a><span id="l2.4"> const Cu = Components.utils;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> Cu.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> Cu.import(&quot;resource:///modules/gloda/utils.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Cu.import(&quot;resource:///modules/gloda/gloda.js&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> Cu.import(&quot;resource:///modules/gloda/datastore.js&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/datamodel.js&quot;); // for GlodaAttachment</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> Cu.import(&quot;resource:///modules/gloda/noun_mimetype.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> Cu.import(&quot;resource:///modules/gloda/connotent.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> /**</span>
<a href="#l2.18"></a><span id="l2.18">  * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l2.19"></a><span id="l2.19">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l2.20"></a><span id="l2.20">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -356,16 +357,28 @@ var GlodaFundAttr = {</span>
<a href="#l2.22"></a><span id="l2.22">         // This will group the MIME types by their category.</span>
<a href="#l2.23"></a><span id="l2.23">         groupIdAttr: &quot;category&quot;,</span>
<a href="#l2.24"></a><span id="l2.24">         queryHelper: &quot;Category&quot;,</span>
<a href="#l2.25"></a><span id="l2.25">       },</span>
<a href="#l2.26"></a><span id="l2.26">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.27"></a><span id="l2.27">       objectNoun: Gloda.NOUN_MIME_TYPE,</span>
<a href="#l2.28"></a><span id="l2.28">       });</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    // Attachment infos</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    this._attrAttachmentInfos = Gloda.defineAttribute({</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+      provider: this,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+      attributeType: Gloda.kAttrFundamental,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+      attributeName: &quot;attachmentInfos&quot;,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+      singular: false,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+      emptySetIsSignificant: false,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+      objectNoun: Gloda.NOUN_ATTACHMENT,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+      });</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42">     // --- Optimization</span>
<a href="#l2.43"></a><span id="l2.43">     /**</span>
<a href="#l2.44"></a><span id="l2.44">      * Involves means any of from/to/cc/bcc.  The queries get ugly enough</span>
<a href="#l2.45"></a><span id="l2.45">      *  without this that it seems to justify the cost, especially given the</span>
<a href="#l2.46"></a><span id="l2.46">      *  frequent use case.  (In fact, post-filtering for the specific from/to/cc</span>
<a href="#l2.47"></a><span id="l2.47">      *  is probably justifiable rather than losing this attribute...)</span>
<a href="#l2.48"></a><span id="l2.48">      */</span>
<a href="#l2.49"></a><span id="l2.49">     this._attrInvolves = Gloda.defineAttribute({</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineat">@@ -543,16 +556,30 @@ var GlodaFundAttr = {</span>
<a href="#l2.51"></a><span id="l2.51">         if (attachment.isRealAttachment &amp;&amp;</span>
<a href="#l2.52"></a><span id="l2.52">             (attachment.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l2.53"></a><span id="l2.53">           attachmentTypes.push(MimeTypeNoun.getMimeType(attachment.contentType));</span>
<a href="#l2.54"></a><span id="l2.54">         }</span>
<a href="#l2.55"></a><span id="l2.55">       }</span>
<a href="#l2.56"></a><span id="l2.56">       if (attachmentTypes.length) {</span>
<a href="#l2.57"></a><span id="l2.57">         aGlodaMessage.attachmentTypes = attachmentTypes;</span>
<a href="#l2.58"></a><span id="l2.58">       }</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+      // This is not the same kind of attachments as above. Now, we want to</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+      // provide convenience attributes to Gloda consumers, so that they can run</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      // through the list of attachments of a given message, to possibly build a</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+      // visualization on top of it. We still reject bogus mime types, which</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      // means yencode won't be supported. Oh, I feel really bad.</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+      let attachmentInfos = [];</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+      for each (let [, att] in Iterator(aMimeMsg.allUserAttachments)) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        if (att.isRealAttachment &amp;&amp; (att.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+          attachmentInfos.push(</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+            new GlodaAttachment(att.name, att.contentType, att.size, att.url));</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+        }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      }</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      aGlodaMessage.attachmentInfos = attachmentInfos;</span>
<a href="#l2.73"></a><span id="l2.73">     }</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">     // TODO: deal with mailing lists, including implicit-to.  this will require</span>
<a href="#l2.76"></a><span id="l2.76">     //  convincing the indexer to pass us in the previous message if it is</span>
<a href="#l2.77"></a><span id="l2.77">     //  available.  (which we'll simply pass to everyone... it can help body</span>
<a href="#l2.78"></a><span id="l2.78">     //  logic for quoting purposes, etc. too.)</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">     yield Gloda.kWorkDone;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -766,16 +766,20 @@ var Gloda = {</span>
<a href="#l3.4"></a><span id="l3.4">   NOUN_CONTACT: GlodaContact.prototype.NOUN_ID, // 103</span>
<a href="#l3.5"></a><span id="l3.5">   /**</span>
<a href="#l3.6"></a><span id="l3.6">    * A single identity of a contact, who may have one or more.  E-mail accounts,</span>
<a href="#l3.7"></a><span id="l3.7">    *  instant messaging accounts, social network site accounts, etc. are each</span>
<a href="#l3.8"></a><span id="l3.8">    *  identities.  See datamodel.js for the definition of the GlodaIdentity</span>
<a href="#l3.9"></a><span id="l3.9">    *  class.</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11">   NOUN_IDENTITY: GlodaIdentity.prototype.NOUN_ID, // 104</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  /**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+   * An attachment to a message. A message may have many different attachments.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+   */</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  NOUN_ATTACHMENT: GlodaAttachment.prototype.NOUN_ID, // 105</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   /**</span>
<a href="#l3.18"></a><span id="l3.18">    * Parameterized identities, for use in the from-me, to-me, cc-me optimization</span>
<a href="#l3.19"></a><span id="l3.19">    *  cases.  Not for reuse without some thought.  These nouns use the parameter</span>
<a href="#l3.20"></a><span id="l3.20">    *  to store the 'me' identity that we are talking about, and the value to</span>
<a href="#l3.21"></a><span id="l3.21">    *  store the identity of the other party.  So in both the from-me and to-me</span>
<a href="#l3.22"></a><span id="l3.22">    *  cases involving 'me' and 'foo@bar', the 'me' identity is always stored via</span>
<a href="#l3.23"></a><span id="l3.23">    *  the attribute parameter, and the 'foo@bar' identity is always stored as</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -884,16 +888,17 @@ var Gloda = {</span>
<a href="#l3.25"></a><span id="l3.25">     //  of functionality.  Said door is officially unsupported.</span>
<a href="#l3.26"></a><span id="l3.26">     if (aNounDef.schema) {</span>
<a href="#l3.27"></a><span id="l3.27">       if (aNounDef.schema.name)</span>
<a href="#l3.28"></a><span id="l3.28">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.schema.name;</span>
<a href="#l3.29"></a><span id="l3.29">       else</span>
<a href="#l3.30"></a><span id="l3.30">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.name;</span>
<a href="#l3.31"></a><span id="l3.31">       // this creates the data table and binder and hooks everything up</span>
<a href="#l3.32"></a><span id="l3.32">       GlodaDatastore.createNounTable(aNounDef);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34">       if (!aNounDef.toParamAndValue)</span>
<a href="#l3.35"></a><span id="l3.35">         aNounDef.toParamAndValue = function (aThing) {</span>
<a href="#l3.36"></a><span id="l3.36">           if (aThing instanceof aNounDef.class)</span>
<a href="#l3.37"></a><span id="l3.37">             return [null, aThing.id];</span>
<a href="#l3.38"></a><span id="l3.38">           else // assume they're just passing the id directly</span>
<a href="#l3.39"></a><span id="l3.39">             return [null, aThing];</span>
<a href="#l3.40"></a><span id="l3.40">         };</span>
<a href="#l3.41"></a><span id="l3.41">     }</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineat">@@ -1332,16 +1337,33 @@ var Gloda = {</span>
<a href="#l3.43"></a><span id="l3.43">         return a.contact.name.localeCompare(b.contact.name);</span>
<a href="#l3.44"></a><span id="l3.44">       },</span>
<a href="#l3.45"></a><span id="l3.45">       toParamAndValue: function(aIdentity) {</span>
<a href="#l3.46"></a><span id="l3.46">         if (aIdentity instanceof GlodaIdentity)</span>
<a href="#l3.47"></a><span id="l3.47">           return [null, aIdentity.id];</span>
<a href="#l3.48"></a><span id="l3.48">         else // assume they're just passing the id directly</span>
<a href="#l3.49"></a><span id="l3.49">           return [null, aIdentity];</span>
<a href="#l3.50"></a><span id="l3.50">       }}, this.NOUN_IDENTITY);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    this.defineNoun({</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+      name: &quot;attachment-infos&quot;,</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+      clazz: GlodaAttachment,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+      allowsArbitraryAttrs: false,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+      toJSON: function (x) {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+          return {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+            name: x.name,</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+            contentType: x.contentType,</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+            size: x.size,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+            url: x.url</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+          }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+        },</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      fromJSON: function (x) {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+          return new GlodaAttachment(x.name, x.contentType, x.size, x.url);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        },</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      }, this.NOUN_ATTACHMENT);</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">     // parameterized identity is just two identities; we store the first one</span>
<a href="#l3.70"></a><span id="l3.70">     //  (whose value set must be very constrainted, like the 'me' identities)</span>
<a href="#l3.71"></a><span id="l3.71">     //  as the parameter, the second (which does not need to be constrained)</span>
<a href="#l3.72"></a><span id="l3.72">     //  as the value.</span>
<a href="#l3.73"></a><span id="l3.73">     this.defineNoun({</span>
<a href="#l3.74"></a><span id="l3.74">       name: &quot;parameterized-identity&quot;,</span>
<a href="#l3.75"></a><span id="l3.75">       clazz: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -375,18 +375,23 @@ var fundamentalGlodaMessageId;</span>
<a href="#l4.4"></a><span id="l4.4">  * Test that we extract the 'fundamental attributes' of a message properly</span>
<a href="#l4.5"></a><span id="l4.5">  *  'Fundamental' in this case is talking about the attributes defined/extracted</span>
<a href="#l4.6"></a><span id="l4.6">  *  by gloda's fundattr.js and perhaps the core message indexing logic itself</span>
<a href="#l4.7"></a><span id="l4.7">  *  (which show up as kSpecial* attributes in fundattr.js anyways.)</span>
<a href="#l4.8"></a><span id="l4.8">  */</span>
<a href="#l4.9"></a><span id="l4.9"> function test_attributes_fundamental() {</span>
<a href="#l4.10"></a><span id="l4.10">   // create a synthetic message with attachment</span>
<a href="#l4.11"></a><span id="l4.11">   let smsg = msgGen.makeMessage({</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    name: 'test message',</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+      new SyntheticPartLeaf({body: 'I like cheese!'}),</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      msgGen.makeMessage({ body: { body: 'I like wine!' }}), // that's one attachment</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    ]),</span>
<a href="#l4.17"></a><span id="l4.17">     attachments: [</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-      {filename: 'bob.txt', body: 'I like cheese!'}</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+      {filename: 'bob.txt', body: 'I like bread!'} // and that's another one</span>
<a href="#l4.20"></a><span id="l4.20">     ],</span>
<a href="#l4.21"></a><span id="l4.21">   });</span>
<a href="#l4.22"></a><span id="l4.22">   // save it off for test_attributes_fundamental_from_disk</span>
<a href="#l4.23"></a><span id="l4.23">   fundamentalSyntheticMessage = smsg;</span>
<a href="#l4.24"></a><span id="l4.24">   let msgSet = new SyntheticMessageSet([smsg]);</span>
<a href="#l4.25"></a><span id="l4.25">   let folder = fundamentalFolderHandle = make_empty_folder();</span>
<a href="#l4.26"></a><span id="l4.26">   yield add_sets_to_folders(folder, [msgSet]);</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineat">@@ -431,16 +436,33 @@ function verify_attributes_fundamental(s</span>
<a href="#l4.29"></a><span id="l4.29">   do_check_eq(smsg.messageId, gmsg.headerMessageID);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   // -- attachments. We won't have these if we don't have fulltext results</span>
<a href="#l4.32"></a><span id="l4.32">   if (expectFulltextResults) {</span>
<a href="#l4.33"></a><span id="l4.33">     do_check_eq(gmsg.attachmentTypes.length, 1);</span>
<a href="#l4.34"></a><span id="l4.34">     do_check_eq(gmsg.attachmentTypes[0], &quot;text/plain&quot;);</span>
<a href="#l4.35"></a><span id="l4.35">     do_check_eq(gmsg.attachmentNames.length, 1);</span>
<a href="#l4.36"></a><span id="l4.36">     do_check_eq(gmsg.attachmentNames[0], &quot;bob.txt&quot;);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    let expectedInfos = [</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      // the name for that one is generated randomly</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      { contentType: &quot;message/rfc822&quot; },</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      { name: &quot;bob.txt&quot;, contentType: &quot;text/plain&quot; },</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    ];</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    let expectedSize = 14;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    do_check_eq(gmsg.attachmentInfos.length, 2);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    for each (let [i, attInfos] in Iterator(gmsg.attachmentInfos)) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      for (let k in expectedInfos[i])</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+        do_check_eq(attInfos[k], expectedInfos[i][k]);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+      // because it's unreliable and depends on the platform</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      do_check_true(Math.abs(attInfos.size - expectedSize) &lt;= 2);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      // because the url contains the path to the folder on disk which depends</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      // on the test setup</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+      do_check_true(attInfos.url.length &gt; 0);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    }</span>
<a href="#l4.54"></a><span id="l4.54">   }</span>
<a href="#l4.55"></a><span id="l4.55">   else {</span>
<a href="#l4.56"></a><span id="l4.56">     // Make sure we don't actually get attachments!</span>
<a href="#l4.57"></a><span id="l4.57">     do_check_eq(gmsg.attachmentTypes, null);</span>
<a href="#l4.58"></a><span id="l4.58">     do_check_eq(gmsg.attachmentNames, null);</span>
<a href="#l4.59"></a><span id="l4.59">   }</span>
<a href="#l4.60"></a><span id="l4.60"> }</span>
<a href="#l4.61"></a><span id="l4.61"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_mime_attachments_size.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_mime_attachments_size.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -163,64 +163,98 @@ var messageInfos = [</span>
<a href="#l5.4"></a><span id="l5.4">   // attachment (probably a deliberate choice), size is NOT counted properly</span>
<a href="#l5.5"></a><span id="l5.5">   // (don't want to investigate, I doubt it's a useful information anyway)</span>
<a href="#l5.6"></a><span id="l5.6">   /*{</span>
<a href="#l5.7"></a><span id="l5.7">     name: 'multipart/related',</span>
<a href="#l5.8"></a><span id="l5.8">     bodyPart: new SyntheticPartMultiRelated([partHtml, partRelImage]),</span>
<a href="#l5.9"></a><span id="l5.9">   },*/</span>
<a href="#l5.10"></a><span id="l5.10">   // all of the other common cases work fine</span>
<a href="#l5.11"></a><span id="l5.11">   {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    name: 'text/plain w/app attachment (=&gt; multipart/mixed)',</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    name: '.eml attachment',</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+      partHtml,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+      msgGen.makeMessage({ body: { body: originalText } }),</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+    ]),</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    epsilon: 4,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  },</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+    name: 'all sorts of &quot;real&quot; attachments',</span>
<a href="#l5.22"></a><span id="l5.22">     bodyPart: partHtml,</span>
<a href="#l5.23"></a><span id="l5.23">     attachments: [tachImage, tachPdf, tachUU,</span>
<a href="#l5.24"></a><span id="l5.24">       tachApplication, tachText, tachInlineText,],</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    epsilon: 2,</span>
<a href="#l5.26"></a><span id="l5.26">   },</span>
<a href="#l5.27"></a><span id="l5.27"> ];</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-function check_attachments(aMimeMsg) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+function check_attachments(aMimeMsg, epsilon) {</span>
<a href="#l5.31"></a><span id="l5.31">   if (aMimeMsg == null)</span>
<a href="#l5.32"></a><span id="l5.32">     do_throw(&quot;We really should have gotten a result!&quot;);</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  /* Today's gory details: libmime somehow counts the trailing newline for an</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-   * attachment MIME part. Most of the time, assuming attachment has N bytes (no matter</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-   * what's inside, newlines or not), libmime will return N + 1 bytes. On Linux</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-   * and Mac, this always holds. However, on Windows, if the attachment is not</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-   * encoded (that is, is inline text), libmime will return N + 2 bytes.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  dump(aMimeMsg.prettyString()+&quot;\n&quot;);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  /* It is hard to get a byte count that's perfectly accurate. When composing</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   * the message, the MIME structure goes like this (for an encoded attachment):</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+   *</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+   * XXXXXXXXXX </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   * XXXXXXXXXX    &lt;-- encoded block</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+   * XXXXXXXXXX</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+   *               &lt;-- newline</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+   * --chopchop    &lt;-- MIME separator</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+   *</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+   * libmime counts bytes all the way up to the separator, which means it counts</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+   * the bytes for the extra line. Since newlines in emails are \n, most of the</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+   * time we get att.size = 174 instead of 173.</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+   *</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+   * Due to mysterious line encoding issues, for attachments that are</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+   * text/plain, we get att.size = 175 instead of 174 on Windows.</span>
<a href="#l5.56"></a><span id="l5.56">    *</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-   * This means on Windows, att.size = 175 for application/x-funky, 174 for</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-   * other test attachments (and the real size is 173 bytes).</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+   * Due to the way the fake messages are created, the test message with an .eml</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+   * attachment gets an extra new line before the separator.</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+   *</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+   * de me dire</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+   * je m'endor   &lt;-- text/plain attachment</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+   * s. &gt;&gt;.</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+   *              &lt;-- aaarggh! an extra newline!</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+   *</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+   * --chopchop</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+   *</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+   * So that raises the count to 175 on Unix, and 177 on Windows, because of</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+   * that weird newline issue.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+   *</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+   * The good news is, it's just a fixed extra cost. There no issues with the</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+   * inner contents of the attachment, you can add as many newlines as you want</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+   * in it, Unix or Windows, the count won't get past the bounds.</span>
<a href="#l5.75"></a><span id="l5.75">    */</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-  let epsilon = (&quot;@mozilla.org/windows-registry-key;1&quot; in Components.classes) ? 2 : 1;</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  do_check_true(aMimeMsg.allAttachments.length &gt; 0);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  do_check_true(aMimeMsg.allUserAttachments.length &gt; 0);</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81">   let totalSize = htmlText.length;</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-  for each (let [i, att] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    dump(&quot;*** Attachment now is &quot;+att.name+&quot;\n&quot;);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    do_check_true((att.size - originalText.length) &lt;= epsilon);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  for each (let [i, att] in Iterator(aMimeMsg.allUserAttachments)) {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+    dump(&quot;*** Attachment now is &quot;+att.name+&quot; &quot;+att.size+&quot;\n&quot;);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+    do_check_true(Math.abs(att.size - originalText.length) &lt;= epsilon);</span>
<a href="#l5.89"></a><span id="l5.89">     totalSize += att.size;</span>
<a href="#l5.90"></a><span id="l5.90">   }</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  do_check_true((aMimeMsg.size - totalSize) &lt;= epsilon);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  do_check_true(Math.abs(aMimeMsg.size - totalSize) &lt;= epsilon);</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95">   async_driver();</span>
<a href="#l5.96"></a><span id="l5.96"> }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98"> function test_message_attachments(info) {</span>
<a href="#l5.99"></a><span id="l5.99">   let synMsg = gMessageGenerator.makeMessage(info);</span>
<a href="#l5.100"></a><span id="l5.100">   let synSet = new SyntheticMessageSet([synMsg]);</span>
<a href="#l5.101"></a><span id="l5.101">   yield add_sets_to_folder(gInbox, [synSet]);</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103">   let msgHdr = synSet.getMsgHdr(0);</span>
<a href="#l5.104"></a><span id="l5.104">   dump(synMsg.toMboxString()+&quot;\n&quot;);</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106">   MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l5.107"></a><span id="l5.107">     try {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-      check_attachments(aMimeMsg);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+      check_attachments(aMimeMsg, info.epsilon);</span>
<a href="#l5.110"></a><span id="l5.110">     } catch (e) {</span>
<a href="#l5.111"></a><span id="l5.111">       do_throw(e);</span>
<a href="#l5.112"></a><span id="l5.112">     }</span>
<a href="#l5.113"></a><span id="l5.113">   });</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115">   yield false;</span>
<a href="#l5.116"></a><span id="l5.116"> }</span>
<a href="#l5.117"></a><span id="l5.117"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_mime_emitter.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_mime_emitter.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -396,33 +396,33 @@ function test_sane_bodies() {</span>
<a href="#l6.4"></a><span id="l6.4"> // allUserAttachments representation</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> var partTachNestedMessages = [</span>
<a href="#l6.7"></a><span id="l6.7">   msgGen.makeMessage(),</span>
<a href="#l6.8"></a><span id="l6.8">   msgGen.makeMessage({</span>
<a href="#l6.9"></a><span id="l6.9">       attachments: [tachImage]</span>
<a href="#l6.10"></a><span id="l6.10">     }),</span>
<a href="#l6.11"></a><span id="l6.11">   msgGen.makeMessage({</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      attachments: [tachImage, { contentType: &quot;message/rfc822&quot;, body: &quot;W000t&quot; }, tachApplication]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      attachments: [tachImage, tachApplication]</span>
<a href="#l6.14"></a><span id="l6.14">     })</span>
<a href="#l6.15"></a><span id="l6.15"> ];</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> var attMessagesParams = [</span>
<a href="#l6.18"></a><span id="l6.18">   {</span>
<a href="#l6.19"></a><span id="l6.19">     name: 'attached rfc822',</span>
<a href="#l6.20"></a><span id="l6.20">     bodyPart: new SyntheticPartMultiMixed([partAlternative,</span>
<a href="#l6.21"></a><span id="l6.21">                                            partTachNestedMessages[0]]),</span>
<a href="#l6.22"></a><span id="l6.22">   },</span>
<a href="#l6.23"></a><span id="l6.23">   {</span>
<a href="#l6.24"></a><span id="l6.24">     name: 'attached rfc822 w. image inside',</span>
<a href="#l6.25"></a><span id="l6.25">     bodyPart: new SyntheticPartMultiMixed([partAlternative,</span>
<a href="#l6.26"></a><span id="l6.26">                                            partTachNestedMessages[1]]),</span>
<a href="#l6.27"></a><span id="l6.27">   },</span>
<a href="#l6.28"></a><span id="l6.28">   {</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-    name: 'attached x/funky + attached rfc822 w. (image + rfc822 + x/funky) inside',</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+    name: 'attached x/funky + attached rfc822 w. (image + x/funky) inside',</span>
<a href="#l6.31"></a><span id="l6.31">     bodyPart: new SyntheticPartMultiMixed([partAlternative,</span>
<a href="#l6.32"></a><span id="l6.32">                                            partTachApplication,</span>
<a href="#l6.33"></a><span id="l6.33">                                            partTachNestedMessages[2]]),</span>
<a href="#l6.34"></a><span id="l6.34">   }</span>
<a href="#l6.35"></a><span id="l6.35"> ];</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> var expectedAttachmentsInfo = [</span>
<a href="#l6.38"></a><span id="l6.38">   {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

