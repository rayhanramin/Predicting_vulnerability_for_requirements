<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12433:f743582c7050fd12afc8dbc3ffc30ffec44c555c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f743582c7050fd12afc8dbc3ffc30ffec44c555c" />
<meta property="og:url" content="/comm-central/rev/f743582c7050fd12afc8dbc3ffc30ffec44c555c" />
<meta property="og:description" content="Fix bug 868740 - Add initial ical.js implementation. r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f743582c7050fd12afc8dbc3ffc30ffec44c555c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f743582c7050fd12afc8dbc3ffc30ffec44c555c">shortlog</a> |
<a href="/comm-central/log/f743582c7050fd12afc8dbc3ffc30ffec44c555c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f743582c7050fd12afc8dbc3ffc30ffec44c555c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f743582c7050fd12afc8dbc3ffc30ffec44c555c">files</a> |
changeset |
<a href="/comm-central/raw-rev/f743582c7050fd12afc8dbc3ffc30ffec44c555c">raw</a>  | <a href="/comm-central/archive/f743582c7050fd12afc8dbc3ffc30ffec44c555c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=868740">bug 868740</a> - Add initial ical.js implementation. r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 07 May 2013 15:11:50 +0200</td></tr>

<tr>
 <td>changeset 12433</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f743582c7050fd12afc8dbc3ffc30ffec44c555c">f743582c7050fd12afc8dbc3ffc30ffec44c555c</a></td>
</tr>



<tr>
<td>parent 12432</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/72f565c70050bcd991449c8e7543d91b5077abdf">72f565c70050bcd991449c8e7543d91b5077abdf</a>
</td>
</tr>

<tr>
<td>child 12434</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/638db6e0f8a7e299666fffd0d127c1c6fd7eb25e">638db6e0f8a7e299666fffd0d127c1c6fd7eb25e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f743582c7050fd12afc8dbc3ffc30ffec44c555c">9168</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 May 2013 10:22:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c5b0682b53eb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c5b0682b53ebe7d14c04cf11b7612db76e93e92f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c5b0682b53ebe7d14c04cf11b7612db76e93e92f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c5b0682b53ebe7d14c04cf11b7612db76e93e92f&newProject=comm-central&newRevision=3ca1770cc64312e83d1020cbe47357076665dc95&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c5b0682b53ebe7d14c04cf11b7612db76e93e92f&newProject=comm-central&newRevision=3ca1770cc64312e83d1020cbe47357076665dc95&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c5b0682b53ebe7d14c04cf11b7612db76e93e92f&newProject=comm-central&newRevision=3ca1770cc64312e83d1020cbe47357076665dc95&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=868740">868740</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=868740">bug 868740</a> - Add initial ical.js implementation. r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">calendar/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">calendar/base/modules/ical.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">file</a> |
<a href="/comm-central/annotate/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">annotate</a> |
<a href="/comm-central/diff/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">diff</a> |
<a href="/comm-central/comparison/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">comparison</a> |
<a href="/comm-central/log/f743582c7050fd12afc8dbc3ffc30ffec44c555c/calendar/base/modules/ical.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -16,11 +16,12 @@ EXTRA_JS_MODULES = \</span>
<a href="#l1.4"></a><span id="l1.4">     calItemUtils.jsm \</span>
<a href="#l1.5"></a><span id="l1.5">     calIteratorUtils.jsm \</span>
<a href="#l1.6"></a><span id="l1.6">     calItipUtils.jsm \</span>
<a href="#l1.7"></a><span id="l1.7">     calPrintUtils.jsm \</span>
<a href="#l1.8"></a><span id="l1.8">     calProviderUtils.jsm \</span>
<a href="#l1.9"></a><span id="l1.9">     calRecurrenceUtils.jsm \</span>
<a href="#l1.10"></a><span id="l1.10">     calUtils.jsm \</span>
<a href="#l1.11"></a><span id="l1.11">     calXMLUtils.jsm \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    ical.js \</span>
<a href="#l1.13"></a><span id="l1.13">     $(NULL)</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/calendar/base/modules/ical.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,6579 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+/**</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * This is ical.js from &lt;https://github.com/mozilla-comm/ical.js&gt;.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * If you would like to change anything in ical.js, it is required to do so</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * upstream first.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ *</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * Current ical.js git revision: b2112a5eb6fe2c311ee945150b2a267213c1f18c</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ */</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;ICAL&quot;, &quot;unwrap&quot;, &quot;unwrapSetter&quot;, &quot;unwrapSingle&quot;, &quot;wrapGetter&quot;];</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+function wrapGetter(type, val) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    return val ? new type(val) : null;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+}</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+function unwrap(type, innerFunc) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    return function(val) unwrapSetter.call(this, type, val, innerFunc);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+}</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+function unwrapSetter(type, val, innerFunc, thisObj) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    return innerFunc.call(thisObj || this, unwrapSingle(type, val));</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+}</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+function unwrapSingle(type, val) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    if (!val || !val.wrappedJSObject) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+        return null;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    } else if (val.wrappedJSObject.innerObject instanceof type) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+        return val.wrappedJSObject.innerObject;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    } else {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+        Components.utils.reportError(&quot;Unknown &quot; + (type.icalclass || type) + &quot; passed at &quot; + cal.STACK(10));</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+        return null;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    }</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+}</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+// -- start ical.js --</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+if (typeof(ICAL) === 'undefined')</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  (typeof(window) !== 'undefined') ? this.ICAL = {} : ICAL = {};</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ICAL.foldLength = 74;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+ICAL.newLineChar = '\r\n';</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+ICAL.debug = false;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+/**</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ * Helper functions used in various places within ical.js</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+ */</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+ICAL.helpers = {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  initState: function initState(aLine, aLineNr) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    return {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+      buffer: aLine,</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+      line: aLine,</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      lineNr: aLineNr,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+      character: 0,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      currentData: null,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+      parentData: []</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    };</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  },</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  initComponentData: function initComponentData(aName) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    return {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      name: aName,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      type: &quot;COMPONENT&quot;,</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      value: []</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    };</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  },</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  /**</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+   * Checks if the given number is NaN</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+   */</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  isStrictlyNaN: function(number) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    return typeof(number) === 'number' &amp;&amp; isNaN(number);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  },</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  /**</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+   * Parses a string value that is expected to be an</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+   * integer, when the valid is not an integer throws</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+   * a decoration error.</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+   *</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+   * @param {String} string raw input.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+   * @return {Number} integer.</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+   */</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  strictParseInt: function(string) {</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    var result = parseInt(string, 10);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    if (ICAL.helpers.isStrictlyNaN(result)) {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+      throw new Error(</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+        'Could not extract integer from &quot;' + string + '&quot;'</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+      );</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    }</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    return result;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+  },</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  /**</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+   * Creates or returns a class instance</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+   * of a given type with the initialization</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+   * data if the data is not already an instance</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+   * of the given type.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+   *</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+   *</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+   * Example:</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+   *</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+   *    var time = new ICAL.Time(...);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+   *    var result = ICAL.helpers.formatClassType(time, ICAL.Time);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+   *</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+   *    (result instanceof ICAL.Time)</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+   *    // =&gt; true</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+   *</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+   *    result = ICAL.helpers.formatClassType({}, ICAL.Time);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+   *    (result isntanceof ICAL.Time)</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+   *    // =&gt; true</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+   *</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+   *</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+   * @param {Object} data object initialization data.</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+   * @param {Object} type object type (like ICAL.Time).</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+   */</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  formatClassType: function formatClassType(data, type) {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    if (typeof(data) === 'undefined')</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+      return undefined;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    if (data instanceof type) {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+      return data;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    }</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    return new type(data);</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  },</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+  /**</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+   * Identical to index of but will only match values</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+   * when they are not preceded by a backslash char \\\</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+   *</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+   * @param {String} buffer string value.</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+   * @param {String} search value.</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+   * @param {Numeric} pos start position.</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+   */</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  unescapedIndexOf: function(buffer, search, pos) {</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    while ((pos = buffer.indexOf(search, pos)) !== -1) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+      if (pos &gt; 0 &amp;&amp; buffer[pos - 1] === '\\') {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+        pos += 1;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      } else {</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+        return pos;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+      }</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    }</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    return -1;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  },</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  binsearchInsert: function(list, seekVal, cmpfunc) {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    if (!list.length)</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+      return 0;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    var low = 0, high = list.length - 1,</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+        mid, cmpval;</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    while (low &lt;= high) {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+      mid = low + Math.floor((high - low) / 2);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+      cmpval = cmpfunc(seekVal, list[mid]);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+      if (cmpval &lt; 0)</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+        high = mid - 1;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+      else if (cmpval &gt; 0)</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+        low = mid + 1;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+      else</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+        break;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    }</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    if (cmpval &lt; 0)</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+      return mid; // insertion is displacing, so use mid outright.</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    else if (cmpval &gt; 0)</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+      return mid + 1;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+    else</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+      return mid;</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  },</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+  dumpn: function() {</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+    if (!ICAL.debug) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+      return null;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    }</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+    if (typeof (console) !== 'undefined' &amp;&amp; 'log' in console) {</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+      ICAL.helpers.dumpn = function consoleDumpn(input) {</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        return console.log(input);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+      }</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    } else {</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+      ICAL.helpers.dumpn = function geckoDumpn(input) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+        dump(input + '\n');</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+      }</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    }</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    return ICAL.helpers.dumpn(arguments[0]);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  },</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  mixin: function(obj, data) {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+    if (data) {</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+      for (var k in data) {</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+        obj[k] = data[k];</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+      }</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+    }</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    return obj;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  },</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+  isArray: function(o) {</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+    return o &amp;&amp; (o instanceof Array || typeof o == &quot;array&quot;);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  },</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+  clone: function(aSrc, aDeep) {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+    if (!aSrc || typeof aSrc != &quot;object&quot;) {</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+      return aSrc;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+    } else if (aSrc instanceof Date) {</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+      return new Date(aSrc.getTime());</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+    } else if (&quot;clone&quot; in aSrc) {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      return aSrc.clone();</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    } else if (ICAL.helpers.isArray(aSrc)) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      var result = [];</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+      for (var i = 0; i &lt; aSrc.length; i++) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+        result.push(aDeep ? ICAL.helpers.clone(aSrc[i], true) : aSrc[i]);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      }</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      return result;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+    } else {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+      var result = {};</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+      for (var name in aSrc) {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+        // uses prototype method to allow use of Object.create(null);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+        if (Object.prototype.hasOwnProperty.call(aSrc, name)) {</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+          if (aDeep) {</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+            result[name] = ICAL.helpers.clone(aSrc[name], true);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+          } else {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+            result[name] = aSrc[name];</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+          }</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+        }</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+      }</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+      return result;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+    }</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+  },</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  unfoldline: function unfoldline(aState) {</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    // Section 3.1</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    // if the line ends with a CRLF</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    // and the next line starts with a LINEAR WHITESPACE (space, htab, ...)</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+    // then remove the CRLF and the whitespace to unsplit the line</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+    var moreLines = true;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+    var line = &quot;&quot;;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    while (moreLines) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+      moreLines = false;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+      var pos = aState.buffer.search(/\r?\n/);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+      if (pos &gt; -1) {</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+        var len = (aState.buffer[pos] == &quot;\r&quot; ? 2 : 1);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+        var nextChar = aState.buffer.substr(pos + len, 1);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+        if (nextChar.match(/^[ \t]$/)) {</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+          moreLines = true;</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+          line += aState.buffer.substr(0, pos);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+          aState.buffer = aState.buffer.substr(pos + len + 1);</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+        } else {</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+          // We're at the end of the line, copy the found chunk</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+          line += aState.buffer.substr(0, pos);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+          aState.buffer = aState.buffer.substr(pos + len);</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+        }</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+      } else {</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+        line += aState.buffer;</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+        aState.buffer = &quot;&quot;;</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+      }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+    }</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+    return line;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+  },</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+  foldline: function foldline(aLine) {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+    var result = &quot;&quot;;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+    var line = aLine || &quot;&quot;;</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+    while (line.length) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+      result += ICAL.newLineChar + &quot; &quot; + line.substr(0, ICAL.foldLength);</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+      line = line.substr(ICAL.foldLength);</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+    }</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+    return result.substr(ICAL.newLineChar.length + 1);</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  },</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+  ensureKeyExists: function(obj, key, defvalue) {</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+    if (!(key in obj)) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+      obj[key] = defvalue;</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+    }</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+  },</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+  hasKey: function(obj, key) {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+    return (obj &amp;&amp; key in obj &amp;&amp; obj[key]);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+  },</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+  pad2: function pad(data) {</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    if (typeof(data) !== 'string') {</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      // handle fractions.</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      if (typeof(data) === 'number') {</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+        data = parseInt(data);</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+      }</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+      data = String(data);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+    var len = data.length;</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+    switch (len) {</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      case 0:</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+        return '00';</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+      case 1:</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+        return '0' + data;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+      default:</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+        return data;</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+    }</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+  },</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+  trunc: function trunc(number) {</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+    return (number &lt; 0 ? Math.ceil(number) : Math.floor(number));</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+  }</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+};</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+ICAL.design = (function() {</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+  'use strict';</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+  var ICAL_NEWLINE = /\\\\|\\;|\\,|\\[Nn]/g;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+  function DecorationError() {</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+    Error.apply(this, arguments);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+  }</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  DecorationError.prototype = {</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+    __proto__: Error.prototype</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  };</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+  function replaceNewlineReplace(string) {</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+    switch (string) {</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+      case &quot;\\\\&quot;:</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+        return &quot;\\&quot;;</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+      case &quot;\\;&quot;:</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+        return &quot;;&quot;;</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+      case &quot;\\,&quot;:</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        return &quot;,&quot;;</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+      case &quot;\\n&quot;:</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+      case &quot;\\N&quot;:</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+        return &quot;\n&quot;;</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+      default:</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+        return string;</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    }</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+  }</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+  function replaceNewline(value) {</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    // avoid regex when possible.</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+    if (value.indexOf('\\') === -1) {</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+      return value;</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+    }</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+    return value.replace(ICAL_NEWLINE, replaceNewlineReplace);</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+  }</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+  /**</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+   * Changes the format of the UNTIl part in the RECUR</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+   * value type. When no UNTIL part is found the original</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+   * is returned untouched.</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+   *</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+   * @param {String} type toICAL or fromICAL.</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+   * @param {String} aValue the value to check.</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+   * @return {String} upgraded/original value.</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+   */</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+  function recurReplaceUntil(aType, aValue) {</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+    var idx = aValue.indexOf('UNTIL=');</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+    if (idx === -1) {</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+      return aValue;</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+    }</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+    idx += 6;</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+    // everything before the value</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+    var begin = aValue.substr(0, idx);</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+    // everything after the value</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+    var end;</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+    // current until value</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    var until;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    // end of value could be -1 meaning this is the last param.</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+    var endValueIdx = aValue.indexOf(';', idx);</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    if (endValueIdx === -1) {</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+      end = '';</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+      until = aValue.substr(idx);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+    } else {</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+      end = aValue.substr(endValueIdx);</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+      until = aValue.substr(idx, endValueIdx - idx);</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+    }</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+    if (until.length &gt; 10) {</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+      until = design.value['date-time'][aType](until);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+    } else {</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+      until = design.value.date[aType](until);</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+    }</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+    return begin + until + end;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+  }</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+  /**</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+   * Design data used by the parser to decide if data is semantically correct</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+   */</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+  var design = {</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+    DecorationError: DecorationError,</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+    defaultType: 'text',</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+    param: {</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+      // Although the syntax is DQUOTE uri DQUOTE, I don't think we should</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+      // enfoce anything aside from it being a valid content line.</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+      // &quot;ALTREP&quot;: { ... },</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+      // CN just wants a param-value</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+      // &quot;CN&quot;: { ... }</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+      &quot;cutype&quot;: {</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+        values: [&quot;INDIVIDUAL&quot;, &quot;GROUP&quot;, &quot;RESOURCE&quot;, &quot;ROOM&quot;, &quot;UNKNOWN&quot;],</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+      },</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+      &quot;delegated-from&quot;: {</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+        valueType: &quot;cal-address&quot;,</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+      },</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+      &quot;delegated-to&quot;: {</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+        valueType: &quot;cal-address&quot;,</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+      },</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+      // &quot;DIR&quot;: { ... }, // See ALTREP</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+      &quot;encoding&quot;: {</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+        values: [&quot;8BIT&quot;, &quot;BASE64&quot;]</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+      },</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+      // &quot;FMTTYPE&quot;: { ... }, // See ALTREP</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+      &quot;fbtype&quot;: {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+        values: [&quot;FREE&quot;, &quot;BUSY&quot;, &quot;BUSY-UNAVAILABLE&quot;, &quot;BUSY-TENTATIVE&quot;],</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+      },</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+      // &quot;LANGUAGE&quot;: { ... }, // See ALTREP</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+      &quot;member&quot;: {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+        valueType: &quot;cal-address&quot;,</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+      },</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+      &quot;partstat&quot;: {</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+        // TODO These values are actually different per-component</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+        values: [&quot;NEEDS-ACTION&quot;, &quot;ACCEPTED&quot;, &quot;DECLINED&quot;, &quot;TENTATIVE&quot;,</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+                 &quot;DELEGATED&quot;, &quot;COMPLETED&quot;, &quot;IN-PROCESS&quot;],</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+      },</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+      &quot;range&quot;: {</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+        values: [&quot;THISLANDFUTURE&quot;]</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+      },</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+      &quot;related&quot;: {</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+        values: [&quot;START&quot;, &quot;END&quot;]</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+      },</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+      &quot;reltype&quot;: {</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+        values: [&quot;PARENT&quot;, &quot;CHILD&quot;, &quot;SIBLING&quot;],</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+      },</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+      &quot;role&quot;: {</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+        values: [&quot;REQ-PARTICIPANT&quot;, &quot;CHAIR&quot;,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+                 &quot;OPT-PARTICIPANT&quot;, &quot;NON-PARTICIPANT&quot;],</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+      },</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+      &quot;rsvp&quot;: {</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+        valueType: &quot;boolean&quot;</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+      },</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+      &quot;sent-by&quot;: {</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+        valueType: &quot;cal-address&quot;</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+      },</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+      &quot;tzid&quot;: {</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+        matches: /^\//</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+      },</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+      &quot;value&quot;: {</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+        // since the value here is a 'type' lowercase is used.</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+        values: [&quot;binary&quot;, &quot;boolean&quot;, &quot;cal-address&quot;, &quot;date&quot;, &quot;date-time&quot;,</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+                 &quot;duration&quot;, &quot;float&quot;, &quot;integer&quot;, &quot;period&quot;, &quot;recur&quot;, &quot;text&quot;,</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+                 &quot;time&quot;, &quot;uri&quot;, &quot;utc-offset&quot;],</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+        allowXName: true,</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+        allowIanaToken: true</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+      }</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+    },</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+    // When adding a value here, be sure to add it to the parameter types!</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+    value: {</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+      &quot;binary&quot;: {</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+        decorate: function(aString) {</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+          return ICAL.Binary.fromString(aString);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+        },</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+        undecorate: function(aBinary) {</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+          return aBinary.toString();</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+        }</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+      },</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+      &quot;boolean&quot;: {</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+        values: [&quot;TRUE&quot;, &quot;FALSE&quot;],</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineplus">+</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+          switch(aValue) {</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+            case 'TRUE':</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+              return true;</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+            case 'FALSE':</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+              return false;</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+            default:</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+              //TODO: parser warning</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+              return false;</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+          }</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineplus">+        },</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineplus">+</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+          if (aValue) {</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+            return 'TRUE';</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineplus">+          }</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+          return 'FALSE';</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineplus">+        }</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineplus">+      },</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+      &quot;cal-address&quot;: {</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+        // needs to be an uri</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+      },</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+      &quot;date&quot;: {</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+        decorate: function(aValue, aProp) {</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+          return ICAL.Time.fromDateString(aValue, aProp);</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+        },</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+        /**</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+         * undecorates a time object.</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+         */</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+        undecorate: function(aValue) {</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+          return aValue.toString();</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+        },</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+          // from: 20120901</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+          // to: 2012-09-01</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+          var result = aValue.substr(0, 4) + '-' +</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+                       aValue.substr(4, 2) + '-' +</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineplus">+                       aValue.substr(6, 2);</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineplus">+</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+          if (aValue[8] === 'Z') {</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+            result += 'Z';</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+          }</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineplus">+</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineplus">+          return result;</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineplus">+        },</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineplus">+</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineplus">+          // from: 2012-09-01</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+          // to: 20120901</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+          if (aValue.length &gt; 11) {</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+            //TODO: serialize warning?</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+            return aValue;</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineplus">+          }</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+          var result = aValue.substr(0, 4) +</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+                       aValue.substr(5, 2) +</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+                       aValue.substr(8, 2);</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+          if (aValue[10] === 'Z') {</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+            result += 'Z';</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+          }</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+          return result;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+        }</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineplus">+      },</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineplus">+      &quot;date-time&quot;: {</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineplus">+          // from: 20120901T130000</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineplus">+          // to: 2012-09-01T13:00:00</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+          var result = aValue.substr(0, 4) + '-' +</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineplus">+                       aValue.substr(4, 2) + '-' +</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+                       aValue.substr(6, 2) + 'T' +</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineplus">+                       aValue.substr(9, 2) + ':' +</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+                       aValue.substr(11, 2) + ':' +</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineplus">+                       aValue.substr(13, 2);</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineplus">+          if (aValue[15] === 'Z') {</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineplus">+            result += 'Z'</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+          }</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+          return result;</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+        },</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineplus">+          // from: 2012-09-01T13:00:00</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+          // to: 20120901T130000</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineplus">+</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineplus">+          if (aValue.length &lt; 19) {</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+            // TODO: error</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineplus">+            return aValue;</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineplus">+          }</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+          var result = aValue.substr(0, 4) +</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+                       aValue.substr(5, 2) +</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+                       // grab the (DDTHH) segment</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+                       aValue.substr(8, 5) +</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+                       // MM</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+                       aValue.substr(14, 2) +</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+                       // SS</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineplus">+                       aValue.substr(17, 2);</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineplus">+</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineplus">+          if (aValue[19] === 'Z') {</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+            result += 'Z';</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+          }</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+          return result;</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+        },</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineplus">+</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineplus">+        decorate: function(aValue, aProp) {</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+          return ICAL.Time.fromDateTimeString(aValue, aProp);</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+        },</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+        undecorate: function(aValue) {</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+          return aValue.toString();</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+        }</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+      },</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+      duration: {</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+        decorate: function(aValue) {</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+          return ICAL.Duration.fromString(aValue);</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+        },</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+        undecorate: function(aValue) {</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+          return aValue.toString();</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+        }</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+      },</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+      float: {</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+        matches: /^[+-]?\d+\.\d+$/,</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+        decorate: function(aValue) {</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+          return ICAL.Value.fromString(aValue, &quot;float&quot;);</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+        },</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineplus">+</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+          var parsed = parseFloat(aValue);</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineplus">+          if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineplus">+            // TODO: parser warning</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineplus">+            return 0.0;</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineplus">+          }</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+          return parsed;</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineplus">+        },</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineplus">+          return String(aValue);</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineplus">+        }</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+      },</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+      integer: {</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+          var parsed = parseInt(aValue);</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+          if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+            return 0;</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineplus">+          }</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineplus">+          return parsed;</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineplus">+        },</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+          return String(aValue);</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+        }</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+      },</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+      period: {</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+        fromICAL: function(string) {</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineplus">+          var parts = string.split('/');</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineplus">+          var result = design.value['date-time'].fromICAL(parts[0]) + '/';</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+          if (ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+            result += parts[1];</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineplus">+          } else {</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineplus">+            result += design.value['date-time'].fromICAL(parts[1]);</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+          }</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineplus">+</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+          return result;</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineplus">+        },</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineplus">+</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineplus">+        toICAL: function(string) {</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineplus">+          var parts = string.split('/');</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineplus">+          var result = design.value['date-time'].toICAL(parts[0]) + '/';</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+          if (ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineplus">+            result += parts[1];</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineplus">+          } else {</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineplus">+            result += design.value['date-time'].toICAL(parts[1]);</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineplus">+          }</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineplus">+</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+          return result;</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineplus">+        },</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineplus">+</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+        decorate: function(aValue, aProp) {</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+          return ICAL.Period.fromString(aValue, aProp);</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+        },</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+        undecorate: function(aValue) {</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+          return aValue.toString();</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineplus">+        }</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineplus">+      },</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineplus">+      recur: {</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineplus">+        fromICAL: recurReplaceUntil.bind(this, 'fromICAL'),</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineplus">+        toICAL: recurReplaceUntil.bind(this, 'toICAL'),</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+        decorate: function decorate(aValue) {</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineplus">+          return ICAL.Recur.fromString(aValue);</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineplus">+        },</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineplus">+</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineplus">+        undecorate: function(aRecur) {</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineplus">+          return aRecur.toString();</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+        }</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+      },</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineplus">+</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineplus">+      text: {</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineplus">+        matches: /.*/,</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+        fromICAL: function(aValue, aName) {</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+          return replaceNewline(aValue);</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineplus">+        },</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineplus">+</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineplus">+        toICAL: function escape(aValue, aName) {</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+          return aValue.replace(/\\|;|,|\n/g, function(str) {</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+            switch (str) {</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+            case &quot;\\&quot;:</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineplus">+              return &quot;\\\\&quot;;</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineplus">+            case &quot;;&quot;:</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+              return &quot;\\;&quot;;</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+            case &quot;,&quot;:</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineplus">+              return &quot;\\,&quot;;</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+            case &quot;\n&quot;:</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineplus">+              return &quot;\\n&quot;;</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+            default:</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+              return str;</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineplus">+            }</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineplus">+          });</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineplus">+        }</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+      },</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+      time: {</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+          // from: MMHHSS(Z)?</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+          // to: HH:MM:SS(Z)?</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+          if (aValue.length &lt; 6) {</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+            // TODO: parser exception?</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineplus">+            return aValue;</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineplus">+          }</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineplus">+</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineplus">+          // HH::MM::SSZ?</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineplus">+          var result = aValue.substr(0, 2) + ':' +</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineplus">+                       aValue.substr(2, 2) + ':' +</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineplus">+                       aValue.substr(4, 2);</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineplus">+</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineplus">+          if (aValue[6] === 'Z') {</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineplus">+            result += 'Z';</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+          }</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+          return result;</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineplus">+        },</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+          // from: HH:MM:SS(Z)?</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineplus">+          // to: MMHHSS(Z)?</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+          if (aValue.length &lt; 8) {</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineplus">+            //TODO: error</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineplus">+            return aValue;</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineplus">+          }</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineplus">+          var result = aValue.substr(0, 2) +</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineplus">+                       aValue.substr(3, 2) +</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+                       aValue.substr(6, 2);</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineplus">+</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineplus">+          if (aValue[8] === 'Z') {</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+            result += 'Z';</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineplus">+          }</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+          return result;</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineplus">+        }</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineplus">+      },</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineplus">+</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineplus">+      uri: {</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineplus">+        // TODO</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineplus">+        /* ... */</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+      },</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineplus">+</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineplus">+      &quot;utc-offset&quot;: {</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineplus">+        toICAL: function(aValue) {</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineplus">+          if (aValue.length &lt; 7) {</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineplus">+            // no seconds</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+            // -0500</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineplus">+            return aValue.substr(0, 3) +</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineplus">+                   aValue.substr(4, 2);</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineplus">+          } else {</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineplus">+            // seconds</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+            // -050000</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+            return aValue.substr(0, 3) +</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+                   aValue.substr(4, 2) +</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+                   aValue.substr(7, 2);</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineplus">+          }</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineplus">+        },</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineplus">+        fromICAL: function(aValue) {</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineplus">+          if (aValue.length &lt; 6) {</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineplus">+            // no seconds</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineplus">+            // -05:00</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineplus">+            return aValue.substr(0, 3) + ':' +</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineplus">+                   aValue.substr(3, 2);</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineplus">+          } else {</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineplus">+            // seconds</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineplus">+            // -05:00:00</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineplus">+            return aValue.substr(0, 3) + ':' +</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+                   aValue.substr(3, 2) + ':' +</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineplus">+                   aValue.substr(5, 2);</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineplus">+          }</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineplus">+        },</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineplus">+</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineplus">+        decorate: function(aValue) {</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineplus">+          return ICAL.UtcOffset.fromString(aValue);</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineplus">+        },</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineplus">+</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineplus">+        undecorate: function(aValue) {</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineplus">+          return aValue.toString();</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineplus">+        }</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineplus">+      }</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+    },</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineplus">+</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineplus">+    property: {</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineplus">+      decorate: function decorate(aData, aParent) {</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineplus">+        return new ICAL.Property(aData, aParent);</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineplus">+      },</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineplus">+      &quot;attach&quot;: {</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineplus">+        defaultType: &quot;uri&quot;</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineplus">+      },</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineplus">+      &quot;attendee&quot;: {</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+        defaultType: &quot;cal-address&quot;</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineplus">+      },</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineplus">+      &quot;categories&quot;: {</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+        defaultType: &quot;text&quot;,</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineplus">+      },</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineplus">+      &quot;completed&quot;: {</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineplus">+        defaultType: &quot;date-time&quot;</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineplus">+      },</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineplus">+      &quot;created&quot;: {</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineplus">+        defaultType: &quot;date-time&quot;</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineplus">+      },</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineplus">+      &quot;dtend&quot;: {</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineplus">+      },</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineplus">+      &quot;dtstamp&quot;: {</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineplus">+        defaultType: &quot;date-time&quot;</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineplus">+      },</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineplus">+      &quot;dtstart&quot;: {</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineplus">+      },</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineplus">+      &quot;due&quot;: {</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineplus">+      },</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineplus">+      &quot;duration&quot;: {</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+        defaultType: &quot;duration&quot;</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineplus">+      },</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineplus">+      &quot;exdate&quot;: {</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;],</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineplus">+        multiValue: ','</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineplus">+      },</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineplus">+      &quot;exrule&quot;: {</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineplus">+        defaultType: &quot;recur&quot;</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineplus">+      },</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineplus">+      &quot;freebusy&quot;: {</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineplus">+        defaultType: &quot;period&quot;,</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineplus">+      },</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineplus">+      &quot;geo&quot;: {</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineplus">+        defaultType: &quot;float&quot;,</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineplus">+        multiValue: &quot;;&quot;</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+      },</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+      /* TODO exactly 2 values */&quot;last-modified&quot;: {</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineplus">+        defaultType: &quot;date-time&quot;</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+      },</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineplus">+      &quot;organizer&quot;: {</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineplus">+        defaultType: &quot;cal-address&quot;</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineplus">+      },</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineplus">+      &quot;percent-complete&quot;: {</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineplus">+        defaultType: &quot;integer&quot;</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineplus">+      },</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineplus">+      &quot;repeat&quot;: {</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineplus">+        defaultType: &quot;integer&quot;</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineplus">+      },</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+      &quot;rdate&quot;: {</span>
<a href="#l2.902"></a><span id="l2.902" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;, &quot;period&quot;],</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineplus">+        multiValue: ',',</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineplus">+        detectType: function(string) {</span>
<a href="#l2.906"></a><span id="l2.906" class="difflineplus">+          if (string.indexOf('/') !== -1) {</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineplus">+            return 'period';</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineplus">+          }</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineplus">+          return (string.indexOf('T') === -1) ? 'date' : 'date-time';</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineplus">+        }</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineplus">+      },</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineplus">+      &quot;recurrence-id&quot;: {</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineplus">+        defaultType: &quot;date-time&quot;,</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineplus">+        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineplus">+      },</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineplus">+      &quot;resources&quot;: {</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineplus">+        defaultType: &quot;text&quot;,</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineplus">+        multiValue: &quot;,&quot;</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineplus">+      },</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineplus">+      &quot;request-status&quot;: {</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineplus">+        defaultType: &quot;text&quot;,</span>
<a href="#l2.922"></a><span id="l2.922" class="difflineplus">+        multiValue: &quot;;&quot;</span>
<a href="#l2.923"></a><span id="l2.923" class="difflineplus">+      },</span>
<a href="#l2.924"></a><span id="l2.924" class="difflineplus">+      &quot;priority&quot;: {</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineplus">+        defaultType: &quot;integer&quot;</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineplus">+      },</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineplus">+      &quot;rrule&quot;: {</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineplus">+        defaultType: &quot;recur&quot;</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineplus">+      },</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineplus">+      &quot;sequence&quot;: {</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineplus">+        defaultType: &quot;integer&quot;</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineplus">+      },</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineplus">+      &quot;trigger&quot;: {</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineplus">+        defaultType: &quot;duration&quot;,</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineplus">+        allowedTypes: [&quot;duration&quot;, &quot;date-time&quot;]</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineplus">+      },</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineplus">+      &quot;tzoffsetfrom&quot;: {</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineplus">+        defaultType: &quot;utc-offset&quot;</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineplus">+      },</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineplus">+      &quot;tzoffsetto&quot;: {</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineplus">+        defaultType: &quot;utc-offset&quot;</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineplus">+      },</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineplus">+      &quot;tzurl&quot;: {</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineplus">+        defaultType: &quot;uri&quot;</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineplus">+      },</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineplus">+      &quot;url&quot;: {</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineplus">+        defaultType: &quot;uri&quot;</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineplus">+      }</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineplus">+    },</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineplus">+</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineplus">+    component: {</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineplus">+      decorate: function decorate(aData, aParent) {</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineplus">+        return new ICAL.Component(aData, aParent);</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineplus">+      },</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineplus">+      &quot;vevent&quot;: {}</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineplus">+    }</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+  };</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineplus">+  return design;</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineplus">+}());</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineplus">+ICAL.stringify = (function() {</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineplus">+  'use strict';</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineplus">+</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+  var LINE_ENDING = '\r\n';</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+  var DEFAULT_TYPE = 'text';</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineplus">+</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineplus">+  var design = ICAL.design;</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineplus">+  var helpers = ICAL.helpers;</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineplus">+</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineplus">+  /**</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineplus">+   * Convert a full jCal Array into a ical document.</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineplus">+   *</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+   * @param {Array} jCal document.</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineplus">+   * @return {String} ical document.</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineplus">+   */</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineplus">+  function stringify(jCal) {</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineplus">+    if (!jCal[0] || jCal[0] !== 'icalendar') {</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineplus">+      throw new Error('must provide full jCal document');</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineplus">+    }</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineplus">+</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineplus">+    // 1 because we skip the initial element.</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineplus">+    var i = 1;</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineplus">+    var len = jCal.length;</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineplus">+    var result = '';</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineplus">+</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineplus">+    for (; i &lt; len; i++) {</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineplus">+      result += stringify.component(jCal[i]) + LINE_ENDING;</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineplus">+    }</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineplus">+</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineplus">+    return result;</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineplus">+  }</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineplus">+</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineplus">+  /**</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineplus">+   * Converts an jCal component array into a ICAL string.</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineplus">+   * Recursive will resolve sub-components.</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineplus">+   *</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineplus">+   * Exact component/property order is not saved all</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineplus">+   * properties will come before subcomponents.</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineplus">+   *</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineplus">+   * @param {Array} component jCal fragment of a component.</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineplus">+   */</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineplus">+  stringify.component = function(component) {</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+    var name = component[0].toUpperCase();</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+    var result = 'BEGIN:' + name + LINE_ENDING;</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+    var props = component[1];</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+    var propIdx = 0;</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+    var propLen = props.length;</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+    for (; propIdx &lt; propLen; propIdx++) {</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineplus">+      result += stringify.property(props[propIdx]) + LINE_ENDING;</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineplus">+    }</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineplus">+    var comps = component[2];</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineplus">+    var compIdx = 0;</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineplus">+    var compLen = comps.length;</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineplus">+</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineplus">+    for (; compIdx &lt; compLen; compIdx++) {</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineplus">+      result += stringify.component(comps[compIdx]) + LINE_ENDING;</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineplus">+    }</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineplus">+</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineplus">+    result += 'END:' + name;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineplus">+    return result;</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineplus">+  }</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+  /**</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+   * Converts a single property to a ICAL string.</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+   *</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+   * @param {Array} property jCal property.</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineplus">+   */</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+  stringify.property = function(property) {</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineplus">+    var name = property[0].toUpperCase();</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineplus">+    var jsName = property[0];</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineplus">+    var params = property[1];</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+    var line = name;</span>
<a href="#l2.1038"></a><span id="l2.1038" class="difflineplus">+</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineplus">+    var paramName;</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineplus">+    for (paramName in params) {</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineplus">+      if (params.hasOwnProperty(paramName)) {</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineplus">+        line += ';' + paramName.toUpperCase();</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineplus">+        line += '=' + stringify.propertyValue(params[paramName]);</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineplus">+      }</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineplus">+    }</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineplus">+</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineplus">+    // there is no value so return.</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineplus">+    if (property.length === 3) {</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineplus">+      // if no params where inserted and no value</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineplus">+      // we given we must add a blank value.</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+      if (!paramName) {</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineplus">+        line += ':';</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineplus">+      }</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineplus">+      return line;</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineplus">+    }</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineplus">+    var valueType = property[2];</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineplus">+</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineplus">+    var propDetails;</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineplus">+    var multiValue = false;</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineplus">+    var isDefault = false;</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineplus">+</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineplus">+    if (jsName in design.property) {</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineplus">+      propDetails = design.property[jsName];</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineplus">+</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineplus">+      if ('multiValue' in propDetails) {</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineplus">+        multiValue = propDetails.multiValue;</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineplus">+      }</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineplus">+</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineplus">+      if ('defaultType' in propDetails) {</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+        if (valueType === propDetails.defaultType) {</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineplus">+          isDefault = true;</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineplus">+        }</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineplus">+      } else {</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineplus">+        if (valueType === DEFAULT_TYPE) {</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineplus">+          isDefault = true;</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineplus">+        }</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineplus">+      }</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineplus">+    } else {</span>
<a href="#l2.1080"></a><span id="l2.1080" class="difflineplus">+      if (valueType === DEFAULT_TYPE) {</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineplus">+        isDefault = true;</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineplus">+      }</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineplus">+    }</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineplus">+</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineplus">+    // push the VALUE property if type is not the default</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineplus">+    // for the current property.</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineplus">+    if (!isDefault) {</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineplus">+      // value will never contain ;/:/, so we don't escape it here.</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+      line += ';VALUE=' + valueType.toUpperCase();</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineplus">+    }</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineplus">+</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineplus">+    line += ':';</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineplus">+</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineplus">+    if (multiValue) {</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineplus">+      line += stringify.multiValue(</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineplus">+        property.slice(3), multiValue, valueType</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+      );</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+    } else {</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+      line += stringify.value(property[3], valueType);</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineplus">+    }</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+    return ICAL.helpers.foldline(line);</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineplus">+  }</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineplus">+</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineplus">+  /**</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineplus">+   * Handles escaping of property values that may contain:</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineplus">+   *</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineplus">+   *    COLON (:), SEMICOLON (;), or COMMA (,)</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineplus">+   *</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineplus">+   * If any of the above are present the result is wrapped</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineplus">+   * in double quotes.</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineplus">+   *</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineplus">+   * @param {String} value raw value.</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineplus">+   * @return {String} given or escaped value when needed.</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineplus">+   */</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineplus">+  stringify.propertyValue = function(value) {</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineplus">+</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineplus">+    if ((helpers.unescapedIndexOf(value, ',') === -1) &amp;&amp;</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineplus">+        (helpers.unescapedIndexOf(value, ':') === -1) &amp;&amp;</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineplus">+        (helpers.unescapedIndexOf(value, ';') === -1)) {</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineplus">+</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineplus">+      return value;</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineplus">+    }</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineplus">+</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineplus">+    return '&quot;' + value + '&quot;';</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineplus">+  }</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineplus">+  /**</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineplus">+   * Converts an array of ical values into a single</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineplus">+   * string based on a type and a delimiter value (like &quot;,&quot;).</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+   *</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineplus">+   * @param {Array} values list of values to convert.</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineplus">+   * @param {String} delim used to join the values usually (&quot;,&quot;, &quot;;&quot;, &quot;:&quot;).</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineplus">+   * @param {String} type lowecase ical value type</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineplus">+   *  (like boolean, date-time, etc..).</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineplus">+   *</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineplus">+   * @return {String} ical string for value.</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineplus">+   */</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+  stringify.multiValue = function(values, delim, type) {</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineplus">+    var result = '';</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineplus">+    var len = values.length;</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineplus">+    var i = 0;</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+</span>
<a href="#l2.1144"></a><span id="l2.1144" class="difflineplus">+    for (; i &lt; len; i++) {</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineplus">+      result += stringify.value(values[i], type);</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineplus">+      if (i !== (len - 1)) {</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineplus">+        result += delim;</span>
<a href="#l2.1148"></a><span id="l2.1148" class="difflineplus">+      }</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineplus">+    }</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineplus">+</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineplus">+    return result;</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineplus">+  }</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineplus">+</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineplus">+  /**</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+   * Processes a single ical value runs the associated &quot;toICAL&quot;</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineplus">+   * method from the design value type if available to convert</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineplus">+   * the value.</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineplus">+   *</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineplus">+   * @param {String|Numeric} value some formatted value.</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineplus">+   * @param {String} type lowecase ical value type</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineplus">+   *  (like boolean, date-time, etc..).</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineplus">+   * @return {String} ical value for single value.</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+   */</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineplus">+  stringify.value = function(value, type) {</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineplus">+    if (type in design.value &amp;&amp; 'toICAL' in design.value[type]) {</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+      return design.value[type].toICAL(value);</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+    }</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineplus">+    return value;</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+  }</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+  return stringify;</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineplus">+</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineplus">+}());</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+ICAL.parse = (function() {</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineplus">+  'use strict';</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineplus">+</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineplus">+  var CHAR = /[^ \t]/;</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineplus">+  var MULTIVALUE_DELIMITER = ',';</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineplus">+  var VALUE_DELIMITER = ':';</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineplus">+  var PARAM_DELIMITER = ';';</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineplus">+  var PARAM_NAME_DELIMITER = '=';</span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineplus">+  var DEFAULT_TYPE = 'text';</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineplus">+</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineplus">+  var design = ICAL.design;</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineplus">+  var helpers = ICAL.helpers;</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineplus">+</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineplus">+  function ParserError(message) {</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineplus">+    this.message = message;</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineplus">+</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineplus">+    try {</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineplus">+      throw new Error();</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+      var split = e.stack.split('\n');</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineplus">+      split.shift();</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineplus">+      this.stack = split.join('\n');</span>
<a href="#l2.1197"></a><span id="l2.1197" class="difflineplus">+    }</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineplus">+  }</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineplus">+</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineplus">+  ParserError.prototype = {</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineplus">+    __proto__: Error.prototype</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineplus">+  };</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineplus">+</span>
<a href="#l2.1204"></a><span id="l2.1204" class="difflineplus">+  function parser(input) {</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineplus">+    var state = {};</span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineplus">+    var root = state.component = [</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineplus">+      'icalendar'</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineplus">+    ];</span>
<a href="#l2.1209"></a><span id="l2.1209" class="difflineplus">+</span>
<a href="#l2.1210"></a><span id="l2.1210" class="difflineplus">+    state.stack = [root];</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineplus">+</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineplus">+    parser._eachLine(input, function(err, line) {</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineplus">+      parser._handleContentLine(line, state);</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineplus">+    });</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineplus">+</span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineplus">+</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineplus">+    // when there are still items on the stack</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineplus">+    // throw a fatal error, a component was not closed</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineplus">+    // correctly in that case.</span>
<a href="#l2.1220"></a><span id="l2.1220" class="difflineplus">+    if (state.stack.length &gt; 1) {</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineplus">+      throw new ParserError(</span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineplus">+        'invalid ical body. component began but did not end'</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineplus">+      );</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineplus">+    }</span>
<a href="#l2.1225"></a><span id="l2.1225" class="difflineplus">+</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineplus">+    state = null;</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineplus">+</span>
<a href="#l2.1228"></a><span id="l2.1228" class="difflineplus">+    return root;</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineplus">+  }</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineplus">+</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineplus">+  // classes &amp; constants</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineplus">+  parser.ParserError = ParserError;</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineplus">+</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineplus">+  parser._formatName = function(name) {</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineplus">+    return name.toLowerCase();</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineplus">+  }</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineplus">+</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineplus">+  parser._handleContentLine = function(line, state) {</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineplus">+    // break up the parts of the line</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineplus">+    var valuePos = line.indexOf(VALUE_DELIMITER);</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineplus">+    var paramPos = line.indexOf(PARAM_DELIMITER);</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineplus">+</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineplus">+    var nextPos = 0;</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineplus">+    // name of property or begin/end</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineplus">+    var name;</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineplus">+    var value;</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineplus">+    var params;</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineplus">+</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineplus">+    /**</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineplus">+     * Different property cases</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineplus">+     *</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+     *</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+     * 1. RRULE:FREQ=foo</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineplus">+     *    // FREQ= is not a param but the value</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineplus">+     *</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineplus">+     * 2. ATTENDEE;ROLE=REQ-PARTICIPANT;</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineplus">+     *    // ROLE= is a param because : has not happened yet</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineplus">+     */</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineplus">+</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineplus">+    if ((paramPos !== -1 &amp;&amp; valuePos !== -1)) {</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+      // when the parameter delimiter is after the</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineplus">+      // value delimiter then its not a parameter.</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineplus">+      if (paramPos &gt; valuePos) {</span>
<a href="#l2.1264"></a><span id="l2.1264" class="difflineplus">+        paramPos = -1;</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineplus">+      }</span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineplus">+    }</span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineplus">+</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineplus">+    if (paramPos !== -1) {</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineplus">+      // when there are parameters (ATTENDEE;RSVP=TRUE;)</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineplus">+      name = parser._formatName(line.substr(0, paramPos));</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+      params = parser._parseParameters(line, paramPos);</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineplus">+      if (valuePos !== -1) {</span>
<a href="#l2.1273"></a><span id="l2.1273" class="difflineplus">+        value = line.substr(valuePos + 1);</span>
<a href="#l2.1274"></a><span id="l2.1274" class="difflineplus">+      }</span>
<a href="#l2.1275"></a><span id="l2.1275" class="difflineplus">+    } else if (valuePos !== -1) {</span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineplus">+      // without parmeters (BEGIN:VCAENDAR, CLASS:PUBLIC)</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineplus">+      name = parser._formatName(line.substr(0, valuePos));</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineplus">+      value = line.substr(valuePos + 1);</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineplus">+</span>
<a href="#l2.1280"></a><span id="l2.1280" class="difflineplus">+      if (name === 'begin') {</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineplus">+        var newComponent = [parser._formatName(value), [], []];</span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineplus">+        if (state.stack.length === 1) {</span>
<a href="#l2.1283"></a><span id="l2.1283" class="difflineplus">+          state.component.push(newComponent);</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineplus">+        } else {</span>
<a href="#l2.1285"></a><span id="l2.1285" class="difflineplus">+          state.component[2].push(newComponent);</span>
<a href="#l2.1286"></a><span id="l2.1286" class="difflineplus">+        }</span>
<a href="#l2.1287"></a><span id="l2.1287" class="difflineplus">+        state.stack.push(state.component);</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineplus">+        state.component = newComponent;</span>
<a href="#l2.1289"></a><span id="l2.1289" class="difflineplus">+        return;</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineplus">+      }</span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineplus">+</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+      if (name === 'end') {</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineplus">+        state.component = state.stack.pop();</span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineplus">+        return;</span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineplus">+      }</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineplus">+    } else {</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineplus">+      /**</span>
<a href="#l2.1298"></a><span id="l2.1298" class="difflineplus">+       * Invalid line.</span>
<a href="#l2.1299"></a><span id="l2.1299" class="difflineplus">+       * The rational to throw an error is we will</span>
<a href="#l2.1300"></a><span id="l2.1300" class="difflineplus">+       * never be certain that the rest of the file</span>
<a href="#l2.1301"></a><span id="l2.1301" class="difflineplus">+       * is sane and its unlikely that we can serialize</span>
<a href="#l2.1302"></a><span id="l2.1302" class="difflineplus">+       * the result correctly either.</span>
<a href="#l2.1303"></a><span id="l2.1303" class="difflineplus">+       */</span>
<a href="#l2.1304"></a><span id="l2.1304" class="difflineplus">+      throw new ParserError(</span>
<a href="#l2.1305"></a><span id="l2.1305" class="difflineplus">+        'invalid line (no token &quot;;&quot; or &quot;:&quot;) &quot;' + line + '&quot;'</span>
<a href="#l2.1306"></a><span id="l2.1306" class="difflineplus">+      );</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineplus">+    }</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineplus">+</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineplus">+    var valueType;</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineplus">+    var multiValue = false;</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineplus">+    var propertyDetails;</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineplus">+</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineplus">+    if (name in design.property) {</span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineplus">+      propertyDetails = design.property[name];</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineplus">+</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineplus">+      if ('multiValue' in propertyDetails) {</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineplus">+        multiValue = propertyDetails.multiValue;</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineplus">+      }</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineplus">+      if (value &amp;&amp; 'detectType' in propertyDetails) {</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineplus">+        valueType = propertyDetails.detectType(value);</span>
<a href="#l2.1322"></a><span id="l2.1322" class="difflineplus">+      }</span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineplus">+    }</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineplus">+</span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineplus">+    // at this point params is mandatory per jcal spec</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineplus">+    params = params || {};</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineplus">+</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineplus">+    // attempt to determine value</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineplus">+    if (!valueType) {</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineplus">+      if (!('value' in params)) {</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineplus">+        if (propertyDetails) {</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+          valueType = propertyDetails.defaultType;</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+        } else {</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+          valueType = DEFAULT_TYPE;</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineplus">+        }</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineplus">+      } else {</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineplus">+        // possible to avoid this?</span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineplus">+        valueType = params.value.toLowerCase();</span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineplus">+      }</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineplus">+    }</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+</span>
<a href="#l2.1342"></a><span id="l2.1342" class="difflineplus">+    delete params.value;</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineplus">+</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineplus">+    /**</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineplus">+     * Note on `var result` juggling:</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineplus">+     *</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineplus">+     * I observed that building the array in pieces has adverse</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineplus">+     * effects on performance, so where possible we inline the creation.</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineplus">+     * Its a little ugly but resulted in ~2000 additional ops/sec.</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineplus">+     */</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+    if (value) {</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+      if (multiValue) {</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineplus">+        var result = [name, params, valueType];</span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineplus">+        parser._parseMultiValue(value, multiValue, valueType, result);</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineplus">+      } else {</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineplus">+        value = parser._parseValue(value, valueType);</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineplus">+        var result = [name, params, valueType, value];</span>
<a href="#l2.1359"></a><span id="l2.1359" class="difflineplus">+      }</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineplus">+    } else {</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineplus">+      var result = [name, params, valueType];</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineplus">+    }</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineplus">+</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineplus">+    state.component[1].push(result);</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineplus">+  };</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineplus">+</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineplus">+  /**</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineplus">+   * @param {String} value original value.</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineplus">+   * @param {String} type type of value.</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineplus">+   * @return {Object} varies on type.</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineplus">+   */</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineplus">+  parser._parseValue = function(value, type) {</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineplus">+    if (type in design.value &amp;&amp; 'fromICAL' in design.value[type]) {</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineplus">+      return design.value[type].fromICAL(value);</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineplus">+    }</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineplus">+    return value;</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineplus">+  };</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineplus">+</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineplus">+  /**</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+   * Parse parameters from a string to object.</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineplus">+   *</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+   * @param {String} line a single unfolded line.</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+   * @param {Numeric} start position to start looking for properties.</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+   * @param {Numeric} maxPos position at which values start.</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+   * @return {Object} key/value pairs.</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+   */</span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineplus">+  parser._parseParameters = function(line, start) {</span>
<a href="#l2.1388"></a><span id="l2.1388" class="difflineplus">+    var lastParam = start;</span>
<a href="#l2.1389"></a><span id="l2.1389" class="difflineplus">+    var pos = 0;</span>
<a href="#l2.1390"></a><span id="l2.1390" class="difflineplus">+    var delim = PARAM_NAME_DELIMITER;</span>
<a href="#l2.1391"></a><span id="l2.1391" class="difflineplus">+    var result = {};</span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineplus">+</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineplus">+    // find the next '=' sign</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineplus">+    // use lastParam and pos to find name</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineplus">+    // check if &quot; is used if so get value from &quot;-&gt;&quot;</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+    // then increment pos to find next ;</span>
<a href="#l2.1397"></a><span id="l2.1397" class="difflineplus">+</span>
<a href="#l2.1398"></a><span id="l2.1398" class="difflineplus">+    while ((pos !== false) &amp;&amp;</span>
<a href="#l2.1399"></a><span id="l2.1399" class="difflineplus">+           (pos = helpers.unescapedIndexOf(line, delim, pos + 1)) !== -1) {</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineplus">+</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineplus">+      var name = line.substr(lastParam + 1, pos - lastParam - 1);</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineplus">+</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+      var nextChar = line[pos + 1];</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineplus">+      var substrOffset = -2;</span>
<a href="#l2.1405"></a><span id="l2.1405" class="difflineplus">+</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineplus">+      if (nextChar === '&quot;') {</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineplus">+        var valuePos = pos + 2;</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineplus">+        pos = helpers.unescapedIndexOf(line, '&quot;', valuePos);</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+        var value = line.substr(valuePos, pos - valuePos);</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineplus">+        lastParam = helpers.unescapedIndexOf(line, PARAM_DELIMITER, pos);</span>
<a href="#l2.1411"></a><span id="l2.1411" class="difflineplus">+      } else {</span>
<a href="#l2.1412"></a><span id="l2.1412" class="difflineplus">+        var valuePos = pos + 1;</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineplus">+        substrOffset = -1;</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineplus">+</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineplus">+        // move to next &quot;;&quot;</span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineplus">+        var nextPos = helpers.unescapedIndexOf(line, PARAM_DELIMITER, valuePos);</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineplus">+</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineplus">+        if (nextPos === -1) {</span>
<a href="#l2.1419"></a><span id="l2.1419" class="difflineplus">+          // when there is no &quot;;&quot; attempt to locate &quot;:&quot;</span>
<a href="#l2.1420"></a><span id="l2.1420" class="difflineplus">+          nextPos = helpers.unescapedIndexOf(line, VALUE_DELIMITER, valuePos);</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineplus">+          // no more tokens end of the line use .length</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineplus">+          if (nextPos === -1) {</span>
<a href="#l2.1423"></a><span id="l2.1423" class="difflineplus">+            nextPos = line.length;</span>
<a href="#l2.1424"></a><span id="l2.1424" class="difflineplus">+            // because we are at the end we don't need to trim</span>
<a href="#l2.1425"></a><span id="l2.1425" class="difflineplus">+            // the found value of substr offset is zero</span>
<a href="#l2.1426"></a><span id="l2.1426" class="difflineplus">+            substrOffset = 0;</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineplus">+          } else {</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineplus">+            // next token is the beginning of the value</span>
<a href="#l2.1429"></a><span id="l2.1429" class="difflineplus">+            // so we must stop looking for the '=' token.</span>
<a href="#l2.1430"></a><span id="l2.1430" class="difflineplus">+            pos = false;</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineplus">+          }</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineplus">+        } else {</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineplus">+          lastParam = nextPos;</span>
<a href="#l2.1434"></a><span id="l2.1434" class="difflineplus">+        }</span>
<a href="#l2.1435"></a><span id="l2.1435" class="difflineplus">+</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineplus">+        var value = line.substr(valuePos, nextPos - valuePos);</span>
<a href="#l2.1437"></a><span id="l2.1437" class="difflineplus">+      }</span>
<a href="#l2.1438"></a><span id="l2.1438" class="difflineplus">+</span>
<a href="#l2.1439"></a><span id="l2.1439" class="difflineplus">+      var type = DEFAULT_TYPE;</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineplus">+</span>
<a href="#l2.1441"></a><span id="l2.1441" class="difflineplus">+      if (name in design.param &amp;&amp; design.param[name].valueType) {</span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineplus">+        type = design.param[name].valueType;</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineplus">+      }</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineplus">+</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineplus">+      result[parser._formatName(name)] = parser._parseValue(value, type);</span>
<a href="#l2.1446"></a><span id="l2.1446" class="difflineplus">+    }</span>
<a href="#l2.1447"></a><span id="l2.1447" class="difflineplus">+</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineplus">+    return result;</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineplus">+  }</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineplus">+</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineplus">+  /**</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineplus">+   * Parse a multi value string</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineplus">+   */</span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineplus">+  parser._parseMultiValue = function(buffer, delim, type, result) {</span>
<a href="#l2.1455"></a><span id="l2.1455" class="difflineplus">+    var pos = 0;</span>
<a href="#l2.1456"></a><span id="l2.1456" class="difflineplus">+    var lastPos = 0;</span>
<a href="#l2.1457"></a><span id="l2.1457" class="difflineplus">+</span>
<a href="#l2.1458"></a><span id="l2.1458" class="difflineplus">+    // split each piece</span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineplus">+    while ((pos = helpers.unescapedIndexOf(buffer, delim, lastPos)) !== -1) {</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineplus">+      var value = buffer.substr(lastPos, pos - lastPos);</span>
<a href="#l2.1461"></a><span id="l2.1461" class="difflineplus">+      result.push(parser._parseValue(value, type));</span>
<a href="#l2.1462"></a><span id="l2.1462" class="difflineplus">+      lastPos = pos + 1;</span>
<a href="#l2.1463"></a><span id="l2.1463" class="difflineplus">+    }</span>
<a href="#l2.1464"></a><span id="l2.1464" class="difflineplus">+</span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineplus">+    // on the last piece take the rest of string</span>
<a href="#l2.1466"></a><span id="l2.1466" class="difflineplus">+    result.push(</span>
<a href="#l2.1467"></a><span id="l2.1467" class="difflineplus">+      parser._parseValue(buffer.substr(lastPos), type)</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineplus">+    );</span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineplus">+</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineplus">+    return result;</span>
<a href="#l2.1471"></a><span id="l2.1471" class="difflineplus">+  }</span>
<a href="#l2.1472"></a><span id="l2.1472" class="difflineplus">+</span>
<a href="#l2.1473"></a><span id="l2.1473" class="difflineplus">+  parser._eachLine = function(buffer, callback) {</span>
<a href="#l2.1474"></a><span id="l2.1474" class="difflineplus">+    var len = buffer.length;</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineplus">+    var lastPos = buffer.search(CHAR);</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineplus">+    var pos = lastPos;</span>
<a href="#l2.1477"></a><span id="l2.1477" class="difflineplus">+    var line;</span>
<a href="#l2.1478"></a><span id="l2.1478" class="difflineplus">+    var firstChar;</span>
<a href="#l2.1479"></a><span id="l2.1479" class="difflineplus">+</span>
<a href="#l2.1480"></a><span id="l2.1480" class="difflineplus">+    var newlineOffset;</span>
<a href="#l2.1481"></a><span id="l2.1481" class="difflineplus">+</span>
<a href="#l2.1482"></a><span id="l2.1482" class="difflineplus">+    do {</span>
<a href="#l2.1483"></a><span id="l2.1483" class="difflineplus">+      pos = buffer.indexOf('\n', lastPos) + 1;</span>
<a href="#l2.1484"></a><span id="l2.1484" class="difflineplus">+</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineplus">+      if (buffer[pos - 2] === '\r') {</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineplus">+        newlineOffset = 2;</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+      } else {</span>
<a href="#l2.1488"></a><span id="l2.1488" class="difflineplus">+        newlineOffset = 1;</span>
<a href="#l2.1489"></a><span id="l2.1489" class="difflineplus">+      }</span>
<a href="#l2.1490"></a><span id="l2.1490" class="difflineplus">+</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineplus">+      if (pos === 0) {</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineplus">+        pos = len;</span>
<a href="#l2.1493"></a><span id="l2.1493" class="difflineplus">+        newlineOffset = 0;</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineplus">+      }</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineplus">+</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineplus">+      firstChar = buffer[lastPos];</span>
<a href="#l2.1497"></a><span id="l2.1497" class="difflineplus">+</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineplus">+      if (firstChar === ' ' || firstChar === '\t') {</span>
<a href="#l2.1499"></a><span id="l2.1499" class="difflineplus">+        // add to line</span>
<a href="#l2.1500"></a><span id="l2.1500" class="difflineplus">+        line += buffer.substr(</span>
<a href="#l2.1501"></a><span id="l2.1501" class="difflineplus">+          lastPos + 1,</span>
<a href="#l2.1502"></a><span id="l2.1502" class="difflineplus">+          pos - lastPos - (newlineOffset + 1)</span>
<a href="#l2.1503"></a><span id="l2.1503" class="difflineplus">+        );</span>
<a href="#l2.1504"></a><span id="l2.1504" class="difflineplus">+      } else {</span>
<a href="#l2.1505"></a><span id="l2.1505" class="difflineplus">+        if (line)</span>
<a href="#l2.1506"></a><span id="l2.1506" class="difflineplus">+          callback(null, line);</span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineplus">+        // push line</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineplus">+        line = buffer.substr(</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineplus">+          lastPos,</span>
<a href="#l2.1510"></a><span id="l2.1510" class="difflineplus">+          pos - lastPos - newlineOffset</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineplus">+        );</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineplus">+      }</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineplus">+</span>
<a href="#l2.1514"></a><span id="l2.1514" class="difflineplus">+      lastPos = pos;</span>
<a href="#l2.1515"></a><span id="l2.1515" class="difflineplus">+    } while (pos !== len);</span>
<a href="#l2.1516"></a><span id="l2.1516" class="difflineplus">+</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineplus">+    // extra ending line</span>
<a href="#l2.1518"></a><span id="l2.1518" class="difflineplus">+    line = line.trim();</span>
<a href="#l2.1519"></a><span id="l2.1519" class="difflineplus">+</span>
<a href="#l2.1520"></a><span id="l2.1520" class="difflineplus">+    if (line.length)</span>
<a href="#l2.1521"></a><span id="l2.1521" class="difflineplus">+      callback(null, line);</span>
<a href="#l2.1522"></a><span id="l2.1522" class="difflineplus">+  }</span>
<a href="#l2.1523"></a><span id="l2.1523" class="difflineplus">+</span>
<a href="#l2.1524"></a><span id="l2.1524" class="difflineplus">+  return parser;</span>
<a href="#l2.1525"></a><span id="l2.1525" class="difflineplus">+</span>
<a href="#l2.1526"></a><span id="l2.1526" class="difflineplus">+}());</span>
<a href="#l2.1527"></a><span id="l2.1527" class="difflineplus">+ICAL.Component = (function() {</span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineplus">+  'use strict';</span>
<a href="#l2.1529"></a><span id="l2.1529" class="difflineplus">+</span>
<a href="#l2.1530"></a><span id="l2.1530" class="difflineplus">+  var PROPERTY_INDEX = 1;</span>
<a href="#l2.1531"></a><span id="l2.1531" class="difflineplus">+  var COMPONENT_INDEX = 2;</span>
<a href="#l2.1532"></a><span id="l2.1532" class="difflineplus">+  var NAME_INDEX = 0;</span>
<a href="#l2.1533"></a><span id="l2.1533" class="difflineplus">+</span>
<a href="#l2.1534"></a><span id="l2.1534" class="difflineplus">+  /**</span>
<a href="#l2.1535"></a><span id="l2.1535" class="difflineplus">+   * Create a wrapper for a jCal component.</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineplus">+   *</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineplus">+   * @param {Array|String} jCal</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineplus">+   *  raw jCal component data OR name of new component.</span>
<a href="#l2.1539"></a><span id="l2.1539" class="difflineplus">+   * @param {ICAL.Component} parent parent component to associate.</span>
<a href="#l2.1540"></a><span id="l2.1540" class="difflineplus">+   */</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineplus">+  function Component(jCal, parent) {</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineplus">+    if (typeof(jCal) === 'string') {</span>
<a href="#l2.1543"></a><span id="l2.1543" class="difflineplus">+      // jCal spec (name, properties, components)</span>
<a href="#l2.1544"></a><span id="l2.1544" class="difflineplus">+      jCal = [jCal, [], []];</span>
<a href="#l2.1545"></a><span id="l2.1545" class="difflineplus">+    }</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineplus">+</span>
<a href="#l2.1547"></a><span id="l2.1547" class="difflineplus">+    // mostly for legacy reasons.</span>
<a href="#l2.1548"></a><span id="l2.1548" class="difflineplus">+    this.jCal = jCal;</span>
<a href="#l2.1549"></a><span id="l2.1549" class="difflineplus">+</span>
<a href="#l2.1550"></a><span id="l2.1550" class="difflineplus">+    if (parent) {</span>
<a href="#l2.1551"></a><span id="l2.1551" class="difflineplus">+      this.parent = parent;</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineplus">+    }</span>
<a href="#l2.1553"></a><span id="l2.1553" class="difflineplus">+  }</span>
<a href="#l2.1554"></a><span id="l2.1554" class="difflineplus">+</span>
<a href="#l2.1555"></a><span id="l2.1555" class="difflineplus">+  Component.prototype = {</span>
<a href="#l2.1556"></a><span id="l2.1556" class="difflineplus">+</span>
<a href="#l2.1557"></a><span id="l2.1557" class="difflineplus">+    get name() {</span>
<a href="#l2.1558"></a><span id="l2.1558" class="difflineplus">+      return this.jCal[NAME_INDEX];</span>
<a href="#l2.1559"></a><span id="l2.1559" class="difflineplus">+    },</span>
<a href="#l2.1560"></a><span id="l2.1560" class="difflineplus">+</span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineplus">+    _hydrateComponent: function(index) {</span>
<a href="#l2.1562"></a><span id="l2.1562" class="difflineplus">+      if (!this._components) {</span>
<a href="#l2.1563"></a><span id="l2.1563" class="difflineplus">+        this._components = [];</span>
<a href="#l2.1564"></a><span id="l2.1564" class="difflineplus">+      }</span>
<a href="#l2.1565"></a><span id="l2.1565" class="difflineplus">+</span>
<a href="#l2.1566"></a><span id="l2.1566" class="difflineplus">+      if (this._components[index]) {</span>
<a href="#l2.1567"></a><span id="l2.1567" class="difflineplus">+        return this._components[index];</span>
<a href="#l2.1568"></a><span id="l2.1568" class="difflineplus">+      }</span>
<a href="#l2.1569"></a><span id="l2.1569" class="difflineplus">+</span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineplus">+      var comp = new Component(</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineplus">+        this.jCal[COMPONENT_INDEX][index],</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineplus">+        this</span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineplus">+      );</span>
<a href="#l2.1574"></a><span id="l2.1574" class="difflineplus">+</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineplus">+      return this._components[index] = comp;</span>
<a href="#l2.1576"></a><span id="l2.1576" class="difflineplus">+    },</span>
<a href="#l2.1577"></a><span id="l2.1577" class="difflineplus">+</span>
<a href="#l2.1578"></a><span id="l2.1578" class="difflineplus">+    _hydrateProperty: function(index) {</span>
<a href="#l2.1579"></a><span id="l2.1579" class="difflineplus">+      if (!this._properties) {</span>
<a href="#l2.1580"></a><span id="l2.1580" class="difflineplus">+        this._properties = [];</span>
<a href="#l2.1581"></a><span id="l2.1581" class="difflineplus">+      }</span>
<a href="#l2.1582"></a><span id="l2.1582" class="difflineplus">+</span>
<a href="#l2.1583"></a><span id="l2.1583" class="difflineplus">+      if (this._properties[index]) {</span>
<a href="#l2.1584"></a><span id="l2.1584" class="difflineplus">+        return this._properties[index];</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineplus">+      }</span>
<a href="#l2.1586"></a><span id="l2.1586" class="difflineplus">+</span>
<a href="#l2.1587"></a><span id="l2.1587" class="difflineplus">+      var prop = new ICAL.Property(</span>
<a href="#l2.1588"></a><span id="l2.1588" class="difflineplus">+        this.jCal[PROPERTY_INDEX][index],</span>
<a href="#l2.1589"></a><span id="l2.1589" class="difflineplus">+        this</span>
<a href="#l2.1590"></a><span id="l2.1590" class="difflineplus">+      );</span>
<a href="#l2.1591"></a><span id="l2.1591" class="difflineplus">+</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineplus">+      return this._properties[index] = prop;</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineplus">+    },</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineplus">+</span>
<a href="#l2.1595"></a><span id="l2.1595" class="difflineplus">+    /**</span>
<a href="#l2.1596"></a><span id="l2.1596" class="difflineplus">+     * Finds first sub component, optionally filtered by name.</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineplus">+     *</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineplus">+     * @method getFirstSubcomponent</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineplus">+     * @param {String} [name] optional name to filter by.</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineplus">+     */</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineplus">+    getFirstSubcomponent: function(name) {</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineplus">+      if (name) {</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineplus">+        var i = 0;</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineplus">+        var comps = this.jCal[COMPONENT_INDEX];</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineplus">+        var len = comps.length;</span>
<a href="#l2.1606"></a><span id="l2.1606" class="difflineplus">+</span>
<a href="#l2.1607"></a><span id="l2.1607" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.1608"></a><span id="l2.1608" class="difflineplus">+          if (comps[i][NAME_INDEX] === name) {</span>
<a href="#l2.1609"></a><span id="l2.1609" class="difflineplus">+            var result = this._hydrateComponent(i);</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineplus">+            return result;</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineplus">+          }</span>
<a href="#l2.1612"></a><span id="l2.1612" class="difflineplus">+        }</span>
<a href="#l2.1613"></a><span id="l2.1613" class="difflineplus">+      } else {</span>
<a href="#l2.1614"></a><span id="l2.1614" class="difflineplus">+        if (this.jCal[COMPONENT_INDEX].length) {</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineplus">+          return this._hydrateComponent(0);</span>
<a href="#l2.1616"></a><span id="l2.1616" class="difflineplus">+        }</span>
<a href="#l2.1617"></a><span id="l2.1617" class="difflineplus">+      }</span>
<a href="#l2.1618"></a><span id="l2.1618" class="difflineplus">+</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineplus">+      // ensure we return a value (strict mode)</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineplus">+      return null;</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineplus">+    },</span>
<a href="#l2.1622"></a><span id="l2.1622" class="difflineplus">+</span>
<a href="#l2.1623"></a><span id="l2.1623" class="difflineplus">+    /**</span>
<a href="#l2.1624"></a><span id="l2.1624" class="difflineplus">+     * Finds all sub components, optionally filtering by name.</span>
<a href="#l2.1625"></a><span id="l2.1625" class="difflineplus">+     *</span>
<a href="#l2.1626"></a><span id="l2.1626" class="difflineplus">+     * @method getAllSubcomponents</span>
<a href="#l2.1627"></a><span id="l2.1627" class="difflineplus">+     * @param {String} [name] optional name to filter by.</span>
<a href="#l2.1628"></a><span id="l2.1628" class="difflineplus">+     */</span>
<a href="#l2.1629"></a><span id="l2.1629" class="difflineplus">+    getAllSubcomponents: function(name) {</span>
<a href="#l2.1630"></a><span id="l2.1630" class="difflineplus">+      var jCalLen = this.jCal[COMPONENT_INDEX].length;</span>
<a href="#l2.1631"></a><span id="l2.1631" class="difflineplus">+</span>
<a href="#l2.1632"></a><span id="l2.1632" class="difflineplus">+      if (name) {</span>
<a href="#l2.1633"></a><span id="l2.1633" class="difflineplus">+        var comps = this.jCal[COMPONENT_INDEX];</span>
<a href="#l2.1634"></a><span id="l2.1634" class="difflineplus">+        var result = [];</span>
<a href="#l2.1635"></a><span id="l2.1635" class="difflineplus">+        var i = 0;</span>
<a href="#l2.1636"></a><span id="l2.1636" class="difflineplus">+</span>
<a href="#l2.1637"></a><span id="l2.1637" class="difflineplus">+        for (; i &lt; jCalLen; i++) {</span>
<a href="#l2.1638"></a><span id="l2.1638" class="difflineplus">+          if (name === comps[i][NAME_INDEX]) {</span>
<a href="#l2.1639"></a><span id="l2.1639" class="difflineplus">+            result.push(</span>
<a href="#l2.1640"></a><span id="l2.1640" class="difflineplus">+              this._hydrateComponent(i)</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineplus">+            );</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineplus">+          }</span>
<a href="#l2.1643"></a><span id="l2.1643" class="difflineplus">+        }</span>
<a href="#l2.1644"></a><span id="l2.1644" class="difflineplus">+        return result;</span>
<a href="#l2.1645"></a><span id="l2.1645" class="difflineplus">+      } else {</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineplus">+        if (!this._components ||</span>
<a href="#l2.1647"></a><span id="l2.1647" class="difflineplus">+            (this._components.length !== jCalLen)) {</span>
<a href="#l2.1648"></a><span id="l2.1648" class="difflineplus">+          var i = 0;</span>
<a href="#l2.1649"></a><span id="l2.1649" class="difflineplus">+          for (; i &lt; jCalLen; i++) {</span>
<a href="#l2.1650"></a><span id="l2.1650" class="difflineplus">+            this._hydrateComponent(i);</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineplus">+          }</span>
<a href="#l2.1652"></a><span id="l2.1652" class="difflineplus">+        }</span>
<a href="#l2.1653"></a><span id="l2.1653" class="difflineplus">+</span>
<a href="#l2.1654"></a><span id="l2.1654" class="difflineplus">+        return this._components;</span>
<a href="#l2.1655"></a><span id="l2.1655" class="difflineplus">+      }</span>
<a href="#l2.1656"></a><span id="l2.1656" class="difflineplus">+    },</span>
<a href="#l2.1657"></a><span id="l2.1657" class="difflineplus">+</span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineplus">+    /**</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineplus">+     * Returns true when a named property exists.</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineplus">+     *</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineplus">+     * @param {String} name property name.</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineplus">+     * @return {Boolean} true when property is found.</span>
<a href="#l2.1663"></a><span id="l2.1663" class="difflineplus">+     */</span>
<a href="#l2.1664"></a><span id="l2.1664" class="difflineplus">+    hasProperty: function(name) {</span>
<a href="#l2.1665"></a><span id="l2.1665" class="difflineplus">+      var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineplus">+      var len = props.length;</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineplus">+</span>
<a href="#l2.1668"></a><span id="l2.1668" class="difflineplus">+      var i = 0;</span>
<a href="#l2.1669"></a><span id="l2.1669" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.1670"></a><span id="l2.1670" class="difflineplus">+        // 0 is property name</span>
<a href="#l2.1671"></a><span id="l2.1671" class="difflineplus">+        if (props[i][NAME_INDEX] === name) {</span>
<a href="#l2.1672"></a><span id="l2.1672" class="difflineplus">+          return true;</span>
<a href="#l2.1673"></a><span id="l2.1673" class="difflineplus">+        }</span>
<a href="#l2.1674"></a><span id="l2.1674" class="difflineplus">+      }</span>
<a href="#l2.1675"></a><span id="l2.1675" class="difflineplus">+</span>
<a href="#l2.1676"></a><span id="l2.1676" class="difflineplus">+      return false;</span>
<a href="#l2.1677"></a><span id="l2.1677" class="difflineplus">+    },</span>
<a href="#l2.1678"></a><span id="l2.1678" class="difflineplus">+</span>
<a href="#l2.1679"></a><span id="l2.1679" class="difflineplus">+    /**</span>
<a href="#l2.1680"></a><span id="l2.1680" class="difflineplus">+     * Finds first property.</span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineplus">+     *</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineplus">+     * @param {String} [name] lowercase name of property.</span>
<a href="#l2.1683"></a><span id="l2.1683" class="difflineplus">+     * @return {ICAL.Property} found property.</span>
<a href="#l2.1684"></a><span id="l2.1684" class="difflineplus">+     */</span>
<a href="#l2.1685"></a><span id="l2.1685" class="difflineplus">+    getFirstProperty: function(name) {</span>
<a href="#l2.1686"></a><span id="l2.1686" class="difflineplus">+      if (name) {</span>
<a href="#l2.1687"></a><span id="l2.1687" class="difflineplus">+        var i = 0;</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineplus">+        var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineplus">+        var len = props.length;</span>
<a href="#l2.1690"></a><span id="l2.1690" class="difflineplus">+</span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineplus">+          if (props[i][NAME_INDEX] === name) {</span>
<a href="#l2.1693"></a><span id="l2.1693" class="difflineplus">+            var result = this._hydrateProperty(i);</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineplus">+            return result;</span>
<a href="#l2.1695"></a><span id="l2.1695" class="difflineplus">+          }</span>
<a href="#l2.1696"></a><span id="l2.1696" class="difflineplus">+        }</span>
<a href="#l2.1697"></a><span id="l2.1697" class="difflineplus">+      } else {</span>
<a href="#l2.1698"></a><span id="l2.1698" class="difflineplus">+        if (this.jCal[PROPERTY_INDEX].length) {</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineplus">+          return this._hydrateProperty(0);</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineplus">+        }</span>
<a href="#l2.1701"></a><span id="l2.1701" class="difflineplus">+      }</span>
<a href="#l2.1702"></a><span id="l2.1702" class="difflineplus">+</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineplus">+      return null;</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineplus">+    },</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineplus">+</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineplus">+    /**</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineplus">+     * Returns first properties value if available.</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineplus">+     *</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineplus">+     * @param {String} [name] (lowecase) property name.</span>
<a href="#l2.1710"></a><span id="l2.1710" class="difflineplus">+     * @return {String} property value.</span>
<a href="#l2.1711"></a><span id="l2.1711" class="difflineplus">+     */</span>
<a href="#l2.1712"></a><span id="l2.1712" class="difflineplus">+    getFirstPropertyValue: function(name) {</span>
<a href="#l2.1713"></a><span id="l2.1713" class="difflineplus">+      var prop = this.getFirstProperty(name);</span>
<a href="#l2.1714"></a><span id="l2.1714" class="difflineplus">+      if (prop) {</span>
<a href="#l2.1715"></a><span id="l2.1715" class="difflineplus">+        return prop.getFirstValue();</span>
<a href="#l2.1716"></a><span id="l2.1716" class="difflineplus">+      }</span>
<a href="#l2.1717"></a><span id="l2.1717" class="difflineplus">+</span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineplus">+      return null;</span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineplus">+    },</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineplus">+</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineplus">+    /**</span>
<a href="#l2.1722"></a><span id="l2.1722" class="difflineplus">+     * get all properties in the component.</span>
<a href="#l2.1723"></a><span id="l2.1723" class="difflineplus">+     *</span>
<a href="#l2.1724"></a><span id="l2.1724" class="difflineplus">+     * @param {String} [name] (lowercase) property name.</span>
<a href="#l2.1725"></a><span id="l2.1725" class="difflineplus">+     * @return {Array[ICAL.Property]} list of properties.</span>
<a href="#l2.1726"></a><span id="l2.1726" class="difflineplus">+     */</span>
<a href="#l2.1727"></a><span id="l2.1727" class="difflineplus">+    getAllProperties: function(name) {</span>
<a href="#l2.1728"></a><span id="l2.1728" class="difflineplus">+      var jCalLen = this.jCal[PROPERTY_INDEX].length;</span>
<a href="#l2.1729"></a><span id="l2.1729" class="difflineplus">+</span>
<a href="#l2.1730"></a><span id="l2.1730" class="difflineplus">+      if (name) {</span>
<a href="#l2.1731"></a><span id="l2.1731" class="difflineplus">+        var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l2.1732"></a><span id="l2.1732" class="difflineplus">+        var result = [];</span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineplus">+        var i = 0;</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineplus">+</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineplus">+        for (; i &lt; jCalLen; i++) {</span>
<a href="#l2.1736"></a><span id="l2.1736" class="difflineplus">+          if (name === props[i][NAME_INDEX]) {</span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineplus">+            result.push(</span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineplus">+              this._hydrateProperty(i)</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineplus">+            );</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineplus">+          }</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineplus">+        }</span>
<a href="#l2.1742"></a><span id="l2.1742" class="difflineplus">+        return result;</span>
<a href="#l2.1743"></a><span id="l2.1743" class="difflineplus">+      } else {</span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineplus">+        if (!this._properties ||</span>
<a href="#l2.1745"></a><span id="l2.1745" class="difflineplus">+            (this._properties.filter(Boolean).length !== jCalLen)) {</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineplus">+          var i = 0;</span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineplus">+          for (; i &lt; jCalLen; i++) {</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineplus">+            this._hydrateProperty(i);</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineplus">+          }</span>
<a href="#l2.1750"></a><span id="l2.1750" class="difflineplus">+        }</span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineplus">+</span>
<a href="#l2.1752"></a><span id="l2.1752" class="difflineplus">+        return this._properties;</span>
<a href="#l2.1753"></a><span id="l2.1753" class="difflineplus">+      }</span>
<a href="#l2.1754"></a><span id="l2.1754" class="difflineplus">+</span>
<a href="#l2.1755"></a><span id="l2.1755" class="difflineplus">+      return null;</span>
<a href="#l2.1756"></a><span id="l2.1756" class="difflineplus">+    },</span>
<a href="#l2.1757"></a><span id="l2.1757" class="difflineplus">+</span>
<a href="#l2.1758"></a><span id="l2.1758" class="difflineplus">+    _removeObjectByIndex: function(jCalIndex, cache, index) {</span>
<a href="#l2.1759"></a><span id="l2.1759" class="difflineplus">+      // remove cached version</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineplus">+      if (cache &amp;&amp; cache[index]) {</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineplus">+        cache.splice(index, 1);</span>
<a href="#l2.1762"></a><span id="l2.1762" class="difflineplus">+      }</span>
<a href="#l2.1763"></a><span id="l2.1763" class="difflineplus">+</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineplus">+      // remove it from the jCal</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineplus">+      this.jCal[jCalIndex].splice(index, 1);</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+    },</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineplus">+</span>
<a href="#l2.1768"></a><span id="l2.1768" class="difflineplus">+    _removeObject: function(jCalIndex, cache, nameOrObject) {</span>
<a href="#l2.1769"></a><span id="l2.1769" class="difflineplus">+      var i = 0;</span>
<a href="#l2.1770"></a><span id="l2.1770" class="difflineplus">+      var objects = this.jCal[jCalIndex];</span>
<a href="#l2.1771"></a><span id="l2.1771" class="difflineplus">+      var len = objects.length;</span>
<a href="#l2.1772"></a><span id="l2.1772" class="difflineplus">+      var cached = this[cache];</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineplus">+</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineplus">+      if (typeof(nameOrObject) === 'string') {</span>
<a href="#l2.1775"></a><span id="l2.1775" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.1776"></a><span id="l2.1776" class="difflineplus">+          if (objects[i][NAME_INDEX] === nameOrObject) {</span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineplus">+            this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineplus">+            return true;</span>
<a href="#l2.1779"></a><span id="l2.1779" class="difflineplus">+          }</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineplus">+        }</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineplus">+      } else if (cached) {</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineplus">+          if (cached[i] &amp;&amp; cached[i] === nameOrObject) {</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineplus">+            this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineplus">+            return true;</span>
<a href="#l2.1786"></a><span id="l2.1786" class="difflineplus">+          }</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineplus">+        }</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineplus">+      }</span>
<a href="#l2.1789"></a><span id="l2.1789" class="difflineplus">+</span>
<a href="#l2.1790"></a><span id="l2.1790" class="difflineplus">+      return false;</span>
<a href="#l2.1791"></a><span id="l2.1791" class="difflineplus">+    },</span>
<a href="#l2.1792"></a><span id="l2.1792" class="difflineplus">+</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineplus">+    _removeAllObjects: function(jCalIndex, cache, name) {</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineplus">+      var cached = this[cache];</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineplus">+</span>
<a href="#l2.1796"></a><span id="l2.1796" class="difflineplus">+      if (name) {</span>
<a href="#l2.1797"></a><span id="l2.1797" class="difflineplus">+        var objects = this.jCal[jCalIndex];</span>
<a href="#l2.1798"></a><span id="l2.1798" class="difflineplus">+        var i = objects.length - 1;</span>
<a href="#l2.1799"></a><span id="l2.1799" class="difflineplus">+</span>
<a href="#l2.1800"></a><span id="l2.1800" class="difflineplus">+        // descending search required because splice</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineplus">+        // is used and will effect the indices.</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineplus">+        for (; i &gt;= 0; i--) {</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineplus">+          if (objects[i][NAME_INDEX] === name) {</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineplus">+            this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineplus">+          }</span>
<a href="#l2.1806"></a><span id="l2.1806" class="difflineplus">+        }</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineplus">+      } else {</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineplus">+        if (cache in this) {</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineplus">+          // I think its probable that when we remove all</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineplus">+          // of a type we may want to add to it again so it</span>
<a href="#l2.1811"></a><span id="l2.1811" class="difflineplus">+          // makes sense to reuse the object in that case.</span>
<a href="#l2.1812"></a><span id="l2.1812" class="difflineplus">+          // For now we remove the contents of the array.</span>
<a href="#l2.1813"></a><span id="l2.1813" class="difflineplus">+          this[cache].length = 0;</span>
<a href="#l2.1814"></a><span id="l2.1814" class="difflineplus">+        }</span>
<a href="#l2.1815"></a><span id="l2.1815" class="difflineplus">+        this.jCal[jCalIndex].length = 0;</span>
<a href="#l2.1816"></a><span id="l2.1816" class="difflineplus">+      }</span>
<a href="#l2.1817"></a><span id="l2.1817" class="difflineplus">+    },</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineplus">+</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineplus">+    /**</span>
<a href="#l2.1820"></a><span id="l2.1820" class="difflineplus">+     * Adds a single sub component.</span>
<a href="#l2.1821"></a><span id="l2.1821" class="difflineplus">+     *</span>
<a href="#l2.1822"></a><span id="l2.1822" class="difflineplus">+     * @param {ICAL.Component} component to add.</span>
<a href="#l2.1823"></a><span id="l2.1823" class="difflineplus">+     */</span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineplus">+    addSubcomponent: function(component) {</span>
<a href="#l2.1825"></a><span id="l2.1825" class="difflineplus">+      if (!this._components) {</span>
<a href="#l2.1826"></a><span id="l2.1826" class="difflineplus">+        this._components = [];</span>
<a href="#l2.1827"></a><span id="l2.1827" class="difflineplus">+      }</span>
<a href="#l2.1828"></a><span id="l2.1828" class="difflineplus">+</span>
<a href="#l2.1829"></a><span id="l2.1829" class="difflineplus">+      var idx = this.jCal[COMPONENT_INDEX].push(component.jCal);</span>
<a href="#l2.1830"></a><span id="l2.1830" class="difflineplus">+      this._components[idx - 1] = component;</span>
<a href="#l2.1831"></a><span id="l2.1831" class="difflineplus">+      component.parent = this;</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineplus">+    },</span>
<a href="#l2.1833"></a><span id="l2.1833" class="difflineplus">+</span>
<a href="#l2.1834"></a><span id="l2.1834" class="difflineplus">+    /**</span>
<a href="#l2.1835"></a><span id="l2.1835" class="difflineplus">+     * Removes a single component by name or</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineplus">+     * the instance of a specific component.</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineplus">+     *</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineplus">+     * @param {ICAL.Component|String} nameOrComp comp type.</span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineplus">+     * @return {Boolean} true when comp is removed.</span>
<a href="#l2.1840"></a><span id="l2.1840" class="difflineplus">+     */</span>
<a href="#l2.1841"></a><span id="l2.1841" class="difflineplus">+    removeSubcomponent: function(nameOrComp) {</span>
<a href="#l2.1842"></a><span id="l2.1842" class="difflineplus">+      return this._removeObject(COMPONENT_INDEX, '_components', nameOrComp);</span>
<a href="#l2.1843"></a><span id="l2.1843" class="difflineplus">+    },</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineplus">+</span>
<a href="#l2.1845"></a><span id="l2.1845" class="difflineplus">+    /**</span>
<a href="#l2.1846"></a><span id="l2.1846" class="difflineplus">+     * Removes all components or (if given) all</span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineplus">+     * components by a particular name.</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineplus">+     *</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineplus">+     * @param {String} [name] (lowercase) component name.</span>
<a href="#l2.1850"></a><span id="l2.1850" class="difflineplus">+     */</span>
<a href="#l2.1851"></a><span id="l2.1851" class="difflineplus">+    removeAllSubcomponents: function(name) {</span>
<a href="#l2.1852"></a><span id="l2.1852" class="difflineplus">+      return this._removeAllObjects(COMPONENT_INDEX, '_components', name);</span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineplus">+    },</span>
<a href="#l2.1854"></a><span id="l2.1854" class="difflineplus">+</span>
<a href="#l2.1855"></a><span id="l2.1855" class="difflineplus">+    /**</span>
<a href="#l2.1856"></a><span id="l2.1856" class="difflineplus">+     * Adds a property to the component.</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineplus">+     *</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineplus">+     * @param {ICAL.Property} property object.</span>
<a href="#l2.1859"></a><span id="l2.1859" class="difflineplus">+     */</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineplus">+    addProperty: function(property) {</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineplus">+      if (!(property instanceof ICAL.Property)) {</span>
<a href="#l2.1862"></a><span id="l2.1862" class="difflineplus">+        throw new TypeError('must instance of ICAL.Property');</span>
<a href="#l2.1863"></a><span id="l2.1863" class="difflineplus">+      }</span>
<a href="#l2.1864"></a><span id="l2.1864" class="difflineplus">+</span>
<a href="#l2.1865"></a><span id="l2.1865" class="difflineplus">+      var idx = this.jCal[PROPERTY_INDEX].push(property.jCal);</span>
<a href="#l2.1866"></a><span id="l2.1866" class="difflineplus">+      property.component = this;</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineplus">+</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineplus">+      if (!this._properties) {</span>
<a href="#l2.1869"></a><span id="l2.1869" class="difflineplus">+        this._properties = [];</span>
<a href="#l2.1870"></a><span id="l2.1870" class="difflineplus">+      }</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineplus">+</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineplus">+      this._properties[idx - 1] = property;</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineplus">+    },</span>
<a href="#l2.1874"></a><span id="l2.1874" class="difflineplus">+</span>
<a href="#l2.1875"></a><span id="l2.1875" class="difflineplus">+    /**</span>
<a href="#l2.1876"></a><span id="l2.1876" class="difflineplus">+     * Helper method to add a property with a value to the component.</span>
<a href="#l2.1877"></a><span id="l2.1877" class="difflineplus">+     *</span>
<a href="#l2.1878"></a><span id="l2.1878" class="difflineplus">+     * @param {String} name property name to add.</span>
<a href="#l2.1879"></a><span id="l2.1879" class="difflineplus">+     * @param {Object} value property value.</span>
<a href="#l2.1880"></a><span id="l2.1880" class="difflineplus">+     */</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineplus">+    addPropertyWithValue: function(name, value) {</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineplus">+      var prop = new ICAL.Property(name, this);</span>
<a href="#l2.1883"></a><span id="l2.1883" class="difflineplus">+      prop.setValue(value);</span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineplus">+</span>
<a href="#l2.1885"></a><span id="l2.1885" class="difflineplus">+      this.addProperty(prop, this);</span>
<a href="#l2.1886"></a><span id="l2.1886" class="difflineplus">+</span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineplus">+      return prop;</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineplus">+    },</span>
<a href="#l2.1889"></a><span id="l2.1889" class="difflineplus">+</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineplus">+    /**</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineplus">+     * Helper method that will update or create a property</span>
<a href="#l2.1892"></a><span id="l2.1892" class="difflineplus">+     * of the given name and sets its value.</span>
<a href="#l2.1893"></a><span id="l2.1893" class="difflineplus">+     *</span>
<a href="#l2.1894"></a><span id="l2.1894" class="difflineplus">+     * @param {String} name property name.</span>
<a href="#l2.1895"></a><span id="l2.1895" class="difflineplus">+     * @param {Object} value property value.</span>
<a href="#l2.1896"></a><span id="l2.1896" class="difflineplus">+     * @return {ICAL.Property} property.</span>
<a href="#l2.1897"></a><span id="l2.1897" class="difflineplus">+     */</span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineplus">+    updatePropertyWithValue: function(name, value) {</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineplus">+      var prop = this.getFirstProperty(name);</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineplus">+</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineplus">+      if (prop) {</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineplus">+        prop.setValue(value);</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineplus">+      } else {</span>
<a href="#l2.1904"></a><span id="l2.1904" class="difflineplus">+        prop = this.addPropertyWithValue(name, value);</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineplus">+      }</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineplus">+</span>
<a href="#l2.1907"></a><span id="l2.1907" class="difflineplus">+      return prop;</span>
<a href="#l2.1908"></a><span id="l2.1908" class="difflineplus">+    },</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineplus">+</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineplus">+    /**</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineplus">+     * Removes a single property by name or</span>
<a href="#l2.1912"></a><span id="l2.1912" class="difflineplus">+     * the instance of the specific property.</span>
<a href="#l2.1913"></a><span id="l2.1913" class="difflineplus">+     *</span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineplus">+     * @param {String|ICAL.Property} nameOrProp to remove.</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineplus">+     * @return {Boolean} true when deleted.</span>
<a href="#l2.1916"></a><span id="l2.1916" class="difflineplus">+     */</span>
<a href="#l2.1917"></a><span id="l2.1917" class="difflineplus">+    removeProperty: function(nameOrProp) {</span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineplus">+      return this._removeObject(PROPERTY_INDEX, '_properties', nameOrProp);</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineplus">+    },</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineplus">+</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineplus">+    /**</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineplus">+     * Removes all properties associated with this component.</span>
<a href="#l2.1923"></a><span id="l2.1923" class="difflineplus">+     *</span>
<a href="#l2.1924"></a><span id="l2.1924" class="difflineplus">+     * @param {String} [name] (lowecase) optional property name.</span>
<a href="#l2.1925"></a><span id="l2.1925" class="difflineplus">+     */</span>
<a href="#l2.1926"></a><span id="l2.1926" class="difflineplus">+    removeAllProperties: function(name) {</span>
<a href="#l2.1927"></a><span id="l2.1927" class="difflineplus">+      return this._removeAllObjects(PROPERTY_INDEX, '_properties', name);</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineplus">+    },</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineplus">+</span>
<a href="#l2.1930"></a><span id="l2.1930" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.1931"></a><span id="l2.1931" class="difflineplus">+      return this.jCal;</span>
<a href="#l2.1932"></a><span id="l2.1932" class="difflineplus">+    },</span>
<a href="#l2.1933"></a><span id="l2.1933" class="difflineplus">+</span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineplus">+    toString: function() {</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineplus">+      return ICAL.stringify.component(</span>
<a href="#l2.1936"></a><span id="l2.1936" class="difflineplus">+        this.jCal</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineplus">+      );</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineplus">+    }</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineplus">+</span>
<a href="#l2.1940"></a><span id="l2.1940" class="difflineplus">+  };</span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineplus">+</span>
<a href="#l2.1942"></a><span id="l2.1942" class="difflineplus">+  return Component;</span>
<a href="#l2.1943"></a><span id="l2.1943" class="difflineplus">+</span>
<a href="#l2.1944"></a><span id="l2.1944" class="difflineplus">+}());</span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineplus">+ICAL.Property = (function() {</span>
<a href="#l2.1946"></a><span id="l2.1946" class="difflineplus">+  'use strict';</span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineplus">+</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineplus">+  var NAME_INDEX = 0;</span>
<a href="#l2.1949"></a><span id="l2.1949" class="difflineplus">+  var PROP_INDEX = 1;</span>
<a href="#l2.1950"></a><span id="l2.1950" class="difflineplus">+  var TYPE_INDEX = 2;</span>
<a href="#l2.1951"></a><span id="l2.1951" class="difflineplus">+  var VALUE_INDEX = 3;</span>
<a href="#l2.1952"></a><span id="l2.1952" class="difflineplus">+</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineplus">+  var design = ICAL.design;</span>
<a href="#l2.1954"></a><span id="l2.1954" class="difflineplus">+</span>
<a href="#l2.1955"></a><span id="l2.1955" class="difflineplus">+  /**</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineplus">+   * Provides a nicer interface to any kind of property.</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineplus">+   * Its important to note that mutations done in the wrapper</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineplus">+   * directly effect (mutate) the jCal object used to initialize.</span>
<a href="#l2.1959"></a><span id="l2.1959" class="difflineplus">+   *</span>
<a href="#l2.1960"></a><span id="l2.1960" class="difflineplus">+   * Can also be used to create new properties by passing</span>
<a href="#l2.1961"></a><span id="l2.1961" class="difflineplus">+   * the name of the property (as a String).</span>
<a href="#l2.1962"></a><span id="l2.1962" class="difflineplus">+   *</span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineplus">+   *</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineplus">+   * @param {Array|String} jCal raw jCal representation OR</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineplus">+   *  the new name of the property (when creating).</span>
<a href="#l2.1966"></a><span id="l2.1966" class="difflineplus">+   *</span>
<a href="#l2.1967"></a><span id="l2.1967" class="difflineplus">+   * @param {ICAL.Component} [component] parent component.</span>
<a href="#l2.1968"></a><span id="l2.1968" class="difflineplus">+   */</span>
<a href="#l2.1969"></a><span id="l2.1969" class="difflineplus">+  function Property(jCal, component) {</span>
<a href="#l2.1970"></a><span id="l2.1970" class="difflineplus">+    if (typeof(jCal) === 'string') {</span>
<a href="#l2.1971"></a><span id="l2.1971" class="difflineplus">+      // because we a creating by name we need</span>
<a href="#l2.1972"></a><span id="l2.1972" class="difflineplus">+      // to find the type when creating the property.</span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineplus">+      var name = jCal;</span>
<a href="#l2.1974"></a><span id="l2.1974" class="difflineplus">+</span>
<a href="#l2.1975"></a><span id="l2.1975" class="difflineplus">+      if (name in design.property) {</span>
<a href="#l2.1976"></a><span id="l2.1976" class="difflineplus">+        var prop = design.property[name];</span>
<a href="#l2.1977"></a><span id="l2.1977" class="difflineplus">+        if ('defaultType' in prop) {</span>
<a href="#l2.1978"></a><span id="l2.1978" class="difflineplus">+          var type = prop.defaultType;</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineplus">+        } else {</span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineplus">+          var type = design.defaultType;</span>
<a href="#l2.1981"></a><span id="l2.1981" class="difflineplus">+        }</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineplus">+      } else {</span>
<a href="#l2.1983"></a><span id="l2.1983" class="difflineplus">+        var type = design.defaultType;</span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineplus">+      }</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineplus">+</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineplus">+      jCal = [name, {}, type];</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineplus">+    }</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineplus">+</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineplus">+    this.jCal = jCal;</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineplus">+    this.component = component;</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineplus">+    this._updateType();</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineplus">+  }</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineplus">+</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineplus">+  Property.prototype = {</span>
<a href="#l2.1995"></a><span id="l2.1995" class="difflineplus">+    get type() {</span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineplus">+      return this.jCal[TYPE_INDEX];</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineplus">+    },</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+</span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineplus">+    get name() {</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineplus">+      return this.jCal[NAME_INDEX];</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineplus">+    },</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineplus">+</span>
<a href="#l2.2003"></a><span id="l2.2003" class="difflineplus">+    _updateType: function() {</span>
<a href="#l2.2004"></a><span id="l2.2004" class="difflineplus">+      if (this.type in design.value) {</span>
<a href="#l2.2005"></a><span id="l2.2005" class="difflineplus">+        var designType = design.value[this.type];</span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineplus">+</span>
<a href="#l2.2007"></a><span id="l2.2007" class="difflineplus">+        if ('decorate' in design.value[this.type]) {</span>
<a href="#l2.2008"></a><span id="l2.2008" class="difflineplus">+          this.isDecorated = true;</span>
<a href="#l2.2009"></a><span id="l2.2009" class="difflineplus">+        } else {</span>
<a href="#l2.2010"></a><span id="l2.2010" class="difflineplus">+          this.isDecorated = false;</span>
<a href="#l2.2011"></a><span id="l2.2011" class="difflineplus">+        }</span>
<a href="#l2.2012"></a><span id="l2.2012" class="difflineplus">+</span>
<a href="#l2.2013"></a><span id="l2.2013" class="difflineplus">+        if (this.name in design.property) {</span>
<a href="#l2.2014"></a><span id="l2.2014" class="difflineplus">+          if ('multiValue' in design.property[this.name]) {</span>
<a href="#l2.2015"></a><span id="l2.2015" class="difflineplus">+            this.isMultiValue = true;</span>
<a href="#l2.2016"></a><span id="l2.2016" class="difflineplus">+          } else {</span>
<a href="#l2.2017"></a><span id="l2.2017" class="difflineplus">+            this.isMultiValue = false;</span>
<a href="#l2.2018"></a><span id="l2.2018" class="difflineplus">+          }</span>
<a href="#l2.2019"></a><span id="l2.2019" class="difflineplus">+        }</span>
<a href="#l2.2020"></a><span id="l2.2020" class="difflineplus">+      }</span>
<a href="#l2.2021"></a><span id="l2.2021" class="difflineplus">+    },</span>
<a href="#l2.2022"></a><span id="l2.2022" class="difflineplus">+</span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineplus">+    /**</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineplus">+     * Hydrate a single value.</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineplus">+     */</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineplus">+    _hydrateValue: function(index) {</span>
<a href="#l2.2027"></a><span id="l2.2027" class="difflineplus">+      if (this._values &amp;&amp; this._values[index]) {</span>
<a href="#l2.2028"></a><span id="l2.2028" class="difflineplus">+        return this._values[index];</span>
<a href="#l2.2029"></a><span id="l2.2029" class="difflineplus">+      }</span>
<a href="#l2.2030"></a><span id="l2.2030" class="difflineplus">+</span>
<a href="#l2.2031"></a><span id="l2.2031" class="difflineplus">+      // for the case where there is no value.</span>
<a href="#l2.2032"></a><span id="l2.2032" class="difflineplus">+      if (this.jCal.length &lt;= (VALUE_INDEX + index)) {</span>
<a href="#l2.2033"></a><span id="l2.2033" class="difflineplus">+        return null;</span>
<a href="#l2.2034"></a><span id="l2.2034" class="difflineplus">+      }</span>
<a href="#l2.2035"></a><span id="l2.2035" class="difflineplus">+</span>
<a href="#l2.2036"></a><span id="l2.2036" class="difflineplus">+      if (this.isDecorated) {</span>
<a href="#l2.2037"></a><span id="l2.2037" class="difflineplus">+        if (!this._values) {</span>
<a href="#l2.2038"></a><span id="l2.2038" class="difflineplus">+          this._values = [];</span>
<a href="#l2.2039"></a><span id="l2.2039" class="difflineplus">+        }</span>
<a href="#l2.2040"></a><span id="l2.2040" class="difflineplus">+        return this._values[index] = this._decorate(</span>
<a href="#l2.2041"></a><span id="l2.2041" class="difflineplus">+          this.jCal[VALUE_INDEX + index]</span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineplus">+        );</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineplus">+      } else {</span>
<a href="#l2.2044"></a><span id="l2.2044" class="difflineplus">+        return this.jCal[VALUE_INDEX + index];</span>
<a href="#l2.2045"></a><span id="l2.2045" class="difflineplus">+      }</span>
<a href="#l2.2046"></a><span id="l2.2046" class="difflineplus">+    },</span>
<a href="#l2.2047"></a><span id="l2.2047" class="difflineplus">+</span>
<a href="#l2.2048"></a><span id="l2.2048" class="difflineplus">+    _decorate: function(value) {</span>
<a href="#l2.2049"></a><span id="l2.2049" class="difflineplus">+      return design.value[this.type].decorate(value, this);</span>
<a href="#l2.2050"></a><span id="l2.2050" class="difflineplus">+    },</span>
<a href="#l2.2051"></a><span id="l2.2051" class="difflineplus">+</span>
<a href="#l2.2052"></a><span id="l2.2052" class="difflineplus">+    _undecorate: function(value) {</span>
<a href="#l2.2053"></a><span id="l2.2053" class="difflineplus">+      return design.value[this.type].undecorate(value, this);</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineplus">+    },</span>
<a href="#l2.2055"></a><span id="l2.2055" class="difflineplus">+</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineplus">+    _setDecoratedValue: function(value, index) {</span>
<a href="#l2.2057"></a><span id="l2.2057" class="difflineplus">+      if (!this._values) {</span>
<a href="#l2.2058"></a><span id="l2.2058" class="difflineplus">+        this._values = [];</span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineplus">+      }</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineplus">+</span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineplus">+      if (typeof(value) === 'object' &amp;&amp; 'icaltype' in value) {</span>
<a href="#l2.2062"></a><span id="l2.2062" class="difflineplus">+        // decorated value</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineplus">+        this.jCal[VALUE_INDEX + index] = this._undecorate(value);</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineplus">+        this._values[index] = value;</span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineplus">+      } else {</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineplus">+        // undecorated value</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineplus">+        this.jCal[VALUE_INDEX + index] = value;</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineplus">+        this._values[index] = this._decorate(value);</span>
<a href="#l2.2069"></a><span id="l2.2069" class="difflineplus">+      }</span>
<a href="#l2.2070"></a><span id="l2.2070" class="difflineplus">+    },</span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineplus">+</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineplus">+    /**</span>
<a href="#l2.2073"></a><span id="l2.2073" class="difflineplus">+     * Gets a param on the property.</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineplus">+     *</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineplus">+     * @param {String} name prop name (lowercase).</span>
<a href="#l2.2076"></a><span id="l2.2076" class="difflineplus">+     * @return {String} prop value.</span>
<a href="#l2.2077"></a><span id="l2.2077" class="difflineplus">+     */</span>
<a href="#l2.2078"></a><span id="l2.2078" class="difflineplus">+    getParameter: function(name) {</span>
<a href="#l2.2079"></a><span id="l2.2079" class="difflineplus">+      return this.jCal[PROP_INDEX][name];</span>
<a href="#l2.2080"></a><span id="l2.2080" class="difflineplus">+    },</span>
<a href="#l2.2081"></a><span id="l2.2081" class="difflineplus">+</span>
<a href="#l2.2082"></a><span id="l2.2082" class="difflineplus">+    /**</span>
<a href="#l2.2083"></a><span id="l2.2083" class="difflineplus">+     * Sets a param on the property.</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineplus">+     *</span>
<a href="#l2.2085"></a><span id="l2.2085" class="difflineplus">+     * @param {String} value property value.</span>
<a href="#l2.2086"></a><span id="l2.2086" class="difflineplus">+     */</span>
<a href="#l2.2087"></a><span id="l2.2087" class="difflineplus">+    setParameter: function(name, value) {</span>
<a href="#l2.2088"></a><span id="l2.2088" class="difflineplus">+      this.jCal[PROP_INDEX][name] = value;</span>
<a href="#l2.2089"></a><span id="l2.2089" class="difflineplus">+    },</span>
<a href="#l2.2090"></a><span id="l2.2090" class="difflineplus">+</span>
<a href="#l2.2091"></a><span id="l2.2091" class="difflineplus">+    /**</span>
<a href="#l2.2092"></a><span id="l2.2092" class="difflineplus">+     * Removes a parameter</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineplus">+     *</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineplus">+     * @param {String} name prop name (lowercase).</span>
<a href="#l2.2095"></a><span id="l2.2095" class="difflineplus">+     */</span>
<a href="#l2.2096"></a><span id="l2.2096" class="difflineplus">+    removeParameter: function(name) {</span>
<a href="#l2.2097"></a><span id="l2.2097" class="difflineplus">+      return delete this.jCal[PROP_INDEX][name];</span>
<a href="#l2.2098"></a><span id="l2.2098" class="difflineplus">+    },</span>
<a href="#l2.2099"></a><span id="l2.2099" class="difflineplus">+</span>
<a href="#l2.2100"></a><span id="l2.2100" class="difflineplus">+    /**</span>
<a href="#l2.2101"></a><span id="l2.2101" class="difflineplus">+     * Sets type of property and clears out any</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineplus">+     * existing values of the current type.</span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineplus">+     *</span>
<a href="#l2.2104"></a><span id="l2.2104" class="difflineplus">+     * @param {String} type new iCAL type (see design.values).</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineplus">+     */</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineplus">+    resetType: function(type) {</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineplus">+      this.removeAllValues();</span>
<a href="#l2.2108"></a><span id="l2.2108" class="difflineplus">+      this.jCal[TYPE_INDEX] = type;</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineplus">+      this._updateType();</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineplus">+    },</span>
<a href="#l2.2111"></a><span id="l2.2111" class="difflineplus">+</span>
<a href="#l2.2112"></a><span id="l2.2112" class="difflineplus">+    /**</span>
<a href="#l2.2113"></a><span id="l2.2113" class="difflineplus">+     * Finds first property value.</span>
<a href="#l2.2114"></a><span id="l2.2114" class="difflineplus">+     *</span>
<a href="#l2.2115"></a><span id="l2.2115" class="difflineplus">+     * @return {String} first property value.</span>
<a href="#l2.2116"></a><span id="l2.2116" class="difflineplus">+     */</span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineplus">+    getFirstValue: function() {</span>
<a href="#l2.2118"></a><span id="l2.2118" class="difflineplus">+      return this._hydrateValue(0);</span>
<a href="#l2.2119"></a><span id="l2.2119" class="difflineplus">+    },</span>
<a href="#l2.2120"></a><span id="l2.2120" class="difflineplus">+</span>
<a href="#l2.2121"></a><span id="l2.2121" class="difflineplus">+    /**</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineplus">+     * Gets all values on the property.</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineplus">+     *</span>
<a href="#l2.2124"></a><span id="l2.2124" class="difflineplus">+     * NOTE: this creates an array during each call.</span>
<a href="#l2.2125"></a><span id="l2.2125" class="difflineplus">+     *</span>
<a href="#l2.2126"></a><span id="l2.2126" class="difflineplus">+     * @return {Array} list of values.</span>
<a href="#l2.2127"></a><span id="l2.2127" class="difflineplus">+     */</span>
<a href="#l2.2128"></a><span id="l2.2128" class="difflineplus">+    getValues: function() {</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineplus">+      var len = this.jCal.length - VALUE_INDEX;</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineplus">+</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineplus">+      if (len &lt; 1) {</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineplus">+        // its possible for a property to have no value.</span>
<a href="#l2.2133"></a><span id="l2.2133" class="difflineplus">+        return [];</span>
<a href="#l2.2134"></a><span id="l2.2134" class="difflineplus">+      }</span>
<a href="#l2.2135"></a><span id="l2.2135" class="difflineplus">+</span>
<a href="#l2.2136"></a><span id="l2.2136" class="difflineplus">+      var i = 0;</span>
<a href="#l2.2137"></a><span id="l2.2137" class="difflineplus">+      var result = [];</span>
<a href="#l2.2138"></a><span id="l2.2138" class="difflineplus">+</span>
<a href="#l2.2139"></a><span id="l2.2139" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineplus">+        result[i] = this._hydrateValue(i);</span>
<a href="#l2.2141"></a><span id="l2.2141" class="difflineplus">+      }</span>
<a href="#l2.2142"></a><span id="l2.2142" class="difflineplus">+</span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineplus">+      return result;</span>
<a href="#l2.2144"></a><span id="l2.2144" class="difflineplus">+    },</span>
<a href="#l2.2145"></a><span id="l2.2145" class="difflineplus">+</span>
<a href="#l2.2146"></a><span id="l2.2146" class="difflineplus">+    removeAllValues: function() {</span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineplus">+      if (this._values) {</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineplus">+        this._values.length = 0;</span>
<a href="#l2.2149"></a><span id="l2.2149" class="difflineplus">+      }</span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineplus">+      this.jCal.length = 3;</span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineplus">+    },</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineplus">+</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineplus">+    /**</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineplus">+     * Sets the values of the property.</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineplus">+     * Will overwrite the existing values.</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineplus">+     *</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineplus">+     * @param {Array} values an array of values.</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineplus">+     */</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+    setValues: function(values) {</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineplus">+      if (!this.isMultiValue) {</span>
<a href="#l2.2161"></a><span id="l2.2161" class="difflineplus">+        throw new Error(</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineplus">+          this.name + ': does not not support mulitValue.\n' +</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineplus">+          'override isMultiValue'</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineplus">+        );</span>
<a href="#l2.2165"></a><span id="l2.2165" class="difflineplus">+      }</span>
<a href="#l2.2166"></a><span id="l2.2166" class="difflineplus">+</span>
<a href="#l2.2167"></a><span id="l2.2167" class="difflineplus">+      var len = values.length;</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineplus">+      var i = 0;</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineplus">+      this.removeAllValues();</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineplus">+</span>
<a href="#l2.2171"></a><span id="l2.2171" class="difflineplus">+      if (this.isDecorated) {</span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+          this._setDecoratedValue(values[i], i);</span>
<a href="#l2.2174"></a><span id="l2.2174" class="difflineplus">+        }</span>
<a href="#l2.2175"></a><span id="l2.2175" class="difflineplus">+      } else {</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineplus">+          this.jCal[VALUE_INDEX + i] = values[i];</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineplus">+        }</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineplus">+      }</span>
<a href="#l2.2180"></a><span id="l2.2180" class="difflineplus">+    },</span>
<a href="#l2.2181"></a><span id="l2.2181" class="difflineplus">+</span>
<a href="#l2.2182"></a><span id="l2.2182" class="difflineplus">+    /**</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineplus">+     * Sets the current value of the property.</span>
<a href="#l2.2184"></a><span id="l2.2184" class="difflineplus">+     *</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineplus">+     * @param {String|Object} value new prop value.</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineplus">+     */</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineplus">+    setValue: function(value) {</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineplus">+      if (this.isDecorated) {</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+        this._setDecoratedValue(value, 0);</span>
<a href="#l2.2190"></a><span id="l2.2190" class="difflineplus">+      } else {</span>
<a href="#l2.2191"></a><span id="l2.2191" class="difflineplus">+        this.jCal[VALUE_INDEX] = value;</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineplus">+      }</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineplus">+    },</span>
<a href="#l2.2194"></a><span id="l2.2194" class="difflineplus">+</span>
<a href="#l2.2195"></a><span id="l2.2195" class="difflineplus">+    /**</span>
<a href="#l2.2196"></a><span id="l2.2196" class="difflineplus">+     * Returns the jCal representation of this property.</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineplus">+     *</span>
<a href="#l2.2198"></a><span id="l2.2198" class="difflineplus">+     * @return {Object} jCal.</span>
<a href="#l2.2199"></a><span id="l2.2199" class="difflineplus">+     */</span>
<a href="#l2.2200"></a><span id="l2.2200" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineplus">+      return this.jCal;</span>
<a href="#l2.2202"></a><span id="l2.2202" class="difflineplus">+    },</span>
<a href="#l2.2203"></a><span id="l2.2203" class="difflineplus">+</span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineplus">+    toICAL: function() {</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineplus">+      return ICAL.stringify.property(</span>
<a href="#l2.2206"></a><span id="l2.2206" class="difflineplus">+        this.jCal</span>
<a href="#l2.2207"></a><span id="l2.2207" class="difflineplus">+      );</span>
<a href="#l2.2208"></a><span id="l2.2208" class="difflineplus">+    }</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineplus">+</span>
<a href="#l2.2210"></a><span id="l2.2210" class="difflineplus">+  };</span>
<a href="#l2.2211"></a><span id="l2.2211" class="difflineplus">+</span>
<a href="#l2.2212"></a><span id="l2.2212" class="difflineplus">+  return Property;</span>
<a href="#l2.2213"></a><span id="l2.2213" class="difflineplus">+</span>
<a href="#l2.2214"></a><span id="l2.2214" class="difflineplus">+}());</span>
<a href="#l2.2215"></a><span id="l2.2215" class="difflineplus">+ICAL.UtcOffset = (function() {</span>
<a href="#l2.2216"></a><span id="l2.2216" class="difflineplus">+</span>
<a href="#l2.2217"></a><span id="l2.2217" class="difflineplus">+  function UtcOffset(aData) {</span>
<a href="#l2.2218"></a><span id="l2.2218" class="difflineplus">+    this.hours = aData.hours;</span>
<a href="#l2.2219"></a><span id="l2.2219" class="difflineplus">+    this.minutes = aData.minutes;</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineplus">+    this.factor = aData.factor;</span>
<a href="#l2.2221"></a><span id="l2.2221" class="difflineplus">+  };</span>
<a href="#l2.2222"></a><span id="l2.2222" class="difflineplus">+</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineplus">+  UtcOffset.prototype = {</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineplus">+</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineplus">+    hours: null,</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineplus">+    minutes: null,</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineplus">+    factor: null,</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineplus">+</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineplus">+    icaltype: &quot;utc-offset&quot;,</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineplus">+</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineplus">+    toString: function toString() {</span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineplus">+      return (this.factor == 1 ? &quot;+&quot; : &quot;-&quot;) +</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineplus">+              ICAL.helpers.pad2(this.hours) + ':' +</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineplus">+              ICAL.helpers.pad2(this.minutes);</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineplus">+    }</span>
<a href="#l2.2236"></a><span id="l2.2236" class="difflineplus">+  };</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineplus">+</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineplus">+  UtcOffset.fromString = function(aString) {</span>
<a href="#l2.2239"></a><span id="l2.2239" class="difflineplus">+    // -05:00</span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineplus">+    var options = {};</span>
<a href="#l2.2241"></a><span id="l2.2241" class="difflineplus">+    //TODO: support seconds per rfc5545 ?</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineplus">+    options.factor = (aString[0] === '+') ? 1 : -1;</span>
<a href="#l2.2243"></a><span id="l2.2243" class="difflineplus">+    options.hours = ICAL.helpers.strictParseInt(aString.substr(1, 2));</span>
<a href="#l2.2244"></a><span id="l2.2244" class="difflineplus">+    options.minutes = ICAL.helpers.strictParseInt(aString.substr(4, 2));</span>
<a href="#l2.2245"></a><span id="l2.2245" class="difflineplus">+</span>
<a href="#l2.2246"></a><span id="l2.2246" class="difflineplus">+    return new ICAL.UtcOffset(options);</span>
<a href="#l2.2247"></a><span id="l2.2247" class="difflineplus">+  };</span>
<a href="#l2.2248"></a><span id="l2.2248" class="difflineplus">+</span>
<a href="#l2.2249"></a><span id="l2.2249" class="difflineplus">+</span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineplus">+  return UtcOffset;</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineplus">+</span>
<a href="#l2.2252"></a><span id="l2.2252" class="difflineplus">+}());</span>
<a href="#l2.2253"></a><span id="l2.2253" class="difflineplus">+ICAL.Binary = (function() {</span>
<a href="#l2.2254"></a><span id="l2.2254" class="difflineplus">+</span>
<a href="#l2.2255"></a><span id="l2.2255" class="difflineplus">+  function Binary(aValue) {</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineplus">+    this.value = aValue;</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineplus">+  };</span>
<a href="#l2.2258"></a><span id="l2.2258" class="difflineplus">+</span>
<a href="#l2.2259"></a><span id="l2.2259" class="difflineplus">+  Binary.prototype = {</span>
<a href="#l2.2260"></a><span id="l2.2260" class="difflineplus">+    icaltype: &quot;binary&quot;,</span>
<a href="#l2.2261"></a><span id="l2.2261" class="difflineplus">+</span>
<a href="#l2.2262"></a><span id="l2.2262" class="difflineplus">+    decodeValue: function decodeValue() {</span>
<a href="#l2.2263"></a><span id="l2.2263" class="difflineplus">+      return this._b64_decode(this.value);</span>
<a href="#l2.2264"></a><span id="l2.2264" class="difflineplus">+    },</span>
<a href="#l2.2265"></a><span id="l2.2265" class="difflineplus">+</span>
<a href="#l2.2266"></a><span id="l2.2266" class="difflineplus">+    setEncodedValue: function setEncodedValue(val) {</span>
<a href="#l2.2267"></a><span id="l2.2267" class="difflineplus">+      this.value = this._b64_encode(val);</span>
<a href="#l2.2268"></a><span id="l2.2268" class="difflineplus">+    },</span>
<a href="#l2.2269"></a><span id="l2.2269" class="difflineplus">+</span>
<a href="#l2.2270"></a><span id="l2.2270" class="difflineplus">+    _b64_encode: function base64_encode(data) {</span>
<a href="#l2.2271"></a><span id="l2.2271" class="difflineplus">+      // http://kevin.vanzonneveld.net</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineplus">+      // +   original by: Tyler Akins (http://rumkin.com)</span>
<a href="#l2.2273"></a><span id="l2.2273" class="difflineplus">+      // +   improved by: Bayron Guevara</span>
<a href="#l2.2274"></a><span id="l2.2274" class="difflineplus">+      // +   improved by: Thunder.m</span>
<a href="#l2.2275"></a><span id="l2.2275" class="difflineplus">+      // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l2.2276"></a><span id="l2.2276" class="difflineplus">+      // +   bugfixed by: Pellentesque Malesuada</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineplus">+      // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l2.2278"></a><span id="l2.2278" class="difflineplus">+      // +   improved by: Rafał Kukawski (http://kukawski.pl)</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineplus">+      // *     example 1: base64_encode('Kevin van Zonneveld');</span>
<a href="#l2.2280"></a><span id="l2.2280" class="difflineplus">+      // *     returns 1: 'S2V2aW4gdmFuIFpvbm5ldmVsZA=='</span>
<a href="#l2.2281"></a><span id="l2.2281" class="difflineplus">+      // mozilla has this native</span>
<a href="#l2.2282"></a><span id="l2.2282" class="difflineplus">+      // - but breaks in 2.0.0.12!</span>
<a href="#l2.2283"></a><span id="l2.2283" class="difflineplus">+      //if (typeof this.window['atob'] == 'function') {</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineplus">+      //    return atob(data);</span>
<a href="#l2.2285"></a><span id="l2.2285" class="difflineplus">+      //}</span>
<a href="#l2.2286"></a><span id="l2.2286" class="difflineplus">+      var b64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot; +</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineplus">+                &quot;abcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineplus">+      var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,</span>
<a href="#l2.2289"></a><span id="l2.2289" class="difflineplus">+        ac = 0,</span>
<a href="#l2.2290"></a><span id="l2.2290" class="difflineplus">+        enc = &quot;&quot;,</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineplus">+        tmp_arr = [];</span>
<a href="#l2.2292"></a><span id="l2.2292" class="difflineplus">+</span>
<a href="#l2.2293"></a><span id="l2.2293" class="difflineplus">+      if (!data) {</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineplus">+        return data;</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineplus">+      }</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineplus">+</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineplus">+      do { // pack three octets into four hexets</span>
<a href="#l2.2298"></a><span id="l2.2298" class="difflineplus">+        o1 = data.charCodeAt(i++);</span>
<a href="#l2.2299"></a><span id="l2.2299" class="difflineplus">+        o2 = data.charCodeAt(i++);</span>
<a href="#l2.2300"></a><span id="l2.2300" class="difflineplus">+        o3 = data.charCodeAt(i++);</span>
<a href="#l2.2301"></a><span id="l2.2301" class="difflineplus">+</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineplus">+        bits = o1 &lt;&lt; 16 | o2 &lt;&lt; 8 | o3;</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineplus">+</span>
<a href="#l2.2304"></a><span id="l2.2304" class="difflineplus">+        h1 = bits &gt;&gt; 18 &amp; 0x3f;</span>
<a href="#l2.2305"></a><span id="l2.2305" class="difflineplus">+        h2 = bits &gt;&gt; 12 &amp; 0x3f;</span>
<a href="#l2.2306"></a><span id="l2.2306" class="difflineplus">+        h3 = bits &gt;&gt; 6 &amp; 0x3f;</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineplus">+        h4 = bits &amp; 0x3f;</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineplus">+</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineplus">+        // use hexets to index into b64, and append result to encoded string</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineplus">+        tmp_arr[ac++] = b64.charAt(h1) + b64.charAt(h2) + b64.charAt(h3) + b64.charAt(h4);</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineplus">+      } while (i &lt; data.length);</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineplus">+</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineplus">+      enc = tmp_arr.join('');</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineplus">+</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineplus">+      var r = data.length % 3;</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineplus">+</span>
<a href="#l2.2317"></a><span id="l2.2317" class="difflineplus">+      return (r ? enc.slice(0, r - 3) : enc) + '==='.slice(r || 3);</span>
<a href="#l2.2318"></a><span id="l2.2318" class="difflineplus">+</span>
<a href="#l2.2319"></a><span id="l2.2319" class="difflineplus">+    },</span>
<a href="#l2.2320"></a><span id="l2.2320" class="difflineplus">+</span>
<a href="#l2.2321"></a><span id="l2.2321" class="difflineplus">+    _b64_decode: function base64_decode(data) {</span>
<a href="#l2.2322"></a><span id="l2.2322" class="difflineplus">+      // http://kevin.vanzonneveld.net</span>
<a href="#l2.2323"></a><span id="l2.2323" class="difflineplus">+      // +   original by: Tyler Akins (http://rumkin.com)</span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineplus">+      // +   improved by: Thunder.m</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineplus">+      // +      input by: Aman Gupta</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineplus">+      // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l2.2327"></a><span id="l2.2327" class="difflineplus">+      // +   bugfixed by: Onno Marsman</span>
<a href="#l2.2328"></a><span id="l2.2328" class="difflineplus">+      // +   bugfixed by: Pellentesque Malesuada</span>
<a href="#l2.2329"></a><span id="l2.2329" class="difflineplus">+      // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineplus">+      // +      input by: Brett Zamir (http://brett-zamir.me)</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineplus">+      // +   bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineplus">+      // *     example 1: base64_decode('S2V2aW4gdmFuIFpvbm5ldmVsZA==');</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineplus">+      // *     returns 1: 'Kevin van Zonneveld'</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineplus">+      // mozilla has this native</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineplus">+      // - but breaks in 2.0.0.12!</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineplus">+      //if (typeof this.window['btoa'] == 'function') {</span>
<a href="#l2.2337"></a><span id="l2.2337" class="difflineplus">+      //    return btoa(data);</span>
<a href="#l2.2338"></a><span id="l2.2338" class="difflineplus">+      //}</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineplus">+      var b64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot; +</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineplus">+                &quot;abcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineplus">+      var o1, o2, o3, h1, h2, h3, h4, bits, i = 0,</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineplus">+        ac = 0,</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineplus">+        dec = &quot;&quot;,</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineplus">+        tmp_arr = [];</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineplus">+</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+      if (!data) {</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineplus">+        return data;</span>
<a href="#l2.2348"></a><span id="l2.2348" class="difflineplus">+      }</span>
<a href="#l2.2349"></a><span id="l2.2349" class="difflineplus">+</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineplus">+      data += '';</span>
<a href="#l2.2351"></a><span id="l2.2351" class="difflineplus">+</span>
<a href="#l2.2352"></a><span id="l2.2352" class="difflineplus">+      do { // unpack four hexets into three octets using index points in b64</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineplus">+        h1 = b64.indexOf(data.charAt(i++));</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineplus">+        h2 = b64.indexOf(data.charAt(i++));</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineplus">+        h3 = b64.indexOf(data.charAt(i++));</span>
<a href="#l2.2356"></a><span id="l2.2356" class="difflineplus">+        h4 = b64.indexOf(data.charAt(i++));</span>
<a href="#l2.2357"></a><span id="l2.2357" class="difflineplus">+</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineplus">+        bits = h1 &lt;&lt; 18 | h2 &lt;&lt; 12 | h3 &lt;&lt; 6 | h4;</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineplus">+</span>
<a href="#l2.2360"></a><span id="l2.2360" class="difflineplus">+        o1 = bits &gt;&gt; 16 &amp; 0xff;</span>
<a href="#l2.2361"></a><span id="l2.2361" class="difflineplus">+        o2 = bits &gt;&gt; 8 &amp; 0xff;</span>
<a href="#l2.2362"></a><span id="l2.2362" class="difflineplus">+        o3 = bits &amp; 0xff;</span>
<a href="#l2.2363"></a><span id="l2.2363" class="difflineplus">+</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineplus">+        if (h3 == 64) {</span>
<a href="#l2.2365"></a><span id="l2.2365" class="difflineplus">+          tmp_arr[ac++] = String.fromCharCode(o1);</span>
<a href="#l2.2366"></a><span id="l2.2366" class="difflineplus">+        } else if (h4 == 64) {</span>
<a href="#l2.2367"></a><span id="l2.2367" class="difflineplus">+          tmp_arr[ac++] = String.fromCharCode(o1, o2);</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineplus">+        } else {</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineplus">+          tmp_arr[ac++] = String.fromCharCode(o1, o2, o3);</span>
<a href="#l2.2370"></a><span id="l2.2370" class="difflineplus">+        }</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineplus">+      } while (i &lt; data.length);</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineplus">+</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineplus">+      dec = tmp_arr.join('');</span>
<a href="#l2.2374"></a><span id="l2.2374" class="difflineplus">+</span>
<a href="#l2.2375"></a><span id="l2.2375" class="difflineplus">+      return dec;</span>
<a href="#l2.2376"></a><span id="l2.2376" class="difflineplus">+    },</span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineplus">+</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineplus">+    toString: function() {</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineplus">+      return this.value;</span>
<a href="#l2.2380"></a><span id="l2.2380" class="difflineplus">+    }</span>
<a href="#l2.2381"></a><span id="l2.2381" class="difflineplus">+  };</span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineplus">+</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineplus">+  Binary.fromString = function(aString) {</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineplus">+    return new Binary(aString);</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineplus">+  }</span>
<a href="#l2.2386"></a><span id="l2.2386" class="difflineplus">+</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineplus">+  return Binary;</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineplus">+</span>
<a href="#l2.2389"></a><span id="l2.2389" class="difflineplus">+}());</span>
<a href="#l2.2390"></a><span id="l2.2390" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.2391"></a><span id="l2.2391" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.2394"></a><span id="l2.2394" class="difflineplus">+</span>
<a href="#l2.2395"></a><span id="l2.2395" class="difflineplus">+</span>
<a href="#l2.2396"></a><span id="l2.2396" class="difflineplus">+</span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.2398"></a><span id="l2.2398" class="difflineplus">+(function() {</span>
<a href="#l2.2399"></a><span id="l2.2399" class="difflineplus">+  ICAL.Period = function icalperiod(aData) {</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l2.2401"></a><span id="l2.2401" class="difflineplus">+</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineplus">+    if (aData &amp;&amp; 'start' in aData) {</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineplus">+      if (aData.start &amp;&amp; !(aData.start instanceof ICAL.Time)) {</span>
<a href="#l2.2404"></a><span id="l2.2404" class="difflineplus">+        throw new TypeError('.start must be an instance of ICAL.Time');</span>
<a href="#l2.2405"></a><span id="l2.2405" class="difflineplus">+      }</span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineplus">+      this.start = aData.start;</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineplus">+    }</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineplus">+</span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineplus">+    if (aData &amp;&amp; 'end' in aData) {</span>
<a href="#l2.2410"></a><span id="l2.2410" class="difflineplus">+      if (aData.end &amp;&amp; !(aData.end instanceof ICAL.Time)) {</span>
<a href="#l2.2411"></a><span id="l2.2411" class="difflineplus">+        throw new TypeError('.end must be an instance of ICAL.Time');</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineplus">+      }</span>
<a href="#l2.2413"></a><span id="l2.2413" class="difflineplus">+      this.end = aData.end;</span>
<a href="#l2.2414"></a><span id="l2.2414" class="difflineplus">+    }</span>
<a href="#l2.2415"></a><span id="l2.2415" class="difflineplus">+</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineplus">+    if (aData &amp;&amp; 'duration' in aData) {</span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineplus">+      if (aData.duration &amp;&amp; !(aData.duration instanceof ICAL.Duration)) {</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineplus">+        throw new TypeError('.duration must be an instance of ICAL.Duration');</span>
<a href="#l2.2419"></a><span id="l2.2419" class="difflineplus">+      }</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineplus">+      this.duration = aData.duration;</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineplus">+    }</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineplus">+  };</span>
<a href="#l2.2423"></a><span id="l2.2423" class="difflineplus">+</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineplus">+  ICAL.Period.prototype = {</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineplus">+</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineplus">+    start: null,</span>
<a href="#l2.2427"></a><span id="l2.2427" class="difflineplus">+    end: null,</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineplus">+    duration: null,</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineplus">+    icalclass: &quot;icalperiod&quot;,</span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineplus">+    icaltype: &quot;period&quot;,</span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineplus">+</span>
<a href="#l2.2432"></a><span id="l2.2432" class="difflineplus">+    getDuration: function duration() {</span>
<a href="#l2.2433"></a><span id="l2.2433" class="difflineplus">+      if (this.duration) {</span>
<a href="#l2.2434"></a><span id="l2.2434" class="difflineplus">+        return this.duration;</span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineplus">+      } else {</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineplus">+        return this.end.subtractDate(this.start);</span>
<a href="#l2.2437"></a><span id="l2.2437" class="difflineplus">+      }</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineplus">+    },</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineplus">+</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineplus">+    getEnd: function() {</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineplus">+      if (this.end) {</span>
<a href="#l2.2442"></a><span id="l2.2442" class="difflineplus">+        return this.end;</span>
<a href="#l2.2443"></a><span id="l2.2443" class="difflineplus">+      } else {</span>
<a href="#l2.2444"></a><span id="l2.2444" class="difflineplus">+        var end = this.start.clone();</span>
<a href="#l2.2445"></a><span id="l2.2445" class="difflineplus">+        end.addDuration(this.duration);</span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineplus">+        return end;</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineplus">+      }</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineplus">+    },</span>
<a href="#l2.2449"></a><span id="l2.2449" class="difflineplus">+</span>
<a href="#l2.2450"></a><span id="l2.2450" class="difflineplus">+    toString: function toString() {</span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineplus">+      return this.start + &quot;/&quot; + (this.end || this.duration);</span>
<a href="#l2.2452"></a><span id="l2.2452" class="difflineplus">+    },</span>
<a href="#l2.2453"></a><span id="l2.2453" class="difflineplus">+</span>
<a href="#l2.2454"></a><span id="l2.2454" class="difflineplus">+    toICALString: function() {</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineplus">+      return this.start.toICALString() + &quot;/&quot; +</span>
<a href="#l2.2456"></a><span id="l2.2456" class="difflineplus">+             (this.end || this.duration).toICALString();</span>
<a href="#l2.2457"></a><span id="l2.2457" class="difflineplus">+    }</span>
<a href="#l2.2458"></a><span id="l2.2458" class="difflineplus">+  };</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineplus">+</span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineplus">+  ICAL.Period.fromString = function fromString(str, prop) {</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineplus">+    var parts = str.split('/');</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineplus">+</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineplus">+    if (parts.length !== 2) {</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineplus">+      throw new Error(</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineplus">+        'Invalid string value: &quot;' + str + '&quot; must contain a &quot;/&quot; char.'</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineplus">+      );</span>
<a href="#l2.2467"></a><span id="l2.2467" class="difflineplus">+    }</span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineplus">+</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineplus">+    var options = {</span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineplus">+      start: ICAL.Time.fromDateTimeString(parts[0], prop)</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineplus">+    };</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineplus">+</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineplus">+    var end = parts[1];</span>
<a href="#l2.2474"></a><span id="l2.2474" class="difflineplus">+</span>
<a href="#l2.2475"></a><span id="l2.2475" class="difflineplus">+    if (ICAL.Duration.isValueString(end)) {</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineplus">+      options.duration = ICAL.Duration.fromString(end);</span>
<a href="#l2.2477"></a><span id="l2.2477" class="difflineplus">+    } else {</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineplus">+      options.end = ICAL.Time.fromDateTimeString(end, prop);</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineplus">+    }</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineplus">+</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineplus">+    return new ICAL.Period(options);</span>
<a href="#l2.2482"></a><span id="l2.2482" class="difflineplus">+  };</span>
<a href="#l2.2483"></a><span id="l2.2483" class="difflineplus">+</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineplus">+  ICAL.Period.fromData = function fromData(aData) {</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineplus">+    return new ICAL.Period(aData);</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineplus">+  };</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineplus">+</span>
<a href="#l2.2488"></a><span id="l2.2488" class="difflineplus">+})();</span>
<a href="#l2.2489"></a><span id="l2.2489" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.2493"></a><span id="l2.2493" class="difflineplus">+</span>
<a href="#l2.2494"></a><span id="l2.2494" class="difflineplus">+</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineplus">+</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.2497"></a><span id="l2.2497" class="difflineplus">+(function() {</span>
<a href="#l2.2498"></a><span id="l2.2498" class="difflineplus">+  var DURATION_LETTERS = /([PDWHMTS]{1,1})/;</span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineplus">+</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineplus">+  ICAL.Duration = function icalduration(data) {</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l2.2502"></a><span id="l2.2502" class="difflineplus">+    this.fromData(data);</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineplus">+  };</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineplus">+</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineplus">+  ICAL.Duration.prototype = {</span>
<a href="#l2.2506"></a><span id="l2.2506" class="difflineplus">+</span>
<a href="#l2.2507"></a><span id="l2.2507" class="difflineplus">+    weeks: 0,</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineplus">+    days: 0,</span>
<a href="#l2.2509"></a><span id="l2.2509" class="difflineplus">+    hours: 0,</span>
<a href="#l2.2510"></a><span id="l2.2510" class="difflineplus">+    minutes: 0,</span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineplus">+    seconds: 0,</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineplus">+    isNegative: false,</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineplus">+    icalclass: &quot;icalduration&quot;,</span>
<a href="#l2.2514"></a><span id="l2.2514" class="difflineplus">+    icaltype: &quot;duration&quot;,</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineplus">+</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineplus">+    clone: function clone() {</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineplus">+      return ICAL.Duration.fromData(this);</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineplus">+    },</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineplus">+</span>
<a href="#l2.2520"></a><span id="l2.2520" class="difflineplus">+    toSeconds: function toSeconds() {</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineplus">+      var seconds = this.seconds + 60 * this.minutes + 3600 * this.hours +</span>
<a href="#l2.2522"></a><span id="l2.2522" class="difflineplus">+                    86400 * this.days + 7 * 86400 * this.weeks;</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineplus">+      return (this.isNegative ? -seconds : seconds);</span>
<a href="#l2.2524"></a><span id="l2.2524" class="difflineplus">+    },</span>
<a href="#l2.2525"></a><span id="l2.2525" class="difflineplus">+</span>
<a href="#l2.2526"></a><span id="l2.2526" class="difflineplus">+    fromSeconds: function fromSeconds(aSeconds) {</span>
<a href="#l2.2527"></a><span id="l2.2527" class="difflineplus">+      var secs = Math.abs(aSeconds);</span>
<a href="#l2.2528"></a><span id="l2.2528" class="difflineplus">+</span>
<a href="#l2.2529"></a><span id="l2.2529" class="difflineplus">+      this.isNegative = (aSeconds &lt; 0);</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineplus">+      this.days = ICAL.helpers.trunc(secs / 86400);</span>
<a href="#l2.2531"></a><span id="l2.2531" class="difflineplus">+</span>
<a href="#l2.2532"></a><span id="l2.2532" class="difflineplus">+      // If we have a flat number of weeks, use them.</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineplus">+      if (this.days % 7 == 0) {</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineplus">+        this.weeks = this.days / 7;</span>
<a href="#l2.2535"></a><span id="l2.2535" class="difflineplus">+        this.days = 0;</span>
<a href="#l2.2536"></a><span id="l2.2536" class="difflineplus">+      } else {</span>
<a href="#l2.2537"></a><span id="l2.2537" class="difflineplus">+        this.weeks = 0;</span>
<a href="#l2.2538"></a><span id="l2.2538" class="difflineplus">+      }</span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineplus">+</span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineplus">+      secs -= (this.days + 7 * this.weeks) * 86400;</span>
<a href="#l2.2541"></a><span id="l2.2541" class="difflineplus">+</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineplus">+      this.hours = ICAL.helpers.trunc(secs / 3600);</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineplus">+      secs -= this.hours * 3600;</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineplus">+</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineplus">+      this.minutes = ICAL.helpers.trunc(secs / 60);</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineplus">+      secs -= this.minutes * 60;</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineplus">+</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineplus">+      this.seconds = secs;</span>
<a href="#l2.2549"></a><span id="l2.2549" class="difflineplus">+      return this;</span>
<a href="#l2.2550"></a><span id="l2.2550" class="difflineplus">+    },</span>
<a href="#l2.2551"></a><span id="l2.2551" class="difflineplus">+</span>
<a href="#l2.2552"></a><span id="l2.2552" class="difflineplus">+    fromData: function fromData(aData) {</span>
<a href="#l2.2553"></a><span id="l2.2553" class="difflineplus">+      var propsToCopy = [&quot;weeks&quot;, &quot;days&quot;, &quot;hours&quot;,</span>
<a href="#l2.2554"></a><span id="l2.2554" class="difflineplus">+                         &quot;minutes&quot;, &quot;seconds&quot;, &quot;isNegative&quot;];</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineplus">+      for (var key in propsToCopy) {</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineplus">+        var prop = propsToCopy[key];</span>
<a href="#l2.2557"></a><span id="l2.2557" class="difflineplus">+        if (aData &amp;&amp; prop in aData) {</span>
<a href="#l2.2558"></a><span id="l2.2558" class="difflineplus">+          this[prop] = aData[prop];</span>
<a href="#l2.2559"></a><span id="l2.2559" class="difflineplus">+        } else {</span>
<a href="#l2.2560"></a><span id="l2.2560" class="difflineplus">+          this[prop] = 0;</span>
<a href="#l2.2561"></a><span id="l2.2561" class="difflineplus">+        }</span>
<a href="#l2.2562"></a><span id="l2.2562" class="difflineplus">+      }</span>
<a href="#l2.2563"></a><span id="l2.2563" class="difflineplus">+</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineplus">+      if (aData &amp;&amp; &quot;factor&quot; in aData) {</span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineplus">+        this.isNegative = (aData.factor == &quot;-1&quot;);</span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineplus">+      }</span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineplus">+    },</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineplus">+</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineplus">+    reset: function reset() {</span>
<a href="#l2.2570"></a><span id="l2.2570" class="difflineplus">+      this.isNegative = false;</span>
<a href="#l2.2571"></a><span id="l2.2571" class="difflineplus">+      this.weeks = 0;</span>
<a href="#l2.2572"></a><span id="l2.2572" class="difflineplus">+      this.days = 0;</span>
<a href="#l2.2573"></a><span id="l2.2573" class="difflineplus">+      this.hours = 0;</span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineplus">+      this.minutes = 0;</span>
<a href="#l2.2575"></a><span id="l2.2575" class="difflineplus">+      this.seconds = 0;</span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineplus">+    },</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineplus">+</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineplus">+    compare: function compare(aOther) {</span>
<a href="#l2.2579"></a><span id="l2.2579" class="difflineplus">+      var thisSeconds = this.toSeconds();</span>
<a href="#l2.2580"></a><span id="l2.2580" class="difflineplus">+      var otherSeconds = aOther.toSeconds();</span>
<a href="#l2.2581"></a><span id="l2.2581" class="difflineplus">+      return (thisSeconds &gt; otherSeconds) - (thisSeconds &lt; otherSeconds);</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineplus">+    },</span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineplus">+</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineplus">+    normalize: function normalize() {</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineplus">+      this.fromSeconds(this.toSeconds());</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineplus">+      return this;</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineplus">+    },</span>
<a href="#l2.2588"></a><span id="l2.2588" class="difflineplus">+</span>
<a href="#l2.2589"></a><span id="l2.2589" class="difflineplus">+    toString: function toString() {</span>
<a href="#l2.2590"></a><span id="l2.2590" class="difflineplus">+      if (this.toSeconds() == 0) {</span>
<a href="#l2.2591"></a><span id="l2.2591" class="difflineplus">+        return &quot;PT0S&quot;;</span>
<a href="#l2.2592"></a><span id="l2.2592" class="difflineplus">+      } else {</span>
<a href="#l2.2593"></a><span id="l2.2593" class="difflineplus">+        var str = &quot;&quot;;</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineplus">+        if (this.isNegative) str += &quot;-&quot;;</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineplus">+        str += &quot;P&quot;;</span>
<a href="#l2.2596"></a><span id="l2.2596" class="difflineplus">+        if (this.weeks) str += this.weeks + &quot;W&quot;;</span>
<a href="#l2.2597"></a><span id="l2.2597" class="difflineplus">+        if (this.days) str += this.days + &quot;D&quot;;</span>
<a href="#l2.2598"></a><span id="l2.2598" class="difflineplus">+</span>
<a href="#l2.2599"></a><span id="l2.2599" class="difflineplus">+        if (this.hours || this.minutes || this.seconds) {</span>
<a href="#l2.2600"></a><span id="l2.2600" class="difflineplus">+          str += &quot;T&quot;;</span>
<a href="#l2.2601"></a><span id="l2.2601" class="difflineplus">+          if (this.hours) str += this.hours + &quot;H&quot;;</span>
<a href="#l2.2602"></a><span id="l2.2602" class="difflineplus">+          if (this.minutes) str += this.minutes + &quot;M&quot;;</span>
<a href="#l2.2603"></a><span id="l2.2603" class="difflineplus">+          if (this.seconds) str += this.seconds + &quot;S&quot;;</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineplus">+        }</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineplus">+        return str;</span>
<a href="#l2.2606"></a><span id="l2.2606" class="difflineplus">+      }</span>
<a href="#l2.2607"></a><span id="l2.2607" class="difflineplus">+    }</span>
<a href="#l2.2608"></a><span id="l2.2608" class="difflineplus">+  };</span>
<a href="#l2.2609"></a><span id="l2.2609" class="difflineplus">+</span>
<a href="#l2.2610"></a><span id="l2.2610" class="difflineplus">+  ICAL.Duration.fromSeconds = function icalduration_from_seconds(aSeconds) {</span>
<a href="#l2.2611"></a><span id="l2.2611" class="difflineplus">+    return (new ICAL.Duration()).fromSeconds(aSeconds);</span>
<a href="#l2.2612"></a><span id="l2.2612" class="difflineplus">+  };</span>
<a href="#l2.2613"></a><span id="l2.2613" class="difflineplus">+</span>
<a href="#l2.2614"></a><span id="l2.2614" class="difflineplus">+  /**</span>
<a href="#l2.2615"></a><span id="l2.2615" class="difflineplus">+   * Internal helper function to handle a chunk of a duration.</span>
<a href="#l2.2616"></a><span id="l2.2616" class="difflineplus">+   *</span>
<a href="#l2.2617"></a><span id="l2.2617" class="difflineplus">+   * @param {String} letter type of duration chunk.</span>
<a href="#l2.2618"></a><span id="l2.2618" class="difflineplus">+   * @param {String} number numeric value or -/+.</span>
<a href="#l2.2619"></a><span id="l2.2619" class="difflineplus">+   * @param {Object} dict target to assign values to.</span>
<a href="#l2.2620"></a><span id="l2.2620" class="difflineplus">+   */</span>
<a href="#l2.2621"></a><span id="l2.2621" class="difflineplus">+  function parseDurationChunk(letter, number, object) {</span>
<a href="#l2.2622"></a><span id="l2.2622" class="difflineplus">+    var type;</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineplus">+    switch (letter) {</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineplus">+      case 'P':</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineplus">+        if (number &amp;&amp; number === '-') {</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineplus">+          object.isNegative = true;</span>
<a href="#l2.2627"></a><span id="l2.2627" class="difflineplus">+        } else {</span>
<a href="#l2.2628"></a><span id="l2.2628" class="difflineplus">+          object.isNegative = false;</span>
<a href="#l2.2629"></a><span id="l2.2629" class="difflineplus">+        }</span>
<a href="#l2.2630"></a><span id="l2.2630" class="difflineplus">+        // period</span>
<a href="#l2.2631"></a><span id="l2.2631" class="difflineplus">+        break;</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineplus">+      case 'D':</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineplus">+        type = 'days';</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineplus">+        break;</span>
<a href="#l2.2635"></a><span id="l2.2635" class="difflineplus">+      case 'W':</span>
<a href="#l2.2636"></a><span id="l2.2636" class="difflineplus">+        type = 'weeks';</span>
<a href="#l2.2637"></a><span id="l2.2637" class="difflineplus">+        break;</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineplus">+      case 'H':</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineplus">+        type = 'hours';</span>
<a href="#l2.2640"></a><span id="l2.2640" class="difflineplus">+        break;</span>
<a href="#l2.2641"></a><span id="l2.2641" class="difflineplus">+      case 'M':</span>
<a href="#l2.2642"></a><span id="l2.2642" class="difflineplus">+        type = 'minutes';</span>
<a href="#l2.2643"></a><span id="l2.2643" class="difflineplus">+        break;</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineplus">+      case 'S':</span>
<a href="#l2.2645"></a><span id="l2.2645" class="difflineplus">+        type = 'seconds';</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineplus">+        break;</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineplus">+      default:</span>
<a href="#l2.2648"></a><span id="l2.2648" class="difflineplus">+        // Not a valid chunk</span>
<a href="#l2.2649"></a><span id="l2.2649" class="difflineplus">+        return 0;</span>
<a href="#l2.2650"></a><span id="l2.2650" class="difflineplus">+    }</span>
<a href="#l2.2651"></a><span id="l2.2651" class="difflineplus">+</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineplus">+    if (type) {</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineplus">+      if (!number &amp;&amp; number !== 0) {</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineplus">+        throw new Error(</span>
<a href="#l2.2655"></a><span id="l2.2655" class="difflineplus">+          'invalid duration value: Missing number before &quot;' + letter + '&quot;'</span>
<a href="#l2.2656"></a><span id="l2.2656" class="difflineplus">+        );</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineplus">+      }</span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineplus">+      var num = parseInt(number, 10);</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineplus">+      if (ICAL.helpers.isStrictlyNaN(num)) {</span>
<a href="#l2.2660"></a><span id="l2.2660" class="difflineplus">+        throw new Error(</span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineplus">+          'invalid duration value: Invalid number &quot;' + number + '&quot; after &quot;' + letter + '&quot;'</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineplus">+        );</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineplus">+      }</span>
<a href="#l2.2664"></a><span id="l2.2664" class="difflineplus">+      object[type] = num;</span>
<a href="#l2.2665"></a><span id="l2.2665" class="difflineplus">+    }</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineplus">+</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineplus">+    return 1;</span>
<a href="#l2.2668"></a><span id="l2.2668" class="difflineplus">+  }</span>
<a href="#l2.2669"></a><span id="l2.2669" class="difflineplus">+</span>
<a href="#l2.2670"></a><span id="l2.2670" class="difflineplus">+  /**</span>
<a href="#l2.2671"></a><span id="l2.2671" class="difflineplus">+   * @param {String} value raw ical value.</span>
<a href="#l2.2672"></a><span id="l2.2672" class="difflineplus">+   * @return {Boolean}</span>
<a href="#l2.2673"></a><span id="l2.2673" class="difflineplus">+   *  true when the given value is of the duration ical type.</span>
<a href="#l2.2674"></a><span id="l2.2674" class="difflineplus">+   */</span>
<a href="#l2.2675"></a><span id="l2.2675" class="difflineplus">+  ICAL.Duration.isValueString = function(string) {</span>
<a href="#l2.2676"></a><span id="l2.2676" class="difflineplus">+    return (string[0] === 'P' || string[1] === 'P');</span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineplus">+  },</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineplus">+</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineplus">+  ICAL.Duration.fromString = function icalduration_from_string(aStr) {</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineplus">+    var pos = 0;</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineplus">+    var dict = Object.create(null);</span>
<a href="#l2.2682"></a><span id="l2.2682" class="difflineplus">+    var chunks = 0;</span>
<a href="#l2.2683"></a><span id="l2.2683" class="difflineplus">+</span>
<a href="#l2.2684"></a><span id="l2.2684" class="difflineplus">+    while ((pos = aStr.search(DURATION_LETTERS)) !== -1) {</span>
<a href="#l2.2685"></a><span id="l2.2685" class="difflineplus">+      var type = aStr[pos];</span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineplus">+      var numeric = aStr.substr(0, pos);</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineplus">+      aStr = aStr.substr(pos + 1);</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineplus">+</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineplus">+      chunks += parseDurationChunk(type, numeric, dict);</span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineplus">+    }</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineplus">+</span>
<a href="#l2.2692"></a><span id="l2.2692" class="difflineplus">+    if (chunks &lt; 2) {</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineplus">+      // There must be at least a chunk with &quot;P&quot; and some unit chunk</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineplus">+      throw new Error(</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineplus">+        'invalid duration value: Not enough duration components in &quot;' + aStr + '&quot;'</span>
<a href="#l2.2696"></a><span id="l2.2696" class="difflineplus">+      );</span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineplus">+    }</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineplus">+</span>
<a href="#l2.2699"></a><span id="l2.2699" class="difflineplus">+    return new ICAL.Duration(dict);</span>
<a href="#l2.2700"></a><span id="l2.2700" class="difflineplus">+  };</span>
<a href="#l2.2701"></a><span id="l2.2701" class="difflineplus">+</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineplus">+  ICAL.Duration.fromData = function icalduration_from_data(aData) {</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineplus">+    return new ICAL.Duration(aData);</span>
<a href="#l2.2704"></a><span id="l2.2704" class="difflineplus">+  };</span>
<a href="#l2.2705"></a><span id="l2.2705" class="difflineplus">+})();</span>
<a href="#l2.2706"></a><span id="l2.2706" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.2710"></a><span id="l2.2710" class="difflineplus">+</span>
<a href="#l2.2711"></a><span id="l2.2711" class="difflineplus">+</span>
<a href="#l2.2712"></a><span id="l2.2712" class="difflineplus">+</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineplus">+(function() {</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineplus">+  var OPTIONS = [&quot;tzid&quot;, &quot;location&quot;, &quot;tznames&quot;,</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineplus">+                 &quot;latitude&quot;, &quot;longitude&quot;];</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineplus">+</span>
<a href="#l2.2718"></a><span id="l2.2718" class="difflineplus">+  /**</span>
<a href="#l2.2719"></a><span id="l2.2719" class="difflineplus">+   * Timezone representation, created by passing in a tzid and component.</span>
<a href="#l2.2720"></a><span id="l2.2720" class="difflineplus">+   *</span>
<a href="#l2.2721"></a><span id="l2.2721" class="difflineplus">+   *    var vcalendar;</span>
<a href="#l2.2722"></a><span id="l2.2722" class="difflineplus">+   *    var timezoneComp = vcalendar.getFirstSubcomponent('vtimezone');</span>
<a href="#l2.2723"></a><span id="l2.2723" class="difflineplus">+   *    var tzid = timezoneComp.getFirstPropertyValue('tzid');</span>
<a href="#l2.2724"></a><span id="l2.2724" class="difflineplus">+   *</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineplus">+   *    var timezone = new ICAL.Timezone({</span>
<a href="#l2.2726"></a><span id="l2.2726" class="difflineplus">+   *      component: timezoneComp,</span>
<a href="#l2.2727"></a><span id="l2.2727" class="difflineplus">+   *      tzid</span>
<a href="#l2.2728"></a><span id="l2.2728" class="difflineplus">+   *    });</span>
<a href="#l2.2729"></a><span id="l2.2729" class="difflineplus">+   *</span>
<a href="#l2.2730"></a><span id="l2.2730" class="difflineplus">+   *</span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineplus">+   * @param {Object} data options for class (see above).</span>
<a href="#l2.2732"></a><span id="l2.2732" class="difflineplus">+   */</span>
<a href="#l2.2733"></a><span id="l2.2733" class="difflineplus">+  ICAL.Timezone = function icaltimezone(data) {</span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineplus">+    this.fromData(data);</span>
<a href="#l2.2736"></a><span id="l2.2736" class="difflineplus">+  };</span>
<a href="#l2.2737"></a><span id="l2.2737" class="difflineplus">+</span>
<a href="#l2.2738"></a><span id="l2.2738" class="difflineplus">+  ICAL.Timezone.prototype = {</span>
<a href="#l2.2739"></a><span id="l2.2739" class="difflineplus">+</span>
<a href="#l2.2740"></a><span id="l2.2740" class="difflineplus">+    tzid: &quot;&quot;,</span>
<a href="#l2.2741"></a><span id="l2.2741" class="difflineplus">+    location: &quot;&quot;,</span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineplus">+    tznames: &quot;&quot;,</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineplus">+</span>
<a href="#l2.2744"></a><span id="l2.2744" class="difflineplus">+    latitude: 0.0,</span>
<a href="#l2.2745"></a><span id="l2.2745" class="difflineplus">+    longitude: 0.0,</span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineplus">+</span>
<a href="#l2.2747"></a><span id="l2.2747" class="difflineplus">+    component: null,</span>
<a href="#l2.2748"></a><span id="l2.2748" class="difflineplus">+</span>
<a href="#l2.2749"></a><span id="l2.2749" class="difflineplus">+    expandedUntilYear: 0,</span>
<a href="#l2.2750"></a><span id="l2.2750" class="difflineplus">+</span>
<a href="#l2.2751"></a><span id="l2.2751" class="difflineplus">+    icalclass: &quot;icaltimezone&quot;,</span>
<a href="#l2.2752"></a><span id="l2.2752" class="difflineplus">+</span>
<a href="#l2.2753"></a><span id="l2.2753" class="difflineplus">+    fromData: function fromData(aData) {</span>
<a href="#l2.2754"></a><span id="l2.2754" class="difflineplus">+      this.expandedUntilYear = 0;</span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineplus">+      this.changes = [];</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineplus">+</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineplus">+      if (aData instanceof ICAL.Component) {</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineplus">+        this.component = aData;</span>
<a href="#l2.2759"></a><span id="l2.2759" class="difflineplus">+        this.tzid = this.component.getFirstPropertyValue('tzid');</span>
<a href="#l2.2760"></a><span id="l2.2760" class="difflineplus">+        return null;</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineplus">+      }</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineplus">+</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineplus">+      for (var key in OPTIONS) {</span>
<a href="#l2.2764"></a><span id="l2.2764" class="difflineplus">+        var prop = OPTIONS[key];</span>
<a href="#l2.2765"></a><span id="l2.2765" class="difflineplus">+        if (aData &amp;&amp; prop in aData) {</span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineplus">+          this[prop] = aData[prop];</span>
<a href="#l2.2767"></a><span id="l2.2767" class="difflineplus">+        }</span>
<a href="#l2.2768"></a><span id="l2.2768" class="difflineplus">+      }</span>
<a href="#l2.2769"></a><span id="l2.2769" class="difflineplus">+</span>
<a href="#l2.2770"></a><span id="l2.2770" class="difflineplus">+      if (aData &amp;&amp; &quot;component&quot; in aData) {</span>
<a href="#l2.2771"></a><span id="l2.2771" class="difflineplus">+        if (typeof aData.component == &quot;string&quot;) {</span>
<a href="#l2.2772"></a><span id="l2.2772" class="difflineplus">+          let icalendar = ICAL.parse(aData.component);</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineplus">+          this.component = new ICAL.Component(icalendar[1]);</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineplus">+        } else {</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineplus">+          this.component = aData.component;</span>
<a href="#l2.2776"></a><span id="l2.2776" class="difflineplus">+        }</span>
<a href="#l2.2777"></a><span id="l2.2777" class="difflineplus">+      } else {</span>
<a href="#l2.2778"></a><span id="l2.2778" class="difflineplus">+        this.component = null;</span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineplus">+      }</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineplus">+      return this;</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineplus">+    },</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineplus">+</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineplus">+    /**</span>
<a href="#l2.2784"></a><span id="l2.2784" class="difflineplus">+     * Finds the utcOffset the given time would occur in this timezone.</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineplus">+     *</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineplus">+     * @return {Number} utc offset in seconds.</span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineplus">+     */</span>
<a href="#l2.2788"></a><span id="l2.2788" class="difflineplus">+    utcOffset: function utcOffset(tt) {</span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineplus">+      if (this == ICAL.Timezone.utcTimezone || this == ICAL.Timezone.localTimezone) {</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineplus">+        return 0;</span>
<a href="#l2.2791"></a><span id="l2.2791" class="difflineplus">+      }</span>
<a href="#l2.2792"></a><span id="l2.2792" class="difflineplus">+</span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineplus">+      this._ensureCoverage(tt.year);</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineplus">+</span>
<a href="#l2.2795"></a><span id="l2.2795" class="difflineplus">+      if (!this.changes.length) {</span>
<a href="#l2.2796"></a><span id="l2.2796" class="difflineplus">+        return 0;</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineplus">+      }</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineplus">+</span>
<a href="#l2.2799"></a><span id="l2.2799" class="difflineplus">+      var tt_change = {</span>
<a href="#l2.2800"></a><span id="l2.2800" class="difflineplus">+        year: tt.year,</span>
<a href="#l2.2801"></a><span id="l2.2801" class="difflineplus">+        month: tt.month,</span>
<a href="#l2.2802"></a><span id="l2.2802" class="difflineplus">+        day: tt.day,</span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineplus">+        hour: tt.hour,</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineplus">+        minute: tt.minute,</span>
<a href="#l2.2805"></a><span id="l2.2805" class="difflineplus">+        second: tt.second</span>
<a href="#l2.2806"></a><span id="l2.2806" class="difflineplus">+      };</span>
<a href="#l2.2807"></a><span id="l2.2807" class="difflineplus">+</span>
<a href="#l2.2808"></a><span id="l2.2808" class="difflineplus">+      var change_num = this._findNearbyChange(tt_change);</span>
<a href="#l2.2809"></a><span id="l2.2809" class="difflineplus">+      var change_num_to_use = -1;</span>
<a href="#l2.2810"></a><span id="l2.2810" class="difflineplus">+      var step = 1;</span>
<a href="#l2.2811"></a><span id="l2.2811" class="difflineplus">+</span>
<a href="#l2.2812"></a><span id="l2.2812" class="difflineplus">+      // TODO: replace with bin search?</span>
<a href="#l2.2813"></a><span id="l2.2813" class="difflineplus">+      for (;;) {</span>
<a href="#l2.2814"></a><span id="l2.2814" class="difflineplus">+        var change = ICAL.helpers.clone(this.changes[change_num], true);</span>
<a href="#l2.2815"></a><span id="l2.2815" class="difflineplus">+        if (change.utcOffset &lt; change.prevUtcOffset) {</span>
<a href="#l2.2816"></a><span id="l2.2816" class="difflineplus">+          ICAL.Timezone.adjust_change(change, 0, 0, 0, change.utcOffset);</span>
<a href="#l2.2817"></a><span id="l2.2817" class="difflineplus">+        } else {</span>
<a href="#l2.2818"></a><span id="l2.2818" class="difflineplus">+          ICAL.Timezone.adjust_change(change, 0, 0, 0,</span>
<a href="#l2.2819"></a><span id="l2.2819" class="difflineplus">+                                          change.prevUtcOffset);</span>
<a href="#l2.2820"></a><span id="l2.2820" class="difflineplus">+        }</span>
<a href="#l2.2821"></a><span id="l2.2821" class="difflineplus">+</span>
<a href="#l2.2822"></a><span id="l2.2822" class="difflineplus">+        var cmp = ICAL.Timezone._compare_change_fn(tt_change, change);</span>
<a href="#l2.2823"></a><span id="l2.2823" class="difflineplus">+</span>
<a href="#l2.2824"></a><span id="l2.2824" class="difflineplus">+        if (cmp &gt;= 0) {</span>
<a href="#l2.2825"></a><span id="l2.2825" class="difflineplus">+          change_num_to_use = change_num;</span>
<a href="#l2.2826"></a><span id="l2.2826" class="difflineplus">+        } else {</span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineplus">+          step = -1;</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineplus">+        }</span>
<a href="#l2.2829"></a><span id="l2.2829" class="difflineplus">+</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineplus">+        if (step == -1 &amp;&amp; change_num_to_use != -1) {</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineplus">+          break;</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineplus">+        }</span>
<a href="#l2.2833"></a><span id="l2.2833" class="difflineplus">+</span>
<a href="#l2.2834"></a><span id="l2.2834" class="difflineplus">+        change_num += step;</span>
<a href="#l2.2835"></a><span id="l2.2835" class="difflineplus">+</span>
<a href="#l2.2836"></a><span id="l2.2836" class="difflineplus">+        if (change_num &lt; 0) {</span>
<a href="#l2.2837"></a><span id="l2.2837" class="difflineplus">+          return 0;</span>
<a href="#l2.2838"></a><span id="l2.2838" class="difflineplus">+        }</span>
<a href="#l2.2839"></a><span id="l2.2839" class="difflineplus">+</span>
<a href="#l2.2840"></a><span id="l2.2840" class="difflineplus">+        if (change_num &gt;= this.changes.length) {</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineplus">+          break;</span>
<a href="#l2.2842"></a><span id="l2.2842" class="difflineplus">+        }</span>
<a href="#l2.2843"></a><span id="l2.2843" class="difflineplus">+      }</span>
<a href="#l2.2844"></a><span id="l2.2844" class="difflineplus">+</span>
<a href="#l2.2845"></a><span id="l2.2845" class="difflineplus">+      var zone_change = this.changes[change_num_to_use];</span>
<a href="#l2.2846"></a><span id="l2.2846" class="difflineplus">+      var utcOffset_change = zone_change.utcOffset - zone_change.prevUtcOffset;</span>
<a href="#l2.2847"></a><span id="l2.2847" class="difflineplus">+</span>
<a href="#l2.2848"></a><span id="l2.2848" class="difflineplus">+      if (utcOffset_change &lt; 0 &amp;&amp; change_num_to_use &gt; 0) {</span>
<a href="#l2.2849"></a><span id="l2.2849" class="difflineplus">+        var tmp_change = ICAL.helpers.clone(zone_change, true);</span>
<a href="#l2.2850"></a><span id="l2.2850" class="difflineplus">+        ICAL.Timezone.adjust_change(tmp_change, 0, 0, 0,</span>
<a href="#l2.2851"></a><span id="l2.2851" class="difflineplus">+                                        tmp_change.prevUtcOffset);</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineplus">+</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineplus">+        if (ICAL.Timezone._compare_change_fn(tt_change, tmp_change) &lt; 0) {</span>
<a href="#l2.2854"></a><span id="l2.2854" class="difflineplus">+          var prev_zone_change = this.changes[change_num_to_use - 1];</span>
<a href="#l2.2855"></a><span id="l2.2855" class="difflineplus">+</span>
<a href="#l2.2856"></a><span id="l2.2856" class="difflineplus">+          var want_daylight = false; // TODO</span>
<a href="#l2.2857"></a><span id="l2.2857" class="difflineplus">+</span>
<a href="#l2.2858"></a><span id="l2.2858" class="difflineplus">+          if (zone_change.is_daylight != want_daylight &amp;&amp;</span>
<a href="#l2.2859"></a><span id="l2.2859" class="difflineplus">+              prev_zone_change.is_daylight == want_daylight) {</span>
<a href="#l2.2860"></a><span id="l2.2860" class="difflineplus">+            zone_change = prev_zone_change;</span>
<a href="#l2.2861"></a><span id="l2.2861" class="difflineplus">+          }</span>
<a href="#l2.2862"></a><span id="l2.2862" class="difflineplus">+        }</span>
<a href="#l2.2863"></a><span id="l2.2863" class="difflineplus">+      }</span>
<a href="#l2.2864"></a><span id="l2.2864" class="difflineplus">+</span>
<a href="#l2.2865"></a><span id="l2.2865" class="difflineplus">+      // TODO return is_daylight?</span>
<a href="#l2.2866"></a><span id="l2.2866" class="difflineplus">+      return zone_change.utcOffset;</span>
<a href="#l2.2867"></a><span id="l2.2867" class="difflineplus">+    },</span>
<a href="#l2.2868"></a><span id="l2.2868" class="difflineplus">+</span>
<a href="#l2.2869"></a><span id="l2.2869" class="difflineplus">+    _findNearbyChange: function icaltimezone_find_nearby_change(change) {</span>
<a href="#l2.2870"></a><span id="l2.2870" class="difflineplus">+      // find the closest match</span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineplus">+      var idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.2872"></a><span id="l2.2872" class="difflineplus">+        this.changes,</span>
<a href="#l2.2873"></a><span id="l2.2873" class="difflineplus">+        change,</span>
<a href="#l2.2874"></a><span id="l2.2874" class="difflineplus">+        ICAL.Timezone._compare_change_fn</span>
<a href="#l2.2875"></a><span id="l2.2875" class="difflineplus">+      );</span>
<a href="#l2.2876"></a><span id="l2.2876" class="difflineplus">+</span>
<a href="#l2.2877"></a><span id="l2.2877" class="difflineplus">+      if (idx &gt;= this.changes.length) {</span>
<a href="#l2.2878"></a><span id="l2.2878" class="difflineplus">+        return this.changes.length - 1;</span>
<a href="#l2.2879"></a><span id="l2.2879" class="difflineplus">+      }</span>
<a href="#l2.2880"></a><span id="l2.2880" class="difflineplus">+</span>
<a href="#l2.2881"></a><span id="l2.2881" class="difflineplus">+      return idx;</span>
<a href="#l2.2882"></a><span id="l2.2882" class="difflineplus">+    },</span>
<a href="#l2.2883"></a><span id="l2.2883" class="difflineplus">+</span>
<a href="#l2.2884"></a><span id="l2.2884" class="difflineplus">+    _ensureCoverage: function(aYear) {</span>
<a href="#l2.2885"></a><span id="l2.2885" class="difflineplus">+      if (ICAL.Timezone._minimumExpansionYear == -1) {</span>
<a href="#l2.2886"></a><span id="l2.2886" class="difflineplus">+        var today = ICAL.Time.now();</span>
<a href="#l2.2887"></a><span id="l2.2887" class="difflineplus">+        ICAL.Timezone._minimumExpansionYear = today.year;</span>
<a href="#l2.2888"></a><span id="l2.2888" class="difflineplus">+      }</span>
<a href="#l2.2889"></a><span id="l2.2889" class="difflineplus">+</span>
<a href="#l2.2890"></a><span id="l2.2890" class="difflineplus">+      var changesEndYear = aYear;</span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineplus">+      if (changesEndYear &lt; ICAL.Timezone._minimumExpansionYear) {</span>
<a href="#l2.2892"></a><span id="l2.2892" class="difflineplus">+        changesEndYear = ICAL.Timezone._minimumExpansionYear;</span>
<a href="#l2.2893"></a><span id="l2.2893" class="difflineplus">+      }</span>
<a href="#l2.2894"></a><span id="l2.2894" class="difflineplus">+</span>
<a href="#l2.2895"></a><span id="l2.2895" class="difflineplus">+      changesEndYear += ICAL.Timezone.EXTRA_COVERAGE;</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineplus">+</span>
<a href="#l2.2897"></a><span id="l2.2897" class="difflineplus">+      if (changesEndYear &gt; ICAL.Timezone.MAX_YEAR) {</span>
<a href="#l2.2898"></a><span id="l2.2898" class="difflineplus">+        changesEndYear = ICAL.Timezone.MAX_YEAR;</span>
<a href="#l2.2899"></a><span id="l2.2899" class="difflineplus">+      }</span>
<a href="#l2.2900"></a><span id="l2.2900" class="difflineplus">+</span>
<a href="#l2.2901"></a><span id="l2.2901" class="difflineplus">+      if (!this.changes.length || this.expandedUntilYear &lt; aYear) {</span>
<a href="#l2.2902"></a><span id="l2.2902" class="difflineplus">+        var subcomps = this.component.getAllSubcomponents();</span>
<a href="#l2.2903"></a><span id="l2.2903" class="difflineplus">+        var compLen = subcomps.length;</span>
<a href="#l2.2904"></a><span id="l2.2904" class="difflineplus">+        var compIdx = 0;</span>
<a href="#l2.2905"></a><span id="l2.2905" class="difflineplus">+</span>
<a href="#l2.2906"></a><span id="l2.2906" class="difflineplus">+        for (; compIdx &lt; compLen; compIdx++) {</span>
<a href="#l2.2907"></a><span id="l2.2907" class="difflineplus">+          this._expandComponent(</span>
<a href="#l2.2908"></a><span id="l2.2908" class="difflineplus">+            subcomps[compIdx], changesEndYear, this.changes</span>
<a href="#l2.2909"></a><span id="l2.2909" class="difflineplus">+          );</span>
<a href="#l2.2910"></a><span id="l2.2910" class="difflineplus">+        }</span>
<a href="#l2.2911"></a><span id="l2.2911" class="difflineplus">+</span>
<a href="#l2.2912"></a><span id="l2.2912" class="difflineplus">+        this.changes.sort(ICAL.Timezone._compare_change_fn);</span>
<a href="#l2.2913"></a><span id="l2.2913" class="difflineplus">+        this.expandedUntilYear = aYear;</span>
<a href="#l2.2914"></a><span id="l2.2914" class="difflineplus">+      }</span>
<a href="#l2.2915"></a><span id="l2.2915" class="difflineplus">+    },</span>
<a href="#l2.2916"></a><span id="l2.2916" class="difflineplus">+</span>
<a href="#l2.2917"></a><span id="l2.2917" class="difflineplus">+    _expandComponent: function(aComponent, aYear, changes) {</span>
<a href="#l2.2918"></a><span id="l2.2918" class="difflineplus">+      if (!aComponent.hasProperty(&quot;dtstart&quot;) ||</span>
<a href="#l2.2919"></a><span id="l2.2919" class="difflineplus">+          !aComponent.hasProperty(&quot;tzoffsetto&quot;) ||</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineplus">+          !aComponent.hasProperty(&quot;tzoffsetfrom&quot;)) {</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineplus">+        return null;</span>
<a href="#l2.2922"></a><span id="l2.2922" class="difflineplus">+      }</span>
<a href="#l2.2923"></a><span id="l2.2923" class="difflineplus">+</span>
<a href="#l2.2924"></a><span id="l2.2924" class="difflineplus">+      var dtstart = aComponent.getFirstProperty(&quot;dtstart&quot;).getFirstValue();</span>
<a href="#l2.2925"></a><span id="l2.2925" class="difflineplus">+</span>
<a href="#l2.2926"></a><span id="l2.2926" class="difflineplus">+      function convert_tzoffset(offset) {</span>
<a href="#l2.2927"></a><span id="l2.2927" class="difflineplus">+        return offset.factor * (offset.hours * 3600 + offset.minutes * 60);</span>
<a href="#l2.2928"></a><span id="l2.2928" class="difflineplus">+      }</span>
<a href="#l2.2929"></a><span id="l2.2929" class="difflineplus">+</span>
<a href="#l2.2930"></a><span id="l2.2930" class="difflineplus">+      function init_changes() {</span>
<a href="#l2.2931"></a><span id="l2.2931" class="difflineplus">+        var changebase = {};</span>
<a href="#l2.2932"></a><span id="l2.2932" class="difflineplus">+        changebase.is_daylight = (aComponent.name == &quot;daylight&quot;);</span>
<a href="#l2.2933"></a><span id="l2.2933" class="difflineplus">+        changebase.utcOffset = convert_tzoffset(</span>
<a href="#l2.2934"></a><span id="l2.2934" class="difflineplus">+          aComponent.getFirstProperty(&quot;tzoffsetto&quot;).getFirstValue()</span>
<a href="#l2.2935"></a><span id="l2.2935" class="difflineplus">+        );</span>
<a href="#l2.2936"></a><span id="l2.2936" class="difflineplus">+</span>
<a href="#l2.2937"></a><span id="l2.2937" class="difflineplus">+        changebase.prevUtcOffset = convert_tzoffset(</span>
<a href="#l2.2938"></a><span id="l2.2938" class="difflineplus">+          aComponent.getFirstProperty(&quot;tzoffsetfrom&quot;).getFirstValue()</span>
<a href="#l2.2939"></a><span id="l2.2939" class="difflineplus">+        );</span>
<a href="#l2.2940"></a><span id="l2.2940" class="difflineplus">+</span>
<a href="#l2.2941"></a><span id="l2.2941" class="difflineplus">+        return changebase;</span>
<a href="#l2.2942"></a><span id="l2.2942" class="difflineplus">+      }</span>
<a href="#l2.2943"></a><span id="l2.2943" class="difflineplus">+</span>
<a href="#l2.2944"></a><span id="l2.2944" class="difflineplus">+      if (!aComponent.hasProperty(&quot;rrule&quot;) &amp;&amp; !aComponent.hasProperty(&quot;rdate&quot;)) {</span>
<a href="#l2.2945"></a><span id="l2.2945" class="difflineplus">+        var change = init_changes();</span>
<a href="#l2.2946"></a><span id="l2.2946" class="difflineplus">+        change.year = dtstart.year;</span>
<a href="#l2.2947"></a><span id="l2.2947" class="difflineplus">+        change.month = dtstart.month;</span>
<a href="#l2.2948"></a><span id="l2.2948" class="difflineplus">+        change.day = dtstart.day;</span>
<a href="#l2.2949"></a><span id="l2.2949" class="difflineplus">+        change.hour = dtstart.hour;</span>
<a href="#l2.2950"></a><span id="l2.2950" class="difflineplus">+        change.minute = dtstart.minute;</span>
<a href="#l2.2951"></a><span id="l2.2951" class="difflineplus">+        change.second = dtstart.second;</span>
<a href="#l2.2952"></a><span id="l2.2952" class="difflineplus">+</span>
<a href="#l2.2953"></a><span id="l2.2953" class="difflineplus">+        ICAL.Timezone.adjust_change(change, 0, 0, 0,</span>
<a href="#l2.2954"></a><span id="l2.2954" class="difflineplus">+                                        -change.prevUtcOffset);</span>
<a href="#l2.2955"></a><span id="l2.2955" class="difflineplus">+        changes.push(change);</span>
<a href="#l2.2956"></a><span id="l2.2956" class="difflineplus">+      } else {</span>
<a href="#l2.2957"></a><span id="l2.2957" class="difflineplus">+        var props = aComponent.getAllProperties(&quot;rdate&quot;);</span>
<a href="#l2.2958"></a><span id="l2.2958" class="difflineplus">+        for (var rdatekey in props) {</span>
<a href="#l2.2959"></a><span id="l2.2959" class="difflineplus">+          var rdate = props[rdatekey];</span>
<a href="#l2.2960"></a><span id="l2.2960" class="difflineplus">+          var time = rdate.getFirstValue();</span>
<a href="#l2.2961"></a><span id="l2.2961" class="difflineplus">+          var change = init_changes();</span>
<a href="#l2.2962"></a><span id="l2.2962" class="difflineplus">+</span>
<a href="#l2.2963"></a><span id="l2.2963" class="difflineplus">+          change.year = time.year;</span>
<a href="#l2.2964"></a><span id="l2.2964" class="difflineplus">+          change.month = time.month;</span>
<a href="#l2.2965"></a><span id="l2.2965" class="difflineplus">+          change.day = time.day;</span>
<a href="#l2.2966"></a><span id="l2.2966" class="difflineplus">+</span>
<a href="#l2.2967"></a><span id="l2.2967" class="difflineplus">+          if (time.isDate) {</span>
<a href="#l2.2968"></a><span id="l2.2968" class="difflineplus">+            change.hour = dtstart.hour;</span>
<a href="#l2.2969"></a><span id="l2.2969" class="difflineplus">+            change.minute = dtstart.minute;</span>
<a href="#l2.2970"></a><span id="l2.2970" class="difflineplus">+            change.second = dtstart.second;</span>
<a href="#l2.2971"></a><span id="l2.2971" class="difflineplus">+          } else {</span>
<a href="#l2.2972"></a><span id="l2.2972" class="difflineplus">+            change.hour = time.hour;</span>
<a href="#l2.2973"></a><span id="l2.2973" class="difflineplus">+            change.minute = time.minute;</span>
<a href="#l2.2974"></a><span id="l2.2974" class="difflineplus">+            change.second = time.second;</span>
<a href="#l2.2975"></a><span id="l2.2975" class="difflineplus">+</span>
<a href="#l2.2976"></a><span id="l2.2976" class="difflineplus">+            if (time.zone == ICAL.Timezone.utcTimezone) {</span>
<a href="#l2.2977"></a><span id="l2.2977" class="difflineplus">+              ICAL.Timezone.adjust_change(change, 0, 0, 0,</span>
<a href="#l2.2978"></a><span id="l2.2978" class="difflineplus">+                                              -change.prevUtcOffset);</span>
<a href="#l2.2979"></a><span id="l2.2979" class="difflineplus">+            }</span>
<a href="#l2.2980"></a><span id="l2.2980" class="difflineplus">+          }</span>
<a href="#l2.2981"></a><span id="l2.2981" class="difflineplus">+</span>
<a href="#l2.2982"></a><span id="l2.2982" class="difflineplus">+          changes.push(change);</span>
<a href="#l2.2983"></a><span id="l2.2983" class="difflineplus">+        }</span>
<a href="#l2.2984"></a><span id="l2.2984" class="difflineplus">+</span>
<a href="#l2.2985"></a><span id="l2.2985" class="difflineplus">+        var rrule = aComponent.getFirstProperty(&quot;rrule&quot;);</span>
<a href="#l2.2986"></a><span id="l2.2986" class="difflineplus">+</span>
<a href="#l2.2987"></a><span id="l2.2987" class="difflineplus">+        if (rrule) {</span>
<a href="#l2.2988"></a><span id="l2.2988" class="difflineplus">+          rrule = rrule.getFirstValue();</span>
<a href="#l2.2989"></a><span id="l2.2989" class="difflineplus">+          var change = init_changes();</span>
<a href="#l2.2990"></a><span id="l2.2990" class="difflineplus">+</span>
<a href="#l2.2991"></a><span id="l2.2991" class="difflineplus">+          if (rrule.until &amp;&amp; rrule.until.zone == ICAL.Timezone.utcTimezone) {</span>
<a href="#l2.2992"></a><span id="l2.2992" class="difflineplus">+            rrule.until.adjust(0, 0, 0, change.prevUtcOffset);</span>
<a href="#l2.2993"></a><span id="l2.2993" class="difflineplus">+            rrule.until.zone = ICAL.Timezone.localTimezone;</span>
<a href="#l2.2994"></a><span id="l2.2994" class="difflineplus">+          }</span>
<a href="#l2.2995"></a><span id="l2.2995" class="difflineplus">+</span>
<a href="#l2.2996"></a><span id="l2.2996" class="difflineplus">+          var iterator = rrule.iterator(dtstart);</span>
<a href="#l2.2997"></a><span id="l2.2997" class="difflineplus">+</span>
<a href="#l2.2998"></a><span id="l2.2998" class="difflineplus">+          var occ;</span>
<a href="#l2.2999"></a><span id="l2.2999" class="difflineplus">+          while ((occ = iterator.next())) {</span>
<a href="#l2.3000"></a><span id="l2.3000" class="difflineplus">+            var change = init_changes();</span>
<a href="#l2.3001"></a><span id="l2.3001" class="difflineplus">+            if (occ.year &gt; aYear || !occ) {</span>
<a href="#l2.3002"></a><span id="l2.3002" class="difflineplus">+              break;</span>
<a href="#l2.3003"></a><span id="l2.3003" class="difflineplus">+            }</span>
<a href="#l2.3004"></a><span id="l2.3004" class="difflineplus">+</span>
<a href="#l2.3005"></a><span id="l2.3005" class="difflineplus">+            change.year = occ.year;</span>
<a href="#l2.3006"></a><span id="l2.3006" class="difflineplus">+            change.month = occ.month;</span>
<a href="#l2.3007"></a><span id="l2.3007" class="difflineplus">+            change.day = occ.day;</span>
<a href="#l2.3008"></a><span id="l2.3008" class="difflineplus">+            change.hour = occ.hour;</span>
<a href="#l2.3009"></a><span id="l2.3009" class="difflineplus">+            change.minute = occ.minute;</span>
<a href="#l2.3010"></a><span id="l2.3010" class="difflineplus">+            change.second = occ.second;</span>
<a href="#l2.3011"></a><span id="l2.3011" class="difflineplus">+            change.isDate = occ.isDate;</span>
<a href="#l2.3012"></a><span id="l2.3012" class="difflineplus">+</span>
<a href="#l2.3013"></a><span id="l2.3013" class="difflineplus">+            ICAL.Timezone.adjust_change(change, 0, 0, 0,</span>
<a href="#l2.3014"></a><span id="l2.3014" class="difflineplus">+                                            -change.prevUtcOffset);</span>
<a href="#l2.3015"></a><span id="l2.3015" class="difflineplus">+            changes.push(change);</span>
<a href="#l2.3016"></a><span id="l2.3016" class="difflineplus">+          }</span>
<a href="#l2.3017"></a><span id="l2.3017" class="difflineplus">+        }</span>
<a href="#l2.3018"></a><span id="l2.3018" class="difflineplus">+      }</span>
<a href="#l2.3019"></a><span id="l2.3019" class="difflineplus">+</span>
<a href="#l2.3020"></a><span id="l2.3020" class="difflineplus">+      return changes;</span>
<a href="#l2.3021"></a><span id="l2.3021" class="difflineplus">+    },</span>
<a href="#l2.3022"></a><span id="l2.3022" class="difflineplus">+</span>
<a href="#l2.3023"></a><span id="l2.3023" class="difflineplus">+    toString: function toString() {</span>
<a href="#l2.3024"></a><span id="l2.3024" class="difflineplus">+      return (this.tznames ? this.tznames : this.tzid);</span>
<a href="#l2.3025"></a><span id="l2.3025" class="difflineplus">+    }</span>
<a href="#l2.3026"></a><span id="l2.3026" class="difflineplus">+</span>
<a href="#l2.3027"></a><span id="l2.3027" class="difflineplus">+  };</span>
<a href="#l2.3028"></a><span id="l2.3028" class="difflineplus">+</span>
<a href="#l2.3029"></a><span id="l2.3029" class="difflineplus">+  ICAL.Timezone._compare_change_fn = function icaltimezone_compare_change_fn(a, b) {</span>
<a href="#l2.3030"></a><span id="l2.3030" class="difflineplus">+    if (a.year &lt; b.year) return -1;</span>
<a href="#l2.3031"></a><span id="l2.3031" class="difflineplus">+    else if (a.year &gt; b.year) return 1;</span>
<a href="#l2.3032"></a><span id="l2.3032" class="difflineplus">+</span>
<a href="#l2.3033"></a><span id="l2.3033" class="difflineplus">+    if (a.month &lt; b.month) return -1;</span>
<a href="#l2.3034"></a><span id="l2.3034" class="difflineplus">+    else if (a.month &gt; b.month) return 1;</span>
<a href="#l2.3035"></a><span id="l2.3035" class="difflineplus">+</span>
<a href="#l2.3036"></a><span id="l2.3036" class="difflineplus">+    if (a.day &lt; b.day) return -1;</span>
<a href="#l2.3037"></a><span id="l2.3037" class="difflineplus">+    else if (a.day &gt; b.day) return 1;</span>
<a href="#l2.3038"></a><span id="l2.3038" class="difflineplus">+</span>
<a href="#l2.3039"></a><span id="l2.3039" class="difflineplus">+    if (a.hour &lt; b.hour) return -1;</span>
<a href="#l2.3040"></a><span id="l2.3040" class="difflineplus">+    else if (a.hour &gt; b.hour) return 1;</span>
<a href="#l2.3041"></a><span id="l2.3041" class="difflineplus">+</span>
<a href="#l2.3042"></a><span id="l2.3042" class="difflineplus">+    if (a.minute &lt; b.minute) return -1;</span>
<a href="#l2.3043"></a><span id="l2.3043" class="difflineplus">+    else if (a.minute &gt; b.minute) return 1;</span>
<a href="#l2.3044"></a><span id="l2.3044" class="difflineplus">+</span>
<a href="#l2.3045"></a><span id="l2.3045" class="difflineplus">+    if (a.second &lt; b.second) return -1;</span>
<a href="#l2.3046"></a><span id="l2.3046" class="difflineplus">+    else if (a.second &gt; b.second) return 1;</span>
<a href="#l2.3047"></a><span id="l2.3047" class="difflineplus">+</span>
<a href="#l2.3048"></a><span id="l2.3048" class="difflineplus">+    return 0;</span>
<a href="#l2.3049"></a><span id="l2.3049" class="difflineplus">+  };</span>
<a href="#l2.3050"></a><span id="l2.3050" class="difflineplus">+</span>
<a href="#l2.3051"></a><span id="l2.3051" class="difflineplus">+  ICAL.Timezone.convert_time = function icaltimezone_convert_time(tt, from_zone, to_zone) {</span>
<a href="#l2.3052"></a><span id="l2.3052" class="difflineplus">+    if (tt.isDate ||</span>
<a href="#l2.3053"></a><span id="l2.3053" class="difflineplus">+        from_zone.tzid == to_zone.tzid ||</span>
<a href="#l2.3054"></a><span id="l2.3054" class="difflineplus">+        from_zone == ICAL.Timezone.localTimezone ||</span>
<a href="#l2.3055"></a><span id="l2.3055" class="difflineplus">+        to_zone == ICAL.Timezone.localTimezone) {</span>
<a href="#l2.3056"></a><span id="l2.3056" class="difflineplus">+      tt.zone = to_zone;</span>
<a href="#l2.3057"></a><span id="l2.3057" class="difflineplus">+      return tt;</span>
<a href="#l2.3058"></a><span id="l2.3058" class="difflineplus">+    }</span>
<a href="#l2.3059"></a><span id="l2.3059" class="difflineplus">+</span>
<a href="#l2.3060"></a><span id="l2.3060" class="difflineplus">+    var utcOffset = from_zone.utcOffset(tt);</span>
<a href="#l2.3061"></a><span id="l2.3061" class="difflineplus">+    tt.adjust(0, 0, 0, - utcOffset);</span>
<a href="#l2.3062"></a><span id="l2.3062" class="difflineplus">+</span>
<a href="#l2.3063"></a><span id="l2.3063" class="difflineplus">+    utcOffset = to_zone.utcOffset(tt);</span>
<a href="#l2.3064"></a><span id="l2.3064" class="difflineplus">+    tt.adjust(0, 0, 0, utcOffset);</span>
<a href="#l2.3065"></a><span id="l2.3065" class="difflineplus">+</span>
<a href="#l2.3066"></a><span id="l2.3066" class="difflineplus">+    return null;</span>
<a href="#l2.3067"></a><span id="l2.3067" class="difflineplus">+  };</span>
<a href="#l2.3068"></a><span id="l2.3068" class="difflineplus">+</span>
<a href="#l2.3069"></a><span id="l2.3069" class="difflineplus">+  ICAL.Timezone.fromData = function icaltimezone_fromData(aData) {</span>
<a href="#l2.3070"></a><span id="l2.3070" class="difflineplus">+    var tt = new ICAL.Timezone();</span>
<a href="#l2.3071"></a><span id="l2.3071" class="difflineplus">+    return tt.fromData(aData);</span>
<a href="#l2.3072"></a><span id="l2.3072" class="difflineplus">+  };</span>
<a href="#l2.3073"></a><span id="l2.3073" class="difflineplus">+</span>
<a href="#l2.3074"></a><span id="l2.3074" class="difflineplus">+  ICAL.Timezone.utcTimezone = ICAL.Timezone.fromData({</span>
<a href="#l2.3075"></a><span id="l2.3075" class="difflineplus">+    tzid: &quot;UTC&quot;</span>
<a href="#l2.3076"></a><span id="l2.3076" class="difflineplus">+  });</span>
<a href="#l2.3077"></a><span id="l2.3077" class="difflineplus">+</span>
<a href="#l2.3078"></a><span id="l2.3078" class="difflineplus">+  ICAL.Timezone.localTimezone = ICAL.Timezone.fromData({</span>
<a href="#l2.3079"></a><span id="l2.3079" class="difflineplus">+    tzid: &quot;floating&quot;</span>
<a href="#l2.3080"></a><span id="l2.3080" class="difflineplus">+  });</span>
<a href="#l2.3081"></a><span id="l2.3081" class="difflineplus">+</span>
<a href="#l2.3082"></a><span id="l2.3082" class="difflineplus">+  ICAL.Timezone.adjust_change = function icaltimezone_adjust_change(change, days, hours, minutes, seconds) {</span>
<a href="#l2.3083"></a><span id="l2.3083" class="difflineplus">+    return ICAL.Time.prototype.adjust.call(</span>
<a href="#l2.3084"></a><span id="l2.3084" class="difflineplus">+      change,</span>
<a href="#l2.3085"></a><span id="l2.3085" class="difflineplus">+      days,</span>
<a href="#l2.3086"></a><span id="l2.3086" class="difflineplus">+      hours,</span>
<a href="#l2.3087"></a><span id="l2.3087" class="difflineplus">+      minutes,</span>
<a href="#l2.3088"></a><span id="l2.3088" class="difflineplus">+      seconds,</span>
<a href="#l2.3089"></a><span id="l2.3089" class="difflineplus">+      change</span>
<a href="#l2.3090"></a><span id="l2.3090" class="difflineplus">+    );</span>
<a href="#l2.3091"></a><span id="l2.3091" class="difflineplus">+  };</span>
<a href="#l2.3092"></a><span id="l2.3092" class="difflineplus">+</span>
<a href="#l2.3093"></a><span id="l2.3093" class="difflineplus">+  ICAL.Timezone._minimumExpansionYear = -1;</span>
<a href="#l2.3094"></a><span id="l2.3094" class="difflineplus">+  ICAL.Timezone.MAX_YEAR = 2035; // TODO this is because of time_t, which we don't need. Still usefull?</span>
<a href="#l2.3095"></a><span id="l2.3095" class="difflineplus">+  ICAL.Timezone.EXTRA_COVERAGE = 5;</span>
<a href="#l2.3096"></a><span id="l2.3096" class="difflineplus">+})();</span>
<a href="#l2.3097"></a><span id="l2.3097" class="difflineplus">+// singleton class to contain timezones.</span>
<a href="#l2.3098"></a><span id="l2.3098" class="difflineplus">+// Right now its all manual registry in the</span>
<a href="#l2.3099"></a><span id="l2.3099" class="difflineplus">+// future we may use this class to download timezone</span>
<a href="#l2.3100"></a><span id="l2.3100" class="difflineplus">+// information or handle loading pre-expanded timezones.</span>
<a href="#l2.3101"></a><span id="l2.3101" class="difflineplus">+ICAL.TimezoneService = (function() {</span>
<a href="#l2.3102"></a><span id="l2.3102" class="difflineplus">+  var zones;</span>
<a href="#l2.3103"></a><span id="l2.3103" class="difflineplus">+</span>
<a href="#l2.3104"></a><span id="l2.3104" class="difflineplus">+  // Using var rather then return so we don't need to name the functions twice.</span>
<a href="#l2.3105"></a><span id="l2.3105" class="difflineplus">+  // TimezoneService#get will appear in profiler, etc...</span>
<a href="#l2.3106"></a><span id="l2.3106" class="difflineplus">+  var TimezoneService = {</span>
<a href="#l2.3107"></a><span id="l2.3107" class="difflineplus">+    reset: function() {</span>
<a href="#l2.3108"></a><span id="l2.3108" class="difflineplus">+      zones = Object.create(null);</span>
<a href="#l2.3109"></a><span id="l2.3109" class="difflineplus">+      var utc = ICAL.Timezone.utcTimezone;</span>
<a href="#l2.3110"></a><span id="l2.3110" class="difflineplus">+</span>
<a href="#l2.3111"></a><span id="l2.3111" class="difflineplus">+      zones.Z = utc;</span>
<a href="#l2.3112"></a><span id="l2.3112" class="difflineplus">+      zones.UTC = utc;</span>
<a href="#l2.3113"></a><span id="l2.3113" class="difflineplus">+      zones.GMT = utc;</span>
<a href="#l2.3114"></a><span id="l2.3114" class="difflineplus">+    },</span>
<a href="#l2.3115"></a><span id="l2.3115" class="difflineplus">+</span>
<a href="#l2.3116"></a><span id="l2.3116" class="difflineplus">+    /**</span>
<a href="#l2.3117"></a><span id="l2.3117" class="difflineplus">+     * Checks if timezone id has been registered.</span>
<a href="#l2.3118"></a><span id="l2.3118" class="difflineplus">+     *</span>
<a href="#l2.3119"></a><span id="l2.3119" class="difflineplus">+     * @param {String} tzid (e.g. America/Los_Angeles).</span>
<a href="#l2.3120"></a><span id="l2.3120" class="difflineplus">+     * @return {Boolean} false when not present.</span>
<a href="#l2.3121"></a><span id="l2.3121" class="difflineplus">+     */</span>
<a href="#l2.3122"></a><span id="l2.3122" class="difflineplus">+    has: function(tzid) {</span>
<a href="#l2.3123"></a><span id="l2.3123" class="difflineplus">+      return !!zones[tzid];</span>
<a href="#l2.3124"></a><span id="l2.3124" class="difflineplus">+    },</span>
<a href="#l2.3125"></a><span id="l2.3125" class="difflineplus">+</span>
<a href="#l2.3126"></a><span id="l2.3126" class="difflineplus">+    /**</span>
<a href="#l2.3127"></a><span id="l2.3127" class="difflineplus">+     * Returns a timezone by its tzid if present.</span>
<a href="#l2.3128"></a><span id="l2.3128" class="difflineplus">+     *</span>
<a href="#l2.3129"></a><span id="l2.3129" class="difflineplus">+     * @param {String} tzid name of timezone (e.g. America/Los_Angeles).</span>
<a href="#l2.3130"></a><span id="l2.3130" class="difflineplus">+     * @return {ICAL.Timezone|Null} zone or null.</span>
<a href="#l2.3131"></a><span id="l2.3131" class="difflineplus">+     */</span>
<a href="#l2.3132"></a><span id="l2.3132" class="difflineplus">+    get: function(tzid) {</span>
<a href="#l2.3133"></a><span id="l2.3133" class="difflineplus">+      return zones[tzid];</span>
<a href="#l2.3134"></a><span id="l2.3134" class="difflineplus">+    },</span>
<a href="#l2.3135"></a><span id="l2.3135" class="difflineplus">+</span>
<a href="#l2.3136"></a><span id="l2.3136" class="difflineplus">+    /**</span>
<a href="#l2.3137"></a><span id="l2.3137" class="difflineplus">+     * Registers a timezone object or component.</span>
<a href="#l2.3138"></a><span id="l2.3138" class="difflineplus">+     *</span>
<a href="#l2.3139"></a><span id="l2.3139" class="difflineplus">+     * @param {String} [name] optional uses timezone.tzid by default.</span>
<a href="#l2.3140"></a><span id="l2.3140" class="difflineplus">+     * @param {ICAL.Component|ICAL.Timezone} zone initialized zone or vtimezone.</span>
<a href="#l2.3141"></a><span id="l2.3141" class="difflineplus">+     */</span>
<a href="#l2.3142"></a><span id="l2.3142" class="difflineplus">+    register: function(name, timezone) {</span>
<a href="#l2.3143"></a><span id="l2.3143" class="difflineplus">+      if (name instanceof ICAL.Component) {</span>
<a href="#l2.3144"></a><span id="l2.3144" class="difflineplus">+        if (name.name === 'vtimezone') {</span>
<a href="#l2.3145"></a><span id="l2.3145" class="difflineplus">+          timezone = new ICAL.Timezone(name);</span>
<a href="#l2.3146"></a><span id="l2.3146" class="difflineplus">+          name = timezone.tzid;</span>
<a href="#l2.3147"></a><span id="l2.3147" class="difflineplus">+        }</span>
<a href="#l2.3148"></a><span id="l2.3148" class="difflineplus">+      }</span>
<a href="#l2.3149"></a><span id="l2.3149" class="difflineplus">+</span>
<a href="#l2.3150"></a><span id="l2.3150" class="difflineplus">+      if (timezone instanceof ICAL.Timezone) {</span>
<a href="#l2.3151"></a><span id="l2.3151" class="difflineplus">+        zones[name] = timezone;</span>
<a href="#l2.3152"></a><span id="l2.3152" class="difflineplus">+      } else {</span>
<a href="#l2.3153"></a><span id="l2.3153" class="difflineplus">+        throw new TypeError('timezone must be ICAL.Timezone or ICAL.Component');</span>
<a href="#l2.3154"></a><span id="l2.3154" class="difflineplus">+      }</span>
<a href="#l2.3155"></a><span id="l2.3155" class="difflineplus">+    },</span>
<a href="#l2.3156"></a><span id="l2.3156" class="difflineplus">+</span>
<a href="#l2.3157"></a><span id="l2.3157" class="difflineplus">+    /**</span>
<a href="#l2.3158"></a><span id="l2.3158" class="difflineplus">+     * Removes a timezone by its tzid from the list.</span>
<a href="#l2.3159"></a><span id="l2.3159" class="difflineplus">+     *</span>
<a href="#l2.3160"></a><span id="l2.3160" class="difflineplus">+     * @param {String} tzid (e.g. America/Los_Angeles).</span>
<a href="#l2.3161"></a><span id="l2.3161" class="difflineplus">+     */</span>
<a href="#l2.3162"></a><span id="l2.3162" class="difflineplus">+    remove: function(tzid) {</span>
<a href="#l2.3163"></a><span id="l2.3163" class="difflineplus">+      return (delete zones[tzid]);</span>
<a href="#l2.3164"></a><span id="l2.3164" class="difflineplus">+    }</span>
<a href="#l2.3165"></a><span id="l2.3165" class="difflineplus">+  };</span>
<a href="#l2.3166"></a><span id="l2.3166" class="difflineplus">+</span>
<a href="#l2.3167"></a><span id="l2.3167" class="difflineplus">+  // initialize defaults</span>
<a href="#l2.3168"></a><span id="l2.3168" class="difflineplus">+  TimezoneService.reset();</span>
<a href="#l2.3169"></a><span id="l2.3169" class="difflineplus">+</span>
<a href="#l2.3170"></a><span id="l2.3170" class="difflineplus">+  return TimezoneService;</span>
<a href="#l2.3171"></a><span id="l2.3171" class="difflineplus">+}());</span>
<a href="#l2.3172"></a><span id="l2.3172" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.3173"></a><span id="l2.3173" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.3174"></a><span id="l2.3174" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.3175"></a><span id="l2.3175" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.3176"></a><span id="l2.3176" class="difflineplus">+</span>
<a href="#l2.3177"></a><span id="l2.3177" class="difflineplus">+</span>
<a href="#l2.3178"></a><span id="l2.3178" class="difflineplus">+</span>
<a href="#l2.3179"></a><span id="l2.3179" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.3180"></a><span id="l2.3180" class="difflineplus">+(function() {</span>
<a href="#l2.3181"></a><span id="l2.3181" class="difflineplus">+</span>
<a href="#l2.3182"></a><span id="l2.3182" class="difflineplus">+  /**</span>
<a href="#l2.3183"></a><span id="l2.3183" class="difflineplus">+   * Time representation (similar to JS Date object).</span>
<a href="#l2.3184"></a><span id="l2.3184" class="difflineplus">+   * Fully independent of system (OS) timezone / time.</span>
<a href="#l2.3185"></a><span id="l2.3185" class="difflineplus">+   * Unlike JS Date month start at 1 (Jan) not zero.</span>
<a href="#l2.3186"></a><span id="l2.3186" class="difflineplus">+   *</span>
<a href="#l2.3187"></a><span id="l2.3187" class="difflineplus">+   *</span>
<a href="#l2.3188"></a><span id="l2.3188" class="difflineplus">+   *    var time = new ICAL.Time({</span>
<a href="#l2.3189"></a><span id="l2.3189" class="difflineplus">+   *      year: 2012,</span>
<a href="#l2.3190"></a><span id="l2.3190" class="difflineplus">+   *      month: 10,</span>
<a href="#l2.3191"></a><span id="l2.3191" class="difflineplus">+   *      day: 11</span>
<a href="#l2.3192"></a><span id="l2.3192" class="difflineplus">+   *      minute: 0,</span>
<a href="#l2.3193"></a><span id="l2.3193" class="difflineplus">+   *      second: 0,</span>
<a href="#l2.3194"></a><span id="l2.3194" class="difflineplus">+   *      isDate: false</span>
<a href="#l2.3195"></a><span id="l2.3195" class="difflineplus">+   *    });</span>
<a href="#l2.3196"></a><span id="l2.3196" class="difflineplus">+   *</span>
<a href="#l2.3197"></a><span id="l2.3197" class="difflineplus">+   *</span>
<a href="#l2.3198"></a><span id="l2.3198" class="difflineplus">+   * @param {Object} data initialization time.</span>
<a href="#l2.3199"></a><span id="l2.3199" class="difflineplus">+   * @param {ICAL.Timezone} zone timezone this position occurs in.</span>
<a href="#l2.3200"></a><span id="l2.3200" class="difflineplus">+   */</span>
<a href="#l2.3201"></a><span id="l2.3201" class="difflineplus">+  ICAL.Time = function icaltime(data, zone) {</span>
<a href="#l2.3202"></a><span id="l2.3202" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l2.3203"></a><span id="l2.3203" class="difflineplus">+    var time = this._time = Object.create(null);</span>
<a href="#l2.3204"></a><span id="l2.3204" class="difflineplus">+</span>
<a href="#l2.3205"></a><span id="l2.3205" class="difflineplus">+    /* time defaults */</span>
<a href="#l2.3206"></a><span id="l2.3206" class="difflineplus">+    time.year = 0;</span>
<a href="#l2.3207"></a><span id="l2.3207" class="difflineplus">+    time.month = 1;</span>
<a href="#l2.3208"></a><span id="l2.3208" class="difflineplus">+    time.day = 1;</span>
<a href="#l2.3209"></a><span id="l2.3209" class="difflineplus">+    time.hour = 0;</span>
<a href="#l2.3210"></a><span id="l2.3210" class="difflineplus">+    time.minute = 0;</span>
<a href="#l2.3211"></a><span id="l2.3211" class="difflineplus">+    time.second = 0;</span>
<a href="#l2.3212"></a><span id="l2.3212" class="difflineplus">+    time.isDate = false;</span>
<a href="#l2.3213"></a><span id="l2.3213" class="difflineplus">+</span>
<a href="#l2.3214"></a><span id="l2.3214" class="difflineplus">+    this.fromData(data, zone);</span>
<a href="#l2.3215"></a><span id="l2.3215" class="difflineplus">+  };</span>
<a href="#l2.3216"></a><span id="l2.3216" class="difflineplus">+</span>
<a href="#l2.3217"></a><span id="l2.3217" class="difflineplus">+  ICAL.Time.prototype = {</span>
<a href="#l2.3218"></a><span id="l2.3218" class="difflineplus">+</span>
<a href="#l2.3219"></a><span id="l2.3219" class="difflineplus">+    icalclass: &quot;icaltime&quot;,</span>
<a href="#l2.3220"></a><span id="l2.3220" class="difflineplus">+    icaltype: &quot;date-time&quot;,</span>
<a href="#l2.3221"></a><span id="l2.3221" class="difflineplus">+</span>
<a href="#l2.3222"></a><span id="l2.3222" class="difflineplus">+    /**</span>
<a href="#l2.3223"></a><span id="l2.3223" class="difflineplus">+     * @type ICAL.Timezone</span>
<a href="#l2.3224"></a><span id="l2.3224" class="difflineplus">+     */</span>
<a href="#l2.3225"></a><span id="l2.3225" class="difflineplus">+    zone: null,</span>
<a href="#l2.3226"></a><span id="l2.3226" class="difflineplus">+</span>
<a href="#l2.3227"></a><span id="l2.3227" class="difflineplus">+    /**</span>
<a href="#l2.3228"></a><span id="l2.3228" class="difflineplus">+     * Internal uses to indicate that a change has been</span>
<a href="#l2.3229"></a><span id="l2.3229" class="difflineplus">+     * made and the next read operation must attempt to</span>
<a href="#l2.3230"></a><span id="l2.3230" class="difflineplus">+     * normalize the value (for example changing the day to 33).</span>
<a href="#l2.3231"></a><span id="l2.3231" class="difflineplus">+     *</span>
<a href="#l2.3232"></a><span id="l2.3232" class="difflineplus">+     * @type Boolean</span>
<a href="#l2.3233"></a><span id="l2.3233" class="difflineplus">+     * @private</span>
<a href="#l2.3234"></a><span id="l2.3234" class="difflineplus">+     */</span>
<a href="#l2.3235"></a><span id="l2.3235" class="difflineplus">+    _pendingNormalization: false,</span>
<a href="#l2.3236"></a><span id="l2.3236" class="difflineplus">+</span>
<a href="#l2.3237"></a><span id="l2.3237" class="difflineplus">+    clone: function icaltime_clone() {</span>
<a href="#l2.3238"></a><span id="l2.3238" class="difflineplus">+      return new ICAL.Time(this._time, this.zone);</span>
<a href="#l2.3239"></a><span id="l2.3239" class="difflineplus">+    },</span>
<a href="#l2.3240"></a><span id="l2.3240" class="difflineplus">+</span>
<a href="#l2.3241"></a><span id="l2.3241" class="difflineplus">+    reset: function icaltime_reset() {</span>
<a href="#l2.3242"></a><span id="l2.3242" class="difflineplus">+      this.fromData(ICAL.Time.epochTime);</span>
<a href="#l2.3243"></a><span id="l2.3243" class="difflineplus">+      this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l2.3244"></a><span id="l2.3244" class="difflineplus">+    },</span>
<a href="#l2.3245"></a><span id="l2.3245" class="difflineplus">+</span>
<a href="#l2.3246"></a><span id="l2.3246" class="difflineplus">+    resetTo: function icaltime_resetTo(year, month, day,</span>
<a href="#l2.3247"></a><span id="l2.3247" class="difflineplus">+                                       hour, minute, second, timezone) {</span>
<a href="#l2.3248"></a><span id="l2.3248" class="difflineplus">+      this.fromData({</span>
<a href="#l2.3249"></a><span id="l2.3249" class="difflineplus">+        year: year,</span>
<a href="#l2.3250"></a><span id="l2.3250" class="difflineplus">+        month: month,</span>
<a href="#l2.3251"></a><span id="l2.3251" class="difflineplus">+        day: day,</span>
<a href="#l2.3252"></a><span id="l2.3252" class="difflineplus">+        hour: hour,</span>
<a href="#l2.3253"></a><span id="l2.3253" class="difflineplus">+        minute: minute,</span>
<a href="#l2.3254"></a><span id="l2.3254" class="difflineplus">+        second: second,</span>
<a href="#l2.3255"></a><span id="l2.3255" class="difflineplus">+        zone: timezone</span>
<a href="#l2.3256"></a><span id="l2.3256" class="difflineplus">+      });</span>
<a href="#l2.3257"></a><span id="l2.3257" class="difflineplus">+    },</span>
<a href="#l2.3258"></a><span id="l2.3258" class="difflineplus">+</span>
<a href="#l2.3259"></a><span id="l2.3259" class="difflineplus">+    fromString: function icaltime_fromString(str) {</span>
<a href="#l2.3260"></a><span id="l2.3260" class="difflineplus">+      var data;</span>
<a href="#l2.3261"></a><span id="l2.3261" class="difflineplus">+      try {</span>
<a href="#l2.3262"></a><span id="l2.3262" class="difflineplus">+        data = ICAL.DecorationParser.parseValue(str, &quot;date&quot;);</span>
<a href="#l2.3263"></a><span id="l2.3263" class="difflineplus">+        data.isDate = true;</span>
<a href="#l2.3264"></a><span id="l2.3264" class="difflineplus">+      } catch (e) {</span>
<a href="#l2.3265"></a><span id="l2.3265" class="difflineplus">+        data = ICAL.DecorationParser.parseValue(str, &quot;date-time&quot;);</span>
<a href="#l2.3266"></a><span id="l2.3266" class="difflineplus">+        data.isDate = false;</span>
<a href="#l2.3267"></a><span id="l2.3267" class="difflineplus">+      }</span>
<a href="#l2.3268"></a><span id="l2.3268" class="difflineplus">+      return this.fromData(data);</span>
<a href="#l2.3269"></a><span id="l2.3269" class="difflineplus">+    },</span>
<a href="#l2.3270"></a><span id="l2.3270" class="difflineplus">+</span>
<a href="#l2.3271"></a><span id="l2.3271" class="difflineplus">+    fromJSDate: function icaltime_fromJSDate(aDate, useUTC) {</span>
<a href="#l2.3272"></a><span id="l2.3272" class="difflineplus">+      if (!aDate) {</span>
<a href="#l2.3273"></a><span id="l2.3273" class="difflineplus">+        this.reset();</span>
<a href="#l2.3274"></a><span id="l2.3274" class="difflineplus">+      } else {</span>
<a href="#l2.3275"></a><span id="l2.3275" class="difflineplus">+        if (useUTC) {</span>
<a href="#l2.3276"></a><span id="l2.3276" class="difflineplus">+          this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l2.3277"></a><span id="l2.3277" class="difflineplus">+          this.year = aDate.getUTCFullYear();</span>
<a href="#l2.3278"></a><span id="l2.3278" class="difflineplus">+          this.month = aDate.getUTCMonth() + 1;</span>
<a href="#l2.3279"></a><span id="l2.3279" class="difflineplus">+          this.day = aDate.getUTCDate();</span>
<a href="#l2.3280"></a><span id="l2.3280" class="difflineplus">+          this.hour = aDate.getUTCHours();</span>
<a href="#l2.3281"></a><span id="l2.3281" class="difflineplus">+          this.minute = aDate.getUTCMinutes();</span>
<a href="#l2.3282"></a><span id="l2.3282" class="difflineplus">+          this.second = aDate.getUTCSeconds();</span>
<a href="#l2.3283"></a><span id="l2.3283" class="difflineplus">+        } else {</span>
<a href="#l2.3284"></a><span id="l2.3284" class="difflineplus">+          this.zone = ICAL.Timezone.localTimezone;</span>
<a href="#l2.3285"></a><span id="l2.3285" class="difflineplus">+          this.year = aDate.getFullYear();</span>
<a href="#l2.3286"></a><span id="l2.3286" class="difflineplus">+          this.month = aDate.getMonth() + 1;</span>
<a href="#l2.3287"></a><span id="l2.3287" class="difflineplus">+          this.day = aDate.getDate();</span>
<a href="#l2.3288"></a><span id="l2.3288" class="difflineplus">+          this.hour = aDate.getHours();</span>
<a href="#l2.3289"></a><span id="l2.3289" class="difflineplus">+          this.minute = aDate.getMinutes();</span>
<a href="#l2.3290"></a><span id="l2.3290" class="difflineplus">+          this.second = aDate.getSeconds();</span>
<a href="#l2.3291"></a><span id="l2.3291" class="difflineplus">+        }</span>
<a href="#l2.3292"></a><span id="l2.3292" class="difflineplus">+      }</span>
<a href="#l2.3293"></a><span id="l2.3293" class="difflineplus">+      return this;</span>
<a href="#l2.3294"></a><span id="l2.3294" class="difflineplus">+    },</span>
<a href="#l2.3295"></a><span id="l2.3295" class="difflineplus">+</span>
<a href="#l2.3296"></a><span id="l2.3296" class="difflineplus">+    fromData: function fromData(aData, aZone) {</span>
<a href="#l2.3297"></a><span id="l2.3297" class="difflineplus">+      for (var key in aData) {</span>
<a href="#l2.3298"></a><span id="l2.3298" class="difflineplus">+        this[key] = aData[key];</span>
<a href="#l2.3299"></a><span id="l2.3299" class="difflineplus">+      }</span>
<a href="#l2.3300"></a><span id="l2.3300" class="difflineplus">+</span>
<a href="#l2.3301"></a><span id="l2.3301" class="difflineplus">+      if (aZone) {</span>
<a href="#l2.3302"></a><span id="l2.3302" class="difflineplus">+        this.zone = aZone;</span>
<a href="#l2.3303"></a><span id="l2.3303" class="difflineplus">+      }</span>
<a href="#l2.3304"></a><span id="l2.3304" class="difflineplus">+</span>
<a href="#l2.3305"></a><span id="l2.3305" class="difflineplus">+      if (aData &amp;&amp; !(&quot;isDate&quot; in aData)) {</span>
<a href="#l2.3306"></a><span id="l2.3306" class="difflineplus">+        this.isDate = !(&quot;hour&quot; in aData);</span>
<a href="#l2.3307"></a><span id="l2.3307" class="difflineplus">+      } else if (aData &amp;&amp; (&quot;isDate&quot; in aData)) {</span>
<a href="#l2.3308"></a><span id="l2.3308" class="difflineplus">+        this.isDate = aData.isDate;</span>
<a href="#l2.3309"></a><span id="l2.3309" class="difflineplus">+      }</span>
<a href="#l2.3310"></a><span id="l2.3310" class="difflineplus">+</span>
<a href="#l2.3311"></a><span id="l2.3311" class="difflineplus">+      if (aData &amp;&amp; &quot;timezone&quot; in aData) {</span>
<a href="#l2.3312"></a><span id="l2.3312" class="difflineplus">+        var zone = ICAL.TimezoneService.get(</span>
<a href="#l2.3313"></a><span id="l2.3313" class="difflineplus">+          aData.timezone</span>
<a href="#l2.3314"></a><span id="l2.3314" class="difflineplus">+        );</span>
<a href="#l2.3315"></a><span id="l2.3315" class="difflineplus">+</span>
<a href="#l2.3316"></a><span id="l2.3316" class="difflineplus">+        this.zone = zone || ICAL.Timezone.localTimezone;</span>
<a href="#l2.3317"></a><span id="l2.3317" class="difflineplus">+      }</span>
<a href="#l2.3318"></a><span id="l2.3318" class="difflineplus">+</span>
<a href="#l2.3319"></a><span id="l2.3319" class="difflineplus">+      if (aData &amp;&amp; &quot;zone&quot; in aData) {</span>
<a href="#l2.3320"></a><span id="l2.3320" class="difflineplus">+        this.zone = aData.zone;</span>
<a href="#l2.3321"></a><span id="l2.3321" class="difflineplus">+      }</span>
<a href="#l2.3322"></a><span id="l2.3322" class="difflineplus">+</span>
<a href="#l2.3323"></a><span id="l2.3323" class="difflineplus">+      if (!this.zone) {</span>
<a href="#l2.3324"></a><span id="l2.3324" class="difflineplus">+        this.zone = ICAL.Timezone.localTimezone;</span>
<a href="#l2.3325"></a><span id="l2.3325" class="difflineplus">+      }</span>
<a href="#l2.3326"></a><span id="l2.3326" class="difflineplus">+</span>
<a href="#l2.3327"></a><span id="l2.3327" class="difflineplus">+      return this;</span>
<a href="#l2.3328"></a><span id="l2.3328" class="difflineplus">+    },</span>
<a href="#l2.3329"></a><span id="l2.3329" class="difflineplus">+</span>
<a href="#l2.3330"></a><span id="l2.3330" class="difflineplus">+    dayOfWeek: function icaltime_dayOfWeek() {</span>
<a href="#l2.3331"></a><span id="l2.3331" class="difflineplus">+      // Using Zeller's algorithm</span>
<a href="#l2.3332"></a><span id="l2.3332" class="difflineplus">+      var q = this.day;</span>
<a href="#l2.3333"></a><span id="l2.3333" class="difflineplus">+      var m = this.month + (this.month &lt; 3 ? 12 : 0);</span>
<a href="#l2.3334"></a><span id="l2.3334" class="difflineplus">+      var Y = this.year - (this.month &lt; 3 ? 1 : 0);</span>
<a href="#l2.3335"></a><span id="l2.3335" class="difflineplus">+</span>
<a href="#l2.3336"></a><span id="l2.3336" class="difflineplus">+      var h = (q + Y + ICAL.helpers.trunc(((m + 1) * 26) / 10) + ICAL.helpers.trunc(Y / 4));</span>
<a href="#l2.3337"></a><span id="l2.3337" class="difflineplus">+      if (true /* gregorian */) {</span>
<a href="#l2.3338"></a><span id="l2.3338" class="difflineplus">+        h += ICAL.helpers.trunc(Y / 100) * 6 + ICAL.helpers.trunc(Y / 400);</span>
<a href="#l2.3339"></a><span id="l2.3339" class="difflineplus">+      } else {</span>
<a href="#l2.3340"></a><span id="l2.3340" class="difflineplus">+        h += 5;</span>
<a href="#l2.3341"></a><span id="l2.3341" class="difflineplus">+      }</span>
<a href="#l2.3342"></a><span id="l2.3342" class="difflineplus">+</span>
<a href="#l2.3343"></a><span id="l2.3343" class="difflineplus">+      // Normalize to 1 = sunday</span>
<a href="#l2.3344"></a><span id="l2.3344" class="difflineplus">+      h = ((h + 6) % 7) + 1;</span>
<a href="#l2.3345"></a><span id="l2.3345" class="difflineplus">+      return h;</span>
<a href="#l2.3346"></a><span id="l2.3346" class="difflineplus">+    },</span>
<a href="#l2.3347"></a><span id="l2.3347" class="difflineplus">+</span>
<a href="#l2.3348"></a><span id="l2.3348" class="difflineplus">+    dayOfYear: function icaltime_dayOfYear() {</span>
<a href="#l2.3349"></a><span id="l2.3349" class="difflineplus">+      var is_leap = (ICAL.Time.is_leap_year(this.year) ? 1 : 0);</span>
<a href="#l2.3350"></a><span id="l2.3350" class="difflineplus">+      var diypm = ICAL.Time._days_in_year_passed_month;</span>
<a href="#l2.3351"></a><span id="l2.3351" class="difflineplus">+      return diypm[is_leap][this.month - 1] + this.day;</span>
<a href="#l2.3352"></a><span id="l2.3352" class="difflineplus">+    },</span>
<a href="#l2.3353"></a><span id="l2.3353" class="difflineplus">+</span>
<a href="#l2.3354"></a><span id="l2.3354" class="difflineplus">+    startOfWeek: function startOfWeek() {</span>
<a href="#l2.3355"></a><span id="l2.3355" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3356"></a><span id="l2.3356" class="difflineplus">+      result.day -= this.dayOfWeek() - 1;</span>
<a href="#l2.3357"></a><span id="l2.3357" class="difflineplus">+      return result;</span>
<a href="#l2.3358"></a><span id="l2.3358" class="difflineplus">+    },</span>
<a href="#l2.3359"></a><span id="l2.3359" class="difflineplus">+</span>
<a href="#l2.3360"></a><span id="l2.3360" class="difflineplus">+    endOfWeek: function endOfWeek() {</span>
<a href="#l2.3361"></a><span id="l2.3361" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3362"></a><span id="l2.3362" class="difflineplus">+      result.day += 7 - this.dayOfWeek();</span>
<a href="#l2.3363"></a><span id="l2.3363" class="difflineplus">+      return result;</span>
<a href="#l2.3364"></a><span id="l2.3364" class="difflineplus">+    },</span>
<a href="#l2.3365"></a><span id="l2.3365" class="difflineplus">+</span>
<a href="#l2.3366"></a><span id="l2.3366" class="difflineplus">+    startOfMonth: function startOfMonth() {</span>
<a href="#l2.3367"></a><span id="l2.3367" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3368"></a><span id="l2.3368" class="difflineplus">+      result.day = 1;</span>
<a href="#l2.3369"></a><span id="l2.3369" class="difflineplus">+      result.isDate = true;</span>
<a href="#l2.3370"></a><span id="l2.3370" class="difflineplus">+      result.hour = 0;</span>
<a href="#l2.3371"></a><span id="l2.3371" class="difflineplus">+      result.minute = 0;</span>
<a href="#l2.3372"></a><span id="l2.3372" class="difflineplus">+      result.second = 0;</span>
<a href="#l2.3373"></a><span id="l2.3373" class="difflineplus">+      return result;</span>
<a href="#l2.3374"></a><span id="l2.3374" class="difflineplus">+    },</span>
<a href="#l2.3375"></a><span id="l2.3375" class="difflineplus">+</span>
<a href="#l2.3376"></a><span id="l2.3376" class="difflineplus">+    endOfMonth: function endOfMonth() {</span>
<a href="#l2.3377"></a><span id="l2.3377" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3378"></a><span id="l2.3378" class="difflineplus">+      result.day = ICAL.Time.daysInMonth(result.month, result.year);</span>
<a href="#l2.3379"></a><span id="l2.3379" class="difflineplus">+      result.isDate = true;</span>
<a href="#l2.3380"></a><span id="l2.3380" class="difflineplus">+      result.hour = 0;</span>
<a href="#l2.3381"></a><span id="l2.3381" class="difflineplus">+      result.minute = 0;</span>
<a href="#l2.3382"></a><span id="l2.3382" class="difflineplus">+      result.second = 0;</span>
<a href="#l2.3383"></a><span id="l2.3383" class="difflineplus">+      return result;</span>
<a href="#l2.3384"></a><span id="l2.3384" class="difflineplus">+    },</span>
<a href="#l2.3385"></a><span id="l2.3385" class="difflineplus">+</span>
<a href="#l2.3386"></a><span id="l2.3386" class="difflineplus">+    startOfYear: function startOfYear() {</span>
<a href="#l2.3387"></a><span id="l2.3387" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3388"></a><span id="l2.3388" class="difflineplus">+      result.day = 1;</span>
<a href="#l2.3389"></a><span id="l2.3389" class="difflineplus">+      result.month = 1;</span>
<a href="#l2.3390"></a><span id="l2.3390" class="difflineplus">+      result.isDate = true;</span>
<a href="#l2.3391"></a><span id="l2.3391" class="difflineplus">+      result.hour = 0;</span>
<a href="#l2.3392"></a><span id="l2.3392" class="difflineplus">+      result.minute = 0;</span>
<a href="#l2.3393"></a><span id="l2.3393" class="difflineplus">+      result.second = 0;</span>
<a href="#l2.3394"></a><span id="l2.3394" class="difflineplus">+      return result;</span>
<a href="#l2.3395"></a><span id="l2.3395" class="difflineplus">+    },</span>
<a href="#l2.3396"></a><span id="l2.3396" class="difflineplus">+</span>
<a href="#l2.3397"></a><span id="l2.3397" class="difflineplus">+    endOfYear: function endOfYear() {</span>
<a href="#l2.3398"></a><span id="l2.3398" class="difflineplus">+      var result = this.clone();</span>
<a href="#l2.3399"></a><span id="l2.3399" class="difflineplus">+      result.day = 31;</span>
<a href="#l2.3400"></a><span id="l2.3400" class="difflineplus">+      result.month = 12;</span>
<a href="#l2.3401"></a><span id="l2.3401" class="difflineplus">+      result.isDate = true;</span>
<a href="#l2.3402"></a><span id="l2.3402" class="difflineplus">+      result.hour = 0;</span>
<a href="#l2.3403"></a><span id="l2.3403" class="difflineplus">+      result.minute = 0;</span>
<a href="#l2.3404"></a><span id="l2.3404" class="difflineplus">+      result.second = 0;</span>
<a href="#l2.3405"></a><span id="l2.3405" class="difflineplus">+      return result;</span>
<a href="#l2.3406"></a><span id="l2.3406" class="difflineplus">+    },</span>
<a href="#l2.3407"></a><span id="l2.3407" class="difflineplus">+</span>
<a href="#l2.3408"></a><span id="l2.3408" class="difflineplus">+    startDoyWeek: function startDoyWeek(aFirstDayOfWeek) {</span>
<a href="#l2.3409"></a><span id="l2.3409" class="difflineplus">+      var firstDow = aFirstDayOfWeek || ICAL.Time.SUNDAY;</span>
<a href="#l2.3410"></a><span id="l2.3410" class="difflineplus">+      var delta = this.dayOfWeek() - firstDow;</span>
<a href="#l2.3411"></a><span id="l2.3411" class="difflineplus">+      if (delta &lt; 0) delta += 7;</span>
<a href="#l2.3412"></a><span id="l2.3412" class="difflineplus">+      return this.dayOfYear() - delta;</span>
<a href="#l2.3413"></a><span id="l2.3413" class="difflineplus">+    },</span>
<a href="#l2.3414"></a><span id="l2.3414" class="difflineplus">+</span>
<a href="#l2.3415"></a><span id="l2.3415" class="difflineplus">+    /**</span>
<a href="#l2.3416"></a><span id="l2.3416" class="difflineplus">+     * Finds the nthWeekDay relative to the current month (not day).</span>
<a href="#l2.3417"></a><span id="l2.3417" class="difflineplus">+     * The returned value is a day relative the month that this</span>
<a href="#l2.3418"></a><span id="l2.3418" class="difflineplus">+     * month belongs to so 1 would indicate the first of the month</span>
<a href="#l2.3419"></a><span id="l2.3419" class="difflineplus">+     * and 40 would indicate a day in the following month.</span>
<a href="#l2.3420"></a><span id="l2.3420" class="difflineplus">+     *</span>
<a href="#l2.3421"></a><span id="l2.3421" class="difflineplus">+     * @param {Numeric} aDayOfWeek day of the week see the day name constants.</span>
<a href="#l2.3422"></a><span id="l2.3422" class="difflineplus">+     * @param {Numeric} aPos nth occurrence of a given week day</span>
<a href="#l2.3423"></a><span id="l2.3423" class="difflineplus">+     *                       values of 1 and 0 both indicate the first</span>
<a href="#l2.3424"></a><span id="l2.3424" class="difflineplus">+     *                       weekday of that type. aPos may be either positive</span>
<a href="#l2.3425"></a><span id="l2.3425" class="difflineplus">+     *                       or negative.</span>
<a href="#l2.3426"></a><span id="l2.3426" class="difflineplus">+     *</span>
<a href="#l2.3427"></a><span id="l2.3427" class="difflineplus">+     * @return {Numeric} numeric value indicating a day relative</span>
<a href="#l2.3428"></a><span id="l2.3428" class="difflineplus">+     *                   to the current month of this time object.</span>
<a href="#l2.3429"></a><span id="l2.3429" class="difflineplus">+     */</span>
<a href="#l2.3430"></a><span id="l2.3430" class="difflineplus">+    nthWeekDay: function icaltime_nthWeekDay(aDayOfWeek, aPos) {</span>
<a href="#l2.3431"></a><span id="l2.3431" class="difflineplus">+      var daysInMonth = ICAL.Time.daysInMonth(this.month, this.year);</span>
<a href="#l2.3432"></a><span id="l2.3432" class="difflineplus">+      var weekday;</span>
<a href="#l2.3433"></a><span id="l2.3433" class="difflineplus">+      var pos = aPos;</span>
<a href="#l2.3434"></a><span id="l2.3434" class="difflineplus">+</span>
<a href="#l2.3435"></a><span id="l2.3435" class="difflineplus">+      var start = 0;</span>
<a href="#l2.3436"></a><span id="l2.3436" class="difflineplus">+</span>
<a href="#l2.3437"></a><span id="l2.3437" class="difflineplus">+      var otherDay = this.clone();</span>
<a href="#l2.3438"></a><span id="l2.3438" class="difflineplus">+</span>
<a href="#l2.3439"></a><span id="l2.3439" class="difflineplus">+      if (pos &gt;= 0) {</span>
<a href="#l2.3440"></a><span id="l2.3440" class="difflineplus">+        otherDay.day = 1;</span>
<a href="#l2.3441"></a><span id="l2.3441" class="difflineplus">+</span>
<a href="#l2.3442"></a><span id="l2.3442" class="difflineplus">+        // because 0 means no position has been given</span>
<a href="#l2.3443"></a><span id="l2.3443" class="difflineplus">+        // 1 and 0 indicate the same day.</span>
<a href="#l2.3444"></a><span id="l2.3444" class="difflineplus">+        if (pos != 0) {</span>
<a href="#l2.3445"></a><span id="l2.3445" class="difflineplus">+          // remove the extra numeric value</span>
<a href="#l2.3446"></a><span id="l2.3446" class="difflineplus">+          pos--;</span>
<a href="#l2.3447"></a><span id="l2.3447" class="difflineplus">+        }</span>
<a href="#l2.3448"></a><span id="l2.3448" class="difflineplus">+</span>
<a href="#l2.3449"></a><span id="l2.3449" class="difflineplus">+        // set current start offset to current day.</span>
<a href="#l2.3450"></a><span id="l2.3450" class="difflineplus">+        start = otherDay.day;</span>
<a href="#l2.3451"></a><span id="l2.3451" class="difflineplus">+</span>
<a href="#l2.3452"></a><span id="l2.3452" class="difflineplus">+        // find the current day of week</span>
<a href="#l2.3453"></a><span id="l2.3453" class="difflineplus">+        var startDow = otherDay.dayOfWeek();</span>
<a href="#l2.3454"></a><span id="l2.3454" class="difflineplus">+</span>
<a href="#l2.3455"></a><span id="l2.3455" class="difflineplus">+        // calculate the difference between current</span>
<a href="#l2.3456"></a><span id="l2.3456" class="difflineplus">+        // day of the week and desired day of the week</span>
<a href="#l2.3457"></a><span id="l2.3457" class="difflineplus">+        var offset = aDayOfWeek - startDow;</span>
<a href="#l2.3458"></a><span id="l2.3458" class="difflineplus">+</span>
<a href="#l2.3459"></a><span id="l2.3459" class="difflineplus">+</span>
<a href="#l2.3460"></a><span id="l2.3460" class="difflineplus">+        // if the offset goes into the past</span>
<a href="#l2.3461"></a><span id="l2.3461" class="difflineplus">+        // week we add 7 so its goes into the next</span>
<a href="#l2.3462"></a><span id="l2.3462" class="difflineplus">+        // week. We only want to go forward in time here.</span>
<a href="#l2.3463"></a><span id="l2.3463" class="difflineplus">+        if (offset &lt; 0)</span>
<a href="#l2.3464"></a><span id="l2.3464" class="difflineplus">+          // this is really important otherwise we would</span>
<a href="#l2.3465"></a><span id="l2.3465" class="difflineplus">+          // end up with dates from in the past.</span>
<a href="#l2.3466"></a><span id="l2.3466" class="difflineplus">+          offset += 7;</span>
<a href="#l2.3467"></a><span id="l2.3467" class="difflineplus">+</span>
<a href="#l2.3468"></a><span id="l2.3468" class="difflineplus">+        // add offset to start so start is the same</span>
<a href="#l2.3469"></a><span id="l2.3469" class="difflineplus">+        // day of the week as the desired day of week.</span>
<a href="#l2.3470"></a><span id="l2.3470" class="difflineplus">+        start += offset;</span>
<a href="#l2.3471"></a><span id="l2.3471" class="difflineplus">+</span>
<a href="#l2.3472"></a><span id="l2.3472" class="difflineplus">+        // because we are going to add (and multiply)</span>
<a href="#l2.3473"></a><span id="l2.3473" class="difflineplus">+        // the numeric value of the day we subtract it</span>
<a href="#l2.3474"></a><span id="l2.3474" class="difflineplus">+        // from the start position so not to add it twice.</span>
<a href="#l2.3475"></a><span id="l2.3475" class="difflineplus">+        start -= aDayOfWeek;</span>
<a href="#l2.3476"></a><span id="l2.3476" class="difflineplus">+</span>
<a href="#l2.3477"></a><span id="l2.3477" class="difflineplus">+        // set week day</span>
<a href="#l2.3478"></a><span id="l2.3478" class="difflineplus">+        weekday = aDayOfWeek;</span>
<a href="#l2.3479"></a><span id="l2.3479" class="difflineplus">+      } else {</span>
<a href="#l2.3480"></a><span id="l2.3480" class="difflineplus">+</span>
<a href="#l2.3481"></a><span id="l2.3481" class="difflineplus">+        // then we set it to the last day in the current month</span>
<a href="#l2.3482"></a><span id="l2.3482" class="difflineplus">+        otherDay.day = daysInMonth;</span>
<a href="#l2.3483"></a><span id="l2.3483" class="difflineplus">+</span>
<a href="#l2.3484"></a><span id="l2.3484" class="difflineplus">+        // find the ends weekday</span>
<a href="#l2.3485"></a><span id="l2.3485" class="difflineplus">+        var endDow = otherDay.dayOfWeek();</span>
<a href="#l2.3486"></a><span id="l2.3486" class="difflineplus">+</span>
<a href="#l2.3487"></a><span id="l2.3487" class="difflineplus">+        pos++;</span>
<a href="#l2.3488"></a><span id="l2.3488" class="difflineplus">+</span>
<a href="#l2.3489"></a><span id="l2.3489" class="difflineplus">+        weekday = (endDow - aDayOfWeek);</span>
<a href="#l2.3490"></a><span id="l2.3490" class="difflineplus">+</span>
<a href="#l2.3491"></a><span id="l2.3491" class="difflineplus">+        if (weekday &lt; 0) {</span>
<a href="#l2.3492"></a><span id="l2.3492" class="difflineplus">+          weekday += 7;</span>
<a href="#l2.3493"></a><span id="l2.3493" class="difflineplus">+        }</span>
<a href="#l2.3494"></a><span id="l2.3494" class="difflineplus">+</span>
<a href="#l2.3495"></a><span id="l2.3495" class="difflineplus">+        weekday = daysInMonth - weekday;</span>
<a href="#l2.3496"></a><span id="l2.3496" class="difflineplus">+      }</span>
<a href="#l2.3497"></a><span id="l2.3497" class="difflineplus">+</span>
<a href="#l2.3498"></a><span id="l2.3498" class="difflineplus">+      weekday += pos * 7;</span>
<a href="#l2.3499"></a><span id="l2.3499" class="difflineplus">+</span>
<a href="#l2.3500"></a><span id="l2.3500" class="difflineplus">+      return start + weekday;</span>
<a href="#l2.3501"></a><span id="l2.3501" class="difflineplus">+    },</span>
<a href="#l2.3502"></a><span id="l2.3502" class="difflineplus">+</span>
<a href="#l2.3503"></a><span id="l2.3503" class="difflineplus">+    /**</span>
<a href="#l2.3504"></a><span id="l2.3504" class="difflineplus">+     * Checks if current time is the nthWeekDay.</span>
<a href="#l2.3505"></a><span id="l2.3505" class="difflineplus">+     * Relative to the current month.</span>
<a href="#l2.3506"></a><span id="l2.3506" class="difflineplus">+     *</span>
<a href="#l2.3507"></a><span id="l2.3507" class="difflineplus">+     * Will always return false when rule resolves</span>
<a href="#l2.3508"></a><span id="l2.3508" class="difflineplus">+     * outside of current month.</span>
<a href="#l2.3509"></a><span id="l2.3509" class="difflineplus">+     *</span>
<a href="#l2.3510"></a><span id="l2.3510" class="difflineplus">+     * @param {Numeric} aDayOfWeek day of week.</span>
<a href="#l2.3511"></a><span id="l2.3511" class="difflineplus">+     * @param {Numeric} aPos position.</span>
<a href="#l2.3512"></a><span id="l2.3512" class="difflineplus">+     * @param {Numeric} aMax maximum valid day.</span>
<a href="#l2.3513"></a><span id="l2.3513" class="difflineplus">+     */</span>
<a href="#l2.3514"></a><span id="l2.3514" class="difflineplus">+    isNthWeekDay: function(aDayOfWeek, aPos) {</span>
<a href="#l2.3515"></a><span id="l2.3515" class="difflineplus">+      var dow = this.dayOfWeek();</span>
<a href="#l2.3516"></a><span id="l2.3516" class="difflineplus">+</span>
<a href="#l2.3517"></a><span id="l2.3517" class="difflineplus">+      if (aPos === 0 &amp;&amp; dow === aDayOfWeek) {</span>
<a href="#l2.3518"></a><span id="l2.3518" class="difflineplus">+        return true;</span>
<a href="#l2.3519"></a><span id="l2.3519" class="difflineplus">+      }</span>
<a href="#l2.3520"></a><span id="l2.3520" class="difflineplus">+</span>
<a href="#l2.3521"></a><span id="l2.3521" class="difflineplus">+      // get pos</span>
<a href="#l2.3522"></a><span id="l2.3522" class="difflineplus">+      var day = this.nthWeekDay(aDayOfWeek, aPos);</span>
<a href="#l2.3523"></a><span id="l2.3523" class="difflineplus">+</span>
<a href="#l2.3524"></a><span id="l2.3524" class="difflineplus">+      if (day === this.day) {</span>
<a href="#l2.3525"></a><span id="l2.3525" class="difflineplus">+        return true;</span>
<a href="#l2.3526"></a><span id="l2.3526" class="difflineplus">+      }</span>
<a href="#l2.3527"></a><span id="l2.3527" class="difflineplus">+</span>
<a href="#l2.3528"></a><span id="l2.3528" class="difflineplus">+      return false;</span>
<a href="#l2.3529"></a><span id="l2.3529" class="difflineplus">+    },</span>
<a href="#l2.3530"></a><span id="l2.3530" class="difflineplus">+</span>
<a href="#l2.3531"></a><span id="l2.3531" class="difflineplus">+    weekNumber: function weekNumber(aWeekStart) {</span>
<a href="#l2.3532"></a><span id="l2.3532" class="difflineplus">+      // This function courtesty of Julian Bucknall, published under the MIT license</span>
<a href="#l2.3533"></a><span id="l2.3533" class="difflineplus">+      // http://www.boyet.com/articles/publishedarticles/calculatingtheisoweeknumb.html</span>
<a href="#l2.3534"></a><span id="l2.3534" class="difflineplus">+      var doy = this.dayOfYear();</span>
<a href="#l2.3535"></a><span id="l2.3535" class="difflineplus">+      var dow = this.dayOfWeek();</span>
<a href="#l2.3536"></a><span id="l2.3536" class="difflineplus">+      var year = this.year;</span>
<a href="#l2.3537"></a><span id="l2.3537" class="difflineplus">+      var week1;</span>
<a href="#l2.3538"></a><span id="l2.3538" class="difflineplus">+</span>
<a href="#l2.3539"></a><span id="l2.3539" class="difflineplus">+      var dt = this.clone();</span>
<a href="#l2.3540"></a><span id="l2.3540" class="difflineplus">+      dt.isDate = true;</span>
<a href="#l2.3541"></a><span id="l2.3541" class="difflineplus">+      var first_dow = dt.dayOfWeek();</span>
<a href="#l2.3542"></a><span id="l2.3542" class="difflineplus">+      var isoyear = this.year;</span>
<a href="#l2.3543"></a><span id="l2.3543" class="difflineplus">+</span>
<a href="#l2.3544"></a><span id="l2.3544" class="difflineplus">+      if (dt.month == 12 &amp;&amp; dt.day &gt; 28) {</span>
<a href="#l2.3545"></a><span id="l2.3545" class="difflineplus">+        week1 = ICAL.Time.weekOneStarts(isoyear + 1, aWeekStart);</span>
<a href="#l2.3546"></a><span id="l2.3546" class="difflineplus">+        if (dt.compare(week1) &lt; 0) {</span>
<a href="#l2.3547"></a><span id="l2.3547" class="difflineplus">+          week1 = ICAL.Time.weekOneStarts(isoyear, aWeekStart);</span>
<a href="#l2.3548"></a><span id="l2.3548" class="difflineplus">+        } else {</span>
<a href="#l2.3549"></a><span id="l2.3549" class="difflineplus">+          isoyear++;</span>
<a href="#l2.3550"></a><span id="l2.3550" class="difflineplus">+        }</span>
<a href="#l2.3551"></a><span id="l2.3551" class="difflineplus">+      } else {</span>
<a href="#l2.3552"></a><span id="l2.3552" class="difflineplus">+        week1 = ICAL.Time.weekOneStarts(isoyear, aWeekStart);</span>
<a href="#l2.3553"></a><span id="l2.3553" class="difflineplus">+        if (dt.compare(week1) &lt; 0) {</span>
<a href="#l2.3554"></a><span id="l2.3554" class="difflineplus">+          week1 = ICAL.Time.weekOneStarts(--isoyear, aWeekStart);</span>
<a href="#l2.3555"></a><span id="l2.3555" class="difflineplus">+        }</span>
<a href="#l2.3556"></a><span id="l2.3556" class="difflineplus">+      }</span>
<a href="#l2.3557"></a><span id="l2.3557" class="difflineplus">+</span>
<a href="#l2.3558"></a><span id="l2.3558" class="difflineplus">+      var daysBetween = (dt.subtractDate(week1).toSeconds() / 86400);</span>
<a href="#l2.3559"></a><span id="l2.3559" class="difflineplus">+      return ICAL.helpers.trunc(daysBetween / 7) + 1;</span>
<a href="#l2.3560"></a><span id="l2.3560" class="difflineplus">+    },</span>
<a href="#l2.3561"></a><span id="l2.3561" class="difflineplus">+</span>
<a href="#l2.3562"></a><span id="l2.3562" class="difflineplus">+    addDuration: function icaltime_add(aDuration) {</span>
<a href="#l2.3563"></a><span id="l2.3563" class="difflineplus">+      var mult = (aDuration.isNegative ? -1 : 1);</span>
<a href="#l2.3564"></a><span id="l2.3564" class="difflineplus">+</span>
<a href="#l2.3565"></a><span id="l2.3565" class="difflineplus">+      // because of the duration optimizations it is much</span>
<a href="#l2.3566"></a><span id="l2.3566" class="difflineplus">+      // more efficient to grab all the values up front</span>
<a href="#l2.3567"></a><span id="l2.3567" class="difflineplus">+      // then set them directly (which will avoid a normalization call).</span>
<a href="#l2.3568"></a><span id="l2.3568" class="difflineplus">+      // So we don't actually normalize until we need it.</span>
<a href="#l2.3569"></a><span id="l2.3569" class="difflineplus">+      var second = this.second;</span>
<a href="#l2.3570"></a><span id="l2.3570" class="difflineplus">+      var minute = this.minute;</span>
<a href="#l2.3571"></a><span id="l2.3571" class="difflineplus">+      var hour = this.hour;</span>
<a href="#l2.3572"></a><span id="l2.3572" class="difflineplus">+      var day = this.day;</span>
<a href="#l2.3573"></a><span id="l2.3573" class="difflineplus">+</span>
<a href="#l2.3574"></a><span id="l2.3574" class="difflineplus">+      second += mult * aDuration.seconds;</span>
<a href="#l2.3575"></a><span id="l2.3575" class="difflineplus">+      minute += mult * aDuration.minutes;</span>
<a href="#l2.3576"></a><span id="l2.3576" class="difflineplus">+      hour += mult * aDuration.hours;</span>
<a href="#l2.3577"></a><span id="l2.3577" class="difflineplus">+      day += mult * aDuration.days;</span>
<a href="#l2.3578"></a><span id="l2.3578" class="difflineplus">+      day += mult * 7 * aDuration.weeks;</span>
<a href="#l2.3579"></a><span id="l2.3579" class="difflineplus">+</span>
<a href="#l2.3580"></a><span id="l2.3580" class="difflineplus">+      this.second = second;</span>
<a href="#l2.3581"></a><span id="l2.3581" class="difflineplus">+      this.minute = minute;</span>
<a href="#l2.3582"></a><span id="l2.3582" class="difflineplus">+      this.hour = hour;</span>
<a href="#l2.3583"></a><span id="l2.3583" class="difflineplus">+      this.day = day;</span>
<a href="#l2.3584"></a><span id="l2.3584" class="difflineplus">+    },</span>
<a href="#l2.3585"></a><span id="l2.3585" class="difflineplus">+</span>
<a href="#l2.3586"></a><span id="l2.3586" class="difflineplus">+    /**</span>
<a href="#l2.3587"></a><span id="l2.3587" class="difflineplus">+     * Subtract the date details (_excluding_ timezone).</span>
<a href="#l2.3588"></a><span id="l2.3588" class="difflineplus">+     * Useful for finding the relative difference between</span>
<a href="#l2.3589"></a><span id="l2.3589" class="difflineplus">+     * two time objects excluding their timezone differences.</span>
<a href="#l2.3590"></a><span id="l2.3590" class="difflineplus">+     *</span>
<a href="#l2.3591"></a><span id="l2.3591" class="difflineplus">+     * @return {ICAL.Duration} difference in duration.</span>
<a href="#l2.3592"></a><span id="l2.3592" class="difflineplus">+     */</span>
<a href="#l2.3593"></a><span id="l2.3593" class="difflineplus">+    subtractDate: function icaltime_subtract(aDate) {</span>
<a href="#l2.3594"></a><span id="l2.3594" class="difflineplus">+      var unixTime = this.toUnixTime();</span>
<a href="#l2.3595"></a><span id="l2.3595" class="difflineplus">+      var other = aDate.toUnixTime();</span>
<a href="#l2.3596"></a><span id="l2.3596" class="difflineplus">+      var diff = (unixTime - other);</span>
<a href="#l2.3597"></a><span id="l2.3597" class="difflineplus">+</span>
<a href="#l2.3598"></a><span id="l2.3598" class="difflineplus">+      return ICAL.Duration.fromSeconds(</span>
<a href="#l2.3599"></a><span id="l2.3599" class="difflineplus">+        diff</span>
<a href="#l2.3600"></a><span id="l2.3600" class="difflineplus">+      );</span>
<a href="#l2.3601"></a><span id="l2.3601" class="difflineplus">+    },</span>
<a href="#l2.3602"></a><span id="l2.3602" class="difflineplus">+</span>
<a href="#l2.3603"></a><span id="l2.3603" class="difflineplus">+    compare: function icaltime_compare(other) {</span>
<a href="#l2.3604"></a><span id="l2.3604" class="difflineplus">+      var a = this.toUnixTime();</span>
<a href="#l2.3605"></a><span id="l2.3605" class="difflineplus">+      var b = other.toUnixTime();</span>
<a href="#l2.3606"></a><span id="l2.3606" class="difflineplus">+</span>
<a href="#l2.3607"></a><span id="l2.3607" class="difflineplus">+      if (a &gt; b) return 1;</span>
<a href="#l2.3608"></a><span id="l2.3608" class="difflineplus">+      if (b &gt; a) return -1;</span>
<a href="#l2.3609"></a><span id="l2.3609" class="difflineplus">+      return 0;</span>
<a href="#l2.3610"></a><span id="l2.3610" class="difflineplus">+    },</span>
<a href="#l2.3611"></a><span id="l2.3611" class="difflineplus">+</span>
<a href="#l2.3612"></a><span id="l2.3612" class="difflineplus">+    compareDateOnlyTz: function icaltime_compareDateOnlyTz(other, tz) {</span>
<a href="#l2.3613"></a><span id="l2.3613" class="difflineplus">+      function cmp(attr) {</span>
<a href="#l2.3614"></a><span id="l2.3614" class="difflineplus">+        return ICAL.Time._cmp_attr(a, b, attr);</span>
<a href="#l2.3615"></a><span id="l2.3615" class="difflineplus">+      }</span>
<a href="#l2.3616"></a><span id="l2.3616" class="difflineplus">+      var a = this.convertToZone(tz);</span>
<a href="#l2.3617"></a><span id="l2.3617" class="difflineplus">+      var b = other.convertToZone(tz);</span>
<a href="#l2.3618"></a><span id="l2.3618" class="difflineplus">+      var rc = 0;</span>
<a href="#l2.3619"></a><span id="l2.3619" class="difflineplus">+</span>
<a href="#l2.3620"></a><span id="l2.3620" class="difflineplus">+      if ((rc = cmp(&quot;year&quot;)) != 0) return rc;</span>
<a href="#l2.3621"></a><span id="l2.3621" class="difflineplus">+      if ((rc = cmp(&quot;month&quot;)) != 0) return rc;</span>
<a href="#l2.3622"></a><span id="l2.3622" class="difflineplus">+      if ((rc = cmp(&quot;day&quot;)) != 0) return rc;</span>
<a href="#l2.3623"></a><span id="l2.3623" class="difflineplus">+</span>
<a href="#l2.3624"></a><span id="l2.3624" class="difflineplus">+      return rc;</span>
<a href="#l2.3625"></a><span id="l2.3625" class="difflineplus">+    },</span>
<a href="#l2.3626"></a><span id="l2.3626" class="difflineplus">+</span>
<a href="#l2.3627"></a><span id="l2.3627" class="difflineplus">+    convertToZone: function convertToZone(zone) {</span>
<a href="#l2.3628"></a><span id="l2.3628" class="difflineplus">+      var copy = this.clone();</span>
<a href="#l2.3629"></a><span id="l2.3629" class="difflineplus">+      var zone_equals = (this.zone.tzid == zone.tzid);</span>
<a href="#l2.3630"></a><span id="l2.3630" class="difflineplus">+</span>
<a href="#l2.3631"></a><span id="l2.3631" class="difflineplus">+      if (!this.isDate &amp;&amp; !zone_equals) {</span>
<a href="#l2.3632"></a><span id="l2.3632" class="difflineplus">+        ICAL.Timezone.convert_time(copy, this.zone, zone);</span>
<a href="#l2.3633"></a><span id="l2.3633" class="difflineplus">+      }</span>
<a href="#l2.3634"></a><span id="l2.3634" class="difflineplus">+</span>
<a href="#l2.3635"></a><span id="l2.3635" class="difflineplus">+      copy.zone = zone;</span>
<a href="#l2.3636"></a><span id="l2.3636" class="difflineplus">+      return copy;</span>
<a href="#l2.3637"></a><span id="l2.3637" class="difflineplus">+    },</span>
<a href="#l2.3638"></a><span id="l2.3638" class="difflineplus">+</span>
<a href="#l2.3639"></a><span id="l2.3639" class="difflineplus">+    utcOffset: function utc_offset() {</span>
<a href="#l2.3640"></a><span id="l2.3640" class="difflineplus">+      if (this.zone == ICAL.Timezone.localTimezone ||</span>
<a href="#l2.3641"></a><span id="l2.3641" class="difflineplus">+          this.zone == ICAL.Timezone.utcTimezone) {</span>
<a href="#l2.3642"></a><span id="l2.3642" class="difflineplus">+        return 0;</span>
<a href="#l2.3643"></a><span id="l2.3643" class="difflineplus">+      } else {</span>
<a href="#l2.3644"></a><span id="l2.3644" class="difflineplus">+        return this.zone.utcOffset(this);</span>
<a href="#l2.3645"></a><span id="l2.3645" class="difflineplus">+      }</span>
<a href="#l2.3646"></a><span id="l2.3646" class="difflineplus">+    },</span>
<a href="#l2.3647"></a><span id="l2.3647" class="difflineplus">+</span>
<a href="#l2.3648"></a><span id="l2.3648" class="difflineplus">+    /**</span>
<a href="#l2.3649"></a><span id="l2.3649" class="difflineplus">+     * Returns an RFC 5455 compliant ical representation of this object.</span>
<a href="#l2.3650"></a><span id="l2.3650" class="difflineplus">+     *</span>
<a href="#l2.3651"></a><span id="l2.3651" class="difflineplus">+     * @return {String} ical date/date-time.</span>
<a href="#l2.3652"></a><span id="l2.3652" class="difflineplus">+     */</span>
<a href="#l2.3653"></a><span id="l2.3653" class="difflineplus">+    toICALString: function() {</span>
<a href="#l2.3654"></a><span id="l2.3654" class="difflineplus">+      var string = this.toString();</span>
<a href="#l2.3655"></a><span id="l2.3655" class="difflineplus">+</span>
<a href="#l2.3656"></a><span id="l2.3656" class="difflineplus">+      if (string.length &gt; 10) {</span>
<a href="#l2.3657"></a><span id="l2.3657" class="difflineplus">+        return ICAL.design.value['date-time'].toICAL(string);</span>
<a href="#l2.3658"></a><span id="l2.3658" class="difflineplus">+      } else {</span>
<a href="#l2.3659"></a><span id="l2.3659" class="difflineplus">+        return ICAL.design.value.date.toICAL(string);</span>
<a href="#l2.3660"></a><span id="l2.3660" class="difflineplus">+      }</span>
<a href="#l2.3661"></a><span id="l2.3661" class="difflineplus">+    },</span>
<a href="#l2.3662"></a><span id="l2.3662" class="difflineplus">+</span>
<a href="#l2.3663"></a><span id="l2.3663" class="difflineplus">+    toString: function toString() {</span>
<a href="#l2.3664"></a><span id="l2.3664" class="difflineplus">+      var result = this.year + '-' +</span>
<a href="#l2.3665"></a><span id="l2.3665" class="difflineplus">+                   ICAL.helpers.pad2(this.month) + '-' +</span>
<a href="#l2.3666"></a><span id="l2.3666" class="difflineplus">+                   ICAL.helpers.pad2(this.day);</span>
<a href="#l2.3667"></a><span id="l2.3667" class="difflineplus">+</span>
<a href="#l2.3668"></a><span id="l2.3668" class="difflineplus">+      if (!this.isDate) {</span>
<a href="#l2.3669"></a><span id="l2.3669" class="difflineplus">+          result += 'T' + ICAL.helpers.pad2(this.hour) + ':' +</span>
<a href="#l2.3670"></a><span id="l2.3670" class="difflineplus">+                    ICAL.helpers.pad2(this.minute) + ':' +</span>
<a href="#l2.3671"></a><span id="l2.3671" class="difflineplus">+                    ICAL.helpers.pad2(this.second);</span>
<a href="#l2.3672"></a><span id="l2.3672" class="difflineplus">+</span>
<a href="#l2.3673"></a><span id="l2.3673" class="difflineplus">+        if (this.zone === ICAL.Timezone.utcTimezone) {</span>
<a href="#l2.3674"></a><span id="l2.3674" class="difflineplus">+          result += 'Z';</span>
<a href="#l2.3675"></a><span id="l2.3675" class="difflineplus">+        }</span>
<a href="#l2.3676"></a><span id="l2.3676" class="difflineplus">+      }</span>
<a href="#l2.3677"></a><span id="l2.3677" class="difflineplus">+</span>
<a href="#l2.3678"></a><span id="l2.3678" class="difflineplus">+      return result;</span>
<a href="#l2.3679"></a><span id="l2.3679" class="difflineplus">+    },</span>
<a href="#l2.3680"></a><span id="l2.3680" class="difflineplus">+</span>
<a href="#l2.3681"></a><span id="l2.3681" class="difflineplus">+    toJSDate: function toJSDate() {</span>
<a href="#l2.3682"></a><span id="l2.3682" class="difflineplus">+      if (this.zone == ICAL.Timezone.localTimezone) {</span>
<a href="#l2.3683"></a><span id="l2.3683" class="difflineplus">+        if (this.isDate) {</span>
<a href="#l2.3684"></a><span id="l2.3684" class="difflineplus">+          return new Date(this.year, this.month - 1, this.day);</span>
<a href="#l2.3685"></a><span id="l2.3685" class="difflineplus">+        } else {</span>
<a href="#l2.3686"></a><span id="l2.3686" class="difflineplus">+          return new Date(this.year, this.month - 1, this.day,</span>
<a href="#l2.3687"></a><span id="l2.3687" class="difflineplus">+                          this.hour, this.minute, this.second, 0);</span>
<a href="#l2.3688"></a><span id="l2.3688" class="difflineplus">+        }</span>
<a href="#l2.3689"></a><span id="l2.3689" class="difflineplus">+      } else {</span>
<a href="#l2.3690"></a><span id="l2.3690" class="difflineplus">+        return new Date(this.toUnixTime() * 1000);</span>
<a href="#l2.3691"></a><span id="l2.3691" class="difflineplus">+      }</span>
<a href="#l2.3692"></a><span id="l2.3692" class="difflineplus">+    },</span>
<a href="#l2.3693"></a><span id="l2.3693" class="difflineplus">+</span>
<a href="#l2.3694"></a><span id="l2.3694" class="difflineplus">+    _normalize: function icaltime_normalize() {</span>
<a href="#l2.3695"></a><span id="l2.3695" class="difflineplus">+      var isDate = this._time.isDate;</span>
<a href="#l2.3696"></a><span id="l2.3696" class="difflineplus">+      if (this._time.isDate) {</span>
<a href="#l2.3697"></a><span id="l2.3697" class="difflineplus">+        this._time.hour = 0;</span>
<a href="#l2.3698"></a><span id="l2.3698" class="difflineplus">+        this._time.minute = 0;</span>
<a href="#l2.3699"></a><span id="l2.3699" class="difflineplus">+        this._time.second = 0;</span>
<a href="#l2.3700"></a><span id="l2.3700" class="difflineplus">+      }</span>
<a href="#l2.3701"></a><span id="l2.3701" class="difflineplus">+      this.icaltype = (isDate ? &quot;date&quot; : &quot;date-time&quot;);</span>
<a href="#l2.3702"></a><span id="l2.3702" class="difflineplus">+      this.adjust(0, 0, 0, 0);</span>
<a href="#l2.3703"></a><span id="l2.3703" class="difflineplus">+</span>
<a href="#l2.3704"></a><span id="l2.3704" class="difflineplus">+      return this;</span>
<a href="#l2.3705"></a><span id="l2.3705" class="difflineplus">+    },</span>
<a href="#l2.3706"></a><span id="l2.3706" class="difflineplus">+</span>
<a href="#l2.3707"></a><span id="l2.3707" class="difflineplus">+    adjust: function icaltime_adjust(aExtraDays, aExtraHours,</span>
<a href="#l2.3708"></a><span id="l2.3708" class="difflineplus">+                                     aExtraMinutes, aExtraSeconds, aTime) {</span>
<a href="#l2.3709"></a><span id="l2.3709" class="difflineplus">+</span>
<a href="#l2.3710"></a><span id="l2.3710" class="difflineplus">+      var minutesOverflow, hoursOverflow,</span>
<a href="#l2.3711"></a><span id="l2.3711" class="difflineplus">+          daysOverflow = 0, yearsOverflow = 0;</span>
<a href="#l2.3712"></a><span id="l2.3712" class="difflineplus">+</span>
<a href="#l2.3713"></a><span id="l2.3713" class="difflineplus">+      var second, minute, hour, day;</span>
<a href="#l2.3714"></a><span id="l2.3714" class="difflineplus">+      var daysInMonth;</span>
<a href="#l2.3715"></a><span id="l2.3715" class="difflineplus">+</span>
<a href="#l2.3716"></a><span id="l2.3716" class="difflineplus">+      var time = aTime || this._time;</span>
<a href="#l2.3717"></a><span id="l2.3717" class="difflineplus">+</span>
<a href="#l2.3718"></a><span id="l2.3718" class="difflineplus">+      if (!time.isDate) {</span>
<a href="#l2.3719"></a><span id="l2.3719" class="difflineplus">+        second = time.second + aExtraSeconds;</span>
<a href="#l2.3720"></a><span id="l2.3720" class="difflineplus">+        time.second = second % 60;</span>
<a href="#l2.3721"></a><span id="l2.3721" class="difflineplus">+        minutesOverflow = ICAL.helpers.trunc(second / 60);</span>
<a href="#l2.3722"></a><span id="l2.3722" class="difflineplus">+        if (time.second &lt; 0) {</span>
<a href="#l2.3723"></a><span id="l2.3723" class="difflineplus">+          time.second += 60;</span>
<a href="#l2.3724"></a><span id="l2.3724" class="difflineplus">+          minutesOverflow--;</span>
<a href="#l2.3725"></a><span id="l2.3725" class="difflineplus">+        }</span>
<a href="#l2.3726"></a><span id="l2.3726" class="difflineplus">+</span>
<a href="#l2.3727"></a><span id="l2.3727" class="difflineplus">+        minute = time.minute + aExtraMinutes + minutesOverflow;</span>
<a href="#l2.3728"></a><span id="l2.3728" class="difflineplus">+        time.minute = minute % 60;</span>
<a href="#l2.3729"></a><span id="l2.3729" class="difflineplus">+        hoursOverflow = ICAL.helpers.trunc(minute / 60);</span>
<a href="#l2.3730"></a><span id="l2.3730" class="difflineplus">+        if (time.minute &lt; 0) {</span>
<a href="#l2.3731"></a><span id="l2.3731" class="difflineplus">+          time.minute += 60;</span>
<a href="#l2.3732"></a><span id="l2.3732" class="difflineplus">+          hoursOverflow--;</span>
<a href="#l2.3733"></a><span id="l2.3733" class="difflineplus">+        }</span>
<a href="#l2.3734"></a><span id="l2.3734" class="difflineplus">+</span>
<a href="#l2.3735"></a><span id="l2.3735" class="difflineplus">+        hour = time.hour + aExtraHours + hoursOverflow;</span>
<a href="#l2.3736"></a><span id="l2.3736" class="difflineplus">+</span>
<a href="#l2.3737"></a><span id="l2.3737" class="difflineplus">+        time.hour = hour % 24;</span>
<a href="#l2.3738"></a><span id="l2.3738" class="difflineplus">+        daysOverflow = ICAL.helpers.trunc(hour / 24);</span>
<a href="#l2.3739"></a><span id="l2.3739" class="difflineplus">+        if (time.hour &lt; 0) {</span>
<a href="#l2.3740"></a><span id="l2.3740" class="difflineplus">+          time.hour += 24;</span>
<a href="#l2.3741"></a><span id="l2.3741" class="difflineplus">+          daysOverflow--;</span>
<a href="#l2.3742"></a><span id="l2.3742" class="difflineplus">+        }</span>
<a href="#l2.3743"></a><span id="l2.3743" class="difflineplus">+      }</span>
<a href="#l2.3744"></a><span id="l2.3744" class="difflineplus">+</span>
<a href="#l2.3745"></a><span id="l2.3745" class="difflineplus">+</span>
<a href="#l2.3746"></a><span id="l2.3746" class="difflineplus">+      // Adjust month and year first, because we need to know what month the day</span>
<a href="#l2.3747"></a><span id="l2.3747" class="difflineplus">+      // is in before adjusting it.</span>
<a href="#l2.3748"></a><span id="l2.3748" class="difflineplus">+      if (time.month &gt; 12) {</span>
<a href="#l2.3749"></a><span id="l2.3749" class="difflineplus">+        yearsOverflow = ICAL.helpers.trunc((time.month - 1) / 12);</span>
<a href="#l2.3750"></a><span id="l2.3750" class="difflineplus">+      } else if (time.month &lt; 1) {</span>
<a href="#l2.3751"></a><span id="l2.3751" class="difflineplus">+        yearsOverflow = ICAL.helpers.trunc(time.month / 12) - 1;</span>
<a href="#l2.3752"></a><span id="l2.3752" class="difflineplus">+      }</span>
<a href="#l2.3753"></a><span id="l2.3753" class="difflineplus">+</span>
<a href="#l2.3754"></a><span id="l2.3754" class="difflineplus">+      time.year += yearsOverflow;</span>
<a href="#l2.3755"></a><span id="l2.3755" class="difflineplus">+      time.month -= 12 * yearsOverflow;</span>
<a href="#l2.3756"></a><span id="l2.3756" class="difflineplus">+</span>
<a href="#l2.3757"></a><span id="l2.3757" class="difflineplus">+      // Now take care of the days (and adjust month if needed)</span>
<a href="#l2.3758"></a><span id="l2.3758" class="difflineplus">+      day = time.day + aExtraDays + daysOverflow;</span>
<a href="#l2.3759"></a><span id="l2.3759" class="difflineplus">+</span>
<a href="#l2.3760"></a><span id="l2.3760" class="difflineplus">+      if (day &gt; 0) {</span>
<a href="#l2.3761"></a><span id="l2.3761" class="difflineplus">+        for (;;) {</span>
<a href="#l2.3762"></a><span id="l2.3762" class="difflineplus">+          var daysInMonth = ICAL.Time.daysInMonth(time.month, time.year);</span>
<a href="#l2.3763"></a><span id="l2.3763" class="difflineplus">+          if (day &lt;= daysInMonth) {</span>
<a href="#l2.3764"></a><span id="l2.3764" class="difflineplus">+            break;</span>
<a href="#l2.3765"></a><span id="l2.3765" class="difflineplus">+          }</span>
<a href="#l2.3766"></a><span id="l2.3766" class="difflineplus">+</span>
<a href="#l2.3767"></a><span id="l2.3767" class="difflineplus">+          time.month++;</span>
<a href="#l2.3768"></a><span id="l2.3768" class="difflineplus">+          if (time.month &gt; 12) {</span>
<a href="#l2.3769"></a><span id="l2.3769" class="difflineplus">+            time.year++;</span>
<a href="#l2.3770"></a><span id="l2.3770" class="difflineplus">+            time.month = 1;</span>
<a href="#l2.3771"></a><span id="l2.3771" class="difflineplus">+          }</span>
<a href="#l2.3772"></a><span id="l2.3772" class="difflineplus">+</span>
<a href="#l2.3773"></a><span id="l2.3773" class="difflineplus">+          day -= daysInMonth;</span>
<a href="#l2.3774"></a><span id="l2.3774" class="difflineplus">+        }</span>
<a href="#l2.3775"></a><span id="l2.3775" class="difflineplus">+      } else {</span>
<a href="#l2.3776"></a><span id="l2.3776" class="difflineplus">+        while (day &lt;= 0) {</span>
<a href="#l2.3777"></a><span id="l2.3777" class="difflineplus">+          if (time.month == 1) {</span>
<a href="#l2.3778"></a><span id="l2.3778" class="difflineplus">+            time.year--;</span>
<a href="#l2.3779"></a><span id="l2.3779" class="difflineplus">+            time.month = 12;</span>
<a href="#l2.3780"></a><span id="l2.3780" class="difflineplus">+          } else {</span>
<a href="#l2.3781"></a><span id="l2.3781" class="difflineplus">+            time.month--;</span>
<a href="#l2.3782"></a><span id="l2.3782" class="difflineplus">+          }</span>
<a href="#l2.3783"></a><span id="l2.3783" class="difflineplus">+</span>
<a href="#l2.3784"></a><span id="l2.3784" class="difflineplus">+          day += ICAL.Time.daysInMonth(time.month, time.year);</span>
<a href="#l2.3785"></a><span id="l2.3785" class="difflineplus">+        }</span>
<a href="#l2.3786"></a><span id="l2.3786" class="difflineplus">+      }</span>
<a href="#l2.3787"></a><span id="l2.3787" class="difflineplus">+</span>
<a href="#l2.3788"></a><span id="l2.3788" class="difflineplus">+      time.day = day;</span>
<a href="#l2.3789"></a><span id="l2.3789" class="difflineplus">+      return this;</span>
<a href="#l2.3790"></a><span id="l2.3790" class="difflineplus">+    },</span>
<a href="#l2.3791"></a><span id="l2.3791" class="difflineplus">+</span>
<a href="#l2.3792"></a><span id="l2.3792" class="difflineplus">+    fromUnixTime: function fromUnixTime(seconds) {</span>
<a href="#l2.3793"></a><span id="l2.3793" class="difflineplus">+      this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l2.3794"></a><span id="l2.3794" class="difflineplus">+      var epoch = ICAL.Time.epochTime.clone();</span>
<a href="#l2.3795"></a><span id="l2.3795" class="difflineplus">+      epoch.adjust(0, 0, 0, seconds);</span>
<a href="#l2.3796"></a><span id="l2.3796" class="difflineplus">+</span>
<a href="#l2.3797"></a><span id="l2.3797" class="difflineplus">+      this.year = epoch.year;</span>
<a href="#l2.3798"></a><span id="l2.3798" class="difflineplus">+      this.month = epoch.month;</span>
<a href="#l2.3799"></a><span id="l2.3799" class="difflineplus">+      this.day = epoch.day;</span>
<a href="#l2.3800"></a><span id="l2.3800" class="difflineplus">+      this.hour = epoch.hour;</span>
<a href="#l2.3801"></a><span id="l2.3801" class="difflineplus">+      this.minute = epoch.minute;</span>
<a href="#l2.3802"></a><span id="l2.3802" class="difflineplus">+      this.second = epoch.second;</span>
<a href="#l2.3803"></a><span id="l2.3803" class="difflineplus">+    },</span>
<a href="#l2.3804"></a><span id="l2.3804" class="difflineplus">+</span>
<a href="#l2.3805"></a><span id="l2.3805" class="difflineplus">+    toUnixTime: function toUnixTime() {</span>
<a href="#l2.3806"></a><span id="l2.3806" class="difflineplus">+      var offset = this.utcOffset();</span>
<a href="#l2.3807"></a><span id="l2.3807" class="difflineplus">+</span>
<a href="#l2.3808"></a><span id="l2.3808" class="difflineplus">+      // we use the offset trick to ensure</span>
<a href="#l2.3809"></a><span id="l2.3809" class="difflineplus">+      // that we are getting the actual UTC time</span>
<a href="#l2.3810"></a><span id="l2.3810" class="difflineplus">+      var ms = Date.UTC(</span>
<a href="#l2.3811"></a><span id="l2.3811" class="difflineplus">+        this.year,</span>
<a href="#l2.3812"></a><span id="l2.3812" class="difflineplus">+        this.month - 1,</span>
<a href="#l2.3813"></a><span id="l2.3813" class="difflineplus">+        this.day,</span>
<a href="#l2.3814"></a><span id="l2.3814" class="difflineplus">+        this.hour,</span>
<a href="#l2.3815"></a><span id="l2.3815" class="difflineplus">+        this.minute,</span>
<a href="#l2.3816"></a><span id="l2.3816" class="difflineplus">+        this.second - offset</span>
<a href="#l2.3817"></a><span id="l2.3817" class="difflineplus">+      );</span>
<a href="#l2.3818"></a><span id="l2.3818" class="difflineplus">+</span>
<a href="#l2.3819"></a><span id="l2.3819" class="difflineplus">+      // seconds</span>
<a href="#l2.3820"></a><span id="l2.3820" class="difflineplus">+      return ms / 1000;</span>
<a href="#l2.3821"></a><span id="l2.3821" class="difflineplus">+    },</span>
<a href="#l2.3822"></a><span id="l2.3822" class="difflineplus">+</span>
<a href="#l2.3823"></a><span id="l2.3823" class="difflineplus">+    /**</span>
<a href="#l2.3824"></a><span id="l2.3824" class="difflineplus">+     * Converts time to into Object</span>
<a href="#l2.3825"></a><span id="l2.3825" class="difflineplus">+     * which can be serialized then re-created</span>
<a href="#l2.3826"></a><span id="l2.3826" class="difflineplus">+     * using the constructor.</span>
<a href="#l2.3827"></a><span id="l2.3827" class="difflineplus">+     *</span>
<a href="#l2.3828"></a><span id="l2.3828" class="difflineplus">+     * Example:</span>
<a href="#l2.3829"></a><span id="l2.3829" class="difflineplus">+     *</span>
<a href="#l2.3830"></a><span id="l2.3830" class="difflineplus">+     *    // toJSON will automatically be called</span>
<a href="#l2.3831"></a><span id="l2.3831" class="difflineplus">+     *    var json = JSON.stringify(mytime);</span>
<a href="#l2.3832"></a><span id="l2.3832" class="difflineplus">+     *</span>
<a href="#l2.3833"></a><span id="l2.3833" class="difflineplus">+     *    var deserialized = JSON.parse(json);</span>
<a href="#l2.3834"></a><span id="l2.3834" class="difflineplus">+     *</span>
<a href="#l2.3835"></a><span id="l2.3835" class="difflineplus">+     *    var time = new ICAL.Time(deserialized);</span>
<a href="#l2.3836"></a><span id="l2.3836" class="difflineplus">+     *</span>
<a href="#l2.3837"></a><span id="l2.3837" class="difflineplus">+     */</span>
<a href="#l2.3838"></a><span id="l2.3838" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.3839"></a><span id="l2.3839" class="difflineplus">+      var copy = [</span>
<a href="#l2.3840"></a><span id="l2.3840" class="difflineplus">+        'year',</span>
<a href="#l2.3841"></a><span id="l2.3841" class="difflineplus">+        'month',</span>
<a href="#l2.3842"></a><span id="l2.3842" class="difflineplus">+        'day',</span>
<a href="#l2.3843"></a><span id="l2.3843" class="difflineplus">+        'hour',</span>
<a href="#l2.3844"></a><span id="l2.3844" class="difflineplus">+        'minute',</span>
<a href="#l2.3845"></a><span id="l2.3845" class="difflineplus">+        'second',</span>
<a href="#l2.3846"></a><span id="l2.3846" class="difflineplus">+        'isDate'</span>
<a href="#l2.3847"></a><span id="l2.3847" class="difflineplus">+      ];</span>
<a href="#l2.3848"></a><span id="l2.3848" class="difflineplus">+</span>
<a href="#l2.3849"></a><span id="l2.3849" class="difflineplus">+      var result = Object.create(null);</span>
<a href="#l2.3850"></a><span id="l2.3850" class="difflineplus">+</span>
<a href="#l2.3851"></a><span id="l2.3851" class="difflineplus">+      var i = 0;</span>
<a href="#l2.3852"></a><span id="l2.3852" class="difflineplus">+      var len = copy.length;</span>
<a href="#l2.3853"></a><span id="l2.3853" class="difflineplus">+      var prop;</span>
<a href="#l2.3854"></a><span id="l2.3854" class="difflineplus">+</span>
<a href="#l2.3855"></a><span id="l2.3855" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.3856"></a><span id="l2.3856" class="difflineplus">+        prop = copy[i];</span>
<a href="#l2.3857"></a><span id="l2.3857" class="difflineplus">+        result[prop] = this[prop];</span>
<a href="#l2.3858"></a><span id="l2.3858" class="difflineplus">+      }</span>
<a href="#l2.3859"></a><span id="l2.3859" class="difflineplus">+</span>
<a href="#l2.3860"></a><span id="l2.3860" class="difflineplus">+      if (this.zone) {</span>
<a href="#l2.3861"></a><span id="l2.3861" class="difflineplus">+        result.timezone = this.zone.tzid;</span>
<a href="#l2.3862"></a><span id="l2.3862" class="difflineplus">+      }</span>
<a href="#l2.3863"></a><span id="l2.3863" class="difflineplus">+</span>
<a href="#l2.3864"></a><span id="l2.3864" class="difflineplus">+      return result;</span>
<a href="#l2.3865"></a><span id="l2.3865" class="difflineplus">+    }</span>
<a href="#l2.3866"></a><span id="l2.3866" class="difflineplus">+</span>
<a href="#l2.3867"></a><span id="l2.3867" class="difflineplus">+  };</span>
<a href="#l2.3868"></a><span id="l2.3868" class="difflineplus">+</span>
<a href="#l2.3869"></a><span id="l2.3869" class="difflineplus">+  (function setupNormalizeAttributes() {</span>
<a href="#l2.3870"></a><span id="l2.3870" class="difflineplus">+    // This needs to run before any instances are created!</span>
<a href="#l2.3871"></a><span id="l2.3871" class="difflineplus">+    function defineAttr(attr) {</span>
<a href="#l2.3872"></a><span id="l2.3872" class="difflineplus">+      Object.defineProperty(ICAL.Time.prototype, attr, {</span>
<a href="#l2.3873"></a><span id="l2.3873" class="difflineplus">+        get: function getTimeAttr() {</span>
<a href="#l2.3874"></a><span id="l2.3874" class="difflineplus">+          if (this._pendingNormalization) {</span>
<a href="#l2.3875"></a><span id="l2.3875" class="difflineplus">+            this._normalize();</span>
<a href="#l2.3876"></a><span id="l2.3876" class="difflineplus">+            this._pendingNormalization = false;</span>
<a href="#l2.3877"></a><span id="l2.3877" class="difflineplus">+          }</span>
<a href="#l2.3878"></a><span id="l2.3878" class="difflineplus">+</span>
<a href="#l2.3879"></a><span id="l2.3879" class="difflineplus">+          return this._time[attr];</span>
<a href="#l2.3880"></a><span id="l2.3880" class="difflineplus">+        },</span>
<a href="#l2.3881"></a><span id="l2.3881" class="difflineplus">+        set: function setTimeAttr(val) {</span>
<a href="#l2.3882"></a><span id="l2.3882" class="difflineplus">+          this._pendingNormalization = true;</span>
<a href="#l2.3883"></a><span id="l2.3883" class="difflineplus">+          this._time[attr] = val;</span>
<a href="#l2.3884"></a><span id="l2.3884" class="difflineplus">+</span>
<a href="#l2.3885"></a><span id="l2.3885" class="difflineplus">+          return val;</span>
<a href="#l2.3886"></a><span id="l2.3886" class="difflineplus">+        }</span>
<a href="#l2.3887"></a><span id="l2.3887" class="difflineplus">+      });</span>
<a href="#l2.3888"></a><span id="l2.3888" class="difflineplus">+</span>
<a href="#l2.3889"></a><span id="l2.3889" class="difflineplus">+    }</span>
<a href="#l2.3890"></a><span id="l2.3890" class="difflineplus">+</span>
<a href="#l2.3891"></a><span id="l2.3891" class="difflineplus">+    if (&quot;defineProperty&quot; in Object) {</span>
<a href="#l2.3892"></a><span id="l2.3892" class="difflineplus">+      defineAttr(&quot;year&quot;);</span>
<a href="#l2.3893"></a><span id="l2.3893" class="difflineplus">+      defineAttr(&quot;month&quot;);</span>
<a href="#l2.3894"></a><span id="l2.3894" class="difflineplus">+      defineAttr(&quot;day&quot;);</span>
<a href="#l2.3895"></a><span id="l2.3895" class="difflineplus">+      defineAttr(&quot;hour&quot;);</span>
<a href="#l2.3896"></a><span id="l2.3896" class="difflineplus">+      defineAttr(&quot;minute&quot;);</span>
<a href="#l2.3897"></a><span id="l2.3897" class="difflineplus">+      defineAttr(&quot;second&quot;);</span>
<a href="#l2.3898"></a><span id="l2.3898" class="difflineplus">+      defineAttr(&quot;isDate&quot;);</span>
<a href="#l2.3899"></a><span id="l2.3899" class="difflineplus">+    }</span>
<a href="#l2.3900"></a><span id="l2.3900" class="difflineplus">+  })();</span>
<a href="#l2.3901"></a><span id="l2.3901" class="difflineplus">+</span>
<a href="#l2.3902"></a><span id="l2.3902" class="difflineplus">+  ICAL.Time.daysInMonth = function icaltime_daysInMonth(month, year) {</span>
<a href="#l2.3903"></a><span id="l2.3903" class="difflineplus">+    var _daysInMonth = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];</span>
<a href="#l2.3904"></a><span id="l2.3904" class="difflineplus">+    var days = 30;</span>
<a href="#l2.3905"></a><span id="l2.3905" class="difflineplus">+</span>
<a href="#l2.3906"></a><span id="l2.3906" class="difflineplus">+    if (month &lt; 1 || month &gt; 12) return days;</span>
<a href="#l2.3907"></a><span id="l2.3907" class="difflineplus">+</span>
<a href="#l2.3908"></a><span id="l2.3908" class="difflineplus">+    days = _daysInMonth[month];</span>
<a href="#l2.3909"></a><span id="l2.3909" class="difflineplus">+</span>
<a href="#l2.3910"></a><span id="l2.3910" class="difflineplus">+    if (month == 2) {</span>
<a href="#l2.3911"></a><span id="l2.3911" class="difflineplus">+      days += ICAL.Time.is_leap_year(year);</span>
<a href="#l2.3912"></a><span id="l2.3912" class="difflineplus">+    }</span>
<a href="#l2.3913"></a><span id="l2.3913" class="difflineplus">+</span>
<a href="#l2.3914"></a><span id="l2.3914" class="difflineplus">+    return days;</span>
<a href="#l2.3915"></a><span id="l2.3915" class="difflineplus">+  };</span>
<a href="#l2.3916"></a><span id="l2.3916" class="difflineplus">+</span>
<a href="#l2.3917"></a><span id="l2.3917" class="difflineplus">+  ICAL.Time.is_leap_year = function icaltime_is_leap_year(year) {</span>
<a href="#l2.3918"></a><span id="l2.3918" class="difflineplus">+    if (year &lt;= 1752) {</span>
<a href="#l2.3919"></a><span id="l2.3919" class="difflineplus">+      return ((year % 4) == 0);</span>
<a href="#l2.3920"></a><span id="l2.3920" class="difflineplus">+    } else {</span>
<a href="#l2.3921"></a><span id="l2.3921" class="difflineplus">+      return (((year % 4 == 0) &amp;&amp; (year % 100 != 0)) || (year % 400 == 0));</span>
<a href="#l2.3922"></a><span id="l2.3922" class="difflineplus">+    }</span>
<a href="#l2.3923"></a><span id="l2.3923" class="difflineplus">+  };</span>
<a href="#l2.3924"></a><span id="l2.3924" class="difflineplus">+</span>
<a href="#l2.3925"></a><span id="l2.3925" class="difflineplus">+  ICAL.Time.fromDayOfYear = function icaltime_fromDayOfYear(aDayOfYear, aYear) {</span>
<a href="#l2.3926"></a><span id="l2.3926" class="difflineplus">+    var year = aYear;</span>
<a href="#l2.3927"></a><span id="l2.3927" class="difflineplus">+    var doy = aDayOfYear;</span>
<a href="#l2.3928"></a><span id="l2.3928" class="difflineplus">+    var tt = new ICAL.Time();</span>
<a href="#l2.3929"></a><span id="l2.3929" class="difflineplus">+    tt.auto_normalize = false;</span>
<a href="#l2.3930"></a><span id="l2.3930" class="difflineplus">+    var is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l2.3931"></a><span id="l2.3931" class="difflineplus">+</span>
<a href="#l2.3932"></a><span id="l2.3932" class="difflineplus">+    if (doy &lt; 1) {</span>
<a href="#l2.3933"></a><span id="l2.3933" class="difflineplus">+      year--;</span>
<a href="#l2.3934"></a><span id="l2.3934" class="difflineplus">+      is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l2.3935"></a><span id="l2.3935" class="difflineplus">+      doy += ICAL.Time._days_in_year_passed_month[is_leap][12];</span>
<a href="#l2.3936"></a><span id="l2.3936" class="difflineplus">+    } else if (doy &gt; ICAL.Time._days_in_year_passed_month[is_leap][12]) {</span>
<a href="#l2.3937"></a><span id="l2.3937" class="difflineplus">+      is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l2.3938"></a><span id="l2.3938" class="difflineplus">+      doy -= ICAL.Time._days_in_year_passed_month[is_leap][12];</span>
<a href="#l2.3939"></a><span id="l2.3939" class="difflineplus">+      year++;</span>
<a href="#l2.3940"></a><span id="l2.3940" class="difflineplus">+    }</span>
<a href="#l2.3941"></a><span id="l2.3941" class="difflineplus">+</span>
<a href="#l2.3942"></a><span id="l2.3942" class="difflineplus">+    tt.year = year;</span>
<a href="#l2.3943"></a><span id="l2.3943" class="difflineplus">+    tt.isDate = true;</span>
<a href="#l2.3944"></a><span id="l2.3944" class="difflineplus">+</span>
<a href="#l2.3945"></a><span id="l2.3945" class="difflineplus">+    for (var month = 11; month &gt;= 0; month--) {</span>
<a href="#l2.3946"></a><span id="l2.3946" class="difflineplus">+      if (doy &gt; ICAL.Time._days_in_year_passed_month[is_leap][month]) {</span>
<a href="#l2.3947"></a><span id="l2.3947" class="difflineplus">+        tt.month = month + 1;</span>
<a href="#l2.3948"></a><span id="l2.3948" class="difflineplus">+        tt.day = doy - ICAL.Time._days_in_year_passed_month[is_leap][month];</span>
<a href="#l2.3949"></a><span id="l2.3949" class="difflineplus">+        break;</span>
<a href="#l2.3950"></a><span id="l2.3950" class="difflineplus">+      }</span>
<a href="#l2.3951"></a><span id="l2.3951" class="difflineplus">+    }</span>
<a href="#l2.3952"></a><span id="l2.3952" class="difflineplus">+</span>
<a href="#l2.3953"></a><span id="l2.3953" class="difflineplus">+    tt.auto_normalize = true;</span>
<a href="#l2.3954"></a><span id="l2.3954" class="difflineplus">+    return tt;</span>
<a href="#l2.3955"></a><span id="l2.3955" class="difflineplus">+  };</span>
<a href="#l2.3956"></a><span id="l2.3956" class="difflineplus">+</span>
<a href="#l2.3957"></a><span id="l2.3957" class="difflineplus">+  ICAL.Time.fromStringv2 = function fromString(str) {</span>
<a href="#l2.3958"></a><span id="l2.3958" class="difflineplus">+    return new ICAL.Time({</span>
<a href="#l2.3959"></a><span id="l2.3959" class="difflineplus">+      year: parseInt(str.substr(0, 4), 10),</span>
<a href="#l2.3960"></a><span id="l2.3960" class="difflineplus">+      month: parseInt(str.substr(5, 2), 10),</span>
<a href="#l2.3961"></a><span id="l2.3961" class="difflineplus">+      day: parseInt(str.substr(8, 2), 10),</span>
<a href="#l2.3962"></a><span id="l2.3962" class="difflineplus">+      isDate: true</span>
<a href="#l2.3963"></a><span id="l2.3963" class="difflineplus">+    });</span>
<a href="#l2.3964"></a><span id="l2.3964" class="difflineplus">+  };</span>
<a href="#l2.3965"></a><span id="l2.3965" class="difflineplus">+</span>
<a href="#l2.3966"></a><span id="l2.3966" class="difflineplus">+  ICAL.Time.fromDateString = function(aValue, aProp) {</span>
<a href="#l2.3967"></a><span id="l2.3967" class="difflineplus">+    // Dates should have no timezone.</span>
<a href="#l2.3968"></a><span id="l2.3968" class="difflineplus">+    // Google likes to sometimes specify Z on dates</span>
<a href="#l2.3969"></a><span id="l2.3969" class="difflineplus">+    // we specifically ignore that to avoid issues.</span>
<a href="#l2.3970"></a><span id="l2.3970" class="difflineplus">+</span>
<a href="#l2.3971"></a><span id="l2.3971" class="difflineplus">+    // YYYY-MM-DD</span>
<a href="#l2.3972"></a><span id="l2.3972" class="difflineplus">+    // 2012-10-10</span>
<a href="#l2.3973"></a><span id="l2.3973" class="difflineplus">+    return new ICAL.Time({</span>
<a href="#l2.3974"></a><span id="l2.3974" class="difflineplus">+      year: ICAL.helpers.strictParseInt(aValue.substr(0, 4)),</span>
<a href="#l2.3975"></a><span id="l2.3975" class="difflineplus">+      month: ICAL.helpers.strictParseInt(aValue.substr(5, 2)),</span>
<a href="#l2.3976"></a><span id="l2.3976" class="difflineplus">+      day: ICAL.helpers.strictParseInt(aValue.substr(8, 2)),</span>
<a href="#l2.3977"></a><span id="l2.3977" class="difflineplus">+      isDate: true</span>
<a href="#l2.3978"></a><span id="l2.3978" class="difflineplus">+    });</span>
<a href="#l2.3979"></a><span id="l2.3979" class="difflineplus">+  };</span>
<a href="#l2.3980"></a><span id="l2.3980" class="difflineplus">+</span>
<a href="#l2.3981"></a><span id="l2.3981" class="difflineplus">+  ICAL.Time.fromDateTimeString = function(aValue, prop) {</span>
<a href="#l2.3982"></a><span id="l2.3982" class="difflineplus">+    if (aValue.length &lt; 19) {</span>
<a href="#l2.3983"></a><span id="l2.3983" class="difflineplus">+      throw new Error(</span>
<a href="#l2.3984"></a><span id="l2.3984" class="difflineplus">+        'invalid date-time value: &quot;' + aValue + '&quot;'</span>
<a href="#l2.3985"></a><span id="l2.3985" class="difflineplus">+      );</span>
<a href="#l2.3986"></a><span id="l2.3986" class="difflineplus">+    }</span>
<a href="#l2.3987"></a><span id="l2.3987" class="difflineplus">+</span>
<a href="#l2.3988"></a><span id="l2.3988" class="difflineplus">+    var zone;</span>
<a href="#l2.3989"></a><span id="l2.3989" class="difflineplus">+</span>
<a href="#l2.3990"></a><span id="l2.3990" class="difflineplus">+    if (aValue[19] === 'Z') {</span>
<a href="#l2.3991"></a><span id="l2.3991" class="difflineplus">+      zone = 'Z';</span>
<a href="#l2.3992"></a><span id="l2.3992" class="difflineplus">+    } else if (prop) {</span>
<a href="#l2.3993"></a><span id="l2.3993" class="difflineplus">+      zone = prop.getParameter('tzid');</span>
<a href="#l2.3994"></a><span id="l2.3994" class="difflineplus">+    }</span>
<a href="#l2.3995"></a><span id="l2.3995" class="difflineplus">+</span>
<a href="#l2.3996"></a><span id="l2.3996" class="difflineplus">+    // 2012-10-10T10:10:10(Z)?</span>
<a href="#l2.3997"></a><span id="l2.3997" class="difflineplus">+    var time = new ICAL.Time({</span>
<a href="#l2.3998"></a><span id="l2.3998" class="difflineplus">+      year: ICAL.helpers.strictParseInt(aValue.substr(0, 4)),</span>
<a href="#l2.3999"></a><span id="l2.3999" class="difflineplus">+      month: ICAL.helpers.strictParseInt(aValue.substr(5, 2)),</span>
<a href="#l2.4000"></a><span id="l2.4000" class="difflineplus">+      day: ICAL.helpers.strictParseInt(aValue.substr(8, 2)),</span>
<a href="#l2.4001"></a><span id="l2.4001" class="difflineplus">+      hour: ICAL.helpers.strictParseInt(aValue.substr(11, 2)),</span>
<a href="#l2.4002"></a><span id="l2.4002" class="difflineplus">+      minute: ICAL.helpers.strictParseInt(aValue.substr(14, 2)),</span>
<a href="#l2.4003"></a><span id="l2.4003" class="difflineplus">+      second: ICAL.helpers.strictParseInt(aValue.substr(17, 2)),</span>
<a href="#l2.4004"></a><span id="l2.4004" class="difflineplus">+      timezone: zone</span>
<a href="#l2.4005"></a><span id="l2.4005" class="difflineplus">+    });</span>
<a href="#l2.4006"></a><span id="l2.4006" class="difflineplus">+</span>
<a href="#l2.4007"></a><span id="l2.4007" class="difflineplus">+    return time;</span>
<a href="#l2.4008"></a><span id="l2.4008" class="difflineplus">+  };</span>
<a href="#l2.4009"></a><span id="l2.4009" class="difflineplus">+</span>
<a href="#l2.4010"></a><span id="l2.4010" class="difflineplus">+  ICAL.Time.fromString = function fromString(aValue) {</span>
<a href="#l2.4011"></a><span id="l2.4011" class="difflineplus">+    if (aValue.length &gt; 10) {</span>
<a href="#l2.4012"></a><span id="l2.4012" class="difflineplus">+      return ICAL.Time.fromDateTimeString(aValue);</span>
<a href="#l2.4013"></a><span id="l2.4013" class="difflineplus">+    } else {</span>
<a href="#l2.4014"></a><span id="l2.4014" class="difflineplus">+      return ICAL.Time.fromDateString(aValue);</span>
<a href="#l2.4015"></a><span id="l2.4015" class="difflineplus">+    }</span>
<a href="#l2.4016"></a><span id="l2.4016" class="difflineplus">+  };</span>
<a href="#l2.4017"></a><span id="l2.4017" class="difflineplus">+</span>
<a href="#l2.4018"></a><span id="l2.4018" class="difflineplus">+  ICAL.Time.fromJSDate = function fromJSDate(aDate, useUTC) {</span>
<a href="#l2.4019"></a><span id="l2.4019" class="difflineplus">+    var tt = new ICAL.Time();</span>
<a href="#l2.4020"></a><span id="l2.4020" class="difflineplus">+    return tt.fromJSDate(aDate, useUTC);</span>
<a href="#l2.4021"></a><span id="l2.4021" class="difflineplus">+  };</span>
<a href="#l2.4022"></a><span id="l2.4022" class="difflineplus">+</span>
<a href="#l2.4023"></a><span id="l2.4023" class="difflineplus">+  ICAL.Time.fromData = function fromData(aData) {</span>
<a href="#l2.4024"></a><span id="l2.4024" class="difflineplus">+    var t = new ICAL.Time();</span>
<a href="#l2.4025"></a><span id="l2.4025" class="difflineplus">+    return t.fromData(aData);</span>
<a href="#l2.4026"></a><span id="l2.4026" class="difflineplus">+  };</span>
<a href="#l2.4027"></a><span id="l2.4027" class="difflineplus">+</span>
<a href="#l2.4028"></a><span id="l2.4028" class="difflineplus">+  ICAL.Time.now = function icaltime_now() {</span>
<a href="#l2.4029"></a><span id="l2.4029" class="difflineplus">+    return ICAL.Time.fromJSDate(new Date(), false);</span>
<a href="#l2.4030"></a><span id="l2.4030" class="difflineplus">+  };</span>
<a href="#l2.4031"></a><span id="l2.4031" class="difflineplus">+</span>
<a href="#l2.4032"></a><span id="l2.4032" class="difflineplus">+  ICAL.Time.weekOneStarts = function weekOneStarts(aYear, aWeekStart) {</span>
<a href="#l2.4033"></a><span id="l2.4033" class="difflineplus">+    var t = ICAL.Time.fromData({</span>
<a href="#l2.4034"></a><span id="l2.4034" class="difflineplus">+      year: aYear,</span>
<a href="#l2.4035"></a><span id="l2.4035" class="difflineplus">+      month: 1,</span>
<a href="#l2.4036"></a><span id="l2.4036" class="difflineplus">+      day: 4,</span>
<a href="#l2.4037"></a><span id="l2.4037" class="difflineplus">+      isDate: true</span>
<a href="#l2.4038"></a><span id="l2.4038" class="difflineplus">+    });</span>
<a href="#l2.4039"></a><span id="l2.4039" class="difflineplus">+</span>
<a href="#l2.4040"></a><span id="l2.4040" class="difflineplus">+    var fourth_dow = t.dayOfWeek();</span>
<a href="#l2.4041"></a><span id="l2.4041" class="difflineplus">+    t.day += (1 - fourth_dow) + ((aWeekStart || ICAL.Time.SUNDAY) - 1);</span>
<a href="#l2.4042"></a><span id="l2.4042" class="difflineplus">+    return t;</span>
<a href="#l2.4043"></a><span id="l2.4043" class="difflineplus">+  };</span>
<a href="#l2.4044"></a><span id="l2.4044" class="difflineplus">+</span>
<a href="#l2.4045"></a><span id="l2.4045" class="difflineplus">+  ICAL.Time.epochTime = ICAL.Time.fromData({</span>
<a href="#l2.4046"></a><span id="l2.4046" class="difflineplus">+    year: 1970,</span>
<a href="#l2.4047"></a><span id="l2.4047" class="difflineplus">+    month: 1,</span>
<a href="#l2.4048"></a><span id="l2.4048" class="difflineplus">+    day: 1,</span>
<a href="#l2.4049"></a><span id="l2.4049" class="difflineplus">+    hour: 0,</span>
<a href="#l2.4050"></a><span id="l2.4050" class="difflineplus">+    minute: 0,</span>
<a href="#l2.4051"></a><span id="l2.4051" class="difflineplus">+    second: 0,</span>
<a href="#l2.4052"></a><span id="l2.4052" class="difflineplus">+    isDate: false,</span>
<a href="#l2.4053"></a><span id="l2.4053" class="difflineplus">+    timezone: &quot;Z&quot;</span>
<a href="#l2.4054"></a><span id="l2.4054" class="difflineplus">+  });</span>
<a href="#l2.4055"></a><span id="l2.4055" class="difflineplus">+</span>
<a href="#l2.4056"></a><span id="l2.4056" class="difflineplus">+  ICAL.Time._cmp_attr = function _cmp_attr(a, b, attr) {</span>
<a href="#l2.4057"></a><span id="l2.4057" class="difflineplus">+    if (a[attr] &gt; b[attr]) return 1;</span>
<a href="#l2.4058"></a><span id="l2.4058" class="difflineplus">+    if (a[attr] &lt; b[attr]) return -1;</span>
<a href="#l2.4059"></a><span id="l2.4059" class="difflineplus">+    return 0;</span>
<a href="#l2.4060"></a><span id="l2.4060" class="difflineplus">+  };</span>
<a href="#l2.4061"></a><span id="l2.4061" class="difflineplus">+</span>
<a href="#l2.4062"></a><span id="l2.4062" class="difflineplus">+  ICAL.Time._days_in_year_passed_month = [</span>
<a href="#l2.4063"></a><span id="l2.4063" class="difflineplus">+    [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365],</span>
<a href="#l2.4064"></a><span id="l2.4064" class="difflineplus">+    [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366]</span>
<a href="#l2.4065"></a><span id="l2.4065" class="difflineplus">+  ];</span>
<a href="#l2.4066"></a><span id="l2.4066" class="difflineplus">+</span>
<a href="#l2.4067"></a><span id="l2.4067" class="difflineplus">+</span>
<a href="#l2.4068"></a><span id="l2.4068" class="difflineplus">+  ICAL.Time.SUNDAY = 1;</span>
<a href="#l2.4069"></a><span id="l2.4069" class="difflineplus">+  ICAL.Time.MONDAY = 2;</span>
<a href="#l2.4070"></a><span id="l2.4070" class="difflineplus">+  ICAL.Time.TUESDAY = 3;</span>
<a href="#l2.4071"></a><span id="l2.4071" class="difflineplus">+  ICAL.Time.WEDNESDAY = 4;</span>
<a href="#l2.4072"></a><span id="l2.4072" class="difflineplus">+  ICAL.Time.THURSDAY = 5;</span>
<a href="#l2.4073"></a><span id="l2.4073" class="difflineplus">+  ICAL.Time.FRIDAY = 6;</span>
<a href="#l2.4074"></a><span id="l2.4074" class="difflineplus">+  ICAL.Time.SATURDAY = 7;</span>
<a href="#l2.4075"></a><span id="l2.4075" class="difflineplus">+</span>
<a href="#l2.4076"></a><span id="l2.4076" class="difflineplus">+  ICAL.Time.DEFAULT_WEEK_START = ICAL.Time.MONDAY;</span>
<a href="#l2.4077"></a><span id="l2.4077" class="difflineplus">+})();</span>
<a href="#l2.4078"></a><span id="l2.4078" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.4079"></a><span id="l2.4079" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.4080"></a><span id="l2.4080" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.4081"></a><span id="l2.4081" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l2.4082"></a><span id="l2.4082" class="difflineplus">+</span>
<a href="#l2.4083"></a><span id="l2.4083" class="difflineplus">+</span>
<a href="#l2.4084"></a><span id="l2.4084" class="difflineplus">+</span>
<a href="#l2.4085"></a><span id="l2.4085" class="difflineplus">+(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l2.4086"></a><span id="l2.4086" class="difflineplus">+(function() {</span>
<a href="#l2.4087"></a><span id="l2.4087" class="difflineplus">+</span>
<a href="#l2.4088"></a><span id="l2.4088" class="difflineplus">+  var DOW_MAP = {</span>
<a href="#l2.4089"></a><span id="l2.4089" class="difflineplus">+    SU: ICAL.Time.SUNDAY,</span>
<a href="#l2.4090"></a><span id="l2.4090" class="difflineplus">+    MO: ICAL.Time.MONDAY,</span>
<a href="#l2.4091"></a><span id="l2.4091" class="difflineplus">+    TU: ICAL.Time.TUESDAY,</span>
<a href="#l2.4092"></a><span id="l2.4092" class="difflineplus">+    WE: ICAL.Time.WEDNESDAY,</span>
<a href="#l2.4093"></a><span id="l2.4093" class="difflineplus">+    TH: ICAL.Time.THURSDAY,</span>
<a href="#l2.4094"></a><span id="l2.4094" class="difflineplus">+    FR: ICAL.Time.FRIDAY,</span>
<a href="#l2.4095"></a><span id="l2.4095" class="difflineplus">+    SA: ICAL.Time.SATURDAY</span>
<a href="#l2.4096"></a><span id="l2.4096" class="difflineplus">+  };</span>
<a href="#l2.4097"></a><span id="l2.4097" class="difflineplus">+</span>
<a href="#l2.4098"></a><span id="l2.4098" class="difflineplus">+  var REVERSE_DOW_MAP = {};</span>
<a href="#l2.4099"></a><span id="l2.4099" class="difflineplus">+  for (var key in DOW_MAP) {</span>
<a href="#l2.4100"></a><span id="l2.4100" class="difflineplus">+    REVERSE_DOW_MAP[DOW_MAP[key]] = key;</span>
<a href="#l2.4101"></a><span id="l2.4101" class="difflineplus">+  }</span>
<a href="#l2.4102"></a><span id="l2.4102" class="difflineplus">+</span>
<a href="#l2.4103"></a><span id="l2.4103" class="difflineplus">+  var COPY_PARTS = [&quot;BYSECOND&quot;, &quot;BYMINUTE&quot;, &quot;BYHOUR&quot;, &quot;BYDAY&quot;,</span>
<a href="#l2.4104"></a><span id="l2.4104" class="difflineplus">+                    &quot;BYMONTHDAY&quot;, &quot;BYYEARDAY&quot;, &quot;BYWEEKNO&quot;,</span>
<a href="#l2.4105"></a><span id="l2.4105" class="difflineplus">+                    &quot;BYMONTH&quot;, &quot;BYSETPOS&quot;];</span>
<a href="#l2.4106"></a><span id="l2.4106" class="difflineplus">+</span>
<a href="#l2.4107"></a><span id="l2.4107" class="difflineplus">+  ICAL.Recur = function icalrecur(data) {</span>
<a href="#l2.4108"></a><span id="l2.4108" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l2.4109"></a><span id="l2.4109" class="difflineplus">+    this.parts = {};</span>
<a href="#l2.4110"></a><span id="l2.4110" class="difflineplus">+</span>
<a href="#l2.4111"></a><span id="l2.4111" class="difflineplus">+    if (typeof(data) === 'object') {</span>
<a href="#l2.4112"></a><span id="l2.4112" class="difflineplus">+      for (var key in data) {</span>
<a href="#l2.4113"></a><span id="l2.4113" class="difflineplus">+        this[key] = data[key];</span>
<a href="#l2.4114"></a><span id="l2.4114" class="difflineplus">+      }</span>
<a href="#l2.4115"></a><span id="l2.4115" class="difflineplus">+</span>
<a href="#l2.4116"></a><span id="l2.4116" class="difflineplus">+      if (this.until &amp;&amp; !(this.until instanceof ICAL.Time)) {</span>
<a href="#l2.4117"></a><span id="l2.4117" class="difflineplus">+        this.until = new ICAL.Time(this.until);</span>
<a href="#l2.4118"></a><span id="l2.4118" class="difflineplus">+      }</span>
<a href="#l2.4119"></a><span id="l2.4119" class="difflineplus">+    }</span>
<a href="#l2.4120"></a><span id="l2.4120" class="difflineplus">+</span>
<a href="#l2.4121"></a><span id="l2.4121" class="difflineplus">+    if (!this.parts) {</span>
<a href="#l2.4122"></a><span id="l2.4122" class="difflineplus">+      this.parts = {};</span>
<a href="#l2.4123"></a><span id="l2.4123" class="difflineplus">+    }</span>
<a href="#l2.4124"></a><span id="l2.4124" class="difflineplus">+  };</span>
<a href="#l2.4125"></a><span id="l2.4125" class="difflineplus">+</span>
<a href="#l2.4126"></a><span id="l2.4126" class="difflineplus">+  ICAL.Recur.prototype = {</span>
<a href="#l2.4127"></a><span id="l2.4127" class="difflineplus">+</span>
<a href="#l2.4128"></a><span id="l2.4128" class="difflineplus">+    parts: null,</span>
<a href="#l2.4129"></a><span id="l2.4129" class="difflineplus">+</span>
<a href="#l2.4130"></a><span id="l2.4130" class="difflineplus">+    interval: 1,</span>
<a href="#l2.4131"></a><span id="l2.4131" class="difflineplus">+    wkst: ICAL.Time.MONDAY,</span>
<a href="#l2.4132"></a><span id="l2.4132" class="difflineplus">+    until: null,</span>
<a href="#l2.4133"></a><span id="l2.4133" class="difflineplus">+    count: null,</span>
<a href="#l2.4134"></a><span id="l2.4134" class="difflineplus">+    freq: null,</span>
<a href="#l2.4135"></a><span id="l2.4135" class="difflineplus">+    icalclass: &quot;icalrecur&quot;,</span>
<a href="#l2.4136"></a><span id="l2.4136" class="difflineplus">+    icaltype: &quot;recur&quot;,</span>
<a href="#l2.4137"></a><span id="l2.4137" class="difflineplus">+</span>
<a href="#l2.4138"></a><span id="l2.4138" class="difflineplus">+    iterator: function(aStart) {</span>
<a href="#l2.4139"></a><span id="l2.4139" class="difflineplus">+      return new ICAL.RecurIterator({</span>
<a href="#l2.4140"></a><span id="l2.4140" class="difflineplus">+        rule: this,</span>
<a href="#l2.4141"></a><span id="l2.4141" class="difflineplus">+        dtstart: aStart</span>
<a href="#l2.4142"></a><span id="l2.4142" class="difflineplus">+      });</span>
<a href="#l2.4143"></a><span id="l2.4143" class="difflineplus">+    },</span>
<a href="#l2.4144"></a><span id="l2.4144" class="difflineplus">+</span>
<a href="#l2.4145"></a><span id="l2.4145" class="difflineplus">+    clone: function clone() {</span>
<a href="#l2.4146"></a><span id="l2.4146" class="difflineplus">+      return new ICAL.Recur(this.toJSON());</span>
<a href="#l2.4147"></a><span id="l2.4147" class="difflineplus">+    },</span>
<a href="#l2.4148"></a><span id="l2.4148" class="difflineplus">+</span>
<a href="#l2.4149"></a><span id="l2.4149" class="difflineplus">+    isFinite: function isfinite() {</span>
<a href="#l2.4150"></a><span id="l2.4150" class="difflineplus">+      return !!(this.count || this.until);</span>
<a href="#l2.4151"></a><span id="l2.4151" class="difflineplus">+    },</span>
<a href="#l2.4152"></a><span id="l2.4152" class="difflineplus">+</span>
<a href="#l2.4153"></a><span id="l2.4153" class="difflineplus">+    isByCount: function isbycount() {</span>
<a href="#l2.4154"></a><span id="l2.4154" class="difflineplus">+      return !!(this.count &amp;&amp; !this.until);</span>
<a href="#l2.4155"></a><span id="l2.4155" class="difflineplus">+    },</span>
<a href="#l2.4156"></a><span id="l2.4156" class="difflineplus">+</span>
<a href="#l2.4157"></a><span id="l2.4157" class="difflineplus">+    addComponent: function addPart(aType, aValue) {</span>
<a href="#l2.4158"></a><span id="l2.4158" class="difflineplus">+      if (!(aType in this.parts)) {</span>
<a href="#l2.4159"></a><span id="l2.4159" class="difflineplus">+        this.parts[aType] = [aValue];</span>
<a href="#l2.4160"></a><span id="l2.4160" class="difflineplus">+      } else {</span>
<a href="#l2.4161"></a><span id="l2.4161" class="difflineplus">+        this.parts[aType].push(aValue);</span>
<a href="#l2.4162"></a><span id="l2.4162" class="difflineplus">+      }</span>
<a href="#l2.4163"></a><span id="l2.4163" class="difflineplus">+    },</span>
<a href="#l2.4164"></a><span id="l2.4164" class="difflineplus">+</span>
<a href="#l2.4165"></a><span id="l2.4165" class="difflineplus">+    setComponent: function setComponent(aType, aValues) {</span>
<a href="#l2.4166"></a><span id="l2.4166" class="difflineplus">+      this.parts[aType] = aValues;</span>
<a href="#l2.4167"></a><span id="l2.4167" class="difflineplus">+    },</span>
<a href="#l2.4168"></a><span id="l2.4168" class="difflineplus">+</span>
<a href="#l2.4169"></a><span id="l2.4169" class="difflineplus">+    getComponent: function getComponent(aType, aCount) {</span>
<a href="#l2.4170"></a><span id="l2.4170" class="difflineplus">+      var ucName = aType.toUpperCase();</span>
<a href="#l2.4171"></a><span id="l2.4171" class="difflineplus">+      var components = (ucName in this.parts ? this.parts[ucName] : []);</span>
<a href="#l2.4172"></a><span id="l2.4172" class="difflineplus">+</span>
<a href="#l2.4173"></a><span id="l2.4173" class="difflineplus">+      if (aCount) aCount.value = components.length;</span>
<a href="#l2.4174"></a><span id="l2.4174" class="difflineplus">+      return components;</span>
<a href="#l2.4175"></a><span id="l2.4175" class="difflineplus">+    },</span>
<a href="#l2.4176"></a><span id="l2.4176" class="difflineplus">+</span>
<a href="#l2.4177"></a><span id="l2.4177" class="difflineplus">+    getNextOccurrence: function getNextOccurrence(aStartTime, aRecurrenceId) {</span>
<a href="#l2.4178"></a><span id="l2.4178" class="difflineplus">+      var iter = this.iterator(aStartTime);</span>
<a href="#l2.4179"></a><span id="l2.4179" class="difflineplus">+      var next, cdt;</span>
<a href="#l2.4180"></a><span id="l2.4180" class="difflineplus">+</span>
<a href="#l2.4181"></a><span id="l2.4181" class="difflineplus">+      do {</span>
<a href="#l2.4182"></a><span id="l2.4182" class="difflineplus">+        next = iter.next();</span>
<a href="#l2.4183"></a><span id="l2.4183" class="difflineplus">+      } while (next &amp;&amp; next.compare(aRecurrenceId) &lt;= 0);</span>
<a href="#l2.4184"></a><span id="l2.4184" class="difflineplus">+</span>
<a href="#l2.4185"></a><span id="l2.4185" class="difflineplus">+      if (next &amp;&amp; aRecurrenceId.zone) {</span>
<a href="#l2.4186"></a><span id="l2.4186" class="difflineplus">+        next.zone = aRecurrenceId.zone;</span>
<a href="#l2.4187"></a><span id="l2.4187" class="difflineplus">+      }</span>
<a href="#l2.4188"></a><span id="l2.4188" class="difflineplus">+</span>
<a href="#l2.4189"></a><span id="l2.4189" class="difflineplus">+      return next;</span>
<a href="#l2.4190"></a><span id="l2.4190" class="difflineplus">+    },</span>
<a href="#l2.4191"></a><span id="l2.4191" class="difflineplus">+</span>
<a href="#l2.4192"></a><span id="l2.4192" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.4193"></a><span id="l2.4193" class="difflineplus">+      //XXX: extract this list up to proto?</span>
<a href="#l2.4194"></a><span id="l2.4194" class="difflineplus">+      var propsToCopy = [</span>
<a href="#l2.4195"></a><span id="l2.4195" class="difflineplus">+        &quot;freq&quot;,</span>
<a href="#l2.4196"></a><span id="l2.4196" class="difflineplus">+        &quot;count&quot;,</span>
<a href="#l2.4197"></a><span id="l2.4197" class="difflineplus">+        &quot;until&quot;,</span>
<a href="#l2.4198"></a><span id="l2.4198" class="difflineplus">+        &quot;wkst&quot;,</span>
<a href="#l2.4199"></a><span id="l2.4199" class="difflineplus">+        &quot;interval&quot;,</span>
<a href="#l2.4200"></a><span id="l2.4200" class="difflineplus">+        &quot;parts&quot;</span>
<a href="#l2.4201"></a><span id="l2.4201" class="difflineplus">+      ];</span>
<a href="#l2.4202"></a><span id="l2.4202" class="difflineplus">+</span>
<a href="#l2.4203"></a><span id="l2.4203" class="difflineplus">+      var result = Object.create(null);</span>
<a href="#l2.4204"></a><span id="l2.4204" class="difflineplus">+</span>
<a href="#l2.4205"></a><span id="l2.4205" class="difflineplus">+      var i = 0;</span>
<a href="#l2.4206"></a><span id="l2.4206" class="difflineplus">+      var len = propsToCopy.length;</span>
<a href="#l2.4207"></a><span id="l2.4207" class="difflineplus">+      var prop;</span>
<a href="#l2.4208"></a><span id="l2.4208" class="difflineplus">+</span>
<a href="#l2.4209"></a><span id="l2.4209" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.4210"></a><span id="l2.4210" class="difflineplus">+        var prop = propsToCopy[i];</span>
<a href="#l2.4211"></a><span id="l2.4211" class="difflineplus">+        result[prop] = this[prop];</span>
<a href="#l2.4212"></a><span id="l2.4212" class="difflineplus">+      }</span>
<a href="#l2.4213"></a><span id="l2.4213" class="difflineplus">+</span>
<a href="#l2.4214"></a><span id="l2.4214" class="difflineplus">+      if (result.until instanceof ICAL.Time) {</span>
<a href="#l2.4215"></a><span id="l2.4215" class="difflineplus">+        result.until = result.until.toJSON();</span>
<a href="#l2.4216"></a><span id="l2.4216" class="difflineplus">+      }</span>
<a href="#l2.4217"></a><span id="l2.4217" class="difflineplus">+</span>
<a href="#l2.4218"></a><span id="l2.4218" class="difflineplus">+      return result;</span>
<a href="#l2.4219"></a><span id="l2.4219" class="difflineplus">+    },</span>
<a href="#l2.4220"></a><span id="l2.4220" class="difflineplus">+</span>
<a href="#l2.4221"></a><span id="l2.4221" class="difflineplus">+    toString: function icalrecur_toString() {</span>
<a href="#l2.4222"></a><span id="l2.4222" class="difflineplus">+      // TODO retain order</span>
<a href="#l2.4223"></a><span id="l2.4223" class="difflineplus">+      var str = &quot;FREQ=&quot; + this.freq;</span>
<a href="#l2.4224"></a><span id="l2.4224" class="difflineplus">+      if (this.count) {</span>
<a href="#l2.4225"></a><span id="l2.4225" class="difflineplus">+        str += &quot;;COUNT=&quot; + this.count;</span>
<a href="#l2.4226"></a><span id="l2.4226" class="difflineplus">+      }</span>
<a href="#l2.4227"></a><span id="l2.4227" class="difflineplus">+      if (this.interval &gt; 1) {</span>
<a href="#l2.4228"></a><span id="l2.4228" class="difflineplus">+        str += &quot;;INTERVAL=&quot; + this.interval;</span>
<a href="#l2.4229"></a><span id="l2.4229" class="difflineplus">+      }</span>
<a href="#l2.4230"></a><span id="l2.4230" class="difflineplus">+      for (var k in this.parts) {</span>
<a href="#l2.4231"></a><span id="l2.4231" class="difflineplus">+        str += &quot;;&quot; + k + &quot;=&quot; + this.parts[k];</span>
<a href="#l2.4232"></a><span id="l2.4232" class="difflineplus">+      }</span>
<a href="#l2.4233"></a><span id="l2.4233" class="difflineplus">+      if (this.until ){</span>
<a href="#l2.4234"></a><span id="l2.4234" class="difflineplus">+        str += ';UNTIL=' + this.until.toString();</span>
<a href="#l2.4235"></a><span id="l2.4235" class="difflineplus">+      }</span>
<a href="#l2.4236"></a><span id="l2.4236" class="difflineplus">+      if ('wkst' in this &amp;&amp; this.wkst !== ICAL.Time.DEFAULT_WEEK_START) {</span>
<a href="#l2.4237"></a><span id="l2.4237" class="difflineplus">+        str += ';WKST=' + ICAL.Recur.numericDayToIcalDay(this.wkst);</span>
<a href="#l2.4238"></a><span id="l2.4238" class="difflineplus">+      }</span>
<a href="#l2.4239"></a><span id="l2.4239" class="difflineplus">+      return str;</span>
<a href="#l2.4240"></a><span id="l2.4240" class="difflineplus">+    }</span>
<a href="#l2.4241"></a><span id="l2.4241" class="difflineplus">+  };</span>
<a href="#l2.4242"></a><span id="l2.4242" class="difflineplus">+</span>
<a href="#l2.4243"></a><span id="l2.4243" class="difflineplus">+  function parseNumericValue(type, min, max, value) {</span>
<a href="#l2.4244"></a><span id="l2.4244" class="difflineplus">+    var result = value;</span>
<a href="#l2.4245"></a><span id="l2.4245" class="difflineplus">+</span>
<a href="#l2.4246"></a><span id="l2.4246" class="difflineplus">+    if (value[0] === '+') {</span>
<a href="#l2.4247"></a><span id="l2.4247" class="difflineplus">+      result = value.substr(1);</span>
<a href="#l2.4248"></a><span id="l2.4248" class="difflineplus">+    }</span>
<a href="#l2.4249"></a><span id="l2.4249" class="difflineplus">+</span>
<a href="#l2.4250"></a><span id="l2.4250" class="difflineplus">+    result = ICAL.helpers.strictParseInt(result);</span>
<a href="#l2.4251"></a><span id="l2.4251" class="difflineplus">+</span>
<a href="#l2.4252"></a><span id="l2.4252" class="difflineplus">+    if (min !== undefined &amp;&amp; value &lt; min) {</span>
<a href="#l2.4253"></a><span id="l2.4253" class="difflineplus">+      throw new Error(</span>
<a href="#l2.4254"></a><span id="l2.4254" class="difflineplus">+        type + ': invalid value &quot;' + value + '&quot; must be &gt; ' + min</span>
<a href="#l2.4255"></a><span id="l2.4255" class="difflineplus">+      );</span>
<a href="#l2.4256"></a><span id="l2.4256" class="difflineplus">+    }</span>
<a href="#l2.4257"></a><span id="l2.4257" class="difflineplus">+</span>
<a href="#l2.4258"></a><span id="l2.4258" class="difflineplus">+    if (max !== undefined &amp;&amp; value &gt; max) {</span>
<a href="#l2.4259"></a><span id="l2.4259" class="difflineplus">+      throw new Error(</span>
<a href="#l2.4260"></a><span id="l2.4260" class="difflineplus">+        type + ': invalid value &quot;' + value + '&quot; must be &lt; ' + min</span>
<a href="#l2.4261"></a><span id="l2.4261" class="difflineplus">+      );</span>
<a href="#l2.4262"></a><span id="l2.4262" class="difflineplus">+    }</span>
<a href="#l2.4263"></a><span id="l2.4263" class="difflineplus">+</span>
<a href="#l2.4264"></a><span id="l2.4264" class="difflineplus">+    return result;</span>
<a href="#l2.4265"></a><span id="l2.4265" class="difflineplus">+  }</span>
<a href="#l2.4266"></a><span id="l2.4266" class="difflineplus">+</span>
<a href="#l2.4267"></a><span id="l2.4267" class="difflineplus">+  /**</span>
<a href="#l2.4268"></a><span id="l2.4268" class="difflineplus">+   * Convert an ical representation of a day (SU, MO, etc..)</span>
<a href="#l2.4269"></a><span id="l2.4269" class="difflineplus">+   * into a numeric value of that day.</span>
<a href="#l2.4270"></a><span id="l2.4270" class="difflineplus">+   *</span>
<a href="#l2.4271"></a><span id="l2.4271" class="difflineplus">+   * @param {String} day ical day.</span>
<a href="#l2.4272"></a><span id="l2.4272" class="difflineplus">+   * @return {Numeric} numeric value of given day.</span>
<a href="#l2.4273"></a><span id="l2.4273" class="difflineplus">+   */</span>
<a href="#l2.4274"></a><span id="l2.4274" class="difflineplus">+  ICAL.Recur.icalDayToNumericDay = function toNumericDay(string) {</span>
<a href="#l2.4275"></a><span id="l2.4275" class="difflineplus">+    //XXX: this is here so we can deal</span>
<a href="#l2.4276"></a><span id="l2.4276" class="difflineplus">+    //     with possibly invalid string values.</span>
<a href="#l2.4277"></a><span id="l2.4277" class="difflineplus">+</span>
<a href="#l2.4278"></a><span id="l2.4278" class="difflineplus">+    return DOW_MAP[string];</span>
<a href="#l2.4279"></a><span id="l2.4279" class="difflineplus">+  };</span>
<a href="#l2.4280"></a><span id="l2.4280" class="difflineplus">+</span>
<a href="#l2.4281"></a><span id="l2.4281" class="difflineplus">+  ICAL.Recur.numericDayToIcalDay = function toIcalDay(num) {</span>
<a href="#l2.4282"></a><span id="l2.4282" class="difflineplus">+    return REVERSE_DOW_MAP[num];</span>
<a href="#l2.4283"></a><span id="l2.4283" class="difflineplus">+  };</span>
<a href="#l2.4284"></a><span id="l2.4284" class="difflineplus">+</span>
<a href="#l2.4285"></a><span id="l2.4285" class="difflineplus">+  var VALID_DAY_NAMES = /^(SU|MO|TU|WE|TH|FR|SA)$/;</span>
<a href="#l2.4286"></a><span id="l2.4286" class="difflineplus">+  var VALID_BYDAY_PART = /^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/</span>
<a href="#l2.4287"></a><span id="l2.4287" class="difflineplus">+  var ALLOWED_FREQ = ['SECONDLY', 'MINUTELY', 'HOURLY',</span>
<a href="#l2.4288"></a><span id="l2.4288" class="difflineplus">+                      'DAILY', 'WEEKLY', 'MONTHLY', 'YEARLY'];</span>
<a href="#l2.4289"></a><span id="l2.4289" class="difflineplus">+</span>
<a href="#l2.4290"></a><span id="l2.4290" class="difflineplus">+  var optionDesign = {</span>
<a href="#l2.4291"></a><span id="l2.4291" class="difflineplus">+    FREQ: function(value, dict) {</span>
<a href="#l2.4292"></a><span id="l2.4292" class="difflineplus">+      // yes this is actually equal or faster then regex.</span>
<a href="#l2.4293"></a><span id="l2.4293" class="difflineplus">+      // upside here is we can enumerate the valid values.</span>
<a href="#l2.4294"></a><span id="l2.4294" class="difflineplus">+      if (ALLOWED_FREQ.indexOf(value) !== -1) {</span>
<a href="#l2.4295"></a><span id="l2.4295" class="difflineplus">+        dict.freq = value;</span>
<a href="#l2.4296"></a><span id="l2.4296" class="difflineplus">+      } else {</span>
<a href="#l2.4297"></a><span id="l2.4297" class="difflineplus">+        throw new Error(</span>
<a href="#l2.4298"></a><span id="l2.4298" class="difflineplus">+          'invalid frequency &quot;' + value + '&quot; expected: &quot;' +</span>
<a href="#l2.4299"></a><span id="l2.4299" class="difflineplus">+          ALLOWED_FREQ.join(', ') + '&quot;'</span>
<a href="#l2.4300"></a><span id="l2.4300" class="difflineplus">+        );</span>
<a href="#l2.4301"></a><span id="l2.4301" class="difflineplus">+      }</span>
<a href="#l2.4302"></a><span id="l2.4302" class="difflineplus">+    },</span>
<a href="#l2.4303"></a><span id="l2.4303" class="difflineplus">+</span>
<a href="#l2.4304"></a><span id="l2.4304" class="difflineplus">+    COUNT: function(value, dict) {</span>
<a href="#l2.4305"></a><span id="l2.4305" class="difflineplus">+      dict.count = ICAL.helpers.strictParseInt(value);</span>
<a href="#l2.4306"></a><span id="l2.4306" class="difflineplus">+    },</span>
<a href="#l2.4307"></a><span id="l2.4307" class="difflineplus">+</span>
<a href="#l2.4308"></a><span id="l2.4308" class="difflineplus">+    INTERVAL: function(value, dict) {</span>
<a href="#l2.4309"></a><span id="l2.4309" class="difflineplus">+      dict.interval = ICAL.helpers.strictParseInt(value);</span>
<a href="#l2.4310"></a><span id="l2.4310" class="difflineplus">+    },</span>
<a href="#l2.4311"></a><span id="l2.4311" class="difflineplus">+</span>
<a href="#l2.4312"></a><span id="l2.4312" class="difflineplus">+    UNTIL: function(value, dict) {</span>
<a href="#l2.4313"></a><span id="l2.4313" class="difflineplus">+      dict.until = ICAL.Time.fromString(value);</span>
<a href="#l2.4314"></a><span id="l2.4314" class="difflineplus">+    },</span>
<a href="#l2.4315"></a><span id="l2.4315" class="difflineplus">+</span>
<a href="#l2.4316"></a><span id="l2.4316" class="difflineplus">+    WKST: function(value, dict) {</span>
<a href="#l2.4317"></a><span id="l2.4317" class="difflineplus">+      if (VALID_DAY_NAMES.test(value)) {</span>
<a href="#l2.4318"></a><span id="l2.4318" class="difflineplus">+        dict.wkst = ICAL.Recur.icalDayToNumericDay(value);</span>
<a href="#l2.4319"></a><span id="l2.4319" class="difflineplus">+      } else {</span>
<a href="#l2.4320"></a><span id="l2.4320" class="difflineplus">+        throw new Error('invalid WKST value &quot;' + value + '&quot;');</span>
<a href="#l2.4321"></a><span id="l2.4321" class="difflineplus">+      }</span>
<a href="#l2.4322"></a><span id="l2.4322" class="difflineplus">+    }</span>
<a href="#l2.4323"></a><span id="l2.4323" class="difflineplus">+  };</span>
<a href="#l2.4324"></a><span id="l2.4324" class="difflineplus">+</span>
<a href="#l2.4325"></a><span id="l2.4325" class="difflineplus">+  var partDesign = {</span>
<a href="#l2.4326"></a><span id="l2.4326" class="difflineplus">+    BYSECOND: parseNumericValue.bind(this, 'BYSECOND', 0, 60),</span>
<a href="#l2.4327"></a><span id="l2.4327" class="difflineplus">+    BYMINUTE: parseNumericValue.bind(this, 'BYMINUTE', 0, 59),</span>
<a href="#l2.4328"></a><span id="l2.4328" class="difflineplus">+    BYHOUR: parseNumericValue.bind(this, 'BYHOUR', 0, 23),</span>
<a href="#l2.4329"></a><span id="l2.4329" class="difflineplus">+    BYDAY: function(value) {</span>
<a href="#l2.4330"></a><span id="l2.4330" class="difflineplus">+      if (VALID_BYDAY_PART.test(value)) {</span>
<a href="#l2.4331"></a><span id="l2.4331" class="difflineplus">+        return value;</span>
<a href="#l2.4332"></a><span id="l2.4332" class="difflineplus">+      } else {</span>
<a href="#l2.4333"></a><span id="l2.4333" class="difflineplus">+        throw new Error('invalid BYDAY value &quot;' + value + '&quot;');</span>
<a href="#l2.4334"></a><span id="l2.4334" class="difflineplus">+      }</span>
<a href="#l2.4335"></a><span id="l2.4335" class="difflineplus">+    },</span>
<a href="#l2.4336"></a><span id="l2.4336" class="difflineplus">+    BYMONTHDAY: parseNumericValue.bind(this, 'BYMONTHDAY', -31, 31),</span>
<a href="#l2.4337"></a><span id="l2.4337" class="difflineplus">+    BYYEARDAY: parseNumericValue.bind(this, 'BYYEARDAY', -366, 366),</span>
<a href="#l2.4338"></a><span id="l2.4338" class="difflineplus">+    BYWEEKNO: parseNumericValue.bind(this, 'BYWEEKNO', -53, 53),</span>
<a href="#l2.4339"></a><span id="l2.4339" class="difflineplus">+    BYMONTH: parseNumericValue.bind(this, 'BYMONTH', 0, 12),</span>
<a href="#l2.4340"></a><span id="l2.4340" class="difflineplus">+    BYSETPOS: parseNumericValue.bind(this, 'BYSETPOS', -366, 366)</span>
<a href="#l2.4341"></a><span id="l2.4341" class="difflineplus">+  };</span>
<a href="#l2.4342"></a><span id="l2.4342" class="difflineplus">+</span>
<a href="#l2.4343"></a><span id="l2.4343" class="difflineplus">+  ICAL.Recur.fromString = function(string) {</span>
<a href="#l2.4344"></a><span id="l2.4344" class="difflineplus">+    var dict = Object.create(null);</span>
<a href="#l2.4345"></a><span id="l2.4345" class="difflineplus">+    var dictParts = dict.parts = {};</span>
<a href="#l2.4346"></a><span id="l2.4346" class="difflineplus">+</span>
<a href="#l2.4347"></a><span id="l2.4347" class="difflineplus">+    // split is slower in FF but fast enough.</span>
<a href="#l2.4348"></a><span id="l2.4348" class="difflineplus">+    // v8 however this is faster then manual split?</span>
<a href="#l2.4349"></a><span id="l2.4349" class="difflineplus">+    var values = string.split(';');</span>
<a href="#l2.4350"></a><span id="l2.4350" class="difflineplus">+    var len = values.length;</span>
<a href="#l2.4351"></a><span id="l2.4351" class="difflineplus">+</span>
<a href="#l2.4352"></a><span id="l2.4352" class="difflineplus">+    for (var i = 0; i &lt; len; i++) {</span>
<a href="#l2.4353"></a><span id="l2.4353" class="difflineplus">+      var parts = values[i].split('=');</span>
<a href="#l2.4354"></a><span id="l2.4354" class="difflineplus">+      var name = parts[0];</span>
<a href="#l2.4355"></a><span id="l2.4355" class="difflineplus">+      var value = parts[1];</span>
<a href="#l2.4356"></a><span id="l2.4356" class="difflineplus">+</span>
<a href="#l2.4357"></a><span id="l2.4357" class="difflineplus">+      if (name in partDesign) {</span>
<a href="#l2.4358"></a><span id="l2.4358" class="difflineplus">+        var partArr = value.split(',');</span>
<a href="#l2.4359"></a><span id="l2.4359" class="difflineplus">+        var partArrIdx = 0;</span>
<a href="#l2.4360"></a><span id="l2.4360" class="difflineplus">+        var partArrLen = partArr.length;</span>
<a href="#l2.4361"></a><span id="l2.4361" class="difflineplus">+</span>
<a href="#l2.4362"></a><span id="l2.4362" class="difflineplus">+        for (; partArrIdx &lt; partArrLen; partArrIdx++) {</span>
<a href="#l2.4363"></a><span id="l2.4363" class="difflineplus">+          partArr[partArrIdx] = partDesign[name](partArr[partArrIdx]);</span>
<a href="#l2.4364"></a><span id="l2.4364" class="difflineplus">+        }</span>
<a href="#l2.4365"></a><span id="l2.4365" class="difflineplus">+        dictParts[name] = partArr;</span>
<a href="#l2.4366"></a><span id="l2.4366" class="difflineplus">+      } else if (name in optionDesign) {</span>
<a href="#l2.4367"></a><span id="l2.4367" class="difflineplus">+        optionDesign[name](value, dict);</span>
<a href="#l2.4368"></a><span id="l2.4368" class="difflineplus">+      }</span>
<a href="#l2.4369"></a><span id="l2.4369" class="difflineplus">+    }</span>
<a href="#l2.4370"></a><span id="l2.4370" class="difflineplus">+</span>
<a href="#l2.4371"></a><span id="l2.4371" class="difflineplus">+    return new ICAL.Recur(dict);</span>
<a href="#l2.4372"></a><span id="l2.4372" class="difflineplus">+  };</span>
<a href="#l2.4373"></a><span id="l2.4373" class="difflineplus">+</span>
<a href="#l2.4374"></a><span id="l2.4374" class="difflineplus">+})();</span>
<a href="#l2.4375"></a><span id="l2.4375" class="difflineplus">+ICAL.RecurIterator = (function() {</span>
<a href="#l2.4376"></a><span id="l2.4376" class="difflineplus">+</span>
<a href="#l2.4377"></a><span id="l2.4377" class="difflineplus">+  /**</span>
<a href="#l2.4378"></a><span id="l2.4378" class="difflineplus">+   * Options:</span>
<a href="#l2.4379"></a><span id="l2.4379" class="difflineplus">+   *  - rule: (ICAL.Recur) instance</span>
<a href="#l2.4380"></a><span id="l2.4380" class="difflineplus">+   *  - dtstart: (ICAL.Time) start date of recurrence rule</span>
<a href="#l2.4381"></a><span id="l2.4381" class="difflineplus">+   *  - initialized: (Boolean) when true will assume options</span>
<a href="#l2.4382"></a><span id="l2.4382" class="difflineplus">+   *                           are from previously constructed</span>
<a href="#l2.4383"></a><span id="l2.4383" class="difflineplus">+   *                           iterator and will not re-initialize</span>
<a href="#l2.4384"></a><span id="l2.4384" class="difflineplus">+   *                           iterator but resume its state from given data.</span>
<a href="#l2.4385"></a><span id="l2.4385" class="difflineplus">+   *</span>
<a href="#l2.4386"></a><span id="l2.4386" class="difflineplus">+   *  - by_data: (for iterator de-serialization)</span>
<a href="#l2.4387"></a><span id="l2.4387" class="difflineplus">+   *  - days: &quot;</span>
<a href="#l2.4388"></a><span id="l2.4388" class="difflineplus">+   *  - last: &quot;</span>
<a href="#l2.4389"></a><span id="l2.4389" class="difflineplus">+   *  - by_indices: &quot;</span>
<a href="#l2.4390"></a><span id="l2.4390" class="difflineplus">+   */</span>
<a href="#l2.4391"></a><span id="l2.4391" class="difflineplus">+  function icalrecur_iterator(options) {</span>
<a href="#l2.4392"></a><span id="l2.4392" class="difflineplus">+    this.fromData(options);</span>
<a href="#l2.4393"></a><span id="l2.4393" class="difflineplus">+  }</span>
<a href="#l2.4394"></a><span id="l2.4394" class="difflineplus">+</span>
<a href="#l2.4395"></a><span id="l2.4395" class="difflineplus">+  icalrecur_iterator.prototype = {</span>
<a href="#l2.4396"></a><span id="l2.4396" class="difflineplus">+</span>
<a href="#l2.4397"></a><span id="l2.4397" class="difflineplus">+    /**</span>
<a href="#l2.4398"></a><span id="l2.4398" class="difflineplus">+     * True when iteration is finished.</span>
<a href="#l2.4399"></a><span id="l2.4399" class="difflineplus">+     */</span>
<a href="#l2.4400"></a><span id="l2.4400" class="difflineplus">+    completed: false,</span>
<a href="#l2.4401"></a><span id="l2.4401" class="difflineplus">+</span>
<a href="#l2.4402"></a><span id="l2.4402" class="difflineplus">+    rule: null,</span>
<a href="#l2.4403"></a><span id="l2.4403" class="difflineplus">+    dtstart: null,</span>
<a href="#l2.4404"></a><span id="l2.4404" class="difflineplus">+    last: null,</span>
<a href="#l2.4405"></a><span id="l2.4405" class="difflineplus">+    occurrence_number: 0,</span>
<a href="#l2.4406"></a><span id="l2.4406" class="difflineplus">+    by_indices: null,</span>
<a href="#l2.4407"></a><span id="l2.4407" class="difflineplus">+    initialized: false,</span>
<a href="#l2.4408"></a><span id="l2.4408" class="difflineplus">+    by_data: null,</span>
<a href="#l2.4409"></a><span id="l2.4409" class="difflineplus">+</span>
<a href="#l2.4410"></a><span id="l2.4410" class="difflineplus">+    days: null,</span>
<a href="#l2.4411"></a><span id="l2.4411" class="difflineplus">+    days_index: 0,</span>
<a href="#l2.4412"></a><span id="l2.4412" class="difflineplus">+</span>
<a href="#l2.4413"></a><span id="l2.4413" class="difflineplus">+    fromData: function(options) {</span>
<a href="#l2.4414"></a><span id="l2.4414" class="difflineplus">+      this.rule = ICAL.helpers.formatClassType(options.rule, ICAL.Recur);</span>
<a href="#l2.4415"></a><span id="l2.4415" class="difflineplus">+</span>
<a href="#l2.4416"></a><span id="l2.4416" class="difflineplus">+      if (!this.rule) {</span>
<a href="#l2.4417"></a><span id="l2.4417" class="difflineplus">+        throw new Error('iterator requires a (ICAL.Recur) rule');</span>
<a href="#l2.4418"></a><span id="l2.4418" class="difflineplus">+      }</span>
<a href="#l2.4419"></a><span id="l2.4419" class="difflineplus">+</span>
<a href="#l2.4420"></a><span id="l2.4420" class="difflineplus">+      this.dtstart = ICAL.helpers.formatClassType(options.dtstart, ICAL.Time);</span>
<a href="#l2.4421"></a><span id="l2.4421" class="difflineplus">+</span>
<a href="#l2.4422"></a><span id="l2.4422" class="difflineplus">+      if (!this.dtstart) {</span>
<a href="#l2.4423"></a><span id="l2.4423" class="difflineplus">+        throw new Error('iterator requires a (ICAL.Time) dtstart');</span>
<a href="#l2.4424"></a><span id="l2.4424" class="difflineplus">+      }</span>
<a href="#l2.4425"></a><span id="l2.4425" class="difflineplus">+</span>
<a href="#l2.4426"></a><span id="l2.4426" class="difflineplus">+      if (options.by_data) {</span>
<a href="#l2.4427"></a><span id="l2.4427" class="difflineplus">+        this.by_data = options.by_data;</span>
<a href="#l2.4428"></a><span id="l2.4428" class="difflineplus">+      } else {</span>
<a href="#l2.4429"></a><span id="l2.4429" class="difflineplus">+        this.by_data = ICAL.helpers.clone(this.rule.parts, true);</span>
<a href="#l2.4430"></a><span id="l2.4430" class="difflineplus">+      }</span>
<a href="#l2.4431"></a><span id="l2.4431" class="difflineplus">+</span>
<a href="#l2.4432"></a><span id="l2.4432" class="difflineplus">+      if (options.occurrence_number)</span>
<a href="#l2.4433"></a><span id="l2.4433" class="difflineplus">+        this.occurrence_number = options.occurrence_number;</span>
<a href="#l2.4434"></a><span id="l2.4434" class="difflineplus">+</span>
<a href="#l2.4435"></a><span id="l2.4435" class="difflineplus">+      this.days = options.days || [];</span>
<a href="#l2.4436"></a><span id="l2.4436" class="difflineplus">+      this.last = ICAL.helpers.formatClassType(options.last, ICAL.Time);</span>
<a href="#l2.4437"></a><span id="l2.4437" class="difflineplus">+</span>
<a href="#l2.4438"></a><span id="l2.4438" class="difflineplus">+      this.by_indices = options.by_indices;</span>
<a href="#l2.4439"></a><span id="l2.4439" class="difflineplus">+</span>
<a href="#l2.4440"></a><span id="l2.4440" class="difflineplus">+      if (!this.by_indices) {</span>
<a href="#l2.4441"></a><span id="l2.4441" class="difflineplus">+        this.by_indices = {</span>
<a href="#l2.4442"></a><span id="l2.4442" class="difflineplus">+          &quot;BYSECOND&quot;: 0,</span>
<a href="#l2.4443"></a><span id="l2.4443" class="difflineplus">+          &quot;BYMINUTE&quot;: 0,</span>
<a href="#l2.4444"></a><span id="l2.4444" class="difflineplus">+          &quot;BYHOUR&quot;: 0,</span>
<a href="#l2.4445"></a><span id="l2.4445" class="difflineplus">+          &quot;BYDAY&quot;: 0,</span>
<a href="#l2.4446"></a><span id="l2.4446" class="difflineplus">+          &quot;BYMONTH&quot;: 0,</span>
<a href="#l2.4447"></a><span id="l2.4447" class="difflineplus">+          &quot;BYWEEKNO&quot;: 0,</span>
<a href="#l2.4448"></a><span id="l2.4448" class="difflineplus">+          &quot;BYMONTHDAY&quot;: 0</span>
<a href="#l2.4449"></a><span id="l2.4449" class="difflineplus">+        };</span>
<a href="#l2.4450"></a><span id="l2.4450" class="difflineplus">+      }</span>
<a href="#l2.4451"></a><span id="l2.4451" class="difflineplus">+</span>
<a href="#l2.4452"></a><span id="l2.4452" class="difflineplus">+      this.initialized = options.initialized || false;</span>
<a href="#l2.4453"></a><span id="l2.4453" class="difflineplus">+</span>
<a href="#l2.4454"></a><span id="l2.4454" class="difflineplus">+      if (!this.initialized) {</span>
<a href="#l2.4455"></a><span id="l2.4455" class="difflineplus">+        this.init();</span>
<a href="#l2.4456"></a><span id="l2.4456" class="difflineplus">+      }</span>
<a href="#l2.4457"></a><span id="l2.4457" class="difflineplus">+    },</span>
<a href="#l2.4458"></a><span id="l2.4458" class="difflineplus">+</span>
<a href="#l2.4459"></a><span id="l2.4459" class="difflineplus">+    init: function icalrecur_iterator_init() {</span>
<a href="#l2.4460"></a><span id="l2.4460" class="difflineplus">+      this.initialized = true;</span>
<a href="#l2.4461"></a><span id="l2.4461" class="difflineplus">+      this.last = this.dtstart.clone();</span>
<a href="#l2.4462"></a><span id="l2.4462" class="difflineplus">+      var parts = this.by_data;</span>
<a href="#l2.4463"></a><span id="l2.4463" class="difflineplus">+</span>
<a href="#l2.4464"></a><span id="l2.4464" class="difflineplus">+      if (&quot;BYDAY&quot; in parts) {</span>
<a href="#l2.4465"></a><span id="l2.4465" class="difflineplus">+        // libical does this earlier when the rule is loaded, but we postpone to</span>
<a href="#l2.4466"></a><span id="l2.4466" class="difflineplus">+        // now so we can preserve the original order.</span>
<a href="#l2.4467"></a><span id="l2.4467" class="difflineplus">+        this.sort_byday_rules(parts.BYDAY, this.rule.wkst);</span>
<a href="#l2.4468"></a><span id="l2.4468" class="difflineplus">+      }</span>
<a href="#l2.4469"></a><span id="l2.4469" class="difflineplus">+</span>
<a href="#l2.4470"></a><span id="l2.4470" class="difflineplus">+      // If the BYYEARDAY appares, no other date rule part may appear</span>
<a href="#l2.4471"></a><span id="l2.4471" class="difflineplus">+      if (&quot;BYYEARDAY&quot; in parts) {</span>
<a href="#l2.4472"></a><span id="l2.4472" class="difflineplus">+        if (&quot;BYMONTH&quot; in parts || &quot;BYWEEKNO&quot; in parts ||</span>
<a href="#l2.4473"></a><span id="l2.4473" class="difflineplus">+            &quot;BYMONTHDAY&quot; in parts || &quot;BYDAY&quot; in parts) {</span>
<a href="#l2.4474"></a><span id="l2.4474" class="difflineplus">+          throw new Error(&quot;Invalid BYYEARDAY rule&quot;);</span>
<a href="#l2.4475"></a><span id="l2.4475" class="difflineplus">+        }</span>
<a href="#l2.4476"></a><span id="l2.4476" class="difflineplus">+      }</span>
<a href="#l2.4477"></a><span id="l2.4477" class="difflineplus">+</span>
<a href="#l2.4478"></a><span id="l2.4478" class="difflineplus">+      // BYWEEKNO and BYMONTHDAY rule parts may not both appear</span>
<a href="#l2.4479"></a><span id="l2.4479" class="difflineplus">+      if (&quot;BYWEEKNO&quot; in parts &amp;&amp; &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l2.4480"></a><span id="l2.4480" class="difflineplus">+        throw new Error(&quot;BYWEEKNO does not fit to BYMONTHDAY&quot;);</span>
<a href="#l2.4481"></a><span id="l2.4481" class="difflineplus">+      }</span>
<a href="#l2.4482"></a><span id="l2.4482" class="difflineplus">+</span>
<a href="#l2.4483"></a><span id="l2.4483" class="difflineplus">+      // For MONTHLY recurrences (FREQ=MONTHLY) neither BYYEARDAY nor</span>
<a href="#l2.4484"></a><span id="l2.4484" class="difflineplus">+      // BYWEEKNO may appear.</span>
<a href="#l2.4485"></a><span id="l2.4485" class="difflineplus">+      if (this.rule.freq == &quot;MONTHLY&quot; &amp;&amp;</span>
<a href="#l2.4486"></a><span id="l2.4486" class="difflineplus">+          (&quot;BYYEARDAY&quot; in parts || &quot;BYWEEKNO&quot; in parts)) {</span>
<a href="#l2.4487"></a><span id="l2.4487" class="difflineplus">+        throw new Error(&quot;For MONTHLY recurrences neither BYYEARDAY nor BYWEEKNO may appear&quot;);</span>
<a href="#l2.4488"></a><span id="l2.4488" class="difflineplus">+      }</span>
<a href="#l2.4489"></a><span id="l2.4489" class="difflineplus">+</span>
<a href="#l2.4490"></a><span id="l2.4490" class="difflineplus">+      // For WEEKLY recurrences (FREQ=WEEKLY) neither BYMONTHDAY nor</span>
<a href="#l2.4491"></a><span id="l2.4491" class="difflineplus">+      // BYYEARDAY may appear.</span>
<a href="#l2.4492"></a><span id="l2.4492" class="difflineplus">+      if (this.rule.freq == &quot;WEEKLY&quot; &amp;&amp;</span>
<a href="#l2.4493"></a><span id="l2.4493" class="difflineplus">+          (&quot;BYYEARDAY&quot; in parts || &quot;BYMONTHDAY&quot; in parts)) {</span>
<a href="#l2.4494"></a><span id="l2.4494" class="difflineplus">+        throw new Error(&quot;For WEEKLY recurrences neither BYMONTHDAY nor BYYEARDAY may appear&quot;);</span>
<a href="#l2.4495"></a><span id="l2.4495" class="difflineplus">+      }</span>
<a href="#l2.4496"></a><span id="l2.4496" class="difflineplus">+</span>
<a href="#l2.4497"></a><span id="l2.4497" class="difflineplus">+      // BYYEARDAY may only appear in YEARLY rules</span>
<a href="#l2.4498"></a><span id="l2.4498" class="difflineplus">+      if (this.rule.freq != &quot;YEARLY&quot; &amp;&amp; &quot;BYYEARDAY&quot; in parts) {</span>
<a href="#l2.4499"></a><span id="l2.4499" class="difflineplus">+        throw new Error(&quot;BYYEARDAY may only appear in YEARLY rules&quot;);</span>
<a href="#l2.4500"></a><span id="l2.4500" class="difflineplus">+      }</span>
<a href="#l2.4501"></a><span id="l2.4501" class="difflineplus">+</span>
<a href="#l2.4502"></a><span id="l2.4502" class="difflineplus">+      this.last.second = this.setup_defaults(&quot;BYSECOND&quot;, &quot;SECONDLY&quot;, this.dtstart.second);</span>
<a href="#l2.4503"></a><span id="l2.4503" class="difflineplus">+      this.last.minute = this.setup_defaults(&quot;BYMINUTE&quot;, &quot;MINUTELY&quot;, this.dtstart.minute);</span>
<a href="#l2.4504"></a><span id="l2.4504" class="difflineplus">+      this.last.hour = this.setup_defaults(&quot;BYHOUR&quot;, &quot;HOURLY&quot;, this.dtstart.hour);</span>
<a href="#l2.4505"></a><span id="l2.4505" class="difflineplus">+      this.last.day = this.setup_defaults(&quot;BYMONTHDAY&quot;, &quot;DAILY&quot;, this.dtstart.day);</span>
<a href="#l2.4506"></a><span id="l2.4506" class="difflineplus">+      this.last.month = this.setup_defaults(&quot;BYMONTH&quot;, &quot;MONTHLY&quot;, this.dtstart.month);</span>
<a href="#l2.4507"></a><span id="l2.4507" class="difflineplus">+</span>
<a href="#l2.4508"></a><span id="l2.4508" class="difflineplus">+      if (this.rule.freq == &quot;WEEKLY&quot;) {</span>
<a href="#l2.4509"></a><span id="l2.4509" class="difflineplus">+        if (&quot;BYDAY&quot; in parts) {</span>
<a href="#l2.4510"></a><span id="l2.4510" class="difflineplus">+          var parts = this.ruleDayOfWeek(parts.BYDAY[0]);</span>
<a href="#l2.4511"></a><span id="l2.4511" class="difflineplus">+          var pos = parts[0];</span>
<a href="#l2.4512"></a><span id="l2.4512" class="difflineplus">+          var rule_dow = parts[1];</span>
<a href="#l2.4513"></a><span id="l2.4513" class="difflineplus">+          var dow = rule_dow - this.last.dayOfWeek();</span>
<a href="#l2.4514"></a><span id="l2.4514" class="difflineplus">+          if ((this.last.dayOfWeek() &lt; rule_dow &amp;&amp; dow &gt;= 0) || dow &lt; 0) {</span>
<a href="#l2.4515"></a><span id="l2.4515" class="difflineplus">+            // Initial time is after first day of BYDAY data</span>
<a href="#l2.4516"></a><span id="l2.4516" class="difflineplus">+            this.last.day += dow;</span>
<a href="#l2.4517"></a><span id="l2.4517" class="difflineplus">+          }</span>
<a href="#l2.4518"></a><span id="l2.4518" class="difflineplus">+        } else {</span>
<a href="#l2.4519"></a><span id="l2.4519" class="difflineplus">+          var wkMap = icalrecur_iterator._wkdayMap[this.dtstart.dayOfWeek()];</span>
<a href="#l2.4520"></a><span id="l2.4520" class="difflineplus">+          parts.BYDAY = [wkMap];</span>
<a href="#l2.4521"></a><span id="l2.4521" class="difflineplus">+        }</span>
<a href="#l2.4522"></a><span id="l2.4522" class="difflineplus">+      }</span>
<a href="#l2.4523"></a><span id="l2.4523" class="difflineplus">+</span>
<a href="#l2.4524"></a><span id="l2.4524" class="difflineplus">+      if (this.rule.freq == &quot;YEARLY&quot;) {</span>
<a href="#l2.4525"></a><span id="l2.4525" class="difflineplus">+        for (;;) {</span>
<a href="#l2.4526"></a><span id="l2.4526" class="difflineplus">+          this.expand_year_days(this.last.year);</span>
<a href="#l2.4527"></a><span id="l2.4527" class="difflineplus">+          if (this.days.length &gt; 0) {</span>
<a href="#l2.4528"></a><span id="l2.4528" class="difflineplus">+            break;</span>
<a href="#l2.4529"></a><span id="l2.4529" class="difflineplus">+          }</span>
<a href="#l2.4530"></a><span id="l2.4530" class="difflineplus">+          this.increment_year(this.rule.interval || 1);</span>
<a href="#l2.4531"></a><span id="l2.4531" class="difflineplus">+        }</span>
<a href="#l2.4532"></a><span id="l2.4532" class="difflineplus">+</span>
<a href="#l2.4533"></a><span id="l2.4533" class="difflineplus">+        var next = ICAL.Time.fromDayOfYear(this.days[0], this.last.year);</span>
<a href="#l2.4534"></a><span id="l2.4534" class="difflineplus">+</span>
<a href="#l2.4535"></a><span id="l2.4535" class="difflineplus">+        this.last.day = next.day;</span>
<a href="#l2.4536"></a><span id="l2.4536" class="difflineplus">+        this.last.month = next.month;</span>
<a href="#l2.4537"></a><span id="l2.4537" class="difflineplus">+      }</span>
<a href="#l2.4538"></a><span id="l2.4538" class="difflineplus">+</span>
<a href="#l2.4539"></a><span id="l2.4539" class="difflineplus">+      if (this.rule.freq == &quot;MONTHLY&quot; &amp;&amp; this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l2.4540"></a><span id="l2.4540" class="difflineplus">+</span>
<a href="#l2.4541"></a><span id="l2.4541" class="difflineplus">+        var coded_day = this.by_data.BYDAY[this.by_indices.BYDAY];</span>
<a href="#l2.4542"></a><span id="l2.4542" class="difflineplus">+        var parts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l2.4543"></a><span id="l2.4543" class="difflineplus">+        var pos = parts[0];</span>
<a href="#l2.4544"></a><span id="l2.4544" class="difflineplus">+        var dow = parts[1];</span>
<a href="#l2.4545"></a><span id="l2.4545" class="difflineplus">+</span>
<a href="#l2.4546"></a><span id="l2.4546" class="difflineplus">+        var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.4547"></a><span id="l2.4547" class="difflineplus">+        var poscount = 0;</span>
<a href="#l2.4548"></a><span id="l2.4548" class="difflineplus">+</span>
<a href="#l2.4549"></a><span id="l2.4549" class="difflineplus">+        if (pos &gt;= 0) {</span>
<a href="#l2.4550"></a><span id="l2.4550" class="difflineplus">+          for (this.last.day = 1; this.last.day &lt;= daysInMonth; this.last.day++) {</span>
<a href="#l2.4551"></a><span id="l2.4551" class="difflineplus">+            if (this.last.dayOfWeek() == dow) {</span>
<a href="#l2.4552"></a><span id="l2.4552" class="difflineplus">+              if (++poscount == pos || pos == 0) {</span>
<a href="#l2.4553"></a><span id="l2.4553" class="difflineplus">+                break;</span>
<a href="#l2.4554"></a><span id="l2.4554" class="difflineplus">+              }</span>
<a href="#l2.4555"></a><span id="l2.4555" class="difflineplus">+            }</span>
<a href="#l2.4556"></a><span id="l2.4556" class="difflineplus">+          }</span>
<a href="#l2.4557"></a><span id="l2.4557" class="difflineplus">+        } else {</span>
<a href="#l2.4558"></a><span id="l2.4558" class="difflineplus">+          pos = -pos;</span>
<a href="#l2.4559"></a><span id="l2.4559" class="difflineplus">+          for (this.last.day = daysInMonth; this.last.day != 0; this.last.day--) {</span>
<a href="#l2.4560"></a><span id="l2.4560" class="difflineplus">+            if (this.last.dayOfWeek() == dow) {</span>
<a href="#l2.4561"></a><span id="l2.4561" class="difflineplus">+              if (++poscount == pos) {</span>
<a href="#l2.4562"></a><span id="l2.4562" class="difflineplus">+                break;</span>
<a href="#l2.4563"></a><span id="l2.4563" class="difflineplus">+              }</span>
<a href="#l2.4564"></a><span id="l2.4564" class="difflineplus">+            }</span>
<a href="#l2.4565"></a><span id="l2.4565" class="difflineplus">+          }</span>
<a href="#l2.4566"></a><span id="l2.4566" class="difflineplus">+        }</span>
<a href="#l2.4567"></a><span id="l2.4567" class="difflineplus">+</span>
<a href="#l2.4568"></a><span id="l2.4568" class="difflineplus">+        //XXX: This feels like a hack, but we need to initialize</span>
<a href="#l2.4569"></a><span id="l2.4569" class="difflineplus">+        //     the BYMONTHDAY case correctly and byDayAndMonthDay handles</span>
<a href="#l2.4570"></a><span id="l2.4570" class="difflineplus">+        //     this case. It accepts a special flag which will avoid incrementing</span>
<a href="#l2.4571"></a><span id="l2.4571" class="difflineplus">+        //     the initial value without the flag days that match the start time</span>
<a href="#l2.4572"></a><span id="l2.4572" class="difflineplus">+        //     would be missed.</span>
<a href="#l2.4573"></a><span id="l2.4573" class="difflineplus">+        if (this.has_by_data('BYMONTHDAY')) {</span>
<a href="#l2.4574"></a><span id="l2.4574" class="difflineplus">+          this._byDayAndMonthDay(true);</span>
<a href="#l2.4575"></a><span id="l2.4575" class="difflineplus">+        }</span>
<a href="#l2.4576"></a><span id="l2.4576" class="difflineplus">+</span>
<a href="#l2.4577"></a><span id="l2.4577" class="difflineplus">+        if (this.last.day &gt; daysInMonth || this.last.day == 0) {</span>
<a href="#l2.4578"></a><span id="l2.4578" class="difflineplus">+          throw new Error(&quot;Malformed values in BYDAY part&quot;);</span>
<a href="#l2.4579"></a><span id="l2.4579" class="difflineplus">+        }</span>
<a href="#l2.4580"></a><span id="l2.4580" class="difflineplus">+</span>
<a href="#l2.4581"></a><span id="l2.4581" class="difflineplus">+      } else if (this.has_by_data(&quot;BYMONTHDAY&quot;)) {</span>
<a href="#l2.4582"></a><span id="l2.4582" class="difflineplus">+        if (this.last.day &lt; 0) {</span>
<a href="#l2.4583"></a><span id="l2.4583" class="difflineplus">+          var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.4584"></a><span id="l2.4584" class="difflineplus">+          this.last.day = daysInMonth + this.last.day + 1;</span>
<a href="#l2.4585"></a><span id="l2.4585" class="difflineplus">+        }</span>
<a href="#l2.4586"></a><span id="l2.4586" class="difflineplus">+      }</span>
<a href="#l2.4587"></a><span id="l2.4587" class="difflineplus">+</span>
<a href="#l2.4588"></a><span id="l2.4588" class="difflineplus">+    },</span>
<a href="#l2.4589"></a><span id="l2.4589" class="difflineplus">+</span>
<a href="#l2.4590"></a><span id="l2.4590" class="difflineplus">+    next: function icalrecur_iterator_next() {</span>
<a href="#l2.4591"></a><span id="l2.4591" class="difflineplus">+      var before = (this.last ? this.last.clone() : null);</span>
<a href="#l2.4592"></a><span id="l2.4592" class="difflineplus">+</span>
<a href="#l2.4593"></a><span id="l2.4593" class="difflineplus">+      if ((this.rule.count &amp;&amp; this.occurrence_number &gt;= this.rule.count) ||</span>
<a href="#l2.4594"></a><span id="l2.4594" class="difflineplus">+          (this.rule.until &amp;&amp; this.last.compare(this.rule.until) &gt; 0)) {</span>
<a href="#l2.4595"></a><span id="l2.4595" class="difflineplus">+</span>
<a href="#l2.4596"></a><span id="l2.4596" class="difflineplus">+        //XXX: right now this is just a flag and has no impact</span>
<a href="#l2.4597"></a><span id="l2.4597" class="difflineplus">+        //     we can simplify the above case to check for completed later.</span>
<a href="#l2.4598"></a><span id="l2.4598" class="difflineplus">+        this.completed = true;</span>
<a href="#l2.4599"></a><span id="l2.4599" class="difflineplus">+</span>
<a href="#l2.4600"></a><span id="l2.4600" class="difflineplus">+        return null;</span>
<a href="#l2.4601"></a><span id="l2.4601" class="difflineplus">+      }</span>
<a href="#l2.4602"></a><span id="l2.4602" class="difflineplus">+</span>
<a href="#l2.4603"></a><span id="l2.4603" class="difflineplus">+      if (this.occurrence_number == 0 &amp;&amp; this.last.compare(this.dtstart) &gt;= 0) {</span>
<a href="#l2.4604"></a><span id="l2.4604" class="difflineplus">+        // First of all, give the instance that was initialized</span>
<a href="#l2.4605"></a><span id="l2.4605" class="difflineplus">+        this.occurrence_number++;</span>
<a href="#l2.4606"></a><span id="l2.4606" class="difflineplus">+        return this.last;</span>
<a href="#l2.4607"></a><span id="l2.4607" class="difflineplus">+      }</span>
<a href="#l2.4608"></a><span id="l2.4608" class="difflineplus">+</span>
<a href="#l2.4609"></a><span id="l2.4609" class="difflineplus">+      do {</span>
<a href="#l2.4610"></a><span id="l2.4610" class="difflineplus">+        var valid = 1;</span>
<a href="#l2.4611"></a><span id="l2.4611" class="difflineplus">+</span>
<a href="#l2.4612"></a><span id="l2.4612" class="difflineplus">+        switch (this.rule.freq) {</span>
<a href="#l2.4613"></a><span id="l2.4613" class="difflineplus">+        case &quot;SECONDLY&quot;:</span>
<a href="#l2.4614"></a><span id="l2.4614" class="difflineplus">+          this.next_second();</span>
<a href="#l2.4615"></a><span id="l2.4615" class="difflineplus">+          break;</span>
<a href="#l2.4616"></a><span id="l2.4616" class="difflineplus">+        case &quot;MINUTELY&quot;:</span>
<a href="#l2.4617"></a><span id="l2.4617" class="difflineplus">+          this.next_minute();</span>
<a href="#l2.4618"></a><span id="l2.4618" class="difflineplus">+          break;</span>
<a href="#l2.4619"></a><span id="l2.4619" class="difflineplus">+        case &quot;HOURLY&quot;:</span>
<a href="#l2.4620"></a><span id="l2.4620" class="difflineplus">+          this.next_hour();</span>
<a href="#l2.4621"></a><span id="l2.4621" class="difflineplus">+          break;</span>
<a href="#l2.4622"></a><span id="l2.4622" class="difflineplus">+        case &quot;DAILY&quot;:</span>
<a href="#l2.4623"></a><span id="l2.4623" class="difflineplus">+          this.next_day();</span>
<a href="#l2.4624"></a><span id="l2.4624" class="difflineplus">+          break;</span>
<a href="#l2.4625"></a><span id="l2.4625" class="difflineplus">+        case &quot;WEEKLY&quot;:</span>
<a href="#l2.4626"></a><span id="l2.4626" class="difflineplus">+          this.next_week();</span>
<a href="#l2.4627"></a><span id="l2.4627" class="difflineplus">+          break;</span>
<a href="#l2.4628"></a><span id="l2.4628" class="difflineplus">+        case &quot;MONTHLY&quot;:</span>
<a href="#l2.4629"></a><span id="l2.4629" class="difflineplus">+          valid = this.next_month();</span>
<a href="#l2.4630"></a><span id="l2.4630" class="difflineplus">+          break;</span>
<a href="#l2.4631"></a><span id="l2.4631" class="difflineplus">+        case &quot;YEARLY&quot;:</span>
<a href="#l2.4632"></a><span id="l2.4632" class="difflineplus">+          this.next_year();</span>
<a href="#l2.4633"></a><span id="l2.4633" class="difflineplus">+          break;</span>
<a href="#l2.4634"></a><span id="l2.4634" class="difflineplus">+</span>
<a href="#l2.4635"></a><span id="l2.4635" class="difflineplus">+        default:</span>
<a href="#l2.4636"></a><span id="l2.4636" class="difflineplus">+          return null;</span>
<a href="#l2.4637"></a><span id="l2.4637" class="difflineplus">+        }</span>
<a href="#l2.4638"></a><span id="l2.4638" class="difflineplus">+      } while (!this.check_contracting_rules() ||</span>
<a href="#l2.4639"></a><span id="l2.4639" class="difflineplus">+               this.last.compare(this.dtstart) &lt; 0 ||</span>
<a href="#l2.4640"></a><span id="l2.4640" class="difflineplus">+               !valid);</span>
<a href="#l2.4641"></a><span id="l2.4641" class="difflineplus">+</span>
<a href="#l2.4642"></a><span id="l2.4642" class="difflineplus">+      // TODO is this valid?</span>
<a href="#l2.4643"></a><span id="l2.4643" class="difflineplus">+      if (this.last.compare(before) == 0) {</span>
<a href="#l2.4644"></a><span id="l2.4644" class="difflineplus">+        throw new Error(&quot;Same occurrence found twice, protecting &quot; +</span>
<a href="#l2.4645"></a><span id="l2.4645" class="difflineplus">+                        &quot;you from death by recursion&quot;);</span>
<a href="#l2.4646"></a><span id="l2.4646" class="difflineplus">+      }</span>
<a href="#l2.4647"></a><span id="l2.4647" class="difflineplus">+</span>
<a href="#l2.4648"></a><span id="l2.4648" class="difflineplus">+      if (this.rule.until &amp;&amp; this.last.compare(this.rule.until) &gt; 0) {</span>
<a href="#l2.4649"></a><span id="l2.4649" class="difflineplus">+        this.completed = true;</span>
<a href="#l2.4650"></a><span id="l2.4650" class="difflineplus">+        return null;</span>
<a href="#l2.4651"></a><span id="l2.4651" class="difflineplus">+      } else {</span>
<a href="#l2.4652"></a><span id="l2.4652" class="difflineplus">+        this.occurrence_number++;</span>
<a href="#l2.4653"></a><span id="l2.4653" class="difflineplus">+        return this.last;</span>
<a href="#l2.4654"></a><span id="l2.4654" class="difflineplus">+      }</span>
<a href="#l2.4655"></a><span id="l2.4655" class="difflineplus">+    },</span>
<a href="#l2.4656"></a><span id="l2.4656" class="difflineplus">+</span>
<a href="#l2.4657"></a><span id="l2.4657" class="difflineplus">+    next_second: function next_second() {</span>
<a href="#l2.4658"></a><span id="l2.4658" class="difflineplus">+      return this.next_generic(&quot;BYSECOND&quot;, &quot;SECONDLY&quot;, &quot;second&quot;, &quot;minute&quot;);</span>
<a href="#l2.4659"></a><span id="l2.4659" class="difflineplus">+    },</span>
<a href="#l2.4660"></a><span id="l2.4660" class="difflineplus">+</span>
<a href="#l2.4661"></a><span id="l2.4661" class="difflineplus">+    increment_second: function increment_second(inc) {</span>
<a href="#l2.4662"></a><span id="l2.4662" class="difflineplus">+      return this.increment_generic(inc, &quot;second&quot;, 60, &quot;minute&quot;);</span>
<a href="#l2.4663"></a><span id="l2.4663" class="difflineplus">+    },</span>
<a href="#l2.4664"></a><span id="l2.4664" class="difflineplus">+</span>
<a href="#l2.4665"></a><span id="l2.4665" class="difflineplus">+    next_minute: function next_minute() {</span>
<a href="#l2.4666"></a><span id="l2.4666" class="difflineplus">+      return this.next_generic(&quot;BYMINUTE&quot;, &quot;MINUTELY&quot;,</span>
<a href="#l2.4667"></a><span id="l2.4667" class="difflineplus">+                               &quot;minute&quot;, &quot;hour&quot;, &quot;next_second&quot;);</span>
<a href="#l2.4668"></a><span id="l2.4668" class="difflineplus">+    },</span>
<a href="#l2.4669"></a><span id="l2.4669" class="difflineplus">+</span>
<a href="#l2.4670"></a><span id="l2.4670" class="difflineplus">+    increment_minute: function increment_minute(inc) {</span>
<a href="#l2.4671"></a><span id="l2.4671" class="difflineplus">+      return this.increment_generic(inc, &quot;minute&quot;, 60, &quot;hour&quot;);</span>
<a href="#l2.4672"></a><span id="l2.4672" class="difflineplus">+    },</span>
<a href="#l2.4673"></a><span id="l2.4673" class="difflineplus">+</span>
<a href="#l2.4674"></a><span id="l2.4674" class="difflineplus">+    next_hour: function next_hour() {</span>
<a href="#l2.4675"></a><span id="l2.4675" class="difflineplus">+      return this.next_generic(&quot;BYHOUR&quot;, &quot;HOURLY&quot;, &quot;hour&quot;,</span>
<a href="#l2.4676"></a><span id="l2.4676" class="difflineplus">+                               &quot;monthday&quot;, &quot;next_minute&quot;);</span>
<a href="#l2.4677"></a><span id="l2.4677" class="difflineplus">+    },</span>
<a href="#l2.4678"></a><span id="l2.4678" class="difflineplus">+</span>
<a href="#l2.4679"></a><span id="l2.4679" class="difflineplus">+    increment_hour: function increment_hour(inc) {</span>
<a href="#l2.4680"></a><span id="l2.4680" class="difflineplus">+      this.increment_generic(inc, &quot;hour&quot;, 24, &quot;monthday&quot;);</span>
<a href="#l2.4681"></a><span id="l2.4681" class="difflineplus">+    },</span>
<a href="#l2.4682"></a><span id="l2.4682" class="difflineplus">+</span>
<a href="#l2.4683"></a><span id="l2.4683" class="difflineplus">+    next_day: function next_day() {</span>
<a href="#l2.4684"></a><span id="l2.4684" class="difflineplus">+      var has_by_day = (&quot;BYDAY&quot; in this.by_data);</span>
<a href="#l2.4685"></a><span id="l2.4685" class="difflineplus">+      var this_freq = (this.rule.freq == &quot;DAILY&quot;);</span>
<a href="#l2.4686"></a><span id="l2.4686" class="difflineplus">+</span>
<a href="#l2.4687"></a><span id="l2.4687" class="difflineplus">+      if (this.next_hour() == 0) {</span>
<a href="#l2.4688"></a><span id="l2.4688" class="difflineplus">+        return 0;</span>
<a href="#l2.4689"></a><span id="l2.4689" class="difflineplus">+      }</span>
<a href="#l2.4690"></a><span id="l2.4690" class="difflineplus">+</span>
<a href="#l2.4691"></a><span id="l2.4691" class="difflineplus">+      if (this_freq) {</span>
<a href="#l2.4692"></a><span id="l2.4692" class="difflineplus">+        this.increment_monthday(this.rule.interval || 1);</span>
<a href="#l2.4693"></a><span id="l2.4693" class="difflineplus">+      } else {</span>
<a href="#l2.4694"></a><span id="l2.4694" class="difflineplus">+        this.increment_monthday(1);</span>
<a href="#l2.4695"></a><span id="l2.4695" class="difflineplus">+      }</span>
<a href="#l2.4696"></a><span id="l2.4696" class="difflineplus">+</span>
<a href="#l2.4697"></a><span id="l2.4697" class="difflineplus">+      return 0;</span>
<a href="#l2.4698"></a><span id="l2.4698" class="difflineplus">+    },</span>
<a href="#l2.4699"></a><span id="l2.4699" class="difflineplus">+</span>
<a href="#l2.4700"></a><span id="l2.4700" class="difflineplus">+    next_week: function next_week() {</span>
<a href="#l2.4701"></a><span id="l2.4701" class="difflineplus">+      var end_of_data = 0;</span>
<a href="#l2.4702"></a><span id="l2.4702" class="difflineplus">+</span>
<a href="#l2.4703"></a><span id="l2.4703" class="difflineplus">+      if (this.next_weekday_by_week() == 0) {</span>
<a href="#l2.4704"></a><span id="l2.4704" class="difflineplus">+        return end_of_data;</span>
<a href="#l2.4705"></a><span id="l2.4705" class="difflineplus">+      }</span>
<a href="#l2.4706"></a><span id="l2.4706" class="difflineplus">+</span>
<a href="#l2.4707"></a><span id="l2.4707" class="difflineplus">+      if (this.has_by_data(&quot;BYWEEKNO&quot;)) {</span>
<a href="#l2.4708"></a><span id="l2.4708" class="difflineplus">+        var idx = ++this.by_indices.BYWEEKNO;</span>
<a href="#l2.4709"></a><span id="l2.4709" class="difflineplus">+</span>
<a href="#l2.4710"></a><span id="l2.4710" class="difflineplus">+        if (this.by_indices.BYWEEKNO == this.by_data.BYWEEKNO.length) {</span>
<a href="#l2.4711"></a><span id="l2.4711" class="difflineplus">+          this.by_indices.BYWEEKNO = 0;</span>
<a href="#l2.4712"></a><span id="l2.4712" class="difflineplus">+          end_of_data = 1;</span>
<a href="#l2.4713"></a><span id="l2.4713" class="difflineplus">+        }</span>
<a href="#l2.4714"></a><span id="l2.4714" class="difflineplus">+</span>
<a href="#l2.4715"></a><span id="l2.4715" class="difflineplus">+        // HACK should be first month of the year</span>
<a href="#l2.4716"></a><span id="l2.4716" class="difflineplus">+        this.last.month = 1;</span>
<a href="#l2.4717"></a><span id="l2.4717" class="difflineplus">+        this.last.day = 1;</span>
<a href="#l2.4718"></a><span id="l2.4718" class="difflineplus">+</span>
<a href="#l2.4719"></a><span id="l2.4719" class="difflineplus">+        var week_no = this.by_data.BYWEEKNO[this.by_indices.BYWEEKNO];</span>
<a href="#l2.4720"></a><span id="l2.4720" class="difflineplus">+</span>
<a href="#l2.4721"></a><span id="l2.4721" class="difflineplus">+        this.last.day += 7 * week_no;</span>
<a href="#l2.4722"></a><span id="l2.4722" class="difflineplus">+</span>
<a href="#l2.4723"></a><span id="l2.4723" class="difflineplus">+        if (end_of_data) {</span>
<a href="#l2.4724"></a><span id="l2.4724" class="difflineplus">+          this.increment_year(1);</span>
<a href="#l2.4725"></a><span id="l2.4725" class="difflineplus">+        }</span>
<a href="#l2.4726"></a><span id="l2.4726" class="difflineplus">+      } else {</span>
<a href="#l2.4727"></a><span id="l2.4727" class="difflineplus">+        // Jump to the next week</span>
<a href="#l2.4728"></a><span id="l2.4728" class="difflineplus">+        this.increment_monthday(7 * (this.rule.interval || 1));</span>
<a href="#l2.4729"></a><span id="l2.4729" class="difflineplus">+      }</span>
<a href="#l2.4730"></a><span id="l2.4730" class="difflineplus">+</span>
<a href="#l2.4731"></a><span id="l2.4731" class="difflineplus">+      return end_of_data;</span>
<a href="#l2.4732"></a><span id="l2.4732" class="difflineplus">+    },</span>
<a href="#l2.4733"></a><span id="l2.4733" class="difflineplus">+</span>
<a href="#l2.4734"></a><span id="l2.4734" class="difflineplus">+    /**</span>
<a href="#l2.4735"></a><span id="l2.4735" class="difflineplus">+     * normalize each by day rule for a given year/month.</span>
<a href="#l2.4736"></a><span id="l2.4736" class="difflineplus">+     * Takes into account ordering and negative rules</span>
<a href="#l2.4737"></a><span id="l2.4737" class="difflineplus">+     *</span>
<a href="#l2.4738"></a><span id="l2.4738" class="difflineplus">+     * @param {Numeric} year current year.</span>
<a href="#l2.4739"></a><span id="l2.4739" class="difflineplus">+     * @param {Numeric} month current month.</span>
<a href="#l2.4740"></a><span id="l2.4740" class="difflineplus">+     * @param {Array} rules array of rules.</span>
<a href="#l2.4741"></a><span id="l2.4741" class="difflineplus">+     *</span>
<a href="#l2.4742"></a><span id="l2.4742" class="difflineplus">+     * @return {Array} sorted and normalized rules.</span>
<a href="#l2.4743"></a><span id="l2.4743" class="difflineplus">+     *                 Negative rules will be expanded to their</span>
<a href="#l2.4744"></a><span id="l2.4744" class="difflineplus">+     *                 correct positive values for easier processing.</span>
<a href="#l2.4745"></a><span id="l2.4745" class="difflineplus">+     */</span>
<a href="#l2.4746"></a><span id="l2.4746" class="difflineplus">+    normalizeByMonthDayRules: function(year, month, rules) {</span>
<a href="#l2.4747"></a><span id="l2.4747" class="difflineplus">+      var daysInMonth = ICAL.Time.daysInMonth(month, year);</span>
<a href="#l2.4748"></a><span id="l2.4748" class="difflineplus">+</span>
<a href="#l2.4749"></a><span id="l2.4749" class="difflineplus">+      // XXX: This is probably bad for performance to allocate</span>
<a href="#l2.4750"></a><span id="l2.4750" class="difflineplus">+      //      a new array for each month we scan, if possible</span>
<a href="#l2.4751"></a><span id="l2.4751" class="difflineplus">+      //      we should try to optimize this...</span>
<a href="#l2.4752"></a><span id="l2.4752" class="difflineplus">+      var newRules = [];</span>
<a href="#l2.4753"></a><span id="l2.4753" class="difflineplus">+</span>
<a href="#l2.4754"></a><span id="l2.4754" class="difflineplus">+      var ruleIdx = 0;</span>
<a href="#l2.4755"></a><span id="l2.4755" class="difflineplus">+      var len = rules.length;</span>
<a href="#l2.4756"></a><span id="l2.4756" class="difflineplus">+      var rule;</span>
<a href="#l2.4757"></a><span id="l2.4757" class="difflineplus">+</span>
<a href="#l2.4758"></a><span id="l2.4758" class="difflineplus">+      for (; ruleIdx &lt; len; ruleIdx++) {</span>
<a href="#l2.4759"></a><span id="l2.4759" class="difflineplus">+        rule = rules[ruleIdx];</span>
<a href="#l2.4760"></a><span id="l2.4760" class="difflineplus">+</span>
<a href="#l2.4761"></a><span id="l2.4761" class="difflineplus">+        // if this rule falls outside of given</span>
<a href="#l2.4762"></a><span id="l2.4762" class="difflineplus">+        // month discard it.</span>
<a href="#l2.4763"></a><span id="l2.4763" class="difflineplus">+        if (Math.abs(rule) &gt; daysInMonth) {</span>
<a href="#l2.4764"></a><span id="l2.4764" class="difflineplus">+          continue;</span>
<a href="#l2.4765"></a><span id="l2.4765" class="difflineplus">+        }</span>
<a href="#l2.4766"></a><span id="l2.4766" class="difflineplus">+</span>
<a href="#l2.4767"></a><span id="l2.4767" class="difflineplus">+        // negative case</span>
<a href="#l2.4768"></a><span id="l2.4768" class="difflineplus">+        if (rule &lt; 0) {</span>
<a href="#l2.4769"></a><span id="l2.4769" class="difflineplus">+          // we add (not subtract its a negative number)</span>
<a href="#l2.4770"></a><span id="l2.4770" class="difflineplus">+          // one from the rule because 1 === last day of month</span>
<a href="#l2.4771"></a><span id="l2.4771" class="difflineplus">+          rule = daysInMonth + (rule + 1);</span>
<a href="#l2.4772"></a><span id="l2.4772" class="difflineplus">+        } else if (rule === 0) {</span>
<a href="#l2.4773"></a><span id="l2.4773" class="difflineplus">+          // skip zero its invalid.</span>
<a href="#l2.4774"></a><span id="l2.4774" class="difflineplus">+          continue;</span>
<a href="#l2.4775"></a><span id="l2.4775" class="difflineplus">+        }</span>
<a href="#l2.4776"></a><span id="l2.4776" class="difflineplus">+</span>
<a href="#l2.4777"></a><span id="l2.4777" class="difflineplus">+        // only add unique items...</span>
<a href="#l2.4778"></a><span id="l2.4778" class="difflineplus">+        if (newRules.indexOf(rule) === -1) {</span>
<a href="#l2.4779"></a><span id="l2.4779" class="difflineplus">+          newRules.push(rule);</span>
<a href="#l2.4780"></a><span id="l2.4780" class="difflineplus">+        }</span>
<a href="#l2.4781"></a><span id="l2.4781" class="difflineplus">+</span>
<a href="#l2.4782"></a><span id="l2.4782" class="difflineplus">+      }</span>
<a href="#l2.4783"></a><span id="l2.4783" class="difflineplus">+</span>
<a href="#l2.4784"></a><span id="l2.4784" class="difflineplus">+      // unique and sort</span>
<a href="#l2.4785"></a><span id="l2.4785" class="difflineplus">+      return newRules.sort();</span>
<a href="#l2.4786"></a><span id="l2.4786" class="difflineplus">+    },</span>
<a href="#l2.4787"></a><span id="l2.4787" class="difflineplus">+</span>
<a href="#l2.4788"></a><span id="l2.4788" class="difflineplus">+    /**</span>
<a href="#l2.4789"></a><span id="l2.4789" class="difflineplus">+     * NOTES:</span>
<a href="#l2.4790"></a><span id="l2.4790" class="difflineplus">+     * We are given a list of dates in the month (BYMONTHDAY) (23, etc..)</span>
<a href="#l2.4791"></a><span id="l2.4791" class="difflineplus">+     * Also we are given a list of days (BYDAY) (MO, 2SU, etc..) when</span>
<a href="#l2.4792"></a><span id="l2.4792" class="difflineplus">+     * both conditions match a given date (this.last.day) iteration stops.</span>
<a href="#l2.4793"></a><span id="l2.4793" class="difflineplus">+     *</span>
<a href="#l2.4794"></a><span id="l2.4794" class="difflineplus">+     * @param {Boolean} [isInit] when given true will not</span>
<a href="#l2.4795"></a><span id="l2.4795" class="difflineplus">+     *                           increment the current day (this.last).</span>
<a href="#l2.4796"></a><span id="l2.4796" class="difflineplus">+     */</span>
<a href="#l2.4797"></a><span id="l2.4797" class="difflineplus">+    _byDayAndMonthDay: function(isInit) {</span>
<a href="#l2.4798"></a><span id="l2.4798" class="difflineplus">+     var byMonthDay; // setup in initMonth</span>
<a href="#l2.4799"></a><span id="l2.4799" class="difflineplus">+      var byDay = this.by_data.BYDAY;</span>
<a href="#l2.4800"></a><span id="l2.4800" class="difflineplus">+</span>
<a href="#l2.4801"></a><span id="l2.4801" class="difflineplus">+      var date;</span>
<a href="#l2.4802"></a><span id="l2.4802" class="difflineplus">+      var dateIdx = 0;</span>
<a href="#l2.4803"></a><span id="l2.4803" class="difflineplus">+      var dateLen; // setup in initMonth</span>
<a href="#l2.4804"></a><span id="l2.4804" class="difflineplus">+      var dayIdx = 0;</span>
<a href="#l2.4805"></a><span id="l2.4805" class="difflineplus">+      var dayLen = byDay.length;</span>
<a href="#l2.4806"></a><span id="l2.4806" class="difflineplus">+</span>
<a href="#l2.4807"></a><span id="l2.4807" class="difflineplus">+      // we are not valid by default</span>
<a href="#l2.4808"></a><span id="l2.4808" class="difflineplus">+      var dataIsValid = 0;</span>
<a href="#l2.4809"></a><span id="l2.4809" class="difflineplus">+</span>
<a href="#l2.4810"></a><span id="l2.4810" class="difflineplus">+      var daysInMonth;</span>
<a href="#l2.4811"></a><span id="l2.4811" class="difflineplus">+      var self = this;</span>
<a href="#l2.4812"></a><span id="l2.4812" class="difflineplus">+</span>
<a href="#l2.4813"></a><span id="l2.4813" class="difflineplus">+      function initMonth() {</span>
<a href="#l2.4814"></a><span id="l2.4814" class="difflineplus">+        daysInMonth = ICAL.Time.daysInMonth(</span>
<a href="#l2.4815"></a><span id="l2.4815" class="difflineplus">+          self.last.month, self.last.year</span>
<a href="#l2.4816"></a><span id="l2.4816" class="difflineplus">+        );</span>
<a href="#l2.4817"></a><span id="l2.4817" class="difflineplus">+</span>
<a href="#l2.4818"></a><span id="l2.4818" class="difflineplus">+        byMonthDay = self.normalizeByMonthDayRules(</span>
<a href="#l2.4819"></a><span id="l2.4819" class="difflineplus">+          self.last.year,</span>
<a href="#l2.4820"></a><span id="l2.4820" class="difflineplus">+          self.last.month,</span>
<a href="#l2.4821"></a><span id="l2.4821" class="difflineplus">+          self.by_data.BYMONTHDAY</span>
<a href="#l2.4822"></a><span id="l2.4822" class="difflineplus">+        );</span>
<a href="#l2.4823"></a><span id="l2.4823" class="difflineplus">+</span>
<a href="#l2.4824"></a><span id="l2.4824" class="difflineplus">+        dateLen = byMonthDay.length;</span>
<a href="#l2.4825"></a><span id="l2.4825" class="difflineplus">+      }</span>
<a href="#l2.4826"></a><span id="l2.4826" class="difflineplus">+</span>
<a href="#l2.4827"></a><span id="l2.4827" class="difflineplus">+      function nextMonth() {</span>
<a href="#l2.4828"></a><span id="l2.4828" class="difflineplus">+        self.last.day = 1;</span>
<a href="#l2.4829"></a><span id="l2.4829" class="difflineplus">+        self.increment_month();</span>
<a href="#l2.4830"></a><span id="l2.4830" class="difflineplus">+        initMonth();</span>
<a href="#l2.4831"></a><span id="l2.4831" class="difflineplus">+</span>
<a href="#l2.4832"></a><span id="l2.4832" class="difflineplus">+        dateIdx = 0;</span>
<a href="#l2.4833"></a><span id="l2.4833" class="difflineplus">+        dayIdx = 0;</span>
<a href="#l2.4834"></a><span id="l2.4834" class="difflineplus">+      }</span>
<a href="#l2.4835"></a><span id="l2.4835" class="difflineplus">+</span>
<a href="#l2.4836"></a><span id="l2.4836" class="difflineplus">+      initMonth();</span>
<a href="#l2.4837"></a><span id="l2.4837" class="difflineplus">+</span>
<a href="#l2.4838"></a><span id="l2.4838" class="difflineplus">+      // should come after initMonth</span>
<a href="#l2.4839"></a><span id="l2.4839" class="difflineplus">+      if (isInit) {</span>
<a href="#l2.4840"></a><span id="l2.4840" class="difflineplus">+        this.last.day -= 1;</span>
<a href="#l2.4841"></a><span id="l2.4841" class="difflineplus">+      }</span>
<a href="#l2.4842"></a><span id="l2.4842" class="difflineplus">+</span>
<a href="#l2.4843"></a><span id="l2.4843" class="difflineplus">+      while (!dataIsValid) {</span>
<a href="#l2.4844"></a><span id="l2.4844" class="difflineplus">+        // find next date</span>
<a href="#l2.4845"></a><span id="l2.4845" class="difflineplus">+        var next = byMonthDay[dateIdx++];</span>
<a href="#l2.4846"></a><span id="l2.4846" class="difflineplus">+</span>
<a href="#l2.4847"></a><span id="l2.4847" class="difflineplus">+        // increment the current date. This is really</span>
<a href="#l2.4848"></a><span id="l2.4848" class="difflineplus">+        // important otherwise we may fall into the infinite</span>
<a href="#l2.4849"></a><span id="l2.4849" class="difflineplus">+        // loop trap. The initial date takes care of the case</span>
<a href="#l2.4850"></a><span id="l2.4850" class="difflineplus">+        // where the current date is the date we are looking</span>
<a href="#l2.4851"></a><span id="l2.4851" class="difflineplus">+        // for.</span>
<a href="#l2.4852"></a><span id="l2.4852" class="difflineplus">+        date = this.last.day + 1;</span>
<a href="#l2.4853"></a><span id="l2.4853" class="difflineplus">+</span>
<a href="#l2.4854"></a><span id="l2.4854" class="difflineplus">+        if (date &gt; daysInMonth) {</span>
<a href="#l2.4855"></a><span id="l2.4855" class="difflineplus">+          nextMonth();</span>
<a href="#l2.4856"></a><span id="l2.4856" class="difflineplus">+          continue;</span>
<a href="#l2.4857"></a><span id="l2.4857" class="difflineplus">+        }</span>
<a href="#l2.4858"></a><span id="l2.4858" class="difflineplus">+</span>
<a href="#l2.4859"></a><span id="l2.4859" class="difflineplus">+        // after verify that the next date</span>
<a href="#l2.4860"></a><span id="l2.4860" class="difflineplus">+        // is in the current month we can increment</span>
<a href="#l2.4861"></a><span id="l2.4861" class="difflineplus">+        // it permanently.</span>
<a href="#l2.4862"></a><span id="l2.4862" class="difflineplus">+        this.last.day = date;</span>
<a href="#l2.4863"></a><span id="l2.4863" class="difflineplus">+</span>
<a href="#l2.4864"></a><span id="l2.4864" class="difflineplus">+        // this logic is dependant on the BYMONTHDAYS</span>
<a href="#l2.4865"></a><span id="l2.4865" class="difflineplus">+        // being in order (which is done by #normalizeByMonthDayRules)</span>
<a href="#l2.4866"></a><span id="l2.4866" class="difflineplus">+        if (next &gt;= this.last.day) {</span>
<a href="#l2.4867"></a><span id="l2.4867" class="difflineplus">+          // if the next month day is in the future jump to it.</span>
<a href="#l2.4868"></a><span id="l2.4868" class="difflineplus">+          this.last.day = next;</span>
<a href="#l2.4869"></a><span id="l2.4869" class="difflineplus">+        } else {</span>
<a href="#l2.4870"></a><span id="l2.4870" class="difflineplus">+          // in this case the 'next' monthday has past</span>
<a href="#l2.4871"></a><span id="l2.4871" class="difflineplus">+          // we must move to the month.</span>
<a href="#l2.4872"></a><span id="l2.4872" class="difflineplus">+          nextMonth();</span>
<a href="#l2.4873"></a><span id="l2.4873" class="difflineplus">+          continue;</span>
<a href="#l2.4874"></a><span id="l2.4874" class="difflineplus">+        }</span>
<a href="#l2.4875"></a><span id="l2.4875" class="difflineplus">+</span>
<a href="#l2.4876"></a><span id="l2.4876" class="difflineplus">+        // Now we can loop through the day rules to see</span>
<a href="#l2.4877"></a><span id="l2.4877" class="difflineplus">+        // if one matches the current month date.</span>
<a href="#l2.4878"></a><span id="l2.4878" class="difflineplus">+        for (dayIdx = 0; dayIdx &lt; dayLen; dayIdx++) {</span>
<a href="#l2.4879"></a><span id="l2.4879" class="difflineplus">+          var parts = this.ruleDayOfWeek(byDay[dayIdx]);</span>
<a href="#l2.4880"></a><span id="l2.4880" class="difflineplus">+          var pos = parts[0];</span>
<a href="#l2.4881"></a><span id="l2.4881" class="difflineplus">+          var dow = parts[1];</span>
<a href="#l2.4882"></a><span id="l2.4882" class="difflineplus">+</span>
<a href="#l2.4883"></a><span id="l2.4883" class="difflineplus">+          if (this.last.isNthWeekDay(dow, pos)) {</span>
<a href="#l2.4884"></a><span id="l2.4884" class="difflineplus">+            // when we find the valid one we can mark</span>
<a href="#l2.4885"></a><span id="l2.4885" class="difflineplus">+            // the conditions as met and break the loop.</span>
<a href="#l2.4886"></a><span id="l2.4886" class="difflineplus">+            // (Because we have this condition above</span>
<a href="#l2.4887"></a><span id="l2.4887" class="difflineplus">+            //  it will also break the parent loop).</span>
<a href="#l2.4888"></a><span id="l2.4888" class="difflineplus">+            dataIsValid = 1;</span>
<a href="#l2.4889"></a><span id="l2.4889" class="difflineplus">+            break;</span>
<a href="#l2.4890"></a><span id="l2.4890" class="difflineplus">+          }</span>
<a href="#l2.4891"></a><span id="l2.4891" class="difflineplus">+        }</span>
<a href="#l2.4892"></a><span id="l2.4892" class="difflineplus">+</span>
<a href="#l2.4893"></a><span id="l2.4893" class="difflineplus">+        // Its completely possible that the combination</span>
<a href="#l2.4894"></a><span id="l2.4894" class="difflineplus">+        // cannot be matched in the current month.</span>
<a href="#l2.4895"></a><span id="l2.4895" class="difflineplus">+        // When we reach the end of possible combinations</span>
<a href="#l2.4896"></a><span id="l2.4896" class="difflineplus">+        // in the current month we iterate to the next one.</span>
<a href="#l2.4897"></a><span id="l2.4897" class="difflineplus">+        if (!dataIsValid &amp;&amp; dateIdx === (dateLen - 1)) {</span>
<a href="#l2.4898"></a><span id="l2.4898" class="difflineplus">+          nextMonth();</span>
<a href="#l2.4899"></a><span id="l2.4899" class="difflineplus">+          continue;</span>
<a href="#l2.4900"></a><span id="l2.4900" class="difflineplus">+        }</span>
<a href="#l2.4901"></a><span id="l2.4901" class="difflineplus">+      }</span>
<a href="#l2.4902"></a><span id="l2.4902" class="difflineplus">+</span>
<a href="#l2.4903"></a><span id="l2.4903" class="difflineplus">+      return dataIsValid;</span>
<a href="#l2.4904"></a><span id="l2.4904" class="difflineplus">+    },</span>
<a href="#l2.4905"></a><span id="l2.4905" class="difflineplus">+</span>
<a href="#l2.4906"></a><span id="l2.4906" class="difflineplus">+    next_month: function next_month() {</span>
<a href="#l2.4907"></a><span id="l2.4907" class="difflineplus">+      var this_freq = (this.rule.freq == &quot;MONTHLY&quot;);</span>
<a href="#l2.4908"></a><span id="l2.4908" class="difflineplus">+      var data_valid = 1;</span>
<a href="#l2.4909"></a><span id="l2.4909" class="difflineplus">+</span>
<a href="#l2.4910"></a><span id="l2.4910" class="difflineplus">+      if (this.next_hour() == 0) {</span>
<a href="#l2.4911"></a><span id="l2.4911" class="difflineplus">+        return data_valid;</span>
<a href="#l2.4912"></a><span id="l2.4912" class="difflineplus">+      }</span>
<a href="#l2.4913"></a><span id="l2.4913" class="difflineplus">+</span>
<a href="#l2.4914"></a><span id="l2.4914" class="difflineplus">+      if (this.has_by_data(&quot;BYDAY&quot;) &amp;&amp; this.has_by_data(&quot;BYMONTHDAY&quot;)) {</span>
<a href="#l2.4915"></a><span id="l2.4915" class="difflineplus">+        data_valid = this._byDayAndMonthDay();</span>
<a href="#l2.4916"></a><span id="l2.4916" class="difflineplus">+      } else if (this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l2.4917"></a><span id="l2.4917" class="difflineplus">+        var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.4918"></a><span id="l2.4918" class="difflineplus">+        var setpos = 0;</span>
<a href="#l2.4919"></a><span id="l2.4919" class="difflineplus">+</span>
<a href="#l2.4920"></a><span id="l2.4920" class="difflineplus">+        if (this.has_by_data(&quot;BYSETPOS&quot;)) {</span>
<a href="#l2.4921"></a><span id="l2.4921" class="difflineplus">+          var last_day = this.last.day;</span>
<a href="#l2.4922"></a><span id="l2.4922" class="difflineplus">+          for (var day = 1; day &lt;= daysInMonth; day++) {</span>
<a href="#l2.4923"></a><span id="l2.4923" class="difflineplus">+            this.last.day = day;</span>
<a href="#l2.4924"></a><span id="l2.4924" class="difflineplus">+            if (this.is_day_in_byday(this.last) &amp;&amp; day &lt;= last_day) {</span>
<a href="#l2.4925"></a><span id="l2.4925" class="difflineplus">+              setpos++;</span>
<a href="#l2.4926"></a><span id="l2.4926" class="difflineplus">+            }</span>
<a href="#l2.4927"></a><span id="l2.4927" class="difflineplus">+          }</span>
<a href="#l2.4928"></a><span id="l2.4928" class="difflineplus">+          this.last.day = last_day;</span>
<a href="#l2.4929"></a><span id="l2.4929" class="difflineplus">+        }</span>
<a href="#l2.4930"></a><span id="l2.4930" class="difflineplus">+</span>
<a href="#l2.4931"></a><span id="l2.4931" class="difflineplus">+        for (var day = this.last.day + 1; day &lt;= daysInMonth; day++) {</span>
<a href="#l2.4932"></a><span id="l2.4932" class="difflineplus">+          this.last.day = day;</span>
<a href="#l2.4933"></a><span id="l2.4933" class="difflineplus">+</span>
<a href="#l2.4934"></a><span id="l2.4934" class="difflineplus">+          if (this.is_day_in_byday(this.last)) {</span>
<a href="#l2.4935"></a><span id="l2.4935" class="difflineplus">+            if (!this.has_by_data(&quot;BYSETPOS&quot;) ||</span>
<a href="#l2.4936"></a><span id="l2.4936" class="difflineplus">+                this.check_set_position(++setpos) ||</span>
<a href="#l2.4937"></a><span id="l2.4937" class="difflineplus">+                this.check_set_position(setpos - this.by_data.BYSETPOS.length - 1)) {</span>
<a href="#l2.4938"></a><span id="l2.4938" class="difflineplus">+</span>
<a href="#l2.4939"></a><span id="l2.4939" class="difflineplus">+              data_valid = 1;</span>
<a href="#l2.4940"></a><span id="l2.4940" class="difflineplus">+              break;</span>
<a href="#l2.4941"></a><span id="l2.4941" class="difflineplus">+            }</span>
<a href="#l2.4942"></a><span id="l2.4942" class="difflineplus">+          }</span>
<a href="#l2.4943"></a><span id="l2.4943" class="difflineplus">+        }</span>
<a href="#l2.4944"></a><span id="l2.4944" class="difflineplus">+</span>
<a href="#l2.4945"></a><span id="l2.4945" class="difflineplus">+        if (day &gt; daysInMonth) {</span>
<a href="#l2.4946"></a><span id="l2.4946" class="difflineplus">+          this.last.day = 1;</span>
<a href="#l2.4947"></a><span id="l2.4947" class="difflineplus">+          this.increment_month();</span>
<a href="#l2.4948"></a><span id="l2.4948" class="difflineplus">+</span>
<a href="#l2.4949"></a><span id="l2.4949" class="difflineplus">+          if (this.is_day_in_byday(this.last)) {</span>
<a href="#l2.4950"></a><span id="l2.4950" class="difflineplus">+            if (!this.has_by_data(&quot;BYSETPOS&quot;) || this.check_set_position(1)) {</span>
<a href="#l2.4951"></a><span id="l2.4951" class="difflineplus">+              data_valid = 1;</span>
<a href="#l2.4952"></a><span id="l2.4952" class="difflineplus">+            }</span>
<a href="#l2.4953"></a><span id="l2.4953" class="difflineplus">+          } else {</span>
<a href="#l2.4954"></a><span id="l2.4954" class="difflineplus">+            data_valid = 0;</span>
<a href="#l2.4955"></a><span id="l2.4955" class="difflineplus">+          }</span>
<a href="#l2.4956"></a><span id="l2.4956" class="difflineplus">+        }</span>
<a href="#l2.4957"></a><span id="l2.4957" class="difflineplus">+      } else if (this.has_by_data(&quot;BYMONTHDAY&quot;)) {</span>
<a href="#l2.4958"></a><span id="l2.4958" class="difflineplus">+        this.by_indices.BYMONTHDAY++;</span>
<a href="#l2.4959"></a><span id="l2.4959" class="difflineplus">+</span>
<a href="#l2.4960"></a><span id="l2.4960" class="difflineplus">+        if (this.by_indices.BYMONTHDAY &gt;= this.by_data.BYMONTHDAY.length) {</span>
<a href="#l2.4961"></a><span id="l2.4961" class="difflineplus">+          this.by_indices.BYMONTHDAY = 0;</span>
<a href="#l2.4962"></a><span id="l2.4962" class="difflineplus">+          this.increment_month();</span>
<a href="#l2.4963"></a><span id="l2.4963" class="difflineplus">+        }</span>
<a href="#l2.4964"></a><span id="l2.4964" class="difflineplus">+</span>
<a href="#l2.4965"></a><span id="l2.4965" class="difflineplus">+        var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.4966"></a><span id="l2.4966" class="difflineplus">+</span>
<a href="#l2.4967"></a><span id="l2.4967" class="difflineplus">+        var day = this.by_data.BYMONTHDAY[this.by_indices.BYMONTHDAY];</span>
<a href="#l2.4968"></a><span id="l2.4968" class="difflineplus">+</span>
<a href="#l2.4969"></a><span id="l2.4969" class="difflineplus">+        if (day &lt; 0) {</span>
<a href="#l2.4970"></a><span id="l2.4970" class="difflineplus">+          day = daysInMonth + day + 1;</span>
<a href="#l2.4971"></a><span id="l2.4971" class="difflineplus">+        }</span>
<a href="#l2.4972"></a><span id="l2.4972" class="difflineplus">+</span>
<a href="#l2.4973"></a><span id="l2.4973" class="difflineplus">+        if (day &gt; daysInMonth) {</span>
<a href="#l2.4974"></a><span id="l2.4974" class="difflineplus">+          this.last.day = 1;</span>
<a href="#l2.4975"></a><span id="l2.4975" class="difflineplus">+          data_valid = this.is_day_in_byday(this.last);</span>
<a href="#l2.4976"></a><span id="l2.4976" class="difflineplus">+        }</span>
<a href="#l2.4977"></a><span id="l2.4977" class="difflineplus">+</span>
<a href="#l2.4978"></a><span id="l2.4978" class="difflineplus">+        this.last.day = day;</span>
<a href="#l2.4979"></a><span id="l2.4979" class="difflineplus">+      } else {</span>
<a href="#l2.4980"></a><span id="l2.4980" class="difflineplus">+        this.last.day = this.by_data.BYMONTHDAY[0];</span>
<a href="#l2.4981"></a><span id="l2.4981" class="difflineplus">+        this.increment_month();</span>
<a href="#l2.4982"></a><span id="l2.4982" class="difflineplus">+        var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.4983"></a><span id="l2.4983" class="difflineplus">+        this.last.day = Math.min(this.last.day, daysInMonth);</span>
<a href="#l2.4984"></a><span id="l2.4984" class="difflineplus">+      }</span>
<a href="#l2.4985"></a><span id="l2.4985" class="difflineplus">+</span>
<a href="#l2.4986"></a><span id="l2.4986" class="difflineplus">+      return data_valid;</span>
<a href="#l2.4987"></a><span id="l2.4987" class="difflineplus">+    },</span>
<a href="#l2.4988"></a><span id="l2.4988" class="difflineplus">+</span>
<a href="#l2.4989"></a><span id="l2.4989" class="difflineplus">+    next_weekday_by_week: function next_weekday_by_week() {</span>
<a href="#l2.4990"></a><span id="l2.4990" class="difflineplus">+      var end_of_data = 0;</span>
<a href="#l2.4991"></a><span id="l2.4991" class="difflineplus">+</span>
<a href="#l2.4992"></a><span id="l2.4992" class="difflineplus">+      if (this.next_hour() == 0) {</span>
<a href="#l2.4993"></a><span id="l2.4993" class="difflineplus">+        return end_of_data;</span>
<a href="#l2.4994"></a><span id="l2.4994" class="difflineplus">+      }</span>
<a href="#l2.4995"></a><span id="l2.4995" class="difflineplus">+</span>
<a href="#l2.4996"></a><span id="l2.4996" class="difflineplus">+      if (!this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l2.4997"></a><span id="l2.4997" class="difflineplus">+        return 1;</span>
<a href="#l2.4998"></a><span id="l2.4998" class="difflineplus">+      }</span>
<a href="#l2.4999"></a><span id="l2.4999" class="difflineplus">+</span>
<a href="#l2.5000"></a><span id="l2.5000" class="difflineplus">+      for (;;) {</span>
<a href="#l2.5001"></a><span id="l2.5001" class="difflineplus">+        var tt = new ICAL.Time();</span>
<a href="#l2.5002"></a><span id="l2.5002" class="difflineplus">+        this.by_indices.BYDAY++;</span>
<a href="#l2.5003"></a><span id="l2.5003" class="difflineplus">+</span>
<a href="#l2.5004"></a><span id="l2.5004" class="difflineplus">+        if (this.by_indices.BYDAY == this.by_data.BYDAY.length) {</span>
<a href="#l2.5005"></a><span id="l2.5005" class="difflineplus">+          this.by_indices.BYDAY = 0;</span>
<a href="#l2.5006"></a><span id="l2.5006" class="difflineplus">+          end_of_data = 1;</span>
<a href="#l2.5007"></a><span id="l2.5007" class="difflineplus">+        }</span>
<a href="#l2.5008"></a><span id="l2.5008" class="difflineplus">+</span>
<a href="#l2.5009"></a><span id="l2.5009" class="difflineplus">+        var coded_day = this.by_data.BYDAY[this.by_indices.BYDAY];</span>
<a href="#l2.5010"></a><span id="l2.5010" class="difflineplus">+        var parts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l2.5011"></a><span id="l2.5011" class="difflineplus">+        var dow = parts[1];</span>
<a href="#l2.5012"></a><span id="l2.5012" class="difflineplus">+</span>
<a href="#l2.5013"></a><span id="l2.5013" class="difflineplus">+        dow -= this.rule.wkst;</span>
<a href="#l2.5014"></a><span id="l2.5014" class="difflineplus">+</span>
<a href="#l2.5015"></a><span id="l2.5015" class="difflineplus">+        if (dow &lt; 0) {</span>
<a href="#l2.5016"></a><span id="l2.5016" class="difflineplus">+          dow += 7;</span>
<a href="#l2.5017"></a><span id="l2.5017" class="difflineplus">+        }</span>
<a href="#l2.5018"></a><span id="l2.5018" class="difflineplus">+</span>
<a href="#l2.5019"></a><span id="l2.5019" class="difflineplus">+        tt.year = this.last.year;</span>
<a href="#l2.5020"></a><span id="l2.5020" class="difflineplus">+        tt.month = this.last.month;</span>
<a href="#l2.5021"></a><span id="l2.5021" class="difflineplus">+        tt.day = this.last.day;</span>
<a href="#l2.5022"></a><span id="l2.5022" class="difflineplus">+</span>
<a href="#l2.5023"></a><span id="l2.5023" class="difflineplus">+        var startOfWeek = tt.startDoyWeek(this.rule.wkst);</span>
<a href="#l2.5024"></a><span id="l2.5024" class="difflineplus">+</span>
<a href="#l2.5025"></a><span id="l2.5025" class="difflineplus">+        if (dow + startOfWeek &lt; 1) {</span>
<a href="#l2.5026"></a><span id="l2.5026" class="difflineplus">+          // The selected date is in the previous year</span>
<a href="#l2.5027"></a><span id="l2.5027" class="difflineplus">+          if (!end_of_data) {</span>
<a href="#l2.5028"></a><span id="l2.5028" class="difflineplus">+            continue;</span>
<a href="#l2.5029"></a><span id="l2.5029" class="difflineplus">+          }</span>
<a href="#l2.5030"></a><span id="l2.5030" class="difflineplus">+        }</span>
<a href="#l2.5031"></a><span id="l2.5031" class="difflineplus">+</span>
<a href="#l2.5032"></a><span id="l2.5032" class="difflineplus">+        var next = ICAL.Time.fromDayOfYear(startOfWeek + dow,</span>
<a href="#l2.5033"></a><span id="l2.5033" class="difflineplus">+                                                  this.last.year);</span>
<a href="#l2.5034"></a><span id="l2.5034" class="difflineplus">+</span>
<a href="#l2.5035"></a><span id="l2.5035" class="difflineplus">+        /**</span>
<a href="#l2.5036"></a><span id="l2.5036" class="difflineplus">+         * The normalization horrors below are due to</span>
<a href="#l2.5037"></a><span id="l2.5037" class="difflineplus">+         * the fact that when the year/month/day changes</span>
<a href="#l2.5038"></a><span id="l2.5038" class="difflineplus">+         * it can effect the other operations that come after.</span>
<a href="#l2.5039"></a><span id="l2.5039" class="difflineplus">+         */</span>
<a href="#l2.5040"></a><span id="l2.5040" class="difflineplus">+        this.last.year = next.year;</span>
<a href="#l2.5041"></a><span id="l2.5041" class="difflineplus">+        this.last.month = next.month;</span>
<a href="#l2.5042"></a><span id="l2.5042" class="difflineplus">+        this.last.day = next.day;</span>
<a href="#l2.5043"></a><span id="l2.5043" class="difflineplus">+</span>
<a href="#l2.5044"></a><span id="l2.5044" class="difflineplus">+        return end_of_data;</span>
<a href="#l2.5045"></a><span id="l2.5045" class="difflineplus">+      }</span>
<a href="#l2.5046"></a><span id="l2.5046" class="difflineplus">+    },</span>
<a href="#l2.5047"></a><span id="l2.5047" class="difflineplus">+</span>
<a href="#l2.5048"></a><span id="l2.5048" class="difflineplus">+    next_year: function next_year() {</span>
<a href="#l2.5049"></a><span id="l2.5049" class="difflineplus">+</span>
<a href="#l2.5050"></a><span id="l2.5050" class="difflineplus">+      if (this.next_hour() == 0) {</span>
<a href="#l2.5051"></a><span id="l2.5051" class="difflineplus">+        return 0;</span>
<a href="#l2.5052"></a><span id="l2.5052" class="difflineplus">+      }</span>
<a href="#l2.5053"></a><span id="l2.5053" class="difflineplus">+</span>
<a href="#l2.5054"></a><span id="l2.5054" class="difflineplus">+      if (++this.days_index == this.days.length) {</span>
<a href="#l2.5055"></a><span id="l2.5055" class="difflineplus">+        this.days_index = 0;</span>
<a href="#l2.5056"></a><span id="l2.5056" class="difflineplus">+        do {</span>
<a href="#l2.5057"></a><span id="l2.5057" class="difflineplus">+          this.increment_year(this.rule.interval || 1);</span>
<a href="#l2.5058"></a><span id="l2.5058" class="difflineplus">+          this.expand_year_days(this.last.year);</span>
<a href="#l2.5059"></a><span id="l2.5059" class="difflineplus">+        } while (this.days.length == 0);</span>
<a href="#l2.5060"></a><span id="l2.5060" class="difflineplus">+      }</span>
<a href="#l2.5061"></a><span id="l2.5061" class="difflineplus">+</span>
<a href="#l2.5062"></a><span id="l2.5062" class="difflineplus">+      var next = ICAL.Time.fromDayOfYear(this.days[this.days_index],</span>
<a href="#l2.5063"></a><span id="l2.5063" class="difflineplus">+                                                this.last.year);</span>
<a href="#l2.5064"></a><span id="l2.5064" class="difflineplus">+</span>
<a href="#l2.5065"></a><span id="l2.5065" class="difflineplus">+      this.last.day = next.day;</span>
<a href="#l2.5066"></a><span id="l2.5066" class="difflineplus">+      this.last.month = next.month;</span>
<a href="#l2.5067"></a><span id="l2.5067" class="difflineplus">+</span>
<a href="#l2.5068"></a><span id="l2.5068" class="difflineplus">+      return 1;</span>
<a href="#l2.5069"></a><span id="l2.5069" class="difflineplus">+    },</span>
<a href="#l2.5070"></a><span id="l2.5070" class="difflineplus">+</span>
<a href="#l2.5071"></a><span id="l2.5071" class="difflineplus">+    ruleDayOfWeek: function ruleDayOfWeek(dow) {</span>
<a href="#l2.5072"></a><span id="l2.5072" class="difflineplus">+      var matches = dow.match(/([+-]?[0-9])?(MO|TU|WE|TH|FR|SA|SU)/);</span>
<a href="#l2.5073"></a><span id="l2.5073" class="difflineplus">+      if (matches) {</span>
<a href="#l2.5074"></a><span id="l2.5074" class="difflineplus">+        var pos = parseInt(matches[1] || 0, 10);</span>
<a href="#l2.5075"></a><span id="l2.5075" class="difflineplus">+        dow = ICAL.Recur.icalDayToNumericDay(matches[2]);</span>
<a href="#l2.5076"></a><span id="l2.5076" class="difflineplus">+        return [pos, dow];</span>
<a href="#l2.5077"></a><span id="l2.5077" class="difflineplus">+      } else {</span>
<a href="#l2.5078"></a><span id="l2.5078" class="difflineplus">+        return [0, 0];</span>
<a href="#l2.5079"></a><span id="l2.5079" class="difflineplus">+      }</span>
<a href="#l2.5080"></a><span id="l2.5080" class="difflineplus">+    },</span>
<a href="#l2.5081"></a><span id="l2.5081" class="difflineplus">+</span>
<a href="#l2.5082"></a><span id="l2.5082" class="difflineplus">+    next_generic: function next_generic(aRuleType, aInterval, aDateAttr,</span>
<a href="#l2.5083"></a><span id="l2.5083" class="difflineplus">+                                        aFollowingAttr, aPreviousIncr) {</span>
<a href="#l2.5084"></a><span id="l2.5084" class="difflineplus">+      var has_by_rule = (aRuleType in this.by_data);</span>
<a href="#l2.5085"></a><span id="l2.5085" class="difflineplus">+      var this_freq = (this.rule.freq == aInterval);</span>
<a href="#l2.5086"></a><span id="l2.5086" class="difflineplus">+      var end_of_data = 0;</span>
<a href="#l2.5087"></a><span id="l2.5087" class="difflineplus">+</span>
<a href="#l2.5088"></a><span id="l2.5088" class="difflineplus">+      if (aPreviousIncr &amp;&amp; this[aPreviousIncr]() == 0) {</span>
<a href="#l2.5089"></a><span id="l2.5089" class="difflineplus">+        return end_of_data;</span>
<a href="#l2.5090"></a><span id="l2.5090" class="difflineplus">+      }</span>
<a href="#l2.5091"></a><span id="l2.5091" class="difflineplus">+</span>
<a href="#l2.5092"></a><span id="l2.5092" class="difflineplus">+      if (has_by_rule) {</span>
<a href="#l2.5093"></a><span id="l2.5093" class="difflineplus">+        this.by_indices[aRuleType]++;</span>
<a href="#l2.5094"></a><span id="l2.5094" class="difflineplus">+        var idx = this.by_indices[aRuleType];</span>
<a href="#l2.5095"></a><span id="l2.5095" class="difflineplus">+        var dta = this.by_data[aRuleType];</span>
<a href="#l2.5096"></a><span id="l2.5096" class="difflineplus">+</span>
<a href="#l2.5097"></a><span id="l2.5097" class="difflineplus">+        if (this.by_indices[aRuleType] == dta.length) {</span>
<a href="#l2.5098"></a><span id="l2.5098" class="difflineplus">+          this.by_indices[aRuleType] = 0;</span>
<a href="#l2.5099"></a><span id="l2.5099" class="difflineplus">+          end_of_data = 1;</span>
<a href="#l2.5100"></a><span id="l2.5100" class="difflineplus">+        }</span>
<a href="#l2.5101"></a><span id="l2.5101" class="difflineplus">+        this.last[aDateAttr] = dta[this.by_indices[aRuleType]];</span>
<a href="#l2.5102"></a><span id="l2.5102" class="difflineplus">+      } else if (this_freq) {</span>
<a href="#l2.5103"></a><span id="l2.5103" class="difflineplus">+        this[&quot;increment_&quot; + aDateAttr](this.rule.interval || 1);</span>
<a href="#l2.5104"></a><span id="l2.5104" class="difflineplus">+      }</span>
<a href="#l2.5105"></a><span id="l2.5105" class="difflineplus">+</span>
<a href="#l2.5106"></a><span id="l2.5106" class="difflineplus">+      if (has_by_rule &amp;&amp; end_of_data &amp;&amp; this_freq) {</span>
<a href="#l2.5107"></a><span id="l2.5107" class="difflineplus">+        this[&quot;increment_&quot; + aFollowingAttr](1);</span>
<a href="#l2.5108"></a><span id="l2.5108" class="difflineplus">+      }</span>
<a href="#l2.5109"></a><span id="l2.5109" class="difflineplus">+</span>
<a href="#l2.5110"></a><span id="l2.5110" class="difflineplus">+      return end_of_data;</span>
<a href="#l2.5111"></a><span id="l2.5111" class="difflineplus">+    },</span>
<a href="#l2.5112"></a><span id="l2.5112" class="difflineplus">+</span>
<a href="#l2.5113"></a><span id="l2.5113" class="difflineplus">+    increment_monthday: function increment_monthday(inc) {</span>
<a href="#l2.5114"></a><span id="l2.5114" class="difflineplus">+      for (var i = 0; i &lt; inc; i++) {</span>
<a href="#l2.5115"></a><span id="l2.5115" class="difflineplus">+        var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l2.5116"></a><span id="l2.5116" class="difflineplus">+        this.last.day++;</span>
<a href="#l2.5117"></a><span id="l2.5117" class="difflineplus">+</span>
<a href="#l2.5118"></a><span id="l2.5118" class="difflineplus">+        if (this.last.day &gt; daysInMonth) {</span>
<a href="#l2.5119"></a><span id="l2.5119" class="difflineplus">+          this.last.day -= daysInMonth;</span>
<a href="#l2.5120"></a><span id="l2.5120" class="difflineplus">+          this.increment_month();</span>
<a href="#l2.5121"></a><span id="l2.5121" class="difflineplus">+        }</span>
<a href="#l2.5122"></a><span id="l2.5122" class="difflineplus">+      }</span>
<a href="#l2.5123"></a><span id="l2.5123" class="difflineplus">+    },</span>
<a href="#l2.5124"></a><span id="l2.5124" class="difflineplus">+</span>
<a href="#l2.5125"></a><span id="l2.5125" class="difflineplus">+    increment_month: function increment_month() {</span>
<a href="#l2.5126"></a><span id="l2.5126" class="difflineplus">+      if (this.has_by_data(&quot;BYMONTH&quot;)) {</span>
<a href="#l2.5127"></a><span id="l2.5127" class="difflineplus">+        this.by_indices.BYMONTH++;</span>
<a href="#l2.5128"></a><span id="l2.5128" class="difflineplus">+</span>
<a href="#l2.5129"></a><span id="l2.5129" class="difflineplus">+        if (this.by_indices.BYMONTH == this.by_data.BYMONTH.length) {</span>
<a href="#l2.5130"></a><span id="l2.5130" class="difflineplus">+          this.by_indices.BYMONTH = 0;</span>
<a href="#l2.5131"></a><span id="l2.5131" class="difflineplus">+          this.increment_year(1);</span>
<a href="#l2.5132"></a><span id="l2.5132" class="difflineplus">+        }</span>
<a href="#l2.5133"></a><span id="l2.5133" class="difflineplus">+</span>
<a href="#l2.5134"></a><span id="l2.5134" class="difflineplus">+        this.last.month = this.by_data.BYMONTH[this.by_indices.BYMONTH];</span>
<a href="#l2.5135"></a><span id="l2.5135" class="difflineplus">+      } else {</span>
<a href="#l2.5136"></a><span id="l2.5136" class="difflineplus">+        var inc;</span>
<a href="#l2.5137"></a><span id="l2.5137" class="difflineplus">+        if (this.rule.freq == &quot;MONTHLY&quot;) {</span>
<a href="#l2.5138"></a><span id="l2.5138" class="difflineplus">+          this.last.month += this.rule.interval || 1;</span>
<a href="#l2.5139"></a><span id="l2.5139" class="difflineplus">+        } else {</span>
<a href="#l2.5140"></a><span id="l2.5140" class="difflineplus">+          this.last.month++;</span>
<a href="#l2.5141"></a><span id="l2.5141" class="difflineplus">+        }</span>
<a href="#l2.5142"></a><span id="l2.5142" class="difflineplus">+</span>
<a href="#l2.5143"></a><span id="l2.5143" class="difflineplus">+        this.last.month--;</span>
<a href="#l2.5144"></a><span id="l2.5144" class="difflineplus">+        var years = ICAL.helpers.trunc(this.last.month / 12);</span>
<a href="#l2.5145"></a><span id="l2.5145" class="difflineplus">+        this.last.month %= 12;</span>
<a href="#l2.5146"></a><span id="l2.5146" class="difflineplus">+        this.last.month++;</span>
<a href="#l2.5147"></a><span id="l2.5147" class="difflineplus">+</span>
<a href="#l2.5148"></a><span id="l2.5148" class="difflineplus">+        if (years != 0) {</span>
<a href="#l2.5149"></a><span id="l2.5149" class="difflineplus">+          this.increment_year(years);</span>
<a href="#l2.5150"></a><span id="l2.5150" class="difflineplus">+        }</span>
<a href="#l2.5151"></a><span id="l2.5151" class="difflineplus">+      }</span>
<a href="#l2.5152"></a><span id="l2.5152" class="difflineplus">+    },</span>
<a href="#l2.5153"></a><span id="l2.5153" class="difflineplus">+</span>
<a href="#l2.5154"></a><span id="l2.5154" class="difflineplus">+    increment_year: function increment_year(inc) {</span>
<a href="#l2.5155"></a><span id="l2.5155" class="difflineplus">+      this.last.year += inc;</span>
<a href="#l2.5156"></a><span id="l2.5156" class="difflineplus">+    },</span>
<a href="#l2.5157"></a><span id="l2.5157" class="difflineplus">+</span>
<a href="#l2.5158"></a><span id="l2.5158" class="difflineplus">+    increment_generic: function increment_generic(inc, aDateAttr,</span>
<a href="#l2.5159"></a><span id="l2.5159" class="difflineplus">+                                                  aFactor, aNextIncrement) {</span>
<a href="#l2.5160"></a><span id="l2.5160" class="difflineplus">+      this.last[aDateAttr] += inc;</span>
<a href="#l2.5161"></a><span id="l2.5161" class="difflineplus">+      var nextunit = ICAL.helpers.trunc(this.last[aDateAttr] / aFactor);</span>
<a href="#l2.5162"></a><span id="l2.5162" class="difflineplus">+      this.last[aDateAttr] %= aFactor;</span>
<a href="#l2.5163"></a><span id="l2.5163" class="difflineplus">+      if (nextunit != 0) {</span>
<a href="#l2.5164"></a><span id="l2.5164" class="difflineplus">+        this[&quot;increment_&quot; + aNextIncrement](nextunit);</span>
<a href="#l2.5165"></a><span id="l2.5165" class="difflineplus">+      }</span>
<a href="#l2.5166"></a><span id="l2.5166" class="difflineplus">+    },</span>
<a href="#l2.5167"></a><span id="l2.5167" class="difflineplus">+</span>
<a href="#l2.5168"></a><span id="l2.5168" class="difflineplus">+    has_by_data: function has_by_data(aRuleType) {</span>
<a href="#l2.5169"></a><span id="l2.5169" class="difflineplus">+      return (aRuleType in this.rule.parts);</span>
<a href="#l2.5170"></a><span id="l2.5170" class="difflineplus">+    },</span>
<a href="#l2.5171"></a><span id="l2.5171" class="difflineplus">+</span>
<a href="#l2.5172"></a><span id="l2.5172" class="difflineplus">+    expand_year_days: function expand_year_days(aYear) {</span>
<a href="#l2.5173"></a><span id="l2.5173" class="difflineplus">+      var t = new ICAL.Time();</span>
<a href="#l2.5174"></a><span id="l2.5174" class="difflineplus">+      this.days = [];</span>
<a href="#l2.5175"></a><span id="l2.5175" class="difflineplus">+</span>
<a href="#l2.5176"></a><span id="l2.5176" class="difflineplus">+      // We need our own copy with a few keys set</span>
<a href="#l2.5177"></a><span id="l2.5177" class="difflineplus">+      var parts = {};</span>
<a href="#l2.5178"></a><span id="l2.5178" class="difflineplus">+      var rules = [&quot;BYDAY&quot;, &quot;BYWEEKNO&quot;, &quot;BYMONTHDAY&quot;, &quot;BYMONTH&quot;, &quot;BYYEARDAY&quot;];</span>
<a href="#l2.5179"></a><span id="l2.5179" class="difflineplus">+      for (var p in rules) {</span>
<a href="#l2.5180"></a><span id="l2.5180" class="difflineplus">+        var part = rules[p];</span>
<a href="#l2.5181"></a><span id="l2.5181" class="difflineplus">+        if (part in this.rule.parts) {</span>
<a href="#l2.5182"></a><span id="l2.5182" class="difflineplus">+          parts[part] = this.rule.parts[part];</span>
<a href="#l2.5183"></a><span id="l2.5183" class="difflineplus">+        }</span>
<a href="#l2.5184"></a><span id="l2.5184" class="difflineplus">+      }</span>
<a href="#l2.5185"></a><span id="l2.5185" class="difflineplus">+</span>
<a href="#l2.5186"></a><span id="l2.5186" class="difflineplus">+      if (&quot;BYMONTH&quot; in parts &amp;&amp; &quot;BYWEEKNO&quot; in parts) {</span>
<a href="#l2.5187"></a><span id="l2.5187" class="difflineplus">+        var valid = 1;</span>
<a href="#l2.5188"></a><span id="l2.5188" class="difflineplus">+        var validWeeks = {};</span>
<a href="#l2.5189"></a><span id="l2.5189" class="difflineplus">+        t.year = aYear;</span>
<a href="#l2.5190"></a><span id="l2.5190" class="difflineplus">+        t.isDate = true;</span>
<a href="#l2.5191"></a><span id="l2.5191" class="difflineplus">+</span>
<a href="#l2.5192"></a><span id="l2.5192" class="difflineplus">+        for (var monthIdx = 0; monthIdx &lt; this.by_data.BYMONTH.length; monthIdx++) {</span>
<a href="#l2.5193"></a><span id="l2.5193" class="difflineplus">+          var month = this.by_data.BYMONTH[monthIdx];</span>
<a href="#l2.5194"></a><span id="l2.5194" class="difflineplus">+          t.month = month;</span>
<a href="#l2.5195"></a><span id="l2.5195" class="difflineplus">+          t.day = 1;</span>
<a href="#l2.5196"></a><span id="l2.5196" class="difflineplus">+          var first_week = t.weekNumber(this.rule.wkst);</span>
<a href="#l2.5197"></a><span id="l2.5197" class="difflineplus">+          t.day = ICAL.Time.daysInMonth(month, aYear);</span>
<a href="#l2.5198"></a><span id="l2.5198" class="difflineplus">+          var last_week = t.weekNumber(this.rule.wkst);</span>
<a href="#l2.5199"></a><span id="l2.5199" class="difflineplus">+          for (monthIdx = first_week; monthIdx &lt; last_week; monthIdx++) {</span>
<a href="#l2.5200"></a><span id="l2.5200" class="difflineplus">+            validWeeks[monthIdx] = 1;</span>
<a href="#l2.5201"></a><span id="l2.5201" class="difflineplus">+          }</span>
<a href="#l2.5202"></a><span id="l2.5202" class="difflineplus">+        }</span>
<a href="#l2.5203"></a><span id="l2.5203" class="difflineplus">+</span>
<a href="#l2.5204"></a><span id="l2.5204" class="difflineplus">+        for (var weekIdx = 0; weekIdx &lt; this.by_data.BYWEEKNO.length &amp;&amp; valid; weekIdx++) {</span>
<a href="#l2.5205"></a><span id="l2.5205" class="difflineplus">+          var weekno = this.by_data.BYWEEKNO[weekIdx];</span>
<a href="#l2.5206"></a><span id="l2.5206" class="difflineplus">+          if (weekno &lt; 52) {</span>
<a href="#l2.5207"></a><span id="l2.5207" class="difflineplus">+            valid &amp;= validWeeks[weekIdx];</span>
<a href="#l2.5208"></a><span id="l2.5208" class="difflineplus">+          } else {</span>
<a href="#l2.5209"></a><span id="l2.5209" class="difflineplus">+            valid = 0;</span>
<a href="#l2.5210"></a><span id="l2.5210" class="difflineplus">+          }</span>
<a href="#l2.5211"></a><span id="l2.5211" class="difflineplus">+        }</span>
<a href="#l2.5212"></a><span id="l2.5212" class="difflineplus">+</span>
<a href="#l2.5213"></a><span id="l2.5213" class="difflineplus">+        if (valid) {</span>
<a href="#l2.5214"></a><span id="l2.5214" class="difflineplus">+          delete parts.BYMONTH;</span>
<a href="#l2.5215"></a><span id="l2.5215" class="difflineplus">+        } else {</span>
<a href="#l2.5216"></a><span id="l2.5216" class="difflineplus">+          delete parts.BYWEEKNO;</span>
<a href="#l2.5217"></a><span id="l2.5217" class="difflineplus">+        }</span>
<a href="#l2.5218"></a><span id="l2.5218" class="difflineplus">+      }</span>
<a href="#l2.5219"></a><span id="l2.5219" class="difflineplus">+</span>
<a href="#l2.5220"></a><span id="l2.5220" class="difflineplus">+      var partCount = Object.keys(parts).length;</span>
<a href="#l2.5221"></a><span id="l2.5221" class="difflineplus">+</span>
<a href="#l2.5222"></a><span id="l2.5222" class="difflineplus">+      if (partCount == 0) {</span>
<a href="#l2.5223"></a><span id="l2.5223" class="difflineplus">+        var t = this.dtstart.clone();</span>
<a href="#l2.5224"></a><span id="l2.5224" class="difflineplus">+        t.year = this.last.year;</span>
<a href="#l2.5225"></a><span id="l2.5225" class="difflineplus">+        this.days.push(t.dayOfYear());</span>
<a href="#l2.5226"></a><span id="l2.5226" class="difflineplus">+      } else if (partCount == 1 &amp;&amp; &quot;BYMONTH&quot; in parts) {</span>
<a href="#l2.5227"></a><span id="l2.5227" class="difflineplus">+        for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l2.5228"></a><span id="l2.5228" class="difflineplus">+          var t2 = this.dtstart.clone();</span>
<a href="#l2.5229"></a><span id="l2.5229" class="difflineplus">+          t2.year = aYear;</span>
<a href="#l2.5230"></a><span id="l2.5230" class="difflineplus">+          t2.month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l2.5231"></a><span id="l2.5231" class="difflineplus">+          t2.isDate = true;</span>
<a href="#l2.5232"></a><span id="l2.5232" class="difflineplus">+          this.days.push(t2.dayOfYear());</span>
<a href="#l2.5233"></a><span id="l2.5233" class="difflineplus">+        }</span>
<a href="#l2.5234"></a><span id="l2.5234" class="difflineplus">+      } else if (partCount == 1 &amp;&amp; &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l2.5235"></a><span id="l2.5235" class="difflineplus">+        for (var monthdaykey in this.by_data.BYMONTHDAY) {</span>
<a href="#l2.5236"></a><span id="l2.5236" class="difflineplus">+          var t2 = this.dtstart.clone();</span>
<a href="#l2.5237"></a><span id="l2.5237" class="difflineplus">+          t2.day = this.by_data.BYMONTHDAY[monthdaykey];</span>
<a href="#l2.5238"></a><span id="l2.5238" class="difflineplus">+          t2.year = aYear;</span>
<a href="#l2.5239"></a><span id="l2.5239" class="difflineplus">+          t2.isDate = true;</span>
<a href="#l2.5240"></a><span id="l2.5240" class="difflineplus">+          this.days.push(t2.dayOfYear());</span>
<a href="#l2.5241"></a><span id="l2.5241" class="difflineplus">+        }</span>
<a href="#l2.5242"></a><span id="l2.5242" class="difflineplus">+      } else if (partCount == 2 &amp;&amp;</span>
<a href="#l2.5243"></a><span id="l2.5243" class="difflineplus">+                 &quot;BYMONTHDAY&quot; in parts &amp;&amp;</span>
<a href="#l2.5244"></a><span id="l2.5244" class="difflineplus">+                 &quot;BYMONTH&quot; in parts) {</span>
<a href="#l2.5245"></a><span id="l2.5245" class="difflineplus">+        for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l2.5246"></a><span id="l2.5246" class="difflineplus">+          for (var monthdaykey in this.by_data.BYMONTHDAY) {</span>
<a href="#l2.5247"></a><span id="l2.5247" class="difflineplus">+            t.day = this.by_data.BYMONTHDAY[monthdaykey];</span>
<a href="#l2.5248"></a><span id="l2.5248" class="difflineplus">+            t.month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l2.5249"></a><span id="l2.5249" class="difflineplus">+            t.year = aYear;</span>
<a href="#l2.5250"></a><span id="l2.5250" class="difflineplus">+            t.isDate = true;</span>
<a href="#l2.5251"></a><span id="l2.5251" class="difflineplus">+</span>
<a href="#l2.5252"></a><span id="l2.5252" class="difflineplus">+            this.days.push(t.dayOfYear());</span>
<a href="#l2.5253"></a><span id="l2.5253" class="difflineplus">+          }</span>
<a href="#l2.5254"></a><span id="l2.5254" class="difflineplus">+        }</span>
<a href="#l2.5255"></a><span id="l2.5255" class="difflineplus">+      } else if (partCount == 1 &amp;&amp; &quot;BYWEEKNO&quot; in parts) {</span>
<a href="#l2.5256"></a><span id="l2.5256" class="difflineplus">+        // TODO unimplemented in libical</span>
<a href="#l2.5257"></a><span id="l2.5257" class="difflineplus">+      } else if (partCount == 2 &amp;&amp;</span>
<a href="#l2.5258"></a><span id="l2.5258" class="difflineplus">+                 &quot;BYWEEKNO&quot; in parts &amp;&amp;</span>
<a href="#l2.5259"></a><span id="l2.5259" class="difflineplus">+                 &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l2.5260"></a><span id="l2.5260" class="difflineplus">+        // TODO unimplemented in libical</span>
<a href="#l2.5261"></a><span id="l2.5261" class="difflineplus">+      } else if (partCount == 1 &amp;&amp; &quot;BYDAY&quot; in parts) {</span>
<a href="#l2.5262"></a><span id="l2.5262" class="difflineplus">+        this.days = this.days.concat(this.expand_by_day(aYear));</span>
<a href="#l2.5263"></a><span id="l2.5263" class="difflineplus">+      } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYMONTH&quot; in parts) {</span>
<a href="#l2.5264"></a><span id="l2.5264" class="difflineplus">+        for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l2.5265"></a><span id="l2.5265" class="difflineplus">+          month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l2.5266"></a><span id="l2.5266" class="difflineplus">+          var daysInMonth = ICAL.Time.daysInMonth(month, aYear);</span>
<a href="#l2.5267"></a><span id="l2.5267" class="difflineplus">+</span>
<a href="#l2.5268"></a><span id="l2.5268" class="difflineplus">+          t.year = aYear;</span>
<a href="#l2.5269"></a><span id="l2.5269" class="difflineplus">+          t.month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l2.5270"></a><span id="l2.5270" class="difflineplus">+          t.day = 1;</span>
<a href="#l2.5271"></a><span id="l2.5271" class="difflineplus">+          t.isDate = true;</span>
<a href="#l2.5272"></a><span id="l2.5272" class="difflineplus">+</span>
<a href="#l2.5273"></a><span id="l2.5273" class="difflineplus">+          var first_dow = t.dayOfWeek();</span>
<a href="#l2.5274"></a><span id="l2.5274" class="difflineplus">+          var doy_offset = t.dayOfYear() - 1;</span>
<a href="#l2.5275"></a><span id="l2.5275" class="difflineplus">+</span>
<a href="#l2.5276"></a><span id="l2.5276" class="difflineplus">+          t.day = daysInMonth;</span>
<a href="#l2.5277"></a><span id="l2.5277" class="difflineplus">+          var last_dow = t.dayOfWeek();</span>
<a href="#l2.5278"></a><span id="l2.5278" class="difflineplus">+</span>
<a href="#l2.5279"></a><span id="l2.5279" class="difflineplus">+          if (this.has_by_data(&quot;BYSETPOS&quot;)) {</span>
<a href="#l2.5280"></a><span id="l2.5280" class="difflineplus">+            var set_pos_counter = 0;</span>
<a href="#l2.5281"></a><span id="l2.5281" class="difflineplus">+            var by_month_day = [];</span>
<a href="#l2.5282"></a><span id="l2.5282" class="difflineplus">+            for (var day = 1; day &lt;= daysInMonth; day++) {</span>
<a href="#l2.5283"></a><span id="l2.5283" class="difflineplus">+              t.day = day;</span>
<a href="#l2.5284"></a><span id="l2.5284" class="difflineplus">+              if (this.is_day_in_byday(t)) {</span>
<a href="#l2.5285"></a><span id="l2.5285" class="difflineplus">+                by_month_day.push(day);</span>
<a href="#l2.5286"></a><span id="l2.5286" class="difflineplus">+              }</span>
<a href="#l2.5287"></a><span id="l2.5287" class="difflineplus">+            }</span>
<a href="#l2.5288"></a><span id="l2.5288" class="difflineplus">+</span>
<a href="#l2.5289"></a><span id="l2.5289" class="difflineplus">+            for (var spIndex = 0; spIndex &lt; by_month_day.length; spIndex++) {</span>
<a href="#l2.5290"></a><span id="l2.5290" class="difflineplus">+              if (this.check_set_position(spIndex + 1) ||</span>
<a href="#l2.5291"></a><span id="l2.5291" class="difflineplus">+                  this.check_set_position(spIndex - by_month_day.length)) {</span>
<a href="#l2.5292"></a><span id="l2.5292" class="difflineplus">+                this.days.push(doy_offset + by_month_day[spIndex]);</span>
<a href="#l2.5293"></a><span id="l2.5293" class="difflineplus">+              }</span>
<a href="#l2.5294"></a><span id="l2.5294" class="difflineplus">+            }</span>
<a href="#l2.5295"></a><span id="l2.5295" class="difflineplus">+          } else {</span>
<a href="#l2.5296"></a><span id="l2.5296" class="difflineplus">+            for (var daycodedkey in this.by_data.BYDAY) {</span>
<a href="#l2.5297"></a><span id="l2.5297" class="difflineplus">+              //TODO: This should return dates in order of occurrence</span>
<a href="#l2.5298"></a><span id="l2.5298" class="difflineplus">+              //      (1,2,3, etc...) instead of by weekday (su, mo, etc..)</span>
<a href="#l2.5299"></a><span id="l2.5299" class="difflineplus">+              var coded_day = this.by_data.BYDAY[daycodedkey];</span>
<a href="#l2.5300"></a><span id="l2.5300" class="difflineplus">+              var parts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l2.5301"></a><span id="l2.5301" class="difflineplus">+              var pos = parts[0];</span>
<a href="#l2.5302"></a><span id="l2.5302" class="difflineplus">+              var dow = parts[1];</span>
<a href="#l2.5303"></a><span id="l2.5303" class="difflineplus">+              var month_day;</span>
<a href="#l2.5304"></a><span id="l2.5304" class="difflineplus">+</span>
<a href="#l2.5305"></a><span id="l2.5305" class="difflineplus">+              var first_matching_day = ((dow + 7 - first_dow) % 7) + 1;</span>
<a href="#l2.5306"></a><span id="l2.5306" class="difflineplus">+              var last_matching_day = daysInMonth - ((last_dow + 7 - dow) % 7);</span>
<a href="#l2.5307"></a><span id="l2.5307" class="difflineplus">+</span>
<a href="#l2.5308"></a><span id="l2.5308" class="difflineplus">+              if (pos == 0) {</span>
<a href="#l2.5309"></a><span id="l2.5309" class="difflineplus">+                for (var day = first_matching_day; day &lt;= daysInMonth; day += 7) {</span>
<a href="#l2.5310"></a><span id="l2.5310" class="difflineplus">+                  this.days.push(doy_offset + day);</span>
<a href="#l2.5311"></a><span id="l2.5311" class="difflineplus">+                }</span>
<a href="#l2.5312"></a><span id="l2.5312" class="difflineplus">+              } else if (pos &gt; 0) {</span>
<a href="#l2.5313"></a><span id="l2.5313" class="difflineplus">+                month_day = first_matching_day + (pos - 1) * 7;</span>
<a href="#l2.5314"></a><span id="l2.5314" class="difflineplus">+</span>
<a href="#l2.5315"></a><span id="l2.5315" class="difflineplus">+                if (month_day &lt;= daysInMonth) {</span>
<a href="#l2.5316"></a><span id="l2.5316" class="difflineplus">+                  this.days.push(doy_offset + month_day);</span>
<a href="#l2.5317"></a><span id="l2.5317" class="difflineplus">+                }</span>
<a href="#l2.5318"></a><span id="l2.5318" class="difflineplus">+              } else {</span>
<a href="#l2.5319"></a><span id="l2.5319" class="difflineplus">+                month_day = last_matching_day + (pos + 1) * 7;</span>
<a href="#l2.5320"></a><span id="l2.5320" class="difflineplus">+</span>
<a href="#l2.5321"></a><span id="l2.5321" class="difflineplus">+                if (month_day &gt; 0) {</span>
<a href="#l2.5322"></a><span id="l2.5322" class="difflineplus">+                  this.days.push(doy_offset + month_day);</span>
<a href="#l2.5323"></a><span id="l2.5323" class="difflineplus">+                }</span>
<a href="#l2.5324"></a><span id="l2.5324" class="difflineplus">+              }</span>
<a href="#l2.5325"></a><span id="l2.5325" class="difflineplus">+            }</span>
<a href="#l2.5326"></a><span id="l2.5326" class="difflineplus">+          }</span>
<a href="#l2.5327"></a><span id="l2.5327" class="difflineplus">+        }</span>
<a href="#l2.5328"></a><span id="l2.5328" class="difflineplus">+      } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l2.5329"></a><span id="l2.5329" class="difflineplus">+        var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l2.5330"></a><span id="l2.5330" class="difflineplus">+</span>
<a href="#l2.5331"></a><span id="l2.5331" class="difflineplus">+        for (var daykey in expandedDays) {</span>
<a href="#l2.5332"></a><span id="l2.5332" class="difflineplus">+          var day = expandedDays[daykey];</span>
<a href="#l2.5333"></a><span id="l2.5333" class="difflineplus">+          var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l2.5334"></a><span id="l2.5334" class="difflineplus">+          if (this.by_data.BYMONTHDAY.indexOf(tt.day) &gt;= 0) {</span>
<a href="#l2.5335"></a><span id="l2.5335" class="difflineplus">+            this.days.push(day);</span>
<a href="#l2.5336"></a><span id="l2.5336" class="difflineplus">+          }</span>
<a href="#l2.5337"></a><span id="l2.5337" class="difflineplus">+        }</span>
<a href="#l2.5338"></a><span id="l2.5338" class="difflineplus">+      } else if (partCount == 3 &amp;&amp;</span>
<a href="#l2.5339"></a><span id="l2.5339" class="difflineplus">+                 &quot;BYDAY&quot; in parts &amp;&amp;</span>
<a href="#l2.5340"></a><span id="l2.5340" class="difflineplus">+                 &quot;BYMONTHDAY&quot; in parts &amp;&amp;</span>
<a href="#l2.5341"></a><span id="l2.5341" class="difflineplus">+                 &quot;BYMONTH&quot; in parts) {</span>
<a href="#l2.5342"></a><span id="l2.5342" class="difflineplus">+        var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l2.5343"></a><span id="l2.5343" class="difflineplus">+</span>
<a href="#l2.5344"></a><span id="l2.5344" class="difflineplus">+        for (var daykey in expandedDays) {</span>
<a href="#l2.5345"></a><span id="l2.5345" class="difflineplus">+          var day = expandedDays[daykey];</span>
<a href="#l2.5346"></a><span id="l2.5346" class="difflineplus">+          var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l2.5347"></a><span id="l2.5347" class="difflineplus">+</span>
<a href="#l2.5348"></a><span id="l2.5348" class="difflineplus">+          if (this.by_data.BYMONTH.indexOf(tt.month) &gt;= 0 &amp;&amp;</span>
<a href="#l2.5349"></a><span id="l2.5349" class="difflineplus">+              this.by_data.BYMONTHDAY.indexOf(tt.day) &gt;= 0) {</span>
<a href="#l2.5350"></a><span id="l2.5350" class="difflineplus">+            this.days.push(day);</span>
<a href="#l2.5351"></a><span id="l2.5351" class="difflineplus">+          }</span>
<a href="#l2.5352"></a><span id="l2.5352" class="difflineplus">+        }</span>
<a href="#l2.5353"></a><span id="l2.5353" class="difflineplus">+      } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYWEEKNO&quot; in parts) {</span>
<a href="#l2.5354"></a><span id="l2.5354" class="difflineplus">+        var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l2.5355"></a><span id="l2.5355" class="difflineplus">+</span>
<a href="#l2.5356"></a><span id="l2.5356" class="difflineplus">+        for (var daykey in expandedDays) {</span>
<a href="#l2.5357"></a><span id="l2.5357" class="difflineplus">+          var day = expandedDays[daykey];</span>
<a href="#l2.5358"></a><span id="l2.5358" class="difflineplus">+          var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l2.5359"></a><span id="l2.5359" class="difflineplus">+          var weekno = tt.weekNumber(this.rule.wkst);</span>
<a href="#l2.5360"></a><span id="l2.5360" class="difflineplus">+</span>
<a href="#l2.5361"></a><span id="l2.5361" class="difflineplus">+          if (this.by_data.BYWEEKNO.indexOf(weekno)) {</span>
<a href="#l2.5362"></a><span id="l2.5362" class="difflineplus">+            this.days.push(day);</span>
<a href="#l2.5363"></a><span id="l2.5363" class="difflineplus">+          }</span>
<a href="#l2.5364"></a><span id="l2.5364" class="difflineplus">+        }</span>
<a href="#l2.5365"></a><span id="l2.5365" class="difflineplus">+      } else if (partCount == 3 &amp;&amp;</span>
<a href="#l2.5366"></a><span id="l2.5366" class="difflineplus">+                 &quot;BYDAY&quot; in parts &amp;&amp;</span>
<a href="#l2.5367"></a><span id="l2.5367" class="difflineplus">+                 &quot;BYWEEKNO&quot; in parts &amp;&amp;</span>
<a href="#l2.5368"></a><span id="l2.5368" class="difflineplus">+                 &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l2.5369"></a><span id="l2.5369" class="difflineplus">+        // TODO unimplemted in libical</span>
<a href="#l2.5370"></a><span id="l2.5370" class="difflineplus">+      } else if (partCount == 1 &amp;&amp; &quot;BYYEARDAY&quot; in parts) {</span>
<a href="#l2.5371"></a><span id="l2.5371" class="difflineplus">+        this.days = this.days.concat(this.by_data.BYYEARDAY);</span>
<a href="#l2.5372"></a><span id="l2.5372" class="difflineplus">+      } else {</span>
<a href="#l2.5373"></a><span id="l2.5373" class="difflineplus">+        this.days = [];</span>
<a href="#l2.5374"></a><span id="l2.5374" class="difflineplus">+      }</span>
<a href="#l2.5375"></a><span id="l2.5375" class="difflineplus">+      return 0;</span>
<a href="#l2.5376"></a><span id="l2.5376" class="difflineplus">+    },</span>
<a href="#l2.5377"></a><span id="l2.5377" class="difflineplus">+</span>
<a href="#l2.5378"></a><span id="l2.5378" class="difflineplus">+    expand_by_day: function expand_by_day(aYear) {</span>
<a href="#l2.5379"></a><span id="l2.5379" class="difflineplus">+</span>
<a href="#l2.5380"></a><span id="l2.5380" class="difflineplus">+      var days_list = [];</span>
<a href="#l2.5381"></a><span id="l2.5381" class="difflineplus">+      var tmp = this.last.clone();</span>
<a href="#l2.5382"></a><span id="l2.5382" class="difflineplus">+</span>
<a href="#l2.5383"></a><span id="l2.5383" class="difflineplus">+      tmp.year = aYear;</span>
<a href="#l2.5384"></a><span id="l2.5384" class="difflineplus">+      tmp.month = 1;</span>
<a href="#l2.5385"></a><span id="l2.5385" class="difflineplus">+      tmp.day = 1;</span>
<a href="#l2.5386"></a><span id="l2.5386" class="difflineplus">+      tmp.isDate = true;</span>
<a href="#l2.5387"></a><span id="l2.5387" class="difflineplus">+</span>
<a href="#l2.5388"></a><span id="l2.5388" class="difflineplus">+      var start_dow = tmp.dayOfWeek();</span>
<a href="#l2.5389"></a><span id="l2.5389" class="difflineplus">+</span>
<a href="#l2.5390"></a><span id="l2.5390" class="difflineplus">+      tmp.month = 12;</span>
<a href="#l2.5391"></a><span id="l2.5391" class="difflineplus">+      tmp.day = 31;</span>
<a href="#l2.5392"></a><span id="l2.5392" class="difflineplus">+      tmp.isDate = true;</span>
<a href="#l2.5393"></a><span id="l2.5393" class="difflineplus">+</span>
<a href="#l2.5394"></a><span id="l2.5394" class="difflineplus">+      var end_dow = tmp.dayOfWeek();</span>
<a href="#l2.5395"></a><span id="l2.5395" class="difflineplus">+      var end_year_day = tmp.dayOfYear();</span>
<a href="#l2.5396"></a><span id="l2.5396" class="difflineplus">+</span>
<a href="#l2.5397"></a><span id="l2.5397" class="difflineplus">+      for (var daykey in this.by_data.BYDAY) {</span>
<a href="#l2.5398"></a><span id="l2.5398" class="difflineplus">+        var day = this.by_data.BYDAY[daykey];</span>
<a href="#l2.5399"></a><span id="l2.5399" class="difflineplus">+        var parts = this.ruleDayOfWeek(day);</span>
<a href="#l2.5400"></a><span id="l2.5400" class="difflineplus">+        var pos = parts[0];</span>
<a href="#l2.5401"></a><span id="l2.5401" class="difflineplus">+        var dow = parts[1];</span>
<a href="#l2.5402"></a><span id="l2.5402" class="difflineplus">+</span>
<a href="#l2.5403"></a><span id="l2.5403" class="difflineplus">+        if (pos == 0) {</span>
<a href="#l2.5404"></a><span id="l2.5404" class="difflineplus">+          var tmp_start_doy = ((dow + 7 - start_dow) % 7) + 1;</span>
<a href="#l2.5405"></a><span id="l2.5405" class="difflineplus">+</span>
<a href="#l2.5406"></a><span id="l2.5406" class="difflineplus">+          for (var doy = tmp_start_doy; doy &lt;= end_year_day; doy += 7) {</span>
<a href="#l2.5407"></a><span id="l2.5407" class="difflineplus">+            days_list.push(doy);</span>
<a href="#l2.5408"></a><span id="l2.5408" class="difflineplus">+          }</span>
<a href="#l2.5409"></a><span id="l2.5409" class="difflineplus">+</span>
<a href="#l2.5410"></a><span id="l2.5410" class="difflineplus">+        } else if (pos &gt; 0) {</span>
<a href="#l2.5411"></a><span id="l2.5411" class="difflineplus">+          var first;</span>
<a href="#l2.5412"></a><span id="l2.5412" class="difflineplus">+          if (dow &gt;= start_dow) {</span>
<a href="#l2.5413"></a><span id="l2.5413" class="difflineplus">+            first = dow - start_dow + 1;</span>
<a href="#l2.5414"></a><span id="l2.5414" class="difflineplus">+          } else {</span>
<a href="#l2.5415"></a><span id="l2.5415" class="difflineplus">+            first = dow - start_dow + 8;</span>
<a href="#l2.5416"></a><span id="l2.5416" class="difflineplus">+          }</span>
<a href="#l2.5417"></a><span id="l2.5417" class="difflineplus">+</span>
<a href="#l2.5418"></a><span id="l2.5418" class="difflineplus">+          days_list.push(first + (pos - 1) * 7);</span>
<a href="#l2.5419"></a><span id="l2.5419" class="difflineplus">+        } else {</span>
<a href="#l2.5420"></a><span id="l2.5420" class="difflineplus">+          var last;</span>
<a href="#l2.5421"></a><span id="l2.5421" class="difflineplus">+          pos = -pos;</span>
<a href="#l2.5422"></a><span id="l2.5422" class="difflineplus">+</span>
<a href="#l2.5423"></a><span id="l2.5423" class="difflineplus">+          if (dow &lt;= end_dow) {</span>
<a href="#l2.5424"></a><span id="l2.5424" class="difflineplus">+            last = end_year_day - end_dow + dow;</span>
<a href="#l2.5425"></a><span id="l2.5425" class="difflineplus">+          } else {</span>
<a href="#l2.5426"></a><span id="l2.5426" class="difflineplus">+            last = end_year_day - end_dow + dow - 7;</span>
<a href="#l2.5427"></a><span id="l2.5427" class="difflineplus">+          }</span>
<a href="#l2.5428"></a><span id="l2.5428" class="difflineplus">+</span>
<a href="#l2.5429"></a><span id="l2.5429" class="difflineplus">+          days_list.push(last - (pos - 1) * 7);</span>
<a href="#l2.5430"></a><span id="l2.5430" class="difflineplus">+        }</span>
<a href="#l2.5431"></a><span id="l2.5431" class="difflineplus">+      }</span>
<a href="#l2.5432"></a><span id="l2.5432" class="difflineplus">+      return days_list;</span>
<a href="#l2.5433"></a><span id="l2.5433" class="difflineplus">+    },</span>
<a href="#l2.5434"></a><span id="l2.5434" class="difflineplus">+</span>
<a href="#l2.5435"></a><span id="l2.5435" class="difflineplus">+    is_day_in_byday: function is_day_in_byday(tt) {</span>
<a href="#l2.5436"></a><span id="l2.5436" class="difflineplus">+      for (var daykey in this.by_data.BYDAY) {</span>
<a href="#l2.5437"></a><span id="l2.5437" class="difflineplus">+        var day = this.by_data.BYDAY[daykey];</span>
<a href="#l2.5438"></a><span id="l2.5438" class="difflineplus">+        var parts = this.ruleDayOfWeek(day);</span>
<a href="#l2.5439"></a><span id="l2.5439" class="difflineplus">+        var pos = parts[0];</span>
<a href="#l2.5440"></a><span id="l2.5440" class="difflineplus">+        var dow = parts[1];</span>
<a href="#l2.5441"></a><span id="l2.5441" class="difflineplus">+        var this_dow = tt.dayOfWeek();</span>
<a href="#l2.5442"></a><span id="l2.5442" class="difflineplus">+</span>
<a href="#l2.5443"></a><span id="l2.5443" class="difflineplus">+        if ((pos == 0 &amp;&amp; dow == this_dow) ||</span>
<a href="#l2.5444"></a><span id="l2.5444" class="difflineplus">+            (tt.nthWeekDay(dow, pos) == tt.day)) {</span>
<a href="#l2.5445"></a><span id="l2.5445" class="difflineplus">+          return 1;</span>
<a href="#l2.5446"></a><span id="l2.5446" class="difflineplus">+        }</span>
<a href="#l2.5447"></a><span id="l2.5447" class="difflineplus">+      }</span>
<a href="#l2.5448"></a><span id="l2.5448" class="difflineplus">+</span>
<a href="#l2.5449"></a><span id="l2.5449" class="difflineplus">+      return 0;</span>
<a href="#l2.5450"></a><span id="l2.5450" class="difflineplus">+    },</span>
<a href="#l2.5451"></a><span id="l2.5451" class="difflineplus">+</span>
<a href="#l2.5452"></a><span id="l2.5452" class="difflineplus">+    /**</span>
<a href="#l2.5453"></a><span id="l2.5453" class="difflineplus">+     * Checks if given value is in BYSETPOS.</span>
<a href="#l2.5454"></a><span id="l2.5454" class="difflineplus">+     *</span>
<a href="#l2.5455"></a><span id="l2.5455" class="difflineplus">+     * @param {Numeric} aPos position to check for.</span>
<a href="#l2.5456"></a><span id="l2.5456" class="difflineplus">+     * @return {Boolean} false unless BYSETPOS rules exist</span>
<a href="#l2.5457"></a><span id="l2.5457" class="difflineplus">+     *                   and the given value is present in rules.</span>
<a href="#l2.5458"></a><span id="l2.5458" class="difflineplus">+     */</span>
<a href="#l2.5459"></a><span id="l2.5459" class="difflineplus">+    check_set_position: function check_set_position(aPos) {</span>
<a href="#l2.5460"></a><span id="l2.5460" class="difflineplus">+      if (this.has_by_data('BYSETPOS')) {</span>
<a href="#l2.5461"></a><span id="l2.5461" class="difflineplus">+        var idx = this.by_data.BYSETPOS.indexOf(aPos);</span>
<a href="#l2.5462"></a><span id="l2.5462" class="difflineplus">+        // negative numbers are not false-y</span>
<a href="#l2.5463"></a><span id="l2.5463" class="difflineplus">+        return idx !== -1;</span>
<a href="#l2.5464"></a><span id="l2.5464" class="difflineplus">+      }</span>
<a href="#l2.5465"></a><span id="l2.5465" class="difflineplus">+      return false;</span>
<a href="#l2.5466"></a><span id="l2.5466" class="difflineplus">+    },</span>
<a href="#l2.5467"></a><span id="l2.5467" class="difflineplus">+</span>
<a href="#l2.5468"></a><span id="l2.5468" class="difflineplus">+    sort_byday_rules: function icalrecur_sort_byday_rules(aRules, aWeekStart) {</span>
<a href="#l2.5469"></a><span id="l2.5469" class="difflineplus">+      for (var i = 0; i &lt; aRules.length; i++) {</span>
<a href="#l2.5470"></a><span id="l2.5470" class="difflineplus">+        for (var j = 0; j &lt; i; j++) {</span>
<a href="#l2.5471"></a><span id="l2.5471" class="difflineplus">+          var one = this.ruleDayOfWeek(aRules[j])[1];</span>
<a href="#l2.5472"></a><span id="l2.5472" class="difflineplus">+          var two = this.ruleDayOfWeek(aRules[i])[1];</span>
<a href="#l2.5473"></a><span id="l2.5473" class="difflineplus">+          one -= aWeekStart;</span>
<a href="#l2.5474"></a><span id="l2.5474" class="difflineplus">+          two -= aWeekStart;</span>
<a href="#l2.5475"></a><span id="l2.5475" class="difflineplus">+          if (one &lt; 0) one += 7;</span>
<a href="#l2.5476"></a><span id="l2.5476" class="difflineplus">+          if (two &lt; 0) two += 7;</span>
<a href="#l2.5477"></a><span id="l2.5477" class="difflineplus">+</span>
<a href="#l2.5478"></a><span id="l2.5478" class="difflineplus">+          if (one &gt; two) {</span>
<a href="#l2.5479"></a><span id="l2.5479" class="difflineplus">+            var tmp = aRules[i];</span>
<a href="#l2.5480"></a><span id="l2.5480" class="difflineplus">+            aRules[i] = aRules[j];</span>
<a href="#l2.5481"></a><span id="l2.5481" class="difflineplus">+            aRules[j] = tmp;</span>
<a href="#l2.5482"></a><span id="l2.5482" class="difflineplus">+          }</span>
<a href="#l2.5483"></a><span id="l2.5483" class="difflineplus">+        }</span>
<a href="#l2.5484"></a><span id="l2.5484" class="difflineplus">+      }</span>
<a href="#l2.5485"></a><span id="l2.5485" class="difflineplus">+    },</span>
<a href="#l2.5486"></a><span id="l2.5486" class="difflineplus">+</span>
<a href="#l2.5487"></a><span id="l2.5487" class="difflineplus">+    check_contract_restriction: function check_contract_restriction(aRuleType, v) {</span>
<a href="#l2.5488"></a><span id="l2.5488" class="difflineplus">+      var indexMapValue = icalrecur_iterator._indexMap[aRuleType];</span>
<a href="#l2.5489"></a><span id="l2.5489" class="difflineplus">+      var ruleMapValue = icalrecur_iterator._expandMap[this.rule.freq][indexMapValue];</span>
<a href="#l2.5490"></a><span id="l2.5490" class="difflineplus">+      var pass = false;</span>
<a href="#l2.5491"></a><span id="l2.5491" class="difflineplus">+</span>
<a href="#l2.5492"></a><span id="l2.5492" class="difflineplus">+      if (aRuleType in this.by_data &amp;&amp;</span>
<a href="#l2.5493"></a><span id="l2.5493" class="difflineplus">+          ruleMapValue == icalrecur_iterator.CONTRACT) {</span>
<a href="#l2.5494"></a><span id="l2.5494" class="difflineplus">+</span>
<a href="#l2.5495"></a><span id="l2.5495" class="difflineplus">+        var ruleType = this.by_data[aRuleType];</span>
<a href="#l2.5496"></a><span id="l2.5496" class="difflineplus">+</span>
<a href="#l2.5497"></a><span id="l2.5497" class="difflineplus">+        for (var bydatakey in ruleType) {</span>
<a href="#l2.5498"></a><span id="l2.5498" class="difflineplus">+          if (ruleType[bydatakey] == v) {</span>
<a href="#l2.5499"></a><span id="l2.5499" class="difflineplus">+            pass = true;</span>
<a href="#l2.5500"></a><span id="l2.5500" class="difflineplus">+            break;</span>
<a href="#l2.5501"></a><span id="l2.5501" class="difflineplus">+          }</span>
<a href="#l2.5502"></a><span id="l2.5502" class="difflineplus">+        }</span>
<a href="#l2.5503"></a><span id="l2.5503" class="difflineplus">+      } else {</span>
<a href="#l2.5504"></a><span id="l2.5504" class="difflineplus">+        // Not a contracting byrule or has no data, test passes</span>
<a href="#l2.5505"></a><span id="l2.5505" class="difflineplus">+        pass = true;</span>
<a href="#l2.5506"></a><span id="l2.5506" class="difflineplus">+      }</span>
<a href="#l2.5507"></a><span id="l2.5507" class="difflineplus">+      return pass;</span>
<a href="#l2.5508"></a><span id="l2.5508" class="difflineplus">+    },</span>
<a href="#l2.5509"></a><span id="l2.5509" class="difflineplus">+</span>
<a href="#l2.5510"></a><span id="l2.5510" class="difflineplus">+    check_contracting_rules: function check_contracting_rules() {</span>
<a href="#l2.5511"></a><span id="l2.5511" class="difflineplus">+      var dow = this.last.dayOfWeek();</span>
<a href="#l2.5512"></a><span id="l2.5512" class="difflineplus">+      var weekNo = this.last.weekNumber(this.rule.wkst);</span>
<a href="#l2.5513"></a><span id="l2.5513" class="difflineplus">+      var doy = this.last.dayOfYear();</span>
<a href="#l2.5514"></a><span id="l2.5514" class="difflineplus">+</span>
<a href="#l2.5515"></a><span id="l2.5515" class="difflineplus">+      return (this.check_contract_restriction(&quot;BYSECOND&quot;, this.last.second) &amp;&amp;</span>
<a href="#l2.5516"></a><span id="l2.5516" class="difflineplus">+              this.check_contract_restriction(&quot;BYMINUTE&quot;, this.last.minute) &amp;&amp;</span>
<a href="#l2.5517"></a><span id="l2.5517" class="difflineplus">+              this.check_contract_restriction(&quot;BYHOUR&quot;, this.last.hour) &amp;&amp;</span>
<a href="#l2.5518"></a><span id="l2.5518" class="difflineplus">+              this.check_contract_restriction(&quot;BYDAY&quot;, icalrecur_iterator._wkdayMap[dow]) &amp;&amp;</span>
<a href="#l2.5519"></a><span id="l2.5519" class="difflineplus">+              this.check_contract_restriction(&quot;BYWEEKNO&quot;, weekNo) &amp;&amp;</span>
<a href="#l2.5520"></a><span id="l2.5520" class="difflineplus">+              this.check_contract_restriction(&quot;BYMONTHDAY&quot;, this.last.day) &amp;&amp;</span>
<a href="#l2.5521"></a><span id="l2.5521" class="difflineplus">+              this.check_contract_restriction(&quot;BYMONTH&quot;, this.last.month) &amp;&amp;</span>
<a href="#l2.5522"></a><span id="l2.5522" class="difflineplus">+              this.check_contract_restriction(&quot;BYYEARDAY&quot;, doy));</span>
<a href="#l2.5523"></a><span id="l2.5523" class="difflineplus">+    },</span>
<a href="#l2.5524"></a><span id="l2.5524" class="difflineplus">+</span>
<a href="#l2.5525"></a><span id="l2.5525" class="difflineplus">+    setup_defaults: function setup_defaults(aRuleType, req, deftime) {</span>
<a href="#l2.5526"></a><span id="l2.5526" class="difflineplus">+      var indexMapValue = icalrecur_iterator._indexMap[aRuleType];</span>
<a href="#l2.5527"></a><span id="l2.5527" class="difflineplus">+      var ruleMapValue = icalrecur_iterator._expandMap[this.rule.freq][indexMapValue];</span>
<a href="#l2.5528"></a><span id="l2.5528" class="difflineplus">+</span>
<a href="#l2.5529"></a><span id="l2.5529" class="difflineplus">+      if (ruleMapValue != icalrecur_iterator.CONTRACT) {</span>
<a href="#l2.5530"></a><span id="l2.5530" class="difflineplus">+        if (!(aRuleType in this.by_data)) {</span>
<a href="#l2.5531"></a><span id="l2.5531" class="difflineplus">+          this.by_data[aRuleType] = [deftime];</span>
<a href="#l2.5532"></a><span id="l2.5532" class="difflineplus">+        }</span>
<a href="#l2.5533"></a><span id="l2.5533" class="difflineplus">+        if (this.rule.freq != req) {</span>
<a href="#l2.5534"></a><span id="l2.5534" class="difflineplus">+          return this.by_data[aRuleType][0];</span>
<a href="#l2.5535"></a><span id="l2.5535" class="difflineplus">+        }</span>
<a href="#l2.5536"></a><span id="l2.5536" class="difflineplus">+      }</span>
<a href="#l2.5537"></a><span id="l2.5537" class="difflineplus">+      return deftime;</span>
<a href="#l2.5538"></a><span id="l2.5538" class="difflineplus">+    },</span>
<a href="#l2.5539"></a><span id="l2.5539" class="difflineplus">+</span>
<a href="#l2.5540"></a><span id="l2.5540" class="difflineplus">+    /**</span>
<a href="#l2.5541"></a><span id="l2.5541" class="difflineplus">+     * Convert iterator into a serialize-able object.</span>
<a href="#l2.5542"></a><span id="l2.5542" class="difflineplus">+     * Will preserve current iteration sequence to ensure</span>
<a href="#l2.5543"></a><span id="l2.5543" class="difflineplus">+     * the seamless continuation of the recurrence rule.</span>
<a href="#l2.5544"></a><span id="l2.5544" class="difflineplus">+     */</span>
<a href="#l2.5545"></a><span id="l2.5545" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.5546"></a><span id="l2.5546" class="difflineplus">+      var result = Object.create(null);</span>
<a href="#l2.5547"></a><span id="l2.5547" class="difflineplus">+</span>
<a href="#l2.5548"></a><span id="l2.5548" class="difflineplus">+      result.initialized = this.initialized;</span>
<a href="#l2.5549"></a><span id="l2.5549" class="difflineplus">+      result.rule = this.rule.toJSON();</span>
<a href="#l2.5550"></a><span id="l2.5550" class="difflineplus">+      result.dtstart = this.dtstart.toJSON();</span>
<a href="#l2.5551"></a><span id="l2.5551" class="difflineplus">+      result.by_data = this.by_data;</span>
<a href="#l2.5552"></a><span id="l2.5552" class="difflineplus">+      result.days = this.days;</span>
<a href="#l2.5553"></a><span id="l2.5553" class="difflineplus">+      result.last = this.last.toJSON();</span>
<a href="#l2.5554"></a><span id="l2.5554" class="difflineplus">+      result.by_indices = this.by_indices;</span>
<a href="#l2.5555"></a><span id="l2.5555" class="difflineplus">+      result.occurrence_number = this.occurrence_number;</span>
<a href="#l2.5556"></a><span id="l2.5556" class="difflineplus">+</span>
<a href="#l2.5557"></a><span id="l2.5557" class="difflineplus">+      return result;</span>
<a href="#l2.5558"></a><span id="l2.5558" class="difflineplus">+    }</span>
<a href="#l2.5559"></a><span id="l2.5559" class="difflineplus">+</span>
<a href="#l2.5560"></a><span id="l2.5560" class="difflineplus">+  };</span>
<a href="#l2.5561"></a><span id="l2.5561" class="difflineplus">+</span>
<a href="#l2.5562"></a><span id="l2.5562" class="difflineplus">+  icalrecur_iterator._wkdayMap = [&quot;&quot;, &quot;SU&quot;, &quot;MO&quot;, &quot;TU&quot;, &quot;WE&quot;, &quot;TH&quot;, &quot;FR&quot;, &quot;SA&quot;];</span>
<a href="#l2.5563"></a><span id="l2.5563" class="difflineplus">+</span>
<a href="#l2.5564"></a><span id="l2.5564" class="difflineplus">+  icalrecur_iterator._indexMap = {</span>
<a href="#l2.5565"></a><span id="l2.5565" class="difflineplus">+    &quot;BYSECOND&quot;: 0,</span>
<a href="#l2.5566"></a><span id="l2.5566" class="difflineplus">+    &quot;BYMINUTE&quot;: 1,</span>
<a href="#l2.5567"></a><span id="l2.5567" class="difflineplus">+    &quot;BYHOUR&quot;: 2,</span>
<a href="#l2.5568"></a><span id="l2.5568" class="difflineplus">+    &quot;BYDAY&quot;: 3,</span>
<a href="#l2.5569"></a><span id="l2.5569" class="difflineplus">+    &quot;BYMONTHDAY&quot;: 4,</span>
<a href="#l2.5570"></a><span id="l2.5570" class="difflineplus">+    &quot;BYYEARDAY&quot;: 5,</span>
<a href="#l2.5571"></a><span id="l2.5571" class="difflineplus">+    &quot;BYWEEKNO&quot;: 6,</span>
<a href="#l2.5572"></a><span id="l2.5572" class="difflineplus">+    &quot;BYMONTH&quot;: 7,</span>
<a href="#l2.5573"></a><span id="l2.5573" class="difflineplus">+    &quot;BYSETPOS&quot;: 8</span>
<a href="#l2.5574"></a><span id="l2.5574" class="difflineplus">+  };</span>
<a href="#l2.5575"></a><span id="l2.5575" class="difflineplus">+</span>
<a href="#l2.5576"></a><span id="l2.5576" class="difflineplus">+  icalrecur_iterator._expandMap = {</span>
<a href="#l2.5577"></a><span id="l2.5577" class="difflineplus">+    &quot;SECONDLY&quot;: [1, 1, 1, 1, 1, 1, 1, 1],</span>
<a href="#l2.5578"></a><span id="l2.5578" class="difflineplus">+    &quot;MINUTELY&quot;: [2, 1, 1, 1, 1, 1, 1, 1],</span>
<a href="#l2.5579"></a><span id="l2.5579" class="difflineplus">+    &quot;HOURLY&quot;: [2, 2, 1, 1, 1, 1, 1, 1],</span>
<a href="#l2.5580"></a><span id="l2.5580" class="difflineplus">+    &quot;DAILY&quot;: [2, 2, 2, 1, 1, 1, 1, 1],</span>
<a href="#l2.5581"></a><span id="l2.5581" class="difflineplus">+    &quot;WEEKLY&quot;: [2, 2, 2, 2, 3, 3, 1, 1],</span>
<a href="#l2.5582"></a><span id="l2.5582" class="difflineplus">+    &quot;MONTHLY&quot;: [2, 2, 2, 2, 2, 3, 3, 1],</span>
<a href="#l2.5583"></a><span id="l2.5583" class="difflineplus">+    &quot;YEARLY&quot;: [2, 2, 2, 2, 2, 2, 2, 2]</span>
<a href="#l2.5584"></a><span id="l2.5584" class="difflineplus">+  };</span>
<a href="#l2.5585"></a><span id="l2.5585" class="difflineplus">+  icalrecur_iterator.UNKNOWN = 0;</span>
<a href="#l2.5586"></a><span id="l2.5586" class="difflineplus">+  icalrecur_iterator.CONTRACT = 1;</span>
<a href="#l2.5587"></a><span id="l2.5587" class="difflineplus">+  icalrecur_iterator.EXPAND = 2;</span>
<a href="#l2.5588"></a><span id="l2.5588" class="difflineplus">+  icalrecur_iterator.ILLEGAL = 3;</span>
<a href="#l2.5589"></a><span id="l2.5589" class="difflineplus">+</span>
<a href="#l2.5590"></a><span id="l2.5590" class="difflineplus">+  return icalrecur_iterator;</span>
<a href="#l2.5591"></a><span id="l2.5591" class="difflineplus">+</span>
<a href="#l2.5592"></a><span id="l2.5592" class="difflineplus">+}());</span>
<a href="#l2.5593"></a><span id="l2.5593" class="difflineplus">+ICAL.RecurExpansion = (function() {</span>
<a href="#l2.5594"></a><span id="l2.5594" class="difflineplus">+  function formatTime(item) {</span>
<a href="#l2.5595"></a><span id="l2.5595" class="difflineplus">+    return ICAL.helpers.formatClassType(item, ICAL.Time);</span>
<a href="#l2.5596"></a><span id="l2.5596" class="difflineplus">+  }</span>
<a href="#l2.5597"></a><span id="l2.5597" class="difflineplus">+</span>
<a href="#l2.5598"></a><span id="l2.5598" class="difflineplus">+  function compareTime(a, b) {</span>
<a href="#l2.5599"></a><span id="l2.5599" class="difflineplus">+    return a.compare(b);</span>
<a href="#l2.5600"></a><span id="l2.5600" class="difflineplus">+  }</span>
<a href="#l2.5601"></a><span id="l2.5601" class="difflineplus">+</span>
<a href="#l2.5602"></a><span id="l2.5602" class="difflineplus">+  function isRecurringComponent(comp) {</span>
<a href="#l2.5603"></a><span id="l2.5603" class="difflineplus">+    return comp.hasProperty('rdate') ||</span>
<a href="#l2.5604"></a><span id="l2.5604" class="difflineplus">+           comp.hasProperty('rrule') ||</span>
<a href="#l2.5605"></a><span id="l2.5605" class="difflineplus">+           comp.hasProperty('recurrence-id');</span>
<a href="#l2.5606"></a><span id="l2.5606" class="difflineplus">+  }</span>
<a href="#l2.5607"></a><span id="l2.5607" class="difflineplus">+</span>
<a href="#l2.5608"></a><span id="l2.5608" class="difflineplus">+  /**</span>
<a href="#l2.5609"></a><span id="l2.5609" class="difflineplus">+   * Primary class for expanding recurring rules.</span>
<a href="#l2.5610"></a><span id="l2.5610" class="difflineplus">+   * Can take multiple rrules, rdates, exdate(s)</span>
<a href="#l2.5611"></a><span id="l2.5611" class="difflineplus">+   * and iterate (in order) over each next occurrence.</span>
<a href="#l2.5612"></a><span id="l2.5612" class="difflineplus">+   *</span>
<a href="#l2.5613"></a><span id="l2.5613" class="difflineplus">+   * Once initialized this class can also be serialized</span>
<a href="#l2.5614"></a><span id="l2.5614" class="difflineplus">+   * saved and continue iteration from the last point.</span>
<a href="#l2.5615"></a><span id="l2.5615" class="difflineplus">+   *</span>
<a href="#l2.5616"></a><span id="l2.5616" class="difflineplus">+   * NOTE: it is intended that this class is to be used</span>
<a href="#l2.5617"></a><span id="l2.5617" class="difflineplus">+   *       with ICAL.Event which handles recurrence exceptions.</span>
<a href="#l2.5618"></a><span id="l2.5618" class="difflineplus">+   *</span>
<a href="#l2.5619"></a><span id="l2.5619" class="difflineplus">+   * Options:</span>
<a href="#l2.5620"></a><span id="l2.5620" class="difflineplus">+   *  - dtstart: (ICAL.Time) start time of event (required)</span>
<a href="#l2.5621"></a><span id="l2.5621" class="difflineplus">+   *  - component: (ICAL.Component) component (required unless resuming)</span>
<a href="#l2.5622"></a><span id="l2.5622" class="difflineplus">+   *</span>
<a href="#l2.5623"></a><span id="l2.5623" class="difflineplus">+   * Examples:</span>
<a href="#l2.5624"></a><span id="l2.5624" class="difflineplus">+   *</span>
<a href="#l2.5625"></a><span id="l2.5625" class="difflineplus">+   *    // assuming event is a parsed ical component</span>
<a href="#l2.5626"></a><span id="l2.5626" class="difflineplus">+   *    var event;</span>
<a href="#l2.5627"></a><span id="l2.5627" class="difflineplus">+   *</span>
<a href="#l2.5628"></a><span id="l2.5628" class="difflineplus">+   *    var expand = new ICAL.RecurExpansion({</span>
<a href="#l2.5629"></a><span id="l2.5629" class="difflineplus">+   *      component: event,</span>
<a href="#l2.5630"></a><span id="l2.5630" class="difflineplus">+   *      start: event.getFirstPropertyValue('DTSTART')</span>
<a href="#l2.5631"></a><span id="l2.5631" class="difflineplus">+   *    });</span>
<a href="#l2.5632"></a><span id="l2.5632" class="difflineplus">+   *</span>
<a href="#l2.5633"></a><span id="l2.5633" class="difflineplus">+   *    // remember there are infinite rules</span>
<a href="#l2.5634"></a><span id="l2.5634" class="difflineplus">+   *    // so its a good idea to limit the scope</span>
<a href="#l2.5635"></a><span id="l2.5635" class="difflineplus">+   *    // of the iterations then resume later on.</span>
<a href="#l2.5636"></a><span id="l2.5636" class="difflineplus">+   *</span>
<a href="#l2.5637"></a><span id="l2.5637" class="difflineplus">+   *    // next is always an ICAL.Time or null</span>
<a href="#l2.5638"></a><span id="l2.5638" class="difflineplus">+   *    var next;</span>
<a href="#l2.5639"></a><span id="l2.5639" class="difflineplus">+   *</span>
<a href="#l2.5640"></a><span id="l2.5640" class="difflineplus">+   *    while(someCondition &amp;&amp; (next = expand.next())) {</span>
<a href="#l2.5641"></a><span id="l2.5641" class="difflineplus">+   *      // do something with next</span>
<a href="#l2.5642"></a><span id="l2.5642" class="difflineplus">+   *    }</span>
<a href="#l2.5643"></a><span id="l2.5643" class="difflineplus">+   *</span>
<a href="#l2.5644"></a><span id="l2.5644" class="difflineplus">+   *    // save instance for later</span>
<a href="#l2.5645"></a><span id="l2.5645" class="difflineplus">+   *    var json = JSON.stringify(expand);</span>
<a href="#l2.5646"></a><span id="l2.5646" class="difflineplus">+   *</span>
<a href="#l2.5647"></a><span id="l2.5647" class="difflineplus">+   *    //...</span>
<a href="#l2.5648"></a><span id="l2.5648" class="difflineplus">+   *</span>
<a href="#l2.5649"></a><span id="l2.5649" class="difflineplus">+   *    // NOTE: if the component's properties have</span>
<a href="#l2.5650"></a><span id="l2.5650" class="difflineplus">+   *    //       changed you will need to rebuild the</span>
<a href="#l2.5651"></a><span id="l2.5651" class="difflineplus">+   *    //       class and start over. This only works</span>
<a href="#l2.5652"></a><span id="l2.5652" class="difflineplus">+   *    //       when the component's recurrence info is the same.</span>
<a href="#l2.5653"></a><span id="l2.5653" class="difflineplus">+   *    var expand = new ICAL.RecurExpansion(JSON.parse(json));</span>
<a href="#l2.5654"></a><span id="l2.5654" class="difflineplus">+   *</span>
<a href="#l2.5655"></a><span id="l2.5655" class="difflineplus">+   *</span>
<a href="#l2.5656"></a><span id="l2.5656" class="difflineplus">+   * @param {Object} options see options block.</span>
<a href="#l2.5657"></a><span id="l2.5657" class="difflineplus">+   */</span>
<a href="#l2.5658"></a><span id="l2.5658" class="difflineplus">+  function RecurExpansion(options) {</span>
<a href="#l2.5659"></a><span id="l2.5659" class="difflineplus">+    this.ruleDates = [];</span>
<a href="#l2.5660"></a><span id="l2.5660" class="difflineplus">+    this.exDates = [];</span>
<a href="#l2.5661"></a><span id="l2.5661" class="difflineplus">+    this.fromData(options);</span>
<a href="#l2.5662"></a><span id="l2.5662" class="difflineplus">+  }</span>
<a href="#l2.5663"></a><span id="l2.5663" class="difflineplus">+</span>
<a href="#l2.5664"></a><span id="l2.5664" class="difflineplus">+  RecurExpansion.prototype = {</span>
<a href="#l2.5665"></a><span id="l2.5665" class="difflineplus">+</span>
<a href="#l2.5666"></a><span id="l2.5666" class="difflineplus">+    /**</span>
<a href="#l2.5667"></a><span id="l2.5667" class="difflineplus">+     * True when iteration is fully completed.</span>
<a href="#l2.5668"></a><span id="l2.5668" class="difflineplus">+     */</span>
<a href="#l2.5669"></a><span id="l2.5669" class="difflineplus">+    complete: false,</span>
<a href="#l2.5670"></a><span id="l2.5670" class="difflineplus">+</span>
<a href="#l2.5671"></a><span id="l2.5671" class="difflineplus">+    /**</span>
<a href="#l2.5672"></a><span id="l2.5672" class="difflineplus">+     * Array of rrule iterators.</span>
<a href="#l2.5673"></a><span id="l2.5673" class="difflineplus">+     *</span>
<a href="#l2.5674"></a><span id="l2.5674" class="difflineplus">+     * @type Array[ICAL.RecurIterator]</span>
<a href="#l2.5675"></a><span id="l2.5675" class="difflineplus">+     * @private</span>
<a href="#l2.5676"></a><span id="l2.5676" class="difflineplus">+     */</span>
<a href="#l2.5677"></a><span id="l2.5677" class="difflineplus">+    ruleIterators: null,</span>
<a href="#l2.5678"></a><span id="l2.5678" class="difflineplus">+</span>
<a href="#l2.5679"></a><span id="l2.5679" class="difflineplus">+    /**</span>
<a href="#l2.5680"></a><span id="l2.5680" class="difflineplus">+     * Array of rdate instances.</span>
<a href="#l2.5681"></a><span id="l2.5681" class="difflineplus">+     *</span>
<a href="#l2.5682"></a><span id="l2.5682" class="difflineplus">+     * @type Array[ICAL.Time]</span>
<a href="#l2.5683"></a><span id="l2.5683" class="difflineplus">+     * @private</span>
<a href="#l2.5684"></a><span id="l2.5684" class="difflineplus">+     */</span>
<a href="#l2.5685"></a><span id="l2.5685" class="difflineplus">+    ruleDates: null,</span>
<a href="#l2.5686"></a><span id="l2.5686" class="difflineplus">+</span>
<a href="#l2.5687"></a><span id="l2.5687" class="difflineplus">+    /**</span>
<a href="#l2.5688"></a><span id="l2.5688" class="difflineplus">+     * Array of exdate instances.</span>
<a href="#l2.5689"></a><span id="l2.5689" class="difflineplus">+     *</span>
<a href="#l2.5690"></a><span id="l2.5690" class="difflineplus">+     * @type Array[ICAL.Time]</span>
<a href="#l2.5691"></a><span id="l2.5691" class="difflineplus">+     * @private</span>
<a href="#l2.5692"></a><span id="l2.5692" class="difflineplus">+     */</span>
<a href="#l2.5693"></a><span id="l2.5693" class="difflineplus">+    exDates: null,</span>
<a href="#l2.5694"></a><span id="l2.5694" class="difflineplus">+</span>
<a href="#l2.5695"></a><span id="l2.5695" class="difflineplus">+    /**</span>
<a href="#l2.5696"></a><span id="l2.5696" class="difflineplus">+     * Current position in ruleDates array.</span>
<a href="#l2.5697"></a><span id="l2.5697" class="difflineplus">+     * @type Numeric</span>
<a href="#l2.5698"></a><span id="l2.5698" class="difflineplus">+     * @private</span>
<a href="#l2.5699"></a><span id="l2.5699" class="difflineplus">+     */</span>
<a href="#l2.5700"></a><span id="l2.5700" class="difflineplus">+    ruleDateInc: 0,</span>
<a href="#l2.5701"></a><span id="l2.5701" class="difflineplus">+</span>
<a href="#l2.5702"></a><span id="l2.5702" class="difflineplus">+    /**</span>
<a href="#l2.5703"></a><span id="l2.5703" class="difflineplus">+     * Current position in exDates array</span>
<a href="#l2.5704"></a><span id="l2.5704" class="difflineplus">+     * @type Numeric</span>
<a href="#l2.5705"></a><span id="l2.5705" class="difflineplus">+     * @private</span>
<a href="#l2.5706"></a><span id="l2.5706" class="difflineplus">+     */</span>
<a href="#l2.5707"></a><span id="l2.5707" class="difflineplus">+    exDateInc: 0,</span>
<a href="#l2.5708"></a><span id="l2.5708" class="difflineplus">+</span>
<a href="#l2.5709"></a><span id="l2.5709" class="difflineplus">+    /**</span>
<a href="#l2.5710"></a><span id="l2.5710" class="difflineplus">+     * Current negative date.</span>
<a href="#l2.5711"></a><span id="l2.5711" class="difflineplus">+     *</span>
<a href="#l2.5712"></a><span id="l2.5712" class="difflineplus">+     * @type ICAL.Time</span>
<a href="#l2.5713"></a><span id="l2.5713" class="difflineplus">+     * @private</span>
<a href="#l2.5714"></a><span id="l2.5714" class="difflineplus">+     */</span>
<a href="#l2.5715"></a><span id="l2.5715" class="difflineplus">+    exDate: null,</span>
<a href="#l2.5716"></a><span id="l2.5716" class="difflineplus">+</span>
<a href="#l2.5717"></a><span id="l2.5717" class="difflineplus">+    /**</span>
<a href="#l2.5718"></a><span id="l2.5718" class="difflineplus">+     * Current additional date.</span>
<a href="#l2.5719"></a><span id="l2.5719" class="difflineplus">+     *</span>
<a href="#l2.5720"></a><span id="l2.5720" class="difflineplus">+     * @type ICAL.Time</span>
<a href="#l2.5721"></a><span id="l2.5721" class="difflineplus">+     * @private</span>
<a href="#l2.5722"></a><span id="l2.5722" class="difflineplus">+     */</span>
<a href="#l2.5723"></a><span id="l2.5723" class="difflineplus">+    ruleDate: null,</span>
<a href="#l2.5724"></a><span id="l2.5724" class="difflineplus">+</span>
<a href="#l2.5725"></a><span id="l2.5725" class="difflineplus">+    /**</span>
<a href="#l2.5726"></a><span id="l2.5726" class="difflineplus">+     * Start date of recurring rules.</span>
<a href="#l2.5727"></a><span id="l2.5727" class="difflineplus">+     *</span>
<a href="#l2.5728"></a><span id="l2.5728" class="difflineplus">+     * @type ICAL.Time</span>
<a href="#l2.5729"></a><span id="l2.5729" class="difflineplus">+     */</span>
<a href="#l2.5730"></a><span id="l2.5730" class="difflineplus">+    dtstart: null,</span>
<a href="#l2.5731"></a><span id="l2.5731" class="difflineplus">+</span>
<a href="#l2.5732"></a><span id="l2.5732" class="difflineplus">+    /**</span>
<a href="#l2.5733"></a><span id="l2.5733" class="difflineplus">+     * Last expanded time</span>
<a href="#l2.5734"></a><span id="l2.5734" class="difflineplus">+     *</span>
<a href="#l2.5735"></a><span id="l2.5735" class="difflineplus">+     * @type ICAL.Time</span>
<a href="#l2.5736"></a><span id="l2.5736" class="difflineplus">+     */</span>
<a href="#l2.5737"></a><span id="l2.5737" class="difflineplus">+    last: null,</span>
<a href="#l2.5738"></a><span id="l2.5738" class="difflineplus">+</span>
<a href="#l2.5739"></a><span id="l2.5739" class="difflineplus">+    fromData: function(options) {</span>
<a href="#l2.5740"></a><span id="l2.5740" class="difflineplus">+      var start = ICAL.helpers.formatClassType(options.dtstart, ICAL.Time);</span>
<a href="#l2.5741"></a><span id="l2.5741" class="difflineplus">+</span>
<a href="#l2.5742"></a><span id="l2.5742" class="difflineplus">+      if (!start) {</span>
<a href="#l2.5743"></a><span id="l2.5743" class="difflineplus">+        throw new Error('.dtstart (ICAL.Time) must be given');</span>
<a href="#l2.5744"></a><span id="l2.5744" class="difflineplus">+      } else {</span>
<a href="#l2.5745"></a><span id="l2.5745" class="difflineplus">+        this.dtstart = start;</span>
<a href="#l2.5746"></a><span id="l2.5746" class="difflineplus">+      }</span>
<a href="#l2.5747"></a><span id="l2.5747" class="difflineplus">+</span>
<a href="#l2.5748"></a><span id="l2.5748" class="difflineplus">+      if (options.component) {</span>
<a href="#l2.5749"></a><span id="l2.5749" class="difflineplus">+        this._init(options.component);</span>
<a href="#l2.5750"></a><span id="l2.5750" class="difflineplus">+      } else {</span>
<a href="#l2.5751"></a><span id="l2.5751" class="difflineplus">+        this.last = formatTime(options.last);</span>
<a href="#l2.5752"></a><span id="l2.5752" class="difflineplus">+</span>
<a href="#l2.5753"></a><span id="l2.5753" class="difflineplus">+        this.ruleIterators = options.ruleIterators.map(function(item) {</span>
<a href="#l2.5754"></a><span id="l2.5754" class="difflineplus">+          return ICAL.helpers.formatClassType(item, ICAL.RecurIterator);</span>
<a href="#l2.5755"></a><span id="l2.5755" class="difflineplus">+        });</span>
<a href="#l2.5756"></a><span id="l2.5756" class="difflineplus">+</span>
<a href="#l2.5757"></a><span id="l2.5757" class="difflineplus">+        this.ruleDateInc = options.ruleDateInc;</span>
<a href="#l2.5758"></a><span id="l2.5758" class="difflineplus">+        this.exDateInc = options.exDateInc;</span>
<a href="#l2.5759"></a><span id="l2.5759" class="difflineplus">+</span>
<a href="#l2.5760"></a><span id="l2.5760" class="difflineplus">+        if (options.ruleDates) {</span>
<a href="#l2.5761"></a><span id="l2.5761" class="difflineplus">+          this.ruleDates = options.ruleDates.map(formatTime);</span>
<a href="#l2.5762"></a><span id="l2.5762" class="difflineplus">+          this.ruleDate = this.ruleDates[this.ruleDateInc];</span>
<a href="#l2.5763"></a><span id="l2.5763" class="difflineplus">+        }</span>
<a href="#l2.5764"></a><span id="l2.5764" class="difflineplus">+</span>
<a href="#l2.5765"></a><span id="l2.5765" class="difflineplus">+        if (options.exDates) {</span>
<a href="#l2.5766"></a><span id="l2.5766" class="difflineplus">+          this.exDates = options.exDates.map(formatTime);</span>
<a href="#l2.5767"></a><span id="l2.5767" class="difflineplus">+          this.exDate = this.exDates[this.exDateInc];</span>
<a href="#l2.5768"></a><span id="l2.5768" class="difflineplus">+        }</span>
<a href="#l2.5769"></a><span id="l2.5769" class="difflineplus">+</span>
<a href="#l2.5770"></a><span id="l2.5770" class="difflineplus">+        if (typeof(options.complete) !== 'undefined') {</span>
<a href="#l2.5771"></a><span id="l2.5771" class="difflineplus">+          this.complete = options.complete;</span>
<a href="#l2.5772"></a><span id="l2.5772" class="difflineplus">+        }</span>
<a href="#l2.5773"></a><span id="l2.5773" class="difflineplus">+      }</span>
<a href="#l2.5774"></a><span id="l2.5774" class="difflineplus">+    },</span>
<a href="#l2.5775"></a><span id="l2.5775" class="difflineplus">+</span>
<a href="#l2.5776"></a><span id="l2.5776" class="difflineplus">+    next: function() {</span>
<a href="#l2.5777"></a><span id="l2.5777" class="difflineplus">+      var iter;</span>
<a href="#l2.5778"></a><span id="l2.5778" class="difflineplus">+      var ruleOfDay;</span>
<a href="#l2.5779"></a><span id="l2.5779" class="difflineplus">+      var next;</span>
<a href="#l2.5780"></a><span id="l2.5780" class="difflineplus">+      var compare;</span>
<a href="#l2.5781"></a><span id="l2.5781" class="difflineplus">+</span>
<a href="#l2.5782"></a><span id="l2.5782" class="difflineplus">+      var maxTries = 500;</span>
<a href="#l2.5783"></a><span id="l2.5783" class="difflineplus">+      var currentTry = 0;</span>
<a href="#l2.5784"></a><span id="l2.5784" class="difflineplus">+</span>
<a href="#l2.5785"></a><span id="l2.5785" class="difflineplus">+      while (true) {</span>
<a href="#l2.5786"></a><span id="l2.5786" class="difflineplus">+        if (currentTry++ &gt; maxTries) {</span>
<a href="#l2.5787"></a><span id="l2.5787" class="difflineplus">+          throw new Error(</span>
<a href="#l2.5788"></a><span id="l2.5788" class="difflineplus">+            'max tries have occured, rule may be impossible to forfill.'</span>
<a href="#l2.5789"></a><span id="l2.5789" class="difflineplus">+          );</span>
<a href="#l2.5790"></a><span id="l2.5790" class="difflineplus">+        }</span>
<a href="#l2.5791"></a><span id="l2.5791" class="difflineplus">+</span>
<a href="#l2.5792"></a><span id="l2.5792" class="difflineplus">+        next = this.ruleDate;</span>
<a href="#l2.5793"></a><span id="l2.5793" class="difflineplus">+        iter = this._nextRecurrenceIter(this.last);</span>
<a href="#l2.5794"></a><span id="l2.5794" class="difflineplus">+</span>
<a href="#l2.5795"></a><span id="l2.5795" class="difflineplus">+        // no more matches</span>
<a href="#l2.5796"></a><span id="l2.5796" class="difflineplus">+        // because we increment the rule day or rule</span>
<a href="#l2.5797"></a><span id="l2.5797" class="difflineplus">+        // _after_ we choose a value this should be</span>
<a href="#l2.5798"></a><span id="l2.5798" class="difflineplus">+        // the only spot where we need to worry about the</span>
<a href="#l2.5799"></a><span id="l2.5799" class="difflineplus">+        // end of events.</span>
<a href="#l2.5800"></a><span id="l2.5800" class="difflineplus">+        if (!next &amp;&amp; !iter) {</span>
<a href="#l2.5801"></a><span id="l2.5801" class="difflineplus">+          // there are no more iterators or rdates</span>
<a href="#l2.5802"></a><span id="l2.5802" class="difflineplus">+          this.complete = true;</span>
<a href="#l2.5803"></a><span id="l2.5803" class="difflineplus">+          break;</span>
<a href="#l2.5804"></a><span id="l2.5804" class="difflineplus">+        }</span>
<a href="#l2.5805"></a><span id="l2.5805" class="difflineplus">+</span>
<a href="#l2.5806"></a><span id="l2.5806" class="difflineplus">+        // no next rule day or recurrence rule is first.</span>
<a href="#l2.5807"></a><span id="l2.5807" class="difflineplus">+        if (!next || (iter &amp;&amp; next.compare(iter.last) &gt; 0)) {</span>
<a href="#l2.5808"></a><span id="l2.5808" class="difflineplus">+          // must be cloned, recur will reuse the time element.</span>
<a href="#l2.5809"></a><span id="l2.5809" class="difflineplus">+          next = iter.last.clone();</span>
<a href="#l2.5810"></a><span id="l2.5810" class="difflineplus">+          // move to next so we can continue</span>
<a href="#l2.5811"></a><span id="l2.5811" class="difflineplus">+          iter.next();</span>
<a href="#l2.5812"></a><span id="l2.5812" class="difflineplus">+        }</span>
<a href="#l2.5813"></a><span id="l2.5813" class="difflineplus">+</span>
<a href="#l2.5814"></a><span id="l2.5814" class="difflineplus">+        // if the ruleDate is still next increment it.</span>
<a href="#l2.5815"></a><span id="l2.5815" class="difflineplus">+        if (this.ruleDate === next) {</span>
<a href="#l2.5816"></a><span id="l2.5816" class="difflineplus">+          this._nextRuleDay();</span>
<a href="#l2.5817"></a><span id="l2.5817" class="difflineplus">+        }</span>
<a href="#l2.5818"></a><span id="l2.5818" class="difflineplus">+</span>
<a href="#l2.5819"></a><span id="l2.5819" class="difflineplus">+        this.last = next;</span>
<a href="#l2.5820"></a><span id="l2.5820" class="difflineplus">+</span>
<a href="#l2.5821"></a><span id="l2.5821" class="difflineplus">+        // check the negative rules</span>
<a href="#l2.5822"></a><span id="l2.5822" class="difflineplus">+        if (this.exDate) {</span>
<a href="#l2.5823"></a><span id="l2.5823" class="difflineplus">+          compare = this.exDate.compare(this.last);</span>
<a href="#l2.5824"></a><span id="l2.5824" class="difflineplus">+</span>
<a href="#l2.5825"></a><span id="l2.5825" class="difflineplus">+          if (compare &lt; 0) {</span>
<a href="#l2.5826"></a><span id="l2.5826" class="difflineplus">+            this._nextExDay();</span>
<a href="#l2.5827"></a><span id="l2.5827" class="difflineplus">+          }</span>
<a href="#l2.5828"></a><span id="l2.5828" class="difflineplus">+</span>
<a href="#l2.5829"></a><span id="l2.5829" class="difflineplus">+          // if the current rule is excluded skip it.</span>
<a href="#l2.5830"></a><span id="l2.5830" class="difflineplus">+          if (compare === 0) {</span>
<a href="#l2.5831"></a><span id="l2.5831" class="difflineplus">+            this._nextExDay();</span>
<a href="#l2.5832"></a><span id="l2.5832" class="difflineplus">+            continue;</span>
<a href="#l2.5833"></a><span id="l2.5833" class="difflineplus">+          }</span>
<a href="#l2.5834"></a><span id="l2.5834" class="difflineplus">+        }</span>
<a href="#l2.5835"></a><span id="l2.5835" class="difflineplus">+</span>
<a href="#l2.5836"></a><span id="l2.5836" class="difflineplus">+        //XXX: The spec states that after we resolve the final</span>
<a href="#l2.5837"></a><span id="l2.5837" class="difflineplus">+        //     list of dates we execute exdate this seems somewhat counter</span>
<a href="#l2.5838"></a><span id="l2.5838" class="difflineplus">+        //     intuitive to what I have seen most servers do so for now</span>
<a href="#l2.5839"></a><span id="l2.5839" class="difflineplus">+        //     I exclude based on the original date not the one that may</span>
<a href="#l2.5840"></a><span id="l2.5840" class="difflineplus">+        //     have been modified by the exception.</span>
<a href="#l2.5841"></a><span id="l2.5841" class="difflineplus">+        return this.last;</span>
<a href="#l2.5842"></a><span id="l2.5842" class="difflineplus">+      }</span>
<a href="#l2.5843"></a><span id="l2.5843" class="difflineplus">+    },</span>
<a href="#l2.5844"></a><span id="l2.5844" class="difflineplus">+</span>
<a href="#l2.5845"></a><span id="l2.5845" class="difflineplus">+    /**</span>
<a href="#l2.5846"></a><span id="l2.5846" class="difflineplus">+     * Converts object into a serialize-able format.</span>
<a href="#l2.5847"></a><span id="l2.5847" class="difflineplus">+     */</span>
<a href="#l2.5848"></a><span id="l2.5848" class="difflineplus">+    toJSON: function() {</span>
<a href="#l2.5849"></a><span id="l2.5849" class="difflineplus">+      function toJSON(item) {</span>
<a href="#l2.5850"></a><span id="l2.5850" class="difflineplus">+        return item.toJSON();</span>
<a href="#l2.5851"></a><span id="l2.5851" class="difflineplus">+      }</span>
<a href="#l2.5852"></a><span id="l2.5852" class="difflineplus">+</span>
<a href="#l2.5853"></a><span id="l2.5853" class="difflineplus">+      var result = Object.create(null);</span>
<a href="#l2.5854"></a><span id="l2.5854" class="difflineplus">+      result.ruleIterators = this.ruleIterators.map(toJSON);</span>
<a href="#l2.5855"></a><span id="l2.5855" class="difflineplus">+</span>
<a href="#l2.5856"></a><span id="l2.5856" class="difflineplus">+      if (this.ruleDates) {</span>
<a href="#l2.5857"></a><span id="l2.5857" class="difflineplus">+        result.ruleDates = this.ruleDates.map(toJSON);</span>
<a href="#l2.5858"></a><span id="l2.5858" class="difflineplus">+      }</span>
<a href="#l2.5859"></a><span id="l2.5859" class="difflineplus">+</span>
<a href="#l2.5860"></a><span id="l2.5860" class="difflineplus">+      if (this.exDates) {</span>
<a href="#l2.5861"></a><span id="l2.5861" class="difflineplus">+        result.exDates = this.exDates.map(toJSON);</span>
<a href="#l2.5862"></a><span id="l2.5862" class="difflineplus">+      }</span>
<a href="#l2.5863"></a><span id="l2.5863" class="difflineplus">+</span>
<a href="#l2.5864"></a><span id="l2.5864" class="difflineplus">+      result.ruleDateInc = this.ruleDateInc;</span>
<a href="#l2.5865"></a><span id="l2.5865" class="difflineplus">+      result.exDateInc = this.exDateInc;</span>
<a href="#l2.5866"></a><span id="l2.5866" class="difflineplus">+      result.last = this.last.toJSON();</span>
<a href="#l2.5867"></a><span id="l2.5867" class="difflineplus">+      result.dtstart = this.dtstart.toJSON();</span>
<a href="#l2.5868"></a><span id="l2.5868" class="difflineplus">+      result.complete = this.complete;</span>
<a href="#l2.5869"></a><span id="l2.5869" class="difflineplus">+</span>
<a href="#l2.5870"></a><span id="l2.5870" class="difflineplus">+      return result;</span>
<a href="#l2.5871"></a><span id="l2.5871" class="difflineplus">+    },</span>
<a href="#l2.5872"></a><span id="l2.5872" class="difflineplus">+</span>
<a href="#l2.5873"></a><span id="l2.5873" class="difflineplus">+</span>
<a href="#l2.5874"></a><span id="l2.5874" class="difflineplus">+    _extractDates: function(component, property) {</span>
<a href="#l2.5875"></a><span id="l2.5875" class="difflineplus">+      var result = [];</span>
<a href="#l2.5876"></a><span id="l2.5876" class="difflineplus">+      var props = component.getAllProperties(property);</span>
<a href="#l2.5877"></a><span id="l2.5877" class="difflineplus">+      var len = props.length;</span>
<a href="#l2.5878"></a><span id="l2.5878" class="difflineplus">+      var i = 0;</span>
<a href="#l2.5879"></a><span id="l2.5879" class="difflineplus">+      var prop;</span>
<a href="#l2.5880"></a><span id="l2.5880" class="difflineplus">+</span>
<a href="#l2.5881"></a><span id="l2.5881" class="difflineplus">+      var idx;</span>
<a href="#l2.5882"></a><span id="l2.5882" class="difflineplus">+</span>
<a href="#l2.5883"></a><span id="l2.5883" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.5884"></a><span id="l2.5884" class="difflineplus">+        props[i].getValues().forEach(function(prop) {</span>
<a href="#l2.5885"></a><span id="l2.5885" class="difflineplus">+          idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.5886"></a><span id="l2.5886" class="difflineplus">+            result,</span>
<a href="#l2.5887"></a><span id="l2.5887" class="difflineplus">+            prop,</span>
<a href="#l2.5888"></a><span id="l2.5888" class="difflineplus">+            compareTime</span>
<a href="#l2.5889"></a><span id="l2.5889" class="difflineplus">+          );</span>
<a href="#l2.5890"></a><span id="l2.5890" class="difflineplus">+</span>
<a href="#l2.5891"></a><span id="l2.5891" class="difflineplus">+          // ordered insert</span>
<a href="#l2.5892"></a><span id="l2.5892" class="difflineplus">+          result.splice(idx, 0, prop);</span>
<a href="#l2.5893"></a><span id="l2.5893" class="difflineplus">+        });</span>
<a href="#l2.5894"></a><span id="l2.5894" class="difflineplus">+      }</span>
<a href="#l2.5895"></a><span id="l2.5895" class="difflineplus">+</span>
<a href="#l2.5896"></a><span id="l2.5896" class="difflineplus">+      return result;</span>
<a href="#l2.5897"></a><span id="l2.5897" class="difflineplus">+    },</span>
<a href="#l2.5898"></a><span id="l2.5898" class="difflineplus">+</span>
<a href="#l2.5899"></a><span id="l2.5899" class="difflineplus">+    _init: function(component) {</span>
<a href="#l2.5900"></a><span id="l2.5900" class="difflineplus">+      this.ruleIterators = [];</span>
<a href="#l2.5901"></a><span id="l2.5901" class="difflineplus">+</span>
<a href="#l2.5902"></a><span id="l2.5902" class="difflineplus">+      this.last = this.dtstart.clone();</span>
<a href="#l2.5903"></a><span id="l2.5903" class="difflineplus">+</span>
<a href="#l2.5904"></a><span id="l2.5904" class="difflineplus">+      // to provide api consistency non-recurring</span>
<a href="#l2.5905"></a><span id="l2.5905" class="difflineplus">+      // events can also use the iterator though it will</span>
<a href="#l2.5906"></a><span id="l2.5906" class="difflineplus">+      // only return a single time.</span>
<a href="#l2.5907"></a><span id="l2.5907" class="difflineplus">+      if (!isRecurringComponent(component)) {</span>
<a href="#l2.5908"></a><span id="l2.5908" class="difflineplus">+        this.ruleDate = this.last.clone();</span>
<a href="#l2.5909"></a><span id="l2.5909" class="difflineplus">+        this.complete = true;</span>
<a href="#l2.5910"></a><span id="l2.5910" class="difflineplus">+        return;</span>
<a href="#l2.5911"></a><span id="l2.5911" class="difflineplus">+      }</span>
<a href="#l2.5912"></a><span id="l2.5912" class="difflineplus">+</span>
<a href="#l2.5913"></a><span id="l2.5913" class="difflineplus">+      if (component.hasProperty('rdate')) {</span>
<a href="#l2.5914"></a><span id="l2.5914" class="difflineplus">+        this.ruleDates = this._extractDates(component, 'rdate');</span>
<a href="#l2.5915"></a><span id="l2.5915" class="difflineplus">+</span>
<a href="#l2.5916"></a><span id="l2.5916" class="difflineplus">+        // special hack for cases where first rdate is prior</span>
<a href="#l2.5917"></a><span id="l2.5917" class="difflineplus">+        // to the start date. We only check for the first rdate.</span>
<a href="#l2.5918"></a><span id="l2.5918" class="difflineplus">+        // This is mostly for google's crazy recurring date logic</span>
<a href="#l2.5919"></a><span id="l2.5919" class="difflineplus">+        // (contacts birthdays).</span>
<a href="#l2.5920"></a><span id="l2.5920" class="difflineplus">+        if ((this.ruleDates[0]) &amp;&amp;</span>
<a href="#l2.5921"></a><span id="l2.5921" class="difflineplus">+            (this.ruleDates[0].compare(this.dtstart) &lt; 0)) {</span>
<a href="#l2.5922"></a><span id="l2.5922" class="difflineplus">+</span>
<a href="#l2.5923"></a><span id="l2.5923" class="difflineplus">+          this.ruleDateInc = 0;</span>
<a href="#l2.5924"></a><span id="l2.5924" class="difflineplus">+          this.last = this.ruleDates[0].clone();</span>
<a href="#l2.5925"></a><span id="l2.5925" class="difflineplus">+        } else {</span>
<a href="#l2.5926"></a><span id="l2.5926" class="difflineplus">+          this.ruleDateInc = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.5927"></a><span id="l2.5927" class="difflineplus">+            this.ruleDates,</span>
<a href="#l2.5928"></a><span id="l2.5928" class="difflineplus">+            this.last,</span>
<a href="#l2.5929"></a><span id="l2.5929" class="difflineplus">+            compareTime</span>
<a href="#l2.5930"></a><span id="l2.5930" class="difflineplus">+          );</span>
<a href="#l2.5931"></a><span id="l2.5931" class="difflineplus">+        }</span>
<a href="#l2.5932"></a><span id="l2.5932" class="difflineplus">+</span>
<a href="#l2.5933"></a><span id="l2.5933" class="difflineplus">+        this.ruleDate = this.ruleDates[this.ruleDateInc];</span>
<a href="#l2.5934"></a><span id="l2.5934" class="difflineplus">+      }</span>
<a href="#l2.5935"></a><span id="l2.5935" class="difflineplus">+</span>
<a href="#l2.5936"></a><span id="l2.5936" class="difflineplus">+      if (component.hasProperty('rrule')) {</span>
<a href="#l2.5937"></a><span id="l2.5937" class="difflineplus">+        var rules = component.getAllProperties('rrule');</span>
<a href="#l2.5938"></a><span id="l2.5938" class="difflineplus">+        var i = 0;</span>
<a href="#l2.5939"></a><span id="l2.5939" class="difflineplus">+        var len = rules.length;</span>
<a href="#l2.5940"></a><span id="l2.5940" class="difflineplus">+</span>
<a href="#l2.5941"></a><span id="l2.5941" class="difflineplus">+        var rule;</span>
<a href="#l2.5942"></a><span id="l2.5942" class="difflineplus">+        var iter;</span>
<a href="#l2.5943"></a><span id="l2.5943" class="difflineplus">+</span>
<a href="#l2.5944"></a><span id="l2.5944" class="difflineplus">+        for (; i &lt; len; i++) {</span>
<a href="#l2.5945"></a><span id="l2.5945" class="difflineplus">+          rule = rules[i].getFirstValue();</span>
<a href="#l2.5946"></a><span id="l2.5946" class="difflineplus">+          iter = rule.iterator(this.dtstart);</span>
<a href="#l2.5947"></a><span id="l2.5947" class="difflineplus">+          this.ruleIterators.push(iter);</span>
<a href="#l2.5948"></a><span id="l2.5948" class="difflineplus">+</span>
<a href="#l2.5949"></a><span id="l2.5949" class="difflineplus">+          // increment to the next occurrence so future</span>
<a href="#l2.5950"></a><span id="l2.5950" class="difflineplus">+          // calls to next return times beyond the initial iteration.</span>
<a href="#l2.5951"></a><span id="l2.5951" class="difflineplus">+          // XXX: I find this suspicious might be a bug?</span>
<a href="#l2.5952"></a><span id="l2.5952" class="difflineplus">+          iter.next();</span>
<a href="#l2.5953"></a><span id="l2.5953" class="difflineplus">+        }</span>
<a href="#l2.5954"></a><span id="l2.5954" class="difflineplus">+      }</span>
<a href="#l2.5955"></a><span id="l2.5955" class="difflineplus">+</span>
<a href="#l2.5956"></a><span id="l2.5956" class="difflineplus">+      if (component.hasProperty('exdate')) {</span>
<a href="#l2.5957"></a><span id="l2.5957" class="difflineplus">+        this.exDates = this._extractDates(component, 'exdate');</span>
<a href="#l2.5958"></a><span id="l2.5958" class="difflineplus">+        // if we have a .last day we increment the index to beyond it.</span>
<a href="#l2.5959"></a><span id="l2.5959" class="difflineplus">+        this.exDateInc = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.5960"></a><span id="l2.5960" class="difflineplus">+          this.exDates,</span>
<a href="#l2.5961"></a><span id="l2.5961" class="difflineplus">+          this.last,</span>
<a href="#l2.5962"></a><span id="l2.5962" class="difflineplus">+          compareTime</span>
<a href="#l2.5963"></a><span id="l2.5963" class="difflineplus">+        );</span>
<a href="#l2.5964"></a><span id="l2.5964" class="difflineplus">+</span>
<a href="#l2.5965"></a><span id="l2.5965" class="difflineplus">+        this.exDate = this.exDates[this.exDateInc];</span>
<a href="#l2.5966"></a><span id="l2.5966" class="difflineplus">+      }</span>
<a href="#l2.5967"></a><span id="l2.5967" class="difflineplus">+    },</span>
<a href="#l2.5968"></a><span id="l2.5968" class="difflineplus">+</span>
<a href="#l2.5969"></a><span id="l2.5969" class="difflineplus">+    _nextExDay: function() {</span>
<a href="#l2.5970"></a><span id="l2.5970" class="difflineplus">+      this.exDate = this.exDates[++this.exDateInc];</span>
<a href="#l2.5971"></a><span id="l2.5971" class="difflineplus">+    },</span>
<a href="#l2.5972"></a><span id="l2.5972" class="difflineplus">+</span>
<a href="#l2.5973"></a><span id="l2.5973" class="difflineplus">+    _nextRuleDay: function() {</span>
<a href="#l2.5974"></a><span id="l2.5974" class="difflineplus">+      this.ruleDate = this.ruleDates[++this.ruleDateInc];</span>
<a href="#l2.5975"></a><span id="l2.5975" class="difflineplus">+    },</span>
<a href="#l2.5976"></a><span id="l2.5976" class="difflineplus">+</span>
<a href="#l2.5977"></a><span id="l2.5977" class="difflineplus">+    /**</span>
<a href="#l2.5978"></a><span id="l2.5978" class="difflineplus">+     * Find and return the recurrence rule with the most</span>
<a href="#l2.5979"></a><span id="l2.5979" class="difflineplus">+     * recent event and return it.</span>
<a href="#l2.5980"></a><span id="l2.5980" class="difflineplus">+     *</span>
<a href="#l2.5981"></a><span id="l2.5981" class="difflineplus">+     * @return {Object} iterator.</span>
<a href="#l2.5982"></a><span id="l2.5982" class="difflineplus">+     */</span>
<a href="#l2.5983"></a><span id="l2.5983" class="difflineplus">+    _nextRecurrenceIter: function() {</span>
<a href="#l2.5984"></a><span id="l2.5984" class="difflineplus">+      var iters = this.ruleIterators;</span>
<a href="#l2.5985"></a><span id="l2.5985" class="difflineplus">+</span>
<a href="#l2.5986"></a><span id="l2.5986" class="difflineplus">+      if (iters.length === 0) {</span>
<a href="#l2.5987"></a><span id="l2.5987" class="difflineplus">+        return null;</span>
<a href="#l2.5988"></a><span id="l2.5988" class="difflineplus">+      }</span>
<a href="#l2.5989"></a><span id="l2.5989" class="difflineplus">+</span>
<a href="#l2.5990"></a><span id="l2.5990" class="difflineplus">+      var len = iters.length;</span>
<a href="#l2.5991"></a><span id="l2.5991" class="difflineplus">+      var iter;</span>
<a href="#l2.5992"></a><span id="l2.5992" class="difflineplus">+      var iterTime;</span>
<a href="#l2.5993"></a><span id="l2.5993" class="difflineplus">+      var iterIdx = 0;</span>
<a href="#l2.5994"></a><span id="l2.5994" class="difflineplus">+      var chosenIter;</span>
<a href="#l2.5995"></a><span id="l2.5995" class="difflineplus">+</span>
<a href="#l2.5996"></a><span id="l2.5996" class="difflineplus">+      // loop through each iterator</span>
<a href="#l2.5997"></a><span id="l2.5997" class="difflineplus">+      for (; iterIdx &lt; len; iterIdx++) {</span>
<a href="#l2.5998"></a><span id="l2.5998" class="difflineplus">+        iter = iters[iterIdx];</span>
<a href="#l2.5999"></a><span id="l2.5999" class="difflineplus">+        iterTime = iter.last;</span>
<a href="#l2.6000"></a><span id="l2.6000" class="difflineplus">+</span>
<a href="#l2.6001"></a><span id="l2.6001" class="difflineplus">+        // if iteration is complete</span>
<a href="#l2.6002"></a><span id="l2.6002" class="difflineplus">+        // then we must exclude it from</span>
<a href="#l2.6003"></a><span id="l2.6003" class="difflineplus">+        // the search and remove it.</span>
<a href="#l2.6004"></a><span id="l2.6004" class="difflineplus">+        if (iter.completed) {</span>
<a href="#l2.6005"></a><span id="l2.6005" class="difflineplus">+          len--;</span>
<a href="#l2.6006"></a><span id="l2.6006" class="difflineplus">+          if (iterIdx !== 0) {</span>
<a href="#l2.6007"></a><span id="l2.6007" class="difflineplus">+            iterIdx--;</span>
<a href="#l2.6008"></a><span id="l2.6008" class="difflineplus">+          }</span>
<a href="#l2.6009"></a><span id="l2.6009" class="difflineplus">+          iters.splice(iterIdx, 1);</span>
<a href="#l2.6010"></a><span id="l2.6010" class="difflineplus">+          continue;</span>
<a href="#l2.6011"></a><span id="l2.6011" class="difflineplus">+        }</span>
<a href="#l2.6012"></a><span id="l2.6012" class="difflineplus">+</span>
<a href="#l2.6013"></a><span id="l2.6013" class="difflineplus">+        // find the most recent possible choice</span>
<a href="#l2.6014"></a><span id="l2.6014" class="difflineplus">+        if (!chosenIter || chosenIter.last.compare(iterTime) &gt; 0) {</span>
<a href="#l2.6015"></a><span id="l2.6015" class="difflineplus">+          // that iterator is saved</span>
<a href="#l2.6016"></a><span id="l2.6016" class="difflineplus">+          chosenIter = iter;</span>
<a href="#l2.6017"></a><span id="l2.6017" class="difflineplus">+        }</span>
<a href="#l2.6018"></a><span id="l2.6018" class="difflineplus">+      }</span>
<a href="#l2.6019"></a><span id="l2.6019" class="difflineplus">+</span>
<a href="#l2.6020"></a><span id="l2.6020" class="difflineplus">+      // the chosen iterator is returned but not mutated</span>
<a href="#l2.6021"></a><span id="l2.6021" class="difflineplus">+      // this iterator contains the most recent event.</span>
<a href="#l2.6022"></a><span id="l2.6022" class="difflineplus">+      return chosenIter;</span>
<a href="#l2.6023"></a><span id="l2.6023" class="difflineplus">+    }</span>
<a href="#l2.6024"></a><span id="l2.6024" class="difflineplus">+</span>
<a href="#l2.6025"></a><span id="l2.6025" class="difflineplus">+  };</span>
<a href="#l2.6026"></a><span id="l2.6026" class="difflineplus">+</span>
<a href="#l2.6027"></a><span id="l2.6027" class="difflineplus">+  return RecurExpansion;</span>
<a href="#l2.6028"></a><span id="l2.6028" class="difflineplus">+</span>
<a href="#l2.6029"></a><span id="l2.6029" class="difflineplus">+}());</span>
<a href="#l2.6030"></a><span id="l2.6030" class="difflineplus">+ICAL.Event = (function() {</span>
<a href="#l2.6031"></a><span id="l2.6031" class="difflineplus">+</span>
<a href="#l2.6032"></a><span id="l2.6032" class="difflineplus">+  function compareRangeException(a, b) {</span>
<a href="#l2.6033"></a><span id="l2.6033" class="difflineplus">+    if (a[0] &gt; b[0]) return 1;</span>
<a href="#l2.6034"></a><span id="l2.6034" class="difflineplus">+    if (b[0] &gt; a[0]) return -1;</span>
<a href="#l2.6035"></a><span id="l2.6035" class="difflineplus">+    return 0;</span>
<a href="#l2.6036"></a><span id="l2.6036" class="difflineplus">+  }</span>
<a href="#l2.6037"></a><span id="l2.6037" class="difflineplus">+</span>
<a href="#l2.6038"></a><span id="l2.6038" class="difflineplus">+  function Event(component, options) {</span>
<a href="#l2.6039"></a><span id="l2.6039" class="difflineplus">+    if (!(component instanceof ICAL.Component)) {</span>
<a href="#l2.6040"></a><span id="l2.6040" class="difflineplus">+      options = component;</span>
<a href="#l2.6041"></a><span id="l2.6041" class="difflineplus">+      component = null;</span>
<a href="#l2.6042"></a><span id="l2.6042" class="difflineplus">+    }</span>
<a href="#l2.6043"></a><span id="l2.6043" class="difflineplus">+</span>
<a href="#l2.6044"></a><span id="l2.6044" class="difflineplus">+    if (component) {</span>
<a href="#l2.6045"></a><span id="l2.6045" class="difflineplus">+      this.component = component;</span>
<a href="#l2.6046"></a><span id="l2.6046" class="difflineplus">+    } else {</span>
<a href="#l2.6047"></a><span id="l2.6047" class="difflineplus">+      this.component = new ICAL.Component('vevent');</span>
<a href="#l2.6048"></a><span id="l2.6048" class="difflineplus">+    }</span>
<a href="#l2.6049"></a><span id="l2.6049" class="difflineplus">+</span>
<a href="#l2.6050"></a><span id="l2.6050" class="difflineplus">+    this._rangeExceptionCache = Object.create(null);</span>
<a href="#l2.6051"></a><span id="l2.6051" class="difflineplus">+    this.exceptions = Object.create(null);</span>
<a href="#l2.6052"></a><span id="l2.6052" class="difflineplus">+    this.rangeExceptions = [];</span>
<a href="#l2.6053"></a><span id="l2.6053" class="difflineplus">+</span>
<a href="#l2.6054"></a><span id="l2.6054" class="difflineplus">+    if (options &amp;&amp; options.strictExceptions) {</span>
<a href="#l2.6055"></a><span id="l2.6055" class="difflineplus">+      this.strictExceptions = options.strictExceptions;</span>
<a href="#l2.6056"></a><span id="l2.6056" class="difflineplus">+    }</span>
<a href="#l2.6057"></a><span id="l2.6057" class="difflineplus">+</span>
<a href="#l2.6058"></a><span id="l2.6058" class="difflineplus">+    if (options &amp;&amp; options.exceptions) {</span>
<a href="#l2.6059"></a><span id="l2.6059" class="difflineplus">+      options.exceptions.forEach(this.relateException, this);</span>
<a href="#l2.6060"></a><span id="l2.6060" class="difflineplus">+    }</span>
<a href="#l2.6061"></a><span id="l2.6061" class="difflineplus">+  }</span>
<a href="#l2.6062"></a><span id="l2.6062" class="difflineplus">+</span>
<a href="#l2.6063"></a><span id="l2.6063" class="difflineplus">+  Event.prototype = {</span>
<a href="#l2.6064"></a><span id="l2.6064" class="difflineplus">+</span>
<a href="#l2.6065"></a><span id="l2.6065" class="difflineplus">+    THISANDFUTURE: 'THISANDFUTURE',</span>
<a href="#l2.6066"></a><span id="l2.6066" class="difflineplus">+</span>
<a href="#l2.6067"></a><span id="l2.6067" class="difflineplus">+    /**</span>
<a href="#l2.6068"></a><span id="l2.6068" class="difflineplus">+     * List of related event exceptions.</span>
<a href="#l2.6069"></a><span id="l2.6069" class="difflineplus">+     *</span>
<a href="#l2.6070"></a><span id="l2.6070" class="difflineplus">+     * @type Array[ICAL.Event]</span>
<a href="#l2.6071"></a><span id="l2.6071" class="difflineplus">+     */</span>
<a href="#l2.6072"></a><span id="l2.6072" class="difflineplus">+    exceptions: null,</span>
<a href="#l2.6073"></a><span id="l2.6073" class="difflineplus">+</span>
<a href="#l2.6074"></a><span id="l2.6074" class="difflineplus">+    /**</span>
<a href="#l2.6075"></a><span id="l2.6075" class="difflineplus">+     * When true will verify exceptions are related by their UUID.</span>
<a href="#l2.6076"></a><span id="l2.6076" class="difflineplus">+     *</span>
<a href="#l2.6077"></a><span id="l2.6077" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l2.6078"></a><span id="l2.6078" class="difflineplus">+     */</span>
<a href="#l2.6079"></a><span id="l2.6079" class="difflineplus">+    strictExceptions: false,</span>
<a href="#l2.6080"></a><span id="l2.6080" class="difflineplus">+</span>
<a href="#l2.6081"></a><span id="l2.6081" class="difflineplus">+    /**</span>
<a href="#l2.6082"></a><span id="l2.6082" class="difflineplus">+     * Relates a given event exception to this object.</span>
<a href="#l2.6083"></a><span id="l2.6083" class="difflineplus">+     * If the given component does not share the UID of</span>
<a href="#l2.6084"></a><span id="l2.6084" class="difflineplus">+     * this event it cannot be related and will throw an</span>
<a href="#l2.6085"></a><span id="l2.6085" class="difflineplus">+     * exception.</span>
<a href="#l2.6086"></a><span id="l2.6086" class="difflineplus">+     *</span>
<a href="#l2.6087"></a><span id="l2.6087" class="difflineplus">+     * If this component is an exception it cannot have other</span>
<a href="#l2.6088"></a><span id="l2.6088" class="difflineplus">+     * exceptions related to it.</span>
<a href="#l2.6089"></a><span id="l2.6089" class="difflineplus">+     *</span>
<a href="#l2.6090"></a><span id="l2.6090" class="difflineplus">+     * @param {ICAL.Component|ICAL.Event} obj component or event.</span>
<a href="#l2.6091"></a><span id="l2.6091" class="difflineplus">+     */</span>
<a href="#l2.6092"></a><span id="l2.6092" class="difflineplus">+    relateException: function(obj) {</span>
<a href="#l2.6093"></a><span id="l2.6093" class="difflineplus">+      if (this.isRecurrenceException()) {</span>
<a href="#l2.6094"></a><span id="l2.6094" class="difflineplus">+        throw new Error('cannot relate exception to exceptions');</span>
<a href="#l2.6095"></a><span id="l2.6095" class="difflineplus">+      }</span>
<a href="#l2.6096"></a><span id="l2.6096" class="difflineplus">+</span>
<a href="#l2.6097"></a><span id="l2.6097" class="difflineplus">+      if (obj instanceof ICAL.Component) {</span>
<a href="#l2.6098"></a><span id="l2.6098" class="difflineplus">+        obj = new ICAL.Event(obj);</span>
<a href="#l2.6099"></a><span id="l2.6099" class="difflineplus">+      }</span>
<a href="#l2.6100"></a><span id="l2.6100" class="difflineplus">+</span>
<a href="#l2.6101"></a><span id="l2.6101" class="difflineplus">+      if (this.strictExceptions &amp;&amp; obj.uid !== this.uid) {</span>
<a href="#l2.6102"></a><span id="l2.6102" class="difflineplus">+        throw new Error('attempted to relate unrelated exception');</span>
<a href="#l2.6103"></a><span id="l2.6103" class="difflineplus">+      }</span>
<a href="#l2.6104"></a><span id="l2.6104" class="difflineplus">+</span>
<a href="#l2.6105"></a><span id="l2.6105" class="difflineplus">+      var id = obj.recurrenceId.toString();</span>
<a href="#l2.6106"></a><span id="l2.6106" class="difflineplus">+</span>
<a href="#l2.6107"></a><span id="l2.6107" class="difflineplus">+      // we don't sort or manage exceptions directly</span>
<a href="#l2.6108"></a><span id="l2.6108" class="difflineplus">+      // here the recurrence expander handles that.</span>
<a href="#l2.6109"></a><span id="l2.6109" class="difflineplus">+      this.exceptions[id] = obj;</span>
<a href="#l2.6110"></a><span id="l2.6110" class="difflineplus">+</span>
<a href="#l2.6111"></a><span id="l2.6111" class="difflineplus">+      // index RANGE=THISANDFUTURE exceptions so we can</span>
<a href="#l2.6112"></a><span id="l2.6112" class="difflineplus">+      // look them up later in getOccurrenceDetails.</span>
<a href="#l2.6113"></a><span id="l2.6113" class="difflineplus">+      if (obj.modifiesFuture()) {</span>
<a href="#l2.6114"></a><span id="l2.6114" class="difflineplus">+        var item = [</span>
<a href="#l2.6115"></a><span id="l2.6115" class="difflineplus">+          obj.recurrenceId.toUnixTime(), id</span>
<a href="#l2.6116"></a><span id="l2.6116" class="difflineplus">+        ];</span>
<a href="#l2.6117"></a><span id="l2.6117" class="difflineplus">+</span>
<a href="#l2.6118"></a><span id="l2.6118" class="difflineplus">+        // we keep them sorted so we can find the nearest</span>
<a href="#l2.6119"></a><span id="l2.6119" class="difflineplus">+        // value later on...</span>
<a href="#l2.6120"></a><span id="l2.6120" class="difflineplus">+        var idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.6121"></a><span id="l2.6121" class="difflineplus">+          this.rangeExceptions,</span>
<a href="#l2.6122"></a><span id="l2.6122" class="difflineplus">+          item,</span>
<a href="#l2.6123"></a><span id="l2.6123" class="difflineplus">+          compareRangeException</span>
<a href="#l2.6124"></a><span id="l2.6124" class="difflineplus">+        );</span>
<a href="#l2.6125"></a><span id="l2.6125" class="difflineplus">+</span>
<a href="#l2.6126"></a><span id="l2.6126" class="difflineplus">+        this.rangeExceptions.splice(idx, 0, item);</span>
<a href="#l2.6127"></a><span id="l2.6127" class="difflineplus">+      }</span>
<a href="#l2.6128"></a><span id="l2.6128" class="difflineplus">+    },</span>
<a href="#l2.6129"></a><span id="l2.6129" class="difflineplus">+</span>
<a href="#l2.6130"></a><span id="l2.6130" class="difflineplus">+    /**</span>
<a href="#l2.6131"></a><span id="l2.6131" class="difflineplus">+     * If this record is an exception and has the RANGE=THISANDFUTURE value.</span>
<a href="#l2.6132"></a><span id="l2.6132" class="difflineplus">+     *</span>
<a href="#l2.6133"></a><span id="l2.6133" class="difflineplus">+     * @return {Boolean} true when is exception with range.</span>
<a href="#l2.6134"></a><span id="l2.6134" class="difflineplus">+     */</span>
<a href="#l2.6135"></a><span id="l2.6135" class="difflineplus">+    modifiesFuture: function() {</span>
<a href="#l2.6136"></a><span id="l2.6136" class="difflineplus">+      var range = this.component.getFirstPropertyValue('range');</span>
<a href="#l2.6137"></a><span id="l2.6137" class="difflineplus">+      return range === this.THISANDFUTURE;</span>
<a href="#l2.6138"></a><span id="l2.6138" class="difflineplus">+    },</span>
<a href="#l2.6139"></a><span id="l2.6139" class="difflineplus">+</span>
<a href="#l2.6140"></a><span id="l2.6140" class="difflineplus">+    /**</span>
<a href="#l2.6141"></a><span id="l2.6141" class="difflineplus">+     * Finds the range exception nearest to the given date.</span>
<a href="#l2.6142"></a><span id="l2.6142" class="difflineplus">+     *</span>
<a href="#l2.6143"></a><span id="l2.6143" class="difflineplus">+     * @param {ICAL.Time} time usually an occurrence time of an event.</span>
<a href="#l2.6144"></a><span id="l2.6144" class="difflineplus">+     * @return {ICAL.Event|Null} the related event/exception or null.</span>
<a href="#l2.6145"></a><span id="l2.6145" class="difflineplus">+     */</span>
<a href="#l2.6146"></a><span id="l2.6146" class="difflineplus">+    findRangeException: function(time) {</span>
<a href="#l2.6147"></a><span id="l2.6147" class="difflineplus">+      if (!this.rangeExceptions.length) {</span>
<a href="#l2.6148"></a><span id="l2.6148" class="difflineplus">+        return null;</span>
<a href="#l2.6149"></a><span id="l2.6149" class="difflineplus">+      }</span>
<a href="#l2.6150"></a><span id="l2.6150" class="difflineplus">+</span>
<a href="#l2.6151"></a><span id="l2.6151" class="difflineplus">+      var utc = time.toUnixTime();</span>
<a href="#l2.6152"></a><span id="l2.6152" class="difflineplus">+      var idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l2.6153"></a><span id="l2.6153" class="difflineplus">+        this.rangeExceptions,</span>
<a href="#l2.6154"></a><span id="l2.6154" class="difflineplus">+        [utc],</span>
<a href="#l2.6155"></a><span id="l2.6155" class="difflineplus">+        compareRangeException</span>
<a href="#l2.6156"></a><span id="l2.6156" class="difflineplus">+      );</span>
<a href="#l2.6157"></a><span id="l2.6157" class="difflineplus">+</span>
<a href="#l2.6158"></a><span id="l2.6158" class="difflineplus">+      idx -= 1;</span>
<a href="#l2.6159"></a><span id="l2.6159" class="difflineplus">+</span>
<a href="#l2.6160"></a><span id="l2.6160" class="difflineplus">+      // occurs before</span>
<a href="#l2.6161"></a><span id="l2.6161" class="difflineplus">+      if (idx &lt; 0) {</span>
<a href="#l2.6162"></a><span id="l2.6162" class="difflineplus">+        return null;</span>
<a href="#l2.6163"></a><span id="l2.6163" class="difflineplus">+      }</span>
<a href="#l2.6164"></a><span id="l2.6164" class="difflineplus">+</span>
<a href="#l2.6165"></a><span id="l2.6165" class="difflineplus">+      var rangeItem = this.rangeExceptions[idx];</span>
<a href="#l2.6166"></a><span id="l2.6166" class="difflineplus">+</span>
<a href="#l2.6167"></a><span id="l2.6167" class="difflineplus">+      // sanity check</span>
<a href="#l2.6168"></a><span id="l2.6168" class="difflineplus">+      if (utc &lt; rangeItem[0]) {</span>
<a href="#l2.6169"></a><span id="l2.6169" class="difflineplus">+        return null;</span>
<a href="#l2.6170"></a><span id="l2.6170" class="difflineplus">+      }</span>
<a href="#l2.6171"></a><span id="l2.6171" class="difflineplus">+</span>
<a href="#l2.6172"></a><span id="l2.6172" class="difflineplus">+      return rangeItem[1];</span>
<a href="#l2.6173"></a><span id="l2.6173" class="difflineplus">+    },</span>
<a href="#l2.6174"></a><span id="l2.6174" class="difflineplus">+</span>
<a href="#l2.6175"></a><span id="l2.6175" class="difflineplus">+    /**</span>
<a href="#l2.6176"></a><span id="l2.6176" class="difflineplus">+     * Returns the occurrence details based on its start time.</span>
<a href="#l2.6177"></a><span id="l2.6177" class="difflineplus">+     * If the occurrence has an exception will return the details</span>
<a href="#l2.6178"></a><span id="l2.6178" class="difflineplus">+     * for that exception.</span>
<a href="#l2.6179"></a><span id="l2.6179" class="difflineplus">+     *</span>
<a href="#l2.6180"></a><span id="l2.6180" class="difflineplus">+     * NOTE: this method is intend to be used in conjunction</span>
<a href="#l2.6181"></a><span id="l2.6181" class="difflineplus">+     *       with the #iterator method.</span>
<a href="#l2.6182"></a><span id="l2.6182" class="difflineplus">+     *</span>
<a href="#l2.6183"></a><span id="l2.6183" class="difflineplus">+     * @param {ICAL.Time} occurrence time occurrence.</span>
<a href="#l2.6184"></a><span id="l2.6184" class="difflineplus">+     */</span>
<a href="#l2.6185"></a><span id="l2.6185" class="difflineplus">+    getOccurrenceDetails: function(occurrence) {</span>
<a href="#l2.6186"></a><span id="l2.6186" class="difflineplus">+      var id = occurrence.toString();</span>
<a href="#l2.6187"></a><span id="l2.6187" class="difflineplus">+      var result = {</span>
<a href="#l2.6188"></a><span id="l2.6188" class="difflineplus">+        //XXX: Clone?</span>
<a href="#l2.6189"></a><span id="l2.6189" class="difflineplus">+        recurrenceId: occurrence</span>
<a href="#l2.6190"></a><span id="l2.6190" class="difflineplus">+      };</span>
<a href="#l2.6191"></a><span id="l2.6191" class="difflineplus">+</span>
<a href="#l2.6192"></a><span id="l2.6192" class="difflineplus">+      if (id in this.exceptions) {</span>
<a href="#l2.6193"></a><span id="l2.6193" class="difflineplus">+        var item = result.item = this.exceptions[id];</span>
<a href="#l2.6194"></a><span id="l2.6194" class="difflineplus">+        result.startDate = item.startDate;</span>
<a href="#l2.6195"></a><span id="l2.6195" class="difflineplus">+        result.endDate = item.endDate;</span>
<a href="#l2.6196"></a><span id="l2.6196" class="difflineplus">+        result.item = item;</span>
<a href="#l2.6197"></a><span id="l2.6197" class="difflineplus">+      } else {</span>
<a href="#l2.6198"></a><span id="l2.6198" class="difflineplus">+        // range exceptions (RANGE=THISANDFUTURE) have a</span>
<a href="#l2.6199"></a><span id="l2.6199" class="difflineplus">+        // lower priority then direct exceptions but</span>
<a href="#l2.6200"></a><span id="l2.6200" class="difflineplus">+        // must be accounted for first. Their item is</span>
<a href="#l2.6201"></a><span id="l2.6201" class="difflineplus">+        // always the first exception with the range prop.</span>
<a href="#l2.6202"></a><span id="l2.6202" class="difflineplus">+        var rangeExceptionId = this.findRangeException(</span>
<a href="#l2.6203"></a><span id="l2.6203" class="difflineplus">+          occurrence</span>
<a href="#l2.6204"></a><span id="l2.6204" class="difflineplus">+        );</span>
<a href="#l2.6205"></a><span id="l2.6205" class="difflineplus">+</span>
<a href="#l2.6206"></a><span id="l2.6206" class="difflineplus">+        if (rangeExceptionId) {</span>
<a href="#l2.6207"></a><span id="l2.6207" class="difflineplus">+          var exception = this.exceptions[rangeExceptionId];</span>
<a href="#l2.6208"></a><span id="l2.6208" class="difflineplus">+</span>
<a href="#l2.6209"></a><span id="l2.6209" class="difflineplus">+          // range exception must modify standard time</span>
<a href="#l2.6210"></a><span id="l2.6210" class="difflineplus">+          // by the difference (if any) in start/end times.</span>
<a href="#l2.6211"></a><span id="l2.6211" class="difflineplus">+          result.item = exception;</span>
<a href="#l2.6212"></a><span id="l2.6212" class="difflineplus">+</span>
<a href="#l2.6213"></a><span id="l2.6213" class="difflineplus">+          var startDiff = this._rangeExceptionCache[rangeExceptionId];</span>
<a href="#l2.6214"></a><span id="l2.6214" class="difflineplus">+</span>
<a href="#l2.6215"></a><span id="l2.6215" class="difflineplus">+          if (!startDiff) {</span>
<a href="#l2.6216"></a><span id="l2.6216" class="difflineplus">+            var original = exception.recurrenceId.clone();</span>
<a href="#l2.6217"></a><span id="l2.6217" class="difflineplus">+            var newStart = exception.startDate.clone();</span>
<a href="#l2.6218"></a><span id="l2.6218" class="difflineplus">+</span>
<a href="#l2.6219"></a><span id="l2.6219" class="difflineplus">+            // zones must be same otherwise subtract may be incorrect.</span>
<a href="#l2.6220"></a><span id="l2.6220" class="difflineplus">+            original.zone = newStart.zone;</span>
<a href="#l2.6221"></a><span id="l2.6221" class="difflineplus">+            var startDiff = newStart.subtractDate(original);</span>
<a href="#l2.6222"></a><span id="l2.6222" class="difflineplus">+</span>
<a href="#l2.6223"></a><span id="l2.6223" class="difflineplus">+            this._rangeExceptionCache[rangeExceptionId] = startDiff;</span>
<a href="#l2.6224"></a><span id="l2.6224" class="difflineplus">+          }</span>
<a href="#l2.6225"></a><span id="l2.6225" class="difflineplus">+</span>
<a href="#l2.6226"></a><span id="l2.6226" class="difflineplus">+          var start = occurrence.clone();</span>
<a href="#l2.6227"></a><span id="l2.6227" class="difflineplus">+          start.zone = exception.startDate.zone;</span>
<a href="#l2.6228"></a><span id="l2.6228" class="difflineplus">+          start.addDuration(startDiff);</span>
<a href="#l2.6229"></a><span id="l2.6229" class="difflineplus">+</span>
<a href="#l2.6230"></a><span id="l2.6230" class="difflineplus">+          var end = start.clone();</span>
<a href="#l2.6231"></a><span id="l2.6231" class="difflineplus">+          end.addDuration(exception.duration);</span>
<a href="#l2.6232"></a><span id="l2.6232" class="difflineplus">+</span>
<a href="#l2.6233"></a><span id="l2.6233" class="difflineplus">+          result.startDate = start;</span>
<a href="#l2.6234"></a><span id="l2.6234" class="difflineplus">+          result.endDate = end;</span>
<a href="#l2.6235"></a><span id="l2.6235" class="difflineplus">+        } else {</span>
<a href="#l2.6236"></a><span id="l2.6236" class="difflineplus">+          // no range exception standard expansion</span>
<a href="#l2.6237"></a><span id="l2.6237" class="difflineplus">+          var end = occurrence.clone();</span>
<a href="#l2.6238"></a><span id="l2.6238" class="difflineplus">+          end.addDuration(this.duration);</span>
<a href="#l2.6239"></a><span id="l2.6239" class="difflineplus">+</span>
<a href="#l2.6240"></a><span id="l2.6240" class="difflineplus">+          result.endDate = end;</span>
<a href="#l2.6241"></a><span id="l2.6241" class="difflineplus">+          result.startDate = occurrence;</span>
<a href="#l2.6242"></a><span id="l2.6242" class="difflineplus">+          result.item = this;</span>
<a href="#l2.6243"></a><span id="l2.6243" class="difflineplus">+        }</span>
<a href="#l2.6244"></a><span id="l2.6244" class="difflineplus">+      }</span>
<a href="#l2.6245"></a><span id="l2.6245" class="difflineplus">+</span>
<a href="#l2.6246"></a><span id="l2.6246" class="difflineplus">+      return result;</span>
<a href="#l2.6247"></a><span id="l2.6247" class="difflineplus">+    },</span>
<a href="#l2.6248"></a><span id="l2.6248" class="difflineplus">+</span>
<a href="#l2.6249"></a><span id="l2.6249" class="difflineplus">+    /**</span>
<a href="#l2.6250"></a><span id="l2.6250" class="difflineplus">+     * Builds a recur expansion instance for a specific</span>
<a href="#l2.6251"></a><span id="l2.6251" class="difflineplus">+     * point in time (defaults to startDate).</span>
<a href="#l2.6252"></a><span id="l2.6252" class="difflineplus">+     *</span>
<a href="#l2.6253"></a><span id="l2.6253" class="difflineplus">+     * @return {ICAL.RecurExpansion} expander object.</span>
<a href="#l2.6254"></a><span id="l2.6254" class="difflineplus">+     */</span>
<a href="#l2.6255"></a><span id="l2.6255" class="difflineplus">+    iterator: function(startTime) {</span>
<a href="#l2.6256"></a><span id="l2.6256" class="difflineplus">+      return new ICAL.RecurExpansion({</span>
<a href="#l2.6257"></a><span id="l2.6257" class="difflineplus">+        component: this.component,</span>
<a href="#l2.6258"></a><span id="l2.6258" class="difflineplus">+        dtstart: startTime || this.startDate</span>
<a href="#l2.6259"></a><span id="l2.6259" class="difflineplus">+      });</span>
<a href="#l2.6260"></a><span id="l2.6260" class="difflineplus">+    },</span>
<a href="#l2.6261"></a><span id="l2.6261" class="difflineplus">+</span>
<a href="#l2.6262"></a><span id="l2.6262" class="difflineplus">+    isRecurring: function() {</span>
<a href="#l2.6263"></a><span id="l2.6263" class="difflineplus">+      var comp = this.component;</span>
<a href="#l2.6264"></a><span id="l2.6264" class="difflineplus">+      return comp.hasProperty('rrule') || comp.hasProperty('rdate');</span>
<a href="#l2.6265"></a><span id="l2.6265" class="difflineplus">+    },</span>
<a href="#l2.6266"></a><span id="l2.6266" class="difflineplus">+</span>
<a href="#l2.6267"></a><span id="l2.6267" class="difflineplus">+    isRecurrenceException: function() {</span>
<a href="#l2.6268"></a><span id="l2.6268" class="difflineplus">+      return this.component.hasProperty('recurrence-id');</span>
<a href="#l2.6269"></a><span id="l2.6269" class="difflineplus">+    },</span>
<a href="#l2.6270"></a><span id="l2.6270" class="difflineplus">+</span>
<a href="#l2.6271"></a><span id="l2.6271" class="difflineplus">+    /**</span>
<a href="#l2.6272"></a><span id="l2.6272" class="difflineplus">+     * Returns the types of recurrences this event may have.</span>
<a href="#l2.6273"></a><span id="l2.6273" class="difflineplus">+     *</span>
<a href="#l2.6274"></a><span id="l2.6274" class="difflineplus">+     * Returned as an object with the following possible keys:</span>
<a href="#l2.6275"></a><span id="l2.6275" class="difflineplus">+     *</span>
<a href="#l2.6276"></a><span id="l2.6276" class="difflineplus">+     *    - YEARLY</span>
<a href="#l2.6277"></a><span id="l2.6277" class="difflineplus">+     *    - MONTHLY</span>
<a href="#l2.6278"></a><span id="l2.6278" class="difflineplus">+     *    - WEEKLY</span>
<a href="#l2.6279"></a><span id="l2.6279" class="difflineplus">+     *    - DAILY</span>
<a href="#l2.6280"></a><span id="l2.6280" class="difflineplus">+     *    - MINUTELY</span>
<a href="#l2.6281"></a><span id="l2.6281" class="difflineplus">+     *    - SECONDLY</span>
<a href="#l2.6282"></a><span id="l2.6282" class="difflineplus">+     *</span>
<a href="#l2.6283"></a><span id="l2.6283" class="difflineplus">+     * @return {Object} object of recurrence flags.</span>
<a href="#l2.6284"></a><span id="l2.6284" class="difflineplus">+     */</span>
<a href="#l2.6285"></a><span id="l2.6285" class="difflineplus">+    getRecurrenceTypes: function() {</span>
<a href="#l2.6286"></a><span id="l2.6286" class="difflineplus">+      var rules = this.component.getAllProperties('rrule');</span>
<a href="#l2.6287"></a><span id="l2.6287" class="difflineplus">+      var i = 0;</span>
<a href="#l2.6288"></a><span id="l2.6288" class="difflineplus">+      var len = rules.length;</span>
<a href="#l2.6289"></a><span id="l2.6289" class="difflineplus">+      var result = Object.create(null);</span>
<a href="#l2.6290"></a><span id="l2.6290" class="difflineplus">+</span>
<a href="#l2.6291"></a><span id="l2.6291" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.6292"></a><span id="l2.6292" class="difflineplus">+        var value = rules[i].getFirstValue();</span>
<a href="#l2.6293"></a><span id="l2.6293" class="difflineplus">+        result[value.freq] = true;</span>
<a href="#l2.6294"></a><span id="l2.6294" class="difflineplus">+      }</span>
<a href="#l2.6295"></a><span id="l2.6295" class="difflineplus">+</span>
<a href="#l2.6296"></a><span id="l2.6296" class="difflineplus">+      return result;</span>
<a href="#l2.6297"></a><span id="l2.6297" class="difflineplus">+    },</span>
<a href="#l2.6298"></a><span id="l2.6298" class="difflineplus">+</span>
<a href="#l2.6299"></a><span id="l2.6299" class="difflineplus">+    get uid() {</span>
<a href="#l2.6300"></a><span id="l2.6300" class="difflineplus">+      return this._firstProp('uid');</span>
<a href="#l2.6301"></a><span id="l2.6301" class="difflineplus">+    },</span>
<a href="#l2.6302"></a><span id="l2.6302" class="difflineplus">+</span>
<a href="#l2.6303"></a><span id="l2.6303" class="difflineplus">+    set uid(value) {</span>
<a href="#l2.6304"></a><span id="l2.6304" class="difflineplus">+      this._setProp('uid', value);</span>
<a href="#l2.6305"></a><span id="l2.6305" class="difflineplus">+    },</span>
<a href="#l2.6306"></a><span id="l2.6306" class="difflineplus">+</span>
<a href="#l2.6307"></a><span id="l2.6307" class="difflineplus">+    get startDate() {</span>
<a href="#l2.6308"></a><span id="l2.6308" class="difflineplus">+      return this._firstProp('dtstart');</span>
<a href="#l2.6309"></a><span id="l2.6309" class="difflineplus">+    },</span>
<a href="#l2.6310"></a><span id="l2.6310" class="difflineplus">+</span>
<a href="#l2.6311"></a><span id="l2.6311" class="difflineplus">+    set startDate(value) {</span>
<a href="#l2.6312"></a><span id="l2.6312" class="difflineplus">+      this._setTime('dtstart', value);</span>
<a href="#l2.6313"></a><span id="l2.6313" class="difflineplus">+    },</span>
<a href="#l2.6314"></a><span id="l2.6314" class="difflineplus">+</span>
<a href="#l2.6315"></a><span id="l2.6315" class="difflineplus">+    get endDate() {</span>
<a href="#l2.6316"></a><span id="l2.6316" class="difflineplus">+      return this._firstProp('dtend');</span>
<a href="#l2.6317"></a><span id="l2.6317" class="difflineplus">+    },</span>
<a href="#l2.6318"></a><span id="l2.6318" class="difflineplus">+</span>
<a href="#l2.6319"></a><span id="l2.6319" class="difflineplus">+    set endDate(value) {</span>
<a href="#l2.6320"></a><span id="l2.6320" class="difflineplus">+      this._setTime('dtend', value);</span>
<a href="#l2.6321"></a><span id="l2.6321" class="difflineplus">+    },</span>
<a href="#l2.6322"></a><span id="l2.6322" class="difflineplus">+</span>
<a href="#l2.6323"></a><span id="l2.6323" class="difflineplus">+    get duration() {</span>
<a href="#l2.6324"></a><span id="l2.6324" class="difflineplus">+      return this.endDate.subtractDate(this.startDate);</span>
<a href="#l2.6325"></a><span id="l2.6325" class="difflineplus">+    },</span>
<a href="#l2.6326"></a><span id="l2.6326" class="difflineplus">+</span>
<a href="#l2.6327"></a><span id="l2.6327" class="difflineplus">+    get location() {</span>
<a href="#l2.6328"></a><span id="l2.6328" class="difflineplus">+      return this._firstProp('location');</span>
<a href="#l2.6329"></a><span id="l2.6329" class="difflineplus">+    },</span>
<a href="#l2.6330"></a><span id="l2.6330" class="difflineplus">+</span>
<a href="#l2.6331"></a><span id="l2.6331" class="difflineplus">+    set location(value) {</span>
<a href="#l2.6332"></a><span id="l2.6332" class="difflineplus">+      return this._setProp('location', value);</span>
<a href="#l2.6333"></a><span id="l2.6333" class="difflineplus">+    },</span>
<a href="#l2.6334"></a><span id="l2.6334" class="difflineplus">+</span>
<a href="#l2.6335"></a><span id="l2.6335" class="difflineplus">+    get attendees() {</span>
<a href="#l2.6336"></a><span id="l2.6336" class="difflineplus">+      //XXX: This is way lame we should have a better</span>
<a href="#l2.6337"></a><span id="l2.6337" class="difflineplus">+      //     data structure for this later.</span>
<a href="#l2.6338"></a><span id="l2.6338" class="difflineplus">+      return this.component.getAllProperties('attendee');</span>
<a href="#l2.6339"></a><span id="l2.6339" class="difflineplus">+    },</span>
<a href="#l2.6340"></a><span id="l2.6340" class="difflineplus">+</span>
<a href="#l2.6341"></a><span id="l2.6341" class="difflineplus">+    get summary() {</span>
<a href="#l2.6342"></a><span id="l2.6342" class="difflineplus">+      return this._firstProp('summary');</span>
<a href="#l2.6343"></a><span id="l2.6343" class="difflineplus">+    },</span>
<a href="#l2.6344"></a><span id="l2.6344" class="difflineplus">+</span>
<a href="#l2.6345"></a><span id="l2.6345" class="difflineplus">+    set summary(value) {</span>
<a href="#l2.6346"></a><span id="l2.6346" class="difflineplus">+      this._setProp('summary', value);</span>
<a href="#l2.6347"></a><span id="l2.6347" class="difflineplus">+    },</span>
<a href="#l2.6348"></a><span id="l2.6348" class="difflineplus">+</span>
<a href="#l2.6349"></a><span id="l2.6349" class="difflineplus">+    get description() {</span>
<a href="#l2.6350"></a><span id="l2.6350" class="difflineplus">+      return this._firstProp('description');</span>
<a href="#l2.6351"></a><span id="l2.6351" class="difflineplus">+    },</span>
<a href="#l2.6352"></a><span id="l2.6352" class="difflineplus">+</span>
<a href="#l2.6353"></a><span id="l2.6353" class="difflineplus">+    set description(value) {</span>
<a href="#l2.6354"></a><span id="l2.6354" class="difflineplus">+      this._setProp('description', value);</span>
<a href="#l2.6355"></a><span id="l2.6355" class="difflineplus">+    },</span>
<a href="#l2.6356"></a><span id="l2.6356" class="difflineplus">+</span>
<a href="#l2.6357"></a><span id="l2.6357" class="difflineplus">+    get organizer() {</span>
<a href="#l2.6358"></a><span id="l2.6358" class="difflineplus">+      return this._firstProp('organizer');</span>
<a href="#l2.6359"></a><span id="l2.6359" class="difflineplus">+    },</span>
<a href="#l2.6360"></a><span id="l2.6360" class="difflineplus">+</span>
<a href="#l2.6361"></a><span id="l2.6361" class="difflineplus">+    set organizer(value) {</span>
<a href="#l2.6362"></a><span id="l2.6362" class="difflineplus">+      this._setProp('organizer', value);</span>
<a href="#l2.6363"></a><span id="l2.6363" class="difflineplus">+    },</span>
<a href="#l2.6364"></a><span id="l2.6364" class="difflineplus">+</span>
<a href="#l2.6365"></a><span id="l2.6365" class="difflineplus">+    get sequence() {</span>
<a href="#l2.6366"></a><span id="l2.6366" class="difflineplus">+      return this._firstProp('sequence');</span>
<a href="#l2.6367"></a><span id="l2.6367" class="difflineplus">+    },</span>
<a href="#l2.6368"></a><span id="l2.6368" class="difflineplus">+</span>
<a href="#l2.6369"></a><span id="l2.6369" class="difflineplus">+    set sequence(value) {</span>
<a href="#l2.6370"></a><span id="l2.6370" class="difflineplus">+      this._setProp('sequence', value);</span>
<a href="#l2.6371"></a><span id="l2.6371" class="difflineplus">+    },</span>
<a href="#l2.6372"></a><span id="l2.6372" class="difflineplus">+</span>
<a href="#l2.6373"></a><span id="l2.6373" class="difflineplus">+    get recurrenceId() {</span>
<a href="#l2.6374"></a><span id="l2.6374" class="difflineplus">+      return this._firstProp('recurrence-id');</span>
<a href="#l2.6375"></a><span id="l2.6375" class="difflineplus">+    },</span>
<a href="#l2.6376"></a><span id="l2.6376" class="difflineplus">+</span>
<a href="#l2.6377"></a><span id="l2.6377" class="difflineplus">+    set recurrenceId(value) {</span>
<a href="#l2.6378"></a><span id="l2.6378" class="difflineplus">+      this._setProp('recurrence-id', value);</span>
<a href="#l2.6379"></a><span id="l2.6379" class="difflineplus">+    },</span>
<a href="#l2.6380"></a><span id="l2.6380" class="difflineplus">+</span>
<a href="#l2.6381"></a><span id="l2.6381" class="difflineplus">+    /**</span>
<a href="#l2.6382"></a><span id="l2.6382" class="difflineplus">+     * set/update a time property's value.</span>
<a href="#l2.6383"></a><span id="l2.6383" class="difflineplus">+     * This will also update the TZID of the property.</span>
<a href="#l2.6384"></a><span id="l2.6384" class="difflineplus">+     *</span>
<a href="#l2.6385"></a><span id="l2.6385" class="difflineplus">+     * TODO: this method handles the case where we are switching</span>
<a href="#l2.6386"></a><span id="l2.6386" class="difflineplus">+     * from a known timezone to an implied timezone (one without TZID).</span>
<a href="#l2.6387"></a><span id="l2.6387" class="difflineplus">+     * This does _not_ handle the case of moving between a known</span>
<a href="#l2.6388"></a><span id="l2.6388" class="difflineplus">+     *  (by TimezoneService) timezone to an unknown timezone...</span>
<a href="#l2.6389"></a><span id="l2.6389" class="difflineplus">+     *</span>
<a href="#l2.6390"></a><span id="l2.6390" class="difflineplus">+     * We will not add/remove/update the VTIMEZONE subcomponents</span>
<a href="#l2.6391"></a><span id="l2.6391" class="difflineplus">+     *  leading to invalid ICAL data...</span>
<a href="#l2.6392"></a><span id="l2.6392" class="difflineplus">+     */</span>
<a href="#l2.6393"></a><span id="l2.6393" class="difflineplus">+    _setTime: function(name, value) {</span>
<a href="#l2.6394"></a><span id="l2.6394" class="difflineplus">+      var currentProp = this.component.getFirstProperty(name);</span>
<a href="#l2.6395"></a><span id="l2.6395" class="difflineplus">+      var currentValue;</span>
<a href="#l2.6396"></a><span id="l2.6396" class="difflineplus">+</span>
<a href="#l2.6397"></a><span id="l2.6397" class="difflineplus">+      if (currentProp &amp;&amp; (currentValue = currentProp.getFirstValue())) {</span>
<a href="#l2.6398"></a><span id="l2.6398" class="difflineplus">+        var newTzid = value.zone.tzid;</span>
<a href="#l2.6399"></a><span id="l2.6399" class="difflineplus">+        var currentTzid = currentProp.getParameter('tzid');</span>
<a href="#l2.6400"></a><span id="l2.6400" class="difflineplus">+</span>
<a href="#l2.6401"></a><span id="l2.6401" class="difflineplus">+        if (currentTzid !== newTzid) {</span>
<a href="#l2.6402"></a><span id="l2.6402" class="difflineplus">+          /**</span>
<a href="#l2.6403"></a><span id="l2.6403" class="difflineplus">+           * Both the localTimezone and the utcTimezone avoid TZID.</span>
<a href="#l2.6404"></a><span id="l2.6404" class="difflineplus">+           * We must remove the tzid param in these cases otherwise</span>
<a href="#l2.6405"></a><span id="l2.6405" class="difflineplus">+           * the time is either wrong or invalid.</span>
<a href="#l2.6406"></a><span id="l2.6406" class="difflineplus">+           */</span>
<a href="#l2.6407"></a><span id="l2.6407" class="difflineplus">+          if (</span>
<a href="#l2.6408"></a><span id="l2.6408" class="difflineplus">+            value.zone === ICAL.Timezone.localTimezone ||</span>
<a href="#l2.6409"></a><span id="l2.6409" class="difflineplus">+            value.zone === ICAL.Timezone.utcTimezone</span>
<a href="#l2.6410"></a><span id="l2.6410" class="difflineplus">+          ) {</span>
<a href="#l2.6411"></a><span id="l2.6411" class="difflineplus">+            currentProp.removeParameter('tzid');</span>
<a href="#l2.6412"></a><span id="l2.6412" class="difflineplus">+          } else {</span>
<a href="#l2.6413"></a><span id="l2.6413" class="difflineplus">+            // for the case where we are switching between to timezones.</span>
<a href="#l2.6414"></a><span id="l2.6414" class="difflineplus">+            currentProp.setParameter('tzid', newTzid);</span>
<a href="#l2.6415"></a><span id="l2.6415" class="difflineplus">+          }</span>
<a href="#l2.6416"></a><span id="l2.6416" class="difflineplus">+        }</span>
<a href="#l2.6417"></a><span id="l2.6417" class="difflineplus">+      }</span>
<a href="#l2.6418"></a><span id="l2.6418" class="difflineplus">+</span>
<a href="#l2.6419"></a><span id="l2.6419" class="difflineplus">+      this._setProp(name, value);</span>
<a href="#l2.6420"></a><span id="l2.6420" class="difflineplus">+    },</span>
<a href="#l2.6421"></a><span id="l2.6421" class="difflineplus">+</span>
<a href="#l2.6422"></a><span id="l2.6422" class="difflineplus">+    _setProp: function(name, value) {</span>
<a href="#l2.6423"></a><span id="l2.6423" class="difflineplus">+      this.component.updatePropertyWithValue(name, value);</span>
<a href="#l2.6424"></a><span id="l2.6424" class="difflineplus">+    },</span>
<a href="#l2.6425"></a><span id="l2.6425" class="difflineplus">+</span>
<a href="#l2.6426"></a><span id="l2.6426" class="difflineplus">+    _firstProp: function(name) {</span>
<a href="#l2.6427"></a><span id="l2.6427" class="difflineplus">+      return this.component.getFirstPropertyValue(name);</span>
<a href="#l2.6428"></a><span id="l2.6428" class="difflineplus">+    },</span>
<a href="#l2.6429"></a><span id="l2.6429" class="difflineplus">+</span>
<a href="#l2.6430"></a><span id="l2.6430" class="difflineplus">+    toString: function() {</span>
<a href="#l2.6431"></a><span id="l2.6431" class="difflineplus">+      return this.component.toString();</span>
<a href="#l2.6432"></a><span id="l2.6432" class="difflineplus">+    }</span>
<a href="#l2.6433"></a><span id="l2.6433" class="difflineplus">+</span>
<a href="#l2.6434"></a><span id="l2.6434" class="difflineplus">+  };</span>
<a href="#l2.6435"></a><span id="l2.6435" class="difflineplus">+</span>
<a href="#l2.6436"></a><span id="l2.6436" class="difflineplus">+  return Event;</span>
<a href="#l2.6437"></a><span id="l2.6437" class="difflineplus">+</span>
<a href="#l2.6438"></a><span id="l2.6438" class="difflineplus">+}());</span>
<a href="#l2.6439"></a><span id="l2.6439" class="difflineplus">+ICAL.ComponentParser = (function() {</span>
<a href="#l2.6440"></a><span id="l2.6440" class="difflineplus">+</span>
<a href="#l2.6441"></a><span id="l2.6441" class="difflineplus">+  /**</span>
<a href="#l2.6442"></a><span id="l2.6442" class="difflineplus">+   * Component parser initializer.</span>
<a href="#l2.6443"></a><span id="l2.6443" class="difflineplus">+   *</span>
<a href="#l2.6444"></a><span id="l2.6444" class="difflineplus">+   * Usage:</span>
<a href="#l2.6445"></a><span id="l2.6445" class="difflineplus">+   *</span>
<a href="#l2.6446"></a><span id="l2.6446" class="difflineplus">+   *    var options = {</span>
<a href="#l2.6447"></a><span id="l2.6447" class="difflineplus">+   *      // when false no events will be emitted for type</span>
<a href="#l2.6448"></a><span id="l2.6448" class="difflineplus">+   *      parseEvent: true,</span>
<a href="#l2.6449"></a><span id="l2.6449" class="difflineplus">+   *      parseTimezone: true</span>
<a href="#l2.6450"></a><span id="l2.6450" class="difflineplus">+   *    };</span>
<a href="#l2.6451"></a><span id="l2.6451" class="difflineplus">+   *</span>
<a href="#l2.6452"></a><span id="l2.6452" class="difflineplus">+   *    var parser = new ICAL.ComponentParser(options);</span>
<a href="#l2.6453"></a><span id="l2.6453" class="difflineplus">+   *</span>
<a href="#l2.6454"></a><span id="l2.6454" class="difflineplus">+   *    parser.onevent() {</span>
<a href="#l2.6455"></a><span id="l2.6455" class="difflineplus">+   *      //...</span>
<a href="#l2.6456"></a><span id="l2.6456" class="difflineplus">+   *    }</span>
<a href="#l2.6457"></a><span id="l2.6457" class="difflineplus">+   *</span>
<a href="#l2.6458"></a><span id="l2.6458" class="difflineplus">+   *    // ontimezone, etc...</span>
<a href="#l2.6459"></a><span id="l2.6459" class="difflineplus">+   *</span>
<a href="#l2.6460"></a><span id="l2.6460" class="difflineplus">+   *    parser.oncomplete = function() {</span>
<a href="#l2.6461"></a><span id="l2.6461" class="difflineplus">+   *</span>
<a href="#l2.6462"></a><span id="l2.6462" class="difflineplus">+   *    };</span>
<a href="#l2.6463"></a><span id="l2.6463" class="difflineplus">+   *</span>
<a href="#l2.6464"></a><span id="l2.6464" class="difflineplus">+   *    parser.process(string | component);</span>
<a href="#l2.6465"></a><span id="l2.6465" class="difflineplus">+   *</span>
<a href="#l2.6466"></a><span id="l2.6466" class="difflineplus">+   *</span>
<a href="#l2.6467"></a><span id="l2.6467" class="difflineplus">+   * @param {Object} options component parser options.</span>
<a href="#l2.6468"></a><span id="l2.6468" class="difflineplus">+   */</span>
<a href="#l2.6469"></a><span id="l2.6469" class="difflineplus">+  function ComponentParser(options) {</span>
<a href="#l2.6470"></a><span id="l2.6470" class="difflineplus">+    if (typeof(options) === 'undefined') {</span>
<a href="#l2.6471"></a><span id="l2.6471" class="difflineplus">+      options = {};</span>
<a href="#l2.6472"></a><span id="l2.6472" class="difflineplus">+    }</span>
<a href="#l2.6473"></a><span id="l2.6473" class="difflineplus">+</span>
<a href="#l2.6474"></a><span id="l2.6474" class="difflineplus">+    var key;</span>
<a href="#l2.6475"></a><span id="l2.6475" class="difflineplus">+    for (key in options) {</span>
<a href="#l2.6476"></a><span id="l2.6476" class="difflineplus">+      if (options.hasOwnProperty(key)) {</span>
<a href="#l2.6477"></a><span id="l2.6477" class="difflineplus">+        this[key] = options[key];</span>
<a href="#l2.6478"></a><span id="l2.6478" class="difflineplus">+      }</span>
<a href="#l2.6479"></a><span id="l2.6479" class="difflineplus">+    }</span>
<a href="#l2.6480"></a><span id="l2.6480" class="difflineplus">+  }</span>
<a href="#l2.6481"></a><span id="l2.6481" class="difflineplus">+</span>
<a href="#l2.6482"></a><span id="l2.6482" class="difflineplus">+  ComponentParser.prototype = {</span>
<a href="#l2.6483"></a><span id="l2.6483" class="difflineplus">+</span>
<a href="#l2.6484"></a><span id="l2.6484" class="difflineplus">+    /**</span>
<a href="#l2.6485"></a><span id="l2.6485" class="difflineplus">+     * When true parse events</span>
<a href="#l2.6486"></a><span id="l2.6486" class="difflineplus">+     *</span>
<a href="#l2.6487"></a><span id="l2.6487" class="difflineplus">+     * @type Boolean</span>
<a href="#l2.6488"></a><span id="l2.6488" class="difflineplus">+     */</span>
<a href="#l2.6489"></a><span id="l2.6489" class="difflineplus">+    parseEvent: true,</span>
<a href="#l2.6490"></a><span id="l2.6490" class="difflineplus">+</span>
<a href="#l2.6491"></a><span id="l2.6491" class="difflineplus">+    /**</span>
<a href="#l2.6492"></a><span id="l2.6492" class="difflineplus">+     * when true parse timezones</span>
<a href="#l2.6493"></a><span id="l2.6493" class="difflineplus">+     *</span>
<a href="#l2.6494"></a><span id="l2.6494" class="difflineplus">+     * @type Boolean</span>
<a href="#l2.6495"></a><span id="l2.6495" class="difflineplus">+     */</span>
<a href="#l2.6496"></a><span id="l2.6496" class="difflineplus">+    parseTimezone: true,</span>
<a href="#l2.6497"></a><span id="l2.6497" class="difflineplus">+</span>
<a href="#l2.6498"></a><span id="l2.6498" class="difflineplus">+</span>
<a href="#l2.6499"></a><span id="l2.6499" class="difflineplus">+    /* SAX like events here for reference */</span>
<a href="#l2.6500"></a><span id="l2.6500" class="difflineplus">+</span>
<a href="#l2.6501"></a><span id="l2.6501" class="difflineplus">+    /**</span>
<a href="#l2.6502"></a><span id="l2.6502" class="difflineplus">+     * Fired when parsing is complete</span>
<a href="#l2.6503"></a><span id="l2.6503" class="difflineplus">+     */</span>
<a href="#l2.6504"></a><span id="l2.6504" class="difflineplus">+    oncomplete: function() {},</span>
<a href="#l2.6505"></a><span id="l2.6505" class="difflineplus">+</span>
<a href="#l2.6506"></a><span id="l2.6506" class="difflineplus">+    /**</span>
<a href="#l2.6507"></a><span id="l2.6507" class="difflineplus">+     * Fired if an error occurs during parsing.</span>
<a href="#l2.6508"></a><span id="l2.6508" class="difflineplus">+     *</span>
<a href="#l2.6509"></a><span id="l2.6509" class="difflineplus">+     * @param {Error} err details of error.</span>
<a href="#l2.6510"></a><span id="l2.6510" class="difflineplus">+     */</span>
<a href="#l2.6511"></a><span id="l2.6511" class="difflineplus">+    onerror: function(err) {},</span>
<a href="#l2.6512"></a><span id="l2.6512" class="difflineplus">+</span>
<a href="#l2.6513"></a><span id="l2.6513" class="difflineplus">+    /**</span>
<a href="#l2.6514"></a><span id="l2.6514" class="difflineplus">+     * Fired when a top level component (vtimezone) is found</span>
<a href="#l2.6515"></a><span id="l2.6515" class="difflineplus">+     *</span>
<a href="#l2.6516"></a><span id="l2.6516" class="difflineplus">+     * @param {ICAL.Timezone} timezone object.</span>
<a href="#l2.6517"></a><span id="l2.6517" class="difflineplus">+     */</span>
<a href="#l2.6518"></a><span id="l2.6518" class="difflineplus">+    ontimezone: function(component) {},</span>
<a href="#l2.6519"></a><span id="l2.6519" class="difflineplus">+</span>
<a href="#l2.6520"></a><span id="l2.6520" class="difflineplus">+    /*</span>
<a href="#l2.6521"></a><span id="l2.6521" class="difflineplus">+     * Fired when a top level component (VEVENT) is found.</span>
<a href="#l2.6522"></a><span id="l2.6522" class="difflineplus">+     * @param {ICAL.Event} component top level component.</span>
<a href="#l2.6523"></a><span id="l2.6523" class="difflineplus">+     */</span>
<a href="#l2.6524"></a><span id="l2.6524" class="difflineplus">+    onevent: function(component) {},</span>
<a href="#l2.6525"></a><span id="l2.6525" class="difflineplus">+</span>
<a href="#l2.6526"></a><span id="l2.6526" class="difflineplus">+    /**</span>
<a href="#l2.6527"></a><span id="l2.6527" class="difflineplus">+     * Process a string or parse ical object.</span>
<a href="#l2.6528"></a><span id="l2.6528" class="difflineplus">+     * This function itself will return nothing but</span>
<a href="#l2.6529"></a><span id="l2.6529" class="difflineplus">+     * will start the parsing process.</span>
<a href="#l2.6530"></a><span id="l2.6530" class="difflineplus">+     *</span>
<a href="#l2.6531"></a><span id="l2.6531" class="difflineplus">+     * Events must be registered prior to calling this method.</span>
<a href="#l2.6532"></a><span id="l2.6532" class="difflineplus">+     *</span>
<a href="#l2.6533"></a><span id="l2.6533" class="difflineplus">+     * @param {String|Object} ical string or parsed ical object.</span>
<a href="#l2.6534"></a><span id="l2.6534" class="difflineplus">+     */</span>
<a href="#l2.6535"></a><span id="l2.6535" class="difflineplus">+    process: function(ical) {</span>
<a href="#l2.6536"></a><span id="l2.6536" class="difflineplus">+      //TODO: this is sync now in the future we will have a incremental parser.</span>
<a href="#l2.6537"></a><span id="l2.6537" class="difflineplus">+      if (typeof(ical) === 'string') {</span>
<a href="#l2.6538"></a><span id="l2.6538" class="difflineplus">+        ical = ICAL.parse(ical)[1];</span>
<a href="#l2.6539"></a><span id="l2.6539" class="difflineplus">+      }</span>
<a href="#l2.6540"></a><span id="l2.6540" class="difflineplus">+</span>
<a href="#l2.6541"></a><span id="l2.6541" class="difflineplus">+      if (!(ical instanceof ICAL.Component)) {</span>
<a href="#l2.6542"></a><span id="l2.6542" class="difflineplus">+        ical = new ICAL.Component(ical);</span>
<a href="#l2.6543"></a><span id="l2.6543" class="difflineplus">+      }</span>
<a href="#l2.6544"></a><span id="l2.6544" class="difflineplus">+</span>
<a href="#l2.6545"></a><span id="l2.6545" class="difflineplus">+      var components = ical.getAllSubcomponents();</span>
<a href="#l2.6546"></a><span id="l2.6546" class="difflineplus">+      var i = 0;</span>
<a href="#l2.6547"></a><span id="l2.6547" class="difflineplus">+      var len = components.length;</span>
<a href="#l2.6548"></a><span id="l2.6548" class="difflineplus">+      var component;</span>
<a href="#l2.6549"></a><span id="l2.6549" class="difflineplus">+</span>
<a href="#l2.6550"></a><span id="l2.6550" class="difflineplus">+      for (; i &lt; len; i++) {</span>
<a href="#l2.6551"></a><span id="l2.6551" class="difflineplus">+        component = components[i];</span>
<a href="#l2.6552"></a><span id="l2.6552" class="difflineplus">+</span>
<a href="#l2.6553"></a><span id="l2.6553" class="difflineplus">+        switch (component.name) {</span>
<a href="#l2.6554"></a><span id="l2.6554" class="difflineplus">+          case 'vtimezone':</span>
<a href="#l2.6555"></a><span id="l2.6555" class="difflineplus">+            if (this.parseTimezone) {</span>
<a href="#l2.6556"></a><span id="l2.6556" class="difflineplus">+              var tzid = component.getFirstPropertyValue('tzid');</span>
<a href="#l2.6557"></a><span id="l2.6557" class="difflineplus">+              if (tzid) {</span>
<a href="#l2.6558"></a><span id="l2.6558" class="difflineplus">+                this.ontimezone(new ICAL.Timezone({</span>
<a href="#l2.6559"></a><span id="l2.6559" class="difflineplus">+                  tzid: tzid,</span>
<a href="#l2.6560"></a><span id="l2.6560" class="difflineplus">+                  component: component</span>
<a href="#l2.6561"></a><span id="l2.6561" class="difflineplus">+                }));</span>
<a href="#l2.6562"></a><span id="l2.6562" class="difflineplus">+              }</span>
<a href="#l2.6563"></a><span id="l2.6563" class="difflineplus">+            }</span>
<a href="#l2.6564"></a><span id="l2.6564" class="difflineplus">+            break;</span>
<a href="#l2.6565"></a><span id="l2.6565" class="difflineplus">+          case 'vevent':</span>
<a href="#l2.6566"></a><span id="l2.6566" class="difflineplus">+            if (this.parseEvent) {</span>
<a href="#l2.6567"></a><span id="l2.6567" class="difflineplus">+              this.onevent(new ICAL.Event(component));</span>
<a href="#l2.6568"></a><span id="l2.6568" class="difflineplus">+            }</span>
<a href="#l2.6569"></a><span id="l2.6569" class="difflineplus">+            break;</span>
<a href="#l2.6570"></a><span id="l2.6570" class="difflineplus">+          default:</span>
<a href="#l2.6571"></a><span id="l2.6571" class="difflineplus">+            continue;</span>
<a href="#l2.6572"></a><span id="l2.6572" class="difflineplus">+        }</span>
<a href="#l2.6573"></a><span id="l2.6573" class="difflineplus">+      }</span>
<a href="#l2.6574"></a><span id="l2.6574" class="difflineplus">+</span>
<a href="#l2.6575"></a><span id="l2.6575" class="difflineplus">+      //XXX: ideally we should do a &quot;nextTick&quot; here</span>
<a href="#l2.6576"></a><span id="l2.6576" class="difflineplus">+      //     so in all cases this is actually async.</span>
<a href="#l2.6577"></a><span id="l2.6577" class="difflineplus">+      this.oncomplete();</span>
<a href="#l2.6578"></a><span id="l2.6578" class="difflineplus">+    }</span>
<a href="#l2.6579"></a><span id="l2.6579" class="difflineplus">+  };</span>
<a href="#l2.6580"></a><span id="l2.6580" class="difflineplus">+</span>
<a href="#l2.6581"></a><span id="l2.6581" class="difflineplus">+  return ComponentParser;</span>
<a href="#l2.6582"></a><span id="l2.6582" class="difflineplus">+</span>
<a href="#l2.6583"></a><span id="l2.6583" class="difflineplus">+}());</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

